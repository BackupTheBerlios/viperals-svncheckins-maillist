From viperal at berlios.de  Sat Oct  1 03:38:30 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 03:38:30 +0200
Subject: [Viperals-svncheckins] r153 - in cms/trunk: . admin images images/icons images/icons/misc images/icons/smilies images/modules images/modules/forums images/modules/forums/adm images/modules/forums/adm/images images/modules/forums/icons images/modules/forums/icons/misc images/modules/forums/icons/smile includes includes/forums includes/forums/admin install
Message-ID: <200510010138.j911cULi026292@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 03:38:23 +0200 (Sat, 01 Oct 2005)
New Revision: 153

Added:
   cms/trunk/images/icons/
   cms/trunk/images/icons/index.htm
   cms/trunk/images/icons/misc/
   cms/trunk/images/icons/misc/arrow_bold_ltr.gif
   cms/trunk/images/icons/misc/arrow_bold_rgt.gif
   cms/trunk/images/icons/misc/asterix.gif
   cms/trunk/images/icons/misc/index.htm
   cms/trunk/images/icons/misc/musical.gif
   cms/trunk/images/icons/misc/square.gif
   cms/trunk/images/icons/smilies/
   cms/trunk/images/icons/smilies/alien_grn.gif
   cms/trunk/images/icons/smilies/exclaim.gif
   cms/trunk/images/icons/smilies/idea.gif
   cms/trunk/images/icons/smilies/index.htm
   cms/trunk/images/icons/smilies/mr_green.gif
   cms/trunk/images/icons/smilies/question.gif
   cms/trunk/images/icons/smilies/redface_anim.gif
   cms/trunk/images/modules/
   cms/trunk/images/modules/forums/
   cms/trunk/images/modules/forums/adm/
   cms/trunk/images/modules/forums/adm/images/
   cms/trunk/images/modules/forums/adm/images/cellpic1.gif
   cms/trunk/images/modules/forums/adm/images/cellpic3.gif
   cms/trunk/images/modules/forums/adm/images/header_bg.jpg
   cms/trunk/images/modules/forums/adm/images/header_left.jpg
   cms/trunk/images/modules/forums/adm/images/icon_folder.gif
   cms/trunk/images/modules/forums/adm/images/icon_folder_link.gif
   cms/trunk/images/modules/forums/adm/images/icon_folder_lock.gif
   cms/trunk/images/modules/forums/adm/images/icon_subfolder.gif
   cms/trunk/images/modules/forums/adm/images/no_avatar.gif
   cms/trunk/images/modules/forums/adm/images/no_image.png
   cms/trunk/images/modules/forums/icons/
   cms/trunk/images/modules/forums/icons/index.htm
   cms/trunk/images/modules/forums/icons/misc/
   cms/trunk/images/modules/forums/icons/misc/arrow_bold_rgt.gif
   cms/trunk/images/modules/forums/icons/misc/asterix.gif
   cms/trunk/images/modules/forums/icons/misc/index.htm
   cms/trunk/images/modules/forums/icons/misc/musical.gif
   cms/trunk/images/modules/forums/icons/misc/square.gif
   cms/trunk/images/modules/forums/icons/smile/
   cms/trunk/images/modules/forums/icons/smile/alien_grn.gif
   cms/trunk/images/modules/forums/icons/smile/exclaim.gif
   cms/trunk/images/modules/forums/icons/smile/idea.gif
   cms/trunk/images/modules/forums/icons/smile/index.htm
   cms/trunk/images/modules/forums/icons/smile/mr_green.gif
   cms/trunk/images/modules/forums/icons/smile/question.gif
   cms/trunk/images/modules/forums/icons/smile/redface_anim.gif
   cms/trunk/images/modules/forums/index.htm
   cms/trunk/images/modules/forums/spacer.gif
Removed:
   cms/trunk/images/Thumbs.db
Modified:
   cms/trunk/.htaccess
   cms/trunk/admin/menu.php
   cms/trunk/admin/users.php
   cms/trunk/feed.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/admin/admin_search.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/mailer.php
   cms/trunk/install/build_data.php
Log:


Modified: cms/trunk/.htaccess
===================================================================
--- cms/trunk/.htaccess	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/.htaccess	2005-10-01 01:38:23 UTC (rev 153)
@@ -3,11 +3,14 @@
 #php_flag magic_quotes_gpc 0
 
 <LimitExcept GET PUT POST>
-order allow,deny
-allow from all
+	order allow,deny
+	allow from all
 </LimitExcept>
 
-ErrorDocument 403 error.php?error=403
-ErrorDocument 404 error.php?error=404
+ErrorDocument 400 /error.php
+ErrorDocument 401 /error.php
+ErrorDocument 403 /error.php
+ErrorDocument 404 /error.php
+ErrorDocument 500 /error.php
 
 Options -Indexes
\ No newline at end of file

Modified: cms/trunk/admin/menu.php
===================================================================
--- cms/trunk/admin/menu.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/admin/menu.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -99,7 +99,7 @@
 			{
 				$content[$name] .= '
 				<tr>
-					<td class="row2" nowrap="nowrap"></td>
+					<td class="row2" height="6" nowrap="nowrap"></td>
 				</tr>
 				';
 			}

Modified: cms/trunk/admin/users.php
===================================================================
--- cms/trunk/admin/users.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/admin/users.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -63,14 +63,14 @@
 
 				$data['activation']		= in_array($activation, $activation_array) ? $activation : USER_ACTIVATION_NONE;
 		 		$data['coppa_enable']	= get_variable('coppa_enable', 'POST') ? 1 : 0;
-		 		$data['coppa_fax']		= get_variable('coppa_fax', 'POST');
-		 		$data['coppa_mail']		= get_variable('coppa_mail', 'POST');
+		 		$data['coppa_fax']		= get_variable('coppa_fax', 'POST', '');
+		 		$data['coppa_mail']		= get_variable('coppa_mail', 'POST', '');
 		 		$data['enable_confirm']	= get_variable('enable_confirm', 'POST') ? 1 : 0;
-		 		$data['min_name_chars']	= get_variable('min_name_chars', 'POST', 0, 'INT');
-		 		$data['max_name_chars']	= get_variable('max_name_chars', 'POST', 0, 'INT');
-		 		$data['min_pass_chars']	= get_variable('min_pass_chars', 'POST', 0, 'INT');
-		 		$data['max_pass_chars']	= get_variable('max_pass_chars', 'POST', 0, 'INT');
-		 		$data['max_reg_attempts'] = get_variable('coppa_fax', 'POST', 0, 'INT');
+		 		$data['min_name_chars']	= get_variable('min_name_chars', 'POST', 0, 'int');
+		 		$data['max_name_chars']	= get_variable('max_name_chars', 'POST', 0, 'int');
+		 		$data['min_pass_chars']	= get_variable('min_pass_chars', 'POST', 0, 'int');
+		 		$data['max_pass_chars']	= get_variable('max_pass_chars', 'POST', 0, 'int');
+		 		$data['max_reg_attempts'] = get_variable('coppa_fax', 'POST', 0, 'int');
 
 				foreach ($data as $name => $setting)
 				{

Modified: cms/trunk/feed.php
===================================================================
--- cms/trunk/feed.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/feed.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -32,17 +32,10 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
-if (isset($_GET['mode']) && $_GET['mode'] == 'cms')
-{
-	$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 3);
-}
-else
-{
-	$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
-}
+$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
 
 $last_post_time = 0;
 
@@ -72,7 +65,7 @@
 
 $_CLASS['core_template']->assign_array(array(
 	'SITE_NAME' 	=> $_CORE_CONFIG['global']['site_name'],
-	'SITE_URL' 		=> $_CORE_CONFIG['global']['site_url'],
+	'SITE_URL' 		=> generate_link(false, array('full' => true, 'sid' => false)),
 	'LANG'			=> 'en-us',
 	'LAST_MODIFIED'	=> $last_modified ,
 	'TIME'			=> gmdate('M d Y H:i:s') .' GMT'

Deleted: cms/trunk/images/Thumbs.db
===================================================================
(Binary files differ)

Added: cms/trunk/images/icons/index.htm
===================================================================
--- cms/trunk/images/icons/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/icons/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/icons/misc/arrow_bold_ltr.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/misc/arrow_bold_ltr.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/misc/arrow_bold_rgt.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/misc/arrow_bold_rgt.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/misc/asterix.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/misc/asterix.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/misc/index.htm
===================================================================
--- cms/trunk/images/icons/misc/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/icons/misc/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/icons/misc/musical.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/misc/musical.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/misc/square.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/misc/square.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/alien_grn.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/alien_grn.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/exclaim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/exclaim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/idea.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/idea.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/index.htm
===================================================================
--- cms/trunk/images/icons/smilies/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/icons/smilies/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/icons/smilies/mr_green.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/mr_green.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/question.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/question.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/icons/smilies/redface_anim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/icons/smilies/redface_anim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/header_bg.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/header_bg.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/header_left.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/header_left.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/icon_folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/icon_folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/icon_folder_link.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/icon_folder_link.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/icon_folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/icon_folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/icon_subfolder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/icon_subfolder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/adm/images/no_image.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/adm/images/no_image.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/index.htm
===================================================================
--- cms/trunk/images/modules/forums/icons/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/modules/forums/icons/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/modules/forums/icons/misc/arrow_bold_rgt.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/misc/arrow_bold_rgt.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/misc/asterix.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/misc/asterix.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/misc/index.htm
===================================================================
--- cms/trunk/images/modules/forums/icons/misc/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/modules/forums/icons/misc/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/modules/forums/icons/misc/musical.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/misc/musical.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/misc/square.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/misc/square.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/alien_grn.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/alien_grn.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/exclaim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/exclaim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/idea.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/idea.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/index.htm
===================================================================
--- cms/trunk/images/modules/forums/icons/smile/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/modules/forums/icons/smile/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/modules/forums/icons/smile/mr_green.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/mr_green.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/question.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/question.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/icons/smile/redface_anim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/icons/smile/redface_anim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/modules/forums/index.htm
===================================================================
--- cms/trunk/images/modules/forums/index.htm	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/images/modules/forums/index.htm	2005-10-01 01:38:23 UTC (rev 153)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/images/modules/forums/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/modules/forums/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -1363,7 +1363,7 @@
 
 	// Delete forum ids from extension groups table
 	$sql = 'SELECT group_id, allowed_forums 
-		FROM ' . EXTENSION_GROUPS_TABLE . "
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . "
 		WHERE allowed_forums <> ''";
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -1371,7 +1371,7 @@
 	{
 		$allowed_forums = unserialize(trim($row['allowed_forums']));
 		$allowed_forums = array_diff($allowed_forums, $forum_ids);
-		$sql = 'UPDATE ' . EXTENSION_GROUPS_TABLE . " 
+		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . " 
 			SET allowed_forums = '" . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . "'
 			WHERE group_id = {$row['group_id']}";
 		$_CLASS['core_db']->query($sql);
@@ -1384,28 +1384,34 @@
 	{
 		case 'MOVE_POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_name);
-			break;
+		break;
+
 		case 'POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case '_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_name);
 			break;
 		case 'POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_name);
-			break;
+		break;
+
 		case '_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_name);
-			break;
+		break;
+
 		case 'POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_name);
-			break; 
+		break; 
 	}
 
 	return $errors;

Modified: cms/trunk/includes/forums/admin/admin_search.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_search.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/forums/admin/admin_search.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -37,10 +37,21 @@
 
 	if (!$start)
 	{
-		// Empty existing tables
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
+		switch ($_CLASS['core_db']->db_layer)
+		{
+			case 'sqlite':
+			case 'sqlite_pdo':
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_TABLE);
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_WORD_TABLE);
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_MATCH_TABLE);
+			break;
+			
+			default:
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
+			break;
+		}
 	}
 
 	// Fetch a batch of posts_text entries
@@ -64,32 +75,31 @@
 			$count++;
 		}
 		$_CLASS['core_db']->free_result($result);
-	}
 
-	if (($start + $count) < $total_posts)
-	{
-		redirect(generate_link('forums&amp;file=admin_search&position=' . ($start + $count), array('admin' => true)), 3);
+		if (($start + $count) < $total_posts)
+		{
+			redirect(generate_link('Forums&amp;file=admin_search&position=' . ($start + $count), array('admin' => true)), 3);
+		}
+		else
+		{
+			// search tidy
+			$fulltext->search_tidy();
+			$_CLASS['core_db']->optimize_tables();
+		}
 	}
-	else
-	{
-		// search tidy
-		$fulltext->search_tidy();
-		$_CLASS['core_db']->optimize_tables();
 
-		adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
+	adm_page_header($_CLASS['core_user']->get_lang('SEARCH_INDEX'));
 
 ?>
 
-<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
+<h1><?php echo $_CLASS['core_user']->get_lang('SEARCH_INDEX'); ?></h1>
 
-<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_COMPLETE']; ?></p>
+<p><?php echo $_CLASS['core_user']->get_lang('SEARCH_INDEX_COMPLETE'); ?></p>
 
 <?php
 
-		adm_page_footer();
+	adm_page_footer();
 
-	}
-
 	die;
 }
 else if (isset($_POST['cancel']))
@@ -117,7 +127,7 @@
 
 <p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_EXPLAIN']; ?></p>
 
-<form method="post" action="<?php echo generate_link('forums&amp;file=admin_search', array('admin' => true)); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
+<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_search', array('admin' => true)); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
 	<tr>
 		<td class="cat" height="28" align="center">&nbsp;<input type="submit" name="start" value="<?php echo $_CLASS['core_user']->lang['START']; ?>" class="btnmain" /> &nbsp; <input type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" class="btnmain" />&nbsp;</td>
 	</tr>

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/forums/functions_admin.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -2053,7 +2053,7 @@
 
 			foreach ($forum_id as $forum)
 			{
-				$sql = 'DELETE FROM '.ACL_TABLE."
+				$sql = 'DELETE FROM '. FORUMS_ACL_TABLE . "
 					WHERE $id_field = $ug_id
 						AND forum_id = $forum
 						$auth_sql";
@@ -2081,7 +2081,7 @@
 			$cur_options = array();
 
 			$sql = "SELECT auth_option, is_global, is_local
-				FROM " . ACL_OPTIONS_TABLE . "
+				FROM " . FORUMS_ACL_OPTIONS_TABLE . "
 				ORDER BY auth_option_id";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -2148,7 +2148,7 @@
 							break;
 							
 						default:
-							$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
+							$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
 								VALUES ($option, " . $type_sql[$type] . ")";
 							$_CLASS['core_db']->query($sql);
 							$sql = '';
@@ -2158,7 +2158,7 @@
 
 			if ($sql != '')
 			{
-				$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
+				$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
 					VALUES $sql";
 				$_CLASS['core_db']->query($sql);
 			}
@@ -2182,7 +2182,7 @@
 	$update_sql = $empty_forums = array();
 
 	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . POSTS_TABLE . "
+		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE post_approved = 1
 			AND {$type}_id IN (" . implode(', ', $ids) . ")
 		GROUP BY {$type}_id";
@@ -2216,7 +2216,7 @@
 	if (!empty($last_post_ids))
 	{
 		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
-			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
 				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
@@ -2237,7 +2237,7 @@
 		return;
 	}
 
-	$table = ($type == 'forum') ? FORUMS_TABLE : TOPICS_TABLE;
+	$table = ($type == 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
 
 	foreach ($update_sql as $update_id => $update_sql_ary)
 	{
@@ -2255,17 +2255,13 @@
 function tidy_database()
 {
 	global $_CLASS;
-
+return;
 	$remove_date = time() - (3 * 62 * 24 * 3600);
 
 	$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 		WHERE mark_time < ' . $remove_date;
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'DELETE FROM ' . TOPICS_TRACK_TABLE . '
-		WHERE mark_time < ' . $remove_date;
-	$_CLASS['core_db']->query($sql);
-
 	set_config('database_last_gc', time(), true);
 }
 

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/forums/functions_display.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -166,11 +166,10 @@
 		{
 			$forum_id36 = base_convert($forum_id, 10, 36);
 			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
-		//echo $forum_id36.' - '.$row['mark_time'].'<br/>';
 		}
 
 		if ($row['mark_time'] < $row['forum_last_post_time'])
-		{//echo $parent_id.' - '.$row['mark_time'] .' - '. $row['forum_last_post_time'].'<br/>';
+		{
 			$forum_unread[$parent_id] = true;
 		}
 	}
@@ -273,12 +272,13 @@
 		// Which folder should we display?
 		if ($row['forum_status'] == ITEM_LOCKED)
 		{
-			$folder_image = 'forum_locked';
+// forum_locked_new , need an image for this one
+			$folder_image = empty($forum_unread[$forum_id]) ? 'forum_locked' : 'folder_locked_new';
 			$folder_alt = 'FORUM_LOCKED';
 		}
 		else
 		{
-			$folder_alt = (!empty($forum_unread[$forum_id])) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+			$folder_alt = empty($forum_unread[$forum_id]) ? 'NO_NEW_POSTS' : 'NEW_POSTS';
 		}
 
 		// Create last post link information, if appropriate

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/functions.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -594,6 +594,7 @@
 		{
 			include_once($file);
 		}
+
 		$_CLASS[$name] =& new $class;
 	}
 }

Modified: cms/trunk/includes/mailer.php
===================================================================
--- cms/trunk/includes/mailer.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/includes/mailer.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -94,7 +94,6 @@
 	{
 		if (isset($address['address']))
 		{
-			echo ($address['name'] && $this->named_addresses) ?  '"' . mail_encode($address['name'], $this->encoding) . '" <' . $address['address'] . '>' : $address['address'];
 			return ($address['name'] && $this->named_addresses) ?  '"' . mail_encode($address['name'], $this->encoding) . '" <' . $address['address'] . '>' : $address['address'];
 		}
 

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-30 15:58:35 UTC (rev 152)
+++ cms/trunk/install/build_data.php	2005-10-01 01:38:23 UTC (rev 153)
@@ -482,4 +482,16 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (5, 'rm')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wma')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wmv')");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/arrow_bold_rgt.gif', 19, 19, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/redface_anim.gif', 19, 19, 9, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/mr_green.gif', 19, 19, 10, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/musical.gif', 19, 19, 4, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/asterix.gif', 19, 19, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/square.gif', 19, 19, 3, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/alien_grn.gif', 19, 19, 5, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/idea.gif', 19, 19, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/question.gif', 19, 19, 6, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/exclaim.gif', 19, 19, 7, 1)");
+
 ?>
\ No newline at end of file



From viperal at berlios.de  Sat Oct  1 03:51:12 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 03:51:12 +0200
Subject: [Viperals-svncheckins] r154 - cms/trunk/includes/display
Message-ID: <200510010151.j911pCHV029236@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 03:51:05 +0200 (Sat, 01 Oct 2005)
New Revision: 154

Modified:
   cms/trunk/includes/display/display.php
Log:


Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-01 01:38:23 UTC (rev 153)
+++ cms/trunk/includes/display/display.php	2005-10-01 01:51:05 UTC (rev 154)
@@ -161,7 +161,8 @@
 		if ($_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_new_privmsg'] && $_CLASS['core_user']->user_data_get('popuppm'))
 		{
 			$this->header['js'][] = '<script type="text/javascript">window.open(\''. preg_replace('/&amp;/', '&', generate_link('Control_Panel&i=pm&mode=popup', array('full' => true)))."', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');</script>";
-			$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
+// need some other field
+			//$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
 		}
 
 		$this->header['regular'][] = '<meta name="generator" content="Viperal CMS ( www.viperal.com ) Copyright(c) '.date('Y').'" />';



From viperal at berlios.de  Sat Oct  1 03:55:23 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 03:55:23 +0200
Subject: [Viperals-svncheckins] r155 - in cms/branches/1.0alpha2: images images/icons images/icons/misc images/icons/smilies includes/display includes/forums includes/forums/admin install modules/Control_Panel/ucp
Message-ID: <200510010155.j911tNib029551@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 03:55:16 +0200 (Sat, 01 Oct 2005)
New Revision: 155

Added:
   cms/branches/1.0alpha2/images/icons/
   cms/branches/1.0alpha2/images/icons/index.htm
   cms/branches/1.0alpha2/images/icons/misc/
   cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
   cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
   cms/branches/1.0alpha2/images/icons/misc/asterix.gif
   cms/branches/1.0alpha2/images/icons/misc/index.htm
   cms/branches/1.0alpha2/images/icons/misc/musical.gif
   cms/branches/1.0alpha2/images/icons/misc/square.gif
   cms/branches/1.0alpha2/images/icons/smilies/
   cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
   cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
   cms/branches/1.0alpha2/images/icons/smilies/idea.gif
   cms/branches/1.0alpha2/images/icons/smilies/index.htm
   cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
   cms/branches/1.0alpha2/images/icons/smilies/question.gif
   cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
Removed:
   cms/branches/1.0alpha2/images/Thumbs.db
Modified:
   cms/branches/1.0alpha2/includes/display/display.php
   cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php
   cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php
   cms/branches/1.0alpha2/includes/forums/functions_admin.php
   cms/branches/1.0alpha2/includes/forums/functions_display.php
   cms/branches/1.0alpha2/install/build_data.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php
Log:


Deleted: cms/branches/1.0alpha2/images/Thumbs.db
===================================================================
(Binary files differ)

Added: cms/branches/1.0alpha2/images/icons/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/asterix.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/asterix.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/misc/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/misc/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/branches/1.0alpha2/images/icons/misc/musical.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/musical.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/square.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/square.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/idea.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/idea.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/smilies/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/smilies/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/question.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/question.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/branches/1.0alpha2/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha2/includes/display/display.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/display/display.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -161,7 +161,7 @@
 		if ($_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_new_privmsg'] && $_CLASS['core_user']->user_data_get('popuppm'))
 		{
 			$this->header['js'][] = '<script type="text/javascript">window.open(\''. preg_replace('/&amp;/', '&', generate_link('Control_Panel&i=pm&mode=popup', array('full' => true)))."', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');</script>";
-			$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
+			//$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
 		}
 
 		$this->header['regular'][] = '<meta name="generator" content="Viperal CMS ( www.viperal.com ) Copyright(c) '.date('Y').'" />';

Modified: cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -1363,7 +1363,7 @@
 
 	// Delete forum ids from extension groups table
 	$sql = 'SELECT group_id, allowed_forums 
-		FROM ' . EXTENSION_GROUPS_TABLE . "
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . "
 		WHERE allowed_forums <> ''";
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -1371,7 +1371,7 @@
 	{
 		$allowed_forums = unserialize(trim($row['allowed_forums']));
 		$allowed_forums = array_diff($allowed_forums, $forum_ids);
-		$sql = 'UPDATE ' . EXTENSION_GROUPS_TABLE . " 
+		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . " 
 			SET allowed_forums = '" . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . "'
 			WHERE group_id = {$row['group_id']}";
 		$_CLASS['core_db']->query($sql);
@@ -1384,28 +1384,34 @@
 	{
 		case 'MOVE_POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_name);
-			break;
+		break;
+
 		case 'POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case '_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_name);
 			break;
 		case 'POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_name);
-			break;
+		break;
+
 		case '_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_name);
-			break;
+		break;
+
 		case 'POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_name);
-			break; 
+		break; 
 	}
 
 	return $errors;

Modified: cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -1,1304 +1,1303 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
-//
-// FILENAME  : admin_permissions.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// values need checks
-
-
-// Grab and set some basic parameters
-//
-// 'mode' determines what we're altering; administrators, users, deps, etc.
-// 'submit' is used to determine what we're doing ... special format
-$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
-
-// What mode are we running? So we can output the correct title, explanation
-// and set the sql_option_mode/acl check
-switch ($mode)
-{
-	case 'forum':
-		$l_title = $_CLASS['core_user']->lang['PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_auth';
-		$sql_option_mode = 'f';
-		break;
-
-	case 'mod':
-		$l_title = $_CLASS['core_user']->lang['MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'supermod':
-		$l_title = $_CLASS['core_user']->lang['SUPER_MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'admin':
-		$l_title = $_CLASS['core_user']->lang['ADMINISTRATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['ADMINISTRATORS_EXPLAIN'];
-		$which_acl = 'a_authadmins';
-		$sql_option_mode = 'a';
-		break;
-
-	case 'user':
-		$l_title = $_CLASS['core_user']->lang['USER_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['USER_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authusers';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'group':
-		$l_title = $_CLASS['core_user']->lang['GROUP_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['GROUP_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authgroups';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'deps':
-		$l_title = $_CLASS['core_user']->lang['DEPENDENCIES'];
-		$l_title_explain = $_CLASS['core_user']->lang['DEPENDENCIES_EXPLAIN'];
-		$which_acl = 'a_authdeps';
-		break;
-}
-
-// Permission check
-if (!$_CLASS['auth']->acl_get($which_acl))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
-$which_mode = (!empty($submode) && $submode != $mode) ? $submode : $mode;
-$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
-$submit		= (sizeof($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
-
-// Submitted setting data
-//
-// 'auth_settings' contains the submitted option settings assigned to options, should be an 
-//   associative array with integer values
-$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
-
-
-// Forum, User or Group information
-//
-// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
-// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
-// 'forum_id' contains the list of forums, 0 is used for "All forums", can be array or scalar
-$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
-$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
-
-if (isset($_REQUEST['f']))
-{
-	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
-}
-
-if (!isset($forum_id[$which_mode]))
-{
-	$forum_id[$which_mode][] = 0;
-}
-
-$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
-
-// Generate list of forum id's
-$s_forum_id = '';
-
-foreach ($forum_id as $forum_submode => $forum_submode_ids)
-{
-	foreach ($forum_submode_ids as $submode_forum_id)
-	{
-		$s_forum_id .= '<input type="hidden" name="f[' . $forum_submode . '][]" value="' . $submode_forum_id . '" />';
-	}
-}
-unset($forum_submode_ids);
-unset($forum_submode);
-unset($submode_forum_id);
-
-
-// Instantiate a new auth admin object in readiness
-$auth_admin = new auth_admin();
-
-// Are we setting deps? If we are we need to re-run the mode match above for the
-// relevant 'new' mode
-if (!empty($submode))
-{
-	switch ($submode)
-	{
-		case 'forum':
-			$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
-			$which_acl = 'a_auth';
-			$sql_option_mode = 'f';
-			break;
-
-		case 'mod':
-			$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-
-		case 'supermod':
-			$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-	}
-
-	// Permission check
-	if (!$_CLASS['auth']->acl_get($which_acl))
-	{
-		trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-	}
-}
-
-
-// Does user want to update anything? Check here to find out 
-// and act appropriately
-switch ($submit)
-{
-	case 'update':
-
-		if (sizeof($auth_settings))
-		{
-			// Admin wants subforums to inherit permissions ... so add these
-			// forums to the list ... since inheritance is only available for
-			// forum and moderator primary modes we deal with '$forum_id[$mode]'
-			if (!empty($_POST['inherit']))
-			{
-				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
-			}
-
-			// Update the permission set ... we loop through each auth setting array
-			foreach ($auth_settings as $auth_submode => $auth_setting)
-			{
-				// Are any entries * ? If so we need to remove them since they
-				// are options the user wishes to ignore
-
-				if (in_array('*', $auth_setting))
-				{
-					foreach ($auth_setting as $option => $setting)
-					{
-						if ($setting == '*')
-						{
-							unset($auth_setting[$option]);
-						}
-					}
-				}
-
-				if (!empty($auth_setting))
-				{
-					// Loop through all user/group ids
-					foreach ($ug_data as $id)
-					{
-						$auth_admin->acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
-					}
-				}
-			}
-
-			// Do we need to recache the moderator lists? We do if the mode
-			// was mod or auth_settings['mod'] is a non-zero size array
-			if ($mode == 'mod' || !empty($auth_settings['mod']))
-			{
-				cache_moderators();
-			}
-
-			// Remove users who are now moderators or admins from everyones foes
-			// list
-			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
-			{
-				update_foes();
-			}
-
-			// Logging ... first grab user or groupnames ...
-			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-			$result = $_CLASS['core_db']->query($sql);
-
-			$l_ug_list = '';
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$auth_submode = array_keys($auth_settings);
-			foreach ($auth_submode as $sub_mode)
-			{
-				if (!in_array(0, $forum_id[$sub_mode]))
-				{
-					// Grab the forum details if non-zero forum_id
-					$sql = 'SELECT forum_name  
-						FROM ' . FORUMS_FORUMS_TABLE . "
-						WHERE forum_id IN ($sql_forum_id)";
-					$result = $_CLASS['core_db']->query($sql);
-
-					$l_forum_list = '';
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-					}
-					$_CLASS['core_db']->free_result($result);
-
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
-				}
-				else
-				{
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
-				}
-			}
-			unset($l_ug_list);
-		}
-		unset($auth_submode);
-		unset($auth_setting);
-
-		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
-		break;
-
-	case 'delete':
-
-		$sql = "SELECT auth_option_id
-			FROM " . FORUMS_ACL_OPTIONS_TABLE . "
-			WHERE auth_option LIKE '{$sql_option_mode}_%'";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$option_id_ary = array();
-			do
-			{
-				$option_id_ary[] = $row['auth_option_id'];
-			}
-			while($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-			foreach ($ug_data as $id)
-			{
-				$auth_admin->acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
-			}
-			unset($option_id_ary);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-
-		// Do we need to recache the moderator lists? We do if the mode
-		// was mod or auth_settings['mod'] is a non-zero size array
-		if ($mode == 'mod' || (isset($auth_settings['mod']) && sizeof($auth_settings['mod'])))
-		{
-			cache_moderators();
-		}
-
-		// Logging ... first grab user or groupnames ...
-		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$l_ug_list = '';
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-
-		// Grab the forum details if non-zero forum_id
-		if (!in_array(0, $forum_id[$which_mode]))
-		{
-			$sql = 'SELECT forum_name  
-				FROM ' . FORUMS_FORUMS_TABLE . "
-				WHERE forum_id IN ($sql_forum_id)";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$l_forum_list = '';
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
-		}
-		else
-		{
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
-		}
-
-		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
-		break;
-
-	case 'presetsave':
-
-		$holding_ary = array();
-	
-		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
-
-		foreach ($auth_setting as $option => $setting)
-		{
-			switch ($setting)
-			{
-				case ACL_YES:
-					$holding_ary['yes'][] = $option;
-					break;
-
-				case ACL_NO:
-					$holding_ary['no'][] = $option;
-					break;
-
-				case ACL_UNSET:
-					$holding_ary['unset'][] = $option;
-					break;
-			}
-		}
-
-		$sql = array(
-			'preset_user_id'=> intval($_CLASS['core_user']->data['user_id']),
-			'preset_type'	=> $sql_option_mode,
-			'preset_data'	=> serialize($holding_ary)
-		);
-
-		if (!empty($_POST['presetname']))
-		{	
-			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
-		}
-		
-		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
-		{
-			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
-			$_CLASS['core_db']->query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
-		}
-		unset($sql, $option, $setting, $auth_setting);
-
-		break;
-
-	case 'presetdel':
-
-		if (!empty($_POST['presetoption']))
-		{
-			$sql = "SELECT preset_name 
-				FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . (int) $_POST['presetoption'];
-			$result = $_CLASS['core_db']->query($sql);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			$sql = "DELETE FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . (int) $_POST['presetoption'];
-			$_CLASS['core_db']->query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
-			unset($row);
-		}
-		break;
-}
-// End update
-
-
-// Output page header
-adm_page_header($l_title);
-
-
-// First potential form ... this is for selecting forums, users
-// or groups. 
-if (in_array($mode, array('user', 'group', 'forum', 'mod')) && empty($submit))
-{
-
-?>
-
-<h1><?php echo $l_title; ?></h1>
-
-<p><?php echo $l_title_explain ?></p>
-
-<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-<?php
-
-	// Mode specific markup
-	switch ($mode)
-	{
-		case 'forum':
-		case 'mod':
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="f[<?php echo $mode; ?>][]" multiple="true" size="7"><?php 
-	
-			echo make_forum_select(false, false, false);
-			
-?></select>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_usergroups" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="forum" /><input type="hidden" name="action" value="usergroups" /></td>
-	</tr>
-<?php
-		
-			break;
-
-		case 'user':
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_USER']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center">&nbsp;<textarea cols="40" rows="4" name="ug_data[]"></textarea>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /></td>
-	</tr>
-<?php
-
-			break;
-
-		case 'group':
-			// Generate list of groups
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="ug_data[]" multiple="true" size="7"><?php 
-
-			$sql = "SELECT group_id, group_name, group_type   
-				FROM " . GROUPS_TABLE . " 
-				ORDER BY group_type DESC";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$group_options = '';
-			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				do
-				{
-					echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-				}
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-			}
-			$_CLASS['core_db']->free_result($result);
-			
-?></select>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /></td>
-	</tr>
-<?php
-
-		break;
-
-	}
-
-?>
-</table></form>
-
-<?php
-
-}
-// End user, group or forum selection
-
-
-// Second possible form, this lists the currently enabled
-// users/groups for the given mode
-if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') && empty($submode) && in_array($mode, array('admin', 'supermod'))))
-{
-
-?>
-
-<h1><?php echo $l_title; ?></h1>
-
-<p><?php echo $l_title_explain; ?></p>
-
-<table width="100%" cellspacing="0" cellpadding="0" border="0">
-	<tr>
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['MANAGE_USERS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php
-			
-	$sql = "SELECT u.user_id, u.username
-		FROM " . USERS_TABLE . " u, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
-		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
-			AND a.auth_option_id = o.auth_option_id
-			AND a.forum_id IN ($sql_forum_id)
-			AND u.user_id = a.user_id
-		ORDER BY u.username, u.user_reg_date ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$users = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-		
-?></select></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-
-		<td align="center"><form method="post" name="admingroups" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-		<tr>
-			<th><?php echo $_CLASS['core_user']->lang['MANAGE_GROUPS']; ?></th>
-		</tr>
-		<tr>
-			<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php 
-	
-	$sql = "SELECT DISTINCT g.group_id, g.group_name, g.group_type 
-		FROM " . GROUPS_TABLE . " g, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
-		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
-			AND a.forum_id IN ($sql_forum_id)
-			AND a.auth_option_id = o.auth_option_id
-			AND g.group_id = a.group_id
-		ORDER BY g.group_type DESC, g.group_name ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$groups = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-
-?></select></td>
-		</tr>
-		<tr>
-			<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
-		</tr>
-	</table></form></td>
-
-	</tr>
-	<tr>
-
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" align="center"><textarea style="height:60px" cols="40" rows="4" name="ug_data[]"></textarea></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&amp;field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['ADD_GROUPS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" style="height: 100%" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple"  size="5"><?php 
-			
-	$sql = "SELECT group_id, group_name, group_type 
-		FROM " . GROUPS_TABLE . "
-		ORDER BY group_type DESC, group_name";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$group_list = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-		
-?></select></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-	</tr>
-</table>
-
-<?php
-
-}
-// End user and group acl selections
-
-
-
-
-
-
-// Third possible form, this is the major section of this script. It
-// handles the entry of permission options for all situations
-if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
-{
-
-	// Did the user specify any users or groups?
-	if (empty($ug_data))
-	{
-		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
-		trigger_error($_CLASS['core_user']->lang[$l_message]);
-	}
-
-
-	$forum_list = '';
-	// Grab the forum details if non-zero forum_id
-	if (!in_array(0, $forum_id[$which_mode]))
-	{
-		$sql = 'SELECT forum_id, forum_name, parent_id  
-			FROM ' . FORUMS_FORUMS_TABLE . "
-			WHERE forum_id IN ($sql_forum_id)";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
-		}
-
-		// If we have more than one forum we want a list of all their names
-		// so loop through all results. We don't need all the data though 
-		// since cascading/inheritance is only applicable if a single forum
-		// was selected
-		$forum_data = $row;
-
-		do
-		{
-			$forum_list .= (($forum_list != '') ? ', ' : '') . '<b>' . $row['forum_name'] . '</b>';
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-		$_CLASS['core_db']->free_result($result);
-	}
-
-
-	// Grab relevant user or group information
-	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
-// need some work ( array_mapping()) blaa blaa
-	switch ($ug_type)
-	{
-		case 'user':
-			$l_no_error = $_CLASS['core_user']->lang['NO_USER'];
-			$sql = 'SELECT user_id AS id, username AS name 
-				FROM ' . USERS_TABLE . ' 
-				WHERE ';
-			$sql .= ($submit == 'add_options') ? " username IN ('" . implode("', '", $_CLASS['core_db']->escape_array(array_unique(explode("\n", modify_lines($ug_data[0], "\n"))))) . "')" : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
-		break;
-
-		case 'group':
-			$l_no_error = $_CLASS['core_user']->lang['NO_GROUP'];
-			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
-				FROM ' . GROUPS_TABLE . '
-				WHERE group_id';
-			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
-		break;
-	}
-	$result = $_CLASS['core_db']->query($sql);
-
-	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		trigger_error($l_no_error);
-	}
-	unset($l_no_error);
-
-	// Store the user_ids and names for later use
-	do 
-	{
-		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<b class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] : '<b>' . $row['name']) . '</b>';
-		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
-		$ug_hidden .= '<input type="hidden" name="ug_data[]" value="' . $row['id'] . '" />';
-	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	$_CLASS['core_db']->free_result($result);
-
-
-	// Grab the list of options ... if we're in deps mode we want all options, 
-	// else we skip the master options
-	$sql_limit_option = ($mode == 'deps') ? '' : "AND auth_option <> '" . $sql_option_mode . "_'";
-	$sql = "SELECT auth_option_id, auth_option
-		FROM " . FORUMS_ACL_OPTIONS_TABLE . "
-		WHERE auth_option LIKE '" . $sql_option_mode . "_%' 
-			$sql_limit_option";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$auth_options = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$auth_presets_compare[] = $row['auth_option'];
-		$auth_options[] = $row;
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	unset($sql_limit_option);
-
-
-	// Now we'll build a list of preset options ...
-	$preset_options = $preset_js = $preset_update_options = '';
-
-	// Do we have a parent forum? If so offer option to inherit from that
-	if ($forum_data['parent_id'] != 0)
-	{
-		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-		 
-		$sql = "SELECT o.auth_option, a.auth_setting
-					FROM " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o 
-					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
-						AND a.auth_option_id = o.auth_option_id AND a.forum_id = " . $forum_data['parent_id'] . '
-						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)";
-
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			do
-			{
-				switch ($row['auth_setting'])
-				{
-					case ACL_YES:
-						$holding['yes'][] = $row['auth_option'];
-					break;
-
-					case ACL_NO:
-						$holding['no'][] = $row['auth_option'];
-					break;
-				}
-			}
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_options .= '<option value="preset_0">' . $_CLASS['core_user']->lang['INHERIT_PARENT'] . '</option>';
-			$preset_js .= "\tpresets['preset_0'] = new Array();" . "\n";
-			$preset_js .= "\tpresets['preset_0'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
-
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-	// Look for custom presets
-	$sql = "SELECT preset_id, preset_name, preset_data  
-		FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-		WHERE preset_type = '" . (($mode == 'deps') ? 'f' : $sql_option_mode) . "' 
-		ORDER BY preset_id ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		do
-		{
-			$preset_update_options .= '<option value="' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
-			$preset_options .= '<option value="preset_' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
-
-			$holding = unserialize($row['preset_data']);
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new Array();" . "\n";
-			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	unset($holding, $auth_presets_compare);
-
-
-	// If we aren't looking @ deps then we try and grab existing sessions for
-	// the given forum and user/group
-	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
-	{
-		if ($which_mode == $mode)
-		{
-			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
-					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o 
-					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
-						AND a.auth_option_id = o.auth_option_id 
-						AND a.forum_id IN ($sql_forum_id) 
-						AND a.".(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)
-					GROUP BY o.auth_option";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$auth_settings[$which_mode] = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-		else
-		{
-			// We're looking at a view ... so we'll set all options to unset
-			// We could be a little more clever here but the "safe side" looks
-			// better right now
-			$auth_settings[$which_mode] = array();
-			foreach ($auth_options as $option)
-			{
-				$auth_settings[$which_mode][$option['auth_option']] = '*';
-			}
-			unset($option);
-		}
-	}
-
-	$view_options = '';
-	// Should we display a dropdown for views?
-	if (in_array($mode, array('admin', 'supermod', 'mod')))
-	{
-		$view_options .= '<option value="">' . $_CLASS['core_user']->lang['SELECT_VIEW'] . '</option>';
-		$view_ary = array(
-			'admin'		=> array('admin' => 'a_', 'forum' => 'a_auth', 'supermod' => 'a_authmods', 'mod' => 'a_authmods'),
-			'supermod'	=> array('supermod' => 'a_authmods', 'mod' => 'a_authmods', 'forum' => 'a_auth'), 
-			'mod'		=> array('mod' => 'a_authmods', 'forum' => 'a_auth')
-		);
-
-		foreach ($view_ary[$mode] as $which_submode => $which_acl)
-		{
-			if ($_CLASS['auth']->acl_get($which_acl))
-			{
-				$view_options .= '<option value="' . $which_submode . '"' . (($which_submode == $which_mode) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ACL_VIEW_' . strtoupper($which_submode)] . '</option>';
-			}
-
-		}
-		unset($view_ary);
-	}
-
-	$settings_hidden = '';
-	// Output original settings ... needed when we jump views
-	foreach ($auth_settings as $auth_submode => $auth_submode_settings)
-	{
-		if ($auth_submode != $which_mode)
-		{
-			foreach ($auth_submode_settings as $submode_option => $submode_setting)
-			{
-				$settings_hidden .= ($submode_setting != '*') ? '<input type="hidden" name="settings[' . $auth_submode . '][' . $submode_option . ']" value="' . $submode_setting . '" />' : '';
-			}
-		}
-	}
-	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
-
-?>
-
-<script language="Javascript" type="text/javascript">
-<!--
-
-	var presets = new Array();
-<?php
-
-	echo $preset_js;
-
-?>
-
-	function preset_obj(yes, no, unset)
-	{
-		this.yes = yes;
-		this.no = no;
-		this.unset = unset;
-	}
-
-	function use_preset(option)
-	{
-		if (option)
-		{
-			document.acl.set.selectedIndex = 0;
-			for (i = 0; i < document.acl.length; i++)
-			{
-				var elem = document.acl.elements[i];
-				if (elem.name.indexOf('settings') == 0)
-				{
-					switch (option)
-					{
-						case 'all_yes':
-							if (elem.value == <?php echo ACL_YES; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_no':
-							if (elem.value == <?php echo ACL_NO; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_unset':
-							if (elem.value == <?php echo ACL_UNSET; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_ignore':
-							if (elem.value == '*')
-								elem.checked = true;
-							break;
-
-						default:
-							option_start = elem.name.search(/\[(\w+?)\]$/);
-							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
-
-							if (presets[option].yes.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_YES; ?>)
-								elem.checked = true;
-							else if (presets[option].no.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_NO; ?>)
-								elem.checked = true;
-							else if (presets[option].unset.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_UNSET; ?>)
-								elem.checked = true;
-							break;
-					}
-				}
-			}
-		}
-	}
-
-	function marklist(match, status)
-	{
-		for (i = 0; i < document.acl.length; i++)
-		{
-			if (document.acl.elements[i].name.indexOf(match) == 0)
-				document.acl.elements[i].checked = status;
-		}
-	}
-
-	function open_win(url, width, height)
-	{
-		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
-		if (window.focus)
-			aclwin.focus();
-	}
-//-->
-</script>
-
-<p><?php echo $_CLASS['core_user']->lang['ACL_EXPLAIN']; ?></p>
-
-<h1><?php echo $l_title; ?></h1>
-
-<?php
-
-	// Do we have a list of forums? If so, output them ... but only
-	// if we're looking at the primary view or mode ... submodes
-	// output their own list of forums as and where applicable so this
-	// is unnecessary
-	if ($forum_list != '' && $which_mode == $mode)
-	{
-		$l_selected_forums = (sizeof($forum_id[$which_mode]) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
-
-		echo '<p>' . $_CLASS['core_user']->lang[$l_selected_forums] . ': ' . $forum_list . '</p>';
-
-		unset($forum_list);
-		unset($l_selected_forums);
-	}
-
-	// Now output the list of users or groups ... these will always exist
-	$l_selected_users = ($ug_type == 'user') ? ((sizeof($ug_data) == 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((sizeof($ug_data) == 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
-
-	echo '<p>' . $_CLASS['core_user']->lang[$l_selected_users] . ': ' . $l_ug_list . '</p>';
-
-	unset($l_selected_users);
-	unset($ug_data);
-
-?>
-
-<p><?php echo $l_title_explain; ?></p>
-
-<?php
-
-	if ($settings_hidden != '')
-	{
-
-?>
-
-<h2 style="color:red"><?php echo $_CLASS['core_user']->lang['WARNING']; ?></h2>
-
-<p><?php echo $_CLASS['core_user']->lang['WARNING_EXPLAIN']; ?></p>
-
-<?php
-
-	}
-
-?>
-
-<form method="post" name="acl" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' => true)); ?>"><table cellspacing="2" cellpadding="0" border="0" align="center">
-<?php
-
-	// This is the main listing of options
-
-	// We output this for both deps and when update is requested where
-	// deps exist
-	if (($mode == 'admin' || $mode == 'supermod') && in_array($submode, array('forum', 'mod')))
-	{
-
-?>
-	<tr>
-		<td colspan="2" align="right"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0">
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['SELECT_FORUM']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="2"><?php echo $_CLASS['core_user']->lang['WILL_SET_OPTIONS']; ?>:</th>
-			</tr>
-			<tr>
-				<td class="row2"><select style="width:100%" name="f[<?php echo $which_mode; ?>][]" multiple="7"><?php 
-		
-		echo make_forum_select($forum_id[$which_mode], false, true); 
-		
-?></select></td>
-			</tr>
-		</table><br /></td>
-	</tr>
-<?php
-
-	}
-	// End deps output
-
-?>
-	<tr>
-		<td align="left"><?php
-	
-	if ($view_options != '')
-	{
-	
-?><select name="submode" onchange="if (this.options[this.selectedIndex].value != '') this.form.submit();"><?php echo $view_options; ?></select><?php
-	
-	}
-	
-?></td>
-		<td align="right"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?>: <select name="set" onchange="use_preset(this.options[this.selectedIndex].value);"><option class="sep"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><option value="all_yes"><?php echo $_CLASS['core_user']->lang['ALL_YES']; ?></option><option value="all_no"><?php echo $_CLASS['core_user']->lang['ALL_NO']; ?></option><option value="all_unset"><?php echo $_CLASS['core_user']->lang['ALL_UNSET']; ?></option><?php 
-
-	$colspan = 4;
-	if ($which_mode != $mode)
-	{
-		$colspan = 5;
-		echo '<option value="all_ignore">' . $_CLASS['core_user']->lang['ALL_IGNORE'] . '</option>';
-	}
-
-	// Output user preset options ... if any
-	echo ($preset_options) ? '<option class="sep">' . $_CLASS['core_user']->lang['USER_PRESETS'] . ' -&gt;' . '</option>' . $preset_options : ''; 
-
-?></select></td>
-	</tr>
-	<tr>
-		<td colspan="2"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th>&nbsp;<?php echo $_CLASS['core_user']->lang['OPTION']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['YES']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['UNSET']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['NO']; ?>&nbsp;</th>
-<?php
-
-	if ($which_mode != $mode)
-	{
-
-?>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['IGNORE']; ?>&nbsp;</th>
-<?php
-
-	}
-
-?>
-			</tr>
-<?php
-
-	$row_class = 'row2';
-	for ($i = 0; $i < sizeof($auth_options); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-		// Try and output correct language strings, else output prettyfied auth_option
-		$l_auth_option = (!empty($_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
-		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
-
-		
-		// Which option should we select?
-		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked="checked"' : '';
-		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked="checked"' : '';
-		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked="checked"' : '';
-
-?>
-			<tr>
-				<td class="<?php echo $row_class; ?>" nowrap="nowrap"><?php echo $l_auth_option; ?>&nbsp;</td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_YES; ?>"<?php echo $selected_yes; ?> /></td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_UNSET; ?>"<?php echo $selected_unset; ?> /></td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_NO; ?>"<?php echo $selected_no; ?> /></td>
-<?php
-
-		if ($which_mode != $mode)
-		{
-			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked="checked"' : '';
-
-?>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="*"<?php echo $selected_ignore; ?> /></td>
-<?php
-
-		}
-
-?>
-			</tr>
-<?php
-
-	}
-
-
-	// If we're setting forum or moderator options and a single forum has
-	// been selected then look to see if any subforums exist. If they do
-	// give user the option of cascading permissions to them
-	if (($mode == 'forum' || $mode == 'mod') && empty($submode) && sizeof($forum_id[$which_mode]) == 1)
-	{
-		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
-
-		if (!empty($children))
-		{
-
-?>
-			<tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="<?php echo $colspan; ?>"><table width="100%" cellspacing="1" cellpadding="0" border="0">
-					<tr>
-						<td class="gensmall" colspan="4" height="16" align="center"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS_EXPLAIN']; ?></td>
-					</tr>
-<?php
-
-			foreach ($children as $row)
-			{
-
-?>
-					<tr>
-						<td><input type="checkbox" name="inherit[]" value="<?php echo $row['forum_id']; ?>" /> <?php echo $row['forum_name']; ?></td>
-					</tr>
-<?php
-
-			}
-
-?>
-					<tr>
-						<td height="16" align="center"><a class="gensmall" href="javascript:marklist('inherit', true);"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('inherit', false);" class="gensmall"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></td>
-					</tr>
-				</table></td>
-			</tr>
-<?php
-
-		}
-	}
-
-	// Display event/cron radio buttons
-	if ($_CLASS['auth']->acl_gets('a_events', 'a_cron') && $mode != 'deps' && $submit != 'update')
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-			<!-- tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['RUN_HOW']; ?></th>
-			</tr>
-			<tr>
-				<td class="<?php echo $row_class; ?>" colspan="4" align="center"><input type="radio" name="runas" value="now" checked="checked" /> <?php echo $_CLASS['core_user']->lang['RUN_AS_NOW']; ?><?php 
-	
-			if ($_CLASS['auth']->acl_get('a_events'))
-			{ 
-
-?> &nbsp;<input type="radio" name="runas" value="evt" /> <?php 
-	
-				echo $_CLASS['core_user']->lang['RUN_AS_EVT'];  
-			}
-			
-			if ($_CLASS['auth']->acl_get('a_cron'))
-			{
-
-?> &nbsp;<input type="radio" name="runas" value="crn" /> <?php 
-	
-				echo $_CLASS['core_user']->lang['RUN_AS_CRN']; 
-				
-			}
-
-?></td>
-			</tr -->
-<?php
-
-	}
-
-?>
-			<tr>
-				<td class="cat" colspan="<?php echo $colspan; ?>" align="center"><input class="btnmain" type="submit" name="submit_update" value="<?php echo $_CLASS['core_user']->lang['UPDATE']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="submit_cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" /><input type="hidden" name="ug_type" value="<?php echo $ug_type; ?>" /><?php echo $ug_hidden; ?><?php 
-
-	// Output forum id data
-	echo $s_forum_id;
-
-	// Output settings generated from other views
-	echo $settings_hidden;
-	unset($settings_hidden);
-	
-?></td>
-			</tr>
-		</table>
-
-		<br clear="all" />
-
-		<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th colspan="4"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="4"><table width="100%" cellspacing="1" cellpadding="0" border="0">
-					<tr>
-						<td colspan="2" height="16"><span class="gensmall"><?php echo $_CLASS['core_user']->lang['PRESETS_EXPLAIN']; ?></span></td>
-					</tr>
-					<tr>
-						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['SELECT_PRESET']; ?>: </td>
-						<td><select name="presetoption"><option class="sep" value="-1"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><?php 
-
-	echo $preset_update_options;
-			
-		?></select></td>
-					</tr>
-					<tr>
-						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['PRESET_NAME']; ?>: </td>
-						<td><input type="text" name="presetname" maxlength="25" /> </td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" name="submit_presetsave" value="<?php echo $_CLASS['core_user']->lang['SAVE']; ?>" /> &nbsp;<input class="btnlite" type="submit" name="submit_presetdel" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /></td>
-			</tr>
-		</table></td>
-	</tr>
-</table></form>
-
-<?php
-
-}
-
-// Output page footer
-adm_page_footer();
-
-// ---------
-// FUNCTIONS
-//
-function update_foes()
-{
-	global $_CLASS;
-
-	$perms = array();
-	foreach ($_CLASS['auth']->acl_get_list(false, array('a_', 'm_'), false) as $forum_id => $forum_ary)
-	{
-		foreach ($forum_ary as $auth_option => $user_ary)
-		{
-			$perms += $user_ary;
-		}
-	}
-
-	if (sizeof($perms))
-	{
-		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-	unset($perms);
-}
-//
-// FUNCTIONS
-// ---------
-
+<?php
+// -------------------------------------------------------------
+//
+// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
+//
+// FILENAME  : admin_permissions.php
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : ? 2001, 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// values need checks
+
+
+// Grab and set some basic parameters
+//
+// 'mode' determines what we're altering; administrators, users, deps, etc.
+// 'submit' is used to determine what we're doing ... special format
+$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
+
+// What mode are we running? So we can output the correct title, explanation
+// and set the sql_option_mode/acl check
+switch ($mode)
+{
+	case 'forum':
+		$l_title = $_CLASS['core_user']->lang['PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_auth';
+		$sql_option_mode = 'f';
+		break;
+
+	case 'mod':
+		$l_title = $_CLASS['core_user']->lang['MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'supermod':
+		$l_title = $_CLASS['core_user']->lang['SUPER_MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'admin':
+		$l_title = $_CLASS['core_user']->lang['ADMINISTRATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['ADMINISTRATORS_EXPLAIN'];
+		$which_acl = 'a_authadmins';
+		$sql_option_mode = 'a';
+		break;
+
+	case 'user':
+		$l_title = $_CLASS['core_user']->lang['USER_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['USER_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authusers';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'group':
+		$l_title = $_CLASS['core_user']->lang['GROUP_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['GROUP_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authgroups';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'deps':
+		$l_title = $_CLASS['core_user']->lang['DEPENDENCIES'];
+		$l_title_explain = $_CLASS['core_user']->lang['DEPENDENCIES_EXPLAIN'];
+		$which_acl = 'a_authdeps';
+		break;
+}
+
+// Permission check
+if (!$_CLASS['auth']->acl_get($which_acl))
+{
+	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+}
+
+$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
+$which_mode = (!empty($submode) && $submode != $mode) ? $submode : $mode;
+$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
+$submit		= (count($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
+
+// Submitted setting data
+//
+// 'auth_settings' contains the submitted option settings assigned to options, should be an 
+//   associative array with integer values
+$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
+
+
+// Forum, User or Group information
+//
+// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
+// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
+// 'forum_id' contains the list of forums, 0 is used for "All forums", can be array or scalar
+$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
+$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
+
+if (isset($_REQUEST['f']))
+{
+	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
+}
+
+if (!isset($forum_id[$which_mode]))
+{
+	$forum_id[$which_mode][] = 0;
+}
+
+$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
+
+// Generate list of forum id's
+$s_forum_id = '';
+
+foreach ($forum_id as $forum_submode => $forum_submode_ids)
+{
+	foreach ($forum_submode_ids as $submode_forum_id)
+	{
+		$s_forum_id .= '<input type="hidden" name="f[' . $forum_submode . '][]" value="' . $submode_forum_id . '" />';
+	}
+}
+unset($forum_submode_ids);
+unset($forum_submode);
+unset($submode_forum_id);
+
+
+// Instantiate a new auth admin object in readiness
+$auth_admin = new auth_admin();
+
+// Are we setting deps? If we are we need to re-run the mode match above for the
+// relevant 'new' mode
+if (!empty($submode))
+{
+	switch ($submode)
+	{
+		case 'forum':
+			$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
+			$which_acl = 'a_auth';
+			$sql_option_mode = 'f';
+			break;
+
+		case 'mod':
+			$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+
+		case 'supermod':
+			$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+	}
+
+	// Permission check
+	if (!$_CLASS['auth']->acl_get($which_acl))
+	{
+		trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+	}
+}
+
+
+// Does user want to update anything? Check here to find out 
+// and act appropriately
+switch ($submit)
+{
+	case 'update':
+		if (!empty($auth_settings))
+		{
+			// Admin wants subforums to inherit permissions ... so add these
+			// forums to the list ... since inheritance is only available for
+			// forum and moderator primary modes we deal with '$forum_id[$mode]'
+			if (!empty($_POST['inherit']))
+			{
+				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
+			}
+
+			// Update the permission set ... we loop through each auth setting array
+			foreach ($auth_settings as $auth_submode => $auth_setting)
+			{
+				// Are any entries * ? If so we need to remove them since they
+				// are options the user wishes to ignore
+
+				if (in_array('*', $auth_setting))
+				{
+					foreach ($auth_setting as $option => $setting)
+					{
+						if ($setting == '*')
+						{
+							unset($auth_setting[$option]);
+						}
+					}
+				}
+
+				if (!empty($auth_setting))
+				{
+					// Loop through all user/group ids
+					foreach ($ug_data as $id)
+					{
+						$auth_admin->acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
+					}
+				}
+			}
+
+			// Do we need to recache the moderator lists? We do if the mode
+			// was mod or auth_settings['mod'] is a non-zero size array
+			if ($mode == 'mod' || !empty($auth_settings['mod']))
+			{
+				cache_moderators();
+			}
+
+			// Remove users who are now moderators or admins from everyones foes
+			// list
+			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
+			{
+				update_foes();
+			}
+
+			// Logging ... first grab user or groupnames ...
+			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+			$result = $_CLASS['core_db']->query($sql);
+
+			$l_ug_list = '';
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$auth_submode = array_keys($auth_settings);
+			foreach ($auth_submode as $sub_mode)
+			{
+				if (!in_array(0, $forum_id[$sub_mode]))
+				{
+					// Grab the forum details if non-zero forum_id
+					$sql = 'SELECT forum_name  
+						FROM ' . FORUMS_FORUMS_TABLE . "
+						WHERE forum_id IN ($sql_forum_id)";
+					$result = $_CLASS['core_db']->query($sql);
+
+					$l_forum_list = '';
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
+				}
+				else
+				{
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
+				}
+			}
+			unset($l_ug_list);
+		}
+		unset($auth_submode);
+		unset($auth_setting);
+
+		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
+	break;
+
+	case 'delete':
+		$sql = "SELECT auth_option_id
+			FROM " . FORUMS_ACL_OPTIONS_TABLE . "
+			WHERE auth_option LIKE '{$sql_option_mode}_%'";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$option_id_ary = array();
+			do
+			{
+				$option_id_ary[] = $row['auth_option_id'];
+			}
+			while($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+			foreach ($ug_data as $id)
+			{
+				$auth_admin->acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
+			}
+			unset($option_id_ary);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+
+		// Do we need to recache the moderator lists? We do if the mode
+		// was mod or auth_settings['mod'] is a non-zero size array
+		if ($mode == 'mod' || (isset($auth_settings['mod']) && !empty($auth_settings['mod'])))
+		{
+			cache_moderators();
+		}
+
+		// Logging ... first grab user or groupnames ...
+		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+
+		$l_ug_list = '';
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+
+		// Grab the forum details if non-zero forum_id
+		if (!in_array(0, $forum_id[$which_mode]))
+		{
+			$sql = 'SELECT forum_name  
+				FROM ' . FORUMS_FORUMS_TABLE . "
+				WHERE forum_id IN ($sql_forum_id)";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$l_forum_list = '';
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
+		}
+		else
+		{
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
+		}
+
+		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
+	break;
+
+	case 'presetsave':
+		$holding_ary = array();
+	
+		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
+
+		foreach ($auth_setting as $option => $setting)
+		{
+			switch ($setting)
+			{
+				case ACL_YES:
+					$holding_ary['yes'][] = $option;
+				break;
+
+				case ACL_NO:
+					$holding_ary['no'][] = $option;
+				break;
+
+				case ACL_UNSET:
+					$holding_ary['unset'][] = $option;
+				break;
+			}
+		}
+
+		$sql = array(
+			'preset_user_id'=> (int) $_CLASS['core_user']->data['user_id'],
+			'preset_type'	=> $sql_option_mode,
+			'preset_data'	=> serialize($holding_ary)
+		);
+
+		if (!empty($_POST['presetname']))
+		{	
+			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
+		}
+		
+		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
+		{
+			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . (int) $_POST['presetoption'];
+			$_CLASS['core_db']->query($sql);
+
+			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
+		}
+		unset($sql, $option, $setting, $auth_setting);
+	break;
+
+	case 'presetdel':
+		if (!empty($_POST['presetoption']))
+		{
+			$sql = "SELECT preset_name 
+				FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+				WHERE preset_id = " . (int) $_POST['presetoption'];
+			$result = $_CLASS['core_db']->query($sql);
+
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($row)
+			{
+				$sql = "DELETE FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+					WHERE preset_id = " . (int) $_POST['presetoption'];
+				$_CLASS['core_db']->query($sql);
+	
+				add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
+			}
+			unset($row);
+		}
+	break;
+}
+// End update
+
+
+// Output page header
+adm_page_header($l_title);
+
+
+// First potential form ... this is for selecting forums, users
+// or groups. 
+if (in_array($mode, array('user', 'group', 'forum', 'mod')) && empty($submit))
+{
+
+?>
+
+<h1><?php echo $l_title; ?></h1>
+
+<p><?php echo $l_title_explain ?></p>
+
+<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+<?php
+
+	// Mode specific markup
+	switch ($mode)
+	{
+		case 'forum':
+		case 'mod':
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="f[<?php echo $mode; ?>][]" multiple="true" size="7"><?php 
+	
+			echo make_forum_select(false, false, false);
+			
+?></select>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_usergroups" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="forum" /><input type="hidden" name="action" value="usergroups" /></td>
+	</tr>
+<?php
+		
+			break;
+
+		case 'user':
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_USER']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center">&nbsp;<textarea cols="40" rows="4" name="ug_data[]"></textarea>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /></td>
+	</tr>
+<?php
+
+			break;
+
+		case 'group':
+			// Generate list of groups
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="ug_data[]" multiple="true" size="7"><?php 
+
+			$sql = "SELECT group_id, group_name, group_type   
+				FROM " . GROUPS_TABLE . " 
+				ORDER BY group_type DESC";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$group_options = '';
+			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				do
+				{
+					echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+				}
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+			}
+			$_CLASS['core_db']->free_result($result);
+			
+?></select>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /></td>
+	</tr>
+<?php
+
+		break;
+
+	}
+
+?>
+</table></form>
+
+<?php
+
+}
+// End user, group or forum selection
+
+
+// Second possible form, this lists the currently enabled
+// users/groups for the given mode
+if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') && empty($submode) && in_array($mode, array('admin', 'supermod'))))
+{
+
+?>
+
+<h1><?php echo $l_title; ?></h1>
+
+<p><?php echo $l_title_explain; ?></p>
+
+<table width="100%" cellspacing="0" cellpadding="0" border="0">
+	<tr>
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['MANAGE_USERS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php
+			
+	$sql = "SELECT u.user_id, u.username
+		FROM " . USERS_TABLE . " u, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
+		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
+			AND a.auth_option_id = o.auth_option_id
+			AND a.forum_id IN ($sql_forum_id)
+			AND u.user_id = a.user_id
+		ORDER BY u.username, u.user_reg_date ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$users = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+		
+?></select></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+
+		<td align="center"><form method="post" name="admingroups" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+		<tr>
+			<th><?php echo $_CLASS['core_user']->lang['MANAGE_GROUPS']; ?></th>
+		</tr>
+		<tr>
+			<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php 
+	
+	$sql = "SELECT DISTINCT g.group_id, g.group_name, g.group_type 
+		FROM " . GROUPS_TABLE . " g, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
+		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
+			AND a.forum_id IN ($sql_forum_id)
+			AND a.auth_option_id = o.auth_option_id
+			AND g.group_id = a.group_id
+		ORDER BY g.group_type DESC, g.group_name ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$groups = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+
+?></select></td>
+		</tr>
+		<tr>
+			<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
+		</tr>
+	</table></form></td>
+
+	</tr>
+	<tr>
+
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" align="center"><textarea style="height:60px" cols="40" rows="4" name="ug_data[]"></textarea></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&amp;field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['ADD_GROUPS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" style="height: 100%" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple"  size="5"><?php 
+			
+	$sql = "SELECT group_id, group_name, group_type 
+		FROM " . GROUPS_TABLE . "
+		ORDER BY group_type DESC, group_name";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$group_list = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+		
+?></select></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+	</tr>
+</table>
+
+<?php
+
+}
+// End user and group acl selections
+
+
+
+
+
+
+// Third possible form, this is the major section of this script. It
+// handles the entry of permission options for all situations
+if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
+{
+
+	// Did the user specify any users or groups?
+	if (empty($ug_data))
+	{
+		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
+		trigger_error($_CLASS['core_user']->lang[$l_message]);
+	}
+
+
+	$forum_list = '';
+	// Grab the forum details if non-zero forum_id
+	if (!in_array(0, $forum_id[$which_mode]))
+	{
+		$sql = 'SELECT forum_id, forum_name, parent_id  
+			FROM ' . FORUMS_FORUMS_TABLE . "
+			WHERE forum_id IN ($sql_forum_id)";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
+		}
+
+		// If we have more than one forum we want a list of all their names
+		// so loop through all results. We don't need all the data though 
+		// since cascading/inheritance is only applicable if a single forum
+		// was selected
+		$forum_data = $row;
+
+		do
+		{
+			$forum_list .= (($forum_list != '') ? ', ' : '') . '<b>' . $row['forum_name'] . '</b>';
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+		$_CLASS['core_db']->free_result($result);
+	}
+
+
+	// Grab relevant user or group information
+	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
+// need some work ( array_mapping()) blaa blaa
+	switch ($ug_type)
+	{
+		case 'user':
+			$l_no_error = $_CLASS['core_user']->lang['NO_USER'];
+			$sql = 'SELECT user_id AS id, username AS name 
+				FROM ' . USERS_TABLE . ' 
+				WHERE ';
+			$sql .= ($submit == 'add_options') ? " username IN ('" . implode("', '", $_CLASS['core_db']->escape_array(array_unique(explode("\n", modify_lines($ug_data[0], "\n"))))) . "')" : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
+		break;
+
+		case 'group':
+			$l_no_error = $_CLASS['core_user']->lang['NO_GROUP'];
+			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
+				FROM ' . GROUPS_TABLE . '
+				WHERE group_id';
+			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
+		break;
+	}
+	$result = $_CLASS['core_db']->query($sql);
+
+	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		trigger_error($l_no_error);
+	}
+	unset($l_no_error);
+
+	// Store the user_ids and names for later use
+	do 
+	{
+		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<b class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] : '<b>' . $row['name']) . '</b>';
+		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
+		$ug_hidden .= '<input type="hidden" name="ug_data[]" value="' . $row['id'] . '" />';
+	}
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	$_CLASS['core_db']->free_result($result);
+
+
+	// Grab the list of options ... if we're in deps mode we want all options, 
+	// else we skip the master options
+	$sql_limit_option = ($mode == 'deps') ? '' : "AND auth_option <> '" . $sql_option_mode . "_'";
+	$sql = "SELECT auth_option_id, auth_option
+		FROM " . FORUMS_ACL_OPTIONS_TABLE . "
+		WHERE auth_option LIKE '" . $sql_option_mode . "_%' 
+			$sql_limit_option";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$auth_options = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$auth_presets_compare[] = $row['auth_option'];
+		$auth_options[] = $row;
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	unset($sql_limit_option);
+
+
+	// Now we'll build a list of preset options ...
+	$preset_options = $preset_js = $preset_update_options = '';
+
+	// Do we have a parent forum? If so offer option to inherit from that
+	if ($forum_data['parent_id'] != 0)
+	{
+		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+		 
+		$sql = "SELECT o.auth_option, a.auth_setting
+					FROM " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o 
+					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
+						AND a.auth_option_id = o.auth_option_id AND a.forum_id = " . $forum_data['parent_id'] . '
+						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)";
+
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			do
+			{
+				switch ($row['auth_setting'])
+				{
+					case ACL_YES:
+						$holding['yes'][] = $row['auth_option'];
+					break;
+
+					case ACL_NO:
+						$holding['no'][] = $row['auth_option'];
+					break;
+				}
+			}
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_options .= '<option value="preset_0">' . $_CLASS['core_user']->lang['INHERIT_PARENT'] . '</option>';
+			$preset_js .= "\tpresets['preset_0'] = new Array();" . "\n";
+			$preset_js .= "\tpresets['preset_0'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
+
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+	// Look for custom presets
+	$sql = "SELECT preset_id, preset_name, preset_data  
+		FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+		WHERE preset_type = '" . (($mode == 'deps') ? 'f' : $sql_option_mode) . "' 
+		ORDER BY preset_id ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		do
+		{
+			$preset_update_options .= '<option value="' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
+			$preset_options .= '<option value="preset_' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
+
+			$holding = unserialize($row['preset_data']);
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new Array();" . "\n";
+			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	unset($holding, $auth_presets_compare);
+
+
+	// If we aren't looking @ deps then we try and grab existing sessions for
+	// the given forum and user/group
+	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
+	{
+		if ($which_mode == $mode)
+		{
+			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
+					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o 
+					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
+						AND a.auth_option_id = o.auth_option_id 
+						AND a.forum_id IN ($sql_forum_id) 
+						AND a.".(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)
+					GROUP BY o.auth_option";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$auth_settings[$which_mode] = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+		else
+		{
+			// We're looking at a view ... so we'll set all options to unset
+			// We could be a little more clever here but the "safe side" looks
+			// better right now
+			$auth_settings[$which_mode] = array();
+			foreach ($auth_options as $option)
+			{
+				$auth_settings[$which_mode][$option['auth_option']] = '*';
+			}
+			unset($option);
+		}
+	}
+
+	$view_options = '';
+	// Should we display a dropdown for views?
+	if (in_array($mode, array('admin', 'supermod', 'mod')))
+	{
+		$view_options .= '<option value="">' . $_CLASS['core_user']->lang['SELECT_VIEW'] . '</option>';
+		$view_ary = array(
+			'admin'		=> array('admin' => 'a_', 'forum' => 'a_auth', 'supermod' => 'a_authmods', 'mod' => 'a_authmods'),
+			'supermod'	=> array('supermod' => 'a_authmods', 'mod' => 'a_authmods', 'forum' => 'a_auth'), 
+			'mod'		=> array('mod' => 'a_authmods', 'forum' => 'a_auth')
+		);
+
+		foreach ($view_ary[$mode] as $which_submode => $which_acl)
+		{
+			if ($_CLASS['auth']->acl_get($which_acl))
+			{
+				$view_options .= '<option value="' . $which_submode . '"' . (($which_submode == $which_mode) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ACL_VIEW_' . strtoupper($which_submode)] . '</option>';
+			}
+
+		}
+		unset($view_ary);
+	}
+
+	$settings_hidden = '';
+	// Output original settings ... needed when we jump views
+	foreach ($auth_settings as $auth_submode => $auth_submode_settings)
+	{
+		if ($auth_submode != $which_mode)
+		{
+			foreach ($auth_submode_settings as $submode_option => $submode_setting)
+			{
+				$settings_hidden .= ($submode_setting != '*') ? '<input type="hidden" name="settings[' . $auth_submode . '][' . $submode_option . ']" value="' . $submode_setting . '" />' : '';
+			}
+		}
+	}
+	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
+
+?>
+
+<script language="Javascript" type="text/javascript">
+<!--
+
+	var presets = new Array();
+<?php
+
+	echo $preset_js;
+
+?>
+
+	function preset_obj(yes, no, unset)
+	{
+		this.yes = yes;
+		this.no = no;
+		this.unset = unset;
+	}
+
+	function use_preset(option)
+	{
+		if (option)
+		{
+			document.acl.set.selectedIndex = 0;
+			for (i = 0; i < document.acl.length; i++)
+			{
+				var elem = document.acl.elements[i];
+				if (elem.name.indexOf('settings') == 0)
+				{
+					switch (option)
+					{
+						case 'all_yes':
+							if (elem.value == <?php echo ACL_YES; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_no':
+							if (elem.value == <?php echo ACL_NO; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_unset':
+							if (elem.value == <?php echo ACL_UNSET; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_ignore':
+							if (elem.value == '*')
+								elem.checked = true;
+							break;
+
+						default:
+							option_start = elem.name.search(/\[(\w+?)\]$/);
+							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
+
+							if (presets[option].yes.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_YES; ?>)
+								elem.checked = true;
+							else if (presets[option].no.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_NO; ?>)
+								elem.checked = true;
+							else if (presets[option].unset.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_UNSET; ?>)
+								elem.checked = true;
+							break;
+					}
+				}
+			}
+		}
+	}
+
+	function marklist(match, status)
+	{
+		for (i = 0; i < document.acl.length; i++)
+		{
+			if (document.acl.elements[i].name.indexOf(match) == 0)
+				document.acl.elements[i].checked = status;
+		}
+	}
+
+	function open_win(url, width, height)
+	{
+		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
+		if (window.focus)
+			aclwin.focus();
+	}
+//-->
+</script>
+
+<p><?php echo $_CLASS['core_user']->lang['ACL_EXPLAIN']; ?></p>
+
+<h1><?php echo $l_title; ?></h1>
+
+<?php
+
+	// Do we have a list of forums? If so, output them ... but only
+	// if we're looking at the primary view or mode ... submodes
+	// output their own list of forums as and where applicable so this
+	// is unnecessary
+	if ($forum_list != '' && $which_mode == $mode)
+	{
+		$l_selected_forums = (count($forum_id[$which_mode]) === 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
+
+		echo '<p>' . $_CLASS['core_user']->lang[$l_selected_forums] . ': ' . $forum_list . '</p>';
+
+		unset($forum_list);
+		unset($l_selected_forums);
+	}
+
+	// Now output the list of users or groups ... these will always exist
+	$l_selected_users = ($ug_type == 'user') ? ((count($ug_data) === 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((count($ug_data) === 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
+
+	echo '<p>' . $_CLASS['core_user']->lang[$l_selected_users] . ': ' . $l_ug_list . '</p>';
+
+	unset($l_selected_users);
+	unset($ug_data);
+
+?>
+
+<p><?php echo $l_title_explain; ?></p>
+
+<?php
+
+	if ($settings_hidden != '')
+	{
+
+?>
+
+<h2 style="color:red"><?php echo $_CLASS['core_user']->lang['WARNING']; ?></h2>
+
+<p><?php echo $_CLASS['core_user']->lang['WARNING_EXPLAIN']; ?></p>
+
+<?php
+
+	}
+
+?>
+
+<form method="post" name="acl" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' => true)); ?>"><table cellspacing="2" cellpadding="0" border="0" align="center">
+<?php
+
+	// This is the main listing of options
+
+	// We output this for both deps and when update is requested where
+	// deps exist
+	if (($mode == 'admin' || $mode == 'supermod') && in_array($submode, array('forum', 'mod')))
+	{
+
+?>
+	<tr>
+		<td colspan="2" align="right"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0">
+			<tr>
+				<th colspan="2"><?php echo $_CLASS['core_user']->lang['SELECT_FORUM']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="2"><?php echo $_CLASS['core_user']->lang['WILL_SET_OPTIONS']; ?>:</th>
+			</tr>
+			<tr>
+				<td class="row2"><select style="width:100%" name="f[<?php echo $which_mode; ?>][]" multiple="7"><?php 
+		
+		echo make_forum_select($forum_id[$which_mode], false, true); 
+		
+?></select></td>
+			</tr>
+		</table><br /></td>
+	</tr>
+<?php
+
+	}
+	// End deps output
+
+?>
+	<tr>
+		<td align="left"><?php
+	
+	if ($view_options != '')
+	{
+	
+?><select name="submode" onchange="if (this.options[this.selectedIndex].value != '') this.form.submit();"><?php echo $view_options; ?></select><?php
+	
+	}
+	
+?></td>
+		<td align="right"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?>: <select name="set" onchange="use_preset(this.options[this.selectedIndex].value);"><option class="sep"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><option value="all_yes"><?php echo $_CLASS['core_user']->lang['ALL_YES']; ?></option><option value="all_no"><?php echo $_CLASS['core_user']->lang['ALL_NO']; ?></option><option value="all_unset"><?php echo $_CLASS['core_user']->lang['ALL_UNSET']; ?></option><?php 
+
+	$colspan = 4;
+	if ($which_mode != $mode)
+	{
+		$colspan = 5;
+		echo '<option value="all_ignore">' . $_CLASS['core_user']->lang['ALL_IGNORE'] . '</option>';
+	}
+
+	// Output user preset options ... if any
+	echo ($preset_options) ? '<option class="sep">' . $_CLASS['core_user']->lang['USER_PRESETS'] . ' -&gt;' . '</option>' . $preset_options : ''; 
+
+?></select></td>
+	</tr>
+	<tr>
+		<td colspan="2"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th>&nbsp;<?php echo $_CLASS['core_user']->lang['OPTION']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['YES']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['UNSET']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['NO']; ?>&nbsp;</th>
+<?php
+
+	if ($which_mode != $mode)
+	{
+
+?>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['IGNORE']; ?>&nbsp;</th>
+<?php
+
+	}
+
+?>
+			</tr>
+<?php
+
+	$row_class = 'row2';
+
+	$count = count($auth_options);
+	for ($i = 0; $i < $count; $i++)
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+		// Try and output correct language strings, else output prettyfied auth_option
+		$l_auth_option = (!empty($_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
+		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
+		
+		// Which option should we select?
+		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked="checked"' : '';
+		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked="checked"' : '';
+		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked="checked"' : '';
+
+?>
+			<tr>
+				<td class="<?php echo $row_class; ?>" nowrap="nowrap"><?php echo $l_auth_option; ?>&nbsp;</td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_YES; ?>"<?php echo $selected_yes; ?> /></td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_UNSET; ?>"<?php echo $selected_unset; ?> /></td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_NO; ?>"<?php echo $selected_no; ?> /></td>
+<?php
+
+		if ($which_mode != $mode)
+		{
+			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked="checked"' : '';
+
+?>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="*"<?php echo $selected_ignore; ?> /></td>
+<?php
+
+		}
+
+?>
+			</tr>
+<?php
+
+	}
+
+
+	// If we're setting forum or moderator options and a single forum has
+	// been selected then look to see if any subforums exist. If they do
+	// give user the option of cascading permissions to them
+	if (($mode == 'forum' || $mode == 'mod') && empty($submode) && count($forum_id[$which_mode]) === 1)
+	{
+		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
+
+		if (!empty($children))
+		{
+
+?>
+			<tr>
+				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="<?php echo $colspan; ?>"><table width="100%" cellspacing="1" cellpadding="0" border="0">
+					<tr>
+						<td class="gensmall" colspan="4" height="16" align="center"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS_EXPLAIN']; ?></td>
+					</tr>
+<?php
+
+			foreach ($children as $row)
+			{
+
+?>
+					<tr>
+						<td><input type="checkbox" name="inherit[]" value="<?php echo $row['forum_id']; ?>" /> <?php echo $row['forum_name']; ?></td>
+					</tr>
+<?php
+
+			}
+
+?>
+					<tr>
+						<td height="16" align="center"><a class="gensmall" href="javascript:marklist('inherit', true);"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('inherit', false);" class="gensmall"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></td>
+					</tr>
+				</table></td>
+			</tr>
+<?php
+
+		}
+	}
+
+	// Display event/cron radio buttons
+	if ($_CLASS['auth']->acl_gets('a_events', 'a_cron') && $mode != 'deps' && $submit != 'update')
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+?>
+			<!-- tr>
+				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['RUN_HOW']; ?></th>
+			</tr>
+			<tr>
+				<td class="<?php echo $row_class; ?>" colspan="4" align="center"><input type="radio" name="runas" value="now" checked="checked" /> <?php echo $_CLASS['core_user']->lang['RUN_AS_NOW']; ?><?php 
+	
+			if ($_CLASS['auth']->acl_get('a_events'))
+			{ 
+
+?> &nbsp;<input type="radio" name="runas" value="evt" /> <?php 
+	
+				echo $_CLASS['core_user']->lang['RUN_AS_EVT'];  
+			}
+			
+			if ($_CLASS['auth']->acl_get('a_cron'))
+			{
+
+?> &nbsp;<input type="radio" name="runas" value="crn" /> <?php 
+	
+				echo $_CLASS['core_user']->lang['RUN_AS_CRN']; 
+				
+			}
+
+?></td>
+			</tr -->
+<?php
+
+	}
+
+?>
+			<tr>
+				<td class="cat" colspan="<?php echo $colspan; ?>" align="center"><input class="btnmain" type="submit" name="submit_update" value="<?php echo $_CLASS['core_user']->lang['UPDATE']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="submit_cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" /><input type="hidden" name="ug_type" value="<?php echo $ug_type; ?>" /><?php echo $ug_hidden; ?><?php 
+
+	// Output forum id data
+	echo $s_forum_id;
+
+	// Output settings generated from other views
+	echo $settings_hidden;
+	unset($settings_hidden);
+	
+?></td>
+			</tr>
+		</table>
+
+		<br clear="all" />
+
+		<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th colspan="4"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="4"><table width="100%" cellspacing="1" cellpadding="0" border="0">
+					<tr>
+						<td colspan="2" height="16"><span class="gensmall"><?php echo $_CLASS['core_user']->lang['PRESETS_EXPLAIN']; ?></span></td>
+					</tr>
+					<tr>
+						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['SELECT_PRESET']; ?>: </td>
+						<td><select name="presetoption"><option class="sep" value="-1"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><?php 
+
+	echo $preset_update_options;
+			
+		?></select></td>
+					</tr>
+					<tr>
+						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['PRESET_NAME']; ?>: </td>
+						<td><input type="text" name="presetname" maxlength="25" /> </td>
+					</tr>
+				</table></td>
+			</tr>
+			<tr>
+				<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" name="submit_presetsave" value="<?php echo $_CLASS['core_user']->lang['SAVE']; ?>" /> &nbsp;<input class="btnlite" type="submit" name="submit_presetdel" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /></td>
+			</tr>
+		</table></td>
+	</tr>
+</table></form>
+
+<?php
+
+}
+
+// Output page footer
+adm_page_footer();
+
+// ---------
+// FUNCTIONS
+//
+function update_foes()
+{
+	global $_CLASS;
+
+	$perms = array();
+	foreach ($_CLASS['auth']->acl_get_list(false, array('a_', 'm_'), false) as $forum_id => $forum_ary)
+	{
+		foreach ($forum_ary as $auth_option => $user_ary)
+		{
+			$perms += $user_ary;
+		}
+	}
+
+	if (!empty($perms))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+	unset($perms);
+}
+//
+// FUNCTIONS
+// ---------
+
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha2/includes/forums/functions_admin.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_admin.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/functions_admin.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -2053,7 +2053,7 @@
 
 			foreach ($forum_id as $forum)
 			{
-				$sql = 'DELETE FROM '.ACL_TABLE."
+				$sql = 'DELETE FROM '. FORUMS_ACL_TABLE . "
 					WHERE $id_field = $ug_id
 						AND forum_id = $forum
 						$auth_sql";
@@ -2081,7 +2081,7 @@
 			$cur_options = array();
 
 			$sql = "SELECT auth_option, is_global, is_local
-				FROM " . ACL_OPTIONS_TABLE . "
+				FROM " . FORUMS_ACL_OPTIONS_TABLE . "
 				ORDER BY auth_option_id";
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -2148,7 +2148,7 @@
 							break;
 							
 						default:
-							$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
+							$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
 								VALUES ($option, " . $type_sql[$type] . ")";
 							$_CLASS['core_db']->query($sql);
 							$sql = '';
@@ -2158,7 +2158,7 @@
 
 			if ($sql != '')
 			{
-				$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
+				$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . " (auth_option, is_global, is_local)
 					VALUES $sql";
 				$_CLASS['core_db']->query($sql);
 			}
@@ -2182,7 +2182,7 @@
 	$update_sql = $empty_forums = array();
 
 	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . POSTS_TABLE . "
+		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE post_approved = 1
 			AND {$type}_id IN (" . implode(', ', $ids) . ")
 		GROUP BY {$type}_id";
@@ -2216,7 +2216,7 @@
 	if (!empty($last_post_ids))
 	{
 		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
-			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
 				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
@@ -2237,7 +2237,7 @@
 		return;
 	}
 
-	$table = ($type == 'forum') ? FORUMS_TABLE : TOPICS_TABLE;
+	$table = ($type == 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
 
 	foreach ($update_sql as $update_id => $update_sql_ary)
 	{
@@ -2255,17 +2255,13 @@
 function tidy_database()
 {
 	global $_CLASS;
-
+return;
 	$remove_date = time() - (3 * 62 * 24 * 3600);
 
 	$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 		WHERE mark_time < ' . $remove_date;
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'DELETE FROM ' . TOPICS_TRACK_TABLE . '
-		WHERE mark_time < ' . $remove_date;
-	$_CLASS['core_db']->query($sql);
-
 	set_config('database_last_gc', time(), true);
 }
 

Modified: cms/branches/1.0alpha2/includes/forums/functions_display.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_display.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/functions_display.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -166,11 +166,10 @@
 		{
 			$forum_id36 = base_convert($forum_id, 10, 36);
 			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
-		//echo $forum_id36.' - '.$row['mark_time'].'<br/>';
 		}
 
 		if ($row['mark_time'] < $row['forum_last_post_time'])
-		{//echo $parent_id.' - '.$row['mark_time'] .' - '. $row['forum_last_post_time'].'<br/>';
+		{
 			$forum_unread[$parent_id] = true;
 		}
 	}
@@ -273,12 +272,13 @@
 		// Which folder should we display?
 		if ($row['forum_status'] == ITEM_LOCKED)
 		{
-			$folder_image = 'forum_locked';
+// forum_locked_new , need an image for this one
+			$folder_image = empty($forum_unread[$forum_id]) ? 'forum_locked' : 'folder_locked_new';
 			$folder_alt = 'FORUM_LOCKED';
 		}
 		else
 		{
-			$folder_alt = (!empty($forum_unread[$forum_id])) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+			$folder_alt = empty($forum_unread[$forum_id]) ? 'NO_NEW_POSTS' : 'NEW_POSTS';
 		}
 
 		// Create last post link information, if appropriate

Modified: cms/branches/1.0alpha2/install/build_data.php
===================================================================
--- cms/branches/1.0alpha2/install/build_data.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/install/build_data.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -510,4 +510,17 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (5, 'rm')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wma')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wmv')");
+
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/arrow_bold_rgt.gif', 19, 19, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/redface_anim.gif', 19, 19, 9, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/mr_green.gif', 19, 19, 10, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/musical.gif', 19, 19, 4, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/asterix.gif', 19, 19, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/square.gif', 19, 19, 3, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/alien_grn.gif', 19, 19, 5, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/idea.gif', 19, 19, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/question.gif', 19, 19, 6, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/exclaim.gif', 19, 19, 7, 1)");
+
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -99,7 +99,7 @@
 			// New private messages popup
 			case 'popup':
 			
-				$indox_link = generate_link('Control_Panel&amp;i=pm&amp;folder=inbox');
+				$indox_link = generate_link('Control_Panel&i=pm&folder=inbox');
 
 				if ($_CLASS['core_user']->data['user_new_privmsg'])
 				{



From viperal at berlios.de  Sat Oct  1 15:03:05 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 15:03:05 +0200
Subject: [Viperals-svncheckins] r156 - in cms/trunk: blocks includes/display install
Message-ID: <200510011303.j91D35vJ000034@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 15:03:04 +0200 (Sat, 01 Oct 2005)
New Revision: 156

Modified:
   cms/trunk/blocks/block-User.php
   cms/trunk/includes/display/display.php
   cms/trunk/install/build_data.php
Log:


Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-10-01 01:55:16 UTC (rev 155)
+++ cms/trunk/blocks/block-User.php	2005-10-01 13:03:04 UTC (rev 156)
@@ -146,7 +146,7 @@
 	
 	if ($row['user_id'] != ANONYMOUS)
 	{
-		$link = (($row['user_type'] == USER_BOT) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
+		$link = ($row['user_type'] == USER_BOT) ? $row['username'].' &gt;' : '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>  &gt;';
 		$who_where['user'] .= $online['user'] .': '.$link.' <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
 	else

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-01 01:55:16 UTC (rev 155)
+++ cms/trunk/includes/display/display.php	2005-10-01 13:03:04 UTC (rev 156)
@@ -49,7 +49,7 @@
 
 		if ($module['module_status'] != STATUS_ACTIVE)
 		{
-			if ($module['module_status'] == STATUS_DISABLE && $_CLASS['core_auth']->admin_auth('modules'))
+			if ($module['module_status'] == STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('modules'))
 			{
 				$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
 			}

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-01 01:55:16 UTC (rev 155)
+++ cms/trunk/install/build_data.php	2005-10-01 13:03:04 UTC (rev 156)
@@ -28,8 +28,9 @@
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
+$content = $_CLASS['core_db']->escape('<a href="feed.php?feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '$content', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dst', '0', 'int', 1)");
@@ -40,8 +41,9 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'index_page', 'contact', 'string', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'active', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)");
+$content = $_CLASS['core_db']->escape('<p align="center"><b>Sorry we are currently updating this site.<br>Please try again later</b></p>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '$content', 'string', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'allow_html_email', '1', 'bool', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_enable', '1', 'bool', 1)");
@@ -177,13 +179,13 @@
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', 'AA0000', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
@@ -372,7 +374,7 @@
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_start_date', ".gmtime().", 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_start_date', $time, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");



From viperal at berlios.de  Sat Oct  1 15:11:37 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 15:11:37 +0200
Subject: [Viperals-svncheckins] r157 - in cms/branches/1.0alpha2: blocks install
Message-ID: <200510011311.j91DBbCa001207@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 15:11:37 +0200 (Sat, 01 Oct 2005)
New Revision: 157

Modified:
   cms/branches/1.0alpha2/blocks/block-User.php
   cms/branches/1.0alpha2/install/build_data.php
Log:


Modified: cms/branches/1.0alpha2/blocks/block-User.php
===================================================================
--- cms/branches/1.0alpha2/blocks/block-User.php	2005-10-01 13:03:04 UTC (rev 156)
+++ cms/branches/1.0alpha2/blocks/block-User.php	2005-10-01 13:11:37 UTC (rev 157)
@@ -146,7 +146,7 @@
 	
 	if ($row['user_id'] != ANONYMOUS)
 	{
-		$link = (($row['user_type'] == USER_BOT) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
+		$link = ($row['user_type'] == USER_BOT) ? $row['username'].' &gt;' : '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>  &gt;';
 		$who_where['user'] .= $online['user'] .': '.$link.' <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
 	else

Modified: cms/branches/1.0alpha2/install/build_data.php
===================================================================
--- cms/branches/1.0alpha2/install/build_data.php	2005-10-01 13:03:04 UTC (rev 156)
+++ cms/branches/1.0alpha2/install/build_data.php	2005-10-01 13:11:37 UTC (rev 157)
@@ -25,12 +25,12 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
-
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
+
+$content = $_CLASS['core_db']->escape('<a href="feed.php?feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '$content', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
@@ -41,8 +41,9 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'contact', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
+$content = $_CLASS['core_db']->escape('<p align="center"><b>Sorry we are currently updating this site.<br>Please try again later</b></p>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '$content', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
@@ -177,13 +178,13 @@
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', 'AA0000', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
@@ -378,7 +379,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', $time, 0)");
 
 // to be removed
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");



From viperal at berlios.de  Sat Oct  1 15:31:36 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 15:31:36 +0200
Subject: [Viperals-svncheckins] r158 - cms/trunk/modules/Control_Panel/ucp
Message-ID: <200510011331.j91DVae8002980@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 15:31:35 +0200 (Sat, 01 Oct 2005)
New Revision: 158

Modified:
   cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
Log:


Modified: cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-10-01 13:11:37 UTC (rev 157)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-10-01 13:31:35 UTC (rev 158)
@@ -328,6 +328,8 @@
 
 				if ($submit)
 				{
+					require_once($site_file_root.'includes/functions_user.php');
+
 					$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
 
 					if ($config['allow_avatar_local'] && $gallery_avatar)



From viperal at berlios.de  Sat Oct  1 16:33:46 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 1 Oct 2005 16:33:46 +0200
Subject: [Viperals-svncheckins] r159 - in cms/trunk/includes: auth forums
Message-ID: <200510011433.j91EXk32008311@sheep.berlios.de>

Author: viperal
Date: 2005-10-01 16:33:45 +0200 (Sat, 01 Oct 2005)
New Revision: 159

Modified:
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/forums/functions_posting.php
Log:


Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2005-10-01 13:31:35 UTC (rev 158)
+++ cms/trunk/includes/auth/auth.php	2005-10-01 14:33:45 UTC (rev 159)
@@ -144,17 +144,17 @@
 			'full_login'	=> true,
 			'full_screen'	=> false,
 		);
-	
+
 		if (is_array($login_options))
 		{
 			$login_array = array_merge($login_array, $login_options);
 		}
 
+		$user_name		= get_variable('username', 'POST', '');
+		$user_password	= get_variable('password', 'POST', '');
+
 		if (isset($_POST['login']))
 		{
-			$user_name		= get_variable('username', 'POST');
-			$user_password	= get_variable('password', 'POST');
-
 			if (!$user_name || !$user_password)
 			{
 				$error = 'INCOMPLETE_LOGIN_INFO';
@@ -187,7 +187,8 @@
 					trigger_error($message);
 				}
 
-				$error = (is_string($result)) ? $result : 'LOGIN_ERROR';
+				$error = is_string($result) ? $result : 'LOGIN_ERROR';
+				$user_name = $user_password = '';
 			}
 		}
 
@@ -209,9 +210,12 @@
 		}
 
 		$_CLASS['core_template']->assign_array(array(
-			'LOGIN_ERROR'			=> $_CLASS['core_user']->get_lang($error),
-			'LOGIN_EXPLAIN'			=> $_CLASS['core_user']->get_lang($login_array['explain']), 
+			'LOGIN_ERROR'			=> ($error) ? $_CLASS['core_user']->get_lang($error) : false,
+			'LOGIN_EXPLAIN'			=> ($login_array['explain']) ? $_CLASS['core_user']->get_lang($login_array['explain']) : '', 
 
+			'USERNAME'				=>	$user_name,
+			'PASSWORD'				=>	$user_password,
+
 			'U_SEND_PASSWORD'	 	=> ($_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=sendpassword') : '',
 			'U_RESEND_ACTIVATION'   => ($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_NONE && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=resend_act') : '',
 			'U_TERMS_USE'			=> generate_link('Control_Panel&amp;mode=terms'), 
@@ -219,8 +223,6 @@
 			'U_REGISTER'			=> generate_link('Control_Panel&amp;mode=register'),
 			'U_CONFIRM_IMAGE'		=> $confirm_image,
 
-			'USERNAME'				=> isset($data['user_name']) ? $data['user_name'] : '',
-
 			'S_DISPLAY_FULL_LOGIN'  => ($login_array['full_login']),
 			'S_LOGIN_ACTION'		=> (!$login_array['admin_login']) ? generate_link($_CLASS['core_user']->url) : generate_link(false, array('admin' => true)),
 			'S_HIDDEN_FIELDS' 		=> $s_hidden_fields,

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-10-01 13:31:35 UTC (rev 158)
+++ cms/trunk/includes/forums/functions_posting.php	2005-10-01 14:33:45 UTC (rev 159)
@@ -877,6 +877,8 @@
 		return;
 	}
 
+	unset($holding[$_CLASS['core_user']->data['user_id']], $ignore_array[$_CLASS['core_user']->data['user_id']]);
+
 	// Now we remove the users that aren't allowed to read the forum
 	$acl_list = $_CLASS['auth']->acl_get_list(array_keys($ignore_array), 'f_read', $forum_id);
 
@@ -889,6 +891,7 @@
 	}
 	$processed = $delete_array = $update_array = array();
 
+
 	foreach ($holding as $user)
 	{
 		if (!in_array($user['user_id'], $ignore_array))



From viperal at berlios.de  Sun Oct  2 00:45:08 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 2 Oct 2005 00:45:08 +0200
Subject: [Viperals-svncheckins] r160 - in cms/branches/1.0alpha2: . includes/db
Message-ID: <200510012245.j91Mj80F020061@sheep.berlios.de>

Author: viperal
Date: 2005-10-02 00:45:03 +0200 (Sun, 02 Oct 2005)
New Revision: 160

Modified:
   cms/branches/1.0alpha2/includes/db/mysql.php
   cms/branches/1.0alpha2/includes/db/mysqli.php
   cms/branches/1.0alpha2/installer.php
Log:
Disabled utf8 tables for now, some hosts don't have it enabeld.

Modified: cms/branches/1.0alpha2/includes/db/mysql.php
===================================================================
--- cms/branches/1.0alpha2/includes/db/mysql.php	2005-10-01 14:33:45 UTC (rev 159)
+++ cms/branches/1.0alpha2/includes/db/mysql.php	2005-10-01 22:45:03 UTC (rev 160)
@@ -544,7 +544,10 @@
 					$fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				//$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+// Need to make surte utf8 is enabled with the database.
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: cms/branches/1.0alpha2/includes/db/mysqli.php
===================================================================
--- cms/branches/1.0alpha2/includes/db/mysqli.php	2005-10-01 14:33:45 UTC (rev 159)
+++ cms/branches/1.0alpha2/includes/db/mysqli.php	2005-10-01 22:45:03 UTC (rev 160)
@@ -539,7 +539,10 @@
 					$_fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				//$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+// Need to make surte utf8 is enabled with the database.
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: cms/branches/1.0alpha2/installer.php
===================================================================
--- cms/branches/1.0alpha2/installer.php	2005-10-01 14:33:45 UTC (rev 159)
+++ cms/branches/1.0alpha2/installer.php	2005-10-01 22:45:03 UTC (rev 160)
@@ -24,6 +24,7 @@
 
 error_reporting(0);
 //error_reporting(E_ALL);
+ at set_time_limit(0);
 
 define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 



From viperal at berlios.de  Thu Oct  6 19:49:41 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 6 Oct 2005 19:49:41 +0200
Subject: [Viperals-svncheckins] r161 - in modules: . google_search google_search/includes google_search/includes/templates google_search/includes/templates/modules google_search/includes/templates/modules/google_search google_search/javascript google_search/javascript/google_search google_search/modules google_search/modules/google_search
Message-ID: <200510061749.j96Hnf3X006580@sheep.berlios.de>

Author: viperal
Date: 2005-10-06 19:49:39 +0200 (Thu, 06 Oct 2005)
New Revision: 161

Added:
   modules/google_search/
   modules/google_search/includes/
   modules/google_search/includes/templates/
   modules/google_search/includes/templates/modules/
   modules/google_search/includes/templates/modules/google_search/
   modules/google_search/includes/templates/modules/google_search/index.html
   modules/google_search/includes/templates/modules/google_search/results.html
   modules/google_search/javascript/
   modules/google_search/javascript/google_search/
   modules/google_search/javascript/google_search/google_search.js
   modules/google_search/modules/
   modules/google_search/modules/google_search/
   modules/google_search/modules/google_search/ajax.php
   modules/google_search/modules/google_search/configurator.php
   modules/google_search/modules/google_search/index.php
Log:


Added: modules/google_search/includes/templates/modules/google_search/index.html
===================================================================
--- modules/google_search/includes/templates/modules/google_search/index.html	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/includes/templates/modules/google_search/index.html	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,52 @@
+<!-- DISPLAY_HEADER -->
+
+<script type="text/javascript" src="javascript/google_search/google_search.js"></script>
+
+{ $THEME_TABLE_OPEN }
+
+<form method="post" onsubmit="return google_search();" action="{ $GS_ACTION }">
+	<table  id="google_form" class="tablebg" width="100%" cellpadding="1" cellspacing="1">
+		<tbody>
+			<tr> 
+				<th>{ $L_SEARCH_QUERY }</th>
+			</tr>
+			<tr>
+				<td align="center" class="row1">
+				
+				<input id="query" name="query" size="15" maxlength="200" value="" type="text" /> 
+				<select id="search_type" name="search_type">
+					<option value="1" select="selected">This Site</option>
+					<option value="2">Web</option>
+				</select>
+				
+				<input class="button" name="submit" value="Search" type="submit" />
+				</td>
+			</tr>
+		</tbody>
+	</table>
+</form>
+
+<div id="google_results">
+
+<!-- if { $google_results } -->
+	<!-- INCLUDE modules/google_search/results.html -->
+<!-- ENDIF -->
+
+</div>
+
+<div id="google_progress_bar" style="display: none">
+	<table class="tablebg" width="100%" cellpadding="1" cellspacing="1">
+		<tbody>
+			<tr>
+				<td align="center" class="row1">
+					<b>Search In Progress please Wait</b> <br/>
+					<img src="images/progress_bar.gif" />
+				</td>
+			</tr>
+		</tbody>
+	</table>
+</div>
+
+{ $THEME_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: modules/google_search/includes/templates/modules/google_search/results.html
===================================================================
--- modules/google_search/includes/templates/modules/google_search/results.html	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/includes/templates/modules/google_search/results.html	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,58 @@
+<br />
+
+<table class="tablebg" width="100%" cellpadding="1" cellspacing="1">
+	<tbody>
+		<tr> 
+			<th colspan="2">{ $L_SEARCH_RESULTS }</th>
+		</tr>
+		<!-- IF { $google_pagination } || { $spelling_suggestion } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="2">
+				<table width="100%" cellpadding="0" cellspacing="0">
+					<tbody>
+						<tr>
+				<!-- IF { $spelling_suggestion } --><td><font color="#cc0000">Did you mean: </font><a href="{ $link_spelling_suggestion } ">{ $spelling_suggestion }</a></td><!-- ENDIF -->
+				<!-- IF { $google_pagination } --><td align="right"><div style="padding-right: 5px; text-align: right;">{ $google_pagination }</div></td><!-- ENDIF -->
+						</tr>
+					</tbody>
+				</table>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="spacer" colspan="2" height="7"></td>
+		</tr>
+		<!-- LOOP $google_result -->
+		<tr>
+			<td align="center" class="row1">
+				<b>{ $google_result:num }</b>
+			</td>
+			<td class="row1">
+				<a href="{ $google_result:url } "><b>{ $google_result:title }</b></a>
+			</td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row1">
+				<p>{ $google_result:snippet }</p>
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="2" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row2">
+			<td align="center" colspan="2">
+				{ $L_RESULTS_FOUND }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+
+		<!-- IF { $google_pagination } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="2">
+				<div style="padding-right: 5px; text-align: right;">{ $google_pagination }</div>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+	</tbody>
+</table>
\ No newline at end of file

Added: modules/google_search/javascript/google_search/google_search.js
===================================================================
--- modules/google_search/javascript/google_search/google_search.js	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/javascript/google_search/google_search.js	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,43 @@
+// By Ryan Marshall ( viperal1 at gmail.com )
+
+function google_search()
+{
+	ajax = new core_ajax();
+
+	if (!ajax)
+	{
+		return true;
+	}
+
+	var query = document.getElementById('query');
+	var search_type = document.getElementById('search_type');
+
+	var google_form = document.getElementById('google_form');
+	var progress_bar = document.getElementById('google_progress_bar');
+	var google_results = document.getElementById('google_results');
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() && ajax.responseText())
+		{
+			var area = document.getElementById('google_results');
+			area.innerHTML = ajax.responseText();
+
+			google_form.style.display = '';
+			google_results.style.display = '';
+			progress_bar.style.display = 'none';
+			//query.value = '';
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	google_results.style.display = 'none';
+	google_form.style.display = 'none';
+	progress_bar.style.display = '';
+
+//alert(search_type.options[search_type.selectedIndex].value);
+	ajax.send('ajax.php?mod=google_search', '&query=' + query.value + '&search_type=' + search_type.options[search_type.selectedIndex].value);
+
+	return false;
+}
\ No newline at end of file

Added: modules/google_search/modules/google_search/ajax.php
===================================================================
--- modules/google_search/modules/google_search/ajax.php	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/modules/google_search/ajax.php	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,111 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+header('Content-Type: text/html');
+
+$_CLASS['core_user']->user_setup();
+
+require_once(SITE_FILE_ROOT.'includes/nusoap/nusoap.php');
+
+$google_license_key = "dJ5XAtRQFHIlbfutrovVj3TizF1Q2TXP";
+
+$query = get_variable('query', 'POST');
+$search_type = get_variable('search_type', 'POST', 0, 'int');
+
+$limit = 10;
+
+if (!$query)
+{
+	script_close();
+}
+
+$query_command = $query;
+
+if ($search_type === 1)
+{
+	$query_command .= ' site:viperals.berlios.de';
+}
+
+$params = array(
+	'key' 		=> (string) $google_license_key,
+	'q' 		=> (string) $query_command, //'viperal site:cpgnuke.com',
+	'start'		=> (int) 0,	
+	'maxResults' => (int) $limit,
+	'filter' 	=> (boolean) true,
+	'restricts'	=> (string)'', //'lang_en'
+	'safeSearch'=> (boolean) false,
+	'lr'		=> (string) '',	
+
+	'ie'		=> 'UTF-8', // No longer used
+	'oe'		=> 'UTF-8',	// No longer used
+);		
+
+$client = new soapclient('http://api.google.com/search/beta2');
+$result = $client->call('doGoogleSearch', $params, 'urn:GoogleSearch');
+
+if ($client->fault || $client->getError())
+{
+	script_close();
+}
+
+$pagination = generate_pagination('google_search&amp;query='.urlencode($query).'&amp;search_type='.$search_type, $result['estimatedTotalResultsCount'], $limit, 0);
+$count = count($result['resultElements']);
+$num = 1;
+
+for ($i = 0; $i < $count; $i++)
+{
+	$_CLASS['core_template']->assign_vars_array('google_result', array(
+		'num' 			=> $num,
+		'url' 			=> $result['resultElements'][$i]['URL'],
+		'title'			=> $result['resultElements'][$i]['title'],
+		'snippet'		=> $result['resultElements'][$i]['snippet'],
+	));
+
+	$num++;
+}
+unset($result);
+
+$params = array(
+	'key' 		=> (string) $google_license_key,
+	'phrase' 	=> (string) $query,
+);
+
+$spelling_suggestion = $client->call('doSpellingSuggestion', $params, 'urn:GoogleSearch');
+
+if (is_array($spelling_suggestion))
+{
+	$spelling_suggestion = false;
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'spelling_suggestion'		=> $spelling_suggestion,
+	'link_spelling_suggestion'	=> ($spelling_suggestion) ? generate_link('google_search&amp;query='.urlencode($spelling_suggestion).'&amp;search_type='.$search_type) : '',
+	'google_pagination' 		=> $pagination['formated'],
+	'google_pagination_array'	=> $pagination['array']
+));
+
+$_CLASS['core_template']->display('modules/google_search/results.html');
+
+script_close();
+
+?>
\ No newline at end of file

Added: modules/google_search/modules/google_search/configurator.php
===================================================================
--- modules/google_search/modules/google_search/configurator.php	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/modules/google_search/configurator.php	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,44 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+class google_search_configurator
+{
+	var $error = array();
+	
+	function install()
+	{
+		return true;
+	}
+
+	function uninstall()
+	{
+		return true;
+	}
+}
+
+?>
\ No newline at end of file

Added: modules/google_search/modules/google_search/index.php
===================================================================
--- modules/google_search/modules/google_search/index.php	2005-10-01 22:45:03 UTC (rev 160)
+++ modules/google_search/modules/google_search/index.php	2005-10-06 17:49:39 UTC (rev 161)
@@ -0,0 +1,128 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+$_CLASS['core_user']->user_setup();
+
+require_once(SITE_FILE_ROOT.'includes/nusoap/nusoap.php');
+
+$query = get_variable('query', 'POST');
+
+if (!$query)
+{
+	$query = urldecode(get_variable('query', 'GET'));
+}
+
+if (!$query)
+{
+	$_CLASS['core_template']->assign_array(array(
+		'GS_ACTION'					=> generate_link('google_search'),
+		'google_results'			=> false,
+	));
+
+	$_CLASS['core_display']->display(false, 'modules/google_search/index.html');
+}
+
+$google_license_key = "dJ5XAtRQFHIlbfutrovVj3TizF1Q2TXP";
+
+$search_type = get_variable('search_type', 'REQUEST', 0, 'int');
+$start = get_variable('start', 'GET', 0, 'int');
+$query_command = $query;
+$limit = 10;
+
+if ($search_type === 1)
+{
+	$query_command .= ' site:viperals.berlios.de';
+}
+
+$params = array(
+	'key' 		=> (string) $google_license_key,
+	'q' 		=> (string) $query_command,
+	'start'		=> (int) $start,	
+	'maxResults' => (int) $limit,
+	'filter' 	=> (boolean) true,
+	'restricts'	=> (string)'', //'lang_en'
+	'safeSearch'=> (boolean) false,
+	'lr'		=> (string) '',	
+
+	'ie'		=> 'UTF-8', // No longer used
+	'oe'		=> 'UTF-8',	// No longer used
+);		
+
+$client = new soapclient('http://api.google.com/search/beta2');
+$result = $client->call('doGoogleSearch', $params, 'urn:GoogleSearch');
+
+if ($client->fault || $client->getError())
+{
+	//$err = $client->getError();
+	//print_r($result);
+	$_CLASS['core_template']->assign_array(array(
+		'ERROR'						=> '',
+		'GS_ACTION'					=> generate_link('google_search'),
+		'google_results'			=> false,
+	));
+
+	$_CLASS['core_display']->display(false, 'modules/google_search/index.html');
+}
+
+$pagination = generate_pagination('google_search&amp;query='.urlencode($query).'&amp;search_type='.$search_type, $result['estimatedTotalResultsCount'], $limit, $start);
+$count = count($result['resultElements']);
+$num = $start + 1;
+
+for ($i = 0; $i < $count; $i++)
+{
+	$_CLASS['core_template']->assign_vars_array('google_result', array(
+		'num' 			=> $num,
+		'url' 			=> $result['resultElements'][$i]['URL'],
+		'title'			=> $result['resultElements'][$i]['title'],
+		'snippet'		=> $result['resultElements'][$i]['snippet'],
+	));
+
+	$num++;
+}
+
+unset($result);
+
+$params = array(
+	'key' 		=> (string) $google_license_key,
+	'phrase' 	=> (string) $query,
+);
+
+$spelling_suggestion = $client->call('doSpellingSuggestion', $params, 'urn:GoogleSearch');
+
+if (is_array($spelling_suggestion))
+{
+	$spelling_suggestion = false;
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'GS_ACTION'					=> generate_link('google_search'),
+	'google_results'			=> true,
+	'spelling_suggestion'		=> $spelling_suggestion,
+	'link_spelling_suggestion'	=> ($spelling_suggestion) ? generate_link('google_search&amp;query='.urlencode($spelling_suggestion).'&amp;search_type='.$search_type) : '',
+	'google_pagination' 		=> $pagination['formated'],
+	'google_pagination_array'	=> $pagination['array']
+));
+
+$_CLASS['core_display']->display(false, 'modules/google_search/index.html');
+
+?>
\ No newline at end of file



From viperal at berlios.de  Thu Oct  6 20:22:39 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 6 Oct 2005 20:22:39 +0200
Subject: [Viperals-svncheckins] r162 - in cms/trunk: . blocks images includes includes/display includes/forums includes/forums/admin includes/forums/mcp includes/templates includes/templates/installer includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Members_List install modules/Control_Panel/ucp modules/Forums themes/viperal/style
Message-ID: <200510061822.j96IMdqJ015869@sheep.berlios.de>

Author: viperal
Date: 2005-10-06 20:22:34 +0200 (Thu, 06 Oct 2005)
New Revision: 162

Added:
   cms/trunk/images/progress_bar.gif
   cms/trunk/includes/templates/installer/stage4.html
Removed:
   cms/trunk/includes/forums/admin/images/
Modified:
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/blocks/block-User.php
   cms/trunk/core.php
   cms/trunk/debug.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_post.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/handler.php
   cms/trunk/includes/session.php
   cms/trunk/includes/system.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/templates/installer/stage2.html
   cms/trunk/includes/templates/installer/stage3.html
   cms/trunk/includes/templates/login_admin.html
   cms/trunk/includes/templates/login_body.html
   cms/trunk/includes/templates/login_body_full.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_history.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage.html
   cms/trunk/includes/templates/modules/Forums/mcp_post.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/modules/Control_Panel/ucp/ucp_main.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/download.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/themes/viperal/style/style.css
Log:


Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -55,9 +55,9 @@
 	$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" id="poster_name" name="poster_name" size="10" maxlength="10" /><br />';
 }
 
-$this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="3"></textarea><br /><br />
+$this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="4"></textarea><br /><br />
 			<input class="button" type="submit" name="submit" value="Post" />
 			<input class="button" type="button" name="submit" onclick="quick_message_refresh()" value="Refresh" />
-		</div></form>';
+		</form></div>';
 
 ?>
\ No newline at end of file

Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/blocks/block-User.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -35,14 +35,16 @@
 	if ($_CLASS['core_user']->data['user_avatar'])
 	{
 		$avatar_img = '';
+
 		switch ($_CLASS['core_user']->data['user_avatar_type'])
 		{
 			case AVATAR_UPLOAD:
-				$avatar_img = $config['avatar_path'] . '/';
-				break;
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+			break;
+
 			case AVATAR_GALLERY:
-				$avatar_img = $config['avatar_gallery_path'] . '/';
-				break;
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+			break;
 		}
 		
 		$avatar_img .= $_CLASS['core_user']->data['user_avatar'];
@@ -72,7 +74,7 @@
 	</tr>
 	<tr>
 		<td colspan="2">
-			<input name="autologin" type="checkbox"><span class="gensmall">Remmeber me</span>
+			<input name="autologin" type="checkbox" /><span class="gensmall">Remmeber me</span>
 		</td>
 	</tr>
 	</table>
@@ -103,11 +105,20 @@
 {
 	if ($row['user_id'] != ANONYMOUS && !in_array($row['user_id'], $prev_ip))
   	{
-		if (!$_CLASS['core_user']->is_admin && (!$row['user_allow_viewonline'] || $row['session_hidden']))
+		$prev_id[] = $row['user_id'];
+
+		if (!$row['user_allow_viewonline'] || $row['session_hidden'])
 		{
 			$online['hidden']++;
 
-			continue;
+			if ($_CLASS['core_user']->is_admin)
+			{
+				$row['username'] = '<i>' . $row['username'] . '</i>';
+			}
+			else
+			{
+				continue;
+			}
 		}
 		else
 		{
@@ -118,11 +129,11 @@
 		{
 			$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
 		}
-		
-		$prev_id[] = $row['user_id'];
 	}
 	elseif ($row['user_id'] == ANONYMOUS && !in_array($row['session_ip'], $prev_ip))
 	{
+		$prev_ip[] = $row['session_ip'];
+
 		$online['guest']++;		
 	}
 	else
@@ -130,7 +141,6 @@
 		continue;	
 	}
 	
-	$prev_ip[] = $row['session_ip'];
 	$online['total']++;
 
 	if (!$row['session_page'])
@@ -205,5 +215,31 @@
 	</td>
   </tr>
 </table>';
+/*
+if ($_CORE_CONFIG['user']['enable_confirm'])
+{
+	$this->content .=  '
+	<div id="block_user_menu" >
+		<table class="tablebg" border="0" cellpadding="4" cellspacing="1">
+			<tbody>
+				<tr>
+					<td align="center" class="row1"><span class="gensmall">Enter the code exactly as you see it in the image<br/><b>This is case sensitive</b></span></td>
+				</tr>
+				<tr>
+					<td align="center" class="row2"><img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" /></a></td>
+				</tr>
+				<tr>
+					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text" /></td>
+				</tr>
+				<tr>
+					<td align="center" class="row1"><input type="submit" name="login" class="button" value="Login"/></td>
+				</tr>
+				<!-- ENDIF -->
+			</tbody>
+		</table>
+	</div>';
 
+	$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
+}
+*/
 ?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/core.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -26,8 +26,15 @@
     die;
 }
 
+if (extension_loaded('zlib') && !ob_get_length())
+{
+	@ob_start('ob_gzhandler');
+}
+
 //ini_set('display_errors', 1);
 set_magic_quotes_runtime(0);
+//error_reporting(E_STRICT);
+error_reporting(E_ALL);
 
 //Error reporting tyoe
 define('ERROR_NONE', 0);
@@ -85,11 +92,11 @@
 
 // Load basic classes
 load_class(false, 'core_template');
-load_class(false, 'core_error_handler');
+load_class(false, 'core_handler');
 
 // Set error handler
-$_CLASS['core_error_handler']->start();
-//$_CLASS['core_error_handler']->stop();
+$_CLASS['core_handler']->start();
+//$_CLASS['core_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
 if (empty($site_db))
@@ -219,20 +226,20 @@
 
 if ($_CLASS['core_user']->is_admin)
 {
-	$_CLASS['core_error_handler']->report = $_CORE_CONFIG['server']['error_options'];	
+	$_CLASS['core_handler']->report = $_CORE_CONFIG['server']['error_options'];	
 }
 else
 {
 	$_CORE_CONFIG['server']['error_options'] = ERROR_NONE;
-	$_CLASS['core_error_handler']->report = ERROR_NONE;
+	$_CLASS['core_handler']->report = ERROR_NONE;
 }
 
-/*
+
 $_CORE_CONFIG['server']['error_options'] = ERROR_DEBUGGER;	
 //$_CORE_CONFIG['server']['error_options'] = ERROR_ONPAGE;	
-$_CLASS['core_error_handler']->report = $_CORE_CONFIG['server']['error_options'];
-*/
+$_CLASS['core_handler']->report = $_CORE_CONFIG['server']['error_options'];
 
+
 if ($_SERVER['REQUEST_METHOD'] == 'POST' && $_CLASS['core_user']->new_session)
 {
 	// error here

Modified: cms/trunk/debug.php
===================================================================
--- cms/trunk/debug.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/debug.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -15,6 +15,8 @@
 
 define('VIPERAL', 'Admin');
 
+error_reporting(E_ALL);
+
 //echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
 $site_file_root = '';
 
@@ -22,22 +24,20 @@
 
 if (!$_CLASS['core_user']->is_admin)
 {
-	die('this is admin only :-) need better language :-(');
+	//die('this is admin only :-) need better language :-(');
 }
 
-$_CLASS['core_error_handler']->stop();
+$_CLASS['core_handler']->stop();
 $_CLASS['core_user']->user_setup();
 error_reporting(E_ALL);
 
 $mode = get_variable('mode', 'GET', false);
 
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'MODE'				=>	$mode,
 	'L_NOTICES'			=>	'NOTICE ERRORS',
 	'L_WARNINGS'		=>	'WARNING ERRORS',
 	'L_QUERIES'			=>	'DB QUERY DETAILS',
-	'bottomblock'		=>	false,
-	'MAIN_CONTENT'		=>	false,
 ));
 
 switch ($mode)

Added: cms/trunk/images/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/display/display.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -141,11 +141,6 @@
 
 		$this->displayed['header'] = true;
 
-		if (extension_loaded('zlib') && !ob_get_length())
-		{
-			ob_start('ob_gzhandler');
-		}
-
 		if ($title)
 		{
 			$_CORE_MODULE['module_title'] = $title;
@@ -161,7 +156,6 @@
 		if ($_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_new_privmsg'] && $_CLASS['core_user']->user_data_get('popuppm'))
 		{
 			$this->header['js'][] = '<script type="text/javascript">window.open(\''. preg_replace('/&amp;/', '&', generate_link('Control_Panel&i=pm&mode=popup', array('full' => true)))."', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');</script>";
-// need some other field
 			//$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
 		}
 

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/functions.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -1181,65 +1181,62 @@
 	
 	if ($config['load_online'] && $config['load_online_time'])
 	{
-		$userlist_ary = $userlist_visible = array();
-		$logged_visible_online = $logged_hidden_online = $guests_online = $prev_user_id = 0;
-		$prev_session_ip = $reading_sql = '';
-		//////////////////
-		/// Need to fix this\
-		/// Think about removing session_users();
-		/////////////////
-		if (!empty($_REQUEST['f']))
+		$logged_visible_online = $logged_hidden_online = $guests_online = 0;
+		$reading_sql = '';
+
+		$prev_ip = $prev_id = array();
+
+		if (isset($_REQUEST['f']))
 		{
-			$f = request_var('f', 0);
-			$reading_sql = "AND s.session_url LIKE '%f=$f%'";
+			$f = get_variable('f', 'REQUEST', 0, 'int');
+			$reading_sql = " AND s.session_url LIKE '%f=$f%'";
 		}
 
-		$session_users = session_users();
-		foreach ($session_users as $row)
+		$sql = 'SELECT session_hidden, session_ip, session_page, session_url, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
+					FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
+						WHERE s.session_time > ' . ($_CLASS['core_user']->time - (int) $_CORE_CONFIG['server']['session_length']) .'
+						AND u.user_id = s.session_user_id'.$reading_sql;
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			// User is logged in and therefor not a guest
-			if ($row['user_id'] != ANONYMOUS)
+			if ($row['user_id'] != ANONYMOUS && !in_array($row['user_id'], $prev_ip))
 			{
-				// Skip multiple sessions for one user
-				if ($row['user_id'] != $prev_user_id)
+				$prev_id[] = $row['user_id'];
+
+				if ((!$row['user_allow_viewonline'] || $row['session_hidden']))
 				{
-					if ($row['user_colour'])
+					if ($_CLASS['core_user']->is_admin)
 					{
-						$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
+						$row['username'] = '<i>' . $row['username'] . '</i>';
 					}
+					$logged_hidden_online++;
+				}
+				else
+				{
+					$logged_visible_online++;
+				}
 
-					if ($row['user_allow_viewonline'] && !$row['session_hidden'])
-					{
-						$user_online_link = $row['username'];
-						$logged_visible_online++;
-					}
-					else
-					{
-						$user_online_link = '<i>' . $row['username'] . '</i>';
-						$logged_hidden_online++;
-					}
-// Fix this
-					if ($row['user_allow_viewonline'] || $_CLASS['auth']->acl_get('u_viewonline'))
-					{
-						$user_online_link = ($row['user_type'] & USER_BOT) ? "<a href=\"" . generate_link('Members_List&amp;&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $user_online_link . '</a>' : $user_online_link;
-						$online_userlist .= ($online_userlist != '') ? ', ' . $user_online_link : $user_online_link;
-					}
+				if ($row['user_colour'])
+				{
+					$row['username'] = '<b style="color:#' . $row['user_colour'] . '">' . $row['username'] . '</b>';
 				}
+	
+				$row['username'] = ($row['user_type'] == USER_BOT) ? $row['username'] : '<a href="' . generate_link('Members_List&amp;&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>';
+				$online_userlist .= ($online_userlist !== '') ? ', ' . $row['username'] : $row['username'];
+			}
+			elseif ($row['user_id'] == ANONYMOUS && !in_array($row['session_ip'], $prev_ip))
+			{
+				$prev_ip[] = $row['session_ip'];
 
-				$prev_user_id = $row['user_id'];
+				$guests_online++;
 			}
 			else
 			{
-				// Skip multiple sessions for one user
-				if ($row['session_ip'] != $prev_session_ip)
-				{
-					$guests_online++;
-				}
+				continue;	
 			}
-
-			$prev_session_ip = $row['session_ip'];
 		}
-		unset($session_users);
 		
 		if (!$online_userlist)
 		{
@@ -1260,8 +1257,8 @@
 
 		if ($total_online_users > $config['record_online_users'])
 		{
-			set_config('record_online_users', $total_online_users, TRUE);
-			set_config('record_online_date', time(), TRUE);
+			set_config('record_online_users', $total_online_users, true);
+			set_config('record_online_date', $_CLASS['core_user']->time, true);
 		}
 
 		// Build online listing
@@ -1278,15 +1275,15 @@
 			{
 				case 0:
 					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USERS_ZERO_TOTAL'];
-					break;
+				break;
 
 				case 1:
 					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USER_TOTAL'];
-					break;
+				break;
 
 				default:
 					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USERS_TOTAL'];
-					break;
+				break;
 			}
 		}
 		unset($vars_online);

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/functions_admin.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -233,7 +233,7 @@
 	global $_CLASS;
 
 	$forum_ids = array($forum_id);
-	$sql_where = (is_array($topic_ids)) ? 'IN (' . implode(', ', $topic_ids) . ')' : '= ' . $topic_ids;
+	$sql_where = is_array($topic_ids) ? 'IN (' . implode(', ', $topic_ids) . ')' : '= ' . $topic_ids;
 
 	$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . "
 		WHERE topic_moved_id $sql_where
@@ -253,8 +253,12 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 	}
-	
-	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_LOG_TABLE);
+
+	$_CLASS['core_db']->transaction();
+
+	//$table_ary = array(FORUMS_FORUMS_TABLE, FORUMS_POLL_OPTIONS_TABLE, , FORUMS_TOPICS_TABLE);
+	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE);
+
 	foreach ($table_ary as $table)
 	{
 		$sql = "UPDATE $table
@@ -264,10 +268,11 @@
 	}
 	unset($table_ary);
 
+	$_CLASS['core_db']->transaction('commit');
+
 	if ($auto_sync)
 	{
 		sync('forum', 'forum_id', $forum_ids, true);
-		unset($forum_ids);
 	}
 }
 
@@ -315,9 +320,8 @@
 	$_CLASS['core_db']->query($sql);
 
 	$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
-		SET topic_id = $topic_id
-			AND in_message = 0
-		WHERE post_msg_id IN (" . implode(', ', $post_ids) . ')';
+		SET topic_id = $topic_id WHERE 
+		post_msg_id IN (" . implode(', ', $post_ids) . ') AND in_message = 0';
 	$_CLASS['core_db']->query($sql);
 
 	if ($auto_sync)
@@ -655,8 +659,12 @@
 	return $num_deleted;
 }
 
+
+// FIX
 function delete_topic_shadows($max_age, $forum_id = '', $auto_sync = TRUE)
 {
+	global $_CLASS;
+
 	$where = (is_array($forum_id)) ? 'AND t.forum_id IN (' . implode(', ', $forum_id) . ')' : (($forum_id) ? "AND t.forum_id = $forum_id" : '');
 
 	switch ($_CLASS['core_db']->db_layer)

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/functions_display.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -361,7 +361,7 @@
 		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
 		$folder_img = 'folder_moved';
 		$folder_alt = 'VIEW_TOPIC_MOVED';
-		$status = 9;
+		//$status = 9;
 	}
 	else
 	{
@@ -369,7 +369,7 @@
 		{
 			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
 			$folder_img = ($unread) ? 'folder_locked_new' :'folder_locked';
-			$status = ($unread) ? 11 : 10;
+			//$status = ($unread) ? 11 : 10;
 		}
 		else
 		{
@@ -379,25 +379,25 @@
 				case POST_ANNOUNCE:
 					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
 					$folder_img = ($unread) ? 'folder_announce_new' : 'folder_announce';
-					$status = ($unread) ? 8 : 7;
+					//$status = ($unread) ? 8 : 7;
 				break;
 	
 				case POST_STICKY:
 					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
 					$folder_img = ($unread) ? 'folder_sticky_new' : 'folder_sticky';
-					$status = ($unread) ? 6 : 5;
+					//$status = ($unread) ? 6 : 5;
 				break;
 	
 				default:
 					if ($replies >= $config['hot_threshold'])
 					{
 						$folder_img = ($unread) ? 'folder_hot_new': 'folder_hot';
-						$status = ($unread) ? 4 : 3;
+						//$status = ($unread) ? 4 : 3;
 					}
 					else
 					{
 						$folder_img = ($unread) ? 'folder_new' : 'folder';
-						$status = ($unread) ? 2 : 1;
+						//$status = ($unread) ? 2 : 1;
 					}
 				break;
 			}
@@ -411,7 +411,7 @@
 		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
 	}
 
-	return $status;
+	//return $status;
 }
 
 // Display Attachments

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -102,7 +102,7 @@
 // Change Topic Type
 function change_topic_type($mode, $topic_ids)
 {
-	global $db, $_CLASS;
+	global $_CLASS;
 
 	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
 	{
@@ -169,27 +169,33 @@
 		}
 		else
 		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . "
-				SET topic_type = $new_topic_type, forum_id = 0
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
+				SET topic_type = $new_topic_type
 				WHERE topic_id IN (" . implode(', ', $topic_ids) . ")";
 			$_CLASS['core_db']->query($sql);
+
+			move_topics($topic_ids, 0, true);
 		}
 
 		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
 
 		$data = get_topic_data($topic_ids);
 
+		$_CLASS['core_db']->transaction();
+
 		foreach ($data as $topic_id => $row)
 		{
 			add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);
 		}
+		
+		$_CLASS['core_db']->transaction('commit');
 	}
 
-	$redirect = generate_link($redirect);
+	$redirect = generate_link($redirect, array('full' => true));
 
 	if (!$success_msg)
 	{
-		url_redirect($redirect);
+		redirect($redirect);
 	}
 	else
 	{
@@ -210,7 +216,7 @@
 		return;
 	}
 
-	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 	$to_forum_id = get_variable('to_forum_id', 'POST', 0, 'int');
 
 	$additional_msg = $success_msg = '';
@@ -399,7 +405,7 @@
 // Delete Posts
 function mcp_delete_post($post_ids)
 {
-	global $_CLASS, $db;
+	global $_CLASS;
 
 	if (!check_ids($post_ids, FORUMS_POSTS_TABLE, 'post_id', 'm_delete'))
 	{
@@ -508,7 +514,7 @@
 // Fork Topic
 function mcp_fork_topic($topic_ids)
 {
-	global $db, $_CLASS, $config;
+	global $_CLASS, $config;
 
 	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
 	{
@@ -621,7 +627,7 @@
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' (poll_option_id, topic_id, poll_option_text, poll_option_total)
-						VALUES (' . $row['poll_option_id'] . ', ' . $new_topic_id . ", '" . $db->sql_escape($row['poll_option_text']) . "', 0)";
+						VALUES (' . $row['poll_option_id'] . ', ' . $new_topic_id . ", '" . $_CLASS['core_db']->escape($row['poll_option_text']) . "', 0)";
 					$_CLASS['core_db']->query($sql);
 				}
 				$_CLASS['core_db']->free_result($result);

Modified: cms/trunk/includes/forums/mcp/mcp_post.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_post.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/mcp/mcp_post.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -23,378 +23,333 @@
 // 
 // -------------------------------------------------------------
 
-function mcp_post_details($id, $mode, $action, $url)
-{
-	global $config, $_CLASS;
-	
-	$_CLASS['core_user']->add_lang('posting');
 
-	$_CLASS['core_template']->assign(array(
-		'L_POST_DETAILS'		=> $_CLASS['core_user']->lang['POST_DETAILS'],
-		'L_POST_SUBJECT'		=> $_CLASS['core_user']->lang['POST_SUBJECT'],
-		'L_POSTER'				=> $_CLASS['core_user']->lang['POSTER'],
-		'L_READ_PROFILE'		=> $_CLASS['core_user']->lang['READ_PROFILE'],
-		'L_READ_USERNOTES'		=> $_CLASS['core_user']->lang['READ_USERNOTES'],
-		'L_READ_WARNINGS'		=> $_CLASS['core_user']->lang['READ_WARNINGS'],
-		'L_THIS_POST_IP'		=> $_CLASS['core_user']->lang['THIS_POST_IP'],
-		'L_POSTED'				=> $_CLASS['core_user']->lang['POSTED'],
-		'L_PREVIEW'				=> $_CLASS['core_user']->lang['PREVIEW'],
-		'L_APPROVE'				=> $_CLASS['core_user']->lang['APPROVE'],
-		'L_DISAPPROVE'			=> $_CLASS['core_user']->lang['DISAPPROVE'],
-		'L_REPORTS'				=> $_CLASS['core_user']->lang['REPORTS'],
-		'L_ADD_FEEDBACK'		=> $_CLASS['core_user']->lang['ADD_FEEDBACK'],
-		'L_FEEDBACK'			=> $_CLASS['core_user']->lang['FEEDBACK'],
-		'L_DELETE_MARKED'		=> $_CLASS['core_user']->lang['DELETE_MARKED'],
-		'L_DELETE_ALL'			=> $_CLASS['core_user']->lang['DELETE_ALL'],
-		'L_REPORTER'			=> $_CLASS['core_user']->lang['REPORTER'],
-		'L_MORE_INFO'			=> $_CLASS['core_user']->lang['MORE_INFO'],
-		'L_MOD_OPTIONS'			=> $_CLASS['core_user']->lang['MOD_OPTIONS'],
-		'L_CHANGE_POSTER'		=> $_CLASS['core_user']->lang['CHANGE_POSTER'],
-		'L_CONFIRM'				=> $_CLASS['core_user']->lang['CONFIRM'],
-		'L_SEARCH'				=> $_CLASS['core_user']->lang['SEARCH'],
-		'L_MOD_OPTIONS'			=> $_CLASS['core_user']->lang['MOD_OPTIONS'],
-		'L_UNLOCK_POST'			=> $_CLASS['core_user']->lang['UNLOCK_POST'],
-		'L_UNLOCK_POST_EXPLAIN'	=> $_CLASS['core_user']->lang['UNLOCK_POST_EXPLAIN'],
-		'L_LOCK_POST'			=> $_CLASS['core_user']->lang['LOCK_POST'],
-		'L_LOCK_POST_EXPLAIN'	=> $_CLASS['core_user']->lang['LOCK_POST_EXPLAIN'],
-		'L_DELETE_POST'			=> $_CLASS['core_user']->lang['DELETE_POST'],
-		'L_SUBMIT'				=> $_CLASS['core_user']->lang['SUBMIT'],
-		'L_IP_INFO'				=> $_CLASS['core_user']->lang['IP_INFO'],
-		'L_OTHER_USERS'			=> $_CLASS['core_user']->lang['OTHER_USERS'],
-		'L_NO_MATCHES_FOUND'	=> $_CLASS['core_user']->lang['NO_MATCHES_FOUND'],
-		'L_OTHER_IPS'			=> $_CLASS['core_user']->lang['OTHER_IPS'],
-		'L_LOOKUP_ALL'			=> $_CLASS['core_user']->lang['LOOKUP_ALL'],
-		'L_JUMP_TO'				=> $_CLASS['core_user']->lang['JUMP_TO'],
-		'L_GO'					=> $_CLASS['core_user']->lang['GO'],
-		'L_LOOKUP_IP'			=> $_CLASS['core_user']->lang['LOOKUP_IP'])
-	);
-	
+$_CLASS['core_user']->add_lang('posting');
+$id = 0;
+$url = 'Forums&amp;file=mcp';
+$post_id = request_var('p', 0);
+$start	= request_var('start', 0);
 
-	$post_id = request_var('p', 0);
-	$start	= request_var('start', 0);
+// Get post data
+$post_info = get_post_data(array($post_id));
 
-	// Get post data
-	$post_info = get_post_data(array($post_id));
+if (empty($post_info))
+{
+	trigger_error('POST_NOT_EXIST');
+}
 
-	if (!sizeof($post_info))
-	{
-		trigger_error($_CLASS['core_user']->lang['POST_NOT_EXIST']);
-	}
+$post_info = $post_info[$post_id];
 
-	$post_info = $post_info[$post_id];
+switch ($action)
+{
+	case 'chgposter_search':
+		$username = request_var('username', '');
 
-	switch ($action)
-	{
-		case 'chgposter_search':
-		
-			$username = request_var('username', '');
+		if ($username)
+		{
+			$users_ary = array();
 
-			if ($username)
+			if (strpos($username, '*') === false)
 			{
-				$users_ary = array();
+				$username = "*$username*";
+			}
+			$username = str_replace('*', '%', str_replace('%', '\%', $username));
 
-				if (strpos($username, '*') === false)
-				{
-					$username = "*$username*";
-				}
-				$username = str_replace('*', '%', str_replace('%', '\%', $username));
+			$sql = 'SELECT user_id, username
+				FROM ' . USERS_TABLE . "
+				WHERE username LIKE '" . $_CLASS['core_db']->sql_escape($username) . "'
+					AND user_type NOT IN (" . USER_INACTIVE . ', ' . USER_IGNORE . ')
+					AND user_id <> ' . $post_info['user_id'];
+			$result = $_CLASS['core_db']->query($sql);
 
-				$sql = 'SELECT user_id, username
-					FROM ' . USERS_TABLE . "
-					WHERE username LIKE '" . $_CLASS['core_db']->sql_escape($username) . "'
-						AND user_type NOT IN (" . USER_INACTIVE . ', ' . USER_IGNORE . ')
-						AND user_id <> ' . $post_info['user_id'];
-				$result = $_CLASS['core_db']->sql_query($sql);
-
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-				{
-					$users_ary[strtolower($row['username'])] = $row;
-				}
-
-				$user_select = '';
-				ksort($users_ary);
-				foreach ($users_ary as $row)
-				{
-					$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
-				}
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$users_ary[strtolower($row['username'])] = $row;
 			}
 
-			if (!$user_select)
+			$user_select = '';
+			ksort($users_ary);
+			foreach ($users_ary as $row)
 			{
-				$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_MATCHES_FOUND']);
+				$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
 			}
+		}
 
-			$_CLASS['core_template']->assign(array(
-				'S_USER_SELECT'		=>	$user_select,
-				'SEARCH_USERNAME'	=>	request_var('username', ''))
-			);
-			break;
+		if (!$user_select)
+		{
+			$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_MATCHES_FOUND']);
+		}
 
-		case 'chgposter':
+		$_CLASS['core_template']->assign_array(array(
+			'S_USER_SELECT'		=>	$user_select,
+			'SEARCH_USERNAME'	=>	request_var('username', ''))
+		);
+		break;
 
-			$new_user = request_var('u', 0);
+	case 'chgposter':
 
-			if ($new_user && $_CLASS['auth']->acl_get('m_', $post_info['forum_id']) && $new_user != $post_info['user_id'])
-			{
-				$sql = 'UPDATE ' . POSTS_TABLE . "
-					SET poster_id = $new_user
-					WHERE post_id = $post_id";
-				$_CLASS['core_db']->sql_query($sql);
+		$new_user = request_var('u', 0);
 
-				if ($post_info['topic_last_post_id'] == $post_info['post_id'] || $post_info['forum_last_post_id'] == $post_info['post_id'])
-				{
-					sync('topic', 'topic_id', $post_info['topic_id'], false, false);
-					sync('forum', 'forum_id', $post_info['forum_id'], false, false);
-				}
-				
-				// Renew post info
-				$post_info = get_post_data(array($post_id));
+		if ($new_user && $_CLASS['auth']->acl_get('m_', $post_info['forum_id']) && $new_user != $post_info['user_id'])
+		{
+			$sql = 'UPDATE ' . POSTS_TABLE . "
+				SET poster_id = $new_user
+				WHERE post_id = $post_id";
+			$_CLASS['core_db']->query($sql);
 
-				if (!sizeof($post_info))
-				{
-					trigger_error($_CLASS['core_user']->lang['POST_NOT_EXIST']);
-				}
-
-				$post_info = $post_info[$post_id];
+			if ($post_info['topic_last_post_id'] == $post_info['post_id'] || $post_info['forum_last_post_id'] == $post_info['post_id'])
+			{
+				sync('topic', 'topic_id', $post_info['topic_id'], false, false);
+				sync('forum', 'forum_id', $post_info['forum_id'], false, false);
 			}
-			break;
 			
-		case 'del_marked':
-		case 'del_all':
-		case 'add_feedback':
-			
-			$deletemark = ($action == 'del_marked') ? true : false;
-			$deleteall	= ($action == 'del_all') ? true : false;
-			$marked		= request_var('marknote', 0);
-			$usernote	= request_var('usernote', '');
+			// Renew post info
+			$post_info = get_post_data(array($post_id));
 
-			if (($deletemark || $deleteall) && $_CLASS['auth']->acl_get('a_clearlogs'))
+			if (empty($post_info))
 			{
-				$where_sql = '';
-				if ($deletemark && $marked)
+				trigger_error('POST_NOT_EXIST');
+			}
+
+			$post_info = $post_info[$post_id];
+		}
+	break;
+		
+	case 'del_marked':
+	case 'del_all':
+	case 'add_feedback':
+		$deletemark = ($action == 'del_marked') ? true : false;
+		$deleteall	= ($action == 'del_all') ? true : false;
+		$marked		= request_var('marknote', 0);
+		$usernote	= request_var('usernote', '');
+
+		if (($deletemark || $deleteall) && $_CLASS['auth']->acl_get('a_clearlogs'))
+		{
+			$where_sql = '';
+			if ($deletemark && $marked)
+			{
+				$sql_in = array();
+				foreach ($marked as $mark)
 				{
-					$sql_in = array();
-					foreach ($marked as $mark)
-					{
-						$sql_in[] = $mark;
-					}
-					$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
-					unset($sql_in);
+					$sql_in[] = $mark;
 				}
+				$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
+				unset($sql_in);
+			}
 
-				$sql = 'DELETE FROM ' . LOG_TABLE . '
-					WHERE log_type = ' . LOG_USERS . " 
-						$where_sql";
-				$_CLASS['core_db']->sql_query($sql);
+			$sql = 'DELETE FROM ' . LOG_TABLE . '
+				WHERE log_type = ' . LOG_USERS . " 
+					$where_sql";
+			$_CLASS['core_db']->query($sql);
 
-				add_log('admin', 'LOG_USERS_CLEAR');
+			add_log('admin', 'LOG_USERS_CLEAR');
 
-				$msg = ($deletemark) ? 'MARKED_DELETED' : 'ALL_DELETED';
-				$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
-				$_CLASS['core_display']->meta_refresh(2, $redirect);
-				trigger_error($_CLASS['core_user']->lang[$msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-			}
+			$msg = ($deletemark) ? 'MARKED_DELETED' : 'ALL_DELETED';
+			$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
+			$_CLASS['core_display']->meta_refresh(2, $redirect);
+			trigger_error($_CLASS['core_user']->lang[$msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+		}
 
-			if ($usernote && $action == 'add_feedback')
-			{
-				add_log('admin', 'LOG_USER_FEEDBACK', $post_info['username']);
-				add_log('user', $post_info['user_id'], 'LOG_USER_GENERAL', $usernote);
+		if ($usernote && $action == 'add_feedback')
+		{
+			add_log('admin', 'LOG_USER_FEEDBACK', $post_info['username']);
+			add_log('user', $post_info['user_id'], 'LOG_USER_GENERAL', $usernote);
 
-				$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
-				$_CLASS['core_display']->meta_refresh(2, $redirect);
-				trigger_error($_CLASS['core_user']->lang['USER_FEEDBACK_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-			}
-			break;
-			
-		default:
-	}
+			$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
+			$_CLASS['core_display']->meta_refresh(2, $redirect);
+			trigger_error($_CLASS['core_user']->lang['USER_FEEDBACK_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+		}
+	break;
+}
 
-	// Set some vars
-	$users_ary = array();
-	$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
+// Set some vars
+$users_ary = array();
+$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
 
-	// Process message, leave it uncensored
-	$message = $post_info['post_text'];
-	if ($post_info['bbcode_bitfield'])
-	{
-		global $site_file_root;
-		require_once($site_file_root.'includes/forums/bbcode.php');
-		$bbcode = new bbcode($post_info['bbcode_bitfield']);
-		$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
-	}
-	$message = smiley_text($message);
+// Process message, leave it uncensored
+$message = $post_info['post_text'];
 
-	$_CLASS['core_template']->assign(array(
-		'U_MCP_ACTION'			=> generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
-		'U_POST_ACTION'			=> generate_link("$url&amp;i=$id&amp;mode=post_details"), // Use this for action parameters
-		'U_APPROVE_ACTION'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;p='.$post_id),
+if ($post_info['bbcode_bitfield'])
+{
+	global $site_file_root;
 
-		'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
-		'S_CAN_CHGPOSTER'		=> $_CLASS['auth']->acl_get('m_', $post_info['forum_id']),
-		'S_CAN_LOCK_POST'		=> $_CLASS['auth']->acl_get('m_lock', $post_info['forum_id']),
-		'S_CAN_DELETE_POST'		=> $_CLASS['auth']->acl_get('m_delete', $post_info['forum_id']),
+	require_once($site_file_root.'includes/forums/bbcode.php');
+	$bbcode = new bbcode($post_info['bbcode_bitfield']);
+	$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+}
 
-		'S_POST_REPORTED'		=> $post_info['post_reported'],
-		'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
-		'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
-		'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
-		'S_SHOW_USER_NOTES'		=> true,
-		'S_CLEAR_ALLOWED'		=> ($_CLASS['auth']->acl_get('a_clearlogs')) ? true : false,
+$_CLASS['core_template']->assign_array(array(
+	'U_MCP_ACTION'			=> generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
+	'U_POST_ACTION'			=> generate_link("$url&amp;i=$id&amp;mode=post_details"), // Use this for action parameters
+	'U_APPROVE_ACTION'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;p='.$post_id),
 
-		'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
+	'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
+	'S_CAN_CHGPOSTER'		=> $_CLASS['auth']->acl_get('m_', $post_info['forum_id']),
+	'S_CAN_LOCK_POST'		=> $_CLASS['auth']->acl_get('m_lock', $post_info['forum_id']),
+	'S_CAN_DELETE_POST'		=> $_CLASS['auth']->acl_get('m_delete', $post_info['forum_id']),
+
+	'S_POST_REPORTED'		=> $post_info['post_reported'],
+	'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
+	'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
+	//'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
+	'S_SHOW_USER_NOTES'		=> true,
+	'S_CLEAR_ALLOWED'		=> ($_CLASS['auth']->acl_get('a_clearlogs')) ? true : false,
+
+	'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
 //		'U_MCP_USERNOTES'		=> generate_link('Forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
 //		'U_MCP_WARNINGS'		=> generate_link('Forums&amp;file=mcp&amp;i=warnings&amp;mode=view_user&amp;u=' . $post_info['user_id']),
-		'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
+	'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
 
-		'RETURN_TOPIC'			=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;p=$post_id#$post_id").'">', '</a>'),
-		'RETURN_FORUM'			=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$post_info['forum_id']}&amp;start={$start}").'">', '</a>'),
-		'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
-		'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
-		'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
-
-		'POSTER_NAME'			=> $poster,
-		'POST_PREVIEW'			=> $message,
-		'POST_SUBJECT'			=> $post_info['post_subject'],
-		'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
-		'POST_IP'				=> $post_info['poster_ip'],
-		'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
-		'POST_ID'				=> $post_info['post_id'])
-	);
+	'RETURN_TOPIC'			=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;p=$post_id#$post_id").'">', '</a>'),
+	'RETURN_FORUM'			=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$post_info['forum_id']}&amp;start={$start}").'">', '</a>'),
+	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
+	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
+	'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
+	'SEARCH_IMG'			=> $_CLASS['core_user']->img('btn_search', 'SEARCH_USER_POSTS'),
 	
-	// Get User Notes
-	$log_data = array();
-	$log_count = 0;
-	view_log('user', $log_data, $log_count, $config['posts_per_page'], 0, 0, 0, $post_info['user_id']);
+	'POSTER_NAME'			=> $poster,
+	'POST_PREVIEW'			=> smiley_text($message),
+	'POST_SUBJECT'			=> $post_info['post_subject'],
+	'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
+	'POST_IP'				=> $post_info['poster_ip'],
+	'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
+	'POST_ID'				=> $post_info['post_id'])
+);
 
-	if ($log_count)
-	{
-		$_CLASS['core_template']->assign('S_USER_NOTES', true);
+// Get User Notes
+$log_data = array();
+$log_count = 0;
 
-		foreach ($log_data as $row)
-		{
-			$_CLASS['core_template']->assign_vars_array('usernotes', array(
-				'REPORT_BY'		=> $row['username'],
-				'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
-				'ACTION'		=> $row['action'],
-				'ID'			=> $row['id'])
-			);
-		}
-	}
-	
-	// Get Reports
-	if ($_CLASS['auth']->acl_get('m_', $post_info['forum_id']))
-	{
-		$sql = 'SELECT r.*, re.*, u.user_id, u.username 
-			FROM ' . REPORTS_TABLE . ' r, ' . USERS_TABLE . ' u, ' . REASONS_TABLE . " re
-			WHERE r.post_id = $post_id
-				AND r.reason_id = re.reason_id
-				AND u.user_id = r.user_id
-			ORDER BY r.report_time DESC";
-		$result = $_CLASS['core_db']->sql_query($sql);
+view_log('user', $log_data, $log_count, $config['posts_per_page'], 0, 0, 0, $post_info['user_id']);
 
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$_CLASS['core_template']->assign('S_SHOW_REPORTS', true);
+if ($log_count)
+{
+	$_CLASS['core_template']->assign('S_USER_NOTES', true);
 
-			do
-			{
-				$_CLASS['core_template']->assign_vars_array('reports', array(
-					'REPORT_ID'		=> $row['report_id'],
-					'REASON_TITLE'	=> $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_name'])],
-					'REASON_DESC'	=> $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])],
-					'REPORTER'		=> ($row['user_id'] != ANONYMOUS) ? $row['username'] : $_CLASS['core_user']->lang['GUEST'],
-					'U_REPORTER'	=> ($row['user_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']) : '',
-					'USER_NOTIFY'	=> ($row['user_notify']) ? true : false,
-					'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']),
-					'REPORT_TEXT'	=> str_replace("\n", '<br />', trim($row['report_text'])))
-				);
-			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
+	foreach ($log_data as $row)
+	{
+		$_CLASS['core_template']->assign_vars_array('usernotes', array(
+			'REPORT_BY'		=> $row['username'],
+			'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
+			'ACTION'		=> $row['action'],
+			'ID'			=> $row['id'])
+		);
 	}
-	
-	// Get IP
-	if ($_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']))
+}
+
+// Get Reports
+
+/*if ($_CLASS['auth']->acl_get('m_', $post_info['forum_id']))
+{
+	$sql = 'SELECT r.*, re.*, u.user_id, u.username 
+		FROM ' . REPORTS_TABLE . ' r, ' . USERS_TABLE . ' u, ' . REASONS_TABLE . " re
+		WHERE r.post_id = $post_id
+			AND r.reason_id = re.reason_id
+			AND u.user_id = r.user_id
+		ORDER BY r.report_time DESC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$rdns_ip_num = request_var('rdns', '');
+		$_CLASS['core_template']->assign('S_SHOW_REPORTS', true);
 
-		if ($rdns_ip_num != 'all')
+		do
 		{
-			$_CLASS['core_template']->assign(array(
-				'U_LOOKUP_ALL'	=> generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all'))
+			$_CLASS['core_template']->assign_vars_array('reports', array(
+				'REPORT_ID'		=> $row['report_id'],
+				'REASON_TITLE'	=> $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_name'])],
+				'REASON_DESC'	=> $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])],
+				'REPORTER'		=> ($row['user_id'] != ANONYMOUS) ? $row['username'] : $_CLASS['core_user']->lang['GUEST'],
+				'U_REPORTER'	=> ($row['user_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']) : '',
+				'USER_NOTIFY'	=> ($row['user_notify']) ? true : false,
+				'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']),
+				'REPORT_TEXT'	=> str_replace("\n", '<br />', trim($row['report_text'])))
 			);
 		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']->free_result($result);
+}*/
 
-		// Get other users who've posted under this IP
-		$sql = 'SELECT u.user_id, u.username, COUNT(*) as postings
-			FROM ' . USERS_TABLE . ' u, ' . POSTS_TABLE . " p
-			WHERE p.poster_id = u.user_id
-				AND p.poster_ip = '{$post_info['poster_ip']}'
-				AND p.poster_id <> {$post_info['user_id']}
-			GROUP BY u.user_id
-			ORDER BY postings DESC";
-		$result = $_CLASS['core_db']->sql_query($sql);
+// Get IP
+if ($_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']))
+{
+	$rdns_ip_num = request_var('rdns', '');
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			// Fill the user select list with users who have posted
-			// under this IP
-			if ($row['user_id'] != $post_info['poster_id'])
-			{
-				$users_ary[strtolower($row['username'])] = $row;
-			}
+	if ($rdns_ip_num != 'all')
+	{
+		$_CLASS['core_template']->assign('U_LOOKUP_ALL', generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all'));
+	}
 
-			$_CLASS['core_template']->assign_vars_array('userrow', array(
-				'USERNAME'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
-				'NUM_POSTS'		=> $row['postings'],	
-				'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
+	// Get other users who've posted under this IP
+	$sql = 'SELECT u.user_id, u.username, user_posts
+		FROM ' . USERS_TABLE . ' u, ' . FORUMS_POSTS_TABLE . " p
+		WHERE p.poster_id = u.user_id
+			AND p.poster_ip = '{$post_info['poster_ip']}'
+			AND p.poster_id <> {$post_info['user_id']}
+		ORDER BY user_posts DESC";
+	$result = $_CLASS['core_db']->query($sql);
 
-				'U_PROFILE'		=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-				'U_SEARCHPOSTS' => generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($row['username']) . '&amp;showresults=topics'))
-			);
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		// Fill the user select list with users who have posted
+		// under this IP
+		if ($row['user_id'] != $post_info['poster_id'])
+		{
+			$users_ary[strtolower($row['username'])] = $row;
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
 
-		// Get other IP's this user has posted under
-		$sql = 'SELECT poster_ip, COUNT(*) AS postings
-			FROM ' . POSTS_TABLE . '
-			WHERE poster_id = ' . $post_info['poster_id'] . '
-			GROUP BY poster_ip
-			ORDER BY postings DESC';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_template']->assign_vars_array('userrow', array(
+			'USERNAME'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
+			'NUM_POSTS'		=> $row['user_posts'],	
+			'L_POST_S'		=> ($row['user_posts'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$hostname = (($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') && $row['poster_ip']) ? @gethostbyaddr($row['poster_ip']) : '';
+			'U_PROFILE'		=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+			'U_SEARCHPOSTS' => generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($row['username']) . '&amp;showresults=topics'))
+		);
+	}
+	$_CLASS['core_db']->free_result($result);
 
-			$_CLASS['core_template']->assign_vars_array('iprow', array(
-				'IP'			=> $row['poster_ip'],
-				'HOSTNAME'		=> $hostname,
-				'NUM_POSTS'		=> $row['postings'],	
-				'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
+	// Get other IP's this user has posted under
+	$sql = 'SELECT poster_ip, COUNT(*) AS postings
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE poster_id = ' . $post_info['poster_id'] . '
+		GROUP BY poster_ip
+		ORDER BY postings DESC';
+	$result = $_CLASS['core_db']->query($sql);
 
-				'U_LOOKUP_IP'	=> ($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') ? '' : generate_link("$url&amp;i=$id&amp;mode=post_details&amp;rdns={$row['poster_ip']}#ip"),
-				'U_WHOIS'		=> generate_link("Forums&amp;file=mcp&amp;i=$id&amp;mode=whois&amp;ip={$row['poster_ip']}"))
-			);
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$hostname = (($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') && $row['poster_ip']) ? @gethostbyaddr($row['poster_ip']) : '';
 
-		// If we were not searching for a specific username fill
-		// the user_select box with users who have posted under
-		// the same IP
-		if ($action != 'chgposter_search')
+		$_CLASS['core_template']->assign_vars_array('iprow', array(
+			'IP'			=> $row['poster_ip'],
+			'HOSTNAME'		=> $hostname,
+			'NUM_POSTS'		=> $row['postings'],	
+			'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
+
+			'U_LOOKUP_IP'	=> ($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') ? '' : generate_link("$url&amp;i=$id&amp;mode=post_details&amp;rdns={$row['poster_ip']}#ip"),
+			'U_WHOIS'		=> generate_link("Forums&amp;file=mcp&amp;i=$id&amp;mode=whois&amp;ip={$row['poster_ip']}"))
+		);
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	// If we were not searching for a specific username fill
+	// the user_select box with users who have posted under
+	// the same IP
+	if ($action != 'chgposter_search')
+	{
+		$user_select = '';
+		ksort($users_ary);
+		foreach ($users_ary as $row)
 		{
-			$user_select = '';
-			ksort($users_ary);
-			foreach ($users_ary as $row)
-			{
-				$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
-			}
-			$_CLASS['core_template']->assign('S_USER_SELECT', $user_select);
+			$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
 		}
+		$_CLASS['core_template']->assign('S_USER_SELECT', $user_select);
 	}
-
 }
 
+page_header();
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_post.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -256,17 +256,15 @@
 
 function split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject)
 {
-	global $_CLASS ;
+	global $_CLASS;
 
-	$start	= request_var('start', 0);
+	$start = get_variable('start', 'REQUEST', false, 'int');
 		
 	if (empty($post_id_list) || !check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_split'))
 	{
 		return false;
 	}
 
-	//$post_id = $post_id_list[0];
-
 	$post_info = get_post_data($post_id_list);
 
 	if (empty($post_info))
@@ -300,11 +298,10 @@
 		return 'DESTINATION_FORUM_NOT_POSTABLE';
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$hidden_fields = build_hidden_fields(array(
 		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
 		'mode'			=> 'topic_view',
 		'start'			=> $start,
 		'action'		=> $mode,
@@ -312,23 +309,25 @@
 		'redirect'		=> $redirect,
 		'subject'		=> $subject,
 		'to_forum_id'	=> $to_forum_id,
-		'icon'			=> request_var('icon', 0))
-	);
-	$success_msg = $return_link = '';
+		'icon'			=> request_var('icon', 0)
+	));
 
-	if (confirm_box(true))
+	$message = ($mode == 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
+
+	if (display_confirmation($_CLASS['core_user']->get_lang($message), $hidden_fields))
 	{
+		$post_id = $post_id_list[0];
 		//$post_info = $post_info[$post_id];
 
-		if ($mode == 'split_beyond')
+		if ($mode === 'split_beyond')
 		{
 			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
-			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
 			if ($sort_order_sql{0} == 'u')
 			{
-				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
-					FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . " u
+				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . " u
 					WHERE p.topic_id = $topic_id
 						AND p.poster_id = u.user_id
 						$limit_time_sql
@@ -336,27 +335,26 @@
 			}
 			else
 			{
-				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
-					FROM ' . POSTS_TABLE . " p
+				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+					FROM ' . FORUMS_POSTS_TABLE . " p
 					WHERE p.topic_id = $topic_id
 						$limit_time_sql
 					ORDER BY $sort_order_sql";
 			}
+
 			$result = $_CLASS['core_db']->query_limit($sql, 0, $start);
 
 			$store = false;
 			$post_id_list = array();
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				// If splitted from selected post (split_beyond), we split the unapproved items too.
-				if (!$row['post_approved'] && !$_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
-				{
-//					continue;
-				}
-
 				// Start to store post_ids as soon as we see the first post that was selected
 				if ($row['post_id'] == $post_id)
 				{
+					$topic_time = $row['post_time'];
+					$topic_poster = $row['poster_id'];
+					$topic_poster_name = $row['post_username'];
 					$store = true;
 				}
 
@@ -367,49 +365,53 @@
 			}
 		}
 
-		if (!sizeof($post_id_list))
+		if (empty($post_id_list))
 		{
-			trigger_error($_CLASS['core_user']->lang['NO_POST_SELECTED']);
+			trigger_error('NO_POST_SELECTED');
 		}
 
-		$icon_id = request_var('icon', 0);
+		$icon_id =  get_variable('icon', 'REQUEST', false, 'int');
 
+		$_CLASS['core_db']->transaction();
+
 		$sql_ary = array(
-			'forum_id'		=> $to_forum_id,
-			'topic_title'	=> $subject,
-			'icon_id'		=> $icon_id,
-			'topic_approved'=> 1
+			'forum_id'				=> $to_forum_id,
+			'topic_title'			=> $subject,
+			'icon_id'				=> $icon_id,
+			'topic_approved'		=> 1,
+			'topic_poster' 			=> $topic_poster,
+			'topic_first_poster_name'	=> $topic_poster_name,
+			'topic_time'			=> $_CLASS['core_user']->time,
+			'topic_status'			=> ITEM_UNLOCKED,
+			'topic_type'			=> POST_NORMAL,
+			'topic_attachment'		=> 0,
+			'topic_replies_real'	=> 0,
+			'topic_replies'			=> 0,
+			'topic_views'			=> 0,
+			'topic_moved_id'		=> 0
 		);
-	
-		$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']->sql_query($sql);
 
-		$to_topic_id = $_CLASS['core_db']->sql_nextid();
+		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+		$to_topic_id = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
+
 		move_posts($post_id_list, $to_topic_id);
 
 		// Change topic title of first post
-		$sql = 'UPDATE ' . POSTS_TABLE . " 
-			SET post_subject = '" . $_CLASS['core_db']->sql_escape($subject) . "'
+		$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . " 
+			SET post_subject = '" . $_CLASS['core_db']->escape($subject) . "'
 			WHERE post_id = {$post_id_list[0]}";
-		$_CLASS['core_db']->sql_query($sql);
-		
+		$_CLASS['core_db']->query($sql);
+
+		$_CLASS['core_db']->transaction('commit');
+
 		$success_msg = 'TOPIC_SPLIT_SUCCESS';
 
 		// Link back to both topics
 		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $post_info['forum_id'] . '&amp;t=' . $post_info['topic_id']) . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_forum_id . '&amp;t=' . $to_topic_id) . '">', '</a>');
 	}
-	else
-	{
-		confirm_box(false, ($mode == 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND', $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link($redirect);
 
-	/*if (strpos($redirect, '?') === false)
-	{
-		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
-	}*/
-
 	if (!$success_msg)
 	{
 		return;

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/forums/message_parser.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -316,10 +316,9 @@
 					if (!preg_match('/^\<\?(.*?)\?\>/is', $code))
 					{
 						$remove_tags = true;
-						$code = "<?php $code";
+						$code = '<?php '. $code;
 					}
 
-					
 					$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
 
 					foreach ($conf as $ini_var)
@@ -327,7 +326,6 @@
 						ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));
 					}
 					
-
 					$code = highlight_string($code, true);
 
 					if (version_compare(PHP_VERSION, '5.0', '<'))
@@ -345,19 +343,20 @@
 					$str_to = array('', '', '&#91;', '&#93;', '&#46;', '&#58', '&#058;');
 
 					$code = str_replace($str_from, $str_to, $code);
-
 					if ($remove_tags)
 					{
 						// if theres any problems with this, find the first "php" without span remove it
 						// then find the first </span> and remove it
-						$pos = ($pos = mb_strpos($code, 'php&nbsp;</span>')) ? $pos + 16 : mb_strpos($code, 'php </span>') + 11;
-						$code = mb_substr($code, $pos);
+						$pos = ($pos = mb_strpos($code, 'php&nbsp;')) ? $pos + 9 : mb_strpos($code, 'php ') + 40;
+						$section = mb_substr($code, 0, $pos);
+						$code = mb_substr($code, $pos);
+						$code = str_replace(array('&lt;?', '<?', 'php&nbsp;', 'php '), '', $section).$code;
 					}
-									
+	
 					$code = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#is', '$1$2$3', $code);
 					$code = preg_replace('#^<span class="[a-z]+"><span class="([a-z]+)">(.*)</span></span>#s', '<span class="$1">$2</span>', $code);
 					$code = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*</span>$#', '</span>', $code);
-				
+			//echo $code; die;	
 					$out .= "[code=$stx:" . $this->bbcode_uid . ']' . trim($code) . '[/code:' . $this->bbcode_uid . ']';
 				break;
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/functions.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -36,7 +36,8 @@
 
 	foreach ($bots_array as $bot)
 	{
-		if ($bot['user_agent'] && preg_match('#' . preg_quote($bot['user_agent'], '#') . '#i', $browser))
+		//if ($bot['user_agent'] && preg_match('#' . preg_quote($bot['user_agent'], '#') . '#i', $browser))
+		if ($bot['user_agent'] && mb_strpos($browser, $bot['user_agent']) === 0)
 		{
 			$is_bot = $bot['user_id'];
 		}

Modified: cms/trunk/includes/handler.php
===================================================================
--- cms/trunk/includes/handler.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/handler.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -17,11 +17,13 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
+
 // Add saving reports to a log file and its define ..
-// this will be core_handlers
 
-class core_error_handler
+class core_handler
 {
 	var $active;
 	var $previous_level;
@@ -80,18 +82,15 @@
 		switch ($option)
 		{
 			case 'start':
-
 				$start_time = explode(' ', microtime());
 				$start_time = $start_time[0] + $start_time[1];
 
 				$this->debug[$name]['start_time'] = $start_time;
 				$this->debug[$name]['queries_before_time'] = $_CLASS['core_db']->sql_time;
 				$this->debug[$name]['queries_before'] = $_CLASS['core_db']->num_queries;
-
 			break;
 
 			case 'stop':
-
 				if (!isset($this->debug[$name]))
 				{
 					return;
@@ -102,20 +101,16 @@
 
 				$this->debug[$name]['end_time'] = $end_time;
 				$this->debug[$name]['queries_after_time'] = $_CLASS['core_db']->sql_time;
-
 			break;
 
 			case 'remove':
-
 				if (isset($this->debug[$name]))
 				{
 					unset($this->debug[$name]);
 				}
-
 			break;
 
 			case 'get':
-
 				switch ($sub_option)
 				{
 					case 'time':
@@ -136,7 +131,6 @@
 						.'<br />Queries Time '.round($this->debug[$name]['queries_after_time'] - $this->debug[$name]['queries_before_time'], 4).' s<br />';
 					break;
 				}
-
 			break;
 		}
 	}
@@ -147,7 +141,7 @@
 
 		if ($this->report != ERROR_NONE)
 		{
-			echo $error;
+			//echo $error;
 
 			//damn windows
 			$errfile = str_replace('\\','/', $errfile);
@@ -165,7 +159,7 @@
 					return;
 				}
 
-				$errtype = ($errtype == E_NOTICE) ? 'E_NOTICE' : 'E_WARNING';
+				$errtype = ($errtype === E_NOTICE) ? 'E_NOTICE' : 'E_WARNING';
 				$this->error = array('type' => $errtype, 'error' => $error, 'file'=> $errfile, 'line' => $errline);
 				$this->format_error($errtype);
 
@@ -173,7 +167,6 @@
 			break;
 
 			case E_USER_ERROR:
-
 				$code = false;
 
 				if (mb_strpos($error, ':')) // there shouldn't be a 0 position
@@ -246,7 +239,7 @@
 
    function format_error($type)
    {
-		if ($this->report == ERROR_ONPAGE)
+		if ($this->report === ERROR_ONPAGE)
 		{
 			echo "PHP $type: in file <b>".$this->error['file'].'</b> on line <b>'.$this->error['line'].'</b>: <b>'.$this->error['error'].'</b><br/>';		
 		}

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/session.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -31,7 +31,7 @@
 	var $sid_link = false;
 	var $need_sid = true;
 
-	var $autologin_code = false;
+	var $autologin_code = '';
 
 	function start()
 	{
@@ -103,6 +103,7 @@
 						$this->need_sid = false;
 					}
 
+					$this->autologin_code = $this->data['session_autologin'];
 					$this->load = check_load_status();
 					$this->sid_link = 'sid='.$this->data['session_id'];
 
@@ -209,6 +210,7 @@
 			'session_admin'		=> (int) $this->data['session_admin'],
 			'session_auth'		=> (int) serialize($_CLASS['core_auth']->auth_dump()),
 			'session_hidden'	=> (int) $this->data['session_hidden'],
+			'session_autologin'	=> (string) $this->autologin_code,
 		);
 
 		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $session_data));
@@ -218,10 +220,12 @@
 		$this->data = array_merge($this->data, $session_data);
 		unset($session_data);
 
-		if ($this->time > $config['session_last_gc'] + $config['session_gc'])
+		$this->gc($this->time);
+
+		/*if ($this->time > $config['session_last_gc'] + $config['session_gc'])
 		{
 			$this->gc($this->time);
-		}
+		}*/
 
 		if (!$this->is_bot)
 		{
@@ -277,10 +281,10 @@
 		$return = false;
 
 		// This is about all we can validate other than the code, and user_id
-		if ($row && $row['auto_login_browser'] == $this->browser)
+		if ($row && $row['auto_login_browser'] === $this->browser)
 		{
 			$return = $user_id;
-			
+
 			$this->autologin_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
 			$data_array = array(
@@ -306,8 +310,8 @@
 	{
 		global $_CLASS;
 		
-		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
-			WHERE user_id = $user_id
+		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . ' 
+			WHERE user_id = '.(INT) $user_id."
 			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
 				
 		$_CLASS['core_db']->query($sql);
@@ -320,7 +324,7 @@
 		if (!$session_id)
 		{
 			$session_id = $this->data['session_id'];
-			
+
 			if ($logout)
 			{
 				$this->set_cookie('sid', '', $this->time - 31536000);
@@ -368,7 +372,7 @@
 			case 'mysqli':
 				$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
 							SET u.user_last_visit = s.session_time
-								WHERE s.session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']) . '
+								WHERE s.session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
 								AND u.user_id = s.session_user_id';
 				$_CLASS['core_db']->query($sql);
 			break;
@@ -392,7 +396,7 @@
 		}
 
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
-				WHERE session_time < ' . ($time - (int) $_CORE_CONFIG['server']['session_length']);
+				WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
 			$_CLASS['core_db']->query($sql);
 
 		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . '
@@ -406,7 +410,7 @@
 
 	function session_data_get($name, $default = false)
 	{
-		return (empty($this->data['session_data'][$name])) ? $default : $this->data['session_data'][$name];
+		return empty($this->data['session_data'][$name]) ? $default : $this->data['session_data'][$name];
 	}
 
 	function session_data_remove($name)

Modified: cms/trunk/includes/system.php
===================================================================
--- cms/trunk/includes/system.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/system.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -32,7 +32,7 @@
 
 	if (extension_loaded('zlib') && !ob_get_length())
 	{
-		ob_start('ob_gzhandler');
+		@ob_start('ob_gzhandler');
 	}
 
 	$size = 24;

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/tables.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -107,10 +107,6 @@
 define('POST_ANNOUNCE', 2);
 define('POST_GLOBAL', 3);
 
-// Lastread types
-define('TRACK_NORMAL', 0);
-define('TRACK_POSTED', 1);
-
 // Notify methods
 define('NOTIFY_EMAIL', 0);
 define('NOTIFY_IM', 1);
@@ -165,12 +161,10 @@
 define('FIELD_DROPDOWN', 5);
 define('FIELD_DATE', 6);
 
-
 // Table names
 
 define('FORUMS_ACL_TABLE', $table_prefix.'forums_auth');
 define('FORUMS_ACL_OPTIONS_TABLE', $table_prefix.'forums_auth_options');
-//define('ACL_DEPS_TABLE', $table_prefix.'forums_auth_deps');
 define('FORUMS_ACL_PRESETS_TABLE', $table_prefix.'forums_auth_presets');
 
 define('FORUMS_ATTACHMENTS_TABLE', $table_prefix.'forums_attachments');

Modified: cms/trunk/includes/templates/installer/stage2.html
===================================================================
--- cms/trunk/includes/templates/installer/stage2.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/installer/stage2.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -1,13 +1,13 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<title>Viperal: Agreement</title>
-<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-<meta http-equiv="expires" content="0" />
-
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
 <style type="text/css">
-<!--
-body
+<!--
+body
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
@@ -19,38 +19,38 @@
 
 .error { color: red; }
 
-#container
-{
-	position: absolute;
-	top: 50%;
-	left: 0px;
-	width: 100%;
-	margin-top: -130px;
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -200px;
 }
-
-#wrapper
-{
-	position: relative;
-	text-align: left;
-	width: 500px;
-	margin: 0px auto;
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
 }
 
 .spacer
 {
 	background-color: #ECECEC;
-}
-
+}
+
 .button
 {
 	background-color: #DCE1E5;
 	border: 1px solid #ccc;
 	color: black;
-}
+}
 
 th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
 .tablebg { background-color: #A9B8C2; }
-
+
 .row1 { background-color: #ECECEC; padding: 4px; }
 .row2 { background-color: #DCE1E5; padding: 4px; }
 .row3 { background-color: #C0C8D0; padding: 4px; }
@@ -63,143 +63,56 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
 
--->
-</style>
-<script language="Javascript" type="text/javascript">
-<!--
-var old_value = 'all';
-
-function change_option(name)
-{
-	var area = document.getElementById(name);
-
-	if (!area)
-	{
-		if (old_value == 'all')
-		{
-			return;
-		}
-		else
-		{
-			name = 'all'
-			area = document.getElementById(name);
-		}
-	}
-
-	area.style.display = '';
-
-	var i = 1;
-
-	while (true)
-	{
-		area = document.getElementById(name + '_' + i);
-
-		if (!area)
-		{
-			break;
-		}
-
-		area.style.display = '';
-		i += 1;
-	}
-
-	area = document.getElementById(old_value);
-	area.style.display = 'none';
-	
-	var i = 1;
-
-	while (true)
-	{
-		area = document.getElementById(old_value + '_' + i);
-
-		if (!area)
-		{
-			break;
-		}
-
-		area.style.display = 'none';
-		i += 1;
-	}
-
-	old_value = name;
-}
-
-//-->
-</script>
+-->
+</style>
+
 <body>
-	<div id="container">
-		<div id="wrapper">
+	<div id="container">
+		<div id="wrapper">
 			<form action="" method="post">
-				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
-					<tbody>
-						<tr>
-							<th colspan="2">Database Configuration</th>
-						</tr>
-						<!-- IF { $error } -->
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<td class="row1" width="50%"><b>Database type: </b></td>
-							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
-						</tr>
-						<tr id="sqlite" style="display: none;">
-							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
-						</tr>
-						<tr id="sqlite_pdo" style="display: none;">
-							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
-						</tr>
-						<tr id="all">
-							<td class="row1" width="50%"><b>Database server hostname: </b></td>
-							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
-						</tr>
-						<tr id="all_1">
-							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
-							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
-						</tr>
-						<tr id="all_2">
-							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
-							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
-						</tr>
-						<tr id="all_3">
-							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
-					
-							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
-						</tr>
-						<tr id="all_4">
-							<td class="row1" width="50%"><b>Database password: </b></td>
-							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
-							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
-							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
-						</tr>
-						<tr>
-							<input type="hidden" name="stage" value="3" />
-							<input type="hidden" name="agreement_signed" value="1" />
-							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
-						</tr>
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">Folder Permissions</th>
+						</tr>
+						<!-- IF { $error } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+							<tr>
+							<td class="row1" width="50%"><b>/cache: </b></td>
+							<td valign="middle" class="row2"><!-- IF { $cache } --><img src="images/led_green.png" /> <b>- Persmission Good</b><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>/cache/template: </b></td>
+							<td valign="middle" class="row2"><!-- IF { $cache_template } --><img src="images/led_green.png" /> <b>- Persmission Good</b><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>/cache/hooks: </b></td>
+							<td valign="middle" class="row2"><!-- IF { $cache_hooks } --><img src="images/led_green.png" /> <b>- Persmission Good</b><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>/images/avatars/upload: </b></td>
+							<td valign="middle" class="row2"><!-- IF { $upload_folder } --><img src="images/led_green.png" /> <b>- Persmission Good</b><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<!-- IF !{ $continue } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">You may not continue, please fix all problems listed in RED</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="3" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" <!-- IF !{ $continue } -->disabled="disabled"<!-- ENDIF --> name="continue" value="Continue" type="submit"></th>
+						</tr>
 					</tbody>
-				</table>
+				</table>
 			</form>
-		</div>
-	</div>
-
-<script language="Javascript" type="text/javascript">
-<!--
-	change_option(document.getElementById('layer').value);
-//-->
-</script>
-
-</body>
-
+		</div>
+	</div>
+</body>
+
 </html>
\ No newline at end of file

Modified: cms/trunk/includes/templates/installer/stage3.html
===================================================================
--- cms/trunk/includes/templates/installer/stage3.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/installer/stage3.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -1,13 +1,13 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<title>Viperal: Agreement</title>
-<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-<meta http-equiv="expires" content="0" />
-
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
 <style type="text/css">
-<!--
-body
+<!--
+body
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
@@ -19,38 +19,38 @@
 
 .error { color: red; }
 
-#container
-{
-	position: relative;
-	top: 50%;
-	left: 0px;
-	width: 100%;
-	margin-top: 0px;
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
 }
-
-#wrapper
-{
-	position: relative;
-	text-align: left;
-	width: 500px;
-	margin: 0px auto;
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
 }
 
 .spacer
 {
 	background-color: #ECECEC;
-}
-
+}
+
 .button
 {
 	background-color: #DCE1E5;
 	border: 1px solid #ccc;
 	color: black;
-}
+}
 
 th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
 .tablebg { background-color: #A9B8C2; }
-
+
 .row1 { background-color: #ECECEC; padding: 4px; }
 .row2 { background-color: #DCE1E5; padding: 4px; }
 .row3 { background-color: #C0C8D0; padding: 4px; }
@@ -63,107 +63,143 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
 
--->
-</style>
-
+-->
+</style>
+<script language="Javascript" type="text/javascript">
+<!--
+var old_value = 'all';
+
+function change_option(name)
+{
+	var area = document.getElementById(name);
+
+	if (!area)
+	{
+		if (old_value == 'all')
+		{
+			return;
+		}
+		else
+		{
+			name = 'all'
+			area = document.getElementById(name);
+		}
+	}
+
+	area.style.display = '';
+
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(name + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = '';
+		i += 1;
+	}
+
+	area = document.getElementById(old_value);
+	area.style.display = 'none';
+	
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(old_value + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = 'none';
+		i += 1;
+	}
+
+	old_value = name;
+}
+
+//-->
+</script>
 <body>
-	<div id="container">
-		<div id="wrapper">
+	<div id="container">
+		<div id="wrapper">
 			<form action="" method="post">
-				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
-					<tbody>
-						<!-- IF { $error } -->
-						<tr>
-							<th align="center" colspan="2">Error</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<th align="center" colspan="2">Administrator Configuration</th>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Username: </b></td>
-					
-							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Password: </b></td>
-							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
-							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Email address: </b></td>
-							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
-							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
-						</tr>
-						<tr>
-							<th align="center" colspan="2">Site Configuration</th>
-						</tr>
-						<tr>
-							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Name: </b></td>
-							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Domain: </b></td>
-							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site path: </b></td>
-							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
-							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
-							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Path: </b></td>
-					
-							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Name: </b></td>
-							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
-						</tr>
-						<!-- IF { $config_content } -->
-						<tr>
-							<th align="center" colspan="2">Config.php Content</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">
-							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
-							</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<input type="hidden" name="stage" value="4" />
-							<input type="hidden" name="agreement_signed" value="1" />
-							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
-						</tr>
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">Database Configuration</th>
+						</tr>
+						<!-- IF { $error } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<td class="row1" width="50%"><b>Database type: </b></td>
+							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
+						</tr>
+						<tr id="sqlite" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="sqlite_pdo" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="all">
+							<td class="row1" width="50%"><b>Database server hostname: </b></td>
+							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
+						</tr>
+						<tr id="all_1">
+							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
+						</tr>
+						<tr id="all_2">
+							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
+							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
+						</tr>
+						<tr id="all_3">
+							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr id="all_4">
+							<td class="row1" width="50%"><b>Database password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
+							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
+							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<input type="hidden" name="stage" value="4" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
+						</tr>
 					</tbody>
-				</table>
+				</table>
 			</form>
-		</div>
-	</div>
-</body>
-
+		</div>
+	</div>
+
+<script language="Javascript" type="text/javascript">
+<!--
+	change_option(document.getElementById('layer').value);
+//-->
+</script>
+
+</body>
+
 </html>
\ No newline at end of file

Added: cms/trunk/includes/templates/installer/stage4.html
===================================================================
--- cms/trunk/includes/templates/installer/stage4.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/installer/stage4.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -0,0 +1,169 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: relative;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: 0px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<!-- IF { $error } -->
+						<tr>
+							<th align="center" colspan="2">Error</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<th align="center" colspan="2">Administrator Configuration</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Username: </b></td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address: </b></td>
+							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
+						</tr>
+						<tr>
+							<th align="center" colspan="2">Site Configuration</th>
+						</tr>
+						<tr>
+							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Name: </b></td>
+							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Domain: </b></td>
+							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site path: </b></td>
+							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
+							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Path: </b></td>
+					
+							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Name: </b></td>
+							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
+						</tr>
+						<!-- IF { $config_content } -->
+						<tr>
+							<th align="center" colspan="2">Config.php Content</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">
+							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
+							</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="5" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/trunk/includes/templates/login_admin.html
===================================================================
--- cms/trunk/includes/templates/login_admin.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/login_admin.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -87,29 +87,28 @@
 					<table width="100%" cellspacing="1" cellpadding="4">
 						<!-- IF { $LOGIN_ERROR } -->
 						<tr>
-							<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
+							<td class="gensmall" colspan="2" align="center"><span class="error">{ $LOGIN_ERROR }</span></td>
 						</tr>
 						<!-- ENDIF -->
 						<tr> 
-							<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
-							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
+							<td valign="top"><b class="gensmall">{ $L_USERNAME }:</b></td>
+							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{ $USERNAME }" tabindex="1" /></td>
 						</tr>
 						<tr> 
-							<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
+							<td valign="top"><b class="gensmall">{ $L_PASSWORD }:</b></td>
 							<td>
-								<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
+								<input class="post" type="password" name="password" size="25" maxlength="25" value="{ $PASSWORD }" tabindex="2" />
 								<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
-								<!-- IF { $U_RESEND_ACTIVATION } --><br /><a class="gensmall" href="{ $U_RESEND_ACTIVATION }">{ $L_RESEND_ACTIVATION }</a><!-- ENDIF -->
 							 </td>
 						</tr>
 						<!-- IF { $S_DISPLAY_FULL_LOGIN } -->
 						<tr> 
 							<td>&nbsp;</td>
-							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{$L_LOG_ME_IN}</span></td>
+							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN }</span></td>
 						</tr>
 						<tr>
 							<td>&nbsp;</td>
-							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{$L_HIDE_ME}</span></td>
+							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME }</span></td>
 						</tr>
 						<!-- ENDIF -->
 					</table>

Modified: cms/trunk/includes/templates/login_body.html
===================================================================
--- cms/trunk/includes/templates/login_body.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/login_body.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -42,7 +42,7 @@
 			<tr class="row2"> 
 				<td><b class="gensmall">{$L_PASSWORD}:</b></td>
 				<td>
-					<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
+					<input class="post" type="password" name="password" size="25" value="{ $PASSWORD }" maxlength="25" tabindex="2" />
 					<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
 					<!-- IF { $U_RESEND_ACTIVATION } --><br /><a class="gensmall" href="{ $U_RESEND_ACTIVATION }">{ $L_RESEND_ACTIVATION }</a><!-- ENDIF -->
 				 </td>

Modified: cms/trunk/includes/templates/login_body_full.html
===================================================================
--- cms/trunk/includes/templates/login_body_full.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/login_body_full.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -87,15 +87,15 @@
 					<table width="100%" cellspacing="1" cellpadding="4">
 						<!-- IF { $LOGIN_ERROR } -->
 						<tr>
-							<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
+							<td class="gensmall" colspan="2" align="center"><span class="error">{ $LOGIN_ERROR }</span></td>
 						</tr>
 						<!-- ENDIF -->
 						<tr> 
-							<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
-							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
+							<td valign="top"><b class="gensmall">{ $L_USERNAME }:</b></td>
+							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{ $USERNAME }" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
 						</tr>
 						<tr> 
-							<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
+							<td valign="top"><b class="gensmall">{ $L_PASSWORD }:</b></td>
 							<td>
 								<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
 								<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
@@ -105,11 +105,11 @@
 						<!-- IF { $S_DISPLAY_FULL_LOGIN } -->
 						<tr> 
 							<td>&nbsp;</td>
-							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{$L_LOG_ME_IN}</span></td>
+							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{ $L_LOG_ME_IN}</span></td>
 						</tr>
 						<tr>
 							<td>&nbsp;</td>
-							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{$L_HIDE_ME}</span></td>
+							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{ $L_HIDE_ME}</span></td>
 						</tr>
 						<!-- ENDIF -->
 					</table>

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_history.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_history.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_history.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -11,53 +11,55 @@
 				<tr>
 					<th width="22%">{ $L_AUTHOR }</th>
 					<th>{ $L_MESSAGE }</th>
-				</tr>
-				{section name=history_rowloop loop=$history_row}
+				</tr>
+				<!-- LOOP $history_row -->
 
-				{ if $smarty.section.history_rowloop.index is even }<tr class="row1">{ else }<tr class="row2">{ /if }
-					<td rowspan="2" align="left" valign="top"><a name="{$history_row[history_rowloop].U_POST_ID}"></a>
+				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+					<td rowspan="2" align="left" valign="top"><a name="{ $history_row:U_POST_ID }"></a>
 						<table width="150" cellspacing="0">
 							<tr>
-								<td align="center" colspan="2"><b class="postauthor">{$history_row[history_rowloop].AUTHOR_NAME}</b></td>
+								<td align="center" colspan="2"><b class="postauthor">{ $history_row:AUTHOR_NAME }</b></td>
 							</tr>
 						</table>
 					</td>
 
-					<td width="100%"{ if $history_row[history_rowloop].S_CURRENT_MSG } style="background-color:lightblue"{ /if }>
-					<div class="gensmall" style="float:left"><b>{$L_PM_SUBJECT}:</b>&nbsp;{$history_row[history_rowloop].SUBJECT}</div><div class="gensmall" style="float:right"><b>{$L_FOLDER}:</b>&nbsp;{$history_row[history_rowloop].FOLDER}</div>
+					<td width="100%"{ if $history_row:S_CURRENT_MSG } style="background-color:lightblue"{ /if }>
+					<div class="gensmall" style="float:left"><b>{ $L_PM_SUBJECT }:</b>&nbsp;{ $history_row:SUBJECT }</div><div class="gensmall" style="float:right"><b>{$L_FOLDER}:</b>&nbsp;{$history_row:FOLDER}</div>
 					</td>
 				</tr>
 
-				{ if $smarty.section.history_rowloop.index is even }<tr class="row1">{ else }<tr class="row2">{ /if }
+				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
 					<td valign="top"><table width="100%" cellspacing="0">
 						<tr>
-							<td valign="top"><table width="100%" cellspacing="0" cellpadding="2">
-								<tr>
-									<td><div id="message_{$history_row[history_rowloop].U_POST_ID}"><div class="postbody">{$history_row[history_rowloop].MESSAGE}</div></div></td>
-								</tr>
-							</table></td>
+							<td valign="top">
+								<table width="100%" cellspacing="0" cellpadding="2">
+									<tr>
+										<td><div id="message_{ $history_row:U_POST_ID }"><div class="postbody">{ $history_row:MESSAGE }</div></div></td>
+									</tr>
+								</table>
+							</td>
 						</tr>
 						<tr>
 							<td><table width="100%" cellspacing="0">
 								<tr valign="middle">
 									<td width="100%">&nbsp;</td>
-									<td width="10" nowrap="nowrap">{$history_row[history_rowloop].MINI_POST_IMG}</td>
-									<td class="gensmall" nowrap="nowrap"><b>{$L_SENT_AT}:</b> {$history_row[history_rowloop].SENT_DATE}</td>
+									<td width="10" nowrap="nowrap">{ $history_row:MINI_POST_IMG }</td>
+									<td class="gensmall" nowrap="nowrap"><b>{ $L_SENT_AT }:</b> { $history_row:SENT_DATE }</td>
 								</tr>
 							</table></td>
 						</tr>
 					</table></td>
 				</tr>
 
-				{ if $smarty.section.history_rowloop.index is even }<tr class="row1">{ else }<tr class="row2">{ /if }
-					<td class="gensmall" align="center" height="28px"><a href="{$history_row[history_rowloop].U_VIEW_MESSAGE}">{$L_VIEW_PM}</a></td>
-					<td><div class="gensmall" style="float:left">&nbsp;{ if $history_row[history_rowloop].U_PROFILE }<a href="{$history_row[history_rowloop].U_PROFILE}">{$PROFILE_IMG}</a> { /if } { if $history_row[history_rowloop].U_EMAIL }<a href="{$history_row[history_rowloop].U_EMAIL}">{$EMAIL_IMG}</a> { /if }&nbsp;</div> <div class="gensmall" style="float:right">{ if $history_row[history_rowloop].U_QUOTE }<a href="{$history_row[history_rowloop].U_QUOTE}">{$QUOTE_IMG}</a> { /if } { if $history_row[history_rowloop].U_POST_REPLY_PM }<a href="{$history_row[history_rowloop].U_POST_REPLY_PM}">{$REPLY_IMG}</a>{ /if }&nbsp;</div></td>
+				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+					<td class="gensmall" align="center" height="28px"><a href="{ $history_row:U_VIEW_MESSAGE }">{ $L_VIEW_PM }</a></td>
+					<td><div class="gensmall" style="float:left">&nbsp;<!-- IF { $history_row:U_AUTHOR_PROFILE } --><a href="{ $history_row:U_AUTHOR_PROFILE }">{ $PROFILE_IMG }</a> <!-- ENDIF --><!-- IF { $history_row:U_EMAIL } --> <a href="{ $history_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF -->&nbsp;</div> <div class="gensmall" style="float:right"><!-- IF { $history_row:U_QUOTE } --><a href="{ $history_row:U_QUOTE }">{ $QUOTE_IMG }</a> <!-- ENDIF --><!-- IF { $history_row:U_POST_REPLY_PM } --> <a href="{ $history_row:U_POST_REPLY_PM }">{ $REPLY_IMG }</a><!-- ENDIF -->&nbsp;</div></td>
 				</tr>
 
 				<tr>
 					<td class="spacer" colspan="2"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
 				</tr>
-				{ /section }
+				<!-- ENDLOOP -->
 			</table>
 		</div></td>
 	</tr>

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -26,7 +26,7 @@
 		<td class="gen">
 		<!-- LOOP $to_recipient -->
 			<a href="{ $to_recipient:U_VIEW }"><!-- IF { $to_recipient:COLOUR } --><span style="color:#{ $to_recipient:COLOUR }"><!-- ELSE --><span<!-- IF { $to_recipient:IS_GROUP} --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $to_recipient:NAME }</span></a>&nbsp;
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $to_recipient -->
 		</td>
 	</tr>
 	<!-- ENDIF -->
@@ -37,7 +37,7 @@
 		<td class="gen">
 		<!-- LOOP $bcc_recipient -->
 			<a href="{ $bcc_recipient:U_VIEW }"><!-- IF { $bcc_recipient:COLOUR } --><span style="color:#{ $bcc_recipient:COLOUR }"><!-- ELSE --><span<!-- IF { $bcc_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $bcc_recipient:NAME }</span></a>&nbsp;
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $bcc_recipient -->
 		</td>
 	</tr>
 	<!-- ENDIF -->

Modified: cms/trunk/includes/templates/modules/Forums/mcp_post.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_post.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/modules/Forums/mcp_post.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
 <table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg"><form method="post" name="mcp" action="{ $U_APPROVE_ACTION }">
@@ -186,4 +188,6 @@
 	<!-- ENDIF -->
 <!-- ENDIF -->
 
-<!-- INCLUDE modules/Forums/mcp_footer.html -->
\ No newline at end of file
+<!-- INCLUDE modules/Forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-10-06 18:22:34 UTC (rev 162)
@@ -86,7 +86,7 @@
 			<!-- IF { $S_SEARCH_USER } --><td align="center"><input type="checkbox" name="user" value="{$leader_row:USERNAME}" /></td><!-- ENDIF -->
 
 		</tr>
-	<!-- ENDLOOP -->
+	<!-- ENDLOOP $leader_row -->
 
 	<!-- IF isset({ $member_row }) && { $S_SHOW_GROUP } && !{ $S_SEARCH_USER } -->
 		<tr>
@@ -115,7 +115,7 @@
 		<tr>
 			<td class="row1" colspan="<!-- IF { $S_SEARCH_USER } -->9<!-- ELSE -->8<!-- ENDIF -->" height="28" align="center"><span class="gen">{ $L_NO_MEMBERS }</span></td>
 		</tr>
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $member_row -->
 
 		<tr>
 			<td class="cat" colspan="<!-- IF { $S_SEARCH_USER } -->9<!-- ELSE -->8<!-- ENDIF -->" align="center">

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/includes/user.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -430,6 +430,7 @@
 	function img($img, $alt = '', $width = false, $suffix = '')
 	{
 		$img = $this->get_img($img);
+		$alt = $this->get_lang($alt);
 
 		if (!$img['src'])
 		{

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/install/build_data.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -25,8 +25,9 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
-
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_upload', 'images/avatars/upload', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_gallery', 'images/avatars/gallery', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_smilies', 'images/smilies', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
 $content = $_CLASS['core_db']->escape('<a href="feed.php?feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
@@ -180,7 +181,7 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', 'AA0000', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8.,66.249.64.,66.249.71.', 'Googlebot/', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/install/build_tables.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -175,6 +175,7 @@
 $_CLASS['core_db']->add_table_field_int('session_user_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('session_admin', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('session_hidden', array('max' => 10));
+$_CLASS['core_db']->add_table_field_char('session_autologin', 40);
 
 $_CLASS['core_db']->add_table_field_text('session_data', 60000);
 $_CLASS['core_db']->add_table_field_text('session_auth', 60000);
@@ -940,7 +941,7 @@
 $_CLASS['core_db']->add_table_field_int('replied', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('marked', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('forwarded', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('folder_id', array('min' => -10, 'max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('msg_id');
 $_CLASS['core_db']->add_table_index(array('user_id', 'folder_id'));

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/installer.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -33,6 +33,7 @@
 
 set_magic_quotes_runtime(0);
 mb_internal_encoding('UTF-8');
+set_time_limit(0);
 
 define('STRIP_SLASHES', get_magic_quotes_gpc());
 
@@ -104,7 +105,7 @@
 	$stage = 0;
 }
 
-if ($stage === 4)
+if ($stage === 5)
 {
 	if (file_exists(SITE_FILE_ROOT.'config.php'))
 	{
@@ -222,12 +223,12 @@
 		'config_content'	=> $config_content
 	));
 
-	$_CLASS['core_template']->display('installer/stage3.html');
+	$_CLASS['core_template']->display('installer/stage4.html');
 
 	script_close();
 }
 
-if ($stage === 3)
+if ($stage === 4)
 {
 	if ($db_layer && in_array($db_layer, array_keys($database_array)))
 	{
@@ -335,7 +336,7 @@
 
 	if (isset($_POST['test']) || !empty($error))
 	{
-		$stage = 2;
+		$stage = 3;
 	}
 	else
 	{
@@ -359,7 +360,7 @@
 
 		if (!$result)
 		{
-			$stage = 2;
+			$stage = 3;
 			$error[] = 'Installation failed<br/> Please confirm that your using the currect database layer';
 		}
 		else
@@ -422,14 +423,14 @@
 				'config_content'	=> $config_data
 			));
 
-			$_CLASS['core_template']->display('installer/stage3.html');
+			$_CLASS['core_template']->display('installer/stage4.html');
 	
 			script_close();
 		}
 	}
 }
 
-if ($stage === 2)
+if ($stage === 3)
 {
 	if (isset($_POST['test']) && empty($error))
 	{
@@ -450,11 +451,27 @@
 		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
 	));
 
-	$_CLASS['core_template']->display('installer/stage2.html');
+	$_CLASS['core_template']->display('installer/stage3.html');
 
 	script_close();
 }
 
+if ($stage === 2)
+{
+	$_CLASS['core_template']->assign_array(array(
+		'error'				=> false,
+		'continue'			=> true,
+
+		'cache'				=> @is_writable(SITE_FILE_ROOT.'cache'),
+		'cache_template'	=> @is_writable(SITE_FILE_ROOT.'cache/template'),
+		'cache_hooks'		=> @is_writable(SITE_FILE_ROOT.'cache/hooks'),
+		'upload_folder'		=> @is_writable('images/avatars/upload'),
+	));
+	
+	$_CLASS['core_template']->display('installer/stage2.html');
+	script_close();
+}
+
 if ($stage === 1)
 {
 	$gd_info = gd_info();

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -539,7 +539,7 @@
 					$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
 					
 					// Get folder img, topic status/type related informations
-					$folder_img = $folder_alt = $topic_type = '';
+					$folder_img = $folder_alt = $topic_type = $unread_topic = '';
 					topic_status($row, $replies, $_CLASS['core_user']->time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
 					$view_topic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id";
@@ -552,7 +552,6 @@
 						'TOPIC_ID' 			=> $topic_id,
 						'S_DELETED_TOPIC'	=> (!$row['topic_id']) ? true : false,
 						'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
-						'TOPIC_TYPE' 		=> $topic_type,
 						'FORUM_NAME'		=> $row['forum_name'],
 
 						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
@@ -561,7 +560,7 @@
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
 						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 
 						'PAGINATION'		=> $pagination['formated'],

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -99,7 +99,7 @@
 			// New private messages popup
 			case 'popup':
 			
-				$indox_link = generate_link('Control_Panel&amp;i=pm&amp;folder=inbox');
+				$indox_link = generate_link('Control_Panel&i=pm&folder=inbox');
 
 				if ($_CLASS['core_user']->data['user_new_privmsg'])
 				{
@@ -327,6 +327,7 @@
 					}
 				}
 
+				$folder = array();
 				get_folder($_CLASS['core_user']->data['user_id'], $folder, $folder_id);
 	
 				$s_folder_options = $s_to_folder_options = '';

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -11,9 +11,9 @@
 // 
 // -------------------------------------------------------------
 	
-function view_message($id, $mode, $folder_id, $msg_id, $folder, $message_row)
+function view_message($id, $mode, $folder_id, $msg_id, $folder, &$message_row)
 {
-	global $_CLASS, $_CORE_CONFIG, $site_file_root, $config;
+	global $_CLASS, $_CORE_CONFIG, $config;
 
 	$_CLASS['core_user']->add_lang('viewtopic');
 	$msg_id		= (int) $msg_id;
@@ -33,7 +33,7 @@
 	// Instantiate BBCode if need be
 	if ($message_row['bbcode_bitfield'])
 	{
-		require($site_file_root.'includes/forums/bbcode.php');
+		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$bbcode = new bbcode($message_row['bbcode_bitfield']);
 	}
 
@@ -46,7 +46,7 @@
 	$message = $message_row['message_text'];
 
 	// If the board has HTML off but the message has HTML on then we process it, else leave it alone
-	if ($message_row['enable_html'] && (!$config['auth_html_pm'] || !$_CLASS['auth']->acl_get('u_pm_html')))
+	if ($message_row['enable_html'] && !$config['auth_html_pm'])
 	{
 		$message = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $message);
 	}
@@ -81,7 +81,7 @@
 
 	if ($message_row['message_attachment'] && $config['allow_pm_attach'])
 	{
-		if ($config['auth_download_pm'] && $_CLASS['auth']->acl_get('u_pm_download'))
+		if ($config['auth_download_pm'])
 		{
 			$sql = 'SELECT * 
 				FROM ' . FORUMS_ATTACHMENTS_TABLE . "
@@ -145,7 +145,7 @@
 		$_CLASS['core_db']->query($sql);
 	}
 
-	$signature = ($message_row['enable_sig'] && $config['allow_sig'] && $_CLASS['auth']->acl_get('u_sig') && $_CLASS['core_user']->optionget('viewsigs')) ? $user_info['user_sig'] : '';
+	$signature = ($message_row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->optionget('viewsigs')) ? $user_info['user_sig'] : '';
 	
 	// End signature parsing, only if needed
 	if ($signature)
@@ -154,7 +154,7 @@
 		{
 			if (!isset($bbcode) || !$bbcode)
 			{
-				require($site_file_root.'includes/forums/bbcode.php');
+				require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 				$bbcode = new bbcode($user_info['user_sig_bbcode_bitfield']);
 			}
 
@@ -195,14 +195,14 @@
 		'EDITED_MESSAGE'	=> $l_edited_by,
 
 		'U_MCP_REPORT'		=> generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']),
-		'U_REPORT'			=> ($config['auth_report_pm'] && $_CLASS['auth']->acl_get('u_pm_report')) ? generate_link('Forums&amp;file=report&amp;pm=' . $message_row['msg_id']) : '',
+		'U_REPORT'			=> (false) ? generate_link('Forums&amp;file=report&amp;pm=' . $message_row['msg_id']) : '',
 		'U_INFO'			=> ($_CLASS['auth']->acl_get('m_') && ($message_row['message_reported'] || $message_row['forwarded'])) ? generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']) : '',
-		'U_DELETE' 			=> ($_CLASS['auth']->acl_get('u_pm_delete')) ? generate_link("$url&amp;mode=compose&amp;action=delete&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
-		'U_AUTHOR_PROFILE' 		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $author_id),
+		'U_DELETE' 			=> generate_link("$url&amp;mode=compose&amp;action=delete&amp;f=$folder_id&amp;p=" . $message_row['msg_id']),
+		'U_AUTHOR_PROFILE' 	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $author_id),
 		'U_EMAIL' 			=> $user_info['email'],
-		'U_QUOTE'			=> ($_CLASS['auth']->acl_get('u_sendpm') && $author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
-		'U_EDIT' 			=> (($message_row['message_time'] > time() - $config['pm_edit_time'] || !$config['pm_edit_time']) && $folder_id == PRIVMSGS_OUTBOX && $_CLASS['auth']->acl_get('u_pm_edit')) ? generate_link("$url&amp;mode=compose&amp;action=edit&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '', 
-		'U_POST_REPLY_PM' 	=> ($author_id != $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('u_sendpm')) ? generate_link("$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
+		'U_QUOTE'			=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
+		'U_EDIT' 			=> (($message_row['message_time'] > time() - $config['pm_edit_time'] || !$config['pm_edit_time']) && $folder_id == PRIVMSGS_OUTBOX) ? generate_link("$url&amp;mode=compose&amp;action=edit&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '', 
+		'U_POST_REPLY_PM' 	=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
 		'U_PREVIOUS_PM'		=> generate_link("$url&amp;f=$folder_id&amp;p=" . $message_row['msg_id'] . "&amp;view=previous"),
 		'U_NEXT_PM'			=> generate_link("$url&amp;f=$folder_id&amp;p=" . $message_row['msg_id'] . "&amp;view=next"),
 
@@ -225,9 +225,9 @@
 }	
 
 // Display Message History
-function message_history($msg_id, $user_id, $message_row, $folder)
+function message_history($msg_id, $user_id, &$message_row, $folder)
 {
-	global $config, $site_file_root, $_CLASS, $bbcode;
+	global $config, $_CLASS, $bbcode;
 
 	// Get History Messages (could be newer)
 	$sql = 'SELECT t.*, p.*, u.*
@@ -283,7 +283,7 @@
 
 	$title = ($sort_dir == 'a') ? $row['message_subject'] : $title;
 
-	if (sizeof($rowset) == 1)
+	if (count($rowset) === 1)
 	{
 		return false;
 	}
@@ -293,7 +293,7 @@
 	{
 		if (!class_exists('bbcode'))
 		{
-			require($site_file_root.'includes/forums/bbcode.php');
+			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		}
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
@@ -325,7 +325,7 @@
 		if ($id == $msg_id)
 		{
 			$next_history_pm = next($rowset);
-			$next_history_pm = (sizeof($next_history_pm)) ? (int) $next_history_pm['msg_id'] : 0;
+			$next_history_pm = empty($next_history_pm) ? 0 : (int) $next_history_pm['msg_id'];
 			$previous_history_pm = $prev_id;
 		}
 
@@ -341,8 +341,8 @@
 			'U_MSG_ID'			=> $row['msg_id'],
 			'U_VIEW_MESSAGE'	=> generate_link("$url&amp;f=$folder_id&amp;p=" . $row['msg_id']),
 			'U_AUTHOR_PROFILE' 	=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$author_id),
-			'U_QUOTE'			=> ($_CLASS['auth']->acl_get('u_sendpm') && $author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=" . $folder_id . "&amp;p=" . $row['msg_id']) : '',
-			'U_POST_REPLY_PM' 	=> ($author_id != $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('u_sendpm')) ? generate_link("$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=" . $row['msg_id']) : '')
+			'U_QUOTE'			=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=" . $folder_id . "&amp;p=" . $row['msg_id']) : '',
+			'U_POST_REPLY_PM' 	=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=" . $row['msg_id']) : '')
 		);
 		unset($rowset[$id]);
 		$prev_id = $id;
@@ -442,9 +442,9 @@
 		$user_row['rank_title'] = $user_row['rank_image'] = '';
 	}
 
-	if (!empty($user_row['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
+	if (!empty($user_row['user_allow_viewemail']))
 	{
-		$user_row['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails'] && !$_CLASS['auth']->acl_get('a_email')) ? '' : 'mailto:' . $user_row['user_email']);
+		$user_row['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails']) ? '' : 'mailto:' . $user_row['user_email']);
 	}
 	else
 	{

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Forums/ajax.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -41,7 +41,7 @@
 		
 		if (!$forum_id || !$title || !$_CLASS['forums_auth']->acl_get('a_forum'))
 		{
-			die;
+			script_close();
 		}
 
 		$title = htmlentities($title, ENT_QUOTES, 'UTF-8');
@@ -59,7 +59,7 @@
 
 		if (!$topic_id || !$title )
 		{
-			die;
+			script_close();
 		}
 
 		$result = $_CLASS['core_db']->query('SELECT forum_id FROM ' . FORUMS_TOPICS_TABLE . ' WHERE topic_id = '.$topic_id);
@@ -68,7 +68,7 @@
 
 		if (!$row || !$_CLASS['forums_auth']->acl_get('m_edit', $row['forum_id']))
 		{
-			die;
+			script_close();
 		}
 
 		$title = mb_strtolower(htmlentities($title, ENT_QUOTES, 'UTF-8'));
@@ -86,7 +86,7 @@
 
 		if (!$topic_id)
 		{
-			die;
+			script_close();
 		}
 
 		$result = $_CLASS['core_db']->query('SELECT forum_id FROM ' . FORUMS_TOPICS_TABLE . ' WHERE topic_id = '.$topic_id);
@@ -95,7 +95,7 @@
 
 		if (!$row || !$_CLASS['forums_auth']->acl_get('m_lock', $row['forum_id']))
 		{
-			die;
+			script_close();
 		}
 
 		$status = ($lock) ? ITEM_LOCKED : ITEM_UNLOCKED;
@@ -115,7 +115,7 @@
 
 		if (!$forum_id || !$_CLASS['forums_auth']->acl_get('a_forum', $forum_id))
 		{
-			die;
+			script_close();
 		}
 
 		$status = ($lock) ? ITEM_LOCKED : ITEM_UNLOCKED;
@@ -130,4 +130,5 @@
 	break;
 }
 
+script_close();
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Forums/download.php
===================================================================
--- cms/trunk/modules/Forums/download.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Forums/download.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -219,11 +219,8 @@
 		$attachment['mimetype'] = ($browser_agent == 'ie' || $browser_agent == 'opera') ? 'application/octetstream' : 'application/octet-stream';
 	}
 
-	if (@ob_get_length())
-	{
-		@ob_end_clean();
-	}
-	
+	while (@ob_end_clean());
+
 	// Now the tricky part... let's dance
 	header('Pragma: public');
 

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/modules/Forums/mcp.php	2005-10-06 18:22:34 UTC (rev 162)
@@ -230,7 +230,6 @@
 		case 'front':
 			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
 			script_close(false);
-			//$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
 		break;
 
 		case 'forum_view':
@@ -245,10 +244,6 @@
 			
 		case 'post_details':
 			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_post.php');
-			
-			mcp_post_details($id, $mode, $action, $url);
-			
-			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_post.html');
 			script_close(false);
 		break;
 	}
@@ -502,7 +497,7 @@
 			{
 				$sql .= 'AND topic_approved = 1';
 			}
-			break;
+		break;
 
 		case 'viewtopic':
 			$type = 'posts';
@@ -512,11 +507,12 @@
 				FROM ' . FORUMS_POSTS_TABLE . "
 				$where_sql topic_id = $topic_id
 					AND post_time >= $min_time";
+
 			if (!$_CLASS['auth']->acl_get('m_approve', $forum_id))
 			{
 				$sql .= 'AND post_approved = 1';
 			}
-			break;
+		break;
 
 		case 'unapproved_posts':
 			$type = 'posts';
@@ -527,7 +523,7 @@
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
 					AND post_approved = 0
 					AND post_time >= ' . $min_time;
-			break;
+		break;
 
 		case 'unapproved_topics':
 			$type = 'topics';
@@ -538,7 +534,7 @@
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
 					AND topic_approved = 0
 					AND topic_time >= ' . $min_time;
-			break;
+		break;
 
 		case 'reports':
 			$type = 'reports';
@@ -563,7 +559,7 @@
 				$where_sql
 					AND p.post_id = r.post_id
 					$limit_time_sql";
-			break;
+		break;
 
 		case 'viewlogs':
 			$type = 'logs';
@@ -574,7 +570,7 @@
 				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_'))) . ')
 					AND log_time >= ' . $min_time . ' 
 					AND log_type = ' . LOG_MOD;
-			break;
+		break;
 	}
 
 	$sort_key = request_var('sk', $default_key);
@@ -589,7 +585,7 @@
 
 			$sort_by_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'tt' => 't.topic_time', 'r' => (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? 't.topic_replies_real' : 't.topic_replies'), 's' => 't.topic_title', 'v' => 't.topic_views');
 			$limit_time_sql = ($min_time) ? "AND t.topic_last_post_time >= $min_time" : '';
-			break;
+		break;
 
 		case 'posts':
 			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_POSTS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);

Modified: cms/trunk/themes/viperal/style/style.css
===================================================================
--- cms/trunk/themes/viperal/style/style.css	2005-10-06 17:49:39 UTC (rev 161)
+++ cms/trunk/themes/viperal/style/style.css	2005-10-06 18:22:34 UTC (rev 162)
@@ -1,13 +1,13 @@
 body
 {
-    font-family: Verdana, Helvetica, sans-serif;
-    font-size: 10px;
+	font-family: Verdana, Helvetica, sans-serif;
+	font-size: 65%;
 
-    /* Needed for opera */
-    margin: 0px; 
+	/* Needed for opera */
+	margin: 0px; 
 
-    padding: 0px;
-    background: url(images/bg.gif);
+	padding: 0px;
+	background: url(images/bg.gif);
 }
 
 .logo
@@ -141,7 +141,6 @@
 	position: relative;
 	min-height: 13px;
 	color: black;
-	font-size: 110%;
 }
 
 /* 
@@ -150,7 +149,6 @@
 .centerblock
 {
 	width : 100%;
-	font-size: 100%;
     border-top:1px solid #ccc;
     border-bottom:1px solid #ccc;
 }
@@ -172,7 +170,8 @@
 /* 
 	SIDE BLOCKS
 */
-.blocks {
+.blocks
+{
 	position: relative;
 	margin: 0px 0px 10px 0px;
 	min-height: 12px;
@@ -201,7 +200,6 @@
     background: url(images/bg.gif);
     border-top: 1px solid #ccc;
     border-bottom: 1px solid #ccc;
-    font-size: 110%;
 }
 	
 .articles_block .title



From viperal at berlios.de  Mon Oct 17 21:31:16 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 17 Oct 2005 21:31:16 +0200
Subject: [Viperals-svncheckins] r163 - in cms/trunk: . includes includes/display install modules/Contact modules/Control_Panel modules/Forums modules/Members_List modules/Quick_Message modules/articles
Message-ID: <200510171931.j9HJVGIm024084@sheep.berlios.de>

Author: viperal
Date: 2005-10-17 21:31:14 +0200 (Mon, 17 Oct 2005)
New Revision: 163

Modified:
   cms/trunk/ajax.php
   cms/trunk/core.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/user.php
   cms/trunk/index.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/modules/Contact/index.php
   cms/trunk/modules/Control_Panel/index.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Members_List/index.php
   cms/trunk/modules/Quick_Message/ajax.php
   cms/trunk/modules/Quick_Message/index.php
   cms/trunk/modules/articles/index.php
Log:
TRUNCK will be broken for a few days.

First major change commit.

Modified: cms/trunk/ajax.php
===================================================================
--- cms/trunk/ajax.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/ajax.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -22,24 +22,17 @@
 //require(SITE_FILE_ROOT.'core.php');
 require('core.php');
 
-$mod = get_variable('mod', 'REQUEST', false);
-
-if (!$mod)
+if ($mod = get_variable('mod', 'REQUEST', false))
 {
-	die;
-}
-else
-{
-	$sql = 'SELECT * FROM '.CORE_MODULES_TABLE.'
-				WHERE module_type = ' . MODULE_NORMAL . "
-				AND module_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+	$sql = 'SELECT * FROM ' . CORE_PAGES_TABLE . "
+				WHERE page_name = '" . $_CLASS['core_db']->escape($mod) . "'";
 
 	//Grab module data if it exsits
 	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	$status = $_CLASS['core_display']->add_module($row);
+	$status = $_CLASS['core_display']->process_page($row, 'ajax');
 
 	if ($status !== true)
 	{
@@ -47,14 +40,9 @@
 		script_close(false);
 	}
 
-	$_CORE_MODULE = $_CLASS['core_display']->get_module();
+	$_CLASS['core_display']->generate_page('ajax');
 }
 
-$path = SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/ajax.php';
-$_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
-
-require_once($path);
-
 script_close(false);
 
 ?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/core.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -44,7 +44,7 @@
 define('STRIP_SLASHES', get_magic_quotes_gpc());
 
 // Remove registered globals
-if ((bool) ini_get('register_globals'))
+if (ini_get('register_globals'))
 {
 	foreach ($_REQUEST as $var_name => $value)
 	{
@@ -57,12 +57,9 @@
 	define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 }
 
-// TEMP
-$site_file_root = SITE_FILE_ROOT;
-
 if (!extension_loaded('mbstring'))
 {
-	require_once(SITE_FILE_ROOT.'includes/compatiblity/mbstring.php');
+	require_once SITE_FILE_ROOT.'includes/compatiblity/mbstring.php';
 }
 
 mb_internal_encoding('UTF-8');
@@ -83,10 +80,10 @@
 	}
 }
 
-require_once(SITE_FILE_ROOT.'includes/display/template.php');
-require_once(SITE_FILE_ROOT.'includes/functions.php');
-require_once(SITE_FILE_ROOT.'includes/handler.php');
-require_once(SITE_FILE_ROOT.'config.php');
+require_once SITE_FILE_ROOT.'includes/display/template.php';
+require_once SITE_FILE_ROOT.'includes/functions.php';
+require_once SITE_FILE_ROOT.'includes/handler.php';
+require_once SITE_FILE_ROOT.'config.php';
 
 @register_shutdown_function('script_close');
 
@@ -96,7 +93,7 @@
 
 // Set error handler
 $_CLASS['core_handler']->start();
-//$_CLASS['core_handler']->stop();
+$_CLASS['core_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
 if (empty($site_db))
@@ -110,10 +107,10 @@
 	trigger_error('503:<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
 }
 
-require_once(SITE_FILE_ROOT.'includes/tables.php');
-require_once(SITE_FILE_ROOT.'includes/db/'.$site_db['type'].'.php');
-require_once(SITE_FILE_ROOT.'includes/cache/cache.php');
-require_once(SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php');
+require_once SITE_FILE_ROOT.'includes/tables.php';
+require_once SITE_FILE_ROOT.'includes/db/'.$site_db['type'].'.php';
+require_once SITE_FILE_ROOT.'includes/cache/cache.php';
+require_once SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php';
 
 load_class(false, 'core_cache', 'cache_'.$acm_type);
 load_class(false, 'core_db', 'db_'.$site_db['type']);
@@ -205,12 +202,12 @@
 }
 
 // Load user based classes, and display options
-require(SITE_FILE_ROOT.'includes/session.php');
-require(SITE_FILE_ROOT.'includes/user.php');
-require(SITE_FILE_ROOT.'includes/auth/auth.php');
-require(SITE_FILE_ROOT.'includes/auth/auth_db.php');
-require(SITE_FILE_ROOT.'includes/display/blocks.php');
-require(SITE_FILE_ROOT.'includes/display/display.php');
+require SITE_FILE_ROOT.'includes/session.php';
+require SITE_FILE_ROOT.'includes/user.php';
+require SITE_FILE_ROOT.'includes/auth/auth.php';
+require SITE_FILE_ROOT.'includes/auth/auth_db.php';
+require SITE_FILE_ROOT.'includes/display/blocks.php';
+require SITE_FILE_ROOT.'includes/display/display.php';
 
 load_class(false, 'core_display');
 load_class(false, 'core_blocks');
@@ -242,7 +239,7 @@
 
 if ($_SERVER['REQUEST_METHOD'] == 'POST' && $_CLASS['core_user']->new_session)
 {
-	// error here
+	die;// error here
 }
 
 function get_memory_usage()

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/includes/display/blocks.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -32,40 +32,42 @@
 	var $content;
 	var $template;
 
+	var $expire_updated;
+
 	/*
 		Check to see there's any blocks for the specified side
 		should be used to stop themes from displaying blank sides
 	*/
 	function check_side($side)
 	{
-// expand this for center blocks
 		static $side_check = array();
-		
-		if (isset($side_check[$side]))
+
+		settype($side, 'int');
+		$true_side = $side >> 1;
+
+		if (isset($side_check[$true_side]))
 		{
-			return $side_check[$side];
+			return $side_check[$true_side];
 		}
 
-		global $_CORE_MODULE, $_CLASS;
+		global $_CLASS;
 
-		$trueside = $side;
-
-		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
+		if ($_CLASS['core_user']->lang['DIRECTION'] === 'rtl')
 		{
-			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
+			$side = ($side === BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
-			
-		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
+
+		if ($_CLASS['core_display']->page['page_blocks'] & $side)
 		{
 			$this->load_blocks();
 
-			if (!empty($this->blocks_array[$side]))
+			if (!empty($this->blocks_array[$side >> 1]))
 			{
-				return $side_check[$trueside] = $side;
+				return $side_check[$true_side] = $side;
 			}
 		}
 		
-		return $side_check[$trueside] = false;
+		return $side_check[$true_side] = false;
 	}
 
 	/*
@@ -121,18 +123,22 @@
 	*/
 	function display($position)
 	{
+		settype($position, 'int');
+
 		$this->display_position = $position;
 
-		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
+		if ($position === BLOCK_LEFT || $position === BLOCK_RIGHT)
 		{
 			$position = $this->check_side($position);
-			
-			if ($position == false)
+
+			if ($position === false)
 			{
 				return false;
 			}
 		}
 
+		$position = ($position >> 1);
+
 		$this->load_blocks();
 
 		if (empty($this->blocks_array[$position]))
@@ -140,7 +146,6 @@
 			return false;
 		}
 
-		static $expire_updated = false;
 		global $_CLASS;
 
 		$this->content = '';
@@ -155,12 +160,12 @@
 				continue;
 			}
 
-			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
+			if ($this->block['block_expires'] && !$this->expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
 			{
 				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);
 										
 				$_CLASS['core_cache']->destroy('blocks');
-				$expire_updated = true;
+				$this->expire_updated = true;
 
 				continue;
 			}
@@ -258,8 +263,7 @@
 
 		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
 		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		if ($this->display_position === BLOCK_LEFT || $this->display_position === BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -289,7 +293,7 @@
 			$edit_link = $expires = false;
 		}
 
-		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
+		$postion = ($this->display_position === BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
 
 		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
 				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
@@ -306,7 +310,7 @@
 	{
 		global $_CLASS;
 		
-		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
+		$position = ($this->display_position === BLOCK_RIGHT) ? 'right' : 'left';
 		
 		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
 			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
@@ -321,7 +325,7 @@
 	{
 		$this->content = $this->block['block_content'];
 
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		if ($this->display_position === BLOCK_LEFT || $this->display_position === BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -340,7 +344,7 @@
 		{
 			$this->content = $this->block['block_content'];
 
-			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+			if ($this->display_position === BLOCK_LEFT || $this->display_position === BLOCK_RIGHT)
 			{
 				$this->block_side();
 			}
@@ -402,7 +406,7 @@
 			$_CLASS['core_cache']->destroy('blocks');
 		}
 
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		if ($this->display_position === BLOCK_LEFT || $this->display_position === BLOCK_RIGHT)
 		{
 			$this->block_side();
 		}
@@ -416,7 +420,7 @@
 	{
 		global $_CLASS;
 		
-		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
+		$position = ($this->display_position === BLOCK_TOP) ? 'center' : 'bottom';
 		
 		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
 			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/includes/display/display.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -31,62 +31,125 @@
 
 	var $theme = false;
 	var $homepage = false;
-	var $modules = array();
 
+	var $pages_holding = array();
+	var $page = array();
+
 	var $copyright = 'Powered by <a href="http://www.viperal.com">CMS alpha-dev</a> (c) 2004 - 2005 Ryan Marshall ( Viperal )';
 
 	/*
 		Handles sorting and auth'ing of modules
 	*/
-	function add_module($module, $homepage = true)
+	function process_page($page, $type = 'page')
 	{
-		global $_CLASS;
-
-		if (!$module || !file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/index.php'))
+		if (!$page)
 		{
 			return '404:_PAGE_NOT_FOUND';
 		}
 
-		if ($module['module_status'] != STATUS_ACTIVE)
+		global $_CLASS;
+
+		settype($page['page_status'], 'int');
+		settype($page['page_type'], 'int');
+		settype($page['page_status'], 'int');
+		settype($page['page_blocks'], 'int');
+
+		if ($page['page_status'] !== STATUS_ACTIVE)
 		{
-			if ($module['module_status'] == STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('modules'))
+			if ($page['page_status'] === STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('pages'))
 			{
-				$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
+				$_CLASS['core_display']->message = '<b>Module '.$page['page_name'].' Isn\'t Active</b><br />';
 			}
 			else
 			{
-				return '_MODULE_NOT_ACTIVE';
+				return '_PAGE_NOT_ACTIVE';
 			}
 		}
 
-		//authization check here
-		$module['module_auth'] = ($module['module_auth']) ? unserialize($module['module_auth']) : '';
+		switch ($type)
+		{
+			case 'admin':
+				if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['module_name']))
+				{
+					trigger_error('NOT_AUTH', E_USER_ERROR);
+				}
+				
+				if (file_exists(SITE_FILE_ROOT.'admin/'.$page['page_name'].'.php'))
+				{
+					$page['page_location'] = SITE_FILE_ROOT.'admin/'.$page['page_name'].'.php';
+				}
+				elseif (file_exists(SITE_FILE_ROOT.'modules/'.$page['page_name'].'/admin/index.php'))
+				{
+					$page['page_location'] = SITE_FILE_ROOT.'modules/'.$page['page_name'].'/admin/index.php';
+				}
+				else
+				{
+					return '404:_PAGE_NOT_FOUND';
+				}
+			break;
+			
+			case 'ajax':
+				$page['page_location'] = SITE_FILE_ROOT.'modules/'.$page['page_name'].'/ajax.php';
 
-		if (($module['module_auth'] && !$_CLASS['core_auth']->auth($module['module_auth'])) && !$_CLASS['core_auth']->admin_power('modules'))
-		{
-			return '_MODULE_NOT_AUTH';
+			default:
+				//authization check here
+				$page['page_auth'] = ($page['page_auth']) ? @unserialize($page['page_auth']) : '';
+		
+				if (($page['page_auth'] && !$_CLASS['core_auth']->auth($page['page_auth'])) && !$_CLASS['core_auth']->admin_power('pages'))
+				{
+					return '_PAGE_NOT_AUTH';
+				}
+	
+				if (!$page['page_location'])
+				{
+					$page['page_location'] = SITE_FILE_ROOT.'modules/'.$page['page_name'].'/index.php';
+				}
+
+				if (!file_exists($page['page_location']))
+				{
+					return '404:_PAGE_NOT_FOUND';
+				}
+			break;
 		}
 
-		//first module control the sides.
-		if (!empty($this->modules))
+		//first page control the sides.
+		if (!empty($this->pages_holding))
 		{
-			$module['module_sides'] = $this->modules[0]['module_sides'];
+			$page['page_sides'] = $this->pages_holding[0]['page_sides'];
 		}
+		else
+		{
+			$_CLASS['core_user']->page = $page['page_name'];
+		}
 
-		$this->modules[] = $module;
+		$this->pages_holding[] = $page;
 
 		return true;
 	}
 
 	/*
-		Returns parsed module data
+		Returns parsed page data
 	*/
-	function get_module()
+	function generate_page($type = 'page')
 	{
-		if (isset($this->modules))
+		if (!empty($this->pages_holding))
 		{
 			// this also unsets $this->modules
-			return array_shift($this->modules);
+			$this->page = array_shift($this->pages_holding);
+
+			if ($this->page['page_location'])
+			{
+				require_once $this->page['page_location'];
+				
+				$class_name = $type.'_'.$this->page['page_name'];
+
+				if (class_exists($class_name))
+				{
+					$module = new $class_name;
+				}
+			}
+
+			return true;
 		}
 
 		return false;
@@ -177,6 +240,9 @@
 		$this->header['js'][] = "<script type=\"text/javascript\">\nvar cms_session_id = '{$_CLASS['core_user']->data['session_id']}';\nvar cms_cookie_path = '{$_CORE_CONFIG['server']['cookie_path']}';\nvar cms_cookie_domain = '{$_CORE_CONFIG['server']['cookie_domain']}';\n</script>";
 		$this->header['meta'][] = '<base href="'.generate_base_url().'" />';
 
+		$this->header['meta'][] = '<meta name="description" content="Development Site for Viperal CMS" />';
+		$this->header['meta'][] = '<meta name="keywords" content="viperal, cms, php, mysql, postgresql, postgres, sqlite, nuke, community, forums, bulletin, boards, javascript, open source, GPL, online, html" />';
+		
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']),
@@ -217,9 +283,14 @@
 			script_close($save);
 		}
 
-		if ($_CORE_MODULE = $this->get_module())
+		if ($this->generate_page())
 		{
-			require(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
+// TEMP
+//$_CORE_MODULE =& $_CLASS['core_display']->page;
+
+		//	require(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
+			return;
+
 		}
 
 		$this->displayed['footer'] = true;

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/includes/functions.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -593,7 +593,7 @@
 	{
 		if ($file)
 		{
-			include_once($file);
+			require_once $file;
 		}
 
 		$_CLASS[$name] =& new $class;
@@ -810,12 +810,9 @@
 	
 	while ($file = readdir($handle))
 	{
-		if (mb_strpos($file, '.') === false)
+		if (mb_strpos($file, '.') === false && file_exists(SITE_FILE_ROOT."themes/$file/index.php"))
 		{
-			if (file_exists(SITE_FILE_ROOT."themes/$file/index.php"))
-			{
-				$theme_array[] = array('file' => $file, 'template'=> true);
-			}
+			$theme_array[] = array('file' => $file, 'template'=> true);
 		}
 	}
 	

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/includes/tables.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -60,15 +60,13 @@
 define('ADMIN_NOT_ADMIN', 1);
 define('ADMIN_IS_ADMIN', 2);
 
-// Block side defines
-define('BLOCK_NONE', 0);
-define('BLOCK_ALL', 1);
-define('BLOCK_LEFT', 2);
-define('BLOCK_RIGHT', 3);
-define('BLOCK_TOP', 4);
-define('BLOCK_BOTTOM', 5);
-define('BLOCK_MESSAGE_TOP', 6);
-define('BLOCK_MESSAGE_BOTTOM', 7);
+// Block side
+define('BLOCK_LEFT', (1 << 1));
+define('BLOCK_RIGHT', (1 << 2));
+define('BLOCK_TOP', (1 << 3));
+define('BLOCK_BOTTOM', (1 << 4));
+define('BLOCK_MESSAGE_TOP', (1 << 5));
+define('BLOCK_MESSAGE_BOTTOM', (1 << 6));
 
 define('BLOCKTYPE_FILE',0);
 define('BLOCKTYPE_FEED',1);
@@ -202,10 +200,8 @@
 define('ADMIN_AUTH_TABLE', $table_prefix.'admins');
 
 define('BLOCKS_TABLE', $table_prefix.'blocks');
-
 define('CORE_CONFIG_TABLE', $table_prefix.'config');
-define('CORE_MODULES_TABLE', $table_prefix.'modules');
-
+define('CORE_PAGES_TABLE', $table_prefix.'pages');
 define('SMILIES_TABLE', $table_prefix.'smilies');
 
 define('USER_GROUP_TABLE', $table_prefix.'groups_members');

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/includes/user.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -205,7 +205,6 @@
 		}
 
 		$this->user_setup = true;
-		$this->data['user_unread_privmsg'] = 0; // TEMP
 		
 		if (!is_null($theme))
 		{
@@ -281,23 +280,23 @@
 
 		if (!$img_file || !ereg('/', $img_file))
 		{
-			global $_CORE_MODULE, $_CLASS;
+			global $_CLASS;
 			
-			$module = ($module) ? $module : $_CORE_MODULE['module_name'];
+			$module = ($module) ? $module : $_CLASS['core_display']->page['page_name'];
 			$lang = ($lang) ? $lang : $this->lang_name;
 
 			if (file_exists($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file"))
 			{
-				include($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file");
+				include $_CLASS['core_display']->theme_path."/images/modules/$module/$img_file";
 			}
 			else
 			{
-				include(SITE_FILE_ROOT.'modules/'.$module."/images/$img_file");
+				include SITE_FILE_ROOT.'modules/'.$module."/images/$img_file";
 			}
 		}
 		else
 		{
-			include($img_file.'.php');
+			include $img_file.'.php';
 		}
 	}
 	
@@ -351,7 +350,7 @@
 		{
 			if (mb_strpos($lang_file, '/') !== false)
 			{
-				include(SITE_FILE_ROOT."language/$this->lang_name/$lang_file");
+				include SITE_FILE_ROOT."language/$this->lang_name/$lang_file";
 
 				return;
 			}
@@ -365,14 +364,14 @@
 
 		if (!$module)
 		{
-			global $_CORE_MODULE;
-			
-			include(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name']."/language/$this->lang_name/$lang_file");
+			global $_CLASS;
 
+			include SITE_FILE_ROOT.'modules/'.$_CLASS['core_display']->page['page_name']."/language/$this->lang_name/$lang_file";
+
 			return;
 		}
 		
-		include(SITE_FILE_ROOT."modules/$module/language/$this->lang_name/$lang_file");		
+		include SITE_FILE_ROOT."modules/$module/language/$this->lang_name/$lang_file";		
 	}
 
 	function user_data_get($name, $default = false)

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -22,11 +22,11 @@
 */
 
 define('VIPERAL', 'CMS');
-
+//print_r($_GET);die;
 error_reporting(E_ALL);
 
-//require(SITE_FILE_ROOT.'core.php');
-require('core.php');
+//require_once SITE_FILE_ROOT.'core.php';
+require_once 'core.php';
 
 $mod = get_variable('mod', 'REQUEST', false);
 
@@ -36,20 +36,33 @@
 	$_CLASS['core_display']->homepage = true;
 	$_CORE_CONFIG['global']['index_page'] = 'articles';
 
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name = '{$_CORE_CONFIG['global']['index_page']}'");
+	$sql = 'SELECT * FROM ' . CORE_PAGES_TABLE . "
+				WHERE page_name = '".$_CLASS['core_db']->escape($_CORE_CONFIG['global']['index_page'])."'";
+	$result = $_CLASS['core_db']->query($sql);
 
 	While ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$_CLASS['core_display']->add_module($row);
+		$_CLASS['core_display']->process_page($row);
 	}
-
 	$_CLASS['core_db']->free_result($result);
 
-	if (!($_CORE_MODULE = $_CLASS['core_display']->get_module()))
+	if (!$_CLASS['core_display']->generate_page())
 	{
-		$_CORE_MODULE['module_sides'] = BLOCK_ALL;
-		$_CORE_MODULE += array('module_name' => '', 'module_title' => ''); // temp
+		/*
+		$blocks = 0;
+		$blocks |= BLOCK_LEFT;
+		$blocks |= BLOCK_RIGHT;
+		$blocks |= BLOCK_TOP;
+		$blocks |= BLOCK_BOTTOM;
+		$blocks |= BLOCK_MESSAGE_TOP;
+		$blocks |= BLOCK_MESSAGE_BOTTOM;
+		echo $blocks;
+		*/
 
+		$blocks = 126;
+
+		$_CLASS['core_display']->page = array('page_blocks' => $blocks, 'page_name' => '', 'page_title' => '');
+
 		$_CLASS['core_user']->user_setup();
 		$_CLASS['core_display']->display_header();
 
@@ -60,13 +73,13 @@
 		}
 	
 		$_CLASS['core_display']->display_footer();
-	}
+	}	
 }
 else
 {
 	if ($mod === 'system')
 	{
-		require_once(SITE_FILE_ROOT.'includes/system.php');
+		require_once SITE_FILE_ROOT.'includes/system.php';
 
 		$mode = get_variable('mode', 'REQUEST', false);
 
@@ -81,30 +94,24 @@
 		script_close(false);
 	}
 
-	$sql = 'SELECT * FROM '.CORE_MODULES_TABLE.'
-				WHERE module_type = ' . MODULE_NORMAL . "
-				AND module_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+	$sql = 'SELECT * FROM '.CORE_PAGES_TABLE.'
+				WHERE page_type = ' . MODULE_NORMAL . "
+				AND page_name = '" . $_CLASS['core_db']->escape($mod) . "'";
 
-	//Grab module data if it exsits
 	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	$status = $_CLASS['core_display']->add_module($row);
+	$status = $_CLASS['core_display']->process_page($row);
 	
 	if ($status !== true)
 	{
 		trigger_error($status, E_USER_ERROR);
 	}
 
-	$_CORE_MODULE = $_CLASS['core_display']->get_module();
+	$_CLASS['core_display']->generate_page();
 }
 
-$path = SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php';
-$_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
-
-require_once($path);
-
 script_close();
 
 ?>
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/install/build_data.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -120,23 +120,22 @@
 $content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('blocks', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('system', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('messages', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('modules', 0, 2)");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('smiles', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('users', 0, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('blocks', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('groups', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('system', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('messages', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('pages', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('smiles', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('users', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('groups', 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('calender', 1, 1, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 1, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Contact', 1, 2, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 1, 1, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Control_Panel', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Forums', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Members_List', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Quick_Message', 1, 1, 102)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/install/build_tables.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -32,7 +32,7 @@
 	Admin Auth Table
 */
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'admins');
+$_CLASS['core_db']->table_create('start', $table_prefix.'admin_access');
 
 $_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
@@ -141,16 +141,15 @@
 /*
 	Modules Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'modules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'admin_modules');
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
 $_CLASS['core_db']->add_table_field_char('module_title', 100, true);
+$_CLASS['core_db']->add_table_field_char('module_location', 100, true);
 $_CLASS['core_db']->add_table_field_int('module_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('module_status', array('max' => 10));
-$_CLASS['core_db']->add_table_field_int('module_sides', array('max' => 10, 'null' => true));
 $_CLASS['core_db']->add_table_field_text('module_auth', 60000, true);
-$_CLASS['core_db']->add_table_field_text('module_auth_options', 60000, true);
 $_CLASS['core_db']->add_table_field_text('module_admin_options', 6000, true);
 
 $_CLASS['core_db']->add_table_index('module_id', 'primary');
@@ -158,6 +157,23 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+$_CLASS['core_db']->table_create('start', $table_prefix.'pages');
+
+$_CLASS['core_db']->add_table_field_int('page_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('page_name', 100);
+$_CLASS['core_db']->add_table_field_char('page_title', 100, true);
+$_CLASS['core_db']->add_table_field_char('page_location', 100, true);
+$_CLASS['core_db']->add_table_field_int('page_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('page_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('page_blocks', array('max' => 10000, 'null' => true)); // Convert to bitfield
+$_CLASS['core_db']->add_table_field_text('page_auth', 60000, true);
+$_CLASS['core_db']->add_table_field_text('page_auth_options', 60000, true);
+
+$_CLASS['core_db']->add_table_index('page_id', 'primary');
+$_CLASS['core_db']->add_table_index('page_name', 'unique');
+
+$_CLASS['core_db']->table_create('commit');
+
 /*
 	Sessions Table
 */

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/installer.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -28,7 +28,7 @@
 
 if (!extension_loaded('mbstring'))
 {
-	require_once(SITE_FILE_ROOT.'includes/compatiblity/mbstring.php');
+	require_once SITE_FILE_ROOT.'includes/compatiblity/mbstring.php';
 }
 
 set_magic_quotes_runtime(0);
@@ -46,8 +46,8 @@
 	}
 }
 
-require_once(SITE_FILE_ROOT.'includes/functions.php');
-require_once(SITE_FILE_ROOT.'includes/display/template.php');
+require_once SITE_FILE_ROOT.'includes/functions.php';
+require_once SITE_FILE_ROOT.'includes/display/template.php';
 
 load_class(false, 'core_template');
 
@@ -109,7 +109,7 @@
 {
 	if (file_exists(SITE_FILE_ROOT.'config.php'))
 	{
-		require_once(SITE_FILE_ROOT.'config.php');
+		require_once SITE_FILE_ROOT.'config.php';
 	}
 
 	$site_name		= get_variable('site_name', 'POST');
@@ -167,9 +167,9 @@
 
 	if (empty($error))
 	{
-		require_once(SITE_FILE_ROOT.'includes/tables.php');
-		require_once(SITE_FILE_ROOT.'includes/cache/cache.php');
-		require_once(SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php');
+		require_once SITE_FILE_ROOT.'includes/tables.php';
+		require_once SITE_FILE_ROOT.'includes/cache/cache.php';
+		require_once SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php';
 
 		load_class(false, 'core_cache', 'cache_'.$acm_type);
 
@@ -321,8 +321,8 @@
 	{
 		$user_prefix	= get_variable('user_prefix', 'POST');
 		$table_prefix	= get_variable('table_prefix', 'POST');
-		
-		require_once(SITE_FILE_ROOT.'includes/tables.php');
+
+		require_once SITE_FILE_ROOT.'includes/tables.php';
 	
 		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
 		$result = $_CLASS['core_db']->query_limit($sql, 1);

Modified: cms/trunk/modules/Contact/index.php
===================================================================
--- cms/trunk/modules/Contact/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Contact/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -21,97 +21,100 @@
 $Id$
 */
 
-// Add departments
+/*$this->test = 'test';
+echo $this-> 'test';*/
 
-if (!defined('VIPERAL'))
+class page_contact
 {
-    die;
-}
-
-$_CLASS['core_user']->user_setup();
-$_CLASS['core_user']->add_lang();
-
-$error = '';
-
-if (!empty($_POST['preview']) || !empty($_POST['contact']))
-{
-	$data['MESSAGE']= trim(get_variable('message', 'POST', ''));
-	$data['NAME']	= get_variable('sender_name', 'POST', '');
-	$data['EMAIL']	= get_variable('sender_email', 'POST', '');
-
-	foreach ($data as $field => $value)
+	function page_contact()
 	{
-		if (!$value)
+		// Add departments
+		global $_CLASS;
+		
+		if (!defined('VIPERAL'))
 		{
-			$error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
-			unset($field, $value, $lang);
-        }
-        elseif ($field == 'EMAIL' && !check_email($value))
-        {
-			$error .= $_CLASS['core_user']->lang['BAD_EMAIL'].'<br />';
+			die;
 		}
-	} 
 
-	if (!empty($_POST['preview']) && $data['MESSAGE'])
-	{
-		send_feedback($data['NAME'],  $data['EMAIL'], $data['MESSAGE'], $preview = true);
+		$_CLASS['core_user']->user_setup();
+		$_CLASS['core_user']->add_lang();
+		
+		$this->error = '';
+		$this->preview = !empty($_POST['preview']);
+		
+		if ($this->preview || !empty($_POST['contact']))
+		{
+			$this->data['MESSAGE'] = trim(get_variable('message', 'POST', ''));
+			$this->data['NAME']	= get_variable('sender_name', 'POST', '');
+			$this->data['EMAIL']	= get_variable('sender_email', 'POST', '');
+		
+			foreach ($this->data as $field => $value)
+			{
+				if (!$value)
+				{
+					$this->error .= $_CLASS['core_user']->lang['ERROR_'.$field].'<br />';
+					unset($field, $value, $lang);
+				}
+				elseif ($field == 'EMAIL' && !check_email($value))
+				{
+					$this->error .= $_CLASS['core_user']->lang['BAD_EMAIL'].'<br />';
+				}
+			} 
+		
+			if (!$this->error)
+			{
+				$this->send_feedback();
+			}
+		}
+		else
+		{
+			$this->data['NAME'] = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['username'] : '';
+			$this->data['EMAIL'] = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['user_email'] : '';
+			$this->data['MESSAGE'] = '';
+		}
+		
+		$_CLASS['core_template']->assign_array(array( 
+			'ERROR' 				=> $this->error,
+			'MESSAGE' 				=> $this->data['MESSAGE'],
+			'ACTION' 				=> generate_link($_CLASS['core_display']->page['page_name']),
+			'SENDER_EMAIL' 			=> $this->data['EMAIL'],
+			'SENDER_NAME' 			=> $this->data['NAME'],
+		));
+		
+		$_CLASS['core_template']->display('modules/Contact/index.html');
 	}
-	elseif (!empty($_POST['contact']) && !$error)
-	{
-		send_feedback($data['NAME'], $data['EMAIL'], $data['MESSAGE']);
-	}
 
-	$sender_name = $data['NAME'];
-	$sender_email = $data['EMAIL'];
-	$message = $data['MESSAGE'];
-}
-else
-{
-	$sender_name = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['username'] : '';
-	$sender_email = ($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['user_email'] : '';
-	$message = '';
-}
-
-$_CLASS['core_template']->assign_array(array( 
-	'ERROR' 				=> $error,
-	'MESSAGE' 				=> $message,
-	'ACTION' 				=> generate_link($_CORE_MODULE['module_name']),
-	'SENDER_EMAIL' 			=> $sender_email,
-	'SENDER_NAME' 			=> $sender_name,
-));
-
-$_CLASS['core_template']->display('modules/Contact/index.html');
-
-// remove this function
-function send_feedback($sender_name, $sender_email, $message, $preview = false)
-{
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']->assign_array(array(
-		'SENT_FROM'		=> $sender_name,
-		'SENDER_NAME'	=> $sender_name,
-		'SENDER_EMAIL'	=> $sender_email,
-		'SENDER_IP'		=> $_CLASS['core_user']->ip,
-		'MESSAGE' 		=> $message,
-	));
-
-	$body = trim($_CLASS['core_template']->display('email/contact/index.txt', true));
-
-	if ($preview)
+	// remove this function
+	function send_feedback()
 	{
-		$_CLASS['core_template']->assign('PREVIEW', modify_lines($body, '<br/>'));
-
-		return;
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$_CLASS['core_template']->assign_array(array(
+			'SENT_FROM'		=> $this->data['NAME'],
+			'SENDER_NAME'	=> $this->data['NAME'],
+			'SENDER_EMAIL'	=> $this->data['EMAIL'],
+			'SENDER_IP'		=> $_CLASS['core_user']->ip,
+			'MESSAGE' 		=> $this->data['MESSAGE'],
+		));
+	
+		$body = trim($_CLASS['core_template']->display('email/contact/index.txt', true));
+	
+		if ($this->preview)
+		{
+			$_CLASS['core_template']->assign('PREVIEW', modify_lines($body, '<br/>'));
+	
+			return;
+		}
+	
+		require_once SITE_FILE_ROOT.'includes/mailer.php';
+	
+		$mailer = new core_mailer;
+		$mailer->to($_CORE_CONFIG['email']['site_mail'], $_CORE_CONFIG['global']['site_name']);
+		$mailer->subject($_CLASS['core_user']->get_lang('SITE_FEEDBACK'));
+	
+		$mailer->message = $body;
+	
+		trigger_error($mailer->send() ? 'SEND_SUCCESSFULL' : $mailer->error);
 	}
-
-	require_once(SITE_FILE_ROOT.'includes/mailer.php');
-
-	$mailer = new core_mailer;
-	$mailer->to($_CORE_CONFIG['email']['site_mail'], false);
-	$mailer->subject($_CLASS['core_user']->get_lang('SITE_FEEDBACK'));
-
-	$mailer->message = $body;
-
-	trigger_error($mailer->send() ? 'SEND_SUCCESSFULL' : $mailer->error);
 }
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Control_Panel/index.php
===================================================================
--- cms/trunk/modules/Control_Panel/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Control_Panel/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -16,8 +16,10 @@
     die;
 }
 
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
+global $_CLASS, $_CORE_CONFIG;
+
+require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 $_CLASS['auth'] =& $_CLASS['forums_auth'];
 
 $_CLASS['core_user']->user_setup();
@@ -30,8 +32,6 @@
 
 $ucp = new module();
 
-//require($site_file_root.'includes/forums/functions_user.php');
-
 //define the undefineds
 $_CLASS['core_template']->assign_array(array(
 	'S_DISPLAY_FORM'		=> false,
@@ -170,8 +170,6 @@
 
 	function load($type = false, $name = false, $mode = false, $run = true)
 	{
-		global $site_file_root;
-
 		if ($type)
 		{
 			$this->type = $type;
@@ -184,7 +182,7 @@
 
 		if (!class_exists($this->type . '_' . $this->name))
 		{
-			require_once($site_file_root."modules/Control_Panel/{$this->type}/{$this->type}_{$this->name}.php");
+			require_once(SITE_FILE_ROOT."modules/Control_Panel/{$this->type}/{$this->type}_{$this->name}.php");
 
 			if ($run)
 			{
@@ -213,32 +211,6 @@
 
 		script_close();
 	}
-
-	// Public methods to be overwritten by modules
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-
-	function install()
-	{
-		return false;
-	}
-
-	function uninstall()
-	{
-		return false;
-	}
 }
 //
 // FUNCTIONS
@@ -300,23 +272,21 @@
 	break;
 		
 	case 'delete_cookies':
-		// Delete Cookies with dynamic names (do NOT delete poll cookies)
-		if (confirm_box(true))
+		if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_COOKIES')))
 		{
 			global $_CORE_CONFIG;
 			
-			$set_time = time() - 31536000;
+			$set_time = gmtime() - 31536000;
+
 			foreach ($_COOKIE as $cookie_name => $cookie_data)
 			{
 				$cookie_name = str_replace($_CORE_CONFIG['server']['cookie_name'] . '_', '', $cookie_name);
+
 				if (strpos($cookie_name, '_poll') === false)
 				{
 					$_CLASS['core_user']->set_cookie($cookie_name, '', $set_time);
 				}
 			}
-			$_CLASS['core_user']->set_cookie('track', '', $set_time);
-			$_CLASS['core_user']->set_cookie('data', '', $set_time);
-			$_CLASS['core_user']->set_cookie('sid', '', $set_time);
 
 			$_CLASS['core_user']->logout();
 
@@ -326,10 +296,6 @@
 			trigger_error($message);
 
 		}
-		else
-		{
-			confirm_box(false, 'DELETE_COOKIES', '');
-		}
 		
 		redirect();
 		break;

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Forums/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -21,6 +21,8 @@
 $Id$
 */
 
+global $_CLASS, $_CORE_CONFIG;
+
 $file = get_variable('file', 'REQUEST', false);
 
 $approved_files = array('viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');

Modified: cms/trunk/modules/Members_List/index.php
===================================================================
--- cms/trunk/modules/Members_List/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Members_List/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -27,12 +27,13 @@
     die();
 }
 
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
-$_CLASS['auth'] =& $_CLASS['forums_auth'];
+global $_CLASS, $_CORE_CONFIG;
 
-$_CLASS['auth']->acl($_CLASS['core_user']->data);
+require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
+$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
+
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang();
 $_CLASS['core_user']->add_img(false, 'Forums');
@@ -62,30 +63,25 @@
 // What do you want to do today? ... oops, I think that line is taken ...
 switch ($mode)
 {
-
-	case 'forum_leaders':
+	case 'leaders':
 		// Display a listing of board admins, moderators
-
-		$_CLASS['core_user']->add_lang('groups', 'Forums');
+		//$_CLASS['core_user']->add_lang('groups', 'Forums');
 		
 		$page_title = $_CLASS['core_user']->lang['LEADER'];
 		$template_html = 'memberlist_leaders.html';
 
-		$user_ary = $_CLASS['auth']->acl_get_list(false, array('a_', 'm_'), false);
+		$user_ary = $_CLASS['forums_auth']->acl_get_list(false, 'm_', false);
+		$admin_id_ary = $mod_id_ary = $forum_id_ary = array();
 
-		$admin_id_ary = $mod_id_ary = $forum_id_ary = array();
 		foreach ($user_ary as $forum_id => $forum_ary)
 		{
-			foreach ($forum_ary as $auth_option => $id_ary)
-			{
-				(!$forum_id && $auth_option == 'a_') ? $admin_id_ary += $id_ary : $mod_id_ary += $id_ary;
+			$mod_id_ary += $forum_ary['m_'];
 
-				if ($forum_id)
+			if ($forum_id)
+			{
+				foreach ($forum_ary['m_'] as $id)
 				{
-					foreach ($id_ary as $id)
-					{
-						$forum_id_ary[$id][] = $forum_id;
-					}
+					$forum_id_ary[$id][] = $forum_id;
 				}
 			}
 		}
@@ -112,21 +108,21 @@
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$which_row = (in_array($row['user_id'], $admin_id_ary)) ? 'admin' : 'mod';
+			$which_row = in_array($row['user_id'], $admin_id_ary) ? 'admin' : 'mod';
 
 			$s_forum_select = '';
 			if ($which_row == 'mod' && sizeof(array_diff(array_keys($forums), $forum_id_ary[$row['user_id']])))
 			{
 				foreach ($forum_id_ary[$row['user_id']] as $forum_id)
 				{
-					if (isset($forums[$forum_id]) && $_CLASS['auth']->acl_get('f_list', $forum_id))
+					if (isset($forums[$forum_id]) && $_CLASS['forums_auth']->acl_get('f_list', $forum_id))
 					{
 						$s_forum_select .= '<option value="">' . $forums[$forum_id] . '</option>';
 					}
 				}
 			}
 			
-			if ($row['group_type'] == GROUP_HIDDEN && !$_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel') && $row['ug_user_id'] != $_CLASS['core_user']->data['user_id'])
+			if ($row['group_type'] == GROUP_HIDDEN && $row['ug_user_id'] != $_CLASS['core_user']->data['user_id'])
 			{
 				$group_name = $_CLASS['core_user']->get_lang('UNDISCLOSED');
 				$u_group = '';
@@ -153,7 +149,7 @@
 
 				'U_GROUP'		=> $u_group,
 				'U_VIEWPROFILE'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']),
-				'U_PM'			=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']) : '')
+				'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']) : '')
 			);
 		}
 		$_CLASS['core_db']->free_result($result);
@@ -237,7 +233,7 @@
 				if ($submit && @extension_loaded('xml'))
 				{
 					// Add class loader
-					require_once($site_file_root.'includes/forums/functions_messenger.php');
+					require_once(SITE_FILE_ROOT.'includes/forums/functions_messenger.php');
 
 					$subject = sprintf($_CLASS['core_user']->lang['IM_JABBER_SUBJECT'], $_CLASS['core_user']->data['username'], $config['server_name']);
 					$message = $_POST['message'];
@@ -367,7 +363,7 @@
 		*/
 
 		// Change post_count_sql to an forum_id array the user is able to see
-		if ($permission_array = $_CLASS['auth']->acl_getf('f_read'))
+		if ($permission_array = $_CLASS['forums_auth']->acl_getf('f_read'))
 		{
 			$post_count_sql = 'AND f.forum_id IN (' . implode(', ', array_keys($permission_array)) . ')';
 	
@@ -427,7 +423,7 @@
 		if ($member['user_sig_bbcode_bitfield'] && $member['user_sig'])
 		{
 			// Add class loader
-			require_once($site_file_root.'includes/forums/bbcode.php');
+			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 			$bbcode = new bbcode();
 			$bbcode->bbcode_second_pass($member['user_sig'], $member['user_sig_bbcode_uid'], $member['user_sig_bbcode_bitfield']);
 		}
@@ -516,7 +512,7 @@
 			trigger_error('NO_EMAIL');
 		}
 
-		if (!$_CLASS['auth']->acl_get('u_sendemail'))
+		if (!$_CLASS['forums_auth']->acl_get('u_sendemail'))
 		{
 			trigger_error('NO_EMAIL');
 		}
@@ -556,7 +552,7 @@
 			}
 			
 			// Can we send email to this user?
-			if (!$row['user_allow_viewemail'] && !$_CLASS['auth']->acl_get('a_user'))
+			if (!$row['user_allow_viewemail'] && !$_CLASS['forums_auth']->acl_get('a_user'))
 			{
 				trigger_error('NO_EMAIL');
 			}
@@ -575,7 +571,7 @@
 				trigger_error('NO_TOPIC');
 			}
 
-			if (!$_CLASS['auth']->acl_get('f_read', $row['forum_id']))
+			if (!$_CLASS['forums_auth']->acl_get('f_read', $row['forum_id']))
 			{
 				trigger_error('NO_FORUM_READ');
 			}
@@ -730,7 +726,7 @@
 		$form	= $window = request_var('form', '');
 		$field	= request_var('field', 'username');
 
-		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['auth']->acl_get('a_')))
+		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['forums_auth']->acl_get('a_')))
 		{
 			$username	= request_var('username', '');
 			$email		= request_var('email', '');
@@ -784,7 +780,7 @@
 			$sql_where .= (sizeof($joined) > 1) ? " AND u.user_reg_date " . $find_key_match[$joined_select] . ' ' . gmmktime(0, 0, 0, intval($joined[1]), intval($joined[2]), intval($joined[0])) : '';
 			$sql_where .= (sizeof($active) > 1) ? " AND u.user_last_visit " . $find_key_match[$active_select] . ' ' . gmmktime(0, 0, 0, $active[1], intval($active[2]), intval($active[0])) : '';
 
-			if ($ipdomain && $_CLASS['auth']->acl_get('m_ip'))
+			if ($ipdomain && $_CLASS['forums_auth']->acl_get('m_ip'))
 			{
 				$ips = (preg_match('#[a-z]#', $ipdomain)) ? implode(', ', preg_replace('#([0-9]{1,3}\.[0-9]{1,3}[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})#', "'\\1'", gethostbynamel($ipdomain))) : "'" . str_replace('*', '%', $ipdomain) . "'";
 
@@ -863,7 +859,7 @@
 					$group_row['group_type'] = 'HIDDEN';
 					
 					// Check for membership or special permissions
-					if (!$_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel') && $group_row['user_id'] != $_CLASS['core_user']->data['user_id'])
+					if (!$_CLASS['forums_auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel') && $group_row['user_id'] != $_CLASS['core_user']->data['user_id'])
 					{
 						trigger_error('NO_GROUP');
 					}
@@ -914,7 +910,7 @@
 				'AVATAR_IMG'	=> $avatar_img,
 				'RANK_IMG'		=> $rank_img,
 
-				'U_PM'			=> ($_CLASS['auth']->acl_get('u_sendpm') && $group_row['group_receive_pm'] && $config['allow_mass_pm']) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id) : '',)
+				'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm') && $group_row['group_receive_pm'] && $config['allow_mass_pm']) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id) : '',)
 			);
 
 			$sql_fields = ', ug.member_status';
@@ -956,6 +952,8 @@
 		// Build a relevant pagination_url
 		$global_var = ($submit) ? '_POST' : '_GET';
 
+		global $$global_var;
+
 		foreach ($$global_var as $key => $var)
 		{
 			// what don't we need ?
@@ -965,14 +963,14 @@
 			}
 			
 			$pagination_url .= '&amp;' . $key . '=' . urlencode(htmlspecialchars($var));
-			$pagination_url2 .= ($key != 'start') ? '&amp;' . $key . '=' . urlencode(htmlspecialchars($var)) : '';
+			$pagination_url2 .= ($key !== 'start') ? '&amp;' . $key . '=' . urlencode(htmlspecialchars($var)) : '';
 		}
 
 		$u_hide_find_member = $pagination_url;
 		$pagination_url .= (($mode) ? '&amp;mode='.$mode : '') . (($first_char) ? '&amp;first_char='.$first_char : '');
 
 		// Some search user specific data
-		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['auth']->acl_get('a_')))
+		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['forums_auth']->acl_get('a_')))
 		{
 			$_CLASS['core_template']->assign_array(array(
 				'USERNAME'	=> $username,
@@ -1066,7 +1064,7 @@
 		'JABBER_IMG'	=> $_CLASS['core_user']->img('btn_jabber', $_CLASS['core_user']->lang['JABBER']),
 		'SEARCH_IMG'	=> $_CLASS['core_user']->img('btn_search', $_CLASS['core_user']->lang['SEARCH']),
 
-		'U_FIND_MEMBER'		=> (!empty($config['load_search']) || $_CLASS['auth']->acl_get('a_')) ? generate_link('Members_List&amp;mode=searchuser') : '',
+		'U_FIND_MEMBER'		=> (!empty($config['load_search']) || $_CLASS['forums_auth']->acl_get('a_')) ? generate_link('Members_List&amp;mode=searchuser') : '',
 		'U_HIDE_FIND_MEMBER'=> ($mode == 'searchuser') ? generate_link($u_hide_find_member) : '',
 		'U_SORT_USERNAME'	=> generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_FROM'		=> generate_link($pagination_url . '&amp;sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a')),
@@ -1082,7 +1080,7 @@
 		'U_SORT_RANK'		=> generate_link($pagination_url . '&amp;sk=l&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_LIST_CHAR'		=> generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a')),
 
-		'S_SEND_MESSAGE'	=> ($_CLASS['auth']->acl_get('u_sendpm')) ? true : false,
+		'S_SEND_MESSAGE'	=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? true : false,
 		'S_SHOW_GROUP'		=> ($mode == 'group') ? true : false,
 		'S_MODE_SELECT'		=> $s_sort_key,
 		'S_ORDER_SELECT'	=> $s_sort_dir,
@@ -1135,9 +1133,9 @@
 
 	get_user_rank($data['user_rank'], $data['user_posts'], $rank_title, $rank_img);
 	
-	if (!empty($data['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
+	if (!empty($data['user_allow_viewemail']) || $_CLASS['forums_auth']->acl_get('a_email'))
 	{
-		$email = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails'] && !$_CLASS['auth']->acl_get('a_email')) ? '' : 'mailto:' . $data['user_email']);
+		$email = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails'] && !$_CLASS['forums_auth']->acl_get('a_email')) ? '' : 'mailto:' . $data['user_email']);
 	}
 	else
 	{
@@ -1161,8 +1159,8 @@
 		'ICQ_STATUS_IMG'=> ($data['user_icq']) ? '<img src="http://web.icq.com/whitepages/online?icq=' . $data['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />' : '',
 
 		'U_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$user_id),
-		'U_SEARCH_USER'	=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($data['username']) . '&amp;show_results=posts') : '',
-		'U_PM'			=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$user_id) : '',
+		'U_SEARCH_USER'	=> ($_CLASS['forums_auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($data['username']) . '&amp;show_results=posts') : '',
+		'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$user_id) : '',
 		'U_EMAIL'		=> $email,
 		'U_WWW'			=> ($data['user_website']) ? $data['user_website'] : '',
 		'U_ICQ'			=> ($data['user_icq']) ? generate_link('Members_List&amp;mode=contact&amp;action=icq&amp;u='.$user_id) : '',

Modified: cms/trunk/modules/Quick_Message/ajax.php
===================================================================
--- cms/trunk/modules/Quick_Message/ajax.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Quick_Message/ajax.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -26,10 +26,12 @@
     die;
 }
 
-global $table_prefix;
+global $_CORE_CONFIG, $_CLASS;
 
 if (!defined('QUICK_MESSAGE_TABLE'))
-{
+{
+	global $table_prefix;
+		
 	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
@@ -52,7 +54,7 @@
 			die;
 		}
 
-		$message = trim(get_variable('message', 'POST', false));
+		$message = trim(get_variable('message', 'POST', ''));
 
 		if (!$message)
 		{
@@ -139,8 +141,6 @@
 	break;
 
 	case 'delete':
-		global $_CORE_CONFIG, $_CLASS;
-
 		$id = get_variable('id', 'GET', false, 'integer');
 
 		if (!$id)

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/Quick_Message/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -26,10 +26,12 @@
     die;
 }
 
-global $table_prefix;
+global $_CLASS, $_CORE_CONFIG;
 
 if (!defined('QUICK_MESSAGE_TABLE'))
-{
+{
+	global $table_prefix;
+
 	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-10-06 18:22:34 UTC (rev 162)
+++ cms/trunk/modules/articles/index.php	2005-10-17 19:31:14 UTC (rev 163)
@@ -28,9 +28,13 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
+	global $table_prefix;
+
 	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
+global $_CLASS;
+
 $_CLASS['core_user']->user_setup();
 
 if (isset($_GET['mode']))



From viperal at berlios.de  Wed Oct 26 20:58:55 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 26 Oct 2005 20:58:55 +0200
Subject: [Viperals-svncheckins] r164 - in cms/trunk: . admin blocks includes includes/display includes/forums install javascript
Message-ID: <200510261858.j9QIwt5r021750@sheep.berlios.de>

Author: viperal
Date: 2005-10-26 20:58:46 +0200 (Wed, 26 Oct 2005)
New Revision: 164

Modified:
   cms/trunk/admin.php
   cms/trunk/admin/index.php
   cms/trunk/admin/modules.php
   cms/trunk/admin/system.php
   cms/trunk/ajax.php
   cms/trunk/blocks/block-Modules.php
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/blocks/block-User.php
   cms/trunk/core.php
   cms/trunk/feed.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/bbcode.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/handler.php
   cms/trunk/includes/session.php
   cms/trunk/includes/system.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/user.php
   cms/trunk/index.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/quick_messages.js
Log:
Yes, It's still broken.  Hopefully it will be moderately functional by tomorrow.......

Modified: cms/trunk/admin/index.php
===================================================================
--- cms/trunk/admin/index.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/admin/index.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -86,7 +86,7 @@
 	{
 		$limit = ($last_count) ? 10 : 20 - $last_count;
 
-		$sql = 'SELECT COUNT(*)	FROM ' . USERS_TABLE . '
+		$sql = 'SELECT COUNT(*)	FROM ' . CORE_USERS_TABLE . '
 					WHERE user_type = '.USER_NORMAL.'
 					AND user_status = '.$status;
 		$result = $_CLASS['core_db']->query($sql);
@@ -111,7 +111,7 @@
 		));
 		
 		$sql = 'SELECT user_id, username, user_reg_date
-			FROM ' . USERS_TABLE . '
+			FROM ' . CORE_USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;
 		

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/admin/modules.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -46,13 +46,37 @@
 
 	return true;
 }
-
+		
 if (isset($_REQUEST['mode']))
 {
 	if ($id = get_variable('id', 'GET', false, 'integer'))
 	{
 		switch ($_REQUEST['mode'])
 		{
+			case 'search':
+				$result = $_CLASS['core_db']->query('SELECT module_name, module_type FROM '. CORE_MODULES_TABLE);
+
+				$modules = array();
+
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$modules[$row['module_name']] = $row;
+				}
+				$_CLASS['core_db']->free_result($result);
+
+				$handle = opendir(SITE_FILE_ROOT.'modules');
+
+				while ($file = readdir($handle))
+				{
+					if (mb_strpos($file, '.') === false && empty($modules[$file]) && file_exists(SITE_FILE_ROOT."modules/$file/index.php"))
+					{
+						//$_CLASS['core_db']->query('INSERT INTO '. CORE_MODULES_TABLE . " (module_name, module_type, module_status, module_sides) VALUES ($file, 1, 1, 1)");
+						echo $file;
+					}
+				}
+				closedir($handle);
+			break;
+
 			case 'change':
 				$result = $_CLASS['core_db']->query('SELECT module_name, module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -67,9 +91,9 @@
 			
 				$status = ($module['module_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 				
-				if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
+				if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
 				{
-					require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
+					require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
 					
 					$name = $module['module_name'].'_configurator';
 
@@ -108,9 +132,9 @@
 				{
 					$status = true;
 
-					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
+					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
 					{
-						require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
+						require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
 						
 						$name = $module['module_name'].'_configurator';
 
@@ -148,9 +172,9 @@
 				
 				if (display_confirmation())
 				{
-					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
+					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
 					{
-						require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
+						require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
 						
 						$name = $module['module_name'].'_configurator';
 

Modified: cms/trunk/admin/system.php
===================================================================
--- cms/trunk/admin/system.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/admin/system.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -26,7 +26,7 @@
 	die;
 }
 
-global $_CLASS;
+global $_CLASS, $_CORE_MODULE;
 
 $_CLASS['core_user']->add_lang('admin/system.php');
 

Modified: cms/trunk/admin.php
===================================================================
--- cms/trunk/admin.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/admin.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -15,22 +15,19 @@
 define('VIPERAL', 'Admin');
 //define('NEED_SID', true);
 
-require('core.php');
+require_once 'core.php';
 
 $_CLASS['core_user']->user_setup(null);
 $_CLASS['core_display']->load_theme('viperal_admin', SITE_FILE_ROOT.'themes_admin/viperal_admin');
 
-//$_CLASS['core_user']->add_lang('admin/common.php');
-
-$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'];
-$_CORE_MODULE['module_sides'] = BLOCK_ALL;
+$_CLASS['core_user']->add_lang('admin/common.php');
 $_CLASS['core_blocks']->blocks_loaded = true;
 
 if (!$_CLASS['core_user']->is_user)
 {
 	if ($_CLASS['core_user']->is_bot)
 	{
-		url_redirect();
+		redirect();
 	}
 
 	login_box(array('admin_login' => true, 'full_screen' => true,  'full_login' => false, 'explain' => 'LOGIN_ADMIN', 'success' => 'LOGIN_ADMIN_SUCCESS'), 'login_admin.html');
@@ -51,46 +48,17 @@
 
 if ($mod)
 {
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name='".$_CLASS['core_db']->escape($mod)."'");
-	$_CORE_MODULE = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
-}
+	$result = $_CLASS['core_db']->query('SELECT * FROM '. CORE_ADMIN_MODULES_TABLE . " WHERE module_name='".$_CLASS['core_db']->escape($mod)."'");
 
-if (!$mod || !$_CORE_MODULE)
-{
-	$_CORE_MODULE = array('module_title' => '', 'module_name' => '');
-	$file_path = SITE_FILE_ROOT.'admin/index.php';
-}
-else
-{
-	if (file_exists(SITE_FILE_ROOT.'admin/'.$_CORE_MODULE['module_name'].'.php'))
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$file_path = SITE_FILE_ROOT.'admin/'.$_CORE_MODULE['module_name'].'.php';
+		$_CLASS['core_display']->process_page($row, 'admin');
 	}
-	else
-	{
-		$file_path = (file_exists(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php')) ? SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php' : false;
-	}
+	$_CLASS['core_db']->free_result($result);
 }
 
-if (!$file_path)
-{
-	trigger_error('NO_ADMIN_MODULE', E_USER_ERROR);
-}
+require_once SITE_FILE_ROOT.'admin/menu.php';
 
-if ($_CORE_MODULE['module_name'])
-{
-	if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['module_name']))
-	{
-		trigger_error('NOT_AUTH', E_USER_ERROR);
-	}
-}
-
-$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['module_title'];
-$_CORE_MODULE['module_sides'] = BLOCK_ALL;
-	
-require(SITE_FILE_ROOT.'admin/menu.php');
-
 $main_menu = build_menu($menu);
 
 $_CLASS['core_template']->assign_array(array(
@@ -101,9 +69,16 @@
 		'MENU_MAIN_ITEMS'	=> $main_menu['menu'],
 ));
 
-
-//load_class(SITE_FILE_ROOT.'includes/core_editor.php', 'core_editor');
-//$_CLASS['core_editor']->setup();
-require($file_path);
+if (!$mod || !$_CLASS['core_display']->generate_page('admin'))
+{
+	$blocks = 0;
+	$blocks |= BLOCK_LEFT;
+	$blocks |= BLOCK_RIGHT;
+				
+	$_CLASS['core_display']->page = array('page_title' => '', 'page_name' => '', 'page_blocks' => $blocks);
+	$file_path = SITE_FILE_ROOT.'admin/index.php';
+	
+	require_once $file_path;
+}
     
 ?>
\ No newline at end of file

Modified: cms/trunk/ajax.php
===================================================================
--- cms/trunk/ajax.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/ajax.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -20,12 +20,12 @@
 }
 
 //require(SITE_FILE_ROOT.'core.php');
-require('core.php');
+require_once 'core.php';
 
 if ($mod = get_variable('mod', 'REQUEST', false))
 {
 	$sql = 'SELECT * FROM ' . CORE_PAGES_TABLE . "
-				WHERE page_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+				WHERE page_name = '" . $_CLASS['core_db']->escape($mod) . "'";//WHERE module_type = ' . MODULE_NORMAL . "
 
 	//Grab module data if it exsits
 	$result = $_CLASS['core_db']->query($sql);

Modified: cms/trunk/blocks/block-Modules.php
===================================================================
--- cms/trunk/blocks/block-Modules.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/blocks/block-Modules.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -21,31 +21,30 @@
 $Id$
 */
 
-// This is temp
 if (!defined('VIPERAL'))
 {
     die;
 }
 
-global $_CLASS, $_CORE_MODULE;
+global $_CLASS;
 
 $this->content .= '<div id="nav"><ul style="margin: 0px; padding: 0px; list-style-type: none; line-height: 150%;">';
 $this->content .= '<li><a href="'.generate_link().'">Home</a></li>';
 
-$result = $_CLASS['core_db']->query('SELECT module_name, module_title, module_auth FROM '.CORE_MODULES_TABLE.' WHERE module_type = '.MODULE_NORMAL.' AND module_status = ' . STATUS_ACTIVE . ' ORDER BY module_name ASC');
+$result = $_CLASS['core_db']->query('SELECT page_name, page_title, page_auth FROM '.CORE_PAGES_TABLE.' WHERE page_type = '.MODULE_NORMAL.' AND page_status = ' . STATUS_ACTIVE . ' ORDER BY page_name ASC');
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 // Add Auth here
-	$row['module_title'] = ($row['module_title']) ? $_CLASS['core_user']->get_lang($row['module_title']) : $_CLASS['core_user']->get_lang($row['module_name']);
+	$row['page_title'] = ($row['page_title']) ? $_CLASS['core_user']->get_lang($row['page_title']) : $_CLASS['core_user']->get_lang($row['page_name']);
 	
-	if ($row['module_name'] == $_CORE_MODULE['module_name'] && !$_CLASS['core_display']->homepage)
+	if ($row['page_name'] == $_CLASS['core_display']->page['page_name'] && !$_CLASS['core_display']->homepage)
 	{
-		$this->content .= '<li><b class="active">'.$row['module_title'].'</b></li>';
+		$this->content .= '<li><b class="active">'.$row['page_title'].'</b></li>';
 	}
 	else
 	{
-		$this->content .= '<li><a href="'.generate_link($row['module_name']).'"> '.$row['module_title'].'</a></li>';
+		$this->content .= '<li><a href="'.generate_link($row['page_name']).'"> '.$row['page_title'].'</a></li>';
 	}
 }
 

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -55,7 +55,7 @@
 	$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" id="poster_name" name="poster_name" size="10" maxlength="10" /><br />';
 }
 
-$this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="4"></textarea><br /><br />
+$this->content .= 'Message <br/> <textarea id="quick_message" name="message" style="width:90%;" rows="4"></textarea><br /><br />
 			<input class="button" type="submit" name="submit" value="Post" />
 			<input class="button" type="button" name="submit" onclick="quick_message_refresh()" value="Refresh" />
 		</form></div>';

Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/blocks/block-User.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -46,7 +46,7 @@
 				$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
 			break;
 		}
-		
+
 		$avatar_img .= $_CLASS['core_user']->data['user_avatar'];
 
 		$this->content .= '<img src="' . $avatar_img . '" width="' . $_CLASS['core_user']->data['user_avatar_width'] . '" height="' . $_CLASS['core_user']->data['user_avatar_height'] . '" border="0" alt="avatar" />';
@@ -94,7 +94,7 @@
 */
 
 $sql = 'SELECT session_hidden, session_ip, session_page, session_url, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
-			FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
+			FROM ' . CORE_SESSIONS_TABLE . ' s, '. CORE_USERS_TABLE.' u
 				WHERE s.session_time > ' . ($_CLASS['core_user']->time - (int) $_CORE_CONFIG['server']['session_length']) .'
 				AND u.user_id = s.session_user_id';
 $result = $_CLASS['core_db']->query($sql);

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/core.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -31,19 +31,22 @@
 	@ob_start('ob_gzhandler');
 }
 
-//ini_set('display_errors', 1);
+/* 
+ini_set('display_errors', 1);
+error_reporting(E_STRICT);
+*/
+
 set_magic_quotes_runtime(0);
-//error_reporting(E_STRICT);
 error_reporting(E_ALL);
 
-//Error reporting tyoe
+/* Error reporting tyoes */
 define('ERROR_NONE', 0);
 define('ERROR_ONPAGE', 1);
 define('ERROR_DEBUGGER', 2);
 define('SERVER_LOCAL', (strpos($_SERVER['HTTP_HOST'], 'localhost') === 0 || strpos($_SERVER['HTTP_HOST'], '127.0.0.1') === 0));
 define('STRIP_SLASHES', get_magic_quotes_gpc());
 
-// Remove registered globals
+/* Remove registered globals */
 if (ini_get('register_globals'))
 {
 	foreach ($_REQUEST as $var_name => $value)
@@ -63,13 +66,13 @@
 }
 
 mb_internal_encoding('UTF-8');
-//mb_http_output('UTF-8');
+/* mb_http_output('UTF-8'); */
 
 $starttime = explode(' ', microtime());
 $starttime = $starttime[1] + $starttime[0];
 $base_memory_usage = get_memory_usage();
 
-//REQUEST_URI not set in IIS
+/* REQUEST_URI not set in IIS */
 if (empty($_SERVER['REQUEST_URI']))
 {
 	$_SERVER['REQUEST_URI'] = $_SERVER['SCRIPT_NAME'];
@@ -87,15 +90,19 @@
 
 @register_shutdown_function('script_close');
 
-// Load basic classes
+/* 
+	Load First Set of Classes
+*/
 load_class(false, 'core_template');
 load_class(false, 'core_handler');
 
-// Set error handler
+/* We're going ot use our own error handler */
 $_CLASS['core_handler']->start();
-$_CLASS['core_handler']->stop();
-//error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
+/*
+	$_CLASS['core_handler']->stop();
+*/
+
 if (empty($site_db))
 {
 	if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
@@ -107,6 +114,9 @@
 	trigger_error('503:<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
 }
 
+/* 
+	Load Second Set of Classes
+*/
 require_once SITE_FILE_ROOT.'includes/tables.php';
 require_once SITE_FILE_ROOT.'includes/db/'.$site_db['type'].'.php';
 require_once SITE_FILE_ROOT.'includes/cache/cache.php';
@@ -120,7 +130,7 @@
 
 $_CLASS['core_db']->report_error(false);
 
-// Error messages just incase we can't get our configs
+/* Error messages just incase we can't get our configs */
 $config_error = '503:<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
 
 if (is_null($_CORE_CONFIG = $_CLASS['core_cache']->get('core_config')))
@@ -192,36 +202,42 @@
 	if (check_maintance_status(true) === true || check_load_status(true) === true)
 	{
 		header('HTTP/1.0 503 Service Unavailable');
-		die;
+
+		script_close(false);
 	}
 }
 
-if (VIPERAL === 'FEED')
-{
-	return;
-}
+/* 
+	Load third Set of Classes :
+		User based classes
+		Display handler
+*/
 
-// Load user based classes, and display options
 require SITE_FILE_ROOT.'includes/session.php';
 require SITE_FILE_ROOT.'includes/user.php';
 require SITE_FILE_ROOT.'includes/auth/auth.php';
 require SITE_FILE_ROOT.'includes/auth/auth_db.php';
-require SITE_FILE_ROOT.'includes/display/blocks.php';
 require SITE_FILE_ROOT.'includes/display/display.php';
 
 load_class(false, 'core_display');
-load_class(false, 'core_blocks');
 load_class(false, 'core_user');
 
 $_CLASS['core_user']->start();
 
 if (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['global']['only_registered'])
 {
-	// conformation image 
+	if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
+	{
+		header('HTTP/1.0 503 Service Unavailable');
+
+		script_close(false);
+	}
+
+	/* conformation image  ? */
 	login_box(array('full_screen'	=> true));
 }
 
-if ($_CLASS['core_user']->is_admin)
+if (VIPERAL !== 'FEED' && VIPERAL !== 'AJAX' && $_CLASS['core_user']->is_admin)
 {
 	$_CLASS['core_handler']->report = $_CORE_CONFIG['server']['error_options'];	
 }
@@ -232,14 +248,25 @@
 }
 
 
+if (VIPERAL === 'FEED')
+{
+	return;
+}
+
+require SITE_FILE_ROOT.'includes/display/blocks.php';
+load_class(false, 'core_blocks');
+
+/*
 $_CORE_CONFIG['server']['error_options'] = ERROR_DEBUGGER;	
-//$_CORE_CONFIG['server']['error_options'] = ERROR_ONPAGE;	
+$_CORE_CONFIG['server']['error_options'] = ERROR_ONPAGE;	
+ 
 $_CLASS['core_handler']->report = $_CORE_CONFIG['server']['error_options'];
+*/
 
 
 if ($_SERVER['REQUEST_METHOD'] == 'POST' && $_CLASS['core_user']->new_session)
 {
-	die;// error here
+	die;	/* error here */
 }
 
 function get_memory_usage()
@@ -252,7 +279,9 @@
 /*
 	This pisses me off, seeing that screen pop up all the time :-(
 	Enable it if you want, Will be disabled by default
+*/
 
+/*
 	if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN')
 	{
 		exec('tasklist /fi "PID eq ' . getmypid() . '" /fo LIST', $output); 

Modified: cms/trunk/feed.php
===================================================================
--- cms/trunk/feed.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/feed.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -25,54 +25,50 @@
 
 error_reporting(0);
 
-//require(SITE_FILE_ROOT.'core.php');
-require('core.php');
+/* require(SITE_FILE_ROOT.'core.php'); */
+require_once 'core.php';
 
-header('Content-Type: text/xml');
-
-if (!defined('ARTICLES_TABLE'))
-{
-	define('ARTICLES_TABLE', $table_prefix.'articles');
-}
-
-$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
-
-$last_post_time = 0;
-
-// Need to fix this, add auth and expires/start check ( will have to remove limit )
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+if ($mod = get_variable('mod', 'REQUEST', false))
 {
-	$time = ($row['articles_starts']) ? $row['articles_starts'] : $row['articles_posted'];
-	$text = ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'];
+	/* Grab module data if it exsits */
+	$sql = 'SELECT * FROM ' . CORE_PAGES_TABLE . "
+				WHERE page_name = '" . $_CLASS['core_db']->escape($mod) . "'";//WHERE module_type = ' . MODULE_NORMAL . "
+	
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
-	if ($time > $last_post_time)
+	$status = $_CLASS['core_display']->process_page($row, 'feed');
+
+	if ($status !== true)
 	{
-		$last_post_time = $time;
+		header("HTTP/1.0 503 Service Unavailable");
+		script_close(false);
 	}
 
-	$_CLASS['core_template']->assign_vars_array('items', array(
-		'TITLE' 			=> htmlspecialchars($row['articles_title'], ENT_QUOTES, 'UTF-8'),
-		'LINK' 				=> generate_link('articles&amp;mode=view&amp;id='.$row['articles_id'], array('full' => true, 'sid' => false)),
-		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($text), ENT_QUOTES, 'UTF-8'),
-		'DESCRIPTION_HTML' 	=> htmlspecialchars($text, ENT_QUOTES, 'UTF-8'),
-		'TIME'				=> date('M d Y H:i:s', $time) .' GMT',
-		'AUTHOR'			=> htmlspecialchars($row['poster_name'], ENT_QUOTES, 'UTF-8')
-	));
+	$_CLASS['core_display']->generate_page('feed');
 }
-$_CLASS['core_db']->free_result($result);
 
-$last_modified = date('M d Y H:i:s', $last_post_time) .' GMT';
+$_CLASS['core_user']->user_setup(null);
 
+if (!defined('DISPLAY_FEED') || DISPLAY_FEED === 'custom')
+{
+	script_close(false);
+}
+
+global $_CORE_CONFIG;
+
+header('Content-Type: text/xml');
+
 $_CLASS['core_template']->assign_array(array(
 	'SITE_NAME' 	=> $_CORE_CONFIG['global']['site_name'],
 	'SITE_URL' 		=> generate_link(false, array('full' => true, 'sid' => false)),
 	'LANG'			=> 'en-us',
-	'LAST_MODIFIED'	=> $last_modified ,
+	//'LAST_MODIFIED'	=> $last_modified ,
 	'TIME'			=> gmdate('M d Y H:i:s') .' GMT'
 ));
 
-header('Last-Modified: '.$last_post_time);
-
+/* Display the feed according to the selected feed type */	
 Switch ($_GET['feed'])
 {
 	case 'rdf':
@@ -97,6 +93,6 @@
 	break;
 }
 
-script_close();
+script_close(false);
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/display/blocks.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -52,7 +52,7 @@
 
 		global $_CLASS;
 
-		if ($_CLASS['core_user']->lang['DIRECTION'] === 'rtl')
+		if ($_CLASS['core_user']->lang['DIRECTION'] === 'rtl' && ($side === BLOCK_LEFT || $side === BLOCK_RIGHT))
 		{
 			$side = ($side === BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
@@ -85,7 +85,7 @@
 
 		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
 		{
-			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
+			$result = $_CLASS['core_db']->query('SELECT * FROM '. CORE_BLOCKS_TABLE . ' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
 
 			$this->blocks_array = array();
 
@@ -96,7 +96,7 @@
 			}
 
 			$_CLASS['core_db']->free_result($result);
-			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
+			$_CLASS['core_cache']->put('blocks', $this->blocks_array, 'formated');
 
 			$_CLASS['core_cache']->save();
 		}
@@ -121,20 +121,17 @@
 
 	/*
 	*/
-	function display($position)
+	function generate($position)
 	{
 		settype($position, 'int');
 
 		$this->display_position = $position;
 
-		if ($position === BLOCK_LEFT || $position === BLOCK_RIGHT)
-		{
-			$position = $this->check_side($position);
+		$position = $this->check_side($position);
 
-			if ($position === false)
-			{
-				return false;
-			}
+		if ($position === false)
+		{
+			return false;
 		}
 
 		$position = ($position >> 1);
@@ -397,7 +394,7 @@
 		{
 			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? (int) $_CLASS['core_user']->time + $this->block['block_rss_rate'] : 0;
 			
-			$sql = 'UPDATE '.BLOCKS_TABLE."
+			$sql = 'UPDATE '. CORE_BLOCKS_TABLE."
 				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
 					WHERE block_id = ".$this->block['block_id'];
 				

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/display/display.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -47,30 +47,31 @@
 			return '404:_PAGE_NOT_FOUND';
 		}
 
-		global $_CLASS;
+		global $_CLASS, $_CORE_MODULE;
 
 		settype($page['page_status'], 'int');
 		settype($page['page_type'], 'int');
 		settype($page['page_status'], 'int');
-		settype($page['page_blocks'], 'int');
 
-		if ($page['page_status'] !== STATUS_ACTIVE)
-		{
-			if ($page['page_status'] === STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('pages'))
-			{
-				$_CLASS['core_display']->message = '<b>Module '.$page['page_name'].' Isn\'t Active</b><br />';
-			}
-			else
-			{
-				return '_PAGE_NOT_ACTIVE';
-			}
-		}
-
 		switch ($type)
 		{
 			case 'admin':
-				if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['module_name']))
+				settype($page['module_status'], 'int');
+
+				if ($page['module_status'] !== STATUS_ACTIVE)
 				{
+					return '_PAGE_NOT_ACTIVE';
+				}
+
+				foreach ($page as $key => $value)
+				{
+					$temp[str_replace('module_', 'page_', $key)] = $value;
+				}
+				$page = $temp;
+				unset($temp);
+
+				if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['page_name']))
+				{
 					trigger_error('NOT_AUTH', E_USER_ERROR);
 				}
 				
@@ -86,12 +87,32 @@
 				{
 					return '404:_PAGE_NOT_FOUND';
 				}
+
+				$page['page_blocks'] = 0;
+				$page['page_blocks'] |= BLOCK_LEFT;
+				$page['page_blocks'] |= BLOCK_RIGHT;
 			break;
 			
 			case 'ajax':
 				$page['page_location'] = SITE_FILE_ROOT.'modules/'.$page['page_name'].'/ajax.php';
 
+			//case 'feed':
 			default:
+				settype($page['page_blocks'], 'int');
+				settype($page['page_blocks'], 'int');
+
+				if ($page['page_status'] !== STATUS_ACTIVE)
+				{
+					if ($page['page_status'] === STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('pages'))
+					{
+						$_CLASS['core_display']->message = '<b>Module '.$page['page_name'].' Isn\'t Active</b><br />';
+					}
+					else
+					{
+						return '_PAGE_NOT_ACTIVE';
+					}
+				}
+
 				//authization check here
 				$page['page_auth'] = ($page['page_auth']) ? @unserialize($page['page_auth']) : '';
 		
@@ -139,13 +160,24 @@
 
 			if ($this->page['page_location'])
 			{
+				$this->supported = array();
+
 				require_once $this->page['page_location'];
-				
-				$class_name = $type.'_'.$this->page['page_name'];
 
-				if (class_exists($class_name))
+				if (in_array($type, $this->supported))
 				{
-					$module = new $class_name;
+					$class_name = 'module_'.$this->page['page_name'];
+	
+					if (class_exists($class_name))
+					{
+						$module = new $class_name;
+						$method = $type.'_'.$this->page['page_name'];
+	
+						if (method_exists($module, $method))
+						{
+							$module->$method();
+						}					
+					}
 				}
 			}
 
@@ -163,7 +195,7 @@
 	{
 		global $_CLASS;
 
-		header('Content-Type: text/html; charset=UTF-8');
+		header('Content-Type: text/html; charset=utf-8');
 		header('Content-language: ' . $_CLASS['core_user']->lang['LANG']);
 
 		header('P3P: CP="CAO DSP COR CURa ADMa DEVa OUR IND PHY ONL UNI COM NAV INT DEM PRE"');
@@ -256,13 +288,9 @@
 			'FOOTER_CONTENT'	=> $this->footer,
 		));
 
-		$_CLASS['core_blocks']->display(BLOCK_MESSAGE_TOP);
+		$_CLASS['core_blocks']->generate(BLOCK_MESSAGE_TOP);
+		$_CLASS['core_blocks']->generate(BLOCK_TOP);
 
-		if ($this->homepage)
-		{  
-			$_CLASS['core_blocks']->display(BLOCK_TOP);
-		}
-
 		$this->theme->theme_header();
 	}
 
@@ -285,23 +313,14 @@
 
 		if ($this->generate_page())
 		{
-// TEMP
-//$_CORE_MODULE =& $_CLASS['core_display']->page;
-
-		//	require(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
 			return;
-
 		}
 
 		$this->displayed['footer'] = true;
 
-		if ($this->homepage)
-		{
-			$_CLASS['core_blocks']->display(BLOCK_BOTTOM);
-		}
+		$_CLASS['core_blocks']->generate(BLOCK_BOTTOM);
+		$_CLASS['core_blocks']->generate(BLOCK_MESSAGE_BOTTOM);
 
-		$_CLASS['core_blocks']->display(BLOCK_MESSAGE_BOTTOM);
-
 		if ($this->displayed['header'])
 		{
 			$this->theme->theme_footer();
@@ -309,7 +328,7 @@
 		
 		script_close($save);
 	}
-	
+
 	/*
 		General display of basic debug info
 	*/

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/auth.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -242,7 +242,7 @@
 
 			$userdata['user_permissions'] = rtrim($hold_str);
 
-			$sql = 'UPDATE ' . USERS_TABLE . "
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . "
 				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "'
 				WHERE user_id = " . $userdata['user_id'];
 			$_CLASS['core_db']->query($sql);
@@ -261,7 +261,7 @@
 
 		if ($sql_user)
 		{
-			$sql = 'SELECT group_id, user_id FROM ' . USER_GROUP_TABLE ." WHERE $sql_user AND member_status <> ".STATUS_PENDING;
+			$sql = 'SELECT group_id, user_id FROM ' . CORE_USER_GROUP_TABLE ." WHERE $sql_user AND member_status <> ".STATUS_PENDING;
 
 			$result = $_CLASS['core_db']->query($sql);
 	
@@ -307,7 +307,7 @@
 		{
 			if (empty($group_members))
 			{
-				$sql = 'SELECT user_group, user_id FROM ' . USERS_TABLE .' WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).') AND user_status = '.STATUS_ACTIVE;
+				$sql = 'SELECT user_group, user_id FROM ' . CORE_USERS_TABLE .' WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).') AND user_status = '.STATUS_ACTIVE;
 				$result = $_CLASS['core_db']->query($sql);
 	
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -344,7 +344,7 @@
 
 		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : " = $user_id") : '';
 
-		$sql = 'UPDATE ' . USERS_TABLE . "
+		$sql = 'UPDATE ' . CORE_USERS_TABLE . "
 			SET user_permissions = ''
 			$where_sql";
 		$_CLASS['core_db']->query($sql);

Modified: cms/trunk/includes/forums/bbcode.php
===================================================================
--- cms/trunk/includes/forums/bbcode.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/bbcode.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -140,6 +140,7 @@
 			}
 		}
 
+//cache this
 		if ($sql)
 		{
 			$rowset = array();

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/functions.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -27,6 +27,8 @@
 $config_error = '<center>There is currently a problem with the site<br/>';
 $config_error .= 'Please try again later<br /><br />Error Code: DB3</center>';
 
+global $config;
+
 if (is_null($config = $_CLASS['core_cache']->get('config')))
 {
 	$config = $cached_config = array();
@@ -194,9 +196,8 @@
 
 	if ($forum_data['forum_rules'])
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$bbcode = new bbcode($forum_data['forum_rules_bbcode_bitfield']);
-		
 		$bbcode->bbcode_second_pass($forum_data['forum_rules'], $forum_data['forum_rules_bbcode_uid']);
 
 		$forum_data['forum_rules'] = smiley_text($forum_data['forum_rules'], !($forum_data['forum_rules_flags'] & 2));
@@ -335,11 +336,11 @@
 	global $_CLASS;
 
 	$rules = array(
-		($_CLASS['auth']->acl_get('f_post', $forum_id)) ? $_CLASS['core_user']->lang['RULES_POST_CAN'] : $_CLASS['core_user']->lang['RULES_POST_CANNOT'],
-		($_CLASS['auth']->acl_get('f_reply', $forum_id)) ? $_CLASS['core_user']->lang['RULES_REPLY_CAN'] : $_CLASS['core_user']->lang['RULES_REPLY_CANNOT'],
-		($_CLASS['auth']->acl_gets(array('f_edit', 'm_edit'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
-		($_CLASS['auth']->acl_gets(array('f_delete', 'm_delete'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
-		($_CLASS['auth']->acl_get('f_attach', $forum_id) && $_CLASS['auth']->acl_get('u_attach', $forum_id)) ? $_CLASS['core_user']->lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']->lang['RULES_ATTACH_CANNOT']
+		($_CLASS['forums_auth']->acl_get('f_post', $forum_id)) ? $_CLASS['core_user']->lang['RULES_POST_CAN'] : $_CLASS['core_user']->lang['RULES_POST_CANNOT'],
+		($_CLASS['forums_auth']->acl_get('f_reply', $forum_id)) ? $_CLASS['core_user']->lang['RULES_REPLY_CAN'] : $_CLASS['core_user']->lang['RULES_REPLY_CANNOT'],
+		($_CLASS['forums_auth']->acl_gets(array('f_edit', 'm_edit'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
+		($_CLASS['forums_auth']->acl_gets(array('f_delete', 'm_delete'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
+		($_CLASS['forums_auth']->acl_get('f_attach', $forum_id) && $_CLASS['forums_auth']->acl_get('u_attach', $forum_id)) ? $_CLASS['core_user']->lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']->lang['RULES_ATTACH_CANNOT']
 	);
 
 	foreach ($rules as $rule)
@@ -433,13 +434,13 @@
 			continue;
 		}
 
-		if (!$_CLASS['auth']->acl_get('f_list', $row['forum_id']))
+		if (!$_CLASS['forums_auth']->acl_get('f_list', $row['forum_id']))
 		{
 			// if the user does not have permissions to list this forum skip
 			continue;
 		}
 		
-		if ($acl_list && !$_CLASS['auth']->acl_gets($acl_list, $row['forum_id']))
+		if ($acl_list && !$_CLASS['forums_auth']->acl_gets($acl_list, $row['forum_id']))
 		{
 			continue;
 		}
@@ -763,40 +764,6 @@
 	}
 }
 
-// Obtain list of naughty words and build preg style replacement arrays for use by the
-// calling script, note that the vars are passed as references this just makes it easier
-// to return both sets of arrays
-function obtain_word_list()
-{
-	global $_CLASS, $config;
-
-	if (!$_CLASS['core_user']->optionget('viewcensors') && $config['allow_nocensors'])
-	{
-		return;
-	}
-
-	if (is_null($censors = $_CLASS['core_cache']->get('word_censors')))
-	{
-		$sql = 'SELECT word, replacement
-			FROM  ' . FORUMS_WORDS_TABLE;
-		$result = $_CLASS['core_db']->query($sql);
-
-		$censors = array();
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$censors['match'][] = '#\b(' . str_replace('\*', '\w*?', preg_quote($row['word'], '#')) . ')\b#i';
-			$censors['replace'][] = $row['replacement'];
-		}
-
-		$_CLASS['core_db']->free_result($result);
-
-		$_CLASS['core_cache']->put('word_censors', $censors);
-	}
-
-	return $censors;
-}
-
 // Obtain icons
 function obtain_icons()
 {
@@ -1020,7 +987,7 @@
 	global $config, $_CLASS;
 
 	// Check permission and make sure the last post was not already bumped
-	if (!$_CLASS['auth']->acl_get('f_bump', $forum_id) || $topic_bumped)
+	if (!$_CLASS['forums_auth']->acl_get('f_bump', $forum_id) || $topic_bumped)
 	{
 		return false;
 	}
@@ -1035,7 +1002,7 @@
 	}
 
 	// Check bumper, only topic poster and last poster are allowed to bump
-	if ($topic_poster != $_CLASS['core_user']->data['user_id'] && $last_topic_poster != $_CLASS['core_user']->data['user_id'] && !$_CLASS['auth']->acl_get('m_', $forum_id))
+	if ($topic_poster != $_CLASS['core_user']->data['user_id'] && $last_topic_poster != $_CLASS['core_user']->data['user_id'] && !$_CLASS['forums_auth']->acl_get('m_', $forum_id))
 	{
 		return false;
 	}
@@ -1044,32 +1011,12 @@
 	return $bump_time;
 }
 
-// Censoring
-function censor_text($text)
-{
-	global $_CLASS;
-
-	if ($_CLASS['core_user']->is_user && !$_CLASS['core_user']->optionget('viewcensors'))
-	{
-		return $text;
-	}
-
-	$censors = obtain_word_list();
-
-	if (!empty($censors))
-	{
-		return preg_replace($censors['match'], $censors['replace'], $text);
-	}
-
-	return $text;
-}
-
 // Smiley processing
 function smiley_text($text, $force_option = false)
 {
 	global $config, $_CLASS;
 
-	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->optionget('viewsmilies')) ? preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text) : str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
+	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->user_data_get('viewsmilies')) ? preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text) : str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
 }
 
 // Inline Attachment processing
@@ -1178,7 +1125,8 @@
 
 	// Get users online list ... if required
 	$l_online_users = $online_userlist = $l_online_record = $l_online_time = '';
-	
+
+// this isn't required in most places
 	if ($config['load_online'] && $config['load_online_time'])
 	{
 		$logged_visible_online = $logged_hidden_online = $guests_online = 0;
@@ -1193,7 +1141,7 @@
 		}
 
 		$sql = 'SELECT session_hidden, session_ip, session_page, session_url, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
-					FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
+					FROM ' . CORE_SESSIONS_TABLE . ' s, '.CORE_USERS_TABLE.' u
 						WHERE s.session_time > ' . ($_CLASS['core_user']->time - (int) $_CORE_CONFIG['server']['session_length']) .'
 						AND u.user_id = s.session_user_id'.$reading_sql;
 		$result = $_CLASS['core_db']->query($sql);
@@ -1362,7 +1310,7 @@
 
 		'S_USER_LOGGED_IN' 		=> ($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? true : false,
 		'S_REGISTERED_USER'		=> $_CLASS['core_user']->is_user,
-		'S_USER_PM_POPUP' 		=> $_CLASS['core_user']->optionget('popuppm'),
+		'S_USER_PM_POPUP' 		=> $_CLASS['core_user']->user_data_get('popuppm'),
 		'S_USER_LANG'			=> $_CLASS['core_user']->data['user_lang'], 
 		'S_USER_BROWSER' 		=> ($_CLASS['core_user']->data['session_browser']) ? $_CLASS['core_user']->data['session_browser'] : $_CLASS['core_user']->lang['UNKNOWN_BROWSER'],
 		'S_CONTENT_DIRECTION' 	=> $_CLASS['core_user']->lang['DIRECTION'],
@@ -1373,7 +1321,7 @@
 		'S_DISPLAY_ONLINE_LIST'	=> ($config['load_online']) ? 1 : 0, 
 		'S_DISPLAY_SEARCH'		=> ($config['load_search']) ? 1 : 0, 
 		'S_DISPLAY_PM'			=> ($config['allow_privmsg']) ? 1 : 0, 
-		'S_DISPLAY_MEMBERLIST'	=> $_CLASS['auth']->acl_get('u_viewprofile'), 
+		'S_DISPLAY_MEMBERLIST'	=> $_CLASS['forums_auth']->acl_get('u_viewprofile'), 
 
 		'T_SMILIES_PATH'		=> "{$config['smilies_path']}/",
 		'T_AVATAR_PATH'			=> "{$config['avatar_path']}/",
@@ -1385,7 +1333,7 @@
 // Temp
 		'T_IMAGE_PATH'			=> "themes/viperal/template/modules/Forums/images/",
 
-		'U_ACP'				=> ($_CLASS['core_user']->is_admin && $_CLASS['auth']->acl_get('a_')) ? generate_link('Forums', array('admin' => true)) : '',
+		'U_ACP'				=> ($_CLASS['core_user']->is_admin && $_CLASS['forums_auth']->acl_get('a_')) ? generate_link('Forums', array('admin' => true)) : '',
 		'L_ACP'				=> $_CLASS['core_user']->lang['ACP']
 	));
 }

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/functions_display.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -353,7 +353,7 @@
 {
 	global $_CLASS, $config;
 
-	$folder = $folder_new = '';
+	$folder = '';
 	$unread = ($mark_time < $topic_row['topic_last_post_time']);
 
 	if ($topic_row['topic_status'] == ITEM_MOVED)

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/functions_posting.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -29,12 +29,12 @@
 	global $_CLASS;
 // add option for all smiles in window
 	$display_link = false;
-	$mode = ($mode == 'window') ? 'window' : 'inline';
+	$mode = ($mode === 'window') ? 'window' : 'inline';
 
-	if ($mode == 'inline')
+	if ($mode === 'inline')
 	{
 		$sql = 'SELECT smiley_id
-			FROM ' . SMILIES_TABLE . '
+			FROM ' . CORE_SMILIES_TABLE . '
 			WHERE smiley_type = 1';
 		$result = $_CLASS['core_db']->query_limit($sql, 1, 0);
 
@@ -50,7 +50,7 @@
 		$smiley = array();
 
 		$sql = 'SELECT *
-			FROM ' . SMILIES_TABLE .' 
+			FROM ' . CORE_SMILIES_TABLE .' 
 				WHERE smiley_type ='.(($mode == 'inline') ? '0' : '1') . '
 					ORDER BY smiley_order';
 		$result = $_CLASS['core_db']->query($sql);
@@ -65,14 +65,14 @@
 				'SMILEY_DESC'   => $row['smiley_description']
 			);
 		}
+		$_CLASS['core_db']->free_result($result);
 
 		$_CLASS['core_cache']->put('smiley_'.$mode, $smiley);
-		$_CLASS['core_db']->free_result($result);
 	}
 
 	$_CLASS['core_template']->assign('smiley', $smiley);
 
-	if ($mode == 'inline')
+	if ($mode === 'inline')
 	{
 		$_CLASS['core_template']->assign_array(array(
 			'S_SHOW_SMILEY_LINK' 	=> ($display_link) ? true : false,
@@ -80,7 +80,7 @@
 		);
 	}
 
-	if ($mode == 'window')
+	if ($mode === 'window')
 	{
 		global $config;
 

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -327,7 +327,7 @@
 				AND user_id = $user_id";
 		$_CLASS['core_db']->query($sql);
 	}
-	*/
+*/
 
 	// Get those messages not yet placed into any box
 	// NOTE: Expand Group Information to all groups the user/author is in? 
@@ -1147,7 +1147,7 @@
 	// Recipient Informations
 	$recipients = $to = $bcc = array();
 
-	if ($mode != 'edit')
+	if ($mode !== 'edit')
 	{
 		// Build Recipient List
 		// u|g => array($user_id => 'to'|'bcc')
@@ -1301,16 +1301,16 @@
 				'msg_id'	=> (int) $data['msg_id'],
 				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
 				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> PRIVMSGS_OUTBOX,
+				'folder_id'	=> (int) PRIVMSGS_OUTBOX,
 				'msg_new'	=> 0,
 				'unread'	=> 0,
-				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
+				'forwarded'	=> ($mode === 'forward') ? 1 : 0))
 			);
 		}
 	}
 
 	// Set user last post time
-	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
+	if ($mode === 'reply' || $mode === 'quote' || $mode === 'forward' || $mode === 'post')
 	{
 		$sql = 'UPDATE ' . USERS_TABLE . "
 			SET user_last_post_time = {$_CLASS['core_user']->time}

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/forums/message_parser.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -942,42 +942,29 @@
 	function smilies($max_smilies = 0)
 	{
 		global $_CLASS;
-		static $match, $replace;
-		
-		// NOTE: There is a memory leak in this block somewhere :\
-		// See if the static arrays have already been filled on an earlier invocation
-  	    if(!is_array($match))
+
+  	    if (is_null($smiley = $_CLASS['core_cache']->get('smiley_parse')))
   	    {
-			// NOTE: obtain_* function? chaching the table contents?
-			
+			$result = $_CLASS['core_db']->query('SELECT * FROM ' . SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC');
 
-			$sql = 'SELECT * FROM ' . SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC';;
-			$result = $_CLASS['core_db']->query($sql);
-
-			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			$smiley = array();
+			
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 			{
-				$match = $replace = array();
-
-				do
-				{
-					// (assertion)
-					$match[] = '#(?<=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
-					$replace[] = '<!-- s' . $row['smiley_code'] . ' --><img src="{SMILIES_PATH}/' . $row['smiley_src'] . '" border="0" alt="' . $row['smiley_description'] . '" title="' . $row['smiley_description'] . '" /><!-- s' . $row['smiley_code'] . ' -->';
-				}
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+				// (assertion)
+				$smiley['match'][] = '#(?<=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
+				$smiley['replace'][] = '<!-- s' . $row['smiley_code'] . ' --><img src="{SMILIES_PATH}/' . $row['smiley_src'] . '" border="0" alt="' . $row['smiley_description'] . '" title="' . $row['smiley_description'] . '" /><!-- s' . $row['smiley_code'] . ' -->';
 			}
-			else
-			{
-				$match = $replace = array();
-			}
 			$_CLASS['core_db']->free_result($result);
+
+			$_CLASS['core_cache']->put('smiley_parse', $smiley);
 		}
-			
-		if (sizeof($match))
+
+		if (!empty($smiley))
 		{
 			if ($max_smilies)
 			{
-				$num_matches = preg_match_all('#' . str_replace('#', '', implode('|', $match)) . '#', $this->message, $matches);
+				$num_matches = preg_match_all('#' . str_replace('#', '', implode('|', $smiley['match'])) . '#', $this->message, $matches);
 				unset($matches);
 
 				if ($num_matches !== false && $num_matches > $max_smilies)
@@ -987,7 +974,7 @@
 				}
 			}
 
-			$this->message = trim(preg_replace($match, $replace, $this->message));
+			$this->message = trim(preg_replace($smiley['match'], $smiley['replace'], $this->message));
 		}
 	}
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/functions.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -21,6 +21,25 @@
 $Id$
 */
 
+function censor_text($text, $force = false)
+{
+	global $_CLASS;
+
+	if (!$force && !$_CLASS['core_user']->user_data_get('viewcensors'))
+	{
+		return;
+	}
+
+	$censors = get_word_censors();
+
+	if (!empty($censors))
+	{
+		return preg_replace($censors['match'], $censors['replace'], $text);
+	}
+
+	return $text;
+}
+
 // Redo
 function check_email($email)
 {
@@ -36,7 +55,6 @@
 
 	foreach ($bots_array as $bot)
 	{
-		//if ($bot['user_agent'] && preg_match('#' . preg_quote($bot['user_agent'], '#') . '#i', $browser))
 		if ($bot['user_agent'] && mb_strpos($browser, $bot['user_agent']) === 0)
 		{
 			$is_bot = $bot['user_id'];
@@ -302,6 +320,32 @@
 	return $bots;
 }
 
+function get_word_censors()
+{
+	global $_CLASS;
+
+	if (is_null($censors = $_CLASS['core_cache']->get('word_censors')))
+	{
+		$sql = 'SELECT word, replacement
+			FROM  ' . CORE_CENSOR_TABLE .'ORDER BY LENGTH(word) DESC';
+		$result = $_CLASS['core_db']->query($sql);
+
+		$censors = array();
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$censors['match'][] = '#\b(' . str_replace('\*', '\w*?', preg_quote($row['word'], '#')) . ')\b#i';
+			$censors['replace'][] = $row['replacement'];
+		}
+
+		$_CLASS['core_db']->free_result($result);
+
+		$_CLASS['core_cache']->put('word_censors', $censors);
+	}
+
+	return $censors;
+}
+
 function get_variable($var_name, $type, $default = false, $var_type = 'string')
 {
 	$variable = null;
@@ -645,14 +689,6 @@
 
 	if (!empty($_CLASS['core_user']))
 	{
-		// phpbb 2.1.2 only remove.
-		if (file_exists(SITE_FILE_ROOT.'cache/queue.php'))
-		{
-			require_once(SITE_FILE_ROOT.'includes/forums/functions_messenger.php');
-			$queue = new queue();
-			$queue->process();
-		}
-
 		if ($save)
 		{
 			//if ($_CLASS['core_user']->is_admin && $_CORE_CONFIG['server']['error_options'])
@@ -669,7 +705,7 @@
 					$_CLASS['core_user']->session_data_set('debug', $_CLASS['core_error_handler']->error_array);
 				}
 			}
-						
+
 			$_CLASS['core_user']->save();
 		}	
 	}

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/functions_user.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -176,14 +176,14 @@
 // add a required array here, then find feilds that are not in the data array
 	$_CLASS['core_db']->transaction();
 
-	$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
+	$sql = 'INSERT INTO ' . CORE_USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
 	$_CLASS['core_db']->query($sql);
 
-	$data['user_id'] = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
+	$data['user_id'] = $_CLASS['core_db']->insert_id(CORE_USERS_TABLE, 'user_id');
 
 	if ($group_add)
 	{
-		$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . CORE_USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 			'group_id'		=> (int) $data['user_group'],
 			'user_id'		=> (int) $data['user_id'],
 			'member_status'	=> $data['user_status']
@@ -209,14 +209,14 @@
 	$_CLASS['core_db']->transaction();
 
 // hook here
-	$sql = 'UPDATE ' . USERS_TABLE . '
+	$sql = 'UPDATE ' . CORE_USERS_TABLE . '
 		SET user_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type <>' . USER_GUEST;
 
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
+	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ') 
 			AND member_status = ' . STATUS_DISABLED;
@@ -253,7 +253,7 @@
 	$_CLASS['core_db']->transaction();
 
 	// disabled the user first
-	$sql = 'UPDATE ' . USERS_TABLE . '
+	$sql = 'UPDATE ' . CORE_USERS_TABLE . '
 		SET user_status = ' . STATUS_DISABLED . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ')
 			AND user_type <>' . USER_GUEST;
@@ -262,7 +262,7 @@
 	// Now we disable the user in his active groups
 	//	( note disable is not uses for group removal, the entry is just deleted )
 // should also remove all pending groups
-	$sql = 'UPDATE ' . USER_GROUP_TABLE . '
+	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_DISABLED . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')
 			AND member_status = ' . STATUS_ACTIVE;
@@ -272,7 +272,7 @@
 	{
 		if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
 		{
-			$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
+			$sql = 'SELECT user_id, username FROM ' . CORE_USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.' AND user_status = '.STATUS_ACTIVE.'
 				ORDER BY user_reg_date';
 	
@@ -306,8 +306,8 @@
 
 	if ($quick)
 	{
-		$sql = "DELETE FROM USERS_TABLE
-			WHERE user_id IN (" . implode(', ', $user_id) . ')';
+		$sql = 'DELETE FROM ' . CORE_USERS_TABLE . '
+			WHERE user_id IN (' . implode(', ', $user_id) . ')';
 		$_CLASS['core_db']->query($sql);
 		
 		return;
@@ -324,28 +324,28 @@
 	$_CLASS['core_db']->transaction();
 
 	$optimize_array = array();
-	$tables = array(USERS_TABLE => 'user_id', USER_GROUP_TABLE => 'user_id');
+	$tables = array(CORE_USERS_TABLE => 'user_id', CORE_USER_GROUP_TABLE => 'user_id');
 // hook here
 
 // Move this to hooks on seperation
 	$tables += array(FORUMS_ACL_TABLE => 'user_id', FORUMS_WATCH_TABLE => 'user_id', FORUMS_TRACK_TABLE => 'user_id');
 
-	$sql = 'UPDATE ' . FORUMS_TABLE . '
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 		SET forum_last_poster_id = ' . ANONYMOUS . " 
 		WHERE forum_last_poster_id IN (" . implode(', ', $user_id) . ')';
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . POSTS_TABLE . '
+	$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 		SET poster_id = ' . ANONYMOUS . " 
 		WHERE poster_id IN (" . implode(', ', $user_id) . ')';
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . TOPICS_TABLE . '
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 		SET topic_poster = ' . ANONYMOUS . "
 		WHERE topic_poster IN (" . implode(', ', $user_id) . ')';
 	$_CLASS['core_db']->query($sql);
 
-	$sql = 'UPDATE ' . TOPICS_TABLE . '
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 		SET topic_last_poster_id = ' . ANONYMOUS . "
 		WHERE topic_last_poster_id IN (" . implode(', ', $user_id) . ')';
 	$_CLASS['core_db']->query($sql);
@@ -386,7 +386,7 @@
 	$data = array('user_id' => array(), 'username' => array());
 
 	$sql = 'SELECT user_id, username
-				FROM ' . USERS_TABLE . " 
+				FROM ' . CORE_USERS_TABLE . " 
 				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -418,7 +418,7 @@
 	$data = array('user_id' => array(), 'username' => array());
 
 	$sql = 'SELECT user_id, username
-				FROM ' . USERS_TABLE . ' 
+				FROM ' . CORE_USERS_TABLE . ' 
 				WHERE user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -453,7 +453,7 @@
 		return;
 	}
 
-	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
+	$sql = 'SELECT user_id FROM ' . CORE_USERS_TABLE . ' 
 				WHERE user_group IN (' . implode(', ', $group_id) . ')
 				AND user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']->query($sql);
@@ -476,13 +476,13 @@
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		$sql = 'UPDATE FROM '. USERS_TABLE .' 
+		$sql = 'UPDATE FROM '. CORE_USERS_TABLE .' 
 					SET user_group = 4, user_rank = -1
 					WHERE user_id IN (' . implode(', ', $group_id) . ')';
 		$result = $_CLASS['core_db']->query($sql);
 	}
 
-	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
+	$sql = 'DELETE FROM ' . CORE_USER_GROUP_TABLE . '
 		WHERE group_id IN ('. implode(', ', $group_id) . ')
 		AND user_id IN ('. implode(', ', $user_id) .')';
 
@@ -547,7 +547,7 @@
 	}
 
 	$sql = 'SELECT username
-		FROM ' . USERS_TABLE . "
+		FROM ' . CORE_USERS_TABLE . "
 		WHERE LOWER(username) = '" . $_CLASS['core_db']->escape($username) . "'";
 
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -629,7 +629,7 @@
 {
 	global $_CORE_CONFIG, $_CLASS;
 
-	if (strtolower($_CLASS['core_user']->data['user_email']) == strtolower($email))
+	if (strtolower($_CLASS['core_user']->data['user_email']) === strtolower($email))
 	{
 		return false;
 	}
@@ -639,23 +639,11 @@
 		return 'EMAIL_INVALID';
 	}
 
-	$sql = 'SELECT ban_email
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (preg_match('#^' . str_replace('*', '.*?', $row['ban_email']) . '$#i', $email))
-		{
-			return 'EMAIL_BANNED';
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
+	/*
 	if (!$_CORE_CONFIG['user']['allow_emailreuse'])
 	{
 		$sql = 'SELECT user_email_hash
-			FROM ' . USERS_TABLE . "
+			FROM ' . CORE_USERS_TABLE . "
 			WHERE user_email_hash = " . crc32(strtolower($email)) . strlen($email);
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -664,7 +652,8 @@
 			return 'EMAIL_TAKEN';
 		}
 		$_CLASS['core_db']->free_result($result);
-	}
+	}
+	*/
 
 	return false;
 }
@@ -729,7 +718,7 @@
 	global $config, $_CLASS;
 
 	// Init upload class
-	include_once(SITE_FILE_ROOT.'includes/forums/functions_upload.php');
+	require_once SITE_FILE_ROOT.'includes/forums/functions_upload.php';
 	
 	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
 							

Modified: cms/trunk/includes/handler.php
===================================================================
--- cms/trunk/includes/handler.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/handler.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -48,12 +48,12 @@
 		$this->report = $report;
 		$this->previous_level = ini_set('error_reporting', 0);
 		$this->logging = ($logfile && is_writable($logfile)) ? true : false;
-		
+
 		if ($this->logging && $log_file)
 		{
-			$this->previous_logger = ini_set('error_log', $log_file);
+			$this->previous_logger = ini_set('', $log_file);
 		}
-		
+
 		set_error_handler(array(&$this, 'error_handler'));
 	}
 	
@@ -139,7 +139,7 @@
 	{
 		global $_CLASS, $_CORE_CONFIG;
 
-		if ($this->report != ERROR_NONE)
+		if ($this->report !== ERROR_NONE)
 		{
 			//echo $error;
 

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/session.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -52,7 +52,7 @@
 		if ($session_id)
 		{
 			$sql = 'SELECT u.*, s.*
-				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . " u
+				FROM ' . CORE_SESSIONS_TABLE . ' s, ' . CORE_USERS_TABLE . " u
 				WHERE s.session_id = '" . $_CLASS['core_db']->escape($session_id) . "'
 					AND u.user_id = s.session_user_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -140,7 +140,7 @@
 		if ($_CORE_CONFIG['server']['limit_sessions'])
 		{
 			$sql = 'SELECT COUNT(*) AS sessions
-				FROM ' . SESSIONS_TABLE . '
+				FROM ' . CORE_SESSIONS_TABLE . '
 				WHERE session_time >= ' . ($this->time - 60);
 			$result = $_CLASS['core_db']->query($sql);
 		
@@ -171,7 +171,7 @@
 		if ($this->is_bot)
 		{
 			$sql = 'SELECT u.*, s.*
-				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . ' u
+				FROM ' . CORE_SESSIONS_TABLE . ' s, ' . CORE_USERS_TABLE . ' u
 				WHERE s.session_user_id = '. (int) $this->data['user_id'] .'
 					AND u.user_id = s.session_user_id';
 
@@ -213,7 +213,7 @@
 			'session_autologin'	=> (string) $this->autologin_code,
 		);
 
-		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $session_data));
+		$_CLASS['core_db']->query('INSERT INTO ' . CORE_SESSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $session_data));
 
 		$this->new_session =  true;
 
@@ -258,7 +258,7 @@
 			'auto_login_time'		=> (int) $this->time,
 		);
 
-		$_CLASS['core_db']->query('INSERT INTO ' . SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
+		$_CLASS['core_db']->query('INSERT INTO ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
 
 		$this->set_cookie('ali', $this->data['user_id'], $this->time + 2592000);
 		$this->set_cookie('alc', $this->autologin_code, $this->time + 2592000);
@@ -270,7 +270,7 @@
 
 		settype($user_id, 'int');
 
-		$sql = 'SELECT * FROM ' . SESSIONS_AUTOLOGIN_TABLE . " 
+		$sql = 'SELECT * FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . " 
 					WHERE user_id = $user_id
 					AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
 
@@ -292,7 +292,7 @@
 				'auto_login_time'		=> (int) $this->time,
 			);
 		
-			$sql = 'UPDATE ' . SESSIONS_AUTOLOGIN_TABLE . '	SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data_array) . "
+			$sql = 'UPDATE ' . CORE_SESSIONS_AUTOLOGIN_TABLE . '	SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data_array) . "
 						WHERE user_id = $user_id
 						AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
 			$_CLASS['core_db']->query($sql);
@@ -310,7 +310,7 @@
 	{
 		global $_CLASS;
 		
-		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . ' 
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
 			WHERE user_id = '.(INT) $user_id."
 			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
 				
@@ -338,12 +338,12 @@
 			$this->save_session = false;
 		}
 
-		$sql = 'DELETE FROM ' . SESSIONS_TABLE . "
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_TABLE . "
 			WHERE session_id = '" . $_CLASS['core_db']->escape($session_id)."'";
 
 		$_CLASS['core_db']->query($sql);
 
-		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
+		$_CLASS['core_db']->optimize_tables(CORE_SESSIONS_TABLE);
 	}
 
 	function gc($time)
@@ -359,7 +359,7 @@
 		$_CLASS['core_db']->transaction();
 
 		// Remove all expired guess sessions
-		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_TABLE . '
 			WHERE session_user_id = ' . ANONYMOUS . '
 			AND session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
 		$_CLASS['core_db']->query($sql);
@@ -370,7 +370,7 @@
 			//Oracle8 suporrts this also, I believe
 			case 'mysql':
 			case 'mysqli':
-				$sql = 'UPDATE ' . USERS_TABLE. ' u, ' . SESSIONS_TABLE . ' s
+				$sql = 'UPDATE ' . CORE_USERS_TABLE. ' u, ' . CORE_SESSIONS_TABLE . ' s
 							SET u.user_last_visit = s.session_time
 								WHERE s.session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
 								AND u.user_id = s.session_user_id';
@@ -379,7 +379,7 @@
 
 			default:
 				$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
-							FROM ' . SESSIONS_TABLE . '
+							FROM ' . CORE_SESSIONS_TABLE . '
 								WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']) . '
 								GROUP BY session_user_id';
 				$result = $_CLASS['core_db']->query($sql);
@@ -387,7 +387,7 @@
 				// Should be fast with the transaction
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$sql = 'UPDATE ' . USERS_TABLE . '
+					$sql = 'UPDATE ' . CORE_USERS_TABLE . '
 							SET user_last_visit = ' . $row['session_time'] . '
 								WHERE user_id = ' . $row['session_user_id'];
 					$_CLASS['core_db']->query($sql);
@@ -395,17 +395,17 @@
 			break;
 		}
 
-		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_TABLE . '
 				WHERE session_time < ' . ($time - $_CORE_CONFIG['server']['session_length']);
 			$_CLASS['core_db']->query($sql);
 
-		$sql = 'DELETE FROM ' . SESSIONS_AUTOLOGIN_TABLE . '
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . '
 					WHERE auto_login_time < ' . ($time - 2592000);
 		$_CLASS['core_db']->query($sql);
 		
 		$_CLASS['core_db']->transaction('commit');
 
-		$_CLASS['core_db']->optimize_tables(SESSIONS_TABLE);
+		$_CLASS['core_db']->optimize_tables(CORE_SESSIONS_TABLE);
 	}
 
 	function session_data_get($name, $default = false)
@@ -456,7 +456,7 @@
 			'session_url'			=> (string) $this->url,
 		);
 
-		$sql = 'UPDATE ' . SESSIONS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . "
+		$sql = 'UPDATE ' . CORE_SESSIONS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . "
 				WHERE session_id = '" . $_CLASS['core_db']->escape($this->data['session_id']) . "'";
 
 		$_CLASS['core_db']->query($sql);

Modified: cms/trunk/includes/system.php
===================================================================
--- cms/trunk/includes/system.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/system.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -166,7 +166,7 @@
 	}
 
 	$sql = 'SELECT username, user_status, user_group, user_new_password, user_new_password_encoding, user_act_key
-		FROM ' . USERS_TABLE . " WHERE user_id = $user_id AND user_type = ".USER_NORMAL;
+		FROM ' . CORE_USERS_TABLE . " WHERE user_id = $user_id AND user_type = ".USER_NORMAL;
 
 	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -197,7 +197,7 @@
 
 	if ($row['user_status'] === STATUS_PENDING)
 	{
-		include_once(SITE_FILE_ROOT.'includes/functions_user.php');
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
 		user_activate($user_id);
 
 		set_core_config('user', 'newest_user_id', $row['user_id'], false);
@@ -212,7 +212,7 @@
 		);
 	}
 
-	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+	$sql = 'UPDATE ' . CORE_USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
 		WHERE user_id = ' . $user_id;
 	$result = $_CLASS['core_db']->query($sql);
 

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/tables.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -197,32 +197,34 @@
 define('FORUMS_EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
 define('FORUMS_EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
-define('ADMIN_AUTH_TABLE', $table_prefix.'admins');
+define('CORE_ADMIN_AUTH_TABLE', $table_prefix.'admins');
+define('CORE_ADMIN_MODULES_TABLE', $table_prefix.'admin_modules');
 
-define('BLOCKS_TABLE', $table_prefix.'blocks');
+define('CORE_BLOCKS_TABLE', $table_prefix.'blocks');
+
 define('CORE_CONFIG_TABLE', $table_prefix.'config');
+define('CORE_CONTROL_PANEL_MODULES_TABLE', $table_prefix . 'control_panel_modules');
+
 define('CORE_PAGES_TABLE', $table_prefix.'pages');
-define('SMILIES_TABLE', $table_prefix.'smilies');
+define('CORE_SMILIES_TABLE', $table_prefix.'smilies');
 
-define('USER_GROUP_TABLE', $table_prefix.'groups_members');
-define('GROUPS_TABLE', $table_prefix.'groups');
+define('CORE_USER_GROUP_TABLE', $table_prefix.'groups_members');
 
-define('SESSIONS_AUTOLOGIN_TABLE', $table_prefix.'sessions_auto_login');
-define('SESSIONS_TABLE', $table_prefix.'sessions');
+define('CORE_GROUPS_TABLE', $table_prefix.'groups');
+define('CORE_GROUPS_MEMBERS_TABLE', $table_prefix.'groups_members');
 
+define('CORE_SESSIONS_AUTOLOGIN_TABLE', $table_prefix.'sessions_auto_login');
+define('CORE_SESSIONS_TABLE', $table_prefix.'sessions');
 
 
-define('USERS_TABLE', $user_prefix.'users');
+
+define('CORE_USERS_TABLE', $user_prefix.'users');
 define('USERS_NOTES_TABLE', $table_prefix.'forums_users_notes');
 define('ZEBRA_TABLE', $table_prefix.'forums_zebra');
 //define('LOG_TABLE', $table_prefix.'log');
 
 
 // can be removed
-define('PROFILE_FIELDS_TABLE', $table_prefix.'forums_profile_fields');
-define('PROFILE_LANG_TABLE', $table_prefix.'forums_profile_lang');
-define('PROFILE_DATA_TABLE', $table_prefix.'forums_profile_fields_data');
-define('PROFILE_FIELDS_LANG_TABLE', $table_prefix.'forums_profile_fields_lang');
 define('DISALLOW_TABLE', $table_prefix.'forums_disallow');
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/user.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -127,13 +127,13 @@
 			script_close(false);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT * FROM ' . USERS_TABLE . ' WHERE user_id = '. $id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . CORE_USERS_TABLE . ' WHERE user_id = '. $id);
 		$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
 		if (!$this->data)
 		{
-			die('Installlation problem');
+			die ('Installlation problem');
 // Error here, however this happen
 		}
 
@@ -166,7 +166,7 @@
 
 		if ($this->is_user)
 		{
-			$sql = 'UPDATE ' . USERS_TABLE . '
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . '
 				SET user_last_visit = ' . (int) $this->data['session_time'] . '
 				WHERE user_id = ' . (int) $this->data['user_id'];
 			$_CLASS['core_db']->query($sql);
@@ -175,7 +175,7 @@
 		$this->session_destroy(false, true);
 
 		$sql = 'SELECT *
-			FROM ' . USERS_TABLE . '
+			FROM ' . CORE_USERS_TABLE . '
 			WHERE user_id = ' . ANONYMOUS;
 		$result = $_CLASS['core_db']->query($sql);
 	
@@ -441,7 +441,7 @@
 
 		return '<img src=' . $img['src'] .$width . $height .' alt="' . $alt . '" title="' . $alt . '" />';
 	}
-
+/*
 	function optionget($key, $data = false)
 	{
 		return $this->user_data_get($key);
@@ -451,6 +451,7 @@
 	{
 		return $this->user_data_set($key, $value);
 	}
+*/
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/index.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -22,20 +22,22 @@
 */
 
 define('VIPERAL', 'CMS');
-//print_r($_GET);die;
 error_reporting(E_ALL);
 
-//require_once SITE_FILE_ROOT.'core.php';
+/* require_once SITE_FILE_ROOT.'core.php'; */
 require_once 'core.php';
 
 $mod = get_variable('mod', 'REQUEST', false);
 
 if (!$mod)
 {
-	// Set as homepage 
+	/* Make it know we're at the homepage */
 	$_CLASS['core_display']->homepage = true;
+	
+
 	$_CORE_CONFIG['global']['index_page'] = 'articles';
 
+	/* Retrieve and process the homepage */
 	$sql = 'SELECT * FROM ' . CORE_PAGES_TABLE . "
 				WHERE page_name = '".$_CLASS['core_db']->escape($_CORE_CONFIG['global']['index_page'])."'";
 	$result = $_CLASS['core_db']->query($sql);
@@ -46,6 +48,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
+	/* If home page isn't a module or template page let atleast display something */
 	if (!$_CLASS['core_display']->generate_page())
 	{
 		/*
@@ -59,6 +62,7 @@
 		echo $blocks;
 		*/
 
+		/* Let all blocks be displayed */
 		$blocks = 126;
 
 		$_CLASS['core_display']->page = array('page_blocks' => $blocks, 'page_name' => '', 'page_title' => '');
@@ -66,7 +70,7 @@
 		$_CLASS['core_user']->user_setup();
 		$_CLASS['core_display']->display_header();
 
-		// Hey admin we don't have a modules set
+		/* Hey admin we don't have a modules set */
 		if ($_CLASS['core_auth']->admin_auth('modules'))
 		{
 			$_CLASS['core_display']->message = '_NO_HOMEPAGE_ADMIN';

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/install/build_data.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -120,15 +120,24 @@
 $content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('blocks', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('groups', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('system', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('messages', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('pages', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('smiles', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('users', 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_module (module_name, module_status) VALUES ('groups', 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('blocks', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('system', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('messages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('pages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('smiles', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('users', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
 
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('main', 2, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('pm', 2, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('profile', 2,'profile_info\r\nreg_details\r\nsignature\r\navatar')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('prefs', 2, 'personal\r\nview\r\npost')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('zebra', 2, 'friends\r\nfoes')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('attachments', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('groups', 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 1, 1, 102)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Contact', 1, 2, 102)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 1, 1, 98)");
@@ -440,15 +449,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
-
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Plain Text', 0, 0, 1, '', 0, '')");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/install/build_tables.php	2005-10-26 18:58:46 UTC (rev 164)
@@ -146,7 +146,7 @@
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
 $_CLASS['core_db']->add_table_field_char('module_title', 100, true);
-$_CLASS['core_db']->add_table_field_char('module_location', 100, true);
+$_CLASS['core_db']->add_table_field_char('module_location', 200, true);
 $_CLASS['core_db']->add_table_field_int('module_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('module_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_text('module_auth', 60000, true);
@@ -157,12 +157,29 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+$_CLASS['core_db']->table_create('start', $table_prefix.'control_panel_modules');
+
+$_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('module_name', 100);
+$_CLASS['core_db']->add_table_field_char('module_title', 100, true);
+$_CLASS['core_db']->add_table_field_char('module_subs', 100, true);
+$_CLASS['core_db']->add_table_field_char('module_location', 200, true);
+//$_CLASS['core_db']->add_table_field_int('module_type', array('max' => 10));
+$_CLASS['core_db']->add_table_field_int('module_status', array('max' => 10));
+$_CLASS['core_db']->add_table_field_text('module_auth', 60000, true);
+$_CLASS['core_db']->add_table_field_text('module_admin_options', 6000, true);
+
+$_CLASS['core_db']->add_table_index('module_id', 'primary');
+$_CLASS['core_db']->add_table_index('module_name', 'unique');
+
+$_CLASS['core_db']->table_create('commit');
+
 $_CLASS['core_db']->table_create('start', $table_prefix.'pages');
 
 $_CLASS['core_db']->add_table_field_int('page_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('page_name', 100);
 $_CLASS['core_db']->add_table_field_char('page_title', 100, true);
-$_CLASS['core_db']->add_table_field_char('page_location', 100, true);
+$_CLASS['core_db']->add_table_field_char('page_location', 200, true);
 $_CLASS['core_db']->add_table_field_int('page_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('page_status', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('page_blocks', array('max' => 10000, 'null' => true)); // Convert to bitfield

Modified: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/javascript/quick_messages.js	2005-10-26 18:58:46 UTC (rev 164)
@@ -2,7 +2,7 @@
 
 function quick_message_submit()
 {
-	var message = document.getElementById('message');
+	var message = document.getElementById('quick_message');
 	var poster_name = document.getElementById('poster_name');
 
 	ajax = new core_ajax();



From viperal at berlios.de  Wed Oct 26 21:21:22 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 26 Oct 2005 21:21:22 +0200
Subject: [Viperals-svncheckins] r165 - in cms/trunk: includes/templates/modules includes/templates/modules/control_panel2 includes/templates/modules/control_panel2/Control_Panel includes/templates/modules/quick_message2 includes/templates/modules/quick_message2/Quick_Message modules
Message-ID: <200510261921.j9QJLM5o031138@sheep.berlios.de>

Author: viperal
Date: 2005-10-26 21:21:18 +0200 (Wed, 26 Oct 2005)
New Revision: 165

Added:
   cms/trunk/includes/templates/modules/calender2/
   cms/trunk/includes/templates/modules/contact2/
   cms/trunk/includes/templates/modules/control_panel2/
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/
   cms/trunk/includes/templates/modules/forums2/
   cms/trunk/includes/templates/modules/members_list2/
   cms/trunk/includes/templates/modules/quick_message2/
   cms/trunk/includes/templates/modules/quick_message2/Quick_Message/
   cms/trunk/modules/contact2/
   cms/trunk/modules/control_panel2/
   cms/trunk/modules/forums2/
   cms/trunk/modules/members_list2/
   cms/trunk/modules/quick_message2/
Removed:
   cms/trunk/includes/templates/modules/Calender/
   cms/trunk/includes/templates/modules/Contact/
   cms/trunk/includes/templates/modules/Control_Panel/
   cms/trunk/includes/templates/modules/Forums/
   cms/trunk/includes/templates/modules/Members_List/
   cms/trunk/includes/templates/modules/Quick_Message/
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_agreement.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_attachments.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_add.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_day.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_details.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_main.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_footer.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_groups_membership.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_header.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_bookmarks.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_drafts.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_front.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_subscribed.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_history.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_footer.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_header.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_options.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_popup.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewfolder.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage_print.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_attach_body.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_body.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_preview.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_personal.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_post.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_view.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_avatar.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_profile_info.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_reg_details.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_signature.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_register.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_remind.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_resend.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_sideblock.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_foes.html
   cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_friends.html
   cms/trunk/includes/templates/modules/quick_message2/Quick_Message/index.html
   cms/trunk/modules/Contact/
   cms/trunk/modules/Control_Panel/
   cms/trunk/modules/Forums/
   cms/trunk/modules/Members_List/
   cms/trunk/modules/Quick_Message/
Log:
Change module cases to all lowercase

Copied: cms/trunk/includes/templates/modules/calender2 (from rev 163, cms/trunk/includes/templates/modules/Calender)

Copied: cms/trunk/includes/templates/modules/contact2 (from rev 163, cms/trunk/includes/templates/modules/Contact)

Copied: cms/trunk/includes/templates/modules/control_panel2 (from rev 163, cms/trunk/includes/templates/modules/Control_Panel)

Copied: cms/trunk/includes/templates/modules/control_panel2/Control_Panel (from rev 163, cms/trunk/includes/templates/modules/Control_Panel)

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_agreement.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_agreement.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_agreement.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,33 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form method="post" action="{ $S_UCP_ACTION }">
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" border="0">
-	<tr>
-		<th height="25">{ $L_REGISTRATION }</th>
-	</tr>
-	<tr>
-		<td class="row1">
-		{ $S_HIDDEN_FIELDS }
-		<!-- IF { $S_SHOW_COPPA } -->
-			<div align="center">
-				<br />{ $L_COPPA_BIRTHDAY }<br /><br />
-				<a href="{ $U_COPPA_NO }">{ $L_COPPA_NO }</a> :: <a href="{ $U_COPPA_YES }">{ $L_COPPA_YES }</a><br /><br />
-			</div>
-		<!-- ELSE -->
-			<div style="padding: 10px" class="genmed"><br />{ $L_TERMS_OF_USE_CONTENT }<br /><br /></div>
-			<div align="center">
-				<input class="button" type="submit" name="agreed" value="{ $L_AGREE }"><br /><br />
-				<input class="button" type="submit" name="not_agreed" value="{ $L_NOT_AGREE }">
-			</div>
-		<!-- ENDIF -->
-		</td>
-	</tr>
-</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_attachments.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,78 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<!-- IF { $S_ATTACHMENT_ROWS } -->
-
-<script language="javascript" type="text/javascript">
-<!--
-	function marklist(form_name, status)
-	{
-		for (i = 0; i < document.forms[form_name].length; i++)
-		{
-			document.forms[form_name].elements[i].checked = status;
-		}
-	}
-//-->
-</script>
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th nowrap="nowrap">#</th>
-			<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_FILENAME }">{ $L_FILENAME }</a></th>
-			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_POST_TIME }">{ $L_POST_TIME }</a></th>
-			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_FILESIZE }">{ $L_FILESIZE }</a></th>
-			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_DOWNLOADS }">{ $L_DOWNLOADS }</a></th>
-			<th width="2%" nowrap="nowrap">{ $L_DELETE }</th>
-		</tr>
-		<!-- IF { $TOTAL_ATTACHMENTS } -->
-		<tr>
-			<td class="row3" colspan="6">
-				<table width="100%" cellspacing="1">
-				<tr>
-					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_ATTACHMENTS } ]&nbsp;</td>
-					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-				</tr>
-				</table>
-			</td>
-		</tr>
-		<!-- ENDIF -->
-		
-		<!-- LOOP $attachrow -->
-			<!-- IF { $attachrow:#LOOP_INDEX } % 2 -->
-			<tr class="row2">
-			<!-- ELSE -->
-			<tr class="row1">
-			<!-- ENDIF -->
-	
-			<td class="genmed" style="padding: 4px;" align="center" width="2%">&nbsp;{ $attachrow:ROW_NUMBER }&nbsp;</td>
-			<td style="padding: 4px;"><a class="gen" href="{ $attachrow:U_VIEW_ATTACHMENT }" target="file">{ $attachrow:FILENAME }</a><br /><span class="gensmall"><!-- IF { $attachrow:S_IN_MESSAGE } --><b>{ $L_PM }: </b><!-- ELSE --><b>{ $L_TOPIC }: </b><!-- ENDIF --><a href="{ $attachrow:U_VIEW_TOPIC }">{ $attachrow:TOPIC_TITLE }</a></span></td>
-			<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">&nbsp;{ $attachrow:POST_TIME }&nbsp;</td>
-			<td class="genmed" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">{ $attachrow:SIZE }</td>
-			<td class="genmed" style="padding: 4px;" align="center">{ $attachrow:DOWNLOAD_COUNT }</td>
-			<td style="padding: 4px;" align="center" valign="middle"><input type="checkbox" name="attachment[{ $attachrow:ATTACH_ID }]" value="1" /></td>
-		</tr>
-		<!-- ENDLOOP -->
-		
-		<tr> 
-			<td class="cat" colspan="6"><div style="float:left"><span class="gensmall">{ $L_SORT_BY }: </span><select name="sk">{$S_SORT_OPTIONS}</select> <select name="sd">{ $S_ORDER_SELECT }</select>&nbsp;<input class="button" type="submit" name="sort" value="{ $L_SORT }" /></div><div style="float:right"><input class="button" type="submit" name="delete" value="{ $L_DELETE_MARKED }" />&nbsp;</div></td>
-		</tr>
-	</table>
-	<br />
-	<div style="float:right"><b class="gensmall"><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
-</form>
-<!-- ELSE -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th height="28">{ $L_TITLE }</th>
-	</tr>
-	<tr class="row1">
-		<td height="25" align="center"><b class="genmed">{ $L_UCP_NO_ATTACHMENTS }</b></td>
-	</tr>
-</table>
-
-<!-- ENDIF -->
-<br />
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_add.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_add.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_add.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,134 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
-<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
-<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
-<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
-
-<script type="text/javascript">
-
-function fast_preview()
-{
-	if(document.getElementById('preview_fast').innerHTML == '{ $L_PREVIEW }')
-	{
-		document.getElementById('preview_fast').innerHTML = '{ $L_EDIT }';
-		document.getElementById('message_preview').innerHTML = document.getElementById('description').value;
-		document.getElementById('message_preview').style.display = '';
-		document.getElementById('description').style.display = 'none';
-	}
-	else
-	{
-		document.getElementById('preview_fast').innerHTML = '{ $L_PREVIEW }';
-		document.getElementById('message_preview').innerHTML = '';
-		document.getElementById('message_preview').style.display = 'none';
-		document.getElementById('description').style.display = '';
-	}
-}
-
-</script>
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table width="100%" cellpadding="3" cellspacing="0">
-		<tr>
-			<td width="60%" valign="top">
-				<table class="tablebg" width="100%" cellspacing="1">
-					<!-- IF { $ERROR } -->
-					<tr>
-						<td class="row1" colspan="2" align="center"><span class="genmed" style="color:red">{ $ERROR }</span></td>
-					</tr>
-					<!-- ENDIF -->
-					<tr>
-						<th colspan="2">{ $L_BASIC_INFO }</th>
-					</tr>
-					<tr> 
-						<td class="row2" align="center" colspan="3">
-							<font class="error">No Content check yet, so don't hack plz</font>
-						</td>
-					</tr>
-					<tr>
-						<td class="row1" width="30%">{ $L_TITLE }</td>
-						<td class="row1"><input class="post" name="title" value="" size="39" type="text" /></td>
-					</tr>
-					<tr>
-						<td valign="top" class="row1" width="30%">{ $L_DESCRIPTION }<br/><a id="preview_fast" href="#" onclick="fast_preview(); return false;">{ $L_PREVIEW }</a></td>
-						<td class="row1">
-							<div id="message_preview" style="display: none; padding:5"></div>
-							<textarea name="description" id="description" rows="5" cols="35" style="display: ;" wrap="virtual" size="40"></textarea>
-						</td>
-					</tr>	
-					<tr>
-						<th colspan="2"></th>
-					</tr>
-					<tr>
-						<td class="row1" width="30%">{ $L_START }</td>
-						<td class="row1"><input class="post" id="start" name="start" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="start_trigger" /></td>
-	
-					</tr>
-					<tr>
-						<td class="row1" width="30%">{ $L_END }</td>
-						<td class="row1"><input class="post" id="end" name="end" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="end_trigger" /></td>
-	
-					</tr>
-					<tr>
-						<td class="cat" align="center"><input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;</td>
-						<td class="cat" align="center"></td>
-					</tr>
-				</table>
-			</td>
-			<td width="40%" valign="top">
-		
-				<table class="tablebg" width="100%" cellspacing="1">
-					<tr>
-						<th>{ $L_BASIC_INFO }</th>
-					</tr>
-					<tr>
-						<td class="row1">{ $L_BASIC_INFO }</td>
-					</tr>
-					<tr>
-						<td align="center" class="row1"><a href="#" onclick="if (document.getElementById('options_recu').style.display)
-																			{
-																				document.getElementById('options_recu').style.display = '';
-																				this.innerHTML = '{ $L_HIDE_RECURRENCE }';
-																			}
-																			else
-																			{
-																				document.getElementById('options_recu').style.display = 'none';
-																				this.innerHTML = '{ $L_SHOW_RECURRENCE }';
-																			}
-																			
-																			return false;">
-						{ $L_SHOW_RECURRENCE }</a></th>
-					</tr>
-					
-					<tr id="options_recu" style="display: none;">
-						<td class="row1">Recurre Every: <input class="post" name="recurrence_rate" value="1" size="5" type="text"><span class="genmed"></span><select name="recurrence_type"><option value="86400">Days</option><option value="86400">Weeks</option><option value="month">Month</option></select></td>
-					</tr>
-					
-				</table>
-			</td>
-		</tr>
-	</table>
-<form>
-
-<script type="text/javascript">
-  Calendar.setup(
-    {
-      inputField  : "start",
-      button      : "start_trigger"
-    }
-  );
-</script>
-<script type="text/javascript">
-  Calendar.setup(
-    {
-      inputField  : "end",
-      button      : "end_trigger"
-    }
-  );
-</script>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_day.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_day.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_day.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,84 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<table class="tablebg" width="100%" cellpadding="5" cellspacing="1">
-	<tr class="row2">
-		<td width="33%"><a href="{ $PREVIOUS_DAY_LINK }">{ $L_PREVIOUS_DAY }</a></td>
-		<td width="33%" align="center"><div style="font-size: 120%"><b>{ $THIS_DAY }</b></div></td>
-		<td width="33%" align="right"><a href="{ $NEXT_DAY_LINK }">{ $L_NEXT_DAY }</a></td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-<table width="100%" cellpadding="5" cellspacing="1">
-	<tr>
-		<td width="50%" valign="top">
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th colspan="3">{ $L_EVENTS }</th>
-				</tr>
-			<!-- IF isset({ $events }) -->
-				<tr>
-					<td class="row3" colspan="3" style="text-align:center; padding:5px;">There are currently % Events Scheduled</td>
-				</tr>
-				<tr>
-					<th>{ $L_EVENT }</th>
-					<th>{ $L_STARTS }</th>
-					<th>{ $L_ENDS }</th>
-				</tr>
-				<!-- LOOP $events -->
-				<tr class="row1">
-					<td valign="top" style="padding:5px; width:50%;" onclick="window.open('{ $events:LINK }','_event{ $events:ID }','width=500,height=400,scrollbars=yes');"><a href="{ $events:LINK }" onclick="window.open('{ $events:LINK }','_event{ $events:ID }','width=500,height=400,scrollbars=yes');return false;" target="_event{ $events:ID }">{ $events:TITLE }</a></td>
-					<td align="center">{ $events:START_TIME }</td>
-					<td align="center">{ $events:END_TIME }</td>
-				</tr>
-				<!-- ENDLOOP -->
-			<!-- ELSE -->
-					<td class="row1" align="center" style="padding:5px"><b>{ $L_NO_EVENTS }</b></td>
-			<!-- ENDIF -->
-				<tr>
-					<th colspan="3"></th>
-				</tr>
-			
-			</table>
-		</td>
-		<td width="50%" valign="top">
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th width="14%">{ $L_SUNDAY }</th>
-					<th width="14%">{ $L_MONDAY }</th>
-					<th width="14%">{ $L_TUESDAY }</th>
-					<th width="14%">{ $L_WEDNESDAY }</th>
-					<th width="14%">{ $L_THURSDAY }</th>
-					<th width="14%">{ $L_FRIDAY }</th>
-					<th width="14%">{ $L_SATURDAY }</th>
-				</tr>
-				<!-- LOOP $days -->
-			
-				<!-- IF ({ $days:#LOOP_INDEX } % 7) == 0 --></tr><tr style="height:40px"><!-- ENDIF -->
-			
-				<!-- IF { $days:NUMBER } -->
-					<!-- IF { $days:LINK } -->
-						<td class="row1" valign="top" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $days:LINK }'" style="padding:5px"><a href="{ $days:LINK }">{ $days:NUMBER }</a></td>
-					<!-- ELSE -->
-						<td class="row3" valign="top" style="padding:5px">{ $days:NUMBER }</td>
-					<!-- ENDIF -->
-				<!-- ELSE -->
-					<td class="row2" style="padding:5px"></td>
-				<!-- ENDIF -->
-			
-				<!-- ENDLOOP -->
-				
-				<tr>
-					<th colspan="7"></th>
-				</tr>
-			
-			</table>
-		</td>
-	</tr>
-</table>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_details.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_details.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_details.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,32 +0,0 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<head>
-<title>{ $L_TITLE }</title>
-<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
-</head>
-<html>
-	<body>
-		<table class="tablebg" width="100%" cellpadding="5" cellspacing="1">
-			<tr>
-				<th colspan="2">Event Detail</th>
-			</tr>
-			<tr class="row1">
-				<td align="center" colspan="2"><strong>{ $CAL_TITLE }</strong></td>
-			</tr>
-			<tr class="row2">
-				<td>Starts</td>
-				<td>{ $CAL_START_TIME }</td>
-			</tr>
-			<tr class="row2">
-				<td>Ends</td>
-				<td>{ $CAL_END_TIME }</td>
-			</tr>
-			<tr>
-				<th colspan="2">Description</th>
-			</tr>
-			<tr class="row2">
-				<td colspan="2">{ $CAL_DESCRIPTION }</td>
-			</tr>
-		</table>
-	</body>
-</html>
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_main.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_main.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_calender_main.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,54 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<table class="tablebg" width="100%" cellpadding="5" cellspacing="1px">
-	<tr class="row2">
-		<td width="33%"><a href="{ $PREVIOUS_MONTH }">{ $PREVIOUS_MONTH_NAME } { $PREVIOUS_MONTH_YEAR }</a></td>
-		<td width="33%" align="center"><div style="font-size: 120%"><b>{ $THIS_MONTH_NAME } { $CURRENT_YEAR }</b></div></td>
-		<td width="33%" align="right"><a href="{ $NEXT_MONTH }">{ $NEXT_MONTH_NAME } { $NEXT_MONTH_YEAR }</a></td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th width="14%">{ $L_SUNDAY }</th>
-		<th width="14%">{ $L_MONDAY }</th>
-		<th width="14%">{ $L_TUESDAY }</th>
-		<th width="14%">{ $L_WEDNESDAY }</th>
-		<th width="14%">{ $L_THURSDAY }</th>
-		<th width="14%">{ $L_FRIDAY }</th>
-		<th width="14%">{ $L_SATURDAY }</th>
-	</tr>
-	<!-- LOOP $days -->
-
-	<!-- IF ({ $days:#LOOP_INDEX } % 7) == 0 --></tr><tr style="height:80px"><!-- ENDIF -->
-
-	<!-- IF { $days:NUMBER } -->
-		<!-- IF { $days:LINK } -->
-			<td class="row1" valign="top" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $days:LINK }'" style="padding:5px">
-				<a href="{ $days:LINK }"><b>{ $days:NUMBER }</b></a>
-		<!-- ELSE -->
-			<td class="row3" valign="top" style="padding:5px"><b>{ $days:NUMBER }</b>
-		<!-- ENDIF -->
-				<br/>
-				<!-- LOOP $days:DATA -->
-					<a href="{ $days:DATA:calender_link }" onclick="window.open('{ $days:DATA:calender_link }','_event{ $days:DATA:calender_id }','width=500,height=400,scrollbars=yes');return false;" target="_event{ $days:DATA:calender_id }">{ $days:DATA:calender_title }</a><br/>
-				<!-- ENDLOOP -->
-			</td>
-	<!-- ELSE -->
-		<td class="row2" style="padding:5px"></td>
-	<!-- ENDIF -->
-	
-	<!-- ENDLOOP -->
-	<tr>
-		<th colspan="7"></th>
-	</tr>
-
-</table>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_footer.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,3 +0,0 @@
-{ $THEME_TABLE_CLOSE }
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_groups_membership.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_groups_membership.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,69 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2">{ $L_USERGROUPS }</th>
-		</tr>
-		<tr>
-			<td class="row3" colspan="2"><span class="genmed">{ $L_GROUPS_EXPLAIN }</span></td>
-		</tr>
-		<tr>
-			<th colspan="1">{ $L_GROUP_DETAILS }</th>
-			<th>{ $L_MARK }</th>
-		</tr>
-	
-		<!-- IF isset({ $leader }) -->
-		<tr>
-			<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_LEADER }</b></td>
-		</tr>
-		<!-- LOOP $leader -->
-		<tr>
-			<td class="row1"><b class="genmed"><a href="{ $leader:U_VIEW_GROUP }">{ $leader:GROUP_NAME }</a></b><!-- IF { $leader:GROUP_DESC } --><p class="forumdesc">{ $leader:GROUP_DESC }</p><!-- ENDIF --></td>
-			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $leader:GROUP_ID }" /><!-- ENDIF --></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<!-- ENDIF -->
-	
-		<!-- IF isset({ $member }) -->
-		<tr>
-			<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_MEMBER }</b></td>
-		</tr>
-		<!-- LOOP $member -->
-		<tr>
-			<td class="row1"><b class="genmed"><a href="{ $member:U_VIEW_GROUP }">{ $member:GROUP_NAME }</a></b><!-- IF { $member:GROUP_DESC } --><p class="forumdesc">{ $member:GROUP_DESC }</p><!-- ENDIF --></td>
-			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $member:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<!-- ENDIF -->
-	
-		<!-- IF isset({ $pending }) -->
-		<tr>
-			<td class="row3" colspan="2"><b class="gensmall">{$L_GROUP_PENDING}</b></td>
-		</tr>
-		<!-- LOOP $pending -->
-		<tr>
-			<td class="row1"><b class="genmed"><a href="{ $pending:U_VIEW_GROUP }">{ $pending:GROUP_NAME }</a></b><!-- IF { $pending:GROUP_DESC } --><p class="forumdesc">{ $pending:GROUP_DESC }</p><!-- ENDIF --></td>
-			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $pending:GROUP_ID }" /><!-- ENDIF --></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<!-- ENDIF -->
-	
-		<!-- IF isset({ $nonmember }) -->
-		<tr>
-			<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_NONMEMBER}</b></td>
-		</tr>
-		<!-- LOOP $nonmember -->
-		<tr>
-			<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
-			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $nonmember:GROUP_ID }" /><!-- ENDIF --></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<!-- ENDIF -->
-		<tr>
-			<td class="cat" colspan="3"><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="apply">Apply marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;</div></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_header.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,3 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-{ $THEME_TABLE_OPEN }
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_bookmarks.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_bookmarks.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_bookmarks.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,107 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<script language="javascript" type="text/javascript">
-
-function marklist(form_name, status)
-{
-	for (i = 0; i < document.forms[form_name].length; i++)
-	{
-		document.forms[form_name].elements[i].checked = status;
-	}
-}
-
-//-->
-</script>
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="5">{ $L_UCP }</th>
-		</tr>
-		<tr>
-			<td class="row1" colspan="5" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
-		</tr>
-		
-		<!-- IF { $S_BOOKMARKS_DISABLED } -->
-		<tr class="row1">
-			<td colspan="5" align="center"><b class="genmed">{ $L_BOOKMARKS_DISABLED }</b></td>
-		</tr>
-		<!-- ELSE -->
-		<tr>
-			<th colspan="5">{ $L_BOOKMARKS_FORUMS }</th>
-		</tr>
-	
-		<!-- LOOP $forummarks -->
-	
-		<!-- IF { $forummarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-			<td style="padding: 4px;" width="20px" align="center" valign="middle">{ $forummarks:TOPIC_FOLDER_IMG }</td>
-		<!-- IF { $forummarks:S_DELETED_TOPIC } -->
-			<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{ $L_DELETED_TOPIC }</td>
-		<!-- ELSE -->
-			<td style="padding: 4px;" width="100%" valign="top">
-			<p class="topictitle">{ $forummarks:ATTACH_ICON_IMG } <a href="{ $forummarks:U_VIEW_TOPIC }">{ $forummarks:TOPIC_TITLE }</a></p><br />
-			<span class="gensmall"><b>{ $L_FORUM }: </b><a href="{ $forummarks:U_VIEW_FORUM }">{ $forummarks:FORUM_NAME }</a></span>
-			<!-- IF { $forummarks:PAGINATION } -->
-				<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $forummarks:PAGINATION } ] </p>
-			<!-- ENDIF -->
-		</td>
-		<td style="padding: 4px;" align="center" valign="top" nowrap="nowrap">
-			<p class="topicdetails">{ $forummarks:LAST_POST_TIME }</p>
-			<p class="topicdetails"><!-- IF { $forummarks:U_LAST_POST_AUTHOR } --><a href="{ $forummarks:U_LAST_POST_AUTHOR }">{ $forummarks:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forummarks:LAST_POST_AUTHOR }<!-- ENDIF -->
-				<a href="{ $forummarks:U_LAST_POST }">{ $forummarks:LAST_POST_IMG }</a>
-			</p>
-		</td>
-		<!-- ENDIF -->
-			<!-- IF { $forummarks:U_MOVE_UP } || { $forummarks:U_MOVE_DOWN } -->
-			<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
-				<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
-				<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
-			<!-- ENDIF -->
-			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $forummarks:TOPIC_ID }" /> </td>
-		</tr>
-		<!-- LOOPELSE -->
-		<tr class="row1">
-			<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<tr>
-			<th colspan="5">{ $L_BOOKMARKS_SITE }</th>
-		</tr>
-	
-		<!-- LOOP $sitemarks -->
-	
-		<!-- IF { $sitemarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-			<td style="padding: 4px;" width="20" align="center" valign="middle">{$forummarks[sitemarksloop].TOPIC_FOLDER_IMG}</td>
-		<!-- IF { $forummarks[sitemarksloop].S_DELETED_TOPIC } -->
-			<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{$L_DELETED_TOPIC}</td>
-		<!-- ELSE -->
-			<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{$forummarks:U_VIEW_TOPIC}">{$forummarks:TOPIC_TITLE}</a></p><br /><span class="gensmall">{$L_FORUM}: <a href="{$forummarks:U_VIEW_FORUM}">{$forummarks:FORUM_NAME}</a></span></td>
-			<td class="postdetails" style="padding: 4px;" align="center" valign="top" nowrap="nowrap">{$L_POSTED}:<br />{$forummarks[sitemarksloop].POSTED_AT}</td>
-		<!-- ENDIF -->
-			<!-- IF { $forummarks[sitemarksloop].U_MOVE_UP } || { $forummarks[sitemarksloop].U_MOVE_DOWN } -->
-			<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
-				<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
-				<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
-			<!-- ENDIF -->
-			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $forummarks:TOPIC_ID }"/> </td>
-		</tr>
-		<!-- LOOPELSE -->
-		<tr class="row1">
-			<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
-		</tr>
-		<!-- ENDLOOP -->
-		<tr>
-			<td class="cat" colspan="5" align="right"><input class="button" type="submit" name="unbookmark" value="{$L_REMOVE_BOOKMARK_MARKED}" />&nbsp;</td>
-		</tr>
-		<!-- ENDIF -->
-	</table>
-</form>
-
-<!-- IF !{ $S_BOOKMARKS } --><div class="gensmall" style="float: right; padding-top: 2px;"><b><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div><!-- ENDIF -->
-<br />
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_drafts.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_drafts.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_drafts.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,113 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="4">{ $L_UCP }</th>
-	</tr>
-	<tr>
-		<td class="row3" colspan="4" align="center"><span class="genmed">{ $L_DRAFTS_EXPLAIN }</span></td>
-	</tr>
-
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row1" colspan="2" align="center"><span class="genmed" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-
-<!-- IF !{ $S_EDIT_DRAFT } -->
-
-	<!-- IF { $draftrow } -->
-	<tr>
-		<th>{ $L_SAVE_DATE }</th>
-		<th>{ $L_DRAFT_TITLE }</th>
-		<th>{ $L_OPTIONS }</th>
-		<th>{ $L_DELETE }</th>
-	</tr>
-	<!-- ENDIF -->
-
-	<!-- LOOP $draftrow -->
-	<tr>
-		<!-- IF { $draftrow:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-		<td class="postdetails" style="padding: 4px;" nowrap="nowrap">{ $draftrow:DATE }</td>
-		<td style="padding: 4px;" valign="top" width="100%">
-			<p class="topictitle">{ $draftrow:DRAFT_SUBJECT }</p>
-			<!-- IF { $draftrow:S_LINK_TOPIC } --><br /><span class="gensmall">{ $L_TOPIC }: <a href="{ $draftrow:U_VIEW }">{ $draftrow:TITLE }</a></span>
-			<!-- ELSEIF { $draftrow:S_LINK_FORUM } --><br /><span class="gensmall">{ $L_FORUM }: <a href="{ $draftrow:U_VIEW }">{ $draftrow:TITLE }</a></span>
-			<!-- ELSEIF { $draftrow:S_LINK_PM } --><br /><span class="gensmall">{ $L_PRIVATE_MESSAGE }</span>
-			<!-- ELSE --><br /><span class="gensmall">{ $L_NO_TOPIC_FORUM }</span><!-- ENDIF -->
-		</td>
-		<td style="padding: 4px;" align="center" nowrap="nowrap"><span class="genmed"><!-- IF { $draftrow:U_INSERT } --><a href="{ $draftrow:U_INSERT }">{ $L_LOAD_DRAFT }</a><br /><!-- ENDIF --><a href="{ $draftrow:U_VIEW_EDIT }">{ $L_VIEW_EDIT }</a></td>
-		<td style="padding: 4px;" align="center"><input type="checkbox" name="d[{ $draftrow:DRAFT_ID }]" /></td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr>
-		<td class="row1" colspan="4" height="25" align="center"><b class="genmed">{ $L_NO_SAVED_DRAFTS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
-
-	<!-- IF { $draftrow } -->
-	<tr>
-		<td class="cat" colspan="4" align="right"><input class="bottom" type="submit" name="delete" value="{ $L_DELETE_MARKED }" />&nbsp;</td>
-	</tr>
-	<!-- ENDIF -->
-
-<!-- ELSEIF { $S_EDIT_DRAFT } -->
-
-<!--
-	La la la
-	What to do here
--->
-	<tr>
-		<td class="row1" width="22%"><b class="genmed">{ $L_SUBJECT }:</b></td>
-		<td class="row2"><input class="post" style="width:450px" type="text" name="subject" size="45" maxlength="60" tabindex="2" value="{ $DRAFT_SUBJECT }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="22%"><b class="genmed">{ $L_MESSAGE }: </b><br /><span class="gensmall">{ $L_EDIT_DRAFT_EXPLAIN }</span></td>
-		<td class="row2"><table cellspacing="0" cellpadding="2" border="0">
-			<tr align="center" valign="middle">
-				<td><input class="btnbbcode" type="button" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="w" name="addbbcode18" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(18)" onmouseover="helpline('w')" /></td>
-			</tr>
-			<tr>
-				<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-					<tr>
-						<td><span class="genmed"> &nbsp;{ $L_FONT_SIZE }:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
-							<option value="7">{ $L_FONT_TINY }</option>
-							<option value="9">{ $L_FONT_SMALL }</option>
-							<option value="12" selected="selected">{ $L_FONT_NORMAL }</option>
-							<option value="18">{ $L_FONT_LARGE }</option>
-							<option value="24">{ $L_FONT_HUGE }</option>
-						</select></td>
-						<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')">{ $L_CLOSE_TAGS }</a></td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td colspan="9"><input class="helpline" type="text" name="helpbox" size="45" maxlength="100" value="{ $L_STYLES_TIP }" /></td>
-			</tr>
-			<tr>
-				<td colspan="9"><textarea class="post" name="message" rows="10" cols="76" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">{ $DRAFT_MESSAGE }</textarea></td>
-			</tr>
-		</table></td>
-	</tr>
-	<tr class="row1">
-		<td colspan="9" align="left"><p class="topictitle"><a href="{ $S_UCP_ACTION }">{ $L_BACK_TO_DRAFTS }</a></p></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="bottom" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-<!-- ENDIF -->
-</table>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_front.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_front.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_front.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,86 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="3">{ $L_UCP }</th>
-	</tr>
-	<tr>
-		<td class="row1" colspan="3" align="center"><p class="genmed">{ $L_UCP_WELCOME }</p></td>
-	</tr>
-	<tr>
-		<th colspan="3">{ $L_IMPORTANT_NEWS }</th>
-	</tr>
-
-	<!-- LOOP $topicrow -->
-
-	<!-- IF { $topicrow:#LOOP_INDEX } % 2 -->
-	<tr class="row1">
-	<!-- ELSE -->
-	<tr class="row2">
-	<!-- ENDIF -->
-		<td class="row1" width="25" align="center">{ $topicrow:TOPIC_FOLDER_IMG }</td>
-		<td class="row1" width="100%">
-			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a></p>
-			<p class="gensmall">{ $topicrow:GOTO_PAGE }</p>
-		</td>
-		<td class="row1" width="160" align="center" nowrap="nowrap">
-			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
-			<p class="topicdetails">
-			<!-- IF { $topicrow:U_LAST_POST_AUTHOR } -->
-				<a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a>
-			<!-- ELSE -->
-				{ $topicrow:LAST_POST_AUTHOR }
-			<!-- ENDIF -->
-			<a href="{ $forumrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>
-			</p>
-		</td>
-
-	</tr>
-	<!-- LOOPELSE -->
-	<tr class="row1">
-		<td align="center"><b class="gen">{ $L_NO_IMPORTANT_NEWS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
-	<tr>
-		<th colspan="3">{ $L_YOUR_DETAILS }</th>
-	</tr>
-	<tr>
-		<td class="row1" colspan="3"><table width="100%" cellspacing="1" cellpadding="4">
-			<tr> 
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_JOINED }: </b></td>
-				<td width="100%"><b class="gen">{ $JOINED }</b></td>
-			</tr>
-			<tr>
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_VISITED }: </b></td>
-				<td width="100%"><b class="gen">{ $VISITED }</b></td>
-			</tr>
-			<tr> 
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_TOTAL_POSTS }: </b></td>
-				<td><!-- IF { $POSTS_PCT } --><b class="gen">{ $POSTS }</b><br /><span class="genmed">[{ $POSTS_PCT } / { $POSTS_DAY }]<br /><a href="{ $U_SEARCH_USER }">{ $L_SEARCH_USER_POSTS }</a></span><!-- ELSE --><b class="gen">{ $POSTS }<b><!-- ENDIF --></td>
-			</tr>
-			<tr>
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_ACTIVE_IN_FORUM }: </b></td>
-				<td><!-- IF { $ACTIVE_FORUM_PCT } --><b><a class="gen" href="{ $U_ACTIVE_FORUM }">{ $ACTIVE_FORUM }</a></b><br /><span class="genmed">[ { $ACTIVE_FORUM_POSTS } / { $ACTIVE_FORUM_PCT } ]</span><!-- ELSE --><span class="gen">-</span><!-- ENDIF --></td>
-			</tr>
-			<tr>
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_ACTIVE_IN_TOPIC }: </b></td>
-				<td><!-- IF { $ACTIVE_TOPIC_PCT } --><b><a class="gen" href="{ $U_ACTIVE_TOPIC }">{ $ACTIVE_TOPIC }</a></b><br /><span class="gensmall">[ { $ACTIVE_TOPIC_POSTS } / { $ACTIVE_TOPIC_PCT } ]</span><!-- ELSE --><span class="gen">-</span><!-- ENDIF --></td>
-			</tr>
-			<!-- IF { $WARNINGS } -->
-			<tr>
-				<td align="right" valign="middle" nowrap="nowrap"><b class="genmed">{ $L_YOUR_WARNINGS }: </b></td>
-				<td class="genmed">[ <b>{ $WARNINGS }</b> ] { $WARNING_IMG }</td>
-			</tr>
-			<!-- ENDIF -->
-		</table></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="3">&nbsp;</td>
-	</tr>
-</table>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_subscribed.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_subscribed.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_main_subscribed.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,106 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<script language="javascript" type="text/javascript">
-<!--
-
-function marklist(form_name, status)
-{
-	for (i = 0; i < document.forms[form_name].length; i++)
-	{
-		document.forms[form_name].elements[i].checked = status;
-	}
-}
-
-//-->
-</script>
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="4">{ $L_UCP }</th>
-		</tr>
-		<tr>
-			<td class="row1" colspan="4" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
-		</tr>
-		<tr>
-			<th colspan="4">{ $L_WATCHED_FORUMS }</th>
-		</tr>
-		<!-- LOOP $forumrow -->
-	
-		<!-- IF { $forumrow:#LOOP_INDEX } % 2 -->
-		<tr class="row1">
-		<!-- ELSE -->
-		<tr class="row2">
-		<!-- ENDIF -->
-	
-			<td style="padding: 4px;" width="20" align="center" valign="middle">{ $forumrow:FORUM_FOLDER_IMG }</td>
-			<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></p></td>
-			<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap"><!-- IF { $forumrow:LAST_POST_TIME } -->{ $forumrow:LAST_POST_TIME }<br />
-			<!-- IF { $forumrow:U_LAST_POST_AUTHOR } --><a href="{$forumrow:U_LAST_POST_AUTHOR}">{ $forumrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forumrow:LAST_POST_AUTHOR }
-			<!-- ENDIF --> <a href="{ $forumrow:U_LAST_POST }">{ $forumrow:LAST_POST_IMG }</a><!-- ELSE -->{$L_NO_POSTS}<!-- ENDIF --></td>
-			<td style="padding: 4px;"> <input type="checkbox" name="f[]" value="{ $forumrow:FORUM_ID }" /> </td>
-		</tr>
-		<!-- LOOPELSE -->
-		<tr class="row1">
-			<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_FORUMS }</b></td>
-		</tr>
-		<!-- ENDLOOP -->
-		
-		<tr>
-			<th colspan="4">{ $L_WATCHED_TOPICS }</th>
-		</tr>
-		
-		<!-- IF { $TOTAL_TOPICS } -->
-		<tr>
-			<td class="row3" colspan="4">
-				<table width="100%" cellspacing="1">
-				<tr>
-					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]&nbsp;</td>
-					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-				</tr>
-				</table>
-			</td>
-		</tr>
-		<!-- ENDIF -->
-		
-		<!-- LOOP $topicrow -->
-	
-		<!-- IF { $topicrow:#LOOP_INDEX } % 2 -->
-		<tr class="row1">
-		<!-- ELSE -->
-		<tr class="row2">
-		<!-- ENDIF -->
-			<td style="padding: 4px;" width="20" align="center" valign="middle">{ $topicrow:TOPIC_FOLDER_IMG }</td>
-			<td style="padding: 4px;" width="100%" valign="middle">
-				<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a></p><br />
-				<!-- IF { $topicrow:PAGINATION } -->
-					<p class="gensmall"> [ { $GOTO_PAGE_IMG } { $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
-				<!-- ENDIF -->
-			<td style="padding: 4px;" align="center" valign="top" nowrap="nowrap">
-				<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
-				<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
-					<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>
-				</p>
-			</td>
-			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $topicrow:TOPIC_ID }" /> </td>
-		</tr>
-		<!-- LOOPELSE -->
-		<tr class="row1">
-			<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_TOPICS }</b></td>
-		</tr>
-		<!-- ENDLOOP -->
-	
-		<tr>
-			<td class="cat" colspan="4" align="right"><input class="button" type="submit" name="unwatch" value="{ $L_UNWATCH_MARKED }" />&nbsp;</td>
-		</tr>
-	</table>
-</form>
-
-<div class="gensmall" style="float: right; padding-top: 2px;"><b><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
-<br/>
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_history.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_history.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_history.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,68 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th align="center">{ $L_MESSAGE_HISTORY } - { $TITLE }</th>
-	</tr>
-	<tr>
-		<td class="row1"><div style="overflow: auto; width: 100%; height: 300px;">
-
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th width="22%">{ $L_AUTHOR }</th>
-					<th>{ $L_MESSAGE }</th>
-				</tr>
-				<!-- LOOP $history_row -->
-
-				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-					<td rowspan="2" align="left" valign="top"><a name="{ $history_row:U_POST_ID }"></a>
-						<table width="150" cellspacing="0">
-							<tr>
-								<td align="center" colspan="2"><b class="postauthor">{ $history_row:AUTHOR_NAME }</b></td>
-							</tr>
-						</table>
-					</td>
-
-					<td width="100%"{ if $history_row:S_CURRENT_MSG } style="background-color:lightblue"{ /if }>
-					<div class="gensmall" style="float:left"><b>{ $L_PM_SUBJECT }:</b>&nbsp;{ $history_row:SUBJECT }</div><div class="gensmall" style="float:right"><b>{$L_FOLDER}:</b>&nbsp;{$history_row:FOLDER}</div>
-					</td>
-				</tr>
-
-				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-					<td valign="top"><table width="100%" cellspacing="0">
-						<tr>
-							<td valign="top">
-								<table width="100%" cellspacing="0" cellpadding="2">
-									<tr>
-										<td><div id="message_{ $history_row:U_POST_ID }"><div class="postbody">{ $history_row:MESSAGE }</div></div></td>
-									</tr>
-								</table>
-							</td>
-						</tr>
-						<tr>
-							<td><table width="100%" cellspacing="0">
-								<tr valign="middle">
-									<td width="100%">&nbsp;</td>
-									<td width="10" nowrap="nowrap">{ $history_row:MINI_POST_IMG }</td>
-									<td class="gensmall" nowrap="nowrap"><b>{ $L_SENT_AT }:</b> { $history_row:SENT_DATE }</td>
-								</tr>
-							</table></td>
-						</tr>
-					</table></td>
-				</tr>
-
-				<!-- IF { $history_row:#LOOP_INDEX }  % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-					<td class="gensmall" align="center" height="28px"><a href="{ $history_row:U_VIEW_MESSAGE }">{ $L_VIEW_PM }</a></td>
-					<td><div class="gensmall" style="float:left">&nbsp;<!-- IF { $history_row:U_AUTHOR_PROFILE } --><a href="{ $history_row:U_AUTHOR_PROFILE }">{ $PROFILE_IMG }</a> <!-- ENDIF --><!-- IF { $history_row:U_EMAIL } --> <a href="{ $history_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF -->&nbsp;</div> <div class="gensmall" style="float:right"><!-- IF { $history_row:U_QUOTE } --><a href="{ $history_row:U_QUOTE }">{ $QUOTE_IMG }</a> <!-- ENDIF --><!-- IF { $history_row:U_POST_REPLY_PM } --> <a href="{ $history_row:U_POST_REPLY_PM }">{ $REPLY_IMG }</a><!-- ENDIF -->&nbsp;</div></td>
-				</tr>
-
-				<tr>
-					<td class="spacer" colspan="2"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
-				</tr>
-				<!-- ENDLOOP -->
-			</table>
-		</div></td>
-	</tr>
-</table>
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_footer.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_footer.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,35 +0,0 @@
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-	<tr>
-		<td class="row1"><table border="0" cellspacing="0" cellpadding="0" width="100%"><tr><td align="left">
-		<!-- IF { $TOTAL_MESSAGES } -->
-			<table width="100%" cellspacing="1">
-				<tr>
-					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;</td>
-					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-				</tr>
-			</table>
-		<!-- ENDIF -->
-		<!-- IF { $S_VIEW_MESSAGE } -->
-		<span class="gensmall">
-				<!-- IF { $U_PRINT_PM } --><a href="{ $U_PRINT_PM }" title="{ $L_PRINT_PM }">{ $L_PRINT_PM }</a><!-- IF { $U_EMAIL_PM } || { $U_FORWARD_PM } --> | <!-- ENDIF --><!-- ENDIF -->
-				<!-- IF { $U_EMAIL_PM } --><a href="{ $U_EMAIL_PM }" title="{ $L_EMAIL_PM }">{ $L_EMAIL_PM }</a><!-- IF { $U_FORWARD_PM } --> | <!-- ENDIF --><!-- ENDIF -->
-				<!-- IF { $U_FORWARD_PM } --><a href="{ $U_FORWARD_PM }" title="{ $L_FORWARD_PM }">{ $L_FORWARD_PM }</a><!-- ENDIF -->
-		</span>
-		<!-- ENDIF -->
-		</td>
-		<td align="right" nowrap="nowrap">
-		<!-- IF { $S_VIEW_MESSAGE } -->
-		<form name="movepm" method="post" action="{$S_PM_ACTION}" style="margin:0px">
-			<input type="hidden" name="marked_msg_id[]" value="{$MSG_ID}" />
-			<input type="hidden" name="cur_folder_id" value="{$CUR_FOLDER_ID}" />
-			<input type="hidden" name="p" value="{$MSG_ID}" />
-		<!-- ENDIF -->
-			<!-- IF !{ $S_UNREAD } -->
-				<select name="dest_folder">{ $S_TO_FOLDER_OPTIONS }</select>&nbsp;<input class="bottom" type="submit" name="move_pm" value="<!-- IF { $S_VIEW_MESSAGE } -->Place Message into Folder<!-- ELSE -->Place Marked into Folder<!-- ENDIF -->" />
-			<!-- ENDIF -->
-			</form>
-		</td></tr></table></td>
-	</tr>
-</table>
-<!-- IF !{ $S_VIEW_MESSAGE } --><div style="float:right"><b class="gensmall"><a href="javascript:marklist('viewfolder', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('viewfolder', false);">{ $L_UNMARK_ALL }</a></b></div><!-- ENDIF -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_message_header.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,51 +0,0 @@
-<script language="javascript" type="text/javascript">
-<!--
-function marklist(form_name, status)
-{
-	for (i = 0; i < document.forms[form_name].length; i++)
-	{
-		document.forms[form_name].elements[i].checked = status;
-	}
-}
-//-->
-</script>
-
-<table width="100%" cellspacing="1">
-	<tr>
-		<td class="gensmall" nowrap="nowrap" align="left">
-			<!-- IF { $S_UNREAD } --><b>{ $L_UNREAD_MESSAGES }</b><!-- ELSE -->{ $FOLDER_STATUS }<!-- ENDIF -->
-		<td class="gensmall" nowrap="nowrap" align="right"><!-- IF !{ $S_IN_INBOX } --><a href="{ $U_INBOX }">{ $L_PM_INBOX }</a><!-- ELSE --><b>{ $L_PM_INBOX }</b><!-- ENDIF -->&nbsp;|&nbsp;<!-- IF !{ $S_IN_OUTBOX } --><a href="{ $U_OUTBOX }">{ $L_PM_OUTBOX }</a><!-- ELSE --><b>{ $L_PM_OUTBOX }</b><!-- ENDIF -->&nbsp;|&nbsp;<!-- IF !{ $S_IN_SENTBOX } --><a href="{ $U_SENTBOX }">{ $L_PM_SENTBOX }</a><!-- ELSE --><b>{ $L_PM_SENTBOX }</b><!-- ENDIF -->&nbsp;|&nbsp;<a href="{ $U_CREATE_FOLDER }">{ $L_CREATE_FOLDER }</a></td>
-	</tr>
-</table>
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-	<tr>
-		<td class="row1">
-			<table border="0" cellspacing="0" cellpadding="0" width="100%">
-				<tr>
-					<td align="left">
-					<!-- IF { $TOTAL_MESSAGES } -->
-						<table width="100%" cellspacing="1">
-							<tr>
-								<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-								<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;</td>
-								<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-							</tr>
-						</table>
-					<!-- ENDIF -->
-					<!-- IF { $S_VIEW_MESSAGE } -->
-					<span class="gensmall">
-					<!-- IF { $S_DISPLAY_HISTORY } --><a href="{ $U_VIEW_PREVIOUS_HISTORY }">{ $L_VIEW_PREVIOUS_HISTORY }</a> | <a href="{ $U_VIEW_NEXT_HISTORY }">{ $L_VIEW_NEXT_HISTORY }</a> | <!-- ENDIF --><a href="{ $U_PREVIOUS_PM }">{ $L_VIEW_PREVIOUS_PM }</a> | <a href="{ $U_NEXT_PM }">{ $L_VIEW_NEXT_PM }</a>&nbsp;
-					</span>
-					<!-- ENDIF -->
-					</td>
-					<td align="right" nowrap="nowrap">
-						<form name="choosefolder" method="post" action="{ $S_FOLDER_ACTION }" style="margin:0px">
-							<select name="f">{ $S_FOLDER_OPTIONS }</select>&nbsp;<input class="bottom" type="submit" name="folder" value="{ $L_GO }" />
-						</form>
-					</td>
-				</tr>
-			</table>
-		</td>
-	</tr>
-</table>
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_options.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_options.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,190 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<!-- IF { $ERROR_MESSAGE } || { $NOTIFICATION_MESSAGE } -->
-	<table border="0" cellspacing="0" cellpadding="0" width="100%">
-		<tr>
-			<td class="row3" align="center">
-				<!-- IF { $ERROR_MESSAGE } --><span class="genmed" style="color:red">{ $ERROR_MESSAGE }</span><!-- ENDIF -->
-				<!-- IF { $NOTIFICATION_MESSAGE } --><span class="genmed" style="color:red">{ $NOTIFICATION_MESSAGE }</span><!-- ENDIF -->
-			</td>
-		</tr>
-	</table>
-	<div style="padding: 2px;"></div>
-<!-- ENDIF -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }">
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="3">{ $L_ADD_NEW_RULE }</th>
-	</tr>
-	<!-- IF { $S_CHECK_DEFINED } -->
-	<tr>
-		<td class="row1" width="50" align="left" valign="top"><b class="gen">{ $L_IF }:</b></td>
-		<td class="row2" align="center" valign="top"><!-- IF { $S_CHECK_SELECT } --><select name="check_option">{ $S_CHECK_OPTIONS }</select><!-- ELSE --><b class="gen">{ $CHECK_CURRENT }</b><input type="hidden" name="check_option" value="{ $CHECK_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_CHECK_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- IF { $S_RULE_DEFINED } -->
-	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="back[rule]" value="{ $L_PREVIOUS }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-		<td class="row2" align="center" valign="top"><!-- IF { $S_RULE_SELECT } --><select name="rule_option">{ $S_RULE_OPTIONS }</select><!-- ELSE --><b class="gen">{ $RULE_CURRENT }</b><input type="hidden" name="rule_option" value="{ $RULE_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-	</tr>
-	<!-- ENDIF -->
-	
-	<!-- IF { $S_COND_DEFINED } -->
-	<!-- IF { $S_COND_SELECT } || { $COND_CURRENT } -->
-	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="back[cond]" value="{ $L_PREVIOUS }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-		<td class="row2" align="center" valign="top">
-		<!-- IF { $S_COND_SELECT } -->
-			<!-- IF { $S_TEXT_CONDITION } -->
-				<input type="text" name="rule_string" value="{$CURRENT_STRING}" size="30" maxlength="250" class="post" />
-			<!-- ELSEIF { $S_USER_CONDITION } -->
-				<input type="text" class="post" name="rule_string" value="{$CURRENT_STRING}" maxlength="50" size="20" />&nbsp;<span class="gensmall">[ <a href="{ $U_FIND_USERNAME }" onclick="window.open('{ $U_FIND_USERNAME }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;">{ $L_FIND_USERNAME }</a> ]</span>
-			<!-- ELSEIF { $S_GROUP_CONDITION } -->
-				<input type="hidden" name="rule_string" value="{ $CURRENT_STRING }" /><!-- IF { $S_GROUP_OPTIONS } --><select name="rule_group_id">{ $S_GROUP_OPTIONS }</select><!-- ELSE -->{ $L_NO_GROUPS }<!-- ENDIF -->
-			<!-- ENDIF -->
-		<!-- ELSE -->
-			<b class="gen">{ $COND_CURRENT }</b>
-				<input type="hidden" name="rule_string" value="{ $CURRENT_STRING }" /><input type="hidden" name="rule_user_id" value="{ $CURRENT_USER_ID }" /><input type="hidden" name="rule_group_id" value="{ $CURRENT_GROUP_ID }" />
-		<!-- ENDIF -->
-		</td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="next" value="{$L_NEXT}" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-	</tr>
-	<!-- ENDIF -->
-	<input type="hidden" name="cond_option" value="{ $COND_OPTION }" />
-	<!-- ENDIF -->
-	<!-- IF { $NONE_CONDITION } --><input type="hidden" name="cond_option" value="none" /><!-- ENDIF -->
-
-	<!-- IF { $S_ACTION_DEFINED } -->
-	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="back[action]" value="{$L_PREVIOUS}" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-		<td class="row2" align="center" valign="top"><!-- IF { $S_ACTION_SELECT } --><select name="action_option">{ $S_ACTION_OPTIONS }</select><!-- ELSE --><b class="gen">{ $ACTION_CURRENT }</b><input type="hidden" name="action_option" value="{ $ACTION_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="add_rule" value="{ $L_ADD_RULE }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
-	</tr>
-	<!-- ENDIF -->
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="6">{ $L_DEFINED_RULES }</th>
-	</tr>
-	<!-- LOOP $rule -->
-	<tr>
-		<td class="row1" width="25" align="center"><span class="gen">{$smarty.section.ruleloop.rownum}</span></td>
-		<td class="row2" width="120"><span class="gen">{ $rule:CHECK }</span></td>
-		<td class="row1" width="120"><span class="gen">{ $rule:RULE }</span></td>
-		<td class="row2" width="120"><span class="gen"><!-- IF { $rule:STRING } -->{ $rule:STRING} <!-- ENDIF --></span></td>
-		<td class="row1"><span class="gen">{ $rule:ACTION }<!-- IF { $rule:FOLDER }  --> { $rule:FOLDER }<!-- ENDIF --></span></td>
-		<td class="row2" width="25"><input type="submit" name="delete_rule[{ $rule:RULE_ID }]" value="{ $L_DELETE_RULE }" class="button" /></td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr>
-		<td colspan="6" class="row3" align="center"><span class="gen">{ $L_NO_RULES_DEFINED }</span></td>
-	</tr>
-	<!-- ENDLOOP -->
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2">{ $L_ADD_FOLDER }</th>
-	</tr>
-	<!-- IF { $S_MAX_FOLDER_REACHED } -->
-	<tr>
-		<td colspan="2">{ $L_MAX_FOLDER_REACHED }</td>
-	</tr>
-	<!-- ELSE -->
-	<tr>
-		<td class="row1" width="200"><b class="gen">{ $L_ADD_FOLDER }: </b></td>
-		<td class="row1"><input type="text" class="post" name="foldername" size="30" maxlength="30" /></td>
-	</tr>
-	<tr>
-		<td class="row1" align="right" colspan="2"><input class="button" style="width:150px" type="submit" name="addfolder" value="{ $L_ADD }" /></td>
-	</tr>
-	<!-- ENDIF -->
-</table>
-
-<div style="padding: 2px;"></div>
-
-<!-- IF { $S_FOLDER_OPTIONS } -->
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2">{ $L_RENAME_FOLDER }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="200"><b class="gen">{ $L_RENAME_FOLDER }: </b></td>
-		<td class="row1"><select name="rename_folder_id">{ $S_FOLDER_OPTIONS }</select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="200"><b class="gen">{ $L_NEW_FOLDER_NAME }: </b></td>
-		<td class="row1"><input type="text" class="post" name="new_folder_name" size="30" maxlength="30" /></td>
-	</tr>
-	<tr>
-		<td class="row1" align="right" colspan="2"><input class="button" style="width:150px" type="submit" name="rename_folder" value="{ $L_RENAME }" /></td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="3">{ $L_REMOVE_FOLDER }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="200"><b class="gen">{ $L_REMOVE_FOLDER }: </b></td>
-		<td class="row1"><select name="remove_folder_id">{ $S_FOLDER_OPTIONS }</select></td>
-		<td class="row1"><b class="genmed">{ $L_AND }</b></td>
-	</tr>
-	<tr>
-		<td class="row2" width="200">&nbsp;</td>
-		<td class="row2" colspan="2"><input type="radio" name="remove_action" value="1" checked="checked" />&nbsp;<span class="genmed">Move messages from removed folder to </span>&nbsp;<select name="move_to">{ $S_TO_FOLDER_OPTIONS }</select></td>
-	</tr>
-	<tr>
-		<td class="row2" width="200">&nbsp;</td>
-		<td class="row2" colspan="2"><input type="radio" name="remove_action" value="2" />&nbsp;<span class="genmed">Delete all messages within removed folder</span></td>
-	</tr>
-	<tr>
-		<td class="row2" width="200">&nbsp;</td>
-		<td class="row2" colspan="2" align="right"><input class="button" style="width:150px" type="submit" name="remove_folder" value="{ $L_REMOVE }" /></td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-<!-- ENDIF -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2">{ $L_FOLDER_OPTIONS }</th>
-	</tr>
-	<tr>
-		<td class="row1" width="200"><b class="genmed">{ $L_IF_FOLDER_FULL }: </b></span></td>
-		<td class="row1"><input type="radio" name="full_action" value="1"{ $S_DELETE_CHECKED } />&nbsp;<span class="genmed">{ $L_DELETE_OLDEST_MESSAGES }</span></td>
-	</tr>
-	<tr>
-		<td class="row1" width="200">&nbsp;</td>
-		<td class="row1"><input type="radio" name="full_action" value="2"{ $S_MOVE_CHECKED } />&nbsp;<span class="genmed">{ $L_MOVE_TO_FOLDER }: </span><select name="full_move_to">{ $S_FULL_FOLDER_OPTIONS }</select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="200">&nbsp;</td>
-		<td class="row1"><input type="radio" name="full_action" value="3"{$S_HOLD_CHECKED} />&nbsp;<span class="genmed">{$L_HOLD_NEW_MESSAGES}</span></td>
-	</tr>
-	<tr>
-		<td class="row2" width="200"><b class="genmed">{ $L_DEFAULT_ACTION }: </b><br /><span class="gensmall">{ $L_DEFAULT_ACTION_EXPLAIN }</span></td>
-		<td class="row2"><span class="genmed">{ $DEFAULT_ACTION }</span></td>
-	</tr>
-	<tr>
-		<td class="row1" colspan="2" align="right"><input class="button" style="width:150px" type="submit" name="fullfolder" value="{ $L_CHANGE }" /></td>
-	</tr>
-</table>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_popup.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_popup.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_popup.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,45 +0,0 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<head>
-	<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-	<meta http-equiv="expires" content="0" />
-	<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
-</head>
-<html>
-	<body>
-
-	<script language="javascript" type="text/javascript">
-	<!--
-	function jump_to_inbox()
-	{
-		opener.document.location.href = "{ $U_JS_RETURN_INBOX }";
-		window.close();
-	}
-	//-->
-	</script>
-
-	{ $THEME_TABLE_OPEN }
-
-	<table width="100%" border="0" cellspacing="0" cellpadding="10">
-		<tr>
-			<td>
-				<table width="100%" border="0" cellspacing="1" cellpadding="4" class="tablebg">
-				<tr class="row1">
-					<td valign="top" align="center">
-						<br /><span class="gen">
-						<!-- IF { $S_NOT_LOGGED_IN } -->
-							{ $L_LOGIN_CHECK_PM }
-						<!-- ELSE -->
-							{ $MESSAGE }<br /><br />{ $CLICK_TO_VIEW }
-						<!-- ENDIF -->
-						</span>
-						<br /><br /><span class="genmed"><a href="javascript:window.close();">{ $L_CLOSE_WINDOW }</a></span><br /><br /></td>
-				</tr>
-				</table>
-			</td>
-		</tr>
-	</table>
-	
-	{ $THEME_TABLE_CLOSE }
-
-	</body>
-</html>
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewfolder.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewfolder.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewfolder.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,90 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_pm_message_header.html -->
-
-	<div style="padding: 2px;"></div>
-
-<!-- IF { $S_PM_ICONS } && { $S_UNREAD } -->
-	<!-- DEFINE COLSPAN = 7 -->
-<!-- ELSEIF !{ $S_PM_ICONS } && !{ $S_UNREAD } -->
-	<!-- DEFINE COLSPAN = 5 -->
-<!-- ELSE -->
-	<!-- DEFINE COLSPAN = 6 -->
-<!-- ENDIF -->
-
-<form name="viewfolder" method="post" action="{ $S_PM_ACTION }" style="margin:0px">
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0" border="0">
-<!-- IF { $NUM_NOT_MOVED } -->
-	<tr>
-		<td class="row3" colspan="{ #COLSPAN }" align="center"><span class="gen">{ $NOT_MOVED_MESSAGES }<br />{ $RELEASE_MESSAGE_INFO }</span></td>
-	</tr>
-<!-- ENDIF -->
-	<tr>
-		<th colspan="<!-- IF { $S_PM_ICONS } -->3<!-- ELSE -->2<!-- ENDIF -->">&nbsp;{ $L_SUBJECT }&nbsp;</th>
-		<!-- IF { $S_UNREAD } -->
-			<th>&nbsp;<!-- IF { $S_SHOW_RECIPIENTS } -->{ $L_RECIPIENTS }<!-- ELSE -->{ $L_AUTHOR }<!-- ENDIF -->&nbsp;</th>
-			<th>&nbsp;{ $L_FOLDER }&nbsp;</th>
-		<!-- ELSE -->
-			<th>&nbsp;<!-- IF { $S_SHOW_RECIPIENTS } -->{ $L_RECIPIENTS }<!-- ELSE -->{ $L_AUTHOR }<!-- ENDIF -->&nbsp;</th>
-		<!-- ENDIF -->
-		<th>&nbsp;{ $L_SENT_AT }&nbsp;</th>
-		<th>&nbsp;{ $L_MARK }&nbsp;</th>
-	</tr>
-	
-	<!-- LOOP $messagerow -->
-	<tr>
-		<td class="row1" width="25" align="center" nowrap="nowrap">{ $messagerow:FOLDER_IMG }</td>
-		<!-- IF { $S_PM_ICONS } -->
-			<td class="row1" width="25" align="center">{ $messagerow:PM_ICON_IMG }</td>
-		<!-- ENDIF -->
-		<!-- IF { $messagerow:S_PM_DELETED } --><td class="row3"><!-- ELSE --><td class="row1"><!-- ENDIF -->
-			<!-- IF { $messagerow:S_PM_REPORTED } -->
-				<a href="{$messagerow:U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
-			<!-- ENDIF -->
-			<!-- IF { $messagerow:PM_IMG } -->
-				{ $messagerow:PM_IMG }&nbsp;
-			<!-- ELSEIF { $messagerow:PM_CLASS } -->
-				<span class="{ $messagerow:PM_CLASS }"><img src="images/spacer.gif" width="10" height="10" alt="" border="0" /></span>&nbsp;
-			<!-- ENDIF -->
-			<p class="topictitle">
-				{ $messagerow:ATTACH_ICON_IMG } 
-				
-				<!-- IF { $messagerow:S_PM_DELETED } -->
-					{ $L_MESSAGE_REMOVED_FROM_OUTBOX }<br />
-					<a href="{ $messagerow:U_REMOVE_PM}" style="float:right;">{ $L_DELETE_MESSAGE }</a>
-				<!-- ELSE -->
-					<a href="{ $messagerow:U_VIEW_PM }">{ $messagerow:SUBJECT }</a>
-				<!-- ENDIF -->
-				
-			</p></td>
-		<td class="row1" width="100" align="center"><p class="topicauthor"><!-- IF { $S_SHOW_RECIPIENTS } -->{ $messagerow:RECIPIENTS }<!-- ELSE -->{$messagerow:MESSAGE_AUTHOR}<!-- ENDIF --></p></td>
-		<!-- IF { $S_UNREAD } -->
-			<td class="row1" width="100" align="center"><p class="topicauthor"><!-- IF { $messagerow:FOLDER } --><a href="{ $messagerow:U_FOLDER }">{ $messagerow:FOLDER }</a><!-- ELSE -->{ $L_UNKNOWN_FOLDER }<!-- ENDIF --></p></td>
-		<!-- ENDIF -->
-		<td class="row1" width="120" align="center"><p class="topicdetails">{ $messagerow:SENT_TIME }</p></td>
-		<td class="row1" width="20" align="center"><p class="topicdetails"><input type="checkbox" name="marked_msg_id[]" value="{ $messagerow:MESSAGE_ID }" /></p></td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr>
-		<td class="row1" colspan="{ #COLSPAN }" height="30" align="center" valign="middle"><span class="gen">{ $L_NO_MESSAGES }</span></td>
-	</tr>
-	<!-- ENDLOOP -->
-	
-	<input type="hidden" name="cur_folder_id" value="{ $CUR_FOLDER_ID }" />
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" border="0" cellspacing="1" cellpadding="0" width="100%">
-	<tr>
-		<td class="cat" align="left"><span class="gensmall">{ $L_DISPLAY_MESSAGES }:</span> { $S_SELECT_SORT_DAYS } <span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR } <input class="bottom" type="submit" name="sort" value="{ $L_GO }" /></td>
-		<td class="cat" align="right"><select name="mark_option">{ $S_MARK_OPTIONS }</select>&nbsp;<input class="bottom" type="submit" name="submit_mark" value="{$L_GO}" />&nbsp;</td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-<!-- INCLUDE modules/Control_Panel/ucp_pm_message_footer.html -->
-<br clear="all" />
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,156 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_pm_message_header.html -->
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
-
-	<tr class="row1">
-		<td class="genmed" nowrap="nowrap" width="150"><b>{ $L_PM_SUBJECT }:</b></td>
-		<td class="gen">{ $SUBJECT }</td>
-	</tr>
-
-	<tr class="row1">
-		<td class="genmed" nowrap="nowrap" width="150"><b>{ $L_PM_FROM }:</b></td>
-		<td class="gen"><a href="{$U_AUTHOR_PROFILE}">{ $AUTHOR_NAME }</a></td>
-	</tr>
-
-	<tr class="row1">
-		<td class="genmed" nowrap="nowrap" width="150"><b>{ $L_SENT_AT }:</b></td>
-		<td class="gen">{ $SENT_DATE }</td>
-	</tr>
-
-	<!-- IF { $S_TO_RECIPIENT } -->
-	<tr class="row1">
-		<td class="genmed" nowrap="nowrap" width="150"><b>{ $L_TO }:</b></td>
-		<td class="gen">
-		<!-- LOOP $to_recipient -->
-			<a href="{ $to_recipient:U_VIEW }"><!-- IF { $to_recipient:COLOUR } --><span style="color:#{ $to_recipient:COLOUR }"><!-- ELSE --><span<!-- IF { $to_recipient:IS_GROUP} --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $to_recipient:NAME }</span></a>&nbsp;
-		<!-- ENDLOOP $to_recipient -->
-		</td>
-	</tr>
-	<!-- ENDIF -->
-
-	<!-- IF { $S_BCC_RECIPIENT } -->
-	<tr class="row1">
-		<td class="genmed" nowrap="nowrap" width="150"><b>{ $L_BCC }:</b></td>
-		<td class="gen">
-		<!-- LOOP $bcc_recipient -->
-			<a href="{ $bcc_recipient:U_VIEW }"><!-- IF { $bcc_recipient:COLOUR } --><span style="color:#{ $bcc_recipient:COLOUR }"><!-- ELSE --><span<!-- IF { $bcc_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $bcc_recipient:NAME }</span></a>&nbsp;
-		<!-- ENDLOOP $bcc_recipient -->
-		</td>
-	</tr>
-	<!-- ENDIF -->
-</table>
-
-<div style="padding: 2px;"></div>
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-
-	<tr>
-		<th nowrap="nowrap">{ $L_MESSAGE }</th>
-	</tr>
-
-	<tr>
-		<td class="spacer" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
-	</tr>
-
-	<tr class="row1">
-		<td valign="top"><table width="100%" cellspacing="5">
-			<tr>
-				<td>
-
-					<!-- IF { $S_MESSAGE_REPORTED } -->
-					<table width="100%" cellspacing="0">
-						<tr>
-							<td class="gensmall"><b class="postreported">&#187 <a class="postreported" href="{ $U_MCP_REPORT }">{ $L_MESSAGE_REPORTED }</a></b></td>
-						</tr>
-					</table>
-
-					<br clear="all" />
-					<!-- ENDIF -->
-
-					<div class="postbody">{ $MESSAGE }</div>
-
-					<!-- IF { $S_HAS_ATTACHMENTS } -->
-					<br clear="all" /><br />
-							
-					<table class="tablebg" width="100%" cellspacing="1">
-						<tr>
-							<td class="row3"><b class="genmed">{ $L_ATTACHMENTS }: </b></td>
-						</tr>
-						<!-- LOOP $attachment -->
-						<tr>
-							<td class="row2">
-							<!-- IF { $attachment:category } == 'DENIED' -->
-								<span class="postbody">[ { $attachment:lang }]</span><br /><br />
-							<!-- ELSEIF { $attachment:category } == 'IMAGE' -->
-								<!-- IF { $attachment:comment } -->
-								<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
-								<!-- ENDIF --><img src="{ $attachment:image_src }" alt="{ $attachment:name }" /></span>
-								<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
-							<!-- ELSEIF { $attachment:category } == 'THUMBNAIL' -->
-								<!-- IF { $attachment:comment } -->
-								<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
-								<!-- ENDIF -->		<a href="{ $attachment:link }" target="_blank"><img src="{ $attachment:image_src }" alt="{ $attachment:name }" border="0" /></a></span>
-								<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
-							<!-- ELSE -->
-								<!-- IF { $attachment:comment } -->
-								<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $attachment:comment }</span><hr />
-								<!-- ENDIF -->
-								<!-- IF { $attachment:icon } --><img src="{ $attachment:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $attachment:link }" target="_blank">{ $attachment:name }</a>
-								<span class="gensmall">
-								<br />{ $L_FILESIZE } { $attachment:lang_size }
-								<br />{ $L_DOWNLOADED } { $attachment:lang_views }
-								</span>
-							<!-- ENDIF -->
-							</td>
-						</tr>
-						<!-- ENDLOOP -->
-					</table>
-					<!-- ENDIF -->
-
-					<!-- IF { $S_DISPLAY_NOTICE } -->
-						<span class="gensmall" style="color:red;"><br /><br />{ $L_DOWNLOAD_NOTICE }</span>
-					<!-- ENDIF -->
-					<!-- IF { $SIGNATURE } -->
-						<span class="postbody"><br />_________________<br />{ $SIGNATURE }</span>
-					<!-- ENDIF -->
-					<!-- IF { $EDITED_MESSAGE } -->
-						<span class="gensmall">{ $EDITED_MESSAGE }</span>
-					<!-- ENDIF -->
-
-					<!-- IF !{ $S_HAS_ATTACHMENTS } --><br clear="all" /><br /><!-- ENDIF -->
-
-					<table width="100%" cellspacing="0">
-						<tr valign="middle">
-							<td class="gensmall" align="right"><!-- IF { $U_REPORT } --><a href="{ $U_REPORT }">{ $REPORT_IMG }</a> <!-- ENDIF --> <!-- IF { $U_INFO } --><a href="{ $U_INFO }">{ $INFO_IMG }</a> <!-- ENDIF --><!-- IF { $U_DELETE } --> <a href="{ $U_DELETE }">{ $DELETE_IMG }</a> <!-- ENDIF --></td>
-						</tr>
-					</table>
-
-				</td>
-			</tr>
-		</table>
-		</td>
-	</tr>
-	
-	<tr class="row1">
-		<td><div class="gensmall" style="float:left">&nbsp;<!-- IF { $U_AUTHOR_PROFILE } --><a href="{ $U_AUTHOR_PROFILE }">{ $PROFILE_IMG }</a> <!-- ENDIF --> <!-- IF { $U_EMAIL } --><a href="{ $U_EMAIL }">{ $EMAIL_IMG }</a> <!-- ENDIF -->&nbsp;</div> <div class="gensmall" style="float:right">
-		<!-- IF { $U_QUOTE } --><a href="{ $U_QUOTE }">{ $QUOTE_IMG }</a><!-- ENDIF --><!-- IF { $U_POST_REPLY_PM } --> <a href="{ $U_POST_REPLY_PM }">{ $REPLY_IMG }</a><!-- ENDIF --> <!-- IF { $U_EDIT } --><a href="{ $U_EDIT }">{ $EDIT_IMG }</a> <!-- ENDIF -->&nbsp;</div></td>
-	</tr>
-
-	<tr>
-		<td class="spacer" height="1"><img src="images/spacer.gif" alt="" width="1" height="1" /></td>
-	</tr>
-</table>
-
-<div style="padding: 2px;"></div>
-
-<!-- INCLUDE modules/Control_Panel/ucp_pm_message_footer.html -->
-
-<!-- IF { $S_DISPLAY_HISTORY } -->
-	<br clear="all" />
-	<!-- INCLUDE modules/Control_Panel/ucp_pm_history.html -->
-<!-- ENDIF -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage_print.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewmessage_print.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_pm_viewmessage_print.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,127 +0,0 @@
-<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
-<html dir="{ $S_CONTENT_DIRECTION }">
-<head>
-<meta http-equiv="Content-Type" content="text/html; charset={ $S_CONTENT_ENCODING }">
-<meta http-equiv="Content-Style-Type" content="text/css">
-<title>{ $SITENAME } :: { $PAGE_TITLE }</title>
-<style type="text/css">
-<!--
-body {
-    font-family:	Verdana,serif;
-    font-size:		10pt;
-}
-
-td {
-	font-family:	Verdana,serif;
-	font-size:		10pt;
-	line-height:	150%;
-}
-
-.code, .quote {
-    font-size:	smaller;
-	border:		black solid 1px;
-}
-
-.forum {
-	font-family:	Arial,Helvetica,sans-serif;
-    font-weight:	bold;
-    font-size:		18pt;
-}
-
-.topic {
-	font-family:	Arial,Helvetica,sans-serif;
-    font-size:		14pt;
-	font-weight:	bold;
-}
-
-.gensmall {
-	font-size: 8pt;
-}
-
-hr {
-	color:			#888888;
-	height:			3px;
-	border-style:	solid;
-}
-
-hr.sep	{$
-	color:			#AAAAAA;
-	height:			1px;
-	border-style:	dashed;
-}
--->
-</style>
-</head>
-<body>
-
-<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
-	<tr>
-		<td colspan="2" align="center"><span class="Forum">{ $SITENAME }</span><br /><span class="gensmall">{ $L_PRIVATE_MESSAGING }</a></span></td>
-	</tr>
-	<tr>
-		<td colspan="2"><br /></td>
-	</tr>
-	<tr>
-		<td><span class="Topic">{ $SUBJECT }</span><br /></td>
-		<td align="right" valign="bottom"><span class="gensmall">{ $PAGE_NUMBER }</span></td>
-	</tr>
-</table>
-
-
-<hr width="85%" />
-
-<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
-	<tr>
-		<td width="10%" nowrap="nowrap">{ $L_PM_FROM }:&nbsp;</td>
-		<td><b>{ $AUTHOR_NAME }</b> [ { $SENT_DATE } ]</td>
-	</tr>
-	<!-- IF { $S_TO_RECIPIENT } -->
-	<tr>
-		<td width="10%" nowrap="nowrap">{$L_TO}:</td>
-		<td>
-		<!-- LOOP $to_recipient -->
-			<!-- IF { $to_recipient:COLOUR } --><span style="color:#{$to_recipient:COLOUR}">{ else }<span<!-- IF { $to_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $to_recipient:NAME }</span>&nbsp;
-		<!-- ENDLOOP -->
-		</td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- IF { $S_BCC_RECIPIENT } -->
-	<tr>
-		<td width="10%" nowrap="nowrap">{ $L_BCC }:</td>
-		<td>
-		<!-- LOOP $bcc_recipient -->
-			<!-- IF { $bcc_recipient:COLOUR } --><span style="color:#{$bcc_recipient:COLOUR}">{ else }<span<<!-- IF { $bcc_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $bcc_recipient:NAME }</span>&nbsp;
-		<!-- ENDLOOP -->
-		</td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td colspan="2"><hr class="sep" />{ $MESSAGE }</td>
-	</tr>
-</table>
-
-<hr width="85%" />
-
-<!--
-	We request you retain the full copyright notice below including the link to www.phpbb.com.
-	This not only gives respect to the large amount of time given freely by the developers
-	but also helps build interest, traffic and use of phpBB2. If you (honestly) cannot retain
-	the full copyright we ask you at least leave in place the "Powered by phpBB {$PHPBB_VERSION}"
-	line, with phpBB linked to www.phpbb.com. If you refuse to include even this then support on
-	our forums may be affected.
-
-	The phpBB Group : 2002
--->
-
-<table width="85%" cellspacing="3" cellpadding="0" border="0" align="center">
-	<tr>
-		<td><span class="gensmall">{ $PAGE_NUMBER }</span></td>
-		<td align="right"><span class="gensmall">{ $S_TIMEZONE }</span></td>
-	</tr>
-	<tr>
-		<td colspan="2" align="center"><span class="gensmall">Powered by phpBB { $PHPBB_VERSION } &copy; 2002 phpBB Group<br />http://www.phpbb.com/</span></td>
-	</tr>
-</table>
-
-</body>
-</html>
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_attach_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_posting_attach_body.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_attach_body.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,55 +0,0 @@
-
-	<tr>
-		<th colspan="2" height="28">{ $L_ADD_ATTACHMENT }</th>
-	</tr>
-	<tr>
-		<td class="row3" colspan="2"><span class="gensmall">{ $L_ADD_ATTACHMENT_EXPLAIN }</span></td>
-	</tr>
-
-	<tr> 
-		<td class="row1"><b class="genmed">{ $L_FILENAME }</b></td> 
-	    <td class="row2"><input type="file" name="fileupload" size="40" maxlength="{ $FILESIZE }" value="{ $FILENAME }" class="button" /></td> 
-	</tr> 
-	<tr> 
-		<td class="row1"><b class="genmed">{ $L_FILE_COMMENT }</b></td> 
-		<td class="row2"><table border="0" cellspacing="0" cellpadding="2">
-			<tr>
-				<td><textarea class="post" name="filecomment" rows="3" cols="35" wrap="virtual" size="40">{ $FILE_COMMENT }</textarea>&nbsp;</td>
-				<td valign="top"><table border="0" cellspacing="4" cellpadding="0">
-					<tr>
-						<td><input class="button" type="submit" style="width:150px" name="add_file" value="{ $L_ADD_FILE }" /></td>
-					</tr></table>
-				</td>
-			</tr></table>
-		</td>
-	</tr> 
-
-	<!-- IF { $S_HAS_ATTACHMENTS } -->
-	<tr>
-		<th colspan="2" height="28">{ $L_POSTED_ATTACHMENTS }</th>
-	</tr>
-
-		<!-- LOOP $attach_row -->
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_FILENAME }</b></td>
-			<td class="row2"><a class="genmed" href="{ $attach_row:U_VIEW_ATTACHMENT }" target="_blank">{ $attach_row:FILENAME }</a></td> 
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_FILE_COMMENT }</b></td> 
-			<td class="row2"><table border="0" cellspacing="0" cellpadding="2">
-				<tr>
-					<td><textarea class="post" name="comment_list[{ $attach_row:ASSOC_INDEX }]" rows="3" cols="35" wrap="virtual" size="40">{ $attach_row:FILE_COMMENT }</textarea>&nbsp;</td>
-					<td valign="top"><table border="0" cellspacing="4" cellpadding="0">
-						<tr>
-							<td><input class="button" type="submit" style="width:150px" name="edit_comment[{ $attach_row:ASSOC_INDEX }]" value="{ $L_UPDATE_COMMENT }" /></td>
-						</tr>
-						<tr>
-							<td><input class="button" type="submit" style="width:150px" name="delete_file[{ $attach_row:ASSOC_INDEX }]" value="{ $L_DELETE_FILE }" /></td>
-						</tr></table>
-					</td>
-				</tr></table>
-			</td>
-		</tr>
-		{ $attach_row:S_HIDDEN }	
-		<!-- ENDLOOP -->
-	<!-- ENDIF -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_posting_body.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_body.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,295 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-<script language="javascript" type="text/javascript">
-<!--
-
-var form_name = 'post';
-var text_name = 'message';
-
-// Define the bbCode tags
-bbcode = new Array();
-bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]','[php]','[/php]');
-imageTag = false;
-
-// Helpline messages
-b_help = "{ $L_BBCODE_B_HELP }";
-i_help = "{ $L_BBCODE_I_HELP }";
-u_help = "{ $L_BBCODE_U_HELP }";
-q_help = "{ $L_BBCODE_Q_HELP }";
-c_help = "{ $L_BBCODE_C_HELP }";
-l_help = "{ $L_BBCODE_L_HELP }";
-o_help = "{ $L_BBCODE_O_HELP }";
-p_help = "{ $L_BBCODE_P_HELP }";
-w_help = "{ $L_BBCODE_W_HELP }";
-a_help = "{ $L_BBCODE_A_HELP }";
-s_help = "{ $L_BBCODE_S_HELP }";
-f_help = "{ $L_BBCODE_F_HELP }";
-e_help = "{ $L_BBCODE_E_HELP }";
-z_help = "{ $L_BBCODE_Z_HELP }";
-
-function checkForm()
-{
-	if (document.post.message.value.length < 6) {
-		alert('{ $L_EMPTY_MESSAGE }');
-		return false;
-	} else {
-//		document.post.post.disabled = true;
-		return true;
-	}
-}
-
-//-->
-</script>
-<script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
-
-<form action="{ $S_POST_ACTION }" method="post" name="post" { $S_FORM_ENCTYPE }>
-
-<!-- IF { $S_DRAFT_LOADED } -->
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th align="center">{ $L_INFORMATION }</th>
-		</tr>
-		<tr>
-			<td class="row1" align="center"><span class="gen">{ $L_DRAFT_LOADED }</span></td>
-		</tr>
-	</table>
-
-	<br clear="all" />
-<!-- ENDIF -->
-
-<!-- IF { $S_SHOW_DRAFTS } -->
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="3" align="center">{ $L_LOAD_DRAFT }</th>
-		</tr>
-		<tr>
-			<td class="row1" colspan="3" align="center"><span class="gen">{ $L_LOAD_DRAFT_EXPLAIN }</span></td>
-		</tr>
-		<tr>
-			<th>{ $L_SAVE_DATE }</th>
-			<th>{ $L_DRAFT_TITLE }</th>
-			<th>{ $L_OPTIONS }</th>
-		</tr>
-		<!-- LOOP $draftrow -->
-			<!-- IF { $draftrow:#LOOP_INDEX } % 2 -->
-			<tr class="row1">
-			<!-- ELSE -->
-			<tr class="row2">
-			<!-- ENDIF -->
-
-			<td class="postdetails" style="padding: 4px;">{ $draftrow:DATE }</td>
-			<td style="padding: 4px;"><b class="gen">{ $draftrow:DRAFT_SUBJECT }</b>
-				<!-- IF { $draftrow:S_LINK_TOPIC } --><br /><span class="gensmall">{ $L_TOPIC }: <a href="{ $draftrow.U_VIEW }">{ $draftrow:TITLE }</a></span>
-				<!-- ELSEIF { $draftrow:S_LINK_FORUM } --><br /><span class="gensmall">{ $L_FORUM }: <a href="{ $draftrow.U_VIEW }">{ $draftrow:TITLE }</a></span>
-				<!-- ELSEIF { $draftrow:S_LINK_PM } --><br /><span class="gensmall">{ $L_PRIVATE_MESSAGE }</span>
-				<!-- ELSE --><br /><span class="gensmall">{ $L_NO_TOPIC_FORUM }</span><!-- ENDIF -->
-			</td>
-			<td style="padding: 4px;" align="center"><span class="gen"><a href="{ $draftrow:U_INSERT }">{ $L_LOAD_DRAFT }</a></td>
-		</tr>
-		<!-- ENDLOOP -->
-	</table>
-
-	<br clear="all" />
-<!-- ENDIF -->
-
-<!-- IF { $S_DISPLAY_PREVIEW } --><!-- INCLUDE modules/Control_Panel/ucp_posting_preview.html --><!-- ENDIF -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2"><b>{ $L_POST_A }</b></th>
-	</tr>
-
-	<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row2" colspan="2" align="center"><span class="genmed" style="color:red">{ $ERROR }</span></td>
-		</tr>
-	<!-- ENDIF -->
-
-	<!-- IF { $S_DELETE_ALLOWED } -->
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_DELETE_POST }:</b></td>
-			<td class="row2"><input type="checkbox" name="delete" /> <span class="gensmall">[ { $L_DELETE_POST_WARN } ]</span></td>
-		</tr>
-	<!-- ENDIF -->
-
-	<!-- IF { $S_SHOW_TOPIC_ICONS } -->
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_ICON }:</b></td>
-			<td class="row2"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-				<tr>
-					<td><input type="radio" name="icon" value="0"{ $S_NO_ICON_CHECKED } /><span class="genmed">{$L_NONE}</span>
-					<!-- LOOP $topic_icon --><input type="radio" name="icon" value="{ $topic_icon:ICON_ID }" { $topic_icon:S_ICON_CHECKED } /><img src="{ $topic_icon:ICON_IMG }" width="{ $topic_icon:ICON_WIDTH }" height="{ $topic_icon:ICON_HEIGHT }" alt="" title="" hspace="2" vspace="2" /> <!-- ENDLOOP --></td>
-				</tr>
-			</table></td>
-		</tr>
-	<!-- ENDIF -->
-
-		<tr>
-			<td class="row1" ><b class="genmed">{ $L_TO }:</b></td>
-			<td class="row2">
-			<!-- LOOP $to_recipient -->
-				<span class="genmed">
-				<a href="{$to_recipient:U_VIEW}"><!-- IF { $to_recipient:COLOUR } --><b style="color:#{ $to_recipient:COLOUR }"><!-- ELSE --><b<!-- IF { $to_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $to_recipient:NAME }</b></a>&nbsp;</span><!-- IF !{ $S_EDIT_POST } --><input class="post" type="submit" name="remove_{ $to_recipient:TYPE }[{ $to_recipient:UG_ID }]" value="Remove" />&nbsp;<!-- ENDIF -->
-			<!-- LOOPELSE -->
-				<span class="genmed">{ $L_NONE }</span>
-			<!-- ENDLOOP -->
-			</td>
-		</tr>
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_BCC }:</b></td>
-			<td class="row2">
-			<!-- LOOP $bcc_recipient -->
-				<span class="genmed">
-				<a href="{$bcc_recipient:U_VIEW}"><!-- IF { $bcc_recipient:COLOUR } --><b style="color:#{$bcc_recipient:COLOUR}"><!-- ELSE --><b<!-- IF { $bcc_recipient:IS_GROUP } --> class="blue"<!-- ENDIF -->><!-- ENDIF -->{ $bcc_recipient:NAME }</b></a>&nbsp;</span><!-- IF !{ $S_EDIT_POST } --><input class="post" type="submit" name="remove_{ $bcc_recipient:TYPE }[{ $bcc_recipient:UG_ID }]" value="Remove" />&nbsp;<!-- ENDIF -->
-			<!-- LOOPELSE -->
-				<span class="genmed">{ $L_NONE }</span>
-			<!-- ENDLOOP -->
-			</td>
-		</tr>
-		{ $S_HIDDEN_ADDRESS_FIELD }
-	<tr>
-		<td class="row1"><b class="genmed">{ $L_USERNAME}:</b></td>
-		<td class="row2">
-		<input class="post" type="text" name="username" size="20" maxlength="40" value="" />&nbsp;<input class="post" type="submit" name="add_bcc" value="{$L_ADD_BCC}" />&nbsp;&nbsp;<input class="post" type="submit" name="add_to" value="{$L_ADD_TO}" />
-		</td>
-	</tr>
-	<tr>
-		<td class="row1" width="22%"><b class="genmed">{ $L_SUBJECT }:</b></td>
-		<td class="row2" width="78%"><input class="post" style="width:450px" type="text" name="subject" size="45" maxlength="60" tabindex="2" value="{$SUBJECT}" /></td>
-	</tr>
-	<tr>
-		<td class="row1" valign="top"><b class="genmed">{ $L_MESSAGE_BODY }:</b><br /><span class="gensmall">{$L_MESSAGE_BODY_EXPLAIN}</span><br /><br /><table width="80%" cellspacing="5" cellpadding="0" border="0" align="center">
-			<tr>
-				<td class="gensmall" align="center"><b>{ $L_SMILIES }</b></td>
-			</tr>
-			<tr>
-				<td align="center"><!-- LOOP $smiley --><a href="javascript:smiley('{ $smiley:SMILEY_CODE }')"><img src="{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }" width="{ $smiley:SMILEY_WIDTH }" height="{ $smiley:SMILEY_HEIGHT }" border="0" alt="{ $smiley:SMILEY_DESC }" title="{ $smiley:SMILEY_DESC }" onclick="smiley('{ $smiley:SMILEY_CODE }');return false" hspace="2" vspace="2" /></a> <!-- ENDLOOP --></td>
-			</tr>
-
-			<!-- IF { $S_SHOW_SMILEY_LINK } -->
-				<tr>
-					<td align="center"><a class="nav" href="{ $U_MORE_SMILIES }" onclick="window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;" target="phpbbsmilies">{ $L_MORE_SMILIES} </a></td>
-				</tr>
-			<!-- ENDIF -->
-
-		</table></td>
-		<td class="row2" valign="top"><table cellspacing="0" cellpadding="2" border="0">
-			<tr align="center" valign="middle">
-				<td><input type="button" class="btnbbcode" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="z" name="addbbcode18" value="php" style="width: 40px" onclick="bbstyle(18)" onmouseover="helpline('z')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="w" name="addbbcode16" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(16)" onmouseover="helpline('w')" /></td>
-			</tr>
-			<tr>
-				<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-					<tr>
-						<td><span class="genmed"> &nbsp;{ $L_FONT_SIZE }:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
-							<option value="7">{ $L_FONT_TINY }</option>
-							<option value="9">{ $L_FONT_SMALL }</option>
-							<option value="12" selected="selected">{ $L_FONT_NORMAL }</option>
-							<option value="18">{ $L_FONT_LARGE }</option>
-							<option  value="24">{ $L_FONT_HUGE }</option>
-						</select></td>
-						<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')">{ $L_CLOSE_TAGS }</a></td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td colspan="9" width="450"><input type="text" name="helpbox" style="width:100%" maxlength="100" class="helpline" value="{ $L_STYLES_TIP }" /></td>
-				<td class="genmed" align="center">{ $L_FONT_COLOR }</td>
-			</tr>
-			<tr>
-				<td colspan="9"><textarea name="message" id="message" rows="15" cols="76" tabindex="3" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">{ $MESSAGE }</textarea></td>
-					
-				<td width="100%" align="center" valign="top"><table cellspacing="0" cellpadding="0" border="0">
-					<tr>
-						<td bgcolor="black"><script language="javascript" type="text/javascript"><!--
-
-						colorPalette('v', 10, 7)
-
-						//--></script></td>
-					</tr>
-				</table></td>
-		 	</tr>
-		</table></td>
-	</tr>
-
-	<!-- IF { $S_INLINE_ATTACHMENT_OPTIONS } -->
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_ATTACHMENTS }:</b></td>
-			<td class="row2"><select name="attachments">{ $S_INLINE_ATTACHMENT_OPTIONS }</select>&nbsp;<input type="button" class="btnbbcode" accesskey="a" value="{ $L_PLACE_INLINE }" name="attachinline" onclick="attach_inline();" />
-			</td>
-		</tr>
-	<!-- ENDIF -->
-
-	<tr>
-		<td class="row1" valign="top"><b class="genmed">{ $L_OPTIONS }:</b><br /><table cellspacing="2" cellpadding="0" border="0">
-			<tr>
-				<td class="gensmall">{ $HTML_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $BBCODE_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $IMG_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $FLASH_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $SMILIES_STATUS }</td>
-			</tr>
-		</table></td>
-		<td class="row2"><table cellpadding="1">
-			<!-- IF { $S_HTML_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_html"{ $S_HTML_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_HTML }</td>
-				</tr>
-			<!-- ENDIF -->
-
-			<!-- IF { $S_BBCODE_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_bbcode"{ $S_BBCODE_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_BBCODE }</td>
-				</tr>
-			<!-- ENDIF --><!-- IF { $S_SMILIES_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_smilies"{$S_SMILIES_CHECKED} /></td>
-					<td class="gen">{$L_DISABLE_SMILIES}</td>
-				</tr>
-			<!-- ENDIF -->
-			<tr>
-				<td><input type="checkbox" name="disable_magic_url"{ $S_MAGIC_URL_CHECKED } /></td>
-				<td class="gen">{ $L_DISABLE_MAGIC_URL }</td>
-			</tr>
-			<!-- IF { $S_SIG_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="attach_sig"{ $S_SIGNATURE_CHECKED } /></td>
-					<td class="gen">{ $L_ATTACH_SIG }</td>
-				</tr>
-			<!-- ENDIF -->
-
-		</table></td>
-	</tr>
-
-	<!-- IF { $S_SHOW_ATTACH_BOX } -->
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="button" type="submit" tabindex="5" name="preview" value="{ $L_PREVIEW }" />&nbsp; <input class="button" type="submit" accesskey="s" tabindex="6" name="post" value="{ $L_SUBMIT }" /><!-- IF { $S_SAVE_ALLOWED } -->&nbsp; <input class="button" type="submit" accesskey="k" tabindex="8" name="save" value="{$L_SAVE}" /><!-- ENDIF --><!-- IF { $S_HAS_DRAFTS } -->&nbsp; <input class="button" type="submit" accesskey="d" tabindex="9" name="load" value="{$L_LOAD}" /><!-- ENDIF -->&nbsp; <input class="button" type="submit" accesskey="c" tabindex="7" name="cancel" value="{ $L_CANCEL }" /></td>
-	</tr>
-	<!-- ENDIF -->
-	
-	<!-- IF { $S_SHOW_ATTACH_BOX } --><!-- INCLUDE modules/Control_Panel/ucp_posting_attach_body.html --><!-- ENDIF -->
-
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" tabindex="5" name="preview" value="{ $L_PREVIEW }" />&nbsp; <input class="btnmain" type="submit" accesskey="s" tabindex="6" name="post" value="{$L_SUBMIT}" /><!-- IF { $S_SAVE_ALLOWED } -->&nbsp; <input class="button" type="submit" accesskey="k" tabindex="8" name="save" value="{$L_SAVE}" /><!-- ENDIF --><!-- IF { $S_HAS_DRAFTS } -->&nbsp; <input class="button" type="submit" accesskey="d" tabindex="9" name="load" value="{$L_LOAD}" /><!-- ENDIF -->&nbsp; <input class="button" type="submit" accesskey="c" tabindex="7" name="cancel" value="{ $L_CANCEL }" /></td>
-	</tr>
-</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_preview.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_posting_preview.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_posting_preview.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,58 +0,0 @@
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr> 
-		<th>{ $L_PREVIEW }</th>
-	</tr>
-	<tr>  
-		<td class="row1">{ $MINI_POST_IMG }<span class="postdetails">{ $L_POSTED }: { $POST_DATE } &nbsp;&nbsp;&nbsp; { $L_POST_SUBJECT }: { $PREVIEW_SUBJECT }</span></td>
-	</tr>
-
-	<tr> 
-		<td class="row1"><table width="100%" border="0" cellspacing="0" cellpadding="0">
-			<tr>
-				<td><div class="postbody">{ $PREVIEW_MESSAGE }</div>
-				<!-- IF { $S_HAS_ATTACHMENTS } -->
-				<br clear="all" /><br />
-
-				<table class="tablebg" width="100%" cellspacing="1">
-					<tr>
-						<td class="row3"><b class="genmed">{ $L_ATTACHMENTS }: </b></td>
-					</tr>
-					<!-- LOOP $attachment -->
-					<tr>
-						<td class="row2">
-						<!-- IF { $attachment:category } == 'DENIED' -->
-							<span class="postbody">[ { $attachment:lang }]</span><br /><br />
-						<!-- ELSEIF { $attachment:category } == 'IMAGE' -->
-							<!-- IF { $attachment:comment } -->
-							<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
-							<!-- ENDIF --><img src="{ $attachment:image_src }" alt="{ $attachment:name }" /></span>
-							<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
-						<!-- ELSEIF { $attachment:category } == 'THUMBNAIL' -->
-							<!-- IF { $attachment:comment } -->
-							<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
-							<!-- ENDIF -->		<a href="{ $attachment:link }" target="_blank"><img src="{ $attachment:image_src }" alt="{ $attachment:name }" border="0" /></a></span>
-							<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
-						<!-- ELSE -->
-							<!-- IF { $attachment:comment } -->
-							<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $attachment:comment }</span><hr />
-							<!-- ENDIF -->
-							<!-- IF { $attachment:icon } --><img src="{ $attachment:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $attachment:link }" target="_blank">{ $attachment:name }</a>
-							<span class="gensmall">
-							<br />{ $L_FILESIZE } { $attachment:lang_size }
-							<br />{ $L_DOWNLOADED } { $attachment:lang_views }
-							</span>
-						<!-- ENDIF -->
-						</td>
-					</tr>
-					<!-- ENDLOOP -->
-				</table>
-				<!-- ENDIF -->
-				<!-- IF { $PREVIEW_SIGNATURE } --><span class="postbody"><br />_________________<br />{ $PREVIEW_SIGNATURE }</span><!-- ENDIF --></td>
-			</tr>
-		</table>
-		</td>
-	</tr>
-</table>
-
-<br clear="all" />
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_personal.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_personal.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,75 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_SHOW_EMAIL }:</b></td>
-			<td class="row2"><input type="radio" name="viewemail" value="1" { $VIEW_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="viewemail" value="0" { $VIEW_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_ADMIN_EMAIL }:</b></td>
-			<td class="row2"><input type="radio" name="massemail" value="1" { $ADMIN_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="massemail" value="0" { $ADMIN_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_ALLOW_PM }:</b><br /><span class="gensmall">{ $L_ALLOW_PM_EXPLAIN }</span></td>
-			<td class="row2"><input type="radio" name="allowpm" value="1" { $ALLOW_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="allowpm" value="0" { $ALLOW_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<!-- IF { $S_CAN_HIDE_ONLINE } -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_HIDE_ONLINE }:</b></td>
-			<td class="row2"><input type="radio" name="hideonline" value="1" { $HIDE_ONLINE_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="hideonline" value="0" { $HIDE_ONLINE_NO } /><span class="genmed">{$L_NO }</span></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $S_SELECT_NOTIFY } -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_METHOD }:</b><br /><span class="gensmall">{ $L_NOTIFY_METHOD_EXPLAIN }</span></td>
-			<td class="row2"><input type="radio" name="notifymethod" value="0" { $NOTIFY_EMAIL } /><span class="genmed">{ $L_NOTIFY_METHOD_EMAIL }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="1" { $NOTIFY_IM } /><span class="genmed">{ $L_NOTIFY_METHOD_IM }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="2"{$NOTIFY_BOTH} /><span class="genmed">{$L_NOTIFY_METHOD_BOTH}</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_ON_PM }:</b></td>
-			<td class="row2"><input type="radio" name="notifypm" value="1" { $NOTIFY_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="notifypm" value="0" { $NOTIFY_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{$L_POPUP_ON_PM}:</b></td>
-			<td class="row2"><input type="radio" name="popuppm" value="1" { $POPUP_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="popuppm" value="0" { $POPUP_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_REPORT_PM_NOTIFY }:</b><br /><span class="gensmall">{ $L_REPORT_PM_NOTIFY_EXPLAIN }</span></td>
-			<td class="row2"><input type="radio" name="report_pm_notify" value="1" { $REPORT_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="report_pm_notify" value="0"{$REPORT_PM_NO} /><span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_LANGUAGE }:</b></td>
-			<td class="row2"><select name="lang">{ $S_LANG_OPTIONS }</select></td>
-		</tr>
-		<!-- IF { $S_THEME_OPTIONS } -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_THEME }:</b></td>
-			<td class="row2"><select name="theme">{ $S_THEME_OPTIONS }</select></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_TIMEZONE }:</b></td>
-			<td class="row2"><select name="tz">{ $S_TZ_OPTIONS }</select></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DST }:</b></td>
-			<td class="row2"><input type="radio" name="dst" value="1"{ $DST_YES } /> <span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="dst" value="0"{ $DST_NO } /> <span class="genmed">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DATE_FORMAT }:</b><br /><span class="gensmall">{ $L_BOARD_DATE_FORMAT_EXPLAIN }</span></td>
-			<td class="row2"><input type="text" name="dateformat" value="{ $DATE_FORMAT }" maxlength="14" class="post" /></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_post.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_post.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,39 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_BBCODE }:</b></td>
-			<td class="row2"><input type="radio" name="bbcode" value="1" { $DEFAULT_BBCODE_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="bbcode" value="0" { $DEFAULT_BBCODE_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_HTML }:</b></td>
-			<td class="row2"><input type="radio" name="html" value="1" { $DEFAULT_HTML_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="html" value="0" { $DEFAULT_HTML_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_SMILIES }:</b></td>
-			<td class="row2"><input type="radio" name="smilies" value="1" { $DEFAULT_SMILIES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $DEFAULT_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_ADD_SIG }:</b></td>
-			<td class="row2"><input type="radio" name="sig" value="1" { $DEFAULT_SIG_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sig" value="0" { $DEFAULT_SIG_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_NOTIFY }:</b></td>
-			<td class="row2"><input type="radio" name="notify" value="1" { $DEFAULT_NOTIFY_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="notify" value="0" { $DEFAULT_NOTIFY_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_view.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_prefs_view.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,75 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_IMAGES }:</b></td>
-			<td class="row2"><input type="radio" name="images" value="1" { $VIEW_IMAGES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="images" value="0" { $VIEW_IMAGES_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_FLASH }:</b></td>
-			<td class="row2"><input type="radio" name="flash" value="1" { $VIEW_FLASH_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="flash" value="0" { $VIEW_FLASH_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SMILIES }:</b></td>
-			<td class="row2"><input type="radio" name="smilies" value="1" { $VIEW_SMILIES_YES} /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $VIEW_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SIGS }:</b></td>
-			<td class="row2"><input type="radio" name="sigs" value="1" { $VIEW_SIGS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sigs" value="0" { $VIEW_SIGS_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_AVATARS }:</b></td>
-			<td class="row2"><input type="radio" name="avatars" value="1" { $VIEW_AVATARS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="avatars" value="0" { $VIEW_AVATARS_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<!-- IF { $S_CHANGE_CENSORS } -->
-		<tr>
-			<td class="row1" width="50%"><b class="genmed">{ $L_DISABLE_CENSORS }:</b></td>
-			<td class="row2"><input type="radio" name="wordcensor" value="1" { $DISABLE_CENSORS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="wordcensor" value="0" { $DISABLE_CENSORS_NO } /><span class="gen">{ $L_NO }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td colspan="2" class="spacer"></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DAYS }:</b></td>
-			<td class="row2">{ $S_TOPIC_SORT_DAYS }</td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_KEY }:</b></td>
-			<td class="row2">{ $S_TOPIC_SORT_KEY }</td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DIR }:</b></td>
-			<td class="row2">{ $S_TOPIC_SORT_DIR }</td>
-		</tr>
-		<tr>
-			<td colspan="2" class="spacer"></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DAYS }:</b></td>
-			<td class="row2">{ $S_POST_SORT_DAYS }</td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_KEY }:</b></td>
-			<td class="row2">{ $S_POST_SORT_KEY }</td>
-		</tr>
-		<tr> 
-			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DIR }:</b></td>
-			<td class="row2">{ $S_POST_SORT_DIR }</td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_avatar.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_avatar.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,70 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }" <!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_IMAGE }: </b><br /><span class="gensmall">{ $L_AVATAR_EXPLAIN }</span></td>
-			<td class="row2" align="center"><br /><!-- IF { $AVATAR } -->{ $AVATAR }<!-- ELSE --><img src="{ $THEME_PATH }/images/no_avatar.gif" alt="" /><!-- ENDIF --><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall">{ $L_DELETE_AVATAR }</span></td>
-		</tr>
-	<!-- IF !isset({ $S_DISPLAY_GALLERY }) -->
-		<!-- IF { $S_CAN_UPLOAD } -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_FILE }: </b></td>
-			<td class="row2"><input type="hidden" name="MAX_FILE_SIZE" value="{ $AVATAR_SIZE }" /><input class="post" type="file" name="uploadfile" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_URL }: </b><br /><span class="gensmall">{ $L_UPLOAD_AVATAR_URL_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="text" name="uploadurl" size="40" value="" /></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $S_LINK_AVATAR } -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_AVATAR }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_AVATAR_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="text" name="remotelink" size="40" value="" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_SIZE }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_SIZE_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="text" name="width" size="3" value="{ $WIDTH }" /> <span class="gen">px X </span> <input class="post" type="text" name="height" size="3" value="{ $HEIGHT }" /> <span class="gen">px</span></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $S_GALLERY_AVATAR } -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_AVATAR_GALLERY }: </b></td>
-			<td class="row2"><input class="button" type="submit" name="display_gallery" value="{ $L_DISPLAY_GALLERY }" /></td>
-		</tr>
-		<!-- ENDIF -->
-	<!-- ELSE -->
-		<tr> 
-			<th colspan="2">{ $L_AVATAR_GALLERY }</th>
-		</tr>
-		<tr> 
-			<td class="cat" colspan="2" align="center" valign="middle"><span class="genmed">{ $L_AVATAR_CATEGORY }: </span><select name="category">{$S_CAT_OPTIONS}</select>&nbsp; <span class="genmed">{ $L_AVATAR_PAGE }: </span><select name="page">{ $S_PAGE_OPTIONS }</select>&nbsp;<input class="button" type="submit" value="{ $L_GO }" name="display_gallery" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" colspan="2" align="center">
-			<table cellspacing="1" cellpadding="4" border="0" width="100%">
-				<!-- LOOP $avatar --><!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --></tr><tr><!-- ENDIF -->
-					<td align="center"><img src="{ $avatar:AVATAR_IMAGE }" alt="{ $avatar:AVATAR_NAME }" title="{ $avatar:AVATAR_NAME }" /><br/>
-					<input type="radio" name="avatarselect" value="{ $avatar:AVATAR_FILE }" /></td>
-				<!-- LOOPELSE -->
-				<tr>
-					<td align="center"><b class="gen">{ $L_NO_GALLERY_AVATAR }</b></td>
-				<!-- ENDLOOP -->
-				</tr>
-			</table>
-			</td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<!-- IF isset({ $S_DISPLAY_GALLERY }) --><input class="button" type="submit" name="cancel" value="{ $L_CANCEL }" /><!-- ELSE --><input class="button" type="reset" value="{ $L_RESET }" name="reset" /><!-- ENDIF --></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_profile_info.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_profile_info.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,62 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }" <!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row3" colspan="2"><span class="gensmall">{ $L_PROFILE_INFO_NOTICE }</span></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_ICQ }: </b></td>
-			<td class="row2"><input class="post" type="text" name="icq" size="30" maxlength="15" value="{ $ICQ }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_AIM }: </b></td>
-			<td class="row2"><input class="post" type="text" name="aim" size="30" maxlength="255" value="{ $AIM }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_MSNM }: </b></td>
-			<td class="row2"><input class="post" type="text" name="msn" size="30" maxlength="255" value="{ $MSN }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_YIM }: </b></td>
-			<td class="row2"><input class="post" type="text" name="yim" size="30" maxlength="255" value="{ $YIM }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_JABBER }: </b></td>
-			<td class="row2"><input class="post" type="text" name="jabber" size="30" maxlength="255" value="{ $JABBER }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_WEBSITE }: </b></td>
-			<td class="row2"><input class="post" type="text" name="website" size="30" maxlength="255" value="{ $WEBSITE }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_LOCATION }: </b></td>
-			<td class="row2"><input class="post" type="text" name="location" size="30" maxlength="100" value="{ $LOCATION }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_OCCUPATION }: </b></td>
-			<td class="row2"><textarea class="post" name="occupation" rows="3" cols="30">{ $OCCUPATION }</textarea></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_INTERESTS }: </b></td>
-			<td class="row2"><textarea class="post" name="interests" rows="3" cols="30">{ $INTERESTS }</textarea></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_BIRTHDAY }: </b><br /><span class="gensmall">{ $L_BIRTHDAY_EXPLAIN }</span></td>
-			<td class="row2"><span class="genmed">{ $L_DAY }:</span> <select name="bday_day">{ $S_BIRTHDAY_DAY_OPTIONS }</select> <span class="genmed">{ $L_MONTH }:</span> <select name="bday_month">{ $S_BIRTHDAY_MONTH_OPTIONS }</select> <span class="genmed">{ $L_YEAR }:</span> <select name="bday_year">{ $S_BIRTHDAY_YEAR_OPTIONS }</select></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_reg_details.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_reg_details.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,49 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<!-- IF { $S_FORCE_PASSWORD } -->
-			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_UCP_PROFILE_REG_WELCOME }</span></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_USERNAME }: </b><br /><span class="gensmall">{ $L_USERNAME_EXPLAIN }</span></td>
-			<td class="row2"><!-- IF { $S_CHANGE_USERNAME } --><input type="text" class="post" name="username" size="30" maxlength="30" value="{ $USERNAME }" /><!-- ELSE --><b class="gen">{ $USERNAME }</b><!-- ENDIF --></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b></td>
-			<td class="row2"><!-- IF { $S_CHANGE_EMAIL } --><input type="text" class="post" name="email" size="30" maxlength="60" value="{ $EMAIL }" /><!-- ELSE --><b class="gen">{ $EMAIL }</b><!-- ENDIF --></td>
-		</tr>
-		<!-- IF { $S_CHANGE_EMAIL } -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{$L_CONFIRM_EMAIL}: </b><br /><span class="gensmall">{ $L_CONFIRM_EMAIL_EXPLAIN }</span></td>
-			<td class="row2"><input type="text" class="post" name="email_confirm" size="30" maxlength="60" value="{ $CONFIRM_EMAIL }" /></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $S_CHANGE_PASSWORD } -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_CHANGE_PASSWORD }: </b><br /><span class="gensmall">{ $L_CHANGE_PASSWORD_EXPLAIN }</span></td>
-			<td class="row2"><input type="password" class="post" name="new_password" size="30" maxlength="255" value="{ $NEW_PASSWORD }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b><br /><span class="gensmall">{ $L_CONFIRM_PASSWORD_EXPLAIN }</span></td>
-			<td class="row2"><input type="password" class="post" name="password_confirm" size="30" maxlength="255" value="{ $PASSWORD_CONFIRM }" /></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_PASSWORD }: </b><br /><span class="gensmall">{ $L_CURRENT_PASSWORD_EXPLAIN }</span></td>
-			<td class="row2"><input type="password" class="post" name="cur_password" size="30" maxlength="255" value="{ $CUR_PASSWORD }" /></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_signature.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_profile_signature.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,177 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<script language="javascript" type="text/javascript">
-<!--
-
-var form_name = 'ucp';
-var text_name = 'signature';
-
-// Define the bbCode tags
-bbcode = new Array();
-bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]');
-imageTag = false;
-
-// Helpline messages
-b_help = "{ $L_BBCODE_B_HELP }";
-i_help = "{ $L_BBCODE_I_HELP }";
-u_help = "{ $L_BBCODE_U_HELP }";
-q_help = "{ $L_BBCODE_Q_HELP }";
-c_help = "{ $L_BBCODE_C_HELP }";
-l_help = "{ $L_BBCODE_L_HELP }";
-o_help = "{ $L_BBCODE_O_HELP }";
-p_help = "{ $L_BBCODE_P_HELP }";
-w_help = "{ $L_BBCODE_W_HELP }";
-a_help = "{ $L_BBCODE_A_HELP }";
-s_help = "{ $L_BBCODE_S_HELP }";
-f_help = "{ $L_BBCODE_F_HELP }";
-e_help = "{ $L_BBCODE_E_HELP }";
-
-function checkForm()
-{
-	if (document.post.message.value.length < 2) {
-		alert('{ $L_EMPTY_MESSAGE }');
-		return false;
-	}
-	else
-	{
-//		document.post.post.disabled = true;
-		return true;
-	}
-}
-
-//-->
-</script>
-<script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2">{ $L_TITLE }</th>
-		</tr>
-	
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="genmed error">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-	
-		<tr> 
-			<td class="row1" width="22%" valign="top">
-			<b class="genmed">{ $L_SIGNATURE }: </b><br /><span class="gensmall">{ $L_SIGNATURE_EXPLAIN }</span><br/><br/>
-			<table width="80%" cellspacing="5" cellpadding="0" border="0" align="center">
-				<tr>
-					<td class="gensmall" align="center"><b>{ $L_SMILIES }</b></td>
-				</tr>
-				<tr>
-					<td align="center"><!-- LOOP $smiley --><a href="javascript:smiley('{ $smiley:SMILEY_CODE }')"><img src="{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }" width="{ $smiley:SMILEY_WIDTH }" height="{ $smiley:SMILEY_HEIGHT }" border="0" alt="{ $smiley:SMILEY_DESC }" title="{ $smiley:SMILEY_DESC }" onclick="smiley('{ $smiley:SMILEY_CODE }');return false" hspace="2" vspace="2" /></a> <!-- ENDLOOP --></td>
-				</tr>
-	
-				<!-- IF { $S_SHOW_SMILEY_LINK } -->
-					<tr>
-						<td align="center"><a class="nav" href="{ $U_MORE_SMILIES }" onclick="window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;" target="_phpbbsmilies">{ $L_MORE_SMILIES} </a></td>
-					</tr>
-				<!-- ENDIF -->
-	
-			</table>
-			</td>
-			<td class="row2">
-			<table cellspacing="0" cellpadding="2" border="0">
-				<tr align="center" valign="middle">
-					<td><input class="btnbbcode" type="button" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
-					<td><input class="btnbbcode" type="button" accesskey="w" name="addbbcode18" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(18)" onmouseover="helpline('w')" /></td>
-				</tr>
-				<tr>
-					<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-						<tr>
-							<td><span class="genmed"> &nbsp;{ $L_FONT_SIZE }:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
-								<option value="7">{ $L_FONT_TINY }</option>
-								<option value="9">{ $L_FONT_SMALL }</option>
-								<option value="12" selected="selected">{ $L_FONT_NORMAL }</option>
-								<option value="18">{ $L_FONT_LARGE }</option>
-								<option  value="24">{ $L_FONT_HUGE }</option>
-							</select></td>
-							<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')">{ $L_CLOSE_TAGS }</a></td>
-						</tr>
-					</table></td>
-				</tr>
-				<tr>
-					<td colspan="9"><input class="helpline" type="text" name="helpbox" size="45" maxlength="100" style="width:100%" value="{$L_STYLES_TIP}" /></td>
-				</tr>
-				<tr>
-					<td colspan="9"><textarea class="post" name="signature" rows="10" cols="70" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">{$SIGNATURE}</textarea></td>
-				</tr>
-				<tr>
-					<td colspan="9"><table cellspacing="0" cellpadding="0" border="0" width="100%">
-						<tr>
-							<td bgcolor="black"><script language="javascript" type="text/javascript"><!--
-	
-							colorPalette('h', 17, 5)
-	
-							//--></script></td>
-						</tr>
-					</table></td>
-				</tr>
-			</table></td>
-		</tr>
-		<tr>
-			<td class="row1" valign="top"><b class="genmed">{ $L_OPTIONS }</b><br /><table cellspacing="2" cellpadding="0" border="0">
-				<tr>
-					<td class="gensmall">{ $HTML_STATUS }</td>
-				</tr>
-				<tr>
-					<td class="gensmall">{ $BBCODE_STATUS }</td>
-				</tr>
-				<tr>
-					<td class="gensmall">{ $IMG_STATUS }</td>
-				</tr>
-				<tr>
-					<td class="gensmall">{ $FLASH_STATUS }</td>
-				</tr>
-				<tr>
-					<td class="gensmall">{ $SMILIES_STATUS }</td>
-				</tr>
-			</table></td>
-			<td class="row2" valign="top"><table cellspacing="0" cellpadding="1" border="0">
-				<!-- IF { $S_HTML_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_html" { $S_HTML_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_HTML }</td>
-				</tr>
-				<!-- ENDIF --><!-- IF { $S_BBCODE_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_bbcode" { $S_BBCODE_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_BBCODE }</td>
-				</tr>
-				<!-- ENDIF --><!-- IF { $S_SMILIES_ALLOWED } -->
-				<tr>
-					<td><input type="checkbox" name="disable_smilies" { $S_SMILIES_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_SMILIES }</td>
-				</tr>
-				<!-- ENDIF -->
-				<tr>
-					<td><input type="checkbox" name="disable_magic_url" { $S_MAGIC_URL_CHECKED } /></td>
-					<td class="gen">{ $L_DISABLE_MAGIC_URL }</td>
-				</tr>
-			</table></td>
-		</tr>
-		<!-- IF { $SIGNATURE_PREVIEW } -->
-		<tr>
-			<th colspan="2" valign="middle">{ $L_SIGNATURE_PREVIEW }</th>
-		</tr>
-		<tr> 
-			<td class="row1" colspan="2"><div class="postdetails" style="padding: 6px;">{ $SIGNATURE_PREVIEW }</div></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="preview" value="{ $L_PREVIEW }" />&nbsp;&nbsp;<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_register.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_register.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_register.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,89 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<script language="Javascript" type="text/javascript">
-<!--
-	function change_language(lang_iso)
-	{
-		document.forms['register'].change_lang.value = lang_iso;
-		document.forms['register'].submit.click();
-	}
-//-->
-</script>
-
-<form name="register" method="post" action="{ $S_UCP_ACTION }">
-	<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-		<tr> 
-			<th colspan="2" height="28" valign="middle">{ $L_REGISTRATION }</th>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $L_ITEMS_REQUIRED } -->
-		<tr> 
-			<td class="row2" colspan="2"><span class="gensmall">{ $L_ITEMS_REQUIRED }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr> 
-			<td class="row1" width="38%"><b class="genmed">{ $L_USERNAME }: </b><br /><span class="gensmall">{ $L_USERNAME_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="text"  name="username" size="25" maxlength="40" value="{ $USERNAME }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b></td>
-			<td class="row2"><input class="post" type="text" name="email" size="25" maxlength="255" value="{ $EMAIL }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_CONFIRM_EMAIL }: </b></td>
-			<td class="row2"><input class="post" type="text"  name="email_confirm" size="25" maxlength="255" value="{ $EMAIL_CONFIRM }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_PASSWORD }: </b><br /><span class="gensmall">{ $L_PASSWORD_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="password" name="password" size="25" maxlength="100" value="{ $PASSWORD }" /></td>
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b></td>
-			<td class="row2"><input class="post" type="password" name="password_confirm" size="25" maxlength="100" value="" /></td>
-		</tr>
-		<!--
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_LANGUAGE }: </b></td>
-			<td class="row2"><select name="lang" onchange="javascript:change_language(this.value);">{ $S_LANG_OPTIONS }</select></td>
-		</tr>
-		-->
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_TIMEZONE }: </b></td>
-			<td class="row2"><select name="tz">{ $SELECT_TZ }</select></td>
-		</tr>
-		<!-- IF { $CONFIRM_IMG } -->
-		<tr> 
-			<th colspan="2" height="28" valign="middle">{ $L_CONFIRMATION }</th>
-		</tr>
-		<tr> 
-			<td class="row3" colspan="2"><span class="gensmall">{ $L_CONFIRM_EXPLAIN }</span></td>
-		</tr>
-		<tr>
-			<td class="row1" colspan="2" align="center">{ $CONFIRM_IMG }</td>
-		</tr>
-		<tr> 
-			<td class="row1"><b class="genmed">{ $L_CONFIRM_CODE }:  </b><br /><span class="gensmall">{ $L_CONFIRM_CODE_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="text"  name="confirm_code" size="10" maxlength="6" /></td>
-		</tr>
-		<!-- ENDIF --><!-- IF { $S_COPPA } -->
-		<tr> 
-			<th colspan="2" height="28" valign="middle">{ $L_COPPA_COMPLIANCE }</th>
-		</tr>
-		<tr> 
-			<td class="row3" colspan="2"><span class="gensmall">{ $L_COPPA_EXPLAIN }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="cat" colspan="2" align="center" height="28">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_remind.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_remind.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_remind.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,31 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form action="{ $S_PROFILE_ACTION }" method="post">
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr> 
-		<th colspan="2">{ $L_SEND_PASSWORD }</th>
-	</tr>
-	<tr> 
-		<td class="row1" width="38%"><b class="genmed">{ $L_USERNAME }: </b></td>
-		<td class="row2"><input type="text" class="post" name="username" size="25" maxlength="60" value="{ $USERNAME }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b><br /><span class="gensmall">{ $L_EMAIL_REMIND }</span></td>
-		<td class="row2"><input type="text" class="post" name="email" size="25" maxlength="255" value="{ $EMAIL }" /></td>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="2" align="center" height="28">
-			{ $S_HIDDEN_FIELDS }
-			<input type="submit" name="submit" value="{ $L_SUBMIT }" class="btnmain" />&nbsp;&nbsp;<input type="reset" value="{ $L_RESET }" name="reset" class="btnlite" />
-		</td>
-	</tr>
-</table>
-
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_resend.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_resend.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_resend.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,30 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form action="{ $S_PROFILE_ACTION }" method="post">
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr> 
-		<th colspan="2">{ $L_UCP_RESEND }</th>
-	</tr>
-	<tr> 
-		<td class="row1" width="100%"><b class="genmed">{ $L_USERNAME }: </b></td>
-		<td class="row2"><input type="text" class="post" name="username" size="25" maxlength="60" value="{ $USERNAME }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b><br /><span class="gensmall">{ $L_EMAIL_REMIND }</span></td>
-		<td class="row2"><input type="text" class="post" name="email" size="25" maxlength="255" value="{ $EMAIL }" /></td>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="2" align="center" height="28">
-			{ $S_HIDDEN_FIELDS }
-			<input type="submit" name="submit" value="{ $L_SUBMIT }" class="btnmain" />&nbsp;&nbsp;<input type="reset" value="{ $L_RESET }" name="reset" class="btnlite" />
-		</td>
-	</tr>
-</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_sideblock.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_sideblock.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,74 +0,0 @@
-?<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th>{ $L_OPTIONS }</th>
-	</tr>
-	<!-- LOOP $ucp_section -->
-	<tr>
-		<!-- IF { $ucp_section:S_SELECTED } -->
-		<td class="row1"><b class="nav">{ $ucp_section:L_TITLE }</b>
-			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			<!-- LOOP $ucp_subsection -->
-			<li>&#187; <!-- IF { $ucp_subsection:S_SELECTED } --><b>{ $ucp_subsection:L_TITLE }</b><!-- ELSE --><a href="{$ucp_subsection:U_TITLE}">{ $ucp_subsection:L_TITLE }</a><!-- ENDIF --></li>
-			<!-- ENDLOOP $ucp_subsection -->
-			</ul>
-		<!-- ELSE -->
-		<td class="row2" nowrap="nowrap" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $ucp_section:U_TITLE }'"><a class="nav" href="{ $ucp_section:U_TITLE }">{ $ucp_section:L_TITLE }</a>
-		<!-- ENDIF -->
-		</td>
-	</tr>
-	<!-- ENDLOOP $ucp_section -->
-</table>
-
-<div style="padding: 2px;"></div>
-
-<!-- IF { $S_SHOW_COLOUR_LEGEND } -->
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-	<tr>
-		<th colspan="2">{ $L_MESSAGE_COLOURS }</th>
-	</tr>
-	<!-- LOOP $pm_colour_info -->
-	<tr>
-		<!-- IF { $pm_colour_info:IMG } -->
-			<td class="row1" width="25" align="center">{ $pm_colour_info:IMG }</td>
-		<!-- ELSE -->
-			<td class="row1 { $pm_colour_info:CLASS }" width="5"><img src="images/spacer.gif" width="5" alt="{ $pm_colour_info:LANG }" border="0" /></td>
-		<!-- ENDIF -->
-		<td class="row1"><span class="genmed">{ $pm_colour_info:LANG }</span></td>
-	</tr>
-	<!-- ENDLOOP $pm_colour_info -->
-</table>
- 
-<div style="padding: 2px;"></div>
-<!-- ENDIF -->
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th>{ $L_FRIENDS }</th>
-	</tr>
-	<tr>
-		<td class="row1" align="center">
-		
-			<b class="genmed" style="color:green">{ $L_FRIENDS_ONLINE }</b>
-
-			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			<!-- LOOP $friends_online -->
-				<li><a href="{ $friends_online:U_PROFILE }">{ $friends_online:USERNAME }</a></li>
-			<!-- LOOPELSE -->
-			<li>{ $L_NO_FRIENDS_ONLINE }</li>
-			<!-- ENDLOOP $friends_online -->
-			</ul>
-
-			<hr />
-
-			<b class="genmed" style="color:red">{ $L_FRIENDS_OFFLINE }</b>
-
-			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			<!-- LOOP $friends_offline -->
-			<li><a href="{ $friends_offline:U_PROFILE }">{ $friends_offline:USERNAME }</a></li>
-			<!-- LOOPELSE -->
-			<li>{$L_NO_FRIENDS_OFFLINE}</li>
-			<!-- ENDLOOP $friends_online -->
-			</ul>
-		</td>
-	</tr>
-</table>

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_foes.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_foes.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,30 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{ $L_TITLE }</th>
-		</tr>
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FOES_EXPLAIN }</span></td>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FOES }:</b><br /><span class="gensmall">{ $L_YOUR_FOES_EXPLAIN }</span></td>
-			<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FOES }</b><!-- ENDIF --></td>
-		</tr>
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_ADD_FOES }:</b><br /><span class="gensmall">{ $L_ADD_FOES_EXPLAIN } [ <a href="{ $U_SEARCH_USER }" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=780');return false">{ $L_FIND_USERNAME }</a> ]</span></td>
-			<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_friends.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/control_panel2/Control_Panel/ucp_zebra_friends.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,30 +0,0 @@
-<!-- INCLUDE modules/Control_Panel/ucp_header.html -->
-
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th colspan="2" valign="middle">{$L_TITLE}</th>
-		</tr>
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FRIENDS_EXPLAIN }</span></td>
-		</tr>
-		<!-- IF { $ERROR } -->
-		<tr>
-			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-		</tr>
-		<!-- ENDIF -->
-		<tr>
-			<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FRIENDS }:</b><br /><span class="gensmall">{ $L_YOUR_FRIENDS_EXPLAIN }</span></td>
-			<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FRIENDS }</b><!-- ENDIF --></td>
-		</tr>
-		<tr>
-			<td class="row1"><b class="genmed">{ $L_ADD_FRIENDS }:</b><br /><span class="gensmall">{ $L_ADD_FRIENDS_EXPLAIN } [ <a href="{ $U_SEARCH_USER}" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false">{$L_FIND_USERNAME}</a> ]</span></td>
-			<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-		</tr>
-	</table>
-</form>
-
-<!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Copied: cms/trunk/includes/templates/modules/forums2 (from rev 163, cms/trunk/includes/templates/modules/Forums)

Copied: cms/trunk/includes/templates/modules/members_list2 (from rev 163, cms/trunk/includes/templates/modules/Members_List)

Copied: cms/trunk/includes/templates/modules/quick_message2 (from rev 163, cms/trunk/includes/templates/modules/Quick_Message)

Copied: cms/trunk/includes/templates/modules/quick_message2/Quick_Message (from rev 163, cms/trunk/includes/templates/modules/Quick_Message)

Deleted: cms/trunk/includes/templates/modules/quick_message2/Quick_Message/index.html
===================================================================
--- cms/trunk/includes/templates/modules/Quick_Message/index.html	2005-10-17 19:31:14 UTC (rev 163)
+++ cms/trunk/includes/templates/modules/quick_message2/Quick_Message/index.html	2005-10-26 19:21:18 UTC (rev 165)
@@ -1,51 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-{ $THEME_TABLE_OPEN }
-
-<table class="tablebg" width="100%" cellpadding="1" cellspacing="1">
-	<tbody>
-		<tr>
-			<th width="20%">{ $L_POSTER }</th>
-			<th width="80%">{ $L_MESSAGE }</th>
-		</tr>
-		<tr>
-			<td class="spacer" colspan="2" height="7"></td>
-		</tr>
-		<!-- LOOP $quick_message -->
-		<tr style="min-height: 100px;">
-			<td class="row1" align="center" valign="top">
-				<!-- IF { $quick_message:USER_LINK }  -->
-					<a href="{ $quick_message:USER_LINK } "><b> { $quick_message:USER_NAME } </b></a><br /><br />
-				<!-- ELSE -->
-					<b> { $quick_message:USER_NAME } </b>
-				<!-- ENDIF -->
-			</td>
-			<td class="row1">
-				<span class="gensmall">{ $quick_message:TIME }</span>
-				<!-- IF { $quick_message:DELETE_LINK } -->
-					<a href="{ $quick_message:DELETE_LINK } "><b>  { $L_DELETE }</b></a>
-				<!-- ENDIF -->
-				<hr/>
-				<p>
-					{ $quick_message:MESSAGE }
-				</p>
-			</td>
-		</tr>
-		<tr>
-			<td class="spacer" colspan="2" height="7"></td>
-		</tr>
-		<!-- LOOPELSE -->
-			<tr class="row2">
-				<td align="center" colspan="2">
-					{ $L_NO_POST }
-				</td>
-			</tr>
-		<!-- ENDLOOP $quick_message -->
-
-
-	</tbody>
-</table>
-
-{ $THEME_TABLE_CLOSE }
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Copied: cms/trunk/modules/contact2 (from rev 163, cms/trunk/modules/Contact)

Copied: cms/trunk/modules/control_panel2 (from rev 163, cms/trunk/modules/Control_Panel)

Copied: cms/trunk/modules/forums2 (from rev 163, cms/trunk/modules/Forums)

Copied: cms/trunk/modules/members_list2 (from rev 163, cms/trunk/modules/Members_List)

Copied: cms/trunk/modules/quick_message2 (from rev 163, cms/trunk/modules/Quick_Message)



From viperal at berlios.de  Wed Oct 26 21:29:11 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 26 Oct 2005 21:29:11 +0200
Subject: [Viperals-svncheckins] r166 - in cms/trunk: includes/templates/modules modules modules/quick_message modules/quick_message/quick_message2
Message-ID: <200510261929.j9QJTB9M003879@sheep.berlios.de>

Author: viperal
Date: 2005-10-26 21:29:09 +0200 (Wed, 26 Oct 2005)
New Revision: 166

Added:
   cms/trunk/includes/templates/modules/calender/
   cms/trunk/includes/templates/modules/contact/
   cms/trunk/includes/templates/modules/control_panel/
   cms/trunk/includes/templates/modules/forums/
   cms/trunk/includes/templates/modules/members_list/
   cms/trunk/includes/templates/modules/quick_message/
   cms/trunk/modules/contact/
   cms/trunk/modules/control_panel/
   cms/trunk/modules/forums/
   cms/trunk/modules/members_list/
   cms/trunk/modules/quick_message/
   cms/trunk/modules/quick_message/quick_message2/
Removed:
   cms/trunk/includes/templates/modules/calender2/
   cms/trunk/includes/templates/modules/contact2/
   cms/trunk/includes/templates/modules/control_panel2/
   cms/trunk/includes/templates/modules/forums2/
   cms/trunk/includes/templates/modules/members_list2/
   cms/trunk/includes/templates/modules/quick_message2/
   cms/trunk/modules/contact2/
   cms/trunk/modules/control_panel2/
   cms/trunk/modules/forums2/
   cms/trunk/modules/members_list2/
   cms/trunk/modules/quick_message/quick_message2/ajax.php
   cms/trunk/modules/quick_message/quick_message2/configurator.php
   cms/trunk/modules/quick_message/quick_message2/functions.php
   cms/trunk/modules/quick_message/quick_message2/index.php
   cms/trunk/modules/quick_message/quick_message2/language/
   cms/trunk/modules/quick_message2/
Log:
Change module cases to all lowercase ( Completed )

Copied: cms/trunk/includes/templates/modules/calender (from rev 165, cms/trunk/includes/templates/modules/calender2)

Copied: cms/trunk/includes/templates/modules/contact (from rev 165, cms/trunk/includes/templates/modules/contact2)

Copied: cms/trunk/includes/templates/modules/control_panel (from rev 165, cms/trunk/includes/templates/modules/control_panel2)

Copied: cms/trunk/includes/templates/modules/forums (from rev 165, cms/trunk/includes/templates/modules/forums2)

Copied: cms/trunk/includes/templates/modules/members_list (from rev 165, cms/trunk/includes/templates/modules/members_list2)

Copied: cms/trunk/includes/templates/modules/quick_message (from rev 165, cms/trunk/includes/templates/modules/quick_message2)

Copied: cms/trunk/modules/contact (from rev 165, cms/trunk/modules/contact2)

Copied: cms/trunk/modules/control_panel (from rev 165, cms/trunk/modules/control_panel2)

Copied: cms/trunk/modules/forums (from rev 165, cms/trunk/modules/forums2)

Copied: cms/trunk/modules/members_list (from rev 165, cms/trunk/modules/members_list2)

Copied: cms/trunk/modules/quick_message (from rev 165, cms/trunk/modules/quick_message2)

Copied: cms/trunk/modules/quick_message/quick_message2 (from rev 165, cms/trunk/modules/quick_message2)

Deleted: cms/trunk/modules/quick_message/quick_message2/ajax.php
===================================================================
--- cms/trunk/modules/quick_message2/ajax.php	2005-10-26 19:21:18 UTC (rev 165)
+++ cms/trunk/modules/quick_message/quick_message2/ajax.php	2005-10-26 19:29:09 UTC (rev 166)
@@ -1,188 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $_CORE_CONFIG, $_CLASS;
-
-if (!defined('QUICK_MESSAGE_TABLE'))
-{
-	global $table_prefix;
-		
-	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
-}
-
-$_CLASS['core_user']->user_setup();
-$mode = get_variable('mode', 'REQUEST', false);
-
-switch ($mode)
-{
-	case 'ajax_refresh':
-		require_once(SITE_FILE_ROOT.'modules/Quick_Message/functions.php');
-
-		echo qm_block_content();
-
-		script_close();
-	break;
-
-	case 'ajax_add':
-		if ($_CLASS['core_user']->is_bot)
-		{
-			die;
-		}
-
-		$message = trim(get_variable('message', 'POST', ''));
-
-		if (!$message)
-		{
-			die;
-		}
-
-		$length = mb_strlen($message);
-
-		if ($length > $_CORE_CONFIG['quick_message']['length_max'])
-		{ 
-			die;
-		}
-
-	// use limit
-		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
-		$count = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-	// add a count check here so it admin ajustable
-		if ($count['count'] > 0)
-		{
-			die;
-		}
-
-		$_CLASS['core_db']->free_result($result);
-
-		if ($_CLASS['core_user']->is_user)
-		{
-			$user_id =  $_CLASS['core_user']->data['user_id'];
-			$user_name = $_CLASS['core_user']->data['username'];
-		}
-		else
-		{
-			$user_id = 0;
-			$user_name = get_variable('poster_name', 'POST', false);
-
-			if (!$user_name)
-			{
-				if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
-				{
-					die;
-				}
-			}
-			else
-			{
-				$length = mb_strlen($user_name);
-
-				if ($length < 2)
-				{
-					die;
-				}
-
-				if ($length > 10)
-				{
-					die;
-				}
-
-				require(SITE_FILE_ROOT.'includes/functions_user.php');
-				$status = validate_username($user_name);
-
-				if ($status !== true)
-				{
-					die;
-				}
-			}
-		}
-
-		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-			'poster_name'	=> (string) $user_name,
-			'poster_id'		=> (int) $user_id,
-			'poster_ip'		=> (string) $_CLASS['core_user']->ip,
-			'message_text'	=> (string) $message,
-			'message_time'	=> (int) $_CLASS['core_user']->time,
-		));
-
-		$_CLASS['core_db']->query($sql);
-
-		require_once(SITE_FILE_ROOT.'modules/Quick_Message/functions.php');
-
-		echo qm_block_content();
-
-		script_close();
-
-	break;
-
-	case 'delete':
-		$id = get_variable('id', 'GET', false, 'integer');
-
-		if (!$id)
-		{
-			die;
-		}
-
-		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-		
-		if (!$row)
-		{
-			trigger_error('NO_MESSAGE');
-		}
-
-		$return = true;
-
-		if ($row['message_id'] == $id)
-		{
-			if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
-			{
-				if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
-				{
-					$return = false;
-				}
-			}
-		}
-
-		if ($return)
-		{
-			trigger_error('MESSAGE_NOT_DELETABLE');
-		}
-
-		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
-		$_CLASS['core_db']->query($sql);
-
-		//trigger_error('MESSAGE_DELETED');
-		redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
-	break;
-}
-
-script_close(false);
-
-?>
\ No newline at end of file

Deleted: cms/trunk/modules/quick_message/quick_message2/configurator.php
===================================================================
--- cms/trunk/modules/quick_message2/configurator.php	2005-10-26 19:21:18 UTC (rev 165)
+++ cms/trunk/modules/quick_message/quick_message2/configurator.php	2005-10-26 19:29:09 UTC (rev 166)
@@ -1,93 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $table_prefix;
-
-if (!defined('QUICK_MESSAGE_TABLE'))
-{
-	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
-}
-
-class Quick_Message_configurator
-{
-	function install()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->table_create('start', QUICK_MESSAGE_TABLE);
-		
-		$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
-		$_CLASS['core_db']->add_table_field_text('message_text', 200);
-		$_CLASS['core_db']->add_table_field_int('message_time', array('max' => 200000000));
-		$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
-		$_CLASS['core_db']->add_table_field_char('poster_name', 80);
-		$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
-		
-		$_CLASS['core_db']->add_table_index('message_id', 'primary');
-		$_CLASS['core_db']->add_table_index('message_time');
-		
-		$_CLASS['core_db']->table_create('commit');
-		
-		// use set config ?
-		set_core_config('quick_message', 'anonymous_posting', 2, false, true, 'int');
-		set_core_config('quick_message', 'delete_time', 300, false, true, 'int');
-		set_core_config('quick_message', 'height', 200, false, true, 'int');
-		set_core_config('quick_message', 'last_post_check', 150, false, true, 'int');
-		set_core_config('quick_message', 'length_max', 150, false, true, 'int');
-
-		$_CLASS['core_cache']->destroy('core_config');
-
-		$array = array(
-			'message_text'	=> 'Lets do this !',
-			'message_time'	=> (int) $_CLASS['core_user']->time,
-			'poster_id'		=> 0,
-			'poster_name'	=> (string) '',
-			'poster_ip'		=> (string) ''
-		);
-
-		$_CLASS['core_db']->query('INSERT INTO ' . QUICK_MESSAGE_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
-
-		return true;
-	}
-
-	function uninstall()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->report_error(false);
-
-		$_CLASS['core_db']->query('DROP TABLE ' . QUICK_MESSAGE_TABLE);
-		$_CLASS['core_db']->query('DELETE FROM ' . CORE_CONFIG_TABLE . " WHERE config_section = 'quick_message'");
-
-		$_CLASS['core_db']->report_error(true);
-		
-		return true;
-	}
-}
-
-?>
\ No newline at end of file

Deleted: cms/trunk/modules/quick_message/quick_message2/functions.php
===================================================================
--- cms/trunk/modules/quick_message2/functions.php	2005-10-26 19:21:18 UTC (rev 165)
+++ cms/trunk/modules/quick_message/quick_message2/functions.php	2005-10-26 19:29:09 UTC (rev 166)
@@ -1,101 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $table_prefix;
-
-if (!defined('QUICK_MESSAGE_TABLE'))
-{
-	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
-}
-
-function qm_block_content()
-{
-	global $_CLASS, $_CORE_CONFIG;
-	
-	$content = '<div style="width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;">';
-	
-	$result = $_CLASS['core_db']->query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$words_array = explode(' ', $row['message_text']);
-	
-		$row['message_text'] = '';
-	
-		foreach($words_array as $words)
-		{
-			if (substr($words, 0, 4) != '[url')
-			{
-				$row['message_text'] .= ' '.wordwrap($words, 18, "\n", 1);
-			}
-			else
-			{
-				$row['message_text'] .= $words;
-			}
-		}
-	
-		$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
-	
-		unset($words_array, $words);
-		
-		$content .= '<div style="padding: 4px;">';
-		
-		if ($row['poster_name'])
-		{
-			$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
-	
-			if ($row['poster_id']) 
-			{
-				$content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'"><b>' . $row['poster_name'] . ': </b></a>';
-			}
-			else
-			{
-				$content .= '<b>' . $row['poster_name'] . ': </b>'; 
-			}
-		}
-		else
-		{
-			$content .= '<b>' . $_CLASS['core_user']->lang['ANONYMOUS'] . ': </b>';
-		}
-	
-		if ($row['poster_id'])
-		{
-			$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
-		}
-	
-		$content .= $row['message_text'].'<br />'. $_CLASS['core_user']->format_date($row['message_time']) .'</div><hr/>';
-	}
-	
-	$_CLASS['core_db']->free_result($result);
-	
-	$content .= '</div>';
-
-	return $content;
-}
-
-?>
\ No newline at end of file

Deleted: cms/trunk/modules/quick_message/quick_message2/index.php
===================================================================
--- cms/trunk/modules/quick_message2/index.php	2005-10-26 19:21:18 UTC (rev 165)
+++ cms/trunk/modules/quick_message/quick_message2/index.php	2005-10-26 19:29:09 UTC (rev 166)
@@ -1,276 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $_CLASS, $_CORE_CONFIG;
-
-if (!defined('QUICK_MESSAGE_TABLE'))
-{
-	global $table_prefix;
-
-	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
-}
-
-$_CLASS['core_user']->user_setup();
-$_CLASS['core_user']->add_lang();
-if ($mode = get_variable('mode', 'REQUEST', false))
-{
-	switch ($mode)
-	{
-		case 'add':
-			if ($_CLASS['core_user']->is_bot)
-			{
-				redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
-			}
-	
-			$message = trim(get_variable('message', 'POST', false));
-	
-			if (!$message)
-			{
-				trigger_error('NO_MESSAGE');
-			}
-	
-			$length = mb_strlen($message);
-	
-			if ($length > $_CORE_CONFIG['quick_message']['length_max'])
-			{ 
-				trigger_error('LONG_MESSAGE');
-			}
-	
-		// use limit
-			$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
-			$count = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-	
-		// add a count check here so it admin ajustable
-			if ($count['count'] > 0)
-			{
-				trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
-			}
-	
-			$_CLASS['core_db']->free_result($result);
-	
-			if ($_CLASS['core_user']->is_user)
-			{
-				$user_id =  $_CLASS['core_user']->data['user_id'];
-				$user_name = $_CLASS['core_user']->data['username'];
-			}
-			else
-			{
-				$user_id = 0;
-				$user_name = get_variable('poster_name', 'POST', false);
-	
-				if (!$user_name)
-				{
-					if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
-					{
-						trigger_error('NO_NAME');
-					}
-				}
-				else
-				{
-					$length = mb_strlen($user_name);
-	
-					if ($length < 2)
-					{
-						trigger_error('SHORT_NAME');
-					}
-	
-					if ($length > 10)
-					{
-						trigger_error('LONG_NAME');
-					}
-	
-					require(SITE_FILE_ROOT.'includes/functions_user.php');
-					$status = validate_username($user_name);
-
-					if ($status !== true)
-					{
-						trigger_error($error);
-					}
-				}
-			}
-	
-			$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'poster_name'	=> (string) $user_name,
-				'poster_id'		=> (int) $user_id,
-				'poster_ip'		=> (string) $_CLASS['core_user']->ip,
-				'message_text'	=> (string) $message,
-				'message_time'	=> (int) $_CLASS['core_user']->time,
-			));
-	
-			$_CLASS['core_db']->query($sql);
-
-			redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
-		break;
-	
-		case 'delete':
-			global $_CORE_CONFIG, $_CLASS;
-	
-			$id = get_variable('id', 'GET', false, 'integer');
-	
-			if (!$id)
-			{
-				die;
-			}
-	
-			$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-			
-			if (!$row)
-			{
-				trigger_error('NO_MESSAGE');
-			}
-	
-			$return = true;
-	
-			if ($row['message_id'] == $id)
-			{
-				if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
-				{
-					if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
-					{
-						$return = false;
-					}
-				}
-			}
-	
-			if ($return)
-			{
-				trigger_error('MESSAGE_NOT_DELETABLE');
-			}
-	
-			$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
-			$_CLASS['core_db']->query($sql);
-	
-			//trigger_error('MESSAGE_DELETED');
-			redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
-		break;
-		
-		default:
-			script_close();
-		break;
-	}
-}
-
-$start = get_variable('start', 'GET', 0, 'integer');
-$limit = 20;
-
-//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
-$result = $_CLASS['core_db']->query_limit('SELECT * FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', $limit, $start);
-$row = $_CLASS['core_db']->fetch_row_assoc($result);
-
-if (!$row)
-{
-	$_CLASS['core_template']->assign_array(array(
-		'Q_MESSAGE_PAGINATION'	=> generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
-		'Q_PAGE_NUMBER'			=> on_page($row['total'], $limit, $start),
-		'Q_TOTAL_MESSAGES'		=> $row['total']
-	));
-
-	$_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
-}
-
-$delete_link = '';
-
-if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
-{
-	if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
-	{
-		$delete_link = generate_link('Quick_Message&amp;mode=delete&amp;id='.$row['message_id']);
-	}
-}
-
-do
-{
-	if ($row['poster_name'])
-	{
-		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
-		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
-	}
-	else
-	{
-		$user_name = $_CLASS['core_user']->lang['ANONYMOUS'];
-		$userlink = false;
-	}
-
-	$avatar = false;
-	/*if ($row['user_avatar'] && $_CLASS['core_user']->optionget('viewavatars'))
-	{
-		$avatar_img = '';
-		
-		switch ($row['user_avatar_type'])
-		{
-			case AVATAR_UPLOAD:
-				$avatar_img = $config['avatar_path'] . '/';
-				break;
-			case AVATAR_GALLERY:
-				$avatar_img = $config['avatar_gallery_path'] . '/';
-				break;
-		}
-		
-		$avatar_img .= $row['user_avatar'];
-		$avatar = '<img src="' . $avatar_img . '" width="' . $row['user_avatar_width'] . '" height="' . $row['user_avatar_height'] . '" border="0" alt="" />';
-		
-	}*/
-
-	if ($row['poster_id'])
-	{
-		$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
-	}
-	
-	$_CLASS['core_template']->assign_vars_array('quick_message', array(
-		'USER_NAME'		=> $user_name,
-		'USER_LINK'		=> $userlink,
-		'DELETE_LINK'	=> $delete_link,
-		'MESSAGE'		=> modify_lines(htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8'), '<br />'),
-		'TIME'			=> $_CLASS['core_user']->format_date($row['message_time']),
-		'POSTER_AVATAR' => $avatar,
-		'U_PROFILE' 	=> ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['poster_id']) : false,
-	));
-	
-	$delete_link = '';
-}
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total from '.QUICK_MESSAGE_TABLE);
-$row = $_CLASS['core_db']->fetch_row_assoc($result);
-$_CLASS['core_db']->free_result($result);	
-
-$pagination = generate_pagination('Quick_Message', $row['total'], $limit, $start);
-
-$_CLASS['core_template']->assign_array(array(
-	'Q_MESSAGE_PAGINATION'			=> $pagination['formated'],
-	'Q_MESSAGE_PAGINATION_ARRAY'	=> $pagination['array'],
-	'Q_PAGE_NUMBER'					=> on_page($row['total'], $limit, $start),
-	'Q_TOTAL_MESSAGES'				=> $row['total']
-));
-
-$_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
-
-?>
\ No newline at end of file



From viperal at berlios.de  Wed Oct 26 21:33:03 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 26 Oct 2005 21:33:03 +0200
Subject: [Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language
Message-ID: <200510261933.j9QJX3vP006358@sheep.berlios.de>

Author: viperal
Date: 2005-10-26 21:32:51 +0200 (Wed, 26 Oct 2005)
New Revision: 167

Added:
   cms/trunk/modules/control_panel/modules/
   cms/trunk/modules/quick_message/quick_message2/language/
   cms/trunk/modules/quick_message/quick_message2/language/en/
Removed:
   cms/trunk/modules/control_panel/ucp/
Modified:
   cms/trunk/modules/articles/index.php
   cms/trunk/modules/contact/index.php
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/forums/main.php
   cms/trunk/modules/forums/viewtopic.php
   cms/trunk/modules/members_list/index.php
Log:
Yes, It's still broken.  Hopefully it will be moderately functional by tomorrow.......

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/articles/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -33,133 +33,181 @@
 	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
-global $_CLASS;
+$this->supported = array('page', 'feed');
 
-$_CLASS['core_user']->user_setup();
-
-if (isset($_GET['mode']))
+class module_articles
 {
-	Switch ($_GET['mode'])
+	function page_articles()
 	{
-		Case 'print':
-			$print = true;
-		Case 'view':
-			$print = isset($print);
-
-			$id = get_variable('id', 'GET', false, 'int');
+		global $_CLASS;
 		
-			if (!$id)
+		$_CLASS['core_user']->user_setup();
+		
+		if (isset($_GET['mode']))
+		{
+			Switch ($_GET['mode'])
 			{
-				trigger_error('ARTICLE_NOT_FOUND');
+				Case 'print':
+					$print = true;
+				Case 'view':
+					$print = isset($print);
+		
+					$id = get_variable('id', 'GET', false, 'int');
+				
+					if (!$id)
+					{
+						trigger_error('ARTICLE_NOT_FOUND');
+					}
+				
+					$result = $_CLASS['core_db']->query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
+					$row = $_CLASS['core_db']->fetch_row_assoc($result);
+					$_CLASS['core_db']->free_result($result);
+		
+					if (!$row || $row['articles_status'] != STATUS_ACTIVE)
+					{
+						trigger_error('ARTICLE_NOT_FOUND');
+					}
+		
+					$_CLASS['core_template']->assign_array(array(
+						'ARTICLES_POSTER' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
+						'ARTICLES_POSTER_LINK'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+						'ARTICLES_TEXT'			=> $row['articles_text'],
+						'ARTICLES_CONTENT_LINK' => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+						'ARTICLES_TIME'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
+						'ARTICLES_TITLE'		=> $row['articles_title'],
+						'ARTICLES_ID'       	=> $id,
+						'ARTICLES_LINK_PRINT'	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+						'ARTICLES_LINK_SEND'	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+					));
+		
+					$_CLASS['core_display']->display(false, ($print) ? 'modules/articles/print.html' : 'modules/articles/view.html');	
+		
+					script_close();
+				break;
 			}
+		}
 		
-			$result = $_CLASS['core_db']->query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if (!$row || $row['articles_status'] != STATUS_ACTIVE)
+		$start = get_variable('start', 'GET', false, 'int');
+		$collapable_holding = array();
+		$expire_updated = false;
+		$limit = 10;
+		
+		$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
+		$result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
+		
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+		// this can cause problems, only thing to do is remove the limit query and do a loop until we get the needed articles
+			if ($row['articles_auth'] && !$_CLASS['core_auth']->auth(@unserialize($row['articles_auth'])) && !$_CLASS['core_auth']->admin_power('articles'))
 			{
-				trigger_error('ARTICLE_NOT_FOUND');
+				continue;
 			}
-
-			$_CLASS['core_template']->assign_array(array(
-				'ARTICLES_POSTER' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
-				'ARTICLES_POSTER_LINK'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
-				'ARTICLES_TEXT'			=> $row['articles_text'],
-				'ARTICLES_CONTENT_LINK' => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
-				'ARTICLES_TIME'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
-				'ARTICLES_TITLE'		=> $row['articles_title'],
-				'ARTICLES_ID'       	=> $id,
-				'ARTICLES_LINK_PRINT'	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
-				'ARTICLES_LINK_SEND'	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+			
+			if ($row['articles_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $row['articles_expires']))
+			{
+				$_CLASS['core_db']->query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires > 0 AND articles_expires <= ' . $_CLASS['core_user']->time);
+				$expire_updated = true;
+		
+				continue;
+			}
+		
+			if ($row['articles_starts'] && ($row['articles_starts'] > $_CLASS['core_user']->time))
+			{
+				continue;
+			}
+		
+			$_CLASS['core_template']->assign_vars_array('articles', array(
+				'poster' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
+				'content'		=> ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'],
+				'time'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
+				'title'			=> $row['articles_title'],
+				'id'      		=> $row['articles_id'],
+		
+				'collapse'  	=> check_collapsed_status('a_'.$row['articles_id']),
+				'full_story'	=> ($row['articles_intro'] && $row['articles_text']),
+		
+				'link_poster'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+				'link_content'  => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+				'link_print' 	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+				'link_send' 	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
 			));
-
-			$_CLASS['core_display']->display(false, ($print) ? 'modules/articles/print.html' : 'modules/articles/view.html');	
-
-			script_close();
-		break;
+		
+			$collapable_holding[] = 'a_'.$row['articles_id'];
+		}
+		$_CLASS['core_db']->free_result($result);
+		
+		// Garbage collection, would cause problems with guest/loggin articl views
+		if ($cookie_data = get_variable('collapsed_items', 'COOKIE'))
+		{
+			$collapsed_items = ($cookie_data) ? explode(':', $cookie_data) : array();
+			$count = count($collapsed_items);
+		
+			for($i = 0; $i < $count; $i++)
+			{
+				if (mb_strpos($collapsed_items[$i], 'a_') === 0 && !in_array($collapsed_items[$i], $collapable_holding))
+				{
+					unset($collapsed_items[$i]);
+				}
+			}
+		
+			$collapsed_items = implode(':', $collapsed_items);
+		
+			setcookie('collapsed_items', $collapsed_items, (int) $_CLASS['core_user']->time + 31536000000, '/');
+		}
+		
+		$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total FROM ' . ARTICLES_TABLE . ' WHERE articles_status = '.STATUS_ACTIVE);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		
+		$pagination = generate_pagination('articles', $row['total'], $limit, $start);
+		
+		$_CLASS['core_template']->assign_array(array(
+			'articles_pagination' 		=> $pagination['formated'],
+			'articles_pagination_array' => $pagination['array']
+		));
+		
+		$_CLASS['core_display']->display(false, 'modules/articles/index.html');
 	}
-}
-
-$start = get_variable('start', 'GET', false, 'int');
-$collapable_holding = array();
-$expire_updated = false;
-$limit = 10;
-
-$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
-$result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
-
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-// this can cause problems, only thing to do is remove the limit query and do a loop until we get the needed articles
-	if ($row['articles_auth'] && !$_CLASS['core_auth']->auth(@unserialize($row['articles_auth'])) && !$_CLASS['core_auth']->admin_power('articles'))
+	
+	function feed_articles()
 	{
-		continue;
-	}
-	
-	if ($row['articles_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $row['articles_expires']))
-	{
-		$_CLASS['core_db']->query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires > 0 AND articles_expires <= ' . $_CLASS['core_user']->time);
-		$expire_updated = true;
-
-		continue;
-	}
-
-	if ($row['articles_starts'] && ($row['articles_starts'] > $_CLASS['core_user']->time))
-	{
-		continue;
-	}
+		global $_CLASS;
 
-	$_CLASS['core_template']->assign_vars_array('articles', array(
-		'poster' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
-		'content'		=> ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'],
-		'time'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
-		'title'			=> $row['articles_title'],
-		'id'      		=> $row['articles_id'],
+		$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+		
+		$last_post_time = 0;
+		
+		// Need to fix this, add auth and expires/start check ( will have to remove limit )
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$time = ($row['articles_starts']) ? $row['articles_starts'] : $row['articles_posted'];
+			$text = ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'];
+		
+			if ($time > $last_post_time)
+			{
+				$last_post_time = $time;
+			}
+		
+			$_CLASS['core_template']->assign_vars_array('items', array(
+				'TITLE' 			=> htmlspecialchars($row['articles_title'], ENT_QUOTES, 'UTF-8'),
+				'LINK' 				=> generate_link('articles&amp;mode=view&amp;id='.$row['articles_id'], array('full' => true, 'sid' => false)),
+				'DESCRIPTION' 		=> htmlspecialchars(strip_tags($text), ENT_QUOTES, 'UTF-8'),
+				'DESCRIPTION_HTML' 	=> htmlspecialchars($text, ENT_QUOTES, 'UTF-8'),
+				'TIME'				=> date('M d Y H:i:s', $time) .' GMT',
+				'AUTHOR'			=> htmlspecialchars($row['poster_name'], ENT_QUOTES, 'UTF-8')
+			));
+		}
+		$_CLASS['core_db']->free_result($result);
 
-		'collapse'  	=> check_collapsed_status('a_'.$row['articles_id']),
-		'full_story'	=> ($row['articles_intro'] && $row['articles_text']),
 
-		'link_poster'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
-		'link_content'  => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
-		'link_print' 	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
-		'link_send' 	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
-	));
+		if ($last_post_time)
+		{
+			define('DISPLAY_FEED', true);
 
-	$collapable_holding[] = 'a_'.$row['articles_id'];
-}
-$_CLASS['core_db']->free_result($result);
-
-// Garbage collection, would cause problems with guest/loggin articl views
-if ($cookie_data = get_variable('collapsed_items', 'COOKIE'))
-{
-	$collapsed_items = ($cookie_data) ? explode(':', $cookie_data) : array();
-	$count = count($collapsed_items);
-
-	for($i = 0; $i < $count; $i++)
-	{
-		if (mb_strpos($collapsed_items[$i], 'a_') === 0 && !in_array($collapsed_items[$i], $collapable_holding))
-		{
-			unset($collapsed_items[$i]);
+			$_CLASS['core_template']->assign('LAST_MODIFIED', date('M d Y H:i:s', $last_post_time) .' GMT');
+	
+			header('Last-Modified: '.$last_post_time);
 		}
 	}
-
-	$collapsed_items = implode(':', $collapsed_items);
-
-	setcookie('collapsed_items', $collapsed_items, (int) $_CLASS['core_user']->time + 31536000000, '/');
 }
-
-$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total FROM ' . ARTICLES_TABLE . ' WHERE articles_status = '.STATUS_ACTIVE);
-$row = $_CLASS['core_db']->fetch_row_assoc($result);
-$_CLASS['core_db']->free_result($result);
-
-$pagination = generate_pagination('articles', $row['total'], $limit, $start);
-
-$_CLASS['core_template']->assign_array(array(
-	'articles_pagination' 		=> $pagination['formated'],
-	'articles_pagination_array' => $pagination['array']
-));
-
-$_CLASS['core_display']->display(false, 'modules/articles/index.html');
-
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/contact/index.php
===================================================================
--- cms/trunk/modules/contact/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/contact/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -21,21 +21,15 @@
 $Id$
 */
 
-/*$this->test = 'test';
-echo $this-> 'test';*/
+$this->supported = array('page');
 
-class page_contact
+class module_contact
 {
 	function page_contact()
 	{
 		// Add departments
 		global $_CLASS;
 		
-		if (!defined('VIPERAL'))
-		{
-			die;
-		}
-
 		$_CLASS['core_user']->user_setup();
 		$_CLASS['core_user']->add_lang();
 		
@@ -81,7 +75,7 @@
 			'SENDER_NAME' 			=> $this->data['NAME'],
 		));
 		
-		$_CLASS['core_template']->display('modules/Contact/index.html');
+		$_CLASS['core_template']->display('modules/contact/index.html');
 	}
 
 	// remove this function

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/control_panel/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -1,375 +1,252 @@
 <?php 
-// -------------------------------------------------------------
-//
-// $Id: ucp.php,v 1.36 2004/07/11 15:20:34 acydburn Exp $
-//
-// FILENAME  : bbcode.php 
-// STARTED   : Thu Nov 21, 2002
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
-if (!defined('VIPERAL'))
-{
-    die;
-}
+$Id$
+*/
 
-global $_CLASS, $_CORE_CONFIG;
 
+/*
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
 load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 $_CLASS['auth'] =& $_CLASS['forums_auth'];
 
-$_CLASS['core_user']->user_setup();
-$_CLASS['core_user']->add_lang();
+
 $_CLASS['core_user']->add_img(0, 'Forums');
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
+*/
 
-$mode	= request_var('mode', '');
-$module = request_var('i', '');
+if (!defined('VIPERAL'))
+{
+    die;
+}
 
-$ucp = new module();
+//$this->supported = array('page', 'feed', 'ajax');
+$this->supported = array('page');
 
-//define the undefineds
-$_CLASS['core_template']->assign_array(array(
-	'S_DISPLAY_FORM'		=> false,
-	'S_SHOW_PM_BOX'			=> false,
-	'S_SHOW_COLOUR_LEGEND'	=> false,
-	'USERNAME'				=> '',
-	'friends_online'		=> false,
-	'friends_offline' 		=> false,
-));
-
-// ---------
-// FUNCTIONS
-//
-class module
+class module_control_panel
 {
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
+	function module_control_panel()
+	{
+		$this->module = get_variable('i', 'REQUEST');
+		$this->mode = get_variable('mode', 'REQUEST');
+	}
 
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $selected_mod = false, $selected_submod = false)
+	function process_module($type = 'page')
 	{
-		global $_CLASS, $config;
+		global $_CLASS;
 
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . FORUMS_MODULES_TABLE . "
-			WHERE module_type = '{$module_type}'
-				AND module_enabled = 1
-			ORDER BY module_order ASC";
+		$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. "
+					WHERE module_name = '".$_CLASS['core_db']->escape($this->module)."'";
 		$result = $_CLASS['core_db']->query($sql);
+		
+		if (!$module_info = $_CLASS['core_db']->fetch_row_assoc($result) || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this->module . '.php'))
+		{
+			$this->module = 'main';
+			$this->mode = false;
+		}
+		
+		$this->link_standard = $this->link = 'control_panel&amp;i='.$this->module;
 
-		$i = 0;
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		if ($this->mode)
 		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-				//echo $row['module_acl'];
-				$row['module_acl'] = preg_replace(array('#acl_([a-z_]+)#', '#cfg_([a-z_]+)#'), array('$_CLASS[\'auth\']->acl_get("\\1")', '$config["\\1"]'), trim($row['module_acl']));
-				//echo $row['module_acl'];
+			$this->link .= '&amp;mode='.$this->mode;
+		}
+	}
 
-				eval('$is_auth = ('.$row['module_acl'].');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod && !$i)) ?  true : false;
-
-			// Get the localised lang string if available, or make up our own otherwise
-			$module_lang = strtoupper($module_type) . '_' . $row['module_title'];
-			$_CLASS['core_template']->assign_vars_array($module_type . '_section', array(
-				'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
+	function generate_panel_block()
+	{
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$sql = 'SELECT *
+			FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. ' ORDER BY module_id';
+		$result = $_CLASS['core_db']->query($sql);
+	
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$selected = ($row['module_name'] === $this->module);
+		
+			$module_lang = 'UCP_' . $row['module_title'];
+			$_CLASS['core_template']->assign_vars_array('ucp_section', array(
+				'L_TITLE'		=> isset($_CLASS['core_user']->lang[$module_lang]) ? $_CLASS['core_user']->lang[$module_lang] : mb_convert_case(str_replace('_', ' ',  ($row['module_name'])), MB_CASE_TITLE),
 				'S_SELECTED'	=> $selected, 
-				'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $row['module_id']))
+				'U_TITLE'		=> generate_link('control_panel&amp;i=' . $row['module_name']))
 			);
-
+		
 			if ($selected)
 			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
+				if (!$row['module_subs'])
 				{
-					$j = 0;
-					$submodules_ary = explode("\n", $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
+					$_CLASS['core_template']->assign('ucp_subsection', false);
+		
+					continue;
+				}
+		
+				$sub_modules = explode("\n", trim($row['module_subs']));
+		
+				foreach ($sub_modules as $sub_module)
+				{
+					if (!trim($sub_module))
 					{
-						if (!trim($submodule))
-						{
-							continue;
-						}
-
-						$submodule = explode(',', trim($submodule));
-						$submodule_title = array_shift($submodule);
-
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']->acl_get("\\1")', '(int) $config["\\1"]'), trim($auth_option)) . ');');
-
-							if (!$is_auth)
-							{
-								break;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod && !$j)) ? true : false;
-
-						// Get the localised lang string if available, or make up our own otherwise
-						$module_lang = strtoupper($module_type . '_' . $module_name . '_' . $submodule_title);
-
-						$_CLASS['core_template']->assign_vars_array("{$module_type}_subsection", array(
-							'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : $module_lang,
-							'S_SELECTED'	=> $selected, 
-							'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title)
-						));
-
-						if ($selected)
-						{
-							$this->mode = $submodule_title;
-						}
-
-						$j++;
+						continue;
 					}
+		
+					$selected = ($this->mode && $sub_module === $this->mode) ? true : false;
+		
+					$module_lang = strtoupper('UCP_' . $row['module_name'] . '_' . $sub_module);
+		
+					$_CLASS['core_template']->assign_vars_array("ucp_subsection", array(
+						'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : $module_lang,
+						'S_SELECTED'	=> $selected, 
+						'U_TITLE'		=> generate_link('control_panel&amp;i=' . $row['module_name'] . '&amp;mode=' . $sub_module)
+					));
 				}
-				else
-				{
-					$_CLASS['core_template']->assign('ucp_subsection', false);
-				}
 			}
-
-			$i++;
 		}
 		$_CLASS['core_db']->free_result($result);
-
-		if (!isset($module_id) || !$module_id)
+	
+		// Output listing of friends online
+		$online_time = $_CLASS['core_user']->time = $_CORE_CONFIG['server']['session_length'];
+		
+		$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
+			FROM ' . CORE_USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
+			LEFT JOIN ' . CORE_SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
+			WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+				AND z.friend = 1 
+				AND u.user_id = z.zebra_id';
+		$result = $_CLASS['core_db']->query($sql);
+		
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			trigger_error('MODULE_NOT_EXIST');
+			$which = ($row['session_time'] > $online_time) ? 'online' : 'offline';
+		
+			$_CLASS['core_template']->assign_vars_array("friends_{$which}", array(
+				'U_PROFILE'	=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+				'USER_ID'	=> $row['user_id'],
+				'USERNAME'	=> $row['username']
+			));
 		}
-
-		$this->type = $module_type;
-		$this->id = $module_id;
-		$this->name = $module_name;
+		$_CLASS['core_db']->free_result($result);
 	}
 
-	function load($type = false, $name = false, $mode = false, $run = true)
+	function page_control_panel()
 	{
-		if ($type)
-		{
-			$this->type = $type;
-		}
+		global $_CLASS, $_CORE_CONFIG;
 
-		if ($name)
-		{
-			$this->name = $name;
-		}
+		$_CLASS['core_user']->user_setup();
+		
+		/* Assign some basic template varibles */
+		$_CLASS['core_template']->assign_array(array(
+			'S_DISPLAY_FORM'		=> false,
+			'S_SHOW_PM_BOX'			=> false,
+			'S_SHOW_COLOUR_LEGEND'	=> false,
+			'USERNAME'				=> '',
+			'friends_online'		=> false,
+			'friends_offline' 		=> false,
+		));
+		
+		$mode = get_variable('mode', 'REQUEST');
+		$module = get_variable('i', 'REQUEST');
 
-		if (!class_exists($this->type . '_' . $this->name))
-		{
-			require_once(SITE_FILE_ROOT."modules/Control_Panel/{$this->type}/{$this->type}_{$this->name}.php");
+		$_CLASS['core_user']->add_lang();
 
-			if ($run)
+		if (!$module && $mode)
+		{
+			switch ($mode)
 			{
-				if (!isset($this->mode))
-				{
-					$this->mode = $mode;
-				}
+				case 'register':
+					if ($_CLASS['core_user']->is_user || $_CLASS['core_user']->is_bot)
+					{
+						redirect();
+					}
 
-				eval("\$this->module = new {$this->type}_{$this->name}(\$this->id, \$this->mode);");
-				if (method_exists($this->module, 'init'))
-				{
-					$this->module->init();
-				}
-			}
-		}
-	}
+					require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_register.php';
 
-	// Displays the appropriate template with the given title
-	function display($page_title, $tpl_name)
-	{
-		global $_CLASS;
+				break;
+			
+				case 'login':
+					if ($_CLASS['core_user']->is_user || $_CLASS['core_user']->is_bot)
+					{
+						redirect();
+					}
+			
+					login_box();
+				break;
+			
+				case 'logout':
+					if ($_CLASS['core_user']->is_user)
+					{
+						$_CLASS['core_user']->logout();
+					}
+			
+					$_CLASS['core_display']->meta_refresh(3);
+			
+					$message = $_CLASS['core_user']->lang['LOGOUT_REDIRECT'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . generate_link() . '">', '</a> ');
+					trigger_error($message);
+				break;
+			
+				case 'delete_cookies':
+					if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_COOKIES')))
+					{
+						global $_CORE_CONFIG;
+						
+						$set_time = gmtime() - 31536000;
+			
+						foreach ($_COOKIE as $cookie_name => $cookie_data)
+						{
+							$cookie_name = str_replace($_CORE_CONFIG['server']['cookie_name'] . '_', '', $cookie_name);
+			
+							if (strpos($cookie_name, '_poll') === false)
+							{
+								$_CLASS['core_user']->set_cookie($cookie_name, '', $set_time);
+							}
+						}
 
-		page_header();
+						$_CLASS['core_user']->logout();
 
-        $_CLASS['core_template']->display('modules/Control_Panel/'.$tpl_name);
+						$_CLASS['core_display']->meta_refresh(3);
 
-		script_close();
-	}
-}
-//
-// FUNCTIONS
-// ---------
-
-// Basic "global" modes
-switch ($mode)
-{
-	case 'activate':
-		$ucp->load('ucp', 'activate');
-		$ucp->module->ucp_activate();
-		url_redirect();
-	break;
-
-	case 'resend_act':
-		$ucp->load('ucp', 'resend');
-		$ucp->module->ucp_resend();
-	break;
-
-	case 'sendpassword':
-		$ucp->load('ucp', 'remind');
-		$ucp->module->ucp_remind();
-	break;
-
-	case 'register':
-		if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS || isset($_REQUEST['not_agreed']))
-		{
-			redirect();
+						$message = $_CLASS['core_user']->lang['COOKIES_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'], '<a href="'.generate_link().'">', '</a>');
+						trigger_error($message);
+					}
+			
+					redirect();
+				break;
+			}
 		}
-
-		$ucp->load('ucp', 'register');
-		$ucp->module->ucp_register();
-	break;
-
-	case 'confirm':
-		$ucp->load('ucp', 'confirm');
-		$ucp->module->ucp_confirm();
-	break;
-
-	case 'login':
-		if ($_CLASS['core_user']->is_user || $_CLASS['core_user']->is_bot)
-		{
-			redirect();
-		}
-
-		login_box();
-	break;
-
-	case 'logout':
-		if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
-		{
-			$_CLASS['core_user']->logout();
-		}
-
-		$_CLASS['core_display']->meta_refresh(3);
-
-		$message = $_CLASS['core_user']->lang['LOGOUT_REDIRECT'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . generate_link() . '">', '</a> ');
-		trigger_error($message);
-	break;
 		
-	case 'delete_cookies':
-		if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_COOKIES')))
+		/* Only registered users can go beyond this point*/
+		if (!$_CLASS['core_user']->is_user)
 		{
-			global $_CORE_CONFIG;
-			
-			$set_time = gmtime() - 31536000;
-
-			foreach ($_COOKIE as $cookie_name => $cookie_data)
+			if ($_CLASS['core_user']->is_bot)
 			{
-				$cookie_name = str_replace($_CORE_CONFIG['server']['cookie_name'] . '_', '', $cookie_name);
-
-				if (strpos($cookie_name, '_poll') === false)
-				{
-					$_CLASS['core_user']->set_cookie($cookie_name, '', $set_time);
-				}
+				redirect();
 			}
-
-			$_CLASS['core_user']->logout();
-
-			$_CLASS['core_display']->meta_refresh(3);
-
-			$message = $_CLASS['core_user']->lang['COOKIES_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'], '<a href="'.generate_link().'">', '</a>');
-			trigger_error($message);
-
+		
+			login_box(array('explain' => $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_UCP')));
 		}
 		
-		redirect();
-		break;
-}
+		$this->process_module('page');
+		$this->generate_panel_block('page');
 
-
-// Only registered users can go beyond this point
-if (!$_CLASS['core_user']->is_user)
-{
-	if ($_CLASS['core_user']->is_bot)
-	{
-		url_redirect();
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $module . '.php';
 	}
-	
-	login_box(array('explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_UCP']));
 }
 
-// Output listing of friends online
-$update_time = $config['load_online_time'] * 60;
-
-$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
-	FROM ' . USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
-	LEFT JOIN ' . SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
-	WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-		AND z.friend = 1 
-		AND u.user_id = z.zebra_id';
-$result = $_CLASS['core_db']->query($sql);
-
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-	$which = (time() - $update_time < $row['session_time']) ? 'online' : 'offline';
-
-	$_CLASS['core_template']->assign_vars_array("friends_{$which}", array(
-		'U_PROFILE'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-		
-		'USER_ID'	=> $row['user_id'],
-		'USERNAME'	=> $row['username'])
-	);
-}
-$_CLASS['core_db']->free_result($result);
-
-/*
-// Output PM_TO box if message composing
-if ($mode == 'compose' && request_var('action', '') != 'edit')
-{
-	if ($config['allow_mass_pm'])
-	{
-		$sql = 'SELECT group_id, group_name, group_type   
-			FROM ' . GROUPS_TABLE . ' 
-			WHERE group_type NOT IN (' . GROUP_HIDDEN . ', ' . GROUP_CLOSED . ')
-				AND group_receive_pm = 1
-			ORDER BY group_type DESC';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$group_options = '';
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$group_options .= '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	$_CLASS['core_template']->assign(array(
-		'S_SHOW_PM_BOX'		=> true,
-		'S_ALLOW_MASS_PM'	=> ($config['allow_mass_pm']),
-		'S_GROUP_OPTIONS'	=> ($config['allow_mass_pm']) ? $group_options : '',
-		'U_SEARCH_USER'		=> generate_link('Members_List&amp;mode=searchuser&amp;form=post&amp;field=username_list'),
-	));
-}*/
-
-// Instantiate module system and generate list of available modules
-$ucp->create('ucp', 'Control_Panel', $module, $mode);
-
-// Load and execute the relevant module
-$ucp->load();
-
 ?>
\ No newline at end of file

Copied: cms/trunk/modules/control_panel/modules (from rev 166, cms/trunk/modules/control_panel/ucp)

Modified: cms/trunk/modules/forums/main.php
===================================================================
--- cms/trunk/modules/forums/main.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/forums/main.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -47,7 +47,7 @@
 
 // Grab group details for legend display
 $sql = 'SELECT group_id, group_name, group_colour, group_type
-	FROM ' . GROUPS_TABLE . ' 
+	FROM ' . CORE_GROUPS_TABLE . ' 
 	WHERE group_legend = 1
 		AND group_type <> ' . GROUP_HIDDEN;
 $result = $_CLASS['core_db']->query($sql);
@@ -69,7 +69,7 @@
 	$now = explode(':', gmdate('j:m'));
 
 	$sql = 'SELECT user_id, username, user_colour, user_birthday 
-		FROM ' . USERS_TABLE . " 
+		FROM ' . CORE_USERS_TABLE . " 
 		WHERE user_birthday LIKE '" . sprintf('%2d-%2d-', $now[0], $now[1]) . "%'
 			AND user_type = ".USER_NORMAL;
 	$result = $_CLASS['core_db']->query($sql);
@@ -79,12 +79,14 @@
 		$user_colour = ($row['user_colour']) ? ' style="color:#' . $row['user_colour'] .'"' : '';
 		$birthday_list .= (($birthday_list != '') ? ', ' : '') . '<a' . $user_colour . ' href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>';
 		
-		if ($age = (int)substr($row['user_birthday'], -4))
+		if ($age = (int) substr($row['user_birthday'], -4))
 		{
 			$birthday_list .= ' (' . ($now['year'] - $age) . ')';
 		}
 	}
 	$_CLASS['core_db']->free_result($result);
+	
+	unset($now);
 }
 
 $l_total_user_s = ($config['num_users'] == 0) ? 'TOTAL_USERS_ZERO' : 'TOTAL_USERS_OTHER';

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/forums/viewtopic.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -598,7 +598,7 @@
 
 $sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_reg_date, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p
-	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . USERS_TABLE . ' u
+	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . CORE_USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
 		AND u.user_id = p.poster_id';
 
@@ -665,7 +665,7 @@
 	$bbcode_bitfield |= $row['bbcode_bitfield'];
 
 	// Is a signature attached? Are we going to display it?
-	if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->optionget('viewsigs'))
+	if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->user_data_get('viewsigs'))
 	{
 		$bbcode_bitfield |= $row['user_sig_bbcode_bitfield'];
 	}
@@ -708,7 +708,7 @@
 		{
 			$user_sig = '';
 
-			if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->optionget('viewsigs'))
+			if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->user_data_get('viewsigs'))
 			{
 				$user_sig = $row['user_sig'];
 			}
@@ -736,7 +736,7 @@
 				'username'		=> ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster
 			);
 
-			if ($row['user_avatar'] && $_CLASS['core_user']->optionget('viewavatars'))
+			if ($row['user_avatar'] && $_CLASS['core_user']->user_data_get('viewavatars'))
 			{
 				$avatar_img = '';
 				switch ($row['user_avatar_type'])
@@ -810,17 +810,17 @@
 if ($config['load_onlinetrack'] && !empty($id_cache))
 {
 	$sql = 'SELECT session_user_id, session_hidden, MAX(session_time) as online_time
-		FROM ' . SESSIONS_TABLE . ' 
+		FROM ' . CORE_SESSIONS_TABLE . ' 
 		WHERE session_user_id IN (' . implode(', ', $id_cache) . ')
 		GROUP BY session_user_id, session_hidden';
 
 	$result = $_CLASS['core_db']->query($sql);
 
-	$min_online_time = $_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length'] * 60;
+	$online_time = $_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length'];
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] && $row['online_time'] > $min_online_time);
+		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] && $row['online_time'] > $online_time);
 	}
 }
 unset($id_cache);

Modified: cms/trunk/modules/members_list/index.php
===================================================================
--- cms/trunk/modules/members_list/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/members_list/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -29,11 +29,6 @@
 
 global $_CLASS, $_CORE_CONFIG;
 
-require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
-
-$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
-
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang();
 $_CLASS['core_user']->add_img(false, 'Forums');
@@ -44,38 +39,37 @@
 ));
 
 // Grab data
-$mode		= request_var('mode', '');
-$action		= request_var('action', '');
-$user_id	= request_var('u', ANONYMOUS);
-$group_id	= request_var('g', 0);
+$mode		= get_variable('mode', 'REQUEST');
+$action		= get_variable('action', 'REQUEST');
 
-$start		= request_var('start', 0);
+$start		= get_variable('start', 'REQUEST', false, 'int');
 $submit		= isset($_POST['submit']);
 
-$sort_key	= request_var('sk', 'c');
-$sort_dir	= request_var('sd', 'a');
+$sort_key	= get_variable('sk', 'REQUEST', 'c');
+$sort_dir	= get_variable('sd', 'REQUEST', 'a');
 
 $window		= false;
 
 // Grab rank information for later
-$ranks = obtain_ranks();
+//$ranks = obtain_ranks();
 
-// What do you want to do today? ... oops, I think that line is taken ...
 switch ($mode)
 {
-	case 'leaders':
-		// Display a listing of board admins, moderators
-		//$_CLASS['core_user']->add_lang('groups', 'Forums');
-		
+	case 'forum_moderators':
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+
+		$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
+		
 		$page_title = $_CLASS['core_user']->lang['LEADER'];
-		$template_html = 'memberlist_leaders.html';
+		$template_html = 'memberlist_forum_moderators.html';
 
 		$user_ary = $_CLASS['forums_auth']->acl_get_list(false, 'm_', false);
-		$admin_id_ary = $mod_id_ary = $forum_id_ary = array();
+		$modorators = $forum_id_ary = array();
 
 		foreach ($user_ary as $forum_id => $forum_ary)
 		{
-			$mod_id_ary += $forum_ary['m_'];
+			$modorators += $forum_ary['m_'];
 
 			if ($forum_id)
 			{
@@ -91,37 +85,41 @@
 			WHERE forum_type = ' . FORUM_POST;
 		$result = $_CLASS['core_db']->query($sql);
 		
-		$forums = array();
+		$forums_array = array();
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$forums[$row['forum_id']] = $row['forum_name'];
+			$forums_array[$row['forum_id']] = $row['forum_name'];
+			$forum_array_ids[] = $row['forum_id'];
 		}
 		$_CLASS['core_db']->free_result($result);
 
 		$sql = 'SELECT u.user_id, u.username, u.user_colour, u.user_rank, u.user_posts, g.group_id, g.group_name, g.group_colour, g.group_type, ug.user_id as ug_user_id
-			FROM ' . USERS_TABLE . ' u, ' . GROUPS_TABLE . ' g
-			LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')
-			WHERE u.user_id IN (' . implode(', ', $admin_id_ary + $mod_id_ary) . ')
+			FROM ' . CORE_USERS_TABLE . ' u, ' . CORE_GROUPS_TABLE . ' g
+			LEFT JOIN ' . CORE_GROUPS_MEMBERS_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')
+			WHERE u.user_id IN (' . implode(', ', $modorators) . ')
 				AND u.user_group = g.group_id
-			ORDER BY g.group_name ASC, u.username ASC';
-		$result = $_CLASS['core_db']->query($sql);
+			ORDER BY g.group_name ASC, u.username ASC';
 
+		$result = $_CLASS['core_db']->query($sql);
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$which_row = in_array($row['user_id'], $admin_id_ary) ? 'admin' : 'mod';
+			$forums = array_intersect($forum_id_ary[$row['user_id']], $forum_array_ids);
+
+			if (empty($forums))
+			{
+				continue;
+			}
 
-			$s_forum_select = '';
-			if ($which_row == 'mod' && sizeof(array_diff(array_keys($forums), $forum_id_ary[$row['user_id']])))
+			$s_forum_select = '';
+
+			foreach ($forums as $forum_id)
 			{
-				foreach ($forum_id_ary[$row['user_id']] as $forum_id)
+				if ($_CLASS['forums_auth']->acl_get('f_list', $forum_id))
 				{
-					if (isset($forums[$forum_id]) && $_CLASS['forums_auth']->acl_get('f_list', $forum_id))
-					{
-						$s_forum_select .= '<option value="">' . $forums[$forum_id] . '</option>';
-					}
+					$s_forum_select .= '<option value="">' . $forums[$forum_id] . '</option>';
 				}
-			}
-			
+			}
+
 			if ($row['group_type'] == GROUP_HIDDEN && $row['ug_user_id'] != $_CLASS['core_user']->data['user_id'])
 			{
 				$group_name = $_CLASS['core_user']->get_lang('UNDISCLOSED');
@@ -130,13 +128,13 @@
 			else
 			{
 				$group_name = isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'];
-				$u_group = generate_link('Members_List&amp;mode=group&amp;g='.$row['group_id']);
+				$u_group = generate_link('members_list&amp;mode=group&amp;g='.$row['group_id']);
 			}
 
 			$rank_title = $rank_img = '';
 			get_user_rank($row['user_rank'], $row['user_posts'], $rank_title, $rank_img);
 
-			$_CLASS['core_template']->assign_vars_array($which_row, array(
+			$_CLASS['core_template']->assign_vars_array('moderators', array(
 				'USER_ID'		=> $row['user_id'],
 				'FORUMS'		=> $s_forum_select,
 				'USERNAME'		=> $row['username'],
@@ -148,9 +146,9 @@
 				'RANK_IMG'		=> $rank_img,
 
 				'U_GROUP'		=> $u_group,
-				'U_VIEWPROFILE'	=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']),
-				'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']) : '')
-			);
+				'U_VIEWPROFILE'	=> generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']),
+				'U_PM'			=> generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id'])
+			));
 		}
 		$_CLASS['core_db']->free_result($result);
 
@@ -200,7 +198,7 @@
 				$lang = 'JABBER';
 				$sql_field = 'user_jabber';
 				$s_select = (@extension_loaded('xml')) ? 'S_SEND_JABBER' : 'S_NO_SEND_JABBER';
-				$s_action = generate_link("Members_List&amp;mode=contact&amp;action=$action&amp;u=$user_id");
+				$s_action = generate_link("members_list&amp;mode=contact&amp;action=$action&amp;u=$user_id");
 				break;
 
 			default:
@@ -277,12 +275,14 @@
 			$s_select			=> true,
 			'S_IM_ACTION'		=> $s_action
 		));
+	break;
 
-		break;
-
 	case 'viewprofile':
+	
+		$user_id = get_variable('u', 'REQUEST', ANONYMOUS, 'int');
+
 		// Display a profile
-		if ($user_id == ANONYMOUS)
+		if ($user_id === ANONYMOUS)
 		{
 			trigger_error('NO_USER');
 		}
@@ -292,9 +292,10 @@
 			user_sig_bbcode_uid, user_sig_bbcode_bitfield, user_allow_viewemail, user_posts, user_reg_date, user_rank,
 			user_from, user_occ, user_interests, user_website, user_email, user_icq, user_aim, user_yim, user_msnm,
 			user_jabber, user_avatar, user_avatar_width, user_avatar_height, user_avatar_type, user_last_visit
-			FROM ' . USERS_TABLE . "
+			FROM ' . CORE_USERS_TABLE . "
 			WHERE user_id = $user_id
 				AND user_type = " . USER_NORMAL;
+
 		$result = $_CLASS['core_db']->query($sql);
 		$member = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
@@ -307,7 +308,7 @@
 		}
 		
 		$sql = 'SELECT g.group_id, g.group_name, g.group_type
-			FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . " g
+			FROM ' . CORE_USER_GROUP_TABLE . ' ug, ' . CORE_GROUPS_TABLE . " g
 			WHERE ug.user_id = $user_id
 				AND g.group_id = ug.group_id AND group_type <> " . GROUP_HIDDEN. '
 			ORDER BY group_type, group_name';
@@ -325,7 +326,7 @@
 		$template_html = 'memberlist_view.html';
 		
 		$sql = 'SELECT MAX(session_time) AS session_time
-			FROM ' . SESSIONS_TABLE . "
+			FROM ' . CORE_SESSIONS_TABLE . "
 			WHERE session_user_id = $user_id";
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -337,70 +338,13 @@
 
 		$num_real_posts = $_CLASS['core_user']->data['user_posts'];
 
-		/*
-		// Obtain list of forums where this users post count is incremented
-		$auth2 = new auth();
-		$auth2->acl($member);
-		
-		if ($permission_array = $auth2->acl_getf('f_postcount'))
-		{
-			// Grab all the relevant data
-			$sql = 'SELECT COUNT(*) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . "
-					WHERE poster_id = $user_id
-					AND forum_id IN (" . implode(', ', array_keys($permission_array)) . ')';
-
-			$result = $_CLASS['core_db']->query($sql);
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-	
-			$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $row['num_posts']);
-
-			unset($permission_array, $auth2);
-
-		}		
-		$active_f_row = $active_t_row = array();
-		*/
-
-		// Change post_count_sql to an forum_id array the user is able to see
-		if ($permission_array = $_CLASS['forums_auth']->acl_getf('f_read'))
-		{
-			$post_count_sql = 'AND f.forum_id IN (' . implode(', ', array_keys($permission_array)) . ')';
-	
-			$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . " f
-				WHERE p.poster_id = $user_id
-					AND f.forum_id = p.forum_id
-					$post_count_sql
-				GROUP BY f.forum_id, f.forum_name
-				ORDER BY num_posts DESC";
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-			$active_f_row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
-				WHERE p.poster_id = $user_id
-					AND t.topic_id = p.topic_id
-					AND f.forum_id = t.forum_id
-					$post_count_sql
-				GROUP BY t.topic_id, t.topic_title
-				ORDER BY num_posts DESC";
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-			$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-	
-			unset($permission_array, $post_count_sql);
-		}
-
 		// Do the relevant calculations
 		$memberdays = max(1, round(($_CLASS['core_user']->time - $member['user_reg_date']) / 86400));
 		$posts_per_day = $member['user_posts'] / $memberdays;
 		$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
 		$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+
 		if (!empty($active_f_row['num_posts']))
 		{
 			$active_f_name = $active_f_row['forum_name'];
@@ -422,8 +366,8 @@
 
 		if ($member['user_sig_bbcode_bitfield'] && $member['user_sig'])
 		{
-			// Add class loader
-			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
+
 			$bbcode = new bbcode();
 			$bbcode->bbcode_second_pass($member['user_sig'], $member['user_sig_bbcode_uid'], $member['user_sig_bbcode_bitfield']);
 		}
@@ -439,20 +383,63 @@
 			switch ($member['user_avatar_type'])
 			{
 				case AVATAR_UPLOAD:
-					$poster_avatar = $config['avatar_path'] . '/';
-					break;
+					$poster_avatar = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+				break;
+
 				case AVATAR_GALLERY:
-					$poster_avatar = $config['avatar_gallery_path'] . '/';
-					break;
+					$poster_avatar = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+				break;
 			}
 			$poster_avatar .= $member['user_avatar'];
 
 			$poster_avatar = '<img src="' . $poster_avatar . '" width="' . $member['user_avatar_width'] . '" height="' . $member['user_avatar_height'] . '" border="0" alt="" />';
 		}
 
-		$_CLASS['core_template']->assign_array(show_profile($member));
+		$rank_title = $rank_img = '';
+	
+		get_user_rank($member['user_rank'], $member['user_posts'], $rank_title, $rank_img);
 		
+		if (!empty($member['user_allow_viewemail']))
+		{
+			$email = ($_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$member['user_id']) : ((false) ? '' : 'mailto:' . $member['user_email']);
+		}
+		else
+		{
+			$email = '';
+		}
+	
+		$last_visit = ($member['session_time']) ? $member['session_time'] : $member['user_last_visit'];
+		$online = ($member['session_time'] >= ($_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length']));
+	
 		$_CLASS['core_template']->assign_array(array(
+			'USERNAME'		=> $member['username'],
+			'USER_COLOR'	=> ($member['user_colour']) ? $member['user_colour'] : '',
+			'RANK_TITLE'	=> $rank_title,
+	
+			'JOINED'		=> $_CLASS['core_user']->format_date($member['user_reg_date']),
+			'VISITED'		=> ($last_visit) ? ' - ' : $_CLASS['core_user']->format_date($last_visit),
+			'POSTS'			=> ($member['user_posts']) ? $member['user_posts'] : 0,
+	
+			'ONLINE_IMG'	=> ($online) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['USER_ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['USER_ONLINE']),
+			'RANK_IMG'		=> $rank_img,
+			'ICQ_STATUS_IMG'=> ($member['user_icq']) ? '<img src="http://web.icq.com/whitepages/online?icq=' . $member['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />' : '',
+	
+			'U_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u='.$member['user_id']),
+			'U_SEARCH_USER'	=> generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($member['username']) . '&amp;show_results=posts'),
+			'U_PM'			=> generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$member['user_id']),
+			'U_EMAIL'		=> $email,
+			'U_WWW'			=> ($member['user_website']) ? $member['user_website'] : '',
+			'U_ICQ'			=> ($member['user_icq']) ? generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$member['user_id']) : '',
+			'U_AIM'			=> ($member['user_aim']) ? generate_link('members_list&amp;mode=contact&amp;action=aim&amp;u='.$member['user_id']) : '',
+			'U_YIM'			=> ($member['user_yim']) ? 'http://edit.yahoo.com/config/send_webmesg?.target=' . $member['user_yim'] . '&.src=pg' : '',
+			'U_MSN'			=> ($member['user_msnm']) ? generate_link('members_list&amp;mode=contact&amp;action=msnm&amp;u='.$member['user_id']) : '',
+			'U_JABBER'		=> ($member['user_jabber']) ? generate_link('members_list&amp;mode=contact&amp;action=jabber&amp;u='.$member['user_id']) : '',
+	
+			'S_ONLINE'		=> $online,
+			'S_USER_LOGGED_IN' => $_CLASS['core_user']->is_user
+		));
+		
+		$_CLASS['core_template']->assign_array(array(
 			'POSTS_DAY'			=> sprintf($_CLASS['core_user']->lang['POST_DAY'], $posts_per_day),
 			'POSTS_PCT'			=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $percentage),
 			'ACTIVE_FORUM'		=> $active_f_name,
@@ -478,7 +465,7 @@
 			'JABBER_IMG'	=> $_CLASS['core_user']->img('btn_jabber', $_CLASS['core_user']->lang['JABBER']),
 			'SEARCH_IMG'	=> $_CLASS['core_user']->img('btn_search', $_CLASS['core_user']->lang['SEARCH']),
 
-			'S_PROFILE_ACTION'	=> generate_link('Members_List&amp;mode=group'),
+			'S_PROFILE_ACTION'	=> generate_link('members_list&amp;mode=group'),
 			'S_GROUP_OPTIONS'	=> $group_options,
 			
 			'U_ADD_FRIEND'		=> generate_link('Control_Panel&amp;i=zebra&amp;add=' . urlencode($member['username'])),
@@ -506,13 +493,10 @@
 			trigger_error('EMAIL_DISABLED');
 		}
 
-		// do soemthing better than this
-		if (($user_id === ANONYMOUS || !$config['board_email_form']) && !$topic_id)
-		{
-			trigger_error('NO_EMAIL');
-		}
+		$user_id = get_variable('u', 'REQUEST', ANONYMOUS, 'int');
+		$topic_id = get_variable('t', 'REQUEST', false, 'int');
 
-		if (!$_CLASS['forums_auth']->acl_get('u_sendemail'))
+		if ($user_id === ANONYMOUS && !$topic_id)
 		{
 			trigger_error('NO_EMAIL');
 		}
@@ -539,9 +523,10 @@
 		{
 			// Get the appropriate username, etc.
 			$sql = 'SELECT username, user_email, user_allow_viewemail, user_lang, user_jabber, user_notify_type
-				FROM ' . USERS_TABLE . "
+				FROM ' . CORE_USERS_TABLE . "
 				WHERE user_id = $user_id
 					AND user_type = ". USER_NORMAL . ' AND user_status = ' . STATUS_ACTIVE;
+
 			$result = $_CLASS['core_db']->query($sql);
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
@@ -552,7 +537,7 @@
 			}
 			
 			// Can we send email to this user?
-			if (!$row['user_allow_viewemail'] && !$_CLASS['forums_auth']->acl_get('a_user'))
+			if (!$row['user_allow_viewemail'])
 			{
 				trigger_error('NO_EMAIL');
 			}
@@ -571,6 +556,11 @@
 				trigger_error('NO_TOPIC');
 			}
 
+			require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+			load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+	
+			$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
+
 			if (!$_CLASS['forums_auth']->acl_get('f_read', $row['forum_id']))
 			{
 				trigger_error('NO_FORUM_READ');
@@ -652,11 +642,10 @@
 
 				$_CLASS['core_template']->assign_array(array(
 					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-					'BOARD_EMAIL'	=> $config['board_contact'],
 					'FROM_USERNAME' => $_CLASS['core_user']->data['username'],
 					'TO_USERNAME'   => ($topic_id) ? $name : $row['username'],
 					'MESSAGE'		=> $message,
-					'TOPIC_NAME'	=> ($topic_id) ? strtr($row['topic_title'], array_flip(get_html_translation_table(HTML_ENTITIES))) : '',
+					'TOPIC_NAME'	=> ($topic_id) ? html_entity_decode($row['topic_title'], HTML_ENTITIES) : '',
 					'U_TOPIC'		=> ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . "&t=$topic_id", array('full' => true, 'sid' => false)) : '')
 				);
 
@@ -687,7 +676,7 @@
 
 			'L_EMAIL_BODY_EXPLAIN'	=> $_CLASS['core_user']->get_lang((!$topic_id) ? 'EMAIL_BODY_EXPLAIN' : 'EMAIL_TOPIC_EXPLAIN'),
 
-			'S_POST_ACTION' => (!$topic_id) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id, array('full' => true)) : generate_link("Members_List&amp;mode=email&amp;f={$row['forum_id']}&amp;t=$topic_id", array('full' => true)),
+			'S_POST_ACTION' => (!$topic_id) ? generate_link('members_list&amp;mode=email&amp;u='.$user_id, array('full' => true)) : generate_link("members_list&amp;mode=email&amp;f={$row['forum_id']}&amp;t=$topic_id", array('full' => true)),
 			'S_SEND_USER'	=> (!$topic_id),
 		));
 	break;
@@ -708,26 +697,25 @@
 		$s_sort_key = '';
 		foreach ($sort_key_text as $key => $value)
 		{
-			$selected = ($sort_key == $key) ? ' selected="selected"' : '';
+			$selected = ($sort_key === $key) ? ' selected="selected"' : '';
 			$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
 		}
 
 		$s_sort_dir = '';
 		foreach ($sort_dir_text as $key => $value)
 		{
-			$selected = ($sort_dir == $key) ? ' selected="selected"' : '';
+			$selected = ($sort_dir === $key) ? ' selected="selected"' : '';
 			$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
 		}
 
-		// Additional sorting options for user search ... if search is enabled, if not
-		// then only admins can make use of this (for ACP functionality)
 		$sql_select = $sql_from = $sql_where = $sql_fields =  '';
 
-		$form	= $window = request_var('form', '');
-		$field	= request_var('field', 'username');
+		$form = $window = get_variable('form', 'REQUEST');
 
-		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['forums_auth']->acl_get('a_')))
+		if ($mode === 'search_user')
 		{
+			$field	= get_variable('field', 'REQUEST', 'username');
+
 			$username	= request_var('username', '');
 			$email		= request_var('email', '');
 			$icq		= request_var('icq', '');
@@ -808,32 +796,30 @@
 			}
 		}
 
-		$first_char = request_var('first_char', '');
+		$first_char = get_variable('first_char', 'REQUEST');
 
-		if ($first_char == 'other')
+		if ($first_char === 'other')
 		{
-			$sql_where = '';
+			$sql_where = '';
+
 			for ($i = 65; $i < 91; $i++)
 			{
 				$sql_where .= " AND u.username NOT LIKE '" . chr($i) . "%'";
 			}
 		}
-		else if ($first_char)
+		elseif ($first_char)
 		{
 			$sql_where = " AND u.username LIKE '" . $_CLASS['core_db']->escape(substr($first_char, 0, 1)) . "%'";
 		}
 
-		// Are we looking at a usergroup? If so, fetch additional info
-		// and further restrict the user info query
-		if ($mode == 'group')
+		if ($mode === 'group')
 		{
-			// We JOIN here to save a query for determining membership for hidden groups. ;)
-			
-			$sql = 'SELECT g.*, ug.user_id
-				FROM ' . GROUPS_TABLE . ' g
-				LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . " AND ug.group_id = $group_id)
-				WHERE g.group_id = $group_id
-				AND group_status = ".STATUS_ACTIVE;
+			$group_id = get_variable('g', 'REQUEST', false, 'int');
+
+			$sql = 'SELECT g.*, ug.member_status
+						FROM ' . CORE_GROUPS_TABLE . ' g
+							LEFT JOIN ' . CORE_USER_GROUP_TABLE . ' ug ON (ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . " AND ug.group_id = $group_id)
+							WHERE g.group_id = $group_id AND group_status = " . STATUS_ACTIVE;
 	
 			$result = $_CLASS['core_db']->query($sql);
 			$group_row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -859,7 +845,7 @@
 					$group_row['group_type'] = 'HIDDEN';
 					
 					// Check for membership or special permissions
-					if (!$_CLASS['forums_auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel') && $group_row['user_id'] != $_CLASS['core_user']->data['user_id'])
+					if ((int) $group_row['member_status'] !== STATUS_ACTIVE)
 					{
 						trigger_error('NO_GROUP');
 					}
@@ -881,14 +867,15 @@
 				switch ($group_row['group_avatar_type'])
 				{
 					case AVATAR_UPLOAD:
-						$avatar_img = $config['avatar_path'] . '/';
-						break;
+						$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+					break;
+
 					case AVATAR_GALLERY:
-						$avatar_img = $config['avatar_gallery_path'] . '/';
-						break;
+						$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+					break;
 				}
+				
 				$avatar_img .= $group_row['group_avatar'];
-
 				$avatar_img = '<img src="' . $avatar_img . '" width="' . $group_row['group_avatar_width'] . '" height="' . $group_row['group_avatar_height'] . '" border="0" alt="" />';
 			}
 
@@ -910,34 +897,36 @@
 				'AVATAR_IMG'	=> $avatar_img,
 				'RANK_IMG'		=> $rank_img,
 
-				'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm') && $group_row['group_receive_pm'] && $config['allow_mass_pm']) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id) : '',)
-			);
+				'U_PM'			=> generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id)
+			));
 
 			$sql_fields = ', ug.member_status';
-			$sql_from = ', ' . USER_GROUP_TABLE . ' ug ';
-			$sql_where .= " AND u.user_id = ug.user_id AND ug.group_id = $group_id";
+			$sql_from = ', ' . CORE_USER_GROUP_TABLE . ' ug ';
+			$sql_where .= " AND u.user_id = ug.user_id AND ug.group_id = $group_id AND member_status IN (".STATUS_ACTIVE.', '.STATUS_LEADER.')';
 		}
 
 		// Sorting and order
-		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
+		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir === 'a') ? 'ASC' : 'DESC');
 
 		// Count the users ...
 		if ($sql_where)
 		{
-			$sql = 'SELECT COUNT(u.user_id) AS total_users
-				FROM ' . USERS_TABLE . " u$sql_from
+			$sql = 'SELECT COUNT(*) AS total_users
+				FROM ' . CORE_USERS_TABLE . " u$sql_from
 				WHERE u.user_type = " . USER_NORMAL .' AND u.user_status = ' . STATUS_ACTIVE ."
 				$sql_where";
-			$result = $_CLASS['core_db']->query($sql);
 
-			$total_users = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['total_users'] : 0;
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
+
+			$total_users = $row['total_users'];
 		}
 		else
 		{
-			$total_users = $config['num_users'];
+			$total_users = $_CORE_CONFIG['user']['total_users'];
 		}
-		
+
 		$s_char_options = '<option value=""' . ((!$first_char) ? ' selected="selected"' : '') . '>&nbsp; &nbsp;</option>';
 
 		for ($i = 65; $i < 91; $i++)
@@ -947,7 +936,7 @@
 		$s_char_options .= '<option value="other"' . (($first_char == 'other') ? ' selected="selected"' : '') . '>Other</option>';
 		
 		// Pagination string
-		$pagination_url = $pagination_url2 = 'Members_List';
+		$pagination_url = $pagination_url2 = 'members_list';
 
 		// Build a relevant pagination_url
 		$global_var = ($submit) ? '_POST' : '_GET';
@@ -970,7 +959,7 @@
 		$pagination_url .= (($mode) ? '&amp;mode='.$mode : '') . (($first_char) ? '&amp;first_char='.$first_char : '');
 
 		// Some search user specific data
-		if ($mode == 'searchuser' && ($config['load_search'] || $_CLASS['forums_auth']->acl_get('a_')))
+		if ($mode === 'search_user')
 		{
 			$_CLASS['core_template']->assign_array(array(
 				'USERNAME'	=> $username,
@@ -992,12 +981,15 @@
 				'S_SORT_OPTIONS' 		=> $s_sort_key,
 				'S_JOINED_TIME_OPTIONS' => $s_find_join_time,
 				'S_ACTIVE_TIME_OPTIONS' => $s_find_active_time,
-				'S_SEARCH_ACTION' 		=> generate_link("Members_List&amp;mode=searchuser&amp;form=$form&amp;field=$field"))
+				'S_SEARCH_ACTION' 		=> generate_link("members_list&amp;mode=searchuser&amp;form=$form&amp;field=$field"))
 			);
 		}
 
+		$online_time = $_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length'];
+
+// this can be big
 		$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
-			FROM ' . SESSIONS_TABLE . '
+			FROM ' . CORE_SESSIONS_TABLE . '
 			WHERE session_time >= ' . ($_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length']) . '
 				AND session_user_id <> ' . ANONYMOUS . '
 			GROUP BY session_user_id';
@@ -1006,7 +998,7 @@
 		$session_times = array();
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$session_times[$row['session_user_id']] = $row['session_time'];
+			$session_times[$row['session_user_id']] = (int) $row['session_time'];
 		}
 		$_CLASS['core_db']->free_result($result);
 		
@@ -1014,43 +1006,54 @@
 		$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_allow_viewemail, u.user_posts, u.user_reg_date,
 				u.user_rank, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, 
 				u.user_msnm, u.user_jabber, u.user_avatar, u.user_avatar_type, u.user_last_visit '. $sql_fields .'
-					FROM ' . USERS_TABLE . " u$sql_from
+					FROM ' . CORE_USERS_TABLE . " u$sql_from
 					WHERE u.user_type = " . USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE ."
 						$sql_where
 						ORDER BY $order_by";
 
-		$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+		$result = $_CLASS['core_db']->query_limit($sql, 20, $start);
 
-		$id_cache = array();
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($mode == 'group' && $row['member_status'] == STATUS_PENDING)
+			$option_row = ($mode === 'group' && $row['member_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
+
+			$row['session_time'] = empty($session_times[$row['user_id']]) ? 0 : $session_times[$row['user_id']];
+
+			if (!empty($row['user_allow_viewemail']))
 			{
-				 continue;
+				$email = ($_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$row['user_id']) : ((false) ? '' : 'mailto:' . $row['user_email']);
 			}
-
-			$row['session_time'] = (!empty($session_times[$row['user_id']])) ? $session_times[$row['user_id']] : '';
-			$id_cache[$row['user_id']] = $row;
-		}
-		$_CLASS['core_db']->free_result($result);
+			else
+			{
+				$email = '';
+			}
 		
-		foreach ($id_cache as $user_id => $row)
-		{
-			$option_row = ($mode == 'group' && $row['member_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
+			$online = ($row['session_time'] >= $online_time);
 
-			$$option_row = array_merge(show_profile($row), array(
-				'U_VIEWPROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']))
-			);
+			$_CLASS['core_template']->assign_vars_array($option_row, array(
+					'USERNAME'		=> $row['username'],
+					'USER_COLOR'	=> ($row['user_colour']) ? $row['user_colour'] : '',
 
-			$_CLASS['core_template']->assign_vars_array($option_row, $$option_row);
+					'JOINED'		=> $_CLASS['core_user']->format_date($row['user_reg_date']),
+
+					'ONLINE_IMG'	=> ($online) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['USER_ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['USER_ONLINE']),
 			
-			unset($id_cache[$user_id]);
-	}
+					'U_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']),
+					'U_PM'			=> generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']),
+					'U_EMAIL'		=> $email,
+					'U_WWW'			=> ($row['user_website']) ? $row['user_website'] : '',
+					'U_VIEWPROFILE' => generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 
+					'S_ONLINE'		=> $online
+				)
+			);
+		}
+		$_CLASS['core_db']->free_result($result);
+
 	// Generate page
 	$_CLASS['core_template']->assign_array(array(
-		'PAGINATION' 	=> generate_pagination($pagination_url2, $total_users, $config['topics_per_page'], $start),
-		'PAGE_NUMBER' 	=> on_page($total_users, $config['topics_per_page'], $start),
+		'PAGINATION' 	=> generate_pagination($pagination_url2, $total_users, 20, $start),
+		'PAGE_NUMBER' 	=> on_page($total_users, 20, $start),
 		'TOTAL_USERS'	=> ($total_users == 1) ? $_CLASS['core_user']->lang['LIST_USER'] : sprintf($_CLASS['core_user']->lang['LIST_USERS'], $total_users),
 
 		'PROFILE_IMG'	=> $_CLASS['core_user']->img('btn_profile', $_CLASS['core_user']->lang['PROFILE']),
@@ -1064,23 +1067,22 @@
 		'JABBER_IMG'	=> $_CLASS['core_user']->img('btn_jabber', $_CLASS['core_user']->lang['JABBER']),
 		'SEARCH_IMG'	=> $_CLASS['core_user']->img('btn_search', $_CLASS['core_user']->lang['SEARCH']),
 
-		'U_FIND_MEMBER'		=> (!empty($config['load_search']) || $_CLASS['forums_auth']->acl_get('a_')) ? generate_link('Members_List&amp;mode=searchuser') : '',
-		'U_HIDE_FIND_MEMBER'=> ($mode == 'searchuser') ? generate_link($u_hide_find_member) : '',
+		'U_FIND_MEMBER'		=> generate_link('members_list&amp;mode=search_user'),
+		'U_HIDE_FIND_MEMBER'=> ($mode === 'search_user') ? generate_link($u_hide_find_member) : '',
 		'U_SORT_USERNAME'	=> generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_FROM'		=> generate_link($pagination_url . '&amp;sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_JOINED'		=> generate_link($pagination_url . '&amp;sk=c&amp;sd=' . (($sort_key == 'c' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_POSTS'		=> generate_link($pagination_url . '&amp;sk=d&amp;sd=' . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a')),
+		'U_SORT_ONLINE'		=> generate_link($pagination_url . '&amp;sk=d&amp;sd=' . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_EMAIL'		=> generate_link($pagination_url . '&amp;sk=e&amp;sd=' . (($sort_key == 'e' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_WEBSITE'	=> generate_link($pagination_url . '&amp;sk=f&amp;sd=' . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_ICQ'		=> generate_link($pagination_url . '&amp;sk=g&amp;sd=' . (($sort_key == 'g' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_AIM'		=> generate_link($pagination_url . '&amp;sk=h&amp;sd=' . (($sort_key == 'h' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_MSN'		=> generate_link($pagination_url . '&amp;sk=i&amp;sd=' . (($sort_key == 'i' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_YIM'		=> generate_link($pagination_url . '&amp;sk=j&amp;sd=' . (($sort_key == 'j' && $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_ICQ'		=> generate_link($pagination_url . '&amp;sk=g&amp;sd=' . (($sort_key == 'g' && $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_AIM'		=> generate_link($pagination_url . '&amp;sk=h&amp;sd=' . (($sort_key == 'h' && $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_MSN'		=> generate_link($pagination_url . '&amp;sk=i&amp;sd=' . (($sort_key == 'i' && $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_YIM'		=> generate_link($pagination_url . '&amp;sk=j&amp;sd=' . (($sort_key == 'j' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_ACTIVE'		=> generate_link($pagination_url . '&amp;sk=k&amp;sd=' . (($sort_key == 'k' && $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_RANK'		=> generate_link($pagination_url . '&amp;sk=l&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a')),
 		'U_LIST_CHAR'		=> generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'l' && $sort_dir == 'a') ? 'd' : 'a')),
 
-		'S_SEND_MESSAGE'	=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? true : false,
+		'S_SEND_MESSAGE'	=> true,
 		'S_SHOW_GROUP'		=> ($mode == 'group') ? true : false,
 		'S_MODE_SELECT'		=> $s_sort_key,
 		'S_ORDER_SELECT'	=> $s_sort_dir,
@@ -1090,12 +1092,9 @@
 }
 
 
-// Output the page
 $_CLASS['core_template']->assign('DISPLAY_STYLESHEET_LINK', $window);
-page_header();
+$_CLASS['core_display']->display($page_title, 'modules/members_list/'.$template_html);
 
-$_CLASS['core_display']->display($page_title, 'modules/Members_List/'.$template_html);
-
 script_close();
 // ---------
 // FUNCTIONS
@@ -1124,53 +1123,4 @@
 	}
 }
 
-function show_profile($data)
-{
-	global $config, $_CORE_CONFIG, $_CLASS;
-
-	$user_id = $data['user_id'];
-	$rank_title = $rank_img = '';
-
-	get_user_rank($data['user_rank'], $data['user_posts'], $rank_title, $rank_img);
-	
-	if (!empty($data['user_allow_viewemail']) || $_CLASS['forums_auth']->acl_get('a_email'))
-	{
-		$email = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails'] && !$_CLASS['forums_auth']->acl_get('a_email')) ? '' : 'mailto:' . $data['user_email']);
-	}
-	else
-	{
-		$email = '';
-	}
-
-	$last_visit = ($data['session_time']) ? $data['session_time'] : $data['user_last_visit'];
-	$online = ($data['session_time'] >= ($_CLASS['core_user']->time - ($config['load_online_time'] * 60)));
-
-	return array(
-		'USERNAME'		=> $data['username'],
-		'USER_COLOR'	=> ($data['user_colour']) ? $data['user_colour'] : '',
-		'RANK_TITLE'	=> $rank_title,
-
-		'JOINED'		=> $_CLASS['core_user']->format_date($data['user_reg_date']),
-		'VISITED'		=> ($last_visit) ? ' - ' : $_CLASS['core_user']->format_date($last_visit),
-		'POSTS'			=> ($data['user_posts']) ? $data['user_posts'] : 0,
-
-		'ONLINE_IMG'	=> ($online) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['USER_ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['USER_ONLINE']),
-		'RANK_IMG'		=> $rank_img,
-		'ICQ_STATUS_IMG'=> ($data['user_icq']) ? '<img src="http://web.icq.com/whitepages/online?icq=' . $data['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />' : '',
-
-		'U_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$user_id),
-		'U_SEARCH_USER'	=> ($_CLASS['forums_auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($data['username']) . '&amp;show_results=posts') : '',
-		'U_PM'			=> ($_CLASS['forums_auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$user_id) : '',
-		'U_EMAIL'		=> $email,
-		'U_WWW'			=> ($data['user_website']) ? $data['user_website'] : '',
-		'U_ICQ'			=> ($data['user_icq']) ? generate_link('Members_List&amp;mode=contact&amp;action=icq&amp;u='.$user_id) : '',
-		'U_AIM'			=> ($data['user_aim']) ? generate_link('Members_List&amp;mode=contact&amp;action=aim&amp;u='.$user_id) : '',
-		'U_YIM'			=> ($data['user_yim']) ? 'http://edit.yahoo.com/config/send_webmesg?.target=' . $data['user_yim'] . '&.src=pg' : '',
-		'U_MSN'			=> ($data['user_msnm']) ? generate_link('Members_List&amp;mode=contact&amp;action=msnm&amp;u='.$user_id) : '',
-		'U_JABBER'		=> ($data['user_jabber']) ? generate_link('Members_List&amp;mode=contact&amp;action=jabber&amp;u='.$user_id) : '',
-
-		'S_ONLINE'		=> $online
-	);
-}
-
 ?>
\ No newline at end of file



From viperal at berlios.de  Thu Oct 27 18:01:49 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 27 Oct 2005 18:01:49 +0200
Subject: [Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message
Message-ID: <200510271601.j9RG1nRS022321@sheep.berlios.de>

Author: viperal
Date: 2005-10-27 18:01:46 +0200 (Thu, 27 Oct 2005)
New Revision: 168

Added:
   cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html
Removed:
   cms/trunk/includes/templates/modules/Recommend_Us/
   cms/trunk/includes/templates/modules/control_panel/Control_Panel/
   cms/trunk/includes/templates/modules/google_search/
   cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html
   cms/trunk/includes/templates/modules/quick_message/Quick_Message/
   cms/trunk/modules/quick_message/quick_message2/
Modified:
   cms/trunk/includes/compatiblity/mbstring.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html
   cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html
   cms/trunk/includes/templates/modules/forums/posting_topic_review.html
   cms/trunk/includes/templates/modules/members_list/memberlist_body.html
   cms/trunk/includes/templates/modules/members_list/memberlist_footer.html
   cms/trunk/index.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/control_panel/modules/ucp_attachments.php
   cms/trunk/modules/control_panel/modules/ucp_groups.php
   cms/trunk/modules/control_panel/modules/ucp_main.php
   cms/trunk/modules/control_panel/modules/ucp_pm.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
   cms/trunk/modules/control_panel/modules/ucp_profile.php
   cms/trunk/modules/control_panel/modules/ucp_register.php
   cms/trunk/modules/control_panel/modules/ucp_zebra.php
   cms/trunk/modules/forums/download.php
Log:
Yes, It's still broken.  Hopefully it will be moderately functional by today.......

Modified: cms/trunk/includes/compatiblity/mbstring.php
===================================================================
--- cms/trunk/includes/compatiblity/mbstring.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/compatiblity/mbstring.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -26,7 +26,9 @@
 	next your going to say you can't use a database *
 */
 
-define('MB_CASE_TITLE', 0);
+ at define('MB_CASE_UPPER', 0);
+ at define('MB_CASE_LOWER', 1);
+ at define('MB_CASE_TITLE', 2);
 
 if (!function_exists('mb_internal_encoding'))
 {
@@ -80,8 +82,21 @@
 {
 	function mb_convert_case($string, $mode = null, $encoding = null)
 	{
-		// maybe add modes
-		return ucfirst(strtolower($string));
+		switch ($mode)
+		{
+			case MB_CASE_TITLE:
+/* Make do some make this complete */
+				return ucfirst(strtolower($string));
+			break;
+
+			case MB_CASE_UPPER:
+				return strtoupper($string);
+			break;
+
+			case MB_CASE_LOWER:
+				return strtolower($string);
+			break;
+		}
 	}
 }
 
@@ -92,4 +107,13 @@
 		return strtolower($string);
 	}
 }
+
+if (!function_exists('mb_strtoupper'))
+{
+	function mb_strtoupper($string, $encoding = null)
+	{
+		return strtoupper($string);
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/auth.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -37,7 +37,7 @@
 	var $option = array();
 	var $acl_options = array();
 
-	function acl(&$userdata)
+	function acl($userdata)
 	{
 		global $_CLASS;
 

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/functions.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -1011,14 +1011,6 @@
 	return $bump_time;
 }
 
-// Smiley processing
-function smiley_text($text, $force_option = false)
-{
-	global $config, $_CLASS;
-
-	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->user_data_get('viewsmilies')) ? preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text) : str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
-}
-
 // Inline Attachment processing
 function parse_inline_attachments(&$text, $attachments, &$update_count, $forum_id = 0, $preview = false)
 {

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/message_parser.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -27,22 +27,8 @@
     die;
 }
 
-// case-insensitive strpos() - needed for some functions
-if (!function_exists('stripos'))
-{
-	function stripos($haystack, $needle)
-	{
-		if (preg_match('#' . preg_quote($needle, '#') . '#i', $haystack, $m))
-		{
-			return strpos($haystack, $m[0]);
-		}
+require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 
-		return false;
-	}
-}
-
-require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
-
 // BBCODE_FIRSTPASS
 //
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/functions.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -544,7 +544,7 @@
 	return $hidden_fields;
 }
 
-function generate_pagination($base_url, $total, $per_page = 10, $start = 0, $admin_link = false)
+function generate_pagination($base_url, $total, $per_page = 10, $start = 0, $admin_link = false, $wrapper = false)
 {
 	global $_CLASS;
 
@@ -553,10 +553,13 @@
 		return false;
 	}
 
-	$wrapper['normal'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
-	$wrapper['current'] = '<span class="page_link_normal">%2$d</span>';
-	$wrapper['first'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
-	$wrapper['last'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
+	if (!$wrapper)
+	{
+		$wrapper['normal'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
+		$wrapper['current'] = '<span class="page_link_normal">%2$d</span>';
+		$wrapper['first'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
+		$wrapper['last'] = '<span class="page_link_normal"><a href="%1$s">%2$d</a></span>';
+	}
 
 	$total_pages = ceil($total / $per_page);
 	$current_page = ($start) ? floor($start / $per_page) + 1 : 1;
@@ -640,7 +643,8 @@
 			require_once $file;
 		}
 
-		$_CLASS[$name] =& new $class;
+		//$_CLASS[$name] =& new $class;
+		$_CLASS[$name] = new $class;
 	}
 }
 
@@ -1026,4 +1030,27 @@
 	}
 }
 
+
+// FROM PHPBB
+
+// Smiley processing
+function smiley_text($text, $force_option = false)
+{
+	global $config, $_CLASS;
+
+	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->user_data_get('viewsmilies')) ? preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text) : str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
+}
+
+if (!function_exists('stripos'))
+{
+	function stripos($haystack, $needle)
+	{
+		if (preg_match('#' . preg_quote($needle, '#') . '#i', $haystack, $m))
+		{
+			return strpos($haystack, $m[0]);
+		}
+
+		return false;
+	}
+}
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -50,7 +50,7 @@
 			<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">&nbsp;{ $attachrow:POST_TIME }&nbsp;</td>
 			<td class="genmed" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">{ $attachrow:SIZE }</td>
 			<td class="genmed" style="padding: 4px;" align="center">{ $attachrow:DOWNLOAD_COUNT }</td>
-			<td style="padding: 4px;" align="center" valign="middle"><input type="checkbox" name="attachment[{ $attachrow:ATTACH_ID }]" value="1" /></td>
+			<td style="padding: 4px;" align="center" valign="middle"><input type="checkbox" name="attachment[]" value="{ $attachrow:ATTACH_ID }" /></td>
 		</tr>
 		<!-- ENDLOOP -->
 		
@@ -62,7 +62,6 @@
 	<div style="float:right"><b class="gensmall"><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
 </form>
 <!-- ELSE -->
-
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
 		<th height="28">{ $L_TITLE }</th>

Modified: cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html
===================================================================
--- cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -57,17 +57,9 @@
 				<td width="100%"><b class="gen">{ $VISITED }</b></td>
 			</tr>
 			<tr> 
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_TOTAL_POSTS }: </b></td>
-				<td><!-- IF { $POSTS_PCT } --><b class="gen">{ $POSTS }</b><br /><span class="genmed">[{ $POSTS_PCT } / { $POSTS_DAY }]<br /><a href="{ $U_SEARCH_USER }">{ $L_SEARCH_USER_POSTS }</a></span><!-- ELSE --><b class="gen">{ $POSTS }<b><!-- ENDIF --></td>
+				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_TOTAL_FORUM_POSTS }: </b></td>
+				<td><!-- IF { $POSTS } --><b class="gen">{ $POSTS }</b><br /><a href="{ $U_SEARCH_MY_POSTS }">{ $L_SEARCH_USER_POSTS }</a><!-- ELSE --><b class="gen">{ $POSTS }<b><!-- ENDIF --></td>
 			</tr>
-			<tr>
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_ACTIVE_IN_FORUM }: </b></td>
-				<td><!-- IF { $ACTIVE_FORUM_PCT } --><b><a class="gen" href="{ $U_ACTIVE_FORUM }">{ $ACTIVE_FORUM }</a></b><br /><span class="genmed">[ { $ACTIVE_FORUM_POSTS } / { $ACTIVE_FORUM_PCT } ]</span><!-- ELSE --><span class="gen">-</span><!-- ENDIF --></td>
-			</tr>
-			<tr>
-				<td align="right" valign="top" nowrap="nowrap"><b class="genmed">{ $L_ACTIVE_IN_TOPIC }: </b></td>
-				<td><!-- IF { $ACTIVE_TOPIC_PCT } --><b><a class="gen" href="{ $U_ACTIVE_TOPIC }">{ $ACTIVE_TOPIC }</a></b><br /><span class="gensmall">[ { $ACTIVE_TOPIC_POSTS } / { $ACTIVE_TOPIC_PCT } ]</span><!-- ELSE --><span class="gen">-</span><!-- ENDIF --></td>
-			</tr>
 			<!-- IF { $WARNINGS } -->
 			<tr>
 				<td align="right" valign="middle" nowrap="nowrap"><b class="genmed">{ $L_YOUR_WARNINGS }: </b></td>

Modified: cms/trunk/includes/templates/modules/forums/posting_topic_review.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/posting_topic_review.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/forums/posting_topic_review.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -28,7 +28,7 @@
 						<tr>
 							<td valign="top"><table width="100%" cellspacing="0" cellpadding="2">
 								<tr>
-									<td><div id="message_{ $topic_review_row:U_POST_ID }"><div class="postbody">{ $topic_review_row:MESSAGE }</div></div></td>
+									<td><div class="postbody" id="message_{ $topic_review_row:U_POST_ID }">{ $topic_review_row:MESSAGE }</div></td>
 								</tr>
 							</table></td>
 						</tr>

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -49,9 +49,8 @@
 		<tr>
 			<th nowrap="nowrap">#</th>
 			<th nowrap="nowrap" width="<!-- IF { $S_SEND_MESSAGE } -->20<!-- ELSE -->34<!-- ENDIF -->%"><a class="th" href="{ $U_SORT_USERNAME }">{ $L_USERNAME }</a></th>
+			<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_POSTS }">{ $L_ONLINE }</a></th>
 			<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_JOINED }">{ $L_JOINED }</a></th>
-			<th nowrap="nowrap" width="10%"><a class="th" href="{ $U_SORT_POSTS }">{ $L_POSTS }</a></th>
-			<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_RANK }">{ $L_RANK }</a></th>
 		<!-- IF { $S_SEND_MESSAGE } -->
 			<th nowrap="nowrap" width="11%">{ $L_SEND_MESSAGE }</th>
 		<!-- ENDIF -->
@@ -77,9 +76,8 @@
 
 			<td class="gen" align="center">{ $leader_row:#LOOP_NUMBER }</td>
 			<td class="gen" align="center"><strong><a<!-- IF { $leader_row:USER_COLOR } --> style="color:#{ $leader_row:USER_COLOR }"<!-- ENDIF --> href="{ $leader_row:U_VIEWPROFILE }">{ $leader_row:USERNAME }</a></strong></td>
-			<td class="gensmall" align="center" nowrap="nowrap">{$leader_row:JOINED}</td>
-			<td class="gen" align="center">{ $leader_row:POSTS }</td>
-			<td class="gen" align="center">{ $leader_row:RANK_IMG }</td>
+			<td class="gen" align="center">{ $leader_row:ONLINE_IMG }</td>
+			<td class="gensmall" align="center" nowrap="nowrap"> { $leader_row:JOINED } </td>
 			<!-- IF { $leader_row:U_PM } --><td class="gen" align="center"><a href="{ $leader_row:U_PM }">{ $PM_IMG }</a></td><!-- ENDIF -->
 			<td class="gen" align="center"><!-- IF { $leader_row:U_EMAIL } --><a href="{ $leader_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF --></td>
 			<td class="gen" align="center"><!-- IF { $leader_row:U_WWW } --><a href="{ $leader_row:U_WWW }" target="_blank">{ $WWW_IMG }</a><!-- ENDIF --></td>
@@ -102,9 +100,8 @@
 		<!-- ENDIF -->
 			<td class="gen" align="center">{ $member_row:#LOOP_NUMBER }</td>
 			<td class="gen" align="center"><strong><a<!-- IF { $member_row:USER_COLOR } --> style="color:#{ $member_row:USER_COLOR }"<!-- ENDIF --> href="{ $member_row:U_VIEWPROFILE }">{ $member_row:USERNAME }</a></strong></td>
+			<td class="gen" align="center">{ $member_row:ONLINE_IMG }</td>
 			<td class="gensmall" align="center" nowrap="nowrap">{ $member_row:JOINED }</td>
-			<td class="gen" align="center">{ $member_row:POSTS }</td>
-			<td class="gen" align="center">{ $member_row:RANK_IMG }</td>
 			<!-- IF { $member_row:U_PM } -->
 			<td class="gen" align="center"><a href="{ $member_row:U_PM }">{ $PM_IMG }</a></td><!-- ENDIF -->
 			<td class="gen" align="center"><!-- IF { $member_row:U_EMAIL } --><a href="{ $member_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF --></td>

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_footer.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_footer.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -1,16 +1 @@
-<!--
-	We request you retain the full copyright notice below including the link to www.phpbb.com.
-	This not only gives respect to the large amount of time given freely by the developers
-	but also helps build interest, traffic and use of phpBB2. If you (honestly) cannot retain
-	the full copyright we ask you at least leave in place the "Powered by phpBB" line, with
-	"phpBB" linked to www.phpbb.com. If you refuse to include even this then support on our 
-	forums may be affected.
-
-	The phpBB Group : 2003
--->
-
-<br />
-<div style="text-align: center;" class="copyright">
-Based on <a href="http://www.phpbb.com/" target="phpbb">phpBB</a></div>
-
 { $THEME_TABLE_CLOSE }
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -0,0 +1,45 @@
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/Members_List/memberlist_header.html -->
+
+<form method="post" action="{ $S_MODE_ACTION }">
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th nowrap="nowrap" width="20%">{ $L_USERNAME }</th>
+			<th nowrap="nowrap" width="25%">{ $L_FORUMS }</th>
+			<th nowrap="nowrap" width="20%">{ $L_PRIMARY_GROUP }</th>
+			<th nowrap="nowrap" width="15%">{ $L_RANK }</th>
+			<th nowrap="nowrap" width="11%">{ $L_SEND_MESSAGE }</th>
+		</tr>
+		<tr class="row3">
+			<td colspan="9"><b class="gensmall">{ $L_MODERATORS }</b></td>
+		</tr>
+	
+		<!-- LOOP $moderators -->
+			<!-- IF { $moderators:#LOOP_INDEX } % 2 --><tr class="row2"><!-- ELSE --><tr class="row1"><!-- ENDIF -->
+		
+			<td class="gen" align="center"><strong><a<!-- IF { $moderators:USER_COLOR } --> style="color:#{ $moderators:USER_COLOR }"<!-- ENDIF --> href="{ $moderators:U_VIEWPROFILE }">{ $moderators:USERNAME }</a></strong></td>
+			<td align="center"><!-- IF !{ $moderators:FORUMS } -->{ $L_ALL_FORUMS }<!-- ELSE --><select style="width: 200px;">{ $moderators:FORUMS }</select><!-- ENDIF -->&nbsp;</td>
+			<td class="gensmall" align="center" nowrap="nowrap">&nbsp;
+				<!-- IF { $moderators:U_GROUP } -->
+					<a<!-- IF { $moderators:GROUP_COLOR } --> style="color:#{ $moderators:GROUP_COLOR }"<!-- ENDIF --> href="{ $moderators:U_GROUP }">{ $moderators:GROUP_NAME }</a>
+				<!-- ELSE -->
+					{ $moderators:GROUP_NAME }
+				<!-- ENDIF -->
+			&nbsp;</td>
+			<td class="gen" align="center">{ $moderators:RANK_IMG }</td>
+			<td class="gen" align="center">&nbsp;<!-- IF { $moderators:U_PM } --><a href="{ $moderators:U_PM }">{ $PM_IMG }</a><!-- ENDIF -->&nbsp;</td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr>
+			<td class="row1" colspan="9" height="28" align="center"><span class="gen">{ $L_NO_MEMBERS }</span></td>
+		</tr>
+		<!-- ENDLOOP $moderators -->
+	</table>
+</form>
+
+<br clear="all" />
+
+<!-- INCLUDE modules/Members_List/memberlist_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -1,69 +0,0 @@
-<!-- DISPLAY_HEADER -->
-
-<!-- INCLUDE modules/Members_List/memberlist_header.html -->
-
-<form method="post" action="{$S_MODE_ACTION}">
-
-<table class="tablebg" width="100%" cellspacing="1">
-<tr>
-	<th nowrap="nowrap" width="20%">{ $L_USERNAME }</th>
-	<th nowrap="nowrap" width="25%">{ $L_FORUMS }</th>
-	<th nowrap="nowrap" width="20%">{ $L_PRIMARY_GROUP }</th>
-	<th nowrap="nowrap" width="15%">{ $L_RANK }</th>
-	<th nowrap="nowrap" width="11%">{ $L_SEND_MESSAGE }</th>
-</tr>
-<tr class="row3">
-	<td colspan="5"><b class="gensmall">{ $L_ADMINISTRATORS }</b></td>
-</tr>
-<!-- LOOP $admin -->
-	<!-- IF { $admin:#LOOP_INDEX is even } --><tr class="row2"><!-- ELSE --><tr class="row1"><!-- ENDIF -->
-
-	<td class="gen" align="center"><strong><a<!-- IF { $admin:USER_COLOR } --> style="color:#{ $admin:USER_COLOR }"<!-- ENDIF --> href="{ $admin:U_VIEWPROFILE }">{ $admin:USERNAME }</a></strong></td>
-	<td class="gensmall" align="center">&nbsp;</td>
-	<td class="gensmall" align="center" nowrap="nowrap">&nbsp;
-		<!-- IF { $admin:U_GROUP } -->
-			<a<!-- IF { $admin:GROUP_COLOR } --> style="color:#{ $admin:GROUP_COLOR }"<!-- ENDIF --> href="{ $admin:U_GROUP }">{ $admin:GROUP_NAME }</a>
-		<!-- ELSE -->
-			{ $admin:GROUP_NAME }
-		<!-- ENDIF -->
-	&nbsp;</td>
-	<td class="gen" align="center">{ $admin:RANK_IMG }</td>
-	<td class="gen" align="center">&nbsp;<!-- IF { $admin:U_PM } --><a href="{ $admin:U_PM }">{ $PM_IMG }</a><!-- ENDIF -->&nbsp;</td>
-</tr>
-<!-- LOOPELSE -->
-<tr>
-	<td class="row1" colspan="9" height="28" align="center"><span class="gen">{ $L_NO_MEMBERS }</span></td>
-</tr>
-<!-- ENDLOOP -->
-<tr class="row3">
-	<td colspan="9"><b class="gensmall">{ $L_MODERATORS }</b></td>
-</tr>
-<!-- LOOP $mod -->
-	<!-- IF { $mod:S_ROW_COUNT is even } --><tr class="row2"><!-- ELSE -->	<tr class="row1"><!-- ENDIF -->
-
-	<td class="gen" align="center"><strong><a<!-- IF { $mod:USER_COLOR } --> style="color:#{ $mod:USER_COLOR }"<!-- ENDIF --> href="{ $mod:U_VIEWPROFILE }">{ $mod:USERNAME }</a></strong></td>
-	<td align="center"><!-- IF !{ $mod:FORUMS } -->{ $L_ALL_FORUMS }<!-- ELSE --><select style="width: 200px;">{ $mod:FORUMS }</select><!-- ENDIF -->&nbsp;</td>
-	<td class="gensmall" align="center" nowrap="nowrap">&nbsp;
-		<!-- IF { $mod:U_GROUP } -->
-			<a<!-- IF { $mod:GROUP_COLOR } --> style="color:#{ $mod:GROUP_COLOR }"<!-- ENDIF --> href="{ $mod:U_GROUP }">{ $mod:GROUP_NAME }</a>
-		<!-- ELSE -->
-			{ $mod:GROUP_NAME }
-		<!-- ENDIF -->
-	&nbsp;</td>
-	<td class="gen" align="center">{ $mod:RANK_IMG }</td>
-	<td class="gen" align="center">&nbsp;<!-- IF { $mod:U_PM } --><a href="{ $mod:U_PM }">{ $PM_IMG }</a><!-- ENDIF -->&nbsp;</td>
-</tr>
-<!-- LOOPELSE -->
-<tr>
-	<td class="row1" colspan="9" height="28" align="center"><span class="gen">{ $L_NO_MEMBERS }</span></td>
-</tr>
-<!-- ENDLOOP -->
-</table>
-	
-</form>
-
-<br clear="all" />
-
-<!-- INCLUDE modules/Members_List/memberlist_footer.html -->
-
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/index.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -27,7 +27,8 @@
 /* require_once SITE_FILE_ROOT.'core.php'; */
 require_once 'core.php';
 
-$mod = get_variable('mod', 'REQUEST', false);
+/* mb_strtolower is a temp... */
+$mod = mb_strtolower(get_variable('mod', 'REQUEST', false));
 
 if (!$mod)
 {

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/install/build_data.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -139,12 +139,12 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 1, 1, 102)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Contact', 1, 2, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('contact', 1, 2, 102)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 1, 1, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Control_Panel', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Forums', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Members_List', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('Quick_Message', 1, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('forums', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('members_List', 1, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 1, 1, 102)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/index.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -51,19 +51,23 @@
 	function process_module($type = 'page')
 	{
 		global $_CLASS;
-
-		$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. "
-					WHERE module_name = '".$_CLASS['core_db']->escape($this->module)."'";
-		$result = $_CLASS['core_db']->query($sql);
 		
-		if (!$module_info = $_CLASS['core_db']->fetch_row_assoc($result) || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this->module . '.php'))
+		if ($this->module)
 		{
+			$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. "
+					WHERE module_name = '".$_CLASS['core_db']->escape($this->module)."'";
+			$result = $_CLASS['core_db']->query($sql);
+			$module_info = $_CLASS['core_db']->fetch_row_assoc($result);
+		}
+
+		if (!$this->module || !$module_info || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this->module . '.php'))
+		{
 			$this->module = 'main';
-			$this->mode = false;
+			$this->mode = ($this->module) ? false : $this->mode;
 		}
-		
-		$this->link_standard = $this->link = 'control_panel&amp;i='.$this->module;
 
+		$this->link_parent = $this->link = 'control_panel&amp;i='.$this->module;
+
 		if ($this->mode)
 		{
 			$this->link .= '&amp;mode='.$this->mode;
@@ -161,14 +165,11 @@
 			'friends_offline' 		=> false,
 		));
 		
-		$mode = get_variable('mode', 'REQUEST');
-		$module = get_variable('i', 'REQUEST');
-
 		$_CLASS['core_user']->add_lang();
 
-		if (!$module && $mode)
+		if (!$this->module && $this->mode)
 		{
-			switch ($mode)
+			switch ($this->mode)
 			{
 				case 'register':
 					if ($_CLASS['core_user']->is_user || $_CLASS['core_user']->is_bot)
@@ -245,7 +246,7 @@
 		$this->process_module('page');
 		$this->generate_panel_block('page');
 
-		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $module . '.php';
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $this->module . '.php';
 	}
 }
 

Modified: cms/trunk/modules/control_panel/modules/ucp_attachments.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_attachments.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_attachments.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -15,148 +15,152 @@
 // * Use this for ACP integration - changeable user id
 //
 
-class ucp_attachments extends module
+
+global $_CLASS, $config, $site_file_root;
+
+$start	= get_variable('start', 'REQUEST', 0, 'int');
+$delete = isset($_POST['delete']);
+$confirm = isset($_POST['confirm']);
+
+// change this
+$delete_ids = array_unique(get_variable('attachment', 'POST', array(), 'array:int'));
+
+if (!empty($delete_ids))
 {
-	function ucp_attachments($id, $mode)
+	$hidden_fields['delete'] = 1;
+	$hidden_fields['attachment'] = $delete_ids;
+
+	if (display_confirmation($_CLASS['core_user']->get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), generate_hidden_fields($hidden_fields)))
 	{
-		global $_CLASS, $config, $site_file_root;
+		require_once $site_file_root.'includes/forums/functions_admin.php';
+		require_once $site_file_root.'includes/forums/functions.php';
 
-		$start	= request_var('start', 0);
-		$delete = (isset($_POST['delete'])) ? true : false;
-		$confirm = (isset($_POST['confirm'])) ? true : false;
-		$delete_ids = isset($_REQUEST['attachment']) ? array_keys(array_map('intval', $_REQUEST['attachment'])) : array();
-		
-		if (!empty($delete_ids))
-		{
-			$s_hidden_fields = '<input type="hidden" name="delete" value="1" />';
-			foreach ($delete_ids as $attachment_id)
-			{
-				$s_hidden_fields .= '<input type="hidden" name="attachment[' . $attachment_id . ']" value="1" />';
-			}
+		$_CLASS['core_db']->transaction();
+		delete_attachments('attach', $delete_ids);
+		$_CLASS['core_db']->transaction('commit');
 
-			if (display_confirmation($_CLASS['core_user']->get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), $s_hidden_fields))
-			{
-				require($site_file_root.'includes/forums/functions_admin.php');
-				delete_attachments('attach', $delete_ids);
+		$return_link = generate_link($this->link_parent);
 
-				$refresh_url = generate_link('Control_Panel&amp;i='.$id);
-				$_CLASS['core_display']->meta_refresh(3, $refresh_url);
-				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']->lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']->lang['ATTACHMENTS_DELETED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $refresh_url . '">', '</a>');
+		$_CLASS['core_display']->meta_refresh(3, $return_link);
+		$message = ((count($delete_ids) === 1) ? $_CLASS['core_user']->lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']->lang['ATTACHMENTS_DELETED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $return_link . '">', '</a>');
 
-				trigger_error($message);
-			}
-		}
-		
-		$sort_key = request_var('sk', 'a');
-		$sort_dir = request_var('sd', 'a');
+		trigger_error($message);
+	}
+}
 
-		// Select box eventually
-		$sort_key_text = array('a' => $_CLASS['core_user']->lang['SORT_FILENAME'], 'b' => $_CLASS['core_user']->lang['SORT_COMMENT'], 'c' => $_CLASS['core_user']->lang['SORT_EXTENSION'], 'd' => $_CLASS['core_user']->lang['SORT_SIZE'], 'e' => $_CLASS['core_user']->lang['SORT_DOWNLOADS'], 'f' => $_CLASS['core_user']->lang['SORT_POST_TIME'], 'g' => $_CLASS['core_user']->lang['SORT_TOPIC_TITLE']);
-		$sort_key_sql = array('a' => 'a.real_filename', 'b' => 'a.comment', 'c' => 'a.extension', 'd' => 'a.filesize', 'e' => 'a.download_count', 'f' => 'a.filetime', 'g' => 't.topic_title');
+$sort_key = get_variable('sk', 'REQUEST', 'a');
+$sort_dir = get_variable('sd', 'REQUEST', 'a');
 
-		$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
-	
-		$s_sort_key = '';
-		foreach ($sort_key_text as $key => $value)
-		{
-			$selected = ($sort_key == $key) ? ' selected="selected"' : '';
-			$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
-		}
+// Select box eventually
+$sort_key_text = array('a' => $_CLASS['core_user']->lang['SORT_FILENAME'], 'b' => $_CLASS['core_user']->lang['SORT_COMMENT'], 'c' => $_CLASS['core_user']->lang['SORT_EXTENSION'], 'd' => $_CLASS['core_user']->lang['SORT_SIZE'], 'e' => $_CLASS['core_user']->lang['SORT_DOWNLOADS'], 'f' => $_CLASS['core_user']->lang['SORT_POST_TIME'], 'g' => $_CLASS['core_user']->lang['SORT_TOPIC_TITLE']);
+$sort_key_sql = array('a' => 'a.real_filename', 'b' => 'a.comment', 'c' => 'a.extension', 'd' => 'a.filesize', 'e' => 'a.download_count', 'f' => 'a.filetime', 'g' => 't.topic_title');
 
-		$s_sort_dir = '';
-		foreach ($sort_dir_text as $key => $value)
-		{
-			$selected = ($sort_dir == $key) ? ' selected="selected"' : '';
-			$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
-		}
+$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
 
-		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
-		
-		$sql = 'SELECT COUNT(*) as num_attachments
-			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
-			WHERE poster_id = ' . $_CLASS['core_user']->data['user_id'];
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
-		list($num_attachments) = $_CLASS['core_db']->fetch_row_num($result);
-		$_CLASS['core_db']->free_result($result);
-		
-		$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
-			FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
-				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
-					AND a.in_message = 0)
-				LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
-					AND a.in_message = 1)
-			WHERE a.poster_id = ' . $_CLASS['core_user']->data['user_id'] . "
-			ORDER BY $order_by";
-		$result = $_CLASS['core_db']->query_limit($sql, $config['posts_per_page'], $start);
+$s_sort_key = '';
+foreach ($sort_key_text as $key => $value)
+{
+	$selected = ($sort_key == $key) ? ' selected="selected"' : '';
+	$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
+}
 
-		$row_count = 0;
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', true);
+$s_sort_dir = '';
+foreach ($sort_dir_text as $key => $value)
+{
+	$selected = ($sort_dir == $key) ? ' selected="selected"' : '';
+	$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
+}
 
-			do
-			{
-				if ($row['in_message'])
-				{
-					$view_topic = generate_link('Control_Panel&amp;i=pm&amp;p='.$row['post_msg_id']);
-				}
-				else
-				{
-					$view_topic = generate_link("Forums&amp;file=viewtopic&amp;t={$row['topic_id']}&amp;p={$row['post_msg_id']}#{$row['post_msg_id']}");
-				}
+$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
 
-				$_CLASS['core_template']->assign_vars_array('attachrow', array(
-					'ROW_NUMBER'		=> $row_count + ($start + 1),
-					'FILENAME'			=> $row['real_filename'],
-					'COMMENT'			=> str_replace("\n", '<br />', $row['comment']),
-					'EXTENSION'			=> $row['extension'],
-					'SIZE'				=> ($row['filesize'] >= 1048576) ? ($row['filesize'] >> 20) . ' ' . $_CLASS['core_user']->lang['MB'] : (($row['filesize'] >= 1024) ? ($row['filesize'] >> 10) . ' ' . $_CLASS['core_user']->lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']->lang['BYTES']),
-					'DOWNLOAD_COUNT'	=> $row['download_count'],
-					'POST_TIME'			=> $_CLASS['core_user']->format_date($row['filetime'], $_CLASS['core_user']->lang['DATE_FORMAT']),
-					'TOPIC_TITLE'		=> ($row['in_message']) ? $row['message_title'] : $row['topic_title'],
+$sql = 'SELECT COUNT(*) as num_attachments
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+	WHERE poster_id = ' . $_CLASS['core_user']->data['user_id'];
+$result = $_CLASS['core_db']->query($sql);
+list($num_attachments) = $_CLASS['core_db']->fetch_row_num($result);
+$_CLASS['core_db']->free_result($result);
 
-					'ATTACH_ID'			=> $row['attach_id'],
-					'POST_ID'			=> $row['post_msg_id'],
-					'TOPIC_ID'			=> $row['topic_id'],
-				
-					'S_IN_MESSAGE'		=> $row['in_message'],
+$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
+		LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
+			AND a.in_message = 0)
+		LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
+			AND a.in_message = 1)
+	WHERE a.poster_id = ' . $_CLASS['core_user']->data['user_id'] . "
+	ORDER BY $order_by";
+$result = $_CLASS['core_db']->query_limit($sql, 10, $start);
 
-					'U_VIEW_ATTACHMENT'	=> generate_link('Forums&amp;file=download&amp;id=' . $row['attach_id']),
-					'U_VIEW_TOPIC'		=> $view_topic)
-				);
+$row_count = 0;
 
-				$row_count++;
-			} 
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', true);
+
+	do
+	{
+		if ($row['in_message'])
+		{
+			$view_topic = generate_link('control_panel&amp;i=pm&amp;p='.$row['post_msg_id']);
 		}
 		else
 		{
-			$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', false);
+			$view_topic = generate_link("forums&amp;file=viewtopic&amp;t={$row['topic_id']}&amp;p={$row['post_msg_id']}#{$row['post_msg_id']}");
 		}
-		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign_array(array( 
-			'PAGE_NUMBER'			=> on_page($num_attachments, $config['posts_per_page'], $start),
-			'PAGINATION'			=> generate_pagination("Control_Panel&amp;i=$id&amp;sk=$sort_key&amp;sd=$sort_dir", $num_attachments, $config['posts_per_page'], $start),
-			'TOTAL_ATTACHMENTS'		=> $num_attachments,
-			
-			'U_SORT_FILENAME'		=> generate_link("Control_Panel&amp;i=$id&amp;sk=a&amp;sd=" . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_FILE_COMMENT'	=> generate_link("Control_Panel&amp;i=$id&amp;sk=b&amp;sd=" . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_EXTENSION'		=> generate_link("Control_Panel&amp;i=$id&amp;sk=c&amp;sd=" . (($sort_key == 'c' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_FILESIZE'		=> generate_link("Control_Panel&amp;i=$id&amp;sk=d&amp;sd=" . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_DOWNLOADS'		=> generate_link("Control_Panel&amp;i=$id&amp;sk=e&amp;sd=" . (($sort_key == 'e' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_POST_TIME'		=> generate_link("Control_Panel&amp;i=$id&amp;sk=f&amp;sd=" . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_TOPIC_TITLE'	=> generate_link("Control_Panel&amp;i=$id&amp;sk=g&amp;sd=" . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a')), 
+		$_CLASS['core_template']->assign_vars_array('attachrow', array(
+			'ROW_NUMBER'		=> $row_count + ($start + 1),
+			'FILENAME'			=> $row['real_filename'],
+			'COMMENT'			=> str_replace("\n", '<br />', $row['comment']),
+			'EXTENSION'			=> $row['extension'],
+			'SIZE'				=> ($row['filesize'] >= 1048576) ? ($row['filesize'] >> 20) . ' ' . $_CLASS['core_user']->lang['MB'] : (($row['filesize'] >= 1024) ? ($row['filesize'] >> 10) . ' ' . $_CLASS['core_user']->lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']->lang['BYTES']),
+			'DOWNLOAD_COUNT'	=> $row['download_count'],
+			'POST_TIME'			=> $_CLASS['core_user']->format_date($row['filetime'], $_CLASS['core_user']->lang['DATE_FORMAT']),
+			'TOPIC_TITLE'		=> ($row['in_message']) ? $row['message_title'] : $row['topic_title'],
 
-			'S_DISPLAY_MARK_ALL'	=> ($num_attachments) ? true : false,
-			'S_DISPLAY_PAGINATION'	=> ($num_attachments) ? true : false,
-			'S_UCP_ACTION'			=> generate_link('Control_Panel&amp;i='.$id),
-			'S_SORT_OPTIONS' 		=> $s_sort_key,
-			'S_ORDER_SELECT'		=> $s_sort_dir)
+			'ATTACH_ID'			=> $row['attach_id'],
+			'POST_ID'			=> $row['post_msg_id'],
+			'TOPIC_ID'			=> $row['topic_id'],
+		
+			'S_IN_MESSAGE'		=> $row['in_message'],
+
+			'U_VIEW_ATTACHMENT'	=> generate_link('forums&amp;file=download&amp;id=' . $row['attach_id']),
+			'U_VIEW_TOPIC'		=> $view_topic)
 		);
 
-		$this->display($_CLASS['core_user']->lang['UCP_ATTACHMENTS'], 'ucp_attachments.html');
-	}
+		$row_count++;
+	} 
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 }
+else
+{
+	$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', false);
+}
+$_CLASS['core_db']->free_result($result);
 
+$pagination = generate_pagination($this->link."&amp;sk=$sort_key&amp;sd=$sort_dir", $num_attachments, 10, $start);
+
+$_CLASS['core_template']->assign_array(array( 
+	'PAGE_NUMBER'			=> on_page($num_attachments, 10, $start),
+	'PAGINATION'			=> $pagination['formated'],
+	'PAGINATION_ARRAY'		=> $pagination['array'],
+	'TOTAL_ATTACHMENTS'		=> $num_attachments,
+
+	'U_SORT_FILENAME'		=> generate_link($this->link.'&amp;sk=a&amp;sd=' . (($sort_key == 'a' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_FILE_COMMENT'	=> generate_link($this->link.'&amp;sk=b&amp;sd=' . (($sort_key == 'b' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_EXTENSION'		=> generate_link($this->link.'&amp;sk=c&amp;sd=' . (($sort_key == 'c' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_FILESIZE'		=> generate_link($this->link.'&amp;sk=d&amp;sd=' . (($sort_key == 'd' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_DOWNLOADS'		=> generate_link($this->link.'&amp;sk=e&amp;sd=' . (($sort_key == 'e' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_POST_TIME'		=> generate_link($this->link.'&amp;sk=f&amp;sd=' . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_TOPIC_TITLE'	=> generate_link($this->link.'&amp;sk=g&amp;sd=' . (($sort_key == 'f' && $sort_dir == 'a') ? 'd' : 'a')), 
+
+	'S_DISPLAY_MARK_ALL'	=> ($num_attachments) ? true : false,
+	'S_DISPLAY_PAGINATION'	=> ($num_attachments) ? true : false,
+	'S_UCP_ACTION'			=> generate_link($this->link),
+	'S_SORT_OPTIONS' 		=> $s_sort_key,
+	'S_ORDER_SELECT'		=> $s_sort_dir)
+);
+
+$_CLASS['core_display']->display($_CLASS['core_user']->lang['UCP_ATTACHMENTS'], 'modules/control_panel/ucp_attachments.html');
+
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_groups.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_groups.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_groups.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,170 +21,164 @@
 $Id$
 */
 
-class ucp_groups extends module
+
+global $_CLASS, $site_file_root;
+
+$_CLASS['core_user']->add_lang('groups');
+
+$submit	= isset($_POST['submit']);
+
+if ($submit && !empty($_POST['group_id']))
 {
-	function ucp_groups($id, $mode)
+	if (is_array($_POST['group_id']))
 	{
-		global $_CLASS, $site_file_root;
+		$group_id = array_unique(get_variable('group_id', 'POST', array(), 'array:int'));
+	}
+	else
+	{
+		if ($group_id = get_variable('group_id', 'POST', false, 'interger'))
+		{
+			$group_id = array($group_id);
+		}
+		else
+		{
+			die;
+		}
+	}
+	
+	if (empty($group_id))
+	{
+		die; //temp
+	}
 
-		$_CLASS['core_user']->add_lang('groups');
+	require_once($site_file_root.'includes/functions_user.php');
 
-		$submit	= isset($_POST['submit']) ? $_POST['submit'] : false;
+	switch ($_POST['mode'])
+	{
+		case 'resign':
+			$sql = 'SELECT m.member_status, g.group_id, g.group_type
+						FROM ' . CORE_GROUPS_MEMBERS_TABLE . ' m, ' . CORE_GROUPS_TABLE . ' g 
+						WHERE m.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+						AND m.group_id IN ('. implode(', ', $group_id) .')';
 
-		if ($submit && !empty($_POST['group_id']))
-		{
-			if (is_array($_POST['group_id']))
+			$result = $_CLASS['core_db']->query($sql);
+
+			$unset = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$group_id = array_unique(get_variable('group_id', 'REQUEST', array(), 'array:int'));
-			}
-			else
-			{
-				if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+				if ($row['group_type'] == GROUP_SYSTEM && $row['group_type'] == GROUP_SPECIAL && $row['member_status'] != STATUS_PENDING)
 				{
-					$group_id = array($group_id);
+					$unset[] = $row['user_id'];
 				}
-				else
-				{
-					die;
-				}
 			}
-			
-			if (empty($group_id))
-			{
-				die; //temp
-			}
+			$_CLASS['core_db']->free_result($result);
 
-			require_once($site_file_root.'includes/functions_user.php');
+			$group_id = array_diff($group_id, $unset);
+			unset($unset);
 
-			switch ($_POST['mode'])
+			if (!empty($group_id))
 			{
-				case 'resign':
-					$sql = 'SELECT m.member_status, g.group_id, g.group_type
-								FROM ' . USER_GROUP_TABLE . ' m, ' . GROUPS_TABLE . ' g 
-								WHERE m.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-								AND m.group_id IN ('. implode(', ', $group_id) .')';
+				groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
+			}
+		break;
 
-					$result = $_CLASS['core_db']->query($sql);
+		case 'apply':
+			$sql = 'SELECT group_id FROM ' . CORE_GROUPS_MEMBERS_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+				AND group_id IN ('. implode(', ', $group_id) .')';
 
-					$unset = array();
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						if ($row['group_type'] == GROUP_SYSTEM && $row['group_type'] == GROUP_SPECIAL && $row['member_status'] != STATUS_PENDING)
-						{
-							$unset[] = $row['user_id'];
-						}
-					}
-					$_CLASS['core_db']->free_result($result);
+			$result = $_CLASS['core_db']->query($sql);
 
-					$group_id = array_diff($group_id, $unset);
-					unset($unset);
+			$unset = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$unset[] = $row['group_id'];
+			}
+			$_CLASS['core_db']->free_result($result);
 
-					if (!empty($group_id))
-					{
-						groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
-					}
-				break;
+			$group_id = array_diff($group_id, $unset);
+			unset($unset);
 
-				case 'apply':
-					$sql = 'SELECT group_id FROM ' . USER_GROUP_TABLE . '
-						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-						AND group_id IN ('. implode(', ', $group_id) .')';
+			if (!empty($group_id))
+			{
+				$sql = 'SELECT group_id, group_status, group_type FROM  ' . CORE_GROUPS_TABLE . '
+							WHERE group_id IN ('. implode(', ', $group_id) .')';
+				$result = $_CLASS['core_db']->query($sql);
 
-					$result = $_CLASS['core_db']->query($sql);
+				$group_id = array();
 
-					$unset = array();
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$unset[] = $row['group_id'];
-					}
-					$_CLASS['core_db']->free_result($result);
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
 
-					$group_id = array_diff($group_id, $unset);
-					unset($unset);
-
-					if (!empty($group_id))
+					if ($row['group_status'] == STATUS_ACTIVE)
 					{
-						$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
-									WHERE group_id IN ('. implode(', ', $group_id) .')';
-						$result = $_CLASS['core_db']->query($sql);
-	
-						$group_id = array();
-	
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-						{
-							$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
-	
-							if ($row['group_status'] == STATUS_ACTIVE)
-							{
-								$group_id[$status][] = $row['group_id'];
-							}
-						}
-						$_CLASS['core_db']->free_result($result);
-	
-						foreach ($group_id as $status => $ids)
-						{
-							groups_user_add($ids, $_CLASS['core_user']->data['user_id'], $status);
-						}
+						$group_id[$status][] = $row['group_id'];
 					}
-				break;		
+				}
+				$_CLASS['core_db']->free_result($result);
+
+				foreach ($group_id as $status => $ids)
+				{
+					groups_user_add($ids, $_CLASS['core_user']->data['user_id'], $status);
+				}
 			}
-		}
+		break;		
+	}
+}
 
-		$error = $data = array();
+$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
+	FROM ' . CORE_GROUPS_TABLE . ' g, ' . CORE_GROUPS_MEMBERS_TABLE . ' ug
+	WHERE ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+		AND g.group_id = ug.group_id
+	ORDER BY g.group_type DESC, g.group_name';
+$result = $_CLASS['core_db']->query($sql);
 
-		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
-			FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
-			WHERE ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-				AND g.group_id = ug.group_id
-			ORDER BY g.group_type DESC, g.group_name';
-		$result = $_CLASS['core_db']->query($sql);
+$group_array = array();
 
-		$group_array = array();
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$row['group_status'] = STATUS_ACTIVE;
 
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$row['group_status'] = STATUS_ACTIVE;
+	$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
-			$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
+	$_CLASS['core_template']->assign_vars_array($block, array(
+		'GROUP_ID'			=> $row['group_id'],
+		'GROUP_NAME'		=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
+		'GROUP_DESC'		=> $row['group_description'],
+		'GROUP_RESIGN'		=> ($row['member_status'] == STATUS_PENDING || ($row['group_type'] != GROUP_SYSTEM && $row['group_type'] != GROUP_SPECIAL)),
+		'U_VIEW_GROUP'		=> generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id']),
+		'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['user_group']) ? true : false
+	));
 
-			$_CLASS['core_template']->assign_vars_array($block, array(
-				'GROUP_ID'			=> $row['group_id'],
-				'GROUP_NAME'		=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'		=> $row['group_description'],
-				'GROUP_RESIGN'		=> ($row['member_status'] == STATUS_PENDING || ($row['group_type'] != GROUP_SYSTEM && $row['group_type'] != GROUP_SPECIAL)),
-				'U_VIEW_GROUP'		=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
-				'S_GROUP_DEFAULT'	=> ($row['group_id'] == $_CLASS['core_user']->data['user_group']) ? true : false
-			));
+	$group_array[] = $row['group_id'];
+}
+$_CLASS['core_db']->free_result($result);
 
-			$group_array[] = $row['group_id'];
-		}
-		$_CLASS['core_db']->free_result($result);
+$sql_and = 'AND group_type NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
-		$sql_and = 'AND group_type NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
+$sql = 'SELECT group_id, group_name, group_description, group_type
+	FROM ' . CORE_GROUPS_TABLE . '
+	WHERE group_id NOT IN (' . implode(', ', $group_array) . ')
+		AND group_status = '. STATUS_ACTIVE ." $sql_and
+	ORDER BY group_type DESC, group_name";
+$result = $_CLASS['core_db']->query($sql);
 
-		$sql = 'SELECT group_id, group_name, group_description, group_type
-			FROM ' . GROUPS_TABLE . '
-			WHERE group_id NOT IN (' . implode(', ', $group_array) . ')
-				AND group_status = '. STATUS_ACTIVE ." $sql_and
-			ORDER BY group_type DESC, group_name";
-		$result = $_CLASS['core_db']->query($sql);
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$_CLASS['core_template']->assign_vars_array('nonmember', array(
+		'GROUP_ID'		=> $row['group_id'],
+		'GROUP_NAME'	=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
+		'GROUP_DESC'	=> $row['group_description'],
+		'GROUP_APPLY'	=> true,
+		'U_VIEW_GROUP'	=> generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id'])
+	));
+}
+$_CLASS['core_db']->free_result($result);
 
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$_CLASS['core_template']->assign_vars_array('nonmember', array(
-				'GROUP_ID'		=> $row['group_id'],
-				'GROUP_NAME'	=> isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'	=> $row['group_description'],
-				'GROUP_APPLY'	=> true,
-				'U_VIEW_GROUP'	=> generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
-			));
-		}
-		$_CLASS['core_db']->free_result($result);
+$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link($this->link));
 
-		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'modules/control_panel/ucp_groups_membership.html');
 
-		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
-	}
-}
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_main.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_main.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_main.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -11,763 +11,721 @@
 // 
 // -------------------------------------------------------------
 
-class ucp_main extends module  
-{
-	function ucp_main($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
+global $_CLASS, $_CORE_CONFIG;
 
-		$_CLASS['core_template']->assign_array(array(
-			'ERROR' 		=> false,
-			'topicrow'		=> false,
-			'WARNINGS'		=> false,
-			'draftrow'		=> false
-		));
+$_CLASS['core_template']->assign_array(array(
+	'ERROR' 		=> false,
+	'topicrow'		=> false,
+	'WARNINGS'		=> false,
+	'draftrow'		=> false
+));
 
-		$_CLASS['core_user']->user_setup();
+$s_hidden_fields = '';
 
-		switch ($mode)
-		{
-			case 'front':
-				$_CLASS['core_user']->add_lang(false,'Members_List');
+$_CLASS['core_user']->user_setup();
 
-				if ($config['load_db_lastread'] || $config['load_db_track'])
-				{
-					if ($config['load_db_lastread'])
-					{
-						$sql = 'SELECT mark_time 
-							FROM ' . FORUMS_TRACK_TABLE . ' 
-							WHERE forum_id = 0
-								AND user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$result = $_CLASS['core_db']->query($sql);
+switch ($this->mode)
+{
+	case 'subscribed':
+		$_CLASS['core_user']->add_img(false, 'forums');
 
-						$track_data = $_CLASS['core_db']->fetch_row_assoc($result);
-						$_CLASS['core_db']->free_result($result);
-					}
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+		
+		$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
-					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
-					$sql_select = ', tt.mark_time';
+		$unwatch = isset($_POST['unwatch']);
+		
+		if ($unwatch)
+		{
+			$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
+			$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 
-				}
-				else
-				{
-					$sql_from = TOPICS_TABLE . ' t ';
-					$sql_select = '';
-				}
+			if (!empty($forums) || !empty($topics))
+			{
+				$l_unwatch = '';
 
-				// Has to be in while loop if we not only check forum id 0
-				if ($config['load_db_lastread'])
+				if (!empty($forums))
 				{
-					$forum_check = $track_data['mark_time'];
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+						WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
+							AND user_id = ' .$_CLASS['core_user']->data['user_id'];
+					$_CLASS['core_db']->query($sql);
+
+					$l_unwatch .= '_FORUMS';
 				}
-				else
-				{
-					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
-					$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
-				}
 
-				$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
-				$folder = 'folder_announce';
-				$folder_new = $folder . '_new';
-
-				$sql = "SELECT t.* $sql_select 
-					FROM $sql_from
-					WHERE t.forum_id = 0
-						AND t.topic_type = " . POST_GLOBAL . '
-					ORDER BY t.topic_last_post_time DESC';
-				$result = $_CLASS['core_db']->query($sql);
-
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				if (!empty($topics))
 				{
-					$forum_id = $row['forum_id'];
-					$topic_id = $row['topic_id'];
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+						WHERE topic_id IN ('.implode(', ', $topics) .')
+							AND user_id = ' .$_CLASS['core_user']->data['user_id'];
+					$_CLASS['core_db']->query($sql);
 
-					if ($row['topic_status'] == ITEM_LOCKED)
-					{
-						$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
-						$folder = 'folder_locked';
-						$folder_new = 'folder_locked_new';
-					}
+					$l_unwatch .= '_TOPICS';
+				}
 
-					$unread_topic = true;
+				$message = $_CLASS['core_user']->lang['UNWATCHED' . $l_unwatch] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'. generate_link($this->link_parent.'&amp;mode=subscribed').'">', '</a>');
+				
+				$_CLASS['core_display']->meta_refresh(3, generate_link($this->link_parent.'&amp;mode=subscribed'));
+				trigger_error($message);
+			}
+		}
 
-					if ($config['load_db_lastread'])
-					{
-						$topic_check = $row['mark_time'];
-					}
-					else
-					{
-						$topic_id36 = base_convert($topic_id, 10, 36);
-						$topic_check = (isset($tracking_topics[0][$topic_id36])) ? base_convert($tracking_topics[0][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
-					}
+		if ($config['load_db_lastread'])
+		{
+			$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+							AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
+			$lastread_select = ', ft.mark_time ';
+		}
+		else
+		{
+			$sql_from = FORUMS_FORUMS_TABLE . ' f ';
+			$lastread_select = '';
 
-					if ($topic_check >= $row['topic_last_post_time'] || $forum_check >= $row['topic_last_post_time'])
-					{
-						$unread_topic = false;
-					}
+			$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 
-					$newest_post_img = ($unread_topic) ? '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
-					$folder_img = ($unread_topic) ? $folder_new : $folder;
-					$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+			if (!is_array($tracking))
+			{
+				$tracking = array();
+			}
+		}
 
-					// Posted image?
-					$view_topic_url = generate_link("Forums&amp;file=viewtopic&amp;&amp;t=$topic_id");
+		$sql = "SELECT f.*$lastread_select 
+			FROM $sql_from, " . FORUMS_WATCH_TABLE . ' fw
+			WHERE fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+				 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
+			ORDER BY left_id';
 
-					$last_post_img = '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;p=" . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '">' . $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST') . '</a>';
+		$result = $_CLASS['core_db']->query($sql);
+		//$topics_count = $_CLASS['core_db']->num_rows($result);
 
-					$_CLASS['core_template']->assign_vars_array('topicrow', array(
-						'FORUM_ID'			=> $forum_id,
-						'TOPIC_ID'			=> $topic_id,
-						'GOTO_PAGE'			=> '',
-						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
-						'LAST_POST_AUTHOR'	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$forum_id = (int) $row['forum_id'];
 
-						'TOPIC_TITLE'		=> censor_text($row['topic_title']),
-						'TOPIC_TYPE'		=> $topic_type,
+			$unread_forum = false;
+			
+			if ($config['load_db_lastread'])
+			{
+				$mark_time_forum = $row['mark_time'];
+			}
+			else
+			{
+				$forum_id36 = base_convert($forum_id, 10, 36);
+				$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
+			}
 
-						'LAST_POST_IMG'		=> $last_post_img,
-						'NEWEST_POST_IMG'	=> $newest_post_img,
-						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', '') : '',
+			if ($mark_time_forum < $row['forum_last_post_time'])
+			{
+				$unread_forum = true;
+			}
 
-						'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
-						'U_VIEW_TOPIC'		=> $view_topic_url)
-					);
-				}
-				$_CLASS['core_db']->free_result($result);
+			// Which folder should we display?
+			if ($row['forum_status'] == ITEM_LOCKED)
+			{
+				$folder_image = ($unread_forum) ? 'folder_locked_new' : 'folder_locked';
+				$folder_alt = 'FORUM_LOCKED';
+			}
+			else
+			{
+				$folder_image = ($unread_forum) ? 'folder_new' : 'folder';
+				$folder_alt = ($unread_forum) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+			}
 
-				$num_real_posts = $_CLASS['core_user']->data['user_posts'];
-				$active_f_row = $active_t_row = array();
+			// Create last post link information, if appropriate
+			if ($row['forum_last_post_id'])
+			{
+				$last_post_time = $_CLASS['core_user']->format_date($row['forum_last_post_time']);
 
-				// Do the relevant calculations 
-				$memberdays = max(1, round(($_CLASS['core_user']->time - $_CLASS['core_user']->data['user_reg_date']) / 86400));
-				$posts_per_day = $_CLASS['core_user']->data['user_posts'] / $memberdays;
-				$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
+				$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'];
+				$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
 
-				$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+				$last_post_url = generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['forum_last_post_id'] . '#' . $row['forum_last_post_id']);
+			}
+			else
+			{
+				$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
+			}
 
-				if (!empty($active_f_row['num_posts']))
-				{
-					$active_f_name = $active_f_row['forum_name'];
-					$active_f_id = $active_f_row['forum_id'];
-					$active_f_count = $active_f_row['num_posts'];
-					$active_f_pct = ($_CLASS['core_user']->data['user_posts']) ? ($active_f_count / $_CLASS['core_user']->data['user_posts']) * 100 : 0;
-				}
-				unset($active_f_row);
+			$_CLASS['core_template']->assign_vars_array('forumrow', array(
+				'FORUM_ID'			=> $forum_id, 
+				'FORUM_FOLDER_IMG'	=> $_CLASS['core_user']->img($folder_image, $folder_alt),
+				'FORUM_NAME'		=> $row['forum_name'],
+				'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
+				'LAST_POST_TIME'	=> $last_post_time,
+				'LAST_POST_AUTHOR'	=> $last_poster,
+				
+				'U_LAST_POST_AUTHOR'=> $last_poster_url, 
+				'U_LAST_POST'		=> $last_post_url, 
+				'U_VIEWFORUM'		=> generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
+			);
+		}
+		$_CLASS['core_db']->free_result($result);
 
-				$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+		// Subscribed Topics
+		$start = get_variable('start', 'REQUEST', 0, 'int');
 
-				if (!empty($active_t_row['num_posts']))
-				{
-					$active_t_name = $active_t_row['topic_title'];
-					$active_t_id = $active_t_row['topic_id'];
-					$active_t_count = $active_t_row['num_posts'];
-					$active_t_pct = ($_CLASS['core_user']->data['user_posts']) ? ($active_t_count / $_CLASS['core_user']->data['user_posts']) * 100 : 0;
-				}
-				unset($active_t_row);
+		if ($config['load_db_lastread'])
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+			$sql_t_select = ', tt.mark_time';
+		}
+		else
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t';
+			$sql_t_select = '';
+		}
 
+		$sql = "SELECT t.* $sql_t_select 
+			FROM ". FORUMS_WATCH_TABLE . " tw, $sql_from 
+			WHERE tw.user_id = " . $_CLASS['core_user']->data['user_id'] . '
+				AND t.topic_id = tw.topic_id 
+			ORDER BY t.topic_last_post_time DESC';
 
-				$_CLASS['core_template']->assign_array(array(
-					'USER_COLOR'		=> (!empty($_CLASS['core_user']->data['user_colour'])) ? $_CLASS['core_user']->data['user_colour'] : '', 
-					'JOINED'			=> $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_reg_date']),
-					'VISITED'			=> (empty($_CLASS['core_user']->data['user_lastvisit'])) ? ' - ' : $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit']),
-					'POSTS'				=> ($_CLASS['core_user']->data['user_posts']) ? $_CLASS['core_user']->data['user_posts'] : 0,
-					'POSTS_DAY'			=> sprintf($_CLASS['core_user']->lang['POST_DAY'], $posts_per_day),
-					'POSTS_PCT'			=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $percentage),
-					'ACTIVE_FORUM'		=> $active_f_name, 
-					'ACTIVE_FORUM_POSTS'=> ($active_f_count == 1) ? sprintf($_CLASS['core_user']->lang['USER_POST'], 1) : sprintf($_CLASS['core_user']->lang['USER_POSTS'], $active_f_count), 
-					'ACTIVE_FORUM_PCT'	=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $active_f_pct), 
-					'ACTIVE_TOPIC'		=> $active_t_name,
-					'ACTIVE_TOPIC_POSTS'=> ($active_t_count == 1) ? sprintf($_CLASS['core_user']->lang['USER_POST'], 1) : sprintf($_CLASS['core_user']->lang['USER_POSTS'], $active_t_count), 
-					'ACTIVE_TOPIC_PCT'	=> sprintf($_CLASS['core_user']->lang['POST_PCT'], $active_t_pct), 
+		$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+		$topics_count = $_CLASS['core_db']->num_rows($result);
 
-					'OCCUPATION'	=> (!empty($row['user_occ'])) ? $row['user_occ'] : '',
-					'INTERESTS'		=> (!empty($row['user_interests'])) ? $row['user_interests'] : '',
+		if ($topics_count)
+		{
+			$pagination = generate_pagination($this->link, $topics_count, $config['topics_per_page'], $start);
 
-					'U_SEARCH_USER'		=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']->data['username']) . "&amp;show_results=posts") : '',  
-					'U_ACTIVE_FORUM'	=> generate_link('Forums&amp;file=viewforum&amp;f='.$active_f_id),
-					'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
-					'U_ACTIVE_TOPIC'	=> generate_link('Forums&amp;file=viewtopic&amp;t='.$active_t_id))
-				);
+			$_CLASS['core_template']->assign_array(array(
+				'PAGINATION'		=> $pagination['formated'],
+				'PAGINATION_ARRAY'	=> $pagination['array'],
+				'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
+				'TOTAL_TOPICS'		=> ($topics_count === 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)
+			));
+		}
+		else
+		{
+			$_CLASS['core_template']->assign('TOTAL_TOPICS', false);
+		}
 
-				break;
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$topic_id = (int) $row['topic_id'];
+			$forum_id = (int) $row['forum_id'];
+			
+			if (!$config['load_db_lastread'])
+			{
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
 
-			case 'subscribed':
-				require($site_file_root.'includes/forums/functions_display.php');
+				$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+				$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 
-				$unwatch = isset($_POST['unwatch']);
-				
-				if ($unwatch)
-				{
-					$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
-					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
+				$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
+			}
 
-					if (!empty($forums) || !empty($topics))
-					{
-						$l_unwatch = '';
+			// Replies
+			$replies = $_CLASS['forums_auth']->acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
 
-						if (!empty($forums))
-						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-								WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
-									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
-							$_CLASS['core_db']->query($sql);
+			if ($row['topic_status'] == ITEM_MOVED)
+			{
+				$topic_id = $row['topic_moved_id'];
+			}
 
-							$l_unwatch .= '_FORUMS';
-						}
+			// Get folder img, topic status/type related informations
+			$folder_img = $folder_alt = $topic_type = '';
 
-						if (!empty($topics))
-						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-								WHERE topic_id IN ('.implode(', ', $topics) .')
-									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
-							$_CLASS['core_db']->query($sql);
+			topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
+			$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-							$l_unwatch .= '_TOPICS';
-						}
+			$view_topic_url = 'forums&amp;file=viewtopic&amp;t='.$topic_id;
+			$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
 
-						$message = $_CLASS['core_user']->lang['UNWATCHED' . $l_unwatch] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'. generate_link("Control_Panel&amp;i=$id&amp;mode=subscribed").'">', '</a>');
-						
-						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=subscribed"));
-						trigger_error($message);
-					}
-				}
+			$_CLASS['core_template']->assign_vars_array('topicrow', array(
+				'FORUM_ID' 			=> $forum_id,
+				'TOPIC_ID' 			=> $topic_id,
 
-				if ($config['load_db_lastread'])
-				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-									AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
-					$lastread_select = ', ft.mark_time ';
-				}
-				else
-				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
-					$lastread_select = '';
+				'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+				'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
 
-					$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+				'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
+				'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
+				'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
+				'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
 
-					if (!is_array($tracking))
-					{
-						$tracking = array();
-					}
-				}
+				'PAGINATION'		=> $pagination['formated'],
+				'PAGINATION_ARRAY'	=> $pagination['array'],
 
-				$sql = "SELECT f.*$lastread_select 
-					FROM $sql_from, " . FORUMS_WATCH_TABLE . ' fw
-					WHERE fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-						 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
-					ORDER BY left_id';
+				'REPLIES' 			=> $replies,
+				'VIEWS' 			=> $row['topic_views'],
+				'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
+				'TOPIC_TYPE' 		=> $topic_type,
 
-				$result = $_CLASS['core_db']->query($sql);
-				//$topics_count = $_CLASS['core_db']->num_rows($result);
+				'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
+				'NEWEST_POST_IMG' 	=> $newest_post_img,
+				'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
+				'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />',
+				'ATTACH_ICON_IMG'	=> ($_CLASS['forums_auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', sprintf($_CLASS['core_user']->lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
 
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					$forum_id = (int) $row['forum_id'];
+				'S_TOPIC_TYPE'		=> $row['topic_type'],
+				'S_UNREAD_TOPIC'	=> $unread_topic,
 
-					$unread_forum = false;
-					
-					if ($config['load_db_lastread'])
-					{
-						$mark_time_forum = $row['mark_time'];
-					}
-					else
-					{
-						$forum_id36 = base_convert($forum_id, 10, 36);
-						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
-					}
+				'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+				'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] && $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+				'U_VIEW_TOPIC'		=> generate_link($view_topic_url))
+			);
+			
+		}
+		$_CLASS['core_db']->free_result($result);
+	break;
 
-					if ($mark_time_forum < $row['forum_last_post_time'])
-					{
-						$unread_forum = true;
-					}
+	case 'bookmarks':
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
-					// Which folder should we display?
-					if ($row['forum_status'] == ITEM_LOCKED)
-					{
-						$folder_image = ($unread_forum) ? 'folder_locked_new' : 'folder_locked';
-						$folder_alt = 'FORUM_LOCKED';
-					}
-					else
-					{
-						$folder_image = ($unread_forum) ? 'folder_new' : 'folder';
-						$folder_alt = ($unread_forum) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
-					}
+		$move_up = request_var('move_up', 0);
+		$move_down = request_var('move_down', 0);
 
-					// Create last post link information, if appropriate
-					if ($row['forum_last_post_id'])
-					{
-						$last_post_time = $_CLASS['core_user']->format_date($row['forum_last_post_time']);
+		$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
+			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+		$result = $_CLASS['core_db']->query($sql);
+		list($max_order_id) = $_CLASS['core_db']->fetch_row_num($result);
+		$_CLASS['core_db']->free_result($result);
 
-						$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'];
-						$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
+		if ($move_up || $move_down)
+		{
+			if (($move_up && $move_up != 1) || ($move_down && $move_down != $max_order_id))
+			{
+				$order = ($move_up) ? $move_up : $move_down;
+				$order_total = $order * 2 + (($move_up) ? -1 : 1);
 
-						$last_post_url = generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['forum_last_post_id'] . '#' . $row['forum_last_post_id']);
-					}
-					else
-					{
-						$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
-					}
+				$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
+					SET order_id = $order_total - order_id
+					WHERE order_id IN ($order, " . (($move_up) ? $order - 1 : $order + 1) . ')
+						AND user_id = ' . $_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->query($sql);
+			}
+		}
+		
+		if (isset($_POST['unbookmark']))
+		{
+			$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
+			
+			if (empty($topics))
+			{
+				trigger_error('NO_BOOKMARKS_SELECTED');
+			}
 
-					$_CLASS['core_template']->assign_vars_array('forumrow', array(
-						'FORUM_ID'			=> $forum_id, 
-						'FORUM_FOLDER_IMG'	=> $_CLASS['core_user']->img($folder_image, $folder_alt),
-						'FORUM_NAME'		=> $row['forum_name'],
-						'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
-						'LAST_POST_TIME'	=> $last_post_time,
-						'LAST_POST_AUTHOR'	=> $last_poster,
-						
-						'U_LAST_POST_AUTHOR'=> $last_poster_url, 
-						'U_LAST_POST'		=> $last_post_url, 
-						'U_VIEWFORUM'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
-					);
-				}
-				$_CLASS['core_db']->free_result($result);
+			$hidden_fields = array(
+				'unbookmark' => 1,
+				't' => $topics
+			);
 
-				// Subscribed Topics
-				$start = get_variable('start', 'REQUEST', 0, 'int');
+			if (display_confirmation($_CLASS['core_user']->get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
+			{
+				$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+						AND topic_id IN (' . implode(', ', $topics) . ')';
+				$_CLASS['core_db']->query($sql);
 
-				if ($config['load_db_lastread'])
-				{
-					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
-					$sql_t_select = ', tt.mark_time';
-				}
-				else
-				{
-					$sql_from = FORUMS_TOPICS_TABLE . ' t';
-					$sql_t_select = '';
-				}
+				$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+					ORDER BY order_id ASC';
+				$result = $_CLASS['core_db']->query($sql);
 
-				$sql = "SELECT t.* $sql_t_select 
-					FROM ". FORUMS_WATCH_TABLE . " tw, $sql_from 
-					WHERE tw.user_id = " . $_CLASS['core_user']->data['user_id'] . '
-						AND t.topic_id = tw.topic_id 
-					ORDER BY t.topic_last_post_time DESC';
-
-				$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
-				$topics_count = $_CLASS['core_db']->num_rows($result);
-	
-				if ($topics_count)
+				$i = 1;
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$pagination = generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start);
-
-					$_CLASS['core_template']->assign_array(array(
-						'PAGINATION'		=> $pagination['formated'],
-						'PAGINATION_ARRAY'	=> $pagination['array'],
-						'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
-						'TOTAL_TOPICS'		=> ($topics_count === 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
-					);
+					$_CLASS['core_db']->query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
+						SET order_id = '$i'
+						WHERE topic_id = '{$row['topic_id']}'
+							AND user_id = '{$_CLASS['core_user']->data['user_id']}'");
+					$i++;
 				}
-				else
-				{
-					$_CLASS['core_template']->assign('TOTAL_TOPICS', false);
-				}
+				$_CLASS['core_db']->free_result($result);
 
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					$topic_id = $row['topic_id'];
-					$forum_id = $row['forum_id'];
-					
-					if (!$config['load_db_lastread'])
-					{
-						$topic_id36 = base_convert($topic_id, 10, 36);
-						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
+				$url = generate_link('control_panel&amp;i=main&amp;mode=bookmarks');
 
-						$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
-						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
+				$_CLASS['core_display']->meta_refresh(3, $url);
+				$message = $_CLASS['core_user']->lang['BOOKMARKS_REMOVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $url . '">', '</a>');
+				trigger_error($message);
+			}
+		}
 
-						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
-					}
+		// We grab deleted topics here too...
+		// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
+		// But since bookmarks are sensible to the user, they should not be deleted without notice.
+		$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
+			FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
+				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
+				LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
+			WHERE b.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+			ORDER BY b.order_id ASC';
+		$result = $_CLASS['core_db']->query($sql);
+		
+		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+		{
+			$_CLASS['core_db']->free_result($result);
+			
+			$_CLASS['core_template']->assign_array(array(
+					'S_BOOKMARKS'			=> false,
+					'S_BOOKMARKS_DISABLED'	=> false
+			));
+			break;
+		}
 
-					// Replies
-					$replies = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
+		$bookmarks = true;
+		
+		do
+		{
+			$forum_id = $row['forum_id'];
+			$topic_id = $row['b_topic_id'];
+			$bookmarks = true;
 
-					if ($row['topic_status'] == ITEM_MOVED)
-					{
-						$topic_id = $row['topic_moved_id'];
-					}
+			$replies = ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
+			
+			// Get folder img, topic status/type related informations
+			$folder_img = $folder_alt = $topic_type = $unread_topic = '';
+			topic_status($row, $replies, $_CLASS['core_user']->time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
-					// Get folder img, topic status/type related informations
-					$folder_img = $folder_alt = $topic_type = '';
+			$view_topic_url = "forums&amp;file=viewtopic&amp;t=$topic_id";
+//					$last_post_img = '<a href="'.generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '">' . $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST') . '</a>';
 
-					topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
-					$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
+			$pagination = generate_pagination('forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
 
-					$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
-					$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
+			$_CLASS['core_template']->assign_vars_array('forummarks', array(
+				'FORUM_ID' 			=> $forum_id,
+				'TOPIC_ID' 			=> $topic_id,
+				'S_DELETED_TOPIC'	=> (!$row['topic_id']) ? true : false,
+				'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
+				'FORUM_NAME'		=> $row['forum_name'],
 
-					$_CLASS['core_template']->assign_vars_array('topicrow', array(
-						'FORUM_ID' 			=> $forum_id,
-						'TOPIC_ID' 			=> $topic_id,
+				'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+				'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
 
-						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
-						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+				'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
+				'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
+				'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
+				'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+				'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 
-						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
-						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
-						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+				'PAGINATION'		=> $pagination['formated'],
+				'PAGINATION_ARRAY'	=> $pagination['array'],
 
-						'PAGINATION'		=> $pagination['formated'],
-						'PAGINATION_ARRAY'	=> $pagination['array'],
+				'POSTED_AT'			=> $_CLASS['core_user']->format_date($row['topic_time']),
+				'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
+				'ATTACH_ICON_IMG'	=> ($_CLASS['forums_auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', '') : '',
 
-						'REPLIES' 			=> $replies,
-						'VIEWS' 			=> $row['topic_views'],
-						'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
-						'TOPIC_TYPE' 		=> $topic_type,
+				'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
+				'U_VIEW_FORUM'		=> generate_link('forums&amp;file=viewforum&amp;f='.$forum_id),
+				
+				'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+				'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+				'U_MOVE_UP'			=> ($row['order_id'] != 1) ? generate_link("control_panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}") : '',
+				'U_MOVE_DOWN'		=> ($row['order_id'] != $max_order_id) ? generate_link("control_panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}") : '')
+			);
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
-						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
-						'NEWEST_POST_IMG' 	=> $newest_post_img,
-						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-						'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />',
-						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', sprintf($_CLASS['core_user']->lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
+		$_CLASS['core_db']->free_result($result);
 
-						'S_TOPIC_TYPE'		=> $row['topic_type'],
-						'S_UNREAD_TOPIC'	=> $unread_topic,
+		$_CLASS['core_template']->assign_array(array(
+			'S_BOOKMARKS'			=> $bookmarks,
+			'S_BOOKMARKS_DISABLED'	=> false
+		));
+	break;
 
-						'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] && $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-						'U_VIEW_TOPIC'		=> generate_link($view_topic_url))
-					);
-					
-				}
-				$_CLASS['core_db']->free_result($result);
-			break;
-
-			case 'bookmarks':
-				require($site_file_root.'includes/forums/functions_display.php');
-
-				$move_up = request_var('move_up', 0);
-				$move_down = request_var('move_down', 0);
-
-				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
-					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-				$result = $_CLASS['core_db']->query($sql);
-				list($max_order_id) = $_CLASS['core_db']->fetch_row_num($result);
-				$_CLASS['core_db']->free_result($result);
-
-				if ($move_up || $move_down)
-				{
-					if (($move_up && $move_up != 1) || ($move_down && $move_down != $max_order_id))
-					{
-						$order = ($move_up) ? $move_up : $move_down;
-						$order_total = $order * 2 + (($move_up) ? -1 : 1);
+	case 'drafts':
+		global $ucp;
 		
-						$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
-							SET order_id = $order_total - order_id
-							WHERE order_id IN ($order, " . (($move_up) ? $order - 1 : $order + 1) . ')
-								AND user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->query($sql);
-					}
-				}
-				
-				if (isset($_POST['unbookmark']))
-				{
-					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
-					
-					if (empty($topics))
-					{
-						trigger_error('NO_BOOKMARKS_SELECTED');
-					}
+		$pm_drafts = ($this->module === 'pm') ? true : false;
 
-					$hidden_fields = array(
-						'unbookmark' => 1,
-						't' => $topics
-					);
+		$_CLASS['core_user']->add_lang('posting','forums');
 
-					if (display_confirmation($_CLASS['core_user']->get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
-					{
-						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-								AND topic_id IN (' . implode(', ', $topics) . ')';
-						$_CLASS['core_db']->query($sql);
+		$edit = (isset($_REQUEST['edit'])) ? true : false;
+		$submit = (isset($_POST['submit'])) ? true : false;
+		$draft_id = ($edit) ? intval($_REQUEST['edit']) : 0;
+		$delete = (isset($_POST['delete'])) ? true : false;
 
-						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-							ORDER BY order_id ASC';
-						$result = $_CLASS['core_db']->query($sql);
+		$s_hidden_fields = ($edit) ? '<input type="hidden" name="edit" value="' . $draft_id . '" />' : '';
+		$draft_subject = $draft_message = '';
 
-						$i = 1;
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-						{
-							$_CLASS['core_db']->query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . "
-								SET order_id = '$i'
-								WHERE topic_id = '{$row['topic_id']}'
-									AND user_id = '{$_CLASS['core_user']->data['user_id']}'");
-							$i++;
-						}
-						$_CLASS['core_db']->free_result($result);
+		if ($delete)
+		{
+			$drafts = (isset($_POST['d'])) ? implode(', ', array_map('intval', array_keys($_POST['d']))) : '';
 
-						$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+			if ($drafts)
+			{
+				$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . "
+					WHERE draft_id IN ($drafts) 
+						AND user_id = " .$_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->query($sql);
 
-						$_CLASS['core_display']->meta_refresh(3, $url);
-						$message = $_CLASS['core_user']->lang['BOOKMARKS_REMOVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $url . '">', '</a>');
-						trigger_error($message);
-					}
-				}
+				$message = $_CLASS['core_user']->lang['DRAFTS_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link($this->link).'">', '</a>');
 
-				// We grab deleted topics here too...
-				// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
-				// But since bookmarks are sensible to the user, they should not be deleted without notice.
-				$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
-					FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
-						LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
-						LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
-					WHERE b.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-					ORDER BY b.order_id ASC';
-				$result = $_CLASS['core_db']->query($sql);
-				
-				if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-				{
-					$_CLASS['core_db']->free_result($result);
-					
-					$_CLASS['core_template']->assign_array(array(
-							'S_BOOKMARKS'			=> false,
-							'S_BOOKMARKS_DISABLED'	=> false
-					));
-					break;
-				}
+				$_CLASS['core_display']->meta_refresh(3, generate_link($this->link));
+				trigger_error($message);
+			}
+		}
 
-				$bookmarks = true;
-				
-				do
-				{
-					$forum_id = $row['forum_id'];
-					$topic_id = $row['b_topic_id'];
-					$bookmarks = true;
+		if ($submit && $edit)
+		{
+			$draft_subject = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', request_var('subject', ''));
+			$draft_message = (isset($_POST['message'])) ? htmlspecialchars(trim(str_replace(array('\\\'', '\\"', '\\0', '\\\\'), array('\'', '"', '\0', '\\'), $_POST['message']))) : '';
+			$draft_message = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', $draft_message);
 
-					$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
-					
-					// Get folder img, topic status/type related informations
-					$folder_img = $folder_alt = $topic_type = $unread_topic = '';
-					topic_status($row, $replies, $_CLASS['core_user']->time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+			if ($draft_message && $draft_subject)
+			{
+				$draft_row = array(
+					'draft_subject' => $draft_subject,
+					'draft_message' => $draft_message
+				);
 
-					$view_topic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id";
-//					$last_post_img = '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=" . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '">' . $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST') . '</a>';
+				$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
+					SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $draft_row) . " 
+					WHERE draft_id = $draft_id
+						AND user_id = " . $_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->query($sql);
 
-					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
+				$message = $_CLASS['core_user']->lang['DRAFT_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link($this->link).'">', '</a>');
 
-					$_CLASS['core_template']->assign_vars_array('forummarks', array(
-						'FORUM_ID' 			=> $forum_id,
-						'TOPIC_ID' 			=> $topic_id,
-						'S_DELETED_TOPIC'	=> (!$row['topic_id']) ? true : false,
-						'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
-						'FORUM_NAME'		=> $row['forum_name'],
+				$_CLASS['core_display']->meta_refresh(3, generate_link($this->link));
+				trigger_error($message);
+			}
+			else
+			{
+				$_CLASS['core_template']->assign('ERROR', ($draft_message == '') ? $_CLASS['core_user']->lang['EMPTY_DRAFT'] : (($draft_subject == '') ? $_CLASS['core_user']->lang['EMPTY_DRAFT_TITLE'] : ''));
+			}
+		}
 
-						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
-						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+		if (!$pm_drafts)
+		{
+			$sql = 'SELECT d.*, f.forum_name
+				FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
+				WHERE d.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
+					(($edit) ? "AND d.draft_id = $draft_id" : '') . '
+					AND f.forum_id = d.forum_id
+					ORDER BY d.save_time DESC';
+		}
+		else
+		{
+			$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
+					(($edit) ? "AND draft_id = $draft_id" : '') . '
+					AND forum_id = 0 
+					AND topic_id = 0
+					ORDER BY save_time DESC';
+		}
+		$result = $_CLASS['core_db']->query($sql);
+		
+		$draftrows = $topic_ids = array();
 
-						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
-						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
-						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			if ($row['topic_id'])
+			{
+				$topic_ids[] = (int) $row['topic_id'];
+			}
+			$draftrows[] = $row;
+		}
+		$_CLASS['core_db']->free_result($result);
+		
+		if (sizeof($topic_ids))
+		{
+			$sql = 'SELECT topic_id, forum_id, topic_title
+				FROM ' . FORUMS_TOPICS_TABLE . '
+				WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
+			$result = $_CLASS['core_db']->query($sql);
 
-						'PAGINATION'		=> $pagination['formated'],
-						'PAGINATION_ARRAY'	=> $pagination['array'],
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$topic_rows[$row['topic_id']] = $row;
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+		unset($topic_ids);
+		
+		$_CLASS['core_template']->assign('S_EDIT_DRAFT', $edit);
 
-						'POSTED_AT'			=> $_CLASS['core_user']->format_date($row['topic_time']),
-						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', '') : '',
+		foreach ($draftrows as $draft)
+		{
+			$link_topic = $link_forum = $link_pm = false;
+			$insert_url = $view_url = $title = '';
 
-						'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
-						'U_VIEW_FORUM'		=> generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
-						
-						'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-						'U_MOVE_UP'			=> ($row['order_id'] != 1) ? generate_link("Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}") : '',
-						'U_MOVE_DOWN'		=> ($row['order_id'] != $max_order_id) ? generate_link("Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}") : '')
-					);
-				}
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+			if ($pm_drafts)
+			{
+				$link_pm = true;
+				$insert_url = generate_link($this->link_parent.'&amp;mode=compose&amp;d=' . $draft['draft_id']);
+			}
+			else if (isset($topic_rows[$draft['topic_id']]) && $_CLASS['forums_auth']->acl_get('f_read', $topic_rows[$draft['topic_id']]['forum_id']))
+			{
+				$link_topic = true;
+				$view_url = generate_link('forums&amp;file=viewtopic&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . "&amp;t=" . $draft['topic_id']);
+				$title = $topic_rows[$draft['topic_id']]['topic_title'];
 
-				$_CLASS['core_db']->free_result($result);
+				$insert_url = generate_link('forums&amp;file=posting&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . '&amp;t=' . $draft['topic_id'] . '&amp;mode=reply&amp;d=' . $draft['draft_id']);
+			}
+			else if ($_CLASS['forums_auth']->acl_get('f_read', $draft['forum_id']))
+			{
+				$link_forum = true;
+				$view_url = generate_link('forums&amp;file=viewforum&amp;f=' . $draft['forum_id']);
+				$title = $draft['forum_name'];
 
-				$_CLASS['core_template']->assign_array(array(
-					'S_BOOKMARKS'			=> $bookmarks,
-					'S_BOOKMARKS_DISABLED'	=> false
-				));
+				$insert_url = generate_link('forums&amp;file=posting&amp;f=' . $draft['forum_id'] . '&amp;mode=post&amp;d=' . $draft['draft_id']);
+			}
+				
+			$template_row = array(
+				'DATE'			=> $_CLASS['core_user']->format_date($draft['save_time']),
+				'DRAFT_MESSAGE'	=> ($submit) ? $draft_message : $draft['draft_message'],
+				'DRAFT_SUBJECT'	=> ($submit) ? $draft_subject : $draft['draft_subject'],
+				'TITLE'			=> $title,
 
-				break;
+				'DRAFT_ID'			=> $draft['draft_id'],
+				'FORUM_ID'			=> $draft['forum_id'],
+				'TOPIC_ID'			=> $draft['topic_id'],
 
-			case 'drafts':
-				global $ucp;
+				'U_VIEW'			=> $view_url,
+				'U_VIEW_EDIT'		=> generate_link($this->link.'&amp;edit=' . $draft['draft_id']),
+				'U_INSERT'			=> $insert_url,
+
+				'S_LINK_TOPIC'		=> $link_topic,
+				'S_LINK_FORUM'		=> $link_forum,
+				'S_LINK_PM'			=> $link_pm,
+				'S_HIDDEN_FIELDS'	=> $s_hidden_fields
+			);
 				
-				$pm_drafts = ($ucp->name == 'pm') ? true : false;
+			($edit) ? $_CLASS['core_template']->assign_array($template_row) : $_CLASS['core_template']->assign_vars_array('draftrow', $template_row);
+		}
 
-				$_CLASS['core_user']->add_lang('posting','Forums');
+	break;
 
-				$edit = (isset($_REQUEST['edit'])) ? true : false;
-				$submit = (isset($_POST['submit'])) ? true : false;
-				$draft_id = ($edit) ? intval($_REQUEST['edit']) : 0;
-				$delete = (isset($_POST['delete'])) ? true : false;
+	default:
+	//case 'front':
+		$this->mode = 'front';
 
-				$s_hidden_fields = ($edit) ? '<input type="hidden" name="edit" value="' . $draft_id . '" />' : '';
-				$draft_subject = $draft_message = '';
+// remove
+		$_CLASS['core_user']->add_lang(false, 'members_list');
 
-				if ($delete)
-				{
-					$drafts = (isset($_POST['d'])) ? implode(', ', array_map('intval', array_keys($_POST['d']))) : '';
+/*
+		if ($config['load_db_lastread'])
+		{
+			if ($config['load_db_lastread'])
+			{
+				$sql = 'SELECT mark_time 
+					FROM ' . FORUMS_TRACK_TABLE . ' 
+					WHERE forum_id = 0
+						AND user_id = ' . $_CLASS['core_user']->data['user_id'];
+				$result = $_CLASS['core_db']->query($sql);
 
-					if ($drafts)
-					{
-						$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . "
-							WHERE draft_id IN ($drafts) 
-								AND user_id = " .$_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->query($sql);
+				$track_data = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			}
 
-						$message = $_CLASS['core_user']->lang['DRAFTS_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
+			$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+			$sql_select = ', tt.mark_time';
 
-						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
-						trigger_error($message);
-					}
-				}
+		}
+		else
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t ';
+			$sql_select = '';
+		}
 
-				if ($submit && $edit)
-				{
-					$draft_subject = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', request_var('subject', ''));
-					$draft_message = (isset($_POST['message'])) ? htmlspecialchars(trim(str_replace(array('\\\'', '\\"', '\\0', '\\\\'), array('\'', '"', '\0', '\\'), $_POST['message']))) : '';
-					$draft_message = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', $draft_message);
+		// Has to be in while loop if we not only check forum id 0
+		if ($config['load_db_lastread'])
+		{
+			$forum_check = $track_data['mark_time'];
+		}
+		else
+		{
+			$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+			$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
+		}
 
-					if ($draft_message && $draft_subject)
-					{
-						$draft_row = array(
-							'draft_subject' => $draft_subject,
-							'draft_message' => $draft_message
-						);
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
+		$folder = 'folder_announce';
+		$folder_new = $folder . '_new';
 
-						$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $draft_row) . " 
-							WHERE draft_id = $draft_id
-								AND user_id = " . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->query($sql);
+		$sql = "SELECT t.* $sql_select 
+			FROM $sql_from
+			WHERE t.forum_id = 0
+				AND t.topic_type = " . POST_GLOBAL . '
+			ORDER BY t.topic_last_post_time DESC';
+		$result = $_CLASS['core_db']->query($sql);
 
-						$message = $_CLASS['core_user']->lang['DRAFT_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$forum_id = $row['forum_id'];
+			$topic_id = $row['topic_id'];
 
-						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
-						trigger_error($message);
-					}
-					else
-					{
-						$_CLASS['core_template']->assign('ERROR', ($draft_message == '') ? $_CLASS['core_user']->lang['EMPTY_DRAFT'] : (($draft_subject == '') ? $_CLASS['core_user']->lang['EMPTY_DRAFT_TITLE'] : ''));
-					}
-				}
+			if ($row['topic_status'] == ITEM_LOCKED)
+			{
+				$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
+				$folder = 'folder_locked';
+				$folder_new = 'folder_locked_new';
+			}
 
-				if (!$pm_drafts)
-				{
-					$sql = 'SELECT d.*, f.forum_name
-						FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
-						WHERE d.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
-							(($edit) ? "AND d.draft_id = $draft_id" : '') . '
-							AND f.forum_id = d.forum_id
-							ORDER BY d.save_time DESC';
-				}
-				else
-				{
-					$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
-						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . ' ' .
-							(($edit) ? "AND draft_id = $draft_id" : '') . '
-							AND forum_id = 0 
-							AND topic_id = 0
-							ORDER BY save_time DESC';
-				}
-				$result = $_CLASS['core_db']->query($sql);
-				
-				$draftrows = $topic_ids = array();
+			$unread_topic = true;
 
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					if ($row['topic_id'])
-					{
-						$topic_ids[] = (int) $row['topic_id'];
-					}
-					$draftrows[] = $row;
-				}
-				$_CLASS['core_db']->free_result($result);
-				
-				if (sizeof($topic_ids))
-				{
-					$sql = 'SELECT topic_id, forum_id, topic_title
-						FROM ' . FORUMS_TOPICS_TABLE . '
-						WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
-					$result = $_CLASS['core_db']->query($sql);
+			if ($config['load_db_lastread'])
+			{
+				$topic_check = $row['mark_time'];
+			}
+			else
+			{
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$topic_check = (isset($tracking_topics[0][$topic_id36])) ? base_convert($tracking_topics[0][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
+			}
 
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$topic_rows[$row['topic_id']] = $row;
-					}
-					$_CLASS['core_db']->free_result($result);
-				}
-				unset($topic_ids);
-				
-				$_CLASS['core_template']->assign('S_EDIT_DRAFT', $edit);
+			if ($topic_check >= $row['topic_last_post_time'] || $forum_check >= $row['topic_last_post_time'])
+			{
+				$unread_topic = false;
+			}
 
-				foreach ($draftrows as $draft)
-				{
-					$link_topic = $link_forum = $link_pm = false;
-					$insert_url = $view_url = $title = '';
+			$newest_post_img = ($unread_topic) ? '<a href="'.generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
+			$folder_img = ($unread_topic) ? $folder_new : $folder;
+			$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
 
-					if ($pm_drafts)
-					{
-						$link_pm = true;
-						$insert_url = generate_link("Control_Panel&amp;i=$id&amp;mode=compose&amp;d=" . $draft['draft_id']);
-					}
-					else if (isset($topic_rows[$draft['topic_id']]) && $_CLASS['auth']->acl_get('f_read', $topic_rows[$draft['topic_id']]['forum_id']))
-					{
-						$link_topic = true;
-						$view_url = generate_link('Forums&amp;file=viewtopic&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . "&amp;t=" . $draft['topic_id']);
-						$title = $topic_rows[$draft['topic_id']]['topic_title'];
+			// Posted image?
+			$view_topic_url = generate_link("forums&amp;file=viewtopic&amp;&amp;t=$topic_id");
 
-						$insert_url = generate_link('Forums&amp;file=posting&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . '&amp;t=' . $draft['topic_id'] . '&amp;mode=reply&amp;d=' . $draft['draft_id']);
-					}
-					else if ($_CLASS['auth']->acl_get('f_read', $draft['forum_id']))
-					{
-						$link_forum = true;
-						$view_url = generate_link('Forums&amp;file=viewforum&amp;f=' . $draft['forum_id']);
-						$title = $draft['forum_name'];
+			$last_post_img = '<a href="'. generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;p=" . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '">' . $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST') . '</a>';
 
-						$insert_url = generate_link('Forums&amp;file=posting&amp;f=' . $draft['forum_id'] . '&amp;mode=post&amp;d=' . $draft['draft_id']);
-					}
-						
-					$template_row = array(
-						'DATE'			=> $_CLASS['core_user']->format_date($draft['save_time']),
-						'DRAFT_MESSAGE'	=> ($submit) ? $draft_message : $draft['draft_message'],
-						'DRAFT_SUBJECT'	=> ($submit) ? $draft_subject : $draft['draft_subject'],
-						'TITLE'			=> $title,
+			$_CLASS['core_template']->assign_vars_array('topicrow', array(
+				'FORUM_ID'			=> $forum_id,
+				'TOPIC_ID'			=> $topic_id,
+				'GOTO_PAGE'			=> '',
+				'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
+				'LAST_POST_AUTHOR'	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
 
-						'DRAFT_ID'			=> $draft['draft_id'],
-						'FORUM_ID'			=> $draft['forum_id'],
-						'TOPIC_ID'			=> $draft['topic_id'],
-	
-						'U_VIEW'			=> $view_url,
-						'U_VIEW_EDIT'		=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode&amp;edit=" . $draft['draft_id']),
-						'U_INSERT'			=> $insert_url,
+				'TOPIC_TITLE'		=> censor_text($row['topic_title']),
+				'TOPIC_TYPE'		=> $topic_type,
 
-						'S_LINK_TOPIC'		=> $link_topic,
-						'S_LINK_FORUM'		=> $link_forum,
-						'S_LINK_PM'			=> $link_pm,
-						'S_HIDDEN_FIELDS'	=> $s_hidden_fields
-					);
-						
-					($edit) ? $_CLASS['core_template']->assign_array($template_row) : $_CLASS['core_template']->assign_vars_array('draftrow', $template_row);
-				}
+				'LAST_POST_IMG'		=> $last_post_img,
+				'NEWEST_POST_IMG'	=> $newest_post_img,
+				'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
+				'ATTACH_ICON_IMG'	=> $row['topic_attachment'] ? $_CLASS['core_user']->img('icon_attach', '') : '',
 
-				break;
+				'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
+				'U_VIEW_TOPIC'		=> $view_topic_url)
+			);
 		}
+		$_CLASS['core_db']->free_result($result);
+*/
 
+		$_CLASS['core_template']->assign_array(array(
+			'JOINED'			=> $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_reg_date']),
+			'VISITED'			=> empty($_CLASS['core_user']->data['user_lastvisit']) ? ' - ' : $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit']),
+			'POSTS'				=> (int) $_CLASS['core_user']->data['user_posts'],
 
-		$_CLASS['core_template']->assign_array(array( 
-			'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_MAIN_' . strtoupper($mode)],
-			'S_DISPLAY_MARK_ALL'		=> ($mode == 'watched' || ($mode == 'drafts' && !isset($_GET['edit']))) ? true : false, 
-			'S_HIDDEN_FIELDS'			=> (isset($s_hidden_fields)) ? $s_hidden_fields : '',
-			'S_DISPLAY_FORM'			=> true,
-			'S_UCP_ACTION'				=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"),
+			'U_SEARCH_USER'		=> generate_link('forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']->data['username']) . "&amp;show_results=posts"),  
 		));
-		
-		$this->display($_CLASS['core_user']->lang['UCP_MAIN'], 'ucp_main_' . $mode . '.html');
+	break;
+}
 
-	}
 
-}
+$_CLASS['core_template']->assign_array(array( 
+	'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_MAIN_' . strtoupper($this->mode)],
+	'S_DISPLAY_MARK_ALL'		=> ($this->mode === 'watched' || ($this->mode === 'drafts' && !isset($_GET['edit']))) ? true : false, 
+	'S_HIDDEN_FIELDS'			=> (isset($s_hidden_fields)) ? $s_hidden_fields : '',
+	'S_DISPLAY_FORM'			=> true,
+	'S_UCP_ACTION'				=> generate_link($this->link),
+));
 
+$_CLASS['core_display']->display(false, 'modules/control_panel/ucp_main_' . $this->mode . '.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_pm.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -41,372 +41,419 @@
 *
 */
 
-class ucp_pm extends module
+global $_CLASS, $config;
+
+$action = '';
+$mode = false;
+
+if ($_CLASS['core_user']->data['user_id'] == ANONYMOUS)
 {
-	function ucp_pm($id, $mode)
+	trigger_error('NO_MESSAGE');
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'S_UNREAD'				=> false,
+	'TOTAL_MESSAGES'		=> false,
+	'S_DISPLAY_HISTORY'		=> false,
+	'S_BCC_RECIPIENT'		=> false,
+));
+
+// This is loaded 2x with drafts
+$_CLASS['core_user']->add_lang();
+$_CLASS['core_user']->add_lang('posting', 'Forums');
+
+$_CLASS['core_template']->assign('S_PRIVMSGS', true);
+
+// Folder directly specified?
+$folder_specified = get_variable('folder', 'REQUEST');
+
+if ($folder_specified)
+{
+	if (is_numeric($folder_specified))
 	{
-		global $_CLASS, $config;
+		$folder_specified = (int) $folder_specified;
+	}
+	else
+	{
+		$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
+	}
 
-		$action = '';
-		
-		if ($_CLASS['core_user']->data['user_id'] == ANONYMOUS)
+	$mode = 'view_messages';
+}
+else
+{
+	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+}
+
+require(SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php');
+
+$_CLASS['core_template']->assign_array(array( 
+	'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PM_' . strtoupper($mode)],
+	'S_UCP_ACTION'      => generate_link($this->link . ((isset($action)) ? "&amp;action=$action" : '')))
+);
+
+switch ($mode)
+{
+	// New private messages popup
+	case 'popup':
+	
+		$indox_link = generate_link('control_panel&i=pm&folder=inbox');
+
+		if ($_CLASS['core_user']->data['user_new_privmsg'])
 		{
-			trigger_error('NO_MESSAGE');
+			$l_new_message = ($_CLASS['core_user']->data['user_new_privmsg'] == 1) ? $_CLASS['core_user']->lang['YOU_NEW_PM'] : $_CLASS['core_user']->lang['YOU_NEW_PMS'];
 		}
+		else
+		{
+			$l_new_message = $_CLASS['core_user']->lang['YOU_NO_NEW_PM'];
+		}
 
 		$_CLASS['core_template']->assign_array(array(
-			'S_UNREAD'				=> false,
-			'TOTAL_MESSAGES'		=> false,
-			'S_DISPLAY_HISTORY'		=> false,
-			'S_BCC_RECIPIENT'		=> false,
+			'MESSAGE'			=> $l_new_message,
+			'U_JS_RETURN_INBOX'	=> $indox_link,
+			'S_NOT_LOGGED_IN'	=> ($_CLASS['core_user']->data['user_id'] == ANONYMOUS) ? true : false,
+			'CLICK_TO_VIEW'		=> sprintf($_CLASS['core_user']->lang['CLICK_VIEW_PRIVMSG'], '<a href="' . $indox_link . '" onclick="jump_to_inbox();return false;" target="_new">', '</a>'),
+			'U_INBOX'			=> $indox_link
 		));
 
-// This is loaded 2x with drafts
-		$_CLASS['core_user']->add_lang('posting','Forums');
+		$_CLASS['core_display']->display(false, 'modules/control_panel/ucp_pm_popup.html');
+	break;
+
+	// Compose message
+	case 'compose':
+		$action = get_variable('action', 'REQUEST', 'post');
+
+		get_folder($_CLASS['core_user']->data['user_id'], $folder);
 		
-		$_CLASS['core_template']->assign('S_PRIVMSGS', true);
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_compose.php';
+		compose_pm($id, $mode, $action);
+	
+		$_CLASS['core_display']->display(false, 'modules/control_panel/ucp_posting_body.html');
+	break;
+	
+	case 'options':
+		$sql = 'SELECT group_message_limit
+			FROM ' . GROUPS_TABLE . '
+			WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
+		$result = $_CLASS['core_db']->query($sql);
 
-		// Folder directly specified?
-		$folder_specified = get_variable('folder', 'REQUEST');
+		list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
 
+		$_CLASS['core_db']->free_result($result);
+		
+		(int) $_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+		
+		get_folder($_CLASS['core_user']->data['user_id'], $folder);
+
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_options.php';
+		message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
+
+		$_CLASS['core_display']->display(false, 'modules/control_panel/ucp_pm_options.html');
+	break;
+
+	case 'drafts':
+		get_folder($_CLASS['core_user']->data['user_id'], $folder);
+	
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_main.php';
+		$module = new ucp_main($id, $mode);
+		unset($module);
+		exit;
+	break;
+
+	case 'unread':
+	case 'view_messages':
+		$sql = 'SELECT group_message_limit
+			FROM ' . CORE_GROUPS_TABLE . '
+			WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
+		$result = $_CLASS['core_db']->query($sql);
+
+		list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+
 		if ($folder_specified)
 		{
-			if (is_numeric($folder_specified))
-			{
-				$folder_specified = (int) $folder_specified;
-			}
-			else
-			{
-				$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
-			}
-
-			$mode = 'view_messages';
+			$folder_id = $folder_specified;
+			$action = 'view_folder';
 		}
 		else
 		{
-			$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
+			$action = get_variable('action', 'REQUEST', 'view_folder');
 		}
 
-		require(SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php');
+		if ($folder_id === PRIVMSGS_NO_BOX)
+		{
+			$folder_id = PRIVMSGS_INBOX;
+		}
+
+		$msg_id = get_variable('p', 'REQUEST', 0, 'int');
+		$view	= get_variable('view', 'REQUEST');
 		
-		$_CLASS['core_template']->assign_array(array( 
-			'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PM_' . strtoupper($mode)],
-			'S_UCP_ACTION'      => generate_link("Control_Panel&amp;i=$id&amp;mode=$mode" . ((isset($action)) ? "&amp;action=$action" : '')))
-		);
-
-		switch ($mode)
+		if ($msg_id && $action === 'view_folder')
 		{
-			// New private messages popup
-			case 'popup':
-			
-				$indox_link = generate_link('Control_Panel&i=pm&folder=inbox');
+			$action = 'view_message';
+		}
 
-				if ($_CLASS['core_user']->data['user_new_privmsg'])
-				{
-					$l_new_message = ($_CLASS['core_user']->data['user_new_privmsg'] == 1) ? $_CLASS['core_user']->lang['YOU_NEW_PM'] : $_CLASS['core_user']->lang['YOU_NEW_PMS'];
-				}
-				else
-				{
-					$l_new_message = $_CLASS['core_user']->lang['YOU_NO_NEW_PM'];
-				}
+// First Handle Mark actions and moving messages
 
-				$_CLASS['core_template']->assign_array(array(
-					'MESSAGE'			=> $l_new_message,
-					'U_JS_RETURN_INBOX'	=> $indox_link,
-					'S_NOT_LOGGED_IN'	=> ($_CLASS['core_user']->data['user_id'] == ANONYMOUS) ? true : false,
-					'CLICK_TO_VIEW'		=> sprintf($_CLASS['core_user']->lang['CLICK_VIEW_PRIVMSG'], '<a href="' . $indox_link . '" onclick="jump_to_inbox();return false;" target="_new">', '</a>'),
-					'U_INBOX'			=> $indox_link
-				));
+		// Move PM
+		if (isset($_REQUEST['move_pm']))
+		{
+			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
+			$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
 
-				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_pm_popup.html');
-			break;
-
-			// Compose message
-			case 'compose':
-				$action = request_var('action', 'post');
-	
-				get_folder($_CLASS['core_user']->data['user_id'], $folder);
-				
-				if (!$_CLASS['auth']->acl_get('u_sendpm'))
+			if (move_pm($_CLASS['core_user']->data['user_id'], $_CLASS['core_user']->data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
+			{
+				// Return to folder view if single message moved
+				if ($action == 'view_message')
 				{
-					trigger_error('NO_AUTH_SEND_MESSAGE');
+					$msg_id		= 0;
+					$folder_id	= $cur_folder_id;
+					$action		= 'view_folder';
 				}
+			}
+		}
 
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_compose.php');
-				compose_pm($id, $mode, $action);
-			
-				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_posting_body.html');
-			break;
-			
-			case 'options':
-				$sql = 'SELECT group_message_limit
-					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
-				$result = $_CLASS['core_db']->query($sql);
+		// Message Mark Options
+		if (isset($_REQUEST['submit_mark']))
+		{
+			$mark_option = get_variable('mark_option', 'POST');
+			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
 
-				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
+			Switch ($mark_option)
+			{
+				case 'mark_read':
+				case 'mark_unread':
+						$read_status = ($mark_option === 'mark_read');
+						set_read_status($read_status, $msg_ids, $_CLASS['core_user']->data['user_id'], $cur_folder_id);
+				break;
 
-				$_CLASS['core_db']->free_result($result);
-				
-				(int) $_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
-				
-				get_folder($_CLASS['core_user']->data['user_id'], $folder);
+				default:
+					// redo this
+					handle_mark_actions($_CLASS['core_user']->data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
+				break;
+			}
+		}
 
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_options.php');
-				message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
+		// If new messages arrived, place them into the appropiate folder
+		$num_not_moved = 0;
 
-				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_pm_options.html');
-			break;
+		if ($_CLASS['core_user']->data['user_new_privmsg'] && $action == 'view_folder')
+		{
+			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
+			$num_not_moved = $_CLASS['core_user']->data['user_new_privmsg'];
+		}
 
-			case 'drafts':
-				get_folder($_CLASS['core_user']->data['user_id'], $folder);
-			
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_main.php');
-				$module = new ucp_main($id, $mode);
-				unset($module);
-				exit;
-			break;
+		$message_row = array();
 
-			case 'unread':
-			case 'view_messages':
-				/*
-				if (!$_CLASS['auth']->acl_get('u_readpm'))
+		if ($mode === 'view_messages' && $action === 'view_message' && $msg_id)
+		{
+			// Get Message user want to see
+			if ($view === 'next' || $view === 'previous')
+			{
+				if ($view === 'next')
 				{
-					trigger_error('NO_AUTH_READ_MESSAGE');
+					$sql_condition = '>';
+					$sql_ordering = 'ASC';
 				}
-				*/
+				else
+				{
+					$sql_condition = '<';
+					$sql_ordering = 'DESC';
+				}
 
-				$sql = 'SELECT group_message_limit
-					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
-				$result = $_CLASS['core_db']->query($sql);
+// Redo this for sqlite
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . " p2
+					WHERE p2.msg_id = $msg_id
+						AND t.folder_id = $folder_id
+						AND t.user_id = " . $_CLASS['core_user']->data['user_id'] . "
+						AND t.msg_id = p.msg_id
+						AND p.message_time $sql_condition p2.message_time
+					ORDER BY p.message_time $sql_ordering";
+				$result = $_CLASS['core_db']->query_limit($sql, 1);
 
-				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
-				$_CLASS['core_db']->free_result($result);
-
-				$_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
-
-				if ($folder_specified)
+				if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 				{
-					$folder_id = $folder_specified;
-					$action = 'view_folder';
+					$message = ($view === 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
+					trigger_error($message);
 				}
 				else
 				{
-					$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
-					$action = get_variable('action', 'REQUEST', 'view_folder');
+					$msg_id = $row['msg_id'];
 				}
 
-				if ($folder_id === PRIVMSGS_NO_BOX)
-				{
-					$folder_id = PRIVMSGS_INBOX;
-				}
+				$_CLASS['core_db']->free_result($result);
+			}
 
-				$msg_id = get_variable('p', 'REQUEST', 0, 'int');
-				$view	= get_variable('view', 'REQUEST');
-				
-				if ($msg_id && $action === 'view_folder')
-				{
-					$action = 'view_message';
-				}
+			$sql = 'SELECT t.*, p.*, u.*
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
+				WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
+					AND p.author_id = u.user_id
+					AND t.folder_id = $folder_id
+					AND t.msg_id = p.msg_id
+					AND p.msg_id = $msg_id";
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$message_row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-// First Handle Mark actions and moving messages
+			if (!$message_row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
 
-				// Move PM
-				if (isset($_REQUEST['move_pm']))
-				{
-					$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
-					$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
+			// Update unread status
+			if ($message_row['unread'])
+			{
+				set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']->data['user_id'], $folder_id);
+			}
+		}
 
-					if (move_pm($_CLASS['core_user']->data['user_id'], $_CLASS['core_user']->data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
-					{
-						// Return to folder view if single message moved
-						if ($action == 'view_message')
-						{
-							$msg_id		= 0;
-							$folder_id	= $cur_folder_id;
-							$action		= 'view_folder';
-						}
-					}
-				}
+		$folder = array();
+		get_folder($_CLASS['core_user']->data['user_id'], $folder, $folder_id);
 
-				// Message Mark Options
-				if (isset($_REQUEST['submit_mark']))
-				{
-					$mark_option = get_variable('mark_option', 'POST');
-					$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
+		$s_folder_options = $s_to_folder_options = '';
+		foreach ($folder as $f_id => $folder_ary)
+		{
+			$option = '<option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class="blue"' : '') . ' value="' . $f_id . '"' . ((($f_id == $folder_id && $mode != 'unread') || ($f_id === 'unread' && $mode == 'unread')) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '</option>';
 
-					Switch ($mark_option)
-					{
-						case 'mark_read':
-						case 'mark_unread':
-								$read_status = ($mark_option === 'mark_read');
-								set_read_status($read_status, $msg_ids, $_CLASS['core_user']->data['user_id'], $cur_folder_id);
-						break;
+			$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX && $f_id != PRIVMSGS_SENTBOX) ? $option : '';
+			$s_folder_options .= $option;
+		}
 
-						default:
-							// redo this
-							handle_mark_actions($_CLASS['core_user']->data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
-						break;
-					}
-				}
+		clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
 
-				// If new messages arrived, place them into the appropiate folder
-				$num_not_moved = 0;
+		// Header for message view - folder and so on
+		$folder_status = get_folder_status($folder_id, $folder);
 
-				if ($_CLASS['core_user']->data['user_new_privmsg'] && $action == 'view_folder')
-				{
-					place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
-					$num_not_moved = $_CLASS['core_user']->data['user_new_privmsg'];
-				}
+		$_CLASS['core_template']->assign_array(array(
+			'CUR_FOLDER_ID'				=> $folder_id,
+			'CUR_FOLDER_NAME'			=> $folder_status['folder_name'],
+			'NUM_NOT_MOVED'				=> $num_not_moved,
+			'RELEASE_MESSAGE_INFO'		=> sprintf($_CLASS['core_user']->lang['RELEASE_MESSAGES'], '<a href="' . generate_link($this->link_parent . '&amp;folder=' . $folder_id . '&amp;release=1').'">', '</a>'),
+			'NOT_MOVED_MESSAGES'		=> ($num_not_moved == 1) ? $_CLASS['core_user']->lang['NOT_MOVED_MESSAGE'] : sprintf($_CLASS['core_user']->lang['NOT_MOVED_MESSAGES'], $num_not_moved),
+
+			'S_FOLDER_OPTIONS'			=> $s_folder_options,
+			'S_TO_FOLDER_OPTIONS'		=> $s_to_folder_options,
+			'S_FOLDER_ACTION'			=> generate_link($this->link_parent.'&amp;mode=view_messages&amp;action=view_folder'),
+			'S_PM_ACTION'				=> generate_link($this->link_parent.'&amp;mode=$mode&amp;action='.$action),
+			
+			'U_INBOX'					=> generate_link($this->link_parent.'&amp;folder=inbox'),
+			'U_OUTBOX'					=> generate_link($this->link_parent.'&amp;folder=outbox'),
+			'U_SENTBOX'					=> generate_link($this->link_parent.'&amp;folder=sentbox'),
+			'U_CREATE_FOLDER'			=> generate_link($this->link_parent.'&amp;mode=options'),
+			
+			'S_IN_INBOX'				=> ($folder_id == PRIVMSGS_INBOX),
+			'S_IN_OUTBOX'				=> ($folder_id == PRIVMSGS_OUTBOX),
+			'S_IN_SENTBOX'				=> ($folder_id == PRIVMSGS_SENTBOX),
+
+			'FOLDER_STATUS'				=> $folder_status['message'],
+			'FOLDER_MAX_MESSAGES'		=> $folder_status['max'],
+			'FOLDER_CUR_MESSAGES'		=> $folder_status['cur'],
+			'FOLDER_REMAINING_MESSAGES'	=> $folder_status['remaining'],
+			'FOLDER_PERCENT'			=> $folder_status['percent'])
+		);
 		
-				$message_row = array();
+		$_CLASS['core_template']->assign('S_VIEW_MESSAGE',  false);
 
-				if ($mode == 'view_messages' && $action == 'view_message' && $msg_id)
-				{
-					// Get Message user want to see
-					if ($view === 'next' || $view === 'previous')
-					{
-						if ($view === 'next')
-						{
-							$sql_condition = '>';
-							$sql_ordering = 'ASC';
-						}
-						else
-						{
-							$sql_condition = '<';
-							$sql_ordering = 'DESC';
-						}
+		if ($mode == 'unread' || $action == 'view_folder')
+		{
+			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewfolder.php';
+			view_folder($this, $folder_id, $folder, (($mode === 'unread') ? 'unread' : 'folder'));
 
-// Redo this for sqlite
-						$sql = 'SELECT t.msg_id
-							FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . " p2
-							WHERE p2.msg_id = $msg_id
-								AND t.folder_id = $folder_id
-								AND t.user_id = " . $_CLASS['core_user']->data['user_id'] . "
-								AND t.msg_id = p.msg_id
-								AND p.message_time $sql_condition p2.message_time
-							ORDER BY p.message_time $sql_ordering";
-						$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$_CLASS['core_display']->display(false,  'modules/control_panel/ucp_pm_viewfolder.html');
 
-						if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-						{
-							$message = ($view == 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
-							trigger_error($message);
-						}
-						else
-						{
-							$msg_id = $row['msg_id'];
-						}
+		}
+		elseif ($action == 'view_message')
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'S_VIEW_MESSAGE'=> true,
+				'MSG_ID'		=> $msg_id)
+			);
+		
+			if (!$msg_id)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+			
+			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewmessage.php';
+			view_message($this, $folder_id, $msg_id, $folder, $message_row);
 
-						$_CLASS['core_db']->free_result($result);
-					}
-	
-					$sql = 'SELECT t.*, p.*, u.*
-						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
-						WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
-							AND p.author_id = u.user_id
-							AND t.folder_id = $folder_id
-							AND t.msg_id = p.msg_id
-							AND p.msg_id = $msg_id";
-					$result = $_CLASS['core_db']->query_limit($sql, 1);
-					$message_row = $_CLASS['core_db']->fetch_row_assoc($result);
-					$_CLASS['core_db']->free_result($result);
+			$_CLASS['core_display']->display(false, 'modules/control_panel/'.(($view === 'print') ? 'ucp_pm_viewmessage_print.html' : 'ucp_pm_viewmessage.html'));
+		}	
+	break;
 
-					if (!$message_row)
-					{
-						trigger_error('NO_MESSAGE');
-					}
+	default:
+		trigger_error('NO_ACTION_MODE');
+	break;
+}
 
-					// Update unread status
-					if ($message_row['unread'])
-					{
-						set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']->data['user_id'], $folder_id);
-					}
-				}
+function obtain_icons()
+{
+	global $_CLASS;
 
-				$folder = array();
-				get_folder($_CLASS['core_user']->data['user_id'], $folder, $folder_id);
-	
-				$s_folder_options = $s_to_folder_options = '';
-				foreach ($folder as $f_id => $folder_ary)
-				{
-					$option = '<option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class="blue"' : '') . ' value="' . $f_id . '"' . ((($f_id == $folder_id && $mode != 'unread') || ($f_id === 'unread' && $mode == 'unread')) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '</option>';
+	if (is_null($icons = $_CLASS['core_cache']->get('icons')))
+	{
+		$sql = 'SELECT *
+			FROM ' . FORUMS_ICONS_TABLE . ' 
+			ORDER BY icons_order';
+		$result = $_CLASS['core_db']->query($sql);
 
-					$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX && $f_id != PRIVMSGS_SENTBOX) ? $option : '';
-					$s_folder_options .= $option;
-				}
+		$icons = array();
 
-				clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$icons[$row['icons_id']]['img'] = $row['icons_url'];
+			$icons[$row['icons_id']]['width'] = (int) $row['icons_width'];
+			$icons[$row['icons_id']]['height'] = (int) $row['icons_height'];
+			$icons[$row['icons_id']]['display'] = (bool) $row['display_on_posting'];
+		}
 
-				// Header for message view - folder and so on
-				$folder_status = get_folder_status($folder_id, $folder);
-				$url = 'Control_Panel&amp;i='.$id;
+		$_CLASS['core_db']->free_result($result);
 
-				$_CLASS['core_template']->assign_array(array(
-					'CUR_FOLDER_ID'				=> $folder_id,
-					'CUR_FOLDER_NAME'			=> $folder_status['folder_name'],
-					'NUM_NOT_MOVED'				=> $num_not_moved,
-					'RELEASE_MESSAGE_INFO'		=> sprintf($_CLASS['core_user']->lang['RELEASE_MESSAGES'], '<a href="' . generate_link($url . '&amp;folder=' . $folder_id . '&amp;release=1').'">', '</a>'),
-					'NOT_MOVED_MESSAGES'		=> ($num_not_moved == 1) ? $_CLASS['core_user']->lang['NOT_MOVED_MESSAGE'] : sprintf($_CLASS['core_user']->lang['NOT_MOVED_MESSAGES'], $num_not_moved),
+		$_CLASS['core_cache']->put('icons', $icons);
+	}
 
-					'S_FOLDER_OPTIONS'			=> $s_folder_options,
-					'S_TO_FOLDER_OPTIONS'		=> $s_to_folder_options,
-					'S_FOLDER_ACTION'			=> generate_link($url.'&amp;mode=view_messages&amp;action=view_folder'),
-					'S_PM_ACTION'				=> generate_link("$url&amp;mode=$mode&amp;action=$action"),
-					
-					'U_INBOX'					=> generate_link($url.'&amp;folder=inbox'),
-					'U_OUTBOX'					=> generate_link($url.'&amp;folder=outbox'),
-					'U_SENTBOX'					=> generate_link($url.'&amp;folder=sentbox'),
-					'U_CREATE_FOLDER'			=> generate_link($url.'&amp;mode=options'),
-					
-					'S_IN_INBOX'				=> ($folder_id == PRIVMSGS_INBOX) ? true : false,
-					'S_IN_OUTBOX'				=> ($folder_id == PRIVMSGS_OUTBOX) ? true : false,
-					'S_IN_SENTBOX'				=> ($folder_id == PRIVMSGS_SENTBOX) ? true : false,
+	return $icons;
+}
 
-					'FOLDER_STATUS'				=> $folder_status['message'],
-					'FOLDER_MAX_MESSAGES'		=> $folder_status['max'],
-					'FOLDER_CUR_MESSAGES'		=> $folder_status['cur'],
-					'FOLDER_REMAINING_MESSAGES'	=> $folder_status['remaining'],
-					'FOLDER_PERCENT'			=> $folder_status['percent'])
-				);
-				
-				$_CLASS['core_template']->assign('S_VIEW_MESSAGE',  false);
+function gen_sort_selects(&$limit_days, &$sort_by_text, &$sort_days, &$sort_key, &$sort_dir, &$s_limit_days, &$s_sort_key, &$s_sort_dir, &$u_sort_param)
+{
+	global $_CLASS;
 
-				if ($mode == 'unread' || $action == 'view_folder')
-				{
-					require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_viewfolder.php');
-					view_folder($id, $mode, $folder_id, $folder, (($mode == 'unread') ? 'unread' : 'folder'));
+	$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
 
-					$_CLASS['core_display']->display(false,  'modules/Control_Panel/ucp_pm_viewfolder.html');
+	$s_limit_days = '<select name="st">';
+	foreach ($limit_days as $day => $text)
+	{
+		$selected = ($sort_days == $day) ? ' selected="selected"' : '';
+		$s_limit_days .= '<option value="' . $day . '"' . $selected . '>' . $text . '</option>';
+	}
+	$s_limit_days .= '</select>';
 
-				}
-				elseif ($action == 'view_message')
-				{
-					$_CLASS['core_template']->assign_array(array(
-						'S_VIEW_MESSAGE'=> true,
-						'MSG_ID'		=> $msg_id)
-					);
-				
-					if (!$msg_id)
-					{
-						trigger_error('NO_MESSAGE');
-					}
-					
-					require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_viewmessage.php');
-					view_message($id, $mode, $folder_id, $msg_id, $folder, $message_row);
+	$s_sort_key = '<select name="sk">';
+	foreach ($sort_by_text as $key => $text)
+	{
+		$selected = ($sort_key == $key) ? ' selected="selected"' : '';
+		$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $text . '</option>';
+	}
+	$s_sort_key .= '</select>';
 
-					$_CLASS['core_display']->display(false, 'modules/Control_Panel/'.(($view == 'print') ? 'ucp_pm_viewmessage_print.html' : 'ucp_pm_viewmessage.html'));
-				}	
-			break;
+	$s_sort_dir = '<select name="sd">';
+	foreach ($sort_dir_text as $key => $value)
+	{
+		$selected = ($sort_dir == $key) ? ' selected="selected"' : '';
+		$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
+	}
+	$s_sort_dir .= '</select>';
 
-			default:
-				trigger_error('NO_ACTION_MODE');
-			break;
-		}
-	}
+	$u_sort_param = "st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir";
+
+	return;
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -18,10 +18,11 @@
 	'S_PM_ICONS'		=> false
 ));
 
-function view_folder($id, $mode, $folder_id, $folder, $type)
+function view_folder($parent_class, $folder_id, $folder, $type)
 {
-	global $_CLASS, $config;
+	global $_CLASS;
 	
+	$limit = 10;
 	$icons = obtain_icons();
 
 	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
@@ -63,7 +64,7 @@
 		'S_MARK_OPTIONS'=> $s_mark_options)
 	);
 
-	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']->data['user_id'], "Control_Panel&amp;i=$id", $type);
+	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']->data['user_id'], $parent_class->link_parent, $type);
 
 	// Okay, lets dump out the page ...
 	if (!empty($folder_info['pm_list']))
@@ -92,7 +93,7 @@
 			{
 				if (isset($recipient_list[$ug_type]) && sizeof($recipient_list[$ug_type]))
 				{
-					$sql = ($ug_type == 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . GROUPS_TABLE . ' WHERE group_id';
+					$sql = ($ug_type === 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . CORE_USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . CORE_GROUPS_TABLE . ' WHERE group_id';
 					$sql .= ' IN (' . implode(', ', array_keys($recipient_list[$ug_type])) . ')';
 	
 					$result = $_CLASS['core_db']->query($sql);
@@ -119,8 +120,6 @@
 			unset($recipient_list, $address);
 		}
 
-		$url = 'Control_Panel&amp;i='.$id;
-
 		foreach ($folder_info['pm_list'] as $message_id)
 		{
 			$row =& $folder_info['rowset'][$message_id];
@@ -130,8 +129,8 @@
 
 			// Generate all URIs ...
 			$message_author = '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '">' . $row['username'] . '</a>';
-			$view_message_url = generate_link("$url&amp;f=$folder_id&amp;p=$message_id");
-			$remove_message_url = generate_link($url.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
+			$view_message_url = generate_link($parent_class->link_parent."&amp;f=$folder_id&amp;p=$message_id");
+			$remove_message_url = generate_link($parent_class->link_parent.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
 			
 			$row_indicator = '';
 			foreach ($color_rows as $var)
@@ -147,26 +146,27 @@
 			// Send vars to template
 			$_CLASS['core_template']->assign_vars_array('messagerow', array(
 				'PM_CLASS'			=> ($row_indicator) ? 'pm_' . $row_indicator . '_colour' : '',
-	
+
 				'FOLDER_ID' 		=> $folder_id,
 				'MESSAGE_ID'		=> $message_id,
 				'MESSAGE_AUTHOR'	=> $message_author,
 				'SENT_TIME'		 	=> $_CLASS['core_user']->format_date($row['message_time']),
 				'SUBJECT'			=> censor_text($row['message_subject']),
 				'FOLDER'			=> (isset($folder[$row['folder_id']])) ? $folder[$row['folder_id']]['folder_name'] : '',
-				'U_FOLDER'			=> (isset($folder[$row['folder_id']])) ? generate_link("$url&amp;folder=" . $row['folder_id']) : '',
+				'U_FOLDER'			=> (isset($folder[$row['folder_id']])) ? generate_link($parent_class->link_parent.'&amp;folder=' . $row['folder_id']) : '',
 				'PM_ICON_IMG'		=> (!empty($icons[$row['icon_id']])) ? '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />' : '',
 				'FOLDER_IMG'		=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 				'PM_IMG'			=> ($row_indicator) ? $_CLASS['core_user']->img('pm_' . $row_indicator, '') : '',
-				'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_get('u_download') && $row['message_attachment'] && $config['allow_pm_attach'] && $config['auth_download_pm']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
-				'S_PM_REPORTED'		=> (!empty($row['message_reported']) && $_CLASS['auth']->acl_get('m_')) ? true : false,
+				'ATTACH_ICON_IMG'	=> ($row['message_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+				//'S_PM_REPORTED'		=> (!empty($row['message_reported'])) ? true : false,
+				'S_PM_REPORTED'		=> '',
 				'S_PM_DELETED'		=> ($row['deleted']) ? true : false,
 				
 				'U_VIEW_PM'			=> ($row['deleted']) ? '' : $view_message_url,
 				'U_REMOVE_PM'		=> ($row['deleted']) ? $remove_message_url : '',
 				
 				'RECIPIENTS'		=> ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? implode(', ', $address_list[$message_id]) : '',
-				'U_MCP_REPORT'		=> generate_link('Forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
+				'U_MCP_REPORT'		=> generate_link('forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
 //				'U_MCP_QUEUE'		=> "mcp.$phpEx?sid={$_CLASS['core_user']->session_id}&amp;mode=mod_queue&amp;t=$topic_id")
 			);
 		}
@@ -184,17 +184,18 @@
 // Get PM's in all folders from user x with type of x (unread, new)
 function get_pm_from($folder_id, $folder, $user_id, $url, $type = 'folder')
 {
-	global $config, $_CLASS, $_POST;
+	global $_CLASS, $_POST;
 
-	$start		= request_var('start', 0);
+	$limit = 10;
+	$start = get_variable('start', 'REQUEST', 0, 'int');
 
 	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']->data['user_post_show_days'])) ? $_CLASS['core_user']->data['user_post_show_days'] : 0));
 	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']->data['user_post_sortby_type'])) ? $_CLASS['core_user']->data['user_post_sortby_type'] : 't'));
 	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']->data['user_post_sortby_dir'])) ? $_CLASS['core_user']->data['user_post_sortby_dir'] : 'd'));
 
-	$sort_days	= request_var('st', 0);
-	$sort_key	= request_var('sk', 't');
-	$sort_dir	= request_var('sd', 'd');
+	$sort_days	= get_variable('st', 'REQUEST', 0, 'int');
+	$sort_key	= get_variable('sk', 'REQUEST', 't');
+	$sort_dir	= get_variable('sd', 'REQUEST', 'd');
 	
 	// PM ordering options
 	$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_MESSAGES'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
@@ -206,9 +207,9 @@
 	$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
 	gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
 
-	if ($type != 'folder')
+	if ($type !== 'folder')
 	{
-		$folder_sql = ($type == 'unread') ? 't.unread = 1' : 't.new = 1';
+		$folder_sql = ($type === 'unread') ? 't.msg_unread = 1' : 't.msg_new = 1';
 		$folder_id = PRIVMSGS_INBOX;
 	}
 	else
@@ -219,7 +220,7 @@
 	// Limit pms to certain time frame, obtain correct pm count
 	if ($sort_days)
 	{
-		$min_post_time = time() - ($sort_days * 86400);
+		$min_post_time = $_CLASS['core_user']->time - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
 			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
@@ -241,7 +242,7 @@
 	}
 	else
 	{
-		if ($type == 'folder')
+		if ($type === 'folder')
 		{
 			$pm_count = $folder[$folder_id]['num_messages'];
 		}
@@ -271,22 +272,26 @@
 	}
 
 	$_CLASS['core_template']->assign_array(array(
-		'PAGINATION'		=> generate_pagination("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param", $pm_count, $config['topics_per_page'], $start),
-		'PAGE_NUMBER'		=> on_page($pm_count, $config['topics_per_page'], $start),
+		'PAGINATION'		=> generate_pagination("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param", $pm_count, $limit, $start),
+		'PAGE_NUMBER'		=> on_page($pm_count, $limit, $start),
 		'TOTAL_MESSAGES'	=> (($pm_count == 1) ? $_CLASS['core_user']->lang['VIEW_PM_MESSAGE'] : sprintf($_CLASS['core_user']->lang['VIEW_PM_MESSAGES'], $pm_count)),
 
-		'POST_IMG'			=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']->img('btn_post_pm', 'POST_PM'),
+		//'POST_IMG'			=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']->img('btn_post_pm', 'POST_PM'),
+		'POST_IMG'			=> $_CLASS['core_user']->img('btn_post_pm', 'POST_PM'),
 
 		'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'MESSAGE_REPORTED'),
 
-		'L_NO_MESSAGES'		=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->lang['POST_PM_LOCKED'] : $_CLASS['core_user']->lang['NO_MESSAGES'],
+		//'L_NO_MESSAGES'		=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->lang['POST_PM_LOCKED'] : $_CLASS['core_user']->lang['NO_MESSAGES'],
+		'L_NO_MESSAGES'		=> $_CLASS['core_user']->lang['NO_MESSAGES'],
 
 		'S_SELECT_SORT_DIR'		=> $s_sort_dir,
 		'S_SELECT_SORT_KEY'		=> $s_sort_key,
 		'S_SELECT_SORT_DAYS'	=> $s_limit_days,
-		'S_TOPIC_ICONS'			=> ($config['enable_pm_icons']) ? true : false, 
+		'S_TOPIC_ICONS'			=> true, 
 
-		'U_POST_NEW_TOPIC'	=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
+		//'U_POST_NEW_TOPIC'	=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
+		'U_POST_NEW_TOPIC'	=> generate_link($url.'&amp;mode=compose&amp;action=post'), 
+
 		'S_PM_ACTION'		=> generate_link("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id"))
 	);
 
@@ -295,14 +300,15 @@
 
 	// If the user is trying to reach late pages, start searching from the end
 	$store_reverse = false;
-	$sql_limit = $config['topics_per_page'];
+	$sql_limit = $limit;
+
 	if ($start > $pm_count / 2)
 	{
 		$store_reverse = true;
 
-		if ($start + $config['topics_per_page'] > $pm_count)
+		if ($start + $limit > $pm_count)
 		{
-			$sql_limit = min($config['topics_per_page'], max(1, $pm_count - $start));
+			$sql_limit = min($limit, max(1, $pm_count - $start));
 		}
 
 		// Select the sort order
@@ -317,7 +323,7 @@
 	}
 
 	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.message_reported, p.to_address, p.message_attachment, p.bcc_address, u.username 
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id
 			AND $folder_sql

Modified: cms/trunk/modules/control_panel/modules/ucp_profile.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_profile.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_profile.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,470 +21,466 @@
 $Id$
 */
 
-class ucp_profile extends module
-{
-	function ucp_profile($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
-		
-		$preview	= isset($_POST['preview']);
-		$submit		= isset($_POST['submit']);
+global $config, $_CLASS, $_CORE_CONFIG;
 
-		$module_link = generate_link("Control_Panel&amp;i=$id&amp;mode=$mode");
+$submit		= isset($_POST['submit']);
 
-		$error = $data = array();
-		$s_hidden_fields = '';
-		
-		switch ($mode)
+$error = $data = array();
+$hidden_fields = array();
+
+switch ($this->mode)
+{
+	case 'reg_details':
+		if ($submit)
 		{
-			case 'reg_details':
-				if ($submit)
-				{
-					$password		= get_variable('new_password', 'POST', false);
-					$cur_password	= get_variable('cur_password', 'POST', false);
+			$password		= get_variable('new_password', 'POST', false);
+			$cur_password	= get_variable('cur_password', 'POST', false);
 
-					if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']->data['user_password_encoding']) !== $_CLASS['core_user']->data['user_password'])
-					{
-						$error[] = $_CLASS['core_user']->get_lang('CURRENT_PASSWORD_INVALID');
-					}
+			if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']->data['user_password_encoding']) !== $_CLASS['core_user']->data['user_password'])
+			{
+				$error[] = $_CLASS['core_user']->get_lang('CURRENT_PASSWORD_INVALID');
+			}
 
-					if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
-					{
-						$error[] = $_CLASS['core_user']->get_lang('PASSWORD_MISMATCH');
-					}
+			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+			{
+				$error[] = $_CLASS['core_user']->get_lang('PASSWORD_MISMATCH');
+			}
 
-					if (empty($error) && $password === $cur_password)
-					{
-						$error[] = $_CLASS['core_user']->get_lang('PASSWORD_SAME');
-					}
+			if (empty($error) && $password === $cur_password)
+			{
+				$error[] = $_CLASS['core_user']->get_lang('PASSWORD_SAME');
+			}
 
-					if (empty($error))
-					{
-						$array = array(
-							'user_password' => encode_password($password, $_CLASS['core_user']->data['user_password_encoding']),
-						);
-						
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $array) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-
-						$_CLASS['core_db']->sql_query($sql);
-					}
-				}
-
-				$_CLASS['core_template']->assign_array(array(
-					'ERROR'				=> empty($error) ? '' : implode('<br />', $error),
-
-					'USERNAME'			=> $_CLASS['core_user']->data['username'],
-					'EMAIL'				=> $_CLASS['core_user']->data['user_email'],
-
-					'CONFIRM_EMAIL'		=> '',
-					'PASSWORD_CONFIRM'	=> (isset($password_confirm)) ? $password_confirm : '',
-					'NEW_PASSWORD'		=> (isset($new_password)) ? $new_password : '',
-					
-					'CUR_PASSWORD'					=> '', 
-					
-					'L_USERNAME_EXPLAIN'		=> '', 
-					'L_CHANGE_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+			if (empty($error))
+			{
+				$array = array(
+					'user_password' => encode_password($password, $_CLASS['core_user']->data['user_password_encoding']),
+				);
 				
-					'S_FORCE_PASSWORD'	=> false,
-					'S_CHANGE_USERNAME'	=> false, 
-					'S_CHANGE_EMAIL'	=> false,
-					'S_CHANGE_PASSWORD'	=> true
-				));
-			break;
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $array) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 
-			case 'profile_info':
+				$_CLASS['core_db']->sql_query($sql);
+			}
+		}
 
-				$error = array();
-				$this_year = gmdate('Y', time());
-				
-				if ($submit)
-				{
-					$icq	= get_variable('icq', 'POST', null);
-					$aim	= get_variable('aim', 'POST', null);
-					$msn	= get_variable('msn', 'POST', null);
-					$yim	= get_variable('yim', 'POST', null);
-					$jabber = get_variable('jabber', 'POST', null);
-					//$google = get_variable('google', 'POST', null);
+		$_CLASS['core_template']->assign_array(array(
+			'ERROR'				=> empty($error) ? '' : implode('<br />', $error),
 
-					$website	= get_variable('website', 'POST', null);
-					$location	= get_variable('location', 'POST', null);				
-					$occupation	= get_variable('occupation', 'POST', null);
-					$interests	= get_variable('interests', 'POST', null);
+			'USERNAME'			=> $_CLASS['core_user']->data['username'],
+			'EMAIL'				=> $_CLASS['core_user']->data['user_email'],
 
-					$bday_day	= get_variable('bday_day', 'POST', false);
-					$bday_month	= get_variable('bday_month', 'POST', false);
-					$bday_year	= get_variable('bday_year', 'POST', false);
+			'CONFIRM_EMAIL'		=> '',
+			'PASSWORD_CONFIRM'	=> (isset($password_confirm)) ? $password_confirm : '',
+			'NEW_PASSWORD'		=> (isset($new_password)) ? $new_password : '',
+			
+			'CUR_PASSWORD'					=> '', 
+			
+			'L_USERNAME_EXPLAIN'		=> '', 
+			'L_CHANGE_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+		
+			'S_FORCE_PASSWORD'	=> false,
+			'S_CHANGE_USERNAME'	=> false, 
+			'S_CHANGE_EMAIL'	=> false,
+			'S_CHANGE_PASSWORD'	=> true
+		));
+	break;
 
-					if ($bday_day || $bday_month || $bday_year)
-					{
-						if ($bday_day < 1 || $bday_day > 31 || $bday_month < 1 || $bday_month > 12 || $bday_year < ($this_year - 100) || $bday_month > $this_year)
-						{
-							$error[] = $_CLASS['core_user']->get_lang('BIRTHDAY_ERROR');
-						}
-					}
+	case 'signature':
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+		
+		// Generate smiley listing
+		generate_smilies('inline', 0);
 
-					if (mb_strlen($interests) > 255)
-					{
-						$error[] = $_CLASS['core_user']->get_lang('INTEREST_LONG_ERROR');
-					}
+		$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
+		$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
+		$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
+		$enable_urls	= !isset($_POST['disable_magic_url']);
 
-					if (mb_strlen($occupation) > 255)
-					{
-						$error[] = $_CLASS['core_user']->get_lang('OCCUPATION_LONG_ERROR');
-					}
+		$signature	= get_variable('signature', 'POST', $_CLASS['core_user']->data['user_sig']);
+		$preview	= isset($_POST['preview']);
 
-					if (empty($error))
-					{
-						$sql_ary = array(
-							'user_icq'		=> $icq,
-							'user_aim'		=> $aim,
-							'user_msnm'		=> $msn,
-							'user_yim'		=> $yim,
-							'user_jabber'	=> $jabber,
-							//'user_google'	=> $google,
-							'user_website'	=> $website,
-							'user_from'		=> $location,
-							'user_occ'		=> $occupation,
-							'user_interests'=> $interests,
-							'user_birthday'	=> ($bday_day) ? sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year) : null,
-						);
-	
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->sql_query($sql);
-	
-						$_CLASS['core_display']->meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
-						trigger_error($message);
-					}
-				}
+		if ($submit || $preview)
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
 
-				if (!isset($bday_day))
+			if (trim($signature))
+			{
+				$message_parser = new parse_message($signature);
+
+				// Allowing Quote BBCode
+				$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
+				
+				if (!empty($message_parser->warn_msg))
 				{
-					if ($_CLASS['core_user']->data['user_birthday'])
-					{
-						list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']->data['user_birthday']);
-					}
-					else
-					{
-						$bday_day = $bday_month = $bday_year = '';
-					}
+					$error[] = implode('<br />', $message_parser->warn_msg);
 				}
+			}
 
-				$s_birthday_day_options = '<option value="0"' . ((!$bday_day) ? ' selected="selected"' : '') . '>--</option>';
-
-				for ($i = 1; $i < 32; $i++)
+			if (empty($error) && $submit)
+			{
+				if ($signature && !empty($message_parser->message))
 				{
-					$selected = ($i == $bday_day) ? ' selected="selected"' : '';
-					$s_birthday_day_options .= "<option value=\"$i\"$selected>$i</option>";
+					$sql_array = array(
+						'user_sig'					=> (string) $message_parser->message, 
+						'user_sig_bbcode_uid'		=> (string) $message_parser->bbcode_uid, 
+						'user_sig_bbcode_bitfield'	=> (int) $message_parser->bbcode_bitfield
+					);
 				}
-
-				$s_birthday_month_options = '<option value="0"' . ((!$bday_month) ? ' selected="selected"' : '') . '>--</option>';
-				for ($i = 1; $i < 13; $i++)
+				else
 				{
-					$selected = ($i == $bday_month) ? ' selected="selected"' : '';
-					$s_birthday_month_options .= "<option value=\"$i\"$selected>$i</option>";
+					$sql_array = array(
+						'user_sig'					=> (string) '', 
+						'user_sig_bbcode_uid'		=> (string) '', 
+						'user_sig_bbcode_bitfield'	=> (int) 0
+					);
 				}
-				$s_birthday_year_options = '';
 
-				$s_birthday_year_options = '<option value="0"' . ((!$bday_year) ? ' selected="selected"' : '') . '>--</option>';
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->sql_query($sql);
 
-				$i = $this_year - 100;
-				for ($i; $i < $this_year; $i++)
-				{
-					$selected = ($i == $bday_year) ? ' selected="selected"' : '';
-					$s_birthday_year_options .= "<option value=\"$i\"$selected>$i</option>";
-				}
+				$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'. generate_link($this->link) .'">', '</a>');
+				trigger_error($message);
+			}
+		}
 
-				$_CLASS['core_template']->assign_array(array(
-					'ERROR'		=> empty($error) ? '' : implode('<br />', $error),
+		$signature_preview = '';
 
-					'ICQ'		=> isset($icq) ? $icq : $_CLASS['core_user']->data['user_icq'], 
-					'YIM'		=> isset($yim) ? $yim : $_CLASS['core_user']->data['user_yim'], 
-					'AIM'		=> isset($aim) ? $aim : $_CLASS['core_user']->data['user_aim'], 
-					'MSN'		=> isset($msn) ? $msn : $_CLASS['core_user']->data['user_msnm'], 
-					//'GOOGLE'	=> isset($google) ? $google : $_CLASS['core_user']->data['user_google'], 
-					'JABBER'	=> isset($jabber) ? $jabber : $_CLASS['core_user']->data['user_jabber'], 
-					'WEBSITE'	=> isset($website) ? $website : $_CLASS['core_user']->data['user_website'], 
-					'LOCATION'	=> isset($location) ? $location : $_CLASS['core_user']->data['user_from'], 
-					'OCCUPATION'=> isset($occupation) ? $occupation : $_CLASS['core_user']->data['user_occ'], 
-					'INTERESTS'	=> isset($interests) ? $interests : $_CLASS['core_user']->data['user_interests'], 
+		if ($preview && $signature)
+		{
+			// Now parse it for displaying
+			$signature_preview = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
+			unset($message_parser);
+		}
 
-					'S_BIRTHDAY_DAY_OPTIONS'	=> $s_birthday_day_options, 
-					'S_BIRTHDAY_MONTH_OPTIONS'	=> $s_birthday_month_options, 
-					'S_BIRTHDAY_YEAR_OPTIONS'	=> $s_birthday_year_options,
-				));
-			break;
+		if ($signature)
+		{
+			decode_message($signature, $_CLASS['core_user']->data['user_sig_bbcode_uid']);
+		}
 
-			case 'signature':
-				require($site_file_root.'includes/forums/functions_posting.php');
-				
-				// Generate smiley listing
-				generate_smilies('inline', 0);
-	
-				$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
-				$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
-				$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
-				$enable_urls	= !isset($_POST['disable_magic_url']);
+		$_CLASS['core_template']->assign_array(array(
+			'ERROR'				=> empty($error) ? '' : implode('<br />', $error), 
+			'SIGNATURE'			=> $signature,
+			'SIGNATURE_PREVIEW'	=> $signature_preview, 
+			
+			'S_HTML_CHECKED' 		=> ($enable_html) ? '' : 'checked="checked"',
+			'S_BBCODE_CHECKED' 		=> ($enable_bbcode) ? '' : 'checked="checked"',
+			'S_SMILIES_CHECKED' 	=> ($enable_smilies) ? '' : 'checked="checked"',
+			'S_MAGIC_URL_CHECKED' 	=> ($enable_urls) ? '' : 'checked="checked"',
 
-				$signature		= get_variable('signature', 'POST', $_CLASS['core_user']->data['user_sig']);
-				$signature_preview = '';
-				$sql_array = false;
+			'HTML_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('HTML_IS_ON') : $_CLASS['core_user']->get_lang('HTML_IS_OFF'),
+			'BBCODE_STATUS'			=> (true) ? sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_ON'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>') : sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_OFF'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
+			'SMILIES_STATUS'		=> (true) ? $_CLASS['core_user']->get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']->get_lang('SMILIES_ARE_OFF'),
+			'IMG_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']->get_lang('IMAGES_ARE_OFF'),
+			'FLASH_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('FLASH_IS_ON') : $_CLASS['core_user']->get_lang('FLASH_IS_OFF'),
 
-				if ($submit || $preview)
-				{
-					require_once($site_file_root.'includes/forums/message_parser.php');
+			'L_SIGNATURE_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
 
-					if ($signature)
-					{
-						$message_parser = new parse_message($signature);
-	
-						// Allowing Quote BBCode
-						$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
-						
-						if (!empty($message_parser->warn_msg))
-						{
-							$error[] = implode('<br />', $message_parser->warn_msg);
-						}
-					}
+			'S_HTML_ALLOWED'		=> true, 
+			'S_BBCODE_ALLOWED'		=> true, 
+			'S_SMILIES_ALLOWED'		=> true,
+		));
+	break;
 
-					if (empty($error) && $submit)
-					{
-						if ($signature && !empty($message_parser->message))
-						{
-							$sql_array = array(
-								'user_sig'					=> (string) $message_parser->message, 
-								'user_sig_bbcode_uid'		=> (string) $message_parser->bbcode_uid, 
-								'user_sig_bbcode_bitfield'	=> (int) $message_parser->bbcode_bitfield
-							);
-						}
-						else
-						{
-							$sql_array = array(
-								'user_sig'					=> (string) '', 
-								'user_sig_bbcode_uid'		=> (string) '', 
-								'user_sig_bbcode_bitfield'	=> (int) 0
-							);
-						}
+	case 'avatar':
+		$display_gallery = isset($_POST['display_gallery']);
+		$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->sql_query($sql);
+		$delete = isset($_POST['delete']);
 
-						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
-						trigger_error($message);
-					}
+		// Can we upload? 
+		$can_upload = (@ini_get('file_uploads') && file_exists($_CORE_CONFIG['global']['path_avatar_upload']) && is_writeable($_CORE_CONFIG['global']['path_avatar_upload']));
+
+		if ($submit)
+		{
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+			$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
+
+			if ($gallery_avatar)
+			{
+				if (!file_exists($config['avatar_gallery_path'] . '/' . $gallery_avatar))
+				{
+					$error[] = 'BAD_AVATAR';
 				}
+				else
+				{
+					$type = AVATAR_GALLERY;
+					$filename = $gallery_avatar;
 
-				if ($preview && $signature)
+					list($width, $height) = getimagesize($_CORE_CONFIG['global']['path_avatar_gallery'] . '/' . $gallery_avatar);
+				}
+			}
+			else
+			{
+				$data['uploadurl']	= get_variable('uploadurl', 'POST', false);
+				$data['remotelink']	= get_variable('remotelink', 'POST', '');
+				$data['width']		= get_variable('width', 'POST', '');
+				$data['height']		= get_variable('height', 'POST', '');
+				$data['user_id']	= $_CLASS['core_user']->data['user_id'];
+
+				if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) && $can_upload)
 				{
-					// Now parse it for displaying
-					$signature_preview = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
-					unset($message_parser);
+					list($type, $filename, $width, $height) = avatar_upload($data, $error);
 				}
+				elseif ($data['remotelink'] && $config['allow_avatar_remote'])
+				{
+					list($type, $filename, $width, $height) = avatar_remote($data, $error);
+				}
+				elseif ($delete)
+				{
+					$filename = '';
+					$type = $width = $height = 0;
+				}
+				else
+				{
+					$error[] = 'IM_LOST';
+				}
+			}
 
-				if ($signature)
+			if (empty($error))
+			{
+				$sql_ary = array(
+					'user_avatar'			=> (string) $filename, 
+					'user_avatar_type'		=> (int) $type, 
+					'user_avatar_width'		=> (int) $width, 
+					'user_avatar_height'	=> (int) $height, 
+				);
+
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->sql_query($sql);
+
+				/* Delete old avatar if present */
+				if ($_CLASS['core_user']->data['user_avatar'] && $filename !== $_CLASS['core_user']->data['user_avatar'] && $_CLASS['core_user']->data['user_avatar_type'] != AVATAR_GALLERY)
 				{
-					decode_message($signature, $_CLASS['core_user']->data['user_sig_bbcode_uid']);
+					avatar_delete($_CLASS['core_user']->data['user_avatar']);
 				}
 
-				$_CLASS['core_template']->assign_array(array(
-					'ERROR'				=> empty($error) ? '' : implode('<br />', $error), 
-					'SIGNATURE'			=> $signature,
-					'SIGNATURE_PREVIEW'	=> $signature_preview, 
-					
-					'S_HTML_CHECKED' 		=> ($enable_html) ? '' : 'checked="checked"',
-					'S_BBCODE_CHECKED' 		=> ($enable_bbcode) ? '' : 'checked="checked"',
-					'S_SMILIES_CHECKED' 	=> ($enable_smilies) ? '' : 'checked="checked"',
-					'S_MAGIC_URL_CHECKED' 	=> ($enable_urls) ? '' : 'checked="checked"',
+				$_CLASS['core_user']->data += $sql_ary;
+				unset($sql_ary);
 
-					'HTML_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('HTML_IS_ON') : $_CLASS['core_user']->get_lang('HTML_IS_OFF'),
-					'BBCODE_STATUS'			=> (true) ? sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_ON'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>') : sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_OFF'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
-					'SMILIES_STATUS'		=> (true) ? $_CLASS['core_user']->get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']->get_lang('SMILIES_ARE_OFF'),
-					'IMG_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']->get_lang('IMAGES_ARE_OFF'),
-					'FLASH_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('FLASH_IS_ON') : $_CLASS['core_user']->get_lang('FLASH_IS_OFF'),
+				$_CLASS['core_display']->meta_refresh(3, generate_link($this->link));
+				$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'. generate_link($this->link) .'">', '</a>');
+				trigger_error($message);
+			}
 
-					'L_SIGNATURE_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
+			$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
+		}
 
-					'S_HTML_ALLOWED'		=> true, 
-					'S_BBCODE_ALLOWED'		=> true, 
-					'S_SMILIES_ALLOWED'		=> true,
-				));
-			break;
+		// Generate users avatar
+		$avatar_img = '';
 
-			case 'avatar':
+		if ($_CLASS['core_user']->data['user_avatar'])
+		{
+			switch ($_CLASS['core_user']->data['user_avatar_type'])
+			{
+				case AVATAR_UPLOAD:
+					$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+				break;
 
-				$display_gallery = isset($_POST['display_gallery']);
-				$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
+				case AVATAR_GALLERY:
+					$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+				break;
+			}
 
-				$delete = isset($_POST['delete']);
+			$avatar_img .= $_CLASS['core_user']->data['user_avatar'];
+			$avatar_img = '<img src="' . $avatar_img . '" width="' . $_CLASS['core_user']->data['user_avatar_width'] . '" height="' . $_CLASS['core_user']->data['user_avatar_height'] . '" border="0" alt="" />';
+		}
 
-				// Can we upload? 
-				$can_upload = (file_exists($config['avatar_path']) && is_writeable($config['avatar_path']) && @ini_get('file_uploads')) ? true : false;
+		$_CLASS['core_template']->assign_array(array(
+			'ERROR'			=> empty($error) ? '' : implode('<br />', $error), 
+			'AVATAR'		=> $avatar_img, 
+			'AVATAR_SIZE'	=> $config['avatar_filesize'], 
 
-				if ($submit)
-				{
-					require_once($site_file_root.'includes/functions_user.php');
+			'S_FORM_ENCTYPE'	=> ($can_upload) ? ' enctype="multipart/form-data"' : '', 
 
-					$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
+			'L_AVATAR_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),)
+		);
 
-					if ($config['allow_avatar_local'] && $gallery_avatar)
-					{
-						if (!file_exists($config['avatar_gallery_path'] . '/' . $gallery_avatar))
-						{
-							$error[] = 'BAD_AVATAR';
-						}
-						else
-						{
-							$type = AVATAR_GALLERY;
-							$filename = $gallery_avatar;
+		if ($display_gallery)
+		{
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
-							list($width, $height) = getimagesize($config['avatar_gallery_path'] . '/' . $gallery_avatar);
-						}
-					}
-					else
-					{
-						$data['uploadurl']	= get_variable('uploadurl', 'POST', false);
-						$data['remotelink']	= get_variable('remotelink', 'POST', '');
-						$data['width']		= get_variable('width', 'POST', '');
-						$data['height']		= get_variable('height', 'POST', '');
-						$data['user_id']	= $_CLASS['core_user']->data['user_id'];
+			$avatar_list = avatar_gallery($folder, $folders, $error);
 
-						if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) && $can_upload)
-						{
-							list($type, $filename, $width, $height) = avatar_upload($data, $error);
-						}
-						elseif ($data['remotelink'] && $config['allow_avatar_remote'])
-						{
-							list($type, $filename, $width, $height) = avatar_remote($data, $error);
-						}
-						elseif ($delete)
-						{
-							$filename =  '';
-							$type = $width = $height = 0;
-						}
-						else
-						{
-							$error[] = 'IM_LOST';
-						}
-					}
+			array_unshift($folders, '');
 
-					if (empty($error))
-					{
-						$sql_ary = array(
-							'user_avatar'			=> (string) $filename, 
-							'user_avatar_type'		=> (int) $type, 
-							'user_avatar_width'		=> (int) $width, 
-							'user_avatar_height'	=> (int) $height, 
-						);
+			$s_category_options = '';
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->sql_query($sql);
+			foreach ($folders as $cat)
+			{
+				$s_category_options .= '<option value="' . $cat . '"' . (($cat == $folder) ? ' selected="selected"' : '') . '>' . (($cat) ? $cat : '--') . '</option>';
+			}
 
-						// Delete old avatar if present
-						if ($_CLASS['core_user']->data['user_avatar'] && $filename != $_CLASS['core_user']->data['user_avatar'] && $_CLASS['core_user']->data['user_avatar_type'] != AVATAR_GALLERY)
-						{
-							avatar_delete($_CLASS['core_user']->data['user_avatar']);
-						}
+			$_CLASS['core_template']->assign_array(array(
+				'S_DISPLAY_GALLERY'	=> true,
+				'S_CAT_OPTIONS'		=> $s_category_options
+			));
 
-						$_CLASS['core_display']->meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
-						trigger_error($message);
-					}
+			foreach ($avatar_list as $avatar)
+			{
+				$_CLASS['core_template']->assign_vars_array('avatar',  array(
+					'AVATAR_IMAGE'		=> $config['avatar_gallery_path'] . '/' . $avatar['file'],
+					'AVATAR_NAME'		=> $avatar['name'],
+					'AVATAR_FILE'		=> $avatar['file'],
+				));
+			}
+			unset($avatar_list);
+		}
+		else
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'AVATAR'		=> $avatar_img,
+				'AVATAR_SIZE'	=> $config['avatar_filesize'],
+				'WIDTH'			=> $_CLASS['core_user']->data['user_avatar_width'],
+				'HEIGHT'		=> $_CLASS['core_user']->data['user_avatar_height'],
 
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
-				}
+				'S_CAN_UPLOAD'		=> $can_upload,
+				'S_LINK_AVATAR'		=> ($config['allow_avatar_remote']),
+				'S_GALLERY_AVATAR'	=> ($config['allow_avatar_local']),
+			));
+		}
 
-				// Generate users avatar
-				$avatar_img = '';
+	break;
+	
+	default:
+	//case 'profile_info':
+		$this->mode = 'profile_info';
 
-				if ($_CLASS['core_user']->data['user_avatar'])
-				{
-					switch ($_CLASS['core_user']->data['user_avatar_type'])
-					{
-						case AVATAR_UPLOAD:
-							$avatar_img = $config['avatar_path'] . '/';
-							break;
-						case AVATAR_GALLERY:
-							$avatar_img = $config['avatar_gallery_path'] . '/';
-							break;
-					}
-					$avatar_img .= $_CLASS['core_user']->data['user_avatar'];
+		$this_year = gmdate('Y', time());
+		
+		if ($submit)
+		{
+			$icq	= get_variable('icq', 'POST', null);
+			$aim	= get_variable('aim', 'POST', null);
+			$msn	= get_variable('msn', 'POST', null);
+			$yim	= get_variable('yim', 'POST', null);
+			$jabber = get_variable('jabber', 'POST', null);
+			//$google = get_variable('google', 'POST', null);
 
-					$avatar_img = '<img src="' . $avatar_img . '" width="' . $_CLASS['core_user']->data['user_avatar_width'] . '" height="' . $_CLASS['core_user']->data['user_avatar_height'] . '" border="0" alt="" />';
+			$website	= get_variable('website', 'POST', null);
+			$location	= get_variable('location', 'POST', null);				
+			$occupation	= get_variable('occupation', 'POST', null);
+			$interests	= get_variable('interests', 'POST', null);
+
+			$bday_day	= get_variable('bday_day', 'POST', false);
+			$bday_month	= get_variable('bday_month', 'POST', false);
+			$bday_year	= get_variable('bday_year', 'POST', false);
+
+			if ($bday_day || $bday_month || $bday_year)
+			{
+				if ($bday_day < 1 || $bday_day > 31 || $bday_month < 1 || $bday_month > 12 || $bday_year < ($this_year - 100) || $bday_month > $this_year)
+				{
+					$error[] = $_CLASS['core_user']->get_lang('BIRTHDAY_ERROR');
 				}
+			}
 
-				$_CLASS['core_template']->assign_array(array(
-					'ERROR'			=> empty($error) ? '' : implode('<br />', $error), 
-					'AVATAR'		=> $avatar_img, 
-					'AVATAR_SIZE'	=> $config['avatar_filesize'], 
+			if (mb_strlen($interests) > 255)
+			{
+				$error[] = $_CLASS['core_user']->get_lang('INTEREST_LONG_ERROR');
+			}
 
-					'S_FORM_ENCTYPE'	=> ($can_upload) ? ' enctype="multipart/form-data"' : '', 
+			if (mb_strlen($occupation) > 255)
+			{
+				$error[] = $_CLASS['core_user']->get_lang('OCCUPATION_LONG_ERROR');
+			}
 
-					'L_AVATAR_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),)
+			if (empty($error))
+			{
+				$sql_ary = array(
+					'user_icq'		=> $icq,
+					'user_aim'		=> $aim,
+					'user_msnm'		=> $msn,
+					'user_yim'		=> $yim,
+					'user_jabber'	=> $jabber,
+					//'user_google'	=> $google,
+					'user_website'	=> $website,
+					'user_from'		=> $location,
+					'user_occ'		=> $occupation,
+					'user_interests'=> $interests,
+					'user_birthday'	=> ($bday_day) ? sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year) : null,
 				);
 
-				if ($display_gallery && $config['allow_avatar_local'])
-				{
-					require_once($site_file_root.'includes/functions_user.php');
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+				$_CLASS['core_db']->sql_query($sql);
 
-					$avatar_list = avatar_gallery($folder, $folders, $error);
+				$_CLASS['core_display']->meta_refresh(3, generate_link($this->link));
+				$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'. generate_link($this->link) .'">', '</a>');
+				trigger_error($message);
+			}
+		}
 
-					array_unshift($folders, '');
+		if (!isset($bday_day))
+		{
+			if ($_CLASS['core_user']->data['user_birthday'])
+			{
+				list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']->data['user_birthday']);
+			}
+			else
+			{
+				$bday_day = $bday_month = $bday_year = '';
+			}
+		}
 
-					$s_category_options = '';
+		$s_birthday_day_options = '<option value="0"' . ((!$bday_day) ? ' selected="selected"' : '') . '>--</option>';
 
-					foreach ($folders as $cat)
-					{
-						$s_category_options .= '<option value="' . $cat . '"' . (($cat == $folder) ? ' selected="selected"' : '') . '>' . (($cat) ? $cat : '--') . '</option>';
-					}
+		for ($i = 1; $i < 32; $i++)
+		{
+			$selected = ($i == $bday_day) ? ' selected="selected"' : '';
+			$s_birthday_day_options .= "<option value=\"$i\"$selected>$i</option>";
+		}
 
-					$_CLASS['core_template']->assign_array(array(
-						'S_DISPLAY_GALLERY'	=> true,
-						'S_CAT_OPTIONS'		=> $s_category_options)
-					);
+		$s_birthday_month_options = '<option value="0"' . ((!$bday_month) ? ' selected="selected"' : '') . '>--</option>';
+		for ($i = 1; $i < 13; $i++)
+		{
+			$selected = ($i == $bday_month) ? ' selected="selected"' : '';
+			$s_birthday_month_options .= "<option value=\"$i\"$selected>$i</option>";
+		}
+		$s_birthday_year_options = '';
 
-					foreach ($avatar_list as $avatar)
-					{
-						$_CLASS['core_template']->assign_vars_array('avatar',  array(
-							'AVATAR_IMAGE'		=> $config['avatar_gallery_path'] . '/' . $avatar['file'],
-							'AVATAR_NAME'		=> $avatar['name'],
-							'AVATAR_FILE'		=> $avatar['file'],
-						));
-					}
-					unset($avatar_list);
-				}
-				else
-				{
-					$_CLASS['core_template']->assign_array(array(
-						'AVATAR'		=> $avatar_img,
-						'AVATAR_SIZE'	=> $config['avatar_filesize'],
-						'WIDTH'			=> $_CLASS['core_user']->data['user_avatar_width'],
-						'HEIGHT'		=> $_CLASS['core_user']->data['user_avatar_height'],
+		$s_birthday_year_options = '<option value="0"' . ((!$bday_year) ? ' selected="selected"' : '') . '>--</option>';
 
-						'S_CAN_UPLOAD'		=> $can_upload,
-						'S_LINK_AVATAR'		=> ($config['allow_avatar_remote']),
-						'S_GALLERY_AVATAR'	=> ($config['allow_avatar_local']),
-					));
-				}
-
-				break;
+		$i = $this_year - 100;
+		for ($i; $i < $this_year; $i++)
+		{
+			$selected = ($i == $bday_year) ? ' selected="selected"' : '';
+			$s_birthday_year_options .= "<option value=\"$i\"$selected>$i</option>";
 		}
 
 		$_CLASS['core_template']->assign_array(array(
-			'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_PROFILE_' . strtoupper($mode)],
-			'S_HIDDEN_FIELDS'			=> $s_hidden_fields,
-			'S_UCP_ACTION'				=> $module_link
-		));
+			'ERROR'		=> empty($error) ? '' : implode('<br />', $error),
 
-		$this->display($_CLASS['core_user']->lang['UCP_PROFILE'], 'ucp_profile_' . $mode . '.html');
-	}
+			'ICQ'		=> isset($icq) ? $icq : $_CLASS['core_user']->data['user_icq'], 
+			'YIM'		=> isset($yim) ? $yim : $_CLASS['core_user']->data['user_yim'], 
+			'AIM'		=> isset($aim) ? $aim : $_CLASS['core_user']->data['user_aim'], 
+			'MSN'		=> isset($msn) ? $msn : $_CLASS['core_user']->data['user_msnm'], 
+			//'GOOGLE'	=> isset($google) ? $google : $_CLASS['core_user']->data['user_google'], 
+			'JABBER'	=> isset($jabber) ? $jabber : $_CLASS['core_user']->data['user_jabber'], 
+			'WEBSITE'	=> isset($website) ? $website : $_CLASS['core_user']->data['user_website'], 
+			'LOCATION'	=> isset($location) ? $location : $_CLASS['core_user']->data['user_from'], 
+			'OCCUPATION'=> isset($occupation) ? $occupation : $_CLASS['core_user']->data['user_occ'], 
+			'INTERESTS'	=> isset($interests) ? $interests : $_CLASS['core_user']->data['user_interests'], 
+
+			'S_BIRTHDAY_DAY_OPTIONS'	=> $s_birthday_day_options, 
+			'S_BIRTHDAY_MONTH_OPTIONS'	=> $s_birthday_month_options, 
+			'S_BIRTHDAY_YEAR_OPTIONS'	=> $s_birthday_year_options,
+		));
+	break;
 }
 
+$_CLASS['core_template']->assign_array(array(
+	'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_PROFILE_' . strtoupper($this->mode)],
+	'S_HIDDEN_FIELDS'			=> generate_hidden_fields($hidden_fields),
+	'S_UCP_ACTION'				=> generate_link($this->link)
+));
+
+$_CLASS['core_display']->display($_CLASS['core_user']->lang['UCP_PROFILE'], 'modules/control_panel/ucp_profile_' . $this->mode . '.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_register.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_register.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_register.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,294 +21,286 @@
 $Id$
 */
 
-class ucp_register extends module 
+
+global $_CLASS, $_CORE_CONFIG;
+
+$coppa  = isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
+$submit = isset($_POST['submit']);
+
+if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
+	|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
+	&& !$_CORE_CONFIG['email']['email_enable'])
 {
-	function ucp_register($id, $mode)
+	trigger_error('UCP_REGISTER_DISABLE');
+}
+
+$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
+
+$error = $data = array();
+$hidden_fields = '';
+
+if (!isset($_POST['agreed']))
+{
+	if ($_CORE_CONFIG['user']['coppa_enable'] && is_null($coppa))
 	{
-		global $site_file_root, $config, $_CLASS, $_CORE_CONFIG;
-		
-		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
-		$submit		= isset($_POST['submit']);
+		$now = explode(':', gmdate('m:j:Y'));
 
-		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
-			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-			&& !$_CORE_CONFIG['email']['email_enable'])
-		{
-			trigger_error('UCP_REGISTER_DISABLE');
-		}
+		$coppa_birthday = $_CLASS['core_user']->format_date(mktime(12, 0, 0, $now[0], $now[1], $now[2] - 13), 'D M d, Y'); 
 
-		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
+		$_CLASS['core_template']->assign_array(array(
+			'L_COPPA_NO'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_BEFORE'], $coppa_birthday),
+			'L_COPPA_YES'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
 
-		$error = $data = array();
-		$s_hidden_fields = '';
+			'U_COPPA_NO'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=0'), 
+			'U_COPPA_YES'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
 
+			'S_SHOW_COPPA'		=> true, 
+			'S_HIDDEN_FIELDS'	=> $hidden_fields,
+			'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
+		);
+	}
+	else
+	{
+		$hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
 
-		if (!isset($_POST['agreed']))
-		{
-			if ($_CORE_CONFIG['user']['coppa_enable'] && is_null($coppa))
-			{
-				$now = explode(':', gmdate('m:j:Y'));
+		$_CLASS['core_template']->assign_array(array(
+			'S_SHOW_COPPA'		=> false,
+			'S_HIDDEN_FIELDS'	=> $hidden_fields,
+			'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register')
+		));
+	}
 
-				$coppa_birthday = $_CLASS['core_user']->format_date(mktime(12, 0, 0, $now[0], $now[1], $now[2] - 13), 'D M d, Y'); 
+	$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/Control_Panel/ucp_agreement.html');
+}
 
-				$_CLASS['core_template']->assign_array(array(
-					'L_COPPA_NO'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_BEFORE'], $coppa_birthday),
-					'L_COPPA_YES'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
+if ($submit)
+{
+	require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
-					'U_COPPA_NO'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=0'), 
-					'U_COPPA_YES'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
+	$error = array();
 
-					'S_SHOW_COPPA'		=> true, 
-					'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
-					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
-				);
-			}
-			else
-			{
-				$s_hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
+	$username	= get_variable('username', 'POST', false);
+	$password	= get_variable('password', 'POST', false);
 
-				$_CLASS['core_template']->assign_array(array(
-					'S_SHOW_COPPA'		=> false,
-					'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
-					'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register')
-				));
-			}
+	$email			= get_variable('email', 'POST', false);
+	$email_confirm	= get_variable('email_confirm', 'POST', '');
 
-			$this->display($_CLASS['core_user']->lang['REGISTER'], 'ucp_agreement.html');
+	//when we add this make sure to confirm that it's one of the installed langs
+	$lang		= $_CORE_CONFIG['global']['default_lang'];
+	$tz			= get_variable('tz', 'POST', false);
 
-			script_close();
-		}
+	if (strpos($username, "\n"))
+	{
+		die;
+	}
 
-		if ($submit)
-		{
-			require_once($site_file_root.'includes/functions_user.php');
+	$username_validate = validate_username($username);
 
-			$error = array();
+	if ($username_validate !== true)
+	{
+		$error[] = $_CLASS['core_user']->get_lang($username_validate);
+	}
 
-			$username	= get_variable('username', 'POST', false);
-			$password	= get_variable('password', 'POST', false);
+	if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+	{
+		$error[] = $_CLASS['core_user']->get_lang('PASSWORD_ERROR');
+	}
 
-			$email			= get_variable('email', 'POST', false);
-			$email_confirm	= get_variable('email_confirm', 'POST', '');
+	if (!$email || $email !== $email_confirm)
+	{
+		$error[] = $_CLASS['core_user']->get_lang('EMAIL_ERROR');
+	}
+	elseif (!check_email($email))
+	{
+		$error[] = $_CLASS['core_user']->get_lang('EMAIL_INVALID');
+	}
 
-			//when we add this make sure to confirm that it's one of the installed langs
-			$lang		= $_CORE_CONFIG['global']['default_lang'];
-			$tz			= get_variable('tz', 'POST', false);
+	if (!$tz || !in_array($tz, tz_array()))
+	{
+		$tz = null;
+	}
 
-			if (strpos($username, "\n"))
-			{
-				die;
-			}
+	if ($_CORE_CONFIG['user']['enable_confirm'])
+	{
+		$confirmation_code = $_CLASS['core_user']->session_data_get('confirmation_code');
+		$confirm_code = trim(get_variable('confirm_code', 'POST', false));
 
-			$username_validate = validate_username($username);
+		if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
+		{
+			$error[] = $_CLASS['core_user']->get_lang('CONFIRM_CODE_WRONG');
+		}
 
-			if ($username_validate !== true)
-			{
-				$error[] = $_CLASS['core_user']->get_lang($username_validate);
-			}
+		// we don't need this any more
+		$_CLASS['core_user']->user_data_kill('confirmation_code');
+	}
 
-			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
-			{
-				$error[] = $_CLASS['core_user']->get_lang('PASSWORD_ERROR');
-			}
+	if (empty($error))
+	{
+		$encode_password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
 
-			if (!$email || $email !== $email_confirm)
-			{
-				$error[] = $_CLASS['core_user']->get_lang('EMAIL_ERROR');
-			}
-			elseif (!check_email($email))
-			{
-				$error[] = $_CLASS['core_user']->get_lang('EMAIL_INVALID');
-			}
+		if (!$encode_password)
+		{
+			//do some admin contact thing here
+			die('Activation disabled: Passwaord encoding problem');
+		}
 
-			if (!$tz || !in_array($tz, tz_array()))
+		if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
+		{
+			$user_status = STATUS_PENDING;
+			$user_act_key = generate_string(10);
+
+			if ($coppa)
 			{
-				$tz = null;
+				$message = $_CLASS['core_user']->get_lang('ACCOUNT_COPPA');
+				$email_template = 'activation_coppa_inactive.txt';
 			}
-
-			if ($_CORE_CONFIG['user']['enable_confirm'])
+			elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
 			{
-				$confirmation_code = $_CLASS['core_user']->session_data_get('confirmation_code');
-				$confirm_code = trim(get_variable('confirm_code', 'POST', false));
-
-				if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
-				{
-					$error[] = $_CLASS['core_user']->get_lang('CONFIRM_CODE_WRONG');
-				}
-
-				// we don't need this any more
-				$_CLASS['core_user']->user_data_kill('confirmation_code');
+				$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE');
+				$email_template = 'activation_inactive.txt';
 			}
-
-			if (empty($error))
+			elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			{
-				$encode_password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
+				$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE_ADMIN');
+				$email_template = 'activation_admin_inactive.txt';
+			}
+		}
+		else
+		{
+			$user_status = STATUS_ACTIVE;
+			$user_act_key = null;
 	
-				if (!$encode_password)
-				{
-					//do some admin contact thing here
-					die('Activation disabled: Passwaord encoding problem');
-				}
+			$email_template = 'activation_active.txt';
+			$message = $_CLASS['core_user']->get_lang('ACCOUNT_ADDED');
+		}
 
-				if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-				{
-					$user_status = STATUS_PENDING;
-					$user_act_key = generate_string(10);
+		$data = array(
+			'username'		=> (string) $username,
+			'user_email'	=> (string) $email,
+// add an option so admin can set with group they added to
+			'user_group'	=> ($coppa) ? 3 : 2,
+			'user_reg_date'	=> (int) $_CLASS['core_user']->time,
+			'user_timezone'	=> (string) $tz,
 
-					if ($coppa)
-					{
-						$message = $_CLASS['core_user']->get_lang('ACCOUNT_COPPA');
-						$email_template = 'activation_coppa_inactive.txt';
-					}
-					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
-					{
-						$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE');
-						$email_template = 'activation_inactive.txt';
-					}
-					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-					{
-						$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE_ADMIN');
-						$email_template = 'activation_admin_inactive.txt';
-					}
-				}
-				else
-				{
-					$user_status = STATUS_ACTIVE;
-					$user_act_key = null;
-			
-					$email_template = 'activation_active.txt';
-					$message = $_CLASS['core_user']->get_lang('ACCOUNT_ADDED');
-				}
+			'user_password'			=> (string) $encode_password,
+			'user_password_encoding'=> (string) $_CORE_CONFIG['user']['password_encoding'],
 
-				$data = array(
-					'username'		=> (string) $username,
-					'user_email'	=> (string) $email,
-// add an option so admin can set with group they added to
-					'user_group'	=> ($coppa) ? 3 : 2,
-					'user_reg_date'	=> (int) $_CLASS['core_user']->time,
-					'user_timezone'	=> (string) $tz,
+			'user_lang'			=> ($lang) ? (string) $lang : null,
+			'user_type'			=> USER_NORMAL,
+			'user_status'		=> (int) $user_status,
+			'user_act_key'		=> (string) $user_act_key,
+			'user_ip'			=> (string) $_CLASS['core_user']->ip,
+		);
 
-					'user_password'			=> (string) $encode_password,
-					'user_password_encoding'=> (string) $_CORE_CONFIG['user']['password_encoding'],
+		user_add($data);
 
-					'user_lang'			=> ($lang) ? (string) $lang : null,
-					'user_type'			=> USER_NORMAL,
-					'user_status'		=> (int) $user_status,
-					'user_act_key'		=> (string) $user_act_key,
-					'user_ip'			=> (string) $_CLASS['core_user']->ip,
-				);
+		if ($data['user_status'] === STATUS_ACTIVE)
+		{
+			set_core_config('user', 'newest_user_id', $data['user_id'], false);
+			set_core_config('user', 'newest_username', $data['username'], false);
+			set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
+		}
 
-				user_add($data);
+		require_once SITE_FILE_ROOT.'includes/mailer.php';
 
-				if ($data['user_status'] === STATUS_ACTIVE)
-				{
-					set_core_config('user', 'newest_user_id', $data['user_id'], false);
-					set_core_config('user', 'newest_username', $data['username'], false);
-					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
-				}
+		$mailer = new core_mailer();
 
-				require_once($site_file_root.'includes/mailer.php');
+		$mailer->to($email, $username);
+		$mailer->subject('Welcome to ');
 
-				$mailer = new core_mailer();
+		$_CLASS['core_template']->assign_array(array(
+			'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
+			'WELCOME_MSG'   => sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
+			'USERNAME'		=> $username,
+			'PASSWORD'		=> $password,
+			'EMAIL_SIG'		=> '', //I like this
+			'U_ACTIVATE'	=> generate_link('system&mode=activate&user_id='.$data['user_id'].'&key='.$user_act_key, array('sid' => false, 'full' => true))
+		));
 
-				$mailer->to($email, $username);
-				$mailer->subject('Welcome to ');
+		if ($coppa)
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
+				'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
+				'EMAIL_ADDRESS' => $email,
+				'SITENAME'		=> $_CORE_CONFIG['global']['site_name']
+			));
+		}
 
-				$_CLASS['core_template']->assign_array(array(
-					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-					'WELCOME_MSG'   => sprintf($_CLASS['core_user']->lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
-					'USERNAME'		=> $username,
-					'PASSWORD'		=> $password,
-					'EMAIL_SIG'		=> '', //I like this
-					'U_ACTIVATE'	=> generate_link('system&mode=activate&user_id='.$data['user_id'].'&key='.$user_act_key, array('sid' => false, 'full' => true))
-				));
+		$mailer->message = trim($_CLASS['core_template']->display('email/core/'.$email_template, true));
 
-				if ($coppa)
-				{
-					$_CLASS['core_template']->assign_array(array(
-						'FAX_INFO'		=> $_CORE_CONFIG['user']['coppa_fax'],
-						'MAIL_INFO'		=> $_CORE_CONFIG['user']['coppa_mail'],
-						'EMAIL_ADDRESS' => $email,
-						'SITENAME'		=> $_CORE_CONFIG['global']['site_name']
-					));
-				}
+		$mailer->send();
 
-				$mailer->message = trim($_CLASS['core_template']->display('email/core/'.$email_template, true));
+		$message = $message . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="'. generate_link() .'">', '</a>');
+		trigger_error($message);
+	}
+}
 
-				$mailer->send();
+$hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
+$hidden_fields .= '<input type="hidden" name="agreed" value="true" />';
 
-				$message = $message . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="'. generate_link() .'">', '</a>');
-				trigger_error($message);
-			}
-		}
+if ($_CORE_CONFIG['user']['enable_confirm'])
+{
+	$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
+	$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
+}
+else
+{
+	$confirm_image = false;
+}
 
-		$s_hidden_fields .= '<input type="hidden" name="coppa" value="' . $coppa . '" />';
-		$s_hidden_fields .= '<input type="hidden" name="agreed" value="true" />';
-		
-		if ($_CORE_CONFIG['user']['enable_confirm'])
+if ($submit)
+{
+	if ($_CORE_CONFIG['user']['max_reg_attempts'])
+	{
+		$attempts = (int) $_CLASS['core_user']->session_data_get('reg_attempts', 0);
+
+		if ($attempts > $_CORE_CONFIG['user']['max_reg_attempts'])
 		{
-			$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
-			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
+			trigger_error('TOO_MANY_ATTEMPTS');
 		}
-		else
-		{
-			$confirm_image = false;
-		}
 
-		if ($submit)
-		{
-			if ($_CORE_CONFIG['user']['max_reg_attempts'])
-			{
-				$attempts = (int) $_CLASS['core_user']->session_data_get('reg_attempts', 0);
+		$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
+	}
+}
 
-				if ($attempts > $_CORE_CONFIG['user']['max_reg_attempts'])
-				{
-					trigger_error('TOO_MANY_ATTEMPTS');
-				}
+switch ($_CORE_CONFIG['user']['activation'])
+{
+	case USER_ACTIVATION_SELF:
+		$l_reg_cond = $_CLASS['core_user']->lang['UCP_EMAIL_ACTIVATE'];
+	break;
 
-				$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));
-			}
-		}
+	case USER_ACTIVATION_ADMIN:
+		$l_reg_cond = $_CLASS['core_user']->lang['UCP_ADMIN_ACTIVATE'];
+	break;
+	
+	default:
+		$l_reg_cond = '';
+	break;
+}
 
-		switch ($_CORE_CONFIG['user']['activation'])
-		{
-			case USER_ACTIVATION_SELF:
-				$l_reg_cond = $_CLASS['core_user']->lang['UCP_EMAIL_ACTIVATE'];
-			break;
+$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
 
-			case USER_ACTIVATION_ADMIN:
-				$l_reg_cond = $_CLASS['core_user']->lang['UCP_ADMIN_ACTIVATE'];
-			break;
-			
-			default:
-				$l_reg_cond = '';
-			break;
-		}
+$_CLASS['core_template']->assign_array(array(
+	'ERROR'			=> empty($error) ? false : implode('<br />', $error), 
+	'USERNAME'		=> isset($username) ? $username : '',
+	'PASSWORD'		=> isset($password) ? $password : '',
+	'EMAIL'			=> isset($email) ? $email : '',
+	'EMAIL_CONFIRM'	=> isset($email_confirm) ? $email_confirm : '',
+	'CONFIRM_IMG'	=> $confirm_image,
+	'SELECT_TZ'		=> select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
-		$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
+	'L_CONFIRM_EXPLAIN'			=> sprintf($_CLASS['core_user']->lang['CONFIRM_EXPLAIN'], '<a href="mailto:' . htmlentities('') . '">', '</a>'), 
+	'L_ITEMS_REQUIRED'			=> $l_reg_cond, 
+	'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
+	'L_NEW_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 
-		$_CLASS['core_template']->assign_array(array(
-			'ERROR'			=> empty($error) ? false : implode('<br />', $error), 
-			'USERNAME'		=> isset($username) ? $username : '',
-			'PASSWORD'		=> isset($password) ? $password : '',
-			'EMAIL'			=> isset($email) ? $email : '',
-			'EMAIL_CONFIRM'	=> isset($email_confirm) ? $email_confirm : '',
-			'CONFIRM_IMG'	=> $confirm_image,
-			'SELECT_TZ'		=> select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
-			'L_CONFIRM_EXPLAIN'			=> sprintf($_CLASS['core_user']->lang['CONFIRM_EXPLAIN'], '<a href="mailto:' . htmlentities($config['board_contact']) . '">', '</a>'), 
-			'L_ITEMS_REQUIRED'			=> $l_reg_cond, 
-			'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
-			'L_NEW_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+	'S_COPPA'			=> $coppa, 
+	'S_HIDDEN_FIELDS'	=> $hidden_fields,
+	'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;mode=register"))
+);
 
+$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/Control_Panel/ucp_register.html');
 
-			'S_COPPA'			=> $coppa, 
-			'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
-			'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;mode=register"))
-		);
-		
-		$this->display($_CLASS['core_user']->lang['REGISTER'], 'ucp_register.html');
-	}
-}
-
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_zebra.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_zebra.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_zebra.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -11,162 +11,168 @@
 // 
 // -------------------------------------------------------------
 
-class ucp_zebra extends module
+global $_CLASS;
+
+$_CLASS['core_template']->assign_array(array(
+	'ERROR'				=> false,
+	'USERNAMES'			=> false,
+	'S_USERNAME_OPTIONS'=> false
+));
+
+$hidden_fields = array();
+$this->mode = ($this->mode === 'foes') ? 'foes' : 'friends';
+
+if (!empty($_POST['submit']) || !empty($_GET['add']))
 {
-	function ucp_zebra($id, $mode)
+	if ($add_users = get_variable('add', 'REQUEST', false))
 	{
-		global $_CLASS;
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 		
-		$_CLASS['core_template']->assign_array(array(
-			'ERROR'				=> false,
-			'USERNAMES'			=> false,
-			'S_USERNAME_OPTIONS'=> false
-		));
-		
-		$s_hidden_fields = '';
+		$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
 
-		if (!empty($_POST['submit']) || !empty($_GET['add']))
+		$add_users = explode("\n", $add_users);
+
+		$sql = 'SELECT z.*, u.username 
+			FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
+			WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
+				AND u.user_id = z.zebra_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		$friends = $foes = array();
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$data['usernames'] = get_variable('usernames', 'POST', false, 'array');
-			$data['add'] = get_variable('add', 'POST', false);
-
-			if ($data['add'] && empty($error))
+			if ($row['friend'])
 			{
-				$data['add'] = explode("\n", $data['add']);
+				$friends[] = $row['username'];
+			}
+			else
+			{
+				$foes[] = $row['username'];
+			}
+		}
+		$_CLASS['core_db']->free_result($result);
 
-				$sql = 'SELECT z.*, u.username 
-					FROM ' . ZEBRA_TABLE . ' z, ' . USERS_TABLE . ' u 
-					WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
-						AND u.user_id = z.zebra_id";
-				$result = $_CLASS['core_db']->query($sql);
+		$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']->data['username']));
+		unset($friends, $foes);
 
-				$friends = $foes = array();
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		if (!empty($add_users))
+		{
+			$sql = 'SELECT user_id, user_type, user_status
+				FROM ' . CORE_USERS_TABLE . " 
+				WHERE username IN ('" .implode("', '", $_CLASS['core_db']->escape_array($add_users))."')";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$add_users = array();
+
+			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				do
 				{
-					if ($row['friend'])
+					if ($row['user_type'] == USER_NORMAL && $row['user_status'] == STATUS_ACTIVE)
 					{
-						$friends[] = $row['username'];
+						$add_users[] = $row['user_id'];
 					}
-					else
-					{
-						$foes[] = $row['username'];
-					}
 				}
-				$_CLASS['core_db']->free_result($result);
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
-				$data['add'] = array_diff($data['add'], $friends, $foes, array($_CLASS['core_user']->data['username']));
-				unset($friends, $foes);
-
-				$data['add'] = "'".implode("', '", $_CLASS['core_db']->escape_array($data['add']))."'";
-
-				if ($data['add'])
+				// Remove users from foe list if they are admins or moderators
+				if ($this->mode === 'foes')
 				{
-					$sql = 'SELECT user_id, user_type, user_status
-						FROM ' . USERS_TABLE . ' 
-						WHERE username IN (' . $data['add'] . ')';
-					$result = $_CLASS['core_db']->query($sql);
-
-					if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					$perms = array();
+					foreach ($_CLASS['forums_auth']->acl_get_list($add_users, array('a_', 'm_')) as $forum_id => $forum_ary)
 					{
-						$user_id_ary = array();
-						do
+						foreach ($forum_ary as $auth_option => $user_ary)
 						{
-							if ($row['user_type'] == USER_NORMAL && $row['user_status'] == STATUS_ACTIVE)
-							{
-								$user_id_ary[] = $row['user_id'];
-							}
+							$perms += $user_ary;
 						}
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+					}
 
-						// Remove users from foe list if they are admins or moderators
-						if ($mode == 'foes')
-						{
-							$perms = array();
-							foreach ($_CLASS['auth']->acl_get_list($user_id_ary, array('a_', 'm_')) as $forum_id => $forum_ary)
-							{
-								foreach ($forum_ary as $auth_option => $user_ary)
-								{
-									$perms += $user_ary;
-								}
-							}
+					// This may not be right ... it may yield true when perms equate to deny
+					$add_users = array_diff($add_users, $perms);
+					unset($perms);
+				}
 
-							// This may not be right ... it may yield true when perms equate to deny
-							$user_id_ary = array_diff($user_id_ary, $perms);
-							unset($perms);
-						}
+				if (!empty($add_users))
+				{
+					$sql_mode = ($this->mode === 'friends') ? 'friend' : 'foe';
 
-						if (!empty($user_id_ary))
-						{
-							$sql_mode = ($mode == 'friends') ? 'friend' : 'foe';
-
-							$sql = 'INSERT INTO ' . ZEBRA_TABLE . " (user_id, zebra_id, $sql_mode) 
-								VALUES " . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']->data['user_id'] . ", \\1, 1)",  $user_id_ary));
-							$_CLASS['core_db']->query($sql);
-						}
-						else
-						{
-							$error[] = 'NOT_ADDED_' . strtoupper($mode);
-						}
-						unset($user_id_ary);
-					}
-					else
-					{
-						$error[] = 'USER_NOT_FOUND';
-					}
-					
-					$_CLASS['core_db']->free_result($result);
+					$sql = 'INSERT INTO ' . ZEBRA_TABLE . " (user_id, zebra_id, $sql_mode) 
+						VALUES " . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']->data['user_id'] . ", \\1, 1)",  $user_id_ary));
+					$_CLASS['core_db']->query($sql);
 				}
+				else
+				{
+					$error[] = 'NOT_ADDED_' . strtoupper($this->mode);
+				}
+				unset($add_users);
 			}
-			elseif ($data['usernames'] && empty($error))
+			else
 			{
-				// Force integer values
-				$data['usernames'] = array_map('intval', $data['usernames']);
-
-				$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-						AND zebra_id IN (' . implode(', ', $data['usernames']) . ')';
-				$_CLASS['core_db']->query($sql);
+				$error[] = 'USER_NOT_FOUND';
 			}
 			
-			if (empty($error))
-			{
-				$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
-				$message = $_CLASS['core_user']->lang[strtoupper($mode) . '_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
-				trigger_error($message);
-			}
-			else
-			{
-				$_CLASS['core_template']->assign('ERROR', implode('<br />', preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error)));
-			}
+			$_CLASS['core_db']->free_result($result);
 		}
+	}
+	elseif ($remove_users = get_variable('usernames', 'POST', false, 'array:int'))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+				AND zebra_id IN (' . implode(', ', array_unique($remove_users)) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
 
-		$sql_and = ($mode == 'friends') ? 'z.friend = 1' : 'z.foe = 1';
-		$sql = 'SELECT z.*, u.username 
-			FROM ' . ZEBRA_TABLE . ' z, ' . USERS_TABLE . ' u 
-			WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
-				AND $sql_and 
-				AND u.user_id = z.zebra_id";
-		$result = $_CLASS['core_db']->query($sql);
+	if (empty($error))
+	{
+		$_CLASS['core_display']->meta_refresh(3, generate_link($this->link));
+		$message = $_CLASS['core_user']->lang[strtoupper($this->mode) . '_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link($this->link).'">', '</a>');
+		trigger_error($message);
+	}
+	else
+	{
+		$_CLASS['core_template']->assign('ERROR', implode('<br />', preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error)));
+	}
+}
 
-		$s_username_options = '';
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$s_username_options .= '<option value="' . $row['zebra_id'] . '">' . $row['username'] . '</option>';
-		}
-		$_CLASS['core_db']->free_result($result);
+$sql_and = ($this->mode === 'friends') ? 'z.friend = 1' : 'z.foe = 1';
 
-		$_CLASS['core_template']->assign_array(array( 
-			'L_TITLE'				=> $_CLASS['core_user']->lang['UCP_ZEBRA_' . strtoupper($mode)],
+$sql = 'SELECT z.*, u.username 
+	FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
+	WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
+		AND $sql_and 
+		AND u.user_id = z.zebra_id";
+$result = $_CLASS['core_db']->query($sql);
 
-			'U_SEARCH_USER'			=> generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 
+$username_options = '';
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$username_options .= '<option value="' . $row['zebra_id'] . '">' . $row['username'] . '</option>';
+}
+$_CLASS['core_db']->free_result($result);
 
-			'S_USERNAME_OPTIONS'	=> $s_username_options,
-			'S_HIDDEN_FIELDS'		=> $s_hidden_fields,
-			'S_UCP_ACTION'			=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"))
-		);
+$_CLASS['core_template']->assign_array(array( 
+	'L_TITLE'				=> $_CLASS['core_user']->lang['UCP_ZEBRA_' . strtoupper($this->mode)],
 
-		$this->display($_CLASS['core_user']->lang['UCP_ZEBRA'], 'ucp_zebra_' . $mode . '.html');
-	}
+	'U_SEARCH_USER'			=> generate_link('members_list&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 
+
+	'S_USERNAME_OPTIONS'	=> $username_options,
+	'S_HIDDEN_FIELDS'		=> generate_hidden_fields($hidden_fields),
+	'S_UCP_ACTION'			=> generate_link($this->link)
+));
+
+unset($username_options);
+
+/*
+$result = $_CLASS['core_db']->query('SHOW COLLATION');
+$result = $_CLASS['core_db']->query('SHOW CHARACTER SET');
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	print_r($row );echo '<br/>'; die;
 }
+*/
 
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('UCP_ZEBRA'), 'modules/control_panel/ucp_zebra_' . $this->mode . '.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/download.php
===================================================================
--- cms/trunk/modules/forums/download.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/forums/download.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -212,42 +212,41 @@
 		$browser_agent = 'other';
     }
 
-	// Correct the mime type - we force application/octetstream for all files, except images
-	// Please do not change this, it is a security precaution
+	/*
+		Correct the mime type - we force application/octetstream for all files, except images
+		Please do not change this, it is a security precaution
+	*/
+
 	if ($category == ATTACHMENT_CATEGORY_NONE && strpos($attachment['mimetype'], 'image') === false)
 	{
-		$attachment['mimetype'] = ($browser_agent == 'ie' || $browser_agent == 'opera') ? 'application/octetstream' : 'application/octet-stream';
+		$attachment['mimetype'] = ($browser_agent === 'ie' || $browser_agent === 'opera') ? 'application/octetstream' : 'application/octet-stream';
 	}
 
+	/* Clean all output buffers */
 	while (@ob_end_clean());
+	header('Content-Encoding: ');
 
-	// Now the tricky part... let's dance
+	/* Send out required headers */
 	header('Pragma: public');
-
-	// Send out the Headers
 	header('Content-Type: ' . $attachment['mimetype'] . '; name="' . $attachment['real_filename'] . '"');
 	header('Content-Disposition: inline; filename="' . $attachment['real_filename'] . '"');
 
-	// Now send the File Contents to the Browser
+	/* Now send the File Contents to the Browser */
 	$size = @filesize($filename);
+
 	if ($size)
 	{
-		header("Content-length: $size");
+		header('Content-Length: '.$size);
 	}
+
 	$result = @readfile($filename);
 
 	if (!$result)
 	{
 		trigger_error('Unable to deliver file.<br />Error was: ' . $php_errormsg, E_USER_WARNING);
 	}
-	if (!empty($_CLASS['core_cache']))
-	{
-		$_CLASS['core_cache']->unload();
-	}
-	
-	$_CLASS['core_db']->sql_close();
-	flush();
-	exit;
+
+	script_close(false);
 }
 
 function download_allowed()



From viperal at berlios.de  Fri Oct 28 05:46:06 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 28 Oct 2005 05:46:06 +0200
Subject: [Viperals-svncheckins] r169 - in cms/trunk: . admin admin/functions includes includes/display includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users install modules/forums themes_admin/viperal_admin themes_admin/viperal_admin/template
Message-ID: <200510280346.j9S3k6CP023682@sheep.berlios.de>

Author: viperal
Date: 2005-10-28 05:45:54 +0200 (Fri, 28 Oct 2005)
New Revision: 169

Modified:
   cms/trunk/admin/blocks.php
   cms/trunk/admin/functions/block_functions.php
   cms/trunk/admin/messages.php
   cms/trunk/admin/modules.php
   cms/trunk/admin/users.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/templates/admin/blocks/edit.html
   cms/trunk/includes/templates/admin/blocks/index.html
   cms/trunk/includes/templates/admin/index.html
   cms/trunk/includes/templates/admin/messages/edit.html
   cms/trunk/includes/templates/admin/messages/index.html
   cms/trunk/includes/templates/admin/modules/edit.html
   cms/trunk/includes/templates/admin/modules/index.html
   cms/trunk/includes/templates/admin/system/index.html
   cms/trunk/includes/templates/admin/users/add.html
   cms/trunk/includes/templates/admin/users/bots.html
   cms/trunk/includes/templates/admin/users/disabled.html
   cms/trunk/includes/templates/admin/users/index.html
   cms/trunk/includes/templates/admin/users/setting.html
   cms/trunk/includes/templates/admin/users/unactivated.html
   cms/trunk/index.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/modules/forums/index.php
   cms/trunk/modules/forums/main.php
   cms/trunk/themes_admin/viperal_admin/index.php
   cms/trunk/themes_admin/viperal_admin/template/header.html
Log:
Ok, some features are still broken.. But it installs again

Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/admin/blocks.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -26,7 +26,9 @@
 	die;
 }
 
-require($site_file_root.'admin/functions/block_functions.php');
+global $_CLASS;
+
+require_once SITE_FILE_ROOT.'admin/functions/block_functions.php';
 $_CLASS['core_user']->add_lang('admin/blocks.php');
 
 function check_position($position, $redirect = true)
@@ -39,7 +41,6 @@
 		if ($redirect)
 		{
 			redirect(generate_link('blocks', array('admin' => true)));
-			die;
 		}
 		return false;
 	}
@@ -97,7 +98,7 @@
 }
 
 $result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_starts, block_expires, block_file, block_auth
-	FROM ' . BLOCKS_TABLE . ' WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ')
+	FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ')
 	ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
@@ -121,7 +122,7 @@
 	switch ($block['block_type'])
 	{
 		case BLOCKTYPE_FILE:
-			if (!$block['block_file'] || !file_exists($site_file_root.'blocks/'.$block['block_file']))
+			if (!$block['block_file'] || !file_exists(SITE_FILE_ROOT.'blocks/'.$block['block_file']))
 			{
 				$error = 'File_MISSING';
 			}
@@ -175,7 +176,7 @@
 
 	check_position($position);
 
-	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM '.CORE_BLOCKS_TABLE.' WHERE block_id = '.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -186,14 +187,14 @@
 
 	check_position($block['block_position']);
 
-	$result = $_CLASS['core_db']->query('SELECT max(block_order) as max_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$position);
+	$result = $_CLASS['core_db']->query('SELECT max(block_order) as max_order FROM '.CORE_BLOCKS_TABLE.' WHERE block_position = '.$position);
 	list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 	$_CLASS['core_db']->free_result($result);
 
 	$new_order = (int) $max_order + 1;
 
-	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE." SET block_position = $position , block_order = $new_order where block_id = $id");
-	$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_order = block_order - 1 WHERE block_position = '.$block['block_position'].' AND block_order > '.$block['block_order']);
+	$_CLASS['core_db']->query('UPDATE '.CORE_BLOCKS_TABLE." SET block_position = $position , block_order = $new_order where block_id = $id");
+	$_CLASS['core_db']->query('UPDATE '.CORE_BLOCKS_TABLE.' SET block_order = block_order - 1 WHERE block_position = '.$block['block_position'].' AND block_order > '.$block['block_order']);
 
 	$_CLASS['core_cache']->destroy('blocks');
 }
@@ -204,7 +205,7 @@
 
 	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
@@ -368,7 +369,7 @@
 
 function block_position_select($default = false)
 {
-	global $site_file_root, $_CLASS;
+	global $_CLASS;
 	
 	$block_position_array = array(
 		BLOCK_RIGHT 	=> $_CLASS['core_user']->lang['B_RIGHT'],
@@ -403,7 +404,7 @@
 	
 	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT block_order, block_position, block_type FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
+		$result = $_CLASS['core_db']->query('SELECT block_order, block_position, block_type FROM '.CORE_BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
@@ -428,7 +429,7 @@
 			blocks_change_position($data['block_position'], $id);
 		}
 		
-		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
+		$sql = 'UPDATE '.CORE_BLOCKS_TABLE.' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
 	}
 	else
 	{
@@ -439,13 +440,13 @@
 			return block_add(false, $data, $error);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$data['block_position']);
+		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM '.CORE_BLOCKS_TABLE.' WHERE block_position = '.$data['block_position']);
 		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 		$_CLASS['core_db']->free_result($result);
 				
 		$data['block_order'] = (int) $max_order + 1;
 		
-		$sql = 'INSERT INTO '.BLOCKS_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
+		$sql = 'INSERT INTO '.CORE_BLOCKS_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
 	}
 
 	$_CLASS['core_db']->query($sql);
@@ -458,11 +459,11 @@
 
 function block_select($default = false)
 {
-	global $site_file_root, $_CLASS;
+	global $_CLASS;
 
 	$block_list_array = array();
 
-	$handle = opendir($site_file_root.'blocks');
+	$handle = opendir(SITE_FILE_ROOT.'blocks');
 
 	while ($file = readdir($handle))
 	{

Modified: cms/trunk/admin/functions/block_functions.php
===================================================================
--- cms/trunk/admin/functions/block_functions.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/admin/functions/block_functions.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -25,7 +25,7 @@
 {
 	global $_CLASS;
 
-	$result = $_CLASS['core_db']->query('SELECT block_position, block_auth FROM ' . BLOCKS_TABLE . ' WHERE block_id = '.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_auth FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_id = '.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 	
@@ -55,7 +55,7 @@
 			$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
 		}
 
-		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET block_auth = $auth WHERE block_id = $id");
+		$_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . " SET block_auth = $auth WHERE block_id = $id");
 		$_CLASS['core_cache']->destroy('blocks');
 	}
 	
@@ -66,7 +66,7 @@
 {
 	global $_CLASS;
 	
-	$result = $_CLASS['core_db']->query('SELECT block_status, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_status, block_position FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -78,7 +78,7 @@
 	check_position($block['block_position']);
 	$status = ($block['block_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 
-	$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_status = '.$status.' WHERE block_id = '.$id);
+	$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_status = '.$status.' WHERE block_id = '.$id);
 
 	$_CLASS['core_cache']->destroy('blocks');
 }
@@ -92,7 +92,7 @@
 		return;
 	}
 
-	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM ' . BLOCKS_TABLE . ' WHERE block_id= ' . $id);
+	$result = $_CLASS['core_db']->query('SELECT block_position, block_order FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_id= ' . $id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -108,14 +108,14 @@
 	{
 		case 'down':
 
-			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
 			list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 			$_CLASS['core_db']->free_result($result);
 
 			if ($block['block_order'] < $max_order)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position = '.$block['block_position'].' AND block_order='.($block['block_order'] + 1));
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.($block['block_order'] + 1).' WHERE block_id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position = '.$block['block_position'].' AND block_order='.($block['block_order'] + 1));
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = '.($block['block_order'] + 1).' WHERE block_id ='. $id);
 
 				$_CLASS['core_cache']->destroy('blocks');
 			}
@@ -123,14 +123,14 @@
 
 		case 'bottom':
 
-			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
 			list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 			$_CLASS['core_db']->free_result($result);
 
 			if ($block['block_order'] < $max_order)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.$max_order.' WHERE block_id = '.$id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = '.$max_order.' WHERE block_id = '.$id);
 
 				$_CLASS['core_cache']->destroy('blocks');
 			}
@@ -140,8 +140,8 @@
 
 			if ($block['block_order'] && $block['block_order'] != 1)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order = '.($block['block_order'] - 1));
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order='.($block['block_order'] -1 ).' WHERE block_id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order = '.($block['block_order'] - 1));
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order='.($block['block_order'] -1 ).' WHERE block_id ='. $id);
 
 				$_CLASS['core_cache']->destroy('blocks');
 			}
@@ -151,8 +151,8 @@
 
 			if ($block['block_order'] != 1)
 			{
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order < '.$block['block_order']);
-				$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = 1 WHERE block_id = '.$id);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order < '.$block['block_order']);
+				$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = 1 WHERE block_id = '.$id);
 
 				$_CLASS['core_cache']->destroy('blocks');
 			}
@@ -164,7 +164,7 @@
 {
 	global $_CLASS;
 
-	$result = $_CLASS['core_db']->query('SELECT block_order, block_type, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
+	$result = $_CLASS['core_db']->query('SELECT block_order, block_type, block_position FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -177,8 +177,8 @@
 
 	if (display_confirmation())
 	{
-		$_CLASS['core_db']->query('DELETE from ' . BLOCKS_TABLE . ' where block_id = '.$id);
-		$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
+		$_CLASS['core_db']->query('DELETE from ' . CORE_BLOCKS_TABLE . ' where block_id = '.$id);
+		$result = $_CLASS['core_db']->query('UPDATE ' . CORE_BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
 
 		$_CLASS['core_cache']->destroy('blocks');
         

Modified: cms/trunk/admin/messages.php
===================================================================
--- cms/trunk/admin/messages.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/admin/messages.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -26,7 +26,9 @@
 	die;
 }
 
-require($site_file_root.'admin/functions/block_functions.php');
+global $_CLASS;
+
+require_once SITE_FILE_ROOT.'admin/functions/block_functions.php';
 $_CLASS['core_user']->add_lang('admin/blocks.php');
 
 function check_position($position, $redirect = true)
@@ -84,8 +86,9 @@
 	}
 }
 
-$result = $_CLASS['core_db']->query('SELECT block_id, block_position, block_title, block_starts, block_expires, block_order, block_status FROM ' . BLOCKS_TABLE . '
-				WHERE block_position IN ('.BLOCK_MESSAGE_TOP.', '.BLOCK_MESSAGE_BOTTOM.') 
+
+$result = $_CLASS['core_db']->query('SELECT block_id, block_position, block_title, block_starts, block_expires, block_order, block_status FROM ' . CORE_BLOCKS_TABLE . '
+				WHERE block_position IN ('. BLOCK_MESSAGE_TOP .', '. BLOCK_MESSAGE_BOTTOM .') 
 					 ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_MESSAGE_TOP => 'top', BLOCK_MESSAGE_BOTTOM => 'bottom');
@@ -149,7 +152,7 @@
 
 	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_id = ' . $id);
+		$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_BLOCKS_TABLE.' WHERE block_id = ' . $id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
@@ -263,7 +266,7 @@
     
 	if ($id)
 	{
-		$result = $_CLASS['core_db']->query('SELECT block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id = '. $id);
+		$result = $_CLASS['core_db']->query('SELECT block_position FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_id = '. $id);
 		$block = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
@@ -281,7 +284,7 @@
 			return message_edit($id, $data, $error);
 		}
 	
-		$sql = 'UPDATE ' . BLOCKS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
+		$sql = 'UPDATE ' . CORE_BLOCKS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
 
 		$_CLASS['core_db']->query($sql);
 	}
@@ -294,13 +297,13 @@
 			return message_edit(false, $data, $error);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position = '.$data['block_position']);
+		$result = $_CLASS['core_db']->query('SELECT MAX(block_order) as block_order FROM ' . CORE_BLOCKS_TABLE . ' WHERE block_position = '.$data['block_position']);
 		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
 		$_CLASS['core_db']->free_result($result);
 
 		$data['block_order'] = (int) $max_order + 1;
 
-		$_CLASS['core_db']->query('INSERT INTO ' . BLOCKS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
+		$_CLASS['core_db']->query('INSERT INTO ' . CORE_BLOCKS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
 	}
 
 	$_CLASS['core_cache']->destroy('blocks');
@@ -311,7 +314,7 @@
 
 function message_position_select($default = false)
 {
-	global $site_file_root, $_CLASS;
+	global $_CLASS;
 
 	$block_position_array = array(
 		BLOCK_MESSAGE_TOP		=> 'Top',
@@ -340,7 +343,7 @@
 
 function message_type_select($default = false)
 {
-	global $site_file_root, $_CLASS;
+	global $_CLASS;
 
 	$block_position_array = array(
 		BLOCKTYPE_MESSAGE			=> 'Normal Message',

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/admin/modules.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -26,13 +26,15 @@
 	die;
 }
 
+global $_CLASS;
+
 $_CLASS['core_user']->add_lang('admin/blocks.php');
 
 $mode = get_variable('mode', 'GET', false);
 
 function check_type($type, $redirect = true)
 {
-	$appoved_type = array(MODULE_NORMAL);
+	$appoved_type = array(1);
 	$type = (int) $type;
 	
 	if (!in_array($type, $appoved_type, true))
@@ -49,18 +51,18 @@
 		
 if (isset($_REQUEST['mode']))
 {
-	if ($id = get_variable('id', 'GET', false, 'integer'))
+	if ($id = get_variable('id', 'GET', false, 'int'))
 	{
 		switch ($_REQUEST['mode'])
 		{
 			case 'search':
-				$result = $_CLASS['core_db']->query('SELECT module_name, module_type FROM '. CORE_MODULES_TABLE);
+				$result = $_CLASS['core_db']->query('SELECT page_name, page_type FROM '. CORE_PAGES_TABLE);
 
 				$modules = array();
 
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$modules[$row['module_name']] = $row;
+					$modules[$row['page_name']] = $row;
 				}
 				$_CLASS['core_db']->free_result($result);
 
@@ -70,7 +72,7 @@
 				{
 					if (mb_strpos($file, '.') === false && empty($modules[$file]) && file_exists(SITE_FILE_ROOT."modules/$file/index.php"))
 					{
-						//$_CLASS['core_db']->query('INSERT INTO '. CORE_MODULES_TABLE . " (module_name, module_type, module_status, module_sides) VALUES ($file, 1, 1, 1)");
+						//$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE . " (page_name, page_type, page_status, page_sides) VALUES ($file, 1, 1, 1)");
 						echo $file;
 					}
 				}
@@ -78,32 +80,32 @@
 			break;
 
 			case 'change':
-				$result = $_CLASS['core_db']->query('SELECT module_name, module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_name, page_status, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
 				if (!$module)
 				{
-					trigger_error('MODULE_NOT_FOUND');
+					trigger_error('page_NOT_FOUND');
 				}
 			
-				check_type($module['module_type']);
+				check_type($module['page_type']);
 			
-				$status = ($module['module_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+				$status = ($module['page_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 				
-				if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
+				if (file_exists(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php'))
 				{
-					require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
+					require_once(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php');
 					
-					$name = $module['module_name'].'_configurator';
+					$name = $module['page_name'].'_configurator';
 
 					if (class_exists($name))
 					{
-						$module_configurer = new $name;
+						$page_configurer = new $name;
 
-						if (method_exists($module_configurer, 'status_change'))
+						if (method_exists($page_configurer, 'status_change'))
 						{
-							$report = $module_configurer->status_change($status, $module['module_status']);
+							$report = $page_configurer->status_change($status, $module['page_status']);
 		
 							if ($report !== true)
 							{
@@ -113,38 +115,38 @@
 					}
 				}
 
-				$result = $_CLASS['core_db']->query('UPDATE '. CORE_MODULES_TABLE . " SET module_status = $status WHERE module_id = $id");
+				$result = $_CLASS['core_db']->query('UPDATE '. CORE_PAGES_TABLE . " SET page_status = $status WHERE page_id = $id");
 			break;
 
 			case 'install':
-				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
-				if (!$module || $module['module_status'] != STATUS_PENDING)
+				if (!$module || $module['page_status'] != STATUS_PENDING)
 				{
-					trigger_error($module ? 'MODULE_ALREADY_INSTALLED' : 'MODULE_NOT_FOUND');
+					trigger_error($module ? 'page_ALREADY_INSTALLED' : 'page_NOT_FOUND');
 				}
 
-				check_type($module['module_type']);
+				check_type($module['page_type']);
 
 				if (display_confirmation())
 				{
 					$status = true;
 
-					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
+					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php'))
 					{
-						require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
+						require_once(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php');
 						
-						$name = $module['module_name'].'_configurator';
+						$name = $module['page_name'].'_configurator';
 
 						if (class_exists($name))
 						{
-							$module_configurer = new $name;
+							$page_configurer = new $name;
 	
-							if (method_exists($module_configurer, 'install'))
+							if (method_exists($page_configurer, 'install'))
 							{
-								$status = $module_configurer->install();
+								$status = $page_configurer->install();
 			
 								if ($status !== true)
 								{
@@ -154,37 +156,37 @@
 						}
 					}
 
-					$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE.' set module_status = '.STATUS_DISABLED.' WHERE module_id = '.$id);
+					$_CLASS['core_db']->query('UPDATE '.CORE_PAGES_TABLE.' set page_status = '.STATUS_DISABLED.' WHERE page_id = '.$id);
 				}
 			break;
 
 			case 'uninstall':
-				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
-				if (!$module || $module['module_status'] == STATUS_PENDING)
+				if (!$module || $module['page_status'] == STATUS_PENDING)
 				{
-					trigger_error($module ? 'MODULE_NOT_UNINSTALLABLE' : 'MODULE_NOT_FOUND');
+					trigger_error($module ? 'page_NOT_UNINSTALLABLE' : 'page_NOT_FOUND');
 				}
 			
-				check_type($module['module_type']);
+				check_type($module['page_type']);
 				
 				if (display_confirmation())
 				{
-					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php'))
+					if (file_exists(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php'))
 					{
-						require_once(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/configurator.php');
+						require_once(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php');
 						
-						$name = $module['module_name'].'_configurator';
+						$name = $module['page_name'].'_configurator';
 
 						if (class_exists($name))
 						{
-							$module_configurer = new $name;
+							$page_configurer = new $name;
 	
-							if (method_exists($module_configurer, 'uninstall'))
+							if (method_exists($page_configurer, 'uninstall'))
 							{
-								$status = $module_configurer->uninstall();
+								$status = $page_configurer->uninstall();
 			
 								if ($status !== true)
 								{
@@ -194,60 +196,60 @@
 						}
 					}
 
-					$_CLASS['core_db']->query('UPDATE ' . CORE_MODULES_TABLE . ' set module_status = ' . STATUS_PENDING . ' WHERE module_id = '.$id);
+					$_CLASS['core_db']->query('UPDATE ' . CORE_PAGES_TABLE . ' set page_status = ' . STATUS_PENDING . ' WHERE page_id = '.$id);
 				}
 			break;
 
 			case 'remove':
-				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
-				if (!$module || $module['module_status'] != STATUS_PENDING)
+				if (!$module || $module['page_status'] != STATUS_PENDING)
 				{
-					trigger_error($module ? 'MODULE_NOT_REMOVABLE' : 'MODULE_NOT_FOUND');
+					trigger_error($module ? 'page_NOT_REMOVABLE' : 'page_NOT_FOUND');
 				}
 
-				check_type($module['module_type']);
+				check_type($module['page_type']);
 
 				if (display_confirmation())
 				{
-					$_CLASS['core_db']->query('DELETE from ' . CORE_MODULES_TABLE . ' WHERE module_id = '.$id);
+					$_CLASS['core_db']->query('DELETE from ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
 				}
 			break;
 
 			case 'auth':
-				$result = $_CLASS['core_db']->query('SELECT module_type, module_auth FROM ' . CORE_MODULES_TABLE . ' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_type, page_auth FROM ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 		
 				if (!$module)
 				{
-					trigger_error('MODULE_NOT_FOUND');
+					trigger_error('page_NOT_FOUND');
 				}
 		
-				$module['module_auth'] = ($module['module_auth']) ? unserialize($module['module_auth']) : '';
+				$module['page_auth'] = ($module['page_auth']) ? unserialize($module['page_auth']) : '';
 		
-				check_type($module['module_type']);
+				check_type($module['page_type']);
 		
 				$_CLASS['core_display']->display_header();
 		
-				$auth = $_CLASS['core_auth']->generate_auth_options($module['module_auth']);
+				$auth = $_CLASS['core_auth']->generate_auth_options($module['page_auth']);
 		
 				if ($auth !== false)
 				{
 					if (is_null($auth))
 					{
-						$module['module_auth'] = '';
+						$module['page_auth'] = '';
 						$auth = 'null';
 					}
 					else
 					{
-						$module['module_auth'] = $auth;
+						$module['page_auth'] = $auth;
 						$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
 					}
 		
-					$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE." set module_status = $auth WHERE module_id = $id");
+					$_CLASS['core_db']->query('UPDATE '.CORE_PAGES_TABLE." set page_status = $auth WHERE page_id = $id");
 					$_CLASS['core_cache']->destroy('blocks');
 				}
 
@@ -258,22 +260,22 @@
 }
 
 
-$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' ORDER BY module_name');
+$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_PAGES_TABLE.' ORDER BY page_name');
 
 $modules = array();
 
 while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	$modules[$row['module_type']][] = $row;
+	$modules[$row['page_type']][] = $row;
 }
 $_CLASS['core_db']->free_result($result);
 
 $admin_auth = false;
 $_CLASS['core_template']->assign('S_LINK_ADMIN_AUTH', $admin_auth);
 
-$module_type = array(MODULE_SYSTEM => 'system', MODULE_NORMAL => 'normal');
+$page_type = array(0 => 'system', 1 => 'normal');
 
-foreach ($module_type as $type => $name)
+foreach ($page_type as $type => $name)
 {
 	if (empty($modules[$type]))
 	{
@@ -282,18 +284,18 @@
 
 	foreach ($modules[$type] as $module)
 	{
-		$active = $module['module_status'] == STATUS_ACTIVE;
+		$active = $module['page_status'] == STATUS_ACTIVE;
 
-		if ($module['module_status'] == STATUS_PENDING)
+		if ($module['page_status'] == STATUS_PENDING)
 		{
 			$installed = false;
-			$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['module_id'], array('admin' => true));
-			$remove_link = generate_link('modules&amp;mode=remove&amp;id='.$module['module_id'], array('admin' => true));
+			$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['page_id'], array('admin' => true));
+			$remove_link = generate_link('modules&amp;mode=remove&amp;id='.$module['page_id'], array('admin' => true));
 		}
 		else
 		{
 			$installed = true;
-			$installer_link = ($module['module_type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['module_id'], array('admin' => true)) : '';
+			$installer_link = ($module['page_type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['page_id'], array('admin' => true)) : '';
 			$remove_link = '';
 		}
 
@@ -302,12 +304,12 @@
 				'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 				'ERROR'			=> '',
 				'INSTALLED'		=> $installed,
-				'TITLE'			=> ($module['module_title']) ? $module['module_title'] : $module['module_name'],
+				'TITLE'			=> ($module['page_title']) ? $module['page_title'] : $module['page_name'],
 
-				'LINK_ACTIVE'		=> generate_link('modules&amp;mode=change&amp;id='.$module['module_id'], array('admin' => true)),
-				'LINK_EDIT'			=> generate_link('modules&amp;mode=edit&amp;id='.$module['module_id'], array('admin' => true)),
-				'LINK_AUTH'			=> generate_link('modules&amp;mode=auth&amp;id='.$module['module_id'], array('admin' => true)),
-				'LINK_ADMIN_AUTH'	=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['module_id'], array('admin' => true)) : '' ,
+				'LINK_ACTIVE'		=> generate_link('modules&amp;mode=change&amp;id='.$module['page_id'], array('admin' => true)),
+				'LINK_EDIT'			=> generate_link('modules&amp;mode=edit&amp;id='.$module['page_id'], array('admin' => true)),
+				'LINK_AUTH'			=> generate_link('modules&amp;mode=auth&amp;id='.$module['page_id'], array('admin' => true)),
+				'LINK_ADMIN_AUTH'	=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['page_id'], array('admin' => true)) : '' ,
 				'LINK_INSTALLER'	=> $installer_link,
 				'LINK_REMOVE'		=> $remove_link,
 		));

Modified: cms/trunk/admin/users.php
===================================================================
--- cms/trunk/admin/users.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/admin/users.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -26,12 +26,14 @@
 	die;
 }
 
-// Just testing the layout, i know they not acurrate
-$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_BOT);
+global $_CLASS;
+
+/*  Just testing the layout, i know they not acurrate */
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . CORE_USERS_TABLE . ' WHERE user_type = ' . USER_BOT);
 list($count_bots) = $_CLASS['core_db']->fetch_row_num($result);
 $_CLASS['core_db']->free_result($result);
 
-$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_NORMAL);
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM ' . CORE_USERS_TABLE . ' WHERE user_type = ' . USER_NORMAL);
 list($count_users) = $_CLASS['core_db']->fetch_row_num($result);
 $_CLASS['core_db']->free_result($result);
 
@@ -56,6 +58,8 @@
 	switch ($_REQUEST['mode'])
 	{
 		case 'setting':
+			global $_CORE_CONFIG;
+
 			if (isset($_POST['submit']))
 			{
 				$activation_array = array(USER_ACTIVATION_NONE, USER_ACTIVATION_SELF, USER_ACTIVATION_ADMIN, USER_ACTIVATION_DISABLE);
@@ -72,13 +76,23 @@
 		 		$data['max_pass_chars']	= get_variable('max_pass_chars', 'POST', 0, 'int');
 		 		$data['max_reg_attempts'] = get_variable('coppa_fax', 'POST', 0, 'int');
 
+				$remove_config = false;
+
 				foreach ($data as $name => $setting)
 				{
-					if ($setting != $_CORE_CONFIG['user'][$name])
+					if ($setting !== $_CORE_CONFIG['user'][$name])
 					{
+						$remove_config = true;
+
 						set_core_config('user', $name, $setting, false);
 					}
 				}
+
+				if ($remove_config)
+				{
+					$_CLASS['core_cache']->destroy('core_config');
+				}
+				unset($remove_config, $data);
 			}
 
 			$_CLASS['core_template']->assign_array(array(
@@ -126,10 +140,13 @@
 		break;
 
 		case 'add_user':
+			global $_CORE_CONFIG;
+
 			if (isset($_POST['submit']))
 			{
-				require_once($site_file_root.'includes/functions_user.php');
-	
+				require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+
 				$error = array();
 	
 				$username	= get_variable('username', 'POST');
@@ -163,7 +180,7 @@
 				{
 					$error[] = $_CLASS['core_user']->get_lang('EMAIL_ERROR');
 				}
-				elseif (!check_email($email)) // we can maybe remove this check
+				elseif (!check_email($email)) /* we can maybe remove this check */
 				{
 					$error[] = $_CLASS['core_user']->get_lang('EMAIL_INVALID');
 				}
@@ -179,7 +196,7 @@
 		
 					if (!$password)
 					{
-						//do some admin contact thing here
+						/* do some admin contact thing here */
 						die('Try again later');
 					}
 
@@ -228,10 +245,10 @@
 		case 'bots':
 			if ($id && isset($_REQUEST['option']))
 			{
-				require_once($site_file_root.'includes/functions_user.php');
+				require_once SITE_FILE_ROOT.'includes/functions_user.php';
 			
 				$sql = 'SELECT user_id, user_type, user_status
-					FROM ' . USERS_TABLE . ' 
+					FROM ' . CORE_USERS_TABLE . ' 
 					WHERE user_id = '.$id;
 				
 				$result = $_CLASS['core_db']->query($sql);
@@ -271,7 +288,7 @@
 			}
 
 			$sql = 'SELECT user_id, username, user_status, user_last_visit 
-				FROM ' . USERS_TABLE . '
+				FROM ' . CORE_USERS_TABLE . '
 				WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -296,10 +313,10 @@
 		case 'unactivated':
 			if ($id && isset($_REQUEST['option']))
 			{
-				require_once($site_file_root.'includes/functions_user.php');
+				require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
 				$sql = 'SELECT user_id, user_type, user_status
-					FROM ' . USERS_TABLE . ' 
+					FROM ' . CORE_USERS_TABLE . ' 
 					WHERE user_id = '.$id;
 
 				$result = $_CLASS['core_db']->query($sql);
@@ -324,7 +341,7 @@
 						if (display_confirmation())
 						{
 							$sql = 'SELECT user_id, user_type
-								FROM ' . USERS_TABLE . ' 
+								FROM ' . CORE_USERS_TABLE . ' 
 								WHERE user_id = '.$id;
 				
 							$result = $_CLASS['core_db']->query($sql);
@@ -360,7 +377,7 @@
 			$start = get_variable('start', 'GET', false, 'integer');
 
 			$sql = 'SELECT user_id, username, user_reg_date
-				FROM ' . USERS_TABLE . '
+				FROM ' . CORE_USERS_TABLE . '
 					WHERE user_type = '.USER_NORMAL.'
 					AND user_status = '.$status;
 
@@ -381,7 +398,7 @@
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			$sql = 'SELECT count(*) as count FROM ' . USERS_TABLE . '
+			$sql = 'SELECT count(*) as count FROM ' . CORE_USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;
 
@@ -404,7 +421,7 @@
 {
 	$limit = ($last_count) ? 10 : 20 - $last_count;
 
-	$sql = 'SELECT COUNT(*)	FROM ' . USERS_TABLE . '
+	$sql = 'SELECT COUNT(*)	FROM ' . CORE_USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;
 	$result = $_CLASS['core_db']->query($sql);
@@ -429,7 +446,7 @@
 	));
 
 	$sql = 'SELECT user_id, username, user_reg_date
-		FROM ' . USERS_TABLE . '
+		FROM ' . CORE_USERS_TABLE . '
 			WHERE user_type = '.USER_NORMAL.'
 			AND user_status = '.$status;
 

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/display/blocks.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -43,7 +43,7 @@
 		static $side_check = array();
 
 		settype($side, 'int');
-		$true_side = $side >> 1;
+		$true_side = $side;
 
 		if (isset($side_check[$true_side]))
 		{
@@ -57,11 +57,11 @@
 			$side = ($side === BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
 
-		if ($_CLASS['core_display']->page['page_blocks'] & $side)
+		if ($_CLASS['core_display']->page['page_blocks'] & (1 << $side))
 		{
 			$this->load_blocks();
 
-			if (!empty($this->blocks_array[$side >> 1]))
+			if (!empty($this->blocks_array[$side]))
 			{
 				return $side_check[$true_side] = $side;
 			}
@@ -134,8 +134,6 @@
 			return false;
 		}
 
-		$position = ($position >> 1);
-
 		$this->load_blocks();
 
 		if (empty($this->blocks_array[$position]))

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/functions.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -34,7 +34,7 @@
 
 	if (!empty($censors))
 	{
-		return preg_replace($censors['match'], $censors['replace'], $text);
+		return preg_replace($censors['word_match'], $censors['word_replace'], $text);
 	}
 
 	return $text;
@@ -305,7 +305,7 @@
 		$bots = array();
 
 		$sql = 'SELECT user_id, username, user_agent, user_ip
-			FROM ' . USERS_TABLE . ' WHERE user_type = ' . USER_BOT;
+			FROM ' . CORE_USERS_TABLE . ' WHERE user_type = ' . USER_BOT;
 		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -327,15 +327,15 @@
 	if (is_null($censors = $_CLASS['core_cache']->get('word_censors')))
 	{
 		$sql = 'SELECT word, replacement
-			FROM  ' . CORE_CENSOR_TABLE .'ORDER BY LENGTH(word) DESC';
+			FROM  ' . CORE_CENSOR_TABLE .' ORDER BY LENGTH(word) DESC';
 		$result = $_CLASS['core_db']->query($sql);
 
 		$censors = array();
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$censors['match'][] = '#\b(' . str_replace('\*', '\w*?', preg_quote($row['word'], '#')) . ')\b#i';
-			$censors['replace'][] = $row['replacement'];
+			$censors['word_match'][] = '#\b(' . str_replace('\*', '\w*?', preg_quote($row['word_match'], '#')) . ')\b#i';
+			$censors['word_replace'][] = $row['word_replacement'];
 		}
 
 		$_CLASS['core_db']->free_result($result);
@@ -643,8 +643,9 @@
 			require_once $file;
 		}
 
-		//$_CLASS[$name] =& new $class;
-		$_CLASS[$name] = new $class;
+/* I think reference is required below PHP 4.4 */
+		$_CLASS[$name] =& new $class;
+		//$_CLASS[$name] = new $class;
 	}
 }
 

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/tables.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -61,12 +61,12 @@
 define('ADMIN_IS_ADMIN', 2);
 
 // Block side
-define('BLOCK_LEFT', (1 << 1));
-define('BLOCK_RIGHT', (1 << 2));
-define('BLOCK_TOP', (1 << 3));
-define('BLOCK_BOTTOM', (1 << 4));
-define('BLOCK_MESSAGE_TOP', (1 << 5));
-define('BLOCK_MESSAGE_BOTTOM', (1 << 6));
+define('BLOCK_LEFT', 1);
+define('BLOCK_RIGHT', 2);
+define('BLOCK_TOP', 3);
+define('BLOCK_BOTTOM', 4);
+define('BLOCK_MESSAGE_TOP', 5);
+define('BLOCK_MESSAGE_BOTTOM', 6);
 
 define('BLOCKTYPE_FILE',0);
 define('BLOCKTYPE_FEED',1);
@@ -190,18 +190,18 @@
 define('FORUMS_TOPICS_TABLE', $table_prefix.'forums_topics');
 define('FORUMS_POLL_OPTIONS_TABLE', $table_prefix.'forums_poll_results');
 define('FORUMS_POLL_VOTES_TABLE', $table_prefix.'forums_poll_voters');
-define('FORUMS_WORDS_TABLE', $table_prefix.'forums_words');
 define('FORUMS_WATCH_TABLE', $table_prefix.'forums_watch');
 define('FORUMS_TRACK_TABLE', $table_prefix.'forums_tracking');
 define('FORUMS_RANKS_TABLE', $table_prefix.'forums_ranks');
 define('FORUMS_EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
 define('FORUMS_EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
-define('CORE_ADMIN_AUTH_TABLE', $table_prefix.'admins');
+define('CORE_ADMIN_AUTH_TABLE', $table_prefix.'admin_access');
 define('CORE_ADMIN_MODULES_TABLE', $table_prefix.'admin_modules');
 
 define('CORE_BLOCKS_TABLE', $table_prefix.'blocks');
 
+define('CORE_CENSOR_TABLE', $table_prefix.'censor');
 define('CORE_CONFIG_TABLE', $table_prefix.'config');
 define('CORE_CONTROL_PANEL_MODULES_TABLE', $table_prefix . 'control_panel_modules');
 

Modified: cms/trunk/includes/templates/admin/blocks/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/blocks/edit.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/blocks/edit.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -5,7 +5,7 @@
 <script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
 <script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <form action="{ $B_ACTION }" method="post">
 	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
@@ -99,6 +99,6 @@
   );
 </script>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/blocks/index.html
===================================================================
--- cms/trunk/includes/templates/admin/blocks/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/blocks/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table border="0" class="tablebg" cellpadding="4" cellspacing="1" width="100%">
 	<tbody>
@@ -214,6 +214,7 @@
 		</tr>
 	</tbody>
 </table>
-{ $A_TABLE_CLOSE }
 
+{ $THEME_TABLE_CLOSE }
+
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/index.html
===================================================================
--- cms/trunk/includes/templates/admin/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table border="0" cellpadding="4" cellspacing="1" width="100%">
 	<tbody>
@@ -230,6 +230,6 @@
     </tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/messages/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/messages/edit.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/messages/edit.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -5,7 +5,7 @@
 <script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
 <script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <form action="{ $B_ACTION }" name="message" method="post">
 	<table class="tablebg" align="center" cellpadding="4" cellspacing="1" width="100%">
@@ -70,7 +70,7 @@
 	</table>
 </form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <script type="text/javascript">
 

Modified: cms/trunk/includes/templates/admin/messages/index.html
===================================================================
--- cms/trunk/includes/templates/admin/messages/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/messages/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
@@ -105,6 +105,6 @@
   </tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/modules/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/edit.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/modules/edit.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,8 +1,10 @@
 <style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
 <script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
 <script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
-<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
-{ $A_TABLE_OPEN }
+<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
+
+{ $THEME_TABLE_OPEN }
+
 <form action="{ $B_ACTION }" method="post">
 	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
 		<tbody>
@@ -96,5 +98,6 @@
     }
   );
 </script>
-{/literal}
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{/literal}
+
+{ $THEME_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/modules/index.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/modules/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table class="tablebg" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
@@ -93,6 +93,6 @@
 	</tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/system/index.html
===================================================================
--- cms/trunk/includes/templates/admin/system/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/system/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -5,10 +5,8 @@
 <script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
 <script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
-
-
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
 	<tbody>
 		<tr>
@@ -202,6 +200,6 @@
 	</table>
 </form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/add.html
===================================================================
--- cms/trunk/includes/templates/admin/users/add.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/add.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,10 +1,13 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 <form method="post" action="{ $S_ACTION }">
 	<table class="tablebg" cellspacing="1" cellpadding="4" width="100%">
+		<tr>
+			<th colspan="6" align="center"></th>
+		</tr>
 		<!-- IF { $ERROR } -->
 		<tr>
 			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</td>
@@ -40,6 +43,6 @@
 	</table>
 </form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/bots.html
===================================================================
--- cms/trunk/includes/templates/admin/users/bots.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/bots.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 
@@ -9,7 +9,6 @@
 		<th nowrap="nowrap">Bot name</th>
 		<th nowrap="nowrap">Last visit</th>
 		<th colspan="3" nowrap="nowrap">Options</th>
-
 	</tr>
 	<!-- LOOP $admin_bots -->
 	<tr>
@@ -28,6 +27,6 @@
 	<!-- ENDLOOP $admin_bots -->
 </table>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/disabled.html
===================================================================
--- cms/trunk/includes/templates/admin/users/disabled.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/disabled.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 
@@ -64,6 +64,7 @@
 		<!-- ENDIF -->
     </tbody>
 </table>
-{ $A_TABLE_CLOSE }
 
+{ $THEME_TABLE_CLOSE }
+
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/index.html
===================================================================
--- cms/trunk/includes/templates/admin/users/index.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/index.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 
@@ -105,6 +105,6 @@
 		</tr>
     </tbody>
 </table>
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/setting.html
===================================================================
--- cms/trunk/includes/templates/admin/users/setting.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/setting.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 <form method="post" action="{ $S_ACTION }">
@@ -79,6 +79,6 @@
 	</table>
 </form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/users/unactivated.html
===================================================================
--- cms/trunk/includes/templates/admin/users/unactivated.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/includes/templates/admin/users/unactivated.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <!-- INCLUDE admin/users/header.html -->
 
@@ -64,6 +64,7 @@
 		<!-- ENDIF -->
     </tbody>
 </table>
-{ $A_TABLE_CLOSE }
 
+{ $THEME_TABLE_CLOSE }
+
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/index.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -54,12 +54,12 @@
 	{
 		/*
 		$blocks = 0;
-		$blocks |= BLOCK_LEFT;
-		$blocks |= BLOCK_RIGHT;
-		$blocks |= BLOCK_TOP;
-		$blocks |= BLOCK_BOTTOM;
-		$blocks |= BLOCK_MESSAGE_TOP;
-		$blocks |= BLOCK_MESSAGE_BOTTOM;
+		$blocks |= (1 << BLOCK_LEFT);
+		$blocks |= (1 << BLOCK_RIGHT);
+		$blocks |= (1 << BLOCK_TOP);
+		$blocks |= (1 << BLOCK_BOTTOM);
+		$blocks |= (1 << BLOCK_MESSAGE_TOP);
+		$blocks |= (1 << BLOCK_MESSAGE_BOTTOM);
 		echo $blocks;
 		*/
 

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/install/build_data.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -23,7 +23,7 @@
 
 $time = gmtime();
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_access (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_upload', 'images/avatars/upload', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_gallery', 'images/avatars/gallery', 'string', 1)");
@@ -111,11 +111,11 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 2, 1, 'block-Control_Panel.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 2, 2, 'block-Modules.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 2, 3, 'block-User.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 3, 1, 'http://www.php.net/news.rss', 7200)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 3, 2, 'block-theme_select.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 1, 1, 'block-Control_Panel.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 1, 2, 'block-Modules.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 1, 3, 'block-User.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 2, 1, 'http://www.php.net/news.rss', 7200)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 2, 2, 'block-theme_select.php')");
 
 $content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
@@ -123,7 +123,8 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('blocks', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('system', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('messages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('messages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('modules', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('pages', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('smiles', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('users', 2, 0)");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/install/build_tables.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -836,11 +836,11 @@
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_words');
+$_CLASS['core_db']->table_create('start', $table_prefix.'censor');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 16000000, 'auto_increment' => true));
-$_CLASS['core_db']->add_table_field_char('word', 100);
-$_CLASS['core_db']->add_table_field_char('replacement', 100);
+$_CLASS['core_db']->add_table_field_char('word_match', 100);
+$_CLASS['core_db']->add_table_field_char('word_replacement', 100);
 
 $_CLASS['core_db']->add_table_index('word_id', 'primary');
 

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/installer.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -194,7 +194,7 @@
 			'user_email'			=> $email
 		);
 
-		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
+		$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
 
 		$_CLASS['core_template']->assign_array(array(
 			'admin_link'		=> generate_link(false, array('full' => true, 'sid' => false, 'admin' => true)),

Modified: cms/trunk/modules/forums/index.php
===================================================================
--- cms/trunk/modules/forums/index.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/modules/forums/index.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -34,14 +34,14 @@
 
 unset($approved_files);
 
-require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+require_once SITE_FILE_ROOT.'includes/forums/functions.php';
 load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
 $_CLASS['auth'] =& $_CLASS['forums_auth'];
 
-$_CLASS['auth']->acl($_CLASS['core_user']->data);
+$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
 
 $_CLASS['core_user']->user_setup();
-include(dirname(__FILE__)."/$file.php");
+include dirname(__FILE__)."/$file.php";
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/main.php
===================================================================
--- cms/trunk/modules/forums/main.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/modules/forums/main.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -37,12 +37,10 @@
     die;
 }
 
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
-
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_img();
 
-require(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 display_forums('', $config['load_moderators']);
 
 // Grab group details for legend display
@@ -89,7 +87,7 @@
 	unset($now);
 }
 
-$l_total_user_s = ($config['num_users'] == 0) ? 'TOTAL_USERS_ZERO' : 'TOTAL_USERS_OTHER';
+$l_total_user_s = ($_CORE_CONFIG['user']['total_users'] === 0) ? 'TOTAL_USERS_ZERO' : 'TOTAL_USERS_OTHER';
 $l_total_post_s = ($config['num_posts'] == 0) ? 'TOTAL_POSTS_ZERO' : 'TOTAL_POSTS_OTHER';
 $l_total_topic_s = ($config['num_topics'] == 0) ? 'TOTAL_TOPICS_ZERO' : 'TOTAL_TOPICS_OTHER';
 
@@ -97,7 +95,7 @@
 $_CLASS['core_template']->assign_array(array(
 	'TOTAL_POSTS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_post_s), $config['num_posts']),
 	'TOTAL_TOPICS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_topic_s), $config['num_topics']),
-	'TOTAL_USERS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_user_s), $config['num_users']),
+	'TOTAL_USERS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_user_s), $_CORE_CONFIG['user']['total_users']),
 	'NEWEST_USER'	=> sprintf($_CLASS['core_user']->get_lang('NEWEST_USER'), '<a href="'. generate_link('Members_List&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">', $_CORE_CONFIG['user']['newest_username'], '</a>'), 
 	'LEGEND'		=> $legend, 
 	'BIRTHDAY_LIST'	=> $birthday_list, 
@@ -111,6 +109,7 @@
 
 	'U_MARK_FORUMS'	=> generate_link('Forums&amp;mark=forums')
 ));
+unset($birthday_list, $legend);
 
 page_header();
 

Modified: cms/trunk/themes_admin/viperal_admin/index.php
===================================================================
--- cms/trunk/themes_admin/viperal_admin/index.php	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/themes_admin/viperal_admin/index.php	2005-10-28 03:45:54 UTC (rev 169)
@@ -28,9 +28,9 @@
 		$this->table_close	= '</div></div></div>';
 		
 		$_CLASS['core_template']->assign_array(array(
-			'A_TABLE_OPEN'	=> $this->table_open,
-			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> 'themes_admin/viperal_admin/style/style.css',
+			'THEME_TABLE_OPEN'	=> $this->table_open,
+			'THEME_TABLE_CLOSE'	=> $this->table_close,
+			'THEME_STYLESHEET'	=> 'themes_admin/viperal_admin/style/style.css',
 		));
 	}
 
@@ -54,7 +54,7 @@
 			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME'].' &gt; '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']));
 		}
 		
-		$_CLASS['core_blocks']->display(BLOCK_LEFT);
+		$_CLASS['core_blocks']->generate(BLOCK_LEFT);
 	
 		$_CLASS['core_template']->display('header.html');
 	}
@@ -63,7 +63,7 @@
 	{
 		global $_CLASS;
 
-		$_CLASS['core_blocks']->display(BLOCK_RIGHT);
+		$_CLASS['core_blocks']->generate(BLOCK_RIGHT);
 
 		$_CLASS['core_template']->assign('THEME_FOOTER', $_CLASS['core_display']->footmsg());
 		

Modified: cms/trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/trunk/themes_admin/viperal_admin/template/header.html	2005-10-27 16:01:46 UTC (rev 168)
+++ cms/trunk/themes_admin/viperal_admin/template/header.html	2005-10-28 03:45:54 UTC (rev 169)
@@ -6,9 +6,8 @@
 <meta name="author" content="{ $SITE_NAME }" /><meta http-equiv="expires" content="0" />
 <meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
 <!-- <meta name="robots" content="noindex, nofollow" /> -->
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
 { $HEADER_META }
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
 { $HEADER_REGULAR }
 { $HEADER_JS }
 <script type="text/javascript" src="javascript/collapse.js"></script>



From viperal at berlios.de  Fri Oct 28 19:24:59 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 28 Oct 2005 19:24:59 +0200
Subject: [Viperals-svncheckins] r170 - in cms/trunk: . admin admin/functions blocks includes includes/auth includes/db includes/display includes/templates includes/templates/admin/modules install
Message-ID: <200510281724.j9SHOx9G003444@sheep.berlios.de>

Author: viperal
Date: 2005-10-28 19:24:47 +0200 (Fri, 28 Oct 2005)
New Revision: 170

Added:
   cms/trunk/admin/functions/page_functions.php
   cms/trunk/includes/templates/pages/
Modified:
   cms/trunk/.htaccess
   cms/trunk/admin.php
   cms/trunk/admin/blocks.php
   cms/trunk/admin/modules.php
   cms/trunk/blocks/block-Modules.php
   cms/trunk/blocks/block-User.php
   cms/trunk/debug.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/system.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/templates/admin/modules/index.html
   cms/trunk/includes/user.php
   cms/trunk/index.php
   cms/trunk/install/build_data.php
Log:


Modified: cms/trunk/.htaccess
===================================================================
--- cms/trunk/.htaccess	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/.htaccess	2005-10-28 17:24:47 UTC (rev 170)
@@ -7,10 +7,30 @@
 	allow from all
 </LimitExcept>
 
+# If you use SEO, mod_rewrite is necessary
+# This is based from dragonfly cms ( drgaonflycms.com )
+<IfModule mod_rewrite.c>
+  RewriteEngine On
+
+  RewriteCond %{REQUEST_FILENAME} -f [NC,OR]
+  RewriteCond %{REQUEST_FILENAME} -d
+  RewriteRule ^(.*)$ - [L]
+
+  # RewriteBase /html
+	RewriteRule ^index\.html /index.php
+	RewriteRule ^([a-zA-Z0-9_=+-]+)(/|\.html)$ index=$1 [L]
+	RewriteRule ^([a-zA-Z0-9_]+)/(.*)(/|\.html)$ index=$1&$2  [L]
+	RewriteRule ^index=(.*[^/])/(.*) index=$1&$2 [N,L]
+
+	RewriteRule ^index=(.*) index.php?mod=$1 [L]
+</IfModule>
+
 ErrorDocument 400 /error.php
 ErrorDocument 401 /error.php
 ErrorDocument 403 /error.php
 ErrorDocument 404 /error.php
 ErrorDocument 500 /error.php
 
-Options -Indexes
\ No newline at end of file
+Options -Indexes
+
+AddDefaultCharset utf-8
\ No newline at end of file

Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/admin/blocks.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -28,7 +28,6 @@
 
 global $_CLASS;
 
-require_once SITE_FILE_ROOT.'admin/functions/block_functions.php';
 $_CLASS['core_user']->add_lang('admin/blocks.php');
 
 function check_position($position, $redirect = true)
@@ -50,6 +49,8 @@
 
 if (isset($_REQUEST['mode']))
 {
+	require_once SITE_FILE_ROOT.'admin/functions/block_functions.php';
+
 	if ($id = get_variable('id', 'REQUEST', false, 'integer'))
 	{
 		switch ($_REQUEST['mode'])

Added: cms/trunk/admin/functions/page_functions.php
===================================================================
--- cms/trunk/admin/functions/page_functions.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/admin/functions/page_functions.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -0,0 +1,137 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+function page_auth($id)
+{
+	global $_CLASS;
+
+	$result = $_CLASS['core_db']->query('SELECT page_type, page_auth FROM ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
+	$page = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$page)
+	{
+		trigger_error('page_NOT_FOUND');
+	}
+
+	$page['page_auth'] = ($page['page_auth']) ? unserialize($page['page_auth']) : '';
+
+	check_type($page['page_type']);
+
+	$_CLASS['core_display']->display_header();
+
+	$auth = $_CLASS['core_auth']->generate_auth_options($page['page_auth']);
+
+	if ($auth !== false)
+	{
+		if (is_null($auth))
+		{
+			$page['page_auth'] = '';
+			$auth = 'null';
+		}
+		else
+		{
+			$page['page_auth'] = $auth;
+			$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
+		}
+
+		$_CLASS['core_db']->query('UPDATE '. CORE_PAGES_TABLE . " set page_auth = $auth WHERE page_id = $id");
+		$_CLASS['core_cache']->destroy('blocks');
+	}
+
+	$_CLASS['core_display']->display_footer();
+}
+		
+function page_change($id)
+{
+	global $_CLASS;
+	
+	$result = $_CLASS['core_db']->query('SELECT page_name, page_status, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
+	$page = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$page)
+	{
+		trigger_error('page_NOT_FOUND');
+	}
+
+	check_type($page['page_type']);
+
+	$status = ($page['page_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+	
+	if (file_exists(SITE_FILE_ROOT.'modules/'.$page['page_name'].'/configurator.php'))
+	{
+		require_once(SITE_FILE_ROOT.'modules/'.$page['page_name'].'/configurator.php');
+		
+		$name = $page['page_name'].'_configurator';
+
+		if (class_exists($name))
+		{
+			$page_configurer = new $name;
+
+			if (method_exists($page_configurer, 'status_change'))
+			{
+				$report = $page_configurer->status_change($status, $page['page_status']);
+
+				if ($report !== true)
+				{
+					trigger_error(is_string($report) ? $report : 'STATUS_CHANGE_FAILED');
+				}
+			}
+		}
+	}
+
+	$result = $_CLASS['core_db']->query('UPDATE '. CORE_PAGES_TABLE . " SET page_status = $status WHERE page_id = $id");
+}
+
+function page_remove($id)
+{
+	global $_CLASS;
+
+	$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
+	$page = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$page || $page['page_status'] != STATUS_PENDING)
+	{
+		trigger_error($page ? 'MODULE_NOT_REMOVABLE' : 'MODULE_NOT_FOUND');
+	}
+
+	check_type($page['page_type']);
+
+	if (display_confirmation())
+	{
+		if ($page['page_type'] === PAGE_TEMPLATE)
+		{
+		// remove template
+		}
+
+		$_CLASS['core_db']->query('DELETE from ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
+
+		return true;
+	}
+
+	return false;
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/admin/modules.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -32,9 +32,9 @@
 
 $mode = get_variable('mode', 'GET', false);
 
-function check_type($type, $redirect = true)
+function check_type(&$type, $redirect = true)
 {
-	$appoved_type = array(1);
+	$appoved_type = array(0);
 	$type = (int) $type;
 	
 	if (!in_array($type, $appoved_type, true))
@@ -56,6 +56,7 @@
 		switch ($_REQUEST['mode'])
 		{
 			case 'search':
+				//$result = $_CLASS['core_db']->query('SELECT page_name, page_type FROM '. CORE_PAGES_TABLE .' WHERE page_type = '. PAGE_MODULE);
 				$result = $_CLASS['core_db']->query('SELECT page_name, page_type FROM '. CORE_PAGES_TABLE);
 
 				$modules = array();
@@ -80,56 +81,21 @@
 			break;
 
 			case 'change':
-				$result = $_CLASS['core_db']->query('SELECT page_name, page_status, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
-				$module = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-			
-				if (!$module)
-				{
-					trigger_error('page_NOT_FOUND');
-				}
-			
-				check_type($module['page_type']);
-			
-				$status = ($module['page_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
-				
-				if (file_exists(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php'))
-				{
-					require_once(SITE_FILE_ROOT.'modules/'.$module['page_name'].'/configurator.php');
-					
-					$name = $module['page_name'].'_configurator';
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
 
-					if (class_exists($name))
-					{
-						$page_configurer = new $name;
-
-						if (method_exists($page_configurer, 'status_change'))
-						{
-							$report = $page_configurer->status_change($status, $module['page_status']);
-		
-							if ($report !== true)
-							{
-								trigger_error(is_string($report) ? $report : 'STATUS_CHANGE_FAILED');
-							}
-						}
-					}
-				}
-
-				$result = $_CLASS['core_db']->query('UPDATE '. CORE_PAGES_TABLE . " SET page_status = $status WHERE page_id = $id");
+				page_change($id);
 			break;
 
 			case 'install':
-				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE." WHERE page_id = $id AND page_type = ". PAGE_MODULE);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
-			
+
 				if (!$module || $module['page_status'] != STATUS_PENDING)
 				{
-					trigger_error($module ? 'page_ALREADY_INSTALLED' : 'page_NOT_FOUND');
+					trigger_error($module ? 'MODULE_ALREADY_INSTALLED' : 'MODULE_NOT_FOUND');
 				}
 
-				check_type($module['page_type']);
-
 				if (display_confirmation())
 				{
 					$status = true;
@@ -167,7 +133,7 @@
 			
 				if (!$module || $module['page_status'] == STATUS_PENDING)
 				{
-					trigger_error($module ? 'page_NOT_UNINSTALLABLE' : 'page_NOT_FOUND');
+					trigger_error($module ? 'MODULE_NOT_UNINSTALLABLE' : 'MODULE_NOT_FOUND');
 				}
 			
 				check_type($module['page_type']);
@@ -201,122 +167,64 @@
 			break;
 
 			case 'remove':
-				$result = $_CLASS['core_db']->query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
-				$module = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-			
-				if (!$module || $module['page_status'] != STATUS_PENDING)
-				{
-					trigger_error($module ? 'page_NOT_REMOVABLE' : 'page_NOT_FOUND');
-				}
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
 
-				check_type($module['page_type']);
-
-				if (display_confirmation())
-				{
-					$_CLASS['core_db']->query('DELETE from ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
-				}
+				page_remove($id);
 			break;
 
 			case 'auth':
-				$result = $_CLASS['core_db']->query('SELECT page_type, page_auth FROM ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);
-				$module = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-		
-				if (!$module)
-				{
-					trigger_error('page_NOT_FOUND');
-				}
-		
-				$module['page_auth'] = ($module['page_auth']) ? unserialize($module['page_auth']) : '';
-		
-				check_type($module['page_type']);
-		
-				$_CLASS['core_display']->display_header();
-		
-				$auth = $_CLASS['core_auth']->generate_auth_options($module['page_auth']);
-		
-				if ($auth !== false)
-				{
-					if (is_null($auth))
-					{
-						$module['page_auth'] = '';
-						$auth = 'null';
-					}
-					else
-					{
-						$module['page_auth'] = $auth;
-						$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
-					}
-		
-					$_CLASS['core_db']->query('UPDATE '.CORE_PAGES_TABLE." set page_status = $auth WHERE page_id = $id");
-					$_CLASS['core_cache']->destroy('blocks');
-				}
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
 
-				$_CLASS['core_display']->display_footer();
+				page_auth($id);
 			break;
 		}
 	}
 }
 
+$sql = 'SELECT * FROM '.CORE_PAGES_TABLE.'
+			WHERE page_type = '. PAGE_MODULE .'
+				ORDER BY page_name';
 
-$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_PAGES_TABLE.' ORDER BY page_name');
+$result = $_CLASS['core_db']->query($sql);
 
 $modules = array();
-
-while($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-	$modules[$row['page_type']][] = $row;
-}
-$_CLASS['core_db']->free_result($result);
-
 $admin_auth = false;
-$_CLASS['core_template']->assign('S_LINK_ADMIN_AUTH', $admin_auth);
 
-$page_type = array(0 => 'system', 1 => 'normal');
-
-foreach ($page_type as $type => $name)
+while ($module = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	if (empty($modules[$type]))
+	settype($module['page_status'], 'int');
+
+	$active = ($module['page_status'] === STATUS_ACTIVE);
+	if ($module['page_status'] === STATUS_PENDING)
 	{
-		continue;
+		$installed = false;
+		$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['page_id'], array('admin' => true));
+		$remove_link = generate_link('modules&amp;mode=remove&amp;id='.$module['page_id'], array('admin' => true));
 	}
-
-	foreach ($modules[$type] as $module)
+	else
 	{
-		$active = $module['page_status'] == STATUS_ACTIVE;
+		$installed = true;
+		$installer_link = generate_link('modules&amp;mode=uninstall&amp;id='.$module['page_id'], array('admin' => true));
+		$remove_link = '';
+	}
 
-		if ($module['page_status'] == STATUS_PENDING)
-		{
-			$installed = false;
-			$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['page_id'], array('admin' => true));
-			$remove_link = generate_link('modules&amp;mode=remove&amp;id='.$module['page_id'], array('admin' => true));
-		}
-		else
-		{
-			$installed = true;
-			$installer_link = ($module['page_type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['page_id'], array('admin' => true)) : '';
-			$remove_link = '';
-		}
+	$_CLASS['core_template']->assign_vars_array('normal_modules', array(
+			'ACTIVE'		=> ($active),
+			'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+			'ERROR'			=> '',
+			'INSTALLED'		=> $installed,
+			'TITLE'			=> ($module['page_title']) ? $module['page_title'] : $module['page_name'],
 
-		$_CLASS['core_template']->assign_vars_array($name.'_modules', array(
-				'ACTIVE'		=> ($active),
-				'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
-				'ERROR'			=> '',
-				'INSTALLED'		=> $installed,
-				'TITLE'			=> ($module['page_title']) ? $module['page_title'] : $module['page_name'],
-
-				'LINK_ACTIVE'		=> generate_link('modules&amp;mode=change&amp;id='.$module['page_id'], array('admin' => true)),
-				'LINK_EDIT'			=> generate_link('modules&amp;mode=edit&amp;id='.$module['page_id'], array('admin' => true)),
-				'LINK_AUTH'			=> generate_link('modules&amp;mode=auth&amp;id='.$module['page_id'], array('admin' => true)),
-				'LINK_ADMIN_AUTH'	=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['page_id'], array('admin' => true)) : '' ,
-				'LINK_INSTALLER'	=> $installer_link,
-				'LINK_REMOVE'		=> $remove_link,
-		));
-	}
-	unset($modules[$type], $module);
+			'LINK_ACTIVE'		=> generate_link('modules&amp;mode=change&amp;id='.$module['page_id'], array('admin' => true)),
+			'LINK_EDIT'			=> generate_link('modules&amp;mode=edit&amp;id='.$module['page_id'], array('admin' => true)),
+			'LINK_AUTH'			=> generate_link('modules&amp;mode=auth&amp;id='.$module['page_id'], array('admin' => true)),
+			'LINK_ADMIN_AUTH'	=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['page_id'], array('admin' => true)) : '' ,
+			'LINK_INSTALLER'	=> $installer_link,
+			'LINK_REMOVE'		=> $remove_link,
+	));
 }
 
+
 $_CLASS['core_display']->display(false, 'admin/modules/index.html');
 
 ?>
\ No newline at end of file

Modified: cms/trunk/admin.php
===================================================================
--- cms/trunk/admin.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/admin.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -72,8 +72,8 @@
 if (!$mod || !$_CLASS['core_display']->generate_page('admin'))
 {
 	$blocks = 0;
-	$blocks |= BLOCK_LEFT;
-	$blocks |= BLOCK_RIGHT;
+	$blocks |= (1 << BLOCK_LEFT);
+	//$blocks |= (1 << BLOCK_RIGHT);
 				
 	$_CLASS['core_display']->page = array('page_title' => '', 'page_name' => '', 'page_blocks' => $blocks);
 	$file_path = SITE_FILE_ROOT.'admin/index.php';

Modified: cms/trunk/blocks/block-Modules.php
===================================================================
--- cms/trunk/blocks/block-Modules.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/blocks/block-Modules.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -31,7 +31,7 @@
 $this->content .= '<div id="nav"><ul style="margin: 0px; padding: 0px; list-style-type: none; line-height: 150%;">';
 $this->content .= '<li><a href="'.generate_link().'">Home</a></li>';
 
-$result = $_CLASS['core_db']->query('SELECT page_name, page_title, page_auth FROM '.CORE_PAGES_TABLE.' WHERE page_type = '.MODULE_NORMAL.' AND page_status = ' . STATUS_ACTIVE . ' ORDER BY page_name ASC');
+$result = $_CLASS['core_db']->query('SELECT page_name, page_title, page_auth FROM '.CORE_PAGES_TABLE.' WHERE page_status = ' . STATUS_ACTIVE . ' ORDER BY page_name ASC');
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {

Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/blocks/block-User.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -54,19 +54,19 @@
 	}
 	
 	$this->content .= '<br />'.$_CLASS['core_user']->lang['WELCOME'].'<br />' . $_CLASS['core_user']->data['username'].'<br /><hr /></div><b>Your Info</b><br /><br />'
-	.'<div style="margin-left: 12px;"><a href="'.generate_link('Control_Panel&amp;i=2').'">'.$_CLASS['core_user']->lang['PRIVATE_MESSAGE'].'</a><hr />'.sprintf($_CLASS['core_user']->lang['NEW_PMS'], $_CLASS['core_user']->data['user_new_privmsg']) . '<br />'
+	.'<div style="margin-left: 12px;"><a href="'.generate_link('control_panel&amp;i=2').'">'.$_CLASS['core_user']->lang['PRIVATE_MESSAGE'].'</a><hr />'.sprintf($_CLASS['core_user']->lang['NEW_PMS'], $_CLASS['core_user']->data['user_new_privmsg']) . '<br />'
 	.sprintf($_CLASS['core_user']->lang['UNREAD_PM'], $_CLASS['core_user']->data['user_unread_privmsg']) . '<br /><br />'
 	//.$_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit'])
-	.'<a href="'.generate_link('Control_Panel').'">Control Panel</a><br />'
-	.'<a href="'.generate_link('Control_Panel&amp;mode=logout').'">'.$_CLASS['core_user']->lang['LOGOUT'].'</a><br /></div>';
+	.'<a href="'.generate_link('control_panel').'">Control Panel</a><br />'
+	.'<a href="'.generate_link('control_panel&amp;mode=logout').'">'.$_CLASS['core_user']->lang['LOGOUT'].'</a><br /></div>';
 }
 else
 {
-    $this->content .= '<br /><form action="'.generate_link('Control_Panel&amp;mode=login').'" method="post"><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
+    $this->content .= '<br /><form action="'.generate_link('control_panel&amp;mode=login').'" method="post"><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td>
     '.$_CLASS['core_user']->lang['USERNAME'].'</td><td align="right"><input class="post" type="text" name="username" size="10" maxlength="25" /></td></tr><tr><td>
     '.$_CLASS['core_user']->lang['PASSWORD'].'</td><td align="right"><input class="post" type="password" name="password" size="10" maxlength="20" /></td></tr><tr><td>';
 
-    $this->content .= (($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_DISABLE) ? '(<a href="'.generate_link('Control_Panel&amp;mode=register').'">'.$_CLASS['core_user']->lang['REGISTER'].'</a>)' : '') . '</td>
+    $this->content .= (($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_DISABLE) ? '(<a href="'.generate_link('control_panel&amp;mode=register').'">'.$_CLASS['core_user']->lang['REGISTER'].'</a>)' : '') . '</td>
 		<td align="right">
 			<input type="hidden" name="redirect" value="'.htmlspecialchars($_CLASS['core_user']->url).'" />
 			<input class="button" type="submit" name="login" value="'.$_CLASS['core_user']->lang['LOGIN'].'" /><br/>
@@ -156,14 +156,13 @@
 	
 	if ($row['user_id'] != ANONYMOUS)
 	{
-		$link = ($row['user_type'] == USER_BOT) ? $row['username'].' &gt;' : '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>  &gt;';
+		$link = ($row['user_type'] == USER_BOT) ? $row['username'].' &gt;' : '<a href="'.generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>  &gt;';
 		$who_where['user'] .= $online['user'] .': '.$link.' <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
 	else
 	{
 		$who_where['guest'] .= $online['guest'] .': <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
-
 }
 
 unset($session_users);
@@ -179,7 +178,7 @@
   </tr>
   <tr> 
 	<td align="center" valign="middle" rowspan="1"><img src="images/blocks/user/stats.gif" alt="statistics" border="0" /></td>
-	<td class="gensmall" align="left" width="100%">Members&nbsp;<b>'.$_CORE_CONFIG['user']['total_users'].'</b><br />Latest:&nbsp;<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">'. $_CORE_CONFIG['user']['newest_username']. '</a>
+	<td class="gensmall" align="left" width="100%">Members&nbsp;<b>'.$_CORE_CONFIG['user']['total_users'].'</b><br />Latest:&nbsp;<a href="' . generate_link('members_list&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">'. $_CORE_CONFIG['user']['newest_username']. '</a>
 	<br /><hr />
 	</td>
   </tr>

Modified: cms/trunk/debug.php
===================================================================
--- cms/trunk/debug.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/debug.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -1,26 +1,33 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 define('VIPERAL', 'Admin');
 
 error_reporting(E_ALL);
 
-//echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
-$site_file_root = '';
+/* require_once SITE_FILE_ROOT.'core.php'; */
+require_once 'core.php';
 
-require($site_file_root.'core.php');
 
 if (!$_CLASS['core_user']->is_admin)
 {
@@ -29,6 +36,7 @@
 
 $_CLASS['core_handler']->stop();
 $_CLASS['core_user']->user_setup();
+
 error_reporting(E_ALL);
 
 $mode = get_variable('mode', 'GET', false);
@@ -54,7 +62,7 @@
 
 		$size = count($debug_data['E_WARNING']);
 	
-		for ($i=0; $i<$size; $i++)
+		for ($i=0; $i < $size; $i++)
 		{
 			$_CLASS['core_template']->assign_vars_array('error_warnings', array(
 				'errfile'	=> $debug_data['E_WARNING'][$i]['file'],
@@ -62,7 +70,6 @@
 				'msg_text' => $debug_data['E_WARNING'][$i]['error']
 			));
 		}
-		
 	break;
 
 	case 'queries':
@@ -117,7 +124,7 @@
 	break;
 	
 	default:
-	case 'notice':
+	/* case 'notice': */
 		$debug_data = $_CLASS['core_user']->session_data_get('debug');
 		
 		if (empty($debug_data['E_NOTICE']))
@@ -139,4 +146,5 @@
 
 $_CLASS['core_template']->display('debug.html');
 script_close(false);
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/auth/auth.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -28,12 +28,12 @@
 	var $_got_data = false;
 	var $_admin_permission = array();
 
-	function core_auth($user_id = false, $user_group = false)
+	function core_auth($user_data = false)
 	{
 		global $_CLASS;
 
-		$this->_user_id = ($user_id) ? $user_id : $_CLASS['core_user']->data['user_id'];
-		$this->_user_group = ($user_group) ? $user_group : $_CLASS['core_user']->data['user_group'];
+		$this->_user_id = ($user_data) ? $user_data['user_id'] : $_CLASS['core_user']->data['user_id'];
+		$this->_user_group = ($user_data) ? $user_data['user_group'] : $_CLASS['core_user']->data['user_group'];
 	}
 
 	function user_auth($user_name, $user_password)
@@ -41,7 +41,7 @@
 		global $_CLASS;
 
 		$sql = 'SELECT user_id, username, user_password, user_password_encoding, user_status 
-					FROM ' . USERS_TABLE . " WHERE username = '" . $_CLASS['core_db']->escape($user_name) . "'";
+					FROM ' . CORE_USERS_TABLE . " WHERE username = '" . $_CLASS['core_db']->escape($user_name) . "'";
 
 		$result = $_CLASS['core_db']->query($sql);
 	
@@ -80,7 +80,7 @@
 		global $_CLASS;
 
 // should this be extended for defualt groups only, and all in group ?
-		$sql = 'SELECT * FROM ' . ADMIN_AUTH_TABLE ." 
+		$sql = 'SELECT * FROM ' . CORE_ADMIN_AUTH_TABLE ." 
 					WHERE user_id = {$this->_user_id}
 					OR group_id = {$this->_user_group} ORDER BY user_id";
 
@@ -333,7 +333,7 @@
 					if (count($setup['groups']))
 					{
 						$sql = 'SELECT group_id
-							FROM ' . GROUPS_TABLE . '
+							FROM ' . CORE_GROUPS_TABLE . '
 							WHERE group_id IN ('.implode(', ', array_map('intval', $setup['groups'])).')';
 						$result = $_CLASS['core_db']->query($sql);
 
@@ -409,7 +409,7 @@
 		if (!empty($auth_options['users']))
 		{
 			$sql = 'SELECT user_id, username, user_colour
-				FROM ' . USERS_TABLE . '
+				FROM ' . CORE_USERS_TABLE . '
 				WHERE user_id IN ('.implode(', ', array_keys($auth_options['users'])).')
 					ORDER BY username';
 			$result = $_CLASS['core_db']->query($sql);
@@ -428,7 +428,7 @@
 		if (!empty($groups_ids))
 		{
 			$sql = 'SELECT group_id, group_name, group_type 
-				FROM ' . GROUPS_TABLE . '
+				FROM ' . CORE_GROUPS_TABLE . '
 				WHERE group_id IN ('.implode(', ', $groups_ids).')
 					ORDER BY group_type DESC, group_name';
 			$result = $_CLASS['core_db']->query($sql);
@@ -445,7 +445,7 @@
 		}
 
 		$sql = 'SELECT group_id, group_name, group_type 
-			FROM ' . GROUPS_TABLE . 
+			FROM ' . CORE_GROUPS_TABLE . 
 				(empty($groups_ids) ? '' : ' WHERE group_id NOT IN ('.implode(', ', $groups_ids).')').'
 					ORDER BY group_type DESC, group_name';
 		$result = $_CLASS['core_db']->query($sql);
@@ -456,7 +456,7 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 	
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'P_ADD_GROUPS'		=> $group_list,
 			'P_CURRENT_USERS'	=> $allowed_user_list,
 			'P_DCURRENT_USERS'	=> $disallowed_user_list,

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/db/mysql.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -544,10 +544,12 @@
 					$fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
+				//$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
-				if ($option == 'return')
+				if ($option === 'return')
 				{
 					return $table;
 				}

Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/db/mysqli.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -435,7 +435,7 @@
 			);
 		}
 
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}
@@ -539,7 +539,10 @@
 					$_fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB;";
+				//$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+
+				
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/display/display.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -51,7 +51,6 @@
 
 		settype($page['page_status'], 'int');
 		settype($page['page_type'], 'int');
-		settype($page['page_status'], 'int');
 
 		switch ($type)
 		{
@@ -99,7 +98,7 @@
 			//case 'feed':
 			default:
 				settype($page['page_blocks'], 'int');
-				settype($page['page_blocks'], 'int');
+				settype($page['page_type'], 'int');
 
 				if ($page['page_status'] !== STATUS_ACTIVE)
 				{
@@ -124,12 +123,12 @@
 				if (!$page['page_location'])
 				{
 					$page['page_location'] = SITE_FILE_ROOT.'modules/'.$page['page_name'].'/index.php';
+					
+					if (!file_exists($page['page_location']))
+					{
+						return '404:_PAGE_NOT_FOUND';
+					}
 				}
-
-				if (!file_exists($page['page_location']))
-				{
-					return '404:_PAGE_NOT_FOUND';
-				}
 			break;
 		}
 
@@ -160,6 +159,17 @@
 
 			if ($this->page['page_location'])
 			{
+				if ($this->page['page_type'] === PAGE_TEMPLATE)
+				{
+					global $_CLASS;
+
+					$_CLASS['core_user']->user_setup();
+
+					$this->display(false, $this->page['page_location']);
+
+					return true;
+				}
+
 				$this->supported = array();
 
 				require_once $this->page['page_location'];
@@ -196,7 +206,7 @@
 		global $_CLASS;
 
 		header('Content-Type: text/html; charset=utf-8');
-		header('Content-language: ' . $_CLASS['core_user']->lang['LANG']);
+		header('Content-Language: ' . $_CLASS['core_user']->lang['LANG']);
 
 		header('P3P: CP="CAO DSP COR CURa ADMa DEVa OUR IND PHY ONL UNI COM NAV INT DEM PRE"');
 		header('Cache-Control: private, pre-check=0, post-check=0, max-age=0');

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/functions.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -441,9 +441,12 @@
 	return $base;
 }
 
+/*
+	Search Engine URL based on implementation from dragonfly cms ( drgaonflycms.com )
+*/
 function generate_link($link = false, $link_options = false)
 {
-	global $_CLASS, $_CORE_MODULE;
+	global $_CLASS, $_CORE_CONFIG;
 	//static $SEO = array('?', '&', '&amp;');
 
 	$options = array(
@@ -457,8 +460,10 @@
 	if (is_array($link_options))
 	{
 		$options = array_merge($options, $link_options);
-	} 
-$options['seo'] = false;
+	}
+
+	$options['seo'] = ($options['force_sid']) ? true : ($_CORE_CONFIG['global']['link_optimization'] && $options['seo']);
+
 	if ($options['admin'])
 	{
 		$options['seo'] = false;
@@ -470,6 +475,7 @@
 	}
 	else
 	{
+		/* No really, I want to know what you call that */
 		$what_you_call_this = false;
 	}
 
@@ -477,9 +483,9 @@
 
 	if (!$link)
 	{
-		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
+		if ($options['sid'] && $_CLASS['core_user']->need_sid)
 		{
-			$options['seo'] = false;
+			$options['seo'] = $options['force_sid'] = false;
 
 			$link = $file.'?'.$_CLASS['core_user']->sid_link;
 		}
@@ -490,14 +496,14 @@
 	}
 	else
 	{
-		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
+		if ($options['sid'] && $_CLASS['core_user']->need_sid)
 		{
 			$link .= '&amp;'.$_CLASS['core_user']->sid_link;
 		}
 
-		if ($link{0} == '&')
+		if ($link{0} === '&')
 		{
-			$link = $_CORE_MODULE['module_name'].$link;
+			$link = $_CLASS['core_display']->page['page_name'].$link;
 		}
 
 		if (!$options['seo'])

Modified: cms/trunk/includes/system.php
===================================================================
--- cms/trunk/includes/system.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/system.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -37,8 +37,8 @@
 
 	$size = 24;
 
-	header('Content-type: image/png');
-	header('Cache-control: no-cache, no-store');
+	header('Content-Type: image/png');
+	header('Cache-Control: no-cache, no-store');
 
 	if (function_exists('imagettfbbox'))
 	{

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/tables.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -20,17 +20,15 @@
 
 $Id$
 */
-// Well this needs some works
+
 if (!defined('VIPERAL'))
 {
-    Header('Location: /');
-    die();
+    die;
 }
 
-// User related
 define('ANONYMOUS', 1);
 
-// status settings
+/* Global Status types */
 define('STATUS_DISABLED', 0);
 define('STATUS_PENDING', 1);
 define('STATUS_ACTIVE', 2);
@@ -60,7 +58,7 @@
 define('ADMIN_NOT_ADMIN', 1);
 define('ADMIN_IS_ADMIN', 2);
 
-// Block side
+/* BLOCKS */
 define('BLOCK_LEFT', 1);
 define('BLOCK_RIGHT', 2);
 define('BLOCK_TOP', 3);
@@ -75,8 +73,8 @@
 define('BLOCKTYPE_MESSAGE', 4);
 define('BLOCKTYPE_MESSAGE_GLOBAL', 5);
 
-define('MODULE_SYSTEM', 0);
-define('MODULE_NORMAL', 1);
+define('PAGE_MODULE', 0);
+define('PAGE_TEMPLATE', 1);
 
 define('ACL_NO', 0);
 define('ACL_YES', 1);
@@ -159,7 +157,6 @@
 define('FIELD_DROPDOWN', 5);
 define('FIELD_DATE', 6);
 
-// Table names
 
 define('FORUMS_ACL_TABLE', $table_prefix.'forums_auth');
 define('FORUMS_ACL_OPTIONS_TABLE', $table_prefix.'forums_auth_options');

Modified: cms/trunk/includes/templates/admin/modules/index.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/index.html	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/templates/admin/modules/index.html	2005-10-28 17:24:47 UTC (rev 170)
@@ -5,14 +5,10 @@
 <table class="tablebg" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
 		<tr>
-			<th width="<!-- IF { $S_LINK_ADMIN_AUTH } -->30<!-- ELSE -->50<!-- ENDIF -->%" align="center"><b>{ $L_TITLE }</b></th>
+			<th width="50%" align="center"><b>{ $L_TITLE }</b></th>
 			<th align="center"><b>{ $L_STATUS }</b></td>
 			<th align="center"><b>{ $L_FUNCTIONS }</b></th>
-			<!-- IF { $S_LINK_ADMIN_AUTH } -->
-			<th align="center"></th>
-			<!-- ENDIF -->
 		</tr>
-
 	<!-- IF isset({ $normal_modules }) -->
     	<tr>
 			<td class="cat" colspan="4"><b class="gensmall">Normal</b></td>
@@ -47,11 +43,6 @@
 					 | <a href="{ $normal_modules:LINK_INSTALLER }">{ $L_UNINSTALL }</a>
 				<!-- ENDIF -->
 			</td>
-			<!-- IF { $S_LINK_ADMIN_AUTH } -->
-			<td nowrap="nowrap" class="row1" align="center">
-				<a href="{ $normal_modules:LINK_ADMIN_AUTH }">{ $L_ADMIN_PERMISSIONS }</a>
-			</td>
-			<!-- ENDIF -->
 		<!-- ELSE -->
 			<td align="center" class="row1">
 				{ $L_NOT_INSTALLED }

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/includes/user.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -48,7 +48,6 @@
 	function core_user()
 	{
 		$this->browser = mb_substr((empty($_SERVER['HTTP_USER_AGENT']) ? getenv('HTTP_USER_AGENT') : $_SERVER['HTTP_USER_AGENT']), 0, 255);
-
 		$this->url	= $_SERVER['REQUEST_URI'];
 		$this->ip	= empty($_SERVER['REMOTE_ADDR']) ? getenv('REMOTE_ADDR') : $_SERVER['REMOTE_ADDR'];
 		$this->time	= (int) gmtime();
@@ -57,21 +56,31 @@
 		{
 			$pos = $pos + mb_strlen(INDEX_PAGE.'?mod=');
 			$this->url = mb_substr($this->url, $pos);
-			
-			if (($pos = mb_strpos($this->url, 'sid')) !== false)
+		}
+		elseif (mb_substr($this->url, -5) === '.html') /* Add for .html#blabla */
+		{
+			$this->url = str_replace(array('/', '.html'), array('&', ''), $this->url);
+
+			if ($this->url{0} === '&')
 			{
-				$this->url = mb_substr($this->url, 0, $pos - 1);
+				$this->url = mb_substr($this->url, 1);
 			}
-
-			//$this->url = htmlspecialchars(html_entity_decode($this->url, ENT_QUOTES));
-			$this->url = htmlspecialchars($this->url, ENT_QUOTES);
-
-			$this->url = mb_substr($this->url, 0, 255);
 		}
 		else
 		{
 			$this->url = '';
 		}
+
+		if ($this->url)
+		{
+			if (($pos = mb_strpos($this->url, 'sid=')) !== false)
+			{
+				$this->url = mb_substr($this->url, 0, $pos - 1);
+			}
+			
+			$this->url = htmlspecialchars($this->url, ENT_QUOTES);
+			$this->url = mb_substr($this->url, 0, 255);
+		}
 	}
 
 	function format_date($gmtime, $format = false)

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/index.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -90,7 +90,7 @@
 
 		if (!$mode || !function_exists($mode))
 		{
-			header("HTTP/1.0 503 Service Unavailable");
+			header('HTTP/1.0 503 Service Unavailable');
 			script_close(false);
 		}
 
@@ -99,9 +99,8 @@
 		script_close(false);
 	}
 
-	$sql = 'SELECT * FROM '.CORE_PAGES_TABLE.'
-				WHERE page_type = ' . MODULE_NORMAL . "
-				AND page_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+	$sql = 'SELECT * FROM '. CORE_PAGES_TABLE ."
+				WHERE page_name = '" . $_CLASS['core_db']->escape($mod) . "'";
 
 	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-28 03:45:54 UTC (rev 169)
+++ cms/trunk/install/build_data.php	2005-10-28 17:24:47 UTC (rev 170)
@@ -139,13 +139,13 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('groups', 2, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 1, 1, 102)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('contact', 1, 2, 102)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 1, 1, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('forums', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('members_List', 1, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 1, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 0, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('contact', 0, 2, 102)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 0, 1, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('forums', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('members_list', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 0, 1, 102)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");



From viperal at berlios.de  Sun Oct 30 07:09:56 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 30 Oct 2005 07:09:56 +0100
Subject: [Viperals-svncheckins] r171 - in cms/trunk: install themes/viperal themes/viperal/template themes/viperal/template/modules/articles
Message-ID: <200510300609.j9U69u9Y027202@sheep.berlios.de>

Author: viperal
Date: 2005-10-30 07:09:47 +0100 (Sun, 30 Oct 2005)
New Revision: 171

Modified:
   cms/trunk/install/build_data.php
   cms/trunk/themes/viperal/index.php
   cms/trunk/themes/viperal/template/footer.html
   cms/trunk/themes/viperal/template/modules/articles/print.html
Log:


Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-28 17:24:47 UTC (rev 170)
+++ cms/trunk/install/build_data.php	2005-10-30 06:09:47 UTC (rev 171)
@@ -118,7 +118,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 2, 2, 'block-theme_select.php')");
 
 $content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 5, 4, '$content')");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('blocks', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");

Modified: cms/trunk/themes/viperal/index.php
===================================================================
--- cms/trunk/themes/viperal/index.php	2005-10-28 17:24:47 UTC (rev 170)
+++ cms/trunk/themes/viperal/index.php	2005-10-30 06:09:47 UTC (rev 171)
@@ -64,7 +64,7 @@
 			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME'].' &gt; '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']));
 		}
 		
-		$_CLASS['core_blocks']->display(BLOCK_LEFT);
+		$_CLASS['core_blocks']->generate(BLOCK_LEFT);
 	
 		$_CLASS['core_template']->display('header.html');
 	}
@@ -73,7 +73,7 @@
 	{
 		global $_CLASS;
 
-		$_CLASS['core_blocks']->display(BLOCK_RIGHT);
+		$_CLASS['core_blocks']->generate(BLOCK_RIGHT);
 
 		$_CLASS['core_template']->assign('THEME_FOOTER', $_CLASS['core_display']->footmsg());
 		

Modified: cms/trunk/themes/viperal/template/footer.html
===================================================================
--- cms/trunk/themes/viperal/template/footer.html	2005-10-28 17:24:47 UTC (rev 170)
+++ cms/trunk/themes/viperal/template/footer.html	2005-10-30 06:09:47 UTC (rev 171)
@@ -13,19 +13,18 @@
 	<!-- ENDIF $block_bottom -->
 	
 	<!-- IF isset({ $message_block_bottom }) -->
-	<br/>
-		<div class="messageblock">
-		<!-- LOOP $message_block_bottom -->
-			<div class="title" onclick="blockswitch2('{ $message_block_bottom:ID }');" style="cursor:pointer">{ $message_block_bottom:TITLE }
-			<!-- IF { $message_block_bottom:EDIT_LINK } -->[ <!-- IF { $message_block_bottom:EXPIRES } -->{ $message_block_bottom:EXPIRES } | <!-- ENDIF -->
-			<a href="{ $message_block_bottom:EDIT_LINK }" >{ $message_block_bottom:L_EDIT }</a> ]<!-- ENDIF --></div>
-			<div class="content" { $message_block_bottom:HIDE } id="pe{ $message_block_bottom:ID }">{ $message_block_bottom:CONTENT }</div>
-		<br />
-		<!-- ENDLOOP $message_block_bottom -->
-	
-		</div>
+	<div class="messageblock">
+	<!-- LOOP $message_block_bottom -->
+		<div class="title" onclick="switch_collapse('block_{ $message_block_bottom:id }');" style="cursor:pointer">{ $message_block_bottom:title }
+		<!-- IF { $message_block_bottom:edit_link } -->[ <!-- IF { $message_block_bottom:expires } -->{ $message_block_bottom:expires } | <!-- ENDIF -->
+		<a href="{ $message_block_bottom:edit_link }" >{ $L_EDIT }</a> ]<!-- ENDIF --></div>
+		<div <!-- IF { $message_block_bottom:collapsed } -->style="display: none;"<!-- ENDIF --> class="content" id="block_{ $message_block_bottom:id }">{ $message_block_bottom:content }</div>
 	<br />
+	<!-- ENDLOOP $message_block_bottom -->
+	</div>
+	<br />
 	<!-- ENDIF -->
+
 	</div>
 	</div>
 	

Modified: cms/trunk/themes/viperal/template/modules/articles/print.html
===================================================================
--- cms/trunk/themes/viperal/template/modules/articles/print.html	2005-10-28 17:24:47 UTC (rev 170)
+++ cms/trunk/themes/viperal/template/modules/articles/print.html	2005-10-30 06:09:47 UTC (rev 171)
@@ -2,8 +2,8 @@
 <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
 <head>
 <title>Viperal: News</title>
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
-<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
+<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
 </head>
 
 <body>
@@ -19,8 +19,9 @@
 		<br />
 		<div style="text-align: center;">
 			<a href="#" onclick="javascript:window.print(); return false" title="Print">{ $L_PRINT }</a><br/>
-			<a href='javascript:window.close();'><span class="small"> { $L_CLOSE_WINDOW }</a>
+			<a href='javascript:window.close();'>{ $L_CLOSE_WINDOW }</a>
 		</div>
 	</div>
 </body>
+
 </html>
\ No newline at end of file



From masternoles at berlios.de  Sun Oct 30 07:24:10 2005
From: masternoles at berlios.de (Jonathan Steele at BerliOS)
Date: Sun, 30 Oct 2005 07:24:10 +0100
Subject: [Viperals-svncheckins] r172 - cms/trunk
Message-ID: <200510300624.j9U6OA7n031640@sheep.berlios.de>

Author: masternoles
Date: 2005-10-30 07:24:01 +0100 (Sun, 30 Oct 2005)
New Revision: 172

Modified:
   cms/trunk/.htaccess
Log:


Modified: cms/trunk/.htaccess
===================================================================
--- cms/trunk/.htaccess	2005-10-30 06:09:47 UTC (rev 171)
+++ cms/trunk/.htaccess	2005-10-30 06:24:01 UTC (rev 172)
@@ -31,6 +31,6 @@
 ErrorDocument 404 /error.php
 ErrorDocument 500 /error.php
 
-Options -Indexes
+# Options -Indexes
 
 AddDefaultCharset utf-8
\ No newline at end of file



From masternoles at berlios.de  Mon Oct 31 19:57:06 2005
From: masternoles at berlios.de (Jonathan Steele at BerliOS)
Date: Mon, 31 Oct 2005 19:57:06 +0100
Subject: [Viperals-svncheckins] r174 - cms/trunk/blocks
Message-ID: <200510311857.j9VIv6U5009082@sheep.berlios.de>

Author: masternoles
Date: 2005-10-31 19:57:04 +0100 (Mon, 31 Oct 2005)
New Revision: 174

Modified:
   cms/trunk/blocks/block-User.php
Log:


Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-10-31 03:36:49 UTC (rev 173)
+++ cms/trunk/blocks/block-User.php	2005-10-31 18:57:04 UTC (rev 174)
@@ -53,12 +53,11 @@
 	
 	}
 	
-	$this->content .= '<br />'.$_CLASS['core_user']->lang['WELCOME'].'<br />' . $_CLASS['core_user']->data['username'].'<br /><hr /></div><b>Your Info</b><br /><br />'
-	.'<div style="margin-left: 12px;"><a href="'.generate_link('control_panel&amp;i=2').'">'.$_CLASS['core_user']->lang['PRIVATE_MESSAGE'].'</a><hr />'.sprintf($_CLASS['core_user']->lang['NEW_PMS'], $_CLASS['core_user']->data['user_new_privmsg']) . '<br />'
-	.sprintf($_CLASS['core_user']->lang['UNREAD_PM'], $_CLASS['core_user']->data['user_unread_privmsg']) . '<br /><br />'
-	//.$_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit'])
-	.'<a href="'.generate_link('control_panel').'">Control Panel</a><br />'
-	.'<a href="'.generate_link('control_panel&amp;mode=logout').'">'.$_CLASS['core_user']->lang['LOGOUT'].'</a><br /></div>';
+	$this->content .= '<br />'.$_CLASS['core_user']->lang['WELCOME'].'<br />' . $_CLASS['core_user']->data['username'].'<br /><hr /></div><b>Your Info</b><br /><br />
+	<div style="margin-left: 12px;"><a href="'.generate_link('control_panel&amp;i=2').'">'.$_CLASS['core_user']->lang['PRIVATE_MESSAGE'].'</a><hr />'.sprintf($_CLASS['core_user']->lang['NEW_PMS'], $_CLASS['core_user']->data['user_new_privmsg']) . '<br />
+	'.sprintf($_CLASS['core_user']->lang['UNREAD_PM'], $_CLASS['core_user']->data['user_unread_privmsg']) . '<br /><br />
+	<a href="'.generate_link('control_panel').'">Control Panel</a><br />
+	<a href="'.generate_link('control_panel&amp;mode=logout').'">'.$_CLASS['core_user']->lang['LOGOUT'].'</a><br /></div>';
 }
 else
 {
@@ -74,7 +73,7 @@
 	</tr>
 	<tr>
 		<td colspan="2">
-			<input name="autologin" type="checkbox" /><span class="gensmall">Remmeber me</span>
+			<input name="autologin" type="checkbox" /><span class="gensmall">Remember me</span>
 		</td>
 	</tr>
 	</table>
@@ -165,9 +164,11 @@
 	}
 }
 
-unset($session_users);
-unset($prev_id);
-unset($prev_ip);
+if (isset($session_users))
+{
+    unset($session_users);
+}
+unset($prev_id,$prev_ip);
 
 $this->content .= '
 <hr /><table >
@@ -210,7 +211,6 @@
 	<hr /><b>Members</b><br />
 '.(($who_where['user']) ? $who_where['user'] : '<em><b>&nbsp;None Online</b></em>').'<br /><b>Guests</b><br />
 '.(($who_where['guest']) ? $who_where['guest'] : '<em><b>&nbsp;None Online</b></em>').'
-		
 	</td>
   </tr>
 </table>';



