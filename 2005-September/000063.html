<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r143 - in cms/trunk: includes includes/db includes/display includes/forums includes/forums/mcp includes/templates includes/templates/en/email includes/templates/en/email/members_list includes/templates/modules/Contact includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Members_List includes/templates/modules/Quick_Message install javascript modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Forums/admin modules/Members_List
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-September/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r143%20-%20in%20cms/trunk%3A%20includes%20includes/db%20includes/display%20includes/forums%20includes/forums/mcp%20includes/templates%20includes/templates/en/email%20includes/templates/en/email/members_list%20includes/templates/modules/Contact%20includes/templates/modules/Control_Panel%20includes/templates/modules/Forums%20includes/templates/modules/Members_List%20includes/templates/modules/Quick_Message%20install%20javascript%20modules/Control_Panel%20modules/Control_Panel/ucp%20modules/Forums%20modules/Forums/admin%20modules/Members_List&In-Reply-To=%3C200509272358.j8RNw3gq020637%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000062.html">
   <LINK REL="Next"  HREF="000064.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r143 - in cms/trunk: includes includes/db includes/display includes/forums includes/forums/mcp includes/templates includes/templates/en/email includes/templates/en/email/members_list includes/templates/modules/Contact includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Members_List includes/templates/modules/Quick_Message install javascript modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Forums/admin modules/Members_List</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r143%20-%20in%20cms/trunk%3A%20includes%20includes/db%20includes/display%20includes/forums%20includes/forums/mcp%20includes/templates%20includes/templates/en/email%20includes/templates/en/email/members_list%20includes/templates/modules/Contact%20includes/templates/modules/Control_Panel%20includes/templates/modules/Forums%20includes/templates/modules/Members_List%20includes/templates/modules/Quick_Message%20install%20javascript%20modules/Control_Panel%20modules/Control_Panel/ucp%20modules/Forums%20modules/Forums/admin%20modules/Members_List&In-Reply-To=%3C200509272358.j8RNw3gq020637%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r143 - in cms/trunk: includes includes/db includes/display includes/forums includes/forums/mcp includes/templates includes/templates/en/email includes/templates/en/email/members_list includes/templates/modules/Contact includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Members_List includes/templates/modules/Quick_Message install javascript modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Forums/admin modules/Members_List">viperal at berlios.de
       </A><BR>
    <I>Wed Sep 28 01:58:03 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000062.html">[Viperals-svncheckins] r142 - in cms/trunk: includes includes/forums includes/templates/modules/Control_Panel modules/Control_Panel/ucp modules/Forums
</A></li>
        <LI>Next message: <A HREF="000064.html">[Viperals-svncheckins] r144 - in cms/trunk: . blocks includes/forums modules/Forums themes/viperal themes/viperal/template
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63">[ date ]</a>
              <a href="thread.html#63">[ thread ]</a>
              <a href="subject.html#63">[ subject ]</a>
              <a href="author.html#63">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-09-28 01:57:50 +0200 (Wed, 28 Sep 2005)
New Revision: 143

Added:
   cms/trunk/includes/templates/en/email/members_list/
   cms/trunk/includes/templates/en/email/members_list/email_notify.txt
   cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt
Modified:
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/confirmation.html
   cms/trunk/includes/templates/login_body.html
   cms/trunk/includes/templates/modules/Contact/index.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html
   cms/trunk/includes/templates/modules/Forums/overall_footer.html
   cms/trunk/includes/templates/modules/Forums/overall_header.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_header.html
   cms/trunk/includes/templates/modules/Quick_Message/index.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/common.js
   cms/trunk/javascript/menu.js
   cms/trunk/modules/Control_Panel/index.php
   cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
   cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
   cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
   cms/trunk/modules/Control_Panel/ucp/ucp_register.php
   cms/trunk/modules/Forums/admin/index.php
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/search.php
   cms/trunk/modules/Forums/viewtopic.php
   cms/trunk/modules/Members_List/index.php
Log:


Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/db/postgres.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -465,30 +465,32 @@
 
 		if (function_exists('pg_version'))
 		{
-			$version = pg_version($this-&gt;link_identifier);
-			return $version['server'];	
-		}
-		else
-		{
-			$result = $this-&gt;query('SELECT VERSION() AS version');
-			$row = $this-&gt;fetch_row_assoc($result);
-			$this-&gt;free_result($result);
+			$version = pg_version($this-&gt;link_identifier);
 
-			if (!$row)
+			if (isset($version['server']))
 			{
-				return;
-			}
-
-			if ($return_dbname)
-			{	// should we return the full info ?
-				return $row['version'];
-			}
-			else
-			{
-				$version = explode(' ', $row['version']);
-				return $version[1];
+				return $version['server'];
 			}
 		}
+
+		$result = $this-&gt;query('SELECT VERSION() AS version');
+		$row = $this-&gt;fetch_row_assoc($result);
+		$this-&gt;free_result($result);
+
+		if (!$row)
+		{
+			return;
+		}
+
+		if ($return_dbname)
+		{	// should we return the full info ?
+			return $row['version'];
+		}
+		else
+		{
+			$version = explode(' ', $row['version']);
+			return $version[1];
+		}
 	}
 
 	function _debug($mode, $backtrace)

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/display/display.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -169,7 +169,7 @@
 
 		$this-&gt;header['regular'][] = '&lt;link rel=&quot;alternate&quot; type=&quot;application/xml&quot; title=&quot;RSS&quot; href=&quot;'.generate_base_url().'feed.php?feed=rdf&quot; /&gt;';
 
-		if ($_CORE_CONFIG['maintenance']['active'] &amp;&amp; $_CORE_CONFIG['maintenance']['start'] &lt; time())
+		if ($_CORE_CONFIG['maintenance']['active'] &amp;&amp; $_CORE_CONFIG['maintenance']['start'] &lt; $_CLASS['core_user']-&gt;time)
 		{
 			$this-&gt;message = '&lt;b&gt;System is in maintenance mode&lt;/b&gt;&lt;br /&gt;';
 		}

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/auth.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -30,7 +30,7 @@
 
 // Will be keeping my eye of 'other products' to ensure these things don't
 // mysteriously appear elsewhere, think up your own solutions!
-class auth
+class forums_auth
 {
 	var $founder = false;
 	var $acl = array();
@@ -121,10 +121,12 @@
 
 	function acl_getf($opt)
 	{
-		static $cache;
+		$cache = false;
 
 		if (isset($this-&gt;acl_options['local'][$opt]))
 		{
+			$cache = array();
+
 			foreach ($this-&gt;acl as $f =&gt; $bitstring)
 			{
 				if (!isset($cache[$f][$opt]))
@@ -132,6 +134,7 @@
 					$cache[$f][$opt] = false;
 
 					$cache[$f][$opt] = $bitstring{$this-&gt;acl_options['local'][$opt]};
+
 					if (isset($this-&gt;acl_options['global'][$opt]))
 					{
 						$cache[$f][$opt] |= $this-&gt;acl[0]{$this-&gt;acl_options['global'][$opt]};

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -113,19 +113,19 @@
 }
 
 // Obtain authed forums list
-function get_forum_list($acl_list = 'f_list', $id_only = TRUE, $postable_only = FALSE, $no_cache = FALSE)
+function get_forum_list($acl_list = 'f_list', $id_only = true, $postable_only = false)
 {
 	global $_CLASS;
 	static $forum_rows;
+	
+//print_r($_CLASS['forums_auth']-&gt;acl_getf('f_read'));
 
-	if (!isset($forum_rows))
+	if (empty($forum_rows))
 	{
 		// This query is identical to the jumpbox one
-		$expire_time = ($no_cache) ? 0 : 120;
 		$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			ORDER BY left_id ASC';
-		$result = $_CLASS['core_db']-&gt;query($sql, $expire_time);
+			FROM ' . FORUMS_FORUMS_TABLE . ' ORDER BY left_id ASC';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
@@ -135,6 +135,7 @@
 	}
 
 	$rowset = array();
+
 	foreach ($forum_rows as $row)
 	{
 		if ($postable_only &amp;&amp; $row['forum_type'] != FORUM_POST)
@@ -142,7 +143,7 @@
 			continue;
 		}
 
-		if ($acl_list == '' || ($acl_list != '' &amp;&amp; $_CLASS['auth']-&gt;acl_gets($acl_list, $row['forum_id'])))
+		if (!$acl_list || $_CLASS['auth']-&gt;acl_gets($acl_list, $row['forum_id']))
 		{
 			$rowset[] = ($id_only) ? $row['forum_id'] : $row;
 		}
@@ -375,6 +376,7 @@
 	$_CLASS['core_db']-&gt;transaction();
 
 	$table_ary = array(FORUMS_TRACK_TABLE, FORUMS_POLL_VOTES_TABLE, FORUMS_POLL_OPTIONS_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE);
+
 	foreach ($table_ary as $table)
 	{
 		$sql = &quot;DELETE FROM $table 
@@ -990,7 +992,7 @@
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
-			break;
+		break;
 
 		case 'topic_attachment':
 			if ($sync_extra)
@@ -1859,9 +1861,9 @@
 }
 
 // Extension of auth class for changing permissions
-if (class_exists('auth'))
+if (class_exists('forums_auth'))
 {
-	class auth_admin extends auth
+	class auth_admin extends forums_auth
 	{
 		// Set a user or group ACL record
 		function acl_set($ug_type, &amp;$forum_id, &amp;$ug_id, &amp;$auth)

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,1451 +1,1489 @@
-&lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_privmsgs.php,v 1.7 2004/09/16 18:33:20 acydburn Exp $
-//
-// FILENAME  : functions_privmsgs.php
-// STARTED   : Sun Apr 18, 2004
-// COPYRIGHT : &#169; 2004 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// Define Rule processing schema
-// NOTE: might change
-
-/*
-	Ability to simply add own rules by doing three things:
-		1) Add an appropiate constant
-		2) Add a new check array to the global_privmsgs_rules variable and the condition array (if one is required)
-		3) Add a new language variable to ucp.php
-		
-		The user is then able to select the new rule. It will be checked against and handled as specified.
-		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
-*/
-
-define('RULE_IS_LIKE', 1); // Is Like
-define('RULE_IS_NOT_LIKE', 2); // Is Not Like
-define('RULE_IS', 3); // Is
-define('RULE_IS_NOT', 4); // Is Not
-define('RULE_BEGINS_WITH', 5); // Begins with
-define('RULE_ENDS_WITH', 6); // Ends with
-define('RULE_IS_FRIEND', 7); // Is Friend
-define('RULE_IS_FOE', 8); // Is Foe
-define('RULE_IS_USER', 9); // Is User
-define('RULE_IS_GROUP', 10); // Is In Usergroup
-define('RULE_ANSWERED', 11); // Answered
-define('RULE_FORWARDED', 12); // Forwarded
-define('RULE_REPORTED', 13); // Reported
-define('RULE_TO_GROUP', 14); // Usergroup
-define('RULE_TO_ME', 15); // Me
-
-define('ACTION_PLACE_INTO_FOLDER', 1);
-define('ACTION_MARK_AS_READ', 2);
-define('ACTION_MARK_AS_IMPORTANT', 3);
-define('ACTION_DELETE_MESSAGE', 4);
-
-define('CHECK_SUBJECT', 1);
-define('CHECK_SENDER', 2);
-define('CHECK_MESSAGE', 3);
-define('CHECK_STATUS', 4);
-define('CHECK_TO', 5);
-
-$global_privmsgs_rules = array(
-	CHECK_SUBJECT	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})')),
-
-	CHECK_SENDER	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'username', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})'),
-		RULE_IS_FRIEND		=&gt; array('check0' =&gt; 'friend', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_IS_FOE			=&gt; array('check0' =&gt; 'foe', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_IS_USER		=&gt; array('check0' =&gt; 'author_id', 'function' =&gt; '{CHECK0} == {USER_ID}'),
-		RULE_IS_GROUP       =&gt; array('check0' =&gt; 'author_in_group', 'function' =&gt; 'in_array({GROUP_ID}, {CHECK0})')),
-
-	CHECK_MESSAGE	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} != {STRING}')),
-		
-	CHECK_STATUS	=&gt; array(
-		RULE_ANSWERED		=&gt; array('check0' =&gt; 'replied', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_FORWARDED		=&gt; array('check0' =&gt; 'forwarded', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_REPORTED		=&gt; array('check0' =&gt; 'message_reported', 'function' =&gt; '{CHECK0} == 1')),
-		
-	CHECK_TO		=&gt; array(
-		RULE_TO_GROUP		=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'check2' =&gt; 'user_in_group', 'function' =&gt; 'in_array(&quot;g_&quot; . {CHECK2}, {CHECK0}) || in_array(&quot;g_&quot; . {CHECK2}, {CHECK1})'),
-		RULE_TO_ME			=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'function' =&gt; 'in_array(&quot;u_&quot; . $user_id, {CHECK0}) || in_array(&quot;u_&quot; . $user_id, {CHECK1})'))
-);
-
-// This is for defining which condition fields to show for which Rule
-$global_rule_conditions = array(
-	RULE_IS_LIKE		=&gt; 'text',
-	RULE_IS_NOT_LIKE	=&gt; 'text',
-	RULE_IS				=&gt; 'text',
-	RULE_IS_NOT			=&gt; 'text',
-	RULE_BEGINS_WITH	=&gt; 'text',
-	RULE_ENDS_WITH		=&gt; 'text',
-	RULE_IS_USER		=&gt; 'user',
-	RULE_IS_GROUP		=&gt; 'group'
-);
-
-// Get all folder
-function get_folder($user_id, &amp;$folder, $folder_id = false)
-{
-	global $_CLASS;
-
-	if (!is_array($folder))
-	{
-		$folder = array();
-	}
-
-	// Get folder informations
-	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-		WHERE user_id = $user_id
-			AND folder_id &lt;&gt; &quot; . PRIVMSGS_NO_BOX . '
-		GROUP BY folder_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$num_messages = $num_unread = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$num_messages[(int) $row['folder_id']] = $row['num_messages'];
-		$num_unread[(int) $row['folder_id']] = $row['num_unread'];
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	// Make sure the default boxes are defined
-	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
-	foreach ($folder_array as $default_folder)
-	{
-		if (!isset($num_messages[$default_folder]))
-		{
-			$num_messages[$default_folder] = 0;
-		}
-
-		if (!isset($num_unread[$default_folder]))
-		{
-			$num_unread[$default_folder] = 0;
-		}
-	}
-
-	// Adjust unread status for outbox
-	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
-	
-	$folder[PRIVMSGS_INBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_INBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_INBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_INBOX]);
-
-	// Custom Folder
-	$sql = 'SELECT folder_id, folder_name, pm_count
-		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
-			WHERE user_id = $user_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-			
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$folder[$row['folder_id']] = array('folder_name' =&gt; $row['folder_name'], 'num_messages' =&gt; $row['pm_count'], 'unread_messages' =&gt; ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$folder[PRIVMSGS_OUTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_OUTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_OUTBOX]);
-	$folder[PRIVMSGS_SENTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_SENTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_SENTBOX]);
-
-	// Define Folder Array for template designers (and for making custom folders usable by the template too)
-	foreach ($folder as $f_id =&gt; $folder_ary)
-	{
-		$_CLASS['core_template']-&gt;assign_vars_array('folder', array(
-			'FOLDER_ID'			=&gt; $f_id,
-			'FOLDER_NAME'		=&gt; $folder_ary['folder_name'],
-			'NUM_MESSAGES'		=&gt; $folder_ary['num_messages'],
-			'UNREAD_MESSAGES'	=&gt; $folder_ary['unread_messages'],
-
-			'S_CUR_FOLDER'		=&gt; ($f_id == $folder_id) ? true : false,
-			'S_UNREAD_MESSAGES'	=&gt; ($folder_ary['unread_messages']) ? true : false,
-			'S_CUSTOM_FOLDER'	=&gt; ($f_id &gt; 0) ? true : false)
-		);
-	}
-
-	return;
-}
-
-// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
-function clean_sentbox($num_sentbox_messages)
-{
-	global $_CLASS, $config;
-// TEMP
-$_CLASS['core_user']-&gt;data['user_message_limit'] = isset($_CLASS['core_user']-&gt;data['user_message_limit']) ? $_CLASS['core_user']-&gt;data['user_message_limit'] : false;
-	$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
-	
-	// Check Message Limit - 
-	if ($message_limit &amp;&amp; $num_sentbox_messages &gt; $message_limit)
-	{
-		// Delete old messages
-		$sql = 'SELECT t.msg_id
-			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
-			WHERE t.msg_id = p.msg_id
-				AND t.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
-			ORDER BY p.message_time ASC';
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, ($num_sentbox_messages - $message_limit));
-
-		$delete_ids = array();
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$delete_ids[] = $row['msg_id'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-		delete_pm($_CLASS['core_user']-&gt;data['user_id'], $delete_ids, PRIVMSGS_SENTBOX);
-	}
-}
-
-// Check Rule against Message Informations
-function check_rule(&amp;$rules, &amp;$rule_row, &amp;$message_row, $user_id)
-{
-	global $_CLASS, $config;
-
-	if (!isset($rules[$rule_row['rule_check']][$rule_row['rule_connection']]))
-	{
-		return false;
-	}
-
-	$check_ary = $rules[$rule_row['rule_check']][$rule_row['rule_connection']];
-
-	// Replace Check Literals
-	$evaluate = $check_ary['function'];
-	$evaluate = preg_replace('/{(CHECK[0-9])}/', '$message_row[$check_ary[strtolower(&quot;\1&quot;)]]', $evaluate);
-
-	// Replace Rule Literals
-	$evaluate = preg_replace('/{(STRING|USER_ID|GROUP_ID)}/', '$rule_row[&quot;rule_&quot; . strtolower(&quot;\1&quot;)]', $evaluate);
-
-	// Eval Statement
-	$result = false;
-	eval('$result = (' . $evaluate . ') ? true : false;');
-		
-	if (!$result)
-	{
-		return false;
-	}
-
-	switch ($rule_row['rule_action'])
-	{
-		case ACTION_PLACE_INTO_FOLDER:
-			return array('action' =&gt; $rule_row['rule_action'], 'folder_id' =&gt; $rule_row['rule_folder_id']);
-			break;
-		case ACTION_MARK_AS_READ:
-		case ACTION_MARK_AS_IMPORTANT:
-		case ACTION_DELETE_MESSAGE:
-			return array('action' =&gt; $rule_row['rule_action'], 'unread' =&gt; $row['unread'], 'important' =&gt; $row['important']);
-			break;
-		default:
-			return false;
-	}
-
-	return false;
-}
-
-// Place new messages into appropiate folder
-function place_pm_into_folder(&amp;$global_privmsgs_rules, $release = false)
-{
-	global $_CLASS, $config;
-
-	if (!$_CLASS['core_user']-&gt;data['user_new_privmsg'])
-	{
-		return;
-	}
-
-	$user_new_privmsg = (int) $_CLASS['core_user']-&gt;data['user_new_privmsg'];
-	$user_message_rules = (int) $_CLASS['core_user']-&gt;data['user_message_rules'];
-	$user_id = (int) $_CLASS['core_user']-&gt;data['user_id'];
-
-	$user_rules = $zebra = array();
-	if ($user_message_rules)
-	{
-		$sql = 'SELECT * 
-			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . &quot;
-			WHERE user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$user_rules = $_CLASS['core_db']-&gt;fetch_row_assocset($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (!empty($user_rules))
-		{
-			$sql = 'SELECT zebra_id, friend, foe
-				FROM ' . ZEBRA_TABLE . &quot;
-				WHERE user_id = $user_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$zebra[$row['zebra_id']] = $row;
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-	}
-
-	if ($release)
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_NO_BOX . '
-			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . &quot;
-				AND user_id = $user_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Get those messages not yet placed into any box
-	// NOTE: Expand Group Information to all groups the user/author is in? 
-	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . &quot; u
-		WHERE t.user_id = $user_id
-			AND p.author_id = u.user_id
-			AND t.folder_id = &quot; . PRIVMSGS_NO_BOX . '
-			AND t.msg_id = p.msg_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$action_ary = $move_into_folder = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$row['to']		= explode(':', $row['to_address']);
-		$row['bcc']		= explode(':', $row['bcc_address']);
-		$row['friend']	= (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['friend'] : 0;
-		$row['foe']		= (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['foe'] : 0;
-		$row['user_in_group'] = $_CLASS['core_user']-&gt;data['group_id'];
-						
-		// Check Rule - this should be very quick since we have all informations we need
-		$is_match = false;
-		foreach ($user_rules as $rule_row)
-		{
-			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
-			{
-				$is_match = true;
-				$action_ary[$row['msg_id']][] = $action;
-			}
-		}
-	
-		if (!$is_match)
-		{
-			$action_ary[$row['msg_id']][] = array('action' =&gt; false);
-			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	// We place actions into arrays, to save queries.
-	$num_new = $num_unread = 0;
-	$sql = $unread_ids = $delete_ids = $important_ids = array();
-
-	foreach ($action_ary as $msg_id =&gt; $msg_ary)
-	{
-		// It is allowed to execute actions more than once, except placing messages into folder
-		$folder_action = false;
-
-		foreach ($msg_ary as $pos =&gt; $rule_ary)
-		{
-			if ($folder_action &amp;&amp; $rule_ary['action'] == ACTION_PLACE_INTO_FOLDER)
-			{
-				continue;
-			}
-	
-			switch ($rule_ary['action'])
-			{
-				case ACTION_PLACE_INTO_FOLDER:
-					$folder_action = true;
-					$_folder_id = (int) $rule_ary['folder_id'];
-					$move_into_folder[$_folder_id][] = $msg_id;
-					$num_new++;
-					break;
-
-				case ACTION_MARK_AS_READ:
-					if ($rule_ary['unread'])
-					{
-						$unread_ids[] = $msg_id;
-					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
-					break;
-
-				case ACTION_DELETE_MESSAGE:
-					$delete_ids[] = $msg_id;
-					break;
-
-				case ACTION_MARK_AS_IMPORTANT:
-					if (!$rule_ary['important'])
-					{
-						$important_ids[] = $msg_id;
-					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
-					break;
-
-				default:
-			}
-		}
-	}
-
-	$num_new += sizeof(array_unique($delete_ids));
-	$num_unread += sizeof(array_unique($delete_ids));
-	$num_unread += sizeof(array_unique($unread_ids));
-
-	// Do not change the order of processing
-	// The number of queries needed to be executed here highly depends on the defined rules and are
-	// only gone through if new messages arrive.
-	$num_not_moved = 0;
-
-	// Delete messages
-	if (sizeof($delete_ids))
-	{
-		delete_pm($user_id, $delete_ids, PRIVMSGS_NO_BOX);
-	}
-
-	// Set messages to Unread
-	if (sizeof($unread_ids))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET unread = 0
-			WHERE msg_id IN (' . implode(', ', $unread_ids) . &quot;)
-				AND user_id = $user_id
-				AND folder_id = &quot; . PRIVMSGS_NO_BOX;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// mark messages as important
-	if (sizeof($important_ids))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET marked = !marked
-			WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
-				AND user_id = $user_id
-				AND msg_id IN (&quot; . implode(', ', $important_ids) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Move into folder
-	$folder = array();
-
-	if (sizeof($move_into_folder))
-	{
-		// Determine Full Folder Action - we need the move to folder id later eventually
-		$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
-
-		$sql = 'SELECT folder_id, pm_count 
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action &gt;= 0) ? ', ' . $full_folder_action : '') . &quot;)
-				AND user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
-		{
-			$sql = 'SELECT folder_id, COUNT(*) as num_messages
-				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-				WHERE user_id = $user_id
-					AND folder_id = &quot; . PRIVMSGS_INBOX . &quot;
-				GROUP BY folder_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-			
-			$folder[PRIVMSGS_INBOX] = (int) $_CLASS['core_db']-&gt;sql_fetchfield('num_messages', 0, $result);
-			$_CLASS['core_db']-&gt;free_result($result);			
-		}
-	}
-
-	// Here we have ideally only one folder to move into
-	$message_limit = (!$_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
-
-	foreach ($move_into_folder as $folder_id =&gt; $msg_ary)
-	{
-		$dest_folder = $folder_id;
-		$full_folder_action = FULL_FOLDER_NONE;
-
-		// Check Message Limit - we calculate with the complete array, most of the time it is one message
-		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
-		if ($message_limit &amp;&amp; $folder[$folder_id] &amp;&amp; ($folder[$folder_id] + sizeof($msg_ary)) &gt; $message_limit)
-		{
-			$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
-
-			// If destination folder itself is full...
-			if ($full_folder_action &gt;= 0 &amp;&amp; ($folder[$full_folder_action] + sizeof($msg_ary)) &gt; $message_limit)
-			{
-				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
-			}
-
-			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
-			if ($full_folder_action &gt;= 0)
-			{
-				$dest_folder = $full_folder_action;
-			}
-			else if ($full_folder_action == FULL_FOLDER_DELETE)
-			{
-				// Delete some messages ;)
-				$sql = 'SELECT t.msg_id
-					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
-					WHERE t.msg_id = p.msg_id
-						AND t.user_id = $user_id
-						AND t.folder_id = $dest_folder
-					ORDER BY p.message_time ASC&quot;;
-				$result = $_CLASS['core_db']-&gt;query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $message_limit));
-
-				$delete_ids = array();
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$delete_ids[] = $row['msg_id'];
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-				delete_pm($user_id, $delete_ids, $dest_folder);
-			}
-		}
-		
-		if ($full_folder_action == FULL_FOLDER_HOLD)
-		{
-			$num_not_moved += sizeof($msg_ary);
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
-				WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
-					AND user_id = $user_id
-					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		else
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
-				SET folder_id = $dest_folder, msg_new = 0
-				WHERE folder_id = &quot; . PRIVMSGS_NO_BOX . &quot;
-					AND user_id = $user_id
-					AND msg_new = 1
-					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			if ($dest_folder != PRIVMSGS_INBOX)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']-&gt;sql_affectedrows() . &quot;
-					WHERE folder_id = $dest_folder
-						AND user_id = $user_id&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-			else
-			{
-				$num_new += $_CLASS['core_db']-&gt;sql_affectedrows();
-			}
-		}
-	}
-
-	if (sizeof($action_ary))
-	{
-		// Move from OUTBOX to SENTBOX
-		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_SENTBOX . '
-			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql != '') ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-		
-		$_CLASS['core_db']-&gt;query('UPDATE ' . USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
-		$_CLASS['core_user']-&gt;data['user_new_privmsg'] -= $num_new;
-		$_CLASS['core_user']-&gt;data['user_unread_privmsg'] -= $num_unread;
-	}
-
-	return $num_not_moved;
-}
-
-// Move PM from one to another folder
-function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
-{
-	global $_CLASS;
-	
-	if (!is_array($move_msg_ids))
-	{
-		$move_msg_ids = array($move_msg_ids);
-	}
-	
-	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
-	{
-		return 0;
-	}
-	
-	// We have to check the destination folder ;)
-	if ($dest_folder !== PRIVMSGS_INBOX)
-	{
-		$sql = 'SELECT folder_id, folder_name, pm_count
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
-			WHERE folder_id = $dest_folder
-				AND user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (!$row)
-		{
-			trigger_error('NOT_AUTHORIZED');
-		}
-// is message limit per folder ?
-		if ($row['pm_count'] + count($move_msg_ids) &gt; $message_limit)
-		{
-			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '&lt;br /&gt;&lt;br /&gt;';
-			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'&quot;&gt;', '&lt;/a&gt;', $row['folder_name']);
-
-			trigger_error($message);
-		}
-	}
-	else
-	{
-		$sql = 'SELECT COUNT(*) as num_messages
-			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			WHERE folder_id = ' . PRIVMSGS_INBOX . &quot;
-				AND user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) &gt; $message_limit)
-		{
-			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']-&gt;lang['PM_INBOX']) . '&lt;br /&gt;&lt;br /&gt;';
-			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'&quot;&gt;', '&lt;/a&gt;', $_CLASS['core_user']-&gt;lang['PM_INBOX']);
-			trigger_error($message);
-		}
-	}
-
-	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-		SET folder_id = $dest_folder
-		WHERE folder_id = $cur_folder_id
-			AND user_id = $user_id
-			AND msg_id IN (&quot; . implode(', ', $move_msg_ids) . ')';
-
-	$_CLASS['core_db']-&gt;query($sql);
-	$num_moved = $_CLASS['core_db']-&gt;affected_rows();
-
-	// Update pm counts
-	if ($num_moved)
-	{
-// We should maybe add moving of atleast sentbox messages, maybe
-		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
-		if ($cur_folder_id !== PRIVMSGS_INBOX)
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
-				SET pm_count = pm_count - $num_moved
-				WHERE folder_id = $cur_folder_id
-					AND user_id = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		if ($dest_folder !== PRIVMSGS_INBOX)
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
-				SET pm_count = pm_count + $num_moved
-				WHERE folder_id = $dest_folder
-					AND user_id = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-
-	return $num_moved;
-}
-
-function set_read_status($read, $msg_id, $user_id, $folder_id)
-{
-	global $_CLASS;
-
-	if (empty($msg_id))
-	{
-		return;
-	}
-
-	$read = ($read) ? 0 : 1;
-
-	$sql_msg = is_array($msg_id) ? 'IN ('.implode(', ', $msg_id).')' : '= '.(int) $msg_id;
-
-	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
-		SET unread = $read
-		WHERE msg_id $sql_msg
-			AND user_id = $user_id
-			AND folder_id = $folder_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-	
-	$count = $_CLASS['core_db']-&gt;affected_rows();
-
-	if ($count)
-	{
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_unread_privmsg = user_unread_privmsg '.(($read) ? '+ ' : '- '). &quot; $count
-			WHERE user_id = $user_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-}
-
-// Handle all actions possible with marked messages
-function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
-{
-	global $_CLASS;
-
-	if (empty($msg_ids))
-	{
-		return;
-	}
-
-	switch ($mark_action)
-	{
-		case 'mark_important':
-
-			$mark_list = array();
-
-			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-				WHERE folder_id = $cur_folder_id
-					AND user_id = $user_id
-					AND msg_id IN (&quot; . implode(', ', $msg_ids) . ')';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$row['marked'] = ($row['marked']) ? 0 : 1;
-				$mark_list[$row['marked']][] = $row['msg_id'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if (empty($mark_list))
-			{
-				break;
-			}
-
-			foreach ($mark_list as $mark =&gt; $ids)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-					SET marked = $mark
-					WHERE msg_id IN (&quot; . implode(', ', $ids) . ')';
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-		break;
-
-		case 'delete_marked':
-			$hidden_fields = array('marked_msg_id' =&gt; $msg_ids, 'cur_folder_id' =&gt; $cur_folder_id, 'mark_option' =&gt; 'delete_marked', 'submit_mark' =&gt; true);
-
-			if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
-			{
-				delete_pm($user_id, $msg_ids, $cur_folder_id);
-				
-				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
-				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
-				$_CLASS['core_display']-&gt;meta_refresh(3, $redirect);
-				
-				trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FOLDER'], '&lt;a href=&quot;' . $redirect . '&quot;&gt;', '&lt;/a&gt;'));
-			}
-		break;
-
-		case 'export_as_xml':
-		case 'export_as_csv':
-		case 'export_as_txt':
-			$export_as = str_replace('export_as_', '', $mark_action);
-			break;
-
-		default:
-			return false;
-	}
-
-	return true;
-}
-
-// Delete PM(s)
-function delete_pm($user_id, $msg_ids, $folder_id)
-{
-	global $_CLASS;
-
-	$user_id	= (int) $user_id;
-	$folder_id	= (int) $folder_id;
-
-	if (!$user_id)
-	{
-		return false;
-	}
-
-	if (!is_array($msg_ids))
-	{
-		if (!$msg_ids)
-		{
-			return false;
-		}
-
-		$msg_ids = array($msg_ids);
-	}
-
-	if (empty($msg_ids))
-	{
-		return false;
-	}
-
-	// Get PM Informations for later deleting
-	$sql = 'SELECT msg_id, unread, msg_new
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . &quot;)
-			AND folder_id = $folder_id
-			AND user_id = $user_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$delete_rows = array();
-	$num_unread = $num_new = $num_deleted = 0;
-	
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$num_unread += ($row['unread']) ? 1 : 0;
-		$num_new += ($row['msg_new']) ? 1 : 0;
-
-		$delete_rows[$row['msg_id']] = 1;
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	unset($msg_ids);
-
-	if (empty($delete_rows))
-	{
-		return false;
-	}
-
-	// if no one has read the message yet (meaning it is in users outbox)
-	// then mark the message as deleted...
-	if ($folder_id === PRIVMSGS_OUTBOX)
-	{
-		// Remove PM from Outbox
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-			WHERE user_id = $user_id AND folder_id = &quot; . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		// Update PM Information for safety
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . &quot; SET message_text = ''
-			WHERE msg_id IN (&quot; . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		// Set delete flag for those intended to receive the PM
-		// We do not remove the message actually, to retain some basic informations (sent time for example)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET deleted = 1
-			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
-	}
-	else
-	{
-		// Delete Private Message Informations
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-			WHERE user_id = $user_id
-				AND folder_id = $folder_id
-				AND msg_id IN (&quot; . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
-	}
-
-	// if folder id is user defined folder then decrease pm_count
-	if (!in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX, PRIVMSGS_NO_BOX)))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot; 
-			SET pm_count = pm_count - $num_deleted 
-			WHERE folder_id = $folder_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql != '') ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-		
-		$_CLASS['core_db']-&gt;query('UPDATE ' . USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
-	}
-	
-	// Now we have to check which messages we can delete completely	
-	$sql = 'SELECT msg_id 
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		unset($delete_rows[$row['msg_id']]);
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$delete_ids = implode(', ', array_keys($delete_rows));
-
-	if ($delete_ids)
-	{
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TABLE . '
-			WHERE msg_id IN (' . $delete_ids . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-}
-
-// Rebuild message header
-function rebuild_header($check_ary)
-{
-	$address = array();
-
-	foreach ($check_ary as $check_type =&gt; $address_field)
-	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id =&gt; $type)
-		{
-			${$type}[] = (int) $match[2][$id];
-		}
-
-		foreach (array('u', 'g') as $type)
-		{
-			if (sizeof($$type))
-			{
-				foreach ($$type as $id)
-				{
-					$address[$type][$id] = $check_type;
-				}
-			}
-		}
-	}
-
-	return $address;
-}
-
-// Print out/Assign recipient informations
-function write_pm_addresses($check_ary, $author_id, $plaintext = false)
-{
-	global $_CLASS;
-
-	$addresses = array();
-	
-	foreach ($check_ary as $check_type =&gt; $address_field)
-	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id =&gt; $type)
-		{
-			${$type}[] = (int) $match[2][$id];
-		}
-
-		$address = array();
-		if (sizeof($u))
-		{
-			$sql = 'SELECT user_id, username, user_colour 
-				FROM ' . USERS_TABLE . '
-				WHERE user_id IN (' . implode(', ', $u) . ')
-					AND user_type = ' . USER_NORMAL;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
-				{
-					if ($plaintext)
-					{
-						$address[] = $row['username'];
-					}
-					else
-					{
-						$address['user'][$row['user_id']] = array('name' =&gt; $row['username'], 'colour' =&gt; $row['user_colour']);
-					}
-				}
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-
-		if (sizeof($g))
-		{
-			if ($plaintext)
-			{
-				$sql = 'SELECT group_name
-					FROM ' . GROUPS_TABLE . ' 
-						WHERE group_id IN (' . implode(', ', $g) . ')';
-				$result = $_CLASS['core_db']-&gt;query($sql);
-		
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
-					{
-						$address[] = $row['group_name'];
-					}
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-			}
-			else
-			{
-				$sql = 'SELECT g.group_id, g.group_name, g.group_colour, ug.user_id
-					FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
-						WHERE g.group_id IN (' . implode(', ', $g) . ')
-						AND g.group_id = ug.group_id
-						AND ug.user_pending = 0';
-				$result = $_CLASS['core_db']-&gt;query($sql);
-		
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					if (!isset($address['group'][$row['group_id']]))
-					{
-						if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
-						{
-							$address['group'][$row['group_id']] = array('name' =&gt; $row['group_name'], 'colour' =&gt; $row['group_colour']);
-						}
-					}
-	
-					if (isset($address['user'][$row['user_id']]))
-					{
-						$address['user'][$row['user_id']]['in_group'] = $row['group_id'];
-					}
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-			}
-		}
-
-		if (sizeof($address) &amp;&amp; !$plaintext)
-		{
-			$_CLASS['core_template']-&gt;assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
-
-			foreach ($address as $type =&gt; $adr_ary)
-			{
-				foreach ($adr_ary as $id =&gt; $row)
-				{
-					$_CLASS['core_template']-&gt;assign_vars_array($check_type . '_recipient', array(
-						'NAME'		=&gt; $row['name'],
-						'IS_GROUP'	=&gt; ($type == 'group'),
-						'IS_USER'	=&gt; ($type == 'user'),
-						'COLOUR'	=&gt; ($row['colour']) ? $row['colour'] : '',
-						'UG_ID'		=&gt; $id,
-						'U_VIEW'	=&gt; ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
-					);
-				}
-			}
-		}
-
-		$addresses[$check_type] = $address;
-	}
-
-	return $addresses;
-}
-
-// Get folder status
-function get_folder_status($folder_id, $folder)
-{
-	global $_CLASS, $config;
-
-	if (isset($folder[$folder_id]))
-	{
-		$folder = $folder[$folder_id];
-	}
-	else
-	{
-		return false;
-	}
-
-	$message_limit = (!$_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
-
-	$return = array(
-		'folder_name'	=&gt; $folder['folder_name'], 
-		'cur'			=&gt; $folder['num_messages'],
-		'remaining'		=&gt; $message_limit - $folder['num_messages'],
-		'max'			=&gt; $message_limit,
-		'percent'		=&gt; ($message_limit) ? round(($folder['num_messages'] / $message_limit) * 100) : 100
-	);
-
-	$return['message'] = sprintf($_CLASS['core_user']-&gt;lang['FOLDER_STATUS_MSG'], $return['percent'], $return['cur'], $return['max']);
-
-	return $return;
-}
-
-//
-// COMPOSE MESSAGES
-//
-
-// Submit PM
-function submit_pm($mode, $subject, &amp;$data, $update_message, $put_in_outbox = true)
-{
-	global $_CLASS, $config;
-
-	// We do not handle erasing posts here
-	if ($mode == 'delete')
-	{
-		return;
-	}
-
-	// Collect some basic informations about which tables and which rows to update/insert
-	$sql_data = array();
-	$root_level = 0;
-
-	// Recipient Informations
-	$recipients = $to = $bcc = array();
-
-	if ($mode != 'edit')
-	{
-		// Build Recipient List
-		// u|g =&gt; array($user_id =&gt; 'to'|'bcc')
-		foreach (array('u', 'g') as $ug_type)
-		{
-			if (isset($data['address_list'][$ug_type]) &amp;&amp; sizeof($data['address_list'][$ug_type]))
-			{
-				foreach ($data['address_list'][$ug_type] as $id =&gt; $field)
-				{
-					$field = ($field == 'to') ? 'to' : 'bcc';
-					if ($ug_type == 'u')
-					{
-						$recipients[$id] = $field;
-					}
-					${$field}[] = $ug_type . '_' . (int) $id;
-				}
-			}
-		}
-
-		if (isset($data['address_list']['g']) &amp;&amp; sizeof($data['address_list']['g']))
-		{
-			$sql = 'SELECT group_id, user_id
-				FROM ' . USER_GROUP_TABLE . '
-				WHERE group_id IN (' . implode(', ', array_keys($data['address_list']['g'])) . ')
-					AND user_pending = 0';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-	
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
-				$recipients[$row['user_id']] = $field;
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-
-		if (!sizeof($recipients))
-		{
-			trigger_error('NO_RECIPIENT');
-		}
-	}
-
-	$sql = '';
-	
-	switch ($mode)
-	{
-		case 'reply':
-		case 'quote':
-			$root_level = ($data['reply_from_root_level']) ? $data['reply_from_root_level'] : $data['reply_from_msg_id']; 
-
-			// Set message_replied switch for this user
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET replied = 1
-				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-					AND msg_id = ' . $data['reply_from_msg_id'];
-
-		case 'forward':
-		case 'post':
-			$sql_data = array(
-				'root_level'		=&gt; $root_level,
-				'author_id'			=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'icon_id'			=&gt; $data['icon_id'], 
-				'author_ip' 		=&gt; $_CLASS['core_user']-&gt;ip,
-				'message_time'		=&gt; $_CLASS['core_user']-&gt;time,
-				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
-				'enable_html' 		=&gt; $data['enable_html'],
-				'enable_smilies' 	=&gt; $data['enable_smilies'],
-				'enable_magic_url' 	=&gt; $data['enable_urls'],
-				'enable_sig' 		=&gt; $data['enable_sig'],
-				'message_subject'	=&gt; $subject,
-				'message_text' 		=&gt; $data['message'],
-				'message_checksum'	=&gt; $data['message_md5'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
-				'bbcode_uid'		=&gt; $data['bbcode_uid'],
-				'to_address'		=&gt; implode(':', $to),
-				'bcc_address'		=&gt; implode(':', $bcc)
-			);
-			break;
-
-		case 'edit':
-			$sql_data = array(
-				'icon_id'			=&gt; $data['icon_id'],
-				'message_edit_time'	=&gt; $_CLASS['core_user']-&gt;time,
-				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
-				'enable_html' 		=&gt; $data['enable_html'],
-				'enable_smilies' 	=&gt; $data['enable_smilies'],
-				'enable_magic_url' 	=&gt; $data['enable_urls'],
-				'enable_sig' 		=&gt; $data['enable_sig'],
-				'message_subject'	=&gt; $subject,
-				'message_text' 		=&gt; $data['message'],
-				'message_checksum'	=&gt; $data['message_md5'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
-				'bbcode_uid'		=&gt; $data['bbcode_uid']
-			);
-		break;
-	}
-
-	$_CLASS['core_db']-&gt;transaction();
-
-	if (!empty($sql_data))
-	{
-		if ($mode === 'post' || $mode === 'reply' || $mode === 'quote' || $mode === 'forward')
-		{
-			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data));
-			$data['msg_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_PRIVMSGS_TABLE, 'msg_id');
-		}
-		else if ($mode === 'edit')
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
-				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data) . ' 
-				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-	
-	if ($mode !== 'edit')
-	{
-		if ($sql)
-		{
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		foreach ($recipients as $user_id =&gt; $type)
-		{
-			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'msg_id'	=&gt; $data['msg_id'],
-				'user_id'	=&gt; $user_id,
-				'author_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-				'folder_id'	=&gt; PRIVMSGS_INBOX,
-				'msg_new'	=&gt; 1,
-				'unread'	=&gt; 1,
-				'forwarded'	=&gt; ($mode == 'forward') ? 1 : 0))
-			);
-		}
-
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
-			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		// Put PM into outbox
-		if ($put_in_outbox)
-		{
-			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'msg_id'	=&gt; (int) $data['msg_id'],
-				'user_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'author_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'folder_id'	=&gt; PRIVMSGS_OUTBOX,
-				'msg_new'	=&gt; 0,
-				'unread'	=&gt; 0,
-				'forwarded'	=&gt; ($mode == 'forward') ? 1 : 0))
-			);
-		}
-	}
-
-	// Set user last post time
-	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
-	{
-		$sql = 'UPDATE ' . USERS_TABLE . &quot;
-			SET user_last_post_time = {$_CLASS['core_user']-&gt;time}
-			WHERE user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Submit Attachments
-	if (!empty($data['attachment_data']) &amp;&amp; $data['msg_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
-	{
-		$space_taken = $files_added = 0;
-
-		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
-		{
-			if ($attach_row['attach_id'])
-			{
-				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot; 
-					SET comment = '&quot; . $_CLASS['core_db']-&gt;sql_escape($attach_row['comment']) . &quot;' 
-					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-			else
-			{
-				// insert attachment into db 
-				$attach_sql = array(
-					'post_msg_id'		=&gt; $data['msg_id'],
-					'download_count'	=&gt; 0,
-					'topic_id'			=&gt; 0,
-					'in_message'		=&gt; 1,
-					'poster_id'			=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
-					'real_filename'		=&gt; basename($attach_row['real_filename']),
-					'comment'			=&gt; $attach_row['comment'],
-					'extension'			=&gt; $attach_row['extension'],
-					'mimetype'			=&gt; $attach_row['mimetype'],
-					'filesize'			=&gt; $attach_row['filesize'],
-					'filetime'			=&gt; $attach_row['filetime'],
-					'thumbnail'			=&gt; $attach_row['thumbnail']
-				);
-
-				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql));
-
-				$space_taken += $attach_row['filesize'];
-
-				$files_added++;
-			}
-		}
-		
-		if (!empty($data['attachment_data']))
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
-				SET message_attachment = 1
-				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		if ($space_taken &amp;&amp; $files_added)
-		{
-			set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
-			set_config('num_files', $config['num_files'] + $files_added, true);
-		}
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-
-	// Delete draft if post was loaded...
-	$draft_id = request_var('draft_loaded', 0);
-
-	if ($draft_id)
-	{
-		$sql = 'DELETE FROM ' . DRAFTS_TABLE . &quot; 
-			WHERE draft_id = $draft_id 
-				AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Send Notifications
-	if ($mode != 'edit')
-	{
-		pm_notification($mode, stripslashes($_CLASS['core_user']-&gt;data['username']), $recipients, stripslashes($subject), stripslashes($data['message']));
-	}
-
-	return $data['msg_id'];
-}
-
-// PM Notification
-function pm_notification($mode, $author, $recipients, $subject, $message)
-{
-	global $_CLASS, $config;
-return;
-	$subject = censor_text($subject);
-	
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']-&gt;data['user_id']]);
-	
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (isset($row['ban_userid']))
-		{
-			unset($recipients[$row['ban_userid']]);
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if (!sizeof($recipients))
-	{
-		return;
-	}
-
-	$recipient_list = implode(', ', array_keys($recipients));
-
-	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
-		FROM ' . USERS_TABLE . &quot;
-		WHERE user_id IN ($recipient_list)&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$msg_list_ary = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if ($row['user_notify_pm'] == 1 &amp;&amp; trim($row['user_email']))
-		{
-			$msg_list_ary[] = array(
-				'method'	=&gt; $row['user_notify_type'],
-				'email'		=&gt; $row['user_email'],
-				'jabber'	=&gt; $row['user_jabber'],
-				'name'		=&gt; $row['username'],
-				'lang'		=&gt; $row['user_lang']
-			);
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-	
-	if (!sizeof($msg_list_ary))
-	{
-		return;
-	}
-
-	require_once('includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
-	$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
-
-	foreach ($msg_list_ary as $pos =&gt; $addr)
-	{
-		$messenger-&gt;template('privmsg_notify', $addr['lang']);
-
-		$messenger-&gt;replyto($config['board_email']);
-		$messenger-&gt;to($addr['email'], $addr['name']);
-		$messenger-&gt;im($addr['jabber'], $addr['name']);
-
-		$messenger-&gt;assign_vars(array(
-			'EMAIL_SIG'		=&gt; $email_sig,
-			'SITENAME'		=&gt; $config['sitename'],
-			'SUBJECT'		=&gt; $subject,
-			'AUTHOR_NAME'	=&gt; $author,
-			'USERNAME'		=&gt; $addr['name'],
-
-			'U_INBOX'		=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true)))
-		);
-
-		$messenger-&gt;send($addr['method']);
-		$messenger-&gt;reset();
-	}
-	unset($msg_list_ary);
-
-	if ($messenger-&gt;queue)
-	{
-		$messenger-&gt;save_queue();
-	}
-
-	unset($messenger);
-}
-
+&lt;?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright &#169; 2004 by Viperal									//
+//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: functions_privmsgs.php,v 1.7 2004/09/16 18:33:20 acydburn Exp $
+//
+// FILENAME  : functions_privmsgs.php
+// STARTED   : Sun Apr 18, 2004
+// COPYRIGHT : &#169; 2004 phpBB Group
+// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+// Define Rule processing schema
+// NOTE: might change
+
+/*
+	Ability to simply add own rules by doing three things:
+		1) Add an appropiate constant
+		2) Add a new check array to the global_privmsgs_rules variable and the condition array (if one is required)
+		3) Add a new language variable to ucp.php
+		
+		The user is then able to select the new rule. It will be checked against and handled as specified.
+		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
+*/
+
+define('RULE_IS_LIKE', 1); // Is Like
+define('RULE_IS_NOT_LIKE', 2); // Is Not Like
+define('RULE_IS', 3); // Is
+define('RULE_IS_NOT', 4); // Is Not
+define('RULE_BEGINS_WITH', 5); // Begins with
+define('RULE_ENDS_WITH', 6); // Ends with
+define('RULE_IS_FRIEND', 7); // Is Friend
+define('RULE_IS_FOE', 8); // Is Foe
+define('RULE_IS_USER', 9); // Is User
+define('RULE_IS_GROUP', 10); // Is In Usergroup
+define('RULE_ANSWERED', 11); // Answered
+define('RULE_FORWARDED', 12); // Forwarded
+define('RULE_REPORTED', 13); // Reported
+define('RULE_TO_GROUP', 14); // Usergroup
+define('RULE_TO_ME', 15); // Me
+
+define('ACTION_PLACE_INTO_FOLDER', 1);
+define('ACTION_MARK_AS_READ', 2);
+define('ACTION_MARK_AS_IMPORTANT', 3);
+define('ACTION_DELETE_MESSAGE', 4);
+
+define('CHECK_SUBJECT', 1);
+define('CHECK_SENDER', 2);
+define('CHECK_MESSAGE', 3);
+define('CHECK_STATUS', 4);
+define('CHECK_TO', 5);
+
+$global_privmsgs_rules = array(
+	CHECK_SUBJECT	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
+		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})')),
+
+	CHECK_SENDER	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'username', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
+		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})'),
+		RULE_IS_FRIEND		=&gt; array('check0' =&gt; 'friend', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_IS_FOE			=&gt; array('check0' =&gt; 'foe', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_IS_USER		=&gt; array('check0' =&gt; 'author_id', 'function' =&gt; '{CHECK0} == {USER_ID}'),
+		RULE_IS_GROUP       =&gt; array('check0' =&gt; 'author_in_group', 'function' =&gt; 'in_array({GROUP_ID}, {CHECK0})')),
+
+	CHECK_MESSAGE	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} != {STRING}')),
+		
+	CHECK_STATUS	=&gt; array(
+		RULE_ANSWERED		=&gt; array('check0' =&gt; 'replied', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_FORWARDED		=&gt; array('check0' =&gt; 'forwarded', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_REPORTED		=&gt; array('check0' =&gt; 'message_reported', 'function' =&gt; '{CHECK0} == 1')),
+		
+	CHECK_TO		=&gt; array(
+		RULE_TO_GROUP		=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'check2' =&gt; 'user_in_group', 'function' =&gt; 'in_array(&quot;g_&quot; . {CHECK2}, {CHECK0}) || in_array(&quot;g_&quot; . {CHECK2}, {CHECK1})'),
+		RULE_TO_ME			=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'function' =&gt; 'in_array(&quot;u_&quot; . $user_id, {CHECK0}) || in_array(&quot;u_&quot; . $user_id, {CHECK1})'))
+);
+
+// This is for defining which condition fields to show for which Rule
+$global_rule_conditions = array(
+	RULE_IS_LIKE		=&gt; 'text',
+	RULE_IS_NOT_LIKE	=&gt; 'text',
+	RULE_IS				=&gt; 'text',
+	RULE_IS_NOT			=&gt; 'text',
+	RULE_BEGINS_WITH	=&gt; 'text',
+	RULE_ENDS_WITH		=&gt; 'text',
+	RULE_IS_USER		=&gt; 'user',
+	RULE_IS_GROUP		=&gt; 'group'
+);
+
+// Get all folder
+function get_folder($user_id, &amp;$folder, $folder_id = false)
+{
+	global $_CLASS;
+
+	if (!is_array($folder))
+	{
+		$folder = array();
+	}
+
+	// Get folder informations
+	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+		WHERE user_id = $user_id
+			AND folder_id &lt;&gt; &quot; . PRIVMSGS_NO_BOX . '
+		GROUP BY folder_id';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$num_messages = $num_unread = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$num_messages[(int) $row['folder_id']] = $row['num_messages'];
+		$num_unread[(int) $row['folder_id']] = $row['num_unread'];
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	// Make sure the default boxes are defined
+	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
+	foreach ($folder_array as $default_folder)
+	{
+		if (!isset($num_messages[$default_folder]))
+		{
+			$num_messages[$default_folder] = 0;
+		}
+
+		if (!isset($num_unread[$default_folder]))
+		{
+			$num_unread[$default_folder] = 0;
+		}
+	}
+
+	// Adjust unread status for outbox
+	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
+	
+	$folder[PRIVMSGS_INBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_INBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_INBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_INBOX]);
+
+	// Custom Folder
+	$sql = 'SELECT folder_id, folder_name, pm_count
+		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+			WHERE user_id = $user_id&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+			
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$folder[$row['folder_id']] = array('folder_name' =&gt; $row['folder_name'], 'num_messages' =&gt; $row['pm_count'], 'unread_messages' =&gt; ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	$folder[PRIVMSGS_OUTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_OUTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_OUTBOX]);
+	$folder[PRIVMSGS_SENTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_SENTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_SENTBOX]);
+
+	// Define Folder Array for template designers (and for making custom folders usable by the template too)
+	foreach ($folder as $f_id =&gt; $folder_ary)
+	{
+		$_CLASS['core_template']-&gt;assign_vars_array('folder', array(
+			'FOLDER_ID'			=&gt; $f_id,
+			'FOLDER_NAME'		=&gt; $folder_ary['folder_name'],
+			'NUM_MESSAGES'		=&gt; $folder_ary['num_messages'],
+			'UNREAD_MESSAGES'	=&gt; $folder_ary['unread_messages'],
+
+			'S_CUR_FOLDER'		=&gt; ($f_id == $folder_id) ? true : false,
+			'S_UNREAD_MESSAGES'	=&gt; ($folder_ary['unread_messages']) ? true : false,
+			'S_CUSTOM_FOLDER'	=&gt; ($f_id &gt; 0) ? true : false)
+		);
+	}
+
+	return;
+}
+
+// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
+function clean_sentbox($num_sentbox_messages)
+{
+	global $_CLASS, $config;
+
+	$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
+	
+	// Check Message Limit - 
+	if ($message_limit &amp;&amp; $num_sentbox_messages &gt; $message_limit)
+	{
+		// Delete old messages
+		$sql = 'SELECT t.msg_id
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
+			WHERE t.msg_id = p.msg_id
+				AND t.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
+			ORDER BY p.message_time ASC';
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, ($num_sentbox_messages - $message_limit));
+
+		$delete_ids = array();
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$delete_ids[] = $row['msg_id'];
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$_CLASS['core_db']-&gt;transaction();
+
+		delete_pm($_CLASS['core_user']-&gt;data['user_id'], $delete_ids, PRIVMSGS_SENTBOX);
+
+		$_CLASS['core_db']-&gt;transaction('commit');
+	}
+}
+
+// Check Rule against Message Informations
+function check_rule(&amp;$rules, &amp;$rule_row, &amp;$message_row, $user_id)
+{
+	global $_CLASS, $config;
+
+	if (!isset($rules[$rule_row['rule_check']][$rule_row['rule_connection']]))
+	{
+		return false;
+	}
+
+	$check_ary = $rules[$rule_row['rule_check']][$rule_row['rule_connection']];
+
+	// Replace Check Literals
+	$evaluate = $check_ary['function'];
+	$evaluate = preg_replace('/{(CHECK[0-9])}/', '$message_row[$check_ary[strtolower(&quot;\1&quot;)]]', $evaluate);
+
+	// Replace Rule Literals
+	$evaluate = preg_replace('/{(STRING|USER_ID|GROUP_ID)}/', '$rule_row[&quot;rule_&quot; . strtolower(&quot;\1&quot;)]', $evaluate);
+
+	// Eval Statement
+	$result = false;
+	eval('$result = (' . $evaluate . ') ? true : false;');
+		
+	if (!$result)
+	{
+		return false;
+	}
+
+	switch ($rule_row['rule_action'])
+	{
+		case ACTION_PLACE_INTO_FOLDER:
+			return array('action' =&gt; $rule_row['rule_action'], 'folder_id' =&gt; $rule_row['rule_folder_id']);
+			break;
+		case ACTION_MARK_AS_READ:
+		case ACTION_MARK_AS_IMPORTANT:
+		case ACTION_DELETE_MESSAGE:
+			return array('action' =&gt; $rule_row['rule_action'], 'unread' =&gt; $row['unread'], 'important' =&gt; $row['important']);
+			break;
+		default:
+			return false;
+	}
+
+	return false;
+}
+
+// Place new messages into appropiate folder
+function place_pm_into_folder(&amp;$global_privmsgs_rules, $release = false)
+{
+	global $_CLASS, $config;
+
+	if (!$_CLASS['core_user']-&gt;data['user_new_privmsg'])
+	{
+		return;
+	}
+$_CLASS['core_user']-&gt;data['user_message_rules'] = 0;
+$_CLASS['core_user']-&gt;data['user_full_folder'] = FULL_FOLDER_NONE;
+
+	$user_new_privmsg = (int) $_CLASS['core_user']-&gt;data['user_new_privmsg'];
+	$user_message_rules = (int) $_CLASS['core_user']-&gt;data['user_message_rules'];
+	$user_id = (int) $_CLASS['core_user']-&gt;data['user_id'];
+
+	$user_rules = $zebra = array();
+
+	if ($user_message_rules)
+	{
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . &quot;
+			WHERE user_id = $user_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$user_rules[] = $row;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (!empty($user_rules))
+		{
+			$sql = 'SELECT zebra_id, friend, foe
+				FROM ' . ZEBRA_TABLE . &quot;
+				WHERE user_id = $user_id&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$zebra[$row['zebra_id']] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+	}
+
+// I don't like no box
+	/*
+	if ($release)
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_NO_BOX . '
+			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . &quot;
+				AND user_id = $user_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	*/
+
+	// Get those messages not yet placed into any box
+	// NOTE: Expand Group Information to all groups the user/author is in? 
+	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . &quot; u
+		WHERE t.user_id = $user_id
+			AND p.author_id = u.user_id
+			AND t.folder_id = &quot; . PRIVMSGS_NO_BOX . '
+			AND t.msg_id = p.msg_id';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$action_ary = $move_into_folder = array();
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$row['to']		= explode(':', $row['to_address']);
+		$row['bcc']		= explode(':', $row['bcc_address']);
+		$row['friend']	= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['friend'] : 0;
+		$row['foe']		= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['foe'] : 0;
+		$row['user_in_group'] = $_CLASS['core_user']-&gt;data['user_group'];
+		
+		// Check Rule - this should be very quick since we have all informations we need
+		$is_match = false;
+
+		foreach ($user_rules as $rule_row)
+		{
+			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
+			{
+				$is_match = true;
+				$action_ary[$row['msg_id']][] = $action;
+			}
+		}
+	
+		if (!$is_match)
+		{
+			$action_ary[$row['msg_id']][] = array('action' =&gt; false);
+			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
+		}
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	// We place actions into arrays, to save queries.
+	$num_new = $num_unread = 0;
+	$sql = $unread_ids = $delete_ids = $important_ids = array();
+
+	foreach ($action_ary as $msg_id =&gt; $msg_ary)
+	{
+		// It is allowed to execute actions more than once, except placing messages into folder
+		$folder_action = false;
+
+		foreach ($msg_ary as $pos =&gt; $rule_ary)
+		{
+			if ($folder_action &amp;&amp; $rule_ary['action'] == ACTION_PLACE_INTO_FOLDER)
+			{
+				continue;
+			}
+
+			switch ($rule_ary['action'])
+			{
+				case ACTION_PLACE_INTO_FOLDER:
+					$folder_action = true;
+					$_folder_id = (int) $rule_ary['folder_id'];
+					$move_into_folder[$_folder_id][] = $msg_id;
+					$num_new++;
+				break;
+
+				case ACTION_MARK_AS_READ:
+					if ($rule_ary['unread'])
+					{
+						$unread_ids[] = $msg_id;
+					}
+					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+				break;
+
+				case ACTION_DELETE_MESSAGE:
+					$delete_ids[] = $msg_id;
+				break;
+
+				case ACTION_MARK_AS_IMPORTANT:
+					if (!$rule_ary['important'])
+					{
+						$important_ids[] = $msg_id;
+					}
+					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+				break;
+			}
+		}
+	}
+
+	$num_new += count(array_unique($delete_ids));
+	$num_unread += count(array_unique($delete_ids));
+	$num_unread += count(array_unique($unread_ids));
+
+	// Do not change the order of processing
+	// The number of queries needed to be executed here highly depends on the defined rules and are
+	// only gone through if new messages arrive.
+	$num_not_moved = 0;
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	// Delete messages
+	if (!empty($delete_ids))
+	{
+		delete_pm($user_id, $delete_ids, PRIVMSGS_NO_BOX);
+	}
+
+	// Set messages to Unread
+	if (!empty($unread_ids))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET unread = 0
+			WHERE msg_id IN (' . implode(', ', $unread_ids) . &quot;)
+				AND user_id = $user_id
+				AND folder_id = &quot; . PRIVMSGS_NO_BOX;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// mark messages as important
+	if (!empty($important_ids))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			SET marked = 1
+			WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
+				AND user_id = $user_id
+				AND msg_id IN (&quot; . implode(', ', $important_ids) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Move into folder
+	$folder = array();
+
+	if (!empty($move_into_folder))
+	{
+		// Determine Full Folder Action - we need the move to folder id later eventually
+		$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
+
+		$sql = 'SELECT folder_id, pm_count 
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action &gt;= 0) ? ', ' . $full_folder_action : '') . &quot;)
+				AND user_id = $user_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
+		{
+			$sql = 'SELECT COUNT(*) as num_messages
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+				WHERE user_id = $user_id
+					AND folder_id = &quot; . PRIVMSGS_INBOX;
+
+			$result = $_CLASS['core_db']-&gt;query_limit($sql);
+			list($count) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+			$_CLASS['core_db']-&gt;free_result($result);	
+
+			$folder[PRIVMSGS_INBOX] = (int) $count;
+		}
+	}
+
+	// Here we have ideally only one folder to move into
+	$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $_CLASS['core_user']-&gt;data['user_message_limit'] : $config['pm_max_msgs'];
+
+	foreach ($move_into_folder as $folder_id =&gt; $msg_ary)
+	{
+		$dest_folder = $folder_id;
+		$full_folder_action = FULL_FOLDER_NONE;
+
+		// Check Message Limit - we calculate with the complete array, most of the time it is one message
+		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
+		if ($message_limit &amp;&amp; $folder[$folder_id] &amp;&amp; ($folder[$folder_id] + count($msg_ary)) &gt; $message_limit)
+		{
+			$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
+
+			// If destination folder itself is full...
+			if ($full_folder_action &gt;= 0 &amp;&amp; ($folder[$full_folder_action] + count($msg_ary)) &gt; $message_limit)
+			{
+				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
+			}
+
+			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
+			if ($full_folder_action &gt;= 0)
+			{
+				$dest_folder = $full_folder_action;
+			}
+			elseif ($full_folder_action == FULL_FOLDER_DELETE)
+			{
+				// Delete some messages ;)
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
+					WHERE t.msg_id = p.msg_id
+						AND t.user_id = $user_id
+						AND t.folder_id = $dest_folder
+					ORDER BY p.message_time ASC&quot;;
+				$result = $_CLASS['core_db']-&gt;query_limit($sql, (($folder[$dest_folder] + count($msg_ary)) - $message_limit));
+
+				$delete_ids = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$delete_ids[] = $row['msg_id'];
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+				delete_pm($user_id, $delete_ids, $dest_folder);
+			}
+		}
+
+		if ($full_folder_action == FULL_FOLDER_HOLD)
+		{
+			$num_not_moved += count($msg_ary);
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
+				WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
+					AND user_id = $user_id
+					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+		else
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
+				SET folder_id = $dest_folder, msg_new = 0
+				WHERE folder_id = &quot; . PRIVMSGS_NO_BOX . &quot;
+					AND user_id = $user_id
+					AND msg_new = 1
+					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']-&gt;query($sql);
+
+			if ($dest_folder != PRIVMSGS_INBOX)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']-&gt;affected_rows() . &quot;
+					WHERE folder_id = $dest_folder
+						AND user_id = $user_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			else
+			{
+				$num_new += $_CLASS['core_db']-&gt;affected_rows();
+			}
+		}
+	}
+
+	if (!empty($action_ary))
+	{
+		// Move from OUTBOX to SENTBOX
+		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_SENTBOX . '
+			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql) ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+
+		$_CLASS['core_db']-&gt;query('UPDATE ' . USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
+
+		$_CLASS['core_user']-&gt;data['user_new_privmsg'] -= $num_new;
+		$_CLASS['core_user']-&gt;data['user_unread_privmsg'] -= $num_unread;
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	return $num_not_moved;
+}
+
+// Move PM from one to another folder
+function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
+{
+	global $_CLASS;
+	
+	if (!is_array($move_msg_ids))
+	{
+		$move_msg_ids = array($move_msg_ids);
+	}
+	
+	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
+	{
+		return 0;
+	}
+	
+	// We have to check the destination folder ;)
+	if ($dest_folder !== PRIVMSGS_INBOX)
+	{
+		$sql = 'SELECT folder_id, folder_name, pm_count
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+			WHERE folder_id = $dest_folder
+				AND user_id = $user_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (!$row)
+		{
+			trigger_error('NOT_AUTHORIZED');
+		}
+// is message limit per folder ?
+		if ($row['pm_count'] + count($move_msg_ids) &gt; $message_limit)
+		{
+			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '&lt;br /&gt;&lt;br /&gt;';
+			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'&quot;&gt;', '&lt;/a&gt;', $row['folder_name']);
+
+			trigger_error($message);
+		}
+	}
+	else
+	{
+		$sql = 'SELECT COUNT(*) as num_messages
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			WHERE folder_id = ' . PRIVMSGS_INBOX . &quot;
+				AND user_id = $user_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) &gt; $message_limit)
+		{
+			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']-&gt;lang['PM_INBOX']) . '&lt;br /&gt;&lt;br /&gt;';
+			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'&quot;&gt;', '&lt;/a&gt;', $_CLASS['core_user']-&gt;lang['PM_INBOX']);
+			trigger_error($message);
+		}
+	}
+
+	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+		SET folder_id = $dest_folder
+		WHERE folder_id = $cur_folder_id
+			AND user_id = $user_id
+			AND msg_id IN (&quot; . implode(', ', $move_msg_ids) . ')';
+
+	$_CLASS['core_db']-&gt;query($sql);
+	$num_moved = $_CLASS['core_db']-&gt;affected_rows();
+
+	// Update pm counts
+	if ($num_moved)
+	{
+// We should maybe add moving of atleast sentbox messages, maybe
+		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
+		if ($cur_folder_id !== PRIVMSGS_INBOX)
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+				SET pm_count = pm_count - $num_moved
+				WHERE folder_id = $cur_folder_id
+					AND user_id = $user_id&quot;;
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
+		if ($dest_folder !== PRIVMSGS_INBOX)
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+				SET pm_count = pm_count + $num_moved
+				WHERE folder_id = $dest_folder
+					AND user_id = $user_id&quot;;
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+
+	return $num_moved;
+}
+
+function set_read_status($read, $msg_id, $user_id, $folder_id)
+{
+	global $_CLASS;
+
+	if (empty($msg_id))
+	{
+		return;
+	}
+
+	$read = ($read) ? 0 : 1;
+
+	$sql_msg = is_array($msg_id) ? 'IN ('.implode(', ', $msg_id).')' : '= '.(int) $msg_id;
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
+		SET unread = $read
+		WHERE msg_id $sql_msg
+			AND user_id = $user_id
+			AND folder_id = $folder_id&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+	
+	$count = $_CLASS['core_db']-&gt;affected_rows();
+
+	if ($count)
+	{
+		$sql = 'UPDATE ' . USERS_TABLE . ' 
+			SET user_unread_privmsg = user_unread_privmsg '.(($read) ? '+ ' : '- '). &quot; $count
+			WHERE user_id = $user_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	
+	$_CLASS['core_db']-&gt;transaction('commit');
+}
+
+// Handle all actions possible with marked messages
+function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
+{
+	global $_CLASS;
+
+	if (empty($msg_ids))
+	{
+		return;
+	}
+
+	switch ($mark_action)
+	{
+		case 'mark_important':
+
+			$mark_list = array();
+
+			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+				WHERE folder_id = $cur_folder_id
+					AND user_id = $user_id
+					AND msg_id IN (&quot; . implode(', ', $msg_ids) . ')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$row['marked'] = ($row['marked']) ? 0 : 1;
+				$mark_list[$row['marked']][] = $row['msg_id'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (empty($mark_list))
+			{
+				break;
+			}
+
+			$_CLASS['core_db']-&gt;transaction();
+
+			foreach ($mark_list as $mark =&gt; $ids)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+					SET marked = $mark
+					WHERE msg_id IN (&quot; . implode(', ', $ids) . ')';
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+
+			$_CLASS['core_db']-&gt;transaction('commit');
+		break;
+
+		case 'delete_marked':
+			$hidden_fields = array('marked_msg_id' =&gt; $msg_ids, 'cur_folder_id' =&gt; $cur_folder_id, 'mark_option' =&gt; 'delete_marked', 'submit_mark' =&gt; true);
+
+			if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
+			{
+				$_CLASS['core_db']-&gt;transaction();
+
+				delete_pm($user_id, $msg_ids, $cur_folder_id);
+
+				$_CLASS['core_db']-&gt;transaction('commit');
+
+				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
+				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
+				$_CLASS['core_display']-&gt;meta_refresh(3, $redirect);
+				
+				trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FOLDER'], '&lt;a href=&quot;' . $redirect . '&quot;&gt;', '&lt;/a&gt;'));
+			}
+		break;
+
+		/*
+		case 'export_as_xml':
+		case 'export_as_csv':
+		case 'export_as_txt':
+			$export_as = str_replace('export_as_', '', $mark_action);
+		break;
+		*/
+
+		default:
+			return false;
+		break;
+	}
+
+	return true;
+}
+
+// Delete PM(s)
+function delete_pm($user_id, $msg_ids, $folder_id)
+{
+	global $_CLASS;
+
+	$user_id	= (int) $user_id;
+	$folder_id	= (int) $folder_id;
+
+	if (!$user_id)
+	{
+		return false;
+	}
+
+	if (!is_array($msg_ids))
+	{
+		if (!$msg_ids)
+		{
+			return false;
+		}
+
+		$msg_ids = array($msg_ids);
+	}
+
+	if (empty($msg_ids))
+	{
+		return false;
+	}
+
+	// Get PM Informations for later deleting
+	$sql = 'SELECT msg_id, unread, msg_new
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . &quot;)
+			AND folder_id = $folder_id
+			AND user_id = $user_id&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$delete_rows = array();
+	$num_unread = $num_new = $num_deleted = 0;
+	
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$num_unread += ($row['unread']) ? 1 : 0;
+		$num_new += ($row['msg_new']) ? 1 : 0;
+
+		$delete_rows[$row['msg_id']] = 1;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	unset($msg_ids);
+
+	if (empty($delete_rows))
+	{
+		return false;
+	}
+
+	// if no one has read the message yet (meaning it is in users outbox)
+	// then mark the message as deleted...
+	if ($folder_id === PRIVMSGS_OUTBOX)
+	{
+		// Remove PM from Outbox
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+			WHERE user_id = $user_id AND folder_id = &quot; . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Update PM Information for safety
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . &quot; SET message_text = ''
+			WHERE msg_id IN (&quot; . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Set delete flag for those intended to receive the PM
+		// We do not remove the message actually, to retain some basic informations (sent time for example)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			SET deleted = 1
+			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
+	}
+	else
+	{
+		// Delete Private Message Informations
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+			WHERE user_id = $user_id
+				AND folder_id = $folder_id
+				AND msg_id IN (&quot; . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
+	}
+
+	// if folder id is user defined folder then decrease pm_count
+	if (!in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX, PRIVMSGS_NO_BOX)))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot; 
+			SET pm_count = pm_count - $num_deleted 
+			WHERE folder_id = $folder_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql != '') ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+		
+		$_CLASS['core_db']-&gt;query('UPDATE ' . USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
+	}
+	
+	// Now we have to check which messages we can delete completely	
+	$sql = 'SELECT msg_id 
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		unset($delete_rows[$row['msg_id']]);
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	$delete_ids = implode(', ', array_keys($delete_rows));
+
+	if ($delete_ids)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TABLE . '
+			WHERE msg_id IN (' . $delete_ids . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+}
+
+// Rebuild message header
+function rebuild_header($check_ary)
+{
+	$address = array();
+
+	foreach ($check_ary as $check_type =&gt; $address_field)
+	{
+		// Split Addresses into users and groups
+		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+
+		$u = $g = array();
+		foreach ($match[1] as $id =&gt; $type)
+		{
+			${$type}[] = (int) $match[2][$id];
+		}
+
+		foreach (array('u', 'g') as $type)
+		{
+			if (sizeof($$type))
+			{
+				foreach ($$type as $id)
+				{
+					$address[$type][$id] = $check_type;
+				}
+			}
+		}
+	}
+
+	return $address;
+}
+
+// Print out/Assign recipient informations
+function write_pm_addresses($check_ary, $author_id, $plaintext = false)
+{
+	global $_CLASS;
+
+	$addresses = array();
+	
+	foreach ($check_ary as $check_type =&gt; $address_field)
+	{
+		// Split Addresses into users and groups
+		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+
+		$u = $g = array();
+		foreach ($match[1] as $id =&gt; $type)
+		{
+			${$type}[] = (int) $match[2][$id];
+		}
+
+		$address = array();
+		if (sizeof($u))
+		{
+			$sql = 'SELECT user_id, username, user_colour 
+				FROM ' . USERS_TABLE . '
+				WHERE user_id IN (' . implode(', ', $u) . ')
+					AND user_type = ' . USER_NORMAL;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
+				{
+					if ($plaintext)
+					{
+						$address[] = $row['username'];
+					}
+					else
+					{
+						$address['user'][$row['user_id']] = array('name' =&gt; $row['username'], 'colour' =&gt; $row['user_colour']);
+					}
+				}
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		if (sizeof($g))
+		{
+			if ($plaintext)
+			{
+				$sql = 'SELECT group_name
+					FROM ' . GROUPS_TABLE . ' 
+						WHERE group_id IN (' . implode(', ', $g) . ')';
+				$result = $_CLASS['core_db']-&gt;query($sql);
+		
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
+					{
+						$address[] = $row['group_name'];
+					}
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+			else
+			{
+				$sql = 'SELECT g.group_id, g.group_name, g.group_colour, ug.user_id
+					FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
+						WHERE g.group_id IN (' . implode(', ', $g) . ')
+						AND g.group_id = ug.group_id
+						AND ug.user_pending = 0';
+				$result = $_CLASS['core_db']-&gt;query($sql);
+		
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					if (!isset($address['group'][$row['group_id']]))
+					{
+						if ($check_type == 'to' || $author_id == $_CLASS['core_user']-&gt;data['user_id'] || $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id'])
+						{
+							$address['group'][$row['group_id']] = array('name' =&gt; $row['group_name'], 'colour' =&gt; $row['group_colour']);
+						}
+					}
+	
+					if (isset($address['user'][$row['user_id']]))
+					{
+						$address['user'][$row['user_id']]['in_group'] = $row['group_id'];
+					}
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+		}
+
+		if (sizeof($address) &amp;&amp; !$plaintext)
+		{
+			$_CLASS['core_template']-&gt;assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
+
+			foreach ($address as $type =&gt; $adr_ary)
+			{
+				foreach ($adr_ary as $id =&gt; $row)
+				{
+					$_CLASS['core_template']-&gt;assign_vars_array($check_type . '_recipient', array(
+						'NAME'		=&gt; $row['name'],
+						'IS_GROUP'	=&gt; ($type == 'group'),
+						'IS_USER'	=&gt; ($type == 'user'),
+						'COLOUR'	=&gt; ($row['colour']) ? $row['colour'] : '',
+						'UG_ID'		=&gt; $id,
+						'U_VIEW'	=&gt; ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
+					);
+				}
+			}
+		}
+
+		$addresses[$check_type] = $address;
+	}
+
+	return $addresses;
+}
+
+// Get folder status
+function get_folder_status($folder_id, $folder)
+{
+	global $_CLASS, $config;
+
+	if (isset($folder[$folder_id]))
+	{
+		$folder = $folder[$folder_id];
+	}
+	else
+	{
+		return false;
+	}
+
+	$message_limit = (!$_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
+
+	$return = array(
+		'folder_name'	=&gt; $folder['folder_name'], 
+		'cur'			=&gt; $folder['num_messages'],
+		'remaining'		=&gt; $message_limit - $folder['num_messages'],
+		'max'			=&gt; $message_limit,
+		'percent'		=&gt; ($message_limit) ? round(($folder['num_messages'] / $message_limit) * 100) : 100
+	);
+
+	$return['message'] = sprintf($_CLASS['core_user']-&gt;lang['FOLDER_STATUS_MSG'], $return['percent'], $return['cur'], $return['max']);
+
+	return $return;
+}
+
+//
+// COMPOSE MESSAGES
+//
+
+// Submit PM
+function submit_pm($mode, $subject, &amp;$data, $update_message, $put_in_outbox = true)
+{
+	global $_CLASS, $config;
+
+	// We do not handle erasing posts here
+	if ($mode == 'delete')
+	{
+		return;
+	}
+
+	// Collect some basic informations about which tables and which rows to update/insert
+	$sql_data = array();
+	$root_level = 0;
+
+	// Recipient Informations
+	$recipients = $to = $bcc = array();
+
+	if ($mode != 'edit')
+	{
+		// Build Recipient List
+		// u|g =&gt; array($user_id =&gt; 'to'|'bcc')
+		foreach (array('u', 'g') as $ug_type)
+		{
+			if (!empty($data['address_list'][$ug_type]))
+			{
+				foreach ($data['address_list'][$ug_type] as $id =&gt; $field)
+				{
+					$field = ($field == 'to') ? 'to' : 'bcc';
+
+					if ($ug_type == 'u')
+					{
+						$recipients[$id] = $field;
+					}
+
+					${$field}[] = $ug_type . '_' . (int) $id;
+				}
+			}
+		}
+
+		if (!empty($data['address_list']['g']))
+		{
+			$sql = 'SELECT group_id, user_id
+				FROM ' . USER_GROUP_TABLE . '
+				WHERE group_id IN (' . implode(', ', array_keys($data['address_list']['g'])) . ')
+					AND user_pending = 0';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+	
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
+				$recipients[$row['user_id']] = $field;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		if (empty($recipients))
+		{
+			trigger_error('NO_RECIPIENT');
+		}
+	}
+
+	$sql = '';
+
+	switch ($mode)
+	{
+		case 'reply':
+		case 'quote':
+			$root_level = ($data['reply_from_root_level']) ? $data['reply_from_root_level'] : $data['reply_from_msg_id']; 
+
+			// Set message_replied switch for this user
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+				SET replied = 1
+				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+					AND msg_id = ' . $data['reply_from_msg_id'];
+
+		case 'forward':
+		case 'post':
+			$sql_data = array(
+				'root_level'		=&gt; $root_level,
+				'author_id'			=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'icon_id'			=&gt; $data['icon_id'], 
+				'author_ip' 		=&gt; $_CLASS['core_user']-&gt;ip,
+				'message_time'		=&gt; $_CLASS['core_user']-&gt;time,
+				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
+				'enable_html' 		=&gt; $data['enable_html'],
+				'enable_smilies' 	=&gt; $data['enable_smilies'],
+				'enable_magic_url' 	=&gt; $data['enable_urls'],
+				'enable_sig' 		=&gt; $data['enable_sig'],
+				'message_subject'	=&gt; $subject,
+				'message_text' 		=&gt; $data['message'],
+				'message_checksum'	=&gt; $data['message_md5'],
+				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
+				'bbcode_uid'		=&gt; $data['bbcode_uid'],
+				'to_address'		=&gt; implode(':', $to),
+				'bcc_address'		=&gt; implode(':', $bcc)
+			);
+		break;
+
+		case 'edit':
+			$sql_data = array(
+				'icon_id'			=&gt; $data['icon_id'],
+				'message_edit_time'	=&gt; $_CLASS['core_user']-&gt;time,
+				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
+				'enable_html' 		=&gt; $data['enable_html'],
+				'enable_smilies' 	=&gt; $data['enable_smilies'],
+				'enable_magic_url' 	=&gt; $data['enable_urls'],
+				'enable_sig' 		=&gt; $data['enable_sig'],
+				'message_subject'	=&gt; $subject,
+				'message_text' 		=&gt; $data['message'],
+				'message_checksum'	=&gt; $data['message_md5'],
+				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
+				'bbcode_uid'		=&gt; $data['bbcode_uid']
+			);
+		break;
+	}
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	if (!empty($sql_data))
+	{
+		if ($mode === 'post' || $mode === 'reply' || $mode === 'quote' || $mode === 'forward')
+		{
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data));
+			$data['msg_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_PRIVMSGS_TABLE, 'msg_id');
+		}
+		elseif ($mode === 'edit')
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
+				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data) . ' 
+				WHERE msg_id = ' . $data['msg_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+	
+	if ($mode !== 'edit')
+	{
+		if ($sql)
+		{
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
+		foreach ($recipients as $user_id =&gt; $type)
+		{
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+				'msg_id'	=&gt; $data['msg_id'],
+				'user_id'	=&gt; $user_id,
+				'author_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+				'folder_id'	=&gt; PRIVMSGS_NO_BOX,
+				'msg_new'	=&gt; 1,
+				'unread'	=&gt; 1,
+				'forwarded'	=&gt; ($mode == 'forward') ? 1 : 0)
+			));
+		}
+
+		$sql = 'UPDATE ' . USERS_TABLE . ' 
+			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
+			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Put PM into outbox
+		if ($put_in_outbox)
+		{
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+				'msg_id'	=&gt; (int) $data['msg_id'],
+				'user_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'author_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'folder_id'	=&gt; PRIVMSGS_OUTBOX,
+				'msg_new'	=&gt; 0,
+				'unread'	=&gt; 0,
+				'forwarded'	=&gt; ($mode == 'forward') ? 1 : 0))
+			);
+		}
+	}
+
+	// Set user last post time
+	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
+	{
+		$sql = 'UPDATE ' . USERS_TABLE . &quot;
+			SET user_last_post_time = {$_CLASS['core_user']-&gt;time}
+			WHERE user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Submit Attachments
+	if (!empty($data['attachment_data']) &amp;&amp; $data['msg_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
+	{
+		$space_taken = $files_added = 0;
+
+		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
+		{
+			if ($attach_row['attach_id'])
+			{
+				// update entry in db if attachment already stored in db and filespace
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot; 
+					SET comment = '&quot; . $_CLASS['core_db']-&gt;sql_escape($attach_row['comment']) . &quot;' 
+					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			else
+			{
+				// insert attachment into db 
+				$attach_sql = array(
+					'post_msg_id'		=&gt; $data['msg_id'],
+					'download_count'	=&gt; 0,
+					'topic_id'			=&gt; 0,
+					'in_message'		=&gt; 1,
+					'poster_id'			=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
+					'real_filename'		=&gt; basename($attach_row['real_filename']),
+					'comment'			=&gt; $attach_row['comment'],
+					'extension'			=&gt; $attach_row['extension'],
+					'mimetype'			=&gt; $attach_row['mimetype'],
+					'filesize'			=&gt; $attach_row['filesize'],
+					'filetime'			=&gt; $attach_row['filetime'],
+					'thumbnail'			=&gt; $attach_row['thumbnail']
+				);
+
+				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql));
+
+				$space_taken += $attach_row['filesize'];
+
+				$files_added++;
+			}
+		}
+		
+		if (!empty($data['attachment_data']))
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
+				SET message_attachment = 1
+				WHERE msg_id = ' . $data['msg_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
+		if ($space_taken &amp;&amp; $files_added)
+		{
+			set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
+			set_config('num_files', $config['num_files'] + $files_added, true);
+		}
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	// Delete draft if post was loaded...
+	$draft_id = request_var('draft_loaded', 0);
+
+	if ($draft_id)
+	{
+		$sql = 'DELETE FROM ' . DRAFTS_TABLE . &quot; 
+			WHERE draft_id = $draft_id 
+				AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Send Notifications
+	if ($mode !== 'edit')
+	{
+		pm_notification($mode, $_CLASS['core_user']-&gt;data['username'], $recipients, $subject, $data['message']);
+	}
+
+	return $data['msg_id'];
+}
+
+// PM Notification
+function pm_notification($mode, $author, $recipients, $subject, $message)
+{
+	global $_CLASS, $config;
+return;
+	$subject = censor_text($subject);
+	
+	// Get banned User ID's
+	$sql = 'SELECT ban_userid 
+		FROM ' . BANLIST_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']-&gt;data['user_id']]);
+	
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		if (isset($row['ban_userid']))
+		{
+			unset($recipients[$row['ban_userid']]);
+		}
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if (!sizeof($recipients))
+	{
+		return;
+	}
+
+	$recipient_list = implode(', ', array_keys($recipients));
+
+	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
+		FROM ' . USERS_TABLE . &quot;
+		WHERE user_id IN ($recipient_list)&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$msg_list_ary = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		if ($row['user_notify_pm'] == 1 &amp;&amp; trim($row['user_email']))
+		{
+			$msg_list_ary[] = array(
+				'method'	=&gt; $row['user_notify_type'],
+				'email'		=&gt; $row['user_email'],
+				'jabber'	=&gt; $row['user_jabber'],
+				'name'		=&gt; $row['username'],
+				'lang'		=&gt; $row['user_lang']
+			);
+		}
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+	
+	if (!sizeof($msg_list_ary))
+	{
+		return;
+	}
+
+	require_once('includes/forums/functions_messenger.php');
+	$messenger = new messenger();
+
+	$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
+
+	foreach ($msg_list_ary as $pos =&gt; $addr)
+	{
+		$messenger-&gt;template('privmsg_notify', $addr['lang']);
+
+		$messenger-&gt;replyto($config['board_email']);
+		$messenger-&gt;to($addr['email'], $addr['name']);
+		$messenger-&gt;im($addr['jabber'], $addr['name']);
+
+		$messenger-&gt;assign_vars(array(
+			'EMAIL_SIG'		=&gt; $email_sig,
+			'SITENAME'		=&gt; $config['sitename'],
+			'SUBJECT'		=&gt; $subject,
+			'AUTHOR_NAME'	=&gt; $author,
+			'USERNAME'		=&gt; $addr['name'],
+
+			'U_INBOX'		=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true)))
+		);
+
+		$messenger-&gt;send($addr['method']);
+		$messenger-&gt;reset();
+	}
+	unset($msg_list_ary);
+
+	if ($messenger-&gt;queue)
+	{
+		$messenger-&gt;save_queue();
+	}
+
+	unset($messenger);
+}
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -33,111 +33,6 @@
 // 
 // -------------------------------------------------------------
 
-global $_CLASS;
-
-$action = request_var('action', '');
-$quickmod = request_var('quickmod', '');
-
-switch ($mode)
-{
-	case 'lock':
-	case 'unlock':
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		lock_unlock($mode, $topic_ids);
-	break;
-
-	case 'lock_post':
-	case 'unlock_post':
-		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		lock_unlock($mode, $post_ids);
-	break;
-
-	case 'make_announce':
-	case 'make_sticky':
-	case 'make_global':
-	case 'make_normal':
-		
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		change_topic_type($mode, $topic_ids);
-	break;
-
-	case 'move':
-		$_CLASS['core_user']-&gt;add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_move_topic($topic_ids);
-	break;
-
-	case 'fork':
-		$_CLASS['core_user']-&gt;add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_fork_topic($topic_ids);
-	break;
-
-	case 'delete_topic':
-		$_CLASS['core_user']-&gt;add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_delete_topic($topic_ids);
-	break;
-
-	case 'delete_post':
-		$_CLASS['core_user']-&gt;add_lang('posting');
-
-		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		mcp_delete_post($post_ids);
-	break;
-
-	default:
-		trigger_error(&quot;Unknown mode: $mode&quot;);
-	break;
-}
-
-trigger_error('I need to put something here');
-
 // Lock/Unlock Topic/Post
 function lock_unlock($mode, $ids)
 {
@@ -209,7 +104,7 @@
 {
 	global $db, $_CLASS;
 
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
 	{
 		return;
 	}
@@ -219,64 +114,68 @@
 		case 'make_announce':
 			$new_topic_type = POST_ANNOUNCE;
 			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
+		break;
+
 		case 'make_global':
 			$new_topic_type = POST_GLOBAL;
 			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
+		break;
+
 		case 'make_sticky':
 			$new_topic_type = POST_STICKY;
 			$check_acl = 'f_sticky';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
+		break;
+
 		default:
 			$new_topic_type = POST_NORMAL;
 			$check_acl = '';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
+		break;
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']-&gt;data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$hidden_fields = build_hidden_fields(array(
 		'topic_id_list'	=&gt; $topic_ids,
-		'f'				=&gt; $forum_id,
 		'mode'			=&gt; $mode,
-		'redirect'		=&gt; $redirect)
-	);
+		'redirect'		=&gt; $redirect
+	));
 	$success_msg = '';
 
-	if (confirm_box(true))
+	if (display_confirmation($_CLASS['core_user']-&gt;get_lang($l_new_type), $hidden_fields))
 	{
-		if ($new_topic_type != POST_GLOBAL)
+		if ($new_topic_type !== POST_GLOBAL)
 		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . &quot;
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . &quot;
 				SET topic_type = $new_topic_type
 				WHERE topic_id IN (&quot; . implode(', ', $topic_ids) . ')
 					AND forum_id &lt;&gt; 0';
-			$db-&gt;query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 
-			// Reset forum id if a global topic is within the array
+// do select first
+			/*
 			if ($forum_id)
 			{
 				$sql = 'UPDATE ' . TOPICS_TABLE . &quot;
 					SET topic_type = $new_topic_type, forum_id = $forum_id
 						WHERE topic_id IN (&quot; . implode(', ', $topic_ids) . ')
 						AND forum_id = 0';
-				$db-&gt;query($sql);
+				$_CLASS['core_db']-&gt;query($sql);
 			}
+			*/
 		}
 		else
 		{
 			$sql = 'UPDATE ' . TOPICS_TABLE . &quot;
 				SET topic_type = $new_topic_type, forum_id = 0
 				WHERE topic_id IN (&quot; . implode(', ', $topic_ids) . &quot;)&quot;;
-			$db-&gt;query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 		}
 
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
+		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
 
 		$data = get_topic_data($topic_ids);
 
@@ -285,12 +184,8 @@
 			add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);
 		}
 	}
-	else
-	{
-		confirm_box(false, $l_new_type, $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link($redirect);
 
 	if (!$success_msg)
 	{
@@ -431,7 +326,7 @@
 		// Now sync forums
 		sync('forum', 'forum_id', $forum_ids);
 
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
+		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
 	}
 
 	$redirect = generate_link($redirect);
@@ -456,7 +351,7 @@
 // Delete Topics
 function mcp_delete_topic($topic_ids)
 {
-	global $_CLASS, $db;
+	global $_CLASS;
 
 	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_delete'))
 	{
@@ -486,8 +381,6 @@
 		}
 
 		$return = delete_topics('topic_id', $topic_ids, true);
-
-		// TODO: Adjust total post count...
 	}
 
 	$redirect = generate_link($redirect);
@@ -499,7 +392,7 @@
 	else
 	{
 		$_CLASS['core_display']-&gt;meta_refresh(3, $redirect);
-		trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '&quot;&gt;', '&lt;/a&gt;'));
+		trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FORUM'], '&lt;a href=&quot;'. $redirect . '&quot;&gt;', '&lt;/a&gt;'));
 	}
 }
 
@@ -508,33 +401,35 @@
 {
 	global $_CLASS, $db;
 
-	if (!($forum_id = check_ids($post_ids, POSTS_TABLE, 'post_id', 'm_delete')))
+	if (!check_ids($post_ids, FORUMS_POSTS_TABLE, 'post_id', 'm_delete'))
 	{
 		return;
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']-&gt;data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$hidden_fields = build_hidden_fields(array(
 		'post_id_list'	=&gt; $post_ids,
-		'f'				=&gt; $forum_id,
 		'mode'			=&gt; 'delete_post',
-		'redirect'		=&gt; $redirect)
-	);
+		'redirect'		=&gt; $redirect
+	));
+
 	$success_msg = '';
+	$message = $_CLASS['core_user']-&gt;get_lang((count($post_ids) === 1) ? 'DELETE_POST' : 'DELETE_POSTS');
 
-	if (confirm_box(true))
+	if (display_confirmation($message, $hidden_fields))
 	{
 		// Count the number of topics that are affected
 		// I did not use COUNT(DISTINCT ...) because I remember having problems
 		// with it on older versions of MySQL -- Ashe
 
 		$sql = 'SELECT DISTINCT topic_id
-			FROM ' . POSTS_TABLE . '
+			FROM ' . FORUMS_POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 		$result = $db-&gt;query($sql);
 
 		$topic_id_list = array();
+
 		while ($row = $db-&gt;sql_fetchrow($result))
 		{
 			$topic_id_list[] = $row['topic_id'];
@@ -596,12 +491,8 @@
 			}
 		}
 	}
-	else
-	{
-		confirm_box(false, (sizeof($post_ids) == 1) ? 'DELETE_POST' : 'DELETE_POSTS', $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link('Forums');
 
 	if (!$success_msg)
 	{
@@ -624,7 +515,7 @@
 		return;
 	}
 
-	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);//generate_link('Forums')
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 	$to_forum_id = get_variable('to_forum_id', 'POST', 0, 'int');
 
 	$additional_msg = $success_msg = '';
@@ -846,7 +737,7 @@
 	else
 	{
 		$_CLASS['core_display']-&gt;meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id));
-		$return_link = sprintf($_CLASS['core_user']-&gt;lang['RETURN_NEW_FORUM'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=viewforum&amp;f=' . $to_forum_id) . '&quot;&gt;', '&lt;/a&gt;');
+		$return_link = sprintf($_CLASS['core_user']-&gt;lang['RETURN_NEW_FORUM'], '&lt;a href=&quot;'. $redirect . '&quot;&gt;', '&lt;/a&gt;');
 
 		trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . $return_link);
 	}

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -155,7 +155,7 @@
 	
 	function check_bbcode($bbcode, &amp;$in)
 	{
-		$in = trim($in);
+		$in = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($in)));
 
 		if (!$in)
 		{

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/functions.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -26,6 +26,7 @@
 {
 	//Code Copyright 2004 phpBB Group - <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
 	return preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email);
+	//preg_match('#^.*?@(.*?\.)?[a-z0-9\-]+\.[a-z]{2,4}$#i', $email)
 }
 
 function check_bot_status($browser, $ip)
@@ -195,6 +196,11 @@
 
 function check_theme($theme)
 {
+	if (mb_strpos($theme, '.') !== false)
+	{
+		return false;
+	}
+
 	return file_exists(SITE_FILE_ROOT.'themes/'.$theme.'/index.php');
 }
 
@@ -330,7 +336,7 @@
 		{
 		 	case 'int':
 		 	case 'integer':
-				$variable = is_numeric($variable) ? (int) $variable : $default;
+				return is_numeric($variable) ? (int) $variable : $default;
 			break;
 
 			case 'array':
@@ -344,14 +350,33 @@
 				{
 					$variable[$key] = strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $value), &quot;\n&quot;)));
 				}
+
+				return $variable;
 			break;
+			
+			case 'array:int':
+			case 'array:integer':
+				if (!is_array($variable))
+				{
+					return $default;
+				}
 
+// need to add a function here to loop multi... arrays
+				foreach ($variable as $key =&gt; $value)
+				{
+					if (is_numeric($value))
+					{
+						$variable[$key] = (int) $value;
+					}
+				}
+
+				return $variable;
+			break;
+
 			default:
-				$variable = strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $variable), &quot;\n&quot;)));
+				return strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $variable), &quot;\n&quot;)));
 			break;
 		}
-
-		return $variable;
 	}
 }
 
@@ -728,7 +753,14 @@
 {
 	$url = ($url) ? str_replace('&amp;', '&amp;', $url) : generate_link();
 
-	header('Location: ' . $url);
+	if (preg_match('#Microsoft|WebSTAR|Xitami#', $_SERVER['SERVER_SOFTWARE']))
+	{
+		header('Refresh: 0; url=' . $url);
+	}
+	else
+	{
+		header('Location: ' . $url);
+	}
 
 	header('P3P: CP=&quot;CAO DSP COR CURa ADMa DEVa OUR IND PHY ONL UNI COM NAV INT DEM PRE&quot;');
 	header('Cache-Control: private, pre-check=0, post-check=0, max-age=0');
@@ -754,12 +786,19 @@
 {
 }
 
-function select_theme($default = false)
+function select_theme($default = false, $system = false)
 {
 	global $_CLASS;
 
-	if (!$default)
+	$select = '';
+
+	if ($system)
 	{
+		$selected = (!$default) ? ' selected=&quot;selected&quot;' : '';
+		$select .= &quot;&lt;option value=\&quot;\&quot; $selected&gt; - Site Default - &lt;/option&gt;\n&quot;;
+	}
+	elseif (!$default)
+	{
 		$default = $_CLASS['core_display']-&gt;theme_name;
 	}
 
@@ -768,7 +807,7 @@
 	
 	while ($file = readdir($handle))
 	{
-		if (!mb_strpos($file, '.'))
+		if (mb_strpos($file, '.') === false)
 		{
 			if (file_exists(SITE_FILE_ROOT.&quot;themes/$file/index.php&quot;))
 			{
@@ -780,7 +819,6 @@
 	closedir($handle);
 	
 	$count = count($theme_array);
-	$select = '';
 
 	for ($i = 0; $i &lt; $count; $i++)
 	{
@@ -797,20 +835,27 @@
 			'1', '2', '3','3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7', '8', '9.5', '10', '11', '12');
 }
 
-function select_tz($default = false)
+function select_tz($default = false, $system = false)
 {
 	global $_CLASS;
 
+	$select = '';
+
+	if ($system)
+	{
+		$selected = (!$default) ? ' selected=&quot;selected&quot;' : '';
+		$select .= &quot;&lt;option value=\&quot;\&quot; $selected&gt; - Site Default - &lt;/option&gt;\n&quot;;
+	}
+	/*
+	elseif (!$default)
+	{
+		$default = $_CORE_CONFIG['global']['default_timezone'] / 3600;
+	}
+	*/
+
 	$tz_array = tz_array();
+	$count = count($tz_array);
 
-	$count = count($tz_array);
-	$select = '';
-	
-	/*if (!$default)
-	{
-		$default = $_CORE_CONFIG['global']['default_timezone'];
-	}*/
-	
 	for ($i = 0; $i &lt; $count; $i++)
 	{
 		$selected = ($tz_array[$i] == $default) ? ' selected=&quot;selected&quot;' : '';

Modified: cms/trunk/includes/templates/confirmation.html
===================================================================
--- cms/trunk/includes/templates/confirmation.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/confirmation.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 &lt;form action=&quot;{ $CONFIRM_ACTION }&quot; method=&quot;post&quot;&gt;
 	&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
@@ -19,6 +19,6 @@
 	&lt;/table&gt;
 &lt;/form&gt;
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 &lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/members_list/email_notify.txt
===================================================================
--- cms/trunk/includes/templates/en/email/members_list/email_notify.txt	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/en/email/members_list/email_notify.txt	2005-09-27 23:57:50 UTC (rev 143)
@@ -0,0 +1,15 @@
+Hello { $TO_USERNAME },
+
+This email was sent from &quot;{ $SITENAME }&quot; by { $FROM_USERNAME } who thought you may be interested in the following topic:
+
+{ $TOPIC_NAME } 
+
+You can find it at:
+
+{ $U_TOPIC } 
+
+A message from { $USERNAME } may also be included below. Please note that this message has not been seen or approved by the board administrators. If you wish to complain about having received this email please contact the board administrator { $CONTACT_EMAIL }. Please quote the the message headers when contacting this address.
+
+----------
+
+{ $MESSAGE } 
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt
===================================================================
--- cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt	2005-09-27 23:57:50 UTC (rev 143)
@@ -0,0 +1,12 @@
+Hello { $TO_USERNAME },
+
+The following is an email sent to you by { $FROM_USERNAME } via your account on { $SITENAME }. If this message is spam, contains abusive or other comments you find offensive please contact the webmaster of the board at the following address:
+
+{ $BOARD_EMAIL } 
+
+Include this full email (particularly the headers). Please note that the reply address to this email has been set to that of { $FROM_USERNAME }.
+
+Message sent to you follows
+~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+{ $MESSAGE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/login_body.html
===================================================================
--- cms/trunk/includes/templates/login_body.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/login_body.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 &lt;form action=&quot;{ $S_LOGIN_ACTION }&quot; method=&quot;post&quot;&gt;
 
@@ -75,6 +75,6 @@
 	&lt;/tr&gt;
 &lt;/table&gt;&lt;/form&gt;
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 &lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Contact/index.html
===================================================================
--- cms/trunk/includes/templates/modules/Contact/index.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Contact/index.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 &lt;form method=&quot;post&quot; action=&quot;{ $ACTION }&quot; &gt;
     &lt;table width=&quot;100%&quot;&gt;
@@ -41,6 +41,6 @@
 &lt;/table&gt;
 &lt;!-- ENDIF --&gt;
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 &lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -14,52 +14,53 @@
 //--&gt;
 &lt;/script&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;#&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_FILENAME }&quot;&gt;{ $L_FILENAME }&lt;/a&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_POST_TIME }&quot;&gt;{ $L_POST_TIME }&lt;/a&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_FILESIZE }&quot;&gt;{ $L_FILESIZE }&lt;/a&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_DOWNLOADS }&quot;&gt;{ $L_DOWNLOADS }&lt;/a&gt;&lt;/th&gt;
-		&lt;th width=&quot;2%&quot; nowrap=&quot;nowrap&quot;&gt;{ $L_DELETE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $TOTAL_ATTACHMENTS } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;6&quot;&gt;
-			&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;nav&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $PAGE_NUMBER }&lt;br /&gt;&lt;/td&gt;
-				&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;[ { $TOTAL_ATTACHMENTS } ]&nbsp;&lt;/td&gt;
-				&lt;td class=&quot;gensmall&quot; width=&quot;100%&quot; align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $PAGINATION } --&gt;&lt;b&gt;&lt;a href=&quot;javascript:jumpto();&quot;&gt;{ $L_GOTO_PAGE }&lt;/a&gt; &lt;!-- IF { $PREVIOUS_PAGE } --&gt;&lt;a href=&quot;{ $PREVIOUS_PAGE }&quot;&gt;{ $L_PREVIOUS }&lt;/a&gt;&nbsp;&nbsp;&lt;!-- ENDIF --&gt;{ $PAGINATION }&lt;!-- IF { $NEXT_PAGE } --&gt;&nbsp;&nbsp;&lt;a href=&quot;{ $NEXT_PAGE }&quot;&gt;{ $L_NEXT }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;/table&gt;
-		&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	
-	&lt;!-- LOOP $attachrow --&gt;
-		&lt;!-- IF { $attachrow:#LOOP_INDEX } % 2 --&gt;
-		&lt;tr class=&quot;row2&quot;&gt;
-		&lt;!-- ELSE --&gt;
-		&lt;tr class=&quot;row1&quot;&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th nowrap=&quot;nowrap&quot;&gt;#&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_FILENAME }&quot;&gt;{ $L_FILENAME }&lt;/a&gt;&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_POST_TIME }&quot;&gt;{ $L_POST_TIME }&lt;/a&gt;&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_FILESIZE }&quot;&gt;{ $L_FILESIZE }&lt;/a&gt;&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_DOWNLOADS }&quot;&gt;{ $L_DOWNLOADS }&lt;/a&gt;&lt;/th&gt;
+			&lt;th width=&quot;2%&quot; nowrap=&quot;nowrap&quot;&gt;{ $L_DELETE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $TOTAL_ATTACHMENTS } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;6&quot;&gt;
+				&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;nav&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $PAGE_NUMBER }&lt;br /&gt;&lt;/td&gt;
+					&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;[ { $TOTAL_ATTACHMENTS } ]&nbsp;&lt;/td&gt;
+					&lt;td class=&quot;gensmall&quot; width=&quot;100%&quot; align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $PAGINATION } --&gt;&lt;b&gt;&lt;a href=&quot;javascript:jumpto();&quot;&gt;{ $L_GOTO_PAGE }&lt;/a&gt; &lt;!-- IF { $PREVIOUS_PAGE } --&gt;&lt;a href=&quot;{ $PREVIOUS_PAGE }&quot;&gt;{ $L_PREVIOUS }&lt;/a&gt;&nbsp;&nbsp;&lt;!-- ENDIF --&gt;{ $PAGINATION }&lt;!-- IF { $NEXT_PAGE } --&gt;&nbsp;&nbsp;&lt;a href=&quot;{ $NEXT_PAGE }&quot;&gt;{ $L_NEXT }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;/table&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
 		&lt;!-- ENDIF --&gt;
-
-		&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; width=&quot;2%&quot;&gt;&nbsp;{ $attachrow:ROW_NUMBER }&nbsp;&lt;/td&gt;
-		&lt;td style=&quot;padding: 4px;&quot;&gt;&lt;a class=&quot;gen&quot; href=&quot;{ $attachrow:U_VIEW_ATTACHMENT }&quot; target=&quot;file&quot;&gt;{ $attachrow:FILENAME }&lt;/a&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;!-- IF { $attachrow:S_IN_MESSAGE } --&gt;&lt;b&gt;{ $L_PM }: &lt;/b&gt;&lt;!-- ELSE --&gt;&lt;b&gt;{ $L_TOPIC }: &lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;a href=&quot;{ $attachrow:U_VIEW_TOPIC }&quot;&gt;{ $attachrow:TOPIC_TITLE }&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;gensmall&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $attachrow:POST_TIME }&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;{ $attachrow:SIZE }&lt;/td&gt;
-		&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot;&gt;{ $attachrow:DOWNLOAD_COUNT }&lt;/td&gt;
-		&lt;td style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attachment[{ $attachrow:ATTACH_ID }]&quot; value=&quot;1&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDLOOP --&gt;
+		
+		&lt;!-- LOOP $attachrow --&gt;
+			&lt;!-- IF { $attachrow:#LOOP_INDEX } % 2 --&gt;
+			&lt;tr class=&quot;row2&quot;&gt;
+			&lt;!-- ELSE --&gt;
+			&lt;tr class=&quot;row1&quot;&gt;
+			&lt;!-- ENDIF --&gt;
 	
-	&lt;tr&gt; 
-		&lt;td class=&quot;cat&quot; colspan=&quot;6&quot;&gt;&lt;div style=&quot;float:left&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_SORT_BY }: &lt;/span&gt;&lt;select name=&quot;sk&quot;&gt;{$S_SORT_OPTIONS}&lt;/select&gt; &lt;select name=&quot;sd&quot;&gt;{ $S_ORDER_SELECT }&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;sort&quot; value=&quot;{ $L_SORT }&quot; /&gt;&lt;/div&gt;&lt;div style=&quot;float:right&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delete&quot; value=&quot;{ $L_DELETE_MARKED }&quot; /&gt;&nbsp;&lt;/div&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;div style=&quot;float:right&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('ucp', true);&quot;&gt;{ $L_MARK_ALL }&lt;/a&gt; :: &lt;a  href=&quot;javascript:marklist('ucp', false);&quot;&gt;{ $L_UNMARK_ALL }&lt;/a&gt;&lt;/b&gt;&lt;/div&gt;
-
+			&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; width=&quot;2%&quot;&gt;&nbsp;{ $attachrow:ROW_NUMBER }&nbsp;&lt;/td&gt;
+			&lt;td style=&quot;padding: 4px;&quot;&gt;&lt;a class=&quot;gen&quot; href=&quot;{ $attachrow:U_VIEW_ATTACHMENT }&quot; target=&quot;file&quot;&gt;{ $attachrow:FILENAME }&lt;/a&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;!-- IF { $attachrow:S_IN_MESSAGE } --&gt;&lt;b&gt;{ $L_PM }: &lt;/b&gt;&lt;!-- ELSE --&gt;&lt;b&gt;{ $L_TOPIC }: &lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;a href=&quot;{ $attachrow:U_VIEW_TOPIC }&quot;&gt;{ $attachrow:TOPIC_TITLE }&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;gensmall&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $attachrow:POST_TIME }&nbsp;&lt;/td&gt;
+			&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;{ $attachrow:SIZE }&lt;/td&gt;
+			&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot;&gt;{ $attachrow:DOWNLOAD_COUNT }&lt;/td&gt;
+			&lt;td style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attachment[{ $attachrow:ATTACH_ID }]&quot; value=&quot;1&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP --&gt;
+		
+		&lt;tr&gt; 
+			&lt;td class=&quot;cat&quot; colspan=&quot;6&quot;&gt;&lt;div style=&quot;float:left&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_SORT_BY }: &lt;/span&gt;&lt;select name=&quot;sk&quot;&gt;{$S_SORT_OPTIONS}&lt;/select&gt; &lt;select name=&quot;sd&quot;&gt;{ $S_ORDER_SELECT }&lt;/select&gt;&nbsp;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;sort&quot; value=&quot;{ $L_SORT }&quot; /&gt;&lt;/div&gt;&lt;div style=&quot;float:right&quot;&gt;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;delete&quot; value=&quot;{ $L_DELETE_MARKED }&quot; /&gt;&nbsp;&lt;/div&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+	&lt;br /&gt;
+	&lt;div style=&quot;float:right&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('ucp', true);&quot;&gt;{ $L_MARK_ALL }&lt;/a&gt; :: &lt;a  href=&quot;javascript:marklist('ucp', false);&quot;&gt;{ $L_UNMARK_ALL }&lt;/a&gt;&lt;/b&gt;&lt;/div&gt;
+&lt;/form&gt;
 &lt;!-- ELSE --&gt;
 
 &lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,7 +1,3 @@
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
-&lt;!-- IF { $S_DISPLAY_FORM } --&gt;
-&lt;/form&gt;
-&lt;!-- ENDIF --&gt;
-
 &lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,68 +1,69 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;{ $L_USERGROUPS }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_GROUPS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-
-	&lt;tr&gt;
-		&lt;th colspan=&quot;1&quot;&gt;{ $L_GROUP_DETAILS }&lt;/td&gt;
-		&lt;th&gt;{ $L_MARK }&lt;/td&gt;
-	&lt;/tr&gt;
-
-	&lt;!-- IF isset({ $leader }) --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_GROUP_LEADER }&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;!-- LOOP $leader --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $leader:U_VIEW_GROUP }&quot;&gt;{ $leader:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $leader:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $leader:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $leader:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $leader:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDLOOP --&gt;
-
-	&lt;!-- IF isset({ $member }) --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_GROUP_MEMBER }&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;!-- LOOP $member --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $member:U_VIEW_GROUP }&quot;&gt;{ $member:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $member:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $member:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $member:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $member:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDLOOP --&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot;&gt;{ $L_USERGROUPS }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_GROUPS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;1&quot;&gt;{ $L_GROUP_DETAILS }&lt;/th&gt;
+			&lt;th&gt;{ $L_MARK }&lt;/th&gt;
+		&lt;/tr&gt;
 	
-	&lt;!-- IF isset({ $pending }) --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{$L_GROUP_PENDING}&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;!-- LOOP $pending --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $pending:U_VIEW_GROUP }&quot;&gt;{ $pending:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $pending:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $pending:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $pending:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $pending:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDLOOP --&gt;
+		&lt;!-- IF isset({ $leader }) --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_GROUP_LEADER }&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $leader --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $leader:U_VIEW_GROUP }&quot;&gt;{ $leader:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $leader:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $leader:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $leader:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $leader:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP --&gt;
+		&lt;!-- ENDIF --&gt;
 	
-	&lt;!-- IF isset({ $nonmember }) --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;3&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{$L_GROUP_NONMEMBER}&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;!-- LOOP $nonmember --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{$nonmember:U_VIEW_GROUP}&quot;&gt;{ $nonmember:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $nonmember:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $nonmember:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $nonmember:GROUP_APPLY } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $nonmember:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDLOOP --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;3&quot;&gt;&lt;/div&gt;&lt;div style=&quot;float:right&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;Select: &lt;/span&gt;&lt;select name=&quot;mode&quot;&gt;&lt;option value=&quot;apply&quot;&gt;Apply marked&lt;/option&gt;&lt;option value=&quot;resign&quot;&gt;Resign marked&lt;/option&gt;&lt;option value=&quot;demote&quot;&gt;Demote marked&lt;/option&gt;&lt;/select&gt;&nbsp;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{$L_SUBMIT}&quot; /&gt;&nbsp;&lt;/div&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+		&lt;!-- IF isset({ $member }) --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_GROUP_MEMBER }&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $member --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $member:U_VIEW_GROUP }&quot;&gt;{ $member:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $member:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $member:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $member:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $member:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP --&gt;
+		&lt;!-- ENDIF --&gt;
+	
+		&lt;!-- IF isset({ $pending }) --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{$L_GROUP_PENDING}&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $pending --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{ $pending:U_VIEW_GROUP }&quot;&gt;{ $pending:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $pending:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $pending:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $pending:GROUP_RESIGN } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $pending:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP --&gt;
+		&lt;!-- ENDIF --&gt;
+	
+		&lt;!-- IF isset({ $nonmember }) --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;3&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{$L_GROUP_NONMEMBER}&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $nonmember --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;a href=&quot;{$nonmember:U_VIEW_GROUP}&quot;&gt;{ $nonmember:GROUP_NAME }&lt;/a&gt;&lt;/b&gt;&lt;!-- IF { $nonmember:GROUP_DESC } --&gt;&lt;p class=&quot;forumdesc&quot;&gt;{ $nonmember:GROUP_DESC }&lt;/p&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;6%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $nonmember:GROUP_APPLY } --&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_id[]&quot; value=&quot;{ $nonmember:GROUP_ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP --&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;3&quot;&gt;&lt;div style=&quot;float:right&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;Select: &lt;/span&gt;&lt;select name=&quot;mode&quot;&gt;&lt;option value=&quot;apply&quot;&gt;Apply marked&lt;/option&gt;&lt;option value=&quot;resign&quot;&gt;Resign marked&lt;/option&gt;&lt;option value=&quot;demote&quot;&gt;Demote marked&lt;/option&gt;&lt;/select&gt;&nbsp;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&lt;/div&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,7 +1,3 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
-&lt;!-- IF { $S_DISPLAY_FORM } --&gt;
-&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
-&lt;!-- ENDIF --&gt;
-
-{ $A_TABLE_OPEN }
\ No newline at end of file
+{ $THEME_TABLE_OPEN }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -20,23 +20,32 @@
 
 &lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot;&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td align=&quot;left&quot;&gt;
-		&lt;!-- IF { $TOTAL_MESSAGES } --&gt;
-			&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;td class=&quot;row1&quot;&gt;
+			&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;
 				&lt;tr&gt;
-					&lt;td class=&quot;nav&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $PAGE_NUMBER }&lt;br /&gt;&lt;/td&gt;
-					&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;&lt;/td&gt;
-					&lt;td class=&quot;gensmall&quot; width=&quot;100%&quot; align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $PAGINATION } --&gt;&lt;b&gt;&lt;a href=&quot;javascript:jumpto();&quot;&gt;{ $L_GOTO_PAGE }&lt;/a&gt; &lt;!-- IF { $PREVIOUS_PAGE } --&gt;&lt;a href=&quot;{ $PREVIOUS_PAGE }&quot;&gt;{ $L_PREVIOUS }&lt;/a&gt;&nbsp;&nbsp;&lt;!-- ENDIF --&gt;{ $PAGINATION }&lt;!-- IF { $NEXT_PAGE } --&gt;&nbsp;&nbsp;&lt;a href=&quot;{ $NEXT_PAGE }&quot;&gt;{ $L_NEXT }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+					&lt;td align=&quot;left&quot;&gt;
+					&lt;!-- IF { $TOTAL_MESSAGES } --&gt;
+						&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+							&lt;tr&gt;
+								&lt;td class=&quot;nav&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $PAGE_NUMBER }&lt;br /&gt;&lt;/td&gt;
+								&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;&lt;/td&gt;
+								&lt;td class=&quot;gensmall&quot; width=&quot;100%&quot; align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;&lt;!-- IF { $PAGINATION } --&gt;&lt;b&gt;&lt;a href=&quot;javascript:jumpto();&quot;&gt;{ $L_GOTO_PAGE }&lt;/a&gt; &lt;!-- IF { $PREVIOUS_PAGE } --&gt;&lt;a href=&quot;{ $PREVIOUS_PAGE }&quot;&gt;{ $L_PREVIOUS }&lt;/a&gt;&nbsp;&nbsp;&lt;!-- ENDIF --&gt;{ $PAGINATION }&lt;!-- IF { $NEXT_PAGE } --&gt;&nbsp;&nbsp;&lt;a href=&quot;{ $NEXT_PAGE }&quot;&gt;{ $L_NEXT }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+							&lt;/tr&gt;
+						&lt;/table&gt;
+					&lt;!-- ENDIF --&gt;
+					&lt;!-- IF { $S_VIEW_MESSAGE } --&gt;
+					&lt;span class=&quot;gensmall&quot;&gt;
+					&lt;!-- IF { $S_DISPLAY_HISTORY } --&gt;&lt;a href=&quot;{ $U_VIEW_PREVIOUS_HISTORY }&quot;&gt;{ $L_VIEW_PREVIOUS_HISTORY }&lt;/a&gt; | &lt;a href=&quot;{ $U_VIEW_NEXT_HISTORY }&quot;&gt;{ $L_VIEW_NEXT_HISTORY }&lt;/a&gt; | &lt;!-- ENDIF --&gt;&lt;a href=&quot;{ $U_PREVIOUS_PM }&quot;&gt;{ $L_VIEW_PREVIOUS_PM }&lt;/a&gt; | &lt;a href=&quot;{ $U_NEXT_PM }&quot;&gt;{ $L_VIEW_NEXT_PM }&lt;/a&gt;&nbsp;
+					&lt;/span&gt;
+					&lt;!-- ENDIF --&gt;
+					&lt;/td&gt;
+					&lt;td align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;
+						&lt;form name=&quot;choosefolder&quot; method=&quot;post&quot; action=&quot;{ $S_FOLDER_ACTION }&quot; style=&quot;margin:0px&quot;&gt;
+							&lt;select name=&quot;f&quot;&gt;{ $S_FOLDER_OPTIONS }&lt;/select&gt;&nbsp;&lt;input class=&quot;bottom&quot; type=&quot;submit&quot; name=&quot;folder&quot; value=&quot;{ $L_GO }&quot; /&gt;
+						&lt;/form&gt;
+					&lt;/td&gt;
 				&lt;/tr&gt;
 			&lt;/table&gt;
-		&lt;!-- ENDIF --&gt;
-		&lt;!-- IF { $S_VIEW_MESSAGE } --&gt;
-		&lt;span class=&quot;gensmall&quot;&gt;
-		&lt;!-- IF { $S_DISPLAY_HISTORY } --&gt;&lt;a href=&quot;{ $U_VIEW_PREVIOUS_HISTORY }&quot;&gt;{ $L_VIEW_PREVIOUS_HISTORY }&lt;/a&gt; | &lt;a href=&quot;{ $U_VIEW_NEXT_HISTORY }&quot;&gt;{ $L_VIEW_NEXT_HISTORY }&lt;/a&gt; | &lt;!-- ENDIF --&gt;&lt;a href=&quot;{ $U_PREVIOUS_PM }&quot;&gt;{ $L_VIEW_PREVIOUS_PM }&lt;/a&gt; | &lt;a href=&quot;{ $U_NEXT_PM }&quot;&gt;{ $L_VIEW_NEXT_PM }&lt;/a&gt;&nbsp;
-		&lt;/span&gt;
-		&lt;!-- ENDIF --&gt;
-		&lt;/td&gt;&lt;td align=&quot;right&quot; nowrap=&quot;nowrap&quot;&gt;&lt;form name=&quot;choosefolder&quot; method=&quot;post&quot; action=&quot;{ $S_FOLDER_ACTION }&quot; style=&quot;margin:0px&quot;&gt;
-			&lt;select name=&quot;f&quot;&gt;{ $S_FOLDER_OPTIONS }&lt;/select&gt;&nbsp;&lt;input class=&quot;bottom&quot; type=&quot;submit&quot; name=&quot;folder&quot; value=&quot;{ $L_GO }&quot; /&gt;&lt;/form&gt;
-		&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
+		&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;/table&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -24,21 +24,21 @@
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_IF }:&lt;/b&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_CHECK_SELECT } --&gt;&lt;select name=&quot;check_option&quot;&gt;{ $S_CHECK_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $CHECK_CURRENT }&lt;/b&gt;&lt;input type=&quot;hidden&quot; name=&quot;check_option&quot; value=&quot;{ $CHECK_OPTION }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_CHECK_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{ $L_NEXT }&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_CHECK_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{ $L_NEXT }&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- ENDIF --&gt;
 	&lt;!-- IF { $S_RULE_DEFINED } --&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_RULE_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[rule]&quot; value=&quot;{ $L_PREVIOUS }&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_RULE_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[rule]&quot; value=&quot;{ $L_PREVIOUS }&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_RULE_SELECT } --&gt;&lt;select name=&quot;rule_option&quot;&gt;{ $S_RULE_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $RULE_CURRENT }&lt;/b&gt;&lt;input type=&quot;hidden&quot; name=&quot;rule_option&quot; value=&quot;{ $RULE_OPTION }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_RULE_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{ $L_NEXT }&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_RULE_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{ $L_NEXT }&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- ENDIF --&gt;
 	
 	&lt;!-- IF { $S_COND_DEFINED } --&gt;
 	&lt;!-- IF { $S_COND_SELECT } || { $COND_CURRENT } --&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_COND_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[cond]&quot; value=&quot;{ $L_PREVIOUS }&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_COND_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[cond]&quot; value=&quot;{ $L_PREVIOUS }&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;top&quot;&gt;
 		&lt;!-- IF { $S_COND_SELECT } --&gt;
 			&lt;!-- IF { $S_TEXT_CONDITION } --&gt;
@@ -53,7 +53,7 @@
 				&lt;input type=&quot;hidden&quot; name=&quot;rule_string&quot; value=&quot;{ $CURRENT_STRING }&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;rule_user_id&quot; value=&quot;{ $CURRENT_USER_ID }&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;rule_group_id&quot; value=&quot;{ $CURRENT_GROUP_ID }&quot; /&gt;
 		&lt;!-- ENDIF --&gt;
 		&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_COND_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{$L_NEXT}&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_COND_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;next&quot; value=&quot;{$L_NEXT}&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- ENDIF --&gt;
 	&lt;input type=&quot;hidden&quot; name=&quot;cond_option&quot; value=&quot;{ $COND_OPTION }&quot; /&gt;
@@ -62,9 +62,9 @@
 
 	&lt;!-- IF { $S_ACTION_DEFINED } --&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_ACTION_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[action]&quot; value=&quot;{$L_PREVIOUS}&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;left&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_ACTION_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;back[action]&quot; value=&quot;{$L_PREVIOUS}&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_ACTION_SELECT } --&gt;&lt;select name=&quot;action_option&quot;&gt;{ $S_ACTION_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $ACTION_CURRENT }&lt;/b&gt;&lt;input type=&quot;hidden&quot; name=&quot;action_option&quot; value=&quot;{ $ACTION_OPTION }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_ACTION_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;add_rule&quot; value=&quot;{ $L_ADD_RULE }&quot; class=&quot;bottom&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;50&quot; align=&quot;right&quot; valign=&quot;top&quot;&gt;&lt;!-- IF { $S_ACTION_SELECT } --&gt;&lt;input type=&quot;submit&quot; name=&quot;add_rule&quot; value=&quot;{ $L_ADD_RULE }&quot; class=&quot;button&quot; /&gt;&lt;!-- ELSE --&gt;&nbsp;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- ENDIF --&gt;
 &lt;/table&gt;
@@ -82,7 +82,7 @@
 		&lt;td class=&quot;row1&quot; width=&quot;120&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $rule:RULE }&lt;/span&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot; width=&quot;120&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;!-- IF { $rule:STRING } --&gt;{ $rule:STRING} &lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;/td&gt;
 		&lt;td class=&quot;row1&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $rule:ACTION }&lt;!-- IF { $rule:FOLDER }  --&gt; { $rule:FOLDER }&lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; width=&quot;25&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;delete_rule[{ $rule:RULE_ID }]&quot; value=&quot;{ $L_DELETE_RULE }&quot; class=&quot;bottom&quot; /&gt;&lt;/td&gt;
+		&lt;td class=&quot;row2&quot; width=&quot;25&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;delete_rule[{ $rule:RULE_ID }]&quot; value=&quot;{ $L_DELETE_RULE }&quot; class=&quot;button&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- LOOPELSE --&gt;
 	&lt;tr&gt;
@@ -107,7 +107,7 @@
 		&lt;td class=&quot;row1&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;foldername&quot; size=&quot;30&quot; maxlength=&quot;30&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;right&quot; colspan=&quot;2&quot;&gt;&lt;input class=&quot;bottom&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;addfolder&quot; value=&quot;{ $L_ADD }&quot; /&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;right&quot; colspan=&quot;2&quot;&gt;&lt;input class=&quot;button&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;addfolder&quot; value=&quot;{ $L_ADD }&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;!-- ENDIF --&gt;
 &lt;/table&gt;
@@ -115,13 +115,32 @@
 &lt;div style=&quot;padding: 2px;&quot;&gt;&lt;/div&gt;
 
 &lt;!-- IF { $S_FOLDER_OPTIONS } --&gt;
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;{ $L_RENAME_FOLDER }&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;200&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_RENAME_FOLDER }: &lt;/b&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;rename_folder_id&quot;&gt;{ $S_FOLDER_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; width=&quot;200&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_NEW_FOLDER_NAME }: &lt;/b&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;new_folder_name&quot; size=&quot;30&quot; maxlength=&quot;30&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;right&quot; colspan=&quot;2&quot;&gt;&lt;input class=&quot;button&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;rename_folder&quot; value=&quot;{ $L_RENAME }&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;div style=&quot;padding: 2px;&quot;&gt;&lt;/div&gt;
+
 &lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
 	&lt;tr&gt;
 		&lt;th colspan=&quot;3&quot;&gt;{ $L_REMOVE_FOLDER }&lt;/th&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot; width=&quot;200&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_REMOVE_FOLDER }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;removefolder&quot;&gt;{ $S_FOLDER_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;remove_folder_id&quot;&gt;{ $S_FOLDER_OPTIONS }&lt;/select&gt;&lt;/td&gt;
 		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_AND }&lt;/b&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
@@ -134,9 +153,8 @@
 	&lt;/tr&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row2&quot; width=&quot;200&quot;&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;bottom&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;remove&quot; value=&quot;{ $L_REMOVE }&quot; /&gt;&lt;/td&gt;
+		&lt;td class=&quot;row2&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;button&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;remove_folder&quot; value=&quot;{ $L_REMOVE }&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
-
 &lt;/table&gt;
 
 &lt;div style=&quot;padding: 2px;&quot;&gt;&lt;/div&gt;
@@ -163,7 +181,7 @@
 		&lt;td class=&quot;row2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $DEFAULT_ACTION }&lt;/span&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;bottom&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;fullfolder&quot; value=&quot;{ $L_CHANGE }&quot; /&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;button&quot; style=&quot;width:150px&quot; type=&quot;submit&quot; name=&quot;fullfolder&quot; value=&quot;{ $L_CHANGE }&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;/table&gt;
 

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,74 +1,75 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_SHOW_EMAIL }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewemail&quot; value=&quot;1&quot; { $VIEW_EMAIL_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewemail&quot; value=&quot;0&quot; { $VIEW_EMAIL_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADMIN_EMAIL }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;massemail&quot; value=&quot;1&quot; { $ADMIN_EMAIL_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;massemail&quot; value=&quot;0&quot; { $ADMIN_EMAIL_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ALLOW_PM }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ALLOW_PM_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;allowpm&quot; value=&quot;1&quot; { $ALLOW_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;allowpm&quot; value=&quot;0&quot; { $ALLOW_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $S_CAN_HIDE_ONLINE } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_HIDE_ONLINE }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;hideonline&quot; value=&quot;1&quot; { $HIDE_ONLINE_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;hideonline&quot; value=&quot;0&quot; { $HIDE_ONLINE_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{$L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_SELECT_NOTIFY } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_NOTIFY_METHOD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;0&quot; { $NOTIFY_EMAIL } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD_EMAIL }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;1&quot; { $NOTIFY_IM } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD_IM }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;2&quot;{$NOTIFY_BOTH} /&gt;&lt;span class=&quot;genmed&quot;&gt;{$L_NOTIFY_METHOD_BOTH}&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NOTIFY_ON_PM }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifypm&quot; value=&quot;1&quot; { $NOTIFY_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifypm&quot; value=&quot;0&quot; { $NOTIFY_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{$L_POPUP_ON_PM}:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;1&quot; { $POPUP_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;0&quot; { $POPUP_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_REPORT_PM_NOTIFY }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_REPORT_PM_NOTIFY_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;report_pm_notify&quot; value=&quot;1&quot; { $REPORT_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;report_pm_notify&quot; value=&quot;0&quot;{$REPORT_PM_NO} /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_LANGUAGE }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;lang&quot;&gt;{ $S_LANG_OPTIONS }&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $S_THEME_OPTIONS } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_THEME }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;theme&quot;&gt;{ $S_THEME_OPTIONS }&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_TIMEZONE }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;tz&quot;&gt;{ $S_TZ_OPTIONS }&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_DST }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;dst&quot; value=&quot;1&quot;{ $DST_YES } /&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;dst&quot; value=&quot;0&quot;{ $DST_NO } /&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_DATE_FORMAT }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_BOARD_DATE_FORMAT_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;dateformat&quot; value=&quot;{ $DATE_FORMAT }&quot; maxlength=&quot;14&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_SHOW_EMAIL }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewemail&quot; value=&quot;1&quot; { $VIEW_EMAIL_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewemail&quot; value=&quot;0&quot; { $VIEW_EMAIL_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADMIN_EMAIL }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;massemail&quot; value=&quot;1&quot; { $ADMIN_EMAIL_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;massemail&quot; value=&quot;0&quot; { $ADMIN_EMAIL_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ALLOW_PM }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ALLOW_PM_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;allowpm&quot; value=&quot;1&quot; { $ALLOW_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;allowpm&quot; value=&quot;0&quot; { $ALLOW_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $S_CAN_HIDE_ONLINE } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_HIDE_ONLINE }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;hideonline&quot; value=&quot;1&quot; { $HIDE_ONLINE_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;hideonline&quot; value=&quot;0&quot; { $HIDE_ONLINE_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{$L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_SELECT_NOTIFY } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_NOTIFY_METHOD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;0&quot; { $NOTIFY_EMAIL } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD_EMAIL }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;1&quot; { $NOTIFY_IM } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NOTIFY_METHOD_IM }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifymethod&quot; value=&quot;2&quot;{$NOTIFY_BOTH} /&gt;&lt;span class=&quot;genmed&quot;&gt;{$L_NOTIFY_METHOD_BOTH}&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NOTIFY_ON_PM }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notifypm&quot; value=&quot;1&quot; { $NOTIFY_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;notifypm&quot; value=&quot;0&quot; { $NOTIFY_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{$L_POPUP_ON_PM}:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;1&quot; { $POPUP_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;0&quot; { $POPUP_PM_NO } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_REPORT_PM_NOTIFY }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_REPORT_PM_NOTIFY_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;report_pm_notify&quot; value=&quot;1&quot; { $REPORT_PM_YES } /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;report_pm_notify&quot; value=&quot;0&quot;{$REPORT_PM_NO} /&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_LANGUAGE }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;lang&quot;&gt;{ $S_LANG_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $S_THEME_OPTIONS } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_THEME }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;theme&quot;&gt;{ $S_THEME_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_TIMEZONE }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;tz&quot;&gt;{ $S_TZ_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_DST }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;dst&quot; value=&quot;1&quot;{ $DST_YES } /&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;dst&quot; value=&quot;0&quot;{ $DST_NO } /&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BOARD_DATE_FORMAT }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_BOARD_DATE_FORMAT_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;dateformat&quot; value=&quot;{ $DATE_FORMAT }&quot; maxlength=&quot;14&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,37 +1,39 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_BBCODE }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;1&quot; { $DEFAULT_BBCODE_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;0&quot; { $DEFAULT_BBCODE_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_HTML }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;1&quot; { $DEFAULT_HTML_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;0&quot; { $DEFAULT_HTML_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_SMILIES }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;1&quot; { $DEFAULT_SMILIES_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;0&quot; { $DEFAULT_SMILIES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_ADD_SIG }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;sig&quot; value=&quot;1&quot; { $DEFAULT_SIG_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;sig&quot; value=&quot;0&quot; { $DEFAULT_SIG_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_NOTIFY }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notify&quot; value=&quot;1&quot; { $DEFAULT_NOTIFY_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;notify&quot; value=&quot;0&quot; { $DEFAULT_NOTIFY_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_BBCODE }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;1&quot; { $DEFAULT_BBCODE_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;0&quot; { $DEFAULT_BBCODE_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_HTML }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;1&quot; { $DEFAULT_HTML_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;0&quot; { $DEFAULT_HTML_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_SMILIES }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;1&quot; { $DEFAULT_SMILIES_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;0&quot; { $DEFAULT_SMILIES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_ADD_SIG }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;sig&quot; value=&quot;1&quot; { $DEFAULT_SIG_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;sig&quot; value=&quot;0&quot; { $DEFAULT_SIG_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DEFAULT_NOTIFY }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;notify&quot; value=&quot;1&quot; { $DEFAULT_NOTIFY_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;notify&quot; value=&quot;0&quot; { $DEFAULT_NOTIFY_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,73 +1,75 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_IMAGES }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;images&quot; value=&quot;1&quot; { $VIEW_IMAGES_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;images&quot; value=&quot;0&quot; { $VIEW_IMAGES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_FLASH }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;flash&quot; value=&quot;1&quot; { $VIEW_FLASH_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;flash&quot; value=&quot;0&quot; { $VIEW_FLASH_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_SMILIES }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;1&quot; { $VIEW_SMILIES_YES} /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;0&quot; { $VIEW_SMILIES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_SIGS }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;sigs&quot; value=&quot;1&quot; { $VIEW_SIGS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;sigs&quot; value=&quot;0&quot; { $VIEW_SIGS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_AVATARS }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;avatars&quot; value=&quot;1&quot; { $VIEW_AVATARS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;avatars&quot; value=&quot;0&quot; { $VIEW_AVATARS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $S_CHANGE_CENSORS } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DISABLE_CENSORS }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;wordcensor&quot; value=&quot;1&quot; { $DISABLE_CENSORS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;wordcensor&quot; value=&quot;0&quot; { $DISABLE_CENSORS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot; class=&quot;spacer&quot;&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_DAYS }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_DAYS }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_KEY }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_KEY }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_DIR }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_DIR }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot; class=&quot;spacer&quot;&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_DAYS }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_DAYS }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_KEY }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_KEY }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_DIR }:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_DIR }&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_IMAGES }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;images&quot; value=&quot;1&quot; { $VIEW_IMAGES_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;images&quot; value=&quot;0&quot; { $VIEW_IMAGES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_FLASH }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;flash&quot; value=&quot;1&quot; { $VIEW_FLASH_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;flash&quot; value=&quot;0&quot; { $VIEW_FLASH_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_SMILIES }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;1&quot; { $VIEW_SMILIES_YES} /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;smilies&quot; value=&quot;0&quot; { $VIEW_SMILIES_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_SIGS }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;sigs&quot; value=&quot;1&quot; { $VIEW_SIGS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;sigs&quot; value=&quot;0&quot; { $VIEW_SIGS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_AVATARS }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;avatars&quot; value=&quot;1&quot; { $VIEW_AVATARS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;avatars&quot; value=&quot;0&quot; { $VIEW_AVATARS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $S_CHANGE_CENSORS } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_DISABLE_CENSORS }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;wordcensor&quot; value=&quot;1&quot; { $DISABLE_CENSORS_YES } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_YES }&lt;/span&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;wordcensor&quot; value=&quot;0&quot; { $DISABLE_CENSORS_NO } /&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;2&quot; class=&quot;spacer&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_DAYS }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_DAYS }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_KEY }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_KEY }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_TOPICS_DIR }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_TOPIC_SORT_DIR }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;2&quot; class=&quot;spacer&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_DAYS }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_DAYS }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_KEY }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_KEY }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_VIEW_POSTS_DIR }:&lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;{ $S_POST_SORT_DIR }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,68 +1,70 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CURRENT_IMAGE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_AVATAR_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;!-- IF { $AVATAR } --&gt;{$AVATAR}&lt;!-- ELSE --&gt;&lt;img src=&quot;{ $T_THEME_PATH }/images/no_avatar.gif&quot; alt=&quot;&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;br /&gt;&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; /&gt;&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{ $L_DELETE_AVATAR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;!-- IF !isset({ $S_DISPLAY_GALLERY }) --&gt;
-	&lt;!-- IF { $S_CAN_UPLOAD } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UPLOAD_AVATAR_FILE }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;{ $AVATAR_SIZE }&quot; /&gt;&lt;input class=&quot;post&quot; type=&quot;file&quot; name=&quot;uploadfile&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UPLOAD_AVATAR_URL }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_UPLOAD_AVATAR_URL_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;uploadurl&quot; size=&quot;40&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_LINK_AVATAR } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LINK_REMOTE_AVATAR }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_LINK_REMOTE_AVATAR_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;remotelink&quot; size=&quot;40&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LINK_REMOTE_SIZE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_LINK_REMOTE_SIZE_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;width&quot; size=&quot;3&quot; value=&quot;{ $WIDTH }&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px X &lt;/span&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;height&quot; size=&quot;3&quot; value=&quot;{ $HEIGHT }&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_GALLERY_AVATAR } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_AVATAR_GALLERY }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;display_gallery&quot; value=&quot;{ $L_DISPLAY_GALLERY }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-&lt;!-- ELSE --&gt;
-	&lt;tr&gt; 
-		&lt;th colspan=&quot;2&quot;&gt;{ $L_AVATAR_GALLERY }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_AVATAR_CATEGORY }: &lt;/span&gt;&lt;select name=&quot;category&quot;&gt;{$S_CAT_OPTIONS}&lt;/select&gt;&nbsp; &lt;span class=&quot;genmed&quot;&gt;{$L_AVATAR_PAGE}: &lt;/span&gt;&lt;select name=&quot;page&quot;&gt;{$S_PAGE_OPTIONS}&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;{$L_GO}&quot; name=&quot;display_gallery&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;
-		&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;
-			&lt;!-- LOOP $avatar --&gt;&lt;!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --&gt;&lt;/tr&gt;&lt;tr&gt;&lt;!-- ENDIF --&gt;
-				&lt;td align=&quot;center&quot;&gt;&lt;img src=&quot;{ $avatar:AVATAR_IMAGE }&quot; alt=&quot;{ $avatar:AVATAR_NAME }&quot; title=&quot;{ $avatar:AVATAR_NAME }&quot; /&gt;&lt;br/&gt;
-				&lt;input type=&quot;radio&quot; name=&quot;avatarselect&quot; value=&quot;{ $avatar:AVATAR_FILE }&quot; /&gt;&lt;/td&gt;
-			&lt;!-- LOOPELSE --&gt;
-			&lt;tr&gt;
-				&lt;td align=&quot;center&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_NO_GALLERY_AVATAR }&lt;/b&gt;&lt;/td&gt;
-			&lt;!-- ENDLOOP --&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;
-		&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;!-- IF isset({ $S_DISPLAY_GALLERY }) --&gt;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;{ $L_CANCEL }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot; &lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CURRENT_IMAGE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_AVATAR_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;!-- IF { $AVATAR } --&gt;{ $AVATAR }&lt;!-- ELSE --&gt;&lt;img src=&quot;{ $THEME_PATH }/images/no_avatar.gif&quot; alt=&quot;&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;br /&gt;&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; /&gt;&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{ $L_DELETE_AVATAR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;!-- IF !isset({ $S_DISPLAY_GALLERY }) --&gt;
+		&lt;!-- IF { $S_CAN_UPLOAD } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UPLOAD_AVATAR_FILE }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;{ $AVATAR_SIZE }&quot; /&gt;&lt;input class=&quot;post&quot; type=&quot;file&quot; name=&quot;uploadfile&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UPLOAD_AVATAR_URL }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_UPLOAD_AVATAR_URL_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;uploadurl&quot; size=&quot;40&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_LINK_AVATAR } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LINK_REMOTE_AVATAR }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_LINK_REMOTE_AVATAR_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;remotelink&quot; size=&quot;40&quot; value=&quot;&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LINK_REMOTE_SIZE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_LINK_REMOTE_SIZE_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;width&quot; size=&quot;3&quot; value=&quot;{ $WIDTH }&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px X &lt;/span&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;height&quot; size=&quot;3&quot; value=&quot;{ $HEIGHT }&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_GALLERY_AVATAR } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_AVATAR_GALLERY }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;display_gallery&quot; value=&quot;{ $L_DISPLAY_GALLERY }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+	&lt;!-- ELSE --&gt;
+		&lt;tr&gt; 
+			&lt;th colspan=&quot;2&quot;&gt;{ $L_AVATAR_GALLERY }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_AVATAR_CATEGORY }: &lt;/span&gt;&lt;select name=&quot;category&quot;&gt;{$S_CAT_OPTIONS}&lt;/select&gt;&nbsp; &lt;span class=&quot;genmed&quot;&gt;{ $L_AVATAR_PAGE }: &lt;/span&gt;&lt;select name=&quot;page&quot;&gt;{ $S_PAGE_OPTIONS }&lt;/select&gt;&nbsp;&lt;input class=&quot;button&quot; type=&quot;submit&quot; value=&quot;{ $L_GO }&quot; name=&quot;display_gallery&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;
+			&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;
+				&lt;!-- LOOP $avatar --&gt;&lt;!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --&gt;&lt;/tr&gt;&lt;tr&gt;&lt;!-- ENDIF --&gt;
+					&lt;td align=&quot;center&quot;&gt;&lt;img src=&quot;{ $avatar:AVATAR_IMAGE }&quot; alt=&quot;{ $avatar:AVATAR_NAME }&quot; title=&quot;{ $avatar:AVATAR_NAME }&quot; /&gt;&lt;br/&gt;
+					&lt;input type=&quot;radio&quot; name=&quot;avatarselect&quot; value=&quot;{ $avatar:AVATAR_FILE }&quot; /&gt;&lt;/td&gt;
+				&lt;!-- LOOPELSE --&gt;
+				&lt;tr&gt;
+					&lt;td align=&quot;center&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_NO_GALLERY_AVATAR }&lt;/b&gt;&lt;/td&gt;
+				&lt;!-- ENDLOOP --&gt;
+				&lt;/tr&gt;
+			&lt;/table&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;!-- IF isset({ $S_DISPLAY_GALLERY }) --&gt;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;{ $L_CANCEL }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,60 +1,62 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
+
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot; &lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_PROFILE_INFO_NOTICE }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_ICQ }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;icq&quot; size=&quot;30&quot; maxlength=&quot;15&quot; value=&quot;{ $ICQ }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_AIM }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;aim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $AIM }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_MSNM }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;msn&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $MSN }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_YIM }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;yim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $YIM }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_JABBER }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jabber&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $JABBER }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_WEBSITE }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;website&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $WEBSITE }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LOCATION }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;location&quot; size=&quot;30&quot; maxlength=&quot;100&quot; value=&quot;{ $LOCATION }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_OCCUPATION }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;occupation&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;{ $OCCUPATION }&lt;/textarea&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_INTERESTS }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;interests&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;{ $INTERESTS }&lt;/textarea&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BIRTHDAY }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_BIRTHDAY_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_DAY }:&lt;/span&gt; &lt;select name=&quot;bday_day&quot;&gt;{ $S_BIRTHDAY_DAY_OPTIONS }&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_MONTH }:&lt;/span&gt; &lt;select name=&quot;bday_month&quot;&gt;{ $S_BIRTHDAY_MONTH_OPTIONS }&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_YEAR }:&lt;/span&gt; &lt;select name=&quot;bday_year&quot;&gt;{ $S_BIRTHDAY_YEAR_OPTIONS }&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_PROFILE_INFO_NOTICE }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_ICQ }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;icq&quot; size=&quot;30&quot; maxlength=&quot;15&quot; value=&quot;{ $ICQ }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_AIM }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;aim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $AIM }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_MSNM }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;msn&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $MSN }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_YIM }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;yim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $YIM }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_UCP_JABBER }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jabber&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $JABBER }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_WEBSITE }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;website&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $WEBSITE }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_LOCATION }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;location&quot; size=&quot;30&quot; maxlength=&quot;100&quot; value=&quot;{ $LOCATION }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_OCCUPATION }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;occupation&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;{ $OCCUPATION }&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_INTERESTS }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;interests&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;{ $INTERESTS }&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_BIRTHDAY }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_BIRTHDAY_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;{ $L_DAY }:&lt;/span&gt; &lt;select name=&quot;bday_day&quot;&gt;{ $S_BIRTHDAY_DAY_OPTIONS }&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_MONTH }:&lt;/span&gt; &lt;select name=&quot;bday_month&quot;&gt;{ $S_BIRTHDAY_MONTH_OPTIONS }&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;{ $L_YEAR }:&lt;/span&gt; &lt;select name=&quot;bday_year&quot;&gt;{ $S_BIRTHDAY_YEAR_OPTIONS }&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,47 +1,49 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $S_FORCE_PASSWORD } --&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_UCP_PROFILE_REG_WELCOME }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_USERNAME }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_USERNAME_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;!-- IF { $S_CHANGE_USERNAME } --&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;username&quot; size=&quot;30&quot; maxlength=&quot;30&quot; value=&quot;{ $USERNAME }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $USERNAME }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_EMAIL_ADDRESS }: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;!-- IF { $S_CHANGE_EMAIL } --&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;email&quot; size=&quot;30&quot; maxlength=&quot;60&quot; value=&quot;{ $EMAIL }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $EMAIL }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $S_CHANGE_EMAIL } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{$L_CONFIRM_EMAIL}: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CONFIRM_EMAIL_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;email_confirm&quot; size=&quot;30&quot; maxlength=&quot;60&quot; value=&quot;{ $CONFIRM_EMAIL }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_CHANGE_PASSWORD } --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CHANGE_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CHANGE_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;new_password&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $NEW_PASSWORD }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CONFIRM_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CONFIRM_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;password_confirm&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $PASSWORD_CONFIRM }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CURRENT_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CURRENT_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;cur_password&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $CUR_PASSWORD }&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $S_FORCE_PASSWORD } --&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_UCP_PROFILE_REG_WELCOME }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_USERNAME }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_USERNAME_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;!-- IF { $S_CHANGE_USERNAME } --&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;username&quot; size=&quot;30&quot; maxlength=&quot;30&quot; value=&quot;{ $USERNAME }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $USERNAME }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_EMAIL_ADDRESS }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;!-- IF { $S_CHANGE_EMAIL } --&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;email&quot; size=&quot;30&quot; maxlength=&quot;60&quot; value=&quot;{ $EMAIL }&quot; /&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $EMAIL }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $S_CHANGE_EMAIL } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{$L_CONFIRM_EMAIL}: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CONFIRM_EMAIL_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;email_confirm&quot; size=&quot;30&quot; maxlength=&quot;60&quot; value=&quot;{ $CONFIRM_EMAIL }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_CHANGE_PASSWORD } --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CHANGE_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CHANGE_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;new_password&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $NEW_PASSWORD }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CONFIRM_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CONFIRM_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;password_confirm&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $PASSWORD_CONFIRM }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_CURRENT_PASSWORD }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CURRENT_PASSWORD_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;password&quot; class=&quot;post&quot; name=&quot;cur_password&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;{ $CUR_PASSWORD }&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -43,134 +43,135 @@
 &lt;/script&gt;
 &lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;javascript/editor.js&quot;&gt;&lt;/script&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;genmed error&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;22%&quot; valign=&quot;top&quot;&gt;
-		&lt;b class=&quot;genmed&quot;&gt;{ $L_SIGNATURE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_SIGNATURE_EXPLAIN }&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;
-		&lt;table width=&quot;80%&quot; cellspacing=&quot;5&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot; align=&quot;center&quot;&gt;&lt;b&gt;{ $L_SMILIES }&lt;/b&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td align=&quot;center&quot;&gt;&lt;!-- LOOP $smiley --&gt;&lt;a href=&quot;javascript:smiley('{ $smiley:SMILEY_CODE }')&quot;&gt;&lt;img src=&quot;{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }&quot; width=&quot;{ $smiley:SMILEY_WIDTH }&quot; height=&quot;{ $smiley:SMILEY_HEIGHT }&quot; border=&quot;0&quot; alt=&quot;{ $smiley:SMILEY_DESC }&quot; title=&quot;{ $smiley:SMILEY_DESC }&quot; onclick=&quot;smiley('{ $smiley:SMILEY_CODE }');return false&quot; hspace=&quot;2&quot; vspace=&quot;2&quot; /&gt;&lt;/a&gt; &lt;!-- ENDLOOP --&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-
-			&lt;!-- IF { $S_SHOW_SMILEY_LINK } --&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+	
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;genmed error&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+	
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; width=&quot;22%&quot; valign=&quot;top&quot;&gt;
+			&lt;b class=&quot;genmed&quot;&gt;{ $L_SIGNATURE }: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_SIGNATURE_EXPLAIN }&lt;/span&gt;&lt;br/&gt;&lt;br/&gt;
+			&lt;table width=&quot;80%&quot; cellspacing=&quot;5&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
 				&lt;tr&gt;
-					&lt;td align=&quot;center&quot;&gt;&lt;a class=&quot;nav&quot; href=&quot;{ $U_MORE_SMILIES }&quot; onclick=&quot;window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;&quot; target=&quot;_phpbbsmilies&quot;&gt;{ $L_MORE_SMILIES} &lt;/a&gt;&lt;/td&gt;
+					&lt;td class=&quot;gensmall&quot; align=&quot;center&quot;&gt;&lt;b&gt;{ $L_SMILIES }&lt;/b&gt;&lt;/td&gt;
 				&lt;/tr&gt;
-			&lt;!-- ENDIF --&gt;
-
-		&lt;/table&gt;
-		&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;
-		&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
-			&lt;tr align=&quot;center&quot; valign=&quot;middle&quot;&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;b&quot; name=&quot;addbbcode0&quot; value=&quot; B &quot; style=&quot;font-weight:bold; width: 30px&quot; onclick=&quot;bbstyle(0)&quot; onmouseover=&quot;helpline('b')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;i&quot; name=&quot;addbbcode2&quot; value=&quot; i &quot; style=&quot;font-style:italic; width: 30px&quot; onclick=&quot;bbstyle(2)&quot; onmouseover=&quot;helpline('i')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;u&quot; name=&quot;addbbcode4&quot; value=&quot; u &quot; style=&quot;text-decoration: underline; width: 30px&quot; onclick=&quot;bbstyle(4)&quot; onmouseover=&quot;helpline('u')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;q&quot; name=&quot;addbbcode6&quot; value=&quot;Quote&quot; style=&quot;width: 50px&quot; onclick=&quot;bbstyle(6)&quot; onmouseover=&quot;helpline('q')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;c&quot; name=&quot;addbbcode8&quot; value=&quot;Code&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(8)&quot; onmouseover=&quot;helpline('c')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;l&quot; name=&quot;addbbcode10&quot; value=&quot;List&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(10)&quot; onmouseover=&quot;helpline('l')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;o&quot; name=&quot;addbbcode12&quot; value=&quot;List=&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(12)&quot; onmouseover=&quot;helpline('o')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;p&quot; name=&quot;addbbcode14&quot; value=&quot;Img&quot; style=&quot;width: 40px&quot;  onclick=&quot;bbstyle(14)&quot; onmouseover=&quot;helpline('p')&quot; /&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;w&quot; name=&quot;addbbcode18&quot; value=&quot;URL&quot; style=&quot;text-decoration: underline; width: 40px&quot; onclick=&quot;bbstyle(18)&quot; onmouseover=&quot;helpline('w')&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td colspan=&quot;9&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+				&lt;tr&gt;
+					&lt;td align=&quot;center&quot;&gt;&lt;!-- LOOP $smiley --&gt;&lt;a href=&quot;javascript:smiley('{ $smiley:SMILEY_CODE }')&quot;&gt;&lt;img src=&quot;{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }&quot; width=&quot;{ $smiley:SMILEY_WIDTH }&quot; height=&quot;{ $smiley:SMILEY_HEIGHT }&quot; border=&quot;0&quot; alt=&quot;{ $smiley:SMILEY_DESC }&quot; title=&quot;{ $smiley:SMILEY_DESC }&quot; onclick=&quot;smiley('{ $smiley:SMILEY_CODE }');return false&quot; hspace=&quot;2&quot; vspace=&quot;2&quot; /&gt;&lt;/a&gt; &lt;!-- ENDLOOP --&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+	
+				&lt;!-- IF { $S_SHOW_SMILEY_LINK } --&gt;
 					&lt;tr&gt;
-						&lt;td&gt;&lt;span class=&quot;genmed&quot;&gt; &nbsp;{ $L_FONT_SIZE }:&lt;/span&gt; &lt;select name=&quot;addbbcode20&quot; onchange=&quot;bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;&quot; onmouseover=&quot;helpline('f')&quot;&gt;
-							&lt;option value=&quot;7&quot;&gt;{ $L_FONT_TINY }&lt;/option&gt;
-							&lt;option value=&quot;9&quot;&gt;{ $L_FONT_SMALL }&lt;/option&gt;
-							&lt;option value=&quot;12&quot; selected=&quot;selected&quot;&gt;{ $L_FONT_NORMAL }&lt;/option&gt;
-							&lt;option value=&quot;18&quot;&gt;{ $L_FONT_LARGE }&lt;/option&gt;
-							&lt;option  value=&quot;24&quot;&gt;{ $L_FONT_HUGE }&lt;/option&gt;
-						&lt;/select&gt;&lt;/td&gt;
-						&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot; align=&quot;right&quot;&gt;&lt;a href=&quot;javascript:bbstyle(-1)&quot; onmouseover=&quot;helpline('a')&quot;&gt;{ $L_CLOSE_TAGS }&lt;/a&gt;&lt;/td&gt;
+						&lt;td align=&quot;center&quot;&gt;&lt;a class=&quot;nav&quot; href=&quot;{ $U_MORE_SMILIES }&quot; onclick=&quot;window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;&quot; target=&quot;_phpbbsmilies&quot;&gt;{ $L_MORE_SMILIES} &lt;/a&gt;&lt;/td&gt;
 					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td colspan=&quot;9&quot;&gt;&lt;input class=&quot;helpline&quot; type=&quot;text&quot; name=&quot;helpbox&quot; size=&quot;45&quot; maxlength=&quot;100&quot; style=&quot;width:100%&quot; value=&quot;{$L_STYLES_TIP}&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td colspan=&quot;9&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;signature&quot; rows=&quot;10&quot; cols=&quot;70&quot; onselect=&quot;storeCaret(this);&quot; onclick=&quot;storeCaret(this);&quot; onkeyup=&quot;storeCaret(this);&quot;&gt;{$SIGNATURE}&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td colspan=&quot;9&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;
-					&lt;tr&gt;
-						&lt;td bgcolor=&quot;black&quot;&gt;&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;&lt;!--
-
-						colorPalette('h', 17, 5)
-
-						//--&gt;&lt;/script&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_OPTIONS }&lt;/b&gt;&lt;br /&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot;&gt;{ $HTML_STATUS }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot;&gt;{ $BBCODE_STATUS }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot;&gt;{ $IMG_STATUS }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot;&gt;{ $FLASH_STATUS }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;gensmall&quot;&gt;{ $SMILIES_STATUS }&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; valign=&quot;top&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;1&quot; border=&quot;0&quot;&gt;
-			&lt;!-- IF { $S_HTML_ALLOWED } --&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_html&quot; { $S_HTML_CHECKED } /&gt;&lt;/td&gt;
-				&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_HTML }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_BBCODE_ALLOWED } --&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_bbcode&quot; { $S_BBCODE_CHECKED } /&gt;&lt;/td&gt;
-				&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_BBCODE }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_SMILIES_ALLOWED } --&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_smilies&quot; { $S_SMILIES_CHECKED } /&gt;&lt;/td&gt;
-				&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_SMILIES }&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;!-- ENDIF --&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_magic_url&quot; { $S_MAGIC_URL_CHECKED } /&gt;&lt;/td&gt;
-				&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_MAGIC_URL }&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $SIGNATURE_PREVIEW } --&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_SIGNATURE_PREVIEW }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;div class=&quot;postdetails&quot; style=&quot;padding: 6px;&quot;&gt;{ $SIGNATURE_PREVIEW }&lt;/div&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;preview&quot; value=&quot;{ $L_PREVIEW }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
+				&lt;!-- ENDIF --&gt;
+	
+			&lt;/table&gt;
+			&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;
+			&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
+				&lt;tr align=&quot;center&quot; valign=&quot;middle&quot;&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;b&quot; name=&quot;addbbcode0&quot; value=&quot; B &quot; style=&quot;font-weight:bold; width: 30px&quot; onclick=&quot;bbstyle(0)&quot; onmouseover=&quot;helpline('b')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;i&quot; name=&quot;addbbcode2&quot; value=&quot; i &quot; style=&quot;font-style:italic; width: 30px&quot; onclick=&quot;bbstyle(2)&quot; onmouseover=&quot;helpline('i')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;u&quot; name=&quot;addbbcode4&quot; value=&quot; u &quot; style=&quot;text-decoration: underline; width: 30px&quot; onclick=&quot;bbstyle(4)&quot; onmouseover=&quot;helpline('u')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;q&quot; name=&quot;addbbcode6&quot; value=&quot;Quote&quot; style=&quot;width: 50px&quot; onclick=&quot;bbstyle(6)&quot; onmouseover=&quot;helpline('q')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;c&quot; name=&quot;addbbcode8&quot; value=&quot;Code&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(8)&quot; onmouseover=&quot;helpline('c')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;l&quot; name=&quot;addbbcode10&quot; value=&quot;List&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(10)&quot; onmouseover=&quot;helpline('l')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;o&quot; name=&quot;addbbcode12&quot; value=&quot;List=&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(12)&quot; onmouseover=&quot;helpline('o')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;p&quot; name=&quot;addbbcode14&quot; value=&quot;Img&quot; style=&quot;width: 40px&quot;  onclick=&quot;bbstyle(14)&quot; onmouseover=&quot;helpline('p')&quot; /&gt;&lt;/td&gt;
+					&lt;td&gt;&lt;input class=&quot;btnbbcode&quot; type=&quot;button&quot; accesskey=&quot;w&quot; name=&quot;addbbcode18&quot; value=&quot;URL&quot; style=&quot;text-decoration: underline; width: 40px&quot; onclick=&quot;bbstyle(18)&quot; onmouseover=&quot;helpline('w')&quot; /&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td colspan=&quot;9&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+						&lt;tr&gt;
+							&lt;td&gt;&lt;span class=&quot;genmed&quot;&gt; &nbsp;{ $L_FONT_SIZE }:&lt;/span&gt; &lt;select name=&quot;addbbcode20&quot; onchange=&quot;bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;&quot; onmouseover=&quot;helpline('f')&quot;&gt;
+								&lt;option value=&quot;7&quot;&gt;{ $L_FONT_TINY }&lt;/option&gt;
+								&lt;option value=&quot;9&quot;&gt;{ $L_FONT_SMALL }&lt;/option&gt;
+								&lt;option value=&quot;12&quot; selected=&quot;selected&quot;&gt;{ $L_FONT_NORMAL }&lt;/option&gt;
+								&lt;option value=&quot;18&quot;&gt;{ $L_FONT_LARGE }&lt;/option&gt;
+								&lt;option  value=&quot;24&quot;&gt;{ $L_FONT_HUGE }&lt;/option&gt;
+							&lt;/select&gt;&lt;/td&gt;
+							&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot; align=&quot;right&quot;&gt;&lt;a href=&quot;javascript:bbstyle(-1)&quot; onmouseover=&quot;helpline('a')&quot;&gt;{ $L_CLOSE_TAGS }&lt;/a&gt;&lt;/td&gt;
+						&lt;/tr&gt;
+					&lt;/table&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td colspan=&quot;9&quot;&gt;&lt;input class=&quot;helpline&quot; type=&quot;text&quot; name=&quot;helpbox&quot; size=&quot;45&quot; maxlength=&quot;100&quot; style=&quot;width:100%&quot; value=&quot;{$L_STYLES_TIP}&quot; /&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td colspan=&quot;9&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;signature&quot; rows=&quot;10&quot; cols=&quot;70&quot; onselect=&quot;storeCaret(this);&quot; onclick=&quot;storeCaret(this);&quot; onkeyup=&quot;storeCaret(this);&quot;&gt;{$SIGNATURE}&lt;/textarea&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td colspan=&quot;9&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; width=&quot;100%&quot;&gt;
+						&lt;tr&gt;
+							&lt;td bgcolor=&quot;black&quot;&gt;&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;&lt;!--
+	
+							colorPalette('h', 17, 5)
+	
+							//--&gt;&lt;/script&gt;&lt;/td&gt;
+						&lt;/tr&gt;
+					&lt;/table&gt;&lt;/td&gt;
+				&lt;/tr&gt;
+			&lt;/table&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_OPTIONS }&lt;/b&gt;&lt;br /&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;gensmall&quot;&gt;{ $HTML_STATUS }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;gensmall&quot;&gt;{ $BBCODE_STATUS }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;gensmall&quot;&gt;{ $IMG_STATUS }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;gensmall&quot;&gt;{ $FLASH_STATUS }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;tr&gt;
+					&lt;td class=&quot;gensmall&quot;&gt;{ $SMILIES_STATUS }&lt;/td&gt;
+				&lt;/tr&gt;
+			&lt;/table&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; valign=&quot;top&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;1&quot; border=&quot;0&quot;&gt;
+				&lt;!-- IF { $S_HTML_ALLOWED } --&gt;
+				&lt;tr&gt;
+					&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_html&quot; { $S_HTML_CHECKED } /&gt;&lt;/td&gt;
+					&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_HTML }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_BBCODE_ALLOWED } --&gt;
+				&lt;tr&gt;
+					&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_bbcode&quot; { $S_BBCODE_CHECKED } /&gt;&lt;/td&gt;
+					&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_BBCODE }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;!-- ENDIF --&gt;&lt;!-- IF { $S_SMILIES_ALLOWED } --&gt;
+				&lt;tr&gt;
+					&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_smilies&quot; { $S_SMILIES_CHECKED } /&gt;&lt;/td&gt;
+					&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_SMILIES }&lt;/td&gt;
+				&lt;/tr&gt;
+				&lt;!-- ENDIF --&gt;
+				&lt;tr&gt;
+					&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_magic_url&quot; { $S_MAGIC_URL_CHECKED } /&gt;&lt;/td&gt;
+					&lt;td class=&quot;gen&quot;&gt;{ $L_DISABLE_MAGIC_URL }&lt;/td&gt;
+				&lt;/tr&gt;
+			&lt;/table&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $SIGNATURE_PREVIEW } --&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_SIGNATURE_PREVIEW }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt; 
+			&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;div class=&quot;postdetails&quot; style=&quot;padding: 6px;&quot;&gt;{ $SIGNATURE_PREVIEW }&lt;/div&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;preview&quot; value=&quot;{ $L_PREVIEW }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,28 +1,30 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_FOES_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_YOUR_FOES }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_YOUR_FOES_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $S_USERNAME_OPTIONS } --&gt;&lt;select name=&quot;usernames[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;{ $S_USERNAME_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NO_FOES }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADD_FOES }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ADD_FOES_EXPLAIN } [ &lt;a href=&quot;{ $U_SEARCH_USER }&quot; onclick=&quot;window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=780');return false&quot;&gt;{ $L_FIND_USERNAME }&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;textarea name=&quot;add&quot; rows=&quot;5&quot; cols=&quot;30&quot;&gt;{ $USERNAMES }&lt;/textarea&gt;&lt;br /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{ $L_TITLE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_FOES_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_YOUR_FOES }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_YOUR_FOES_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $S_USERNAME_OPTIONS } --&gt;&lt;select name=&quot;usernames[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;{ $S_USERNAME_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NO_FOES }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADD_FOES }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ADD_FOES_EXPLAIN } [ &lt;a href=&quot;{ $U_SEARCH_USER }&quot; onclick=&quot;window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=780');return false&quot;&gt;{ $L_FIND_USERNAME }&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;textarea name=&quot;add&quot; rows=&quot;5&quot; cols=&quot;30&quot;&gt;{ $USERNAMES }&lt;/textarea&gt;&lt;br /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,28 +1,30 @@
 &lt;!-- INCLUDE modules/Control_Panel/ucp_header.html --&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{$L_TITLE}&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_FRIENDS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- IF { $ERROR } --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;!-- ENDIF --&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_YOUR_FRIENDS }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_YOUR_FRIENDS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $S_USERNAME_OPTIONS } --&gt;&lt;select name=&quot;usernames[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;{ $S_USERNAME_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NO_FRIENDS }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADD_FRIENDS }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ADD_FRIENDS_EXPLAIN } [ &lt;a href=&quot;{ $U_SEARCH_USER}&quot; onclick=&quot;window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false&quot;&gt;{$L_FIND_USERNAME}&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;textarea name=&quot;add&quot; rows=&quot;5&quot; cols=&quot;30&quot;&gt;{ $USERNAMES }&lt;/textarea&gt;&lt;br /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
+&lt;form name=&quot;ucp&quot; method=&quot;post&quot; action=&quot;{ $S_UCP_ACTION }&quot;&lt;!-- IF isset({ $S_FORM_ENCTYPE }) --&gt;{ $S_FORM_ENCTYPE }&lt;!-- ENDIF --&gt; &gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;{$L_TITLE}&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_FRIENDS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- IF { $ERROR } --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot; style=&quot;color:red&quot;&gt;{ $ERROR }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_YOUR_FRIENDS }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_YOUR_FRIENDS_EXPLAIN }&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $S_USERNAME_OPTIONS } --&gt;&lt;select name=&quot;usernames[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;{ $S_USERNAME_OPTIONS }&lt;/select&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_NO_FRIENDS }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ADD_FRIENDS }:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_ADD_FRIENDS_EXPLAIN } [ &lt;a href=&quot;{ $U_SEARCH_USER}&quot; onclick=&quot;window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false&quot;&gt;{$L_FIND_USERNAME}&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;textarea name=&quot;add&quot; rows=&quot;5&quot; cols=&quot;30&quot;&gt;{ $USERNAMES }&lt;/textarea&gt;&lt;br /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;{ $S_HIDDEN_FIELDS }&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;button&quot; type=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; name=&quot;reset&quot; /&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
 
 &lt;!-- INCLUDE modules/Control_Panel/ucp_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/overall_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/overall_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Forums/overall_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -14,4 +14,4 @@
 &lt;!-- IF { $U_ACP } --&gt;&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;{ $U_ACP }&quot;&gt;{ $L_ACP }&lt;/a&gt; ]&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;!-- ENDIF --&gt;
 Based on &lt;a href=&quot;<A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>&quot; target=&quot;phpbb&quot;&gt;phpBB&lt;/a&gt;&lt;/div&gt;
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $THEME_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/overall_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,4 +1,4 @@
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 &lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot;&gt;
 	&lt;tr&gt;
@@ -12,7 +12,9 @@
 		&lt;!-- IF { $S_USER_LOGGED_IN } --&gt;&nbsp; &nbsp;&lt;a href=&quot;{ $U_PROFILE }&quot;&gt;&lt;img src=&quot;{ $T_IMAGE_PATH }icon_mini_profile.gif&quot; width=&quot;12&quot; height=&quot;13&quot; border=&quot;0&quot; alt=&quot;{ $L_PROFILE }&quot; /&gt; { $L_PROFILE }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;/table&gt;
+
 &lt;br/&gt;
+
 &lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot;&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;gensmall&quot;&gt;&lt;!-- IF { $S_USER_LOGGED_IN } --&gt;{$LAST_VISIT_DATE}&lt;!-- ENDIF --&gt;&lt;/td&gt;

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -83,10 +83,6 @@
 			&lt;!-- IF { $leader_row:U_PM } --&gt;&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;{ $leader_row:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $leader_row:U_EMAIL } --&gt;&lt;a href=&quot;{ $leader_row:U_EMAIL }&quot;&gt;{ $EMAIL_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $leader_row:U_WWW } --&gt;&lt;a href=&quot;{ $leader_row:U_WWW }&quot; target=&quot;_blank&quot;&gt;{ $WWW_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-			&lt;!-- IF isset({ $leader_row:S_PROFILE_FIELD1 }) --&gt;
-			&lt;!-- Use a construct like this to include admin defined profile fields. Replace FIELD1 with the name of your field. --&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{$leader_row:PROFILE_FIELD1_VALUE}&lt;/td&gt;
-			&lt;!-- ENDIF --&gt;
 			&lt;!-- IF { $S_SEARCH_USER } --&gt;&lt;td align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;user&quot; value=&quot;{$leader_row:USERNAME}&quot; /&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
 
 		&lt;/tr&gt;
@@ -113,12 +109,7 @@
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;{ $member_row:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $member_row:U_EMAIL } --&gt;&lt;a href=&quot;{ $member_row:U_EMAIL }&quot;&gt;{ $EMAIL_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $member_row:U_WWW } --&gt;&lt;a href=&quot;{ $member_row:U_WWW }&quot; target=&quot;_blank&quot;&gt;{ $WWW_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-			&lt;!-- IF isset({ $member_row:S_PROFILE_FIELD1 }) --&gt;
-			&lt;!-- Use a construct like this to include admin defined profile fields. Replace FIELD1 with the name of your field. --&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $member_row:PROFILE_FIELD1_VALUE }&lt;/td&gt;
-			&lt;!-- ENDIF --&gt;
 			&lt;!-- IF { $S_SEARCH_USER } --&gt;&lt;td align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;user&quot; value=&quot;{ $member_row:USERNAME }&quot; /&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
-
 		&lt;/tr&gt;
 		&lt;!-- LOOPELSE --&gt;
 		&lt;tr&gt;

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -13,4 +13,4 @@
 &lt;div style=&quot;text-align: center;&quot; class=&quot;copyright&quot;&gt;
 Based on &lt;a href=&quot;<A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>&quot; target=&quot;phpbb&quot;&gt;phpBB&lt;/a&gt;&lt;/div&gt;
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $THEME_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -16,4 +16,4 @@
 //--&gt;
 &lt;/script&gt;
 
-{ $A_TABLE_OPEN }
\ No newline at end of file
+{ $THEME_TABLE_OPEN }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Quick_Message/index.html
===================================================================
--- cms/trunk/includes/templates/modules/Quick_Message/index.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Quick_Message/index.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,12 +1,12 @@
 &lt;!-- DISPLAY_HEADER --&gt;
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 &lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellpadding=&quot;1&quot; cellspacing=&quot;1&quot;&gt;
 	&lt;tbody&gt;
 		&lt;tr&gt;
 			&lt;th width=&quot;20%&quot;&gt;{ $L_POSTER }&lt;/th&gt;
-			&lt;th width=&quot;80%&quot; colspan=&quot;2&quot;&gt;{ $L_MESSAGE }&lt;/th&gt;
+			&lt;th width=&quot;80%&quot;&gt;{ $L_MESSAGE }&lt;/th&gt;
 		&lt;/tr&gt;
 		&lt;tr&gt;
 			&lt;td class=&quot;spacer&quot; colspan=&quot;2&quot; height=&quot;7&quot;&gt;&lt;/td&gt;
@@ -40,18 +40,12 @@
 					{ $L_NO_POST }
 				&lt;/td&gt;
 			&lt;/tr&gt;
-		&lt;!-- ENDLOOP --&gt;
+		&lt;!-- ENDLOOP $quick_message --&gt;
 
-		&lt;!-- IF { $Q_MESSAGE_PAGINATION } --&gt;
-		&lt;tr class=&quot;row2&quot;&gt;
-			&lt;td style=&quot;padding: 5px;&quot; valign=&quot;middle&quot; colspan=&quot;2&quot;&gt;
-				&lt;div style=&quot;padding-right: 5px; text-align: right;&quot;&gt;{ $Q_MESSAGE_PAGINATION }&lt;/div&gt;
-			&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;!-- ENDIF --&gt;
+
 	&lt;/tbody&gt;
 &lt;/table&gt;
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 &lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/user.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -34,8 +34,7 @@
 	var $img = array();
 
 	var $time_format;
-	var $timezone;
-	var $dst;
+	var $time_offset;
 
 	var $is_admin;
 	var $is_bot;
@@ -99,10 +98,10 @@
 		// user and gmt
 		if ($conversion == 'gmt')
 		{
-			return ($time - $this-&gt;timezone - $this-&gt;dst);
+			return ($time - $this-&gt;time_offset);
 		}
 
-		return $time + $this-&gt;timezone + $this-&gt;dst;
+		return $time + $this-&gt;time_offset;
 	}
 
 	function login($id = ANONYMOUS, $admin_login = false, $hidden = false, $auto_log = false)
@@ -266,8 +265,13 @@
 		$this-&gt;lang_path = SITE_FILE_ROOT.'language/' . $this-&gt;lang_name . '/';
 
 		$this-&gt;time_format = ($this-&gt;data['user_time_format']) ? $this-&gt;data['user_time_format'] : $_CORE_CONFIG['global']['default_dateformat'];
-		$this-&gt;timezone = ($this-&gt;data['user_timezone']) ? $this-&gt;data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
+		$this-&gt;time_offset = ($this-&gt;data['user_timezone']) ? $this-&gt;data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
 
+		if ($this-&gt;data['user_dst'])
+		{
+			$this-&gt;time_offset += 3600;
+		}
+
 		require($this-&gt;lang_path . 'common.php');
 	}
 

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/install/build_tables.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -593,8 +593,8 @@
 $_CLASS['core_db']-&gt;add_table_field_char('topic_title', 50);
 $_CLASS['core_db']-&gt;add_table_field_int('topic_poster', array('max' =&gt; 16000000));
 field_unix_time('topic_time');
-$_CLASS['core_db']-&gt;add_table_field_int('topic_views', array('max' =&gt; 16000000, 'null' =&gt; true));
-$_CLASS['core_db']-&gt;add_table_field_int('topic_replies', array('max' =&gt; 16000000, 'null' =&gt; true));  
+$_CLASS['core_db']-&gt;add_table_field_int('topic_views', array('max' =&gt; 16000000));
+$_CLASS['core_db']-&gt;add_table_field_int('topic_replies', array('max' =&gt; 16000000));  
 $_CLASS['core_db']-&gt;add_table_field_int('topic_status', array('max' =&gt; 1));
 $_CLASS['core_db']-&gt;add_table_field_int('topic_type', array('max' =&gt; 1));
 
@@ -602,14 +602,14 @@
 $_CLASS['core_db']-&gt;add_table_field_int('topic_last_post_id', array('max' =&gt; 16000000, 'null' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_int('topic_first_post_id', array('max' =&gt; 16000000, 'null' =&gt; true));
 
-$_CLASS['core_db']-&gt;add_table_field_int('topic_moved_id', array('max' =&gt; 16000000, 'null' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_int('topic_moved_id', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_int('icon_id', array('max' =&gt; 200));
 
 $_CLASS['core_db']-&gt;add_table_field_int('topic_attachment', array('max' =&gt; 1));
 $_CLASS['core_db']-&gt;add_table_field_int('topic_approved', array('max' =&gt; 1));
 $_CLASS['core_db']-&gt;add_table_field_int('topic_reported', array('max' =&gt; 1, 'null' =&gt; true)); 
 field_unix_time('topic_time_limit', true);
-$_CLASS['core_db']-&gt;add_table_field_int('topic_replies_real', array('max' =&gt; 16000000, 'null' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_int('topic_replies_real', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_char('topic_first_poster_name', 50);
 $_CLASS['core_db']-&gt;add_table_field_int('topic_last_poster_id', array('max' =&gt; 16000000, 'null' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_char('topic_last_poster_name', 50, true);
@@ -899,7 +899,7 @@
 $_CLASS['core_db']-&gt;add_table_field_int('folder_id', array('max' =&gt; 16000000, 'auto_increment' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_int('user_id', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_char('folder_name', 40);
-$_CLASS['core_db']-&gt;add_table_field_int('pm_count', array('max' =&gt; 16000000, 'null' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_int('pm_count', array('max' =&gt; 16000000));
 
 $_CLASS['core_db']-&gt;add_table_index('folder_id', 'primary');
 $_CLASS['core_db']-&gt;add_table_index('user_id');

Modified: cms/trunk/javascript/common.js
===================================================================
--- cms/trunk/javascript/common.js	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/javascript/common.js	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,5 +1,8 @@
 // By Ryan Marshall ( <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A> )
 
+var is_ie		= (navigator.appName == 'Microsoft Internet Explorer');
+var is_gecko	= (navigator.userAgent.indexOf('Gecko') != -1)
+
 function get_cookie(cookie_name)
 {
 	var cookie_prefix = cookie_name + &quot;=&quot;;

Modified: cms/trunk/javascript/menu.js
===================================================================
--- cms/trunk/javascript/menu.js	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/javascript/menu.js	2005-09-27 23:57:50 UTC (rev 143)
@@ -9,14 +9,18 @@
 *	
 */
 
-// Move this to like a global javascript file
-var is_ie		= (navigator.appName == &quot;Microsoft Internet Explorer&quot;);
-var is_gecko	= (navigator.userAgent.indexOf('Gecko') != -1)
-
 var slider_id = new Array();
 var slider_height = new Array();
 var active_menu = false;
+var menu_time_out = false;
 
+/*
+document.onclick		= function (e)
+{
+	menu_hide();
+}
+*/
+
 function get_offsets(element)
 {
 	var offsets = new Array();
@@ -43,9 +47,10 @@
 		return;
 	}
 
+	/*
 	object.onclick = function()
 	{
-		/* Open or close the menu */
+		// Open or close the menu 
 		if (menu.style.display == 'none')
 		{
 			menu_show(object_name);
@@ -57,41 +62,71 @@
 
 		return false;
 	}
-	
-/*
-	need to read more to get these working :-(
+	*/
 
-	object.onmouseover = function()
+// Clean this section up
+	menu.onmouseover = function(e)
 	{
-		//menu_show(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
 	}
-	
-	object.onmouseout = function(e)
-	{
-		menu_hide(object_name);
-	}
 
 	menu.onmouseout = function(e)
 	{
-		menu_hide(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_time_out = window.setTimeout('menu_hide()', 200);
 	}
 
-	menu.onmouseover = function(e)
+	object.onmouseover = function(e)
 	{
-		this.onmouseout = function(e)
+		if (e)
 		{
-			menu_hide(object_name);
+			e.preventDefault();
+			e.stopPropagation();
 		}
-
-		e.preventDefault();
-		e.stopPropagation();
+		
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_show(object_name);
 	}
 
-	menu.onmouseout = function()
+	menu.onmouseout = function(e)
 	{
-		menu_hide(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_time_out = window.setTimeout('menu_hide()', 100);
 	}
-*/
 
 	menu.style.display	= 'none';
 	menu.style.position	= is_gecko ? 'fixed' : 'absolute';
@@ -101,6 +136,17 @@
 
 function menu_show(object_name)
 {
+	// If a menu is open, lets close it
+	if (active_menu)
+	{
+		if (active_menu == object_name)
+		{
+			return;
+		}
+
+		menu_hide(active_menu);
+	}
+
 	var menu		= document.getElementById(object_name + '_menu');
 	var object		= document.getElementById(object_name);
 
@@ -109,12 +155,6 @@
 		return;
 	}
 
-	// If a menu is open, lets close it
-	if (active_menu)
-	{
-		menu_hide(active_menu);
-	}
-
 	active_menu = object_name;
 
 	// best to do this everytime, incase the windows is resized
@@ -148,6 +188,11 @@
 {
 	if (!object_name)
 	{
+		if (!active_menu)
+		{
+			return
+		}
+
 		object_name = active_menu;
 	}
 

Modified: cms/trunk/modules/Control_Panel/index.php
===================================================================
--- cms/trunk/modules/Control_Panel/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -17,7 +17,8 @@
 }
 
 require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =&amp; $_CLASS['forums_auth'];
 
 $_CLASS['core_user']-&gt;user_setup();
 $_CLASS['core_user']-&gt;add_lang();
@@ -33,7 +34,7 @@
 
 //define the undefineds
 $_CLASS['core_template']-&gt;assign_array(array(
-	'S_DISPLAY_FORM'		=&gt; true,
+	'S_DISPLAY_FORM'		=&gt; false,
 	'S_SHOW_PM_BOX'			=&gt; false,
 	'S_SHOW_COLOUR_LEGEND'	=&gt; false,
 	'USERNAME'				=&gt; '',

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -42,6 +42,7 @@
 				$refresh_url = generate_link('Control_Panel&amp;i='.$id);
 				$_CLASS['core_display']-&gt;meta_refresh(3, $refresh_url);
 				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']-&gt;lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']-&gt;lang['ATTACHMENTS_DELETED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $refresh_url . '&quot;&gt;', '&lt;/a&gt;');
+
 				trigger_error($message);
 			}
 		}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -185,12 +185,10 @@
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'S_DISPLAY_FORM', true,
-			'S_UCP_ACTION' =&gt; ''
-		));
+		$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
 
 		$this-&gt;display($_CLASS['core_user']-&gt;get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
+		
 	}
 }
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -68,7 +68,7 @@
 
 		// Folder directly specified?
 		$folder_specified = get_variable('folder', 'REQUEST');
-		
+
 		if ($folder_specified)
 		{
 			if (is_numeric($folder_specified))
@@ -148,14 +148,16 @@
 
 				$_CLASS['core_db']-&gt;free_result($result);
 				
-				(int) $_CLASS['core_user']-&gt;data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+				(int) $_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 				
 				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
 
 				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_options.php');
 				message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
-				break;
 
+				$_CLASS['core_display']-&gt;display(false, 'modules/Control_Panel/ucp_pm_options.html');
+			break;
+
 			case 'drafts':
 				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
 			
@@ -182,7 +184,7 @@
 				list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
 				$_CLASS['core_db']-&gt;free_result($result);
 
-				$_CLASS['core_user']-&gt;data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+				$_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 
 				if ($folder_specified)
 				{
@@ -199,7 +201,7 @@
 				{
 					$folder_id = PRIVMSGS_INBOX;
 				}
-					
+
 				$msg_id = get_variable('p', 'REQUEST', 0, 'int');
 				$view	= get_variable('view', 'REQUEST');
 				
@@ -217,7 +219,7 @@
 					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
 					$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
 
-					if (move_pm($_CLASS['core_user']-&gt;data['user_id'], $_CLASS['core_user']-&gt;data['message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
+					if (move_pm($_CLASS['core_user']-&gt;data['user_id'], $_CLASS['core_user']-&gt;data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
 					{
 						// Return to folder view if single message moved
 						if ($action == 'view_message')
@@ -324,9 +326,9 @@
 						set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']-&gt;data['user_id'], $folder_id);
 					}
 				}
-				
+
 				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder, $folder_id);
-			
+	
 				$s_folder_options = $s_to_folder_options = '';
 				foreach ($folder as $f_id =&gt; $folder_ary)
 				{
@@ -337,7 +339,7 @@
 				}
 
 				clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
-	
+
 				// Header for message view - folder and so on
 				$folder_status = get_folder_status($folder_id, $folder);
 				$url = 'Control_Panel&amp;i='.$id;
@@ -380,7 +382,7 @@
 					$_CLASS['core_display']-&gt;display(false,  'modules/Control_Panel/ucp_pm_viewfolder.html');
 
 				}
-				else if ($action == 'view_message')
+				elseif ($action == 'view_message')
 				{
 					$_CLASS['core_template']-&gt;assign_array(array(
 						'S_VIEW_MESSAGE'=&gt; true,

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -24,8 +24,8 @@
 		'NONE_CONDITION'			=&gt; false,
 		'S_ACTION_DEFINED'			=&gt; false,
 		'NOTIFICATION_MESSAGE'		=&gt; false,
-		'rule'						=&gt; false)
-	);
+		'rule'						=&gt; false
+	));
 
 	// Change &quot;full folder&quot; setting - what to do if folder is full
 	if (isset($_POST['fullfolder']))
@@ -37,15 +37,19 @@
 		{
 			case 1:
 				$set_folder_id = FULL_FOLDER_DELETE;
-				break;
+			break;
+
 			case 2:
 				$set_folder_id = request_var('full_move_to', PRIVMSGS_INBOX);
-				break;
+			break;
+
 			case 3:
 				$set_folder_id = FULL_FOLDER_HOLD;
-				break;
+			break;
+
 			default:
 				$full_action = 0;
+			break;
 		}
 
 		if ($full_action)
@@ -71,32 +75,38 @@
 		if ($folder_name)
 		{
 			$sql = 'SELECT folder_name 
-				FROM ' . PRIVMSGS_FOLDER_TABLE . &quot;
-				WHERE folder_name = '&quot; . $_CLASS['core_db']-&gt;sql_escape($folder_name) . &quot;'
+				FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+				WHERE folder_name = '&quot; . $_CLASS['core_db']-&gt;escape($folder_name) . &quot;'
 					AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
 			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
-			if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			if ($row)
 			{
 				trigger_error(sprintf($_CLASS['core_user']-&gt;lang['FOLDER_NAME_EXIST'], $folder_name));
 			}
-			$_CLASS['core_db']-&gt;free_result($result);
 
-			$sql = 'SELECT COUNT(folder_id) as num_folder
-				FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			$sql = 'SELECT COUNT(*) as num_folder
+				FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 			$result = $_CLASS['core_db']-&gt;query($sql);
-			
-			if ($_CLASS['core_db']-&gt;sql_fetchfield('num_folder', 0, $result) &gt;= $config['pm_max_boxes'])
+			list($count) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($count &gt;= $config['pm_max_boxes'])
 			{
 				trigger_error('MAX_FOLDER_REACHED');
 			}
-			$_CLASS['core_db']-&gt;free_result($result);
 
-			$sql = 'INSERT INTO ' . PRIVMSGS_FOLDER_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'user_id' =&gt; (int) $_CLASS['core_user']-&gt;data['user_id'], 'folder_name' =&gt; $folder_name));
-			$_CLASS['core_db']-&gt;query($sql);
+			$sql_array = array(
+				'user_id' =&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'folder_name' =&gt; $folder_name,
+				'pm_count' =&gt; 0
+			);
 
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_FOLDER_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_array));
+
 			$message = $_CLASS['core_user']-&gt;lang['FOLDER_ADDED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;');
 			$_CLASS['core_display']-&gt;meta_refresh(3, $redirect_url);
 			trigger_error($message);
@@ -117,7 +127,7 @@
 
 		// Select custom folder
 		$sql = 'SELECT folder_name, pm_count
-			FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']-&gt;data['user_id'].&quot;
 				AND folder_id = $rename_folder_id&quot;;
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -129,8 +139,21 @@
 			trigger_error('CANNOT_RENAME_FOLDER');
 		}
 
-		$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . &quot; 
-			SET folder_name = '&quot; . $_CLASS['core_db']-&gt;sql_escape($new_folder_name) . &quot;'
+		$sql = 'SELECT folder_name 
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
+			WHERE folder_name = '&quot; . $_CLASS['core_db']-&gt;escape($new_folder_name) . &quot;'
+				AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if ($row)
+		{
+			trigger_error(sprintf($_CLASS['core_user']-&gt;lang['FOLDER_NAME_EXIST'], $new_folder_name));
+		}
+
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot; 
+			SET folder_name = '&quot; . $_CLASS['core_db']-&gt;escape($new_folder_name) . &quot;'
 			WHERE folder_id = $rename_folder_id
 				AND user_id = &quot;.$_CLASS['core_user']-&gt;data['user_id'];
 		$_CLASS['core_db']-&gt;query($sql);
@@ -150,17 +173,17 @@
 		$move_to = request_var('move_to', PRIVMSGS_INBOX);
 
 		// Move to same folder?
-		if ($remove_action == 1 &amp;&amp; $remove_folder_id == $move_to)
+		if ($remove_action == 1 &amp;&amp; $remove_folder_id === $move_to)
 		{
 			trigger_error('CANNOT_MOVE_TO_SAME_FOLDER');
 		}
-		
+
 		// Select custom folder
 		$sql = 'SELECT folder_name, pm_count
-			FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']-&gt;data['user_id'].&quot;
 				AND folder_id = $remove_folder_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		$folder_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -169,17 +192,19 @@
 			trigger_error('CANNOT_REMOVE_FOLDER');
 		}
 
-		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;remove_folder_id&quot; value=&quot;' . $remove_folder_id . '&quot; /&gt;';
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;remove_action&quot; value=&quot;' . $remove_action . '&quot; /&gt;';
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;move_to&quot; value=&quot;' . $move_to . '&quot; /&gt;';
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;remove_folder&quot; value=&quot;1&quot; /&gt;';
+		$hidden_fields = array(
+			'remove_folder_id'	=&gt; $remove_folder_id,
+			'remove_folder'		=&gt; 1,
+			'remove_action'		=&gt; $remove_action,
+			'move_to'			=&gt; $move_to,
+		);
 
 		// Do we need to confirm?
-		if (confirm_box(true))
+		if (display_confirmation($_CLASS['core_user']-&gt;get_lang('REMOVE_FOLDER'), generate_hidden_fields($hidden_fields)))
 		{
 			// Gather message ids
 			$sql = 'SELECT msg_id 
-				FROM ' . PRIVMSGS_TO_TABLE . '
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 					AND folder_id = $remove_folder_id&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
@@ -196,7 +221,7 @@
 			{
 				// Move Messages
 				case 1:
-					$message_limit = (!$_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
+					$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $_CLASS['core_user']-&gt;data['user_message_limit'] : $config['pm_max_msgs'];
 					$num_moved = move_pm($_CLASS['core_user']-&gt;data['user_id'], $message_limit, $msg_ids, $move_to, $remove_folder_id);
 					
 					// Something went wrong, only partially moved?
@@ -204,16 +229,16 @@
 					{
 						trigger_error(sprintf($_CLASS['core_user']-&gt;lang['MOVE_PM_ERROR'], $num_moved, $folder_row['pm_count']));
 					}
-					break;
+				break;
 
 				// Remove Messages
 				case 2:
 					delete_pm($_CLASS['core_user']-&gt;data['user_id'], $msg_ids, $remove_folder_id);
-					break;
+				break;
 			}
 
 			// Remove folder
-			$sql = 'DELETE FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 				WHERE user_id = '.$_CLASS['core_user']-&gt;data['user_id'].&quot;
 					AND folder_id = $remove_folder_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
@@ -236,10 +261,6 @@
 			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $meta_info . '&quot;&gt;', '&lt;/a&gt;');
 			trigger_error($message);
 		}
-		else
-		{
-			confirm_box(false, 'REMOVE_FOLDER', $s_hidden_fields);
-		}
 	}
 
 	// Add Rule
@@ -278,17 +299,18 @@
 		);
 
 		$sql = 'SELECT rule_id 
-			FROM ' . PRIVMSGS_RULES_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 			WHERE ' . $_CLASS['core_db']-&gt;sql_build_array('SELECT', $rule_ary);
-		$result = $_CLASS['core_db']-&gt;query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql, 1);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
-		if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		if ($row)
 		{
 			trigger_error('RULE_ALREADY_DEFINED');
 		}
-		$_CLASS['core_db']-&gt;free_result($result);
 		
-		$sql = 'INSERT INTO ' . PRIVMSGS_RULES_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $rule_ary);
+		$sql = 'INSERT INTO ' . FORUMS_PRIVMSGS_RULES_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $rule_ary);
 		$_CLASS['core_db']-&gt;query($sql);
 
 		$message = $_CLASS['core_user']-&gt;lang['RULE_ADDED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;');
@@ -312,7 +334,7 @@
 		// Do we need to confirm ?
 		if (confirm_box(true))
 		{
-			$sql = 'DELETE FROM ' . PRIVMSGS_RULES_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 					AND rule_id = $delete_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
@@ -331,10 +353,10 @@
 	}
 	
 	$folder = array();
-	$message_limit = (!$_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
+	$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']-&gt;data['user_message_limit'];
 
-	$sql = 'SELECT COUNT(msg_id) as num_messages
-		FROM ' . PRIVMSGS_TO_TABLE . '
+	$sql = 'SELECT COUNT(*) as num_messages
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 			AND folder_id = ' . PRIVMSGS_INBOX;
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -342,12 +364,12 @@
 	$_CLASS['core_db']-&gt;free_result($result);
 	
 	$folder[PRIVMSGS_INBOX] = array(
-		'folder_name'	=&gt; $_CLASS['core_user']-&gt;lang['PM_INBOX'], 
+		'folder_name'	=&gt; $_CLASS['core_user']-&gt;get_lang('PM_INBOX'),
 		'message_status'=&gt; sprintf($_CLASS['core_user']-&gt;lang['FOLDER_MESSAGE_STATUS'], $num_messages, $message_limit)
 	);
 
 	$sql = 'SELECT folder_id, folder_name, pm_count 
-		FROM ' . PRIVMSGS_FOLDER_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -355,6 +377,7 @@
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$num_user_folder++;
+
 		$folder[$row['folder_id']] = array(
 			'folder_name'	=&gt; $row['folder_name'], 
 			'message_status'=&gt; sprintf($_CLASS['core_user']-&gt;lang['FOLDER_MESSAGE_STATUS'], $row['pm_count'], $message_limit)
@@ -363,7 +386,9 @@
 	$_CLASS['core_db']-&gt;free_result($result);
 
 	$s_full_folder_options = $s_to_folder_options = $s_folder_options = '';
-	
+// temp
+$_CLASS['core_user']-&gt;data['user_full_folder'] = FULL_FOLDER_NONE;
+
 	if ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE)
 	{
 		// -3 here to let the correct folder id be selected
@@ -378,7 +403,7 @@
 	{
 		$s_full_folder_options .= '&lt;option value=&quot;' . $folder_id . '&quot;' . (($_CLASS['core_user']-&gt;data['user_full_folder'] == $folder_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')&lt;/option&gt;';
 		//$s_to_folder_options .= '&lt;option value=&quot;' . $folder_id . '&quot;' . (($to_folder_id == $folder_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')&lt;/option&gt;';
-		$s_to_folder_options .= '&lt;option value=&quot;' . $folder_id . '&gt;' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')&lt;/option&gt;';
+		$s_to_folder_options .= '&lt;option value=&quot;' . $folder_id . '&quot;&gt;' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')&lt;/option&gt;';
 	
 		if ($folder_id != PRIVMSGS_INBOX)
 		{
@@ -415,8 +440,8 @@
 
 		'DEFAULT_ACTION'		=&gt; ($config['full_folder_action'] == 1) ? $_CLASS['core_user']-&gt;lang['DELETE_OLDEST_MESSAGES'] : $_CLASS['core_user']-&gt;lang['HOLD_NEW_MESSAGES'],
 			
-		'U_FIND_USERNAME'		=&gt; generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=rule_string'))
-	);
+		'U_FIND_USERNAME'		=&gt; generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=rule_string')
+	));
 
 	$rule_lang = $action_lang = $check_lang = array();
 
@@ -434,21 +459,21 @@
 	$action_option	= request_var('action_option', '');
 	$back = (isset($_REQUEST['back'])) ? request_var('back', '') : array();
 
-	if (sizeof($back))
+	if (!empty($back))
 	{
 		if ($action_option)
 		{
 			$action_option = '';
 		}
-		else if ($cond_option)
+		elseif ($cond_option)
 		{
 			$cond_option = '';
 		}
-		else if ($rule_option)
+		elseif ($rule_option)
 		{
 			$rule_option = 0;
 		}
-		else if ($check_option)
+		elseif ($check_option)
 		{
 			$check_option = 0;
 		}
@@ -582,16 +607,17 @@
 	
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_COND_DEFINED'	=&gt; true,
-		'S_COND_SELECT'		=&gt; (!$hardcoded &amp;&amp; isset($global_rule_conditions[$rule_option])) ? true : false)
-	);
+		'S_COND_SELECT'		=&gt; (!$hardcoded &amp;&amp; isset($global_rule_conditions[$rule_option]))
+	));
 
 	// Define COND_OPTION
-	if (!isset($global_rule_conditions[$rule_option]))
+	if (empty($global_rule_conditions[$rule_option]))
 	{
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'COND_OPTION'	=&gt; 'none',
-			'COND_CURRENT'	=&gt; false)
-		);
+			'COND_CURRENT'	=&gt; false
+		));
+
 		return;
 	}
 	
@@ -612,36 +638,47 @@
 			);
 
 			$current_value = $rule_string;
-			break;
+		break;
 
 		case 'user':
 			$rule_user_id = request_var('rule_user_id', 0);
 			$rule_string = request_var('rule_string', '');
 
-			if ($rule_string &amp;&amp; !$rule_user_id)
+			if ($rule_string)
 			{
 				$sql = 'SELECT user_id
 					FROM ' . USERS_TABLE . &quot;
-					WHERE username = '&quot; . $_CLASS['core_db']-&gt;sql_escape($rule_string) . &quot;'&quot;;
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				
-				if (!($rule_user_id = $_CLASS['core_db']-&gt;sql_fetchfield('user_id', 0, $result)))
+					WHERE username = '&quot; . $_CLASS['core_db']-&gt;escape($rule_string) . &quot;'&quot;;
+				$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+				$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+	
+				if (!$row)
 				{
 					$rule_string = '';
 				}
-				$_CLASS['core_db']-&gt;free_result($result);
+				else
+				{
+					$rule_user_id = (int) $row['user_id'];
+				}
 			}
-			else if (!$rule_string &amp;&amp; $rule_user_id)
+			elseif ($rule_user_id)
 			{
 				$sql = 'SELECT username
 					FROM ' . USERS_TABLE . &quot;
 					WHERE user_id = $rule_user_id&quot;;
 				$result = $_CLASS['core_db']-&gt;query($sql);
-				
-				if (!($rule_string = $_CLASS['core_db']-&gt;sql_fetchfield('username', 0, $result)))
+				$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				if (!$row)
 				{
 					$rule_user_id = 0;
 				}
+				else
+				{
+					$rule_string = $row['username'];
+				}
 				$_CLASS['core_db']-&gt;free_result($result);
 			}
 
@@ -649,11 +686,11 @@
 				'S_USER_CONDITION'	=&gt; true,
 				'CURRENT_STRING'	=&gt; $rule_string,
 				'CURRENT_USER_ID'	=&gt; $rule_user_id,
-				'CURRENT_GROUP_ID'	=&gt; 0)
-			);
+				'CURRENT_GROUP_ID'	=&gt; 0
+			));
 
 			$current_value = $rule_string;
-			break;
+		break;
 
 		case 'group':
 			$rule_group_id = request_var('rule_group_id', 0);
@@ -663,21 +700,27 @@
 				'S_GROUP_CONDITION'	=&gt; true,
 				'CURRENT_STRING'	=&gt; $rule_string,
 				'CURRENT_USER_ID'	=&gt; 0,
-				'CURRENT_GROUP_ID'	=&gt; $rule_group_id)
-			);
+				'CURRENT_GROUP_ID'	=&gt; $rule_group_id
+			));
 
 			$current_value = $rule_string;
 
-			break;
+		break;
 
 		default:
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'COND_OPTION'	=&gt; 'none',
+				'COND_CURRENT'	=&gt; false
+			));
+
 			return;
+		break;
 	}
 
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'COND_OPTION'	=&gt; $condition,
-		'COND_CURRENT'	=&gt; $current_value)
-	);
+		'COND_CURRENT'	=&gt; $current_value
+	));
 }
 
 function show_defined_rules($user_id, $check_lang, $rule_lang, $action_lang, $folder)
@@ -685,7 +728,7 @@
 	global $_CLASS;
 
 	$sql = 'SELECT *
-		FROM ' . PRIVMSGS_RULES_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 		WHERE user_id = ' . $user_id;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 	

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -22,9 +22,7 @@
 {
 	global $_CLASS, $config;
 	
-	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
 	
@@ -68,7 +66,7 @@
 	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']-&gt;data['user_id'], &quot;Control_Panel&amp;i=$id&quot;, $type);
 
 	// Okay, lets dump out the page ...
-	if (sizeof($folder_info['pm_list']))
+	if (!empty($folder_info['pm_list']))
 	{
 		// Build Recipient List if in outbox/sentbox - max two additional queries
 		$recipient_list = $address_list = $address = array();
@@ -190,7 +188,7 @@
 
 	$start		= request_var('start', 0);
 
-	//$sort_days	= request_var('st', ((!empty($_CLASS['core_user']-&gt;data['user_post_show_days'])) ? $_CLASS['core_user']-&gt;data['user_post_show_days'] : 0));
+	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']-&gt;data['user_post_show_days'])) ? $_CLASS['core_user']-&gt;data['user_post_show_days'] : 0));
 	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_type'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_type'] : 't'));
 	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_dir'] : 'd'));
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -27,52 +27,38 @@
 
 				if ($submit)
 				{
-					$var_ary = array(
-						'dateformat'		=&gt; (string) $_CORE_CONFIG['global']['default_dateformat'], 
-						'lang'				=&gt; (string) $_CORE_CONFIG['global']['default_lang'], 
-						'tz'				=&gt; (float) $_CORE_CONFIG['global']['default_timezone'] / 3600,
-						'theme'				=&gt; (string) $_CORE_CONFIG['global']['default_theme'], 
-						'dst'				=&gt; (bool) $_CORE_CONFIG['global']['default_dst'], 
-						'viewemail'			=&gt; false, 
-						'massemail'			=&gt; true, 
-						'hideonline'		=&gt; false, 
-						'notifymethod'		=&gt; 0, 
-						'notifypm'			=&gt; true, 
-						'popuppm'			=&gt; false, 
-						'allowpm'			=&gt; true,
-						'report_pm_notify'	=&gt; false
-					);
+					$time_format	= get_variable('time_format', 'REQUEST', null);
+					$lang			= get_variable('lang', 'REQUEST', null);
+					$tz				= get_variable('tz', 'REQUEST', null);
+					$dst			= get_variable('dst', 'REQUEST', null);
 
-					foreach ($var_ary as $var =&gt; $default)
-					{
-						$data[$var] = request_var($var, $default);
-					}
+					$theme 		= get_variable('theme', 'REQUEST', null);
+	
+					$viewemail		= (bool) get_variable('viewemail', 'REQUEST', true, 'interger');
+					$massemail		= (bool) get_variable('massemail', 'REQUEST', false, 'interger');
+					$hideonline	= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
+					$notifypm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
 
-					$var_ary = array(
-						'lang'			=&gt; array('match', false, '#^[a-z_]{2,}$#i'),
-						'tz'			=&gt; array('num', false, -13, 13),
-					);
+					$popuppm	= (bool) get_variable('popuppm', 'REQUEST', true, 'interger');
+					$allowpm	= (bool) get_variable('allowpm', 'REQUEST', true, 'interger');
+				//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
 
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if (!sizeof($error))
+					if (empty($error))
 					{
 						$_CLASS['core_user']-&gt;optionset('popuppm', $popuppm);
-						$_CLASS['core_user']-&gt;optionset('report_pm_notify', $report_pm_notify);
+						//$_CLASS['core_user']-&gt;optionset('report_pm_notify', $report_pm_notify);
 						
 						$sql_ary = array(
 							'user_allow_pm'			=&gt; $allowpm, 
 							'user_allow_viewemail'	=&gt; $viewemail, 
 							'user_allow_massemail'	=&gt; $massemail, 
-							'user_allow_viewonline'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']-&gt;data['user_allow_viewonline'], 
-							'user_notify_type'		=&gt; $notifymethod, 
+							'user_allow_viewonline'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']-&gt;data['user_allow_viewonline'], 
+							//'user_notify_type'		=&gt; $notifymethod, 
 							//'user_notify_pm'		=&gt; $notifypm,
 							'user_data'				=&gt; serialize($_CLASS['core_user']-&gt;data['user_data']), 
 
 							'user_dst'				=&gt; $dst,
-							'user_time_format'		=&gt; $dateformat,
+							'user_time_format'		=&gt; $time_format,
 							'user_lang'				=&gt; $lang,
 							'user_timezone'			=&gt; $tz * 3600,
 							'user_theme'			=&gt; $theme,
@@ -153,8 +139,8 @@
 					'DATE_FORMAT'		=&gt; $dateformat, 
 
 					'S_LANG_OPTIONS'	=&gt; select_language($lang), 
-					'S_THEME_OPTIONS'	=&gt; select_theme($theme),
-					'S_TZ_OPTIONS'		=&gt; select_tz($tz),
+					'S_THEME_OPTIONS'	=&gt; select_theme($theme, true),
+					'S_TZ_OPTIONS'		=&gt; select_tz($tz, true),
 					'S_CAN_HIDE_ONLINE'	=&gt; true, 
 					'S_SELECT_NOTIFY'	=&gt; ($config['jab_enable'] &amp;&amp; $_CLASS['core_user']-&gt;data['user_jabber'] &amp;&amp; @extension_loaded('xml')) ? true : false)
 				);
@@ -164,47 +150,30 @@
 
 				if ($submit)
 				{
-					$var_ary = array(
-						'topic_sk'	=&gt; (string) 't',
-						'topic_sd'	=&gt; (string) 'd',
-						'topic_st'	=&gt; 0,
+					$topic_sk 	= get_variable('topic_sk', 'REQUEST', 't');
+					$topic_sd	= get_variable('topic_sd', 'REQUEST', 'd');
+					$topic_st	= get_variable('topic_st', 'REQUEST', 0, 'interger');
+					
+					$post_sk 	= get_variable('post_sk', 'REQUEST', 't');
+					$post_sd	= get_variable('post_sd', 'REQUEST', 'd');
+					$post_st	= get_variable('post_st', 'REQUEST', 0, 'interger');
+	
+					$images		= (bool) get_variable('images', 'REQUEST', true, 'interger');
+					$flash		= (bool) get_variable('flash', 'REQUEST', false, 'interger');
+					$smilies	= (bool) get_variable('smilies', 'REQUEST', true, 'interger');
+					$sigs		= (bool) get_variable('sigs', 'REQUEST', true, 'interger');
+					$avatars	= (bool) get_variable('avatars', 'REQUEST', true, 'interger');
+					$wordcensor	= (bool) get_variable('wordcensor', 'REQUEST', true, 'interger');
 
-						'post_sk'	=&gt; (string) 't',
-						'post_sd'	=&gt; (string) 'a',
-						'post_st'	=&gt; 0,
-
-						'images'	=&gt; true, 
-						'flash'		=&gt; false, 
-						'smilies'	=&gt; true, 
-						'sigs'		=&gt; true, 
-						'avatars'	=&gt; true, 
-						'wordcensor'=&gt; false, 
-					);
-
-					foreach ($var_ary as $var =&gt; $default)
+					if (empty($error))
 					{
-						$data[$var] = request_var($var, $default);
-					}
-
-					$var_ary = array(
-						'topic_sk'	=&gt; array('string', false, 1, 1),
-						'topic_sd'	=&gt; array('string', false, 1, 1),
-						'post_sk'	=&gt; array('string', false, 1, 1),
-						'post_sd'	=&gt; array('string', false, 1, 1),
-					);
-
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if (!sizeof($error))
-					{
 						$_CLASS['core_user']-&gt;optionset('viewimg', $images);
 						$_CLASS['core_user']-&gt;optionset('viewflash', $flash);
 						$_CLASS['core_user']-&gt;optionset('viewsmilies', $smilies);
 						$_CLASS['core_user']-&gt;optionset('viewsigs', $sigs);
 						$_CLASS['core_user']-&gt;optionset('viewavatars', $avatars);
-						if ($_CLASS['auth']-&gt;acl_get('u_chgcensors'))
+
+						if ($_CLASS['forums_auth']-&gt;acl_get('u_chgcensors'))
 						{
 							$_CLASS['core_user']-&gt;optionset('viewcensors', $wordcensor);
 						}
@@ -229,18 +198,15 @@
 						$message = $_CLASS['core_user']-&gt;lang['PREFERENCES_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
 						trigger_error($message);
 					}
-					// Replace &quot;error&quot; strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
 				}
 
-				$topic_sk = (isset($topic_sk)) ? $topic_sk : ((!empty($_CLASS['core_user']-&gt;data['user_tpic_sortby_type'])) ? $_CLASS['core_user']-&gt;data['user_topic_sortby_type'] : 't');
-				$post_sk = (isset($post_sk)) ? $post_sk : ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_type'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_type'] : 't');
+				$topic_sd = empty($_CLASS['core_user']-&gt;data['user_topic_sortby_dir']) ? 'd' : $_CLASS['core_user']-&gt;data['user_topic_sortby_dir'];
+				$topic_sk = empty($_CLASS['core_user']-&gt;data['user_tpic_sortby_type']) ? 't' : $_CLASS['core_user']-&gt;data['user_topic_sortby_type'];
+				$topic_st = empty($_CLASS['core_user']-&gt;data['user_topic_show_days']) ? 0 : $_CLASS['core_user']-&gt;data['user_topic_show_days'];
 
-				$topic_sd = (isset($topic_sd)) ? $topic_sd : ((!empty($_CLASS['core_user']-&gt;data['user_topic_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_topic_sortby_dir'] : 'd');
-				$post_sd = (isset($post_sd)) ? $post_sd : ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_dir'] : 'd');
-				
-				$topic_st = (isset($topic_st)) ? $topic_st : ((!empty($_CLASS['core_user']-&gt;data['user_topic_show_days'])) ? $_CLASS['core_user']-&gt;data['user_topic_show_days'] : 0);
-				$post_st = (isset($post_st)) ? $post_st : ((!empty($_CLASS['core_user']-&gt;data['user_post_show_days'])) ? $_CLASS['core_user']-&gt;data['user_post_show_days'] : 0);
+				$post_sd = empty($_CLASS['core_user']-&gt;data['user_post_sortby_dir']) ? 'd' : $_CLASS['core_user']-&gt;data['user_post_sortby_dir'];
+				$post_sk = empty($_CLASS['core_user']-&gt;data['user_post_sortby_type']) ? 't' : $_CLASS['core_user']-&gt;data['user_post_sortby_type'];
+				$post_st = empty($_CLASS['core_user']-&gt;data['user_post_show_days']) ? 0 : $_CLASS['core_user']-&gt;data['user_post_show_days'];
 
 				$sort_dir_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
 				
@@ -282,28 +248,29 @@
 					}
 					${'s_sort_' . $sort_option . '_dir'} .= '&lt;/select&gt;';
 				}
-				
-				$images = (isset($images)) ? $images : $_CLASS['core_user']-&gt;optionget('viewimg');
+
+				$images 	= $_CLASS['core_user']-&gt;optionget('viewimg');
+				$flash		= $_CLASS['core_user']-&gt;optionget('viewflash');
+				$smilies	= $_CLASS['core_user']-&gt;optionget('viewsmilies');
+				$sigs		= $_CLASS['core_user']-&gt;optionget('viewsigs');
+				$avatars	= $_CLASS['core_user']-&gt;optionget('viewavatars');
+				$wordcensor = $_CLASS['core_user']-&gt;optionget('viewcensors');
+
 				$images_yes = ($images) ? ' checked=&quot;checked&quot;' : '';
 				$images_no = (!$images) ? ' checked=&quot;checked&quot;' : '';
-				$flash = (isset($flash)) ? $flash : $_CLASS['core_user']-&gt;optionget('viewflash');
 				$flash_yes = ($flash) ? ' checked=&quot;checked&quot;' : '';
 				$flash_no = (!$flash) ? ' checked=&quot;checked&quot;' : '';
-				$smilies = (isset($smilies)) ? $smilies : $_CLASS['core_user']-&gt;optionget('viewsmilies');
 				$smilies_yes = ($smilies) ? ' checked=&quot;checked&quot;' : '';
 				$smilies_no = (!$smilies) ? ' checked=&quot;checked&quot;' : '';
-				$sigs = (isset($sigs)) ? $sigs : $_CLASS['core_user']-&gt;optionget('viewsigs');
 				$sigs_yes = ($sigs) ? ' checked=&quot;checked&quot;' : '';
 				$sigs_no = (!$sigs) ? ' checked=&quot;checked&quot;' : '';
-				$avatars = (isset($avatars)) ? $avatars : $_CLASS['core_user']-&gt;optionget('viewavatars');
 				$avatars_yes = ($avatars) ? ' checked=&quot;checked&quot;' : '';
 				$avatars_no = (!$avatars) ? ' checked=&quot;checked&quot;' : '';
-				$wordcensor = (isset($wordcensor)) ? $wordcensor : $_CLASS['core_user']-&gt;optionget('viewcensors');
 				$wordcensor_yes = ($wordcensor) ? ' checked=&quot;checked&quot;' : '';
 				$wordcensor_no = (!$wordcensor) ? ' checked=&quot;checked&quot;' : '';
 
 				$_CLASS['core_template']-&gt;assign_array(array( 
-					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
+					'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
 					
 					'VIEW_IMAGES_YES'		=&gt; $images_yes, 
 					'VIEW_IMAGES_NO'		=&gt; $images_no, 
@@ -318,78 +285,64 @@
 					'DISABLE_CENSORS_YES'	=&gt; $wordcensor_yes, 
 					'DISABLE_CENSORS_NO'	=&gt; $wordcensor_no,
 
-					'S_CHANGE_CENSORS'		=&gt; ($_CLASS['auth']-&gt;acl_get('u_chgcensors')) ? true : false, 
+					'S_CHANGE_CENSORS'		=&gt; $_CLASS['forums_auth']-&gt;acl_get('u_chgcensors'), 
 
 					'S_TOPIC_SORT_DAYS'		=&gt; $s_limit_topic_days,
 					'S_TOPIC_SORT_KEY'		=&gt; $s_sort_topic_key,
 					'S_TOPIC_SORT_DIR'		=&gt; $s_sort_topic_dir,
 					'S_POST_SORT_DAYS'		=&gt; $s_limit_post_days,
 					'S_POST_SORT_KEY'		=&gt; $s_sort_post_key,
-					'S_POST_SORT_DIR'		=&gt; $s_sort_post_dir)
-				);
-				
-				break;
+					'S_POST_SORT_DIR'		=&gt; $s_sort_post_dir
+				));
+			break;
 
 			case 'post':
-
 				if ($submit)
 				{
-					$var_ary = array(
-						'bbcode'	=&gt; true, 
-						'html'		=&gt; false, 
-						'smilies'	=&gt; true,
-						'sig'		=&gt; true, 
-						'notify'	=&gt; false, 
-					);
+					$bbcode 	= (bool) get_variable('bbcode', 'REQUEST', true, 'interger');
+					$html		= (bool) get_variable('html', 'REQUEST', false, 'interger');
+					$smilies	= (bool) get_variable('smilies', 'REQUEST', true, 'interger');
+					$sig		= (bool) get_variable('sig', 'REQUEST', true, 'interger');
+					$notify		= (bool) get_variable('notify', 'REQUEST', false, 'interger');
 
-					foreach ($var_ary as $var =&gt; $default)
-					{
-						$$var = request_var($var, $default);
-					}
-
 					$_CLASS['core_user']-&gt;optionset('bbcode', $bbcode);
 					$_CLASS['core_user']-&gt;optionset('html', $html);
 					$_CLASS['core_user']-&gt;optionset('smilies', $smilies);
 					$_CLASS['core_user']-&gt;optionset('attachsig', $sig);
 
-					if (!sizeof($error))
-					{
-						$sql_ary = array(
-							'user_data'		=&gt; serialize($_CLASS['core_user']-&gt;data['user_data']),
-							'user_notify'	=&gt; $notify,
-						);
+					$sql_ary = array(
+						'user_data'		=&gt; serialize($_CLASS['core_user']-&gt;data['user_data']),
+						'user_notify'	=&gt; $notify,
+					);
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;sql_query($sql);
+					$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
+								WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+					$_CLASS['core_db']-&gt;sql_query($sql);
 
-						$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
-						$message = $_CLASS['core_user']-&gt;lang['PREFERENCES_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
-						trigger_error($message);
-					}
-					// Replace &quot;error&quot; strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
+					$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
+					$message = $_CLASS['core_user']-&gt;lang['PREFERENCES_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
+					trigger_error($message);
 				}
-				
-				$bbcode = (isset($bbcode)) ? $bbcode : $_CLASS['core_user']-&gt;optionget('bbcode');
+
+				$bbcode = $_CLASS['core_user']-&gt;optionget('bbcode');
+				$html = $_CLASS['core_user']-&gt;optionget('html');
+				$smilies = $_CLASS['core_user']-&gt;optionget('smilies');
+				$notify = $_CLASS['core_user']-&gt;data['user_notify'];
+
 				$bbcode_yes = ($bbcode) ? ' checked=&quot;checked&quot;' : '';
-				$bbcode_no = (!$bbcode) ? ' checked=&quot;checked&quot;' : '';
-				$html = (isset($html)) ? $html : $_CLASS['core_user']-&gt;optionget('html');
+				$bbcode_no = (!$bbcode) ? ' checked=&quot;checked&quot;' : '';		
 				$html_yes = ($html) ? ' checked=&quot;checked&quot;' : '';
 				$html_no = (!$html) ? ' checked=&quot;checked&quot;' : '';
-				$smilies = (isset($smilies)) ? $smilies : $_CLASS['core_user']-&gt;optionget('smilies');
 				$smilies_yes = ($smilies) ? ' checked=&quot;checked&quot;' : '';
 				$smilies_no = (!$smilies) ? ' checked=&quot;checked&quot;' : '';
-				$sig = (isset($sig)) ? $sig : $_CLASS['core_user']-&gt;optionget('attachsig');
+				$sig = $_CLASS['core_user']-&gt;optionget('attachsig');
 				$sig_yes = ($sig) ? ' checked=&quot;checked&quot;' : '';
 				$sig_no = (!$sig) ? ' checked=&quot;checked&quot;' : '';
-				$notify = (isset($notify)) ? $notify : $_CLASS['core_user']-&gt;data['user_notify'];
 				$notify_yes = ($notify) ? ' checked=&quot;checked&quot;' : '';
 				$notify_no = (!$notify) ? ' checked=&quot;checked&quot;' : '';
 
-				$_CLASS['core_template']-&gt;assign_array(array( 
-					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'ERROR'				=&gt; empty($error) ? '' :  implode('&lt;br /&gt;', $error),
 
 					'DEFAULT_BBCODE_YES'	=&gt; $bbcode_yes, 
 					'DEFAULT_BBCODE_NO'		=&gt; $bbcode_no, 
@@ -400,18 +353,20 @@
 					'DEFAULT_SIG_YES'		=&gt; $sig_yes, 
 					'DEFAULT_SIG_NO'		=&gt; $sig_no, 
 					'DEFAULT_NOTIFY_YES'	=&gt; $notify_yes, 
-					'DEFAULT_NOTIFY_NO'		=&gt; $notify_no,)
-				);
-				break;
+					'DEFAULT_NOTIFY_NO'		=&gt; $notify_no,
+				));
+			break;
+			
+			default:
+				die;
+			break;
 		}
 
 		$_CLASS['core_template']-&gt;assign_array(array( 
 			'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['UCP_PREFS_' . strtoupper($mode)],
-			'S_PRIVMSGS'		=&gt; false,
-
 			'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields,
-			'S_UCP_ACTION'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;))
-		);
+			'S_UCP_ACTION'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;)
+		));
 
 		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_PROFILE'], 'ucp_prefs_' . $mode . '.html');
 	}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -30,7 +30,7 @@
 		$preview	= isset($_POST['preview']);
 		$submit		= isset($_POST['submit']);
 
-		$module_link	= generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;);
+		$module_link = generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;);
 
 		$error = $data = array();
 		$s_hidden_fields = '';
@@ -478,8 +478,8 @@
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_PROFILE_' . strtoupper($mode)],
 			'S_HIDDEN_FIELDS'			=&gt; $s_hidden_fields,
-			'S_UCP_ACTION'				=&gt; $module_link)
-		);
+			'S_UCP_ACTION'				=&gt; $module_link
+		));
 
 		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_PROFILE'], 'ucp_profile_' . $mode . '.html');
 	}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -29,7 +29,7 @@
 		
 		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
 		$submit		= isset($_POST['submit']);
-$_CORE_CONFIG['user']['activation'] = USER_ACTIVATION_SELF;
+
 		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
 			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			&amp;&amp; !$_CORE_CONFIG['email']['email_enable'])

Modified: cms/trunk/modules/Forums/admin/index.php
===================================================================
--- cms/trunk/modules/Forums/admin/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/admin/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -49,7 +49,9 @@
 
 $_CLASS['core_blocks']-&gt;add_block($data);
 
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =&amp; $_CLASS['forums_auth'];
+
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
 require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -29,9 +29,9 @@
 header('Content-Type: text/html');
 
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
-$_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
+$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
 
 Switch (get_variable('mode', 'POST', false))
 {
@@ -39,7 +39,7 @@
 		$forum_id = get_variable('id', 'POST', false, 'int');
 		$title = get_variable('title', 'POST', false);
 		
-		if (!$forum_id || !$title || !$_CLASS['auth']-&gt;acl_get('a_forum'))
+		if (!$forum_id || !$title || !$_CLASS['forums_auth']-&gt;acl_get('a_forum'))
 		{
 			die;
 		}
@@ -66,7 +66,7 @@
 		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		if (!$row || !$_CLASS['auth']-&gt;acl_get('m_edit', $row['forum_id']))
+		if (!$row || !$_CLASS['forums_auth']-&gt;acl_get('m_edit', $row['forum_id']))
 		{
 			die;
 		}
@@ -93,7 +93,7 @@
 		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		if (!$row || !$_CLASS['auth']-&gt;acl_get('m_lock', $row['forum_id']))
+		if (!$row || !$_CLASS['forums_auth']-&gt;acl_get('m_lock', $row['forum_id']))
 		{
 			die;
 		}
@@ -113,7 +113,7 @@
 		$forum_id = get_variable('id', 'POST', false, 'int');
 		$lock = get_variable('lock', 'POST', 0, 'int');
 
-		if (!$forum_id || !$_CLASS['auth']-&gt;acl_get('a_forum', $forum_id))
+		if (!$forum_id || !$_CLASS['forums_auth']-&gt;acl_get('a_forum', $forum_id))
 		{
 			die;
 		}

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -33,8 +33,10 @@
 unset($approved_files);
 
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
+$_CLASS['auth'] =&amp; $_CLASS['forums_auth'];
+
 $_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
 
 $_CLASS['core_user']-&gt;user_setup();

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/mcp.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -212,7 +212,7 @@
 {
 	$_REQUEST['action'] = $action = $mode;
 	$mode = 'topic_view';
-	$quickmod = false;
+	$quick_mod = false;
 }
 
 // Forum view modes
@@ -220,7 +220,7 @@
 {
 	$_REQUEST['action'] = $action = $mode;
 	$mode = 'forum_view';
-	$quickmod = false;
+	$quick_mod = false;
 }
 
 if (!$quick_mod)
@@ -228,16 +228,19 @@
 	switch ($mode)
 	{
 		case 'front':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			script_close(false);
 			//$this-&gt;display($_CLASS['core_user']-&gt;lang['MCP'], 'mcp_front.html');
 		break;
 
 		case 'forum_view':
 			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_forum.php');
+			script_close(false);
 		break;
 		
 		case 'topic_view':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+			script_close(false);
 		break;
 			
 		case 'post_details':
@@ -245,41 +248,145 @@
 			
 			mcp_post_details($id, $mode, $action, $url);
 			
-			$this-&gt;display($_CLASS['core_user']-&gt;lang['MCP'], 'mcp_post.html');
+			$this-&gt;display($_CLASS['core_user']-&gt;lang['MCP'], 'mcp_post.html');
+			script_close(false);
 		break;
-
-		default:
-			require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
-		break;
 	}
 
-	script_close(false);
+	//script_close(false);
 }
 
+require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+	
 switch ($mode)
 {
 	case 'lock':
 	case 'unlock':
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		lock_unlock($mode, $topic_ids);
+	break;
+
 	case 'lock_post':
 	case 'unlock_post':
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		lock_unlock($mode, $post_ids);
+	break;
+
+	case 'make_announce':
 	case 'make_sticky':
-	case 'make_announce':
 	case 'make_global':
 	case 'make_normal':
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		change_topic_type($mode, $topic_ids);
+	break;
+
+	case 'move':
+		$_CLASS['core_user']-&gt;add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_move_topic($topic_ids);
+	break;
+
 	case 'fork':
-	case 'move':
-	case 'delete_post':
+		$_CLASS['core_user']-&gt;add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_fork_topic($topic_ids);
+	break;
+
 	case 'delete_topic':
-		require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+		$_CLASS['core_user']-&gt;add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_delete_topic($topic_ids);
 	break;
 
+	case 'delete_post':
+		$_CLASS['core_user']-&gt;add_lang('posting');
+
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		mcp_delete_post($post_ids);
+	break;
+
 	default:
-		trigger_error(&quot;$mode not allowed as quickmod&quot;);
+		trigger_error(&quot;Unknown mode: $mode&quot;);
 	break;
 }
 
 script_close(false);
 
+function get_topic_ids($quick_mod)
+{
+	$topic_ids = array_unique(get_variable('topic_id_list', 'POST', array(), 'array:int'));
+
+	if (empty($topic_ids))
+	{
+		if ($topic_ids = get_variable('t', 'REQUEST', false, 'int'))
+		{
+			$topic_ids = array($topic_ids);
+		}
+	}
+
+	return $topic_ids;
+}
+
+function get_post_ids($quick_mod)
+{
+	$post_ids = array_unique(get_variable('post_id_list', 'POST', array(), 'array:int'));
+
+	if (empty($post_ids))
+	{
+		if ($post_ids = get_variable('p', 'REQUEST', false, 'int'))
+		{
+			$post_ids = array($post_ids);
+		}
+	}
+
+	return $post_ids;
+}
+
 // Get simple topic data
 function get_topic_data($topic_ids, $acl_list = false)
 {
@@ -377,7 +484,7 @@
 	global $_CLASS;
 
 	$sort_days = request_var('sort_days', 0);
-	$min_time = ($sort_days) ? time() - ($sort_days * 86400) : 0;
+	$min_time = ($sort_days) ? $_CLASS['core_user']-&gt;time - ($sort_days * 86400) : 0;
 
 	switch ($mode)
 	{

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/posting.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -1542,7 +1542,7 @@
 				'poll_max_options'			=&gt; isset($poll['poll_options']) ? $poll['poll_max_options'] : 1,
 				'poll_length'				=&gt; isset($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
 				'poll_vote_change'			=&gt; isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
-				'topic_attachment'			=&gt; ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0) : $data['topic_attachment']
+				'topic_attachment'			=&gt; ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0) : (int) $data['topic_attachment']
 			);
 			break;
 	}
@@ -1743,9 +1743,7 @@
 					'thumbnail'			=&gt; $attach_row['thumbnail']
 				);
 
-				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
-					$_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql);
-				$_CLASS['core_db']-&gt;query($sql);
+				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql));
 
 				$space_taken += $attach_row['filesize'];
 				$files_added++;
@@ -1855,13 +1853,21 @@
 	// Topic Notification
 	if (!$data['notify_set'] &amp;&amp; $data['notify'])
 	{
-		$sql = 'INSERT INTO ' . FORUMS_TOPICS_WATCH_TABLE . ' (user_id, topic_id)
-			VALUES (' . $_CLASS['core_user']-&gt;data['user_id'] . ', ' . $data['topic_id'] . ')';
-		$_CLASS['core_db']-&gt;query($sql);
+		$notify_sql = array(
+			'user_id'		=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+			'forum_id'		=&gt; $data['forum_id'],
+			'topic_id'		=&gt; $data['topic_id'],
+			'notify_type'	=&gt; $poster_id,
+			'notify_status'	=&gt; 0,
+		);
+				
+		$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $notify_sql));
+
+		unset($notify_sql);
 	}
 	else if ($data['notify_set'] &amp;&amp; !$data['notify'])
 	{
-		$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 				AND topic_id = ' . $data['topic_id'];
 		$_CLASS['core_db']-&gt;query($sql);

Modified: cms/trunk/modules/Forums/search.php
===================================================================
--- cms/trunk/modules/Forums/search.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/search.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -194,7 +194,7 @@
 
 				$last_post_time = ($_CLASS['core_user']-&gt;time - ($sort_days * 24 * 3600));
 
-				$sql = 'SELECT DISTINCT t.topic_id
+				$sql = 'SELECT DISTINCT t.topic_id, t.topic_last_post_time
 					FROM ' . FORUMS_POSTS_TABLE . ' p
 					LEFT JOIN ' . FORUMS_TOPICS_TABLE . &quot; t ON (t.topic_approved = 1 AND p.topic_id = t.topic_id)
 					WHERE p.post_time &gt; $last_post_time
@@ -773,13 +773,13 @@
 			{
 				$replies = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
 	
-				$folder_img = $folder_alt = $topic_type = '';
-				topic_status($row, $replies, $_CLASS['core_user']-&gt;time, $folder_img, $folder_alt, $topic_type);
+				$folder_img = $unread_topic = $folder_alt = $topic_type = '';
+				topic_status($row, $replies, $_CLASS['core_user']-&gt;time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
 				$pagination = generate_pagination($view_topic_url, $replies, $config['posts_per_page'], 0);
 
 				$tpl_ary = array(
-					'TOPIC_AUTHOR' 		=&gt; topic_topic_author($row),
+					'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
 					'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
 					'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
 					'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -183,7 +183,7 @@
 }
 
 //Check for read permission
-if (!$_CLASS['auth']-&gt;acl_get('f_read', $forum_id) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_', $forum_id))
+if (!$_CLASS['auth']-&gt;acl_get('f_read', $forum_id))// &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_', $forum_id)
 {
 	if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS)
 	{

Modified: cms/trunk/modules/Members_List/index.php
===================================================================
--- cms/trunk/modules/Members_List/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Members_List/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -28,7 +28,8 @@
 }
 
 require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =&amp; $_CLASS['forums_auth'];
 
 $_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
 
@@ -46,10 +47,9 @@
 $action		= request_var('action', '');
 $user_id	= request_var('u', ANONYMOUS);
 $group_id	= request_var('g', 0);
-$topic_id	= request_var('t', 0);
 
 $start		= request_var('start', 0);
-$submit		= (isset($_POST['submit'])) ? true : false;
+$submit		= isset($_POST['submit']);
 
 $sort_key	= request_var('sk', 'c');
 $sort_dir	= request_var('sd', 'a');
@@ -400,7 +400,7 @@
 		}
 
 		// Do the relevant calculations
-		$memberdays = max(1, round((time() - $member['user_reg_date']) / 86400));
+		$memberdays = max(1, round(($_CLASS['core_user']-&gt;time - $member['user_reg_date']) / 86400));
 		$posts_per_day = $member['user_posts'] / $memberdays;
 		$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
@@ -502,15 +502,16 @@
 		
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'MESSAGE' =&gt; false,
-			'SUBJECT' =&gt; false)
-		);
+			'SUBJECT' =&gt; false
+		));
 		
 		if (!$_CORE_CONFIG['email']['email_enable'])
 		{
 			trigger_error('EMAIL_DISABLED');
 		}
 
-		if (($user_id == ANONYMOUS || !$config['board_email_form']) &amp;&amp; !$topic_id)
+		// do soemthing better than this
+		if (($user_id === ANONYMOUS || !$config['board_email_form']) &amp;&amp; !$topic_id)
 		{
 			trigger_error('NO_EMAIL');
 		}
@@ -521,18 +522,21 @@
 		}
 
 		// Are we trying to abuse the facility?
-		if (time() - $_CLASS['core_user']-&gt;data['user_emailtime'] &lt; $config['flood_interval'])
+		/*
+		if (($_CLASS['core_user']-&gt;time - $_CLASS['core_user']-&gt;data['user_last_email']) &lt; $config['flood_interval'])
 		{
 			trigger_error('FLOOD_EMAIL_LIMIT');
 		}
+		*/
 
-		$name		= strip_tags(request_var('name', ''));
-		$email		= strip_tags(request_var('email', ''));
-		$email_lang = request_var('lang', '');
-		$subject	= request_var('subject', '');
-		$message	= request_var('message', '');
-		$cc			= (!empty($_POST['cc_email'])) ? true : false;
+		$name		= strip_tags(get_variable('name', 'POST'));
+		$email		= strip_tags(get_variable('email', 'POST'));
+		$subject	= get_variable('subject', 'POST');
+		$message	= get_variable('message', 'POST');
+		$cc			= !empty($_POST['cc_email']);
+		$topic_id	= get_variable('t', 'REQUEST', false, 'int');
 
+
 		// Are we sending an email to a user on this board? Or are we sending a
 		// topic heads-up message?
 		if (!$topic_id)
@@ -543,13 +547,14 @@
 				WHERE user_id = $user_id
 					AND user_type = &quot;. USER_NORMAL . ' AND user_status = ' . STATUS_ACTIVE;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
-			if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+			if (!$row)
 			{
 				trigger_error('NO_USER');
 			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
+			
 			// Can we send email to this user?
 			if (!$row['user_allow_viewemail'] &amp;&amp; !$_CLASS['auth']-&gt;acl_get('a_user'))
 			{
@@ -562,26 +567,22 @@
 				FROM ' . FORUMS_TOPICS_TABLE . &quot;
 				WHERE topic_id = $topic_id&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
-			if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+			if (!$row)
 			{
 				trigger_error('NO_TOPIC');
 			}
-			$_CLASS['core_db']-&gt;free_result($result);
 
 			if (!$_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id']))
 			{
 				trigger_error('NO_FORUM_READ');
 			}
-
-			if (!$_CLASS['auth']-&gt;acl_get('f_email', $row['forum_id']))
-			{
-				trigger_error('NO_EMAIL');
-			}
 		}
 
-		// User has submitted a message, handle it
 		$error = array();
+
 		if ($submit)
 		{
 			if (!$topic_id)
@@ -598,7 +599,7 @@
 			}
 			else
 			{
-				if (!$email || !preg_match('#^.*?@(.*?\.)?[a-z0-9\-]+\.[a-z]{2,4}$#i', $email))
+				if (!$email || !check_email($email))
 				{
 					$error[] = $_CLASS['core_user']-&gt;lang['EMPTY_ADDRESS_EMAIL'];
 				}
@@ -609,56 +610,66 @@
 				}
 			}
 
-			if (!sizeof($error))
+			if (empty($error))
 			{
+				/*
 				$sql = 'UPDATE ' . USERS_TABLE . '
-					SET user_emailtime = ' . gmtime() . '
+					SET user_last_email = ' . $_CLASS['core_user']-&gt;time . '
 					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 				$result = $_CLASS['core_db']-&gt;query($sql);
+				*/
 
 				// Add class loader
-				require_once($site_file_root.'includes/forums/functions_messenger.php');
 
-				$email_tpl	= (!$topic_id) ? 'profile_send_email' : 'email_notify';
-				$email_lang = (!$topic_id) ? $row['user_lang'] : $email_lang;
-				$email		= (!$topic_id) ? $row['user_email'] : $email;
+				require_once(SITE_FILE_ROOT.'includes/mailer.php');
+			
+				$mailer = new core_mailer;
 
-				$messenger = new messenger();
+				if ($topic_id)
+				{
+					$template	= 'email_notify.txt';
+					$email		= $email;
+					$subject	= $row['topic_title'];
+				}
+				else
+				{
+					$template	= 'profile_send_email.txt';
+					$email		= $row['user_email'];
+					$name 		= $row['username'];
+					$subject .= 'Email a friend';
+				}
 
-				$messenger-&gt;template($email_tpl, $email_lang);
-				$messenger-&gt;subject($subject);
 
-				$messenger-&gt;replyto($_CLASS['core_user']-&gt;data['user_email']);
-				$messenger-&gt;to($email, $row['username']);
+				$mailer-&gt;to($email, $name);
+				$mailer-&gt;reply_to($_CLASS['core_user']-&gt;data['user_email'], $_CLASS['core_user']-&gt;data['username']);
 
-				if (!$topic_id)
-				{
-					$messenger-&gt;im($row['user_jabber'], $row['username']);
-				}
-
+				$mailer-&gt;subject($subject);
+			
 				if ($cc)
 				{
-					$messenger-&gt;cc($_CLASS['core_user']-&gt;data['user_email'], $_CLASS['core_user']-&gt;data['username']);
+					$mailer-&gt;cc($_CLASS['core_user']-&gt;data['user_email'], $_CLASS['core_user']-&gt;data['username']);
 				}
 
-				$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-				$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-				$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-				$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
 
-				$messenger-&gt;assign_vars(array(
-					'SITENAME'		=&gt; $_CORE_CONFIG['global']['sitename'],
+				//$mailer-&gt;extra_header('X-AntiAbuse: Board servername - ' . $config['server_name']);
+				$mailer-&gt;extra_header('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
+				$mailer-&gt;extra_header('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
+				$mailer-&gt;extra_header('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
+
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
 					'BOARD_EMAIL'	=&gt; $config['board_contact'],
 					'FROM_USERNAME' =&gt; stripslashes($_CLASS['core_user']-&gt;data['username']),
-					'TO_USERNAME'   =&gt; ($topic_id) ? stripslashes($name) : stripslashes($row['username']),
+					'TO_USERNAME'   =&gt; ($topic_id) ? $name : $row['username'],
 					'MESSAGE'		=&gt; $message,
 					'TOPIC_NAME'	=&gt; ($topic_id) ? strtr($row['topic_title'], array_flip(get_html_translation_table(HTML_ENTITIES))) : '',
 
 					'U_TOPIC'	=&gt; ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . &quot;&amp;t=$topic_id&quot;, true, true, false) : '')
 				);
 
-				$messenger-&gt;send($row['user_notify_type']);
-				$messenger-&gt;save_queue();
+				$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/members_list/'.$template, true));
+				echo $mailer-&gt;message; die;
+				$mailer-&gt;send();
 
 				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link());
 				$message = (!$topic_id) ? sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;' . generate_link() . '&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'],  '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=&quot; . $row['topic_id']) . '&quot;&gt;', '&lt;/a&gt;');
@@ -994,7 +1005,7 @@
 
 		$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
 			FROM ' . SESSIONS_TABLE . '
-			WHERE session_time &gt;= ' . (time() - $_CORE_CONFIG['server']['session_length']) . '
+			WHERE session_time &gt;= ' . ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length']) . '
 				AND session_user_id &lt;&gt; ' . ANONYMOUS . '
 			GROUP BY session_user_id';
 		$result = $_CLASS['core_db']-&gt;query($sql);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000062.html">[Viperals-svncheckins] r142 - in cms/trunk: includes includes/forums includes/templates/modules/Control_Panel modules/Control_Panel/ucp modules/Forums
</A></li>
	<LI>Next message: <A HREF="000064.html">[Viperals-svncheckins] r144 - in cms/trunk: . blocks includes/forums modules/Forums themes/viperal themes/viperal/template
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63">[ date ]</a>
              <a href="thread.html#63">[ thread ]</a>
              <a href="subject.html#63">[ subject ]</a>
              <a href="author.html#63">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
