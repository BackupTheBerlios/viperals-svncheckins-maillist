<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r125 - in cms/trunk: . blocks includes includes/auth includes/forums includes/forums/admin install javascript javascript/forums modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal/template
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-September/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r125%20-%20in%20cms/trunk%3A%20.%20blocks%20includes%20includes/auth%20includes/forums%20includes/forums/admin%20install%20javascript%20javascript/forums%20modules/Control_Panel/ucp%20modules/Forums%20modules/Quick_Message%20themes/viperal/template&In-Reply-To=%3C200509151909.j8FJ9plV025104%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000045.html">
   <LINK REL="Next"  HREF="000047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r125 - in cms/trunk: . blocks includes includes/auth includes/forums includes/forums/admin install javascript javascript/forums modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal/template</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r125%20-%20in%20cms/trunk%3A%20.%20blocks%20includes%20includes/auth%20includes/forums%20includes/forums/admin%20install%20javascript%20javascript/forums%20modules/Control_Panel/ucp%20modules/Forums%20modules/Quick_Message%20themes/viperal/template&In-Reply-To=%3C200509151909.j8FJ9plV025104%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r125 - in cms/trunk: . blocks includes includes/auth includes/forums includes/forums/admin install javascript javascript/forums modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal/template">viperal at berlios.de
       </A><BR>
    <I>Thu Sep 15 21:09:51 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000045.html">[Viperals-svncheckins] r124 - in cms/trunk/modules: Quick_Message articles
</A></li>
        <LI>Next message: <A HREF="000047.html">[Viperals-svncheckins] r126 - in cms/trunk: blocks javascript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-09-15 21:09:49 +0200 (Thu, 15 Sep 2005)
New Revision: 125

Added:
   cms/trunk/includes/forums/functions_profile_fields.php
   cms/trunk/javascript/quick_messages.js
   cms/trunk/modules/Quick_Message/functions.php
Removed:
   cms/trunk/includes/forums/admin/admin_ban.php
   cms/trunk/themes/viperal/template/message.html
Modified:
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/forums/admin/admin_attachments.php
   cms/trunk/includes/forums/admin/admin_board.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/tables.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/javascript/forums/forum_view.js
   cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
   cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
   cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
   cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
   cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php
   cms/trunk/modules/Forums/download.php
   cms/trunk/modules/Quick_Message/index.php
Log:
Just something to test ajax on quick message module ( will change when a ajax frontend is done )
Some other fixes

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -21,83 +21,27 @@
 $Id$
 */
 
+// Convert to template
 if (!defined('VIPERAL'))
 {
     die;
 }
 
-global $table_prefix;
+global $table_prefix, $site_file_root, $_CORE_CONFIG;
 
+/*
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
 	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
+*/
 
-global $prefix, $_CLASS, $_CORE_CONFIG;
+require_once($site_file_root.'modules/Quick_Message/functions.php');
 
-$this-&gt;content = '&lt;div style=&quot;width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;&quot;&gt;';
+$this-&gt;content = '&lt;div id=&quot;qm_block&quot;&gt;'.qm_block_content().'&lt;/div&gt;';
 
-$result = $_CLASS['core_db']-&gt;query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
+$this-&gt;content .= '&lt;script type=&quot;text/javascript&quot; src=&quot;javascript/quick_messages.js&quot;&gt;&lt;/script&gt;&lt;div align=&quot;center&quot;&gt;&lt;a href=&quot;'.generate_link('Quick_Message').'&quot;&gt;Message History&lt;/a&gt;&lt;br /&gt;';
 
-while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-{
-	/*
-		php 4 doesn't support mb html_entity_decode :-(
-		Make a core function for this
-	*/
-	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
-	$words_array = explode(' ', $row['message_text']);
-
-	$row['message_text'] = '';
-
-    foreach($words_array as $words)
-    {
-		if (substr($words, 0, 4) != '[url')
-		{
-			$row['message_text'] .= ' '.wordwrap($words, 18, &quot;\n&quot;, 1);
-		}
-		else
-		{
-			$row['message_text'] .= $words;
-		}
-    }
-
-	$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
-
-	unset($words_array, $words);
-	
-	$this-&gt;content .= '&lt;div style=&quot;padding: 4px;&quot;&gt;';
-	
-	if ($row['poster_name'])
-	{
-		$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
-
-		if ($row['poster_id']) 
-		{
-			$this-&gt;content .= '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'&quot;&gt;&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;&lt;/a&gt;';
-		}
-		else
-		{
-			$this-&gt;content .= '&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;'; 
-		}
-	}
-	else
-	{
-		$this-&gt;content .= '&lt;b&gt;' . $_CLASS['core_user']-&gt;lang['ANONYMOUS'] . ': &lt;/b&gt;';
-	}
-
-	if ($row['poster_id'])
-	{
-		$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message_text']);
-	}
-
-	$this-&gt;content .= $row['message_text'].'&lt;br /&gt;'. $_CLASS['core_user']-&gt;format_date($row['message_time']) .'&lt;/div&gt;&lt;hr/&gt;';
-}
-
-$_CLASS['core_db']-&gt;free_result($result);
-
-$this-&gt;content .= '&lt;/div&gt;&lt;div align=&quot;center&quot;&gt;&lt;a href=&quot;'.generate_link('Quick_Message').'&quot;&gt;Message History&lt;/a&gt;&lt;br /&gt;';
-
 if (!$_CLASS['core_user']-&gt;is_user &amp;&amp; !$_CORE_CONFIG['quick_message']['anonymous_posting'])
 {
 	$this-&gt;content .= '&lt;br/&gt;Only registered users can post&lt;br /&gt;[ &lt;a href=&quot;'.generate_link('Control_Panel&amp;mode=register').'&quot;&gt;Register&lt;/a&gt;&nbsp;|&nbsp;&lt;a href=&quot;'.generate_link('Control_Panel').'&quot;&gt;Login&lt;/a&gt; ]&lt;br /&gt;&lt;/div&gt;';
@@ -109,11 +53,12 @@
 
 if (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
 {
-	$this-&gt;content .= 'Name: &lt;br /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; style=&quot;width:90%;&quot; name=&quot;poster_name&quot; size=&quot;10&quot; maxlength=&quot;10&quot; /&gt;&lt;br /&gt;';
+	$this-&gt;content .= 'Name: &lt;br /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; style=&quot;width:90%;&quot; id=&quot;poster_name&quot; name=&quot;poster_name&quot; size=&quot;10&quot; maxlength=&quot;10&quot; /&gt;&lt;br /&gt;';
 }
 
-$this-&gt;content .= 'Message &lt;br/&gt; &lt;textarea name=&quot;message&quot; style=&quot;width:90%;&quot; rows=&quot;3&quot;&gt;&lt;/textarea&gt;&lt;br /&gt;&lt;br /&gt;
-			&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Post&quot; /&gt;
+$this-&gt;content .= 'Message &lt;br/&gt; &lt;textarea id=&quot;message&quot; name=&quot;message&quot; style=&quot;width:90%;&quot; rows=&quot;3&quot;&gt;&lt;/textarea&gt;&lt;br /&gt;&lt;br /&gt;
+			&lt;input class=&quot;button&quot; type=&quot;button&quot; name=&quot;submit&quot; onclick=&quot;quick_message_submit()&quot; value=&quot;Post&quot; /&gt;
+			&lt;input class=&quot;button&quot; type=&quot;button&quot; name=&quot;submit&quot; onclick=&quot;quick_message_refresh()&quot; value=&quot;Refresh&quot; /&gt;
 		&lt;/div&gt;&lt;/form&gt;';
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/auth/auth.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -166,7 +166,7 @@
 	
 				if (!$code || !$confirm_code || $code !== $confirm_code)
 				{
-				//	$error = 'CONFIRM_CODE_WRONG';
+					$error = 'CONFIRM_CODE_WRONG';
 				}
 			}
 

Modified: cms/trunk/includes/forums/admin/admin_attachments.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_attachments.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_attachments.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -61,10 +61,10 @@
 
 	// Pull all config data
 	$sql = 'SELECT *
-		FROM ' . CONFIG_TABLE;
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		FROM ' . FORUMS_CONFIG_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$config_name = $row['config_name'];
 		$config_value = $row['config_value'];
@@ -101,6 +101,7 @@
 			}
 		}
 	}
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	perform_site_list();
 
@@ -138,20 +139,20 @@
 	$sql = 'SELECT *
 		FROM ' . EXTENSIONS_TABLE . '
 		ORDER BY extension_id';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		if ($row['group_id'] != $extensions[$row['extension_id']]['group_id'])
 		{
 			$sql = 'UPDATE ' . EXTENSIONS_TABLE . ' 
 				SET group_id = ' . (int) $extensions[$row['extension_id']]['group_id'] . '
 				WHERE extension_id = ' . $row['extension_id'];
-			$_CLASS['core_db']-&gt;sql_query($sql);	
+			$_CLASS['core_db']-&gt;query($sql);	
 			add_log('admin', 'LOG_ATTACH_EXT_UPDATE', $row['extension']);
 		}
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	// Delete Extension ?
 	$extension_id_list = (isset($_POST['extension_id_list'])) ? array_map('intval', $_POST['extension_id_list']) : array();
@@ -161,19 +162,19 @@
 		$sql = 'SELECT extension 
 			FROM ' . EXTENSIONS_TABLE . '
 			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		
 		$extension_list = '';
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$extension_list .= ($extension_list == '') ? $row['extension'] : ', ' . $row['extension'];
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
 		$sql = 'DELETE 
 			FROM ' . EXTENSIONS_TABLE . '
 			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 
 		add_log('admin', 'LOG_ATTACH_EXT_DEL', $extension_list);
 	}
@@ -190,13 +191,13 @@
 			$sql = 'SELECT extension_id
 				FROM ' . EXTENSIONS_TABLE . &quot;
 				WHERE extension = '&quot; . $_CLASS['core_db']-&gt;sql_escape($add_extension) . &quot;'&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
+			$result = $_CLASS['core_db']-&gt;query($sql);
 			
-			if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_EXIST'], $add_extension);
 			}
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			if (!sizeof($error))
 			{
@@ -205,7 +206,7 @@
 					'extension'	=&gt;	$add_extension
 				);
 				
-				$_CLASS['core_db']-&gt;sql_query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
+				$_CLASS['core_db']-&gt;query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
 				add_log('admin', 'LOG_ATTACH_EXT_ADD', $add_extension);
 			}
 		}
@@ -238,9 +239,9 @@
 	{
 		$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . &quot;
 			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		$ext_row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$ext_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 	else
 	{
@@ -261,12 +262,12 @@
 		$sql = 'SELECT group_id 
 			FROM ' . EXTENSION_GROUPS_TABLE . &quot;
 			WHERE LOWER(group_name) = '&quot; . $_CLASS['core_db']-&gt;sql_escape(strtolower($new_group_name)) . &quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		if ($_CLASS['core_db']-&gt;sql_fetchrow($result))
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_GROUP_EXIST'], $new_group_name);
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
 	if (!sizeof($error))
@@ -305,7 +306,7 @@
 		$sql .= $_CLASS['core_db']-&gt;sql_build_array((($action == 'add') ? 'INSERT' : 'UPDATE'), $group_ary);
 		$sql .= ($action == 'edit') ? &quot; WHERE group_id = $group_id&quot; : '';
 
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 		
 		if ($action == 'add')
 		{
@@ -322,7 +323,7 @@
 		$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot;
 			SET group_id = 0
 			WHERE group_id = $group_id&quot;;
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 	}
 
 	if (sizeof($extension_list))
@@ -330,7 +331,7 @@
 		$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot; 
 			SET group_id = $group_id
 			WHERE extension_id IN (&quot; . implode(', ', $extension_list) . &quot;)&quot;;
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 	}
 
 	rewrite_extensions();
@@ -387,21 +388,21 @@
 
 		$sql = 'SELECT forum_id, forum_name
 			FROM ' . FORUMS_TABLE;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		
 		$forum_names = array();
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$forum_names[$row['forum_id']] = $row['forum_name'];
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
 		$sql = 'SELECT forum_id, topic_id, post_id 
 			FROM ' . POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', array_keys($upload_list)) . ')';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			echo sprintf($_CLASS['core_user']-&gt;lang['UPLOADING_FILE_TO'], $upload_list[$row['post_id']], $row['post_id']) . '&lt;br /&gt;';
 			if (!$_CLASS['auth']-&gt;acl_gets('f_attach', 'u_attach', $row['forum_id']))
@@ -486,14 +487,14 @@
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		WHERE cat_id &gt; 0
 		ORDER BY cat_id';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$s_assigned_groups = array();
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$s_assigned_groups[$row['cat_id']][] = $row['group_name'];
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	$display_inlined_yes = ($new['img_display_inlined']) ? 'checked=&quot;checked&quot;' : '';
 	$display_inlined_no = (!$new['img_display_inlined']) ? 'checked=&quot;checked&quot;' : '';
@@ -560,7 +561,7 @@
 	  &lt;th align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SETTINGS_CAT_IMAGES']; ?&gt;&lt;/th&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ASSIGNED_GROUP']; ?&gt;: &lt;?php echo ((sizeof($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])) ? implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) : $_CLASS['core_user']-&gt;lang['NONE']); ?&gt;&lt;/td&gt;
+		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ASSIGNED_GROUP']; ?&gt;: &lt;?php echo (empty($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) ? $_CLASS['core_user']-&gt;lang['NONE'] : implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])); ?&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_INLINED']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_INLINED_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
@@ -612,13 +613,13 @@
 	$allow_deny = ($new['secure_allow_deny']) ? 'ALLOWED' : 'DISALLOWED';
 		
 	$sql = 'SELECT *
-		FROM ' . SITELIST_TABLE;
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		FROM ' . FORUMS_SITELIST_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$defined_ips = '';
 	$ips = array();
 
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$value = ($row['site_ip']) ? $row['site_ip'] : $row['site_hostname'];
 		if ($value)
@@ -627,7 +628,7 @@
 			$ips[$row['site_id']] = $value;
 		}
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	if (!$new['secure_downloads'])
 	{
@@ -732,20 +733,20 @@
 			$sql = 'SELECT group_name 
 				FROM ' . EXTENSION_GROUPS_TABLE . &quot;
 				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
+			$result = $_CLASS['core_db']-&gt;query($sql);
 			$group_name = $_CLASS['core_db']-&gt;sql_fetchfield('group_name', 0, $result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 			
 			$sql = 'DELETE 
 				FROM ' . EXTENSION_GROUPS_TABLE . &quot; 
 				WHERE group_id = $group_id&quot;;
-			$_CLASS['core_db']-&gt;sql_query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 
 			// Set corresponding Extensions to a pending Group
 			$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot;
 				SET group_id = 0
 				WHERE group_id = $group_id&quot;;
-			$_CLASS['core_db']-&gt;sql_query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 	
 			add_log('admin', 'LOG_ATTACH_EXTGROUP_DEL', $group_name);
 
@@ -770,9 +771,9 @@
 
 			$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . &quot;
 				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-			extract($_CLASS['core_db']-&gt;sql_fetchrow($result));
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			extract($_CLASS['core_db']-&gt;fetch_row_assoc($result));
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			$forum_ids = (!$allowed_forums) ? array() : unserialize(trim($allowed_forums));
 
@@ -795,9 +796,9 @@
 			$sql = 'SELECT * FROM ' . EXTENSIONS_TABLE . &quot;
 				WHERE group_id = $group_id OR group_id = 0
 				ORDER BY extension&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-			$extensions = $_CLASS['core_db']-&gt;sql_fetchrowset($result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$extensions = $_CLASS['core_db']-&gt;fetch_row_assocset($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			$img_path = $config['upload_icons_path'];
 
@@ -968,12 +969,12 @@
 				$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id
 					FROM ' . FORUMS_TABLE . '
 					ORDER BY left_id ASC';
-				$result = $_CLASS['core_db']-&gt;sql_query($sql);
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
 				$right = $cat_right = $padding_inc = 0;
 				$padding = $forum_list = $holding = '';
 				$padding_store = array('0' =&gt; '');
-				while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
 					if ($row['forum_type'] == FORUM_CAT &amp;&amp; ($row['left_id'] + 1 == $row['right_id']))
 					{
@@ -1018,7 +1019,7 @@
 						$holding = '';
 					}
 				}
-				$_CLASS['core_db']-&gt;sql_freeresult($result);
+				$_CLASS['core_db']-&gt;free_result($result);
 				unset($padding_store);
 ?&gt;
 				&lt;/select&gt;&lt;/td&gt;
@@ -1043,7 +1044,7 @@
 				SET allow_group = ' . (($action == 'activate') ? '1' : '0') . &quot;
 				WHERE group_id = $group_id&quot;;
 
-			$_CLASS['core_db']-&gt;sql_query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 
 			rewrite_extensions();
 
@@ -1052,7 +1053,7 @@
 	$sql = 'SELECT *
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		ORDER BY allow_group DESC, group_name';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
 ?&gt;
 
@@ -1067,7 +1068,7 @@
 
 	$row_class = 'row2';
 
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
 		
@@ -1096,7 +1097,7 @@
 
 &lt;?php
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 ?&gt;
 	&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_GROUP']; ?&gt;: &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_name&quot; maxlength=&quot;30&quot; /&gt; &lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
@@ -1137,9 +1138,9 @@
 	$sql = 'SELECT * 
 		FROM ' . EXTENSIONS_TABLE . ' 
 		ORDER BY group_id, extension';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$old_group_id = $row['group_id'];
 		do
@@ -1163,7 +1164,7 @@
 	&lt;/tr&gt;
 &lt;?
 		}
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 	}
 ?&gt;
 	&lt;tr&gt;
@@ -1209,13 +1210,13 @@
 &lt;?php
 	$sql = 'SELECT physical_filename 
 		FROM ' . ATTACHMENTS_TABLE;
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		unset($attach_filelist[$row['physical_filename']]);
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 ?&gt;
 
@@ -1284,10 +1285,10 @@
 		$sql = 'SELECT cat_id
 			FROM ' . EXTENSION_GROUPS_TABLE . '
 			WHERE group_id = ' . (int) $group_id;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		
-		$cat_type = (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))) ? ATTACHMENT_CATEGORY_NONE : $row['cat_id'];
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$cat_type = (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))) ? ATTACHMENT_CATEGORY_NONE : $row['cat_id'];
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 	else
 	{
@@ -1317,14 +1318,14 @@
 	$sql = 'SELECT group_id, group_name
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		ORDER BY group_name';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$group_name = array();
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$group_name[] = $row;
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	$row['group_id'] = 0;
 	$row['group_name'] = $_CLASS['core_user']-&gt;lang['NOT_ASSIGNED'];
@@ -1364,11 +1365,11 @@
 		$sql = &quot;SELECT download_mode
 			FROM &quot; . EXTENSION_GROUPS_TABLE . &quot;
 			WHERE group_id = &quot; . (int) $group_id;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		
-		$download_mode = (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))) ? INLINE_LINK : $row['download_mode'];
+		$download_mode = (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))) ? INLINE_LINK : $row['download_mode'];
 
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 	else
 	{
@@ -1426,17 +1427,17 @@
 		$_CLASS['core_db']-&gt;sql_transaction();
 
 		$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql);
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 
 		$sql = 'UPDATE ' . POSTS_TABLE . &quot;
 			SET post_attachment = 1
 			WHERE post_id = $post_id&quot;;
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 
 		$sql = 'UPDATE ' . TOPICS_TABLE . &quot;
 			SET topic_attachment = 1
 			WHERE topic_id = $topic_id&quot;;
-		$_CLASS['core_db']-&gt;sql_query($sql);
+		$_CLASS['core_db']-&gt;query($sql);
 
 		$_CLASS['core_db']-&gt;sql_transaction('commit');
 
@@ -1601,11 +1602,11 @@
 		}
 
 		$sql = 'SELECT site_ip, site_hostname
-			FROM ' . SITELIST_TABLE . &quot;
+			FROM ' . FORUMS_SITELIST_TABLE . &quot;
 			WHERE ip_exclude = $ip_exclude&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-		if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$iplist_tmp = array();
 			$hostlist_tmp = array();
@@ -1621,7 +1622,7 @@
 				}
 				break;
 			}
-			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
 			$iplist = array_unique(array_diff($iplist, $iplist_tmp));
 			$hostlist = array_unique(array_diff($hostlist, $hostlist_tmp));
@@ -1633,9 +1634,9 @@
 		{
 			foreach ($iplist as $ip_entry)
 			{
-				$sql = 'INSERT INTO ' . SITELIST_TABLE . &quot; (site_ip, ip_exclude)
+				$sql = 'INSERT INTO ' . FORUMS_SITELIST_TABLE . &quot; (site_ip, ip_exclude)
 					VALUES ($ip_entry, $ip_exclude)&quot;;
-				$_CLASS['core_db']-&gt;sql_query($sql);
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 		}
 
@@ -1643,9 +1644,9 @@
 		{
 			foreach ($hostlist as $host_entry)
 			{
-				$sql = 'INSERT INTO ' . SITELIST_TABLE . &quot; (site_hostname, ip_exclude)
+				$sql = 'INSERT INTO ' . FORUMS_SITELIST_TABLE . &quot; (site_hostname, ip_exclude)
 					VALUES ($host_entry, $ip_exclude)&quot;;
-				$_CLASS['core_db']-&gt;sql_query($sql);
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 		}
 		
@@ -1668,18 +1669,18 @@
 		
 			// Grab details of ips for logging information later
 			$sql = 'SELECT site_ip, site_hostname
-				FROM ' . SITELIST_TABLE . &quot;
+				FROM ' . FORUMS_SITELIST_TABLE . &quot;
 				WHERE site_id IN ($unip_sql)&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
-			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$l_unip_list .= (($l_unip_list != '') ? ', ' : '') . (($row['site_ip']) ? $row['site_ip'] : $row['site_hostname']);
 			}
 
-			$sql = 'DELETE FROM ' . SITELIST_TABLE . &quot;
+			$sql = 'DELETE FROM ' . FORUMS_SITELIST_TABLE . &quot;
 				WHERE site_id IN ($unip_sql)&quot;;
-			$_CLASS['core_db']-&gt;sql_query($sql);
+			$_CLASS['core_db']-&gt;query($sql);
 
 			add_log('admin', 'LOG_DOWNLOAD_REMOVE_IP', $l_unip_list);
 		}
@@ -1697,10 +1698,10 @@
 		FROM ' . EXTENSIONS_TABLE . ' e, ' . EXTENSION_GROUPS_TABLE . ' g
 		WHERE e.group_id = g.group_id
 			AND g.allow_group = 1';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$extensions = array();
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$extension = $row['extension'];
 
@@ -1719,7 +1720,7 @@
 		// Store allowed extensions forum wise
 		$extensions['_allowed_'][$extension] = (!sizeof($allowed_forums)) ? 0 : $allowed_forums;
 	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	$_CLASS['core_cache']-&gt;destroy('extensions');
 	$_CLASS['core_cache']-&gt;put('extensions', $extensions);

Deleted: cms/trunk/includes/forums/admin/admin_ban.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_ban.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_ban.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,289 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_ban.php,v 1.11 2004/08/01 21:01:23 psotfx Exp $
-//
-// FILENAME  : admin_ban.php
-// STARTED   : Tue Jul 31, 2001
-// COPYRIGHT : &#169; 2001,2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
-
-// Do we have ban permissions?
-if (!$auth-&gt;acl_get('a_ban'))
-{
-	trigger_error($user-&gt;lang['NO_ADMIN']);
-}
-
-include('includes/forums/functions_user.'.$phpEx);
-
-// Mode setting
-$mode		= request_var('mode', '');
-$bansubmit	= (isset($_POST['bansubmit'])) ? true : false;
-$unbansubmit= (isset($_POST['unbansubmit'])) ? true : false;
-
-// Set some vars
-$current_time = time();
-
-// Start program
-if ($bansubmit)
-{
-	// Grab the list of entries
-	$ban			= request_var('ban', '');
-	$ban_len		= request_var('banlength', 0);
-	$ban_len_other	= request_var('banlengthother', '');
-	$ban_exclude	= request_var('banexclude', 0);
-	$ban_reason		= request_var('banreason', '');
-
-	user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason);
-
-	trigger_error($user-&gt;lang['BAN_UPDATE_SUCESSFUL']);
-}
-else if ($unbansubmit)
-{
-	$ban = request_var('unban', '');
-
-	user_unban($mode, $ban);
-
-	trigger_error($user-&gt;lang['BAN_UPDATE_SUCESSFUL']);
-}
-
-//
-// Output relevant entry page
-//
-
-
-//
-// Ban length options
-//
-$ban_end_text = array(0 =&gt; $user-&gt;lang['PERMANENT'], 30 =&gt; $user-&gt;lang['30_MINS'], 60 =&gt; $user-&gt;lang['1_HOUR'], 360 =&gt; $user-&gt;lang['6_HOURS'], 1440 =&gt; $user-&gt;lang['1_DAY'], 10080 =&gt; $user-&gt;lang['7_DAYS'], 20160 =&gt; $user-&gt;lang['2_WEEKS'], 40320 =&gt; $user-&gt;lang['1_MONTH'], -1 =&gt; $user-&gt;lang['OTHER'] . ' -&gt; ');
-
-$ban_end_options = '';
-foreach ($ban_end_text as $length =&gt; $text)
-{
-	$ban_end_options .= '&lt;option value=&quot;' . $length . '&quot;&gt;' . $text . '&lt;/option&gt;';
-}
-
-// Title
-switch ($mode)
-{
-	case 'user':
-		$l_title = $user-&gt;lang['BAN_USERS'];
-		break;
-	case 'email':
-		$l_title = $user-&gt;lang['BAN_EMAILS'];
-		break;
-	case 'ip':
-		$l_title = $user-&gt;lang['BAN_IPS'];
-		break;
-}
-
-// Output page
-adm_page_header($l_title);
-
-?&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['BAN_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-switch ($mode)
-{
-	case 'user':
-
-		$field = 'username';
-		$l_ban_title = $user-&gt;lang['BAN_USERS'];
-		$l_ban_explain = $user-&gt;lang['BAN_USERNAME_EXPLAIN'];
-		$l_ban_exclude_explain = $user-&gt;lang['BAN_USER_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user-&gt;lang['UNBAN_USERNAME'];
-		$l_unban_explain = $user-&gt;lang['UNBAN_USERNAME_EXPLAIN'];
-		$l_ban_cell = $user-&gt;lang['USERNAME'] . ': &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;' . getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban').'&quot; onclick=&quot;window.open(\''.getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban').&quot;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;\&quot;&gt;&quot; . $user-&gt;lang['FIND_USERNAME'] .'&lt;/a&gt; ]&lt;/span&gt;';
-		$l_no_ban_cell = $user-&gt;lang['NO_BANNED_USERS'];
-
-		$sql = 'SELECT b.*, u.user_id, u.username
-			FROM ' . BANLIST_TABLE . ' b, ' . USERS_TABLE . ' u
-			WHERE (b.ban_end &gt;= ' . time() . '
-					OR b.ban_end = 0)
-				AND u.user_id = b.ban_userid
-				AND b.ban_userid &lt;&gt; 0
-				AND u.user_id &lt;&gt; ' . ANONYMOUS . '
-			ORDER BY u.user_id ASC';
-		break;
-
-	case 'ip':
-
-		$field = 'ban_ip';
-		$l_ban_title = $user-&gt;lang['BAN_IPS'];
-		$l_ban_explain = $user-&gt;lang['BAN_IP_EXPLAIN'];
-		$l_ban_exclude_explain = $user-&gt;lang['BAN_IP_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user-&gt;lang['UNBAN_IP'];
-		$l_unban_explain = $user-&gt;lang['UNBAN_IP_EXPLAIN'];
-		$l_ban_cell = $user-&gt;lang['IP_HOSTNAME'] . ':';
-		$l_no_ban_cell = $user-&gt;lang['NO_BANNED_IP'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end &gt;= ' . time() . &quot;
-					OR ban_end = 0)
-				AND ban_ip &lt;&gt; ''&quot;;
-		break;
-
-	case 'email':
-
-		$field = 'ban_email';
-		$l_ban_title = $user-&gt;lang['BAN_EMAILS'];
-		$l_ban_explain = $user-&gt;lang['BAN_EMAIL_EXPLAIN'];
-		$l_ban_exclude_explain = $user-&gt;lang['BAN_EMAIL_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user-&gt;lang['UNBAN_EMAIL'];
-		$l_unban_explain = $user-&gt;lang['UNBAN_EMAIL_EXPLAIN'];
-		$l_ban_cell = $user-&gt;lang['EMAIL_ADDRESS'] . ':';
-		$l_no_ban_cell = $user-&gt;lang['NO_BANNED_EMAIL'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end &gt;= ' . time() . &quot;
-					OR ban_end = 0)
-				AND ban_email &lt;&gt; ''&quot;;
-		break;
-}
-$result = $db-&gt;sql_query($sql);
-
-$banned_options = '';
-$ban_length = $ban_reasons = array();
-if ($row = $db-&gt;sql_fetchrow($result))
-{
-	do
-	{
-
-		$banned_options .=  '&lt;option' . (($row['ban_exclude']) ? ' class=&quot;sep&quot;' : '') . ' value=&quot;' . $row['ban_id'] . '&quot;&gt;' . $row[$field] . '&lt;/option&gt;';
-
-		$time_length = (!empty($row['ban_end'])) ? ($row['ban_end'] - $row['ban_start']) / 60 : 0;
-		$ban_length[$row['ban_id']] = (!empty($ban_end_text[$time_length])) ? $ban_end_text[$time_length] : $user-&gt;lang['OTHER'] . ' -&gt; ' . gmdate('Y-m-d', $row['ban_end']);
-
-		$ban_reasons[$row['ban_id']] = addslashes($row['ban_reason']);
-	}
-	while ($row = $db-&gt;sql_fetchrow($result));
-}
-$db-&gt;sql_freeresult($result);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_ban_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_ban_explain; ?&gt;&lt;/p&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-
-var ban_length = new Array();
-&lt;?php
-
-	if (sizeof($ban_length))
-	{
-		foreach ($ban_length as $ban_id =&gt; $length)
-		{
-			echo &quot;ban_length['$ban_id'] = \&quot;$length\&quot;;\n&quot;;
-		}
-	}
-
-?&gt;
-
-var ban_reason = new Array();
-&lt;?php
-
-	if (sizeof($ban_reasons))
-	{
-		foreach ($ban_reasons as $ban_id =&gt; $reason)
-		{
-			echo &quot;ban_reason['$ban_id'] = \&quot;$reason\&quot;;\n&quot;;
-		}
-	}
-?&gt;
-
-function display_details(option)
-{
-	document.forms[0].unbanreason.value = ban_reason[option];
-	document.forms[0].unbanlength.value = ban_length[option];
-}
-
-//--&gt;
-&lt;/script&gt;
-
-&lt;form name=&quot;banning&quot; method=&quot;post&quot; action=&quot;&lt;?php echo &quot;admin_ban.$phpEx$SID&amp;mode=$mode&quot;; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $l_ban_title; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $l_ban_cell; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea cols=&quot;40&quot; rows=&quot;3&quot; name=&quot;ban&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $user-&gt;lang['BAN_LENGTH']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;banlength&quot;&gt;&lt;?php echo $ban_end_options; ?&gt;&lt;/select&gt;&nbsp; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;banlengthother&quot; maxlength=&quot;10&quot; size=&quot;10&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $user-&gt;lang['BAN_EXCLUDE']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $l_ban_exclude_explain;;?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;banexclude&quot; value=&quot;1&quot; /&gt; &lt;?php echo $user-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;banexclude&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $user-&gt;lang['BAN_REASON']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;banreason&quot; maxlength=&quot;255&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;bansubmit&quot; value=&quot;&lt;?php echo $user-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $user-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;h1&gt;&lt;?php echo $l_unban_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_unban_explain; ?&gt;&lt;/p&gt;
-
-&lt;table class=&quot;bg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $l_unban_title; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if ($banned_options)
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $l_ban_cell; ?&gt;: &lt;br /&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt; &lt;select name=&quot;unban[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot; onchange=&quot;display_details(this.options[this.selectedIndex].value)&quot;&gt;&lt;?php echo $banned_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $user-&gt;lang['BAN_REASON']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;row1&quot; style=&quot;border:0px&quot; type=&quot;text&quot; name=&quot;unbanreason&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $user-&gt;lang['BAN_LENGTH']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;row1&quot; style=&quot;border:0px&quot; type=&quot;text&quot; name=&quot;unbanlength&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;unbansubmit&quot; value=&quot;&lt;?php echo $user-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $user-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-	else
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $l_no_ban_cell;  ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_board.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_board.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_board.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -18,7 +18,7 @@
 // Get mode
 $mode	= request_var('mode', '');
 $action	= request_var('action', '');
-$submit = (isset($_POST['submit'])) ? true : false;
+$submit = isset($_POST['submit']);
 
 // Set config vars
 $display_vars = array(

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -16,7 +16,7 @@
 }
 
 // Get general vars
-$update		= (isset($_POST['update'])) ? true : false;
+$update		= isset($_POST['update']);
 $mode		= request_var('mode', '');
 $action		= request_var('action', '');
 $forum_id	= request_var('f', 0);
@@ -42,7 +42,7 @@
 
 if (!$_CLASS['auth']-&gt;acl_get($acl))
 {
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+	trigger_error('NO_ADMIN');
 }
 
 
@@ -80,8 +80,6 @@
 				'forum_id'		=&gt;	$forum_id
 			);
 
-			// No break here
-
 		case 'add':
 			$forum_data += array(
 				'parent_id'				=&gt; $parent_id,
@@ -107,10 +105,16 @@
 				'prune_sticky'			=&gt; request_var('prune_sticky', FALSE),
 				'forum_password'		=&gt; request_var('forum_password', ''),
 				'forum_password_confirm'=&gt; request_var('forum_password_confirm', ''),
-				'forum_posts'			=&gt; 0,
-				'forum_topics'			=&gt; 0,
-				'forum_topics_real'		=&gt; 0,
 			);
+	
+			if ($mode === 'add')
+			{
+				$forum_data += array(
+					'forum_posts'			=&gt; 0,
+					'forum_topics'			=&gt; 0,
+					'forum_topics_real'		=&gt; 0,
+				);
+			}
 
 			if ($forum_data['forum_rules'])
 			{
@@ -130,7 +134,7 @@
 				$forum_data['forum_rules_bbcode_bitfield'] = $message_parser-&gt;bbcode_bitfield;
 				unset($message_parser);
 			}
-					
+
 			$errors = update_forum_data($forum_data);
 
 			if ($errors)
@@ -138,16 +142,15 @@
 				break;
 			}
 
-			// 
 			$_CLASS['auth']-&gt;acl_clear_prefetch();
 
 			// Redirect to permissions
-			$message = ($mode == 'add') ? $_CLASS['core_user']-&gt;lang['FORUM_CREATED'] : $_CLASS['core_user']-&gt;lang['FORUM_UPDATED'];
+			$message = ($mode === 'add') ? $_CLASS['core_user']-&gt;lang['FORUM_CREATED'] : $_CLASS['core_user']-&gt;lang['FORUM_UPDATED'];
 			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['REDIRECT_ACL'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=admin_permissions&amp;mode=forum&amp;submit_usergroups=true&amp;ug_type=forum&amp;action=usergroups&amp;f[forum][]=' . $forum_data['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;', '&lt;/a&gt;');
 			$show_prev_info = ($mode == 'edit') ? true : false;
 
 			trigger_error($message);
-			break;
+		break;
 	}
 }
 
@@ -155,7 +158,7 @@
 {
 	case 'add':
 	case 'edit':
-		if (isset($_POST['update']))
+		if ($update)
 		{
 			extract($forum_data);
 		}
@@ -254,26 +257,26 @@
 		}
 
 		$statuslist = '&lt;option value=&quot;' . ITEM_UNLOCKED . '&quot;' . (($forum_status == ITEM_UNLOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['UNLOCKED'] . '&lt;/option&gt;&lt;option value=&quot;' . ITEM_LOCKED . '&quot;' . (($forum_status == ITEM_LOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['LOCKED'] . '&lt;/option&gt;';
-$enable_icons = isset($enable_icons) ? $enable_icons : 0;
-$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
-$enable_prune = isset($enable_prune) ? $enable_prune : 0;
-$display_on_index = isset($display_on_index) ? $display_on_index : 0;
-$forum_flags = isset($forum_flags) ? $forum_flags : 0;
 
-$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
-$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
-$urls_checked = isset($urls_checked) ? $urls_checked : false;
+		$enable_icons = isset($enable_icons) ? $enable_icons : 0;
+		$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
+		$enable_prune = isset($enable_prune) ? $enable_prune : 0;
+		$display_on_index = isset($display_on_index) ? $display_on_index : 0;
+		$forum_flags = isset($forum_flags) ? $forum_flags : 0;
+		
+		$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
+		$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
+		$urls_checked = isset($urls_checked) ? $urls_checked : false;
+		
+		$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
+		$forum_image = isset($forum_image) ? $forum_image : '';
+		$prune_freq = isset($prune_freq) ? $prune_freq : '';
+		$prune_days = isset($prune_days) ? $prune_days : '';
+		$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
+		$forum_link = isset($forum_link) ? $forum_link : '';
+		
+		$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
 
-$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
-$forum_image = isset($forum_image) ? $forum_image : '';
-$prune_freq = isset($prune_freq) ? $prune_freq : '';
-$prune_days = isset($prune_days) ? $prune_days : '';
-$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
-$forum_link = isset($forum_link) ? $forum_link : '';
-
-$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
-
-
 		$indexing_yes = ($enable_indexing) ? ' checked=&quot;checked&quot;' : '';
 		$indexing_no = (!$enable_indexing) ? ' checked=&quot;checked&quot;' : '';
 		$topic_icons_yes = ($enable_icons) ? ' checked=&quot;checked&quot;' : '';
@@ -345,18 +348,8 @@
 			// deleting all posts or moving them to another forum (if applicable)
 
 ?&gt;&lt;br /&gt;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL_POSTS'];
-
-			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_type = ' . FORUM_POST . &quot;
-					AND forum_id &lt;&gt; $forum_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
 ?&gt;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;move&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_POSTS_TO'] ?&gt; &lt;select name=&quot;to_forum_id&quot;&gt;&lt;?php echo $forums_list ?&gt;&lt;/select&gt;&lt;?php
 
-			}
 		}
 
 ?&gt;&lt;/td&gt;
@@ -365,14 +358,12 @@
 
 		if ($forum_type == FORUM_POST)
 		{
-
 ?&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_STATUS'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
 		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;forum_status&quot;&gt;&lt;?php echo $statuslist ?&gt;&lt;/select&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;?php
-
 		}
 
 ?&gt;
@@ -384,7 +375,6 @@
 
 		if ($forum_type == FORUM_LINK)
 		{
-
 ?&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
@@ -395,7 +385,6 @@
 		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;1&quot;&lt;?php echo $forum_link_track_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;0&quot;&lt;?php echo $forum_link_track_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
 	&lt;/tr&gt;
 &lt;?php
-
 		}
 
 ?&gt;
@@ -655,7 +644,7 @@
 
 		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
 		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
+			trigger_error('NO_FORUM');
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -1431,7 +1420,7 @@
 	switch ($_CLASS['core_db']-&gt;db_layer)
 	{
 // Needs updating and testing
-/*		case 'mysql4':
+/*		case 'mysql':
 		case 'mysqli':
 			// Select then delete all attachments
 			$sql = 'SELECT a.topic_id

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/auth.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,19 +1,29 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 // -------------------------------------------------------------
 //
-// COPYRIGHT : &#169; 2001, 2004 phpBB Group
+// COPYRIGHT : 2001, 2004 phpBB Group
 // WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
 //
 // -------------------------------------------------------------
@@ -182,14 +192,6 @@
 		$hold_ary = $this-&gt;acl_raw_data($userdata['user_id'], false, false);
 		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
 
-		foreach ($this-&gt;acl_options['global'] as $opt =&gt; $id)
-		{
-			if (strstr($opt, 'a_'))
-			{
-				$hold_ary[0][$opt] = 1;
-			}
-		}
-
 		$hold_str = '';
 		if (is_array($hold_ary))
 		{

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -168,24 +168,6 @@
 	return $var;
 }
 
-// Generates an alphanumeric random string of given length
-function gen_rand_string($num_chars)
-{
-	$chars = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',  'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',  'U', 'V', 'W', 'X', 'Y', 'Z', '1', '2', '3', '4', '5', '6', '7', '8', '9');
-
-	list($sec, $usec) = explode(' ', microtime());
-	mt_srand((float) $sec + ((float) $usec * 100000));
-
-	$max_chars = sizeof($chars) - 1;
-	$rand_str = '';
-	for ($i = 0; $i &lt; $num_chars; $i++)
-	{
-		$rand_str .= $chars[mt_rand(0, $max_chars)];
-	}
-
-	return $rand_str;
-}
-
 function get_userdata($user)
 {
 	global $_CLASS;
@@ -916,7 +898,7 @@
 			}
 			
 			// Store allowed extensions forum wise
-			$extensions['_allowed_'][$extension] = (!sizeof($allowed_forums)) ? 0 : $allowed_forums;
+			$extensions['_allowed_'][$extension] = empty($allowed_forums) ? 0 : $allowed_forums;
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -934,7 +916,7 @@
 			if (is_array($check))
 			{
 				// Check for private messaging
-				if (sizeof($check) == 1 &amp;&amp; $check[0] == 0)
+				if (count($check) == 1 &amp;&amp; $check[0] == 0)
 				{
 					$allowed = true;
 				}
@@ -1096,7 +1078,7 @@
 	global $config, $_CLASS;
 
 	$unset_array = array();
-	$tpl_size = sizeof($attachments);
+	$tpl_size = count($attachments);
 
 	preg_match_all('#&lt;!\-\- ia([0-9]+) \-\-&gt;(.*?)&lt;!\-\- ia\1 \-\-&gt;#', $text, $matches, PREG_PATTERN_ORDER);
 	//print_r($matches);
@@ -1142,7 +1124,7 @@
 // Check if extension is allowed to be posted within forum X (forum_id 0 == private messaging)
 function extension_allowed($forum_id, $extension, &amp;$extensions)
 {
-	if (!sizeof($extensions))
+	if (empty($extensions))
 	{
 		$extensions = obtain_attach_extensions();
 	}
@@ -1157,11 +1139,11 @@
 	if (is_array($check))
 	{
 		// Check for private messaging
-		if (sizeof($check) == 1 &amp;&amp; $check[0] == 0)
+		if (count($check) == 1 &amp;&amp; $check[0] == 0)
 		{
 			return true;
 		}
-		
+
 		return (!in_array($forum_id, $check)) ? false : true;
 	}
 	else

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -100,7 +100,7 @@
 
 	$select_field = '&lt;select name=&quot;' . $select_name . '&quot;&gt;';
 
-	$size = sizeof($size_types_text);
+	$size = count($size_types_text);
 	for ($i = 0, $size; $i &lt; $size; $i++)
 	{
 		$selected = ($size_compare == $size_types[$i]) ? ' selected=&quot;selected&quot;' : '';
@@ -339,7 +339,7 @@
 		$where_ids = array_unique($where_ids);
 	}
 
-	if (!sizeof($where_ids))
+	if (empty($where_ids))
 	{
 		return array('topics' =&gt; 0, 'posts' =&gt; 0);
 	}
@@ -360,9 +360,9 @@
 	}
 	$_CLASS['core_db']-&gt;free_result();
 
-	$return['topics'] = sizeof($topic_ids);
+	$return['topics'] = count($topic_ids);
 
-	if (!sizeof($topic_ids))
+	if (!$return['topics'])
 	{
 		return $return;
 	}
@@ -455,7 +455,7 @@
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
 
-	return sizeof($post_ids);
+	return count($post_ids);
 }
 
 // Delete Attachments
@@ -471,7 +471,7 @@
 		$ids = array_unique($ids);
 	}
 	
-	if (!sizeof($ids))
+	if (empty($ids))
 	{
 		return false;
 	}
@@ -556,7 +556,7 @@
 	$topic_ids = array_unique($topic_ids);
 
 	// Update post indicators
-	if (sizeof($post_ids))
+	if (!empty($post_ids))
 	{
 		if ($mode == 'post' || $mode == 'topic')
 		{
@@ -582,7 +582,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 					SET post_attachment = 0
@@ -604,7 +604,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
 					SET message_attachment = 0
@@ -613,7 +613,7 @@
 		}
 	}
 
-	if (sizeof($topic_ids))
+	if (!empty($topic_ids))
 	{
 		// Update topic indicator
 		if ($mode == 'topic')
@@ -639,7 +639,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			$unset_ids = array_diff($topic_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 					SET topic_attachment = 0
@@ -681,7 +681,7 @@
 				$topic_ids[] = $row['topic_id'];
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 					WHERE topic_id IN (' . implode(',', $topic_ids) . ')';
@@ -750,7 +750,7 @@
 		}
 		else
 		{
-			if (!sizeof($where_ids))
+			if (empty($where_ids))
 			{
 				// Empty array with IDs. This means that we don't have any work to do. Just return.
 				return;
@@ -763,7 +763,7 @@
 	}
 	else
 	{
-		if (!sizeof($where_ids))
+		if (empty($where_ids))
 		{
 			return;
 		}
@@ -836,7 +836,7 @@
 					}
 					$_CLASS['core_db']-&gt;free_result();
 
-					if (!sizeof($topic_ids))
+					if (empty($topic_ids))
 					{
 						return;
 					}
@@ -890,7 +890,7 @@
 				$post_ids[] = $post_id;
 			}
 
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_reported = 1 - post_reported
@@ -928,7 +928,7 @@
 				}
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_reported = 1 - topic_reported
@@ -980,7 +980,7 @@
 				$post_ids[] = $post_id;
 			}
 
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_attachment = 1 - post_attachment
@@ -1018,7 +1018,7 @@
 				}
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_attachment = 1 - topic_attachment
@@ -1090,7 +1090,7 @@
 			}
 
 			// 4: Retrieve last_post infos
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'SELECT p.post_id, p.poster_id, p.post_time, p.post_username, u.username
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
@@ -1148,7 +1148,7 @@
 					}
 				}
 
-				if (sizeof($sql))
+				if (!empty($sql))
 				{
 					$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 						SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . '
@@ -1234,18 +1234,18 @@
 			}
 
 			// Now we delete empty topics and orphan posts
-			if (sizeof($delete_posts))
+			if (!empty($delete_posts))
 			{
 				delete_posts('topic_id', array_keys($delete_posts), FALSE);
 				unset($delete_posts);
 			}
-			if (!sizeof($topic_data))
+			if (empty($topic_data))
 			{
 				// If we get there, topic ids were invalid or topics did not contain any posts
 				delete_topics($where_type, $where_ids, TRUE);
 				return;
 			}
-			if (sizeof($delete_topics))
+			if (!empty($delete_topics))
 			{
 				$delete_topic_ids = array();
 				foreach ($delete_topics as $topic_id =&gt; $void)
@@ -1289,7 +1289,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			// approved becomes unapproved, and vice-versa
-			if (sizeof($approved_unapproved_ids))
+			if (!empty($approved_unapproved_ids))
 			{
 				$sql = 'UPDATE ' . TOPICS_TABLE . '
 					SET topic_approved = 1 - topic_approved
@@ -1348,7 +1348,7 @@
 					}
 				}
 
-				if (sizeof($sql))
+				if (!empty($sql))
 				{
 					$sql = 'UPDATE ' . TOPICS_TABLE . '
 						SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . '
@@ -1363,7 +1363,7 @@
 			// if some topics have been resync'ed then resync parent forums
 			// except when we're only syncing a range, we don't want to sync forums during
 			// batch processing.
-			if ($resync_parents &amp;&amp; sizeof($resync_forums) &amp;&amp; $where_type != 'range')
+			if ($resync_parents &amp;&amp; !empty($resync_forums) &amp;&amp; $where_type != 'range')
 			{
 				sync('forum', 'forum_id', $resync_forums, TRUE);
 			}
@@ -1469,7 +1469,7 @@
 	$output = '';
 
 	// try to keep mem. use down
-	$linecount = sizeof($lines);
+	$linecount = count($lines);
 
 	$in_comment = false;
 	for($i = 0; $i &lt; $linecount; $i++)
@@ -1515,7 +1515,7 @@
 	$matches = array();
 
 	// this is faster than calling count($oktens) every time thru the loop.
-	$token_count = sizeof($tokens);
+	$token_count = count($tokens);
 	for ($i = 0; $i &lt; $token_count; $i++)
 	{
 		// Don't wanna add an empty string as the last thing in the array.
@@ -1633,7 +1633,7 @@
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	if (sizeof($m_sql))
+	if (!empty($m_sql))
 	{
 		switch ($_CLASS['core_db']-&gt;db_layer)
 		{
@@ -1807,7 +1807,7 @@
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	if (sizeof($topic_id_list))
+	if (!empty($topic_id_list))
 	{
 		$topic_id_list = array_unique($topic_id_list);
 
@@ -2208,7 +2208,7 @@
 		}
 	}
 
-	if (sizeof($last_post_ids))
+	if (!empty($last_post_ids))
 	{
 		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
 			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
@@ -2227,7 +2227,7 @@
 	}
 	unset($empty_forums, $ids, $last_post_ids);
 
-	if (!sizeof($update_sql))
+	if (empty($update_sql))
 	{
 		return;
 	}

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -234,10 +234,10 @@
 					}
 				}
 
-				if (sizeof($links))
+				if (!empty($links))
 				{
 					$subforums_list = implode(', ', $links);
-					$l_subforums = (sizeof($subforums[$forum_id]) == 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] . ': ' : $_CLASS['core_user']-&gt;lang['SUBFORUMS'] . ': ';
+					$l_subforums = (count($subforums[$forum_id]) == 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] . ': ' : $_CLASS['core_user']-&gt;lang['SUBFORUMS'] . ': ';
 				}
 
 				unset($links);
@@ -291,7 +291,7 @@
 		$l_moderator = $moderators_list = '';
 		if ($display_moderators &amp;&amp; !empty($forum_moderators[$forum_id]))
 		{
-			$l_moderator = (sizeof($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']-&gt;lang['MODERATOR'] : $_CLASS['core_user']-&gt;lang['MODERATORS'];
+			$l_moderator = (count($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']-&gt;lang['MODERATOR'] : $_CLASS['core_user']-&gt;lang['MODERATORS'];
 			$moderators_list = implode(', ', $forum_moderators[$forum_id]);
 		}
 
@@ -329,8 +329,8 @@
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'MODIFY_FORUM'		=&gt; $_CLASS['auth']-&gt;acl_get('a_forum'),
 		'U_MARK_FORUMS'		=&gt; generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
-		'S_HAS_SUBFORUM'	=&gt;	($visible_forums) ? true : false,
-		'L_SUBFORUM'		=&gt;	($visible_forums == 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] : $_CLASS['core_user']-&gt;lang['SUBFORUMS']
+		'S_HAS_SUBFORUM'	=&gt; ($visible_forums) ? true : false,
+		'L_SUBFORUM'		=&gt; ($visible_forums == 1) ? $_CLASS['core_user']-&gt;lang['SUBFORUM'] : $_CLASS['core_user']-&gt;lang['SUBFORUMS']
 	));
 
 	return $active_forum_ary;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -199,7 +199,7 @@
 	$file-&gt;clean_filename('unique', $_CLASS['core_user']-&gt;data['user_id'] . '_');
 	$file-&gt;move_file($config['upload_path']);
 		
-	if (sizeof($file-&gt;error))
+	if (!empty($file-&gt;error))
 	{
 		$file-&gt;remove();
 		$filedata['error'] = array_merge($filedata['error'], $file-&gt;error);
@@ -502,21 +502,21 @@
 {
 	global $_CLASS;
 
-	if (sizeof($attachment_data))
+	if (empty($attachment_data))
 	{
-		$s_inline_attachment_options = '';
-		
-		foreach ($attachment_data as $i =&gt; $attachment)
-		{
-			$s_inline_attachment_options .= '&lt;option value=&quot;' . $i . '&quot;&gt;' . $attachment['real_filename'] . '&lt;/option&gt;';
-		}
+		return false;
+	}
 
-		$_CLASS['core_template']-&gt;assign('S_INLINE_ATTACHMENT_OPTIONS', $s_inline_attachment_options);
-
-		return true;
+	$s_inline_attachment_options = '';
+	
+	foreach ($attachment_data as $i =&gt; $attachment)
+	{
+		$s_inline_attachment_options .= '&lt;option value=&quot;' . $i . '&quot;&gt;' . $attachment['real_filename'] . '&lt;/option&gt;';
 	}
 
-	return false;
+	$_CLASS['core_template']-&gt;assign('S_INLINE_ATTACHMENT_OPTIONS', $s_inline_attachment_options);
+
+	return true;
 }
 
 // Build topic types able to be selected
@@ -581,7 +581,7 @@
 		
 	$_CLASS['core_template']-&gt;assign('S_SHOW_ATTACH_BOX', true);
 
-	if (sizeof($attachment_data))
+	if (!empty($attachment_data))
 	{
 		$_CLASS['core_template']-&gt;assign('S_HAS_ATTACHMENTS', true);
 		
@@ -618,7 +618,7 @@
 		'FILESIZE'		=&gt; $config['max_filesize'])
 	);
 
-	return sizeof($attachment_data);
+	return count($attachment_data);
 }
 
 // Load Drafts
@@ -659,7 +659,7 @@
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 				
-	if (sizeof($topic_ids))
+	if (!empty($topic_ids))
 	{
 		$sql = 'SELECT topic_id, forum_id, topic_title
 			FROM ' . FORUMS_TOPICS_TABLE . '
@@ -674,7 +674,7 @@
 	}
 	unset($topic_ids);
 	
-	if (sizeof($draftrows))
+	if (!empty($draftrows))
 	{
 		$_CLASS['core_template']-&gt;assign_array('S_SHOW_DRAFTS', true);
 

Added: cms/trunk/includes/forums/functions_profile_fields.php
===================================================================
--- cms/trunk/includes/forums/functions_profile_fields.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_profile_fields.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,894 @@
+&lt;?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright &#169; 2004 by Viperal									//
+//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: functions_profile_fields.php,v 1.10 2004/09/19 20:40:20 acydburn Exp $
+//
+// FILENAME  : functions_profile_fields.php
+// STARTED   : Tue Oct 21, 2003
+// COPYRIGHT : &#169; 2003 phpBB Group
+// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+class custom_profile
+{
+	var $profile_types = array(1 =&gt; 'int', 2 =&gt; 'string', 3 =&gt; 'text', 4 =&gt; 'bool', 5 =&gt; 'dropdown', 6 =&gt; 'date');
+	var $profile_cache = array();
+	var $options_lang = array();
+
+	// Build language options cache, useful for viewtopic display
+	function build_cache()
+	{
+		global $_CLASS;
+
+		$this-&gt;profile_cache = array();
+
+		// Display hidden/no_view fields for admin/moderator
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
+			WHERE l.lang_id = ' . $_CLASS['core_user']-&gt;get_iso_lang_id() . '
+				AND f.field_active = 1 ' .
+				((!$_CLASS['auth']-&gt;acl_gets('a_', 'm_')) ? '     AND f.field_hide = 0 AND f.field_no_view = 0 ' : '') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		{
+			$this-&gt;profile_cache[$row['field_ident']] = $row;
+		}
+		$_CLASS['core_db']-&gt;sql_freeresult($result);
+	}
+
+	// Get language entries for options and store them here for later use
+	function get_option_lang($field_id, $lang_id, $field_type, $preview)
+	{
+		global $_CLASS;
+
+		if ($preview)
+		{
+			$lang_options = (!is_array($this-&gt;vars['lang_options'])) ? explode(&quot;\n&quot;, $this-&gt;vars['lang_options']) : $this-&gt;vars['lang_options'];
+			
+			foreach ($lang_options as $num =&gt; $var)
+			{
+				$this-&gt;options_lang[$field_id][$lang_id][($num+1)] = $var;
+			}
+		}
+		else
+		{
+			$sql = 'SELECT option_id, value
+				FROM ' . PROFILE_FIELDS_LANG_TABLE . &quot;
+					WHERE field_id = $field_id
+					AND lang_id = $lang_id
+					AND field_type = $field_type
+				ORDER BY option_id&quot;;
+			$result = $_CLASS['core_db']-&gt;sql_query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+			{
+				$this-&gt;options_lang[$field_id][$lang_id][$row['option_id']] = $row['value'];
+			}
+			$_CLASS['core_db']-&gt;sql_freeresult($result);
+		}
+	}
+
+	// Functions performing operations on register/profile/profile admin
+	function submit_cp_field($mode, $lang_id, &amp;$cp_data, &amp;$cp_error)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . &quot; f 
+			WHERE l.lang_id = $lang_id
+				AND f.field_active = 1
+				&quot; . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
+				(($_CLASS['auth']-&gt;acl_gets('a_', 'm_') &amp;&amp; $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+					
+		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		{
+			$cp_data[$row['field_ident']] = $this-&gt;get_profile_field($row);
+
+			// get_profile_field returns an array with values for TEXT fields.
+			if(is_array($cp_data[$row['field_ident']]))
+			{
+				// Contains the original text without bbcode processing etc
+				$check_value = $cp_data[$row['field_ident']]['submitted'];
+				
+				foreach($cp_data[$row['field_ident']] as $key =&gt; $value)
+				{
+					if($key != 'submitted')
+					{
+						$cp_data[$key] = $value;
+					}
+				}
+			}
+			else
+			{
+				$check_value = $cp_data[$row['field_ident']];
+			}
+			
+			if (($cp_result = $this-&gt;validate_profile_field($row['field_type'], $check_value, $row)) !== false)
+			{
+				// If not and only showing common error messages, use this one
+				$error = false;
+
+				switch ($cp_result)
+				{
+					case 'FIELD_INVALID_DATE':
+					case 'FIELD_REQUIRED':
+						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name']);
+						break;
+					case 'FIELD_TOO_SHORT':
+					case 'FIELD_TOO_SMALL':
+						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name'], $row['field_minlen']);
+						break;
+					case 'FIELD_TOO_LONG':
+					case 'FIELD_TOO_LARGE':
+						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name'], $row['field_maxlen']);
+						break;
+					case 'FIELD_INVALID_CHARS':
+						switch ($row['field_validation'])
+						{
+							case '[0-9]+':
+								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_NUMBERS_ONLY'], $row['lang_name']);
+								break;
+							case '[\w]+':
+								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_ALPHA_ONLY'], $row['lang_name']);
+								break;
+							case '[\w_\+\. \-\[\]]+':
+								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_SPACERS_ONLY'], $row['lang_name']);
+								break;
+						}
+						break;
+				}
+
+				if ($error)
+				{
+					$cp_error[] = $error;
+				}
+			}
+		}
+		$_CLASS['core_db']-&gt;sql_freeresult($result);
+	}
+	
+	// Assign fields to template, mode can be profile (for profile change) or register (for registration)
+//	function generate_profile_fields($mode, $lang_id, $cp_error)
+	function generate_profile_fields($mode, $lang_id)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . &quot; f 
+			WHERE l.lang_id = $lang_id
+				AND f.field_active = 1
+				&quot; . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
+				(($_CLASS['auth']-&gt;acl_gets('a_', 'm_') &amp;&amp; $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		{
+			$_CLASS['core_template']-&gt;assign_vars_array('profile_fields', array(
+				'LANG_NAME' =&gt; $row['lang_name'],
+				'LANG_EXPLAIN' =&gt; $row['lang_explain'],
+				'FIELD' =&gt; $this-&gt;process_field_row('change', $row))
+//				'ERROR' =&gt; $error)
+			);
+		}
+		$_CLASS['core_db']-&gt;sql_freeresult($result);
+	}
+
+	// Assign fields to template, used for viewprofile, viewtopic and memberlist (if load setting is enabled)
+	// This is directly connected to the user -&gt; mode == grab is to grab the user specific fields, mode == show is for assigning the row to the template
+	function generate_profile_fields_template($mode, $user_id = 0, $profile_row = false)
+	{
+		global $_CLASS;
+
+		if ($mode == 'grab')
+		{
+			if (!is_array($user_id))
+			{
+				$user_id = array($user_id);
+			}
+			
+			if (!sizeof($this-&gt;profile_cache))
+			{
+				$this-&gt;build_cache();
+			}
+
+			if (!implode(', ', $user_id))
+			{
+				return array();
+			}
+
+			$sql = 'SELECT *
+				FROM ' . PROFILE_DATA_TABLE . '
+				WHERE user_id IN (' . implode(', ', array_map('intval', $user_id)) . ')';
+			$result = $_CLASS['core_db']-&gt;sql_query($sql);
+
+			if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
+			{
+				return array();
+			}
+			
+			$user_fields = array();
+			do
+			{
+				foreach ($row as $ident =&gt; $value)
+				{
+					if (isset($this-&gt;profile_cache[$ident]))
+					{
+						$user_fields[$row['user_id']][$ident]['value'] = $value;
+						$user_fields[$row['user_id']][$ident]['data'] = $this-&gt;profile_cache[$ident];
+					}
+					else if($i = strpos($ident, '_bbcode'))
+					{
+						// Add extra data (bbcode_uid and bbcode_bitfield) to the data for this profile field.
+						// TODO: Maybe we should try to make this a bit more generic (not limited to bbcode)?
+						$field = substr($ident, 0, $i);
+						$subfield = substr($ident, $i+1);
+						$user_fields[$row['user_id']][$field]['data'][$subfield] = $value;
+					}
+				}
+			} 
+			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
+			
+			$_CLASS['core_db']-&gt;sql_freeresult($result);
+
+			return $user_fields;
+
+		}
+		elseif ($mode == 'show')
+		{
+			// $profile_row == $user_fields[$row['user_id']];
+			$tpl_fields = array();
+			$tpl_fields['row'] = $tpl_fields['blockrow'] = array();
+
+			foreach ($profile_row as $ident =&gt; $ident_ary)
+			{
+				$tpl_fields['row'] += array(
+					'PROFILE_' . strtoupper($ident) . '_VALUE'	=&gt; $this-&gt;get_profile_value($ident_ary),
+					'PROFILE_' . strtoupper($ident) . '_TYPE'	=&gt; $ident_ary['data']['field_type'],
+					'PROFILE_' . strtoupper($ident) . '_NAME'	=&gt; $ident_ary['data']['lang_name'],
+					'PROFILE_' . strtoupper($ident) . '_EXPLAIN'=&gt; $ident_ary['data']['lang_explain'],
+
+					'S_PROFILE_' . strtoupper($ident)			=&gt; true
+				);
+				
+				$tpl_fields['blockrow'][] = array(
+					'PROFILE_FIELD_VALUE'   =&gt; $this-&gt;get_profile_value($ident_ary),
+					'PROFILE_FIELD_TYPE'    =&gt; $ident_ary['data']['field_type'],
+					'PROFILE_FIELD_NAME'    =&gt; $ident_ary['data']['lang_name'],
+					'PROFILE_FIELD_EXPLAIN' =&gt; $ident_ary['data']['lang_explain'],
+					'S_PROFILE_' . strtoupper($ident)               =&gt; true
+				);
+			}
+		
+			return $tpl_fields;
+		}
+	}
+	
+	// VALIDATE Function - validate entered data
+	function validate_profile_field($field_type, &amp;$field_value, $field_data)
+	{
+		switch ($field_type)
+		{
+			case FIELD_INT:
+			case FIELD_DROPDOWN:
+				$field_value = (int) $field_value;
+				break;
+
+			case FIELD_BOOL:
+				$field_value = (bool) $field_value;
+				break;
+		}
+
+		switch ($field_type)
+		{
+			case FIELD_DATE:
+				$field_validate = explode('-', $field_value);
+				
+				$day = (int) $field_validate[0];
+				$month = (int) $field_validate[1];
+				$year = (int) $field_validate[2];
+
+				if ((!$day || !$month || !$year) &amp;&amp; !$field_data['field_required'])
+				{
+					return false;
+				}
+
+				if ((!$day || !$month || !$year) &amp;&amp; $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+
+				if ($day &lt; 0 || $day &gt; 31 || $month &lt; 0 || $month &gt; 12 || ($year &lt; 1901 &amp;&amp; $year &gt; 0) || $year &gt; gmdate('Y', time()))
+				{
+					return 'FIELD_INVALID_DATE';
+				}
+				break;
+
+			case FIELD_INT:
+				if (empty($field_value) &amp;&amp; !$field_data['field_required'])
+				{
+					return false;
+				}
+
+				if ($field_value &lt; $field_data['field_minlen'])
+				{
+					return 'FIELD_TOO_SMALL';
+				}
+				else if ($field_value &gt; $field_data['field_maxlen']) 
+				{
+					return 'FIELD_TOO_LARGE';
+				}
+				break;
+		
+			case FIELD_DROPDOWN:
+				if ($field_value == $field_data['field_novalue'] &amp;&amp; $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+				break;
+			
+			case FIELD_STRING:
+			case FIELD_TEXT:
+				if (empty($field_value) &amp;&amp; !$field_data['field_required'])
+				{
+					return false;
+				}
+				else if (empty($field_value) &amp;&amp; $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+
+				if ($field_data['field_minlen'] &amp;&amp; strlen($field_value) &lt; $field_data['field_minlen'])
+				{
+					return 'FIELD_TOO_SHORT';
+				}
+				else if ($field_data['field_maxlen'] &amp;&amp; strlen($field_value) &gt; $field_data['field_maxlen'])
+				{
+					return 'FIELD_TOO_LONG';
+				}
+
+				if (!empty($field_data['field_validation']) &amp;&amp; $field_data['field_validation'] != '.*')
+				{
+					$field_validate = ($field_type == FIELD_STRING) ? $field_value : str_replace(&quot;\n&quot;, ' ', $field_value);
+					if (!preg_match('#^' . str_replace('\\\\', '\\', $field_data['field_validation']) . '$#i', $field_validate))
+					{
+						return 'FIELD_INVALID_CHARS';
+					}
+				}
+				break;
+		}
+
+		return false;
+	}
+
+	// Get Profile Value for display
+	function get_profile_value($ident_ary)
+	{
+		$value = $ident_ary['value'];
+		$field_type = $ident_ary['data']['field_type'];
+		
+		switch ($this-&gt;profile_types[$field_type])
+		{
+			case 'int':
+				return (int) $value;
+				break;
+			case 'string':
+				return str_replace(&quot;\n&quot;, '&lt;br /&gt;', $value);
+				break;
+			case 'text':
+				// Prepare further, censor_text, smilies, bbcode, html, whatever
+				if ($ident_ary['data']['bbcode_bitfield'])
+				{
+					$bbcode = new bbcode($ident_ary['data']['bbcode_bitfield']);
+					$bbcode-&gt;bbcode_second_pass($value, $ident_ary['data']['bbcode_uid'], $ident_ary['data']['bbcode_bitfield']);
+					$value = smiley_text($value);
+					$value = censor_text($value);
+				}
+				
+				return str_replace(&quot;\n&quot;, '&lt;br /&gt;', $value);
+				break;
+			case 'date':
+				break;
+			case 'dropdown':
+				$field_id = $ident_ary['data']['field_id'];
+				$lang_id = $ident_ary['data']['lang_id'];
+				if (!isset($this-&gt;options_lang[$field_id][$lang_id]))
+				{
+					$this-&gt;get_option_lang($field_id, $lang_id, FIELD_DROPDOWN, false);
+				}
+
+				return $this-&gt;options_lang[$field_id][$lang_id][(int) $value];
+				break;
+			case 'bool':
+				break;
+			default:
+				trigger_error('Unknown profile type');
+				break;
+		}
+	}
+
+	// Get field value for registration/profile
+	function get_var($field_validation, &amp;$profile_row, $default_value, $preview)
+	{
+		global $_CLASS;
+
+		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
+		
+		// checkbox - only testing for isset
+		if ($profile_row['field_type'] == FIELD_BOOL &amp;&amp; $profile_row['field_length'] == 2)
+		{
+			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? true : ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $default_value : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]);
+		}
+		else
+		{
+			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? request_var($profile_row['field_ident'], $default_value) : ((!isset($_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]) || $preview) ? $default_value : $_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]);
+		}
+
+		switch ($field_validation)
+		{
+			case 'int':
+				return (int) $value;
+				break;
+		}
+
+		return $value;
+	}
+	
+	// GENERATE_* Functions - return templated, storable profile fields
+	function generate_int($profile_row, $preview = false)
+	{
+		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+		$this-&gt;set_tpl_vars($profile_row, $value);
+
+		return $this-&gt;get_cp_html();
+	}
+
+	function generate_date($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
+		$now = getdate();
+
+		if (!isset($_REQUEST[$profile_row['field_ident'] . '_day']))
+		{
+			if ($profile_row['field_default_value'] == 'now')
+			{
+				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+			}
+			list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]));
+		}
+		else
+		{
+			if ($preview &amp;&amp; $profile_row['field_default_value'] == 'now')
+			{
+				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+				list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]));
+			}
+			else
+			{
+				$day = request_var($profile_row['field_ident'] . '_day', 0);
+				$month = request_var($profile_row['field_ident'] . '_month', 0);
+				$year = request_var($profile_row['field_ident'] . '_year', 0);
+			}
+		}
+
+		$profile_row['s_day_options'] = '&lt;option value=&quot;0&quot;' . ((!$day) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
+		for ($i = 1; $i &lt; 32; $i++)
+		{
+			$profile_row['s_day_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $day) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
+		}
+
+		$profile_row['s_month_options'] = '&lt;option value=&quot;0&quot;' . ((!$month) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
+		for ($i = 1; $i &lt; 13; $i++)
+		{
+			$profile_row['s_month_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $month) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
+		}
+
+		$profile_row['s_year_options'] = '&lt;option value=&quot;0&quot;' . ((!$year) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
+		for ($i = $now['year'] - 100; $i &lt;= $now['year']; $i++)
+		{
+			$profile_row['s_year_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $year) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
+		}
+		unset($now);
+		
+		$this-&gt;set_tpl_vars($profile_row, 0);
+		return $this-&gt;get_cp_html();
+	}
+
+	function generate_bool($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+
+		$this-&gt;set_tpl_vars($profile_row, $value);
+
+		if ($profile_row['field_length'] == 1)
+		{
+			if (!isset($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]) || !sizeof($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
+			{
+				$this-&gt;get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_BOOL, $preview);
+			}
+
+			foreach ($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id =&gt; $option_value)
+			{
+				$_CLASS['core_template']-&gt;assign_vars_array('bool.options', array(
+					'OPTION_ID' =&gt; $option_id,
+					'CHECKED' =&gt; ($value == $option_id) ? ' checked=&quot;checked&quot;' : '',
+					'VALUE' =&gt; $option_value)
+				);
+			}
+		}
+
+		return $this-&gt;get_cp_html();
+	}
+
+	// Get the data associated with this field for this user
+	function generate_string($profile_row, $preview = false)
+	{
+		$value = $this-&gt;get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
+		$this-&gt;set_tpl_vars($profile_row, $value);
+
+		return $this-&gt;get_cp_html();
+	}
+
+	function generate_text($profile_row, $preview = false)
+	{
+		global $_CLASS, $site_file_root;
+		
+		$value = $this-&gt;get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
+		
+		if($preview == false)
+		{
+			include_once($site_file_root.'includes/forums/message_parser.php');
+			include_once($site_file_root.'includes/forums/functions_posting.php');
+			
+			$message_parser = new parse_message();
+			$message_parser-&gt;message = $value;
+			$message_parser-&gt;decode_message($_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident']) . '_bbcode_uid']);
+			$value = $message_parser-&gt;message;
+		}
+		
+		$field_length = explode('|', $profile_row['field_length']);
+		$profile_row['field_rows'] = $field_length[0];
+		$profile_row['field_cols'] = $field_length[1];
+
+		$this-&gt;set_tpl_vars($profile_row, $value);
+
+		return $this-&gt;get_cp_html();
+	}
+
+	function generate_dropdown($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+
+		if (!isset($this-&gt;options_lang[$profile_row['field_id']]) || !sizeof($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
+		{
+			$this-&gt;get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_DROPDOWN, $preview);
+		}
+
+		$this-&gt;set_tpl_vars($profile_row, $value);
+
+		foreach ($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id =&gt; $option_value)
+		{
+			$_CLASS['core_template']-&gt;assign_vars_array('dropdown.options', array(
+				'OPTION_ID' =&gt; $option_id,
+				'SELECTED' =&gt; ($value == $option_id) ? ' selected=&quot;selected&quot;' : '',
+				'VALUE' =&gt; $option_value)
+			);
+		}
+
+		return $this-&gt;get_cp_html();
+	}
+
+
+	// Return Templated value (change == user is able to set/enter profile values; show == just show the value)
+	function process_field_row($mode, $profile_row)
+	{
+		$preview = false;
+
+		switch ($mode)
+		{
+			case 'preview':
+				$preview = true;
+			case 'change':
+				$type_func = 'generate_' . $this-&gt;profile_types[$profile_row['field_type']];
+				break;
+			default:
+				return;
+		}
+
+		return $this-&gt;$type_func($profile_row, $preview);
+	}
+
+	// Build Array for user insertion into custom profile fields table
+	function build_insert_sql_array($cp_data)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT f.field_type, f.field_ident, f.field_default_value, l.lang_default_value
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
+			WHERE l.lang_id = ' . $_CLASS['core_user']-&gt;get_iso_lang_id() . ' 
+				AND f.field_active = 1
+				AND f.field_show_on_reg = 0
+				' . (($_CLASS['auth']-&gt;acl_gets('a_', 'm_')) ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id';
+		$result = $_CLASS['core_db']-&gt;sql_query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		{
+			if ($row['field_default_value'] == 'now' &amp;&amp; $row['field_type'] == FIELD_DATE)
+			{
+				$now = getdate();
+				$row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+			}
+			$cp_data[$row['field_ident']] = (in_array($row['field_type'], array(FIELD_TEXT, FIELD_STRING))) ? $row['lang_default_value'] : $row['field_default_value'];
+		}
+		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		
+		return $cp_data;
+	}
+
+	function get_profile_field($profile_row)
+	{
+		global $site_file_root;
+		
+		switch ($profile_row['field_type'])
+		{
+			case FIELD_DATE:
+
+				if (!isset($_REQUEST[$var_name . '_day']))
+				{
+					if ($profile_row['field_default_value'] == 'now')
+					{
+						$now = getdate();
+						$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+					}
+					list($day, $month, $year) = explode('-', $profile_row['field_default_value']);
+				}
+				else
+				{
+					$day = request_var($var_name . '_day', 0);
+					$month = request_var($var_name . '_month', 0);
+					$year = request_var($var_name . '_year', 0);
+				}
+				
+				$var = sprintf('%2d-%2d-%4d', $day, $month, $year);
+				break;
+
+			case FIELD_TEXT:
+				include_once($site_file_root.'includes/forums/message_parser.php');
+				$message_parser = new parse_message(request_var($var_name, ''));
+				
+				// Get the allowed settings from the global settings. Magic URLs are always set to true.
+				// TODO: It might be nice to make this a per field setting.
+				$message_parser-&gt;parse($config['allow_html'], $config['allow_bbcode'], true, $config['allow_smilies']);
+				
+				$var = array(
+					$profile_row['field_ident'] =&gt; $message_parser-&gt;message,
+					$profile_row['field_ident'] . '_bbcode_uid' =&gt; $message_parser-&gt;bbcode_uid,
+					$profile_row['field_ident'] . '_bbcode_bitfield' =&gt; $message_parser-&gt;bbcode_bitfield,
+					 'submitted' =&gt; request_var($var_name, '')
+				);
+				break;
+
+			default:
+				$var = request_var($var_name, $profile_row['field_default_value']);
+				break;
+		}
+
+		return $var;
+	}
+
+	function set_tpl_vars($profile_row, $field_value)
+	{
+		global $_CLASS;
+		
+		foreach ($this-&gt;profile_types as $field_case =&gt; $field_type)
+		{
+			unset($_CLASS['core_template']-&gt;_tpl_vars[$field_type]);
+		}
+
+		foreach ($profile_row as $key =&gt; $value)
+		{
+			unset($profile_row[$key]);
+			$profile_row[strtoupper($key)] = $value;
+		}
+
+		$profile_row['FIELD_VALUE'] = $field_value;
+
+		$_CLASS['core_template']-&gt;assign_vars_array($this-&gt;profile_types[$profile_row['FIELD_TYPE']], $profile_row);
+	}
+
+	function get_cp_html()
+	{
+		global $_CLASS;
+
+		ob_start();
+
+		$_CLASS['core_template']-&gt;display('forums/custom_profile_fields.html');
+
+		$data = ob_get_contents();
+		ob_end_clean();
+
+		return $data;
+	}
+}
+
+class custom_profile_admin extends custom_profile
+{
+	var $vars = array();
+	
+
+	function validate_options()
+	{
+		global $_CLASS;
+
+		$validate_ary = array('CHARS_ANY' =&gt; '.*', 'NUMBERS_ONLY' =&gt; '[0-9]+', 'ALPHA_ONLY' =&gt; '[\w]+', 'ALPHA_SPACERS' =&gt; '[\w_\+\. \-\[\]]+');
+
+		$validate_options = '';
+		foreach ($validate_ary as $lang =&gt; $value)
+		{
+			$selected = ($this-&gt;vars['field_validation'] == $value) ? ' selected=&quot;selected&quot;' : '';
+			$validate_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
+		}
+
+		return $validate_options;
+	}
+	
+	// GET_* get admin options for second step
+	function get_string_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_length&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;'),
+			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
+			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
+			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_VALIDATION'], 'FIELD' =&gt; '&lt;select name=&quot;field_validation&quot;&gt;' . $this-&gt;validate_options() . '&lt;/select&gt;')
+		);
+
+		return $options;
+	}
+
+	function get_text_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;table border=0&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;rows&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['rows'] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $_CLASS['core_user']-&gt;lang['ROWS'] . ' ]&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;columns&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['columns'] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $_CLASS['core_user']-&gt;lang['COLUMNS'] . ' ] &lt;input type=&quot;hidden&quot; name=&quot;field_length&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'),
+			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;10&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
+			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;10&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
+			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_VALIDATION'], 'FIELD' =&gt; '&lt;select name=&quot;field_validation&quot;&gt;' . $this-&gt;validate_options() . '&lt;/select&gt;')
+		);
+
+		return $options;
+	}
+
+	function get_int_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_length&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;'),
+			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_NUMBER'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
+			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_NUMBER'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
+			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;post&quot; name=&quot;field_default_value&quot; value=&quot;' . $this-&gt;vars['field_default_value'] . '&quot; /&gt;')
+		);
+
+		return $options;
+	}
+
+	function get_bool_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row = array(
+			'var_name'				=&gt; 'field_default_value',
+			'field_id'				=&gt; 1,
+			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
+			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
+			'lang_id'				=&gt; $default_lang_id,
+			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
+			'field_ident'			=&gt; 'field_default_value',
+			'field_type'			=&gt; FIELD_BOOL,
+			'field_length'			=&gt; $this-&gt;vars['field_length'],
+			'lang_options'			=&gt; $this-&gt;vars['lang_options']
+		);
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_TYPE'], 'EXPLAIN' =&gt; $_CLASS['core_user']-&gt;lang['BOOL_TYPE_EXPLAIN'], 'FIELD' =&gt; '&lt;input type=&quot;radio&quot; name=&quot;field_length&quot; value=&quot;1&quot;' . (($this-&gt;vars['field_length'] == 1) ? ' checked=&quot;checked&quot;' : '') . ' /&gt;' . $_CLASS['core_user']-&gt;lang['RADIO_BUTTONS'] . '&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;field_length&quot; value=&quot;2&quot;' . (($this-&gt;vars['field_length'] == 2) ? ' checked=&quot;checked&quot;' : '') . ' /&gt;' . $_CLASS['core_user']-&gt;lang['CHECKBOX'] . '&nbsp; &nbsp;'),
+			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_bool($profile_row, true))
+		);
+
+		return $options;
+	}
+
+	function get_dropdown_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row[0] = array(
+			'var_name'				=&gt; 'field_default_value',
+			'field_id'				=&gt; 1,
+			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
+			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
+			'lang_id'				=&gt; $default_lang_id,
+			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
+			'field_ident'			=&gt; 'field_default_value',
+			'field_type'			=&gt; FIELD_DROPDOWN,
+			'lang_options'			=&gt; $this-&gt;vars['lang_options']
+		);
+
+		$profile_row[1] = $profile_row[0];
+		$profile_row[1]['var_name'] = 'field_novalue';
+		$profile_row[1]['field_ident'] = 'field_novalue';
+		$profile_row[1]['field_default_value']	= $this-&gt;vars['field_novalue'];
+
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_dropdown($profile_row[0], true)),
+			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['NO_VALUE_OPTION'], 'EXPLAIN' =&gt; $_CLASS['core_user']-&gt;lang['NO_VALUE_OPTION_EXPLAIN'], 'FIELD' =&gt; $this-&gt;generate_dropdown($profile_row[1], true))
+		);
+
+		return $options;
+	}
+
+	function get_date_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row = array(
+			'var_name'				=&gt; 'field_default_value',
+			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
+			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
+			'lang_id'				=&gt; $default_lang_id,
+			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
+			'field_ident'			=&gt; 'field_default_value',
+			'field_type'			=&gt; FIELD_DATE,
+			'field_length'			=&gt; $this-&gt;vars['field_length']
+		);
+
+		$options = array(
+			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_date($profile_row, true) . '&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;always_now&quot;' . ((isset($_REQUEST['always_now']) || $this-&gt;vars['field_default_value'] == 'now') ? ' checked=&quot;checked&quot;' : '') . ' /&gt;&nbsp; ' . $_CLASS['core_user']-&gt;lang['ALWAYS_TODAY'])
+		);
+
+		return $options;
+	}
+}
+
+?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -755,7 +755,8 @@
 
 		// Parse smilies
 		if ($allow_smilies)
-		{
+		{	
+$config['max_' . $mode . '_smilies'] = 0;
 			$this-&gt;smilies($config['max_' . $mode . '_smilies']);
 		}
 		$num_urls = 0;
@@ -781,7 +782,7 @@
 		if ($allow_magic_url)
 		{
 			$this-&gt;magic_url();
-	
+$config['max_' . $mode . '_urls'] = 0;
 			if ($config['max_' . $mode . '_urls'])
 			{
 				$num_urls += preg_match_all('#\&lt;!-- (l|m|w|e) --\&gt;.*?\&lt;!-- \1 --\&gt;#', $this-&gt;message, $matches);
@@ -789,7 +790,8 @@
 		}
 		
 		// Check number of links
-		if ($config['max_' . $mode . '_urls'] &amp;&amp; $num_urls &gt; $config['max_' . $mode . '_urls'])
+//max_sig_urls
+		if (isset($config['max_' . $mode . '_urls']) &amp;&amp; $config['max_' . $mode . '_urls'] &amp;&amp; $num_urls &gt; $config['max_' . $mode . '_urls'])
 		{
 			$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['TOO_MANY_URLS'], $config['max_' . $mode . '_urls']);
 			return $this-&gt;warn_msg;

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -149,8 +149,14 @@
 
 	if ($_CORE_CONFIG['maintenance']['active'])
 	{
-		if ($_CORE_CONFIG['maintenance']['start'] &lt; time())
+		if ($_CORE_CONFIG['maintenance']['start'] &lt; gmtime())
 		{
+// TEMP fix maybe
+			if (get_variable('mod', 'REQUEST', false) === 'system' &amp;&amp; get_variable('mode', 'REQUEST', false) === 'confirmation_image')
+			{
+				return $maintance_status = false;
+			}
+
 			if (VIPERAL == 'Admin' || (isset($_CLASS['core_user']) &amp;&amp; $_CLASS['core_user']-&gt;is_admin))
 			{
 				return $maintance_status = false;

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/functions_user.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -541,4 +541,195 @@
 	return true;
 }
 
+
+
+/***
+Temp copy from phpBB function_user.php
+***/
+function validate_string($string, $optional = false, $min = 0, $max = 0)
+{
+	if (empty($string) &amp;&amp; $optional)
+	{
+		return false;
+	}
+
+	if ($min &amp;&amp; strlen($string) &lt; $min)
+	{
+		return 'TOO_SHORT';
+	}
+	else if ($max &amp;&amp; strlen($string) &gt; $max)
+	{
+		return 'TOO_LONG';
+	}
+
+	return false;
+}
+
+function validate_num($num, $optional = false, $min = 0, $max = 1E99)
+{
+	if (empty($num) &amp;&amp; $optional)
+	{
+		return false;
+	}
+
+	if ($num &lt; $min)
+	{
+		return 'TOO_SMALL';
+	}
+	else if ($num &gt; $max) 
+	{
+		return 'TOO_LARGE';
+	}
+
+	return false;
+}
+
+function validate_match($string, $optional = false, $match)
+{
+	if (empty($string) &amp;&amp; $optional)
+	{
+		return false;
+	}
+
+	if (!preg_match($match, $string))
+	{
+		return 'WRONG_DATA';
+	}
+	return false;
+}
+
+// TODO?
+// Ability to limit types of email address ... not by banning, seperate table
+// capability to require (or deny) use of certain addresses when user is
+// registering from certain IP's/hosts
+
+// Check to see if email address is banned or already present in the DB
+function validate_email($email)
+{
+	global $_CORE_CONFIG, $_CLASS;
+
+	if (strtolower($_CLASS['core_user']-&gt;data['user_email']) == strtolower($email))
+	{
+		return false;
+	}
+
+	if (!preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email))
+	{
+		return 'EMAIL_INVALID';
+	}
+
+	$sql = 'SELECT ban_email
+		FROM ' . BANLIST_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		if (preg_match('#^' . str_replace('*', '.*?', $row['ban_email']) . '$#i', $email))
+		{
+			return 'EMAIL_BANNED';
+		}
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if (!$_CORE_CONFIG['user']['allow_emailreuse'])
+	{
+		$sql = 'SELECT user_email_hash
+			FROM ' . USERS_TABLE . &quot;
+			WHERE user_email_hash = &quot; . crc32(strtolower($email)) . strlen($email);
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			return 'EMAIL_TAKEN';
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+	return false;
+}
+
+//
+// Avatar functions
+//
+
+function avatar_delete($id)
+{
+	global $config, $_CORE_CONFIG;
+
+	if (file_exists($config['avatar_path'] . '/' . $id))
+	{
+		@unlink($config['avatar_path'] . '/' . $id);
+	}
+
+	return false;
+ }
+
+function avatar_remote($data, &amp;$error)
+{
+	global $config, $_CLASS;
+
+	if (!preg_match('#^(http|https|ftp)://#i', $data['remotelink']))
+	{
+		$data['remotelink'] = '<A HREF="http://">http://</A>' . $data['remotelink'];
+	}
+
+	if (!preg_match('#^(http|https|ftp)://(.*?\.)*?[a-z0-9\-]+?\.[a-z]{2,4}:?([0-9]*?).*?\.(gif|jpg|jpeg|png)$#i', $data['remotelink']))
+	{
+		$error[] = $_CLASS['core_user']-&gt;lang['AVATAR_URL_INVALID'];
+		return false;
+	}
+
+	if ((!($data['width'] || $data['height']) || $data['remotelink'] != $_CLASS['core_user']-&gt;data['user_avatar']) &amp;&amp; ($config['avatar_max_width'] || $config['avatar_max_height']))
+	{
+		list($width, $height) = @getimagesize($data['remotelink']);
+
+		if (!$width || !$height)
+		{
+			$error[] = $_CLASS['core_user']-&gt;lang['AVATAR_NO_SIZE'];
+			return false;
+		}
+		else if ($width &gt; $config['avatar_max_width'] || $height &gt; $config['avatar_max_height'])
+		{
+			$error[] = sprintf($_CLASS['core_user']-&gt;lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
+			return false;
+		}
+	}
+	else if ($data['width'] &gt; $config['avatar_max_width'] || $data['height'] &gt; $config['avatar_max_height'])
+	{
+		$error[] = sprintf($_CLASS['core_user']-&gt;lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
+		return false;
+	}
+
+	return array(AVATAR_REMOTE, $data['remotelink'], $width, $height);
+}
+
+function avatar_upload($data, &amp;$error)
+{
+	global $site_file_root, $config, $_CLASS;
+
+	// Init upload class
+	include_once($site_file_root.'includes/forums/functions_upload.php');
+	
+	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
+							
+	if (!empty($_FILES['uploadfile']['name']))
+	{
+		$file = $upload-&gt;form_upload('uploadfile');
+	}
+	else
+	{
+		$file = $upload-&gt;remote_upload($data['uploadurl']);
+	}
+
+	$file-&gt;clean_filename('real', $_CLASS['core_user']-&gt;data['user_id'] . '_');
+	$file-&gt;move_file($config['avatar_path']);
+
+	if (sizeof($file-&gt;error))
+	{
+		$file-&gt;remove();
+		$error = array_merge($error, $file-&gt;error);
+	}
+	
+	return array(AVATAR_UPLOAD, $file-&gt;get('realname'), $file-&gt;get('width'), $file-&gt;get('height'));
+}
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/tables.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -191,6 +191,7 @@
 define('FORUMS_PRIVMSGS_RULES_TABLE', $table_prefix.'forums_privmsgs_rules');
 define('FORUMS_REPORTS_TABLE', $table_prefix.'forums_reports');
 define('FORUMS_REASONS_TABLE', $table_prefix.'forums_reports_reasons');
+define('FORUMS_SITELIST_TABLE', $table_prefix.'forums_sitelist');
 define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
 define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
 define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/install/build_tables.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -946,4 +946,17 @@
 
 $_CLASS['core_db']-&gt;table_create('commit');
 
+
+
+$_CLASS['core_db']-&gt;table_create('start', $table_prefix.'forums_sitelist');
+
+$_CLASS['core_db']-&gt;add_table_field_int('site_id', array('max' =&gt; 16000000, 'auto_increment' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_char('site_ip', 40);
+$_CLASS['core_db']-&gt;add_table_field_char('site_hostname', 255);
+$_CLASS['core_db']-&gt;add_table_field_int('ip_exclude', array('max' =&gt; 1));
+
+$_CLASS['core_db']-&gt;add_table_index('site_id', 'primary');
+
+$_CLASS['core_db']-&gt;table_create('commit');
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/installer.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -95,6 +95,8 @@
 	}
 }
 
+unset($holding_array);
+
 $error = array();
 $stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
 
@@ -320,7 +322,7 @@
 		require_once($site_file_root.'includes/tables.php');
 	
 		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 		$_CLASS['core_db']-&gt;free_result($result);
 	
 		if ($result)
@@ -349,67 +351,79 @@
 	
 		$config_data = &quot;&lt;?php\n\n&quot;;
 
-		foreach ($site_db as $name =&gt; $value)
+		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		$_CLASS['core_db']-&gt;free_result($result);
+	
+		if (!$result)
 		{
-			if (is_bool($value))
+			$stage = 2;
+			$error[] = 'Installation failed&lt;br/&gt; Please confirm that your using the currect database layer';
+		}
+		else
+		{
+			foreach ($site_db as $name =&gt; $value)
 			{
-				$value = ($value) ? 'true' : 'false';
+				if (is_bool($value))
+				{
+					$value = ($value) ? 'true' : 'false';
+				}
+				elseif (!is_int($value))
+				{
+					$value = &quot;'$value'&quot;;
+				}
+	
+				$config_data .= &quot;\$site_db['$name'] = $value;\n&quot;;
 			}
-			elseif (!is_int($value))
+	
+			$config_data .= &quot;\n&quot;;
+			$config_data .= &quot;\$table_prefix\t= '$table_prefix';\n&quot;;
+			$config_data .= &quot;\$user_prefix\t= '$user_prefix';\n\n&quot;;
+			$config_data .= &quot;\$acm_type\t\t= 'file';\n\n&quot;;
+			$config_data .= &quot;if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n&quot;;
+			$config_data .= &quot;if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n&quot;;
+			$config_data .= '?&gt;';
+	
+			if (file_put_contents($site_file_root.'config.php', $config_data))
 			{
-				$value = &quot;'$value'&quot;;
+				$config_data = false;
 			}
-
-			$config_data .= &quot;\$site_db['$name'] = $value;\n&quot;;
+			else
+			{
+				$error[] = 'Failed to write to your config.php file&lt;br/&gt;Please upload the content listed in the &quot;Config.php Content&quot; Section';
+			}
+			
+			$path = dirname(getenv('SCRIPT_NAME'));
+	
+			if (substr($path, -1) != '/')
+			{
+				$path .= '/';
+			}
+	
+			$path = str_replace('install/', '', $path);
+			$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
+	
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'site_name'			=&gt; 'New CMS Site',
+				'site_domain'		=&gt; $domain,
+				'site_path'			=&gt; $path,
+				'site_port'			=&gt; ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
+				'cookie_domain'		=&gt; $domain,
+				'cookie_path'		=&gt; $path,
+				'cookie_name'		=&gt; 'cms',
+				'username'			=&gt; '',
+				'password'			=&gt; '',
+				'password_confirm'	=&gt; '',
+				'email'				=&gt; '',
+				'email_confirm'		=&gt; '',
+				'error'				=&gt; empty($error) ? false : implode('&lt;br/&gt;', $error),
+				'config_content'	=&gt; $config_data
+			));
+	
+			$_CLASS['core_template']-&gt;display('installer/stage3.html');
+	
+			script_close();
 		}
-
-		$config_data .= &quot;\n&quot;;
-		$config_data .= &quot;\$table_prefix\t= '$table_prefix';\n&quot;;
-		$config_data .= &quot;\$user_prefix\t= '$user_prefix';\n\n&quot;;
-		$config_data .= &quot;\$acm_type\t\t= 'file';\n\n&quot;;
-		$config_data .= &quot;if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n&quot;;
-		$config_data .= &quot;if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n&quot;;
-		$config_data .= '?&gt;';
-
-		if (file_put_contents($site_file_root.'config.php', $config_data))
-		{
-			$config_data = false;
-		}
-		else
-		{
-			$error[] = 'Failed to write to your config.php file&lt;br/&gt;Please upload the content listed in the &quot;Config.php Content&quot; Section';
-		}
-		
-		$path = dirname(getenv('SCRIPT_NAME'));
-
-		if (substr($path, -1) != '/')
-		{
-			$path .= '/';
-		}
-
-		$path = str_replace('install/', '', $path);
-		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
-
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'site_name'			=&gt; 'New CMS Site',
-			'site_domain'		=&gt; $domain,
-			'site_path'			=&gt; $path,
-			'site_port'			=&gt; ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
-			'cookie_domain'		=&gt; $domain,
-			'cookie_path'		=&gt; $path,
-			'cookie_name'		=&gt; 'cms',
-			'username'			=&gt; '',
-			'password'			=&gt; '',
-			'password_confirm'	=&gt; '',
-			'email'				=&gt; '',
-			'email_confirm'		=&gt; '',
-			'error'				=&gt; empty($error) ? false : implode('&lt;br/&gt;', $error),
-			'config_content'	=&gt; $config_data
-		));
-
-		$_CLASS['core_template']-&gt;display('installer/stage3.html');
-
-		script_close();
 	}
 }
 

Modified: cms/trunk/javascript/forums/forum_view.js
===================================================================
--- cms/trunk/javascript/forums/forum_view.js	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/javascript/forums/forum_view.js	2005-09-15 19:09:49 UTC (rev 125)
@@ -33,7 +33,6 @@
 	input.size = 50;
 	input.className = 'post';
 	input.value = title.innerHTML;
-	//input.title = title.innerHTML;
 	input.id = mode + '_input_' + id;
 	input.onblur =	function()
 	{

Added: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/javascript/quick_messages.js	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,45 @@
+// By Ryan Marshall ( <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A> )
+
+function quick_message_submit()
+{
+	var message = document.getElementById('message');
+	var poster_name = document.getElementById('poster_name');
+
+	if (!poster_name)
+	{
+		poster_name = '';
+	}
+
+	ajax = new core_ajax();
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() &amp;&amp; ajax.responseText())
+		{
+			var area = document.getElementById('qm_block');
+			area.innerHTML = ajax.responseText();
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	ajax.send('index.php?mod=Quick_Message&amp;mode=ajax_add', '&amp;poster_name=' + poster_name.value + '&amp;message=' + message.value);
+}
+
+function quick_message_refresh()
+{
+	ajax = new core_ajax();
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() &amp;&amp; ajax.responseText())
+		{
+			var area = document.getElementById('qm_block');
+			area.innerHTML = ajax.responseText();
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	ajax.send('index.php?mod=Quick_Message&amp;mode=ajax_refresh', null);
+}
\ No newline at end of file

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -26,7 +26,7 @@
 		$confirm = (isset($_POST['confirm'])) ? true : false;
 		$delete_ids = isset($_REQUEST['attachment']) ? array_keys(array_map('intval', $_REQUEST['attachment'])) : array();
 		
-		if ($delete &amp;&amp; sizeof($delete_ids))
+		if (!empty($delete_ids))
 		{
 			$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;delete&quot; value=&quot;1&quot; /&gt;';
 			foreach ($delete_ids as $attachment_id)
@@ -128,9 +128,13 @@
 			} 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 		}
+		else
+		{
+			$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', false);
+		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		$_CLASS['core_template']-&gt;assign(array( 
+		$_CLASS['core_template']-&gt;assign_array(array( 
 			'PAGE_NUMBER'			=&gt; on_page($num_attachments, $config['posts_per_page'], $start),
 			'PAGINATION'			=&gt; generate_pagination(&quot;Control_Panel&amp;i=$id&amp;sk=$sort_key&amp;sd=$sort_dir&quot;, $num_attachments, $config['posts_per_page'], $start),
 			'TOTAL_ATTACHMENTS'		=&gt; $num_attachments,

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -185,7 +185,7 @@
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'S_DISPLAY_FORM', true,
 			'S_UCP_ACTION' =&gt; ''
 		));

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -21,8 +21,6 @@
 		$error = $data = array();
 		$s_hidden_fields = '';
 
-		require_once($site_file_root.'includes/forums/functions_user.php');
-
 		switch($mode)
 		{
 			case 'personal':
@@ -129,7 +127,7 @@
 				$theme = (isset($theme)) ? $theme : $_CLASS['core_user']-&gt;data['user_theme'];
 				$tz = (isset($tz)) ? $tz * 3600 : $_CLASS['core_user']-&gt;data['user_timezone'] / 3600;
 
-				$_CLASS['core_template']-&gt;assign(array( 
+				$_CLASS['core_template']-&gt;assign_array(array( 
 					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
 
 					'VIEW_EMAIL_YES'	=&gt; $view_email_yes, 
@@ -304,7 +302,7 @@
 				$wordcensor_yes = ($wordcensor) ? ' checked=&quot;checked&quot;' : '';
 				$wordcensor_no = (!$wordcensor) ? ' checked=&quot;checked&quot;' : '';
 
-				$_CLASS['core_template']-&gt;assign(array( 
+				$_CLASS['core_template']-&gt;assign_array(array( 
 					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
 					
 					'VIEW_IMAGES_YES'		=&gt; $images_yes, 
@@ -390,7 +388,7 @@
 				$notify_yes = ($notify) ? ' checked=&quot;checked&quot;' : '';
 				$notify_no = (!$notify) ? ' checked=&quot;checked&quot;' : '';
 
-				$_CLASS['core_template']-&gt;assign(array( 
+				$_CLASS['core_template']-&gt;assign_array(array( 
 					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
 
 					'DEFAULT_BBCODE_YES'	=&gt; $bbcode_yes, 
@@ -407,7 +405,7 @@
 				break;
 		}
 
-		$_CLASS['core_template']-&gt;assign(array( 
+		$_CLASS['core_template']-&gt;assign_array(array( 
 			'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['UCP_PREFS_' . strtoupper($mode)],
 			'S_PRIVMSGS'		=&gt; false,
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,16 +1,26 @@
 &lt;?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_profile.php,v 1.38 2004/09/16 18:33:21 acydburn Exp $
-//
-// FILENAME  : ucp_profile.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_profile extends module
 {
 	function ucp_profile($id, $mode)
@@ -28,167 +38,61 @@
 		switch ($mode)
 		{
 			case 'reg_details':
-
 				if ($submit)
 				{
-					$var_ary = array(
-						'username'			=&gt; $_CLASS['core_user']-&gt;data['username'], 
-						'email'				=&gt; $_CLASS['core_user']-&gt;data['user_email'], 
-						'email_confirm'		=&gt; (string) '',
-						'new_password'		=&gt; (string) '', 
-						'cur_password'		=&gt; (string) '', 
-						'password_confirm'	=&gt; (string) '', 
-					);
+					$password		= get_variable('new_password', 'POST', false);
+					$cur_password	= get_variable('cur_password', 'POST', false);
 
-					foreach ($var_ary as $var =&gt; $default)
+					if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']-&gt;data['user_password_encoding']) !== $_CLASS['core_user']-&gt;data['user_password'])
 					{
-						$data[$var] = request_var($var, $default);
+						$error[] = $_CLASS['core_user']-&gt;get_lang('CURRENT_PASSWORD_INVALID');
 					}
 
-					$var_ary = array(
-						'username'			=&gt; array(
-							array('string', false, $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']), 
-							array('username', $data['username'])),
-						'password_confirm'	=&gt; array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						'new_password'		=&gt; array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						//'cur_password'		=&gt; array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						'email'				=&gt; array(
-							array('string', false, 6, 60), 
-							array('email', $data['email'])),
-						'email_confirm'		=&gt; array('string', true, 6, 60), 
-					);
-
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if ($new_password &amp;&amp; $password_confirm != $new_password)
+					if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
 					{
-						$error[] = 'NEW_PASSWORD_ERROR';
+						$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_MISMATCH');
 					}
 
-					if (($new_password || ($_CLASS['auth']-&gt;acl_get('u_chgemail') &amp;&amp; $email != $_CLASS['core_user']-&gt;data['user_email']) || ($username != $_CLASS['core_user']-&gt;data['username'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_chgname') &amp;&amp; $_CORE_CONFIG['user']['allow_namechange'])) &amp;&amp; encode_password($cur_password, $_CLASS['core_user']-&gt;data['user_password_encoding']) != $_CLASS['core_user']-&gt;data['user_password'])
+					if (empty($error) &amp;&amp; $password === $cur_password)
 					{
-						$error[] = 'CUR_PASSWORD_ERROR';
+						$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_SAME');
 					}
 
-					if ($_CLASS['auth']-&gt;acl_get('u_chgemail') &amp;&amp; $email != $_CLASS['core_user']-&gt;data['user_email'] &amp;&amp; $email_confirm != $email)
+					if (empty($error))
 					{
-						$error[] = 'NEW_EMAIL_ERROR';
-					}
-
-					if (!sizeof($error))
-					{
-						$sql_ary = array(
-							//'username'			=&gt; ($_CLASS['auth']-&gt;acl_get('u_chgname') &amp;&amp; $_CORE_CONFIG['user']['allow_namechange']) ? $username : $_CLASS['core_user']-&gt;data['username'], 
-							'user_email'		=&gt; ($_CLASS['auth']-&gt;acl_get('u_chgemail')) ? $email : $_CLASS['core_user']-&gt;data['user_email'], 
-							//'user_password'		=&gt; ($new_password) ? md5($new_password) : $_CLASS['core_user']-&gt;data['user_password'], 
-							//'user_passchg'		=&gt; time(), 
+						$array = array(
+							'user_password' =&gt; encode_password($password, $_CLASS['core_user']-&gt;data['user_password_encoding']),
 						);
-
-						if ($_CORE_CONFIG['email']['email_enable'] &amp;&amp; $email != $_CLASS['core_user']-&gt;data['user_email'] &amp;&amp; ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN))
-						{
-							$template_file = ($config['require_activation'] == USER_ACTIVATION_ADMIN) ? 'user_activate_inactive.html' : 'user_activate.html';
-							$mailer = new core_mailer;
-
-							$messenger-&gt;template($template_file, $_CLASS['core_user']-&gt;data['user_lang']);
-							$mailer-&gt;subject($subject);
-
-							$messenger-&gt;to($email, $username);
-							$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-							$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-							$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-							$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
-
-							$messenger-&gt;assign_vars(array(
-								'SITENAME'		=&gt; $_CORE_CONFIG['global']['sitename'],
-								'USERNAME'		=&gt; $username,
-								'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-								'U_ACTIVATE'    =&gt; generate_link(&quot;Control_Panel&amp;mode=activate&amp;u={$_CLASS['core_user']-&gt;data['user_id']}&amp;k=$user_actkey&quot;, array('full' =&gt; true)))
-							);
-
-							$body = trim($_CLASS['core_template']-&gt;display('modules/Contact/email/index.html', true));
-
-							$messenger-&gt;send(NOTIFY_EMAIL);
-
-							if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-							{
-								// Grab an array of user_id's with a_user permissions
-								$admin_ary = $_CLASS['auth']-&gt;acl_get_list(false, 'a_user', false);
-
-								$sql = 'SELECT user_id, username, user_email, user_lang, user_jabber, user_notify_type
-									FROM ' . USERS_TABLE . ' 
-									WHERE user_id IN (' . implode(', ', $admin_ary[0]['a_user']) .')';
-								$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-								while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-								{
-									$messenger-&gt;template('admin_activate', $row['user_lang']);
-									$messenger-&gt;replyto($config['board_contact']);
-									$messenger-&gt;to($row['user_email'], $row['username']);
-									$messenger-&gt;im($row['user_jabber'], $row['username']);
-
-									$messenger-&gt;assign_vars(array(
-										'USERNAME'		=&gt; $username,
-										'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-										'U_ACTIVATE'    =&gt; generate_link(&quot;Control_Panel&amp;mode=activate&amp;u={$_CLASS['core_user']-&gt;data['user_id']}&amp;k=$user_actkey&quot;, array('full' =&gt; true)))
-									);
-
-									$messenger-&gt;send($row['user_notify_type']);
-								}
-								$_CLASS['core_db']-&gt;sql_freeresult($result);
-							}
-
-							$messenger-&gt;save_queue();
-
-							$sql_ary += array(
-								'user_type'		=&gt; USER_INACTIVE,
-								'user_actkey'	=&gt; $user_actkey
-							);
-						}
-
+						
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
+							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $array) . ' 
 							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;sql_query($sql);
 
-						// Need to update config, forum, topic, posting, messages, etc.
-						if ($username != $_CLASS['core_user']-&gt;data['username'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_chgname') &amp;&amp; $_CORE_CONFIG['user']['allow_namechange'])
-						{
-							user_update_name($_CLASS['core_user']-&gt;data['username'], $username);
-						}
-
-						$_CLASS['core_display']-&gt;meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'&quot;&gt;', '&lt;/a&gt;');
-						
-						trigger_error($message);
+						$_CLASS['core_db']-&gt;sql_query($sql);
 					}
-					// Replace &quot;error&quot; strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
 				}
 
-				$user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
 
-				$_CLASS['core_template']-&gt;assign(array(
-					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '',
+					'USERNAME'			=&gt; $_CLASS['core_user']-&gt;data['username'],
+					'EMAIL'				=&gt; $_CLASS['core_user']-&gt;data['user_email'],
 
-					'USERNAME'			=&gt; (isset($username)) ? $username : $_CLASS['core_user']-&gt;data['username'],
-					'EMAIL'				=&gt; (isset($email)) ? $email : $_CLASS['core_user']-&gt;data['user_email'],
 					'CONFIRM_EMAIL'		=&gt; '',
 					'PASSWORD_CONFIRM'	=&gt; (isset($password_confirm)) ? $password_confirm : '',
 					'NEW_PASSWORD'		=&gt; (isset($new_password)) ? $new_password : '',
 					
 					'CUR_PASSWORD'					=&gt; '', 
 					
-					'L_USERNAME_EXPLAIN'		=&gt; sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[str_replace('\\\\', '\\', $_CORE_CONFIG['user']['allow_name_chars'])] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']), 
+					'L_USERNAME_EXPLAIN'		=&gt; '', 
 					'L_CHANGE_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 				
-					'S_FORCE_PASSWORD'	=&gt; ($_CORE_CONFIG['user']['chg_passforce'] &amp;&amp; $this-&gt;data['user_passchg'] &lt; time() - $_CORE_CONFIG['user']['chg_passforce']) ? true : false, 
-					'S_CHANGE_USERNAME'	=&gt; ($_CORE_CONFIG['user']['allow_namechange'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_chgname')) ? true : false, 
-					'S_CHANGE_EMAIL'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_chgemail')) ? true : false,
+					'S_FORCE_PASSWORD'	=&gt; false,
+					'S_CHANGE_USERNAME'	=&gt; false, 
+					'S_CHANGE_EMAIL'	=&gt; false,
 					'S_CHANGE_PASSWORD'	=&gt; true
 				));
-				break;
+			break;
 
 			case 'profile_info':
 
@@ -321,16 +225,19 @@
 				// Generate smiley listing
 				generate_smilies('inline', 0);
 	
-				$enable_html	= ($config['allow_sig_html']) ? isset($_POST['disable_html']) : false;
-				$enable_bbcode	= ($config['allow_sig_bbcode']) ? (isset($_POST['disable_bbcode']) ? false : $_CLASS['core_user']-&gt;optionget('bbcode')) : false;
-				$enable_smilies = ($config['allow_sig_smilies']) ? (isset($_POST['disable_smilies']) ? false : $_CLASS['core_user']-&gt;optionget('smilies')) : false;
-				$enable_urls	= (isset($_POST['disable_magic_url'])) ? false : true;
-				$signature		= request_var('signature', $_CLASS['core_user']-&gt;data['user_sig']);
-				
+				$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
+				$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
+				$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
+				$enable_urls	= !isset($_POST['disable_magic_url']);
+
+				$signature		= get_variable('signature', 'POST', $_CLASS['core_user']-&gt;data['user_sig']);
+				$signature_preview = '';
+				$sql_array = false;
+
 				if ($submit || $preview)
 				{
 					require_once($site_file_root.'includes/forums/message_parser.php');
-					
+
 					if ($signature)
 					{
 						$message_parser = new parse_message($signature);
@@ -338,82 +245,81 @@
 						// Allowing Quote BBCode
 						$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
 						
-						if (sizeof($message_parser-&gt;warn_msg))
+						if (!empty($message_parser-&gt;warn_msg))
 						{
 							$error[] = implode('&lt;br /&gt;', $message_parser-&gt;warn_msg);
 						}
-						
-						if (!sizeof($error) &amp;&amp; $submit)
+					}
+
+					if (empty($error) &amp;&amp; $submit)
+					{
+						if ($signature &amp;&amp; !empty($message_parser-&gt;message))
 						{
-							$sql_ary = array(
+							$sql_array = array(
 								'user_sig'					=&gt; (string) $message_parser-&gt;message, 
 								'user_sig_bbcode_uid'		=&gt; (string) $message_parser-&gt;bbcode_uid, 
 								'user_sig_bbcode_bitfield'	=&gt; (int) $message_parser-&gt;bbcode_bitfield
 							);
 						}
-					}
-					else
-					{
-						$sql_ary = array(
-							'user_sig'					=&gt; '', 
-							'user_sig_bbcode_uid'		=&gt; '', 
-							'user_sig_bbcode_bitfield'	=&gt; (int) ''
-						);
-					}
-					
-					if (!sizeof($error) &amp;&amp; $submit)
-					{
+						else
+						{
+							$sql_array = array(
+								'user_sig'					=&gt; (string) '', 
+								'user_sig_bbcode_uid'		=&gt; (string) '', 
+								'user_sig_bbcode_bitfield'	=&gt; (int) 0
+							);
+						}
+
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
+							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_array) . ' 
 							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 						$_CLASS['core_db']-&gt;sql_query($sql);
-	
-						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'\&gt;', '&lt;/a&gt;');
+
+						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'&quot;&gt;', '&lt;/a&gt;');
 						trigger_error($message);
 					}
-					
-					// Replace &quot;error&quot; strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
 				}
 
-				$signature_preview = '';
 				if ($preview &amp;&amp; $signature)
 				{
 					// Now parse it for displaying
 					$signature_preview = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
 					unset($message_parser);
 				}
-				
-				decode_message($signature, $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid']);
 
-				$_CLASS['core_template']-&gt;assign(array(
-					'ERROR'				=&gt; (sizeof($error)) ? implode('&lt;br /&gt;', $error) : '', 
+				if ($signature)
+				{
+					decode_message($signature, $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid']);
+				}
+
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
 					'SIGNATURE'			=&gt; $signature,
 					'SIGNATURE_PREVIEW'	=&gt; $signature_preview, 
 					
-					'S_HTML_CHECKED' 		=&gt; (!$enable_html) ? 'checked=&quot;checked&quot;' : '',
-					'S_BBCODE_CHECKED' 		=&gt; (!$enable_bbcode) ? 'checked=&quot;checked&quot;' : '',
-					'S_SMILIES_CHECKED' 	=&gt; (!$enable_smilies) ? 'checked=&quot;checked&quot;' : '',
-					'S_MAGIC_URL_CHECKED' 	=&gt; (!$enable_urls) ? 'checked=&quot;checked&quot;' : '',
+					'S_HTML_CHECKED' 		=&gt; ($enable_html) ? '' : 'checked=&quot;checked&quot;',
+					'S_BBCODE_CHECKED' 		=&gt; ($enable_bbcode) ? '' : 'checked=&quot;checked&quot;',
+					'S_SMILIES_CHECKED' 	=&gt; ($enable_smilies) ? '' : 'checked=&quot;checked&quot;',
+					'S_MAGIC_URL_CHECKED' 	=&gt; ($enable_urls) ? '' : 'checked=&quot;checked&quot;',
 
-					'HTML_STATUS'			=&gt; ($config['allow_sig_html']) ? $_CLASS['core_user']-&gt;lang['HTML_IS_ON'] : $_CLASS['core_user']-&gt;lang['HTML_IS_OFF'],
-					'BBCODE_STATUS'			=&gt; ($config['allow_sig_bbcode']) ? sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_ON'], '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_OFF'], '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
-					'SMILIES_STATUS'		=&gt; ($config['allow_sig_smilies']) ? $_CLASS['core_user']-&gt;lang['SMILIES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['SMILIES_ARE_OFF'],
-					'IMG_STATUS'			=&gt; ($config['allow_sig_img']) ? $_CLASS['core_user']-&gt;lang['IMAGES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['IMAGES_ARE_OFF'],
-					'FLASH_STATUS'			=&gt; ($config['allow_sig_flash']) ? $_CLASS['core_user']-&gt;lang['FLASH_IS_ON'] : $_CLASS['core_user']-&gt;lang['FLASH_IS_OFF'],
+					'HTML_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('HTML_IS_ON') : $_CLASS['core_user']-&gt;get_lang('HTML_IS_OFF'),
+					'BBCODE_STATUS'			=&gt; (true) ? sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_ON'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_OFF'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
+					'SMILIES_STATUS'		=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_OFF'),
+					'IMG_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_OFF'),
+					'FLASH_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('FLASH_IS_ON') : $_CLASS['core_user']-&gt;get_lang('FLASH_IS_OFF'),
 
 					'L_SIGNATURE_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
 
-					'S_HTML_ALLOWED'		=&gt; $config['allow_sig_html'], 
-					'S_BBCODE_ALLOWED'		=&gt; $config['allow_sig_bbcode'], 
-					'S_SMILIES_ALLOWED'		=&gt; $config['allow_sig_smilies'],)
-				);
-				break;
+					'S_HTML_ALLOWED'		=&gt; true, 
+					'S_BBCODE_ALLOWED'		=&gt; true, 
+					'S_SMILIES_ALLOWED'		=&gt; true,
+				));
+			break;
 
 			case 'avatar':
 
 				$display_gallery = isset($_POST['display_gallery']);
-				$folder = isset($_REQUEST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_REQUEST['category']) : false;
+				$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
 
 				$delete = isset($_POST['delete']);
 
@@ -446,8 +352,6 @@
 						$data['height']		= get_variable('height', 'POST', '');
 						$data['user_id']	= $_CLASS['core_user']-&gt;data['user_id'];
 
-						require_once($site_file_root.'includes/forums/functions_user.php');
-
 						if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) &amp;&amp; $can_upload)
 						{
 							list($type, $filename, $width, $height) = avatar_upload($data, $error);
@@ -458,7 +362,8 @@
 						}
 						elseif ($delete)
 						{
-							$type = $filename = $width = $height = '';
+							$filename =  '';
+							$type = $width = $height = 0;
 						}
 						else
 						{
@@ -469,10 +374,10 @@
 					if (empty($error))
 					{
 						$sql_ary = array(
-							'user_avatar'			=&gt; $filename, 
-							'user_avatar_type'		=&gt; $type, 
-							'user_avatar_width'		=&gt; $width, 
-							'user_avatar_height'	=&gt; $height, 
+							'user_avatar'			=&gt; (string) $filename, 
+							'user_avatar_type'		=&gt; (int) $type, 
+							'user_avatar_width'		=&gt; (int) $width, 
+							'user_avatar_height'	=&gt; (int) $height, 
 						);
 
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
@@ -513,7 +418,7 @@
 					$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_width'] . '&quot; height=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
 				}
 
-				$_CLASS['core_template']-&gt;assign(array(
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'ERROR'			=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
 					'AVATAR'		=&gt; $avatar_img, 
 					'AVATAR_SIZE'	=&gt; $config['avatar_filesize'], 
@@ -538,7 +443,7 @@
 						$s_category_options .= '&lt;option value=&quot;' . $cat . '&quot;' . (($cat == $folder) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . (($cat) ? $cat : '--') . '&lt;/option&gt;';
 					}
 
-					$_CLASS['core_template']-&gt;assign(array(
+					$_CLASS['core_template']-&gt;assign_array(array(
 						'S_DISPLAY_GALLERY'	=&gt; true,
 						'S_CAT_OPTIONS'		=&gt; $s_category_options)
 					);
@@ -555,7 +460,7 @@
 				}
 				else
 				{
-					$_CLASS['core_template']-&gt;assign(array(
+					$_CLASS['core_template']-&gt;assign_array(array(
 						'AVATAR'		=&gt; $avatar_img,
 						'AVATAR_SIZE'	=&gt; $config['avatar_filesize'],
 						'WIDTH'			=&gt; $_CLASS['core_user']-&gt;data['user_avatar_width'],

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -17,22 +17,20 @@
 	{
 		global $_CLASS;
 		
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'ERROR'				=&gt; false,
 			'USERNAMES'			=&gt; false,
-			'S_USERNAME_OPTIONS'=&gt; false)
-		);
+			'S_USERNAME_OPTIONS'=&gt; false
+		));
 		
 		$s_hidden_fields = '';
 
 		if (!empty($_POST['submit']) || !empty($_GET['add']))
 		{
-			$data['usernames'] = request_var('usernames', array(0));
-			$data['add'] = request_var('add', '');
+			$data['usernames'] = get_variable('usernames', 'POST', false, 'array');
+			$data['add'] = get_variable('add', 'POST', false);
 
-			$error = validate_data($data, array('add'	=&gt; array('string', false)));
-			
-			if ($data['add'] &amp;&amp; !sizeof($error))
+			if ($data['add'] &amp;&amp; empty($error))
 			{
 				$data['add'] = explode(&quot;\n&quot;, $data['add']);
 
@@ -97,7 +95,7 @@
 							unset($perms);
 						}
 
-						if (sizeof($user_id_ary))
+						if (!empty($user_id_ary))
 						{
 							$sql_mode = ($mode == 'friends') ? 'friend' : 'foe';
 
@@ -119,7 +117,7 @@
 					$_CLASS['core_db']-&gt;free_result($result);
 				}
 			}
-			else if ($data['usernames'] &amp;&amp; !sizeof($error))
+			elseif ($data['usernames'] &amp;&amp; empty($error))
 			{
 				// Force integer values
 				$data['usernames'] = array_map('intval', $data['usernames']);
@@ -130,7 +128,7 @@
 				$_CLASS['core_db']-&gt;query($sql);
 			}
 			
-			if (!sizeof($error))
+			if (empty($error))
 			{
 				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
 				$message = $_CLASS['core_user']-&gt;lang[strtoupper($mode) . '_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
@@ -157,7 +155,7 @@
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		$_CLASS['core_template']-&gt;assign(array( 
+		$_CLASS['core_template']-&gt;assign_array(array( 
 			'L_TITLE'				=&gt; $_CLASS['core_user']-&gt;lang['UCP_ZEBRA_' . strtoupper($mode)],
 
 			'U_SEARCH_USER'			=&gt; generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 

Modified: cms/trunk/modules/Forums/download.php
===================================================================
--- cms/trunk/modules/Forums/download.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Forums/download.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -88,6 +88,7 @@
 else
 {
 	$row['forum_id'] = 0;
+
 	if (!$_CLASS['auth']-&gt;acl_get('u_pm_download') || !$config['auth_download_pm'])
 	{
 		trigger_error('SORRY_AUTH_VIEW_ATTACH');
@@ -103,7 +104,7 @@
 
 if (!download_allowed())
 {
-	trigger_error($_CLASS['core_user']-&gt;lang['LINKAGE_FORBIDDEN']);
+	trigger_error('LINKAGE_FORBIDDEN');
 }
 
 $download_mode = (int) $extensions[$attachment['extension']]['download_mode'];
@@ -293,7 +294,7 @@
 	if (!$allowed)
 	{
 		$sql = 'SELECT site_ip, site_hostname, ip_exclude
-			FROM ' . SITELIST_TABLE;
+			FROM ' . FORUMS_SITELIST_TABLE;
 		$result = $_CLASS['core_db']-&gt;sql_query($sql);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))

Added: cms/trunk/modules/Quick_Message/functions.php
===================================================================
--- cms/trunk/modules/Quick_Message/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Quick_Message/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,101 @@
+&lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $table_prefix;
+
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
+}
+
+function qm_block_content()
+{
+	global $prefix, $_CLASS, $_CORE_CONFIG;
+	
+	$content = '&lt;div style=&quot;width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;&quot;&gt;';
+	
+	$result = $_CLASS['core_db']-&gt;query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
+	
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$words_array = explode(' ', $row['message_text']);
+	
+		$row['message_text'] = '';
+	
+		foreach($words_array as $words)
+		{
+			if (substr($words, 0, 4) != '[url')
+			{
+				$row['message_text'] .= ' '.wordwrap($words, 18, &quot;\n&quot;, 1);
+			}
+			else
+			{
+				$row['message_text'] .= $words;
+			}
+		}
+	
+		$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
+	
+		unset($words_array, $words);
+		
+		$content .= '&lt;div style=&quot;padding: 4px;&quot;&gt;';
+		
+		if ($row['poster_name'])
+		{
+			$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
+	
+			if ($row['poster_id']) 
+			{
+				$content .= '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'&quot;&gt;&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;&lt;/a&gt;';
+			}
+			else
+			{
+				$content .= '&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;'; 
+			}
+		}
+		else
+		{
+			$content .= '&lt;b&gt;' . $_CLASS['core_user']-&gt;lang['ANONYMOUS'] . ': &lt;/b&gt;';
+		}
+	
+		if ($row['poster_id'])
+		{
+			$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message_text']);
+		}
+	
+		$content .= $row['message_text'].'&lt;br /&gt;'. $_CLASS['core_user']-&gt;format_date($row['message_time']) .'&lt;/div&gt;&lt;hr/&gt;';
+	}
+	
+	$_CLASS['core_db']-&gt;free_result($result);
+	
+	$content .= '&lt;/div&gt;';
+
+	return $content;
+}
+
+?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -35,138 +35,193 @@
 
 $_CLASS['core_user']-&gt;user_setup();
 $_CLASS['core_user']-&gt;add_lang();
-
-switch (get_variable('mode', 'GET', false))
+if ($mode = get_variable('mode', 'REQUEST', false))
 {
-	case 'add':
-		if (empty($_POST['submit']) || $_CLASS['core_user']-&gt;is_bot)
-		{
-			redirect(generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)));
-		}
-
-		$message = trim(get_variable('message', 'POST', false));
-
-		if (!$message)
-		{
-			trigger_error('NO_MESSAGE');
-		}
-
-		$length = mb_strlen($message);
-
-		if ($length &gt; $_CORE_CONFIG['quick_message']['length_max'])
-		{ 
-			trigger_error('LONG_MESSAGE');
-		}
-
-	// use limit
-		$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE.&quot; WHERE message_text='&quot;.$_CLASS['core_db']-&gt;escape($message).&quot;' AND message_time &gt;= &quot;.($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['last_post_check']));
-		$count = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-	// add a count check here so it admin ajustable
-		if ($count['count'] &gt; 0)
-		{
-			trigger_error(sprintf($_CLASS['core_user']-&gt;lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
-		}
-
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if ($_CLASS['core_user']-&gt;is_user)
-		{
-			$user_id =  $_CLASS['core_user']-&gt;data['user_id'];
-			$user_name = $_CLASS['core_user']-&gt;data['username'];
-		}
-		else
-		{
-			$user_id = 0;
-			$user_name = get_variable('poster_name', 'POST', false);
-
-			if (!$user_name)
+	switch ($mode)
+	{
+		case 'ajax_refresh':
+			require_once($site_file_root.'modules/Quick_Message/functions.php');
+	
+			echo qm_block_content();
+	
+			script_close();
+		break;
+	
+		case 'add':
+		case 'ajax_add':
+			if ($_CLASS['core_user']-&gt;is_bot)
 			{
-				if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+				redirect(generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)));
+			}
+	
+			$message = trim(get_variable('message', 'POST', false));
+	
+			if (!$message)
+			{
+				if ($mode === 'ajax_add')
 				{
-					trigger_error('NO_NAME');
+					die;
 				}
+	
+				trigger_error('NO_MESSAGE');
 			}
-			else
+	
+			$length = mb_strlen($message);
+	
+			if ($length &gt; $_CORE_CONFIG['quick_message']['length_max'])
+			{ 
+				if ($mode === 'ajax_add')
+				{
+					die;
+				}
+	
+				trigger_error('LONG_MESSAGE');
+			}
+	
+		// use limit
+			$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE.&quot; WHERE message_text='&quot;.$_CLASS['core_db']-&gt;escape($message).&quot;' AND message_time &gt;= &quot;.($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['last_post_check']));
+			$count = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+	
+		// add a count check here so it admin ajustable
+			if ($count['count'] &gt; 0)
 			{
-				$length = mb_strlen($user_name);
-
-				if ($length &lt; 2)
+				if ($mode === 'ajax_add')
 				{
-					trigger_error('SHORT_NAME');
+					die;
 				}
-
-				if ($length &gt; 10)
+	
+				trigger_error(sprintf($_CLASS['core_user']-&gt;lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
+			}
+	
+			$_CLASS['core_db']-&gt;free_result($result);
+	
+			if ($_CLASS['core_user']-&gt;is_user)
+			{
+				$user_id =  $_CLASS['core_user']-&gt;data['user_id'];
+				$user_name = $_CLASS['core_user']-&gt;data['username'];
+			}
+			else
+			{
+				$user_id = 0;
+				$user_name = get_variable('poster_name', 'POST', false);
+	
+				if (!$user_name)
 				{
-					trigger_error('LONG_NAME');
+					if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('NO_NAME');
+					}
 				}
-
-				require($site_file_root.'includes/functions_user.php');
-			
-				if ($error = validate_username($user_name))
+				else
 				{
-					trigger_error($error);
+					$length = mb_strlen($user_name);
+	
+					if ($length &lt; 2)
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('SHORT_NAME');
+					}
+	
+					if ($length &gt; 10)
+					{
+						if ($mode = 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('LONG_NAME');
+					}
+	
+					require($site_file_root.'includes/functions_user.php');
+				
+					if ($error = validate_username($user_name))
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error($error);
+					}
 				}
 			}
-		}
-
-		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-			'poster_name'	=&gt; (string) $user_name,
-			'poster_id'		=&gt; (int) $user_id,
-			'poster_ip'		=&gt; (string) $_CLASS['core_user']-&gt;ip,
-			'message_text'	=&gt; (string) $message,
-			'message_time'	=&gt; (int) $_CLASS['core_user']-&gt;time,
-		));
-
-		$_CLASS['core_db']-&gt;query($sql);
-
-		redirect(generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)));
-	break;
-
-	case 'delete':
-		global $_CORE_CONFIG, $_CLASS;
-
-		$id = get_variable('id', 'GET', false, 'integer');
-
-		if (!$id)
-		{
-			die;
-		}
-
-		$result = $_CLASS['core_db']-&gt;query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-		
-		if (!$row)
-		{
-			trigger_error('NO_MESSAGE');
-		}
-
-		$return = true;
-
-		if ($row['message_id'] == $id)
-		{
-			if ($row['message_time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
+	
+			$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+				'poster_name'	=&gt; (string) $user_name,
+				'poster_id'		=&gt; (int) $user_id,
+				'poster_ip'		=&gt; (string) $_CLASS['core_user']-&gt;ip,
+				'message_text'	=&gt; (string) $message,
+				'message_time'	=&gt; (int) $_CLASS['core_user']-&gt;time,
+			));
+	
+			$_CLASS['core_db']-&gt;query($sql);
+	
+			if ($mode === 'ajax_add')
 			{
-				if (($row['poster_id'] &amp;&amp; $row['poster_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['poster_id'] &amp;&amp; $row['poster_ip'] == $_CLASS['core_user']-&gt;ip))
+				require_once($site_file_root.'modules/Quick_Message/functions.php');
+	
+				echo qm_block_content();
+	
+				script_close();
+			}
+	
+			redirect(generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)));
+		break;
+	
+		case 'delete':
+			global $_CORE_CONFIG, $_CLASS;
+	
+			$id = get_variable('id', 'GET', false, 'integer');
+	
+			if (!$id)
+			{
+				die;
+			}
+	
+			$result = $_CLASS['core_db']-&gt;query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+			
+			if (!$row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+	
+			$return = true;
+	
+			if ($row['message_id'] == $id)
+			{
+				if ($row['message_time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
 				{
-					$return = false;
+					if (($row['poster_id'] &amp;&amp; $row['poster_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['poster_id'] &amp;&amp; $row['poster_ip'] == $_CLASS['core_user']-&gt;ip))
+					{
+						$return = false;
+					}
 				}
 			}
-		}
-
-		if ($return)
-		{
-			trigger_error('MESSAGE_NOT_DELETABLE');
-		}
-
-		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		//trigger_error('MESSAGE_DELETED');
-		redirect(($_CLASS['core_user']-&gt;data['session_url']) ? generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)) : '');
-	break;
+	
+			if ($return)
+			{
+				trigger_error('MESSAGE_NOT_DELETABLE');
+			}
+	
+			$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
+			$_CLASS['core_db']-&gt;query($sql);
+	
+			//trigger_error('MESSAGE_DELETED');
+			redirect(($_CLASS['core_user']-&gt;data['session_url']) ? generate_link($_CLASS['core_user']-&gt;data['session_url'], array('full' =&gt; true)) : '');
+		break;
+		
+		default:
+			script_close();
+		break;
+	}
 }
 
 $start = get_variable('start', 'GET', 0, 'integer');
@@ -202,7 +257,7 @@
 {
 	if ($row['poster_name'])
 	{
-		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');;
+		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
 		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
 	}
 	else

Deleted: cms/trunk/themes/viperal/template/message.html
===================================================================
--- cms/trunk/themes/viperal/template/message.html	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/themes/viperal/template/message.html	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,14 +0,0 @@
-&lt;div class=&quot;OpenTable&quot;&gt;
-	&lt;div class=&quot;outer&quot;&gt;
-		&lt;div class=&quot;inner&quot;&gt;
-			&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-				&lt;tr&gt;
-					&lt;th&gt;{ $MESSAGE_TITLE }&lt;/th&gt;
-				&lt;/tr&gt;
-				&lt;tr&gt; 
-					&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;p class=&quot;gen&quot;&gt;{ $MESSAGE_TEXT }&lt;/p&gt;&lt;br /&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-			&lt;/table&gt;
-		&lt;/div&gt;
-	&lt;/div&gt;
-&lt;/div&gt;
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000045.html">[Viperals-svncheckins] r124 - in cms/trunk/modules: Quick_Message articles
</A></li>
	<LI>Next message: <A HREF="000047.html">[Viperals-svncheckins] r126 - in cms/trunk: blocks javascript
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
