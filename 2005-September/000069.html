<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r149 - in cms/trunk: . admin includes includes/forums includes/forums/admin includes/templates/admin/system install modules/Forums modules/Quick_Message modules/articles
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-September/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r149%20-%20in%20cms/trunk%3A%20.%20admin%20includes%20includes/forums%20includes/forums/admin%20includes/templates/admin/system%20install%20modules/Forums%20modules/Quick_Message%20modules/articles&In-Reply-To=%3C200509292114.j8TLEepG007176%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000068.html">
   <LINK REL="Next"  HREF="000070.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r149 - in cms/trunk: . admin includes includes/forums includes/forums/admin includes/templates/admin/system install modules/Forums modules/Quick_Message modules/articles</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r149%20-%20in%20cms/trunk%3A%20.%20admin%20includes%20includes/forums%20includes/forums/admin%20includes/templates/admin/system%20install%20modules/Forums%20modules/Quick_Message%20modules/articles&In-Reply-To=%3C200509292114.j8TLEepG007176%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r149 - in cms/trunk: . admin includes includes/forums includes/forums/admin includes/templates/admin/system install modules/Forums modules/Quick_Message modules/articles">viperal at berlios.de
       </A><BR>
    <I>Thu Sep 29 23:14:40 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000068.html">[Viperals-svncheckins] r148 - in cms/branches/1.0alpha2: . includes includes/templates/modules
</A></li>
        <LI>Next message: <A HREF="000070.html">[Viperals-svncheckins] r150 - in cms/branches/1.0alpha2: . images images/modules images/modules/forums images/modules/forums/adm images/modules/forums/adm/images includes/db includes/display includes/forums includes/forums/admin includes/templates/modules/Control_Panel install modules/Control_Panel/ucp modules/Forums modules/Quick_Message modules/articles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#69">[ date ]</a>
              <a href="thread.html#69">[ thread ]</a>
              <a href="subject.html#69">[ subject ]</a>
              <a href="author.html#69">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-09-29 23:14:37 +0200 (Thu, 29 Sep 2005)
New Revision: 149

Modified:
   cms/trunk/admin/system.php
   cms/trunk/core.php
   cms/trunk/includes/forums/admin/admin_permissions.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/mailer.php
   cms/trunk/includes/templates/admin/system/index.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/search.php
   cms/trunk/modules/Quick_Message/configurator.php
   cms/trunk/modules/articles/configurator.php
Log:
Added type casting to core config values
Update mailer class
Other changes

Modified: cms/trunk/admin/system.php
===================================================================
--- cms/trunk/admin/system.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/admin/system.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -21,9 +21,6 @@
 $Id$
 */
 
-
-// Need to redo this, do all check before the saving
-
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -46,36 +43,150 @@
 	'SYSTEM_MODE'	=&gt; $mode,
 ));
 
-$save = (isset($_POST['submit'])) ? true : false;
+$save = isset($_POST['submit']);
 
 switch ($mode)
 {
 	case 'site':
-		admin_site($save);
-	break;
+		if ($save)
+		{
+			$data = array(
+				'global'	=&gt; array(
+					'default_theme'		=&gt; get_variable('default_theme', 'POST', ''),
+					'link_optimization' =&gt; get_variable('link_optimization', 'POST', 0, 'int'),
+					'site_name'			=&gt; get_variable('site_name', 'POST', ''),
+					'site_url'			=&gt; get_variable('site_url', 'POST', ''),
+					'foot1'				=&gt; get_variable('foot1', 'POST', ''),
+					'foot2'				=&gt; get_variable('foot2', 'POST', ''),
+				),
+				'email'	=&gt; array(
+					'email_enable'			=&gt; get_variable('email_enable', 'POST') ? 1 : 0,
+					'email_function_name'	=&gt; get_variable('email_function_name', 'POST', ''),
+					'smtp'					=&gt; get_variable('smtp', 'POST', 0, 'int'),
+					'smtp_host'				=&gt; get_variable('smtp_host', 'POST', ''),
+					'smtp_port'				=&gt; get_variable('smtp_port', 'POST', '', 'int'),
+					'smtp_username'			=&gt; get_variable('smtp_username', 'POST', ''),
+					'smtp_password'			=&gt; get_variable('smtp_password', 'POST', ''),
+					'site_email'			=&gt; get_variable('site_email', 'POST', ''),
+				)
+			);
+			
+			setting_save($data);
 
-	case 'users':
-		//admin_users($save);
+			unset($data);
+		}
+	
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'A_OPTION'		=&gt; 'site',
+			'ACTION'		=&gt; generate_link('system', array('admin' =&gt; true)),
+			
+			'LINK_OPTIMIZATION' =&gt; $_CORE_CONFIG['global']['link_optimization'],
+	
+			'SELECT_THEME' 		=&gt; select_theme($_CORE_CONFIG['global']['default_theme']),
+			'SITE_NAME'			=&gt; $_CORE_CONFIG['global']['site_name'],
+	
+			'EMAIL_ENABLE'		=&gt; $_CORE_CONFIG['email']['email_enable'],
+			'EMAIL_FUNCTION_NAME'=&gt; $_CORE_CONFIG['email']['email_function_name'],
+			'SMTP'				=&gt; $_CORE_CONFIG['email']['smtp'],
+			'SMTP_HOST'			=&gt; $_CORE_CONFIG['email']['smtp_host'],
+			'SMTP_PORT'			=&gt; $_CORE_CONFIG['email']['smtp_port'],
+			'SMTP_USERNAME'		=&gt; $_CORE_CONFIG['email']['smtp_username'],
+			'SMTP_PASSWORD'		=&gt; $_CORE_CONFIG['email']['smtp_password'],
+			'SITE_EMAIL'		=&gt; $_CORE_CONFIG['email']['site_email'],
+	
+			'FOOTER_FIRST' 		=&gt; $_CORE_CONFIG['global']['foot1'],
+			'FOOTER_SECOND' 	=&gt; $_CORE_CONFIG['global']['foot2'],
+		));
+	
+		$_CLASS['core_template']-&gt;display('admin/system/index.html');
 	break;
 
 	case 'system':
-		admin_system($save);
+		if ($save)
+		{
+			if (!empty($_POST['maintenance_start']))
+			{
+				$expires = strtotime($_POST['maintenance_start']);
+				$_POST['maintenance_start'] = (!$expires || $expires === -1) ? 0 : $expires;
+			}
+	
+			$data = array(
+				'maintenance' =&gt; array(
+						'active' 	=&gt; get_variable('maintenance', 'POST') ? 1 : 0,
+						'text'		=&gt; get_variable('maintenance_text', 'POST', ''),
+						'start' 	=&gt; get_variable('maintenance_start', 'POST', 0, 'int'),
+				),
+				'server' =&gt; array(
+					'cookie_domain' =&gt; get_variable('cookie_domain', 'POST', ''),
+					'cookie_name' 	=&gt; get_variable('cookie_name', 'POST', ''),
+					'cookie_path' 	=&gt; get_variable('cookie_path', 'POST', ''),
+					'error_options'	=&gt; get_variable('error_options', 'POST', 0, 'int'),
+					'site_domain'	=&gt; get_variable('site_domain', 'POST', ''),
+					'site_port' 	=&gt; get_variable('site_port', 'POST', ''),
+					'site_path' 	=&gt; get_variable('site_path', 'POST', ''),
+					'site_secure'	=&gt; get_variable('site_secure', 'POST', 0, 'int'),
+					'ip_check' 		=&gt; get_variable('ip_check', 'POST', 0, 'int'),
+					'limit_load' 	=&gt; get_variable('limit_load', 'POST', 0, 'int'),
+					'limit_sessions'	=&gt; get_variable('limit_sessions', 'POST', 0, 'int'),
+					'session_length'	=&gt; get_variable('session_length', 'POST', 600, 'int'),
+				)
+			);
+	
+			setting_save($data);
+	
+			unset($data);
+		}
+		
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$path = str_replace('\\','/', dirname(getenv('SCRIPT_NAME')));
+		
+		if (substr($path, -1) !== '/')
+		{
+			$path .= '/';
+		}
+	
+		$domain = empty($_SERVER['SERVER_NAME']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME'];
+	
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'A_OPTION' 			=&gt; 'system',
+			'ACTION'			=&gt; generate_link('system&amp;mode=system', array('admin' =&gt; true)),
+			
+			'COOKIE_DOMAIN' =&gt; $_CORE_CONFIG['server']['cookie_domain'],
+			'COOKIE_NAME' 	=&gt; $_CORE_CONFIG['server']['cookie_name'],
+			'COOKIE_PATH' 	=&gt; $_CORE_CONFIG['server']['cookie_path'],
+			'ERROR'			=&gt; $_CORE_CONFIG['server']['error_options'],
+			'MAINTENANCE' 		=&gt; $_CORE_CONFIG['maintenance']['active'],
+			'MAINTENANCE_MSG' 	=&gt; $_CORE_CONFIG['maintenance']['text'],
+			'MAINTENANCE_START' =&gt; is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']-&gt;format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
+			'IP_CHECK'			=&gt; $_CORE_CONFIG['server']['ip_check'],
+			'SITE_DOMAIN'		=&gt; $_CORE_CONFIG['server']['site_domain'],
+			'SITE_PATH'			=&gt; $_CORE_CONFIG['server']['site_path'],
+			'SITE_PORT'			=&gt; $_CORE_CONFIG['server']['site_port'],
+			'SITE_SECURE'		=&gt; $_CORE_CONFIG['server']['site_secure'],
+			'LIMIT_LOAD'		=&gt; $_CORE_CONFIG['server']['limit_load'],
+			'LIMIT_SESSIONS'	=&gt; $_CORE_CONFIG['server']['limit_sessions'],
+			'SESSION_LENGTH'	=&gt; $_CORE_CONFIG['server']['session_length'],
+			
+		));
+	
+		$_CLASS['core_template']-&gt;display('admin/system/index.html');
 	break;
 }
 
-function admin_save($data)
+function setting_save($data)
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
 	foreach ($data AS $section =&gt; $option)
     {
-		foreach ($option AS $db_name =&gt; $data_op)
+		foreach ($option AS $name =&gt; $value)
 		{
-			$value = get_variable($data_op['post_name'], 'POST', false);
-
-			if ($value != $_CORE_CONFIG[$section][$db_name])
+			if (isset($_CORE_CONFIG[$section][$name]) &amp;&amp; $value != $_CORE_CONFIG[$section][$name])
 			{
-				set_core_config($section, $db_name, $value, false);
+				set_core_config($section, $name, $value, false);
 			}
 		}
     }
@@ -83,102 +194,4 @@
 	$_CLASS['core_cache']-&gt;destroy('core_config');
 }
 
-function admin_site($save)
-{
-	if ($save)
-	{
-		$data = array('global'	=&gt; array(
-			'default_theme'		=&gt; array('post_name' =&gt; 'default_theme'),
-			'link_optimization' =&gt; array('post_name' =&gt; 'link_optimization'),
-			'site_name'			=&gt; array('post_name' =&gt; 'site_name'),
-			'site_url'			=&gt; array('post_name' =&gt; 'site_url'),
-			'start_date'		=&gt; array('post_name' =&gt; 'start_date'),
-			'foot1'				=&gt; array('post_name' =&gt; 'foot1'),
-			'foot2'				=&gt; array('post_name' =&gt; 'foot2'),
-		));
-		admin_save($data);
-	}
-
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']-&gt;assign_array(array(
-		'A_OPTION'		=&gt; 'site',
-		'ACTION'		=&gt; generate_link('system', array('admin' =&gt; true)),
-		
-		'LINK_OPTIMIZATION' =&gt; $_CORE_CONFIG['global']['link_optimization'],
-
-		'SELECT_THEME' 		=&gt; select_theme($_CORE_CONFIG['global']['default_theme']),
-		'SITE_NAME'			=&gt; $_CORE_CONFIG['global']['site_name'],
-		'SITE_URL'			=&gt; $_CORE_CONFIG['global']['site_url'],
-		'START_DATE'		=&gt; $_CORE_CONFIG['global']['start_date'],
-
-		'FOOTER_FIRST' 		=&gt; $_CORE_CONFIG['global']['foot1'],
-		'FOOTER_SECOND' 	=&gt; $_CORE_CONFIG['global']['foot2'],
-		
-	));
-
-	$_CLASS['core_template']-&gt;display('admin/system/index.html');
-}
-
-function admin_system($save)
-{
-	if ($save)
-	{
-		if (!empty($_POST['maintenance_start']))
-		{
-			$expires = strtotime($_POST['maintenance_start']);
-			$_POST['maintenance_start'] = (!$expires || $expires == -1) ? '' : $expires;
-		}
-
-		$data = array(
-			'maintenance' =&gt; array(
-					'active' =&gt; array('post_name' =&gt; 'maintenance'),
-					'text' =&gt; array('post_name' =&gt; 'maintenance_text'),
-					'start' =&gt; array('post_name' =&gt; 'maintenance_start'),
-			),
-			'server' =&gt; array(
-				'cookie_domain' =&gt; array('post_name' =&gt; 'cookie_domain'),
-				'cookie_name' 	=&gt; array('post_name' =&gt; 'cookie_name'),
-				'cookie_path' 	=&gt; array('post_name' =&gt; 'cookie_path'),
-				'error_options'	=&gt; array('post_name' =&gt; 'error_options'),
-				'site_domain'	=&gt; array('post_name' =&gt; 'site_domain'),
-				'site_port' 	=&gt; array('post_name' =&gt; 'site_port'),
-				'site_path' 	=&gt; array('post_name' =&gt; 'site_path'),
-				'site_secure'	=&gt; array('post_name' =&gt; 'site_secure'),
-				'ip_check' 		=&gt; array('post_name' =&gt; 'ip_check'),
-				'limit_load' 	=&gt; array('post_name' =&gt; 'limit_load'),
-				'limit_sessions'	=&gt; array('post_name' =&gt; 'limit_sessions'),
-				'session_length'	=&gt; array('post_name' =&gt; 'session_length'),
-			)
-		);
-		admin_save($data);
-	}
-	
-	global $_CLASS, $_CORE_CONFIG;
-   
-    $_CLASS['core_template']-&gt;assign_array(array(
-		'A_OPTION' 			=&gt; 'system',
-		'ACTION'			=&gt; generate_link('system&amp;mode=system', array('admin' =&gt; true)),
-		
-		'COOKIE_DOMAIN' =&gt; $_CORE_CONFIG['server']['cookie_domain'],
-		'COOKIE_NAME' 	=&gt; $_CORE_CONFIG['server']['cookie_name'],
-		'COOKIE_PATH' 	=&gt; $_CORE_CONFIG['server']['cookie_path'],
-		'ERROR'			=&gt; $_CORE_CONFIG['server']['error_options'],
-		'MAINTENANCE' 		=&gt; $_CORE_CONFIG['maintenance']['active'],
-		'MAINTENANCE_MSG' 	=&gt; $_CORE_CONFIG['maintenance']['text'],
-		'MAINTENANCE_START' =&gt; is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']-&gt;format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
-		'IP_CHECK'			=&gt; $_CORE_CONFIG['server']['ip_check'],
-		'SITE_DOMAIN'		=&gt; $_CORE_CONFIG['server']['site_domain'],
-		'SITE_PATH'			=&gt; $_CORE_CONFIG['server']['site_path'],
-		'SITE_PORT'			=&gt; $_CORE_CONFIG['server']['site_port'],
-		'SITE_SECURE'		=&gt; $_CORE_CONFIG['server']['site_secure'],
-		'LIMIT_LOAD'		=&gt; $_CORE_CONFIG['server']['limit_load'],
-		'LIMIT_SESSIONS'	=&gt; $_CORE_CONFIG['server']['limit_sessions'],
-		'SESSION_LENGTH'	=&gt; $_CORE_CONFIG['server']['session_length'],
-		
-	));
-
-	$_CLASS['core_template']-&gt;display('admin/system/index.html');
-}
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/core.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -138,10 +138,13 @@
 	
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
+		settype($row['config_value'], $row['config_type']);
+
 		if ($row['config_cache'])
 		{
 			$cache[$row['config_section']][$row['config_name']] = $row['config_value'];
 		}
+
 		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
@@ -166,6 +169,8 @@
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
+		settype($row['config_value'], $row['config_type']);
+
 		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
 	}
 	$_CLASS['core_db']-&gt;free_result($result);

Modified: cms/trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -1,1304 +1,1303 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
-//
-// FILENAME  : admin_permissions.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// values need checks
-
-
-// Grab and set some basic parameters
-//
-// 'mode' determines what we're altering; administrators, users, deps, etc.
-// 'submit' is used to determine what we're doing ... special format
-$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
-
-// What mode are we running? So we can output the correct title, explanation
-// and set the sql_option_mode/acl check
-switch ($mode)
-{
-	case 'forum':
-		$l_title = $_CLASS['core_user']-&gt;lang['PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_auth';
-		$sql_option_mode = 'f';
-		break;
-
-	case 'mod':
-		$l_title = $_CLASS['core_user']-&gt;lang['MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'supermod':
-		$l_title = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'admin':
-		$l_title = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS_EXPLAIN'];
-		$which_acl = 'a_authadmins';
-		$sql_option_mode = 'a';
-		break;
-
-	case 'user':
-		$l_title = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authusers';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'group':
-		$l_title = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authgroups';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'deps':
-		$l_title = $_CLASS['core_user']-&gt;lang['DEPENDENCIES'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['DEPENDENCIES_EXPLAIN'];
-		$which_acl = 'a_authdeps';
-		break;
-}
-
-// Permission check
-if (!$_CLASS['auth']-&gt;acl_get($which_acl))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
-$which_mode = (!empty($submode) &amp;&amp; $submode != $mode) ? $submode : $mode;
-$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
-$submit		= (sizeof($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
-
-// Submitted setting data
-//
-// 'auth_settings' contains the submitted option settings assigned to options, should be an 
-//   associative array with integer values
-$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
-
-
-// Forum, User or Group information
-//
-// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
-// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
-// 'forum_id' contains the list of forums, 0 is used for &quot;All forums&quot;, can be array or scalar
-$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
-$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
-
-if (isset($_REQUEST['f']))
-{
-	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
-}
-
-if (!isset($forum_id[$which_mode]))
-{
-	$forum_id[$which_mode][] = 0;
-}
-
-$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
-
-// Generate list of forum id's
-$s_forum_id = '';
-
-foreach ($forum_id as $forum_submode =&gt; $forum_submode_ids)
-{
-	foreach ($forum_submode_ids as $submode_forum_id)
-	{
-		$s_forum_id .= '&lt;input type=&quot;hidden&quot; name=&quot;f[' . $forum_submode . '][]&quot; value=&quot;' . $submode_forum_id . '&quot; /&gt;';
-	}
-}
-unset($forum_submode_ids);
-unset($forum_submode);
-unset($submode_forum_id);
-
-
-// Instantiate a new auth admin object in readiness
-$auth_admin = new auth_admin();
-
-// Are we setting deps? If we are we need to re-run the mode match above for the
-// relevant 'new' mode
-if (!empty($submode))
-{
-	switch ($submode)
-	{
-		case 'forum':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
-			$which_acl = 'a_auth';
-			$sql_option_mode = 'f';
-			break;
-
-		case 'mod':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-
-		case 'supermod':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-	}
-
-	// Permission check
-	if (!$_CLASS['auth']-&gt;acl_get($which_acl))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-	}
-}
-
-
-// Does user want to update anything? Check here to find out 
-// and act appropriately
-switch ($submit)
-{
-	case 'update':
-
-		if (sizeof($auth_settings))
-		{
-			// Admin wants subforums to inherit permissions ... so add these
-			// forums to the list ... since inheritance is only available for
-			// forum and moderator primary modes we deal with '$forum_id[$mode]'
-			if (!empty($_POST['inherit']))
-			{
-				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
-			}
-
-			// Update the permission set ... we loop through each auth setting array
-			foreach ($auth_settings as $auth_submode =&gt; $auth_setting)
-			{
-				// Are any entries * ? If so we need to remove them since they
-				// are options the user wishes to ignore
-
-				if (in_array('*', $auth_setting))
-				{
-					foreach ($auth_setting as $option =&gt; $setting)
-					{
-						if ($setting == '*')
-						{
-							unset($auth_setting[$option]);
-						}
-					}
-				}
-
-				if (!empty($auth_setting))
-				{
-					// Loop through all user/group ids
-					foreach ($ug_data as $id)
-					{
-						$auth_admin-&gt;acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
-					}
-				}
-			}
-
-			// Do we need to recache the moderator lists? We do if the mode
-			// was mod or auth_settings['mod'] is a non-zero size array
-			if ($mode == 'mod' || !empty($auth_settings['mod']))
-			{
-				cache_moderators();
-			}
-
-			// Remove users who are now moderators or admins from everyones foes
-			// list
-			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
-			{
-				update_foes();
-			}
-
-			// Logging ... first grab user or groupnames ...
-			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$l_ug_list = '';
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$auth_submode = array_keys($auth_settings);
-			foreach ($auth_submode as $sub_mode)
-			{
-				if (!in_array(0, $forum_id[$sub_mode]))
-				{
-					// Grab the forum details if non-zero forum_id
-					$sql = 'SELECT forum_name  
-						FROM ' . FORUMS_FORUMS_TABLE . &quot;
-						WHERE forum_id IN ($sql_forum_id)&quot;;
-					$result = $_CLASS['core_db']-&gt;query($sql);
-
-					$l_forum_list = '';
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-					}
-					$_CLASS['core_db']-&gt;free_result($result);
-
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
-				}
-				else
-				{
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
-				}
-			}
-			unset($l_ug_list);
-		}
-		unset($auth_submode);
-		unset($auth_setting);
-
-		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
-		break;
-
-	case 'delete':
-
-		$sql = &quot;SELECT auth_option_id
-			FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
-			WHERE auth_option LIKE '{$sql_option_mode}_%'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$option_id_ary = array();
-			do
-			{
-				$option_id_ary[] = $row['auth_option_id'];
-			}
-			while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-			foreach ($ug_data as $id)
-			{
-				$auth_admin-&gt;acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
-			}
-			unset($option_id_ary);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-
-		// Do we need to recache the moderator lists? We do if the mode
-		// was mod or auth_settings['mod'] is a non-zero size array
-		if ($mode == 'mod' || (isset($auth_settings['mod']) &amp;&amp; sizeof($auth_settings['mod'])))
-		{
-			cache_moderators();
-		}
-
-		// Logging ... first grab user or groupnames ...
-		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$l_ug_list = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-
-		// Grab the forum details if non-zero forum_id
-		if (!in_array(0, $forum_id[$which_mode]))
-		{
-			$sql = 'SELECT forum_name  
-				FROM ' . FORUMS_FORUMS_TABLE . &quot;
-				WHERE forum_id IN ($sql_forum_id)&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$l_forum_list = '';
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
-		}
-		else
-		{
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
-		}
-
-		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
-		break;
-
-	case 'presetsave':
-
-		$holding_ary = array();
-	
-		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
-
-		foreach ($auth_setting as $option =&gt; $setting)
-		{
-			switch ($setting)
-			{
-				case ACL_YES:
-					$holding_ary['yes'][] = $option;
-					break;
-
-				case ACL_NO:
-					$holding_ary['no'][] = $option;
-					break;
-
-				case ACL_UNSET:
-					$holding_ary['unset'][] = $option;
-					break;
-			}
-		}
-
-		$sql = array(
-			'preset_user_id'=&gt; intval($_CLASS['core_user']-&gt;data['user_id']),
-			'preset_type'	=&gt; $sql_option_mode,
-			'preset_data'	=&gt; serialize($holding_ary)
-		);
-
-		if (!empty($_POST['presetname']))
-		{	
-			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
-		}
-		
-		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
-		{
-			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
-			$_CLASS['core_db']-&gt;query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
-		}
-		unset($sql, $option, $setting, $auth_setting);
-
-		break;
-
-	case 'presetdel':
-
-		if (!empty($_POST['presetoption']))
-		{
-			$sql = &quot;SELECT preset_name 
-				FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$sql = &quot;DELETE FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
-			unset($row);
-		}
-		break;
-}
-// End update
-
-
-// Output page header
-adm_page_header($l_title);
-
-
-// First potential form ... this is for selecting forums, users
-// or groups. 
-if (in_array($mode, array('user', 'group', 'forum', 'mod')) &amp;&amp; empty($submit))
-{
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;?php
-
-	// Mode specific markup
-	switch ($mode)
-	{
-		case 'forum':
-		case 'mod':
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;f[&lt;?php echo $mode; ?&gt;][]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
-	
-			echo make_forum_select(false, false, false);
-			
-?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_usergroups&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;forum&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;usergroups&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-		
-			break;
-
-		case 'user':
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_USER']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&nbsp;&lt;textarea cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-		case 'group':
-			// Generate list of groups
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
-
-			$sql = &quot;SELECT group_id, group_name, group_type   
-				FROM &quot; . GROUPS_TABLE . &quot; 
-				ORDER BY group_type DESC&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$group_options = '';
-			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				do
-				{
-					echo '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-				}
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-			
-?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		break;
-
-	}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-// End user, group or forum selection
-
-
-// Second possible form, this lists the currently enabled
-// users/groups for the given mode
-if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') &amp;&amp; empty($submode) &amp;&amp; in_array($mode, array('admin', 'supermod'))))
-{
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
-
-&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_USERS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php
-			
-	$sql = &quot;SELECT u.user_id, u.username
-		FROM &quot; . USERS_TABLE . &quot; u, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
-		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
-			AND a.auth_option_id = o.auth_option_id
-			AND a.forum_id IN ($sql_forum_id)
-			AND u.user_id = a.user_id
-		ORDER BY u.username, u.user_reg_date ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$users = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-		&lt;td align=&quot;center&quot;&gt;&lt;form method=&quot;post&quot; name=&quot;admingroups&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-		&lt;tr&gt;
-			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_GROUPS']; ?&gt;&lt;/th&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php 
-	
-	$sql = &quot;SELECT DISTINCT g.group_id, g.group_name, g.group_type 
-		FROM &quot; . GROUPS_TABLE . &quot; g, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
-		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
-			AND a.forum_id IN ($sql_forum_id)
-			AND a.auth_option_id = o.auth_option_id
-			AND g.group_id = a.group_id
-		ORDER BY g.group_type DESC, g.group_name ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$groups = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-?&gt;&lt;/select&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-	&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-	&lt;/tr&gt;
-	&lt;tr&gt;
-
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;textarea style=&quot;height:60px&quot; cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_GROUPS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; style=&quot;height: 100%&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot;  size=&quot;5&quot;&gt;&lt;?php 
-			
-	$sql = &quot;SELECT group_id, group_name, group_type 
-		FROM &quot; . GROUPS_TABLE . &quot;
-		ORDER BY group_type DESC, group_name&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$group_list = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;?php
-
-}
-// End user and group acl selections
-
-
-
-
-
-
-// Third possible form, this is the major section of this script. It
-// handles the entry of permission options for all situations
-if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
-{
-
-	// Did the user specify any users or groups?
-	if (empty($ug_data))
-	{
-		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
-		trigger_error($_CLASS['core_user']-&gt;lang[$l_message]);
-	}
-
-
-	$forum_list = '';
-	// Grab the forum details if non-zero forum_id
-	if (!in_array(0, $forum_id[$which_mode]))
-	{
-		$sql = 'SELECT forum_id, forum_name, parent_id  
-			FROM ' . FORUMS_FORUMS_TABLE . &quot;
-			WHERE forum_id IN ($sql_forum_id)&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
-		}
-
-		// If we have more than one forum we want a list of all their names
-		// so loop through all results. We don't need all the data though 
-		// since cascading/inheritance is only applicable if a single forum
-		// was selected
-		$forum_data = $row;
-
-		do
-		{
-			$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-
-	// Grab relevant user or group information
-	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
-// need some work ( array_mapping()) blaa blaa
-	switch ($ug_type)
-	{
-		case 'user':
-			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_USER'];
-			$sql = 'SELECT user_id AS id, username AS name 
-				FROM ' . USERS_TABLE . ' 
-				WHERE ';
-			$sql .= ($submit == 'add_options') ? &quot; username IN ('&quot; . implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array(array_unique(explode(&quot;\n&quot;, modify_lines($ug_data[0], &quot;\n&quot;))))) . &quot;')&quot; : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
-		break;
-
-		case 'group':
-			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_GROUP'];
-			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
-				FROM ' . GROUPS_TABLE . '
-				WHERE group_id';
-			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
-		break;
-	}
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		trigger_error($l_no_error);
-	}
-	unset($l_no_error);
-
-	// Store the user_ids and names for later use
-	do 
-	{
-		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;b class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] : '&lt;b&gt;' . $row['name']) . '&lt;/b&gt;';
-		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
-		$ug_hidden .= '&lt;input type=&quot;hidden&quot; name=&quot;ug_data[]&quot; value=&quot;' . $row['id'] . '&quot; /&gt;';
-	}
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	$_CLASS['core_db']-&gt;free_result($result);
-
-
-	// Grab the list of options ... if we're in deps mode we want all options, 
-	// else we skip the master options
-	$sql_limit_option = ($mode == 'deps') ? '' : &quot;AND auth_option &lt;&gt; '&quot; . $sql_option_mode . &quot;_'&quot;;
-	$sql = &quot;SELECT auth_option_id, auth_option
-		FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
-		WHERE auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-			$sql_limit_option&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$auth_options = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$auth_presets_compare[] = $row['auth_option'];
-		$auth_options[] = $row;
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	unset($sql_limit_option);
-
-
-	// Now we'll build a list of preset options ...
-	$preset_options = $preset_js = $preset_update_options = '';
-
-	// Do we have a parent forum? If so offer option to inherit from that
-	if ($forum_data['parent_id'] != 0)
-	{
-		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-		 
-		$sql = &quot;SELECT o.auth_option, a.auth_setting
-					FROM &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
-					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-						AND a.auth_option_id = o.auth_option_id AND a.forum_id = &quot; . $forum_data['parent_id'] . '
-						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)&quot;;
-
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			do
-			{
-				switch ($row['auth_setting'])
-				{
-					case ACL_YES:
-						$holding['yes'][] = $row['auth_option'];
-					break;
-
-					case ACL_NO:
-						$holding['no'][] = $row['auth_option'];
-					break;
-				}
-			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_options .= '&lt;option value=&quot;preset_0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['INHERIT_PARENT'] . '&lt;/option&gt;';
-			$preset_js .= &quot;\tpresets['preset_0'] = new Array();&quot; . &quot;\n&quot;;
-			$preset_js .= &quot;\tpresets['preset_0'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
-
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-	// Look for custom presets
-	$sql = &quot;SELECT preset_id, preset_name, preset_data  
-		FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-		WHERE preset_type = '&quot; . (($mode == 'deps') ? 'f' : $sql_option_mode) . &quot;' 
-		ORDER BY preset_id ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		do
-		{
-			$preset_update_options .= '&lt;option value=&quot;' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
-			$preset_options .= '&lt;option value=&quot;preset_' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
-
-			$holding = unserialize($row['preset_data']);
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new Array();&quot; . &quot;\n&quot;;
-			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	unset($holding, $auth_presets_compare);
-
-
-	// If we aren't looking @ deps then we try and grab existing sessions for
-	// the given forum and user/group
-	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
-	{
-		if ($which_mode == $mode)
-		{
-			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
-					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
-					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-						AND a.auth_option_id = o.auth_option_id 
-						AND a.forum_id IN ($sql_forum_id) 
-						AND a.&quot;.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)
-					GROUP BY o.auth_option&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$auth_settings[$which_mode] = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-		else
-		{
-			// We're looking at a view ... so we'll set all options to unset
-			// We could be a little more clever here but the &quot;safe side&quot; looks
-			// better right now
-			$auth_settings[$which_mode] = array();
-			foreach ($auth_options as $option)
-			{
-				$auth_settings[$which_mode][$option['auth_option']] = '*';
-			}
-			unset($option);
-		}
-	}
-
-	$view_options = '';
-	// Should we display a dropdown for views?
-	if (in_array($mode, array('admin', 'supermod', 'mod')))
-	{
-		$view_options .= '&lt;option value=&quot;&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SELECT_VIEW'] . '&lt;/option&gt;';
-		$view_ary = array(
-			'admin'		=&gt; array('admin' =&gt; 'a_', 'forum' =&gt; 'a_auth', 'supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods'),
-			'supermod'	=&gt; array('supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth'), 
-			'mod'		=&gt; array('mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth')
-		);
-
-		foreach ($view_ary[$mode] as $which_submode =&gt; $which_acl)
-		{
-			if ($_CLASS['auth']-&gt;acl_get($which_acl))
-			{
-				$view_options .= '&lt;option value=&quot;' . $which_submode . '&quot;' . (($which_submode == $which_mode) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ACL_VIEW_' . strtoupper($which_submode)] . '&lt;/option&gt;';
-			}
-
-		}
-		unset($view_ary);
-	}
-
-	$settings_hidden = '';
-	// Output original settings ... needed when we jump views
-	foreach ($auth_settings as $auth_submode =&gt; $auth_submode_settings)
-	{
-		if ($auth_submode != $which_mode)
-		{
-			foreach ($auth_submode_settings as $submode_option =&gt; $submode_setting)
-			{
-				$settings_hidden .= ($submode_setting != '*') ? '&lt;input type=&quot;hidden&quot; name=&quot;settings[' . $auth_submode . '][' . $submode_option . ']&quot; value=&quot;' . $submode_setting . '&quot; /&gt;' : '';
-			}
-		}
-	}
-	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
-
-?&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-
-	var presets = new Array();
-&lt;?php
-
-	echo $preset_js;
-
-?&gt;
-
-	function preset_obj(yes, no, unset)
-	{
-		this.yes = yes;
-		this.no = no;
-		this.unset = unset;
-	}
-
-	function use_preset(option)
-	{
-		if (option)
-		{
-			document.acl.set.selectedIndex = 0;
-			for (i = 0; i &lt; document.acl.length; i++)
-			{
-				var elem = document.acl.elements[i];
-				if (elem.name.indexOf('settings') == 0)
-				{
-					switch (option)
-					{
-						case 'all_yes':
-							if (elem.value == &lt;?php echo ACL_YES; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_no':
-							if (elem.value == &lt;?php echo ACL_NO; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_unset':
-							if (elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_ignore':
-							if (elem.value == '*')
-								elem.checked = true;
-							break;
-
-						default:
-							option_start = elem.name.search(/\[(\w+?)\]$/);
-							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
-
-							if (presets[option].yes.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_YES; ?&gt;)
-								elem.checked = true;
-							else if (presets[option].no.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_NO; ?&gt;)
-								elem.checked = true;
-							else if (presets[option].unset.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
-								elem.checked = true;
-							break;
-					}
-				}
-			}
-		}
-	}
-
-	function marklist(match, status)
-	{
-		for (i = 0; i &lt; document.acl.length; i++)
-		{
-			if (document.acl.elements[i].name.indexOf(match) == 0)
-				document.acl.elements[i].checked = status;
-		}
-	}
-
-	function open_win(url, width, height)
-	{
-		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
-		if (window.focus)
-			aclwin.focus();
-	}
-//--&gt;
-&lt;/script&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;?php
-
-	// Do we have a list of forums? If so, output them ... but only
-	// if we're looking at the primary view or mode ... submodes
-	// output their own list of forums as and where applicable so this
-	// is unnecessary
-	if ($forum_list != '' &amp;&amp; $which_mode == $mode)
-	{
-		$l_selected_forums = (sizeof($forum_id[$which_mode]) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
-
-		echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_forums] . ': ' . $forum_list . '&lt;/p&gt;';
-
-		unset($forum_list);
-		unset($l_selected_forums);
-	}
-
-	// Now output the list of users or groups ... these will always exist
-	$l_selected_users = ($ug_type == 'user') ? ((sizeof($ug_data) == 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((sizeof($ug_data) == 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
-
-	echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_users] . ': ' . $l_ug_list . '&lt;/p&gt;';
-
-	unset($l_selected_users);
-	unset($ug_data);
-
-?&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	if ($settings_hidden != '')
-	{
-
-?&gt;
-
-&lt;h2 style=&quot;color:red&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING']; ?&gt;&lt;/h2&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	}
-
-?&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;acl&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;?php
-
-	// This is the main listing of options
-
-	// We output this for both deps and when update is requested where
-	// deps exist
-	if (($mode == 'admin' || $mode == 'supermod') &amp;&amp; in_array($submode, array('forum', 'mod')))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WILL_SET_OPTIONS']; ?&gt;:&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select style=&quot;width:100%&quot; name=&quot;f[&lt;?php echo $which_mode; ?&gt;][]&quot; multiple=&quot;7&quot;&gt;&lt;?php 
-		
-		echo make_forum_select($forum_id[$which_mode], false, true); 
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;br /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-	// End deps output
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;left&quot;&gt;&lt;?php
-	
-	if ($view_options != '')
-	{
-	
-?&gt;&lt;select name=&quot;submode&quot; onchange=&quot;if (this.options[this.selectedIndex].value != '') this.form.submit();&quot;&gt;&lt;?php echo $view_options; ?&gt;&lt;/select&gt;&lt;?php
-	
-	}
-	
-?&gt;&lt;/td&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;: &lt;select name=&quot;set&quot; onchange=&quot;use_preset(this.options[this.selectedIndex].value);&quot;&gt;&lt;option class=&quot;sep&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_yes&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_YES']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_no&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_NO']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_unset&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_UNSET']; ?&gt;&lt;/option&gt;&lt;?php 
-
-	$colspan = 4;
-	if ($which_mode != $mode)
-	{
-		$colspan = 5;
-		echo '&lt;option value=&quot;all_ignore&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_IGNORE'] . '&lt;/option&gt;';
-	}
-
-	// Output user preset options ... if any
-	echo ($preset_options) ? '&lt;option class=&quot;sep&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_PRESETS'] . ' -&gt;' . '&lt;/option&gt;' . $preset_options : ''; 
-
-?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTION']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNSET']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&nbsp;&lt;/th&gt;
-&lt;?php
-
-	if ($which_mode != $mode)
-	{
-
-?&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['IGNORE']; ?&gt;&nbsp;&lt;/th&gt;
-&lt;?php
-
-	}
-
-?&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-	$row_class = 'row2';
-	for ($i = 0; $i &lt; sizeof($auth_options); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-		// Try and output correct language strings, else output prettyfied auth_option
-		$l_auth_option = (!empty($_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
-		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
-
-		
-		// Which option should we select?
-		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked=&quot;checked&quot;' : '';
-		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked=&quot;checked&quot;' : '';
-		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked=&quot;checked&quot;' : '';
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $l_auth_option; ?&gt;&nbsp;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_YES; ?&gt;&quot;&lt;?php echo $selected_yes; ?&gt; /&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_UNSET; ?&gt;&quot;&lt;?php echo $selected_unset; ?&gt; /&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_NO; ?&gt;&quot;&lt;?php echo $selected_no; ?&gt; /&gt;&lt;/td&gt;
-&lt;?php
-
-		if ($which_mode != $mode)
-		{
-			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked=&quot;checked&quot;' : '';
-
-?&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;*&quot;&lt;?php echo $selected_ignore; ?&gt; /&gt;&lt;/td&gt;
-&lt;?php
-
-		}
-
-?&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-	}
-
-
-	// If we're setting forum or moderator options and a single forum has
-	// been selected then look to see if any subforums exist. If they do
-	// give user the option of cascading permissions to them
-	if (($mode == 'forum' || $mode == 'mod') &amp;&amp; empty($submode) &amp;&amp; sizeof($forum_id[$which_mode]) == 1)
-	{
-		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
-
-		if (!empty($children))
-		{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot; colspan=&quot;4&quot; height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS_EXPLAIN']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			foreach ($children as $row)
-			{
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;inherit[]&quot; value=&quot;&lt;?php echo $row['forum_id']; ?&gt;&quot; /&gt; &lt;?php echo $row['forum_name']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;gensmall&quot; href=&quot;javascript:marklist('inherit', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('inherit', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-		}
-	}
-
-	// Display event/cron radio buttons
-	if ($_CLASS['auth']-&gt;acl_gets('a_events', 'a_cron') &amp;&amp; $mode != 'deps' &amp;&amp; $submit != 'update')
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-			&lt;!-- tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_HOW']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;now&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_AS_NOW']; ?&gt;&lt;?php 
-	
-			if ($_CLASS['auth']-&gt;acl_get('a_events'))
-			{ 
-
-?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;evt&quot; /&gt; &lt;?php 
-	
-				echo $_CLASS['core_user']-&gt;lang['RUN_AS_EVT'];  
-			}
-			
-			if ($_CLASS['auth']-&gt;acl_get('a_cron'))
-			{
-
-?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;crn&quot; /&gt; &lt;?php 
-	
-				echo $_CLASS['core_user']-&gt;lang['RUN_AS_CRN']; 
-				
-			}
-
-?&gt;&lt;/td&gt;
-			&lt;/tr --&gt;
-&lt;?php
-
-	}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit_update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPDATE']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CANCEL']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;&lt;?php echo $ug_type; ?&gt;&quot; /&gt;&lt;?php echo $ug_hidden; ?&gt;&lt;?php 
-
-	// Output forum id data
-	echo $s_forum_id;
-
-	// Output settings generated from other views
-	echo $settings_hidden;
-	unset($settings_hidden);
-	
-?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;
-
-		&lt;br clear=&quot;all&quot; /&gt;
-
-		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;4&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;4&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;2&quot; height=&quot;16&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_PRESET']; ?&gt;: &lt;/td&gt;
-						&lt;td&gt;&lt;select name=&quot;presetoption&quot;&gt;&lt;option class=&quot;sep&quot; value=&quot;-1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;?php 
-
-	echo $preset_update_options;
-			
-		?&gt;&lt;/select&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESET_NAME']; ?&gt;: &lt;/td&gt;
-						&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;presetname&quot; maxlength=&quot;25&quot; /&gt; &lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetsave&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SAVE']; ?&gt;&quot; /&gt; &nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetdel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-
-// Output page footer
-adm_page_footer();
-
-// ---------
-// FUNCTIONS
-//
-function update_foes()
-{
-	global $_CLASS;
-
-	$perms = array();
-	foreach ($_CLASS['auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
-	{
-		foreach ($forum_ary as $auth_option =&gt; $user_ary)
-		{
-			$perms += $user_ary;
-		}
-	}
-
-	if (sizeof($perms))
-	{
-		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	unset($perms);
-}
-//
-// FUNCTIONS
-// ---------
-
+&lt;?php
+// -------------------------------------------------------------
+//
+// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
+//
+// FILENAME  : admin_permissions.php
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : &#169; 2001, 2003 phpBB Group
+// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// values need checks
+
+
+// Grab and set some basic parameters
+//
+// 'mode' determines what we're altering; administrators, users, deps, etc.
+// 'submit' is used to determine what we're doing ... special format
+$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
+
+// What mode are we running? So we can output the correct title, explanation
+// and set the sql_option_mode/acl check
+switch ($mode)
+{
+	case 'forum':
+		$l_title = $_CLASS['core_user']-&gt;lang['PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_auth';
+		$sql_option_mode = 'f';
+		break;
+
+	case 'mod':
+		$l_title = $_CLASS['core_user']-&gt;lang['MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'supermod':
+		$l_title = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'admin':
+		$l_title = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS_EXPLAIN'];
+		$which_acl = 'a_authadmins';
+		$sql_option_mode = 'a';
+		break;
+
+	case 'user':
+		$l_title = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authusers';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'group':
+		$l_title = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authgroups';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'deps':
+		$l_title = $_CLASS['core_user']-&gt;lang['DEPENDENCIES'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['DEPENDENCIES_EXPLAIN'];
+		$which_acl = 'a_authdeps';
+		break;
+}
+
+// Permission check
+if (!$_CLASS['auth']-&gt;acl_get($which_acl))
+{
+	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+}
+
+$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
+$which_mode = (!empty($submode) &amp;&amp; $submode != $mode) ? $submode : $mode;
+$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
+$submit		= (count($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
+
+// Submitted setting data
+//
+// 'auth_settings' contains the submitted option settings assigned to options, should be an 
+//   associative array with integer values
+$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
+
+
+// Forum, User or Group information
+//
+// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
+// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
+// 'forum_id' contains the list of forums, 0 is used for &quot;All forums&quot;, can be array or scalar
+$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
+$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
+
+if (isset($_REQUEST['f']))
+{
+	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
+}
+
+if (!isset($forum_id[$which_mode]))
+{
+	$forum_id[$which_mode][] = 0;
+}
+
+$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
+
+// Generate list of forum id's
+$s_forum_id = '';
+
+foreach ($forum_id as $forum_submode =&gt; $forum_submode_ids)
+{
+	foreach ($forum_submode_ids as $submode_forum_id)
+	{
+		$s_forum_id .= '&lt;input type=&quot;hidden&quot; name=&quot;f[' . $forum_submode . '][]&quot; value=&quot;' . $submode_forum_id . '&quot; /&gt;';
+	}
+}
+unset($forum_submode_ids);
+unset($forum_submode);
+unset($submode_forum_id);
+
+
+// Instantiate a new auth admin object in readiness
+$auth_admin = new auth_admin();
+
+// Are we setting deps? If we are we need to re-run the mode match above for the
+// relevant 'new' mode
+if (!empty($submode))
+{
+	switch ($submode)
+	{
+		case 'forum':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
+			$which_acl = 'a_auth';
+			$sql_option_mode = 'f';
+			break;
+
+		case 'mod':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+
+		case 'supermod':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+	}
+
+	// Permission check
+	if (!$_CLASS['auth']-&gt;acl_get($which_acl))
+	{
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+	}
+}
+
+
+// Does user want to update anything? Check here to find out 
+// and act appropriately
+switch ($submit)
+{
+	case 'update':
+		if (!empty($auth_settings))
+		{
+			// Admin wants subforums to inherit permissions ... so add these
+			// forums to the list ... since inheritance is only available for
+			// forum and moderator primary modes we deal with '$forum_id[$mode]'
+			if (!empty($_POST['inherit']))
+			{
+				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
+			}
+
+			// Update the permission set ... we loop through each auth setting array
+			foreach ($auth_settings as $auth_submode =&gt; $auth_setting)
+			{
+				// Are any entries * ? If so we need to remove them since they
+				// are options the user wishes to ignore
+
+				if (in_array('*', $auth_setting))
+				{
+					foreach ($auth_setting as $option =&gt; $setting)
+					{
+						if ($setting == '*')
+						{
+							unset($auth_setting[$option]);
+						}
+					}
+				}
+
+				if (!empty($auth_setting))
+				{
+					// Loop through all user/group ids
+					foreach ($ug_data as $id)
+					{
+						$auth_admin-&gt;acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
+					}
+				}
+			}
+
+			// Do we need to recache the moderator lists? We do if the mode
+			// was mod or auth_settings['mod'] is a non-zero size array
+			if ($mode == 'mod' || !empty($auth_settings['mod']))
+			{
+				cache_moderators();
+			}
+
+			// Remove users who are now moderators or admins from everyones foes
+			// list
+			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
+			{
+				update_foes();
+			}
+
+			// Logging ... first grab user or groupnames ...
+			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$l_ug_list = '';
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$auth_submode = array_keys($auth_settings);
+			foreach ($auth_submode as $sub_mode)
+			{
+				if (!in_array(0, $forum_id[$sub_mode]))
+				{
+					// Grab the forum details if non-zero forum_id
+					$sql = 'SELECT forum_name  
+						FROM ' . FORUMS_FORUMS_TABLE . &quot;
+						WHERE forum_id IN ($sql_forum_id)&quot;;
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$l_forum_list = '';
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
+				}
+				else
+				{
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
+				}
+			}
+			unset($l_ug_list);
+		}
+		unset($auth_submode);
+		unset($auth_setting);
+
+		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
+	break;
+
+	case 'delete':
+		$sql = &quot;SELECT auth_option_id
+			FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
+			WHERE auth_option LIKE '{$sql_option_mode}_%'&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$option_id_ary = array();
+			do
+			{
+				$option_id_ary[] = $row['auth_option_id'];
+			}
+			while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+			foreach ($ug_data as $id)
+			{
+				$auth_admin-&gt;acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
+			}
+			unset($option_id_ary);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+
+		// Do we need to recache the moderator lists? We do if the mode
+		// was mod or auth_settings['mod'] is a non-zero size array
+		if ($mode == 'mod' || (isset($auth_settings['mod']) &amp;&amp; !empty($auth_settings['mod'])))
+		{
+			cache_moderators();
+		}
+
+		// Logging ... first grab user or groupnames ...
+		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$l_ug_list = '';
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+
+		// Grab the forum details if non-zero forum_id
+		if (!in_array(0, $forum_id[$which_mode]))
+		{
+			$sql = 'SELECT forum_name  
+				FROM ' . FORUMS_FORUMS_TABLE . &quot;
+				WHERE forum_id IN ($sql_forum_id)&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$l_forum_list = '';
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
+		}
+		else
+		{
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
+		}
+
+		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
+	break;
+
+	case 'presetsave':
+		$holding_ary = array();
+	
+		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
+
+		foreach ($auth_setting as $option =&gt; $setting)
+		{
+			switch ($setting)
+			{
+				case ACL_YES:
+					$holding_ary['yes'][] = $option;
+				break;
+
+				case ACL_NO:
+					$holding_ary['no'][] = $option;
+				break;
+
+				case ACL_UNSET:
+					$holding_ary['unset'][] = $option;
+				break;
+			}
+		}
+
+		$sql = array(
+			'preset_user_id'=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+			'preset_type'	=&gt; $sql_option_mode,
+			'preset_data'	=&gt; serialize($holding_ary)
+		);
+
+		if (!empty($_POST['presetname']))
+		{	
+			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
+		}
+		
+		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
+		{
+			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . (int) $_POST['presetoption'];
+			$_CLASS['core_db']-&gt;query($sql);
+
+			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
+		}
+		unset($sql, $option, $setting, $auth_setting);
+	break;
+
+	case 'presetdel':
+		if (!empty($_POST['presetoption']))
+		{
+			$sql = &quot;SELECT preset_name 
+				FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($row)
+			{
+				$sql = &quot;DELETE FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+					WHERE preset_id = &quot; . (int) $_POST['presetoption'];
+				$_CLASS['core_db']-&gt;query($sql);
+	
+				add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
+			}
+			unset($row);
+		}
+	break;
+}
+// End update
+
+
+// Output page header
+adm_page_header($l_title);
+
+
+// First potential form ... this is for selecting forums, users
+// or groups. 
+if (in_array($mode, array('user', 'group', 'forum', 'mod')) &amp;&amp; empty($submit))
+{
+
+?&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain ?&gt;&lt;/p&gt;
+
+&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+&lt;?php
+
+	// Mode specific markup
+	switch ($mode)
+	{
+		case 'forum':
+		case 'mod':
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;f[&lt;?php echo $mode; ?&gt;][]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
+	
+			echo make_forum_select(false, false, false);
+			
+?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_usergroups&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;forum&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;usergroups&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+		
+			break;
+
+		case 'user':
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_USER']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&nbsp;&lt;textarea cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+			break;
+
+		case 'group':
+			// Generate list of groups
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
+
+			$sql = &quot;SELECT group_id, group_name, group_type   
+				FROM &quot; . GROUPS_TABLE . &quot; 
+				ORDER BY group_type DESC&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$group_options = '';
+			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				do
+				{
+					echo '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+				}
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+			
+?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+		break;
+
+	}
+
+?&gt;
+&lt;/table&gt;&lt;/form&gt;
+
+&lt;?php
+
+}
+// End user, group or forum selection
+
+
+// Second possible form, this lists the currently enabled
+// users/groups for the given mode
+if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') &amp;&amp; empty($submode) &amp;&amp; in_array($mode, array('admin', 'supermod'))))
+{
+
+?&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
+
+&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+	&lt;tr&gt;
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_USERS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php
+			
+	$sql = &quot;SELECT u.user_id, u.username
+		FROM &quot; . USERS_TABLE . &quot; u, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
+		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
+			AND a.auth_option_id = o.auth_option_id
+			AND a.forum_id IN ($sql_forum_id)
+			AND u.user_id = a.user_id
+		ORDER BY u.username, u.user_reg_date ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$users = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+		&lt;td align=&quot;center&quot;&gt;&lt;form method=&quot;post&quot; name=&quot;admingroups&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+		&lt;tr&gt;
+			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_GROUPS']; ?&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php 
+	
+	$sql = &quot;SELECT DISTINCT g.group_id, g.group_name, g.group_type 
+		FROM &quot; . GROUPS_TABLE . &quot; g, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
+		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
+			AND a.forum_id IN ($sql_forum_id)
+			AND a.auth_option_id = o.auth_option_id
+			AND g.group_id = a.group_id
+		ORDER BY g.group_type DESC, g.group_name ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$groups = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+?&gt;&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+	&lt;/tr&gt;
+	&lt;tr&gt;
+
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;textarea style=&quot;height:60px&quot; cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_GROUPS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; style=&quot;height: 100%&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot;  size=&quot;5&quot;&gt;&lt;?php 
+			
+	$sql = &quot;SELECT group_id, group_name, group_type 
+		FROM &quot; . GROUPS_TABLE . &quot;
+		ORDER BY group_type DESC, group_name&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$group_list = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;?php
+
+}
+// End user and group acl selections
+
+
+
+
+
+
+// Third possible form, this is the major section of this script. It
+// handles the entry of permission options for all situations
+if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
+{
+
+	// Did the user specify any users or groups?
+	if (empty($ug_data))
+	{
+		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
+		trigger_error($_CLASS['core_user']-&gt;lang[$l_message]);
+	}
+
+
+	$forum_list = '';
+	// Grab the forum details if non-zero forum_id
+	if (!in_array(0, $forum_id[$which_mode]))
+	{
+		$sql = 'SELECT forum_id, forum_name, parent_id  
+			FROM ' . FORUMS_FORUMS_TABLE . &quot;
+			WHERE forum_id IN ($sql_forum_id)&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
+		}
+
+		// If we have more than one forum we want a list of all their names
+		// so loop through all results. We don't need all the data though 
+		// since cascading/inheritance is only applicable if a single forum
+		// was selected
+		$forum_data = $row;
+
+		do
+		{
+			$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+
+	// Grab relevant user or group information
+	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
+// need some work ( array_mapping()) blaa blaa
+	switch ($ug_type)
+	{
+		case 'user':
+			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_USER'];
+			$sql = 'SELECT user_id AS id, username AS name 
+				FROM ' . USERS_TABLE . ' 
+				WHERE ';
+			$sql .= ($submit == 'add_options') ? &quot; username IN ('&quot; . implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array(array_unique(explode(&quot;\n&quot;, modify_lines($ug_data[0], &quot;\n&quot;))))) . &quot;')&quot; : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
+		break;
+
+		case 'group':
+			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_GROUP'];
+			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
+				FROM ' . GROUPS_TABLE . '
+				WHERE group_id';
+			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
+		break;
+	}
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		trigger_error($l_no_error);
+	}
+	unset($l_no_error);
+
+	// Store the user_ids and names for later use
+	do 
+	{
+		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;b class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] : '&lt;b&gt;' . $row['name']) . '&lt;/b&gt;';
+		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
+		$ug_hidden .= '&lt;input type=&quot;hidden&quot; name=&quot;ug_data[]&quot; value=&quot;' . $row['id'] . '&quot; /&gt;';
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+	$_CLASS['core_db']-&gt;free_result($result);
+
+
+	// Grab the list of options ... if we're in deps mode we want all options, 
+	// else we skip the master options
+	$sql_limit_option = ($mode == 'deps') ? '' : &quot;AND auth_option &lt;&gt; '&quot; . $sql_option_mode . &quot;_'&quot;;
+	$sql = &quot;SELECT auth_option_id, auth_option
+		FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
+		WHERE auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+			$sql_limit_option&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$auth_options = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$auth_presets_compare[] = $row['auth_option'];
+		$auth_options[] = $row;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	unset($sql_limit_option);
+
+
+	// Now we'll build a list of preset options ...
+	$preset_options = $preset_js = $preset_update_options = '';
+
+	// Do we have a parent forum? If so offer option to inherit from that
+	if ($forum_data['parent_id'] != 0)
+	{
+		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+		 
+		$sql = &quot;SELECT o.auth_option, a.auth_setting
+					FROM &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
+					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+						AND a.auth_option_id = o.auth_option_id AND a.forum_id = &quot; . $forum_data['parent_id'] . '
+						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)&quot;;
+
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			do
+			{
+				switch ($row['auth_setting'])
+				{
+					case ACL_YES:
+						$holding['yes'][] = $row['auth_option'];
+					break;
+
+					case ACL_NO:
+						$holding['no'][] = $row['auth_option'];
+					break;
+				}
+			}
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_options .= '&lt;option value=&quot;preset_0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['INHERIT_PARENT'] . '&lt;/option&gt;';
+			$preset_js .= &quot;\tpresets['preset_0'] = new Array();&quot; . &quot;\n&quot;;
+			$preset_js .= &quot;\tpresets['preset_0'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
+
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+	// Look for custom presets
+	$sql = &quot;SELECT preset_id, preset_name, preset_data  
+		FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+		WHERE preset_type = '&quot; . (($mode == 'deps') ? 'f' : $sql_option_mode) . &quot;' 
+		ORDER BY preset_id ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		do
+		{
+			$preset_update_options .= '&lt;option value=&quot;' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
+			$preset_options .= '&lt;option value=&quot;preset_' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
+
+			$holding = unserialize($row['preset_data']);
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new Array();&quot; . &quot;\n&quot;;
+			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	unset($holding, $auth_presets_compare);
+
+
+	// If we aren't looking @ deps then we try and grab existing sessions for
+	// the given forum and user/group
+	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
+	{
+		if ($which_mode == $mode)
+		{
+			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
+					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
+					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+						AND a.auth_option_id = o.auth_option_id 
+						AND a.forum_id IN ($sql_forum_id) 
+						AND a.&quot;.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)
+					GROUP BY o.auth_option&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$auth_settings[$which_mode] = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+		else
+		{
+			// We're looking at a view ... so we'll set all options to unset
+			// We could be a little more clever here but the &quot;safe side&quot; looks
+			// better right now
+			$auth_settings[$which_mode] = array();
+			foreach ($auth_options as $option)
+			{
+				$auth_settings[$which_mode][$option['auth_option']] = '*';
+			}
+			unset($option);
+		}
+	}
+
+	$view_options = '';
+	// Should we display a dropdown for views?
+	if (in_array($mode, array('admin', 'supermod', 'mod')))
+	{
+		$view_options .= '&lt;option value=&quot;&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SELECT_VIEW'] . '&lt;/option&gt;';
+		$view_ary = array(
+			'admin'		=&gt; array('admin' =&gt; 'a_', 'forum' =&gt; 'a_auth', 'supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods'),
+			'supermod'	=&gt; array('supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth'), 
+			'mod'		=&gt; array('mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth')
+		);
+
+		foreach ($view_ary[$mode] as $which_submode =&gt; $which_acl)
+		{
+			if ($_CLASS['auth']-&gt;acl_get($which_acl))
+			{
+				$view_options .= '&lt;option value=&quot;' . $which_submode . '&quot;' . (($which_submode == $which_mode) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ACL_VIEW_' . strtoupper($which_submode)] . '&lt;/option&gt;';
+			}
+
+		}
+		unset($view_ary);
+	}
+
+	$settings_hidden = '';
+	// Output original settings ... needed when we jump views
+	foreach ($auth_settings as $auth_submode =&gt; $auth_submode_settings)
+	{
+		if ($auth_submode != $which_mode)
+		{
+			foreach ($auth_submode_settings as $submode_option =&gt; $submode_setting)
+			{
+				$settings_hidden .= ($submode_setting != '*') ? '&lt;input type=&quot;hidden&quot; name=&quot;settings[' . $auth_submode . '][' . $submode_option . ']&quot; value=&quot;' . $submode_setting . '&quot; /&gt;' : '';
+			}
+		}
+	}
+	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
+
+?&gt;
+
+&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
+&lt;!--
+
+	var presets = new Array();
+&lt;?php
+
+	echo $preset_js;
+
+?&gt;
+
+	function preset_obj(yes, no, unset)
+	{
+		this.yes = yes;
+		this.no = no;
+		this.unset = unset;
+	}
+
+	function use_preset(option)
+	{
+		if (option)
+		{
+			document.acl.set.selectedIndex = 0;
+			for (i = 0; i &lt; document.acl.length; i++)
+			{
+				var elem = document.acl.elements[i];
+				if (elem.name.indexOf('settings') == 0)
+				{
+					switch (option)
+					{
+						case 'all_yes':
+							if (elem.value == &lt;?php echo ACL_YES; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_no':
+							if (elem.value == &lt;?php echo ACL_NO; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_unset':
+							if (elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_ignore':
+							if (elem.value == '*')
+								elem.checked = true;
+							break;
+
+						default:
+							option_start = elem.name.search(/\[(\w+?)\]$/);
+							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
+
+							if (presets[option].yes.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_YES; ?&gt;)
+								elem.checked = true;
+							else if (presets[option].no.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_NO; ?&gt;)
+								elem.checked = true;
+							else if (presets[option].unset.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
+								elem.checked = true;
+							break;
+					}
+				}
+			}
+		}
+	}
+
+	function marklist(match, status)
+	{
+		for (i = 0; i &lt; document.acl.length; i++)
+		{
+			if (document.acl.elements[i].name.indexOf(match) == 0)
+				document.acl.elements[i].checked = status;
+		}
+	}
+
+	function open_win(url, width, height)
+	{
+		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
+		if (window.focus)
+			aclwin.focus();
+	}
+//--&gt;
+&lt;/script&gt;
+
+&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_EXPLAIN']; ?&gt;&lt;/p&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;?php
+
+	// Do we have a list of forums? If so, output them ... but only
+	// if we're looking at the primary view or mode ... submodes
+	// output their own list of forums as and where applicable so this
+	// is unnecessary
+	if ($forum_list != '' &amp;&amp; $which_mode == $mode)
+	{
+		$l_selected_forums = (count($forum_id[$which_mode]) === 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
+
+		echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_forums] . ': ' . $forum_list . '&lt;/p&gt;';
+
+		unset($forum_list);
+		unset($l_selected_forums);
+	}
+
+	// Now output the list of users or groups ... these will always exist
+	$l_selected_users = ($ug_type == 'user') ? ((count($ug_data) === 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((count($ug_data) === 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
+
+	echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_users] . ': ' . $l_ug_list . '&lt;/p&gt;';
+
+	unset($l_selected_users);
+	unset($ug_data);
+
+?&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
+
+&lt;?php
+
+	if ($settings_hidden != '')
+	{
+
+?&gt;
+
+&lt;h2 style=&quot;color:red&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING']; ?&gt;&lt;/h2&gt;
+
+&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING_EXPLAIN']; ?&gt;&lt;/p&gt;
+
+&lt;?php
+
+	}
+
+?&gt;
+
+&lt;form method=&quot;post&quot; name=&quot;acl&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+&lt;?php
+
+	// This is the main listing of options
+
+	// We output this for both deps and when update is requested where
+	// deps exist
+	if (($mode == 'admin' || $mode == 'supermod') &amp;&amp; in_array($submode, array('forum', 'mod')))
+	{
+
+?&gt;
+	&lt;tr&gt;
+		&lt;td colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WILL_SET_OPTIONS']; ?&gt;:&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row2&quot;&gt;&lt;select style=&quot;width:100%&quot; name=&quot;f[&lt;?php echo $which_mode; ?&gt;][]&quot; multiple=&quot;7&quot;&gt;&lt;?php 
+		
+		echo make_forum_select($forum_id[$which_mode], false, true); 
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;br /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+	}
+	// End deps output
+
+?&gt;
+	&lt;tr&gt;
+		&lt;td align=&quot;left&quot;&gt;&lt;?php
+	
+	if ($view_options != '')
+	{
+	
+?&gt;&lt;select name=&quot;submode&quot; onchange=&quot;if (this.options[this.selectedIndex].value != '') this.form.submit();&quot;&gt;&lt;?php echo $view_options; ?&gt;&lt;/select&gt;&lt;?php
+	
+	}
+	
+?&gt;&lt;/td&gt;
+		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;: &lt;select name=&quot;set&quot; onchange=&quot;use_preset(this.options[this.selectedIndex].value);&quot;&gt;&lt;option class=&quot;sep&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_yes&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_YES']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_no&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_NO']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_unset&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_UNSET']; ?&gt;&lt;/option&gt;&lt;?php 
+
+	$colspan = 4;
+	if ($which_mode != $mode)
+	{
+		$colspan = 5;
+		echo '&lt;option value=&quot;all_ignore&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_IGNORE'] . '&lt;/option&gt;';
+	}
+
+	// Output user preset options ... if any
+	echo ($preset_options) ? '&lt;option class=&quot;sep&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_PRESETS'] . ' -&gt;' . '&lt;/option&gt;' . $preset_options : ''; 
+
+?&gt;&lt;/select&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td colspan=&quot;2&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTION']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNSET']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&nbsp;&lt;/th&gt;
+&lt;?php
+
+	if ($which_mode != $mode)
+	{
+
+?&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['IGNORE']; ?&gt;&nbsp;&lt;/th&gt;
+&lt;?php
+
+	}
+
+?&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+	$row_class = 'row2';
+
+	$count = count($auth_options);
+	for ($i = 0; $i &lt; $count; $i++)
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+		// Try and output correct language strings, else output prettyfied auth_option
+		$l_auth_option = (!empty($_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
+		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
+		
+		// Which option should we select?
+		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked=&quot;checked&quot;' : '';
+		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked=&quot;checked&quot;' : '';
+		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked=&quot;checked&quot;' : '';
+
+?&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $l_auth_option; ?&gt;&nbsp;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_YES; ?&gt;&quot;&lt;?php echo $selected_yes; ?&gt; /&gt;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_UNSET; ?&gt;&quot;&lt;?php echo $selected_unset; ?&gt; /&gt;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_NO; ?&gt;&quot;&lt;?php echo $selected_no; ?&gt; /&gt;&lt;/td&gt;
+&lt;?php
+
+		if ($which_mode != $mode)
+		{
+			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked=&quot;checked&quot;' : '';
+
+?&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;*&quot;&lt;?php echo $selected_ignore; ?&gt; /&gt;&lt;/td&gt;
+&lt;?php
+
+		}
+
+?&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+	}
+
+
+	// If we're setting forum or moderator options and a single forum has
+	// been selected then look to see if any subforums exist. If they do
+	// give user the option of cascading permissions to them
+	if (($mode == 'forum' || $mode == 'mod') &amp;&amp; empty($submode) &amp;&amp; count($forum_id[$which_mode]) === 1)
+	{
+		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
+
+		if (!empty($children))
+		{
+
+?&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+					&lt;tr&gt;
+						&lt;td class=&quot;gensmall&quot; colspan=&quot;4&quot; height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS_EXPLAIN']; ?&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+&lt;?php
+
+			foreach ($children as $row)
+			{
+
+?&gt;
+					&lt;tr&gt;
+						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;inherit[]&quot; value=&quot;&lt;?php echo $row['forum_id']; ?&gt;&quot; /&gt; &lt;?php echo $row['forum_name']; ?&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+&lt;?php
+
+			}
+
+?&gt;
+					&lt;tr&gt;
+						&lt;td height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;gensmall&quot; href=&quot;javascript:marklist('inherit', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('inherit', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+				&lt;/table&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+		}
+	}
+
+	// Display event/cron radio buttons
+	if ($_CLASS['auth']-&gt;acl_gets('a_events', 'a_cron') &amp;&amp; $mode != 'deps' &amp;&amp; $submit != 'update')
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+?&gt;
+			&lt;!-- tr&gt;
+				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_HOW']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;now&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_AS_NOW']; ?&gt;&lt;?php 
+	
+			if ($_CLASS['auth']-&gt;acl_get('a_events'))
+			{ 
+
+?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;evt&quot; /&gt; &lt;?php 
+	
+				echo $_CLASS['core_user']-&gt;lang['RUN_AS_EVT'];  
+			}
+			
+			if ($_CLASS['auth']-&gt;acl_get('a_cron'))
+			{
+
+?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;crn&quot; /&gt; &lt;?php 
+	
+				echo $_CLASS['core_user']-&gt;lang['RUN_AS_CRN']; 
+				
+			}
+
+?&gt;&lt;/td&gt;
+			&lt;/tr --&gt;
+&lt;?php
+
+	}
+
+?&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit_update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPDATE']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CANCEL']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;&lt;?php echo $ug_type; ?&gt;&quot; /&gt;&lt;?php echo $ug_hidden; ?&gt;&lt;?php 
+
+	// Output forum id data
+	echo $s_forum_id;
+
+	// Output settings generated from other views
+	echo $settings_hidden;
+	unset($settings_hidden);
+	
+?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;
+
+		&lt;br clear=&quot;all&quot; /&gt;
+
+		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;4&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;4&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+					&lt;tr&gt;
+						&lt;td colspan=&quot;2&quot; height=&quot;16&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+					&lt;tr&gt;
+						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_PRESET']; ?&gt;: &lt;/td&gt;
+						&lt;td&gt;&lt;select name=&quot;presetoption&quot;&gt;&lt;option class=&quot;sep&quot; value=&quot;-1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;?php 
+
+	echo $preset_update_options;
+			
+		?&gt;&lt;/select&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+					&lt;tr&gt;
+						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESET_NAME']; ?&gt;: &lt;/td&gt;
+						&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;presetname&quot; maxlength=&quot;25&quot; /&gt; &lt;/td&gt;
+					&lt;/tr&gt;
+				&lt;/table&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetsave&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SAVE']; ?&gt;&quot; /&gt; &nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetdel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;&lt;/form&gt;
+
+&lt;?php
+
+}
+
+// Output page footer
+adm_page_footer();
+
+// ---------
+// FUNCTIONS
+//
+function update_foes()
+{
+	global $_CLASS;
+
+	$perms = array();
+	foreach ($_CLASS['auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
+	{
+		foreach ($forum_ary as $auth_option =&gt; $user_ary)
+		{
+			$perms += $user_ary;
+		}
+	}
+
+	if (!empty($perms))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	unset($perms);
+}
+//
+// FUNCTIONS
+// ---------
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -826,7 +826,7 @@
 		$topic_title = $subject;
 
 		$notify_type = 'topic';
-		$template = 'notify_topic'; //forum_notify
+		$template = 'notify_topic'; //notify_forum
 		$where = &quot;(w.forum_id = $forum_id OR w.topic_id = $topic_id)&quot;;
 	}
 	else
@@ -857,11 +857,11 @@
 		$ignore_array[$user['user_id']] = $user['user_id'];
 
 		$holding[$user['user_id']] = $user;
-		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' &amp;&amp; $user['forum_id']) ? 'forum_notify' : $template;
+		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' &amp;&amp; $user['forum_id']) ? 'notify_forum' : $template;
 		
 		if ($notify_type == 'topic' &amp;&amp; $user['forum_id'])
 		{
-			$holding[$user['user_id']]['template'] = 'forum_notify';
+			$holding[$user['user_id']]['template'] = 'notify_forum';
 			$holding[$user['user_id']]['update'] = 'forum';
 		}
 		else

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -967,7 +967,7 @@
 
 		foreach (array('u', 'g') as $type)
 		{
-			if (sizeof($$type))
+			if (!empty($$type))
 			{
 				foreach ($$type as $id)
 				{
@@ -999,7 +999,7 @@
 		}
 
 		$address = array();
-		if (sizeof($u))
+		if (!empty($u))
 		{
 			$sql = 'SELECT user_id, username, user_colour 
 				FROM ' . USERS_TABLE . '
@@ -1024,7 +1024,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 		}
 
-		if (sizeof($g))
+		if (!empty($g))
 		{
 			if ($plaintext)
 			{
@@ -1070,7 +1070,7 @@
 			}
 		}
 
-		if (sizeof($address) &amp;&amp; !$plaintext)
+		if (!empty($address) &amp;&amp; !$plaintext)
 		{
 			$_CLASS['core_template']-&gt;assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
 
@@ -1185,6 +1185,9 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 		}
 
+		$recipients = array_unique($recipients);
+		unset($recipients[ANONYMOUS]);
+
 		if (empty($recipients))
 		{
 			trigger_error('NO_RECIPIENT');
@@ -1221,7 +1224,7 @@
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
 				'message_checksum'	=&gt; $data['message_md5'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid'],
 				'to_address'		=&gt; implode(':', $to),
@@ -1241,7 +1244,7 @@
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
 				'message_checksum'	=&gt; $data['message_md5'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid']
 			);
@@ -1388,6 +1391,8 @@
 	// Send Notifications
 	if ($mode !== 'edit')
 	{
+	//unset($recipients[$_CLASS['core_user']-&gt;data['user_id']]);
+
 		pm_notification($mode, $_CLASS['core_user']-&gt;data['username'], $recipients, $subject, $data['message']);
 	}
 
@@ -1397,93 +1402,66 @@
 // PM Notification
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
-	global $_CLASS, $config;
-return;
-	$subject = censor_text($subject);
-	
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
+	global $_CLASS, $_CORE_CONFIG, $config;
 
-	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']-&gt;data['user_id']]);
-	
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	if (empty($recipients))
 	{
-		if (isset($row['ban_userid']))
-		{
-			unset($recipients[$row['ban_userid']]);
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if (!sizeof($recipients))
-	{
 		return;
 	}
 
-	$recipient_list = implode(', ', array_keys($recipients));
+	$subject = censor_text($subject);
 
-	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
+	$recipient_list = implode(', ', array_unique(array_keys($recipients)));
+
+	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type
 		FROM ' . USERS_TABLE . &quot;
 		WHERE user_id IN ($recipient_list)&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	$msg_list_ary = array();
+	$user_list = array();
+// add lang support
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		if ($row['user_notify_pm'] == 1 &amp;&amp; trim($row['user_email']))
+		if ($row['user_notify_pm'])
 		{
-			$msg_list_ary[] = array(
-				'method'	=&gt; $row['user_notify_type'],
-				'email'		=&gt; $row['user_email'],
-				'jabber'	=&gt; $row['user_jabber'],
-				'name'		=&gt; $row['username'],
-				'lang'		=&gt; $row['user_lang']
-			);
+			$user_list[] = $row;
 		}
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 	
-	if (!sizeof($msg_list_ary))
+	if (empty($user_list))
 	{
 		return;
 	}
 
-	require_once('includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
 	$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
 
-	foreach ($msg_list_ary as $pos =&gt; $addr)
+	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	$mailer = new core_mailer;
+
+	$count = count($user_list);
+	for ($i = 0; $i &lt; $count; $i++)
 	{
-		$messenger-&gt;template('privmsg_notify', $addr['lang']);
+		$mailer-&gt;to($user_list[$i]['user_email'], $user_list[$i]['username']);
+	}
 
-		$messenger-&gt;replyto($config['board_email']);
-		$messenger-&gt;to($addr['email'], $addr['name']);
-		$messenger-&gt;im($addr['jabber'], $addr['name']);
+	$mailer-&gt;subject('New Private Message has arrived');
 
-		$messenger-&gt;assign_vars(array(
-			'EMAIL_SIG'		=&gt; $email_sig,
-			'SITENAME'		=&gt; $config['sitename'],
-			'SUBJECT'		=&gt; $subject,
-			'AUTHOR_NAME'	=&gt; $author,
-			'USERNAME'		=&gt; $addr['name'],
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'EMAIL_SIG'		=&gt; $email_sig,
+		'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
+		'SUBJECT'		=&gt; $subject,
+		'AUTHOR_NAME'	=&gt; $author,
 
-			'U_INBOX'		=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true)))
-		);
+		'LINK_INBOX'		=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true))
+	));
 
-		$messenger-&gt;send($addr['method']);
-		$messenger-&gt;reset();
-	}
-	unset($msg_list_ary);
+	$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/control_panel/pm_notify.txt', true));
 
-	if ($messenger-&gt;queue)
+	if (!$mailer-&gt;send())
 	{
-		$messenger-&gt;save_queue();
+		//echo $mailer-&gt;error;
 	}
-
-	unset($messenger);
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/functions.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -605,7 +605,7 @@
 	$_CLASS['core_auth']-&gt;do_login($login_options, $template);
 }
 
-function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $cache = true)
+function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $type = 'string', $cache = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -620,6 +620,7 @@
 			'config_section'=&gt; (string) $section,
 			'config_name'	=&gt; (string) $name,
 			'config_value'	=&gt; (string) $value,
+			'config_type'	=&gt; (string) $type,
 			'config_cache'	=&gt; (int) $cache,
 		);
 

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/functions_user.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -140,7 +140,7 @@
 	return $user_id;
 }
 
-function user_add(&amp;$data)
+function user_add(&amp;$data, $group_add = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -151,6 +151,9 @@
 		'user_new_privmsg'		=&gt; 0,
 		'user_allow_pm'			=&gt; 1,
 		'user_allow_email'		=&gt; 1,
+		'user_posts'			=&gt; 0,
+		'user_new_privmsg'		=&gt; 0,
+		'user_unread_privmsg'	=&gt; 0,
 	);
 
 	$default_data['user_data'] = serialize(array(
@@ -178,13 +181,16 @@
 
 	$data['user_id'] = $_CLASS['core_db']-&gt;insert_id(USERS_TABLE, 'user_id');
 
-	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-		'group_id'		=&gt; (int) $data['user_group'],
-		'user_id'		=&gt; (int) $data['user_id'],
-		'member_status'	=&gt; $data['user_status']
-	));
-	
-	$_CLASS['core_db']-&gt;query($sql);
+	if ($group_add)
+	{
+		$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+			'group_id'		=&gt; (int) $data['user_group'],
+			'user_id'		=&gt; (int) $data['user_id'],
+			'member_status'	=&gt; $data['user_status']
+		));
+		
+		$_CLASS['core_db']-&gt;query($sql);
+	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');
 }

Modified: cms/trunk/includes/mailer.php
===================================================================
--- cms/trunk/includes/mailer.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/mailer.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -43,40 +43,40 @@
 	function to($address, $name = '')
 	{
 		$this-&gt;address_arrays['to'][] = array(
-				'address'	=&gt; $address,
-				'name'		=&gt; $name
+				'address'	=&gt; trim($address),
+				'name'		=&gt; trim($name)
 			);
 	}
 
 	function cc($address, $name = '')
 	{
 		$this-&gt;address_arrays['cc'][] = array(
-				'address'	=&gt; $address,
-				'name'		=&gt; $name
+				'address'	=&gt; trim($address),
+				'name'		=&gt; trim($name)
 			);
 	}
 
 	function bcc($address, $name = '')
 	{
 		$this-&gt;address_arrays['bcc'][] = array(
-				'address'	=&gt; $address,
-				'name'		=&gt; $name
+				'address'	=&gt; trim($address),
+				'name'		=&gt; trim($name)
 			);
 	}
 
 	function reply_to($address, $name = '')
 	{
 		$this-&gt;address_arrays['reply_to'] = array(
-			'address'	=&gt; $address,
-			'name'		=&gt; $name
+			'address'	=&gt; trim($address),
+			'name'		=&gt; trim($name)
 		);
 	}
 
 	function from($address, $name = '')
 	{
 		$this-&gt;address_arrays['from'] = array(
-			'address'	=&gt; $address,
-			'name'		=&gt; $name
+			'address'	=&gt; trim($address),
+			'name'		=&gt; trim($name)
 		);
 	}
 
@@ -92,12 +92,19 @@
 
 	function format_address($address)
 	{
+		if (isset($address['address']))
+		{
+			echo ($address['name'] &amp;&amp; $this-&gt;named_addresses) ?  '&quot;' . mail_encode($address['name'], $this-&gt;encoding) . '&quot; &lt;' . $address['address'] . '&gt;' : $address['address'];
+			return ($address['name'] &amp;&amp; $this-&gt;named_addresses) ?  '&quot;' . mail_encode($address['name'], $this-&gt;encoding) . '&quot; &lt;' . $address['address'] . '&gt;' : $address['address'];
+		}
+
+		$formatted = array();
+
 		foreach ($address as $array)
 		{
-			$array['name'] = trim($array['name']);
-
 			$formatted[] = ($array['name'] &amp;&amp; $this-&gt;named_addresses) ?  '&quot;' . mail_encode($array['name'], $this-&gt;encoding) . '&quot; &lt;' . $array['address'] . '&gt;' : $array['address'];
 		}
+
 		return implode(', ', $formatted);
 	}
 
@@ -105,31 +112,30 @@
 	{
 		global $_CLASS, $_CORE_CONFIG;
 
-		$to = $cc = $bcc = $reply_to = $from = false;
-
-		foreach ($this-&gt;address_arrays as $type =&gt; $address)
+		if (empty($this-&gt;address_arrays['from']))
 		{
-			if (empty($address))
-			{
-				continue;
-			}
-
-			$$type = $this-&gt;format_address($address);
+			$this-&gt;from($_CORE_CONFIG['email']['site_email'], $_CORE_CONFIG['global']['site_name']);
 		}
 
-		$_CORE_CONFIG['email']['site_email'] = trim($_CORE_CONFIG['email']['site_email']);
+		$headers[] = 'Message-ID: &lt;' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . &quot;@&quot; . $_CORE_CONFIG['global']['site_name'] . &quot;&gt;&quot;;
 
-		if (!$from)
+		if (!$_CORE_CONFIG['email']['smtp'])
 		{
-			// modify_lines ?
-			$from = '&lt;' . $_CORE_CONFIG['email']['site_email'] . '&gt;';
-		}
+			$to = $cc = $bcc = $reply_to = $from = false;
 
-		$headers[] = &quot;From: $from&quot;;
-		$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s T');
+			foreach ($this-&gt;address_arrays as $type =&gt; $address)
+			{
+				if (empty($address))
+				{
+					continue;
+				}
+	
+				$$type = $this-&gt;format_address($address);
+			}
 
-		if (!$_CORE_CONFIG['email']['smtp'])
-		{
+			$headers[] = &quot;From: $from&quot;;
+			$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s', gmtime()). ' -0000 (GMT)';
+
 			if ($cc)
 			{
 				$headers[] = &quot;Cc: $cc&quot;;
@@ -139,17 +145,20 @@
 			{
 				$headers[] = &quot;Bcc: $bcc&quot;;
 			}
+
+			if ($reply_to)
+			{
+				$headers[] = &quot;Reply-to: $reply_to&quot;;
+			}
 		}
-
-		if ($reply_to)
+		else
 		{
-			$headers[] = &quot;Reply-to: $reply_to&quot;;
+			$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s', gmtime()). ' -0000 (GMT)';
 		}
 
 		$headers[] = 'Return-Path: &lt;' . $_CORE_CONFIG['email']['site_mail'] . &quot;&gt;&quot;;
 		$headers[] = 'Sender: &lt;' . $_CORE_CONFIG['email']['site_mail'] . &quot;&gt;&quot;;
 		$headers[] = &quot;MIME-Version: 1.0&quot;;
-		$headers[] = 'Message-ID: &lt;' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . &quot;@&quot; . $_CORE_CONFIG['global']['site_name'] . &quot;&gt;&quot;;
 
 		if ($this-&gt;html)
 		{
@@ -159,10 +168,10 @@
 			$headers[] = 'Content-Type: multipart/alternative;';
 			$headers[] = &quot;\tboundary=\&quot;$text_boundary\&quot;&quot;;
 
-			$message .= 'This is a multi-part message in MIME format, Please use a MIME-compatible client';
+			$message = &quot;\n&quot;.'This is a multi-part message in MIME format, Please use a MIME-compatible client';
 
 			// Plain text
-			$message .= &quot;\n\n$text_boundary\n&quot;;
+			$message .= &quot;\n$text_boundary\n&quot;;
 			$message .= 'Content-Type: text/plain; charset='.$this-&gt;encoding.&quot;\n&quot;; //format=
 			$message .= &quot;Content-Transfer-Encoding: 8bit\n\n&quot;;
 			$message .= html_entity_decode(strip_tags(preg_replace('#&lt;br */?&gt;#i', &quot;\n&quot;, modify_lines($this-&gt;message))), ENT_QUOTES);
@@ -199,6 +208,7 @@
 			$smtp-&gt;subject = $this-&gt;subject;
 			$smtp-&gt;headers = $headers;
 			$smtp-&gt;message = $message;
+			$smtp-&gt;from = $this-&gt;address_arrays['from'];
 			$smtp-&gt;recipients = array_merge($this-&gt;address_arrays['to'], $this-&gt;address_arrays['cc'] , $this-&gt;address_arrays['bcc']);
 
 			if (!$smtp-&gt;send_mail())
@@ -243,6 +253,9 @@
 	var $port;
 	var $error;
 
+	var $encoding = 'UTF-8';
+	var $named_addresses = true;
+
 	/*
 		PHP5 destructor
 	*/
@@ -351,11 +364,22 @@
 		return true;
 	}
 
+	function format_address($address, $header = false)
+	{
+		if ($header)
+		{
+			return ($address['name'] &amp;&amp; $this-&gt;named_addresses) ?  '&quot;' . mail_encode($address['name'], $this-&gt;encoding) . '&quot; &lt;' . $address['address'] . '&gt;' : $address['address'];
+		}
+		
+		//return ($address['name'] &amp;&amp; $this-&gt;named_addresses) ?  '&lt;' . $address['address'] . '&gt; '.$address['name'] : '&lt;' . $address['address'] . '&gt;';
+		return '&lt;' . $address['address'] . '&gt;';
+	}
+
 	function send_mail()
 	{
 		global $_CORE_CONFIG;
 
-		fwrite($this-&gt;connection, 'MAIL FROM: &lt;'.$_CORE_CONFIG['email']['site_mail'].'&gt;'.&quot;\r\n&quot;);
+		fwrite($this-&gt;connection, 'MAIL FROM: '.$this-&gt;format_address($this-&gt;from).&quot;\r\n&quot;);
 
 		if (!$this-&gt;check_response(250))
 		{
@@ -368,22 +392,11 @@
 		// Let tell the server who to send this to.
 		foreach ($this-&gt;recipients as $email)
 		{
-			$name = false;
+			fwrite($this-&gt;connection, 'RCPT TO: '.$this-&gt;format_address($email).&quot;\r\n&quot;);
 
-			//print_r($email);
-			if (is_array($email))
-			{
-				$name = $email['name'];
-				$email = $email['address'];
-			}
-
-			$email = trim($email);
-
-			fwrite($this-&gt;connection, 'RCPT TO: &lt;'.$email.&quot;&gt;\r\n&quot;);
-
 			if ($this-&gt;check_response(250))
 			{
-				$to_header[] = ($name) ? &quot;$name &lt;$email&gt;&quot; : &quot;&lt;$email&gt;&quot;;
+				$to_header[] = $this-&gt;format_address($email, true);
 			}
 		}
 
@@ -391,6 +404,7 @@
 		if (empty($to_header))
 		{
 			$this-&gt;error = 'Nothing to send';
+
 			$this-&gt;disconnect();
 			return false;
 		}
@@ -404,6 +418,7 @@
 			return false;
 		}
 
+		fwrite($this-&gt;connection, 'From: '.$this-&gt;format_address($this-&gt;from, true).&quot;\r\n&quot;);
 		fwrite($this-&gt;connection, 'Subject: '.$this-&gt;subject.&quot;\r\n&quot;);
 		fwrite($this-&gt;connection, 'To: '.implode(', ', $to_header).&quot;\r\n&quot;);
 		fwrite($this-&gt;connection, implode(&quot;\r\n&quot;, $this-&gt;headers).&quot;\r\n\r\n&quot;);

Modified: cms/trunk/includes/templates/admin/system/index.html
===================================================================
--- cms/trunk/includes/templates/admin/system/index.html	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/templates/admin/system/index.html	2005-09-29 21:14:37 UTC (rev 149)
@@ -37,14 +37,6 @@
 			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;site_name&quot; value=&quot;{ $SITE_NAME }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
 		&lt;/tr&gt;
 		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SITE_URL }: &lt;/b&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;site_url&quot; value=&quot;{ $SITE_URL }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_START_DATE }: &lt;/b&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;startdate&quot; value=&quot;{ $START_DATE }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
 			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_LINK_OPTIMIZATION }: &lt;/b&gt;&lt;/td&gt;
 			&lt;td class=&quot;row2&quot;&gt;&lt;input name=&quot;link_optimization&quot; value=&quot;1&quot; &lt;!-- IF { $LINK_OPTIMIZATION } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; { $L_YES }&nbsp;&nbsp;&lt;input name=&quot;link_optimization&quot; value=&quot;0&quot; &lt;!-- IF !{ $LINK_OPTIMIZATION } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt;{ $L_NO }&lt;/td&gt;
 		&lt;/tr&gt;
@@ -58,11 +50,53 @@
 			&lt;/td&gt;
 		&lt;/tr&gt;
 		&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot; valign=&quot;top&quot;&gt;&lt;b&gt;{ $L_FOOTER_MESSAGE }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot; valign=&quot;top&quot;&gt;&lt;b&gt;{ $L_FOOTER_MESSAGE }: &lt;/b&gt;&lt;/td&gt;
 			&lt;td class=&quot;row2&quot;&gt;
-			&lt;textarea name=&quot;foot1&quot; rows=&quot;5&quot; cols=&quot;40&quot;&gt;{ $FOOTER_FIRST }&lt;/textarea&gt;&lt;br /&gt;&lt;br /&gt;
-			&lt;textarea name=&quot;foot2&quot; rows=&quot;5&quot; cols=&quot;40&quot;&gt;{ $FOOTER_SECOND }&lt;/textarea&gt;
+				&lt;textarea name=&quot;foot1&quot; rows=&quot;5&quot; cols=&quot;40&quot;&gt;{ $FOOTER_FIRST }&lt;/textarea&gt;&lt;br /&gt;&lt;br /&gt;
+				&lt;textarea name=&quot;foot2&quot; rows=&quot;5&quot; cols=&quot;40&quot;&gt;{ $FOOTER_SECOND }&lt;/textarea&gt;
+			&lt;/td&gt;
 		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;2&quot;&gt;{ $L_EMAIL }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_EMAIL_ENABLE }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input name=&quot;email_enable&quot; value=&quot;1&quot; &lt;!-- IF { $EMAIL_ENABLE } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; { $L_YES }&nbsp;&nbsp;&lt;input name=&quot;email_enable&quot; value=&quot;0&quot; &lt;!-- IF !{ $EMAIL_ENABLE } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt;{ $L_NO }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_MAIL_MODE }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input name=&quot;smtp&quot; value=&quot;1&quot; &lt;!-- IF { $SMTP } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; { $L_SMTP }&nbsp;&nbsp;&lt;input name=&quot;smtp&quot; value=&quot;0&quot; &lt;!-- IF !{ $SMTP } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt;{ $L_FUNCTION }&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SITE_EMAIL }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;site_email&quot; value=&quot;{ $SITE_EMAIL }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;2&quot; class=&quot;row2&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_EMAIL_FUNCTION_NAME }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;email_function_name&quot; value=&quot;{ $EMAIL_FUNCTION_NAME }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;2&quot; class=&quot;row2&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SMTP_SERVER }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;smtp_host&quot; value=&quot;{ $SMTP_HOST }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SMTP_PORT }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;smtp_port&quot; value=&quot;{ $SMTP_PORT }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SMTP_USERNAME }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;smtp_username&quot; value=&quot;{ $SMTP_USERNAME }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_SMTP_PASSWORD }: &lt;/b&gt;&lt;/td&gt;
+			&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; name=&quot;smtp_password&quot; value=&quot;{ $SMTP_PASSWORD }&quot; type=&quot;text&quot;&gt;&lt;/td&gt;
+		&lt;/tr&gt;
 	&lt;!-- ELSEIF { $SYSTEM_MODE } == 'system' --&gt;
 		&lt;tr&gt;
 			&lt;th colspan=&quot;2&quot;&gt;{ $L_MAINTENANCE }&lt;/th&gt;
@@ -74,9 +108,8 @@
 		&lt;tr&gt;
 			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;{ $L_MAINTENANCE_START }: &lt;/b&gt;&lt;/td&gt;
 			&lt;td class=&quot;row2&quot;&gt;
-			&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; id=&quot;maintenance_start&quot; name=&quot;maintenance_start&quot; value=&quot;{ $MAINTENANCE_START }&quot; type=&quot;text&quot;&gt;
-				&lt;img src=&quot;java/jscalendar/calendar.png&quot; style=&quot;cursor: pointer;&quot; id=&quot;time_trigger&quot; /&gt;
-				
+				&lt;input class=&quot;post&quot; size=&quot;40&quot; maxlength=&quot;255&quot; id=&quot;maintenance_start&quot; name=&quot;maintenance_start&quot; value=&quot;{ $MAINTENANCE_START }&quot; type=&quot;text&quot;&gt;
+				&lt;img src=&quot;images/calender_small.png&quot; style=&quot;cursor: pointer;&quot; id=&quot;time_trigger&quot; /&gt;
 			&lt;/td&gt;
 		&lt;/tr&gt;
 		&lt;tr&gt;
@@ -110,8 +143,7 @@
 
 		&lt;tr&gt;
 			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;Session IP validation: &lt;/b&gt;&lt;br&gt;&lt;span class=&quot;gensmall&quot;&gt;Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.&lt;/span&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt;&lt;input name=&quot;ip_check&quot; value=&quot;4&quot; &lt;!-- IF { $IP_CHECK } == 4  --&gt;checked=&quot;checked&quot; &lt;!-- ENDIF --&gt;type=&quot;radio&quot;&gt; All&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;3&quot; &lt;!-- IF { $IP_CHECK } == 3 --&gt;checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; A.B.C&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;2&quot; &lt;!-- IF { $IP_CHECK } == 2 --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; A.B&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;0&quot; &lt;!-- IF { $IP_CHECK } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; None&nbsp;&nbsp;&lt;/td&gt;
-	
+			&lt;td class=&quot;row2&quot;&gt;&lt;input name=&quot;ip_check&quot; value=&quot;4&quot; &lt;!-- IF { $IP_CHECK } == 4  --&gt;checked=&quot;checked&quot; &lt;!-- ENDIF --&gt;type=&quot;radio&quot;&gt; All&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;3&quot; &lt;!-- IF { $IP_CHECK } == 3 --&gt;checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; A.B.C&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;2&quot; &lt;!-- IF { $IP_CHECK } == 2 --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; A.B&nbsp;&nbsp;&lt;input name=&quot;ip_check&quot; value=&quot;0&quot; &lt;!-- IF !{ $IP_CHECK } --&gt; checked=&quot;checked&quot; &lt;!-- ENDIF --&gt; type=&quot;radio&quot;&gt; None&nbsp;&nbsp;&lt;/td&gt;
 		&lt;/tr&gt;
 		&lt;tr&gt;
 			&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;Limit system load: &lt;/b&gt;&lt;br&gt;&lt;span class=&quot;gensmall&quot;&gt;If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.&lt;/span&gt;&lt;/td&gt;

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/install/build_data.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -27,63 +27,63 @@
 
 //$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '&lt;a href=\&quot;feed.php?feed=rss1\&quot; title=\&quot;RSS 1.0 / RDF Feed\&quot;&gt;&lt;img alt=\&quot;RSS 1.0 / RDF\&quot; src=\&quot;images/rss10_logo.gif\&quot; /&gt;&lt;/a&gt; &lt;a href=\&quot;feed.php?feed=rss2\&quot; title=\&quot;RSS 2.0 Feed\&quot;&gt;&lt;img alt=\&quot;RSS 2.0\&quot; src=\&quot;images/rss20_logo.gif\&quot; /&gt;&lt;/a&gt; &lt;a href=\&quot;feed.php?feed=rss\&quot; title=\&quot;RSS 0.91 Feed\&quot;&gt;&lt;img alt=\&quot;RSS 0.9\&quot; src=\&quot;images/rss090_logo.gif\&quot; /&gt;&lt;/a&gt;', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'contact', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '&lt;a href=\&quot;feed.php?feed=rss1\&quot; title=\&quot;RSS 1.0 / RDF Feed\&quot;&gt;&lt;img alt=\&quot;RSS 1.0 / RDF\&quot; src=\&quot;images/rss10_logo.gif\&quot; /&gt;&lt;/a&gt; &lt;a href=\&quot;feed.php?feed=rss2\&quot; title=\&quot;RSS 2.0 Feed\&quot;&gt;&lt;img alt=\&quot;RSS 2.0\&quot; src=\&quot;images/rss20_logo.gif\&quot; /&gt;&lt;/a&gt; &lt;a href=\&quot;feed.php?feed=rss\&quot; title=\&quot;RSS 0.91 Feed\&quot;&gt;&lt;img alt=\&quot;RSS 0.9\&quot; src=\&quot;images/rss090_logo.gif\&quot; /&gt;&lt;/a&gt;', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dst', '0', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'only_registered', '0', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_timezone', '-5', 'float', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'link_optimization', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'index_page', 'contact', 'string', 1)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '&lt;p align=\&quot;center\&quot;&gt;&lt;b&gt;Sorry we are currently updating this site.&lt;br&gt;\nPlease try again later&lt;/b&gt;&lt;/p&gt;\n&lt;p align=\&quot;center\&quot;&gt;&lt;b&gt;Viperal&lt;/b&gt;\n&lt;/p&gt;', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'active', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '&lt;p align=\&quot;center\&quot;&gt;&lt;b&gt;Sorry we are currently updating this site.&lt;br&gt;\nPlease try again later&lt;/b&gt;&lt;/p&gt;\n&lt;p align=\&quot;center\&quot;&gt;&lt;b&gt;Viperal&lt;/b&gt;\n&lt;/p&gt;', 'string', 1)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mail', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'allow_html_email', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_enable', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_function_name', 'mail', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp', 0, 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_host', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_port', '', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_username', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_password', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'site_email', '<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">none at none.com</A>', 'string', 1)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_chars', '.*', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'enable_confirm', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_enable', '1', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_fax', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_mail', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_name_chars', '5', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_reg_attempts', '10', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_name_chars', '50', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_pass_chars', '5', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_pass_chars', '25', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_email_reuse', '0', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_change', '0', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_username', 'admin', 'string', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_user_id', '2', 'int', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'activation', '0', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'total_users', '1', 'int', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'password_encoding', 'md5', 'string', 1)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'path', '/', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_domain', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_name', 'viperal', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_path', '/', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_load', '0', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_sessions', '0', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'ip_check', '4', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'session_length', '3600', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'error_options', '0', 'int', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_secure', '0', 'bool', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_domain', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_path', '', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_port', '', 'int', 1)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')&quot;);
@@ -176,14 +176,14 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']-&gt;escape($data);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$user_prefix.&quot;users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)&quot;);
 
 // Forums
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth_options (auth_option, is_local) VALUES ('f_', 1)&quot;);
@@ -307,20 +307,13 @@
 // ADMINISTRATOR group
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option LIKE 'u_%'&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option LIKE 'a_%'&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')&quot;);
 
 // SUPER MODERATOR group
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option LIKE 'm_%'&quot;);
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname')&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
-
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 0, auth_option_id, 1 FROM &quot;.$table_prefix.&quot;forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname')&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)&quot;);
@@ -348,7 +341,7 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)&quot;);// maybe keep
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)&quot;);
@@ -360,7 +353,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)&quot;);
@@ -374,33 +366,17 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', &quot;.gmtime().&quot;, 0)&quot;);
-
-// to be removed
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)&quot;);
-////
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)&quot;);
-
+//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)&quot;);
+//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)&quot;);
+//$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)&quot;);
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_start_date', &quot;.gmtime().&quot;, 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)&quot;);
+
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)&quot;);
@@ -439,21 +415,20 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)&quot;);
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '0', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '0', 1)&quot;);
+
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)&quot;);
+
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)&quot;);
@@ -462,7 +437,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')&quot;);
@@ -472,8 +446,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach &amp;&amp; cfg_allow_attachments')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')&quot;);

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/install/build_tables.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -81,6 +81,7 @@
 $_CLASS['core_db']-&gt;add_table_field_char('config_section', 20);
 $_CLASS['core_db']-&gt;add_table_field_char('config_name', 20);
 $_CLASS['core_db']-&gt;add_table_field_text('config_value', 60000);
+$_CLASS['core_db']-&gt;add_table_field_char('config_type', 7);
 $_CLASS['core_db']-&gt;add_table_field_int('config_cache', array('max' =&gt; 1, 'null' =&gt; true));
 
 $_CLASS['core_db']-&gt;add_table_index(array('config_section', 'config_name'), 'primary');
@@ -257,8 +258,8 @@
 $_CLASS['core_db']-&gt;add_table_field_int('user_allow_viewemail', array('max' =&gt; 1));
 $_CLASS['core_db']-&gt;add_table_field_int('user_allow_massemail', array('max' =&gt; 1));
 
-$_CLASS['core_db']-&gt;add_table_field_int('user_new_privmsg', array('max' =&gt; 1, 'null' =&gt; true));
-$_CLASS['core_db']-&gt;add_table_field_int('user_unread_privmsg', array('max' =&gt; 1, 'null' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_int('user_new_privmsg', array('max' =&gt; 1));
+$_CLASS['core_db']-&gt;add_table_field_int('user_unread_privmsg', array('max' =&gt; 1));
 
 $_CLASS['core_db']-&gt;add_table_field_text('user_sig', 60000, true);
 $_CLASS['core_db']-&gt;add_table_field_char('user_from', 100, true);
@@ -279,7 +280,7 @@
 ///
 
 $_CLASS['core_db']-&gt;add_table_field_int('user_notify', array('max' =&gt; 1, 'null' =&gt; true));
-//$_CLASS['core_db']-&gt;add_table_field_int('user_notify_pm', array('max' =&gt; 1));
+$_CLASS['core_db']-&gt;add_table_field_int('user_notify_pm', array('max' =&gt; 10, 'null' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_int('user_notify_type', array('max' =&gt; 10, 'null' =&gt; true));
 
 $_CLASS['core_db']-&gt;add_table_field_int('user_allow_pm', array('max' =&gt; 1));
@@ -296,7 +297,7 @@
 $_CLASS['core_db']-&gt;add_table_field_char('user_post_sortby_type', 1, true);
 $_CLASS['core_db']-&gt;add_table_field_char('user_post_sortby_dir', 1, true);
 
-$_CLASS['core_db']-&gt;add_table_field_int('user_posts', array('max' =&gt; 16000000, 'null' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_int('user_posts', array('max' =&gt; 16000000));
 field_unix_time('user_last_post_time', true);
 
 $_CLASS['core_db']-&gt;add_table_field_text('user_permissions', 60000, true); // phpBBs rename user_forums_permissions
@@ -385,7 +386,7 @@
 */
 $_CLASS['core_db']-&gt;table_create('start', $table_prefix.'forums_auth_presets');
 
-$_CLASS['core_db']-&gt;add_table_field_int('preset_id', array('max' =&gt; 16000));
+$_CLASS['core_db']-&gt;add_table_field_int('preset_id', array('max' =&gt; 16000, 'auto_increment' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_int('preset_user_id', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_char('preset_name', 50);
 $_CLASS['core_db']-&gt;add_table_field_char('preset_type', 2);
@@ -794,7 +795,7 @@
 $_CLASS['core_db']-&gt;add_table_field_int('word_id', array('max' =&gt; 3000000000));
 $_CLASS['core_db']-&gt;add_table_field_int('title_match', array('max' =&gt; 1));
 
-$_CLASS['core_db']-&gt;add_table_index('word_id', 'primary');
+$_CLASS['core_db']-&gt;add_table_index('word_id');
 
 $_CLASS['core_db']-&gt;table_create('commit');
 

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Forums/posting.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -1231,11 +1231,12 @@
 	{
 		// Try to delete topic, we may had an previous error causing inconsistency
 		/*
-		if ($post_mode = 'delete_topic')
+		if ($post_mode === 'delete_topic')
 		{
 			delete_topics('topic_id', array($topic_id), false);
 		}
 		*/
+
 		trigger_error('ALREADY_DELETED');
 	}
 
@@ -1259,7 +1260,7 @@
 
 			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-			break;
+		break;
 
 		case 'delete_first_post':
 			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
@@ -1281,7 +1282,7 @@
 			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$next_post_id = (int) $row['post_id'];
-			break;
+		break;
 			
 		case 'delete_last_post':
 			if ($data['topic_type'] != POST_GLOBAL)
@@ -1311,7 +1312,7 @@
 	
 				$next_post_id = (int) $row['last_post_id'];
 			}
-			break;
+		break;
 			
 		case 'delete':
 			$sql = 'SELECT post_id
@@ -1332,6 +1333,7 @@
 
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 			$next_post_id = (int) $row['post_id'];
+		break;
 	}
 				
 	$sql_data[USERS_TABLE] = ($_CLASS['auth']-&gt;acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';

Modified: cms/trunk/modules/Forums/search.php
===================================================================
--- cms/trunk/modules/Forums/search.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Forums/search.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -47,7 +47,8 @@
 $_CLASS['core_user']-&gt;add_img();
 
 // Is user able to search? Has search been disabled?
-if ($_CLASS['core_user']-&gt;is_bot || !$_CLASS['auth']-&gt;acl_get('u_search') || !$config['load_search'])
+//!$_CLASS['auth']-&gt;acl_get('u_search') 
+if ($_CLASS['core_user']-&gt;is_bot || !$config['load_search'])
 {
 	trigger_error('NO_SEARCH');
 }

Modified: cms/trunk/modules/Quick_Message/configurator.php
===================================================================
--- cms/trunk/modules/Quick_Message/configurator.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Quick_Message/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -54,11 +54,11 @@
 		$_CLASS['core_db']-&gt;table_create('commit');
 		
 		// use set config ?
-		set_core_config('quick_message', 'anonymous_posting', 2, false, true);
-		set_core_config('quick_message', 'delete_time', 300, false, true);
-		set_core_config('quick_message', 'height', 200, false, true);
-		set_core_config('quick_message', 'last_post_check', 150, false, true);
-		set_core_config('quick_message', 'length_max', 150, false, true);
+		set_core_config('quick_message', 'anonymous_posting', 2, false, true, 'int');
+		set_core_config('quick_message', 'delete_time', 300, false, true, 'int');
+		set_core_config('quick_message', 'height', 200, false, true, 'int');
+		set_core_config('quick_message', 'last_post_check', 150, false, true, 'int');
+		set_core_config('quick_message', 'length_max', 150, false, true, 'int');
 
 		$_CLASS['core_cache']-&gt;destroy('core_config');
 
@@ -85,6 +85,8 @@
 		$_CLASS['core_db']-&gt;query('DELETE FROM ' . CORE_CONFIG_TABLE . &quot; WHERE config_section = 'quick_message'&quot;);
 
 		$_CLASS['core_db']-&gt;report_error(true);
+		
+		return true;
 	}
 }
 

Modified: cms/trunk/modules/articles/configurator.php
===================================================================
--- cms/trunk/modules/articles/configurator.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/articles/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -97,6 +97,8 @@
 		$_CLASS['core_db']-&gt;query('DROP TABLE ' . ARTICLES_TABLE);
 
 		$_CLASS['core_db']-&gt;report_error(true);
+		
+		return true;
 	}
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000068.html">[Viperals-svncheckins] r148 - in cms/branches/1.0alpha2: . includes includes/templates/modules
</A></li>
	<LI>Next message: <A HREF="000070.html">[Viperals-svncheckins] r150 - in cms/branches/1.0alpha2: . images images/modules images/modules/forums images/modules/forums/adm images/modules/forums/adm/images includes/db includes/display includes/forums includes/forums/admin includes/templates/modules/Control_Panel install modules/Control_Panel/ucp modules/Forums modules/Quick_Message modules/articles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#69">[ date ]</a>
              <a href="thread.html#69">[ thread ]</a>
              <a href="subject.html#69">[ subject ]</a>
              <a href="author.html#69">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
