<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r82 - in trunk: . admin admin/functions blocks images includes includes/auth includes/cache includes/db includes/display modules/Contact modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal themes/viperal/images themes/viperal/style themes/viperal/style/images themes/viperal/template themes/viperal/template/modules/News
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r82%20-%20in%20trunk%3A%20.%20admin%20admin/functions%20blocks%20images%20includes%20includes/auth%20includes/cache%20includes/db%20includes/display%20modules/Contact%20modules/Control_Panel%20modules/Control_Panel/ucp%20modules/Forums%20modules/Quick_Message%20themes/viperal%20themes/viperal/images%20themes/viperal/style%20themes/viperal/style/images%20themes/viperal/template%20themes/viperal/template/modules/News&In-Reply-To=%3C200508152101.j7FL1gZK011031%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000005.html">
   <LINK REL="Next"  HREF="000007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r82 - in trunk: . admin admin/functions blocks images includes includes/auth includes/cache includes/db includes/display modules/Contact modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal themes/viperal/images themes/viperal/style themes/viperal/style/images themes/viperal/template themes/viperal/template/modules/News</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r82%20-%20in%20trunk%3A%20.%20admin%20admin/functions%20blocks%20images%20includes%20includes/auth%20includes/cache%20includes/db%20includes/display%20modules/Contact%20modules/Control_Panel%20modules/Control_Panel/ucp%20modules/Forums%20modules/Quick_Message%20themes/viperal%20themes/viperal/images%20themes/viperal/style%20themes/viperal/style/images%20themes/viperal/template%20themes/viperal/template/modules/News&In-Reply-To=%3C200508152101.j7FL1gZK011031%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r82 - in trunk: . admin admin/functions blocks images includes includes/auth includes/cache includes/db includes/display modules/Contact modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal themes/viperal/images themes/viperal/style themes/viperal/style/images themes/viperal/template themes/viperal/template/modules/News">viperal at berlios.de
       </A><BR>
    <I>Mon Aug 15 23:01:42 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000005.html">[Viperals-svncheckins] r81 - in trunk: . images/mimetypes images/smilies includes includes/auth includes/cache includes/db includes/display includes/forums javascript modules/Control_Panel/ucp modules/Forums modules/Quick_Message
</A></li>
        <LI>Next message: <A HREF="000007.html">[Viperals-svncheckins] r83 - trunk/includes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6">[ date ]</a>
              <a href="thread.html#6">[ thread ]</a>
              <a href="subject.html#6">[ subject ]</a>
              <a href="author.html#6">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-08-15 23:01:36 +0200 (Mon, 15 Aug 2005)
New Revision: 82

Added:
   trunk/modules/Quick_Message/install.php
   trunk/themes/viperal/images/mail.png
   trunk/themes/viperal/images/print.png
Removed:
   trunk/modules/Control_Panel/ucp/ucp_activate.php
   trunk/modules/Control_Panel/ucp/ucp_confirm.php
   trunk/modules/Control_Panel/ucp/ucp_confirm_old.php
   trunk/modules/Control_Panel/ucp/ucp_remind.php
   trunk/modules/Control_Panel/ucp/ucp_resend.php
   trunk/themes/viperal/blockscript.js
   trunk/themes/viperal/images/down-logo.gif
   trunk/themes/viperal/images/leftbar.gif
   trunk/themes/viperal/images/mainbar.gif
   trunk/themes/viperal/images/print.gif
   trunk/themes/viperal/images/rightbar.gif
   trunk/themes/viperal/style/images/cellpic3.gif
   trunk/themes/viperal/style/images/created_by.jpg
   trunk/themes/viperal/style/images/icon_mini_faq.gif
   trunk/themes/viperal/style/images/icon_mini_groups.gif
   trunk/themes/viperal/style/images/icon_mini_login.gif
   trunk/themes/viperal/style/images/icon_mini_members.gif
   trunk/themes/viperal/style/images/icon_mini_message.gif
   trunk/themes/viperal/style/images/icon_mini_profile.gif
   trunk/themes/viperal/style/images/icon_mini_register.gif
   trunk/themes/viperal/style/images/icon_mini_search.gif
   trunk/themes/viperal/style/images/icons/
   trunk/themes/viperal/style/images/index.htm
   trunk/themes/viperal/style/images/logo-christmas.jpg
   trunk/themes/viperal/style/images/sitelogo.jpg
   trunk/themes/viperal/style/images/whosonline.gif
Modified:
   trunk/admin.php
   trunk/admin/blocks.php
   trunk/admin/bots.php
   trunk/admin/functions/block_functions.php
   trunk/admin/index.php
   trunk/admin/system.php
   trunk/blocks/block-Quick_Message.php
   trunk/images/Thumbs.db
   trunk/includes/auth/auth.php
   trunk/includes/auth/auth_db.php
   trunk/includes/auth/auth_http.php
   trunk/includes/cache/cache.php
   trunk/includes/cache/cache_eaccelerator.php
   trunk/includes/cache/cache_file.php
   trunk/includes/cache/cache_none.php
   trunk/includes/core_rss.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysqli.php
   trunk/includes/display/blocks.php
   trunk/includes/display/display.php
   trunk/includes/display/template.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/handler.php
   trunk/includes/session.php
   trunk/includes/system.php
   trunk/includes/user.php
   trunk/modules/Contact/index.php
   trunk/modules/Control_Panel/index.php
   trunk/modules/Control_Panel/ucp/ucp_attachments.php
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_main.php
   trunk/modules/Control_Panel/ucp/ucp_pm.php
   trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
   trunk/modules/Forums/download.php
   trunk/modules/Forums/faq.php
   trunk/modules/Forums/main.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Quick_Message/index.php
   trunk/themes/viperal/images/Thumbs.db
   trunk/themes/viperal/index.php
   trunk/themes/viperal/style/images/Thumbs.db
   trunk/themes/viperal/style/style.css
   trunk/themes/viperal/template/blockleft.html
   trunk/themes/viperal/template/blockright.html
   trunk/themes/viperal/template/header.html
   trunk/themes/viperal/template/modules/News/index.html
Log:
You would expect me to add something of use here, wouldn't you ?

Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/blocks.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -21,8 +21,6 @@
 require($site_file_root.'admin/functions/block_functions.php');
 $_CLASS['core_user']-&gt;add_lang('admin/blocks.php');
 
-$mode = get_variable('mode', 'GET', false);
-
 function check_position($position, $redirect = true)
 {
 	$appoved_blocks = array(BLOCK_RIGHT, BLOCK_TOP, BLOCK_BOTTOM, BLOCK_LEFT);
@@ -41,68 +39,119 @@
 	return true;
 }
 
-function get_id($rediret = true)
+if (isset($_REQUEST['mode']))
 {
-	$id = get_variable('id', 'GET', false, 'integer');
-
-	if (!$id &amp;&amp; $rediret)
+	if ($id = get_variable('id', 'REQUEST', false, 'integer'))
 	{
-		url_redirect(generate_link('blocks', array('admin' =&gt; true)));
-		die;
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				block_change($id);
+			break;
+	
+			case 'order':
+				block_order($id, get_variable('option', 'GET', false));
+			break;
+	
+			case 'delete':
+				block_delete($id);
+			break;
+	
+			case 'position':
+				if ($position = get_variable('option', 'GET', false, 'integer'))
+				{
+					blocks_change_position($position, $id);
+				}
+			break;
+	
+			case 'auth':
+				block_auth($id);
+			break;
+		}
 	}
+	
+	switch ($_REQUEST['mode'])
+	{
+		case 'add':
+		case 'edit':
+			block_add($id);
+			script_close(false);
+		break;
+		   
+		case 'save':
+			block_save($id);
+		break;
+	}
+}
 
-	return (int) $id;
+blocks_block('main');
+
+$result = $_CLASS['core_db']-&gt;query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
+	FROM '.BLOCKS_TABLE.'
+	WHERE block_position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.')  ORDER BY block_position, block_order ASC');
+
+$block_position = array(BLOCK_RIGHT =&gt; 'right', BLOCK_TOP =&gt; 'centertop', BLOCK_BOTTOM =&gt; 'centerbottom', BLOCK_LEFT =&gt; 'left');
+$in_position = false;
+$blocks = array();
+
+while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	if ($in_position != $row['block_position'])
+	{
+		$weigth[$row['block_position']] = $row['block_order'];
+		$in_position == $row['block_position'];
+	}
+	$blocks[] = $row;
 }
+$_CLASS['core_db']-&gt;free_result($result);
 
-switch ($mode)
+foreach ($blocks as $block)
 {
-	case 'change':
-		block_change(get_id());
-		url_redirect(generate_link('blocks', array('admin' =&gt; true, 'full' =&gt; true)));
-    break;
-    
-    case 'weight':
-		block_weight(get_id(), get_variable('option', 'GET', false));
-		url_redirect(generate_link('blocks', array('admin' =&gt; true, 'full' =&gt; true)));
-    break;
-    	
-    case 'delete':
-		block_delete(get_id());
-		url_redirect(generate_link('blocks', array('admin' =&gt; true, 'full' =&gt; true)));
-    break;
-    
-    case 'position':
-		$position = get_variable('option', 'GET', false, 'integer');
+	$error = false;
+	switch ($block['block_type'])
+	{
+		case BLOCKTYPE_FILE:
+			if (!$block['block_file'] || !file_exists($site_file_root.'blocks/'.$block['block_file']))
+			{
+				$error = 'File_MISSING';
+			}
+		break;
+	}
 
-		// Would cause problems is $data['position'] = (int) 0
-		if (!$position)
-		{
-			url_redirect(generate_link('blocks', array('admin' =&gt; true, 'full' =&gt; true)));
-		}
+	$_CLASS['core_template']-&gt;assign_vars_array($block_position[$block['block_position']].'_admin_blocks', array(
+			'ACTIVE'		=&gt; ($block['block_status']),
+			'ACTIVE_LINK'	=&gt; generate_link('blocks&amp;mode=change&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+			'CHANGE'		=&gt; ($block['block_status']) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE'],
+			'ERROR'			=&gt; ($error) ? $_CLASS['core_user']-&gt;get_lang($error) : false,
 
-		blocks_change_position($position, get_id());
+			'EDIT_LINK'		=&gt; generate_link('blocks&amp;mode=edit&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+			'AUTH_LINK'		=&gt; generate_link('blocks&amp;mode=auth&amp;id='.$block['block_id'], array('admin' =&gt; true)),
 
-		url_redirect(generate_link('blocks', array('admin' =&gt; true, 'full' =&gt; true)));
-    break;
+			'DELETE_LINK' 	=&gt; ($block['block_type'] != BLOCKTYPE_SYSTEM) ? generate_link('blocks&amp;mode=delete&amp;id='.$block['block_id'], array('admin' =&gt; true)) : '',
+			'TITLE'			=&gt; $block['block_title'],
+			'TYPE'			=&gt; $_CLASS['core_user']-&gt;get_lang('TYPE_'.$block['block_type']),
 
-    case 'add':
-    case 'edit':
-		block_add();
-    break;
-       
-    case 'save':
-		block_save();
-    break;
+			'ORDER_DOWN' 	=&gt; ($block['block_order'] &lt; $weigth[$block['block_position']]),
+			'ORDER_UP'		=&gt; ($block['block_order'] &gt; 1),
 
-    case 'auth':
-		block_auth(get_id());
-    break;
-
-    default:
-		blocks_admin();
-    break;
+			'LINK_ORDER_UP' 	=&gt; generate_link('blocks&amp;mode=order&amp;option=up&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+			'LINK_ORDER_TOP' 	=&gt; generate_link('blocks&amp;mode=order&amp;option=top&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+			'LINK_ORDER_DOWN'	=&gt; generate_link('blocks&amp;mode=order&amp;option=down&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+			'LINK_ORDER_BOTTOM'	=&gt; generate_link('blocks&amp;mode=order&amp;option=bottom&amp;id='.$block['block_id'], array('admin' =&gt; true)),
+	));
 }
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_BLOCK_REGULAR'	=&gt; 'Add New Regular Block',
+	'L_BLOCK_HTML'		=&gt; 'Add New HTML Block',
+	'L_BLOCK_FEED'		=&gt; 'Add New Feed Block',
+	'N_BLOCK_FILE'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FILE, array('admin' =&gt; true)),
+	'N_BLOCK_FEED'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FEED, array('admin' =&gt; true)),
+	'N_BLOCK_HTML'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_HTML, array('admin' =&gt; true))
+));
+
+$_CLASS['core_template']-&gt;display('admin/blocks/index.html');
+	
 script_close(false);
 
 function blocks_change_position($position, $id)
@@ -111,123 +160,50 @@
 
 	check_position($position);
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT position, weight FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']-&gt;query('SELECT block_position, block_order FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 	$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	check_position($block['position']);
-
-	if ($block['position'] == $position)
+	if (!$block || $block['block_position'] == $position)
 	{
 		return;
 	}
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT weight FROM '.BLOCKS_TABLE.&quot; WHERE position = $position ORDER BY weight DESC LIMIT 1&quot;);
-	$max_weight = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-	$_CLASS['core_db']-&gt;free_result($result);
+	check_position($block['block_position']);
 
-	$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight= weight - 1 WHERE position = '.$block['position'].' AND weight &gt; '.$block['weight']);
-	$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.&quot; set position = $position , weight = &quot;.((int) $max_weight['weight'] + 1).' where id ='.$id);
-
-	$_CLASS['core_cache']-&gt;destroy('blocks');
-}
-
-function blocks_admin()
-{
-    global $_CLASS, $site_file_root;
-
-	blocks_block('main');
-
-    $result = $_CLASS['core_db']-&gt;query('SELECT id, title, type,  position, weight, active, file, auth
-		FROM '.BLOCKS_TABLE.'
-		WHERE position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.')  ORDER BY position, weight ASC');
-
-    $block_position = array(BLOCK_RIGHT =&gt; 'right', BLOCK_TOP =&gt; 'centertop', BLOCK_BOTTOM =&gt; 'centerbottom', BLOCK_LEFT =&gt; 'left');
-	$in_position = false;
-	$blocks = array();
-
-	while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-    {
-		if ($in_position != $row['position'])
-		{
-			$weigth[$row['position']] = $row['weight'];
-			$in_position == $row['position'];
-		}
-		$blocks[] = $row;
-	}
+	$result = $_CLASS['core_db']-&gt;query('SELECT max(block_order) as max_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$position);
+	list($max_order) = $_CLASS['core_db']-&gt;fetch_row_num($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	foreach ($blocks as $block)
-	{
-		$error = false;
-		switch ($block['type'])
-		{
-			case BLOCKTYPE_FILE:
-				if (!$block['file'] || !file_exists($site_file_root.'blocks/'.$block['file']))
-				{
-					$error = 'File_MISSING';
-				}
-			break;
-		}
+	$new_order = (int) $max_order + 1;
 
-		$_CLASS['core_template']-&gt;assign_vars_array($block_position[$block['position']].'_admin_blocks', array(
-				'ACTIVE'		=&gt; ($block['active']),
-				'ACTIVE_LINK'	=&gt; generate_link('blocks&amp;mode=change&amp;id='.$block['id'], array('admin' =&gt; true)),
-				'CHANGE'		=&gt; ($block['active']) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE'],
-				'ERROR'			=&gt; ($error) ? $_CLASS['core_user']-&gt;get_lang($error) : false,
+	$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.&quot; SET block_position = $position , block_order = $new_order where block_id = $id&quot;);
+	$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET block_order = block_order - 1 WHERE block_position = '.$block['block_position'].' AND block_order &gt; '.$block['block_order']);
 
-				'EDIT_LINK'		=&gt; generate_link('blocks&amp;mode=edit&amp;id='.$block['id'], array('admin' =&gt; true)),
-				'AUTH_LINK'		=&gt; generate_link('blocks&amp;mode=auth&amp;id='.$block['id'], array('admin' =&gt; true)),
-
-				'DELETE_LINK' 	=&gt; ($block['type'] != BLOCKTYPE_SYSTEM) ? generate_link('blocks&amp;mode=delete&amp;id='.$block['id'], array('admin' =&gt; true)) : '',
-				'TITLE'			=&gt; $block['title'],
-				'TYPE'			=&gt; $_CLASS['core_user']-&gt;get_lang('TYPE_'.$block['type']),
-
-				'WEIGHT_DOWN' 	=&gt; ($block['weight'] &lt; $weigth[$block['position']]),
-				'WEIGHT_UP'		=&gt; ($block['weight'] &gt; 1),
-
-				'WEIGHT_MOVE_UP' 	=&gt; generate_link('blocks&amp;mode=weight&amp;option=up&amp;id='.$block['id'], array('admin' =&gt; true)),
-				'WEIGHT_MOVE_TOP' 	=&gt; generate_link('blocks&amp;mode=weight&amp;option=top&amp;id='.$block['id'], array('admin' =&gt; true)),
-				'WEIGHT_MOVE_DOWN'	=&gt; generate_link('blocks&amp;mode=weight&amp;option=down&amp;id='.$block['id'], array('admin' =&gt; true)),
-				'WEIGHT_MOVE_BOTTOM'=&gt; generate_link('blocks&amp;mode=weight&amp;option=bottom&amp;id='.$block['id'], array('admin' =&gt; true)),
-		));
-	}
-
-    $_CLASS['core_template']-&gt;assign(array(
-		'L_BLOCK_REGULAR'	=&gt; 'Add New regular Block',
-		'L_BLOCK_HTML'		=&gt; 'Add New HTML Block',
-		'L_BLOCK_FEED'		=&gt; 'Add New Feed Block',
-		'N_BLOCK_FILE'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FILE, array('admin' =&gt; true)),
-		'N_BLOCK_FEED'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FEED, array('admin' =&gt; true)),
-		'N_BLOCK_HTML'		=&gt; generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_HTML, array('admin' =&gt; true))
-	));
-
-	$_CLASS['core_template']-&gt;display('admin/blocks/index.html');
+	$_CLASS['core_cache']-&gt;destroy('blocks');
 }
 
-function block_add($block = false, $error = false)
+function block_add($id = false, $block = false, $error = false)
 {
     global $_CLASS;
 
-    $id = false;
-
-	if (isset($_REQUEST['id']) &amp;&amp; $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+		$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		if (!$block)
 		{
-			url_redirect(generate_link('blocks', array('admin' =&gt; true)));
+			return;
 		}
 
-		check_position($block['position']);
+		check_position($block['block_position']);
 
 		if (isset($_POST['submit']))
 		{
 			// need to re-validate data with the db type
-			block_get_data($block_post, $error, $block['type']);
+			block_get_data($block_post, $error, $block['block_type']);
 			$block = array_merge($block, $block_post);
 		}
 
@@ -247,38 +223,38 @@
 	$b_show_content = $b_file = $b_rss_show = $b_rss_rate = $b_rss_url = false;
 	$b_header = $_CLASS['core_user']-&gt;lang['ADD_NEW'];
 
-	switch ($block['type'])
+	switch ($block['block_type'])
 	{
 		case BLOCKTYPE_HTML:
 			$b_show_content = true;
 		break;
 
 		case BLOCKTYPE_FILE:
-			$b_file = block_select($block['file']);
+			$b_file = block_select($block['block_file']);
 		break;
 
 		case BLOCKTYPE_FEED:
 			$b_rss_show = true;
-			$b_rss_rate = ($block['rss_rate']) ? $block['rss_rate'] : 3600; // 1hr defualt
-			$b_rss_url = ($block['rss_url']) ? $block['rss_url'] : '';
+			$b_rss_rate = ($block['block_rss_rate']) ? $block['block_rss_rate'] : 3600; // 1hr defualt
+			$b_rss_url = ($block['block_rss_url']) ? $block['block_rss_url'] : '';
 		break;
 	}
 
-	$_CLASS['core_template']-&gt;assign(array(
-		'B_ACTION'		=&gt; generate_link('blocks&amp;mode=save&amp;type='.$block['type'].(($id) ? '&amp;id='.$id : ''), array('admin' =&gt; true)),
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'B_ACTION'		=&gt; generate_link('blocks&amp;mode=save&amp;type='.$block['block_type'].(($id) ? '&amp;id='.$id : ''), array('admin' =&gt; true)),
 		'B_HEADER'		=&gt; $b_header,
-		'B_TITLE'		=&gt; $block['title'],
+		'B_TITLE'		=&gt; $block['block_title'],
 		'B_FILE' 		=&gt; $b_file,
-		'B_POSITION'	=&gt; block_position_select($block['position']),
-		'B_ACTIVE'		=&gt; $block['active'],
+		'B_POSITION'	=&gt; block_position_select($block['block_position']),
+		'B_ACTIVE'		=&gt; $block['block_status'],
 		'B_SHOW_CONTENT'=&gt; $b_show_content,
-		'B_CONTENT'		=&gt; $block['content'],
+		'B_CONTENT'		=&gt; $block['block_content'],
 		'B_RSS_SHOW'	=&gt; $b_rss_show,
 		'B_RSS_REFRESH'	=&gt; $b_rss_rate,
 		'B_RSS_URL'		=&gt; $b_rss_url,
 		'B_ERROR'		=&gt; $error,
-		'B_EXPIRES'		=&gt; is_numeric($block['expires']) ? $_CLASS['core_user']-&gt;format_date($block['expires'], 'M d, Y h:i a') : $block['expires'],
-		'B_STARTS'		=&gt; is_numeric($block['start']) ? $_CLASS['core_user']-&gt;format_date($block['start'], 'M d, Y h:i a') : $block['start'],
+		'B_EXPIRES'		=&gt; is_numeric($block['block_expires']) ? $_CLASS['core_user']-&gt;format_date($block['block_expires'], 'M d, Y h:i a') : $block['block_expires'],
+		'B_STARTS'		=&gt; is_numeric($block['block_starts']) ? $_CLASS['core_user']-&gt;format_date($block['block_starts'], 'M d, Y h:i a') : $block['block_starts'],
 		'B_CURRENT_TIME'=&gt; $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;time),
 	));
 
@@ -335,33 +311,33 @@
 	$error = '';
 	$data = array();
 
-	$data['title'] = get_variable('b_title', 'POST', '');
+	$data['block_title'] = get_variable('b_title', 'POST', '');
 
 	// leave here for mods, maybe !
 	foreach ($data as $field =&gt; $value)
 	{
 		if (!$value)
 		{
-			$error .= $_CLASS['core_user']-&gt;lang['ERROR_'.$field].'&lt;br /&gt;';
+			$error .= $_CLASS['core_user']-&gt;get_lang('ERROR_'.$field).'&lt;br /&gt;';
 		}
 	}
 
-	$data['position'] = get_variable('b_position', 'POST', false, 'integer');
+	$data['block_position'] = get_variable('b_position', 'POST', false, 'integer');
 
-	if (!$data['position'] || !check_position($data['position'], false))
+	if (!$data['block_position'] || !check_position($data['block_position'], false))
 	{
-		$data['position'] = BLOCK_RIGHT;
+		$data['block_position'] = BLOCK_RIGHT;
 	}
 
-	$data['active'] = (int) get_variable('b_active', 'POST', 0);
-	$data['expires'] = get_variable('b_expires', 'POST', '');
-	$data['start'] = get_variable('b_time', 'POST', '');
+	$data['block_status'] = (int) get_variable('b_active', 'POST', 0);
+	$data['block_expires'] = get_variable('b_expires', 'POST', '');
+	$data['block_starts'] = get_variable('b_time', 'POST', '');
 
 	$start = $expires = '';
 
-	if ($data['start'])
+	if ($data['block_starts'])
 	{
-		$start = strtotime($data['start']);
+		$start = strtotime($data['block_starts']);
 
 		if (!$start || $start == -1)
 		{
@@ -369,9 +345,9 @@
 		}
 	}
 
-	if ($data['expires'])
+	if ($data['block_expires'])
 	{
-		$expires = strtotime($data['expires']);
+		$expires = strtotime($data['block_expires']);
 
 		if (!$expires || $expires == -1)
 		{
@@ -380,22 +356,22 @@
 	}
 
 	$appoved_types = array(BLOCKTYPE_FILE, BLOCKTYPE_FEED, BLOCKTYPE_HTML, BLOCKTYPE_SYSTEM);
-	$data['type'] = ($type) ? (int) $type : (int) get_variable('b_type', 'REQUEST', BLOCKTYPE_FILE);
+	$data['block_type'] = ($type) ? (int) $type : (int) get_variable('b_type', 'REQUEST', BLOCKTYPE_FILE);
 
-	if (!in_array($data['type'], $appoved_types, true))
+	if (!in_array($data['block_type'], $appoved_types, true))
 	{
-		$data['type'] = BLOCKTYPE_FILE;
+		$data['block_type'] = BLOCKTYPE_FILE;
 	}
 
-	$data['content'] = '';
+	$data['block_content'] = '';
 
-	switch ($data['type'])
+	switch ($data['block_type'])
 	{
 		case BLOCKTYPE_HTML:
 			//$data['content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '&lt;br/&gt;');
-			$data['content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '');
+			$data['block_content'] = modify_lines(trim(get_variable('b_content', 'POST', '')), '');
 
-			if (strlen($data['content']) &lt; 6)
+			if (mb_strlen($data['block_content']) &lt; 6)
 			{
 				$error .= $_CLASS['core_user']-&gt;lang['ERROR_content'].'&lt;br /&gt;';
 			}
@@ -403,20 +379,20 @@
 		
 		case BLOCKTYPE_FILE:
 			// Add a file check here
-			$data['file'] = trim(get_variable('b_file', 'POST', ''));
+			$data['block_file'] = trim(get_variable('b_file', 'POST', ''));
 		break;
 		
 		case BLOCKTYPE_FEED:
 			// Add an url rss check here
-			$data['rss_url'] = get_variable('b_url', 'POST', '');
-			$data['rss_rate'] = get_variable('b_refresh', 'POST', '');
+			$data['block_rss_url'] = get_variable('b_url', 'POST', '');
+			$data['block_rss_rate'] = get_variable('b_refresh', 'POST', '');
 		break;
 	}
 
 	if (!$error)
 	{
-		$data['start'] = ($start) ? $_CLASS['core_user']-&gt;time_convert($start, 'gmt') : 0;
-		$data['expires'] = ($expires) ? $_CLASS['core_user']-&gt;time_convert($expires, 'gmt') : 0;
+		$data['block_starts'] = ($start) ? $_CLASS['core_user']-&gt;time_convert($start, 'gmt') : 0;
+		$data['block_expires'] = ($expires) ? $_CLASS['core_user']-&gt;time_convert($expires, 'gmt') : 0;
 	}
 }
 
@@ -451,38 +427,38 @@
 	return $block_position;
 }
 
-function block_save()
+function block_save($id = false)
 {
 	global $_CLASS;
 	
-	if (isset($_REQUEST['id']) &amp;&amp; $id = get_id())
+	if ($id)
 	{
-		$result = $_CLASS['core_db']-&gt;query('SELECT weight, position, type FROM '.BLOCKS_TABLE.' WHERE id = '.$id);
+		$result = $_CLASS['core_db']-&gt;query('SELECT block_order, block_position, block_type FROM '.BLOCKS_TABLE.' WHERE block_id = '.$id);
 		$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 		
 		if (!$block)
 		{	
-			url_redirect(generate_link('blocks', array('admin' =&gt; true)));
+			return;
 		}
 
-		check_position($block['position']);
+		check_position($block['block_position']);
 		// need to validate data with the db type
-		block_get_data($data, $error, $block['type']);
-		
+		block_get_data($data, $error, $block['block_type']);
+
 		if ($error)
 		{
-			return block_add($data, $error);
+			return block_add($id, $data, $error);
 		}
 
-		//update old position weight if new position is not the same
-		if ($block['position'] != $data['position'])
+		//update old position order if new position is not the same
+		if ($block['block_position'] != $data['block_position'])
 		{
 			// Make an error msg, just incase this fails for some reason
-			blocks_change_position($data['position'], $id);
+			blocks_change_position($data['block_position'], $id);
 		}
 		
-		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $data) .'  WHERE id = '.$id;
+		$sql = 'UPDATE '.BLOCKS_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $data) .'  WHERE block_id = '.$id;
 	}
 	else
 	{
@@ -490,14 +466,14 @@
 
 		if ($error)
 		{
-			return block_add($data, $error);
+			return block_add(false, $data, $error);
 		}
-		
-		$result = $_CLASS['core_db']-&gt;query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position = '.$data['position']);
-		$maxweight = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+
+		$result = $_CLASS['core_db']-&gt;query('SELECT MAX(block_order) as block_order FROM '.BLOCKS_TABLE.' WHERE block_position = '.$data['block_position']);
+		list($max_order) = $_CLASS['core_db']-&gt;fetch_row_num($result);
 		$_CLASS['core_db']-&gt;free_result($result);
 				
-		$data['weight'] = (int) $maxweight['weight'] + 1;
+		$data['block_order'] = (int) $max_order + 1;
 		
 		$sql = 'INSERT INTO '.BLOCKS_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $data);
 	}

Modified: trunk/admin/bots.php
===================================================================
--- trunk/admin/bots.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/bots.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,88 +1,73 @@
 &lt;?php
 
-$option = get_variable('option', 'GET', false);
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
 $id = (int) get_variable('id', 'GET', false);
 
-switch ($option)
+if ($id &amp;&amp; isset($_REQUEST['option']))
 {
-	case 'activate':
+	require_once($site_file_root.'includes/functions_user.php');
 
-		if ($id)
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . '
-				SET user_type = '.USER_BOT_ACTIVE.'
-				WHERE user_type = '.USER_BOT_INACTIVE.' AND user_id ='.$id;
-			$_CLASS['core_db']-&gt;sql_query($sql);
-		}
+	switch ($_REQUEST['option'])
+	{
+		case 'activate':
+			user_activate($id);
 		break;
 
-	case 'deactivate':
-
-		if ($id)
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . '
-				SET user_type = '.USER_BOT_INACTIVE.'
-				WHERE user_type = '.USER_BOT_ACTIVE.' AND user_id ='.$id;
-			$_CLASS['core_db']-&gt;sql_query($sql);
-		}
+		case 'deactivate':
+			user_disable($id);
 		break;
-
-	case 'delete':
-
-		if ($id)
-		{
-			$sql = 'SELECT user_id, user_type
-				FROM ' . USERS_TABLE . ' 
-				WHERE user_id = '.$id;
-
-			$result = $_CLASS['core_db']&gt;sql_query($sql);
-			$row = $_CLASS['core_db']&gt;sql_fetchrow($result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-			if (!in_array($row['user_type'], array(USER_BOT_ACTIVE, USER_BOT_INACTIVE)))
+	
+		case 'delete':
+			if (display_confirmation())
 			{
-				continue;
+				$sql = 'SELECT user_id, user_type
+					FROM ' . USERS_TABLE . ' 
+					WHERE user_id = '.$id;
+	
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				$row = $_CLASS['core_db']&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+	
+				if ($row['user_type'] != USER_BOT)
+				{
+					break;
+				}
+	
+				user_delete($id);
+	
+				trigger_error($_CLASS['core_user']-&gt;lang['BOT_DELETED']);
 			}
-
-// remove permissions also
-			foreach (array(USERS_TABLE, USER_GROUP_TABLE) as $table)
-			{
-				$sql = &quot;DELETE FROM $table
-					WHERE user_id = $id&quot;;
-				$_CLASS['core_db']-&gt;sql_query($sql);
-			}
-
-			trigger_error($_CLASS['core_user']-&gt;lang['BOT_DELETED']);
-		}
 		break;
+	}
 }
 
-$sql = 'SELECT user_id, username, user_type, user_lastvisit 
+$sql = 'SELECT user_id, username, user_status, user_last_visit 
 	FROM ' . USERS_TABLE . ' u
-	WHERE user_type IN (' . USER_BOT_ACTIVE . ', ' . USER_BOT_INACTIVE . ')
-		ORDER BY user_lastvisit DESC';
+	WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
 
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
+$result = $_CLASS['core_db']-&gt;query($sql);
 
-while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 {
 	$_CLASS['core_template']-&gt;assign_vars_array('admin_bots', array(
-		'ACTIVE'		=&gt; ($row['user_type'] == USER_BOT_ACTIVE) ? true : false,
+		'ACTIVE'		=&gt; ($row['user_status'] == USER_ACTIVE),
 		'NAME'			=&gt; $row['username'],
-		'DELETE_LINK'	=&gt; generate_link('system&amp;mode=bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' =&gt; true)),
-		'STATUS_LINK'	=&gt; generate_link('system&amp;mode=bots&amp;option='.(($row['user_type'] == USER_BOT_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' =&gt; true)),
-		'EDIT_LINK'		=&gt; generate_link('system&amp;mode=bots&amp;options=edite&amp;id='.$row['user_id'], array('admin' =&gt; true)),
-		'LAST_VISIT'	=&gt; ($row['user_lastvisit']) ?  $_CLASS['core_user']-&gt;format_date($row['user_lastvisit']) : $_CLASS['core_user']-&gt;lang['BOT_NEVER'],
-		'L_STATUS'		=&gt; ($block['active']) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE'],
+		'DELETE_LINK'	=&gt; generate_link('bots&amp;option=delete&amp;id='.$row['user_id'], array('admin' =&gt; true)),
+		'STATUS_LINK'	=&gt; generate_link('bots&amp;option='.(($row['user_status'] == USER_ACTIVE) ? 'deactivate' :  'activate').'&amp;id='.$row['user_id'], array('admin' =&gt; true)),
+		'EDIT_LINK'		=&gt; generate_link('bots&amp;options=edite&amp;id='.$row['user_id'], array('admin' =&gt; true)),
+		'LAST_VISIT'	=&gt; ($row['user_last_visit']) ?  $_CLASS['core_user']-&gt;format_date($row['user_last_visit']) : $_CLASS['core_user']-&gt;lang['BOT_NEVER'],
+		'L_STATUS'		=&gt; ($row['user_status'] == USER_ACTIVE) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE'],
 	));
 }
 
-$_CLASS['core_db']-&gt;sql_freeresult($result);
+$_CLASS['core_db']-&gt;free_result($result);
 
 $_CLASS['core_template']-&gt;assign('ACTION', generate_link('system&amp;mode=bots', array('admin' =&gt; true))); 
 
-$_CLASS['core_display']-&gt;display_head();
-$_CLASS['core_template']-&gt;display('admin/system/bots.html');
-$_CLASS['core_display']-&gt;display_footer();
+$_CLASS['core_display']-&gt;display(false, 'admin/bots.html');
 
 ?&gt;
\ No newline at end of file

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/functions/block_functions.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -17,7 +17,7 @@
 {
 	global $_CLASS;
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT position, auth FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']-&gt;query('SELECT position, auth FROM ' . BLOCKS_TABLE . ' WHERE id='.$id);
 	$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 	
@@ -30,17 +30,26 @@
 	
 	check_position($block['position']);
 	
-	if ($auth = $_CLASS['core_auth']-&gt;generate_auth_options($block['auth']))
+	$_CLASS['core_display']-&gt;display_header();
+
+	$auth = $_CLASS['core_auth']-&gt;generate_auth_options($block['auth']);
+
+	if ($auth !== false)
 	{
-		$block['auth'] = ($auth === true) ? '' : $auth;
-		$auth = ($auth === true) ? '' : $_CLASS['core_db']-&gt;escape(serialize($auth));
-	
-		$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.&quot; SET auth = '$auth' WHERE id = $id&quot;);
+		if (is_null($auth))
+		{
+			$block['auth'] = $auth = '';
+		}
+		else
+		{
+			$block['auth'] = $auth;
+			$auth = $_CLASS['core_db']-&gt;escape(serialize($auth));
+		}
+
+		$_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . &quot; SET auth = '$auth' WHERE id = $id&quot;);
 		$_CLASS['core_cache']-&gt;destroy('blocks');
 	}
 	
-	$_CLASS['core_display']-&gt;display_header();
-	$_CLASS['core_auth']-&gt;generate_auth_options($block['auth'], true);
 	$_CLASS['core_display']-&gt;display_footer();
 }
 		
@@ -48,7 +57,7 @@
 {
 	global $_CLASS;
 	
-	$result = $_CLASS['core_db']-&gt;query('SELECT active, position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']-&gt;query('SELECT block_status, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
@@ -56,15 +65,16 @@
 	{
 		trigger_error('BLOCK_NOT_FOUND');
 	}
-	check_position($block['position']);
-	$active = ($block['active']) ? 0 : 1;
 
-	$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET active='.$active.' WHERE id='.$id);
+	check_position($block['block_position']);
+	$status = ($block['block_status']) ? 0 : 1;
 
+	$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_status = '.$status.' WHERE block_id = '.$id);
+
 	$_CLASS['core_cache']-&gt;destroy('blocks');
 }
 
-function block_weight($id, $option)
+function block_order($id, $option)
 {
 	global $_CLASS;
 
@@ -73,7 +83,7 @@
 		return;
 	}
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT position, weight FROM '.BLOCKS_TABLE.' WHERE id='. (int) $id);
+	$result = $_CLASS['core_db']-&gt;query('SELECT block_position, block_order FROM ' . BLOCKS_TABLE . ' WHERE block_id= ' . $id);
 	$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
@@ -82,47 +92,47 @@
 		trigger_error('BLOCK_NOT_FOUND');
 	}
 
-	check_position($block['position']);
-	$block['weight'] = (int) $block['weight'];
+	check_position($block['block_position']);
+	settype($block['block_order'], 'integer');
 
 	switch ($option)
 	{
 		case 'down':
 
-			$result = $_CLASS['core_db']-&gt;query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position='.$block['position']);
-			$maxweight = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$result = $_CLASS['core_db']-&gt;query('SELECT MAX(block_order) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			list($max_order) = $_CLASS['core_db']-&gt;fetch_row_num($result);
 			$_CLASS['core_db']-&gt;free_result($result);
 
-			if ($block['weight'] &lt; $maxweight['weight'])
+			if ($block['block_order'] &lt; $max_order)
 			{
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight='.($block['weight'] + 1));
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight='.($block['weight'] + 1).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position = '.$block['block_position'].' AND block_order='.($block['block_order'] + 1));
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.($block['block_order'] + 1).' WHERE block_id ='. $id);
 			}
 
 			$_CLASS['core_cache']-&gt;destroy('blocks');
 		break;
 
-		case 'up':
+		case 'bottom':
 
-			if ($block['weight'] &amp;&amp; $block['weight'] != 1)
+			$result = $_CLASS['core_db']-&gt;query('SELECT MAX(weight) as block_order FROM ' . BLOCKS_TABLE . ' WHERE block_position='.$block['block_position']);
+			list($max_order) = $_CLASS['core_db']-&gt;fetch_row_($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($block['block_order'] &lt; $max_order)
 			{
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=weight+1 WHERE position='.$block['position'].' AND weight='.($block['weight'] - 1));
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight='.($block['weight'] -1 ).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order &gt; '.$block['block_order']);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = '.$max_order.' WHERE block_id = '.$id);
 			}
 
 			$_CLASS['core_cache']-&gt;destroy('blocks');
 		break;
 
-		case 'bottom':
+		case 'up':
 
-			$result = $_CLASS['core_db']-&gt;query('SELECT MAX(weight) as weight FROM '.BLOCKS_TABLE.' WHERE position='.$block['position']);
-			$maxweight = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if ($block['weight'] &lt; $maxweight['weight'])
+			if ($block['block_order'] &amp;&amp; $block['weight'] != 1)
 			{
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight &gt; '.$block['weight']);
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight='.$maxweight['weight'].' WHERE id='.$id);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order = '.($block['block_order'] - 1));
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order='.($block['block_order'] -1 ).' WHERE block_id ='. $id);
 			}
 
 			$_CLASS['core_cache']-&gt;destroy('blocks');
@@ -130,10 +140,10 @@
 
 		case 'top':
 
-			if ($block['weight'] != 1)
+			if ($block['block_order'] != 1)
 			{
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=weight+1 WHERE position='.$block['position'].' AND weight &lt; '.$block['weight']);
-				$result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=1 WHERE id='.$id);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order+1 WHERE block_position='.$block['block_position'].' AND block_order &lt; '.$block['block_order']);
+				$result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = 1 WHERE block_id = '.$id);
 			}
 
 			$_CLASS['core_cache']-&gt;destroy('blocks');
@@ -141,46 +151,38 @@
 	}
 }
 
-function block_delete($id, $return_link = '')
+function block_delete($id, $return_link = false)
 {
     global $_CLASS;
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT weight, type, position FROM '.BLOCKS_TABLE.' WHERE id='.$id);
+	$result = $_CLASS['core_db']-&gt;query('SELECT block_order, block_type, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	if (!$block || ($block['type'] == BLOCKTYPE_SYSTEM))
+	if (!$block || ($block['block_type'] == BLOCKTYPE_SYSTEM))
 	{
 		trigger_error(($block) ? 'BLOCK_NOT_DELETABLE' : 'BLOCK_NOT_FOUND');
 	}
 
-	check_position($block['position']);
+	check_position($block['block_position']);
 
-// TEMP
-    if (get_variable('confirm', 'POST', false) == 'Delete')
+    if (display_confirmation())
     {
-        $result = $_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET weight=weight-1 WHERE position='.$block['position'].' AND weight &gt; '.$block['weight']);
-        $_CLASS['core_db']-&gt;query('DELETE from '.BLOCKS_TABLE.' where id='.$id);
+		$_CLASS['core_db']-&gt;query('DELETE from ' . BLOCKS_TABLE . ' where block_id='.$id);
+        $result = $_CLASS['core_db']-&gt;query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order &gt; '.$block['block_order']);
 
         $_CLASS['core_cache']-&gt;destroy('blocks');
         
-        trigger_error('Block deleted&lt;br/&gt;&lt;a href=&quot;'.generate_link($return_link, array('admin' =&gt; true)).'&quot;&gt;Click here to return&lt;/a&gt;');	        
-    }
-	else
+        if ($return_link)
+        {
+			trigger_error('Block deleted&lt;br/&gt;&lt;a href=&quot;'.$return_link.'&quot;&gt;Click here to return&lt;/a&gt;');	        
+		}
+	}
+	
+	if ($return_link)
 	{
-		$_CLASS['core_display']-&gt;display_header();
-		echo $_CLASS['core_display']-&gt;table_open;
-		
-		echo '&lt;form name=&quot;confirm&quot; action=&quot;&quot; method=&quot;post&quot;&gt;
-		&lt;center&gt;&lt;b&gt;If your certain that you want to remove this item click delete to continue&lt;br/&gt;';
-		echo '&lt;a href=&quot;'.generate_link($_CLASS['core_user']-&gt;url, array('admin' =&gt; true)).'&quot;&gt;Click here to return&lt;/a&gt;&lt;br/&gt;&lt;br/&gt;
-		&lt;input type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;Delete&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;Cancel&quot; class=&quot;button&quot; /&gt;
-		&lt;/center&gt;';
-
-		echo $_CLASS['core_display']-&gt;table_close;
-		
-        $_CLASS['core_display']-&gt;display_footer();
-    }
+		url_redirect($return_link);
+	}
 }
 
 ?&gt;
\ No newline at end of file

Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,7 +1,31 @@
 &lt;?php
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
 
-if (($cms_news = $_CLASS['core_cache']-&gt;get('cms_news')) === false)
+if (isset($_REQUEST['user_mode']) &amp;&amp; $_CLASS['core_auth']-&gt;admin_power('users') &amp;&amp; display_confirmation())
 {
+	require_once($site_file_root.'includes/functions_user.php');
+	$user_id = get_variable('id', 'REQUEST', false, 'integer');
+
+	if ($user_id)
+	{
+		switch ($_REQUEST['user_mode'])
+		{
+			case 'remove':
+				user_delete($user_id);
+			break;
+
+			case 'activate':
+				user_activate($user_id);
+			break;
+		}
+	}
+}
+
+if (is_null($cms_news = $_CLASS['core_cache']-&gt;get('cms_news')))
+{
 	$cms_news = array();
 	
 	load_class($site_file_root.'includes/core_rss.php', 'core_rss');
@@ -13,31 +37,52 @@
 			$cms_news[] = $data;
 		}
 	}
+
 	$_CLASS['core_cache']-&gt;put('cms_news', $cms_news, 43200);
 }
 
+$server_name = empty($_SERVER['SERVER_NAME']) ? getenv('SERVER_NAME') : $_SERVER['SERVER_NAME'];
+$server_addr = empty($_SERVER['SERVER_ADDR']) ? getenv('SERVER_ADDR') : $_SERVER['SERVER_ADDR'];
+$server_software = empty($_SERVER['SERVER_SOFTWARE']) ? getenv('SERVER_SOFTWARE') : $_SERVER['SERVER_SOFTWARE'];
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'core_version'		=&gt; 'CMS Apha 1',
+	'server_host'		=&gt; ($server_name) ? $server_name.&quot; ( $server_addr )&quot;: 'N.A. ',
+	'server_software'	=&gt; ($server_software) ? $server_software : 'N.A. ',
+	'database_version'	=&gt; $_CLASS['core_db']-&gt;version(true),
+	'php_version'		=&gt; PHP_VERSION,
+));
+	
 $_CLASS['core_template']-&gt;assign('cms_news', $cms_news);
 
-$sql = 'SELECT user_id, username, user_regdate
-	FROM ' . USERS_TABLE . ' 
-	WHERE user_type = ' . USER_INACTIVE . ' 
-		ORDER BY user_regdate ASC';
-	
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+if ($_CLASS['core_auth']-&gt;admin_power('users'))
 {
-	$_CLASS['core_template']-&gt;assign_vars_array('admin_user', array(
-			'user_name'		=&gt; $row['username'],
-			'registered'	=&gt; $row['user_regdate'],
-			'active_link'	=&gt; '',
-	));
+	// seperate this
+	$sql = 'SELECT user_id, username, user_regdate
+		FROM ' . USERS_TABLE . '
+			WHERE user_type = '.USER_NORMAL.'
+			AND user_status IN (' . USER_DISABLE . ',  '.USER_UNACTIVATED.')';
+		
+	$result = $_CLASS['core_db']-&gt;query_limit($sql, 20);
+	
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$type = ($row['user_id'] == USER_DISABLE) ? 'users_disabled' : 'users_unactivated';
+	
+		$_CLASS['core_template']-&gt;assign_vars_array($type, array(
+				'user_id'		=&gt; $row['user_id'],
+				'user_name'		=&gt; $row['username'],
+				'registered'	=&gt; $_CLASS['core_user']-&gt;format_time($row['user_regdate']),
+				'link_profile'	=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+				'link_activate'	=&gt; generate_link('&amp;user_mode=activate&amp;id=' . $row['user_id'], array('admin' =&gt; true)),
+				'link_remove'	=&gt; generate_link('&amp;user_mode=remove&amp;id=' . $row['user_id'], array('admin' =&gt; true)),
+				'link_remind'	=&gt; generate_link('&amp;user_mode=remind&amp;id=' . $row['user_id'], array('admin' =&gt; true)),
+				'link_details'	=&gt; '',
+		));
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
 }
 
-$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-$_CLASS['core_display']-&gt;display_head();
 $_CLASS['core_template']-&gt;display('admin/index.html');
-$_CLASS['core_display']-&gt;display_footer();
 
 ?&gt;
\ No newline at end of file

Modified: trunk/admin/system.php
===================================================================
--- trunk/admin/system.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin/system.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -9,57 +9,34 @@
 
 $_CLASS['core_user']-&gt;add_lang('admin/system.php');
 
-$_CLASS['core_template']-&gt;assign(array(
-	'A_L_SITE'		=&gt; generate_link('system&amp;mode=site', array('admin' =&gt; true)),
-	'A_L_WYSIWYG'	=&gt; generate_link('system&amp;mode=wysiwyg', array('admin' =&gt; true)),
-	'A_L_SYSTEM'	=&gt; generate_link('system&amp;mode=system', array('admin' =&gt; true)),
-	'A_L_USERS'		=&gt; generate_link('system&amp;mode=users', array('admin' =&gt; true)),
-));
-
-$option = array(
-	'Site' =&gt; array(
-			'lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SITE')),
-	'system' =&gt; array(
-			'lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SYSTEM')),
-	'users' =&gt; array(
-			'lang' =&gt; $_CLASS['core_user']-&gt;get_lang('USERS_OPTIONS')),
-);
-
 $mode =	get_variable('mode', 'GET', false);
 
-if (!$mode || !in_array($mode, array_keys($option)))
+if (!$mode || !in_array($mode, array('Site', 'system')))
 {
-	$mode = 'Site';
+	$mode = 'site';
 }
 
-foreach ($option as $option_mode =&gt; $settings)
-{
-	$_CLASS['core_template']-&gt;assign_vars_array('a_options', array(
-		'ACTIVE'	=&gt; ($option_mode == $mode) ? true : false,
-		'LANG'		=&gt; $settings['lang'],
-		'LINK'		=&gt; generate_link('system&amp;mode='.$option_mode, array('admin' =&gt; true)),
-	));
-}
+$_CLASS['core_template']-&gt;assign_array(array(
+	'LINK_SITE'		=&gt; generate_link('system&amp;mode=site', array('admin' =&gt; true)),
+	'LINK_SYSTEM'	=&gt; generate_link('system&amp;mode=system', array('admin' =&gt; true)),
+	'SYSTEM_MODE'	=&gt; $mode,
+));
 
 $save = (isset($_POST['submit'])) ? true : false;
 
 switch ($mode)
 {
-	case 'Site':
+	case 'site':
 		admin_site($save);
-		break;
+	break;
 
-	case 'wysiwyg':
-		admin_wysiwyg($save);
-		break;
-
 	case 'users':
-		admin_users($save);
-		break;
+		//admin_users($save);
+	break;
 
 	case 'system':
 		admin_system($save);
-		break;
+	break;
 }
 
 function admin_save($data)
@@ -71,14 +48,14 @@
 		foreach ($option AS $db_name =&gt; $data_op)
 		{
 			$value = get_variable($data_op['post_name'], 'POST', false);
-	
+
 			if ($value != $_CORE_CONFIG[$section][$db_name])
 			{
-				//echo $data_op['post_name'].' : '. $db_name.' : '.$value.'&lt;br/&gt;';
 				set_core_config($section, $db_name, $value, false);
 			}
 		}
     }
+
 	$_CLASS['core_cache']-&gt;destroy('core_config');
 }
 
@@ -101,17 +78,15 @@
 
 	global $_CLASS, $_CORE_CONFIG;
 
-	$_CLASS['core_template']-&gt;assign(array(
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'A_OPTION'		=&gt; 'site',
 		'ACTION'		=&gt; generate_link('system', array('admin' =&gt; true)),
 		
 		'DEFAULT_THEME' 	=&gt; $_CORE_CONFIG['global']['default_theme'],
 		'LINK_OPTIMIZATION' =&gt; $_CORE_CONFIG['global']['link_optimization'],
-		'SITE_LOGO'			=&gt; $_CORE_CONFIG['global']['site_logo'],
 		'SITE_NAME'			=&gt; $_CORE_CONFIG['global']['site_name'],
 		'SITE_URL'			=&gt; $_CORE_CONFIG['global']['site_url'],
-		'SLOGAN'			=&gt; $_CORE_CONFIG['global']['slogan'],
-		'START_DATE'		=&gt; $_CORE_CONFIG['global']['startdate'],
+		'START_DATE'		=&gt; $_CORE_CONFIG['global']['start_date'],
 
 		'FOOTER_FIRST' 		=&gt; $_CORE_CONFIG['global']['foot1'],
 		'FOOTER_SECOND' 	=&gt; $_CORE_CONFIG['global']['foot2'],
@@ -136,9 +111,7 @@
 	
 	closedir($handle);
 
-	$_CLASS['core_display']-&gt;display_head();
 	$_CLASS['core_template']-&gt;display('admin/system/index.html');
-	$_CLASS['core_display']-&gt;display_footer();
 }
 
 function admin_system($save)
@@ -174,7 +147,7 @@
 	
 	global $_CLASS, $_CORE_CONFIG;
    
-    $_CLASS['core_template']-&gt;assign(array(
+    $_CLASS['core_template']-&gt;assign_array(array(
 		'A_OPTION' 			=&gt; 'system',
 		'ACTION'			=&gt; generate_link('system&amp;mode=system', array('admin' =&gt; true)),
 		
@@ -197,9 +170,7 @@
 		
 		));
 
-	$_CLASS['core_display']-&gt;display_head();
 	$_CLASS['core_template']-&gt;display('admin/system/index.html');
-	$_CLASS['core_display']-&gt;display_footer();
 }
 
 function admin_users($save)
@@ -229,7 +200,7 @@
 
 	global $_CLASS, $_CORE_CONFIG;
 
-    $_CLASS['core_template']-&gt;assign(array(
+    $_CLASS['core_template']-&gt;assign_array(array(
 		'A_OPTION' =&gt; 'users',
 		'ACTION' =&gt; generate_link('system&amp;mode=users', array('admin' =&gt; true)),
 		'L_EDITOR_OPTION' =&gt; $_CLASS['core_user']-&gt;lang['EDITOR_OPTION'],
@@ -270,9 +241,7 @@
 			))
 		));
 
-		$_CLASS['core_display']-&gt;display_head();
 		$_CLASS['core_template']-&gt;display('admin/system/index.html');
-		$_CLASS['core_display']-&gt;display_footer();
 }
 
 ?&gt;
\ No newline at end of file

Modified: trunk/admin.php
===================================================================
--- trunk/admin.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/admin.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -91,13 +91,13 @@
 $_CORE_MODULE['sides'] = BLOCK_ALL;
 	
 $_CLASS['core_blocks']-&gt;add_block(array(
-		'title'		=&gt; 'Administration',
-		'position'	=&gt; BLOCK_LEFT,
-		'file'		=&gt; 'block-Admin.php',
+		'block_title'		=&gt; 'Administration',
+		'block_position'	=&gt; BLOCK_LEFT,
+		'block_file'		=&gt; 'block-Admin.php',
 	));
 
-load_class($site_file_root.'includes/core_editor.php', 'core_editor');
-$_CLASS['core_editor']-&gt;setup();
+//load_class($site_file_root.'includes/core_editor.php', 'core_editor');
+//$_CLASS['core_editor']-&gt;setup();
 require($file_path);
     
 ?&gt;
\ No newline at end of file

Modified: trunk/blocks/block-Quick_Message.php
===================================================================
--- trunk/blocks/block-Quick_Message.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/blocks/block-Quick_Message.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,92 +1,107 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 if (!defined('VIPERAL'))
 {
     die;
 }
 
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+}
+
 global $prefix, $_CLASS, $_CORE_CONFIG;
 
 $this-&gt;content = '&lt;div style=&quot;width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;&quot;&gt;';
 
-$result = $_CLASS['core_db']-&gt;query_limit('SELECT * from '.$prefix.'quick_message ORDER BY time DESC', 10);
+$result = $_CLASS['core_db']-&gt;query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
 
 while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 {
-	$words_array = explode(' ',html_entity_decode($row['message'], ENT_QUOTES, 'UTF-8'));
-	$row['message'] = '';
+	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
+	$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES));
 
+	$row['message_text'] = '';
+
     foreach($words_array as $words)
     {
 		if (substr($words, 0, 4) != '[url')
 		{
-			$row['message'] .= ' '.wordwrap($words, 18, &quot;\n&quot;, 1);
+			$row['message_text'] .= ' '.wordwrap($words, 18, &quot;\n&quot;, 1);
 		}
 		else
 		{
-			$row['message'] .= $words;
+			$row['message_text'] .= $words;
 		}
     }
 
-	htmlentities($row['message'], ENT_QUOTES, 'UTF-8');
+	htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
 
 	unset($words_array, $words);
 	
 	$this-&gt;content .= '&lt;div style=&quot;padding: 4px;&quot;&gt;';
 	
-	if ($row['user_name'])
+	if ($row['poster_name'])
 	{
-		if ($row['user_id']) 
+		if ($row['poster_id']) 
 		{
-			$this-&gt;content .= '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'&quot;&gt;&lt;b&gt;' . $row['user_name'] . ': &lt;/b&gt;&lt;/a&gt;';
+			$this-&gt;content .= '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'&quot;&gt;&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;&lt;/a&gt;';
 		}
 		else
 		{
-			$this-&gt;content .= '&lt;b&gt;' . $row['user_name'] . ': &lt;/b&gt;'; 
+			$this-&gt;content .= '&lt;b&gt;' . $row['poster_name'] . ': &lt;/b&gt;'; 
 		}
 	}
 	else
 	{
 		$this-&gt;content .= '&lt;b&gt;' . $_CLASS['core_user']-&gt;lang['ANONYMOUS'] . ': &lt;/b&gt;';
 	}
-	
-	if ($row['user_id'])
+
+	if ($row['poster_id'])
 	{
-		$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message']);
+		$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message_text']);
 	}
-	
-	$this-&gt;content .= $row['message'].'&lt;br /&gt;'.(($_CORE_CONFIG['quick_message']['time']) ? $_CLASS['core_user']-&gt;format_date($row['time']) : '').'&lt;/div&gt;&lt;hr/&gt;';
+
+	$this-&gt;content .= $row['message_text'].'&lt;br /&gt;'. $_CLASS['core_user']-&gt;format_date($row['message_time']) .'&lt;/div&gt;&lt;hr/&gt;';
 }
 
 $_CLASS['core_db']-&gt;free_result($result);
 
-$this-&gt;content .= '&lt;/div&gt;';
+$this-&gt;content .= '&lt;/div&gt;&lt;div align=&quot;center&quot;&gt;&lt;a href=&quot;'.generate_link('Quick_Message').'&quot;&gt;Message History&lt;/a&gt;&lt;br /&gt;';
 
-$this-&gt;content .= '&lt;form name=&quot;post&quot; method=&quot;post&quot; action=&quot;'.generate_link('Quick_Message&amp;mode=add').'&quot; enctype=&quot;multipart/form-data&quot;&gt;'
-				.'		&lt;div align=&quot;center&quot;&gt;&lt;a href=&quot;'.generate_link('Quick_Message').'&quot;&gt;Message History&lt;/a&gt;&lt;br /&gt;';
-if (!$_CLASS['core_user']-&gt;is_user) 
+if (!$_CLASS['core_user']-&gt;is_user &amp;&amp; !$_CORE_CONFIG['quick_message']['anonymous_posting'])
 {
-	if ( !$_CORE_CONFIG['quick_message']['allow_anonymous'] )
-	{
-		$this-&gt;content .= 'Only registered users can post&lt;br /&gt;&lt;a href=&quot;'.generate_link('Control_Panel&amp;mode=register').'&quot;&gt;[ Register&nbsp;|&nbsp;&lt;/a&gt;&lt;a href=&quot;'.generate_link('Control_Panel').'&quot;&gt;Login ]&lt;/a&gt;&lt;br /&gt;&lt;/div&gt;
-		';
-		return;
-	} elseif ( $_CORE_CONFIG['quick_message']['allow_anonymous'] == '2') {
-		$this-&gt;content .= 'Name: &lt;br /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; style=&quot;width:90%;&quot; name=&quot;user_name&quot; size=&quot;10&quot; maxlength=&quot;10&quot; /&gt;&lt;br /&gt;';
-	}
+	$this-&gt;content .= '&lt;br/&gt;Only registered users can post&lt;br /&gt;[ &lt;a href=&quot;'.generate_link('Control_Panel&amp;mode=register').'&quot;&gt;Register&lt;/a&gt;&nbsp;|&nbsp;&lt;a href=&quot;'.generate_link('Control_Panel').'&quot;&gt;Login&lt;/a&gt; ]&lt;br /&gt;&lt;/div&gt;';
+
+	return;
 }
 
+$this-&gt;content .= '&lt;form name=&quot;post&quot; method=&quot;post&quot; action=&quot;'.generate_link('Quick_Message&amp;mode=add').'&quot;&gt;';
+
+if (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
+{
+	$this-&gt;content .= 'Name: &lt;br /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; style=&quot;width:90%;&quot; name=&quot;poster_name&quot; size=&quot;10&quot; maxlength=&quot;10&quot; /&gt;&lt;br /&gt;';
+}
+
 $this-&gt;content .= 'Message &lt;br/&gt; &lt;textarea name=&quot;message&quot; style=&quot;width:90%;&quot; rows=&quot;3&quot;&gt;&lt;/textarea&gt;&lt;br /&gt;&lt;br /&gt;
 			&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Post&quot; /&gt;
 		&lt;/div&gt;&lt;/form&gt;';

Modified: trunk/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/auth/auth.php
===================================================================
--- trunk/includes/auth/auth.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,20 +1,29 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class core_auth
 {
 	var $_user_id;
-	var $_group_id;
+	var $_group_ids = array();
+	var $_group_default_id;
 
 	var $_got_data = false;
 	var $_admin_permission = array();
@@ -24,7 +33,7 @@
 		global $_CLASS;
 
 		$this-&gt;_user_id = ($user_id) ? $user_id : $_CLASS['core_user']-&gt;data['user_id'];
-		$this-&gt;_group_id = ($group_id) ? $group_id : $_CLASS['core_user']-&gt;data['group_id'];
+		$this-&gt;_group_default_id = ($group_id) ? $group_id : $_CLASS['core_user']-&gt;data['group_id'];
 	}
 
 	function user_auth($user_name, $user_password)
@@ -69,30 +78,31 @@
 	{
 		global $_CLASS;
 
-		$sql = 'SELECT * FROM ' . AUTH_ADMIN_TABLE .&quot; 
-					WHERE user_id = {$this-&gt;_user_id}
-					OR group_id = {$this-&gt;_group_id} ORDER BY user_id&quot;;
+// should this be extended for defualt groups only, and all in group ?
+		$sql = 'SELECT * FROM ' . ADMIN_AUTH_TABLE .&quot; 
+					WHERE member_user_id = {$this-&gt;_user_id}
+					OR member_group_id = {$this-&gt;_group_default_id} ORDER BY member_user_id&quot;;
 
 		$result = $_CLASS['core_db']-&gt;query($sql);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			if ($row['status'] == STATUS_PENDING)
+			if ($row['admin_status'] == STATUS_PENDING)
 			{
 				continue;
 			}
 
-			if (!isset($this-&gt;_admin_permission[$row['section']]))
+			if (!isset($this-&gt;_admin_permission[$row['admin_section']]))
 			{
-				$this-&gt;_admin_permission[$row['section']]['core']['status'] = $row['status'];
+				$this-&gt;_admin_permission[$row['admin_section']]['core']['status'] = $row['admin_status'];
 
-				if ($row['options'] &amp;&amp; is_array($row['options'] = @unserialize($row['options'])))
+				if (trim($row['admin_options']) &amp;&amp; is_array($row['admin_options'] = @unserialize($row['admin_options'])))
 				{
 					$this-&gt;_admin_permission[$row['section']] = $row['options'];
 				}
 			}
 		}
-	
+
 		$this-&gt;_got_data = true;
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
@@ -166,13 +176,7 @@
 
 				if (is_numeric($result))
 				{
-					$data = array(
-						'admin_login'		=&gt; $login_array['admin_login'],
-						'auto_log'			=&gt; (!empty($_POST['autologin'])) ? true : false,
-						'show_online'		=&gt; (!empty($_POST['viewonline'])) ? 0 : 1,
-					);
-			
-					$_CLASS['core_user']-&gt;login($result, $data['admin_login'], $data['show_online']);
+					$_CLASS['core_user']-&gt;login($result, $login_array['admin_login'], !empty($_POST['hidden']), !empty($_POST['auto_login']));
 
 					$login_array['redirect'] = generate_link(get_variable('redirect', 'POST', $login_array['redirect']), array('admin' =&gt; $data['admin_login']));	
 
@@ -203,7 +207,7 @@
 			$confirm_image = false;
 		}
 
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'LOGIN_ERROR'			=&gt; $_CLASS['core_user']-&gt;get_lang($error),
 			'LOGIN_EXPLAIN'			=&gt; $_CLASS['core_user']-&gt;get_lang($login_array['explain']), 
 
@@ -221,9 +225,9 @@
 			'S_HIDDEN_FIELDS' 		=&gt; $s_hidden_fields,
 		));
 
-		if ($login_array['full_screen'])
+		if (!$template &amp;&amp; $login_array['full_screen'])
 		{
-			$_CLASS['core_template']-&gt;display('login_body_full.html');
+			$template = 'login_body_full.html';
 		}
 
 		$_CLASS['core_template']-&gt;display(($template) ? $template : 'login_body.html');
@@ -235,57 +239,64 @@
 
 	}
 
-	function auth($data)
+	function auth($options_array, $option = 'core_status')
 	{
 		global $_CLASS;
 
-		if (!$data)
+		if (!$options_array || (empty($options_array['groups']) &amp;&amp; empty($options_array['users'])))
 		{
 			return true;
 		}
 
-		if (empty($data['users_allowed']) &amp;&amp; empty($data['groups_allowed']))
+		if (isset($options_array['users'][$this-&gt;_user_id]))
 		{
+			return (isset($options_array['users'][$this-&gt;_user_id][$option]) ? $options_array['users'][$this-&gt;_user_id][$option] : false);
+		}
+
+		if (!empty($options_array['groups'][1]))
+		{
 			$return = true;
 
-			if (!empty($data['users_disallowed']) &amp;&amp; in_array($this-&gt;_user_id, $data['users_disallowed']))
+			// need to sort/seperate this so that Only Default goups are first
+			foreach ($options_array['groups'][1] as $id =&gt; $group_options)
 			{
-				$return = false;
+				if ($id == $this-&gt;_group_default_id)
+				{
+					return (isset($group_options[$option]) ? $group_options[$option] : false);
+				}
 			}
+		}
 
-			if ($return &amp;&amp; !empty($data['groups_disallowed']) &amp;&amp; in_array($this-&gt;_group_id, $data['groups_disallowed']))
-			{
-				$return = false;
-			}
-
-			return $return;
-		}
-		else
+		if (!empty($options_array['groups'][0]))
 		{
-			if (!empty($data['users_allowed']) &amp;&amp; in_array($this-&gt;_user_id, $data['users_allowed']))
+			//get the ids for all the groups
+			$ids = array_keys($options_array['groups'][0]);
+			//remove the groups that the user isn't a member of
+			$ids = array_intersect($ids, $this-&gt;__group_ids);
+			// need to sort/seperate this so that Only Default goups are first
+			foreach ($ids as $id)
 			{
-				return true;
-			}
-	
-			if (!empty($data['groups_allowed']) &amp;&amp; in_array($this-&gt;_group_id, $data['groups_allowed']))
-			{
-				if (empty($data['users_disallowed']) || !in_array($this-&gt;_user_id, $data['users_disallowed']))
+// will need some sort of ordering if the option is not regular  true/false (0/1)
+				// if the option is not false, return it. The user has permission
+				if (!empty($options_array['groups'][0][$id][$option]))
 				{
-					return true;
+					return $group_options[$option];
 				}
 			}
+		}
 
-			return false;
-		}
+		return false;
 	}
 
-	function generate_auth_options($options = array(), $options_extend = false, $return_link = false)
+	function generate_auth_options($auth_options = array(), $options_extend = false, $return_link = false)
 	{
 		global $_CLASS, $site_file_root;
 
-		$options['groups'] = empty($options['groups']) ? array() : $options['groups'];
-		$options['users'] = empty($options['users']) ? array() : $options['users'];
+		$auth_options['groups'][0] = empty($auth_options['groups'][0]) ? array() : $auth_options['groups'][0];
+		$auth_options['groups'][1] = empty($auth_options['groups'][1]) ? array() : $auth_options['groups'][1];
 
+		$auth_options['users'] = empty($auth_options['users']) ? array() : $auth_options['users'];
+
 		$mode = $return = false;
 		$checks = array('add', 'remove', 'set');
 		
@@ -309,6 +320,8 @@
 					$setup['groups'] = get_variable('groups_add', 'POST', array(), 'array');
 					$setup['users'] = explode(&quot;\n&quot;, get_variable('users_add', 'POST'));
 
+					$submited_options = get_variable('auth_options', 'POST', array(), 'array');
+
 					if (count($setup['users']))
 					{
 						$setup['users'] = user_get_id($setup['users']);
@@ -332,16 +345,16 @@
 
 					foreach ($setup['groups'] as $id)
 					{
-						$options['groups'][$id] = array('status' =&gt; 1);
+						$auth_options['groups'][$submited_options['core_auth_type']][$id] = array('core_status' =&gt; $submited_options['core_status']);
 					}
 
 					foreach ($setup['users'] as $id)
 					{
-						$options['users'][$id] = array('status' =&gt; 1);
+						$auth_options['users'][$id] = array('core_status' =&gt; $submited_options['core_status']);
 					}
 
 					unset($setup);
-					//print_r($options);
+					//print_r($auth_options); die;
 				break;
 
 				case 'remove':
@@ -350,23 +363,30 @@
 					
 					$function = ($mode == 'add') ? 'array_merge' : 'array_diff';
 
-					foreach ($options['groups'] as $key =&gt; $ignore)
+// We need to tell with is only group and with is in group.
+
+					foreach ($ids['groups'] as $groups_id)
 					{
-						if (in_array($key, $ids['groups']))
+						if (isset($auth_options['groups'][1][$groups_id]))
 						{
-							unset($options['groups'][$key]);
+							unset($auth_options['groups'][1][$groups_id]);
 						}
+
+						if (isset($auth_options['groups'][0][$groups_id]))
+						{
+							unset($auth_options['groups'][0][$groups_id]);
+						}
 					}
 
-					foreach ($options['users'] as $key =&gt; $ignore)
+					foreach ($auth_options['users'] as $key =&gt; $ignore)
 					{
 						if (in_array($key, $ids['users']))
 						{
-							unset($options['users'][$key]);
+							unset($auth_options['users'][$key]);
 						}
 					}
 
-					//print_r($options);
+					//print_r($auth_options);
 				break;
 			
 				case 'set':
@@ -374,49 +394,53 @@
 				break;
 			}
 
-			foreach ($options as $option)
+			$return = null;
+
+			foreach ($auth_options as $test)
 			{
-				if (!empty($option))
+				if (!empty($test))
 				{
-					$return =&amp; $options;
+					$return =&amp; $auth_options;
 					break;
 				}
 			}
 		}
 
 		$group_list = $allowed_group_list = $disallowed_group_list = $allowed_user_list = $disallowed_user_list = '';
-		$groups_ids = array_keys($options['users']);
 
-		if (!empty($options['users']))
+		if (!empty($auth_options['users']))
 		{
 			$sql = 'SELECT user_id, username, user_colour
 				FROM ' . USERS_TABLE . '
-				WHERE user_id IN ('.implode(', ', array_keys($options['users'])).')
+				WHERE user_id IN ('.implode(', ', array_keys($auth_options['users'])).')
 					ORDER BY username';
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$user_list = ($options['users'][$row['user_id']]['status'] === 1) ? 'allowed_user_list' : 'disallowed_user_list';
+				$user_list = ($auth_options['users'][$row['user_id']]['core_status'] == 1) ? 'allowed_user_list' : 'disallowed_user_list';
 
 				$$user_list .= '&lt;option ' . (($row['user_colour']) ? ' style=&quot;color: #'.$row['user_colour'].';&quot;' : '') . ' value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
 		}
+// this can be removed, when everthing else is updated
+		$groups_ids = array_merge(array_keys($auth_options['groups'][0]), array_keys($auth_options['groups'][1]));
 
 		if (!empty($groups_ids))
 		{
 			$sql = 'SELECT group_id, group_name, group_type 
 				FROM ' . GROUPS_TABLE . '
-				WHERE group_id IN ('.implode(', ', array_keys($options['groups'])).')
+				WHERE group_id IN ('.implode(', ', $groups_ids).')
 					ORDER BY group_type DESC, group_name';
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$group_list = ($options['groups'][$row['group_id']]['status'] === 1) ? 'allowed_group_list' : 'disallowed_group_list';
+				$group_auth_type = isset($auth_options['groups'][1][$row['group_id']]['core_status']) ? 1 : 0;
+				$group_list = ($auth_options['groups'][$group_auth_type][$row['group_id']]['core_status']) ? 'allowed_group_list' : 'disallowed_group_list';
 				
-				$$group_list .= '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+				$$group_list .= '&lt;option' . (($group_auth_type == 1) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
 				
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
@@ -430,7 +454,7 @@
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$group_list .= '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+			$group_list .= '&lt;option value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 	
@@ -444,7 +468,7 @@
 
 		$_CLASS['core_template']-&gt;display('permission.html');
 
-		return ($return !== false) ? $return : false;
+		return $return;
 	}
 }
 

Modified: trunk/includes/auth/auth_db.php
===================================================================
--- trunk/includes/auth/auth_db.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth_db.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#194;&#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class auth_db extends core_auth
 {

Modified: trunk/includes/auth/auth_http.php
===================================================================
--- trunk/includes/auth/auth_http.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/auth/auth_http.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#194;&#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class auth_db extends core_auth
 {

Modified: trunk/includes/cache/cache.php
===================================================================
--- trunk/includes/cache/cache.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	&#195;&#181;															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache
 {

Modified: trunk/includes/cache/cache_eaccelerator.php
===================================================================
--- trunk/includes/cache/cache_eaccelerator.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_eaccelerator.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	&#195;&#181;															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_eaccelerator extends cache
 {

Modified: trunk/includes/cache/cache_file.php
===================================================================
--- trunk/includes/cache/cache_file.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_file.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//	&#195;&#181;															//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_file extends cache
 {

Modified: trunk/includes/cache/cache_none.php
===================================================================
--- trunk/includes/cache/cache_none.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/cache/cache_none.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class cache_none extends cache
 {

Modified: trunk/includes/core_rss.php
===================================================================
--- trunk/includes/core_rss.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/core_rss.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal&#169;	)								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 // Add channel support, rss_data[channel][item][item_branch]
 // nested items
 // maybe make this more xml specfic with another rss function?
@@ -127,7 +133,7 @@
 
 		if (mb_strpos($data, '200') === false)
 		{
-			echo $data;
+			//echo $data;
 
 			if (mb_strpos($data, '301') === true || mb_strpos($data, '301') === true)
 			{
@@ -165,13 +171,16 @@
 			{
 				$this-&gt;Close_connection();
 				$this-&gt;error = 'Document type is invalid';
+
 				return false;
 			}
 			
+			/*
 			if (mb_strpos($data, 'last-modified') !== false)
 			{
 				//
 			}
+			*/
 
 			if (mb_strpos($data, 'content-encoding') !== false &amp;&amp; mb_strpos($data, 'gzip') !== false)
 			{
@@ -180,7 +189,7 @@
 		}
 
 		$this-&gt;rss_parser = xml_parser_create();
-		xml_set_object( $this-&gt;rss_parser, $this );
+		xml_set_object($this-&gt;rss_parser, $this);
 		xml_set_element_handler($this-&gt;rss_parser, 'tag_open', 'tag_close');
 		xml_set_character_data_handler($this-&gt;rss_parser, 'cdata');
 
@@ -196,7 +205,7 @@
 
 		if ($compressed)
 		{
-			$data = gzinflate(substr($data,10));
+			$data = gzinflate(substr($data, 10));
 		}
 
 		$status = xml_parse($this-&gt;rss_parser, $data, true);

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/db/mysql.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class db_mysql
 {
@@ -94,6 +100,11 @@
 		$this-&gt;return_on_error = $fail;
 	}
 
+	function return_on_error($fail = false)
+	{
+		$this-&gt;return_on_error = $fail;
+	}
+
 	function transaction($option = 'start')
 	{
 		if (!$this-&gt;link_identifier)
@@ -530,58 +541,62 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' =&gt; null, 'min' =&gt; 0, 'max' =&gt; 0, 'auto_increment' =&gt; false, 'null' =&gt; false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if ($number_min &gt;= -0 &amp;&amp; $number_max &lt;= 255)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 255)
 		{
 			// TINYINT UNSIGNED ( 0 to 255 )
 			$this-&gt;_fields[$name] =  &quot;`$name` TINYINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -128 &amp;&amp; $number_max &lt;= 128)
+		elseif ($setting['min'] &gt;= -128 &amp;&amp; $setting['max'] &lt;= 128)
 		{
 			// TINYINT ( -128 to 127 )
 			$this-&gt;_fields[$name] =  &quot;`$name` TINYINT($length) DEFAULT&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 65535)
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 65535)
 		{
 			// SMALLINT UNSIGNED ( 0 to 65,535 )
 			$this-&gt;_fields[$name] =  &quot;`$name` SMALLINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -32768 &amp;&amp; $number_max &lt;= 32767)
+		elseif ($setting['min'] &gt;= -32768 &amp;&amp; $setting['max'] &lt;= 32767)
 		{
 			// SMALLINT ( -32,768 to 32,767 )
 			$this-&gt;_fields[$name] =  &quot;`$name` SMALLINT($length)&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 16777215)
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 16777215)
 		{
 			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
 			$this-&gt;_fields[$name] =  &quot;`$name` MEDIUMINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -8388608 &amp;&amp; $number_max &lt;= 8388607)
+		elseif ($setting['min'] &gt;= -8388608 &amp;&amp; $setting['max'] &lt;= 8388607)
 		{
 			// MEDIUMINT ( -8,388,608 to 8,388,607 )
 			$this-&gt;_fields[$name] =  &quot;`$name` MEDIUMINT($length)&quot;;
 		}
-		elseif ($number_min &gt;= -2147483647 &amp;&amp; $number_max &lt;= 2147483647)
+		elseif ($setting['min'] &gt;= -2147483647 &amp;&amp; $setting['max'] &lt;= 2147483647)
 		{
 			// INT ( -2,147,483,647 to 2,147,483,647 )
 			$this-&gt;_fields[$name] =  &quot;`$name` INT($length)&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 4294967295) // we'll do this last
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 4294967295) // we'll do this last
 		{
 			// INT UNSIGNED ( 0 to 4,294,967,295 )
 			$this-&gt;_fields[$name] =  &quot;`$name` INT($length) UNSIGNED&quot;;
 		}
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
 			$this-&gt;_fields[$name] .= ' auto_increment';
 		}
 		else
 		{
-			$this-&gt;_fields[$name] .= (is_null($default)) ? &quot; NULL&quot; : &quot; NOT NULL DEFAULT '&quot;.(int) $default.&quot;'&quot;;
+			$this-&gt;_fields[$name] .= ($setting['null']) ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
+			$this-&gt;_fields[$name] .= is_null($setting['default']) ? '' : &quot; DEFAULT '&quot;.(int) $setting['default'].&quot;'&quot;;
 		}
 	}
 
@@ -611,21 +626,22 @@
 		$this-&gt;_fields[$name] .= ($null) ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
 	}
 
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-
 		$this-&gt;_fields[$name] = ($padded) ? &quot;`$name` CHAR($characters)&quot; :  &quot;`$name` VARCHAR($characters)&quot;;
-		$this-&gt;_fields[$name] .= (is_null($default)) ? &quot; NULL&quot; : &quot; NOT NULL DEFAULT '$default'&quot;;
+		$this-&gt;_fields[$name] .= $null ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
+		$this-&gt;_fields[$name] .= is_null($default) ? '' : &quot;DEFAULT '$default'&quot;;
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-
-		if (empty($this-&gt;_fields[$field]))
+		
+		/*if (empty($this-&gt;_fields[$field]))
 		{
 			return;
-		}
+		}*/
+		$field = is_array($field) ? implode(',', $field) : $field;
 
 		switch ($type)
 		{

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/db/mysqli.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class db_mysqli
 {
@@ -497,24 +503,24 @@
 		switch ($option)
 		{
 			case 'start':
-				$this-&gt;table_name = $name;
-				$this-&gt;fields = $this-&gt;indexs = array();
+				$this-&gt;_table_name = $name;
+				$this-&gt;_fields = $this-&gt;_indexs = array();
 			break;
 
 			case 'commit':
 			case 'return':
-				if (!$this-&gt;table_name)
+				if (!$this-&gt;_table_name)
 				{
 					return;
 				}
 
-				$fields = implode(&quot;, \n&quot;, $this-&gt;fields);
-				if ($indexs = implode(&quot;, \n&quot;, $this-&gt;indexs))
+				$fields = implode(&quot;, \n&quot;, $this-&gt;_fields);
+				if ($indexs = implode(&quot;, \n&quot;, $this-&gt;_indexs))
 				{
 					$fields .= &quot;, \n&quot;;
 				}
 
-				$table = 'CREATE TABLE '.$this-&gt;table_name.&quot; ( \n&quot; .$fields. $indexs .&quot; \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;&quot;;
+				$table = 'CREATE TABLE '.$this-&gt;_table_name.&quot; ( \n&quot; .$fields. $indexs .&quot; \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;&quot;;
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')
@@ -525,64 +531,68 @@
 				$this-&gt;sql_query($table);
 
 			case 'cancel':
-				$this-&gt;table_name = false;
-				$this-&gt;fields = $this-&gt;indexs = array();
+				$this-&gt;_table_name = false;
+				$this-&gt;_fields = $this-&gt;_indexs = array();
 			break;
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' =&gt; null, 'min' =&gt; 0, 'max' =&gt; 0, 'auto_increment' =&gt; false, 'null' =&gt; false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if ($number_min &gt;= -0 &amp;&amp; $number_max &lt;= 255)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 255)
 		{
 			// TINYINT UNSIGNED ( 0 to 255 )
-			$this-&gt;fields[$name] =  &quot;`$name` TINYINT($length) UNSIGNED&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` TINYINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -128 &amp;&amp; $number_max &lt;= 128)
+		elseif ($setting['min'] &gt;= -128 &amp;&amp; $setting['max'] &lt;= 128)
 		{
 			// TINYINT ( -128 to 127 )
-			$this-&gt;fields[$name] =  &quot;`$name` TINYINT($length) DEFAULT&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` TINYINT($length) DEFAULT&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 65535)
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 65535)
 		{
 			// SMALLINT UNSIGNED ( 0 to 65,535 )
-			$this-&gt;fields[$name] =  &quot;`$name` SMALLINT($length) UNSIGNED&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` SMALLINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -32768 &amp;&amp; $number_max &lt;= 32767)
+		elseif ($setting['min'] &gt;= -32768 &amp;&amp; $setting['max'] &lt;= 32767)
 		{
 			// SMALLINT ( -32,768 to 32,767 )
-			$this-&gt;fields[$name] =  &quot;`$name` SMALLINT($length)&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` SMALLINT($length)&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 16777215)
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 16777215)
 		{
 			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
-			$this-&gt;fields[$name] =  &quot;`$name` MEDIUMINT($length) UNSIGNED&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` MEDIUMINT($length) UNSIGNED&quot;;
 		}
-		elseif ($number_min &gt;= -8388608 &amp;&amp; $number_max &lt;= 8388607)
+		elseif ($setting['min'] &gt;= -8388608 &amp;&amp; $setting['max'] &lt;= 8388607)
 		{
 			// MEDIUMINT ( -8,388,608 to 8,388,607 )
-			$this-&gt;fields[$name] =  &quot;`$name` MEDIUMINT($length)&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` MEDIUMINT($length)&quot;;
 		}
-		elseif ($number_min &gt;= -2147483647 &amp;&amp; $number_max &lt;= 2147483647)
+		elseif ($setting['min'] &gt;= -2147483647 &amp;&amp; $setting['max'] &lt;= 2147483647)
 		{
 			// INT ( -2,147,483,647 to 2,147,483,647 )
-			$this-&gt;fields[$name] =  &quot;`$name` INT($length)&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` INT($length)&quot;;
 		}
-		elseif ($number_min &gt;= 0 &amp;&amp; $number_max &lt;= 4294967295) // we'll do this last
+		elseif ($setting['min'] &gt;= 0 &amp;&amp; $setting['max'] &lt;= 4294967295) // we'll do this last
 		{
 			// INT UNSIGNED ( 0 to 4,294,967,295 )
-			$this-&gt;fields[$name] =  &quot;`$name` INT($length) UNSIGNED&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` INT($length) UNSIGNED&quot;;
 		}
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
-			$this-&gt;fields[$name] .= ' auto_increment';
+			$this-&gt;_fields[$name] .= ' auto_increment';
 		}
 		else
 		{
-			$this-&gt;fields[$name] .= (is_null($default)) ? &quot; NULL&quot; : &quot; NOT NULL DEFAULT '&quot;.(int) $default.&quot;'&quot;;
+			$this-&gt;_fields[$name] .= ($setting['null']) ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
+			$this-&gt;_fields[$name] .= is_null($setting['default']) ? '' : &quot; DEFAULT '&quot;.(int) $setting['default'].&quot;'&quot;;
 		}
 	}
 
@@ -591,56 +601,57 @@
 		if ($characters &lt;= 255)
 		{
 			// TINYTEXT 1 to 255 Characters
-			$this-&gt;fields[$name] =  &quot;`$name` TINYTEXT&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` TINYTEXT&quot;;
 		}
 		elseif ($characters &lt;= 65535)
 		{
 			// TEXT 1 to 65535 Characters
-			$this-&gt;fields[$name] =  &quot;`$name` TEXT&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` TEXT&quot;;
 		}
 		elseif ($characters &lt;= 16777215)
 		{
 			// MEDIUMTEXT 1 to 16,777,215 Characters
-			$this-&gt;fields[$name] =  &quot;`$name` MEDIUMTEXT&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` MEDIUMTEXT&quot;;
 		}
 		elseif ($characters &lt;= 4294967295)
 		{
 			// LONGTEXT 1 to 4,294,967,295 Characters
-			$this-&gt;fields[$name] =  &quot;`$name` LONGTEXT&quot;;
+			$this-&gt;_fields[$name] =  &quot;`$name` LONGTEXT&quot;;
 		}
 
-		$this-&gt;fields[$name] .= ($null) ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
+		$this-&gt;_fields[$name] .= ($null) ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
 	}
 
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-		$this-&gt;fields[$name] =  ($padded) ? &quot;`$name` CHAR($characters)&quot; : &quot;`$name` VARCHAR($characters)&quot;;
-		$this-&gt;fields[$name] .= (is_null($default)) ? &quot; NULL&quot; : &quot; NOT NULL DEFAULT '$default'&quot;;
+		$this-&gt;_fields[$name] = ($padded) ? &quot;`$name` CHAR($characters)&quot; :  &quot;`$name` VARCHAR($characters)&quot;;
+		$this-&gt;_fields[$name] .= $null ? &quot; NULL&quot; : &quot; NOT NULL&quot;;
+		$this-&gt;_fields[$name] .= is_null($default) ? '' : &quot;DEFAULT '$default'&quot;;
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-
-		//$field = (is_array($field)) ? $field : array($field);
-
-		if (empty($this-&gt;fields[$field]))
+		
+		/*if (empty($this-&gt;_fields[$field]))
 		{
 			return;
-		}
+		}*/
+		$field = is_array($field) ? implode(',', $field) : $field;
 
 		switch ($type)
 		{
 			case 'index':
 			case 'unique':
-				$this-&gt;indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . &quot;KEY `$index_name` (`$field`)&quot;;
+				$this-&gt;_indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . &quot;KEY `$index_name` (`$field`)&quot;;
 			break;
 
 			case 'primary':
-				$this-&gt;indexs['primary'] = &quot;PRIMARY KEY (`$field`)&quot;;
+				$this-&gt;_indexs['primary'] = &quot;PRIMARY KEY (`$field`)&quot;;
 			break;
 		}
 	}
+
 }
 
 ?&gt;
\ No newline at end of file

Modified: trunk/includes/display/blocks.php
===================================================================
--- trunk/includes/display/blocks.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/blocks.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 /* to do
 move Auth, lang, and expire/begin checks to load_blocks
@@ -24,7 +30,7 @@
 	var $info;
 	var $content;
 	var $template;
-	
+
 	/*
 		Check to see there's any blocks for the specified side
 		should be used to stop themes from displaying blank sides
@@ -34,24 +40,24 @@
 // expand this for center blocks
 		static $side_check = array();
 		
-		if (!empty($side_check[$side]))
+		if (isset($side_check[$side]))
 		{
 			return $side_check[$side];
 		}
-		
+
 		global $_CORE_MODULE, $_CLASS;
 
 		$trueside = $side;
-		
+
 		if ($_CLASS['core_user']-&gt;lang['DIRECTION'] == 'rtl')
 		{
-			$side = (($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT);
+			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
 		}
 			
 		if ($_CORE_MODULE['sides'] == BLOCK_ALL || ($side == BLOCK_LEFT &amp;&amp; $_CORE_MODULE['sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT &amp;&amp; $_CORE_MODULE['sides'] == BLOCK_RIGHT))
 		{
 			$this-&gt;load_blocks();
-			
+
 			if (!empty($this-&gt;blocks_array[$side]))
 			{
 				return $side_check[$trueside] = $side;
@@ -60,7 +66,7 @@
 		
 		return $side_check[$trueside] = false;
 	}
-	
+
 	/*
 		Load Blocks from cache or databases, also run needed checks
 	*/
@@ -71,49 +77,50 @@
 		{
 			return;
 		}
-		
+
 		global $_CLASS;
 
 		if (is_null($this-&gt;blocks_array = $_CLASS['core_cache']-&gt;get('blocks')))
 		{
-			$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '.BLOCKS_TABLE.' WHERE active &gt; 0 ORDER BY weight ASC');
-			
+			$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = 1 ORDER BY block_order ASC');
+
 			$this-&gt;blocks_array = array();
-			
+
 			while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$row['auth'] = ($row['auth']) ? unserialize($row['auth']) : '';
-				$this-&gt;blocks_array[$row['position']][] = $row;
+				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
+				$this-&gt;blocks_array[$row['block_position']][] = $row;
 			}
-			
+
 			$_CLASS['core_db']-&gt;free_result($result);
 			$_CLASS['core_cache']-&gt;put('blocks', $this-&gt;blocks_array);
+
 			$_CLASS['core_cache']-&gt;save();
 		}
-		
+
 		$_CLASS['core_cache']-&gt;remove('blocks');
 		$this-&gt;blocks_loaded = true;
 	}
-	
+
 	/*
 	*/
 	function add_block($data, $position = false)
 	{
-		$option_array = array('title','position', 'content', 'file' , 'modules', 'start' ,'expires', 'id',	'auth',	'type');
-		
+		$option_array = array('block_title','block_position', 'block_content', 'block_file' , 'block_starts' ,'block_expires', 'block_id',	'block_auth',	'block_type');
+
 		foreach($option_array as $option)
 		{
 			$data_perpared[$option] = (empty($data[$option])) ? '' : $data[$option];
 		}
-		
-		$this-&gt;blocks_array[$data['position']][] = $data_perpared;
+
+		$this-&gt;blocks_array[$data_perpared['block_position']][] = $data_perpared;
 	}
-	
+
 	/*
 	*/
-	function display($position, $template_name = false)
+	function display($position)
 	{
-		//$this-&gt;template_name = $template_name;
+		$this-&gt;display_position = $position;
 
 		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
 		{
@@ -124,27 +131,27 @@
 				return false;
 			}
 		}
-		
+
 		$this-&gt;load_blocks();
-			
+
 		if (empty($this-&gt;blocks_array[$position]))
 		{
 			return false;
 		}
-		
+
 		static $expire_updated = false;
 		global $_CLASS;
-		
+
 		$this-&gt;content = '';
-		
+
 		foreach($this-&gt;blocks_array[$position] as $this-&gt;block)
 		{
-			if ($this-&gt;block['auth'] &amp;&amp; !$_CLASS['core_auth']-&gt;auth($this-&gt;block['auth']) &amp;&amp; !$_CLASS['core_auth']-&gt;admin_power('blocks') )
+			if ($this-&gt;block['block_auth'] &amp;&amp; !$_CLASS['core_auth']-&gt;auth($this-&gt;block['block_auth']) &amp;&amp; !$_CLASS['core_auth']-&gt;admin_power('blocks'))
 			{
 				continue;
 			}
 //language check here.
-			if ($this-&gt;block['expires'] &amp;&amp; !$expire_updated &amp;&amp; ($_CLASS['core_user']-&gt;time &gt; $this-&gt;block['expires']))
+			if ($this-&gt;block['block_expires'] &amp;&amp; !$expire_updated &amp;&amp; ($_CLASS['core_user']-&gt;time &gt; $this-&gt;block['block_expires']))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE '.BLOCKS_TABLE.' SET active=0 WHERE expires &gt; 0 AND expires &lt;='.$_CLASS['core_user']-&gt;time);
 										
@@ -153,26 +160,28 @@
 
 				continue;
 			}
-			
-			if ($this-&gt;block['start'] &amp;&amp; ($this-&gt;block['start'] &gt; $_CLASS['core_user']-&gt;time))
+
+			if ($this-&gt;block['block_starts'] &amp;&amp; ($this-&gt;block['block_starts'] &gt; $_CLASS['core_user']-&gt;time))
 			{
 				continue;
 			}
-			
-			if ($this-&gt;block['modules'])
+
+			/*
+			if ($this-&gt;block['block_modules'])
 			{
-				$this-&gt;block['modules'] = unserialize($this-&gt;block['modules']);
+				$this-&gt;block['block_modules'] = unserialize($this-&gt;block['block_modules']);
 // Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['title'], $this-&gt;block['modules']['show'] || in_array($_CORE_MODULE['title'], $this-&gt;block['modules']['hide'])))
+				if (!in_array($_CORE_MODULE['title'], $this-&gt;block['block_modules']['show'] || in_array($_CORE_MODULE['title'], $this-&gt;block['block_modules']['hide'])))
 				{
 					continue;
 				}
 			}
-			
+			*/
+
 			$this-&gt;display_blocks();
 			$this-&gt;content = '';
 		}
-		
+
 		unset($this-&gt;blocks_array[$position]);
 	}
 
@@ -180,29 +189,26 @@
 	*/
 	function display_blocks()
 	{
-		Switch ($this-&gt;block['type'])
+		Switch ($this-&gt;block['block_type'])
 		{
 			case BLOCKTYPE_FILE:
 			case BLOCKTYPE_SYSTEM:
-				
 				$this-&gt;block_file();
-				break;
+			break;
 				
 			case BLOCKTYPE_MESSAGE:
 			case BLOCKTYPE_MESSAGE_GLOBAL:
-			
 				$this-&gt;block_message();
-				break;
+			break;
 					
 			case BLOCKTYPE_HTML:
 				$this-&gt;block_html();
-				break;
+			break;
 				
 			case BLOCKTYPE_FEED;
 				$this-&gt;block_feed();
-				break;
+			break;
 		}
-		
 		return;
 	}
 
@@ -211,17 +217,17 @@
 	function block_file()
 	{
 		global $_CLASS, $site_file_root;
-		
-		if ($this-&gt;block['file'] &amp;&amp; file_exists($site_file_root.'blocks/'.$this-&gt;block['file']))
+
+		if ($this-&gt;block['block_file'] &amp;&amp; file_exists($site_file_root.'blocks/'.$this-&gt;block['block_file']))
 		{
 			$this-&gt;info = false;
 
-			//$_CLASS['core_error_handler']-&gt;debug_start($this-&gt;block['title']);
-		
-			include($site_file_root.'blocks/'.$this-&gt;block['file']);
-			
-			//$_CLASS['core_error_handler']-&gt;debug_stop($this-&gt;block['title']);
+			//$_CLASS['core_error_handler']-&gt;debug_start($this-&gt;block['block_title']);
 
+			include($site_file_root.'blocks/'.$this-&gt;block['block_file']);
+
+			//$_CLASS['core_error_handler']-&gt;debug_stop($this-&gt;block['block_title']);
+
 			if (!$this-&gt;content &amp;&amp; !$this-&gt;template)
 			{
 				if ($_CLASS['core_auth']-&gt;admin_power('blocks'))
@@ -246,10 +252,10 @@
 			}		
 		}
 
-		//$this-&gt;content .= '&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br /&gt;'.$_CLASS['core_error_handler']-&gt;debug_get($this-&gt;block['title'], 'formated').'&lt;/div&gt;';
-		//$_CLASS['core_error_handler']-&gt;debug_remove($this-&gt;block['title']);
+		//$this-&gt;content .= '&lt;div style=&quot;text-align: center;&quot;&gt;&lt;br /&gt;'.$_CLASS['core_error_handler']-&gt;debug_get($this-&gt;block['block_title'], 'formated').'&lt;/div&gt;';
+		//$_CLASS['core_error_handler']-&gt;debug_remove($this-&gt;block['block_title']);
 
-		if ($this-&gt;block['position'] == BLOCK_LEFT || $this-&gt;block['position'] == BLOCK_RIGHT)
+		if ($this-&gt;display_position == BLOCK_LEFT || $this-&gt;display_position == BLOCK_RIGHT)
 		{
 			$this-&gt;block_side();
 		}
@@ -258,61 +264,60 @@
 			$this-&gt;block_center();
 		}
 	}
-			
+
 	function block_message()
 	{
 		global $_CLASS;
-		
-		if (($this-&gt;block['type'] == BLOCKTYPE_MESSAGE) &amp;&amp; (!$_CLASS['core_display']-&gt;homepage))
+
+		if (($this-&gt;block['block_type'] == BLOCKTYPE_MESSAGE) &amp;&amp; (!$_CLASS['core_display']-&gt;homepage))
 		{
 			return;
 		}
-		
+
 		if ($_CLASS['core_auth']-&gt;admin_power('messages'))
 		{
-			$expires = ($this-&gt;block['expires']) ? $_CLASS['core_user']-&gt;lang['EXPIRES'].' '.$_CLASS['core_user']-&gt;format_date($this-&gt;block['expires']) : false;
-			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this-&gt;block['id'], array('admin' =&gt; true));
-		
+			$expires = ($this-&gt;block['block_expires']) ? $_CLASS['core_user']-&gt;lang['EXPIRES'].' '.$_CLASS['core_user']-&gt;format_date($this-&gt;block['block_expires']) : false;
+			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this-&gt;block['block_id'], array('admin' =&gt; true));
 		}
 		else
 		{
 		
 			$edit_link = $expires = false;
 		}
-		
-		$postion = ($this-&gt;block['position'] == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
-		
+
+		$postion = ($this-&gt;display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
+
 		$_CLASS['core_template']-&gt;assign_vars_array('message_block_'.$postion, array(
-				//'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['title']),
-				'title'		=&gt; $this-&gt;block['title'],
-				'collapsed'	=&gt; collapsed_items('block_'.$this-&gt;block['id']),
-				'content'	=&gt; $this-&gt;block['content'],
+				//'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['block_title']),
+				'title'		=&gt; $this-&gt;block['block_title'],
+				'collapsed'	=&gt; check_collapsed_status('block_'.$this-&gt;block['block_id']),
+				'content'	=&gt; $this-&gt;block['block_content'],
 				'expires'	=&gt; $expires,
 				'edit_link'	=&gt; $edit_link,
-				'id'		=&gt; $this-&gt;block['id'],
+				'id'		=&gt; $this-&gt;block['block_id'],
 		));
 	}
-	
+
 	function block_side()
 	{
 		global $_CLASS;
 		
-		$position = ($this-&gt;block['position'] == BLOCK_RIGHT) ? 'right' : 'left';
+		$position = ($this-&gt;display_position == BLOCK_RIGHT) ? 'right' : 'left';
 		
 		$_CLASS['core_template']-&gt;assign_vars_array('block_'.$position, array(
-			//'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['title']),
-			'title'		=&gt; $this-&gt;block['title'],
+			//'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['block_title']),
+			'title'		=&gt; $this-&gt;block['block_title'],
 			'content'	=&gt; $this-&gt;content,
-			'collapsed'	=&gt; collapsed_items('block_'.$this-&gt;block['id']),
-			'id'		=&gt; $this-&gt;block['id'],
+			'collapsed'	=&gt; check_collapsed_status('block_'.$this-&gt;block['block_id']),
+			'id'		=&gt; $this-&gt;block['block_id'],
 		));
 	}
-	
+
 	function block_html()
 	{
-		$this-&gt;content = $this-&gt;block['content'];
-		
-		if ($this-&gt;block['position'] == BLOCK_LEFT || $this-&gt;block['position'] == BLOCK_RIGHT)
+		$this-&gt;content = $this-&gt;block['block_content'];
+
+		if ($this-&gt;display_position == BLOCK_LEFT || $this-&gt;display_position == BLOCK_RIGHT)
 		{
 			$this-&gt;block_side();
 		}
@@ -321,17 +326,17 @@
 			$this-&gt;block_center();
 		}
 	}
-	
+
 	function block_feed()
 	{
 		global $site_file_root, $_CLASS;
 // think about disabling the block automatically if there's url problems
 // update core_rss file
-		if ($this-&gt;block['content'] &amp;&amp; (!$this-&gt;block['rss_expires'] || $this-&gt;block['rss_expires'] &gt; time()))
+		if ($this-&gt;block['block_content'] &amp;&amp; (!$this-&gt;block['block_rss_expires'] || $this-&gt;block['block_rss_expires'] &gt; time()))
 		{
-			$this-&gt;content = $this-&gt;block['content'];
-			
-			if ($this-&gt;block['position'] == BLOCK_LEFT || $this-&gt;block['position'] == BLOCK_RIGHT)
+			$this-&gt;content = $this-&gt;block['block_content'];
+
+			if ($this-&gt;display_position == BLOCK_LEFT || $this-&gt;display_position == BLOCK_RIGHT)
 			{
 				$this-&gt;block_side();
 			}
@@ -339,13 +344,13 @@
 			{
 				$this-&gt;block_center();
 			}
-			
+
 			return;
 		}
-		
-		if ($this-&gt;block['file'] &amp;&amp; file_exists($site_file_root.'blocks/rss/'.$this-&gt;block['file']))
+
+		if ($this-&gt;block['block_file'] &amp;&amp; file_exists($site_file_root.'blocks/rss/'.$this-&gt;block['block_file']))
 		{
-			include($site_file_root.'blocks/rss/'.$this-&gt;block['file']);
+			include($site_file_root.'blocks/rss/'.$this-&gt;block['block_file']);
 			
 			if (!$this-&gt;content)
 			{
@@ -357,14 +362,14 @@
 			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
 			$_CLASS['core_rss']-&gt;setup(false, array('title', 'link'));
 				
-			if (!$_CLASS['core_rss']-&gt;get_rss($this-&gt;block['rss_url']))
+			if (!$_CLASS['core_rss']-&gt;get_rss($this-&gt;block['block_rss_url']))
 			{
 	//admin only message here
 				return;
 			}
-			
+
 			$this-&gt;content = '&lt;center&gt;&lt;br /&gt;';
-			
+
 			while ($data = $_CLASS['core_rss']-&gt;get_rss_data())
 			{
 				$this-&gt;content .= '&lt;a href=&quot;'.$data['link'].'&quot; target=&quot;new&quot;&gt;'.$data['title'].'&lt;/a&gt;&lt;hr width=&quot;30%&quot;/&gt;';
@@ -378,22 +383,22 @@
 			$this-&gt;content .= '&lt;/center&gt;';
 		}
 
-		settype($this-&gt;block['rss_rate'], 'integer');
+		settype($this-&gt;block['block_rss_rate'], 'integer');
 
-		if ($this-&gt;block['rss_rate'] !== -1)
+		if ($this-&gt;block['block_rss_rate'] !== -1)
 		{
-			$this-&gt;block['rss_expires'] = ($this-&gt;block['rss_rate']) ? time() + $this-&gt;block['rss_rate'] : 0;
+			$this-&gt;block['block_rss_expires'] = ($this-&gt;block['block_rss_rate']) ? gmtime() + (int) $this-&gt;block['block_rss_rate'] : 0;
 			
 			$sql = 'UPDATE '.BLOCKS_TABLE.&quot;
-				SET content='&quot;.$_CLASS['core_db']-&gt;escape($this-&gt;content).&quot;', rss_expires='&quot;.$this-&gt;block['rss_expires'].&quot;' 
-					WHERE id=&quot;.$this-&gt;block['id'];
+				SET block_content = '&quot;.$_CLASS['core_db']-&gt;escape($this-&gt;content).&quot;', block_rss_expires = &quot;.$this-&gt;block['block_rss_expires'].&quot; 
+					WHERE block_id = &quot;.$this-&gt;block['block_id'];
 				
 			$_CLASS['core_db']-&gt;query($sql);
 
 			$_CLASS['core_cache']-&gt;destroy('blocks');
 		}
-		
-		if ($this-&gt;block['position'] == BLOCK_LEFT || $this-&gt;block['position'] == BLOCK_RIGHT)
+
+		if ($this-&gt;display_position == BLOCK_LEFT || $this-&gt;display_position == BLOCK_RIGHT)
 		{
 			$this-&gt;block_side();
 		}
@@ -402,15 +407,15 @@
 			$this-&gt;block_center();
 		}
 	}
-	
+
 	function block_center()
 	{
 		global $_CLASS;
 		
-		$position = ($this-&gt;block['position'] == BLOCK_TOP) ? 'center' : 'bottom';
+		$position = ($this-&gt;display_position == BLOCK_TOP) ? 'center' : 'bottom';
 		
 		$_CLASS['core_template']-&gt;assign_vars_array('block_'.$position , array(
-			'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['title']),
+			'TITLE'		=&gt; $_CLASS['core_user']-&gt;get_lang($this-&gt;block['block_title']),
 			'CONTENT'	=&gt; $this-&gt;content,
 			'TEMPLATE'	=&gt; $this-&gt;template
 		));

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/display.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class core_display
 {
@@ -158,7 +164,7 @@
 			$this-&gt;message = '&lt;b&gt;System is in maintenance mode&lt;/b&gt;&lt;br /&gt;';
 		}
 
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'SITE_LANG'			=&gt;	$_CLASS['core_user']-&gt;lang['LANG'],
 			'SITE_TITLE'		=&gt;	$_CORE_CONFIG['global']['site_name'].': '.$_CORE_MODULE['title'],
 			'SITE_BASE'			=&gt;	generate_base_url(),
@@ -234,17 +240,14 @@
 
 		$debug_output = 'Code Time : '.round($totaltime, 4).'s | Queries Time '.round($_CLASS['core_db']-&gt;queries_time, 4).'s | ' . $_CLASS['core_db']-&gt;num_queries . ' Queries  ] &lt;br /&gt; [ GZIP : ' .  ((in_array('ob_gzhandler' , ob_list_handlers())) ? 'On' : 'Off' ) . ' | Load : '  . (($_CLASS['core_user']-&gt;load) ? $_CLASS['core_user']-&gt;load : 'N/A');
 
-		if (function_exists('memory_get_usage'))
+		if ($memory_usage = get_memory_usage())
 		{
-			if ($memory_usage = memory_get_usage())
-			{
-				global $base_memory_usage;
-				
-				$memory_usage -= $base_memory_usage;
-				$memory_usage = ($memory_usage &gt;= 1048576) ? round((round($memory_usage / 1048576 * 100) / 100), 2) . ' ' . $_CLASS['core_user']-&gt;lang['MB'] : (($memory_usage &gt;= 1024) ? round((round($memory_usage / 1024 * 100) / 100), 2) . ' ' . $_CLASS['core_user']-&gt;lang['KB'] : $memory_usage . ' ' . $_CLASS['core_user']-&gt;lang['BYTES']);
+			global $base_memory_usage;
+			
+			$memory_usage -= $base_memory_usage;
+			$memory_usage = ($memory_usage &gt;= 1048576) ? round((round($memory_usage / 1048576 * 100) / 100), 2) . ' ' . $_CLASS['core_user']-&gt;lang['MB'] : (($memory_usage &gt;= 1024) ? round((round($memory_usage / 1024 * 100) / 100), 2) . ' ' . $_CLASS['core_user']-&gt;lang['KB'] : $memory_usage . ' ' . $_CLASS['core_user']-&gt;lang['BYTES']);
 
-				$debug_output .= ' | Memory Usage: ' . $memory_usage;	
-			}
+			$debug_output .= ' | Memory Usage: ' . $memory_usage;	
 		}
 
 		return $debug_output;
@@ -289,39 +292,4 @@
 	}
 }
 
-function collapsed_items($marker, $cookie = 'collapsed_items') 
-{
-    static $collapsed_items_array = array();
-
-    if (!isset($collapsed_items_array[$cookie]))
-    {
-		$cookie_data = get_variable($cookie, 'COOKIE');
-		$collapsed_items_array[$cookie] = ($cookie_data) ? explode(':', $cookie_data) : array();
-    }
-
-    return in_array($marker, $collapsed_items_array[$cookie]);
-}
-
-function hideblock($id) 
-{
-    // From cpgnuke - <A HREF="http://dragonflycms.org/">http://dragonflycms.org/</A>
-    static $hiddenblocks = false;
-
-    if (!$hiddenblocks) 
-    {
-		$hiddenblocks = array();
-
-        if (isset($_COOKIE['hiddenblocks']))
-        {
-            $tmphidden = explode(':', $_COOKIE['hiddenblocks']);
-			foreach ($tmphidden as $value)
-			{
-                $hiddenblocks[$value] = true;
-            }
-        }
-    }
-
-    return (empty($hiddenblocks[$id])) ? false : true;
-}
-
 ?&gt;
\ No newline at end of file

Modified: trunk/includes/display/template.php
===================================================================
--- trunk/includes/display/template.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/display/template.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,18 +1,25 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
 /*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
+/*
 	To-do cache daa.
 	Area code for content
 */
@@ -39,21 +46,30 @@
     /*
 		Assign variable to be used in template
     */
-    function assign($var, $value = false)
+// rewmove array from here
+	function assign($var, $value = false)
     {
-        if (is_array($var))
-        {
-			foreach ($var as $name =&gt; $value)
-            {
-				$this-&gt;_vars[$name] = $value;
-			}
-        }
-        else
-        {
+		if (is_array($var))
+		{
+			foreach ($var as $name =&gt; $value)
+			{
+				$this-&gt;_vars[$name] = $value;
+			}
+		}
+		else
+		{
 			$this-&gt;_vars[$var] = $value;
 		}
-    }
+	}
 
+    function assign_array($var, $value = false)
+	{
+		foreach ($var as $name =&gt; $value)
+		{
+			$this-&gt;_vars[$name] = $value;
+		}
+	}
+
 	/*
 		Assign variable that are part of a Loop
     */
@@ -178,7 +194,7 @@
 
 		$file_name = str_replace(array('.', '/'), '#', $name);
 
-		return (($this-&gt;theme_themplate) ? $_CLASS['core_display']-&gt;theme.'#' : '') . &quot;$file_name.php&quot;;
+		return ($this-&gt;theme_themplate ? $_CLASS['core_display']-&gt;theme_name.'#' : '') . &quot;$file_name.php&quot;;
 	}
 
     function is_compiled($name)

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/functions.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,24 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal&#169;	)								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
 // Redo
 function check_email($email)
 {
@@ -172,26 +179,23 @@
 	return false;
 }
 
-function display_confirmation($check = false, $hidden = '')
+function display_confirmation($message = '', $hidden = '')
 {
 	global $_CLASS, $SID;
 // Add user entered confirmation code as a choose, maybe ...
-	if ($check)
+	if (isset($_POST['cancel']))
+	{
+		return false;
+	}
+
+	if (isset($_POST['confirm']))
 	{
-		if (isset($_POST['cancel']))
-		{
-			return false;
-		}
-	
-		if (isset($_POST['confirm']))
+		$code = $_CLASS['core_user']-&gt;session_data_get('confirmation_code');
+		$confirm_code = get_variable('confirm_code', 'POST');
+
+		if ($code &amp;&amp; $confirm_code &amp;&amp; $code == $confirm_code)
 		{
-			$code = $_CLASS['core_user']-&gt;session_data_get('confirmation_code');
-			$confirm_code = get_variable('confirm_code', 'POST');
-
-			if ($code &amp;&amp; $confirm_code &amp;&amp; $code !== $confirm_code)
-			{
-				return true;
-			}
+			return true;
 		}
 
 		return false;
@@ -200,12 +204,15 @@
 	$confirmation_code = generate_string(6);
 	$_CLASS['core_user']-&gt;session_data_set('confirmation_code', $confirmation_code);
 
-	$_CLASS['core_template']-&gt;assign(array(
-		'S_CONFIRM_ACTION'  =&gt; generate_link($_CLASS['core_user']-&gt;url),
-		'S_HIDDEN_FIELDS'	=&gt; $hidden.'&lt;input type=&quot;hidden&quot; name=&quot;confirm_code&quot; value=&quot;' . $confirmation_code . '&quot; /&gt;'
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'MESSAGE'		=&gt; ($message) ? $message : 'Are you sure you want to perform this action ?',
+		'CONFIRM_ACTION'=&gt; generate_link($_CLASS['core_user']-&gt;url),
+		'HIDDEN_FIELDS'	=&gt; $hidden.'&lt;input type=&quot;hidden&quot; name=&quot;confirm_code&quot; value=&quot;' . $confirmation_code . '&quot; /&gt;'
 	));
-
-	$_CLASS['core_template']-&gt;display('confirm_display.html');
+
+	$_CLASS['core_template']-&gt;display('confirmation.html');
+
+	script_close();
 }
 
 function encode_password($pure, $encoding = 'md5')
@@ -290,6 +297,7 @@
 	{
 		switch ($var_type)
 		{
+		 	case 'int':
 		 	case 'integer':
 				$variable = is_numeric($variable) ? (int) $variable : $default;
 			break;
@@ -372,7 +380,7 @@
 	{
 		if ($link{0} == '&amp;')
 		{
-			$link = $_CORE_MODULE['title'].$link;
+			$link = $_CORE_MODULE['name'].$link;
 		}
 
 		$link = $file.'?mod='.$link;
@@ -447,8 +455,7 @@
 		$display['formated'] .= sprintf($wrapper['last'], generate_link($base_url.'&amp;start='.(($total_pages - 1)  * $per_page), $admin_link), $total_pages);
 	}
 
-//TMP
-	return $display['formated'];
+	return $display;
 }
 
 /*
@@ -498,34 +505,32 @@
 	$_CLASS['core_auth']-&gt;do_login($login_options, $template);
 }
 
-function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false)
+function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $cache = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
-	$_CLASS['core_db']-&gt;sql_return_on_error(true);
+	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . &quot; SET config_value ='&quot;.$_CLASS['core_db']-&gt;escape($value) . &quot;'
+		WHERE config_section = '&quot; . $_CLASS['core_db']-&gt;escape($section) . &quot;'
+			AND config_name = '&quot;. $_CLASS['core_db']-&gt;escape($name) .&quot;'&quot;;
 
-	$sql = 'UPDATE ' . CORE_CONFIG_TABLE . &quot; SET value ='&quot;.$_CLASS['core_db']-&gt;escape($value) . &quot;'
-		WHERE (section = '&quot; . $_CLASS['core_db']-&gt;escape($section) . &quot;')
-			AND (name = '&quot;. $_CLASS['core_db']-&gt;escape($name) .&quot;')&quot;;
-
-	if (!$_CLASS['core_db']-&gt;query($sql) &amp;&amp; $auto_add)
+	if ($auto_add &amp;&amp; (!$_CLASS['core_db']-&gt;query($sql) || !$_CLASS['core_db']-&gt;affected_rows()))
 	{
 		$sql_array = array(
-			'section'	=&gt; $section,
-			'name'		=&gt; $name,
-			'value'		=&gt; $value
+			'config_section'	=&gt; (string) $section,
+			'config_name'		=&gt; (string) $name,
+			'config_value'		=&gt; (string) $value,
+			'config_cache'		=&gt; (int) $cache,
 		);
+
+		$_CLASS['core_db']-&gt;return_on_error(true);
+
+		$_CLASS['core_db']-&gt;query('INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_array));
 		
-		$_CLASS['core_db']-&gt;sql_return_on_error(false);
-
-		$sql = 'INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_array);
-		$_CLASS['core_db']-&gt;query($sql);
+		$_CLASS['core_db']-&gt;return_on_error(false);
 	}
 
-	$_CLASS['core_db']-&gt;sql_return_on_error(false);
-	
 	$_CORE_CONFIG[$section][$name] = $value;
-	
+
 	if ($clear_cache)
 	{
 		$_CLASS['core_cache']-&gt;destroy('core_config');
@@ -683,7 +688,7 @@
 	return str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;, &quot;\n&quot;), $replacement, $text);
 }
 
-function url_redirect($url = false, $save = false)
+function redirect($url = false, $save = false)
 {
 	$url = ($url) ? $url : generate_link(false, array('full' =&gt; true));
 	$url = trim(str_replace('&amp;', '&amp;', $url));
@@ -710,6 +715,11 @@
 	script_close($save);
 }
 
+function url_redirect($url = false, $save = false)
+{
+	redirect($url = false, $save = false);
+}
+
 if (!function_exists('file_get_contents'))
 {
 	//string file_get_contents ( string filename [, bool use_include_path [, resource context [, int offset [, int maxlen]]]] )

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/functions_user.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,22 +1,32 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
-function user_get_id($username, &amp;$difference = array())
+function user_get_id($username, &amp;$difference)
 {
 	global $_CLASS;
 
+	$difference = array();
+
+	$username = is_array($username) ? $username : array($username);
+
 	$data = array('user_id' =&gt; array(), 'username' =&gt; array());
 
 	$sql = 'SELECT user_id, username
@@ -36,13 +46,15 @@
 	return $data['user_id'];
 }
 
-function user_get_name($user_ids, &amp;$difference = array())
+function user_get_name($user_id, &amp;$difference)
 {
 	global $_CLASS;
 
-	$user_ids = array_map('intval', $user_ids);
+	$difference = array();
 
-	if (empty($user_ids))
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
 	{
 		return;
 	}
@@ -51,39 +63,196 @@
 
 	$sql = 'SELECT user_id, username
 				FROM ' . USERS_TABLE . ' 
-				WHERE user_id IN (' . implode(', ', $user_ids) . ')';
+				WHERE user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$data['user_ids'][] = $row['user_id'];
+		$data['user_id'][] = $row['user_id'];
 		$data['username'][] = $row['username'];
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	$difference = array_diff($user_ids, $data['user_ids']);
+	$difference = array_diff($user_id, $data['user_id']);
 
 	return $data['username'];
 }
 
-function groups_user_remove($group_ids, $user_ids)
+function user_activate($user_id)
 {
+	global $_CLASS, $_CORE_CONFIG;
+
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_ACTIVE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type &lt;&gt;' . USER_GUEST;
+
+	$_CLASS['core_db']-&gt;query($sql);
+	
+	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + count($user_id));
+}
+
+function user_disable($user_id)
+{
+	global $_CLASS, $_CORE_CONFIG;
+
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
+
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_DISABLE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type &lt;&gt;' . USER_GUEST;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
+	{
+		$sql = 'SELECT user_id, username FROM ' . USERS_TABLE . '
+			WHERE user_type = '.USER_NORMAL.' AND user_status = '.USER_ACTIVE.'
+			ORDER BY user_regdate';
+
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		set_core_config('user', 'newest_user_id', $row['user_id'], false);
+		set_core_config('user', 'newest_username', $row['username'], false);
+	}
+
+	set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] - count($user_id), false);
+	
+	$_CLASS['core_cache']-&gt;destroy('core_config');
+}
+
+function user_activate_reminder($user_id)
+{
 	global $_CLASS;
 
-	$group_ids = is_array($group_ids) ? $group_ids : array($group_ids);
-	$user_ids = is_array($user_ids) ? $user_ids : array($user_ids);
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
 
-	$group_ids = array_map('intval', $group_ids);
-	$user_ids = array_map('intval', $user_ids);
+	if (empty($user_id))
+	{
+		return;
+	}
+// hook here -- maybe ?
+	$sql = 'UPDATE ' . USERS_TABLE . '
+		SET user_status = ' . USER_ACTIVE . '
+			WHERE user_id  IN (' . implode(', ', $user_id) . ')
+			AND user_type =' . USER_NORMAL;
+
+	$_CLASS['core_db']-&gt;query($sql);
+}
 
-	if (empty($group_ids) || empty($user_ids))
+function user_delete($user_id, $quick = false)
+{
+	global $_CLASS;
+
+	if ($quick)
 	{
+		$sql = &quot;DELETE FROM USERS_TABLE
+			WHERE user_id IN (&quot; . implode(', ', $user_id) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+		
 		return;
 	}
+	$user_id = array_map('intval', is_array($user_id) ? $user_id : array($user_id));
 
+// Maybe we should make this a cron
+// and just set the user type to deleted or something
+	set_time_limit(0);
+	ignore_user_abort(true);
+
+	if (empty($user_id))
+	{
+		return;
+	}
+
+	// We disable users first to make sure things go right
+	user_disable($user_id);
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	$optimize_array = array();
+	$tables = array(USERS_TABLE =&gt; 'user_id', USER_GROUP_TABLE =&gt; 'user_id');
+// hook here
+
+// Move this to hooks on seperation
+	$tables += array(FORUMS_ACL_TABLE =&gt; 'user_id', FORUMS_WATCH_TABLE =&gt; 'user_id', FORUMS_TRACK_TABLE =&gt; 'user_id');
+
+	$sql = 'UPDATE ' . FORUMS_TABLE . '
+		SET forum_last_poster_id = ' . ANONYMOUS . &quot; 
+		WHERE forum_last_poster_id IN (&quot; . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$sql = 'UPDATE ' . POSTS_TABLE . '
+		SET poster_id = ' . ANONYMOUS . &quot; 
+		WHERE poster_id IN (&quot; . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$sql = 'UPDATE ' . TOPICS_TABLE . '
+		SET topic_poster = ' . ANONYMOUS . &quot;
+		WHERE topic_poster IN (&quot; . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$sql = 'UPDATE ' . TOPICS_TABLE . '
+		SET topic_last_poster_id = ' . ANONYMOUS . &quot;
+		WHERE topic_last_poster_id IN (&quot; . implode(', ', $user_id) . ')';
+	$_CLASS['core_db']-&gt;query($sql);
+
+	switch ($_CLASS['core_db']-&gt;db_layer)
+	{
+		//case 'mysql4':
+		//case 'mysqli':
+		//DELETE FROM t1, t2 USING t1, t2, t3 WHERE t1.id=t2.id AND t2.id=t3.id;
+		//break;
+
+		default:
+			foreach ($tables as $table =&gt; $feild)
+			{
+				$sql = &quot;DELETE FROM $table 
+					WHERE $feild IN (&quot; . implode(', ', $user_id) . ')';
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			$optimize_array[] = $table;
+		break;
+	}
+
+// error on commit fail ( think about seperation commits for hooks )
+	$_CLASS['core_db']-&gt;transaction('commit');
+	
+// This should be in hooks
+	$_CLASS['core_db']-&gt;optimize_tables($optimize_array);
+}
+
+function groups_user_remove($group_id, $user_id)
+{
+	global $_CLASS;
+
+	$group_ids = is_array($group_id) ? $group_id : array($group_id);
+	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+
+	$group_id = array_map('intval', $group_id);
+	$user_id = array_map('intval', $user_id);
+
+	if (empty($group_id) || empty($user_id))
+	{
+		return;
+	}
+
 	$sql = 'SELECT user_id FROM ' . USERS_TABLE . ' 
-				WHERE group_id IN (' . implode(', ', $group_ids) . ')
-				AND user_id IN (' . implode(', ', $group_ids) . ')';
+				WHERE group_id IN (' . implode(', ', $group_id) . ')
+				AND user_id IN (' . implode(', ', $user_id) . ')';
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	$defaults = array();
@@ -106,15 +275,68 @@
 
 		$sql = 'UPDATE FROM '. USERS_TABLE .' 
 					SET group_id = 4, user_rank = -1
-					WHERE user_id IN (' . implode(', ', $group_ids) . ')';
+					WHERE user_id IN (' . implode(', ', $group_id) . ')';
 		$result = $_CLASS['core_db']-&gt;query($sql);
 	}
 
 	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
-		WHERE group_id IN ('. implode(', ', $group_ids) . ')
-		AND user_id IN ('. implode(', ', $user_ids) .')';
+		WHERE group_id IN ('. implode(', ', $group_id) . ')
+		AND user_id IN ('. implode(', ', $user_id) .')';
 
 	$result = $_CLASS['core_db']-&gt;query($sql);
 }
 
+function groups_user_add($group_id, $user_id, $status)
+{
+	global $_CLASS;
+
+	$group_ids = is_array($group_id) ? $group_id : array($group_id);
+	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+
+	$group_id = array_map('intval', $group_id);
+	$user_id = array_map('intval', $user_id);
+
+	if (empty($group_id) || empty($user_id))
+	{
+		return;
+	}
+
+	$sql = 'SELECT member_user_id, member_status FROM ' . USER_GROUP_TABLE . ' 
+				WHERE group_id IN (' . implode(', ', $group_id) . ')
+				AND member_user_id IN (' . implode(', ', $user_id) . ')
+				AND  = '.$status;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$update_array = array();
+	$ignore_array = array();
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$update_id[] = $row['user_id'];
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+	
+	// We move all users that are removed from the default groups to
+	// REGISTERED / REGISTERED_COPPA
+	if (!empty($defaults))
+	{
+// need to update/completion
+		$result = $_CLASS['core_db']-&gt;query('SELECT * FROM ' . GROUPS_TABLE . ' 	WHERE group_id = 4');
+
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$sql = 'UPDATE FROM '. USERS_TABLE .' 
+					SET group_id = 4, user_rank = -1
+					WHERE user_id IN (' . implode(', ', $group_id) . ')';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+	}
+
+	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
+		WHERE group_id IN ('. implode(', ', $group_id) . ')
+		AND user_id IN ('. implode(', ', $user_id) .')';
+
+	$result = $_CLASS['core_db']-&gt;query($sql);
+}
+
 ?&gt;
\ No newline at end of file

Modified: trunk/includes/handler.php
===================================================================
--- trunk/includes/handler.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/handler.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 // Add saving reports to a log file and its define ..
 // this will be core_handlers
 
@@ -168,7 +176,7 @@
 
 				$code = false;
 
-				if (strpos($error, ':')) // there shouldn't be a 0 position
+				if (mb_strpos($error, ':')) // there shouldn't be a 0 position
 				{
 					list($code, $error) = explode(':', $error, 2);
 					
@@ -195,33 +203,25 @@
 				$error = (!empty($_CLASS['core_user']-&gt;lang[$error])) ? $_CLASS['core_user']-&gt;lang[$error] : $error;
 
 				$_CLASS['core_template']-&gt;assign('MESSAGE_TEXT',  $error);
-						
-				$_CLASS['core_template']-&gt;display('error.html');
-					
-				script_close(false);
-				die;
-				
-				break;
-	
+
+				$_CLASS['core_display']-&gt;display(false, 'error.html');
+			break;
+
 			case E_USER_NOTICE:
 				$_CLASS['core_user']-&gt;user_setup();
 
-				$this-&gt;error_setting['title'] = (!empty($_CLASS['core_user']-&gt;lang[$this-&gt;error_setting['title']])) ? $_CLASS['core_user']-&gt;lang[$this-&gt;error_setting['title']] : $this-&gt;error_setting['title'];
-				
-				$error = (!empty($_CLASS['core_user']-&gt;lang[$error])) ? $_CLASS['core_user']-&gt;lang[$error] : $error;
-				
-				$_CLASS['core_display']-&gt;display_head($this-&gt;error_setting['title']);
+				$this-&gt;error_setting['title'] = empty($_CLASS['core_user']-&gt;lang[$this-&gt;error_setting['title']]) ? $this-&gt;error_setting['title'] : $_CLASS['core_user']-&gt;lang[$this-&gt;error_setting['title']];
 
-				$_CLASS['core_template']-&gt;assign(array(
+				$error = empty($_CLASS['core_user']-&gt;lang[$error]) ? $error : $_CLASS['core_user']-&gt;lang[$error];
+
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'MESSAGE_TITLE'	=&gt; $this-&gt;error_setting['title'],
 					'MESSAGE_TEXT'	=&gt; $error
 				));
-				
+
 				$this-&gt;error_setting = array('title', 'redirect');
 				
-				$_CLASS['core_template']-&gt;display('message.html');
-
-				$_CLASS['core_display']-&gt;display_footer(false);
+				$_CLASS['core_display']-&gt;display($this-&gt;error_setting['title'], 'message.html');
 			break;
 		}
 	}

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/session.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal&#169;	)								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 class sessions
 {
@@ -28,27 +34,28 @@
 
 		$this-&gt;server_local = ($_SERVER['HTTP_HOST'] == 'localhost' || $_SERVER['HTTP_HOST'] == '127.0.0.1') ? true : false;
 
-		$session_data['session_id'] = get_variable('sid', 'GET');
+		$session_id = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE');
+		$session_id_url = get_variable('sid', 'GET');
 
-		if ($cookie_sid = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE'))
+		if ($session_id_url)
 		{
 			// session id in url &gt; cookie
-			if (!$session_data['session_id'] || $cookie_sid === $session_data['session_id'])
+			if (!$session_id || $session_id_url !== $session_id)
 			{
-				$session_data['session_id'] = $cookie_sid;
-				$this-&gt;sid_link = defined('NEED_SID') ? 'sid='.$session_data['session_id'] : false;
+				$session_id = $session_id_url;
+				$this-&gt;sid_link = 'sid='.$session_id;
 			}
 		}
 		else
 		{
-			$this-&gt;sid_link = 'sid='.$session_data['session_id'];
+			$this-&gt;sid_link = defined('NEED_SID') ? 'sid='.$session_id : false;
 		}
 
-		if ($session_data['session_id'])
+		if ($session_id)
 		{
 			$sql = 'SELECT u.*, s.*
 				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . &quot; u
-				WHERE s.session_id = '&quot; . $_CLASS['core_db']-&gt;escape($session_data['session_id']) . &quot;'
+				WHERE s.session_id = '&quot; . $_CLASS['core_db']-&gt;escape($session_id) . &quot;'
 					AND u.user_id = s.session_user_id&quot;;
 					
 			$result = $_CLASS['core_db']-&gt;query($sql);
@@ -69,7 +76,7 @@
 				{
 					$check_ip = implode('.', explode('.', $this-&gt;data['session_ip'], $_CORE_CONFIG['server']['ip_check']));
 					
-					if ($check_ip != mb_substr($this-&gt;ip, 0, mb_strlen($check_ip)))
+					if ($check_ip != substr($this-&gt;ip, 0, strlen($check_ip)))
 					{
 						$valid  = false;
 					}
@@ -102,10 +109,23 @@
 			$this-&gt;data = array();
 		}
 
+		$user_id = ANONYMOUS;
+
+		$ali = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_ali', 'COOKIE', false, 'int');
+		$alc = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_alc', 'COOKIE');
+
+		if ($ali &amp;&amp; $ali)
+		{
+			if ($id = $this-&gt;autologin_retrieve($ali, $alc))
+			{
+				$user_id = $id;
+			}
+		}
+
 		check_maintance_status();
 		$this-&gt;load = check_load_status();
 
-		return $this-&gt;login();
+		return $this-&gt;login($user_id);
 	}
 
 	function can_create()
@@ -134,28 +154,32 @@
 	}
 
 	// Create a new session
-	function session_create()
+	function session_create($auto_log = false)
 	{
 		global $_CLASS, $_CORE_CONFIG, $config;
-		$auto_log = false;
 
+		if (isset($this-&gt;data['session_id']) &amp;&amp; $this-&gt;data['session_id'])
+		{
+			$this-&gt;session_destroy(false, false);
+		}
+
 		$this-&gt;data['session_last_visit'] = ($this-&gt;data['user_last_visit']) ? $this-&gt;data['user_last_visit'] : $this-&gt;time;
 
-		$session_id = (function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+		$session_id = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
 		$session_data = array(
-			'session_id'			=&gt; (string) $session_id,
-			'session_user_id'		=&gt; (int) $this-&gt;data['user_id'],
-			'session_start'			=&gt; (int) $this-&gt;time,
-			'session_time'			=&gt; (int) $this-&gt;time,
-			'session_browser'		=&gt; (string) $this-&gt;browser,
-			'session_page'			=&gt; (string) $this-&gt;page,
-			'session_url'			=&gt; (string) $this-&gt;url,
-			'session_ip'			=&gt; (string) $this-&gt;ip,
-			'session_user_type'		=&gt; (string) $this-&gt;data['user_type'],
-			'session_admin'			=&gt; (int) $this-&gt;data['session_admin'],
-			'session_auth'			=&gt; (int) serialize($_CLASS['core_auth']-&gt;auth_dump()),
-			'session_viewonline'	=&gt; (int) $this-&gt;data['session_viewonline'],
+			'session_id'		=&gt; (string) $session_id,
+			'session_user_id'	=&gt; (int) $this-&gt;data['user_id'],
+			'session_start'		=&gt; (int) $this-&gt;time,
+			'session_time'		=&gt; (int) $this-&gt;time,
+			'session_browser'	=&gt; (string) $this-&gt;browser,
+			'session_page'		=&gt; (string) $this-&gt;page,
+			'session_url'		=&gt; (string) $this-&gt;url,
+			'session_ip'		=&gt; (string) $this-&gt;ip,
+			'session_user_type'	=&gt; (int) $this-&gt;data['user_type'],
+			'session_admin'		=&gt; (int) $this-&gt;data['session_admin'],
+			'session_auth'		=&gt; (int) serialize($_CLASS['core_auth']-&gt;auth_dump()),
+			'session_hidden'	=&gt; (int) $this-&gt;data['session_hidden'],
 		);
 
 		$_CLASS['core_db']-&gt;query('INSERT INTO ' . SESSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $session_data));
@@ -174,17 +198,10 @@
 		{
 			if ($auto_log &amp;&amp; $this-&gt;is_user)
 			{
-				$cookie_data['login_code'] = $session_data['user_password'];
-				$cookie_data['user_id'] = $this-&gt;data['user_id'];
-				
-				$this-&gt;set_cookie('data', serialize($cookie_data), $this-&gt;time + 31536000);
+				$this-&gt;autologin_generate();
 			}
-			elseif ($this-&gt;new_session)
-			{
-				$this-&gt;set_cookie('data', '', 0);
-			}
 
-			$this-&gt;set_cookie('sid', $this-&gt;data['session_id'], 0);
+			$this-&gt;set_cookie('sid', $session_id, 0);
 		}
 
 		$this-&gt;sid_link = ($this-&gt;is_bot) ? false : 'sid='.$this-&gt;data['session_id'];
@@ -194,17 +211,55 @@
 		return true;
 	}
 
-	function session_destroy($session_id = false)
+	function autologin_generate()
 	{
 		global $_CLASS;
+// make this useable outside sessions
+		$code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
+		$data_array = array(
+			'user_id'				=&gt; (int) $this-&gt;data['user_id'],
+			'auto_login_browser'	=&gt; (string) $this-&gt;browser,
+			'auto_login_code'		=&gt; $code,
+			'auto_login_time'		=&gt; (int) $this-&gt;time,
+		);
+		
+		$_CLASS['core_db']-&gt;query('INSERT INTO ' . SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']-&gt;sql_build_array('INSERT', $data_array));
+	
+		$this-&gt;set_cookie('ali', $this-&gt;data['user_id'], $this-&gt;time + 31536000);
+		$this-&gt;set_cookie('alc', $code, $this-&gt;time + 31536000);
+	}
+
+	function autologin_retrieve($user_id, $code)
+	{
+		global $_CLASS;
+		
+		$sql = 'SELECT *
+			FROM ' . SESSIONS_AUTOLOGIN_TABLE . &quot; 
+			WHERE user_id = $user_id
+			AND auto_login_code = '&quot; . $_CLASS['core_db']-&gt;escape($code) . &quot;'&quot;;
+				
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		// This is about all you can validate other than the code, and user_id
+		return ($row &amp;&amp; $row['auto_login_browser'] == $this-&gt;browser) ? $user_id : false;
+	}
+
+	function session_destroy($session_id = false, $remove_cookie = true)
+	{
+		global $_CLASS;
+
 		if (!$session_id)
 		{
 			$session_id = $this-&gt;data['session_id'];
 			
-			$this-&gt;set_cookie('data', '', $this-&gt;time - 31536000);
-			$this-&gt;set_cookie('sid', '', $this-&gt;time - 31536000);
-			
+			if ($remove_cookie)
+			{
+				$this-&gt;set_cookie('sid', '', $this-&gt;time - 31536000);
+			}
+
 			if ($this-&gt;data['session_time'])
 			{
 				$sql = 'UPDATE ' . USERS_TABLE . '
@@ -219,9 +274,11 @@
 
 		$_CLASS['core_db']-&gt;query($sql);
 	}
-	
+
 	function gc($time)
 	{
+// Add auto login cleaning
+// Move to cron
 		global $_CORE_CONFIG, $_CLASS;
 
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . '

Modified: trunk/includes/system.php
===================================================================
--- trunk/includes/system.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/system.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,17 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 function confirmation_image($code = false, $size = false)
 {
@@ -140,18 +146,78 @@
 		$x += $font_width * (($width_addition) ? mt_rand(2, 5) : 1);
 	}
 
-	//imagepng($im);
+	imagepng($im);
 	imagedestroy($im);
 }
 
-function login()
+function activate()
 {
 	global $_CLASS;
 
-	$login_options = array(
-		'full_screen'	=&gt; isset($_REQUEST['full']),
+	$user_id = get_variable('user_id', 'GET', 0, 'integer');
+	$key = get_variable('key', 'GET', false);
+
+	if (!$user_id || !$key)
+	{
+		trigger_error('CANT_ACTIVATED');
+	}
+	
+	$sql = 'SELECT username, user_status, user_email, user_new_password, user_new_password_encoding, user_act_key
+		FROM ' . USERS_TABLE . &quot; WHERE user_id = $user_id AND user_type = &quot;.USER_NORMAL;
+
+	$result = $_CLASS['core_db']-&gt;sql_query($sql);
+	$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
+	$_CLASS['core_db']-&gt;sql_freeresult($result);
+
+	if (!$row)
+	{
+		trigger_error('NO_USER');
+	}
+	
+	if ($row['user_status'] != USER_UNACTIVATED &amp;&amp; !$row['user_new_password'])
+	{
+		trigger_error(($row['user_status'] == USER_ACTIVE) ? 'ALREADY_ACTIVATED' : 'CANT_ACTIVATED');
+	}
+	
+	if ($row['user_act_key'] != $key)
+	{
+		trigger_error('WRONG_ACTIVATION_KEY');
+	}
+
+	$sql_ary = array(
+		'user_act_key'				=&gt; null,
+		'user_new_password'			=&gt; null,
+		'user_new_password_encoding'=&gt; null
 	);
+
+	if ($row['user_new_password'])
+	{
+		$sql_ary += array(
+			'user_password'				=&gt; $row['user_new_password'],
+			'user_password_encoding'	=&gt; $row['user_new_password_encoding'],
+		);
+	}
+	else
+	{
+		include_once($site_file_root.'includes/functions_user.php');
+		user_activate($user_id);
 		
-	$_CLASS['core_auth']-&gt;do_login($login_options, $template);
+		set_core_config('user', 'newest_user_id', $row['user_id'], false);
+		set_core_config('user', 'newest_username', $row['username'], false);
+	}
+
+	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
+		WHERE user_id = ' . $row['user_id'];
+	$result = $_CLASS['core_db']-&gt;sql_query($sql);
 }
+
+function login()
+{
+	global $_CLASS;
+
+	$login_options = array('full_screen' =&gt; isset($_REQUEST['full']));
+		
+	$_CLASS['core_auth']-&gt;do_login($login_options, false);
+}
+
 ?&gt;
\ No newline at end of file

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/includes/user.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,5 +1,25 @@
 &lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
+// sessions should extend this
 class core_user extends sessions
 {
 	var $browser;
@@ -76,15 +96,10 @@
 		return $time + $this-&gt;timezone + $this-&gt;dst;
 	}
 
-	function login($id = ANONYMOUS, $admin_login = false, $view_online = true)
+	function login($id = ANONYMOUS, $admin_login = false, $hidden = false, $auto_log = false)
 	{
 		global $_CLASS;
 
-		if (isset($this-&gt;data['session_id']) &amp;&amp; $this-&gt;data['session_id'])
-		{
-			$this-&gt;session_destroy();
-		}
-
 		if ($bot = check_bot_status($this-&gt;browser, $this-&gt;ip))
 		{
 			$id = $bot;
@@ -139,9 +154,9 @@
 		}
 
 		$this-&gt;is_admin = ($this-&gt;data['session_admin'] == ADMIN_IS_ADMIN);
-		$this-&gt;data['session_viewonline'] = $view_online;
+		$this-&gt;data['session_hidden'] = $hidden;
 
-		$this-&gt;session_create();
+		$this-&gt;session_create($auto_log);
 	}
 
 	function logout()
@@ -149,7 +164,7 @@
 		global $_CLASS;
 
 		$this-&gt;session_destroy();
-		
+// do last visit update here
 		$sql = 'SELECT *
 			FROM ' . USERS_TABLE . '
 			WHERE user_id = ' . ANONYMOUS;

Modified: trunk/modules/Contact/index.php
===================================================================
--- trunk/modules/Contact/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Contact/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -18,58 +18,30 @@
     die;
 }
 
+$_CLASS['core_user']-&gt;user_setup();
 $_CLASS['core_user']-&gt;add_lang();
 
-function send_feedback($sender_name, $sender_email, $message, $preview = false)
-{
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']-&gt;assign(array(
-		'SENT_FROM'		=&gt; $sender_name,
-		'SENDER_NAME'	=&gt; $sender_name,
-		'SENDER_EMAIL'	=&gt; $sender_email,
-		'SENDER_IP'		=&gt; $_CLASS['core_user']-&gt;ip,
-
-		'MESSAGE' 		=&gt; $message,
-	));
-	
-	$body = $_CLASS['core_template']-&gt;display('modules/Contact/email/index.html', true);
-
-	if ($preview)
-	{
-		$_CLASS['core_template']-&gt;assign('PREVIEW', $body);
-		return;
-	}
-
-	//include_once(
-	//print $body;
-}
-
-
 $error = '';
 
-If (!empty($_POST['preview']) || !empty($_POST['contact']))
+if (!empty($_POST['preview']) || !empty($_POST['contact']))
 {
 	$data['MESSAGE']= get_variable('message', 'POST', '');
 	$data['NAME']	= get_variable('sender_name', 'POST', '');
 	$data['EMAIL']	= get_variable('sender_email', 'POST', '');
-    
 
 	foreach ($data as $field =&gt; $value)
 	{
 		if (!$value)
 		{
-				$error .= $_CLASS['core_user']-&gt;lang['ERROR_'.$field].'&lt;br /&gt;';
-				unset($field, $value, $lang);
-				
+			$error .= $_CLASS['core_user']-&gt;lang['ERROR_'.$field].'&lt;br /&gt;';
+			unset($field, $value, $lang);
         }
         elseif ($field == 'EMAIL' &amp;&amp; !check_email($value))
         {
-        
 			$error .= $_CLASS['core_user']-&gt;lang['BAD_EMAIL'].'&lt;br /&gt;';
 		}
 	} 
-	
+
 	if (!empty($_POST['preview']) &amp;&amp; $data['MESSAGE'])
 	{
 		send_feedback($data['NAME'],  $data['EMAIL'], $data['MESSAGE'], $preview = true);
@@ -90,15 +62,42 @@
 	$message = '';
 }
 
-	
-$_CLASS['core_template']-&gt;assign(array( 
+$_CLASS['core_template']-&gt;assign_array(array( 
 	'ERROR' 				=&gt; $error,
 	'MESSAGE' 				=&gt; $message,
 	'ACTION' 				=&gt; generate_link($_CORE_MODULE['name']),
 	'SENDER_EMAIL' 			=&gt; $sender_email,
 	'SENDER_NAME' 			=&gt; $sender_name,
 ));
-		
+
 $_CLASS['core_template']-&gt;display('modules/Contact/index.html');
 
+function send_feedback($sender_name, $sender_email, $message, $preview = false)
+{
+	global $_CLASS, $_CORE_CONFIG;
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'SENT_FROM'		=&gt; $sender_name,
+		'SENDER_NAME'	=&gt; $sender_name,
+		'SENDER_EMAIL'	=&gt; $sender_email,
+		'SENDER_IP'		=&gt; $_CLASS['core_user']-&gt;ip,
+		'MESSAGE' 		=&gt; $message,
+	));
+
+	$body = trim($_CLASS['core_template']-&gt;display('modules/Contact/email/index.html', true));
+
+	if ($preview)
+	{
+		$_CLASS['core_template']-&gt;assign('PREVIEW', $body);
+		return;
+	}
+
+	$mailer = new core_mailer;
+	$mailer-&gt;to('<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">newuser at localhost</A>', 'Viperal');
+	$mailer-&gt;subject('New Feedback');
+
+	$mailer-&gt;message = $body;
+
+	trigger_error($mailer-&gt;send() ? 'SEND_SUCCESSFULL' : $mailer-&gt;error);
+}
 ?&gt;
\ No newline at end of file

Modified: trunk/modules/Control_Panel/index.php
===================================================================
--- trunk/modules/Control_Panel/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -32,14 +32,14 @@
 require($site_file_root.'includes/forums/functions_user.php');
 
 //define the undefineds
-$_CLASS['core_template']-&gt;assign(array(
+$_CLASS['core_template']-&gt;assign_array(array(
 	'S_DISPLAY_FORM'		=&gt; true,
 	'S_SHOW_PM_BOX'			=&gt; false,
 	'S_SHOW_COLOUR_LEGEND'	=&gt; false,
 	'USERNAME'				=&gt; '',
 	'friends_online'		=&gt; false,
 	'friends_offline' 		=&gt; false,
-	));
+));
 
 // ---------
 // FUNCTIONS
@@ -57,7 +57,7 @@
 		global $_CLASS, $config;
 
 		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . MODULES_TABLE . &quot;
+			FROM ' . FORUMS_MODULES_TABLE . &quot;
 			WHERE module_type = '{$module_type}'
 				AND module_enabled = 1
 			ORDER BY module_order ASC&quot;;
@@ -206,7 +206,7 @@
 
         $_CLASS['core_template']-&gt;display('modules/Control_Panel/'.$tpl_name);
 
-		die;
+		script_close();
 	}
 
 	// Public methods to be overwritten by modules
@@ -261,7 +261,7 @@
 	case 'register':
 		if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS || isset($_REQUEST['not_agreed']))
 		{
-			url_redirect();
+			redirect();
 		}
 
 		$ucp-&gt;load('ucp', 'register');
@@ -276,7 +276,7 @@
 	case 'login':
 		if ($_CLASS['core_user']-&gt;is_user || $_CLASS['core_user']-&gt;is_bot)
 		{
-			url_redirect();
+			redirect();
 		}
 
 		login_box();
@@ -326,7 +326,7 @@
 			confirm_box(false, 'DELETE_COOKIES', '');
 		}
 		
-		url_redirect();
+		redirect();
 		break;
 }
 
@@ -345,7 +345,7 @@
 // Output listing of friends online
 $update_time = $config['load_online_time'] * 60;
 
-$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_viewonline
+$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
 	FROM ' . USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
 	LEFT JOIN ' . SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
 	WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 

Deleted: trunk/modules/Control_Panel/ucp/ucp_activate.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_activate.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_activate.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,115 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_activate.php,v 1.8 2004/05/26 20:16:20 acydburn Exp $
-//
-// FILENAME  : ucp_activate.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
- 
-class ucp_activate extends module 
-{
-	function ucp_activate($id, $mode)
-	{
-		global $config, $_CORE_CONFIG, $_CLASS, $site_file_root;
-
-		//$user_id = request_var('u', 0);
-		$user_id = get_variable('u', 'REQUEST', 0, 'integer')
-		$key = request_var('k', '');
-
-		$sql = 'SELECT user_id, username, user_type, user_email, user_newpasswd, user_lang, user_notify_type, user_actkey
-			FROM ' . USERS_TABLE . &quot;
-			WHERE user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_USER']);
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-		if ($row['user_type'] &lt;&gt; USER_INACTIVE &amp;&amp; !$row['user_newpasswd'])
-		{
-			$_CLASS['core_display']-&gt;meta_refresh(3);
-			trigger_error($_CLASS['core_user']-&gt;lang['ALREADY_ACTIVATED']);
-		}
-		
-		if ($row['user_actkey'] != $key)
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['WRONG_ACTIVATION']);
-		}
-
-		$update_password = ($row['user_newpasswd']) ? true : false;
-
-		if ($update_password)
-		{
-			$sql_ary = array(
-				'user_type'			=&gt; USER_NORMAL,
-				'user_actkey'		=&gt; '',
-				'user_password'		=&gt; $row['user_newpasswd'],
-				'user_newpasswd'	=&gt; ''
-			);
-
-			$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
-				WHERE user_id = ' . $row['user_id'];
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		}
-		
-		// TODO: check for group membership after password update... active_flip there too
-		if (!$update_password)
-		{
-			// Now we need to demote the user from the inactive group and add him to the registered group
-
-			include_once($site_file_root.'includes/forums/functions_user.php');
-			user_active_flip($row['user_id'], $row['user_type'], '', $row['username']);
-		}
-		
-		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN &amp;&amp; !$update_password)
-		{
-			include_once($site_file_root.'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger();
-
-			$messenger-&gt;template('admin_welcome_activated', $row['user_lang']);
-			
-			$messenger-&gt;replyto($config['board_contact']);
-			$messenger-&gt;to($row['user_email'], $row['username']);
-
-			$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-			$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-			$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-			$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
-
-			$messenger-&gt;assign_vars(array(
-				'SITENAME'	=&gt; $_CORE_CONFIG['global']['sitename'],
-				'USERNAME'	=&gt; $row['username'],
-				'EMAIL_SIG' =&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']))
-			);
-
-			$messenger-&gt;send($row['user_notify_type']);
-			$messenger-&gt;save_queue();
-
-			$message = 'ACCOUNT_ACTIVE_ADMIN';
-		}
-		else
-		{
-			$message = (!$update_password) ? 'ACCOUNT_ACTIVE' : 'PASSWORD_ACTIVATED';
-		}
-
-		if (!$update_password)
-		{
-			set_config('newest_user_id', $row['user_id']);
-			set_config('newest_username', $row['username']);
-			set_config('num_users', $config['num_users'] + 1, TRUE);
-		}
-
-		$_CLASS['core_display']-&gt;meta_refresh(3, generate_link());
-		trigger_error($_CLASS['core_user']-&gt;lang[$message]);
-	}
-}
-
-?&gt;
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -34,7 +34,7 @@
 				$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;attachment[' . $attachment_id . ']&quot; value=&quot;1&quot; /&gt;';
 			}
 
-			if (confirm_box(true))
+			if (display_confirmation($_CLASS['core_user']-&gt;get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), $s_hidden_fields))
 			{
 				require($site_file_root.'includes/forums/functions_admin.php');
 				delete_attachments('attach', $delete_ids);
@@ -44,10 +44,6 @@
 				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']-&gt;lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']-&gt;lang['ATTACHMENTS_DELETED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $refresh_url . '&quot;&gt;', '&lt;/a&gt;');
 				trigger_error($message);
 			}
-			else
-			{
-				confirm_box(false, (sizeof($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS', $s_hidden_fields);
-			}
 		}
 		
 		$sort_key = request_var('sk', 'a');
@@ -76,24 +72,24 @@
 		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
 		
 		$sql = 'SELECT COUNT(*) as num_attachments
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-		$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, 1);
-		$num_attachments = $_CLASS['core_db']-&gt;sql_fetchfield('num_attachments', 0, $result);
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		list($num_attachments) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 		
 		$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
-			FROM ' . ATTACHMENTS_TABLE . ' a 
-				LEFT JOIN ' . TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
+				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
 					AND a.in_message = 0)
-				LEFT JOIN ' . PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
+				LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
 					AND a.in_message = 1)
 			WHERE a.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 			ORDER BY $order_by&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, $config['posts_per_page'], $start);
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['posts_per_page'], $start);
 
 		$row_count = 0;
-		if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', true);
 
@@ -130,9 +126,9 @@
 
 				$row_count++;
 			} 
-			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
 		$_CLASS['core_template']-&gt;assign(array( 
 			'PAGE_NUMBER'			=&gt; on_page($num_attachments, $config['posts_per_page'], $start),

Deleted: trunk/modules/Control_Panel/ucp/ucp_confirm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_confirm.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_confirm.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,28 +0,0 @@
-&lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )						 		//
-//																//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-/*
-	For phpBB3 mods
-*/
-
-class ucp_confirm extends module 
-{
-	function ucp_confirm($id, $mode)
-	{
-		include_once($site_file_root.'includes/system.php');
-		confirmation_image();
-	}
-}
-
-?&gt;
\ No newline at end of file

Deleted: trunk/modules/Control_Panel/ucp/ucp_confirm_old.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_confirm_old.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_confirm_old.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,426 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_confirm.php,v 1.5 2004/05/26 20:16:20 acydburn Exp $
-//
-// FILENAME  : ucp_confirm.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// Note to potential users of this code ...
-//
-// Remember this is released under the _GPL_ and is subject
-// to that licence. Do not incorporate this within software 
-// released or distributed in any way under a licence other
-// than the GPL. We will be watching ... ;)
-
-class ucp_confirm extends module 
-{
-	function ucp_confirm($id, $mode)
-	{
-		global $config, $_CLASS;
-		
-		// Do we have an id? No, then just exit
-		$confirm_id = request_var('id', '');
-
-		if (!$confirm_id)
-		{
-			exit;
-		}
-
-		// Define available charset
-		$chars = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',  'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',  'U', 'V', 'W', 'X', 'Y', 'Z', '1', '2', '3', '4', '5', '6', '7', '8', '9');
-
-		// Try and grab code for this id and session
-		$sql = 'SELECT code  
-			FROM ' . CONFIRM_TABLE . &quot; 
-			WHERE session_id = '&quot; . $_CLASS['core_db']-&gt;sql_escape($_CLASS['core_user']-&gt;data['session_id']) . &quot;' 
-				AND confirm_id = '&quot; . $_CLASS['core_db']-&gt;sql_escape($confirm_id) . &quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		// If we have a row then grab data else create a new id
-		if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-			$code = $row['code'];
-		}
-		else
-		{
-			exit;
-		}
-
-		// If we can we will generate a single filtered png else we will have to simply
-		// output six seperate original pngs ... first way is preferable!
-		if (@extension_loaded('zlib'))
-		{
-			$_png = $this-&gt;define_filtered_pngs();
-
-			$total_width = 320;
-			$total_height = 50;
-			$img_height = 40;
-			$img_width = 0;
-			$l = 0;
-
-			list($usec, $sec) = explode(' ', microtime()); 
-			mt_srand($sec * $usec); 
-
-			$char_widths = array();
-			for ($i = 0; $i &lt; strlen($code); $i++)
-			{
-				$char = $code{$i};
-
-				$width = mt_rand(0, 4);
-				$char_widths[] = $width;
-				$img_width += $_png[$char]['width'] - $width;
-			}
-
-			$offset_x = mt_rand(0, $total_width - $img_width);
-			$offset_y = mt_rand(0, $total_height - $img_height);
-
-			$image = '';
-			$hold_chars = array();
-			for ($i = 0; $i &lt; $total_height; $i++)
-			{
-				$image .= chr(0);
-
-				if ($i &gt; $offset_y &amp;&amp; $i &lt; $offset_y + $img_height)
-				{
-					$j = 0;
-
-					for ($k = 0; $k &lt; $offset_x; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-
-					for ($k = 0; $k &lt; strlen($code); $k++)
-					{
-						$char = $code{$k};
-
-						if (empty($hold_chars[$char]))
-						{
-							$hold_chars[$char] = explode(&quot;\n&quot;, chunk_split(base64_decode($_png[$char]['data']), $_png[$char]['width'] + 1, &quot;\n&quot;));
-						}
-						$image .= $this-&gt;randomise(substr($hold_chars[$char][$l], 1), $char_widths[$j]);
-						$j++;
-					}
-
-					for ($k = $offset_x + $img_width; $k &lt; $total_width; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-
-					$l++;
-				}
-				else
-				{
-					for ($k = 0; $k &lt; $total_width; $k++)
-					{
-						$image .= chr(mt_rand(140, 255));
-					}
-				}
-
-			}
-			unset($hold);
-
-			$image = $this-&gt;create_png(gzcompress($image), $total_width, $total_height);
-
-			// Output image
-			header('Content-Type: image/png');
-			header('Cache-control: no-cache, no-store');
-			echo $image;
-
-			unset($image);
-			unset($_png);
-			exit;
-
-		}
-		else
-		{
-			$char = request_var('c', 0);
-
-			if ($char)
-			{
-				$_png = $this-&gt;define_raw_pngs();
-
-				$char = substr($code, $char - 1, 1);
-				header('Content-Type: image/png');
-				header('Cache-control: no-cache, no-store');
-				echo base64_decode($_png[$char]);
-
-				unset($_png);
-				exit;
-			}
-		}
-
-		exit;
-	}
-
-	// This is designed to randomise the pixels of the image data within
-	// certain limits so as to keep it readable. It also varies the image
-	// width a little
-	function randomise($scanline, $width)
-	{
-		$new_line = '';
-		$start = floor($width/2);
-		$end = strlen($scanline) - ceil($width/2);
-
-		for ($i = $start; $i &lt; $end; $i++)
-		{
-			$pixel = ord($scanline{$i});
-
-			if ($pixel &lt; 190)
-			{
-				$new_line .= chr(mt_rand(0, 205));
-			}
-			else if ($pixel &gt; 190)
-			{
-				$new_line .= chr(mt_rand(145, 255));
-			}
-			else
-			{
-				$new_line .= $scanline{$i};
-			}
-		}
-
-		return $new_line;
-	}
-
-	// This creates a chunk of the given type, with the given data
-	// of the given length adding the relevant crc
-	function png_chunk($length, $type, $data)
-	{
-		$raw = $type;
-		$raw .= $data;
-		$crc = crc32($raw);
-		$raw .= pack('C4', $crc &gt;&gt; 24, $crc &gt;&gt; 16, $crc &gt;&gt; 8, $crc);
-
-		return pack('C4', $length &gt;&gt; 24, $length &gt;&gt; 16, $length &gt;&gt; 8, $length) . $raw;
-	}
-
-	// Creates greyscale 8bit png - The PNG spec can be found at
-	// <A HREF="http://www.libpng.org/pub/png/spec/PNG-Contents.html">http://www.libpng.org/pub/png/spec/PNG-Contents.html</A> we use
-	// png because it's a fully recognised open standard and supported
-	// by practically all modern browsers and OSs
-	function create_png($gzimage, $width, $height)
-	{
-		// SIG
-		$image = pack('C8', 137, 80, 78, 71, 13, 10, 26, 10);
-		// IHDR
-		$raw = pack('C4', $width &gt;&gt; 24, $width &gt;&gt; 16, $width &gt;&gt; 8, $width);
-		$raw .= pack('C4', $height &gt;&gt; 24, $height &gt;&gt; 16, $height &gt;&gt; 8, $height);
-		$raw .= pack('C5', 8, 0, 0, 0, 0);
-		$image .= $this-&gt;png_chunk(13, 'IHDR', $raw);
-		// IDAT
-		$image .= $this-&gt;png_chunk(strlen($gzimage), 'IDAT', $gzimage);
-		// IEND
-		$image .= $this-&gt;png_chunk(0, 'IEND', '');
-
-		return $image;
-	}
-
-	// Each 'data' element is base64_encoded uncompressed IDAT
-	// png image data
-	function define_filtered_pngs()
-	{
-		$_png = array(
-			'0' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A///////////////////olFAkBAAAGDyA4P///M31/////////////wD////////////////0dAgAAAAAAAAAAAAEcPipFGHn////////////AP//////////////6DAAAAAAAAAAAAAAAAAALSEAN+T///////////8A//////////////xAAAAAAAAAAAAAAAAAAAAAACPA/////////////wD/////////////oAAAAAAAAAAAAAAAAAAAAAAAev//////////////AP////////////8oAAAAAAAAPNj/zDAAAAAAAABD//////////////8A////////////1AAAAAAAABjw////5BAAAAAAAADo/////////////wD///////////+QAAAAAAAAbP//////QgAAAAAAAKj/////////////AP///////////1wAAAAAAACs/////8AXAAAAAAAAcP////////////8A////////////OAAAAAAAAND////dNwAAAAAAAABI/////////////wD///////////8gAAAAAAAA4P//7koACwAAAAAAACT//!
 ///////////AP///////////wgAAAAAAAD///VqAwaPAAAAAAAAEP////////////8A////////////AAAAAAAAAP/8kQYDavUAAAAAAAAA/////////////wD///////////8AAAAAAAAA/6kNAEru/wAAAAAAAAD/////////////AP///////////wAAAAAAAADAIwA33f//AAAAAAAAAP////////////8A////////////FAAAAAAAADYAI8D///8AAAAAAAAQ/////////////wD///////////8kAAAAAAAAAA2p////5AAAAAAAACD/////////////AP///////////0gAAAAAAAAFkfz////UAAAAAAAAQP////////////8A////////////cAAAAAAAAET1/////7AAAAAAAABo/////////////wD///////////+oAAAAAAAAXfX/////sAAAAAAAAGj/////////////AAAAALgAAAAAAAAwAAAAAAAAAAAAAAD////////////oAAAAAAAACOT////oEAAAAAAAAOD/////////////AP////////////8+AAAAAAAAKMz/zDQAAAAAAAA0//////////////8A////////////7jgAAAAAAAAAAAAAAAAAAAAAAKT//////////////wD///////////VqAwIAAAAAAAAAAAAAAAAAAAA8////////////////AP//////////rQcDaVEAAAAAAAAAAAAAAAAAKOj///////////////8A///////////nblnu/IAIAAAAAAAAAAAAAFzw/////////////////wD////////////79////+iITCAAAAAgSITg////////////////////AP////////////////////////////////////////////////////8A/////////////////!
 ////////////////////////////////////wD////////////////////////!
 ////////
/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////w==', 
-				'width' =&gt; 40
-			), 
-			'1' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////8BAAAAAAAP//////////////////AP////////////////////////9sAAAAAAAA//////////////////8A////////////////////////pAAAAAAAAAD//////////////////wD//////////////////////6wEAAAAAAAAAP//////////////////AP////////////////////h4AAAAAAAAAAAA//////////////////8A//////////////////ygJAAAAAAAAAAAAAD//////////////////wD//////////////9x8HAAAAAAAAAAAAAAAAP//////////////////AP//////////////AAAAAAAAAAAAAAAAAAAA//////////////////8A//////////////8AAAAAAAAAAAAAAAAAAAD//////////////////wD//////////////wAAAAAAAAR4AAAAAAAAAP//////////////////AP//////////////AAAAAAA4zP8AAAAAAAAA//////////////////8A//////////////8AAAA4sP///wAAAAAAAAD//////////////////wD//////////////yR80P//////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP///////!
 ///////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////AAAAAAAAAP//////////////////AP////////////////////////8AAAAAAAAA//////////////////8A/////////////////////////wAAAAAAAAD//////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'2' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP/////////////////okFAkCAAABCBIfNT///////////////////8A///////////////8hAgAAAAAAAAAAAAAAFTo/////////////////wD//////////////1QAAAAAAAAAAAAAAAAAACjo////////////////AP////////////+MAAAAAAAAAAAAAAAAAAAAADj///////////////8A////////////9BAAAAAAAAAAAAAAAAAAAAAAALD//////////////wD///////////+gAAAAAAAAAHjs+KwMAAAAAAAAVP///!
 ///////////AP///////////1gAAAAAAABM/////6QAAAAAAAAU//////////////8A////////////KAAAAAAAALj/////+AAAAAAAAAD//////////////wD///////////+MfGBMOCAI8P/////wAAAAAAAACP//////////////AP///////////////////////////5wAAAAAAAAw//////////////8A///////////////////////////oFAAAAAAAAHz//////////////wD/////////////////////////6CgAAAAAAAAE3P//////////////AP///////////////////////9ggAAAAAAAAAHT///////////////8A//////////////////////+0DAAAAAAAAAA8+P///////////////wD/////////////////////gAAAAAAAAAAAKOj/////////////////AP//////////////////9FAAAAAAAAAAADzw//////////////////8A/////////////////+g4AAAAAAAAAABk/P///////////////////wD////////////////oKAAAAAAAAAAMqP//////////////////////AP//////////////6CgAAAAAAAAAMNz///////////////////////8A//////////////g4AAAAAAAAAFT0/////////////////////////wD/////////////bAAAAAAAAABU/P//////////////////////////AP///////////8wAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A////////////SAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////9wAAAAAAAAAAAAAAAAAAAAAAAAAAP///////!
 ///////AP//////////hAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8!
 A///////
///9AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////xAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'3' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD////////////////8sGg0FAAAACA4cLz8////////////////////AP//////////////rBgAAAAAAAAAAAAAACTA//////////////////8A/////////////3QAAAAAAAAAAAAAAAAAAASs/////////////////wD///////////+YAAAAAAAAAAAAAAAAAAAAAAjc////////////////AP//////////6AwAAAAAAAAAAAAAAAAAAAAAAGT///////////////8A//////////94AAAAAAAABJDw/8g4AAAAAAAAHP///////////////wD//////////yAAAAAAAACE/////9gAAAAAAAAA////////////////AP///////////NSwiGQ4FOT//////AAAAAAAABD///////////////8A//////////////////////////+YAAAAAAAAVP///////////////wD//////////////////////P/ggAQAAAAAAATM/////!
 ///////////AP////////////////////9gAAAAAAAAAAAElP////////////////8A/////////////////////0AAAAAAAAAAHLj//////////////////wD/////////////////////OAAAAAAAAAAwkPj/////////////////AP////////////////////8gAAAAAAAAAAAAINj///////////////8A/////////////////////xAAAAAAAAAAAAAAIPD//////////////wD/////////////////////uOz/4HgEAAAAAAAAhP//////////////AP///////////////////////////3wAAAAAAAAw//////////////8A////////////////////////////6AAAAAAAAAj//////////////wD/////////////////////////////AAAAAAAAAP//////////////AP//////////tJh8YEQoDNz//////+AAAAAAAAAY//////////////8A//////////88AAAAAAAAaP//////dAAAAAAAAEz//////////////wD//////////6QAAAAAAAAAdOD/5HQAAAAAAAAApP//////////////AP///////////CgAAAAAAAAAAAAAAAAAAAAAACD4//////////////8A////////////yAQAAAAAAAAAAAAAAAAAAAAEuP///////////////wD/////////////rAQAAAAAAAAAAAAAAAAABJD/////////////////AP//////////////zDQAAAAAAAAAAAAAACTA//////////////////8A/////////////////8BwOCAAAAAUNGi0/P///////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'4' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////////////////nAAAAAAAAAD///////////////8A/////////////////////////8AEAAAAAAAAAP///////////////wD////////////////////////gGAAAAAAAAAAA////////////////AP//////////////////////9DAAAAAAAAAAAAD///////////////8A//////////////////////9UAAAAAAAAAAAAAP///////////////wD/////////////////////hAAAAAAAAAAAAAAA////////////////AP///////////////////7QAAAAAAAAAAAAAAAD///////////////8A///////////////////UDAAAAAAUAAAAAAAAAP///////////////wD/////////////////7CQAAAAABMAAAAAAAAAA////////////////AP////////////////xEAAAAAACU/wAAAAAAAAD///////////////8A////////////////cAAAAAAAZP//AAAAAAAAAP///////////////wD//////////////6AAAAAAADz8//8AAAAAAAAA////////////////AP/////////////IBAAAAAAc6P///wAAAAAAAAD///////////////8A////////////5BgAAAAADMz/////AAAAAAAAAP///////////////wD///////////g0AAAAAACk//////8AAAAAAAAA/////!
 ///////////AP//////////XAAAAAAAfP///////wAAAAAAAAD///////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A////////////////////////////AAAAAAAAAP///////////////wD///////////////////////////8AAAAAAAAA////////////////AP///////////////////////////wAAAAAAAAD///////////////8A////////////////////////////AAAAAAAAAP///////////////wD///////////////////////////8AAAAAAAAA////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'5' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////8AAAAAAAAAAAAAAAAAAAAAAA//////////////8A///////////////MAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////////6wAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////////iAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////////9kAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////////0QAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////////IAAAAAAAYP////////////////////////////8A//////////////wAAAAAAAB8/////////////////////////////wD/////////////3AAAAAAAAIj//////////////////!
 ///////////AP////////////+4AAAAAAAAoLRYHAAEKGTE//////////////////8A/////////////5QAAAAAAAAQAAAAAAAAAABY9P///////////////wD/////////////dAAAAAAAAAAAAAAAAAAAAAA89P//////////////AP////////////9QAAAAAAAAAAAAAAAAAAAAAABg//////////////8A/////////////zAAAAAAAAAAAAAAAAAAAAAAAADQ/////////////wD/////////////IAAAAAAAAGjY/+h4BAAAAAAAAGz/////////////AP//////////////9NS0lHSc//////90AAAAAAAALP////////////8A/////////////////////////////9QAAAAAAAAE/////////////wD//////////////////////////////wAAAAAAAAD/////////////AP/////////////////////////////8AAAAAAAAEP////////////8A////////////pIRwWEAgDOD//////8wAAAAAAAA8/////////////wD///////////9EAAAAAAAAaP//////ZAAAAAAAAHz/////////////AP///////////6QAAAAAAAAAaOD/4GQAAAAAAAAE4P////////////8A/////////////CQAAAAAAAAAAAAAAAAAAAAAAGD//////////////wD/////////////yAQAAAAAAAAAAAAAAAAAAAAc7P//////////////AP//////////////rAwAAAAAAAAAAAAAAAAAGNj///////////////8A////////////////0EAAAAAAAAAAAAAAAFTo/////////////////wD//////////////////8h4QCAAAAAcQHzU/////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'6' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////////////+0ZCwMAAAUNGjI////////////////////AP/////////////////EMAAAAAAAAAAAAABM6P////////////////8A////////////////lAQAAAAAAAAAAAAAAAAo6P///////////////wD//////////////6wAAAAAAAAAAAAAAAAAAABI////////////////AP/////////////oEAAAAAAAAAAAAAAAAAAAAACw//////////////8A/////////////3AAAAAAAAAoxP/YPAAAAAAAAEj//////////////wD////////////4EAAAAAAACOD////YDCBAVGiAoP//////////////AP///////////7gAAAAAAABY//////////////////////////////8A////////////eAAAAAAAAJT//////////////////////////////wD///////////9MAAAAAAAAvP/IXBgABCx03P//////////////////AP///////////ygAAAAAAADcdAAAAAAAAAAEiP////////////////8A////////////FAAAAAAAAFAAAAAAAAAAAAAAcP///////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAlP//////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAQ8P////////////8A////////////AAAAAAAAAABAyP/kZAAAAAAAAACQ/////////////wD///////////8MAAAAAAAALPj/////WAAAAAAAAET//!
 ///////////AP///////////yQAAAAAAACY///////MAAAAAAAAFP////////////8A////////////SAAAAAAAAMD///////wAAAAAAAAA/////////////wD///////////9wAAAAAAAAvP///////wAAAAAAAAD/////////////AP///////////7QAAAAAAACI///////UAAAAAAAAJP////////////8A////////////+AwAAAAAACDw/////2wAAAAAAABY/////////////wD/////////////cAAAAAAAADC8/Ox4AAAAAAAAAKj/////////////AP/////////////oEAAAAAAAAAAAAAAAAAAAAAAk/P////////////8A//////////////+oAAAAAAAAAAAAAAAAAAAABLj//////////////wD///////////////+QAAAAAAAAAAAAAAAAAACQ////////////////AP////////////////+0JAAAAAAAAAAAAAAkuP////////////////8A///////////////////8sGg0FAAADCxgqPz//////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'7' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAABP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAy4/////////////wD//////////////////////////+QUAAAAAAAEuP///!
 ///////////AP/////////////////////////8QAAAAAAAAKT///////////////8A/////////////////////////4wAAAAAAAB0/////////////////wD////////////////////////cCAAAAAAANPz/////////////////AP///////////////////////0QAAAAAAATY//////////////////8A//////////////////////+0AAAAAAAAeP///////////////////wD//////////////////////CQAAAAAABTw////////////////////AP////////////////////+gAAAAAAAAkP////////////////////8A/////////////////////ywAAAAAABDw/////////////////////wD///////////////////+4AAAAAAAAbP//////////////////////AP///////////////////1wAAAAAAADQ//////////////////////8A///////////////////4DAAAAAAAMP///////////////////////wD//////////////////7QAAAAAAAB8////////////////////////AP//////////////////aAAAAAAAAMj///////////////////////8A//////////////////8oAAAAAAAM/P///////////////////////wD/////////////////8AAAAAAAAET/////////////////////////AP////////////////+0AAAAAAAAcP////////////////////////8A/////////////////4wAAAAAAACY/////////////////////////wD/////////////////WAAAAAAAAMD//////////////////!
 ///////AP////////////////80AAAAAAAA4P////////////////////////8!
 A///////
//////////xAAAAAAAAD4/////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'8' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD////////////////////IdDQUAAAEIEiA1P//////////////////AP/////////////////gRAAAAAAAAAAAAAAAROD///////////////8A////////////////0BgAAAAAAAAAAAAAAAAAEMj//////////////wD///////////////AcAAAAAAAAAAAAAAAAAAAAHPD/////////////AP//////////////hAAAAAAAAAAAAAAAAAAAAAAAhP////////////8A//////////////8sAAAAAAAAKMz/zCgAAAAAAAAs/////////////wD//////////////wAAAAAAAADM////zAAAAAAAAAD/////////////AP//////////////BAAAAAAAAP//////AAAAAAAABP////////////8A//////////////8sAAAAAAAAzP///9QAAAAAAAAw/////////////wD//////////////3wAAAAAAAAoyP/YNAAAAAAAAIT/////////////AP//////////////7BgAAAAAAAAAAAAAAAAAAAAc8P////////////8A////////////////xBgAAAAAAAAAAAAAAAAAGNj//////////////wD/////////////////tAQAAAAAAAAAAAAAAACo/////!
 ///////////AP///////////////HAAAAAAAAAAAAAAAAAAAAB8//////////////8A//////////////9gAAAAAAAAAAAAAAAAAAAAAAB8/////////////wD/////////////wAAAAAAAAABk4P/UWAAAAAAAAATQ////////////AP////////////9UAAAAAAAAaP//////XAAAAAAAAGT///////////8A/////////////xgAAAAAAADg///////cAAAAAAAAJP///////////wD/////////////AAAAAAAAAP////////8AAAAAAAAA////////////AP////////////8AAAAAAAAA4P//////3AAAAAAAAAT///////////8A/////////////ygAAAAAAABg//////9cAAAAAAAALP///////////wD/////////////ZAAAAAAAAABY1P/cXAAAAAAAAABw////////////AP/////////////QAAAAAAAAAAAAAAAAAAAAAAAABNz///////////8A//////////////9gAAAAAAAAAAAAAAAAAAAAAAB0/////////////wD///////////////Q8AAAAAAAAAAAAAAAAAAAAUPz/////////////AP////////////////x4CAAAAAAAAAAAAAAAEIT8//////////////8A///////////////////smFQwGAAAABg0ZKT0/////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'9' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////////////ysYCwMAAAUNGiw/P//////////////////AP////////////////+4JAAAAAAAAAAAAAAkuP////////////////8A////////////////lAQAAAAAAAAAAAAAAAAAkP///////////////wD//////////////8AEAAAAAAAAAAAAAAAAAAAAqP//////////////AP/////////////8JAAAAAAAAAAAAAAAAAAAAAAQ7P////////////8A/////////////6wAAAAAAAAAfOz8vCwAAAAAAABw/////////////wD/////////////WAAAAAAAAHD/////7BgAAAAAAAz4////////////AP////////////8kAAAAAAAA1P//////hAAAAAAAALT///////////8A/////////////wAAAAAAAAD///////+4AAAAAAAAcP///////////wD/////////////AAAAAAAAAPz//////8AAAAAAAABI////////////AP////////////8UAAAAAAAAzP//////lAAAAAAAACT///////////8A/////////////0QAAAAAAABY//////gsAAAAAAAADP///////////wD/////////////kAAAAAAAAABw5P/IPAAAAAAAAAAA////////////AP/////////////wEAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A//////////////+UAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD///////////////9wAAAAAAAAAAAAAFAAAAAAAAAU/!
 ///////////AP////////////////+IBAAAAAAAAABw3AAAAAAAACj///////////8A///////////////////cdCwEABhcxP+8AAAAAAAATP///////////wD//////////////////////////////5AAAAAAAAB4////////////AP//////////////////////////////UAAAAAAAALj///////////8A//////////////+kgGxUQCAM2P///+AIAAAAAAAQ+P///////////wD//////////////0gAAAAAAAA42P/EKAAAAAAAAHD/////////////AP//////////////sAAAAAAAAAAAAAAAAAAAAAAQ6P////////////8A////////////////TAAAAAAAAAAAAAAAAAAAAKz//////////////wD////////////////oKAAAAAAAAAAAAAAAAASU////////////////AP/////////////////sUAAAAAAAAAAAAAAwxP////////////////8A////////////////////yHA0FAAADCxktP///////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'A' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////+QAAAAAAAAAAAAAAOT/////////////////AP//////////////////kAAAAAAAAAAAAAAAkP////////////////8A//////////////////88AAAAAAAAAAAAAAA8/////////////////wD/////////////////5AAAAAAAAAAAAAAAAADk////////////////AP////////////////+QAAAAAAAAAAAAAAAAAJD///////////////8A/////////////////zwAAAAAAAAAAAAAAAAAPP///////////////wD////////////////kAAAAAAAAAAgAAAAAAAAA5P//////////////AP///////////////5AAAAAAAAAAgAAAAAAAAACQ//////////////8A////////////////PAAAAAAAAAz8HAAAAAAAADz//////////////wD//////////////+QAAAAAAAAAWP9kAAAAAAAAANz//!
 ///////////AP//////////////kAAAAAAAAACk/7wAAAAAAAAAhP////////////8A//////////////88AAAAAAAABOz//BQAAAAAAAAw/////////////wD/////////////4AAAAAAAAAA8////ZAAAAAAAAADc////////////AP////////////+EAAAAAAAAAIj///+8AAAAAAAAAIT///////////8A/////////////zAAAAAAAAAA2P////wQAAAAAAAAMP///////////wD////////////cAAAAAAAAACT//////1wAAAAAAAAA3P//////////AP///////////4QAAAAAAAAAAAAAAAAAAAAAAAAAAACE//////////8A////////////MAAAAAAAAAAAAAAAAAAAAAAAAAAAADD//////////wD//////////9wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANz/////////AP//////////hAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhP////////8A//////////8wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAw/////////wD/////////3AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADc////////AP////////+EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIT///////8A/////////zAAAAAAAAAAhP///////////2QAAAAAAAAAMP///////wD////////cAAAAAAAAAADM////////////vAAAAAAAAAAA3P//////AP///////4QAAAAAAAAAHP/////////////4DAAAAAAAAACE//////8A////////MAAAAAAAAABk//////////////9cAAAAAAAAADD//////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'B' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAEDh83P///////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAEhP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAeP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAxP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAABY////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAABT///////////8A//////////8AAAAAAAAAAP/////4zEwAAAAAAAAAAP///////////wD//////////wAAAAAAAAAA////////7AAAAAAAAAAQ////////////AP//////////AAAAAAAAAAD////////sAAAAAAAAAEj///////////8A//////////8AAAAAAAAAAP/////4zEQAAAAAAAAAtP///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAFz/////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAiA/P////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAIjPj//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAGKz//!
 ///////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAJT///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAABNz//////////wD//////////wAAAAAAAAAA///////sqCAAAAAAAAAAbP//////////AP//////////AAAAAAAAAAD/////////yAAAAAAAAAAs//////////8A//////////8AAAAAAAAAAP//////////AAAAAAAAAAT//////////wD//////////wAAAAAAAAAA/////////7wAAAAAAAAAAP//////////AP//////////AAAAAAAAAAD//////+ikGAAAAAAAAAAY//////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFT//////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAsP//////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAADj///////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAc6P///////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAATOj/////////////AP//////////AAAAAAAAAAAAAAAAAAAEIEBkkNj///////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'C' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////////////5JRULBAAAAgkTIDQ//////////////////8A////////////////1FAAAAAAAAAAAAAAAABAyP///////////////wD//////////////4gEAAAAAAAAAAAAAAAAAAAElP//////////////AP////////////9wAAAAAAAAAAAAAAAAAAAAAAAAlP////////////8A////////////kAAAAAAAAAAAAAAAAAAAAAAAAAAEyP///////////wD//////////9wIAAAAAAAAAAAAAAAAAAAAAAAAAAAw/!
 ///////////AP//////////WAAAAAAAAAAAWMz/8JwQAAAAAAAAAACw//////////8A/////////+wEAAAAAAAAAID//////9QMAAAAAAAAAET//////////wD/////////nAAAAAAAAAAo/P///////3wAAAAABDBspP//////////AP////////9gAAAAAAAAAIz/////////3BxQjMT0//////////////8A/////////zQAAAAAAAAAzP///////////////////////////////wD/////////GAAAAAAAAADo////////////////////////////////AP////////8AAAAAAAAAAP////////////////////////////////8A/////////wAAAAAAAAAA/////////////////////////////////wD/////////AAAAAAAAAAD/////////////////////////////////AP////////8cAAAAAAAAAOj///////////////////////////////8A/////////zgAAAAAAAAA0P/////////kIGio7P///////////////wD/////////bAAAAAAAAACg/////////5wAAAAAMHS49P//////////AP////////+oAAAAAAAAAEz/////////PAAAAAAAAAAc//////////8A//////////QIAAAAAAAAALz//////6QAAAAAAAAAAGT//////////wD//////////3AAAAAAAAAADIzo/+SEBAAAAAAAAAAAyP//////////AP//////////7BAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A////////////rAAAAAAAAAAAAAAAAAAAAAAAAAAE0P///////////wD/////////////fAAAAAAAAAAAAAAAAAAAAAAAAJz//////!
 ///////AP//////////////iAQAAAAAAAAAAAAAAAAAAASY//////////////8!
 A///////
/////////yEAAAAAAAAAAAAAAAAA8yP///////////////wD//////////////////9yIUCwQAAAAIEB4yP//////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'D' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////////8AAAAAAAAAAAAAAAAADChQkOT/////////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAABGjw//////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAACDY/////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAABjk////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAKj//////////wD///////////8AAAAAAAAAAP///+isSAAAAAAAAAAANP//////////AP///////////wAAAAAAAAAA////////hAAAAAAAAAAA2P////////8A////////////AAAAAAAAAAD/////////MAAAAAAAAACQ/////////wD///////////8AAAAAAAAAAP////////+MAAAAAAAAAFj/////////AP///////////wAAAAAAAAAA/////////8gAAAAAAAAAMP////////8A////////////AAAAAAAAAAD/////////5AAAAAAAAAAY/////////wD///////////8AAAAAAAAAAP//////////AAAAAAAAA!
 AD/////////AP///////////wAAAAAAAAAA//////////8AAAAAAAAAAP////////8A////////////AAAAAAAAAAD//////////wAAAAAAAAAA/////////wD///////////8AAAAAAAAAAP/////////wAAAAAAAAABD/////////AP///////////wAAAAAAAAAA/////////9QAAAAAAAAAJP////////8A////////////AAAAAAAAAAD/////////qAAAAAAAAABI/////////wD///////////8AAAAAAAAAAP////////9QAAAAAAAAAHj/////////AP///////////wAAAAAAAAAA////////uAAAAAAAAAAAvP////////8A////////////AAAAAAAAAAD////w0HwEAAAAAAAAACT8/////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAADz8//////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAY6P///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAKNz/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAACHT0//////////////8A////////////AAAAAAAAAAAAAAAAABg4bKj0/////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'E' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//!
 ///////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAD///////////////////////////////8A//////////8AAAAAAAAAAP///////////////////////////////wD//////////wAAAAAAAAAA////////////////////////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////!
 ///////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8!
 A///////
///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'F' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA/////!
 ///////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'G' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////MB8TCgQAAAACCA4YJzs////////////////AP///////////////JQcAAAAAAAAAAAAAAAAAAhw8P////////////8A/////////////9gwAAAAAAAAAAAAAAAAAAAAAAAk2P///////////wD////////////EDAAAAAAAAAAAAAAAAAAAAAAAAAAc7P//////////AP//////////2AwAAAAAAAAAAAAAAAAAAAAAAAAAAABY//////////8A//////////wwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADQ/////////wD/////////kAAAAAAAAAAAEHzQ/P/gmCAAAAAAAAAAAFz/////////AP////////wcAAAAAAAAACjg////////8CwAAAAAAAAgWP////////8A////////vAAAAAAAAAAI2P//////////yBRAcJjI8P///////////wD///////94AAAAAAAAAGD//////////////////////!
 ///////////AP///////0AAAAAAAAAAsP////////////////////////////////8A////////IAAAAAAAAADc/////////////////////////////////wD///////8AAAAAAAAAAP///////wAAAAAAAAAAAAAAAAD/////////AP///////wAAAAAAAAAA////////AAAAAAAAAAAAAAAAAP////////8A////////AAAAAAAAAAD///////8AAAAAAAAAAAAAAAAA/////////wD///////8gAAAAAAAAAOD//////wAAAAAAAAAAAAAAAAD/////////AP///////0AAAAAAAAAAtP//////AAAAAAAAAAAAAAAAAP////////8A////////cAAAAAAAAABw//////8AAAAAAAAAAAAAAAAA/////////wD///////+8AAAAAAAAABDs////////////AAAAAAAAAAD/////////AP////////wYAAAAAAAAADz0//////////AAAAAAAAAAAP////////8A/////////5AAAAAAAAAAACCY4P//3KhcCAAAAAAAAAAA/////////wD/////////+CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////AP//////////xAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIP////////8A////////////rAQAAAAAAAAAAAAAAAAAAAAAAAAAAGTw/////////wD/////////////vBQAAAAAAAAAAAAAAAAAAAAAADjI////////////AP//////////////8HAQAAAAAAAAAAAAAAAAAEiw//////////////8A//////////////////iwcEAgBAAABCA4aKDk/////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'H' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP///!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'I' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP///////////!
 ///////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAP///////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAA////////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAD///////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'J' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP//////////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAD//////////////wD///////////////////////////8AAAAAAAAAAP///!
 ///////////AP///////////////////////////wAAAAAAAAAA//////////////8A////////////////////////////AAAAAAAAAAj//////////////wD//////////+zMrIxwUDAQ//////wAAAAAAAAAIP//////////////AP//////////DAAAAAAAAADo////2AAAAAAAAAA0//////////////8A//////////8wAAAAAAAAAKj///+YAAAAAAAAAFj//////////////wD//////////2gAAAAAAAAAIND/yBgAAAAAAAAAkP//////////////AP//////////vAAAAAAAAAAAAAAAAAAAAAAAAADc//////////////8A////////////MAAAAAAAAAAAAAAAAAAAAAAAUP///////////////wD////////////EBAAAAAAAAAAAAAAAAAAAABjk////////////////AP////////////+sBAAAAAAAAAAAAAAAAAAY2P////////////////8A///////////////EMAAAAAAAAAAAAAAAVOj//////////////////wD/////////////////vHBAIAAAABg8fNT/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'K' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////8AAAAAAAAAAP//////////wAQAAAAAAAAAAABw////////AP///////wAAAAAAAAAA/////////9AMAAAAAAAAAAAAcP////////8A////////AAAAAAAAAAD////////cGAAAAAAAAAAAAHD//////////wD///////8AAAAAAAAAAP//////6CgAAAAAAAAAAABs////////////AP///////wAAAAAAAAAA//////Q0AAAAAAAAAAAAVPz///////////8A////////AAAAAAAAAAD////8RAAAAAAAAAAAAFT8/////////////wD///////8AAAAAAAAAAP///1gAAAAAAAAAAABU/P///!
 ///////////AP///////wAAAAAAAAAA//9wAAAAAAAAAAAASPz///////////////8A////////AAAAAAAAAAD/jAAAAAAAAAAAADz0/////////////////wD///////8AAAAAAAAAAKQAAAAAAAAAAAA89P//////////////////AP///////wAAAAAAAAAABAAAAAAAAAAAFPT///////////////////8A////////AAAAAAAAAAAAAAAAAAAAAAAApP///////////////////wD///////8AAAAAAAAAAAAAAAAAAAAAAAAU8P//////////////////AP///////wAAAAAAAAAAAAAAAAAAAAAAAABk//////////////////8A////////AAAAAAAAAAAAAAAAAAAAAAAAAADE/////////////////wD///////8AAAAAAAAAAAAAAAAoEAAAAAAAACz8////////////////AP///////wAAAAAAAAAAAAAAGNiAAAAAAAAAAIj///////////////8A////////AAAAAAAAAAAAABjY//gYAAAAAAAACOD//////////////wD///////8AAAAAAAAAAAAY2P///5wAAAAAAAAASP//////////////AP///////wAAAAAAAAAAGNj//////CgAAAAAAAAAqP////////////8A////////AAAAAAAAAADI////////sAAAAAAAAAAc8P///////////wD///////8AAAAAAAAAAP//////////QAAAAAAAAABs////////////AP///////wAAAAAAAAAA///////////IAAAAAAAAAATI//////////8A////////AAAAAAAAAAD///////////9YAAAAAAAAADD8/////////wD///////8AAAAAAAAAAP///////////9wEAAAAAAAAAJD//!
 ///////AP///////wAAAAAAAAAA/////////////3AAAAAAAAAADOT///////8!
 A///////
/AAAAAAAAAAD/////////////7BAAAAAAAAAAUP///////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'L' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD//////////////////!
 ///////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAD/////////////////////////////AP////////////8AAAAAAAAAAP////////////////////////////8A/////////////wAAAAAAAAAA/////////////////////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////wAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////////AAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'M' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////8AAAAAAAAAAAAAAHz//////3wAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAAAAAATP//////UAAAAAAAAAAAAAAA////////AP//////AAAAAAAAAAAAAAAc//////8cAAAAAAAAAAAAAAD///////8A//////8AAAAAAAAAAAAAAADw////8AAAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAAAAAAALz////AAAAAAAAAAAAAAAAA////////AP//////AAAAAAAAAAAAAAAAkP///5AAAAAAAAAAAAAAAAD///////8A//////8AAAAAAAAAAAAAAABc////ZAAAAAAAAAAAAAAAAP///////wD//////wAAAAAAAAAoAAAAADD///8wAAAAACQAAAAAAAAA////////AP//////AAAAAAAAAFwAAAAABPz//AgAAAAAXAAAAAAAAAD///////8A//////8AAAAAAAAAkAAAAAAA0P/UAAAAAACQAAAAAAAAAP///////wD//////wAAAAAAAADMAAAAAACg/6gAAAAAAMQAAAAAAAAA////////AP//////AAAAAAAAAPgEAAAAAHD/dAAAAAAE+AAAAAAAAAD///////8A//////8AAAAAAAAA/zQAAAAAQP9IAAAAADD/AAAAAAAAAP///////wD//////wAAAAAAAAD/bAAAAAAQ/xQAAAAAaP8AAAAAA!
 AAA////////AP//////AAAAAAAAAP+gAAAAAADQAAAAAACc/wAAAAAAAAD///////8A//////8AAAAAAAAA/9QAAAAAAGgAAAAAAND/AAAAAAAAAP///////wD//////wAAAAAAAAD//wwAAAAAFAAAAAAM/P8AAAAAAAAA////////AP//////AAAAAAAAAP//RAAAAAAAAAAAADz//wAAAAAAAAD///////8A//////8AAAAAAAAA//94AAAAAAAAAAAAcP//AAAAAAAAAP///////wD//////wAAAAAAAAD//7AAAAAAAAAAAACo//8AAAAAAAAA////////AP//////AAAAAAAAAP//5AAAAAAAAAAAANz//wAAAAAAAAD///////8A//////8AAAAAAAAA////HAAAAAAAAAAQ////AAAAAAAAAP///////wD//////wAAAAAAAAD///9QAAAAAAAAAEz///8AAAAAAAAA////////AP//////AAAAAAAAAP///4gAAAAAAAAAfP///wAAAAAAAAD///////8A//////8AAAAAAAAA////vAAAAAAAAACw////AAAAAAAAAP///////wD//////wAAAAAAAAD////wAAAAAAAAAOz///8AAAAAAAAA////////AP//////AAAAAAAAAP////8sAAAAAAAc/////wAAAAAAAAD///////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'N' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////AAAAAAAAALD/////////////AAAAAAAAAP//////////AP////////8AAAAAAAAAFOj///////////8AAAAAAAAA//////////8A/////////wAAAAAAAAAASP///////////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAkP//////////AAAAAAAAAP//////////AP////////8AAAAAAAAAAAAI1P////////8AAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAw+P///////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAABw////////AAAAAAAAAP//////////AP////////8AAAAAAAAAAAAAAAC8//////8AAAAAAAAA//////////8A/////////wAAAAAAAAAAAAAAABzs/////wAAAAAAAAD//////////wD/////////AAAAAAAAAAAAAAAAAFD/////AAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAAAAAAAAAJz///8AAAAAAAAA//////////8A/////////wAAAAAAAAAUAAAAAAAADNz//wAAAAAAAAD//////////wD/////////AAAAAAAAALQAAAAAAAAANPz/AAAAAAAAAP//////////AP////////8AAAAAAAAA/2wAAAAAAAAAfP8AAAAAAAAA//////////8A/////////wAAAAAAAAD/+CwAAAAAAAAExAAAAAAAAAD//////////wD/////////AAAAAAAAAP//0AQAAAAAAAAgAAAAAAAAAP//////////AP////////8AAAAAAAAA////jAAAAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD/////RAAAAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP/////kFAAAAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAA//////+sAAAAAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD///////9kAAAAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP////////QkAAAAAAAAAAAAAP//////////AP////////8AAAAAAAAA/////////8wEAAAAAAAAAAAA//////////8A/////////wAAAAAAAAD//////////4QAAAAAAAAAAAD//////////wD/////////AAAAAAAAAP///////////DwAAAAAAAAAAP//////////AP////////8AAAAAAAAA////////////4BAAAAAAAAAA//////////8A/////////wAAAAAAAAD/////////////qAAAAAAAAAD//////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'O' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A///////////////////0qGw4HAAAABw4aKT0/////////////////wD////////////////wcAwAAAAAAAAAAAAAAAho6P//////////////AP//////////////uBQAAAAAAAAAAAAAAAAAAAAMoP////////////8A/////////////6AEAAAAAAAAAAAAAAAAAAAAAAAAkP///////////wD///////////+4BAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP//////////8BQAAAAAAAAAAAAAAAAAAAAAAAAAAAAM5P////////8A//////////9wAAAAAAAAAAAsrPD/7KQsAAAAAAAAAABg/////////wD/////////+BAAAAAAAAAAUPj///////hQAAAAAAAAAAjs////////AP////////+sAAAAAAAAABDw//////////AYAAAAAAAAAKD///////8A/////////2wAAAAAAAAAdP///////////3wAAAAAAAAAYP///////wD/////////OAAAAAAAAAC4////////////xAAAAAAAA!
 AAw////////AP////////8cAAAAAAAAAOD////////////oAAAAAAAAABT///////8A/////////wAAAAAAAAAA//////////////8AAAAAAAAAAP///////wD/////////AAAAAAAAAAD//////////////wAAAAAAAAAA////////AP////////8AAAAAAAAAAP/////////////8AAAAAAAAAAD///////8A/////////xwAAAAAAAAA5P///////////+AAAAAAAAAAHP///////wD/////////NAAAAAAAAAC8////////////uAAAAAAAAAA4////////AP////////9oAAAAAAAAAHj///////////98AAAAAAAAAGT///////8A/////////6gAAAAAAAAAGPD/////////+BgAAAAAAAAApP///////wD/////////9AwAAAAAAAAAUPz///////xcAAAAAAAAAAjs////////AP//////////cAAAAAAAAAAALKjs//CwOAAAAAAAAAAAYP////////8A///////////wFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzk/////////wD///////////+4BAAAAAAAAAAAAAAAAAAAAAAAAAAAoP//////////AP////////////+QAAAAAAAAAAAAAAAAAAAAAAAAAJD///////////8A//////////////+sEAAAAAAAAAAAAAAAAAAAAAyg/////////////wD////////////////oZAgAAAAAAAAAAAAAAARg4P//////////////AP//////////////////9KhsOCAAAAAUMFyc7P////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'P' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////////wAAAAAAAAAAAAAAAAAACCxguP////////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAOOD//////////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAGOD/////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAARP////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAxP///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAABo////////////AP///////////wAAAAAAAAAA////6JwMAAAAAAAAADD///////////8A////////////AAAAAAAAAAD//////6AAAAAAAAAADP///////////wD///////////8AAAAAAAAAAP//////9AAAAAAAAAAA////////////AP///////////wAAAAAAAAAA///////0AAAAAAAAAAD///////////8A////////////AAAAAAAAAAD//////5gAAAAAAAAAHP///////////wD///////////8AAAAAAAAAAP///9iICAAAAAAAAABI////////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAJD///////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAAAAAI6P///////////wD///////////8AAAAAAAAAAAAAAAAAAAAAAAAAAIT//!
 ///////////AP///////////wAAAAAAAAAAAAAAAAAAAAAAAABU/P////////////8A////////////AAAAAAAAAAAAAAAAAAAAAAAIhPz//////////////wD///////////8AAAAAAAAAAAAAAAAABCRMkOz/////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP///////////wAAAAAAAAAA//////////////////////////////8A////////////AAAAAAAAAAD//////////////////////////////wD///////////8AAAAAAAAAAP//////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'Q' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////SoaDQcAAAAHDhoqPT///////////////////8A//////////////BwDAAAAAAAAAAAAAAACHDo/////////////////wD///////////+4FAAAAAAAAAAAAAAAAAAAABCo////////////////AP//////////nAQAAAAAAAAAAAAAAAAAAAAAAACQ//////////////8A/////////7gEAAAAAAAAAAAAAAAAAAAAAAAAAACg/////////////wD////////wFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzo////////////AP///////3AAAAAAAAAAACyo8P/sqCwAAAAAAAAAAGT///////////8A///////4EAAAAAAAAABM+P///////FQAAAAAAAAACPT//////////wD//////7AAAAAAAAAAFPD/////////9BgAAAAAAAAApP//////////AP//////bAAAAAAAAAB4////////////fAAAAAAAAABk//////////8A//////84AAAAAAAAALz///////////+8AAAAAAAAADT//////////wD//////xwAAAAAAAAA6P///////////+QAAAAAAAAAH!
 P//////////AP//////AAAAAAAAAAD//////////////wAAAAAAAAAA//////////8A//////8AAAAAAAAAAP//////////////AAAAAAAAAAD//////////wD//////wAAAAAAAAAA/P////////////8AAAAAAAAAAP//////////AP//////GAAAAAAAAADg////////////4AAAAAAAAAAc//////////8A//////84AAAAAAAAALT////MJHTo//+8AAAAAAAAADT//////////wD//////2wAAAAAAAAAdP///2AAABCg/3wAAAAAAAAAZP//////////AP//////rAAAAAAAAAAY9P/sCAAAAABMGAAAAAAAAACk//////////8A///////4EAAAAAAAAABU/P+0OAAAAAAAAAAAAAAACPT//////////wD///////94AAAAAAAAAAA4sPD/gAAAAAAAAAAAAABk////////////AP////////AcAAAAAAAAAAAAAAAAAAAAAAAAAAAADOT///////////8A/////////7wEAAAAAAAAAAAAAAAAAAAAAAAAAACQ/////////////wD//////////6wEAAAAAAAAAAAAAAAAAAAAAAAAABSs////////////AP///////////7gUAAAAAAAAAAAAAAAAAAAAAAAAAABAwP////////8A//////////////BwDAAAAAAAAAAAAAAABAgAAAAAAAA8/////////wD////////////////0qGg0GAAAABgwXJjkxBgAAAAAALD/////////AP//////////////////////////////////5DQAAAAk/P////////8A////////////////////////////////////+GwAAJD//////////wD//////////////////////////////////////8A49P///!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'R' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////wAAAAAAAAAAAAAAAAAAAAQgOGSk+P///////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAcuP//////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAEsP////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQ6P///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAADD///////////8A/////////wAAAAAAAAAA///////svDgAAAAAAAAACP///////////wD/////////AAAAAAAAAAD/////////7AAAAAAAAAAA////////////AP////////8AAAAAAAAAAP/////////cAAAAAAAAABD///////////8A/////////wAAAAAAAAAA//////DQoCQAAAAAAAAAQP///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAACU////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAIPj///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAzU/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAA02P///!
 ///////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAxctPz///////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAEDY/////////////////wD/////////AAAAAAAAAAD/9LAsAAAAAAAAAAzc////////////////AP////////8AAAAAAAAAAP///+wkAAAAAAAAADD8//////////////8A/////////wAAAAAAAAAA/////8QAAAAAAAAAAJD//////////////wD/////////AAAAAAAAAAD//////1QAAAAAAAAAFPD/////////////AP////////8AAAAAAAAAAP//////3AQAAAAAAAAAgP////////////8A/////////wAAAAAAAAAA////////aAAAAAAAAAAM6P///////////wD/////////AAAAAAAAAAD////////oCAAAAAAAAABs////////////AP////////8AAAAAAAAAAP////////+AAAAAAAAAAATc//////////8A/////////wAAAAAAAAAA//////////AUAAAAAAAAAFj//////////wD/////////AAAAAAAAAAD//////////5AAAAAAAAAAAND/////////AP////////8AAAAAAAAAAP//////////+CQAAAAAAAAAQP////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'S' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP/////////////////8vHBEIAgAAAQgQHC8/P////////////////8A////////////////pCQAAAAAAAAAAAAAAAAcoP///////////////wD//////////////FwAAAAAAAAAAAAAAAAAAAAAXP//////////////AP////////////9oAAAAAAAAAAAAAAAAAAAAAAAAhP////////////8A////////////zAAAAAAAAAAAAAAAAAAAAAAAAAAI6P///////////wD///////////9cAAAAAAAAAAAAAAAAAAAAAAAAAACA////////////AP///////////xgAAAAAAAAAUOD/8KwkAAAAAAAAADj///////////8A////////////AAAAAAAAAAD0/////8wABCAgICxASP///////////wD///////////8MAAAAAAAAAMz//////////////////!
 ///////////AP///////////0AAAAAAAAAACFiQxPT///////////////////////8A////////////oAAAAAAAAAAAAAAAADBwtPT//////////////////wD////////////8QAAAAAAAAAAAAAAAAAAACFTA////////////////AP/////////////oOAAAAAAAAAAAAAAAAAAAAABM6P////////////8A///////////////4fAgAAAAAAAAAAAAAAAAAAAAY2P///////////wD/////////////////7IwwAAAAAAAAAAAAAAAAAAAo+P//////////AP/////////////////////koGw0BAAAAAAAAAAAAACU//////////8A///////////////////////////4uFgAAAAAAAAAADz//////////wD//////////2BgSEA0IBwA6P///////5QAAAAAAAAADP//////////AP//////////JAAAAAAAAACc/////////AAAAAAAAAAA//////////8A//////////9YAAAAAAAAACDo///////AAAAAAAAAABT//////////wD//////////6QAAAAAAAAAACCk7P/snBQAAAAAAAAAUP//////////AP//////////+BAAAAAAAAAAAAAAAAAAAAAAAAAAAACs//////////8A////////////kAAAAAAAAAAAAAAAAAAAAAAAAAAAOP///////////wD////////////8RAAAAAAAAAAAAAAAAAAAAAAAABjc////////////AP/////////////0PAAAAAAAAAAAAAAAAAAAAAAg2P////////////8A///////////////8hBQAAAAAAAAAAAAAAAAMdPT//////////////wD/////////////////+LRwSCAMAAAAHDhoqPT//////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'T' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP///////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP///////////!
 ///////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD///////////////////8AAAAAAAAAAP//////////////////////AP///////////////////wAAAAAAAAAA//////////////////////8A////////////////////AAAAAAAAAAD//////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'U' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAAP//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////AAAAAAAAAAD///////////8AAAAAAAAAA!
 P//////////AP////////8AAAAAAAAAAP///////////wAAAAAAAAAA//////////8A/////////wAAAAAAAAAA////////////AAAAAAAAAAD//////////wD/////////JAAAAAAAAADk/////////+gAAAAAAAAAHP//////////AP////////9MAAAAAAAAAJz/////////nAAAAAAAAABE//////////8A/////////4gAAAAAAAAAHOj//////+ggAAAAAAAAAHz//////////wD/////////0AAAAAAAAAAAIJzs/+ykIAAAAAAAAAAA0P//////////AP//////////QAAAAAAAAAAAAAAAAAAAAAAAAAAAAED///////////8A///////////IBAAAAAAAAAAAAAAAAAAAAAAAAAAE0P///////////wD///////////+YAAAAAAAAAAAAAAAAAAAAAAAAAJj/////////////AP////////////+UBAAAAAAAAAAAAAAAAAAAAASU//////////////8A///////////////IPAAAAAAAAAAAAAAAAAAwyP///////////////wD/////////////////0IxYOCAIAAAEIEiAyP//////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'V' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////zAAAAAAAAAAYP//////////////ZAAAAAAAAAAw////////AP//////kAAAAAAAAAAU/P////////////8UAAAAAAAAAJD///////8A///////oBAAAAAAAAADE////////////xAAAAAAAAAAE7P///////wD///////9MAAAAAAAAAHD///////////94AAAAAAAAAEz/////////AP///////6gAAAAAAAAAJP///////////yQAAAAAAAAArP////////8A////////+BAAAAAAAAAA1P/////////YAAAAAAAAABT4/////////wD/////////aAAAAAAAAACE/////////4QAAAAAAAAAb!
 P//////////AP/////////EAAAAAAAAADT/////////OAAAAAAAAADM//////////8A//////////8kAAAAAAAAAOT//////+QAAAAAAAAAKP///////////wD//////////4QAAAAAAAAAmP//////nAAAAAAAAACI////////////AP//////////5AAAAAAAAABE//////9EAAAAAAAABOT///////////8A////////////QAAAAAAAAAT0////9AgAAAAAAABI/////////////wD///////////+gAAAAAAAAAKT///+kAAAAAAAAAKj/////////////AP////////////QIAAAAAAAAXP///1wAAAAAAAAM+P////////////8A/////////////1wAAAAAAAAM+P/8DAAAAAAAAGT//////////////wD/////////////vAAAAAAAAAC8/7wAAAAAAAAAxP//////////////AP//////////////HAAAAAAAAGj/aAAAAAAAACT///////////////8A//////////////94AAAAAAAAHP8cAAAAAAAAhP///////////////wD//////////////9gAAAAAAAAAkAAAAAAAAADk////////////////AP///////////////zgAAAAAAAAQAAAAAAAAQP////////////////8A////////////////lAAAAAAAAAAAAAAAAACg/////////////////wD////////////////sCAAAAAAAAAAAAAAADPT/////////////////AP////////////////9QAAAAAAAAAAAAAABg//////////////////8A/////////////////7AAAAAAAAAAAAAAAMD//////////////////wD//////////////////BQAAAAAAAAAAAAc/////////////!
 ///////AP//////////////////cAAAAAAAAAAAAHz///////////////////8!
 A///////
////////////MAAAAAAAAAAAA3P///////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'W' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//8cAAAAAAAAALz/////4AAAAAAAAAAA6P////+8AAAAAAAAABz//wD//1QAAAAAAAAAjP////+gAAAAAAAAAACo/////4wAAAAAAAAAUP//AP//jAAAAAAAAABU/////2AAAAAAAAAAAGj/////VAAAAAAAAACM//8A///EAAAAAAAAACT/////IAAAAAAAAAAAKP////8kAAAAAAAAAMT//wD///gEAAAAAAAAAPD//+AAAAAAAAAAAAAA6P//8AAAAAAAAAAE9P//AP///zAAAAAAAAAAvP//oAAAAAAAAAAAAACo//+8AAAAAAAAADD///8A////bAAAAAAAAACM//9gAAAAAAAAAAAAAGT//4wAAAAAAAAAaP///wD///+kAAAAAAAAAFT//yAAAAAAAAAAAAAAIP//VAAAA!
 AAAAACc////AP///9gAAAAAAAAAJP/gAAAAAAAAAAAAAAAA4P8kAAAAAAAAANT///8A/////xAAAAAAAAAA8KAAAAAAAAAAAAAAAACg8AAAAAAAAAAQ/////wD/////TAAAAAAAAAC8YAAAAAAAAAAAAAAAAGC8AAAAAAAAAET/////AP////+AAAAAAAAAAIwgAAAAAAAAAAAAAAAAIIwAAAAAAAAAfP////8A/////7gAAAAAAAAANAAAAAAAACwwAAAAAAAANAAAAAAAAACw/////wD/////8AAAAAAAAAAAAAAAAAAAdHgAAAAAAAAAAAAAAAAAAOz/////AP//////KAAAAAAAAAAAAAAAAAC4vAAAAAAAAAAAAAAAAAAg//////8A//////9gAAAAAAAAAAAAAAAACPj4CAAAAAAAAAAAAAAAAFj//////wD//////5QAAAAAAAAAAAAAAABE//9IAAAAAAAAAAAAAAAAkP//////AP//////0AAAAAAAAAAAAAAAAIj//4wAAAAAAAAAAAAAAADI//////8A///////8DAAAAAAAAAAAAAAAzP//1AAAAAAAAAAAAAAABPj//////wD///////88AAAAAAAAAAAAABT/////GAAAAAAAAAAAAAA0////////AP///////3QAAAAAAAAAAAAAWP////9gAAAAAAAAAAAAAHD///////8A////////sAAAAAAAAAAAAACg/////6QAAAAAAAAAAAAApP///////wD////////kAAAAAAAAAAAAAOT/////6AAAAAAAAAAAAADc////////AP////////8cAAAAAAAAAAAo////////MAAAAAAAAAAAEP////////8A/////////1QAAAAAAAAAAHD///////94AAAAAAAAAABM/////////wD/////////jAAAAAAAAAAAtP///////7wAAAAAAAAAAID//!
 ///////AP/////////EAAAAAAAAAAT0////////+AgAAAAAAAAAuP////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'X' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD///////9UAAAAAAAAAKz///////////+sAAAAAAAAAFD/////////AP///////+QQAAAAAAAAFOT/////////8BwAAAAAAAAM5P////////8A/////////5gAAAAAAAAATP////////9kAAAAAAAAAJD//////////wD//////////0AAAAAAAAAAoP//////wAAAAAAAAAA0/P//////////AP//////////2AgAAAAAAAAQ4P////gkAAAAAAAABMz///////////8A////////////iAAAAAAAAABA////dAAAAAAAAABw/////////////wD////////////8MAAAAAAAAACU/9AEAAAAAAAAHPD/////////////AP/////////////IBAAAAAAAAAzYMAAAAAAAAACs//////////////8A//////////////90AAAAAAAAABAAAAAAAAAATP///////////////wD///////////////QgAAAAAAAAAAAAAAAAAAzg/////!
 ///////////AP///////////////7wAAAAAAAAAAAAAAAAAjP////////////////8A/////////////////2AAAAAAAAAAAAAAADD8/////////////////wD/////////////////7BQAAAAAAAAAAAAEyP//////////////////AP/////////////////gDAAAAAAAAAAAAAjY//////////////////8A/////////////////0AAAAAAAAAAAAAAADj8/////////////////wD///////////////+UAAAAAAAAAAAAAAAAAJD/////////////////AP//////////////4AwAAAAAAAAAAAAAAAAADOD///////////////8A//////////////9AAAAAAAAAAAAAAAAAAAAAQP///////////////wD/////////////nAAAAAAAAAAAWAAAAAAAAAAAlP//////////////AP///////////+QQAAAAAAAAAGD/YAAAAAAAAAAM4P////////////8A////////////TAAAAAAAAAAs9P/0LAAAAAAAAABM/////////////wD//////////6AAAAAAAAAADNT////UDAAAAAAAAACg////////////AP/////////kEAAAAAAAAACg//////+gAAAAAAAAABDk//////////8A/////////0wAAAAAAAAAYP////////9gAAAAAAAAAEz//////////wD///////+oAAAAAAAAACz0//////////QsAAAAAAAAAKT/////////AP//////7BQAAAAAAAAM1P///////////9QMAAAAAAAAFOz///////8A//////9UAAAAAAAAAKD//////////////6AAAAAAAAAAVP///////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'Y' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP///////1QAAAAAAAAAAGj//////////2gAAAAAAAAAAFT///////8A////////5BAAAAAAAAAAAMT////////EAAAAAAAAAAAQ5P///////wD/////////mAAAAAAAAAAAKPj/////+CgAAAAAAAAAAJj/////////AP//////////PAAAAAAAAAAAgP////+AAAAAAAAAAAA8//////////8A///////////YCAAAAAAAAAAE2P//2AQAAAAAAAAACNj//////////wD///////////+AAAAAAAAAAAA4//84AAAAAAAAAACA////////////AP////////////woAAAAAAAAAACUlAAAAAAAAAAAKPz///////////8A/////////////8gAAAAAAAAAABAQAAAAAAAAAADI/////////////wD//////////////2wAAAAAAAAAAAAAAAAAAAAAbP//////////////AP//////////////8BwAAAAAAAAAAAAAAAAAABzw//////////////8A////////////////tAAAAAAAAAAAAAAAAAAAtP///////////////wD/////////////////VAAAAAAAAAAAAAAAAFT//////!
 ///////////AP/////////////////oEAAAAAAAAAAAAAAQ6P////////////////8A//////////////////+cAAAAAAAAAAAAAJz//////////////////wD///////////////////9AAAAAAAAAAABA////////////////////AP///////////////////9gAAAAAAAAAANj///////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////8AAAAAAAAAAP////////////////////8A/////////////////////wAAAAAAAAAA/////////////////////wD/////////////////////AAAAAAAAAAD/////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-			'Z' =&gt; array(
-				'data' =&gt; 'AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A/////////////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAA//////////////8A//////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAD//////////////wD//////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////////////AP//////////AAAAAAAAAAAAAAAAAAAAAAAAAAAQ//////////////8A/////////////////////////1AAAAAAAAAABLz//////////////wD///////////////////////98AAAAAAAAAACY////////////////AP//////////////////////pAAAAAAAAAAAaP////////////////8A/////////////////////8QIAAAAAAAAAET8/////////////////wD////////////////////gGAAAAAAAAAAo9P///////!
 ///////////AP//////////////////9CwAAAAAAAAAFNz///////////////////8A//////////////////xMAAAAAAAAAATA/////////////////////wD/////////////////eAAAAAAAAAAAnP//////////////////////AP///////////////5wAAAAAAAAAAHT///////////////////////8A///////////////ABAAAAAAAAABM/P///////////////////////wD/////////////3BQAAAAAAAAALPT/////////////////////////AP////////////QoAAAAAAAAABjg//////////////////////////8A///////////8SAAAAAAAAAAExP///////////////////////////wD//////////2wAAAAAAAAAAKD/////////////////////////////AP////////+YAAAAAAAAAAB8//////////////////////////////8A/////////wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/////////////wD/////////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////AP////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP////////////8A/////////////////////////////////////////////////////wD//////////////////////////////////////////////!
 ///////AP////////////////////////////////////////////////////8!
 A///////
//////////////////////////////////////////////wD/////////////////////////////////////////////////////AP////////////////////////////////////////////////////8=', 
-				'width' =&gt; 40
-			), 
-		);
-
-		return $_png;
-	}
-
-	// These define base64_encoded raw png image data used
-	// when we cannot generate our own single png image
-	function define_raw_pngs()
-	{
-		$_png = array(
-			'0' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QKCNGXKO6AAAAB3RJTUUH0wUOEDQ6EUG1VwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAXNJREFUeNpj/M9AHGAiUt2wVvhyaqAqKyOjpG3jQwaGv+e+IUn9RwJfSjjg4iwFP1aKJD6HyyErfGGAYrquIoP5E2wK/zigu0v5wH9sChdgeKDqP1aFGhBZmxv/z0Dd4IxV4RWIpMQHIPuJAITzAqEQETx7IFQIP5CQNoJwDmALxzMQCuyjg1chnBPYwtECwr8AZN41h0p6YHOjAkTuwf//77wYuCEcFWwKOWA2fM1iZuuHcASwKYQ55c9ENuasrxgRjKlwJS+D17v/hBUeUGYwv/sfn0IRiJQZJIbxuFEFagjvSlDUQNgK2GIGqpC1JRhIfoAqxBYz0DRhn8IMJO+giKEqhMaMJBeI3AHhIKdkRPqG8DlAifqFADyasKRHO6h1Z/6fMYEwTbCmx3cWGCl8CTaFwBhGz+M2/7EpXMvOnBmIok7jBVaFz/Mi3/1pQORrhpgPyOr+M8IL0j9/gKpeLjhy5QEwoDVsYuRR3cE4IktcAJNx8cJaZBeQAAAAAElFTkSuQmCC', 
-			'1' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMi//xxVKAAAAB3RJTUUH0wUOEDYLcqnX7wAAAAlwSFlzAAALEgAACxIB0t1+/AAAAHpJREFUeNpj/M9AHGAiUh1WhR8FGUGAsMKaD9iM/I8BlmCVwVS4hoUohT8qcNiFyv2zQIWBCIV3amRwu54RKcDRAgQ1KigIcJYK7CqR3QsCFmf+Y8qgeQakbANMAz6FKjUXECbj8zWa76nm61GFw1UhI10KqVGFNFQIADdK9Zj7PsV9AAAAAElFTkSuQmCC', 
-			'2' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMwPUBEjoAAAAB3RJTUUH0wUOEDUqFe2UcgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAQxJREFUeNpj/M9AHGAiUt2owkGrkAWF93LFgStPfjCwyGiYRGijqfyPAH9aOJAkQl78RwbICkNQjdB4gUNhD7qzLLAr/CKA4YENSAoRvl7zAUJXvPmxhgfCXILVMxEQvg+IDVUhgtVqDYjkDhD7B2aQIMIx5cOTN29evLAAsaEKObBajQzmQOQMcIQjHLwQgSisIaDwBdS5LHfwK7yhAHVVyX+8CrdAA5HB5gdehQ3Yoxpd4ZcAmDqbD//xKISEIjhU//zHoxDmXQaeFRhOZ8CmzuDOf3wKf8DsDfnyH6/CHJi6P//xKjyDJethVehBpMI7DPgVwrPCCgb8AK5wDwGFcNMF8EkCASOx1QcAGUxu1untnFIAAAAASUVORK5CYII=', 
-			'3' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMxBQugk2AAAAB3RJTUUH0wUOEDU3duv4qwAAAAlwSFlzAAALEgAACxIB0t1+/AAAATdJREFUeNpj/M9AHGAiUt0IVciCzPm7ZceZB28YGBQkLHwcmNFU/keANRJI4ioH/qMAJIUlaHatwaFwBrqrOO5gVfiCB8P9KVgVVkAtnPDh/wkLCFsGq0IFiGQLiH0D06P/GWHJ7O+NOzfuXLlzQRrEhgSawHscwYPurxAcwQMBf/4/aIAYyHIGr8IEeDhO+Y9XoQNUncwOVHGMRPEDSovc+IkzrpGDCQgUbuC1WgBhhsIHfAp3vPn/oIIFKfRxKQSDGohCA4IKX0DTD7YoRAWMUJ9iyQpbn4DBBWUQ5yFEDDnFw622gXAzwBxoYvfB5sYlUI0lD/4/gWWKJdgU/tHAcKjCD6y+PsGCpo4FJbaRgmcNqkqWCThTzxkTJHXo+Ro1HA9uOPHiATDlKJj4eKCVFIzDqWgGAK7GW/haPS+zAAAAAElFTkSuQmCC', 
-			'4' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMyqWttCEAAAAB3RJTUUH0wUOEDUxn4hdngAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKBJREFUeNpj/M9AHGAiUh2FCucyQgCK4H9McIAFixwWhQ8kGIhS+MWAgTiFIQzEKWxhIE7hFgbiFF7hASkQIajwjQpInuUAIYV/XMDyU/4TUlgAlk75T0jhArCszR9CCk+AY07mxX8CCp+AY47nzH8CCn+YgOWW/CekMAYsVfMfl0JGmCBq4kNEDp2zAn0UMmItABjRvDykPTO43DgyFQIANP6pTFLWAdoAAAAASUVORK5CYII=', 
-			'5' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QMzPy3XhEAAAAB3RJTUUH0wUOEDUk8lW5dQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAQpJREFUeNpj/M9AHGAiUt2oQuIVfmREBzgU3iHWxAfEKiTaRFpZnfAfAbAr/AsxUYagiVCbeQgqhPpFYmukLCOrZupRNJUIB02BCAjAZCK+/Ed2LoJZgm6bzRfsCgMw3JWAXaEBpg8uIGSRPPMBQmXc+P+iggXCnoOQZUQK1K8PgEAjGcQs7QGL6FzG5mtkcAUiyYIQYcRRUkDTLEIWR1b4ixamQMPhrKUP3rx48eDNFXmwdyFiOthixgXqaTAnBcKpwRaOS6A6Mx78fwBVx/IAm8I/KsTGzAkWNHUyb7Ar/L8GNSlK3MCRev7/v+CApC7kBUoUoAX4yQ0nHjwAWqpiE6GNFgNDoAwHAKC2Q2lMNcCmAAAAAElFTkSuQmCC', 
-			'6' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNAObRd4vAAAAB3RJTUUH0wUOEDUc2lcB6wAAAAlwSFlzAAALEgAACxIB0t1+/AAAATtJREFUeNpj/M9AHGAiUh2Gwq2puryMjKKmmSfRVf5HBkcMEBI+L1CkUBROYUE2QuMFLoVr0CzzwKHwhQC6szZgV1gAtfHI/xs2mEYywsPxp8QHEMVxQ56B4aaJiIKIiIRCPDZf74DwI/5jB4hwPAChbAgG+BWoExlOxkoysuqW3sUV4BoQ/p0SqARLB44AF4HIByDMKMCuEIu7phCrUOADNl/DgMOJ/09SIMwPC7B5hgfC1/kB4kRAOC7YrFaByM0Ac85AOCLYrFaBhSMIQNPlG2wBDg3HP2CSGU/MuEAoiKVXUWxB9cwPiG8UwEGSg5FCMNOjwZ4/byqgpqwgMoWr/MGeZ1agqWPZgSNz/Z+AqnDCf1wK/29B8qbKDhQpRtTE8HfLjjMP3jDwKJh4hKCGJSPNC6lRhTRWCABWpdoxd/bZ4QAAAABJRU5ErkJggg==', 
-			'7' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNA18/fMoAAAAB3RJTUUH0wUOEDUVo4u5TwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAM9JREFUeNpj/M9AHGAiUt2oQnorZIGzGLFJIyJ40HqGhUiFPFuQ/YUFPBGBmLcDSQybwj8OEDOW/CegsAeiruQ/AYV3OMDqTP4QUugCceCN/wQUQn1a8Z+Awj8qYHUiHwgpXAAxcMJ/Qgp1wOoEPhBSuANiYM5/QgpjIAovEFL4gweszgAz0NASxZ4vYMqHYDKDBiIWhWhWa0CS1x9CVn+8AaYsmAlZfQRC6RDMChADGTQIKjxDrMI7EEoBi0JGlMJe8AOY+sFOSCEeQHQBAABCZ7xyT9fJhwAAAABJRU5ErkJggg==', 
-			'8' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNBeBnwpSAAAAB3RJTUUH0wUOEDUOKe5wowAAAAlwSFlzAAALEgAACxIB0t1+/AAAATVJREFUeNpj/M9AHGAiUt1AKmRB459cc+DBGwYWGQ2LEG1Umf/I4IELkozLA2QpFIUXJFDMEDiBQ+EHGTR3yHzArrAFwwct2BXqQGQ1zvw/owFh6mBXCDXmDJB5BsOrjEhxzfoHIgkiGCGB9xtrgEPtOwvEV6FWY4+ZAAgVc5LhZgKEGYI9wN+gBiPu4Pl/BFWlxA1cMfN/C0rUr8AVhX8K0KyuwaEwASNmarAqPACVTXnw/0oENBFewKYQGhYZYE4MVBM2hVAvQ1LhHQhHBVsUMjIgYhCdhy3PPASTd6GOxBYz0KhOQHajDjY3pkC1Rlz5fweqjqEAm8ILGK5gYLlDZICXYI+ZLzZo6gL+4EgUfyo4kJQJtCCpQ8kKQPB2zZ47L14AU5iMgUMAN7IM43AqHwdQIQAhMPz6Gz5V/wAAAABJRU5ErkJggg==', 
-			'9' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QNCQ+T2tEAAAAB3RJTUUH0wUOEDUHUDLIBwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAUZJREFUeNpj/M9AHGAiUh26wr9rE3V5GRlFTTM3/kVT+R8Z7FBBSKjsQJFCUTiFBcWMCbgUHmBBs20FdoV/VNDUMQi8wapwDVS65s2fPToQZgFWhRFIkm8kwGyeH9gUQm2+Aua0QDhb4LJI4XgHQmmDSRMIZw+emIEENAeEcwObQhEIdQHiABRbUGPGBSIQAWL/gHqbB5tnJkC1Fjz5f8IGwxwkhR8EsCQarFE4hViF/wsQCgKgHsSu8H8HLFkUQL2rgUPh/zslOiwMEjFH/kND2geXQvQgqMAWhSjgAIRygAswIuXCpXfevHjz4M0ZdQaGhxo/wAnyBTuWmPnvARGxuPH/iAa+9Ph/A7r9Ai+wK/zvg6ZwzX8cCl9oICtjmfIfl8L/bwIQ6gyO/Met8P//EwUmwHTJo5OyBU2CkdaF1KhCWisEAM/sJxmZkdWnAAAAAElFTkSuQmCC', 
-			'A' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QFwy1U7TfAAAAB3RJTUUH0wUOEC0ZKCZtPQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAO1JREFUeNrt1LERwiAUBuAHZ2GRwsIypQMwQEZwgBQpM4QDZBSLFI7gCA5gQWGRdA5gkTuMSh48eMTUnq96wH98B+QiDCwruTD3D76qF676ueAp0Y9lSBXeSkFWaLAje3T+kkzK4SgpBzZw8pqxJWcdOJuRsyGPbWDk0tS20zw9SXsobdfytJVXdzNsP61i6Zt3K7Ht0UeUgbPdjsrOXMd+2IS2C2qb271HVWi7YANcNXFQsUEVBTXwNdl46jYRxPl52dnwRUZbhkLSDmS8DnxFRWiULxg8UxvobefuRR8ZQYDKtffVVcQWv/RrfgJC4bd0upw4MQAAAABJRU5ErkJggg==', 
-			'B' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGAusrz2zAAAAB3RJTUUH0wUOEC01Gv4B3gAAAAlwSFlzAAALEgAACxIB0t1+/AAAANJJREFUeNpj/M9AHGAiUh0tFTKiAUHL2rsoKv9DARZDWFr+IwA+hQwMFcQqZDhCrMIIYhWK4FYIYv8444PuV+wK//9/A+UJwBUSCHAL3OEIsdoFyttCpGdiiAtHjoY/RCnk6PlBbBRKrCE6CqcQq5DlDs5whIT3CgUI788EvOEIBCegXB2YPCNMBSNMISqf5TeUjysK90LpP/itfrFEAhZCMHkWdKMYUbk2MAah7BqD02pUYEFkgMu8IE6hD0IdpmegwSejoKLjoY7syaFU7A0HhQA2e4cJytImvAAAAABJRU5ErkJggg==', 
-			'C' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGBbPqVFqAAAAB3RJTUUH0wUOEC4BEGemqAAAAAlwSFlzAAALEgAACxIB0t1+/AAAASlJREFUeNpj/M9AHGAiUt2owkGrkAWV+3TDgRtPPjBwyGiYBOijSv1HAlcCkGUcTiDLISvsQDOeZQp2hQWYDpuCTeEEbD44ganwDgc2vxpgKoyAyUWc+f9hjgCMtwFd4RuYRxog/ueBcl3QFc6BSmj8gfBrwE40yFmCrjABqrAH5mSZgJ4jX7AEjwlU4Zn/OAAsrp9AaRlccc0IzdeMsBilOPWQrBDmtpfEKnwBpZ8qZq58i6IS6vscKHcBcgQYlOz4gh6OK6AKfaB8G5hN6Aq/wBLPHjB3CczCFIzUA0u2PD0v/j9pgaf1ExgK3wgwYAEOWFL4GizqWC5gyzM1mArnEJkLZ2DPhf//n3BAVmeDkq8ZUZPL3TUn7gBLCgYFBYsAcxQZRmKrDwABNsv9SJSDwwAAAABJRU5ErkJggg==', 
-			'D' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGC1+orhOAAAAB3RJTUUH0wUOEC4yr7fHvgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAM9JREFUeNpj/M9AHGAiUt1AKmSBsxiRhXlkNBxCpFFU/ocBTDMyPvxHADwKGRgUbhCpkEHiCZEKGRyIVciwArdCIPPFGg8YzwSvQiBogXFvEFD43wDKnQDl44yZGCh9glAU2sCsJqRQBkq/gMUw3G2wuP6PnU/H9PgRSgsQUvgESosQUngFSqsQUrgCSsNiCFcU7oBx9+CL6w8XamB5SeUPkelxAZEJ1+YPcQolXhCXFTTuEJULOUq+IOVrFgasQELBxMaHG1mEcTiVjwOoEADAIkCnGpmJKgAAAABJRU5ErkJggg==', 
-			'E' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGDeDwEE0AAAAB3RJTUUH0wUOEC8CkHXGUwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD5JREFUeNpj/M9AHGAiUt2owkGrkAXGYMQqjUgJQ8EzpPsa05+D140oMYTk4KEQ4MMqZqgUhcM1czESW30AABfqB1XDnLzcAAAAAElFTkSuQmCC', 
-			'F' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGQe8AkDZAAAAB3RJTUUH0wUOEC8JB6cf2wAAAAlwSFlzAAALEgAACxIB0t1+/AAAADlJREFUeNpj/M9AHGAiUt3wUsiCYDJikUYE3lDwDDm+xvTp4HUjIoaQXTsUAnxYxcyoQryAcUSWuAAW/gZTg/yEMAAAAABJRU5ErkJggg==', 
-			'G' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGRFI1vWIAAAAB3RJTUUH0wUOEC8QY8y3GwAAAAlwSFlzAAALEgAACxIB0t1+/AAAASZJREFUeNpj/M9AHGAiUt0IVciCwvt7ZM+FOy8+MDBwSEho2AQII8v9R4A/U2RQtHEUfEBIIim8YYBhn8oNLAqP8GBxmcwbDIU3sKljYIhAV/jHgAE7uICmcAJMQqDmwp//D2YowPgxqAr/wPyr8QAi8EEHwleIQFW4BxYicG+eEHEomHECET5QhRVQhQn/cQFoFJ6AKgwgFNcPoFwdnAoZIXmGERahKDwkIdqlR1j4PiRW4RVCCmExvQenQrSYEXiDiAoUBfC4loAK23yBSnzArhCRehRmAJPFnRUxHDgU/lDA7zZECj/Cgl2dAkaeWYNVZcoHDIX/94hgKLM4gS27/v9QIICizGMDkiQjSon7c8eBCw+e/GFgkZEwsHCRRpZiHE5FMwCa2YE+WcAOUwAAAABJRU5ErkJggg==', 
-			'H' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGRw2Z4k1AAAAB3RJTUUH0wUOEC8agxleBQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD1JREFUeNpj/M9AHGAiUt2oQvyABUozQml4+KMLDAXPDAWFLGh8RlwKh4JnaB88GOlxELhxVCFewDgEynAAN2sFVHAvevkAAAAASUVORK5CYII=', 
-			'I' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGSlg1E0WAAAAB3RJTUUH0wUOEC86uHd+zQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAD5JREFUeNpj/M9AHGAiUt1AKmRBMBkxJJE9OhQ8Q32FjGhxDQsjjCQwFDwzqnCwKkRKZqO5EBMwDqcSl2iFAMMeB0s/kLo2AAAAAElFTkSuQmCC', 
-			'J' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QGywiiNsbAAAAB3RJTUUH0wUOEDAFw0tdbgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKdJREFUeNpj/M9AHGAiUh3xClmwijJCaSR3Ud/qUYWjCklTyIHEhifctw8ePHgCxO+B7L9QMQlsChW+QOiX4gwMd6BiItisVoHSB6AYWQwM/kNBBszkC/9PwKyc8B8B4Ar3YPHMHWwK/xtgqAv4j1XhEfScK/EEu8L/a1BVStz4j0Ph/yPItoe8QFH3nxGlkNq75cKDB0DDVBwitNEcwjhwpdmoQrwAAN6ioiFapgUdAAAAAElFTkSuQmCC', 
-			'K' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHAEoFhGpAAAAB3RJTUUH0wUOEDANzZDVXAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAPZJREFUeNpj/M9AHGAiUt2owgFSyAgFMOGDrDARxkKo0H8wYEDh/b/AAzepACqEVeEdCQx1WBW+0ICry/mPR+EXE7i6kD94FP5xwaYOi8IIrOowFRbA1Xkgq8NQ2ANXZ/PlPx6FS3CpQ1fIAmOIoKn7jxbXf2CMNxvQIxvVRAQQ+YDXaiSQQqxChiOEFGoIQGidP/gVStxogLI68CqUuPH/BzSVcTzAoxCo7v//ObBIxK0QrO7/H1iCXIFT4QkIFxbaMh9wKYQJO0D5OYQUnoDF/QkCCuHJ1+APAYV3YOloAgGF8JTO84SAwjfQiGQIgPAZqV4rAACnKSarzdlc4gAAAABJRU5ErkJggg==', 
-			'L' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHA64qQw4AAAAB3RJTUUH0wUOEDAXMPIsJgAAAAlwSFlzAAALEgAACxIB0t1+/AAAADlJREFUeNpj/M9AHGAiUt2QUMiCYDJCaezhMBQ8M6pwVCEdFLJgCjEisRH5Zyh4hvoKGUdkQUq0QgARaARRV9jUFQAAAABJRU5ErkJggg==', 
-			'M' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHBhMfblpAAAAB3RJTUUH0wUOEDAqaJpgNwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAPNJREFUeNrdlK0OgzAUhS8bCQYxMYmcmEAgEAgejQfZQyG2pAIxOYlATkAu691o2tvSYia2iv7lyzn3NG0jhG1tt5H7Aggom7ZuaKPhBFqKV+pFWDGjjcxStEAYXuvBkrKtoVX+gdRiK9i6sxjgeVGUMJzWwZLACaZOTqoAOAronmrlBuvPkQsIgHn8BqnE2AMmhaaYJ57jqTRFMwsDyW249XaJLhAujizm7UFM5XCUXTqiTvBLQYWRc7H3WWt+3NmlyGbOGh9q/45mjQxUb+CA6A2jSqu5MweX0ooQWLJxLYx6fz0GwmBOsww5GP3At/dX4Ayb7qpFI9y5ygAAAABJRU5ErkJggg==', 
-			'N' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHC6DxyzwAAAAB3RJTUUH0wUOEDAye/b4YQAAAAlwSFlzAAALEgAACxIB0t1+/AAAALRJREFUeNpj/M9AHGAiUt0IV8gIARsRMlAROP8/BEB5Ii/+/0cVgXNRhRk8iFXIMIFYhRxXiFTIYPCDSIUMBcQqZNhDrEKZN0QqZAggViHDHIIKRSAUzx1CCrdAaZM/BBT+z4Eyaggp/KEDYbAcIaDw/wUWCEuBkML/PagBgFvhfxdiFT4RIVLh/zXEKvyfQqzCLypEKvx/hoVIhf9biFX4x4ZIhf8fCBCp8P8KNBHG4VQ0AwDEOyeZhO5p1AAAAABJRU5ErkJggg==', 
-			'O' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHQExDSDoAAAAB3RJTUUH0wUOEDA4myMRfwAAAAlwSFlzAAALEgAACxIB0t1+/AAAATtJREFUeNpj/M9AHGAiUt3wUsiCyv265ciZJ08YGGRkDGwCuFGk/iOBDwU8SDIcGS+Q5JAV7hBBs45nAVaFC1gwXTYBi8IdWNQxMCzAUPhBBJs6Bp4n6AoLYFI6az78f7NEB8ZNQFP4QwAqEfADwg+A+f0NqsI1UHGBDzCnSKC6EhYzB6B0Cj+UwZ+CKgNTeAZKu8C94QGlL6DGjAyU+wAeXC+gIiIQLiM0KzDC9CFCBlWICsnsL3aFMDc+hcs8QZWBKYSF2g24whvYFZpA6T1whUegNCwyoYGxAmYyLGZ+wOxYghqFX2BpO+APmP8nBspHj2uk1LPizf8PGyxgXPTUQ3x6JDqF//8/AYs6bHkGmCYF0O3FnguBCSaFA0kZS8IDJDlG1IIUVFK8eABMWzI6DgHCyDKMI7LEBQCD5YgI9wbKGgAAAABJRU5ErkJggg==', 
-			'P' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHQvR2Mn2AAAAB3RJTUUH0wUOEDEDMzPJGgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKVJREFUeNpj/M9AHGAiUh05ChlRAKdu4k5Ulf9hANMQiwf/EQCfQgaJB0QqZHAhViHDEbg0AV8vwRM8QN0v5vBAOSfw+BrMWQDl8MClGeEKGGEKQcRXHmQemTGD1RMy+N14o4MDyvGAS7NgGMaIzPHAYyIy4HhBZMy0EBmFIX+IUsjRgqQOi2fAgEVBwyVGGEUEQw2O3EbLzDWSFDIOhtJsVCEWAAC/Yt2X+2PYcgAAAABJRU5ErkJggg==', 
-			'Q' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHRxSC0wxAAAAB3RJTUUH0wUOEDEKSu9xvgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAW1JREFUeNpj/M9AHGAiUt2QUMiCzPm65cCZF08YGGRkDBx8uNFU/oeDDwU8SOIcBS/+IwOEwh0iaEYIrMCqcA4LprsmYFG4A4s6BoYFGAo/iGBTx8DzAl1hAUxKZ8WH/29W6MC4KWgKfwhAJXx+gPl/QmB+/4KqcANUXOQDVPiLBFRkCUwhJGb2wGzihzK4U6CMA6hReAbKc4F7wwFKX0CNGRkoB+HJJ1ARGZgAIziFM8J0IUIGXYjMZPaXkEJYYDyBiz+EuRFVoQKUdwWIz6qWvmRguAMVkUBVaIIUalPu9GgshIefAWrwrIHp//L/DQc4KjFiBi2uQ/7832KB5AX0uP5fAZOx2PDhfwNCIXrq+f9BhgEb4HmCkcL3YE3hSHkBnmfWYFMpsoaYXAgGDgcwFKLlaxYOCG2DqRCYrldkmIACUMIgZsaTI5Cg3IBNISp4AoovlT+EFf7/kYPkb3wK//8/YAGPGcYhUIYDAHBC9Yak1w7iAAAAAElFTkSuQmCC', 
-			'R' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHSkEuIgSAAAAB3RJTUUH0wUOEDEUsOBM3QAAAAlwSFlzAAALEgAACxIB0t1+/AAAAOZJREFUeNpj/M9AHGAiUh0NFLJAaUY0YRkJHYcQdmSh/xCAzRCZHf8RAJ9CBpYNRCpkEHgBV4jfMx+mEOVGIDDAaTWY82aPBZTLgV8hUCkaH6cbP8B8gxHgyODjgwstMDfiVIgWQyFE+lrhB3EBznOFuJgxuUFMXPPEbPmDpA53FH55osKMIoAe4F826MDMvPMfj9WgWFGBBeIf/Ar/H4FxJhBQ+B8WzCIfCCi8A4uvBgIK/2fA/POCgMIXHFBuDqH02ABLM3cIKPwgAuVHEFD4fwJM4AIBhT9goe4AFWAcAsXesFIIAEvJyZHTCSiTAAAAAElFTkSuQmCC', 
-			'S' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHTRnvuTLAAAAB3RJTUUH0wUOEDEbIF9RTAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAVZJREFUeNpj/M9AHGAiUt2oQvyABYX398CWK3de/GBgkVEw8HFgRpH7jwSWqCDLyCxAlkNS+CcG3boY7AozMB3Wgk3hGSw+4HgBl0b4egIWhT9mYPGMBFQg4MH/D2tgvrKASzPC0yMjlP7CDSTOmrDIMDDwiHBsxzSRBypw5j9WgFDoAPNAxIQjX/ApXIDsC4OCLV9wKfzjwIACOEIO4IiZFxbooePzAqvC/z9qONBUStzAqvD//zc9BqgqNX5gVwgETxbkmCClvSk4FYLdsCMCptAGI2YSGV78+PLmz5MX4mDu1ByIMM9n9JiBxe4caGChy8MZMMsUIEFyAMoVwVC4BGaEwpI3/9/MEYGlJQyFPwQYsIE1mL7GlnCR0iNSXLtgqpO4gy1mvtigq1NAxCBKgP9pEUFWxlOCnNIYUYrmn3v23Ljx5gsw88sYOPhwI0sxDoEyHAABtSc836a1EQAAAABJRU5ErkJggg==', 
-			'T' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHgUdTbcyAAAAB3RJTUUH0wUOEDEgkVS4aAAAAAlwSFlzAAALEgAACxIB0t1+/AAAADdJREFUeNpj/M9AHGAiUt0IVcgCpRlxyMODeSh4hmiFjGipB+Z7jEQ1FDwzqnBU4WBSyDicimYAb/AFTaJpyH8AAAAASUVORK5CYII=', 
-			'U' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHhEHl2NPAAAAB3RJTUUH0wUOEDEon48wWgAAAAlwSFlzAAALEgAACxIB0t1+/AAAAKlJREFUeNpj/M9AHGAiUh3xClmgNCOUhrsEXYD6Vo8qHFVIuUIVKP0USr+E0jLoCjWg9A4ovQVNHJjUIaADZsILMPeFApRfA5X/D1N4AaZRYc6b/2+WwNQxXEBX+N8Bqxcc/mMoPMGCRR3LBUyF/2dgUTjjPxaF/6egm8ky5T9Whf9P2KCoMziBJPefEaWQurjnzIMXL34wsMhoWHiYo2hjHLjSbFQhXgAAKzejCLAOcVMAAAAASUVORK5CYII=', 
-			'V' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHh/gL05IAAAAB3RJTUUH0wUOEDEuduyVbwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAVNJREFUeNpj/M9AHGAiUt2owoFRaMgIAYlIMqlQMUMo/z8ITIByRP78hwMRqNgECBei8AULVPQIXN0RqAjLGwgfYrW4B1R4DdzmLVDaQxjZ6v8roDwVuIkqMK3/ka3+/0MAKn4FKn4D5uof/5GtZmCPgEpsQHNDBDsDitVwt5tA+RZQ/pn/qFYj3PQEzHsC5WnA3QyPmQQU3+5AE0VYDTfDBcxzgQbik/8YVv93gMp9AbK/cEAD8T+m1TBb/oD8veEHhs0IE2GmxADZMRAmz4//WKxGkv3DA2Gm/MeqcA/Ujj1w1hHsCv/LQKQz/megRzyawgqIvAxMRwsuhbCEAEvGT3AphEUwNCU5IEv9R8lcUH9/wAxE5HAEgjccSBI8X3CbKOyBxAnhxm3i/w1IEgdQZFA98/+PCFydDKo6VKsZmGPQ0wgOq/+fgYvfQTORkeq1AgCIAvD7+THsDgAAAABJRU5ErkJggg==', 
-			'W' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QFhZRKnzkAAAAB3RJTUUH0wUOEDIR66frkQAAAAlwSFlzAAALEgAACxIB0t1+/AAAAXNJREFUeNrtlK1ywkAUhZdMZsJMKyIqKhAIBAKBiEBEVCDyCJV9iIo+Do9QGRERgUBEVCAqKhAIREVERURnTvfn3t27xSA6g+kOQ/ZkP/aec5NlBHXZSC7k/sE/AhUwoVkDPQ58/2RUQ2IC6B1XpN7MV8tg62/pUdjSDO7OwR2J0pbekpqZYlMG50bNSGwBDQ4pyV5YtCZ7mqZf1mO2IN2Jynba0XRx49pThjQCbEKWFfVRpIlBzlK4PuLdpxEWlTr4LHvYMEDOaTYS3HCW3DAJt8mmaSXYchZbOfEzkyYGZRbrEbX8qe7GMpLqFeyxV9F4fon1pwcxjxbqJpJTBPBJLoyHYSz1I3xq78aOMssepHZZHFjKhbX9/AZd6e9bsdABeyHTQXiE2PLO6PugCwiP/r1QVLYSlpXwKE1Wno7b7jY+hoWj0aegPyA9+jPrzgqwZJ0j8hhMVtElmDoD19FFPAvamc+sOXBm+KdYEzC63p/9D7Tr72kj/8qjAAAAAElFTkSuQmCC', 
-			'X' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHi/G9n7kAAAAB3RJTUUH0wUOEDIXAsROpAAAAAlwSFlzAAALEgAACxIB0t1+/AAAAT9JREFUeNpj/M9AHGAiUt3IVhjKCAFr4RJroSKBMIH/YPBEAMITeQLh//8gAxHggQlAFf6fAdXnA+WnQPkT/qMp/O8AlVkA5h2A8kz+YCi8wQGREngA5PxQgXBYzvzHUPi/A2qIA5BdAmUX/Mei8I8BVHbK/wssEJbMB2wK/5+ASvPcgGlZ8x+rQriFAmghgKHwiwJKXPA8wKXw/x4UhT3/cSr8n4CkzuAPHoVvRODqWE6gyPxHTT1ffiAUCjCgAhRtDkgSFnisnoJixAScCh/wEBk8DmiucsChcA5MQQSMMQWrQlgiZ0iAByey5QiFPlBZnS//v+hgxjZc4QKYKVeAnCswby3AUAi3eAGKNoEn6Ap94A5EjXUfNIUrEA6EALgzl6AohCUGsAMhAOZMkTfICkMw3I5wZgiEyzicimYAFRFkVwgDfJ0AAAAASUVORK5CYII=', 
-			'Y' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHjkyIsu1AAAAB3RJTUUH0wUOEDIkvRQvsgAAAAlwSFlzAAALEgAACxIB0t1+/AAAANJJREFUeNrt1L0NgzAQBWAcUVB6AAZgBAoKhmAICoZgCAoKxmAECkbwABSUlBRILwF8duwYhFJEihJ37+6T5T9g8K6N20X3FdDDNjKKOeTIqZLtWcKBU73bCx1lPhgQNTWieY1zRLmGCZFQp1xTSSmBDUUgW754BF+GQLxAPUkMxMb0FlzUsqpKLXhxQPRqo+oIerggCvuMC7jhFJounA4gWhO2OIL6Jp/uzglHrh0fTyAaDRucQaTkUpxDQVBYDWZ/hYze6bsv/A8/DNlP/kgvwzuer4kCMGPZDgAAAABJRU5ErkJggg==', 
-			'Z' =&gt; 'iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAAAAACpleexAAAAFXRFWHRDcmVhdGlvbiBUaW1lAAfTBQ4QHwfqWOdfAAAAB3RJTUUH0wUOEDIrLasyIwAAAAlwSFlzAAALEgAACxIB0t1+/AAAAL5JREFUeNrl1C0OwkAQBWCWQIJEVPQIFT0GAlHBMRBIBKIHqahAIDlERY9R0UOs3ORh5qVLunmp5GfUZvczbzKzDqtltV7ofgtueHCp16h33xBGwn0KYqoTO/J868Csaj418e0cPujOkLDfmTsECcfcXOGhoC/NZQMUDBUDd5DwxiAtJGzprpCw48xVQcIhM1d6KOgLc/kIBcORgXtIeGGQOyRs6Oq0g7P92YbkRE7bRZhcwhh+6nLF5f7yx30B8Z7FgxzMWtEAAAAASUVORK5CYII=', 
-		);
-
-		return $_png;
-	}
-}
-
-?&gt;
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -20,19 +20,30 @@
 		$_CLASS['core_user']-&gt;add_lang('groups');
 
 		$submit	= !empty($_POST['submit']);
-		$group_ids = array_map('intval', request_var('mark', array(0)));
 
-		if ($submit)
+		if (is_array($_POST['group_id']))
 		{
+			$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
+		}
+		elseif 
+		{
+			if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+			{
+				$group_id = array($group_id);
+			}
+		}
+	
+
+		if ($submit &amp;&amp; !empty($group_id))
+		{
 			require_once($site_file_root.'includes/functions_user.php');
 
 			switch ($_POST['mode'])
 			{
 				case 'resign':
-					
 					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
 								WHERE group_type = ' . GROUP_SPECIAL .'
-								AND group_id IN ('. implode(', ', $group_ids) .')';
+								AND group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
 					$special = array();
@@ -42,14 +53,30 @@
 					}
 					$_CLASS['core_db']-&gt;free_result($result);
 
-					$group_ids = array_diff($group_ids, $special);
+					$group_id = array_diff($group_id, $special);
 					unset($special);
 
-					groups_user_remove($group_ids, $_CLASS['core_user']-&gt;data['user_id']);
+					groups_user_remove($group_id, $_CLASS['core_user']-&gt;data['user_id']);
 				break;
 
 				case 'apply':
-					
+					$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
+								WHERE group_type IN (' . GROUP_REQUEST .', ' . GROUP_UNRESTRAINED .')
+								AND group_id IN ('. implode(', ', $group_id) .')';
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$group_id = array()
+
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						if ($row['user_id'] == STATUS_ACTIVE)
+						{
+							$group_id[] = $row['user_id'];
+						}
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					groups_user_remove($group_ids, $_CLASS['core_user']-&gt;data['user_id']);
 				break;		
 			}
 		}
@@ -66,14 +93,15 @@
 		$group_id_ary = array();
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
+			$row['group_status'] = STATUS_ACTIVE;
+
 			$block = ($row['user_status'] == STATUS_LEADER) ? 'leader' : (($row['user_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
 			$_CLASS['core_template']-&gt;assign_vars_array($block, array(
 				'GROUP_ID'			=&gt; $row['group_id'],
-				'GROUP_NAME'		=&gt; ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'		=&gt; ($row['group_type'] &lt;&gt; GROUP_SPECIAL) ? $row['group_description'] : $_CLASS['core_user']-&gt;lang['GROUP_IS_SPECIAL'],
-				'GROUP_SPECIAL'		=&gt; ($row['group_type'] &lt;&gt; GROUP_SPECIAL) ? false : true,
-
+				'GROUP_NAME'		=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
+				'GROUP_DESC'		=&gt; $row['group_description'],
+				'GROUP_RESIGN'		=&gt; ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL &amp;&amp; $row['user_status'] == STATUS_PENDING),
 				'U_VIEW_GROUP'		=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
 				'S_GROUP_DEFAULT'	=&gt; ($row['group_id'] == $_CLASS['core_user']-&gt;data['group_id']) ? true : false
 			));
@@ -83,7 +111,7 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		// Hide hidden groups unless user is an admin with group privileges
-		$sql_and = ($_CLASS['auth']-&gt;acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '&lt;&gt; ' . GROUP_SPECIAL : 'NOT IN (' . GROUP_SPECIAL . ', ' . GROUP_HIDDEN . ')';
+		$sql_and = ($_CLASS['auth']-&gt;acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '&lt;&gt; ' . GROUP_SYSTEM : 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
 		$sql = 'SELECT group_id, group_name, group_description, group_type
 			FROM ' . GROUPS_TABLE . '
@@ -94,13 +122,13 @@
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
+			$row['group_status'] = STATUS_ACTIVE;
+
 			$_CLASS['core_template']-&gt;assign_vars_array('nonmember', array(
 				'GROUP_ID'		=&gt; $row['group_id'],
-				'GROUP_NAME'	=&gt; ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
+				'GROUP_NAME'	=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'	=&gt; $row['group_description'],
-				'GROUP_SPECIAL'	=&gt; ($row['group_type'] == GROUP_SPECIAL),
-				'GROUP_CLOSED'	=&gt; ($row['group_type'] &lt;&gt; GROUP_CLOSED || $_CLASS['auth']-&gt;acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? false : true,
-
+				'GROUP_APPLY'	=&gt; ($row['group_type'] != GROUP_SYSTEM &amp;&amp; $row['group_status'] == STATUS_ACTIVE),
 				'U_VIEW_GROUP'	=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
 			));
 		}

Modified: trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -17,13 +17,15 @@
 	{
 		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
 
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'ERROR' 		=&gt; false,
 			'topicrow'		=&gt; false,
 			'WARNINGS'		=&gt; false,
-			'draftrow'		=&gt; false)
-		);
+			'draftrow'		=&gt; false
+		));
+
 		$_CLASS['core_user']-&gt;user_setup();
+
 		switch ($mode)
 		{
 			case 'front':
@@ -44,7 +46,7 @@
 						$_CLASS['core_db']-&gt;free_result($result);
 					}
 
-					$sql_from = TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
+					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
 					$sql_select = ', tt.mark_time';
 
 				}
@@ -54,8 +56,6 @@
 					$sql_select = '';
 				}
 
-				$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
-		
 				// Has to be in while loop if we not only check forum id 0
 				if ($config['load_db_lastread'])
 				{
@@ -63,6 +63,7 @@
 				}
 				else
 				{
+					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
 					$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
 				}
 
@@ -158,7 +159,7 @@
 					
 					// Grab all the relevant data
 					$sql = 'SELECT COUNT(p.post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
 						WHERE p.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; 
 							AND f.forum_id = p.forum_id 
 							$post_count_sql&quot;;
@@ -169,7 +170,7 @@
 					$num_real_posts = min($_CLASS['core_user']-&gt;data['user_posts'], $num_posts);
 
 					$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
 						WHERE p.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; 
 							AND f.forum_id = p.forum_id 
 							$post_count_sql
@@ -181,7 +182,7 @@
 					$_CLASS['core_db']-&gt;free_result($result);
 
 					$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
 						WHERE p.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; 
 							AND t.topic_id = p.topic_id  
 							AND f.forum_id = t.forum_id 
@@ -225,7 +226,7 @@
 				unset($active_t_row);
 
 
-				$_CLASS['core_template']-&gt;assign(array(
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'USER_COLOR'		=&gt; (!empty($_CLASS['core_user']-&gt;data['user_colour'])) ? $_CLASS['core_user']-&gt;data['user_colour'] : '', 
 					'JOINED'			=&gt; $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_regdate']),
 					'VISITED'			=&gt; (empty($_CLASS['core_user']-&gt;data['user_lastvisit'])) ? ' - ' : $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_lastvisit']),
@@ -244,6 +245,7 @@
 
 					'U_SEARCH_USER'		=&gt; ($_CLASS['auth']-&gt;acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']-&gt;data['username']) . &quot;&amp;show_results=posts&quot;) : '',  
 					'U_ACTIVE_FORUM'	=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$active_f_id),
+					'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
 					'U_ACTIVE_TOPIC'	=&gt; generate_link('Forums&amp;file=viewtopic&amp;t='.$active_t_id))
 				);
 
@@ -264,10 +266,11 @@
 					if ($forums || $topics)
 					{
 						$l_unwatch = '';
+
 						if ($forums)
 						{
 							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
-								WHERE forum_id IN ($forums) 
+								WHERE forum_id IN ($forums) AND topic_id = 0
 									AND user_id = &quot; .$_CLASS['core_user']-&gt;data['user_id'];
 							$_CLASS['core_db']-&gt;query($sql);
 
@@ -276,8 +279,8 @@
 
 						if ($topics)
 						{
-							$sql = 'DELETE FROM ' . TOPICS_WATCH_TABLE . &quot;
-								WHERE topic_id IN ($topics) 
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
+								WHERE topic_id IN ($topics)
 									AND user_id = &quot; .$_CLASS['core_user']-&gt;data['user_id'];
 							$_CLASS['core_db']-&gt;query($sql);
 
@@ -293,12 +296,12 @@
 
 				if ($config['load_db_lastread'])
 				{
-					$sql_from = FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND ft.forum_id = f.forum_id)';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND ft.forum_id = f.forum_id)';
 					$lastread_select = ', ft.mark_time ';
 				}
 				else
 				{
-					$sql_from = FORUMS_TABLE . ' f ';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
 					$lastread_select = '';
 
 					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
@@ -380,23 +383,19 @@
 
 				if ($topics_count)
 				{
-					$_CLASS['core_template']-&gt;assign(array(
+					$_CLASS['core_template']-&gt;assign_array(array(
 						'PAGINATION'	=&gt; generate_pagination(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;, $topics_count, $config['topics_per_page'], $start),
 						'PAGE_NUMBER'	=&gt; on_page($topics_count, $config['topics_per_page'], $start),
 						'TOTAL_TOPICS'	=&gt; ($topics_count == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPICS'], $topics_count))
 					);
 				}
 // Fix this up
-				$sql_from = ($config['load_db_lastread'] || $config['load_db_track']) ? TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')' : TOPICS_TABLE . ' t';
-				$sql_f_tracking = ($config['load_db_lastread']) ? 'LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.forum_id = t.forum_id AND ft.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '), ' : '';
-
-				$sql_t_select = ($config['load_db_lastread'] || $config['load_db_track']) ? ', tt.mark_time' : '';
-				$sql_f_select = ($config['load_db_lastread']) ? ', ft.mark_time AS forum_mark_time' : '';
-
+				$sql_from = ($config['load_db_lastread']) ? FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')' : TOPICS_TABLE . ' t';
+				$sql_t_select = ($config['load_db_lastread']) ? ', tt.mark_time' : '';
 //
-				$sql = &quot;SELECT t.* $sql_f_select $sql_t_select 
-					FROM $sql_from $sql_f_tracking &quot; . FORUMS_WATCH_TABLE . ' tw
-					WHERE tw.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+				$sql = &quot;SELECT t.* $sql_t_select 
+					FROM &quot;. FORUMS_WATCH_TABLE . &quot; tw, $sql_from 
+					WHERE tw.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . '
 						AND t.topic_id = tw.topic_id 
 					ORDER BY t.topic_last_post_time DESC';
 				$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page'], $start);
@@ -408,16 +407,13 @@
 					
 					if ($config['load_db_lastread'])
 					{
-						$mark_time_topic = $row['mark_time'];
-						$mark_time_forum = $row['forum_mark_time'];
-					}
-					else
-					{
 						$topic_id36 = base_convert($topic_id, 10, 36);
 						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : $forum_id;
 						$mark_time_topic = (isset($tracking_topics[$forum_id36][$topic_id36])) ? base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
 
 						$mark_time_forum = (isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+
+						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
 					}
 
 					// Replies
@@ -430,8 +426,8 @@
 
 					// Get folder img, topic status/type related informations
 					$folder_img = $folder_alt = $topic_type = '';
-// TEMP max($mark_time_topic, $mark_time_forum)
-					$unread_topic = topic_status($row, $replies, max($mark_time_topic, $mark_time_forum), $folder_img, $folder_alt, $topic_type);
+
+					$unread_topic = topic_status($row, $replies, $row['mark_time'], $folder_img, $folder_alt, $topic_type);
 					$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;'. generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
 
 					$view_topic_url = &quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;;
@@ -443,7 +439,7 @@
 						'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
 						'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
+						'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
 						'PAGINATION' 		=&gt; topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . &quot;&amp;t=$topic_id&quot;),
 						'REPLIES' 			=&gt; $replies,
 						'VIEWS' 			=&gt; $row['topic_views'],
@@ -466,9 +462,8 @@
 					
 				}
 				$_CLASS['core_db']-&gt;free_result($result);
+			break;
 
-				break;
-
 			case 'bookmarks':
 				
 				if (!$config['allow_bookmarks'])
@@ -482,7 +477,7 @@
 				$move_up = request_var('move_up', 0);
 				$move_down = request_var('move_down', 0);
 
-				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . BOOKMARKS_TABLE . '
+				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 				$result = $_CLASS['core_db']-&gt;query($sql);
 				list($max_order_id) = $_CLASS['core_db']-&gt;fetch_row_num($result);
@@ -495,7 +490,7 @@
 						$order = ($move_up) ? $move_up : $move_down;
 						$order_total = $order * 2 + (($move_up) ? -1 : 1);
 		
-						$sql = 'UPDATE ' . BOOKMARKS_TABLE . &quot;
+						$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
 							SET order_id = $order_total - order_id
 							WHERE order_id IN ($order, &quot; . (($move_up) ? $order - 1 : $order + 1) . ')
 								AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
@@ -521,13 +516,13 @@
 
 					if (confirm_box(true))
 					{
-						$sql = 'DELETE FROM ' . BOOKMARKS_TABLE . '
+						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 								AND topic_id IN (' . implode(', ', $topics) . ')';
 						$_CLASS['core_db']-&gt;query($sql);
 
 						// Re-Order bookmarks (possible with one query? This query massaker is not really acceptable...)
-						$sql = 'SELECT topic_id FROM ' . BOOKMARKS_TABLE . '
+						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 							ORDER BY order_id ASC';
 						$result = $_CLASS['core_db']-&gt;query($sql);
@@ -535,7 +530,7 @@
 						$i = 1;
 						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 						{
-							$_CLASS['core_db']-&gt;query('UPDATE ' . BOOKMARKS_TABLE . &quot;
+							$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
 								SET order_id = '$i'
 								WHERE topic_id = '{$row['topic_id']}'
 									AND user_id = '{$_CLASS['core_user']-&gt;data['user_id']}'&quot;);
@@ -557,9 +552,9 @@
 				// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
 				// But since bookmarks are sensible to the user, they should not be deleted without notice.
 				$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
-					FROM ' . BOOKMARKS_TABLE . ' b
-						LEFT JOIN ' . TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
-						LEFT JOIN ' . FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
+					FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
+						LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
+						LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
 					WHERE b.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 					ORDER BY b.order_id ASC';
 				$result = $_CLASS['core_db']-&gt;query($sql);
@@ -568,7 +563,7 @@
 				{
 					$_CLASS['core_db']-&gt;free_result($result);
 					
-					$_CLASS['core_template']-&gt;assign(array(
+					$_CLASS['core_template']-&gt;assign_array(array(
 							'S_BOOKMARKS'			=&gt; false,
 							'S_BOOKMARKS_DISABLED'	=&gt; false
 					));
@@ -589,9 +584,11 @@
 					$folder_img = $folder_alt = $topic_type = '';
 					$unread_topic = topic_status($row, $replies, time(), time(), $folder_img, $folder_alt, $topic_type);
 
-					$view_topic_url = generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;);
+					$view_topic_url = &quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;;
 //					$last_post_img = '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST') . '&lt;/a&gt;';
 
+					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
+
 					$_CLASS['core_template']-&gt;assign_vars_array('forummarks', array(
 						'FORUM_ID' 			=&gt; $forum_id,
 						'TOPIC_ID' 			=&gt; $topic_id,
@@ -605,15 +602,20 @@
 						'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
 						'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
-						'PAGINATION' 		=&gt; topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . &quot;&amp;t=$topic_id&quot;),
-				
+						'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
 
+						'PAGINATION'		=&gt; $pagination['formated'],
+						'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+
 						'POSTED_AT'			=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
 						'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
 						'ATTACH_ICON_IMG'	=&gt; ($_CLASS['auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', '') : '',
 
-						'U_VIEW_TOPIC'		=&gt; $view_topic_url,
+						'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url),
 						'U_VIEW_FORUM'		=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
+						
+						'U_LAST_POST'		=&gt; generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+						'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 						'U_MOVE_UP'			=&gt; ($row['order_id'] != 1) ? generate_link(&quot;Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}&quot;) : '',
 						'U_MOVE_DOWN'		=&gt; ($row['order_id'] != $max_order_id) ? generate_link(&quot;Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}&quot;) : '')
 					);
@@ -622,7 +624,7 @@
 
 				$_CLASS['core_db']-&gt;free_result($result);
 
-				$_CLASS['core_template']-&gt;assign(array(
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'S_BOOKMARKS'			=&gt; $bookmarks,
 					'S_BOOKMARKS_DISABLED'	=&gt; false
 				));
@@ -650,7 +652,7 @@
 
 					if ($drafts)
 					{
-						$sql = 'DELETE FROM ' . DRAFTS_TABLE . &quot;
+						$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . &quot;
 							WHERE draft_id IN ($drafts) 
 								AND user_id = &quot; .$_CLASS['core_user']-&gt;data['user_id'];
 						$_CLASS['core_db']-&gt;query($sql);
@@ -675,7 +677,7 @@
 							'draft_message' =&gt; $draft_message
 						);
 
-						$sql = 'UPDATE ' . DRAFTS_TABLE . ' 
+						$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
 							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $draft_row) . &quot; 
 							WHERE draft_id = $draft_id
 								AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
@@ -695,7 +697,7 @@
 				if (!$pm_drafts)
 				{
 					$sql = 'SELECT d.*, f.forum_name
-						FROM ' . DRAFTS_TABLE . ' d, ' . FORUMS_TABLE . ' f
+						FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
 						WHERE d.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
 							(($edit) ? &quot;AND d.draft_id = $draft_id&quot; : '') . '
 							AND f.forum_id = d.forum_id
@@ -703,7 +705,7 @@
 				}
 				else
 				{
-					$sql = 'SELECT * FROM ' . DRAFTS_TABLE . '
+					$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
 						WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
 							(($edit) ? &quot;AND draft_id = $draft_id&quot; : '') . '
 							AND forum_id = 0 
@@ -727,7 +729,7 @@
 				if (sizeof($topic_ids))
 				{
 					$sql = 'SELECT topic_id, forum_id, topic_title
-						FROM ' . TOPICS_TABLE . '
+						FROM ' . FORUMS_TOPICS_TABLE . '
 						WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -788,14 +790,14 @@
 						'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields
 					);
 						
-					($edit) ? $_CLASS['core_template']-&gt;assign($template_row) : $_CLASS['core_template']-&gt;assign_vars_array('draftrow', $template_row);
+					($edit) ? $_CLASS['core_template']-&gt;assign_array($template_row) : $_CLASS['core_template']-&gt;assign_vars_array('draftrow', $template_row);
 				}
 
 				break;
 		}
 
 
-		$_CLASS['core_template']-&gt;assign(array( 
+		$_CLASS['core_template']-&gt;assign_array(array( 
 			'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_MAIN_' . strtoupper($mode)],
 			'S_DISPLAY_MARK_ALL'		=&gt; ($mode == 'watched' || ($mode == 'drafts' &amp;&amp; !isset($_GET['edit']))) ? true : false, 
 			'S_HIDDEN_FIELDS'			=&gt; (isset($s_hidden_fields)) ? $s_hidden_fields : '',
@@ -804,27 +806,9 @@
 		));
 		
 		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_MAIN'], 'ucp_main_' . $mode . '.html');
-	}
 
-	function install()
-	{
 	}
 
-	function uninstall()
-	{
-	}
-
-	function module()
-	{
-		$details = array(
-			'name'			=&gt; 'UCP - Main',
-			'description'	=&gt; 'Front end for User Control Panel', 
-			'filename'		=&gt; 'main',
-			'version'		=&gt; '1.0.0', 
-			'phpbbversion'	=&gt; '2.2.0'
-		);
-		return $details;
-	}
 }
 
 ?&gt;
\ No newline at end of file

Modified: trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -183,7 +183,7 @@
 				}
 				else
 				{
-					$folder_id = request_var('f', PRIVMSGS_NO_BOX);
+					$folder_id = request_var('f', PRIVMSGS_INBOX);
 					$action = request_var('action', 'view_folder');
 				}
 
@@ -242,7 +242,7 @@
 				else if ($msg_id &amp;&amp; $folder_id == PRIVMSGS_NO_BOX)
 				{
 					$sql = 'SELECT folder_id
-						FROM ' . PRIVMSGS_TO_TABLE . &quot;
+						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
 						WHERE msg_id = $msg_id
 							AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
 					$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -265,7 +265,7 @@
 						$sql_ordering = ($view == 'next') ? 'ASC' : 'DESC';
 
 						$sql = 'SELECT t.msg_id
-							FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . PRIVMSGS_TABLE . &quot; p2
+							FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . &quot; p2
 							WHERE p2.msg_id = $msg_id
 								AND t.folder_id = $folder_id
 								AND t.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
@@ -286,7 +286,7 @@
 					}
 	
 					$sql = 'SELECT t.*, p.*, u.*
-						FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
+						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_USERS_TABLE . ' u
 						WHERE t.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 							AND p.author_id = u.user_id
 							AND t.folder_id = $folder_id

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -224,7 +224,7 @@
 		$min_post_time = time() - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
-			FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . &quot; p
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
 			WHERE $folder_sql
 				AND t.user_id = $user_id
 				AND t.msg_id = p.msg_id
@@ -252,7 +252,7 @@
 			if (in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
 			{
 				$sql = 'SELECT COUNT(t.msg_id) AS pm_count
-					FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . &quot; p
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
 					WHERE $folder_sql
 						AND t.user_id = $user_id
 						AND t.msg_id = p.msg_id&quot;;
@@ -260,7 +260,7 @@
 			else
 			{
 				$sql = 'SELECT pm_count 
-					FROM ' . PRIVMSGS_FOLDER_TABLE . &quot; 
+					FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot; 
 					WHERE folder_id = $folder_id
 						AND user_id = $user_id&quot;;
 			}
@@ -319,7 +319,7 @@
 	}
 
 	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.message_reported, p.to_address, p.message_attachment, p.bcc_address, u.username 
-		FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . &quot; u
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . &quot; u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id
 			AND $folder_sql

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -24,8 +24,6 @@
 			trigger_error('UCP_REGISTER_DISABLE');
 		}
 
-		//require($site_file_root.'includes/forums/functions_profile_fields.php');
-
 		// Do not alter this first one to use request_var!
 		$confirm_id = request_var('confirm_id', '');
 		$coppa		= (isset($_REQUEST['coppa'])) ? !empty($_REQUEST['coppa']) : null;
@@ -55,7 +53,7 @@
 				$now = explode(':', gmdate('m:j:Y'));
 				$coppa_birthday = $_CLASS['core_user']-&gt;format_date(mktime(12, 0, 0, $now[0], $now[1] - 1, $now[2] - 13, 0)); 
 
-				$_CLASS['core_template']-&gt;assign(array(
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'L_COPPA_NO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_BEFORE'], $coppa_birthday),
 					'L_COPPA_YES'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
 
@@ -68,7 +66,7 @@
 			}
 			else
 			{
-				$_CLASS['core_template']-&gt;assign(array(
+				$_CLASS['core_template']-&gt;assign_array(array(
 					'S_SHOW_COPPA'		=&gt; false, 
 					'S_REGISTER_ACTION'	=&gt; generate_link('Control_Panel&amp;mode=register'))
 				);
@@ -362,7 +360,7 @@
 					$_CLASS['core_user']-&gt;session_data_get('reg_attempts', ($attempts + 1));
 				}
 				
-				$_CLASS['core_user']-&gt;session_data_get('confirmation_code', generate_string(6));
+				$_CLASS['core_user']-&gt;session_data_set('confirmation_code', generate_string(6));
 			}
 
 			$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';

Deleted: trunk/modules/Control_Panel/ucp/ucp_remind.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_remind.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_remind.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,100 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_remind.php,v 1.8 2004/02/21 12:47:34 acydburn Exp $
-//
-// FILENAME  : ucp_remind.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-class ucp_remind extends module 
-{
-	function ucp_remind($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root;
-		
-		$_CLASS['core_template']-&gt;assign('S_HIDDEN_FIELDS', false);
-
-		$submit = (isset($_POST['submit'])) ? true : false;
-
-		if ($submit)
-		{
-			$username	= request_var('username', '');
-			$email		= request_var('email', '');
-
-			$sql = 'SELECT user_id, username, user_email, user_jabber, user_notify_type, user_type, user_lang
-				FROM ' . USERS_TABLE . &quot;
-				WHERE user_email = '&quot; . $_CLASS['core_db']-&gt;sql_escape($email) . &quot;'
-					AND username = '&quot; . $_CLASS['core_db']-&gt;sql_escape($username) . &quot;'&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-			{
-				trigger_error('NO_EMAIL_USER');
-			}
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-			if ($row['user_type'] == USER_INACTIVE)
-			{
-				trigger_error('ACCOUNT_NOT_ACTIVATED');
-			}
-
-			$server_url = generate_board_url();
-			$username = $row['username'];
-			$user_id = $row['user_id'];
-
-			$key_len = 54 - strlen($server_url);
-			$key_len = ($key_len &gt; 6) ? $key_len : 6;
-			$user_actkey = substr(gen_rand_string(10), 0, $key_len);
-			$user_password = gen_rand_string(8);
-
-			$sql = 'UPDATE ' . USERS_TABLE . &quot;
-				SET user_newpasswd = '&quot; . $_CLASS['core_db']-&gt;sql_escape(md5($user_password)) . &quot;', user_actkey = '&quot; . $_CLASS['core_db']-&gt;sql_escape($user_actkey) . &quot;'
-				WHERE user_id = &quot; . $row['user_id'];
-			$_CLASS['core_db']-&gt;sql_query($sql);
-
-			include_once($site_file_root. 'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger();
-
-			$messenger-&gt;template('user_activate_passwd', $row['user_lang']);
-			
-			$messenger-&gt;replyto($_CLASS['core_user']-&gt;data['user_email']);
-			$messenger-&gt;to($row['user_email'], $row['username']);
-			$messenger-&gt;im($row['user_jabber'], $row['username']);
-
-			$messenger-&gt;assign_vars(array(
-				'SITENAME'		=&gt; $config['site_name'],
-				'USERNAME'		=&gt; $username,
-				'PASSWORD'		=&gt; $user_password,
-				'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-				'U_ACTIVATE'	=&gt; generate_link(&quot;Control_Panel&amp;mode=activate&amp;u=$user_id&amp;k=$user_actkey&quot;, array('full' =&gt; true, 'sid' =&gt; false)))
-			);
-
-			$messenger-&gt;send($row['user_notify_type']);
-			$messenger-&gt;save_queue();
-			
-			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link());
-
-			$message = $_CLASS['core_user']-&gt;lang['PASSWORD_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;' . generate_link() . '&quot;&gt;', '&lt;/a&gt;');
-			trigger_error($message);
-		}
-		else
-		{
-			$username = $email = '';
-		}
-
-		$_CLASS['core_template']-&gt;assign(array(
-			
-			'USERNAME'	=&gt; $username,
-			'EMAIL'		=&gt; $email)
-		);
-
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_REMIND'], 'ucp_remind.html');
-	}
-}
-
-?&gt;
\ No newline at end of file

Deleted: trunk/modules/Control_Panel/ucp/ucp_resend.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_resend.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Control_Panel/ucp/ucp_resend.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,150 +0,0 @@
-&lt;?php
-/** 
-*
-* @package ucp
-* @version $Id: ucp_resend.php,v 1.1 2005/04/09 12:26:57 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-* @package ucp
-* ucp_resend
-* Resending activation emails
-*/
-class ucp_resend extends module 
-{
-	function ucp_resend($id, $mode)
-	{
-		global $site_file_root, $config, $_CORE_CONFIG, $_CLASS;
-
-		$submit = (isset($_POST['submit'])) ? true : false;
-
-		if ($submit)
-		{
-			$username	= request_var('username', '');
-			$email		= request_var('email', '');
-
-			$sql = 'SELECT user_id, username, user_email, user_type, user_lang, user_actkey
-				FROM ' . USERS_TABLE . &quot;
-				WHERE user_email = '&quot; . $_CLASS['core_db']-&gt;sql_escape($email) . &quot;'
-					AND username = '&quot; . $_CLASS['core_db']-&gt;sql_escape($username) . &quot;'&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-			{
-				trigger_error('NO_EMAIL_USER');
-			}
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-			if (!$row['user_actkey'])
-			{
-				trigger_error('ACCOUNT_ALREADY_ACTIVATED');
-			}
-
-			$server_url = generate_board_url();
-			$username = $row['username'];
-			$user_id = $row['user_id'];
-
-/*			if ($coppa)
-			{
-				$email_template = 'coppa_welcome_inactive';
-			}*/
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-			{
-				$email_template = 'admin_welcome_inactive';
-			}
-			else
-			{
-				$email_template = 'user_welcome_inactive';
-			}
-
-			include_once($site_file_root.'includes/forums/functions_messenger.php');
-
-			$messenger = new messenger(false);
-
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $coppa)
-			{
-				$messenger-&gt;template('user_resend_inactive', $row['user_lang']);
-
-				$messenger-&gt;replyto($config['board_contact']);
-				$messenger-&gt;to($row['user_email'], $row['username']);
-
-				$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-				$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-				$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-				$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
-
-				$messenger-&gt;assign_vars(array(
-					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
-					'WELCOME_MSG'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
-					'USERNAME'		=&gt; $row['username'],
-					'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-
-					'U_ACTIVATE'	=&gt; generate_link(&quot;Control_Panel&amp;mode=activate&amp;u={$row['user_id']}&amp;k={$row['user_actkey']}&quot;, array('full' =&gt; true, 'sid' =&gt; false)))
-				);
-
-				if ($coppa)
-				{
-					$messenger-&gt;assign_vars(array(
-						'FAX_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_fax'],
-						'MAIL_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_mail'],
-						'EMAIL_ADDRESS' =&gt; $row['user_email'],
-						'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'])
-					);
-				}
-
-				$messenger-&gt;send(NOTIFY_EMAIL);
-			}
-
-			if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-			{
-				// Grab an array of user_id's with a_user permissions ... these users
-				// can activate a user
-				$admin_ary = $_CLASS['auth']-&gt;acl_get_list(false, 'a_user', false);
-
-				$sql = 'SELECT user_id, username, user_email, user_lang, user_jabber, user_notify_type
-					FROM ' . USERS_TABLE . '
-					WHERE user_id IN (' . implode(', ', $admin_ary[0]['a_user']) .')';
-				$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-				{
-					$messenger-&gt;template('admin_activate', $row['user_lang']);
-					$messenger-&gt;replyto($config['board_contact']);
-					$messenger-&gt;to($row['user_email'], $row['username']);
-					$messenger-&gt;im($row['user_jabber'], $row['username']);
-
-					$messenger-&gt;assign_vars(array(
-						'USERNAME'		=&gt; $row['username'],
-						'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-
-						'U_ACTIVATE'	=&gt; generate_link(&quot;Control_Panel&amp;mode=activate&amp;u={$row['user_id']}&amp;k={$row['user_actkey']}&quot;, array('full' =&gt; true, 'sid' =&gt; false)))
-					);
-
-					$messenger-&gt;send($row['user_notify_type']);
-				}
-				$_CLASS['core_db']-&gt;sql_freeresult($result);
-			}
-
-			meta_refresh(3, generate_link());
-
-			$message = $_CLASS['core_user']-&gt;lang['ACTIVATION_EMAIL_SENT'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;' . generate_link() . '&quot;&gt;', '&lt;/a&gt;');
-			trigger_error($message);
-		}
-		else
-		{
-			$username = $email = '';
-		}
-		
-		$_CLASS['core_template']-&gt;assign(array(
-			'USERNAME'	=&gt; $username,
-			'EMAIL'		=&gt; $email)
-		);
-		
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_RESEND'], 'ucp_resend.html');
-	}
-}
-
-?&gt;

Modified: trunk/modules/Forums/download.php
===================================================================
--- trunk/modules/Forums/download.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/download.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -46,15 +46,15 @@
 }
 
 $sql = 'SELECT attach_id, in_message, post_msg_id, extension
-	FROM ' . ATTACHMENTS_TABLE . &quot;
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 	WHERE attach_id = $download_id&quot;;
-$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, 1);
+$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 
-if (!($attachment = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
+if (!($attachment = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
 {
 	trigger_error('ERROR_NO_ATTACHMENT');
 }
-$_CLASS['core_db']-&gt;sql_freeresult($result);
+$_CLASS['core_db']-&gt;free_result($result);
 
 if ((!$attachment['in_message'] &amp;&amp; !$config['allow_attachments']) || ($attachment['in_message'] &amp;&amp; !$config['allow_pm_attach']))
 {
@@ -64,14 +64,13 @@
 $row = array();
 if (!$attachment['in_message'])
 {
-	// 
 	$sql = 'SELECT p.forum_id, f.forum_password, f.parent_id
-		FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
 		WHERE p.post_id = ' . $attachment['post_msg_id'] . '
 			AND p.forum_id = f.forum_id';
-	$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, 1);
-	$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
+	$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
 	if ($_CLASS['auth']-&gt;acl_gets('f_download', 'u_download', $row['forum_id']))
 	{
@@ -83,7 +82,7 @@
 	}
 	else
 	{
-		trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		//trigger_error('SORRY_AUTH_VIEW_ATTACH');
 	}
 }
 else
@@ -111,15 +110,15 @@
 
 // Fetching filename here to prevent sniffing of filename
 $sql = 'SELECT attach_id, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype
-	FROM ' . ATTACHMENTS_TABLE . &quot;
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 	WHERE attach_id = $download_id&quot;;
-$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, 1);
+$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 
-if (!($attachment = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
+if (!($attachment = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
 {
 	trigger_error('ERROR_NO_ATTACHMENT');
 }
-$_CLASS['core_db']-&gt;sql_freeresult($result);
+$_CLASS['core_db']-&gt;free_result($result);
 
 $attachment['physical_filename'] = basename($attachment['physical_filename']);
 
@@ -131,7 +130,7 @@
 else
 {
 	// Update download count
-	$sql = 'UPDATE ' . ATTACHMENTS_TABLE . ' 
+	$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
 		SET download_count = download_count + 1 
 		WHERE attach_id = ' . $attachment['attach_id'];
 	$_CLASS['core_db']-&gt;sql_query($sql);
@@ -297,7 +296,7 @@
 			FROM ' . SITELIST_TABLE;
 		$result = $_CLASS['core_db']-&gt;sql_query($sql);
 
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
 			$site_ip = trim($row['site_ip']);
 			$site_hostname = trim($row['site_hostname']);
@@ -338,7 +337,7 @@
 			}
 		}
 
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 	
 	return $allowed;

Modified: trunk/modules/Forums/faq.php
===================================================================
--- trunk/modules/Forums/faq.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/faq.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -120,8 +120,8 @@
 	'L_BACK_TO_TOP'			=&gt; $_CLASS['core_user']-&gt;lang['BACK_TO_TOP'],
 	'L_JUMP_TO'				=&gt; $_CLASS['core_user']-&gt;lang['JUMP_TO'],
 	'L_GO'					=&gt; $_CLASS['core_user']-&gt;lang['GO'],
-	'S_BACK_TO_TOP'			=&gt; generate_link('Forums&amp;file=faq'.$link.'#Top'))
-);
+	'S_BACK_TO_TOP'			=&gt; generate_link('Forums&amp;file=faq'.$link.'#Top')
+));
 
 
 $_CLASS['core_template']-&gt;assign('DISPLAY_STYLESHEET_LINK', ($mode == 'bbcode'));

Modified: trunk/modules/Forums/main.php
===================================================================
--- trunk/modules/Forums/main.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/main.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -81,7 +81,7 @@
 $l_total_topic_s = ($config['num_topics'] == 0) ? 'TOTAL_TOPICS_ZERO' : 'TOTAL_TOPICS_OTHER';
 
 // Assign index specific vars
-$_CLASS['core_template']-&gt;assign(array(
+$_CLASS['core_template']-&gt;assign_array(array(
 	'TOTAL_POSTS'	=&gt; sprintf($_CLASS['core_user']-&gt;get_lang($l_total_post_s), $config['num_posts']),
 	'TOTAL_TOPICS'	=&gt; sprintf($_CLASS['core_user']-&gt;get_lang($l_total_topic_s), $config['num_topics']),
 	'TOTAL_USERS'	=&gt; sprintf($_CLASS['core_user']-&gt;get_lang($l_total_user_s), $config['num_users']),

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/posting.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -52,7 +52,7 @@
 		}
 
 		$sql = 'SELECT *
-			FROM ' . FORUMS_TABLE . &quot;
+			FROM ' . FORUMS_FORUMS_TABLE . &quot;
 			WHERE forum_id = $forum_id&quot;;
 		break;
 
@@ -64,7 +64,7 @@
 		}
 
 		$sql = 'SELECT t.*, f.* 
-			FROM ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . &quot; f
+			FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . &quot; f
 			WHERE t.topic_id = $topic_id
 				AND f.forum_id = t.forum_id&quot;;
 	break;
@@ -78,7 +78,7 @@
 		}
 
 		$sql = 'SELECT f.*, t.*, p.*, u.username, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield
-			FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f, ' . USERS_TABLE . &quot; u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_USERS_TABLE . &quot; u
 			WHERE p.post_id = $post_id
 				AND t.topic_id = p.topic_id
 				AND u.user_id = p.poster_id
@@ -166,7 +166,7 @@
 if ($poll_start)
 {
 	$sql = 'SELECT poll_option_text 
-		FROM ' . POLL_OPTIONS_TABLE . &quot;
+		FROM ' . FORUMS_POLL_OPTIONS_TABLE . &quot;
 		WHERE topic_id = $topic_id
 		ORDER BY poll_option_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -203,7 +203,7 @@
 if ($post_attachment &amp;&amp; !$submit &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; $mode == 'edit')
 {
 	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
-		FROM ' . ATTACHMENTS_TABLE . &quot;
+		FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
 		ORDER BY filetime &quot; . ((!$config['display_order']) ? 'DESC' : 'ASC');
@@ -240,7 +240,7 @@
 if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $mode != 'delete')
 {
 	$sql = 'SELECT draft_id
-		FROM ' . DRAFTS_TABLE . '
+		FROM ' . FORUMS_DRAFTS_TABLE . '
 		WHERE (forum_id = ' . $forum_id . (($topic_id) ? &quot; OR topic_id = $topic_id&quot; : '') . ')
 			AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . 
 			(($draft_id) ? &quot; AND draft_id &lt;&gt; $draft_id&quot; : '');
@@ -400,18 +400,18 @@
 {
 	$_CLASS['core_db']-&gt;transaction();
 
-	$_CLASS['core_db']-&gt;query('UPDATE ' . POSTS_TABLE . &quot;
+	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . &quot;
 		SET post_time = $current_time
 		WHERE post_id = $topic_last_post_id
 			AND topic_id = $topic_id&quot;);
 
-	$_CLASS['core_db']-&gt;query('UPDATE ' . TOPICS_TABLE . &quot;
+	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . &quot;
 		SET topic_last_post_time = $current_time,
 			topic_bumped = 1,
 			topic_bumper = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 		WHERE topic_id = $topic_id&quot;);
 
-	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TABLE . '
+	$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_FORUMS_TABLE . '
 		SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . &quot;
 		WHERE forum_id = $forum_id&quot;);
 
@@ -445,7 +445,7 @@
 
 	if ($subject &amp;&amp; $message)
 	{
-		$sql = 'INSERT INTO ' . DRAFTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
 			'user_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
 			'topic_id'	=&gt; $topic_id,
 			'forum_id'	=&gt; $forum_id,
@@ -470,7 +470,7 @@
 }
 
 // Move to where they should be
-$_CLASS['core_template']-&gt;assign(array(
+$_CLASS['core_template']-&gt;assign_array(array(
 		'S_DRAFT_LOADED'	=&gt; false,
 		'S_SHOW_DRAFTS'		=&gt; false,
 		'S_POST_REVIEW'		=&gt; false,
@@ -487,7 +487,7 @@
 if ($draft_id &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['auth']-&gt;acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_subject, draft_message 
-		FROM ' . DRAFTS_TABLE . &quot; 
+		FROM ' . FORUMS_DRAFTS_TABLE . &quot; 
 		WHERE draft_id = $draft_id
 			AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
 	$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -758,7 +758,7 @@
 		if ($topic_type != POST_GLOBAL)
 		{
 			$sql = 'SELECT topic_type, forum_id
-				FROM ' . TOPICS_TABLE . &quot;
+				FROM ' . FORUMS_TOPICS_TABLE . &quot;
 				WHERE topic_id = $topic_id&quot;;
 			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 
@@ -770,7 +770,7 @@
 	
 				if (!$to_forum_id)
 				{
-					$_CLASS['core_template']-&gt;assign(array(
+					$_CLASS['core_template']-&gt;assign_array(array(
 						'S_FORUM_SELECT'	=&gt; make_forum_select(false, false, false, true, true),
 						'S_UNGLOBALISE'		=&gt; true) 
 					);
@@ -906,7 +906,7 @@
 
 		$parse_poll-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
 		
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'S_HAS_POLL_OPTIONS'=&gt; (sizeof($poll_options)),
 			'S_IS_MULTI_CHOICE'	=&gt; ($poll_max_options &gt; 1) ? true : false,
 
@@ -954,7 +954,7 @@
 
 	if (!sizeof($error))
 	{
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'PREVIEW_SUBJECT'		=&gt; $preview_subject,
 			'PREVIEW_MESSAGE'		=&gt; $preview_message,
 			'PREVIEW_SIGNATURE'		=&gt; $preview_signature,
@@ -1085,7 +1085,7 @@
 $form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']-&gt;acl_gets('f_attach', 'u_attach', $forum_id)) ? '' : ' enctype=&quot;multipart/form-data&quot;';
 
 // Start assigning vars for main posting page ...
-$_CLASS['core_template']-&gt;assign(array(
+$_CLASS['core_template']-&gt;assign_array(array(
 	'L_POST_A'				=&gt; $page_title,
 	'L_ICON'				=&gt; ($mode == 'reply' || $mode == 'quote') ? $_CLASS['core_user']-&gt;lang['POST_ICON'] : $_CLASS['core_user']-&gt;lang['TOPIC_ICON'], 
 	'L_MESSAGE_BODY_EXPLAIN'=&gt; (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']-&gt;lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',
@@ -1144,7 +1144,7 @@
 if (($mode == 'post' || ($mode == 'edit' &amp;&amp; $post_id == $topic_first_post_id &amp;&amp; (!$poll_last_vote || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id))))
 	&amp;&amp; $_CLASS['auth']-&gt;acl_get('f_poll', $forum_id))
 {
-	$_CLASS['core_template']-&gt;assign(array(
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_SHOW_POLL_BOX'		=&gt; true,
 		'S_POLL_VOTE_CHANGE'    =&gt; ($_CLASS['auth']-&gt;acl_get('f_votechg', $forum_id)),
 		'S_POLL_DELETE'			=&gt; ($mode == 'edit' &amp;&amp; $poll_options &amp;&amp; ((!$poll_last_vote &amp;&amp; $poster_id == $_CLASS['core_user']-&gt;data['user_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id)) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id))),
@@ -1159,7 +1159,7 @@
 }
 else
 {
-	$_CLASS['core_template']-&gt;assign(array(
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_SHOW_POLL_BOX'		=&gt; false,
 		'S_POLL_DELETE'			=&gt; false,
 	));
@@ -1372,7 +1372,7 @@
 	{
 		case 'post':
 		case 'reply':
-			$sql_data[POSTS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 				'forum_id' 			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'poster_id' 		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
 				'icon_id'			=&gt; $data['icon_id'],
@@ -1399,11 +1399,11 @@
 		case 'edit':
 			if (!$_CLASS['auth']-&gt;acl_gets('m_', 'a_') || $data['post_edit_reason'])
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array(
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 					'post_edit_time'	=&gt; $current_time
 				);
 
-				$sql_data[POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
 			}
 
 		case 'edit_last_post':
@@ -1411,19 +1411,19 @@
 
 			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') &amp;&amp; $data['post_edit_reason'])
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array(
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
 					'post_edit_time'	=&gt; $current_time
 				);
 
-				$sql_data[POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
 			}
 
-			if (!isset($sql_data[POSTS_TABLE]['sql']))
+			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
 			{
-				$sql_data[POSTS_TABLE]['sql'] = array();
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
 			}
 
-			$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
 				'forum_id' 			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'poster_id' 		=&gt; $data['poster_id'],
 				'icon_id'			=&gt; $data['icon_id'],
@@ -1446,7 +1446,7 @@
 
 			if ($update_message)
 			{
-				$sql_data[POSTS_TABLE]['sql']['post_text'] = $data['message'];
+				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
 			}
 
 			break;
@@ -1456,7 +1456,7 @@
 	switch ($post_mode)
 	{
 		case 'post':
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_poster'		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
 				'topic_time'		=&gt; $current_time,
 				'forum_id' 			=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
@@ -1471,7 +1471,7 @@
 
 			if (isset($poll['poll_options']) &amp;&amp; !empty($poll['poll_options']))
 			{
-				$sql_data[TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
+				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
 					'poll_title'		=&gt; $poll['poll_title'],
 					'poll_start'		=&gt; ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
 					'poll_max_options'	=&gt; $poll['poll_max_options'],
@@ -1486,27 +1486,27 @@
 			{
 				if (!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve'))
 				{
-					$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
 				}
-				$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
 			}
 			
 			break;
 
 		case 'reply':
-			$sql_data[TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
 			$sql_data[USERS_TABLE]['stat'][] = &quot;user_last_post_time = $current_time&quot; . (($_CLASS['auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
 			
 			if ((!$_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']-&gt;acl_get('m_approve')) &amp;&amp; $topic_type != POST_GLOBAL)
 			{
-				$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
 			}
 			break;
 
 		case 'edit_topic':
 		case 'edit_first_post':
 
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'forum_id' 					=&gt; ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
 				'icon_id'					=&gt; $data['icon_id'],
 				'topic_approved'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_moderate', $data['forum_id']) &amp;&amp; !$_CLASS['auth']-&gt;acl_get('m_approve')) ? 0 : 1,
@@ -1529,16 +1529,16 @@
 	// Submit new topic
 	if ($post_mode == 'post')
 	{
-		$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' .
-			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[TOPICS_TABLE]['sql']);
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
+			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
 		$_CLASS['core_db']-&gt;query($sql);
 
-		$data['topic_id'] = $_CLASS['core_db']-&gt;insert_id(TOPICS_TABLE, 'topic_id');
+		$data['topic_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
 
-		$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 			'topic_id' =&gt; $data['topic_id'])
 		);
-		unset($sql_data[TOPICS_TABLE]['sql']);
+		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
 	}
 
 	// Submit new post
@@ -1546,19 +1546,19 @@
 	{
 		if ($post_mode == 'reply')
 		{
-			$sql_data[POSTS_TABLE]['sql'] = array_merge($sql_data[POSTS_TABLE]['sql'], array(
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 				'topic_id' =&gt; $data['topic_id'])
 			);
 		}
 
-		$sql = 'INSERT INTO ' . POSTS_TABLE . ' ' .
-			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[POSTS_TABLE]['sql']);
+		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .
+			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
 		$_CLASS['core_db']-&gt;query($sql);
-		$data['post_id'] = $_CLASS['core_db']-&gt;insert_id(POSTS_TABLE, 'post_id');
+		$data['post_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
 		if ($post_mode == 'post')
 		{
-			$sql_data[TOPICS_TABLE]['sql'] = array(
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_first_post_id' =&gt; $data['post_id'],
 				'topic_last_post_id' =&gt; $data['post_id'],
 				'topic_last_post_time' =&gt; $current_time,
@@ -1567,7 +1567,7 @@
 			);
 		}
 
-		unset($sql_data[POSTS_TABLE]['sql']);
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
 	}
 
 	$make_global = false;
@@ -1576,7 +1576,7 @@
 	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
 	{
 		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_id = ' . $data['topic_id'];
 		$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -1588,10 +1588,10 @@
 		{
 			// Decrement topic/post count
 			$make_global = true;
-			$sql_data[FORUMS_TABLE]['stat'] = array();
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
 
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
 
 			// Update forum_ids for all posts
 			$sql = 'UPDATE ' . POSTS_TABLE . '
@@ -1604,13 +1604,13 @@
 		{
 			// Increment topic/post count
 			$make_global = true;
-			$sql_data[FORUMS_TABLE]['stat'] = array();
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
 
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
 
 			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . POSTS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET forum_id = ' . $data['forum_id'] . '
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']-&gt;query($sql);
@@ -1618,18 +1618,18 @@
 	}
 
 	// Update the topics table
-	if (isset($sql_data[TOPICS_TABLE]['sql']))
+	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
 	{
-		$_CLASS['core_db']-&gt;query('UPDATE ' . TOPICS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[TOPICS_TABLE]['sql']) . '
+		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . '
+			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
 			WHERE topic_id = ' . $data['topic_id']);
 	}
 
 	// Update the posts table
-	if (isset($sql_data[POSTS_TABLE]['sql']))
+	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
 	{
-		$_CLASS['core_db']-&gt;query('UPDATE ' . POSTS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[POSTS_TABLE]['sql']) . '
+		$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . '
+			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']) . '
 			WHERE post_id = ' . $data['post_id']);
 	}
 
@@ -1640,7 +1640,7 @@
 
 		if ($poll['poll_start'] &amp;&amp; $mode == 'edit')
 		{
-			$sql = 'SELECT * FROM ' . POLL_OPTIONS_TABLE . '
+			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
 				WHERE topic_id = ' . $data['topic_id'] . '
 				ORDER BY poll_option_id';
 			$result = $_CLASS['core_db']-&gt;query($sql);
@@ -1656,13 +1656,13 @@
 			{
 				if (!$cur_poll_options[$i])
 				{
-					$sql = 'INSERT INTO ' . POLL_OPTIONS_TABLE . &quot;  (poll_option_id, topic_id, poll_option_text)
+					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . &quot;  (poll_option_id, topic_id, poll_option_text)
 						VALUES ($i, &quot; . $data['topic_id'] . &quot;, '&quot; . $_CLASS['core_db']-&gt;sql_escape($poll['poll_options'][$i]) . &quot;')&quot;;
 					$_CLASS['core_db']-&gt;query($sql);
 				}
 				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
 				{
-					$sql = &quot;UPDATE &quot; . POLL_OPTIONS_TABLE . &quot;
+					$sql = &quot;UPDATE &quot; . FORUMS_POLL_OPTIONS_TABLE . &quot;
 						SET poll_option_text = '&quot; . $_CLASS['core_db']-&gt;sql_escape($poll['poll_options'][$i]) . &quot;'
 						WHERE poll_option_id = &quot; . $cur_poll_options[$i]['poll_option_id'] . &quot;
 							AND topic_id = &quot; . $data['topic_id'];
@@ -1673,7 +1673,7 @@
 
 		if (sizeof($poll['poll_options']) &lt; sizeof($cur_poll_options))
 		{
-			$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
 				WHERE poll_option_id &gt;= ' . sizeof($poll['poll_options']) . '
 					AND topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']-&gt;query($sql);
@@ -1690,7 +1690,7 @@
 			if ($attach_row['attach_id'])
 			{
 				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . ATTACHMENTS_TABLE . &quot;
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 					SET comment = '&quot; . $_CLASS['core_db']-&gt;sql_escape($attach_row['comment']) . &quot;'
 					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
 				$_CLASS['core_db']-&gt;query($sql);
@@ -1718,7 +1718,7 @@
 					'thumbnail'			=&gt; $attach_row['thumbnail']
 				);
 
-				$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' .
+				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
 					$_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql);
 				$_CLASS['core_db']-&gt;query($sql);
 
@@ -1729,12 +1729,12 @@
 
 		if (sizeof($data['attachment_data']))
 		{
-			$sql = 'UPDATE ' . POSTS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET post_attachment = 1
 				WHERE post_id = ' . $data['post_id'];
 			$_CLASS['core_db']-&gt;query($sql);
 
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 				SET topic_attachment = 1
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']-&gt;query($sql);
@@ -1750,19 +1750,19 @@
 	{
 		if ($topic_type != POST_GLOBAL)
 		{
-			$sql_data[FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
 		}
 
 		$update = update_last_post_information('topic', $data['topic_id']);
 		if (sizeof($update))
 		{
-			$sql_data[TOPICS_TABLE]['stat'][] = implode(', ', $update);
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
 	}
 
 	if ($make_global)
 	{
-		$sql_data[FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
+		$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
 	}
 
 	if ($post_mode == 'edit_topic')
@@ -1770,7 +1770,7 @@
 		$update = update_last_post_information('topic', $data['topic_id']);
 		if (sizeof($update))
 		{
-			$sql_data[TOPICS_TABLE]['stat'][] = implode(', ', $update);
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
 	}
 
@@ -1792,7 +1792,7 @@
 	// Update forum stats
 	$_CLASS['core_db']-&gt;transaction();
 
-	$where_sql = array(POSTS_TABLE =&gt; 'post_id = ' . $data['post_id'], TOPICS_TABLE =&gt; 'topic_id = ' . $data['topic_id'], FORUMS_TABLE =&gt; 'forum_id = ' . $data['forum_id'], USERS_TABLE =&gt; 'user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
+	$where_sql = array(FORUMS_POSTS_TABLE =&gt; 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE =&gt; 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE =&gt; 'forum_id = ' . $data['forum_id'], USERS_TABLE =&gt; 'user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
 
 	foreach ($sql_data as $table =&gt; $update_ary)
 	{
@@ -1805,7 +1805,7 @@
 	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
 	if ($make_global)
 	{
-		$_CLASS['core_db']-&gt;query('DELETE FROM ' . TOPICS_TABLE . '
+		$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_moved_id = ' . $data['topic_id']);
 	}
 
@@ -1828,13 +1828,13 @@
 	// Topic Notification
 	if (!$data['notify_set'] &amp;&amp; $data['notify'])
 	{
-		$sql = 'INSERT INTO ' . TOPICS_WATCH_TABLE . ' (user_id, topic_id)
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_WATCH_TABLE . ' (user_id, topic_id)
 			VALUES (' . $_CLASS['core_user']-&gt;data['user_id'] . ', ' . $data['topic_id'] . ')';
 		$_CLASS['core_db']-&gt;query($sql);
 	}
 	else if ($data['notify_set'] &amp;&amp; !$data['notify'])
 	{
-		$sql = 'DELETE FROM ' . TOPICS_WATCH_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 				AND topic_id = ' . $data['topic_id'];
 		$_CLASS['core_db']-&gt;query($sql);

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/viewforum.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -50,7 +50,7 @@
 if (!$_CLASS['core_user']-&gt;is_user)
 {
 	$sql = 'SELECT *
-		FROM ' . FORUMS_TABLE . '
+		FROM ' . FORUMS_FORUMS_TABLE . '
 		WHERE forum_id = ' . $forum_id .'
 		AND forum_status &lt;&gt; '.ITEM_DELETING;
 }
@@ -69,7 +69,7 @@
 		}
 
 		$sql = &quot;SELECT f.*, fw.notify_status $lastread_select 
-			FROM &quot; . FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;) $sql_lastread
+			FROM &quot; . FORUMS_FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;) $sql_lastread
 			WHERE f.forum_id = $forum_id&quot;;
 }
 
@@ -99,7 +99,7 @@
 	// Does it have click tracking enabled?
 	if ($forum_data['forum_flags'] &amp; 1)
 	{
-		$sql = 'UPDATE ' . FORUMS_TABLE . '
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET forum_posts = forum_posts + 1 
 			WHERE forum_id = ' . $forum_id;
 		$_CLASS['core_db']-&gt;query($sql);
@@ -202,7 +202,7 @@
 		$min_post_time = time() - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(topic_id) AS num_topics
-			FROM ' . TOPICS_TABLE . &quot;
+			FROM ' . FORUMS_TOPICS_TABLE . &quot;
 			WHERE forum_id = $forum_id
 				AND topic_type &lt;&gt; &quot; . POST_ANNOUNCE . &quot;  
 				AND topic_last_post_time &gt;= $min_post_time
@@ -232,12 +232,14 @@
 
 	// Basic pagewide vars
 	$post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']-&gt;lang['FORUM_LOCKED'] : $_CLASS['core_user']-&gt;lang['POST_NEW_TOPIC'];
+	$pagination = generate_pagination(&quot;Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&quot;, $topics_count, $config['topics_per_page'], $start);
 
-	$_CLASS['core_template']-&gt;assign(array(
-		'PAGINATION'	=&gt; generate_pagination(generate_link(&quot;Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&quot;), $topics_count, $config['topics_per_page'], $start),
-		'PAGE_NUMBER'	=&gt; on_page($topics_count, $config['topics_per_page'], $start),
-		'TOTAL_TOPICS'	=&gt; ($forum_data['forum_flags'] &amp; 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPICS'], $topics_count)),
-		'MODERATORS'	=&gt; (!empty($moderators[$forum_id])) ? implode(', ', $moderators[$forum_id]) : '',
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'PAGINATION'		=&gt; $pagination['formated'],
+		'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+		'PAGE_NUMBER'		=&gt; on_page($topics_count, $config['topics_per_page'], $start),
+		'TOTAL_TOPICS'		=&gt; ($forum_data['forum_flags'] &amp; 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPICS'], $topics_count)),
+		'MODERATORS'		=&gt; (!empty($moderators[$forum_id])) ? implode(', ', $moderators[$forum_id]) : '',
 
 		'POST_IMG' 				=&gt; ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']-&gt;img('btn_locked', $post_alt) : $_CLASS['core_user']-&gt;img('btn_post', $post_alt),
 		'FOLDER_IMG' 			=&gt; $_CLASS['core_user']-&gt;img('folder', 'NO_NEW_POSTS'),
@@ -276,13 +278,12 @@
 	);
 
 	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	// Grab all topic data
 	$rowset = $announcement_list = $topic_list = array();
 
-	$sql_from = TOPICS_TABLE.' t ';
+	$sql_from = FORUMS_TOPICS_TABLE.' t ';
 	$sql_from .= ($_CLASS['core_user']-&gt;is_user &amp;&amp; $config['load_db_lastread']) ? ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')' : '';
 
 	$sql_approved = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1';
@@ -421,6 +422,8 @@
 			// Generate all the URIs ...
 			$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
 
+			$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
+
 			// Send vars to template
 			$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
 				'FORUM_ID' 			=&gt; $forum_id,
@@ -430,7 +433,8 @@
 				'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
 				'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
 				'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
-				'PAGINATION'		=&gt; topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id),
+				'PAGINATION'		=&gt; $pagination['formated'],
+				'PAGINATION_ARRAY'	=&gt; $pagination['array'],
 				'REPLIES' 			=&gt; $replies,
 				'VIEWS' 			=&gt; $row['topic_views'],
 				'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
@@ -471,7 +475,7 @@
 }
 else
 {
-	$_CLASS['core_template']-&gt;assign(array(
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_IS_POSTABLE'			=&gt; false,
 		'S_DISPLAY_ACTIVE'		=&gt; false,
 		'S_DISPLAY_SEARCHBOX'	=&gt; false,

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Forums/viewtopic.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,15 +1,23 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
 
 // -------------------------------------------------------------
 //
@@ -17,7 +25,7 @@
 //
 // FILENAME  : viewtopic.php 
 // STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -55,12 +63,12 @@
 
 if ($topic_id)
 {
-	$sql = 'SELECT forum_id FROM ' . TOPICS_TABLE . '
+	$sql = 'SELECT forum_id, topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
 		WHERE topic_id = '.$topic_id;
 }
 else
 {
-	$sql = 'SELECT forum_id, topic_id FROM ' . POSTS_TABLE . '
+	$sql = 'SELECT forum_id, topic_id FROM ' . FORUMS_POSTS_TABLE . '
 		WHERE post_id = '.$post_id;
 }
 
@@ -68,17 +76,15 @@
 $row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 $_CLASS['core_db']-&gt;free_result($result);
 
-if ($row)
+if (!$row)
 {
-	$forum_id = $row['forum_id'];
-	$topic_id = ($topic_id) ? $topic_id : $row['topic_id'];
-}
-else
-{
 	trigger_error('NO_TOPIC');
 }
 
-/*
+$forum_id = $row['forum_id'];
+$topic_id = ($topic_id) ? $topic_id : $row['topic_id'];
+$topic_last_post_time = isset($row['topic_last_post_time']) ? $row['topic_last_post_time'] : false;
+
 if ($view)
 {
 	if ($view == 'unread')
@@ -101,8 +107,8 @@
 			// Setup user environment so we can process lang string
 			$_CLASS['core_user']-&gt;add_lang('viewtopic');
 
-			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;));
-			$message = $_CLASS['core_user']-&gt;lang['NO_UNREAD_POSTS'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
+			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;));
+			$message = $_CLASS['core_user']-&gt;lang['NO_UNREAD_POSTS'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
 			trigger_error($message);
 		}
 
@@ -111,16 +117,34 @@
 	}
 	elseif ($view == 'next' || $view == 'previous')
 	{
-		$sql_condition = ($view == 'next') ? '&gt;' : '&lt;';
-		$sql_ordering = ($view == 'next') ? 'ASC' : 'DESC';
+		if ($view == 'next')
+		{
+			$sql_condition = '&gt;';
+			$sql_ordering = 'ASC';
+		}
+		else
+		{
+			$sql_condition = '&lt;';
+			$sql_ordering = 'DESC';
+		}
 
-		$sql = 'SELECT t.topic_id, t.forum_id
-			FROM ' . TOPICS_TABLE . ' t, ' . TOPICS_TABLE . &quot; t2
-			WHERE t2.topic_id = $topic_id
-				AND t.forum_id = t2.forum_id
-				&quot; . (($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . &quot;
-				AND t.topic_last_post_time $sql_condition t2.topic_last_post_time
-			ORDER BY t.topic_last_post_time $sql_ordering&quot;;
+		if (!$topic_last_post_time)
+		{
+			$sql = 'SELECT topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . '
+						WHERE topic_id = '.$topic_id;
+
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			list($topic_last_post_time) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+// should we only find the next topic with in the forum ?
+		$sql = 'SELECT topic_id, forum_id
+			FROM ' . FORUMS_TOPICS_TABLE . &quot;
+			 WHERE forum_id = $forum_id AND topic_last_post_time $sql_condition $topic_last_post_time&quot;
+			 . ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . &quot;
+			ORDER BY topic_last_post_time $sql_ordering&quot;;
+	
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
@@ -133,19 +157,10 @@
 		else
 		{
 			$topic_id = $row['topic_id'];
-	
-			// Check for global announcement correctness?
-			if (!$row['forum_id'] &amp;&amp; !$forum_id)
-			{
-				trigger_error('NO_TOPIC');
-			}
-			else if ($row['forum_id'])
-			{
-				$forum_id = $row['forum_id'];
-			}
+			$forum_id = $row['forum_id'];
 		}
 	}
-}*/
+}
 
 /*
 if (!$post_id)
@@ -175,7 +190,7 @@
 	if ($config['allow_bookmarks'])
 	{
 		$extra_fields .= ', bm.order_id as bookmarked';
-		$join_sql_table .= ' LEFT JOIN ' . BOOKMARKS_TABLE . ' bm ON (bm.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+		$join_sql_table .= ' LEFT JOIN ' . FORUMS_BOOKMARKS_TABLE . ' bm ON (bm.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 			AND t.topic_id = bm.topic_id)';
 	}
 }
@@ -187,7 +202,7 @@
 	f.forum_name, f.forum_desc, f.forum_parents, f.parent_id, f.left_id, f.right_id, f.forum_status, f.forum_type,
 	f.forum_id, f.forum_password, f.forum_rules, f.forum_rules_link, f.forum_rules_flags, f.forum_rules_bbcode_uid,
 	f.forum_rules_bbcode_bitfield' . $extra_fields . '
-		FROM ' . FORUMS_TABLE . ' f, ' . TOPICS_TABLE . &quot; t  $join_sql_table 
+		FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . &quot; t  $join_sql_table 
 		WHERE t.topic_id = $topic_id&quot;;
 
 $result = $_CLASS['core_db']-&gt;query($sql);
@@ -220,11 +235,11 @@
 {
 	if (!$topic_data['bookmarked'])
 	{
-		$sql = 'INSERT INTO ' . BOOKMARKS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+		$sql = 'INSERT INTO ' . FORUMS_BOOKMARKS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
 			'user_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
 			'topic_id'	=&gt; $topic_id,
-			'order_id'	=&gt; 0)
-		);
+			'order_id'	=&gt; 0
+		));
 		$_CLASS['core_db']-&gt;query($sql);
 
 		$where_sql = '';
@@ -232,7 +247,7 @@
 	}
 	else
 	{
-		$sql = 'DELETE FROM ' . BOOKMARKS_TABLE . ' 
+		$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . ' 
 			WHERE user_id = '.$_CLASS['core_user']-&gt;data['user_id'].'
 				AND order_id = '.$topic_data['bookmarked'];
 		$_CLASS['core_db']-&gt;query($sql);
@@ -243,15 +258,16 @@
 	}
 
 	// Re-Sort Bookmarks
-	$sql = 'UPDATE ' . BOOKMARKS_TABLE . &quot;
+	$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
 		SET order_id = order_id $sign 1
 			WHERE user_id = {$_CLASS['core_user']-&gt;data['user_id']}
 			$where_sql&quot;;
 	$_CLASS['core_db']-&gt;query($sql);
 
-	$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($viewtopic_url, false));
-	$message = (($topic_data['bookmarked']) ? $_CLASS['core_user']-&gt;lang['BOOKMARK_REMOVED'] : $_CLASS['core_user']-&gt;lang['BOOKMARK_ADDED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . generate_link($viewtopic_url, false) . '&quot;&gt;', '&lt;/a&gt;');
-	trigger_error($message);
+	$topic_data['bookmarked'] = ($topic_data['bookmarked']) ? false : true;
+//	$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($viewtopic_url, false));
+//	$message = (($topic_data['bookmarked']) ? $_CLASS['core_user']-&gt;lang['BOOKMARK_REMOVED'] : $_CLASS['core_user']-&gt;lang['BOOKMARK_ADDED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . generate_link($viewtopic_url, false) . '&quot;&gt;', '&lt;/a&gt;');
+//	trigger_error($message);
 }
 
 // We make this check here because the correct forum_id is determined
@@ -265,7 +281,7 @@
 // Check sticky/announcement time limit
 if (($topic_data['topic_type'] == POST_STICKY || $topic_data['topic_type'] == POST_ANNOUNCE) &amp;&amp; $topic_data['topic_time_limit'] &amp;&amp; $topic_data['topic_time'] + $topic_data['topic_time_limit'] &lt; $_CLASS['core_user']-&gt;time)
 {
-	$sql = 'UPDATE ' . TOPICS_TABLE . ' 
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 		SET topic_type = ' . POST_NORMAL . ', topic_time_limit = 0
 		WHERE topic_id = ' . $topic_id;
 
@@ -307,7 +323,7 @@
 	$min_post_time = time() - ($sort_days * 86400);
 
 	$sql = 'SELECT COUNT(post_id) AS num_posts
-		FROM ' . POSTS_TABLE . &quot;
+		FROM ' . FORUMS_POSTS_TABLE . &quot;
 		WHERE topic_id = $topic_id
 			AND post_time &gt;= $min_post_time
 		&quot; . (($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
@@ -383,17 +399,20 @@
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('f_announce', $forum_id) &amp;&amp; $topic_data['topic_type'] != POST_GLOBAL) ? '&lt;option value=&quot;make_global&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAKE_GLOBAL'] . '&lt;/option&gt;' : '';
 $topic_mod .= ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? '&lt;option value=&quot;viewlogs&quot;&gt;' . $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOGS'] . '&lt;/option&gt;' : '';
 
+$pagination = generate_pagination(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param&quot; . (($highlight_match) ? &quot;&amp;hilit=$highlight&quot; : ''), $total_posts, $config['posts_per_page'], $start);
+
 // Send vars to template
-$_CLASS['core_template']-&gt;assign(array(
+$_CLASS['core_template']-&gt;assign_array(array(
 	'FORUM_ID' 		=&gt; $forum_id,
 	'FORUM_NAME' 	=&gt; $topic_data['forum_name'],
 	'FORUM_DESC'	=&gt; $topic_data['forum_desc'],
 	'TOPIC_ID' 		=&gt; $topic_id,
 	'TOPIC_TITLE' 	=&gt; censor_text($topic_data['topic_title']),
-	'PAGINATION' 	=&gt; generate_pagination(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;$u_sort_param&quot; . (($highlight_match) ? &quot;&amp;hilit=$highlight&quot; : ''), $total_posts, $config['posts_per_page'], $start),
+	'PAGINATION'		=&gt; $pagination['formated'],
+	'PAGINATION_ARRAY'	=&gt; $pagination['array'],
 	'PAGE_NUMBER' 	=&gt; on_page($total_posts, $config['posts_per_page'], $start),
 	'TOTAL_POSTS'	=&gt; ($total_posts == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_TOPIC_POSTS'], $total_posts), 
-	'U_MCP' 		=&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link(&quot;Forums&amp;file=mcp&amp;mode=topic_view&amp;f=$forum_id&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param&quot;, false, false) : '',
+	'U_MCP' 		=&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link(&quot;Forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param&quot;, false, false) : '',
 
 	'MODERATORS'	=&gt; (isset($forum_moderators[$forum_id]) &amp;&amp; sizeof($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
 
@@ -420,19 +439,19 @@
 	'S_SELECT_SORT_DIR' 	=&gt; $s_sort_dir,
 	'S_SELECT_SORT_KEY' 	=&gt; $s_sort_key,
 	'S_SELECT_SORT_DAYS' 	=&gt; $s_limit_days,
-	'S_TOPIC_ACTION' 		=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;start=$start&quot;),
+	'S_TOPIC_ACTION' 		=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start&quot;),
 	'S_TOPIC_MOD' 			=&gt; ($topic_mod != '') ? '&lt;select name=&quot;mode&quot;&gt;' . $topic_mod . '&lt;/select&gt;' : '',
-	'S_MOD_ACTION' 			=&gt; generate_link(&quot;Forums&amp;file=mcp&amp;t=$topic_id&amp;f=$forum_id&amp;quickmod=1&quot;, false, false), 
+	'S_MOD_ACTION' 			=&gt; generate_link(&quot;Forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1&quot;, false, false), 
 
 	'S_DISPLAY_SEARCHBOX'	=&gt; ($_CLASS['auth']-&gt;acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=&gt; generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_TOPIC'				=&gt; (!$view == 'print') ? generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;) : generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;, true, true),
-	'U_VIEW_UNREAD_POST'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread&quot;).'#unread',
+	'U_TOPIC'				=&gt; ($view == 'print') ? generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' =&gt; true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
+	'U_VIEW_UNREAD_POST'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread&quot;).'#unread',
 	'U_VIEW_TOPIC' 			=&gt; generate_link($viewtopic_url, false),
 	'U_VIEW_FORUM' 			=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
-	'U_VIEW_OLDER_TOPIC'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=previous&quot;),
-	'U_VIEW_NEWER_TOPIC'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=next&quot;),
+	'U_VIEW_OLDER_TOPIC'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous&quot;),
+	'U_VIEW_NEWER_TOPIC'	=&gt; generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next&quot;),
 	'U_PRINT_TOPIC'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print', false) : '',
 	'U_EMAIL_TOPIC'			=&gt; ($_CLASS['auth']-&gt;acl_get('f_email', $forum_id) &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
 
@@ -443,15 +462,15 @@
 	'L_BOOKMARK_TOPIC'		=&gt; ($_CLASS['core_user']-&gt;is_user &amp;&amp; $config['allow_bookmarks'] &amp;&amp; $topic_data['bookmarked']) ? $_CLASS['core_user']-&gt;lang['BOOKMARK_TOPIC_REMOVE'] : $_CLASS['core_user']-&gt;lang['BOOKMARK_TOPIC'],
 	
 	'U_POST_NEW_TOPIC' 		=&gt; generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
-	'U_POST_REPLY_TOPIC' 	=&gt; generate_link(&quot;Forums&amp;file=posting&amp;mode=reply&amp;f=$forum_id&amp;t=$topic_id&quot;),
-	'U_BUMP_TOPIC'			=&gt; (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=bump&amp;f=$forum_id&amp;t=$topic_id&quot;) : '')
+	'U_POST_REPLY_TOPIC' 	=&gt; generate_link(&quot;Forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id&quot;),
+	'U_BUMP_TOPIC'			=&gt; (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id&quot;) : '')
 );
 
 // Does this topic contain a poll?
 if (!empty($poll_start))
 {
 	$sql = 'SELECT o.*, p.bbcode_bitfield, p.bbcode_uid
-		FROM ' . POLL_OPTIONS_TABLE . ' o, ' . POSTS_TABLE . &quot; p
+		FROM ' . FORUMS_POLL_OPTIONS_TABLE . ' o, ' . FORUMS_POSTS_TABLE . &quot; p
 		WHERE o.topic_id = $topic_id 
 			AND p.post_id = $topic_first_post_id
 			AND p.topic_id = o.topic_id
@@ -469,7 +488,7 @@
 	if ($_CLASS['core_user']-&gt;is_user)
 	{
 		$sql = 'SELECT poll_option_id
-			FROM ' . POLL_VOTES_TABLE . '
+			FROM ' . FORUMS_POLL_VOTES_TABLE . '
 			WHERE topic_id = ' . $topic_id . '
 				AND vote_user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 		$result = $_CLASS['core_db']-&gt;query($sql);
@@ -503,10 +522,10 @@
 	{
 		if (!sizeof($voted_id) || sizeof($voted_id) &gt; $poll_max_options)
 		{
-			$_CLASS['core_display']-&gt;meta_refresh(5, generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;));
+			$_CLASS['core_display']-&gt;meta_refresh(5, generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;));
 
 			$message = (!sizeof($voted_id)) ? 'NO_VOTE_OPTION' : 'TOO_MANY_VOTE_OPTIONS';
-			$message = $_CLASS['core_user']-&gt;lang[$message] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
+			$message = $_CLASS['core_user']-&gt;lang[$message] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
 			trigger_error($message);
 		}
 
@@ -517,7 +536,7 @@
 				continue;
 			}
 
-			$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . &quot; 
+			$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . &quot; 
 				SET poll_option_total = poll_option_total + 1 
 				WHERE poll_option_id = $option 
 					AND topic_id = $topic_id&quot;;
@@ -525,7 +544,7 @@
 
 			if ($_CLASS['core_user']-&gt;is_user)
 			{
-				$sql = 'INSERT INTO  ' . POLL_VOTES_TABLE . &quot; (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
+				$sql = 'INSERT INTO  ' . FORUMS_POLL_VOTES_TABLE . &quot; (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
 					VALUES ($topic_id, $option, &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;')&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
 			}
@@ -535,7 +554,7 @@
 		{
 			if (!in_array($option, $voted_id))
 			{
-				$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . &quot; 
+				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . &quot; 
 					SET poll_option_total = poll_option_total - 1 
 					WHERE poll_option_id = $option 
 						AND topic_id = $topic_id&quot;;
@@ -543,7 +562,7 @@
 
 				if ($_CLASS['core_user']-&gt;is_user)
 				{
-					$sql = 'DELETE FROM ' . POLL_VOTES_TABLE . &quot; 
+					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . &quot; 
 						WHERE topic_id = $topic_id
 							AND poll_option_id = $option 
 							AND vote_user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
@@ -557,15 +576,15 @@
 			$_CLASS['core_user']-&gt;set_cookie('poll_' . $topic_id, implode(',', $voted_id), time() + 31536000);
 		}
 
-		$sql = 'UPDATE ' . TOPICS_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 			SET poll_last_vote = ' . time() . &quot; 
 			WHERE topic_id = $topic_id&quot;;
 			//, topic_last_post_time = ' . time() . &quot; -- for bumping topics with new votes, ignore for now
 		$_CLASS['core_db']-&gt;query($sql);
 
-		$_CLASS['core_display']-&gt;meta_refresh(5, generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;));
+		$_CLASS['core_display']-&gt;meta_refresh(5, generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;));
 
-		$message = $_CLASS['core_user']-&gt;lang['VOTE_SUBMITTED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
+		$message = $_CLASS['core_user']-&gt;lang['VOTE_SUBMITTED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;).'&quot;&gt;', '&lt;/a&gt;');
 		trigger_error($message);
 	}
 
@@ -611,7 +630,7 @@
 		);
 	}
 
-	$_CLASS['core_template']-&gt;assign(array(
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'POLL_QUESTION'		=&gt; $poll_title,
 		'TOTAL_VOTES' 		=&gt; $poll_total,
 		'POLL_LEFT_CAP_IMG'	=&gt; $_CLASS['core_user']-&gt;img('poll_left'),
@@ -667,7 +686,7 @@
 
 // Go ahead and pull all data for this topic
 $sql = 'SELECT p.post_id
-	FROM ' . POSTS_TABLE . ' p' . (($sort_by_sql[$sort_key]{0} == 'u') ? ', ' . USERS_TABLE . ' u': '') . &quot;
+	FROM ' . FORUMS_POSTS_TABLE . ' p' . (($sort_by_sql[$sort_key]{0} == 'u') ? ', ' . USERS_TABLE . ' u': '') . &quot;
 	WHERE p.topic_id = $topic_id
 		&quot; . ((!$_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? 'AND p.post_approved = 1' : '') . &quot;
 		&quot; . (($sort_by_sql[$sort_key]{0} == 'u') ? 'AND u.user_id = p.poster_id': '') . &quot;
@@ -691,7 +710,7 @@
 }
 
 $sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_regdate, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
-	FROM ' . POSTS_TABLE . ' p
+	FROM ' . FORUMS_POSTS_TABLE . ' p
 	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
 		AND u.user_id = p.poster_id';
@@ -900,10 +919,10 @@
 // Generate online information for user
 if ($config['load_onlinetrack'] &amp;&amp; sizeof($id_cache))
 {
-	$sql = 'SELECT session_user_id, session_viewonline, MAX(session_time) as online_time
+	$sql = 'SELECT session_user_id, session_hidden, MAX(session_time) as online_time
 		FROM ' . SESSIONS_TABLE . ' 
 		WHERE session_user_id IN (' . implode(', ', $id_cache) . ')
-		GROUP BY session_user_id, session_viewonline';
+		GROUP BY session_user_id, session_hidden';
 
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -911,7 +930,7 @@
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$user_cache[$row['session_user_id']]['online'] = (time() - $update_time &lt; $row['online_time'] &amp;&amp; ($row['session_viewonline'] || $_CLASS['auth']-&gt;acl_get('u_viewonline'))) ? true : false;
+		$user_cache[$row['session_user_id']]['online'] = (time() - $update_time &lt; $row['online_time'] &amp;&amp; (!$row['session_hidden']));
 	}
 }
 unset($id_cache);
@@ -924,7 +943,7 @@
 		include($site_file_root.'includes/forums/functions_display.php');
 
 		$sql = 'SELECT * 
-			FROM ' . ATTACHMENTS_TABLE . '
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE post_msg_id IN (' . implode(', ', $attach_list) . ')
 				AND in_message = 0
 			ORDER BY filetime ' . ((!$config['display_order']) ? 'DESC' : 'ASC') . ', post_msg_id ASC';
@@ -939,7 +958,7 @@
 		// No attachments exist, but post table thinks they do so go ahead and reset post_attach flags
 		if (!sizeof($attachments))
 		{
-			$sql = 'UPDATE ' . POSTS_TABLE . ' 
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0 
 				WHERE post_id IN (' . implode(', ', $attach_list) . ')';
 			$_CLASS['core_db']-&gt;query($sql);
@@ -949,7 +968,7 @@
 			{
 				// Not all posts are displayed so we query the db to find if there's any attachment for this topic
 				$sql = 'SELECT a.post_msg_id as post_id
-					FROM ' . ATTACHMENTS_TABLE . ' a, ' . POSTS_TABLE . &quot; p
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a, ' . POSTS_TABLE . &quot; p
 					WHERE p.topic_id = $topic_id
 						AND p.post_approved = 1
 						AND p.topic_id = a.topic_id&quot;;
@@ -957,7 +976,7 @@
 
 				if (!$_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
-					$sql = 'UPDATE ' . TOPICS_TABLE . &quot; 
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . &quot; 
 						SET topic_attachment = 0 
 						WHERE topic_id = $topic_id&quot;;
 					$_CLASS['core_db']-&gt;query($sql);
@@ -965,7 +984,7 @@
 			}
 			else
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . &quot; 
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . &quot; 
 					SET topic_attachment = 0 
 					WHERE topic_id = $topic_id&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
@@ -974,7 +993,7 @@
 		elseif ($has_attachments &amp;&amp; !$topic_data['topic_attachment'])
 		{
 			// Topic has approved attachments but its flag is wrong
-			$sql = 'UPDATE ' . TOPICS_TABLE . &quot; 
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . &quot; 
 				SET topic_attachment = 1 
 				WHERE topic_id = $topic_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
@@ -995,12 +1014,10 @@
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 
-$i_total = sizeof($rowset) - 1;
+$i_total = count($rowset) - 1;
 $prev_post_id = '';
 
-$_CLASS['core_template']-&gt;assign(array(
-	'S_NUM_POSTS' =&gt; sizeof($post_list))
-);
+$_CLASS['core_template']-&gt;assign('S_NUM_POSTS', count($post_list));
 
 // Output the posts
 //foreach ($rowset as $i =&gt; $row)
@@ -1014,7 +1031,7 @@
 	{
 		$_CLASS['core_template']-&gt;assign_vars_array('postrow', array(
 			'S_IGNORE_POST' =&gt; true, 
-			'L_IGNORE_POST' =&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_BY_FOE'], $row['poster'], '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['post_id'] . '&amp;view=show') . '#' . $row['post_id'] . '&quot;&gt;', '&lt;/a&gt;'))
+			'L_IGNORE_POST' =&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_BY_FOE'], $row['poster'], '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;p=&quot; . $row['post_id'] . '&amp;view=show') . '#' . $row['post_id'] . '&quot;&gt;', '&lt;/a&gt;'))
 		);
 
 		continue;
@@ -1092,7 +1109,7 @@
 			$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);
 
 			$sql = 'SELECT DISTINCT u.user_id, u.username, u.user_colour 
-				FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 				WHERE p.post_id IN (' . implode(', ', $post_storage_list) . &quot;)
 					AND p.post_edit_count &lt;&gt; 0
 					AND p.post_edit_user &lt;&gt; 0
@@ -1119,28 +1136,19 @@
 	}
 
 	// Bump information
-	if ($topic_data['topic_bumped'] &amp;&amp; $row['post_id'] == $topic_last_post_id)
+	if ($topic_data['topic_bumped'] &amp;&amp; $row['post_id'] == $topic_data['topic_last_post_id'])
 	{
 		// It is safe to grab the username from the user cache array, we are at the last 
 		// post and only the topic poster and last poster are allowed to bump
-		$l_bumped_by = '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['BUMPED_BY'], $user_cache[$topic_bumper]['username'], $_CLASS['core_user']-&gt;format_date($topic_data['topic_last_post_time']));
+		$l_bumped_by = '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['BUMPED_BY'], $user_cache[$topic_data['topic_bumper']]['username'], $_CLASS['core_user']-&gt;format_date($topic_data['topic_last_post_time']));
 	}
 	else
 	{
 		$l_bumped_by = '';
 	}
 
-	$cp_row = array();
-
-	if ($config['load_cpf_viewtopic'])
+	if (empty($icons[$row['icon_id']]))
 	{
-		$cp_row = (isset($profile_fields_cache[$poster_id])) ? $cp-&gt;generate_profile_fields_template('show', false, $profile_fields_cache[$poster_id]) : array();
-	}
-	
-	$can_rate = false;
-	
-	if (empty($row['icon_id']) || empty($icons[$row['icon_id']]))
-	{
 		$icons[$row['icon_id']] = array('img' =&gt; '' , 'width' =&gt; '', 'height' =&gt; '');
 	}
 
@@ -1187,10 +1195,10 @@
 
 		'ONLINE_IMG'		=&gt; ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $_CLASS['core_user']-&gt;img('btn_online', 'ONLINE') : $_CLASS['core_user']-&gt;img('btn_offline', 'OFFLINE')), 
 
-		'U_EDIT' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_edit', $forum_id) &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=edit&amp;f=$forum_id&amp;p=&quot; . $row['post_id']) : '',
-		'U_QUOTE' 			=&gt; ($_CLASS['auth']-&gt;acl_get('f_quote', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=quote&amp;f=$forum_id&amp;p=&quot; . $row['post_id']) : '', 
+		'U_EDIT' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_edit', $forum_id) &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_edit', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=edit&amp;p=&quot; . $row['post_id']) : '',
+		'U_QUOTE' 			=&gt; ($_CLASS['auth']-&gt;acl_get('f_quote', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=quote&amp;p=&quot; . $row['post_id']) : '', 
 		'U_INFO'            =&gt; ($_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
-		'U_DELETE' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $topic_data['topic_last_post_id'] == $row['post_id'] &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=delete&amp;f=$forum_id&amp;p=&quot; . $row['post_id']) : '',
+		'U_DELETE' 			=&gt; (($_CLASS['core_user']-&gt;data['user_id'] == $poster_id &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_delete', $forum_id) &amp;&amp; $topic_data['topic_last_post_id'] == $row['post_id'] &amp;&amp; ($row['post_time'] &gt; time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']-&gt;acl_get('m_delete', $forum_id)) ? generate_link(&quot;Forums&amp;file=posting&amp;mode=delete&amp;p=&quot; . $row['post_id']) : '',
 
 		'U_PROFILE' 		=&gt; $user_cache[$poster_id]['profile'],
 		'U_SEARCH' 			=&gt; $user_cache[$poster_id]['search'],
@@ -1219,25 +1227,11 @@
 		'S_FRIEND'			=&gt; ($row['friend']) ? true : false,
 		'S_UNREAD_POST'		=&gt; $unread,
 		'S_FIRST_UNREAD'	=&gt; ($unread_post_id == $row['post_id']) ? true : false,
-		'S_CUSTOM_FIELDS'	=&gt; (isset($cp_row['row']) &amp;&amp; sizeof($cp_row['row'])) ? true : false
 	);
 
-	if (isset($cp_row['row']) &amp;&amp; sizeof($cp_row['row']))
-	{
-		$postrow = array_merge($postrow, $cp_row['row']);
-	}
-	
 	// Dump vars into template
 	$_CLASS['core_template']-&gt;assign_vars_array('postrow', $postrow);
 	
-	if (isset($cp_row['blockrow']) &amp;&amp; sizeof($cp_row['blockrow']))
-	{
-		foreach ($cp_row['blockrow'] as $field_data)
-		{
-			//$_CLASS['core_template']-&gt;assign_vars_array('postrow.custom_fields', $field_data);
-		}
-	}
-
 	$prev_post_id = $row['post_id'];
 
 	unset($rowset[$i], $post_attachments);
@@ -1249,17 +1243,19 @@
 
 // Update topic view and if necessary attachment view counters ... but only
 // if this is the first 'page view'
-if (isset($_CLASS['core_user']-&gt;data['session_page']) &amp;&amp; !preg_match(&quot;#&amp;t=$topic_id#&quot;, $_CLASS['core_user']-&gt;data['session_page']))
+
+//mb_strpos() should never be 0 here
+if (!mb_strpos($_CLASS['core_user']-&gt;data['session_url'], '&amp;t='.$topic_id))
 {
-	$sql = 'UPDATE ' . TOPICS_TABLE . '
-		SET topic_views = topic_views + 1, topic_last_view_time = ' . time() . &quot;
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+		SET topic_views = topic_views + 1, topic_last_view_time = ' . gmtime() . &quot;
 		WHERE topic_id = $topic_id&quot;;
 	$_CLASS['core_db']-&gt;query($sql);
 
 	// Update the attachment download counts
 	if (sizeof($update_count))
 	{
-		$sql = 'UPDATE ' . ATTACHMENTS_TABLE . ' 
+		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
 			SET download_count = download_count + 1 
 			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
 		$_CLASS['core_db']-&gt;query($sql);
@@ -1272,61 +1268,53 @@
 	// Now lets get the all topics that are in the markable range,
 	// with is the max topics displayed on the forum's viewforum page
 // Need forum_topic_per_page along with whatever users have to after listing
-// Global posts make us do this when not needed :-(
-	if ($topic_data['topic_type'] == POST_GLOBAL)
-	{
-		// temp
-		markread('topic', 0, $topic_id, $update_mark);
-	}
-	else
-	{
-		// Get the user's last mark time for this forums
-		$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
-			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; 
-				AND forum_id = $forum_id AND topic_id = 0&quot;;
 
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		$forum_marktime = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['mark_time'] : 0;
-		$_CLASS['core_db']-&gt;free_result($result);
-			
-		$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . TOPICS_TABLE . ' t
-				LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON ( tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']-&gt;data['user_id'].&quot;)
-					WHERE t.forum_id = $forum_id
-						ORDER BY topic_last_post_time DESC&quot;;
+	// Get the user's last mark time for this forums
+	$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
+		WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; 
+			AND forum_id = $forum_id AND topic_id = 0&quot;;
 
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page']);
-		$update_forum_mark = true;
-	
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			// DESC order so the first post is the last post
-			$last_forum_post = $row['topic_last_post_time'];
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$forum_marktime = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['mark_time'] : 0;
+	$_CLASS['core_db']-&gt;free_result($result);
+		
+	$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . FORUMS_TOPICS_TABLE . ' t
+			LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON ( tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']-&gt;data['user_id'].&quot;)
+				WHERE t.forum_id = $forum_id
+					ORDER BY topic_last_post_time DESC&quot;;
 
-			do
+	$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page']);
+	$update_forum_mark = true;
+
+	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		// DESC order so the first post is the last post
+		$last_forum_post = $row['topic_last_post_time'];
+
+		do
+		{
+			$last_mark_time = max($row['mark_time'], $forum_marktime);
+			if ($row['topic_last_post_time'] &gt; $last_mark_time &amp;&amp; $row['topic_id'] != $topic_id)
 			{
-				$last_mark_time = max($row['mark_time'], $forum_marktime);
-				if ($row['topic_last_post_time'] &gt; $last_mark_time &amp;&amp; $row['topic_id'] != $topic_id)
-				{
-					// We have a winner/loser
-					// Set so the forum isn't marked
-					$update_forum_mark = false;
-					break;
-				}
+				// We have a winner/loser
+				// Set so the forum isn't marked
+				$update_forum_mark = false;
+				break;
 			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 		}
-		$_CLASS['core_db']-&gt;free_result($result);
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
 
-		// Was this the last unread topic ?
-		if ($update_forum_mark)
-		{
-			markread('forum', $forum_id, 0, $last_forum_post);
-		}
-		else
-		{
-			markread('topic', $forum_id, $topic_id, $update_mark);
-		}
+	// Was this the last unread topic ?
+	if ($update_forum_mark)
+	{
+		markread('forum', $forum_id, 0, $last_forum_post);
 	}
+	else
+	{
+		markread('topic', $forum_id, $topic_id, $update_mark);
+	}
 }
 
 if ($view == 'print')

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Quick_Message/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -10,241 +10,227 @@
 //  of the GNU General Public License version 2					//
 //																//
 //**************************************************************//
-$_CORE_CONFIG['quick_message']['delete_time'] = 18000;
 
 if (!defined('VIPERAL'))
 {
     die;
 }
 
-$_CLASS['core_user']-&gt;user_setup();
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+}
 
 switch (get_variable('mode', 'GET', false))
 {
 	case 'add':
-		add_message();
-		break;
-		
-	case 'all':
-		show_messages(true);
-		
-	case 'delete':
-		delete_message();
+		if (empty($_POST['submit']) || $_CLASS['core_user']-&gt;is_bot)
+		{
+			url_redirect(generate_link($_CLASS['core_user']-&gt;data['session_url']), false);
+		}
 	
-	default:
-		show_messages();
-		break;
-}
+		$_CLASS['core_user']-&gt;user_setup();
+		$_CLASS['core_user']-&gt;add_lang();
 
-script_close(false);
+		$message = trim(get_variable('message', 'POST', false));
+		$_CORE_CONFIG['quick_message']['lastpost_check'] = 300;
 
-function add_message()
-{
-	if (empty($_POST['submit']))
-	{
-		return show_messages();
-	}
+		if (!$message)
+		{
+			trigger_error('NO_MESSAGE'); 
+		}
 
-	global $_CLASS, $prefix, $_CORE_CONFIG;
+		$length = mb_strlen($message);
 
-	if ($_CLASS['core_user']-&gt;is_bot)
-	{
-		url_redirect(generate_link($_CLASS['core_user']-&gt;data['session_url']), false);
-	}
-		
-	$_CLASS['core_user']-&gt;add_lang();
-	$_CORE_CONFIG['quick_message']['lastpost_check'] = 300;
+		if ($length &gt; $_CORE_CONFIG['quick_message']['length_max'])
+		{ 
+			trigger_error('LONG_MESSAGE');
+		}
 
-	$user_id = ($_CLASS['core_user']-&gt;is_user) ? $_CLASS['core_user']-&gt;data['user_id'] : '';
-	$user_name = ($_CLASS['core_user']-&gt;is_user) ? $_CLASS['core_user']-&gt;data['username'] : get_username();
-	
-    if(!$message = get_variable('message', 'POST', false))
-    {
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_MESSAGE']); 
-    }
-    
-    $length = mb_strlen($message);
-    
-    if($length &lt; 2)
-    {
-		trigger_error($_CLASS['core_user']-&gt;lang['SHORT_MESSAGE']); 
-    }
-    
-    if($length &gt; $_CORE_CONFIG['quick_message']['maxlength'])
-    { 
-		trigger_error($_CLASS['core_user']-&gt;lang['LONG_MESSAGE']);
-    }
+		$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
 
-	$message 	= htmlentities($message, ENT_QUOTES, 'UTF-8');
-	$user_name 	= htmlentities($user_name, ENT_QUOTES, 'UTF-8');
+	// use limit
+		$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE.&quot; WHERE message_text='&quot;.$_CLASS['core_db']-&gt;escape($message).&quot;' AND message_time &gt;= &quot;.($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['lastpost_check']));
+		$count = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
-    $result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) as count FROM '.$prefix.&quot;quick_message WHERE message='&quot;.$_CLASS['core_db']-&gt;escape($message).&quot;' AND time &gt;= '&quot;.(time() - $_CORE_CONFIG['quick_message']['lastpost_check']).&quot;'&quot;);
-	$count = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-    $_CLASS['core_db']-&gt;free_result($result);
+	// add a count check here so it admin ajustable
+		if ($count['count'] &gt; 0)
+		{
+			trigger_error(sprintf($_CLASS['core_user']-&gt;lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['lastpost_check'] / 60));
+		}
 
-// add a count check here so it admin ajustable
-    if ($count['count'] &gt; 0)
-    {
-        trigger_error(sprintf($_CLASS['core_user']-&gt;lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['lastpost_check'] / 60));
-    }
+		$_CLASS['core_db']-&gt;free_result($result);
 
-    $_CLASS['core_db']-&gt;free_result($result);
+		if ($_CLASS['core_user']-&gt;is_user)
+		{
+			$user_id =  $_CLASS['core_user']-&gt;data['user_id'];
+			$user_name = $_CLASS['core_user']-&gt;data['username'];
+		}
+		else
+		{
+			$user_id = 0;
+			$user_name = get_username();
+		}
 
-	$sql = 'INSERT INTO '.$prefix.'quick_message ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-		'user_name'	=&gt; (string) $user_name,
-		'user_id'	=&gt; (int) $user_id ,
-		'message'	=&gt; (string) $message,
-		'time'		=&gt; (int)  $_CLASS['core_user']-&gt;time,
-		'ip'		=&gt; (string) $_CLASS['core_user']-&gt;ip
-	));
-		
-	$_CLASS['core_db']-&gt;query($sql);
-	
-	url_redirect(generate_link($_CLASS['core_user']-&gt;data['session_url']), false);
-}
+		htmlentities($user_name, ENT_QUOTES, 'UTF-8');
 
-function show_messages($all = false)
-{
-    global $prefix, $_CLASS, $config, $_CORE_CONFIG;
-	
-	$_CLASS['core_user']-&gt;add_lang();
-	$_CLASS['core_user']-&gt;add_img(false, 'Forums');
+		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+			'poster_name'	=&gt; (string) $user_name,
+			'poster_id'		=&gt; (int) $user_id,
+			'poster_ip'		=&gt; (string) $_CLASS['core_user']-&gt;ip,
+			'message_text'	=&gt; (string) $message,
+			'message_time'	=&gt; (int) $_CLASS['core_user']-&gt;time,
+		));
 
-	$start = ($all) ? '' : get_variable('start', 'GET', 0, 'integer');
-	$limit = ($all) ? '' : $_CORE_CONFIG['quick_message']['number'];
-	
-	//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
-	
-	$result = $_CLASS['core_db']-&gt;query_limit('SELECT * FROM '.$prefix.'quick_message ORDER BY time DESC', $limit, $start);
-	$error = (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $_CLASS['core_user']-&gt;lang['NO_POSTS'] : false;
+		$_CLASS['core_db']-&gt;query($sql);
 
-	$_CLASS['core_template']-&gt;assign(array(
-		'L_POSTER'			=&gt; $_CLASS['core_user']-&gt;lang['POSTER'],
-		'L_POSTED'			=&gt; $_CLASS['core_user']-&gt;lang['POSTED'],
-		'L_MESSAGE'			=&gt; $_CLASS['core_user']-&gt;lang['MESSAGE'],
-		'L_DELETE'			=&gt; $_CLASS['core_user']-&gt;get_lang('DELETE'),
-		'ERROR'				=&gt; $error, 
-		)
-	);
-	
-	if ($error)
-	{
-		$_CLASS['core_template']-&gt;display('modules/Quick_Message/index.html');	
-	}
-	
-	do {
-	
-		if ($row['user_name'])
+		redirect(generate_link($_CLASS['core_user']-&gt;data['session_url']), false);
+	break;
+
+	case 'delete':
+		global $_CORE_CONFIG, $_CLASS;
+
+		$id = get_variable('id', 'GET', false, 'integer');
+
+		if (!$id)
 		{
-			$user_name = $row['user_name'];
-			$userlink = ($row['user_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) : false;
+			die;
 		}
-		else
-		{
-			$user_name = $_CLASS['core_user']-&gt;lang['ANONYMOUS'];
-			$userlink = false;
-		}
+
+		$result = $_CLASS['core_db']-&gt;query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time', 1);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 		
-		$delete_link = '';
-		
-		if ($row['time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
+		if (!$row)
 		{
-			if (($row['user_id'] &amp;&amp; $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['user_id'] &amp;&amp; $row['ip'] == $_CLASS['core_user']-&gt;ip))
-			{
-				$delete_link = generate_link('Quick_Message&amp;mode=delete&amp;id='.$row['id']);
-			}
+			trigger_error('NO_MESSAGE');
 		}
 
-		$avatar = false;
-		/*if ($row['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;optionget('viewavatars'))
+		$return = true;
+
+		if ($row['message_id'] != $id)
 		{
-			$avatar_img = '';
-			
-			switch ($row['user_avatar_type'])
+			if ($row['message_time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
 			{
-				case AVATAR_UPLOAD:
-					$avatar_img = $config['avatar_path'] . '/';
-					break;
-				case AVATAR_GALLERY:
-					$avatar_img = $config['avatar_gallery_path'] . '/';
-					break;
+				if (($row['poster_id'] &amp;&amp; $row['poster_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['poster_id'] &amp;&amp; $row['poster_ip'] == $_CLASS['core_user']-&gt;ip))
+				{
+					$return = false;
+				}
 			}
-			
-			$avatar_img .= $row['user_avatar'];
-			$avatar = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $row['user_avatar_width'] . '&quot; height=&quot;' . $row['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
-			
 		}
-*/
 
-		if ($row['user_id'])
+		if ($return)
 		{
-			$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message']);
+			trigger_error('MESSAGE_NOT_DELETABLE');
 		}
-		
-		$_CLASS['core_template']-&gt;assign_vars_array('quick_message', array(
-			'USER_NAME'		=&gt; $user_name,
-			'USER_LINK'		=&gt; $userlink,
-			'DELETE_LINK'	=&gt; $delete_link,
-			'MESSAGE'		=&gt; modify_lines($row['message'], '&lt;br /&gt;'),
-			'TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['time']),
-			'POSTER_AVATAR' =&gt; $avatar,
-			'U_PROFILE' 	=&gt; ($row['user_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']) : false,
-		));
-		
-	}
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
-	$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) AS total from '.$prefix.'quick_message');
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-	$_CLASS['core_db']-&gt;free_result($result);	
+		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
+		$_CLASS['core_db']-&gt;query($sql);
 
-	$_CLASS['core_template']-&gt;assign(array(
+		//trigger_error('MESSAGE_DELETED');
+		redirect(generate_link($_CLASS['core_user']-&gt;data['session_url']), false);
+	break;
+}
+
+$_CLASS['core_user']-&gt;user_setup();
+$_CLASS['core_user']-&gt;add_lang();
+
+$start = get_variable('start', 'GET', 0, 'integer');
+$limit = 20;
+
+//$sql = 'SELECT s.*, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height FROM '.$prefix.'quick_message s LEFT JOIN ' . USERS_TABLE . ' u  ON (u.user_id = s.user_id) ORDER BY time DESC';
+$result = $_CLASS['core_db']-&gt;query_limit('SELECT * FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', $limit, $start);
+$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+
+if (!$row)
+{
+	$_CLASS['core_template']-&gt;assign_array(array(
 		'Q_MESSAGE_PAGINATION'	=&gt; generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
 		'Q_PAGE_NUMBER'			=&gt; on_page($row['total'], $limit, $start),
 		'Q_TOTAL_MESSAGES'		=&gt; $row['total']
 	));
-	
-	$_CLASS['core_template']-&gt;display('modules/Quick_Message/index.html');
+
+	$_CLASS['core_display']-&gt;display(false, 'modules/Quick_Message/index.html');
+	script_close();
 }
 
-function delete_message()
+$delete_link = '';
+
+if ($row['message_time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
 {
+	if (($row['poster_id'] &amp;&amp; $row['poster_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['poster_id'] &amp;&amp; $row['poster_ip'] == $_CLASS['core_user']-&gt;ip))
+	{
+		$delete_link = generate_link('Quick_Message&amp;mode=delete&amp;id='.$row['message_id']);
+	}
+}
 
-	global $_CORE_CONFIG, $_CLASS, $prefix;
-	
-	$id = (int) get_variable('id', 'GET');
-	
-// we should only delete last message
-	$result = $_CLASS['core_db']-&gt;query('SELECT user_id, time, ip FROM '.$prefix.'quick_message WHERE id='.$id);
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-	$_CLASS['core_db']-&gt;free_result($result);
-	
-	if (!$row)
+do
+{
+	if ($row['poster_name'])
 	{
-		trigger_error('MESSAGE_NOT_FOUND');
+		$user_name = $row['poster_name'];
+		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
 	}
-	
-	$return = true;
-	
-	if ($row['time'] &gt; ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['quick_message']['delete_time']))
+	else
 	{
-		if (($row['user_id'] &amp;&amp; $row['user_id'] == $_CLASS['core_user']-&gt;data['user_id']) || (!$row['user_id'] &amp;&amp; $row['ip'] == $_CLASS['core_user']-&gt;ip))
+		$user_name = $_CLASS['core_user']-&gt;lang['ANONYMOUS'];
+		$userlink = false;
+	}
+
+	$avatar = false;
+	/*if ($row['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;optionget('viewavatars'))
+	{
+		$avatar_img = '';
+		
+		switch ($row['user_avatar_type'])
 		{
-			$return = false;
+			case AVATAR_UPLOAD:
+				$avatar_img = $config['avatar_path'] . '/';
+				break;
+			case AVATAR_GALLERY:
+				$avatar_img = $config['avatar_gallery_path'] . '/';
+				break;
 		}
-	}
-	
-	if ($return)
+		
+		$avatar_img .= $row['user_avatar'];
+		$avatar = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $row['user_avatar_width'] . '&quot; height=&quot;' . $row['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
+		
+	}*/
+
+	if ($row['poster_id'])
 	{
-		trigger_error('MESSAGE_NOT_DELETABLE');
+		$row['message'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '&lt;a href=&quot;$1&quot; target=&quot;_blank&quot;&gt;$2&lt;/a&gt;', $row['message_text']);
 	}
 	
-	$sql = 'DELETE FROM '.$prefix.'quick_message WHERE id='.$id;
-	$_CLASS['core_db']-&gt;query($sql);
+	$_CLASS['core_template']-&gt;assign_vars_array('quick_message', array(
+		'USER_NAME'		=&gt; $user_name,
+		'USER_LINK'		=&gt; $userlink,
+		'DELETE_LINK'	=&gt; $delete_link,
+		'MESSAGE'		=&gt; modify_lines($row['message_text'], '&lt;br /&gt;'),
+		'TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['message_time']),
+		'POSTER_AVATAR' =&gt; $avatar,
+		'U_PROFILE' 	=&gt; ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['poster_id']) : false,
+	));
 	
-	trigger_error('MESSAGE_DELETED');
+	$delete_link = '';
 }
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
+$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) AS total from '.QUICK_MESSAGE_TABLE);
+$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+$_CLASS['core_db']-&gt;free_result($result);	
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'Q_MESSAGE_PAGINATION'	=&gt; generate_pagination('Quick_Message', $row['total'], $limit, $start, false, 'Q_MESSAGE_'),
+	'Q_PAGE_NUMBER'			=&gt; on_page($row['total'], $limit, $start),
+	'Q_TOTAL_MESSAGES'		=&gt; $row['total']
+));
+
+$_CLASS['core_display']-&gt;display(false, 'modules/Quick_Message/index.html');
+	
+script_close();
+
 function get_username()
 {
 
@@ -254,7 +240,7 @@
 
 	if (!$user_name)
 	{
-		if ($_CORE_CONFIG['quick_message']['allow_anonymous'] == '2')
+		if ($_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
 		{
 			return false;
 			
@@ -277,6 +263,7 @@
 	}
 	
 	require($site_file_root.'includes/forums/functions_user.php');
+
 	if ($error = validate_username($user_name))
 	{
 		trigger_error($error);

Added: trunk/modules/Quick_Message/install.php
===================================================================
--- trunk/modules/Quick_Message/install.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/modules/Quick_Message/install.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -0,0 +1,46 @@
+&lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+*/
+
+$_CLASS['core_db']-&gt;table_create('start', $install_prefix.'quick_message');
+
+$_CLASS['core_db']-&gt;add_table_field_int('message_id', array('max' =&gt; 16000000, 'auto_increment' =&gt; true));
+$_CLASS['core_db']-&gt;add_table_field_text('message_text', 200);
+field_unix_time('message_time');
+$_CLASS['core_db']-&gt;add_table_field_int('poster_id', array('max' =&gt; 16000000));
+$_CLASS['core_db']-&gt;add_table_field_char('poster_name', 80);
+$_CLASS['core_db']-&gt;add_table_field_char('poster_ip', 18);
+
+$_CLASS['core_db']-&gt;add_table_index('message_id', 'primary');
+$_CLASS['core_db']-&gt;add_table_index('message_time');
+
+$_CLASS['core_db']-&gt;table_create('commit');
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'anonymous_posting', '2', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'delete_time', '300', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'height', '200', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'last_post_check', '150', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'length_max', '150', 1)&quot;);
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$install_prefix.&quot;quick_message (poster_id, poster_name, poster_ip, message_text, message_time) VALUES (0, 'Site', '', 'Lets do this !', &quot;.gmtime().&quot;)&quot;);
+
+$installed = true;
+
+?&gt;
\ No newline at end of file

Deleted: trunk/themes/viperal/blockscript.js
===================================================================
--- trunk/themes/viperal/blockscript.js	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/blockscript.js	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,73 +0,0 @@
-function GetCookie(name) {
-  var arg=name+&quot;=&quot;;
-  var alen = arg.length;
-  var clen = document.cookie.length;
-  var i  = 0;
-  while (i &lt; clen) {
-    var j = i + alen;
-    if (document.cookie.substring(i,j) == arg)
-      return getCookieVal (j);
-    i = document.cookie.indexOf(&quot; &quot;, i) + 1;
-    if (i == 0) break;
-  }
-  return null;
-}
-function getCookieVal (offset) {
-   var endstr = document.cookie.indexOf (&quot;;&quot;, offset);
-     if (endstr == 1)
-       endstr = document.cookie.length;
-     return unescape(document.cookie.substring(offset, endstr));
-}
-function SetCookie (name, value, expires) {
-  var exp = new Date();
-  var expiro = (exp.getTime() + (24 * 60 * 60 * 1000 * expires));
-  exp.setTime(expiro);
-  var expstr = &quot;; expires=&quot; + exp.toGMTString();
-  document.cookie = name + &quot;=&quot; + escape(value) + expstr + &quot;; path=/;&quot;;
-  //  &quot;domain=webmonkey.com;&quot;;
-}
-function DeleteCookie(name){
-  if (GetCookie(name)) {
-    document.cookie = name + &quot;=:; expires = Thu, 01-Jan-70 00:00:01 GMT; path=/;&quot;;
-  }
-}
-var imagepath = &quot;images/&quot;;
-
-var hiddenblocks = new Array();
-var blocks = GetCookie('hiddenblocks');
-if (blocks != null) {
-  var hidden = blocks.split(&quot;:&quot;);
-  for (var loop = 0; loop &lt; hidden.length; loop++) {
-    var hiddenblock = hidden[loop];
-    hiddenblocks[hiddenblock] = hiddenblock;
-  }
-}
-hiddenblocks[88]= &quot;88&quot;;
-function blockswitch2(bid, min, max) {
-  var bpe  = document.getElementById('pe'+bid);
-  var bico = document.getElementById('pic'+bid);
-  if (bpe.style.display==&quot;none&quot;) {
-    bpe.style.display=&quot;&quot;;
-    hiddenblocks[bid] = null;
-
-  } else {
-    bpe.style.display=&quot;none&quot;;
-    hiddenblocks[bid] = bid;
-  }
-  
-  var cookie = null;
-  for (var q = 0; q &lt; hiddenblocks.length; q++) {
-    if (hiddenblocks[q] != null) {
-      if (cookie != null) {
-        cookie = (cookie+&quot;:&quot;+hiddenblocks[q]);
-      } else {
-        cookie = hiddenblocks[q];
-      }
-    }
-  }
-  if (cookie != null) {
-    SetCookie('hiddenblocks', cookie, 365);
-  } else {
-    DeleteCookie('hiddenblocks');
-  }
-}
\ No newline at end of file

Modified: trunk/themes/viperal/images/Thumbs.db
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/down-logo.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/leftbar.gif
===================================================================
(Binary files differ)

Added: trunk/themes/viperal/images/mail.png
===================================================================
(Binary files differ)


Property changes on: trunk/themes/viperal/images/mail.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: trunk/themes/viperal/images/mainbar.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/images/print.gif
===================================================================
(Binary files differ)

Added: trunk/themes/viperal/images/print.png
===================================================================
(Binary files differ)


Property changes on: trunk/themes/viperal/images/print.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Deleted: trunk/themes/viperal/images/rightbar.gif
===================================================================
(Binary files differ)

Modified: trunk/themes/viperal/index.php
===================================================================
--- trunk/themes/viperal/index.php	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/index.php	2005-08-15 21:01:36 UTC (rev 82)
@@ -27,7 +27,7 @@
 		$this-&gt;table_open	= '&lt;div class=&quot;OpenTable&quot;&gt;&lt;div class=&quot;outer&quot;&gt;&lt;div class=&quot;inner&quot;&gt;';
 		$this-&gt;table_close	= '&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;';
 		
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'A_TABLE_OPEN'	=&gt; $this-&gt;table_open,
 			'A_TABLE_CLOSE'	=&gt; $this-&gt;table_close,
 			'A_STYLESHEET'	=&gt; '/themes/viperal/style/style.css',
@@ -38,13 +38,13 @@
 	{
 		global $_CORE_CONFIG, $_CORE_MODULE, $_CLASS;
 
-		$_CLASS['core_template']-&gt;assign(array(
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'THEME_MAININDEX'	=&gt; generate_link(),
 			'THEME_SITENAME'	=&gt; $_CORE_CONFIG['global']['site_name'],
-			'THEME_MARGINRIGHT'	=&gt; ($_CLASS['core_blocks']-&gt;check_side(BLOCK_RIGHT)) ? '180px' : '0px',
-			'THEME_MARGINLEFT' 	=&gt; ($_CLASS['core_blocks']-&gt;check_side(BLOCK_LEFT)) ? '180px' : '0px'
+			'THEME_MARGINRIGHT'	=&gt; $_CLASS['core_blocks']-&gt;check_side(BLOCK_RIGHT) ? '180px' : '0px',
+			'THEME_MARGINLEFT' 	=&gt; $_CLASS['core_blocks']-&gt;check_side(BLOCK_LEFT) ? '180px' : '0px'
 		));
-		
+
 		if ($_CLASS['core_display']-&gt;homepage)
 		{
 			$_CLASS['core_template']-&gt;assign('PAGE_TITLE', $_CLASS['core_user']-&gt;lang['HOME']);
@@ -62,9 +62,9 @@
 	function theme_footer()
 	{
 		global $_CLASS;
-		
+
 		$_CLASS['core_blocks']-&gt;display(BLOCK_RIGHT);
-		
+
 		$_CLASS['core_template']-&gt;assign('THEME_FOOTER', $_CLASS['core_display']-&gt;footmsg());
 		
 		$_CLASS['core_template']-&gt;display('footer.html');

Modified: trunk/themes/viperal/style/images/Thumbs.db
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/cellpic3.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/created_by.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_faq.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_groups.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_login.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_members.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_message.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_profile.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_register.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/icon_mini_search.gif
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/index.htm
===================================================================
--- trunk/themes/viperal/style/images/index.htm	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/style/images/index.htm	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,16 +0,0 @@
-&lt;html&gt;
-&lt;head&gt;
-&lt;title&gt;subSilver created by subBlue Design&lt;/title&gt;
-&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
-&lt;/head&gt;
-
-&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot;&gt;
-
-&lt;table width=&quot;100%&quot; height=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;a href=&quot;<A HREF="http://www.subblue.com/">http://www.subblue.com/</A>&quot; target=&quot;_new&quot;&gt;&lt;img src=&quot;created_by.jpg&quot; width=&quot;400&quot; height=&quot;300&quot; border=&quot;0&quot; alt=&quot;Created by subBlue Design&quot; /&gt;&lt;/a&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;/body&gt;
-&lt;/html&gt;
\ No newline at end of file

Deleted: trunk/themes/viperal/style/images/logo-christmas.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/sitelogo.jpg
===================================================================
(Binary files differ)

Deleted: trunk/themes/viperal/style/images/whosonline.gif
===================================================================
(Binary files differ)

Modified: trunk/themes/viperal/style/style.css
===================================================================
--- trunk/themes/viperal/style/style.css	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/style/style.css	2005-08-15 21:01:36 UTC (rev 82)
@@ -2,11 +2,12 @@
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
-    /*font: 7pt &quot;Bitstream Vera Sans&quot;, verdana, geneva, lucida, 'lucida grande', arial, helvetica, sans-serif;*/
-    margin: 0px;
+
+    /* Needed for opera */
+    margin: 0px; 
+
     padding: 0px;
-    background-color: white;
-    background: url(images/bg.gif);
+    background: url(/images/bg.gif);
 }
 
 .logo
@@ -14,10 +15,10 @@
 	position:fixed;
 	top: -1px;
 	left: -1px;
-	z-index:	1;
+	z-index: 1;
 }
 
-#nav li a, .active
+#nav li a
 {
 	display: block;
 	padding: 5px 10px 5px 5px; 
@@ -25,7 +26,7 @@
 	color: black;
 }
 
-#nav li a:hover, .active
+#nav li a:hover
 {
 	background-color: #FFFFFF;
 	color: black;
@@ -39,21 +40,22 @@
 #page
 {
 	position: relative;
-	height:15px;
+	height: 15px;
 	background: url(images/curve.gif) top left no-repeat;
 	background-color: #eee;
 	color: #999;
-	padding: 0.25em 0 0.25em 2em;
+	padding: 2px;
+	padding-left: 20px;
 }
 
 
 #header
 {
 	position: relative;
-	height:138px;
+	height: 138px;
 	width: 100%;
 	background: url(images/background.gif);
-	border-bottom:1px solid #ccc;
+	border-bottom: 1px solid #ccc;
 }
 	
 #blocksleft
@@ -61,18 +63,18 @@
 	position:absolute;
 	top: 137px;
 	left:0px;
-	width:180px;
+	width: 180px;
 	height:100%;
-	margin:0px 0px 10px 0px;
+	margin: 0px 0px 10px 0px;
 }
 	
 #blocksright
 {
 	position:absolute;
 	top: 160px;
-	right:0px;
-	width:180px;
-	margin:0px 0px 10px 0px;
+	right: 0px;
+	width: 180px;
+	margin: 0px 0px 10px 0px;
 }
 
 /* 
@@ -80,8 +82,8 @@
 */
 .mainbody
 {
-	position:relative;
-	height:100%;
+	position: relative;
+	height: 100%;
 	border-left:1px solid #ccc;
 	border-top:1px solid #ccc;
 	background-color:white;
@@ -89,10 +91,10 @@
 	
 .bodymain
 {
-	position:relative;
-	border-top:1px solid #ccc;
-	height:100%;
-	min-height:1500px;
+	position: relative;
+	border-top: 1px solid #ccc;
+	height: 100%;
+	min-height: 1500px;
 	border-right:1px dashed #ccc;
 }
 
@@ -259,6 +261,22 @@
 	background-color: #ECECEC; padding: 4px;
 }
 
+.page_link_normal
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
+.page_link_current
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
 /* 
 	TEXT
 */
@@ -328,26 +346,41 @@
 
 .catdiv
 {
-	height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: white; background-image: url('./images/cellpic2.jpg'); background-repeat: repeat-y;
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color:white;
+	background-image: url('./images/cellpic2.jpg');
+	background-repeat: repeat-y;
 }
 
 .cat
 {
-	height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: #C7D0D7; background-image: url('../images/cellpic1.gif'); text-indent: 4px;
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color: #C7D0D7;
+	background-image: url('../images/cellpic1.gif');
+	text-indent: 4px;
 }
 
 .row1
 {
-	background-color: #ECECEC; padding: 4px;
+	background-color: #ECECEC;
+	padding: 4px;
 }
 .row2
 {
-	background-color: #DCE1E5; padding: 4px;
+	background-color: #DCE1E5;
+	padding: 4px;
 }
 
 .row3
 {
-background-color: #C0C8D0; padding: 4px;
+	background-color: #C0C8D0;
+	padding: 4px;
 }
 
 .spacer
@@ -408,47 +441,49 @@
 	font-size: 100%; color: black; font-family: Verdana, serif; font-weight: normal;
 }
 
-input:focus
+textarea
 {
-	background-color: #C7D0D7;
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 110%; font-weight: normal;
 	border:1px solid #999;
+	padding: 3px;
 }
 
-textarea
-{
-	background-color: white; color: black; font-family: Verdana, serif; font-size: 110%; font-weight: normal;
-	border:1px solid #999; 
-}
-
 select
 {
-	background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal;;
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 100%;
+	font-weight: normal;;
 }
 
-.button, .btnbbcode
+.button, .btnbbcode, .button_main
 {
 	background-color: #FAFAFA;
 	border: 1px solid #ccc;
 	color: black;
 }
 
+.button_main
+{
+	font-weight: bold;
+}
+
 /* Rename this */
 .post
 {
 	background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;
 }
 
-02.helpline
+.helpline
 {
 	background-color: #DEE3E7; border-style: none;
 }
 
 /* Rename this */
-.btnmain
-{
-	font-weight: bold; background-color: #FAFAFA; border-style: solid; border-width: 1px;
-}
 
+
 /* 
 	BBCODE 
 */

Modified: trunk/themes/viperal/template/blockleft.html
===================================================================
--- trunk/themes/viperal/template/blockleft.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/blockleft.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,18 +1,13 @@
 &lt;!-- IF isset({ $block_left }) --&gt;
 &lt;div id=&quot;blocksleft&quot;&gt;
-  &lt;!-- LOOP $block_left --&gt;
+	&lt;!-- LOOP $block_left --&gt;
 	&lt;div class=&quot;blocks&quot;&gt;
-       
-        &lt;div class=&quot;top&quot; onclick=&quot;blockswitch2('{ $block_left:ID }');&quot; style=&quot;cursor:pointer&quot;&gt;&nbsp;{ $block_left:TITLE }&nbsp;&lt;/div&gt;
-                    
-		&lt;div class=&quot;content&quot; id=&quot;pe{ $block_left:ID }&quot; { $block_left:COLLAPSE }&gt;
-
-        { $block_left:CONTENT }
-        
-        &lt;/div&gt;
-
-	&lt;/div&gt;
-  &lt;br /&gt;
-  &lt;!-- ENDLOOP $block_left--&gt;
+		&lt;div class=&quot;top&quot; onclick=&quot;switch_collapse('block_{ $block_left:id }');&quot; style=&quot;cursor:pointer&quot;&gt;&nbsp;{ $block_left:title }&nbsp;&lt;/div&gt;
+			&lt;div&lt;!-- IF { $block_left:collapsed } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt; class=&quot;content&quot; id=&quot;block_{ $block_left:id }&quot;&gt;
+			{ $block_left:content }
+			&lt;/div&gt;
+		&lt;/div&gt;
+	&lt;br /&gt;
+	&lt;!-- ENDLOOP $block_left--&gt;
 &lt;/div&gt;
 &lt;!-- ENDIF --&gt;
\ No newline at end of file

Modified: trunk/themes/viperal/template/blockright.html
===================================================================
--- trunk/themes/viperal/template/blockright.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/blockright.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,19 +1,13 @@
-&lt;!-- IF isset({ $block_right }) --&gt;
-&lt;div id=&quot;blocksright&quot;&gt;
-  &lt;!-- LOOP $block_right --&gt;
-	&lt;div class=&quot;blocks&quot;&gt;
-       
-        &lt;div class=&quot;top&quot; onclick=&quot;blockswitch2('{ $block_right:ID }');&quot; style=&quot;cursor:pointer&quot;&gt;&nbsp;{ $block_right:TITLE }&nbsp;&lt;/div&gt;
-                    
-		&lt;div class=&quot;content&quot; id=&quot;pe{ $block_right:ID }&quot; { $block_right:COLLAPSE }&gt;
-
-        { $block_right:CONTENT }
-        
-        &lt;/div&gt;
-
-	&lt;/div&gt;
-  &lt;br /&gt;
-  &lt;!-- ENDLOOP $block_right --&gt;
-
-&lt;/div&gt;
+&lt;!-- IF isset({ $block_right }) --&gt;
+&lt;div id=&quot;blocksright&quot;&gt;
+	&lt;!-- LOOP $block_right --&gt;
+	&lt;div class=&quot;blocks&quot;&gt;
+		&lt;div class=&quot;top&quot; onclick=&quot;switch_collapse('block_{ $block_right:id }');&quot; style=&quot;cursor:pointer&quot;&gt;&nbsp;{ $block_right:title }&nbsp;&lt;/div&gt;
+			&lt;div&lt;!-- IF { $block_right:collapsed } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt; class=&quot;content&quot; id=&quot;block_{ $block_right:id }&quot;&gt;
+			{ $block_right:content }
+			&lt;/div&gt;
+		&lt;/div&gt;
+	&lt;br /&gt;
+	&lt;!-- ENDLOOP $block_right --&gt;
+&lt;/div&gt;
 &lt;!-- ENDIF --&gt;
\ No newline at end of file

Modified: trunk/themes/viperal/template/header.html
===================================================================
--- trunk/themes/viperal/template/header.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/header.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -6,14 +6,17 @@
 &lt;meta name=&quot;author&quot; content=&quot;{ $SITE_NAME }&quot; /&gt;&lt;meta http-equiv=&quot;expires&quot; content=&quot;0&quot; /&gt;
 &lt;meta name=&quot;copyright&quot; content=&quot;Copyright { $SITE_NAME } { $SITE_URL }&quot; /&gt;
 &lt;meta name=&quot;robots&quot; content=&quot;index, follow&quot; /&gt;
-&lt;link rel=&quot;stylesheet&quot; href=&quot;{ $A_STYLESHEET }&quot; type=&quot;text/css&quot; /&gt;
+&lt;!-- &lt;link rel=&quot;stylesheet&quot; href=&quot;{ $A_STYLESHEET }&quot; type=&quot;text/css&quot; /&gt; --&gt;
+&lt;style type=&quot;text/css&quot;&gt;@import &quot;{ $A_STYLESHEET }&quot;;&lt;/style&gt;
 { $HEADER_REGULAR }
+
 { $HEADER_JS }
-&lt;script type=&quot;text/javascript&quot; src=&quot;/themes/viperal/blockscript.js&quot;&gt;&lt;/script&gt;
+&lt;script type=&quot;text/javascript&quot; src=&quot;/javascript/collapse.js&quot;&gt;&lt;/script&gt;
 
 &lt;!--[if IE]&gt;
 &lt;style&gt;
-	.bodymain {
+	.bodymain
+	{
 		height:1500px;
 	}
 &lt;/style&gt;
@@ -24,8 +27,6 @@
 
 &lt;a name=&quot;Top&quot;&gt;&lt;/a&gt;
 
-&lt;div class=&quot;menu&quot;&gt;&lt;/div&gt;
-
 &lt;div id=&quot;header&quot;&gt;
 	&lt;a href=&quot;{ $THEME_MAININDEX }&quot;&gt;&lt;img src=&quot;themes/viperal/images/Viperal_Logo.gif&quot; border=&quot;0&quot; alt=&quot;{ $THEME_SITENAME }&quot; /&gt;&lt;/a&gt;
 &lt;/div&gt;
@@ -39,16 +40,16 @@
 	
 	&lt;div class=&quot;bodymain&quot; style=&quot;margin-right: { $THEME_MARGINRIGHT }&quot;&gt;
 	&lt;!-- IF { $HEADER_MESSAGE }--&gt;
-	{ $A_TABLE_OPEN }&lt;div style=&quot;text-align: center;&quot;&gt;{ $HEADER_MESSAGE }&lt;/div&gt;{ $A_TABLE_CLOSE }
+	&lt;div style=&quot;color: #999; border-bottom:1px solid #ccc; padding:2px; background-color: #eee; text-align: center;&quot;&gt;{ $HEADER_MESSAGE }&lt;/div&gt;
 	&lt;!-- ENDIF --&gt;
 
 	&lt;!-- IF isset({ $message_block_top }) --&gt;
 	&lt;div class=&quot;messageblock&quot;&gt;
 	&lt;!-- LOOP $message_block_top --&gt;
-		&lt;div class=&quot;title&quot; onclick=&quot;blockswitch2('{ $message_block_top:ID }');&quot; style=&quot;cursor:pointer&quot;&gt;{ $message_block_top:TITLE }
-		&lt;!-- IF { $message_block_top:EDIT_LINK } --&gt;[ &lt;!-- IF { $message_block_top:EXPIRES } --&gt;{ $message_block_top:EXPIRES } | &lt;!-- ENDIF --&gt;
-		&lt;a href=&quot;{ $message_block_top:EDIT_LINK }&quot; &gt;{ $message_block_top:L_EDIT }&lt;/a&gt; ]&lt;!-- ENDIF --&gt;&lt;/div&gt;
-		&lt;div class=&quot;content&quot; { $message_block_top:HIDE } id=&quot;pe{ $message_block_top:ID }&quot;&gt;{ $message_block_top:CONTENT }&lt;/div&gt;
+		&lt;div class=&quot;title&quot; onclick=&quot;switch_collapse('block_{ $message_block_top:id }');&quot; style=&quot;cursor:pointer&quot;&gt;{ $message_block_top:title }
+		&lt;!-- IF { $message_block_top:edit_link } --&gt;[ &lt;!-- IF { $message_block_top:expires } --&gt;{ $message_block_top:expires } | &lt;!-- ENDIF --&gt;
+		&lt;a href=&quot;{ $message_block_top:edit_link }&quot; &gt;{ $L_EDIT }&lt;/a&gt; ]&lt;!-- ENDIF --&gt;&lt;/div&gt;
+		&lt;div &lt;!-- IF { $message_block_top:collapsed } --&gt;style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt; class=&quot;content&quot; id=&quot;block_{ $message_block_top:id }&quot;&gt;{ $message_block_top:content }&lt;/div&gt;
 	&lt;br /&gt;
 	&lt;!-- ENDLOOP $message_block_top --&gt;
 	&lt;/div&gt;&lt;br /&gt;

Modified: trunk/themes/viperal/template/modules/News/index.html
===================================================================
--- trunk/themes/viperal/template/modules/News/index.html	2005-08-10 02:42:08 UTC (rev 81)
+++ trunk/themes/viperal/template/modules/News/index.html	2005-08-15 21:01:36 UTC (rev 82)
@@ -1,21 +1,25 @@
-&lt;div class=&quot;newsblock&quot;&gt;
-&lt;!-- LOOP $news --&gt;
-	&lt;div class=&quot;title&quot; onclick=&quot;blockswitch2('{ $news:ID }');&quot; style=&quot;cursor:pointer&quot;&gt;{ $news:TITLE }&lt;/div&gt;
-	&lt;div class=&quot;content&quot;&lt;!-- IF { $news:COLLAPSE } --&gt; style=&quot;display: none&quot;&lt;!-- ENDIF --&gt; id=&quot;pe{ $news:ID }&quot;&gt;
-	{ $news:CONTENT }
-	&lt;br /&gt;&lt;br /&gt;
-	&lt;!-- IF { $news:FULL_STORY } --&gt;&lt;a href=&quot;{ $news:CONTENT_LINK }&quot; &gt; Readmore ..&lt;/a&gt;&lt;!-- ENDIF --&gt;
-	&lt;hr /&gt;
-	
-	 &lt;div style=&quot;float: left; Top: -2.5em;&quot;&gt;&lt;a onclick=&quot;window.open('{ $news:PRINT_LINK }', 'print{ $news:ID }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600');return false;&quot; href=&quot;{ $news:PRINT_LINK }&quot; &gt;
-	 &lt;img src=&quot;themes/viperal/images/print.gif&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;&lt;/div&gt;
-	 &lt;div style=&quot;float: right; Top: -2.5em;&quot;&gt;Posted: { $news:TIME }&lt;br/&gt;
-	&lt;!-- IF { $news:POSTER_LINK } --&gt;By: &lt;a href=&quot;{ $news:POSTER_LINK }&quot;&gt;{ $news:POSTER } &lt;/a&gt;&lt;!-- ELSE --&gt;By: { $news:POSTER } &lt;!-- ENDIF --&gt;&lt;/div&gt;&lt;/div&gt;
-	&lt;br /&gt;
-	&lt;br /&gt;
-	&lt;br /&gt;
-&lt;!-- ENDLOOP  --&gt;
-&lt;!-- IF { $NEWS_PAGINATION } --&gt;&lt;div class=&quot;numbering&quot;&gt;[ &lt;!-- IF { $NEWS_PREVIOUS_PAGE } --&gt;&lt;a href=&quot;{ $NEWS_PREVIOUS_PAGE }&quot;&gt;{ $L_PREVIOUS }&lt;/a&gt;&nbsp;|&nbsp;&lt;!-- ENDIF --&gt; { $NEWS_PAGINATION }
-&lt;!-- IF { $NEWS_NEXT_PAGE } --&gt;&nbsp;|&nbsp;&lt;a href=&quot;{ $NEWS_NEXT_PAGE }&quot;&gt;{$L_NEXT}&lt;/a&gt;&lt;!-- ENDIF --&gt; ]&lt;/div&gt;&lt;br /&gt;&lt;!-- ENDIF --&gt;
-&lt;/div&gt;
-&lt;br /&gt;
\ No newline at end of file
+&lt;!-- DISPLAY_HEADER --&gt;
+
+&lt;div class=&quot;newsblock&quot;&gt;
+	&lt;!-- LOOP $news --&gt;
+	&lt;div class=&quot;title&quot; onclick=&quot;switch_collapse('article_{ $news:id }');&quot; style=&quot;cursor:pointer&quot;&gt;{ $news:title }&lt;/div&gt;
+		&lt;div class=&quot;content&quot;&lt;!-- IF { $news:collapse } --&gt; style=&quot;display: none&quot;&lt;!-- ENDIF --&gt; id=&quot;article_{ $news:id }&quot;&gt;
+			{ $news:content }
+			&lt;br clear=&quot;all&quot;&gt;
+			&lt;p&gt;
+				&lt;!-- IF { $news:full_story } --&gt;&lt;a href=&quot;{ $news:link_content }&quot; &gt; { $L_READMORE } ..&lt;/a&gt;&lt;!-- ENDIF --&gt;
+				&lt;hr /&gt;
+				&lt;div style=&quot;float: left; Top: -2.5em;&quot;&gt;
+					&lt;a onclick=&quot;window.open('{ $news:link_print }', 'print{ $news:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600,height=400'); return false;&quot; href=&quot;{ $news:link_print }&quot; &gt;&lt;img src=&quot;themes/viperal/images/print.png&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;
+					&lt;a onclick=&quot;window.open('{ $news:link_send }', 'send{ $news:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600'); return false;&quot; href=&quot;{ $news:link_send }&quot; &gt;&lt;img src=&quot;themes/viperal/images/mail.png&quot; alt=&quot;&quot; /&gt;&lt;/a&gt;
+				&lt;/div&gt;
+				&lt;div style=&quot;float: right; Top: -2.5em;&quot;&gt;{ $L_POSTED } { $news:time }&lt;br/&gt;
+					&lt;!-- IF { $news:link_poster } --&gt;By: &lt;a href=&quot;{ $news:link_poster }&quot;&gt;{ $news:poster } &lt;/a&gt;&lt;!-- ELSE --&gt;By: { $news:poster } &lt;!-- ENDIF --&gt;
+				&lt;/div&gt;
+			&lt;/p&gt;
+		&lt;/div&gt;
+	&lt;br /&gt;&lt;br /&gt;
+	&lt;!-- ENDLOOP  --&gt;
+	&lt;p align=&quot;center&quot;&gt; { $NEWS_PAGINATION }&lt;/p&gt;
+&lt;/div&gt;
+&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000005.html">[Viperals-svncheckins] r81 - in trunk: . images/mimetypes images/smilies includes includes/auth includes/cache includes/db includes/display includes/forums javascript modules/Control_Panel/ucp modules/Forums modules/Quick_Message
</A></li>
	<LI>Next message: <A HREF="000007.html">[Viperals-svncheckins] r83 - trunk/includes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6">[ date ]</a>
              <a href="thread.html#6">[ thread ]</a>
              <a href="subject.html#6">[ subject ]</a>
              <a href="author.html#6">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
