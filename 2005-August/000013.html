<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r89 - in trunk: blocks includes includes/db includes/forums includes/forums/admin javascript modules/Control_Panel/ucp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r89%20-%20in%20trunk%3A%20blocks%20includes%20includes/db%20includes/forums%20includes/forums/admin%20javascript%20modules/Control_Panel/ucp&In-Reply-To=%3C200508241500.j7OF0WQC026303%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000012.html">
   <LINK REL="Next"  HREF="000014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r89 - in trunk: blocks includes includes/db includes/forums includes/forums/admin javascript modules/Control_Panel/ucp</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r89%20-%20in%20trunk%3A%20blocks%20includes%20includes/db%20includes/forums%20includes/forums/admin%20javascript%20modules/Control_Panel/ucp&In-Reply-To=%3C200508241500.j7OF0WQC026303%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r89 - in trunk: blocks includes includes/db includes/forums includes/forums/admin javascript modules/Control_Panel/ucp">viperal at berlios.de
       </A><BR>
    <I>Wed Aug 24 17:00:32 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000012.html">[Viperals-svncheckins] r88 - in trunk: admin images includes includes/auth includes/crons includes/forums includes/forums/admin includes/templates includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users includes/templates/modules includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Quick_Message install modules/Control_Panel modules/Control_Panel/ucp modules/Quick_Message
</A></li>
        <LI>Next message: <A HREF="000014.html">[Viperals-svncheckins] r90 - in trunk: . admin blocks includes includes/templates/admin includes/templates/admin/users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13">[ date ]</a>
              <a href="thread.html#13">[ thread ]</a>
              <a href="subject.html#13">[ subject ]</a>
              <a href="author.html#13">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-08-24 17:00:26 +0200 (Wed, 24 Aug 2005)
New Revision: 89

Removed:
   trunk/includes/forums/admin/admin_bots.php
   trunk/includes/forums/admin/admin_groups.php
   trunk/includes/forums/admin/admin_users.php
Modified:
   trunk/blocks/block-Demo_Block.php
   trunk/blocks/block-Google.php
   trunk/blocks/block-theme_select.php
   trunk/includes/db/mysql.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/message_parser.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/session.php
   trunk/javascript/collapse.js
   trunk/javascript/menu.js
   trunk/modules/Control_Panel/ucp/ucp_groups.php
   trunk/modules/Control_Panel/ucp/ucp_prefs.php
   trunk/modules/Control_Panel/ucp/ucp_register.php
Log:


Modified: trunk/blocks/block-Demo_Block.php
===================================================================
--- trunk/blocks/block-Demo_Block.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-Demo_Block.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;

Modified: trunk/blocks/block-Google.php
===================================================================
--- trunk/blocks/block-Google.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-Google.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,15 +1,25 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 if (!defined('VIPERAL'))
 {
@@ -29,7 +39,7 @@
 	&lt;input name=&quot;domains&quot; value=&quot;'.$Site_domain.'&quot; type=&quot;hidden&quot; /&gt;
 	&lt;input name=&quot;q&quot; size=&quot;15&quot; maxlength=&quot;200&quot; value=&quot;&quot; type=&quot;text&quot; /&gt;
 	&lt;input name=&quot;sitesearch&quot; value=&quot;'.$Site_domain.'&quot; type=&quot;hidden&quot; /&gt;
-	&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;bottom&quot; name=&quot;btnG&quot; value=&quot;Search&quot; type=&quot;submit&quot; /&gt;
+	&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;button&quot; name=&quot;btnG&quot; value=&quot;Search&quot; type=&quot;submit&quot; /&gt;
 &lt;/form&gt;
 &lt;/div&gt;';
 

Modified: trunk/blocks/block-theme_select.php
===================================================================
--- trunk/blocks/block-theme_select.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/blocks/block-theme_select.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 &lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -19,7 +29,7 @@
 $this-&gt;content = '
 &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
 	&lt;p style=&quot;text-align: center;&quot;&gt;
-		&lt;select name=&quot;prevtheme&quot; onchange=&quot;this.form.submit();&quot;&gt;'.theme_select().'&lt;/select&gt;
+		&lt;select name=&quot;prevtheme&quot; onchange=&quot;this.form.submit();&quot;&gt;'.select_theme().'&lt;/select&gt;
 		&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;button&quot; value=&quot;Select&quot; type=&quot;submit&quot; /&gt;
 	&lt;/p&gt;
 &lt;/form&gt;';

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/db/mysql.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -449,9 +449,10 @@
 		switch ($mode)
 		{
 			case 'start':
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
+// this is done even for none admins ( need to fix this )
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
 				{
-					if (strpos('SELECT', $this-&gt;last_query) === 0)
+					if (strpos($this-&gt;last_query, 'SELECT') !== false)
 					{
 						if ($result = @mysql_query('EXPLAIN '.$this-&gt;last_query, $this-&gt;link_identifier))
 						{
@@ -478,7 +479,7 @@
 				$end_time = $end_time[0] + $end_time[1];
 				$this-&gt;queries_time += $end_time - $start_time;
 
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
+				if (empty($_CORE_CONFIG['server']['error_options']) || $_CORE_CONFIG['server']['error_options'] == ERROR_DEBUGGER)
 				{
 					if ($this-&gt;last_result !== false)
 					{

Deleted: trunk/includes/forums/admin/admin_bots.php
===================================================================
--- trunk/includes/forums/admin/admin_bots.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_bots.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,372 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_bots.php,v 1.3 2003/10/21 00:15:28 psotfx Exp $
-//
-// FILENAME  : admin_bots.php 
-// STARTED   : Tue Oct 15, 2003
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have permission?
-if (!$_CLASS['auth']-&gt;acl_get('a_server'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Set various vars
-$submit = (isset($_POST['submit'])) ? true : false;
-$action = request_var('action', '');
-$mark	= request_var('mark', 0);
-$id		= request_var('id', 0);
-
-if (isset($_POST['add']))
-{
-	$action = 'add';
-}
-
-$error = array();
-
-// User wants to do something, how inconsiderate of them!
-switch ($action)
-{
-	case 'activate':
-		if ($id || $mark)
-		{
-			$id = ($id) ? &quot; = $id&quot; : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'UPDATE ' . BOTS_TABLE . &quot; 
-				SET bot_active = 1
-				WHERE bot_id $id&quot;;
-			$db-&gt;sql_query($sql);
-		}
-		break;
-
-	case 'deactivate':
-		if ($id || $mark)
-		{
-			$id = ($id) ? &quot; = $id&quot; : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'UPDATE ' . BOTS_TABLE . &quot; 
-				SET bot_active = 0
-				WHERE bot_id $id&quot;;
-			$db-&gt;sql_query($sql);
-		}
-		break;
-
-	case 'delete':
-		if ($id || $mark)
-		{
-			// We need to delete the relevant user, usergroup and bot entries ...
-			$id = ($id) ? &quot; = $id&quot; : ' IN (' . implode(', ', $mark) . ')';
-			$sql = 'SELECT bot_name, user_id 
-				FROM ' . BOTS_TABLE . &quot; 
-				WHERE bot_id $id&quot;;
-			$result = $db-&gt;sql_query($sql);
-
-			$user_id_ary = $bot_name_ary = array();
-			while ($row = $db-&gt;sql_fetchrow($result))
-			{
-				$user_id_ary[] = (int) $row['user_id'];
-				$bot_name_ary[] = $row['bot_name'];
-			}
-			$db-&gt;sql_freeresult($result);
-
-			$db-&gt;sql_transaction();
-
-			$sql = 'DELETE FROM ' . BOTS_TABLE . &quot; 
-				WHERE bot_id $id&quot;;
-			$db-&gt;sql_query($sql);
-
-			foreach (array(USERS_TABLE, USER_GROUP_TABLE) as $table)
-			{
-				$sql = &quot;DELETE FROM $table
-					WHERE user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-				$db-&gt;sql_query($sql);
-			}
-
-			$db-&gt;sql_transaction('commit');
-
-			add_log('admin', 'LOG_BOT_DELETE', implode(', ', $bot_name_ary));
-			trigger_error($_CLASS['core_user']-&gt;lang['BOT_DELETED']);
-		}
-		break;
-
-	case 'edit':
-	case 'add':
-		$bot_name	= request_var('bot_name', '');
-		$bot_agent	= request_var('bot_agent', '');
-		$bot_ip		= request_var('bot_ip', '');
-		$bot_active = request_var('bot_active', true);
-		$bot_lang	= request_var('bot_lang', $_CORE_CONFIG['global']['default_lang']);
-		$bot_theme	= request_var('bot_theme' , $_CORE_CONFIG['global']['default_theme']);
-
-		if ($submit)
-		{
-			if (!$bot_agent &amp;&amp; !$bot_ip)
-			{
-				$error[] = $_CLASS['core_user']-&gt;lang['ERR_BOT_NO_MATCHES'];
-			}
-			if ($bot_ip &amp;&amp; !preg_match('#^[\d\.,:]+$#', $bot_ip))
-			{
-				if (!$ip_list = gethostbynamel($bot_ip))
-				{
-					$error[] = $_CLASS['core_user']-&gt;lang['ERR_BOT_NO_IP'];
-				}
-				else
-				{
-					$bot_ip = implode(',', $ip_list);
-				}
-			}
-			$bot_ip = str_replace(' ', '', $bot_ip);
-
-			if (!sizeof($error))
-			{
-				$db-&gt;sql_transaction();
-
-				// New bot? Create a new user and group entry
-				if ($action == 'add')
-				{
-					$sql = 'SELECT group_id, group_colour 
-						FROM ' . GROUPS_TABLE . &quot; 
-						WHERE group_name = 'BOTS' 
-							AND group_type = &quot; . GROUP_SPECIAL;
-					$result = $db-&gt;sql_query($sql);
-
-					if (!extract($db-&gt;sql_fetchrow($result)))
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-					}
-					$db-&gt;sql_freeresult($result);
-
-					$sql = 'INSERT INTO ' . USERS_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', array(
-						'group_id'		=&gt; (int) $group_id, 
-						'username'		=&gt; (string) $bot_name, 
-						'user_type'		=&gt; (int) USER_IGNORE, 
-						'user_colour'	=&gt; (string) $group_colour,
-						'user_lang'		=&gt; (string) $bot_lang, 
-						'theme'			=&gt; (string) $bot_theme,
-						'user_options'	=&gt; 0)
-					);
-					$db-&gt;sql_query($sql);
-
-					$user_id = $db-&gt;sql_nextid();
-
-					// Add to Bots usergroup
-					$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', array(
-						'user_id'	=&gt; $user_id, 
-						'group_id'	=&gt; $group_id)
-					);
-					$db-&gt;sql_query($sql);
-
-					$sql = 'INSERT INTO ' . BOTS_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', array(
-						'user_id'		=&gt; (int) $user_id,
-						'bot_name'		=&gt; (string) $bot_name, 
-						'bot_active'	=&gt; (int) $bot_active, 
-						'bot_agent'		=&gt; (string) $bot_agent,
-						'bot_ip'		=&gt; (string) $bot_ip,)
-					);
-
-					$log = 'ADDED';
-				}
-				else
-				{
-					$sql = 'SELECT user_id 
-						FROM ' . BOTS_TABLE . &quot; 
-						WHERE bot_id = $id&quot;;
-					$result = $db-&gt;sql_query($sql);
-
-					if (!extract($db-&gt;sql_fetchrow($result)))
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['NO_BOT']);
-					}
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', array(
-						'theme'			=&gt; (string) $bot_theme,
-						'user_lang'		=&gt; (string) $bot_lang,)
-					) . &quot; WHERE user_id = $user_id&quot;;
-					$db-&gt;sql_query($sql);
-
-					$sql = 'UPDATE ' . BOTS_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', array(
-						'bot_name'		=&gt; (string) $bot_name, 
-						'bot_active'	=&gt; (int) $bot_active, 
-						'bot_agent'		=&gt; (string) $bot_agent,
-						'bot_ip'		=&gt; (string) $bot_ip,)
-					) . &quot; WHERE bot_id = $id&quot;;
-
-					$log = 'UPDATED';
-				}
-				$db-&gt;sql_query($sql);
-
-				$db-&gt;sql_transaction('commit');
-
-				add_log('admin', 'LOG_BOT_' . $log, $bot_name);
-				trigger_error($_CLASS['core_user']-&gt;lang['BOT_' . $log]);
-			}
-		}
-		else if ($id)
-		{
-			$sql = 'SELECT b.*, u.user_lang, u.theme 
-				FROM ' . BOTS_TABLE . ' b, ' . USERS_TABLE . &quot; u
-				WHERE b.bot_id = $id
-					AND u.user_id = b.user_id&quot;;
-			$result = $db-&gt;sql_query($sql);
-
-			if (!extract($db-&gt;sql_fetchrow($result)))
-			{
-				trigger_error($_CLASS['core_user']-&gt;lang['NO_BOT']);
-			}
-			$db-&gt;sql_freeresult($result);
-
-			$bot_lang = $user_lang;
-			$bot_theme = $theme;
-		}
-
-		$s_active_options = '';
-		foreach (array('0' =&gt; 'NO', '1' =&gt; 'YES') as $value =&gt; $lang)
-		{
-			$selected = ($bot_active == $value) ? ' selected=&quot;selected&quot;' : '';
-			$s_active_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
-		}
-
-		$theme_select = theme_select($bot_theme);
-		$lang_select = language_select($bot_lang);
-
-		$l_title = ($action == 'edit') ? 'EDIT' : 'ADD';
-
-		// Output relevant page
-		adm_page_header($_CLASS['core_user']-&gt;lang['BOT_' . $l_title]);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_' . $l_title]; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_EDIT_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_bots&amp;action=$action&amp;id=$id&quot;); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_' . $l_title]; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if (sizeof($error))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_NAME']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_NAME_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;bot_name&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $bot_name; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_STYLE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_STYLE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;bot_theme&quot;&gt;&lt;?php echo $theme_select; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_LANG']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_LANG_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;bot_lang&quot;&gt;&lt;?php echo $lang_select; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_ACTIVE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;bot_active&quot;&gt;&lt;?php echo $s_active_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_AGENT']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_AGENT_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;bot_agent&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $bot_agent; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_IP']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_IP_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;bot_ip&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $bot_ip; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		adm_page_footer();
-
-		break;
-}
-
-// Output relevant page
-adm_page_header($_CLASS['core_user']-&gt;lang['BOTS']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOTS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOTS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php adminlink('forums&amp;file=admin_bots'); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_NAME']; ?&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_LAST_VISIT']; ?&gt;&lt;/th&gt;
-		&lt;th colspan=&quot;3&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTIONS']; ?&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-$s_options = '';
-foreach (array('activate' =&gt; 'BOT_ACTIVATE', 'deactivate' =&gt; 'BOT_DEACTIVATE', 'delete' =&gt; 'DELETE') as $value =&gt; $lang)
-{
-	$s_options .= '&lt;option value=&quot;' . $value . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
-}
-
-$sql = 'SELECT b.bot_id, b.bot_name, b.bot_active, u.user_lastvisit 
-	FROM ' . BOTS_TABLE . ' b, ' . USERS_TABLE . ' u
-	WHERE u.user_id = b.user_id
-	ORDER BY u.user_lastvisit DESC';
-$result = $db-&gt;sql_query($sql);
-
-$row_class = 'row1';
-while ($row = $db-&gt;sql_fetchrow($result))
-{
-	$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-	$active_lang = (!$row['bot_active']) ? 'BOT_ACTIVATE' : 'BOT_DEACTIVATE';
-	$active_value = (!$row['bot_active']) ? 'activate' : 'deactivate';
-	$id = $row['bot_id'];
-
-?&gt;	
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;50%&quot;&gt;&lt;?php echo $row['bot_name']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;15%&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php echo ($row['user_lastvisit']) ?  $_CLASS['core_user']-&gt;format_date($row['user_lastvisit']) : $_CLASS['core_user']-&gt;lang['BOT_NEVER']; ?&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;1%&quot;align=&quot;center&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_bots&amp;id=$id&amp;action=$active_value&quot;); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$active_lang]; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;1%&quot; align=&quot;center&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_bots&amp;id=$id&amp;action=edit&quot;); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;1%&quot; align=&quot;center&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_bots&amp;id=$id&amp;action=delete&quot;); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;1%&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $id; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-}
-$db-&gt;sql_freeresult($result);
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;6&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOT_ADD']; ?&gt;&quot; /&gt;&lt;/td&gt;
-				&lt;td align=&quot;right&quot;&gt;&lt;select name=&quot;action&quot;&gt;&lt;?php echo $s_options; ?&gt;&lt;/select&gt; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Deleted: trunk/includes/forums/admin/admin_groups.php
===================================================================
--- trunk/includes/forums/admin/admin_groups.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_groups.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,902 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_groups.php,v 1.18 2004/05/02 13:05:36 acydburn Exp $
-//
-// FILENAME  : admin_groups.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001,2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// TODO
-// Avatar gallery ...
-// Mass user pref setting via group membership
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-require_once($site_file_root.'includes/forums/functions_user.'.$phpEx);
-
-// Do we have general permissions?
-if (!$_CLASS['auth']-&gt;acl_get('a_group'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Check and set some common vars
-$mode		= request_var('mode', '');
-$action		= (isset($_POST['add'])) ? 'add' : ((isset($_POST['addusers'])) ? 'addusers' : request_var('action', ''));
-$group_id	= request_var('g', 0);
-$mark_ary   = request_var('mark', array(0));
-$name_ary	= request_var('usernames', '');
-$leader		= request_var('leader', 0);
-$default	= request_var('default', 0);
-$start		= request_var('start', 0);
-$update		= (isset($_POST['update'])) ? true : false;
-$confirm	= (isset($_POST['confirm'])) ? true : false;
-$cancel		= (isset($_POST['cancel'])) ? true : false;
-
-// Clear some vars
-$can_upload = (file_exists($config['avatar_path']) &amp;&amp; is_writeable($config['avatar_path']) &amp;&amp; $file_uploads) ? true : false;
-
-$group_type = $group_name = $group_desc = $group_colour = $group_rank = $group_avatar = false;
-
-// Grab basic data for group, if group_id is set and exists
-if ($group_id)
-{
-	$sql = 'SELECT * 
-		FROM ' . GROUPS_TABLE . &quot; 
-		WHERE group_id = $group_id&quot;;
-	$result = $db-&gt;sql_query($sql);
-
-	if (!extract($db-&gt;sql_fetchrow($result)))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-	}
-	$db-&gt;sql_freeresult($result);
-}
-
-switch ($mode)
-{
-	case 'manage':
-		// Page header
-		adm_page_header($_CLASS['core_user']-&gt;lang['MANAGE']);
-
-		// Common javascript
-?&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-function marklist(match, status)
-{
-	len = eval('document.' + match + '.length');
-	for (i = 0; i &lt; len; i++)
-	{
-		eval('document.' + match + '.elements[i].checked = ' + status);
-	}
-}
-
-//--&gt;
-&lt;/script&gt;
-
-&lt;?php
-
-		// Which page?
-		switch ($action)
-		{
-			case 'approve':
-			case 'demote':
-			case 'promote':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-				}
-
-				group_user_attributes($action, $group_id, $mark_ary, false, $group_name);
-
-				switch ($action)
-				{
-					case 'demote':
-						$message = 'GROUP_MODS_DEMOTED';
-						break;
-					case 'promote':
-						$message = 'GROUP_MODS_PROMOTED';
-						break;
-					case 'approve':
-						$message = 'USERS_APPROVED';
-						break;
-				}
-				trigger_error($_CLASS['core_user']-&gt;lang[$message]);
-				break;
-
-			case 'default':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-				}
-
-				if (!$mark_ary)
-				{
-					$start = 0;
-					do
-					{
-						$sql = 'SELECT user_id 
-							FROM ' . USER_GROUP_TABLE . &quot;
-							WHERE group_id = $group_id 
-							ORDER BY user_id 
-							LIMIT $start, 200&quot;;
-						$result = $db-&gt;sql_query($sql);
-
-						$mark_ary = array();
-						if ($row = $db-&gt;sql_fetchrow($result))
-						{
-							do
-							{
-								$mark_ary[] = $row['user_id'];
-							}
-							while ($row = $db-&gt;sql_fetchrow($result));
-
-							group_user_attributes('default', $group_id, $mark_ary, false, $group_name, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height);
-
-							$start = (sizeof($user_id_ary) &lt; 200) ? 0 : $start + 200;
-						}
-						else
-						{
-							$start = 0;
-						}
-						$db-&gt;sql_freeresult($result);
-					}
-					while ($start);
-				}
-				else
-				{
-					group_user_attributes('default', $group_id, $mark_ary, false, $group_name, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height);
-				}
-
-				trigger_error($_CLASS['core_user']-&gt;lang['GROUP_DEFS_UPDATED']);
-				break;
-
-			case 'deleteusers':
-			case 'delete':
-				if (!$cancel &amp;&amp; !$confirm)
-				{
-					adm_page_confirm($_CLASS['core_user']-&gt;lang['CONFIRM'], $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION']);
-				}
-				else
-				{
-					if (!$group_id)
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-					}
-
-					switch ($action)
-					{
-						case 'delete':
-							$error = group_delete($group_id, $group_name);
-							break;
-
-						case 'deleteusers':
-							$error = group_user_del($group_id, $mark_ary, false, $group_name);
-							break;
-					}
-
-					if ($error)
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang[$error]);
-					}
-
-					$message = ($action == 'delete') ? 'GROUP_DELETED' : 'GROUP_USERS_REMOVE';
-					trigger_error($_CLASS['core_user']-&gt;lang[$message]);
-				}
-				break;
-
-			case 'addusers':
-				if (!$group_id)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-				}
-
-				if (!$name_ary)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_USERS']);
-				}
-
-				$name_ary = array_unique(explode(&quot;\n&quot;, $name_ary));
-
-				// Add user/s to group
-				if ($error = group_user_add($group_id, false, $name_ary, $group_name, $default, $leader, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height))
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang[$error]);
-				}
-
-				$message = ($action == 'addleaders') ? 'GROUP_MODS_ADDED' : 'GROUP_USERS_ADDED';
-				trigger_error($_CLASS['core_user']-&gt;lang[$message]);
-				break;
-
-			case 'edit':
-			case 'add':
-
-				if ($action == 'edit' &amp;&amp; !$group_id)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-				}
-
-				// Did we submit?
-				if ($update)
-				{
-					$group_name	= request_var('group_name', '');
-					$group_desc	= request_var('group_description', '');
-					$group_type	= request_var('group_type', 0);
-
-					$colour		= request_var('group_colour', '');
-					$rank		= request_var('group_rank', 0);
-
-					$data['uploadurl']	= request_var('uploadurl', '');
-					$data['remotelink'] = request_var('remotelink', '');
-					$delete				= request_var('delete', '');
-					$receive_pm			= isset($_REQUEST['group_receive_pm']) ? 1 : 0;
-					$message_limit		= request_var('group_message_limit', 0);
-
-					if (!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl'] || $data['remotelink'])
-					{
-						$data['width']		= request_var('width', '');
-						$data['height']		= request_var('height', '');
-
-						// Avatar stuff
-						$var_ary = array(
-							'uploadurl'		=&gt; array('string', true, 5, 255), 
-							'remotelink'	=&gt; array('string', true, 5, 255), 
-							'width'			=&gt; array('string', true, 1, 3), 
-							'height'		=&gt; array('string', true, 1, 3), 
-						);
-
-						if (!($error = validate_data($data, $var_ary)))
-						{
-							$data['user_id'] = &quot;g$group_id&quot;;
-
-							if ((!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl']) &amp;&amp; $can_upload)
-							{
-								list($avatar_type, $avatar, $avatar_width, $avatar_height) = avatar_upload($data, $error);
-							}
-							else if ($data['remotelink'])
-							{
-								list($avatar_type, $avatar, $avatar_width, $avatar_height) = avatar_remote($data, $error);
-							}
-						}
-					}
-					else if ($delete)
-					{
-						$avatar = '';
-						$avatar_type = $avatar_width = $avatar_height = 0;
-					}
-
-					if (($avatar &amp;&amp; $group_avatar != $avatar) || $delete)
-					{
-						avatar_delete($group_avatar);
-					}
-
-					// Only set the rank, colour, etc. if it's changed or if we're adding a new
-					// group. This prevents existing group members being updated if no changes 
-					// were made.
-					foreach (array('rank', 'colour', 'avatar', 'avatar_type', 'avatar_width', 'avatar_height', 'receive_pm', 'message_limit') as $test)
-					{
-						${'group_' . $test} = ($action == 'add' || (isset($$test) &amp;&amp; $$test != ${'group_' . $test})) ? $$test : false;
-					}
-
-					if (!($error = group_create($group_id, $group_type, $group_name, $group_description, $group_colour, $group_rank, $group_avatar, $group_avatar_type, $group_avatar_width, $group_avatar_height, $group_receive_pm, $group_message_limit)))
-					{
-						$message = ($action == 'edit') ? 'GROUP_UPDATED' : 'GROUP_CREATED';
-						trigger_error($message);
-					}
-				}
-				else if (!$group_id)
-				{
-					$group_name = request_var('group_name', '');
-					$group_description = $group_colour = $group_avatar = '';
-					$group_type = GROUP_FREE;
-				}
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_EDIT_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php 
-
-				$sql = 'SELECT * 
-					FROM ' . RANKS_TABLE . '
-					WHERE rank_special = 1
-					ORDER BY rank_title';
-				$result = $db-&gt;sql_query($sql);
-
-				$rank_options = '&lt;option value=&quot;-1&quot;' . ((empty($group_rank)) ? 'selected=&quot;selected&quot; ' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['USER_DEFAULT'] . '&lt;/option&gt;';
-				if ($row = $db-&gt;sql_fetchrow($result))
-				{
-					do
-					{
-						$selected = (!empty($group_rank) &amp;&amp; $row['rank_id'] == $group_rank) ? ' selected=&quot;selected&quot;' : '';
-						$rank_options .= '&lt;option value=&quot;' . $row['rank_id'] . '&quot;' . $selected . '&gt;' . $row['rank_title'] . '&lt;/option&gt;';
-					}
-					while ($row = $db-&gt;sql_fetchrow($result));
-				}
-				$db-&gt;sql_freeresult($result);
-
-				$type_free		= ($group_type == GROUP_FREE) ? ' checked=&quot;checked&quot;' : '';
-				$type_open		= ($group_type == GROUP_OPEN) ? ' checked=&quot;checked&quot;' : '';
-				$type_closed	= ($group_type == GROUP_CLOSED) ? ' checked=&quot;checked&quot;' : '';
-				$type_hidden	= ($group_type == GROUP_HIDDEN) ? ' checked=&quot;checked&quot;' : '';
-
-				if ($group_avatar)
-				{
-					switch ($group_avatar_type)
-					{
-						case AVATAR_UPLOAD:
-							$avatar_img = $config['avatar_path'] . '/';
-							break;
-						case AVATAR_GALLERY:
-							$avatar_img = $config['avatar_gallery_path'] . '/';
-							break;
-					}
-					$avatar_img .= $group_avatar;
-
-					$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $group_avatar_width . '&quot; height=&quot;' . $group_avatar_height . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
-				}
-				else
-				{
-					$avatar_img = '&lt;img src=&quot;images/no_avatar.gif&quot; alt=&quot;&quot; /&gt;';
-				}
-
-?&gt;
-
-&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-
-function swatch()
-{
-	window.open('&lt;?php echo adminlink('forums&amp;file=swatch'); ?&gt;?form=settings&amp;name=group_colour', '_swatch', 'HEIGHT=115,resizable=yes,scrollbars=no,WIDTH=636');
-	return false;
-}
-
-//--&gt;
-&lt;/script&gt;
-
-&lt;form name=&quot;settings&quot; method=&quot;post&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;action=$action&amp;g=$group_id&quot;); ?&gt;&quot;&lt;?php echo ($can_upload) ? ' enctype=&quot;multipart/form-data&quot;' : ''; ?&gt;&gt;&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_DETAILS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				if (sizeof($error))
-				{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_NAME']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php 
-	
-				if ($group_type != GROUP_SPECIAL)
-				{
-		
-?&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_name&quot; value=&quot;&lt;?php echo (!empty($group_name)) ? $group_name : ''; ?&gt;&quot; size=&quot;40&quot; maxlength=&quot;40&quot; /&gt;&lt;?php
-			
-				}
-				else
-				{
-				
-?&gt;&lt;b&gt;&lt;?php echo ($group_type == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $group_name] : $group_name; ?&gt;&lt;/b&gt;&lt;?php
-	
-				}
-	
-?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_DESC']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_description&quot; value=&quot;&lt;?php echo (!empty($group_description)) ? $group_description : ''; ?&gt;&quot; size=&quot;40&quot; maxlength=&quot;255&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				if ($group_type != GROUP_SPECIAL)
-				{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_TYPE']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_TYPE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;group_type&quot; value=&quot;&lt;?php echo GROUP_FREE . '&quot;' . $type_free; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_OPEN']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;group_type&quot; value=&quot;&lt;?php echo GROUP_OPEN . '&quot;' . $type_open; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_REQUEST']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;group_type&quot; value=&quot;&lt;?php echo GROUP_CLOSED . '&quot;' . $type_closed; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_CLOSED']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;group_type&quot; value=&quot;&lt;?php echo GROUP_HIDDEN . '&quot;' . $type_hidden; ?&gt;&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_HIDDEN']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_SETTINGS_SAVE']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_RECEIVE_PM']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;group_receive_pm&quot;&lt;?php echo ($group_receive_pm) ? ' checked=&quot;checked&quot;' : ''; ?&gt; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_MESSAGE_LIMIT']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; maxlength=&quot;4&quot; size=&quot;4&quot; name=&quot;group_message_limit&quot; value=&quot;&lt;?php echo $group_message_limit; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_COLOR']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_COLOR_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_colour&quot; value=&quot;&lt;?php echo (!empty($group_colour)) ? $group_colour : ''; ?&gt;&quot; size=&quot;6&quot; maxlength=&quot;6&quot; /&gt; &nbsp; [ &lt;a href=&quot;&lt;?php echo adminlink('forums&amp;file=swatch'); ?&gt;&quot; onclick=&quot;swatch();return false&quot; target=&quot;_swatch&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['COLOUR_SWATCH']; ?&gt;&lt;/a&gt; ]&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_RANK']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;group_rank&quot;&gt;&lt;?php echo $rank_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_AVATAR']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CURRENT_IMAGE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo sprintf($_CLASS['core_user']-&gt;lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)); ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;?php echo $avatar_img; ?&gt;&lt;br /&gt;&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; /&gt;&nbsp;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_AVATAR']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			// Can we upload?
-			if ($can_upload)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_FILE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;&lt;?php echo $config['avatar_max_filesize']; ?&gt;&quot; /&gt;&lt;input class=&quot;post&quot; type=&quot;file&quot; name=&quot;uploadfile&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_URL']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_URL_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;uploadurl&quot; size=&quot;40&quot; value=&quot;&lt;?php echo $avatar_url; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_AVATAR']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_AVATAR_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;remotelink&quot; size=&quot;40&quot; value=&quot;&lt;?php echo $avatar_url; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_SIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_SIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;width&quot; size=&quot;3&quot; value=&quot;&lt;?php echo $group_avatar_width; ?&gt;&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px X &lt;/span&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;height&quot; size=&quot;3&quot; value=&quot;&lt;?php echo $group_avatar_height; ?&gt;&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			// Do we have a gallery?
-			if ($config['null'] &amp;&amp; !$display_gallery)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_GALLERY']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;displaygallery&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_GALLERY']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-			}
-
-			// Do we want to display it?
-			if ($config['null'] &amp;&amp; $display_gallery)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_GALLERY']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_CATEGORY']; ?&gt;: &lt;/span&gt;&lt;select name=&quot;avatarcat&quot;&gt;{S_CAT_OPTIONS}&lt;/select&gt;&nbsp; &lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_PAGE']; ?&gt;: &lt;/span&gt;&lt;select name=&quot;avatarpage&quot;&gt;{S_PAGE_OPTIONS}&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; name=&quot;avatargallery&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-		
-			&lt;!-- BEGIN avatar_row --&gt;
-			&lt;tr&gt; 
-				&lt;!-- BEGIN avatar_column --&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;img src=&quot;{avatar_row.avatar_column.AVATAR_IMAGE}&quot; alt=&quot;{avatar_row.avatar_column.AVATAR_NAME}&quot; title=&quot;{avatar_row.avatar_column.AVATAR_NAME}&quot; /&gt;&lt;/td&gt;
-				&lt;!-- END avatar_column --&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;!-- BEGIN avatar_option_column --&gt;
-				&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;avatarselect&quot; value=&quot;{avatar_row.avatar_option_column.S_OPTIONS_AVATAR}&quot; /&gt;&lt;/td&gt;
-				&lt;!-- END avatar_option_column --&gt;
-			&lt;/tr&gt;
-			&lt;!-- END avatar_row --&gt;
-
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-
-				adm_page_footer();
-				break;
-		}
-
-		if ($mode == 'list' || $group_id)
-		{
-			if (!$group_id)
-			{
-				trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-			}
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_MEMBERS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_MEMBERS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form name=&quot;list&quot; method=&quot;post&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;g=$group_id&quot;); ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th width=&quot;55%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;3%&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;20%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JOINED']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;20%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['POSTS']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;2%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				// Total number of group leaders
-				$sql = 'SELECT COUNT(user_id) AS total_leaders 
-					FROM ' . USER_GROUP_TABLE . &quot; 
-					WHERE group_id = $group_id 
-						AND group_leader = 1&quot;;
-				$result = $db-&gt;sql_query($sql);
-
-				$total_leaders = ($row = $db-&gt;sql_fetchrow($result)) ? $row['total_leaders'] : 0;
-				$db-&gt;sql_freeresult($result);
-
-				// Total number of group members (non-leaders)
-				$sql = 'SELECT COUNT(user_id) AS total_members 
-					FROM ' . USER_GROUP_TABLE . &quot; 
-					WHERE group_id = $group_id 
-						AND group_leader &lt;&gt; 1&quot;;
-				$result = $db-&gt;sql_query($sql);
-
-				$total_members = ($row = $db-&gt;sql_fetchrow($result)) ? $row['total_members'] : 0;
-				$db-&gt;sql_freeresult($result);
-
-				// Grab the members
-				$sql = 'SELECT u.user_id, u.username, u.user_regdate, u.user_posts, u.group_id, ug.group_leader, ug.user_pending 
-					FROM ' . USERS_TABLE . ' u, ' . USER_GROUP_TABLE . &quot; ug 
-					WHERE ug.group_id = $group_id 
-						AND u.user_id = ug.user_id 
-					ORDER BY ug.group_leader DESC, ug.user_pending DESC, u.username 
-					LIMIT $start, &quot; . $config['topics_per_page'];
-				$result = $db-&gt;sql_query($sql);
-
-				$leader = $member = 0;
-				$group_data = array();
-				if ($row = $db-&gt;sql_fetchrow($result))
-				{
-					do
-					{
-						$type = ($row['group_leader']) ? 'leader' : 'member';
-
-						$group_data[$type][$$type]['user_id'] = $row['user_id'];
-						$group_data[$type][$$type]['group_id'] = $row['group_id'];
-						$group_data[$type][$$type]['username'] = $row['username'];
-						$group_data[$type][$$type]['user_regdate'] = $row['user_regdate'];
-						$group_data[$type][$$type]['user_posts'] = $row['user_posts'];
-						$group_data[$type][$$type]['user_pending'] = ($row['user_pending']) ? 1 : 0;
-
-						$$type++;
-					}
-					while ($row = $db-&gt;sql_fetchrow($result));
-				}
-				$db-&gt;sql_freeresult($result);
-
-				if ($group_type != GROUP_SPECIAL)
-				{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;5&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_LEAD']; ?&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					if (sizeof($group_data['leader']))
-					{
-						$row_class = '';
-						foreach ($group_data['leader'] as $row)
-						{
-							$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo adminlink('forums&amp;file=admin_users&amp;mode=edit&amp;u=' . $row['user_id']); ?&gt;&quot;&gt;&lt;?php echo $row['username']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo ($row['group_id'] == $group_id) ? $_CLASS['core_user']-&gt;lang['YES'] : $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;format_date($row['user_regdate'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']); ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['user_posts']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;checkbox&quot; type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $row['user_id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php	
-
-						}
-					}
-					else
-					{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUPS_NO_MODS']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					}
-				}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;5&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_APPROVED']; ?&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-				if (!empty($group_data['member']) &amp;&amp; sizeof($group_data['member']))
-				{
-					$pending = $group_data['member'][0]['user_pending'];
-
-					foreach ($group_data['member'] as $row)
-					{
-						if ($pending)
-						{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;5&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_PENDING']; ?&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-						}
-
-						$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo adminlink('forums&amp;file=admin_users&amp;mode=edit&amp;u=' . $row['user_id']); ?&gt;&quot;&gt;&lt;?php echo $row['username']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo ($row['group_id'] == $group_id) ? $_CLASS['core_user']-&gt;lang['YES'] : $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo ($row['user_regdate']) ? $_CLASS['core_user']-&gt;format_date($row['user_regdate'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']) : '-'; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['user_posts']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;checkbox&quot; type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $row['user_id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					}
-				}
-				else
-				{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUPS_NO_MEMBERS']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; align=&quot;right&quot;&gt;&lt;select name=&quot;action&quot;&gt;&lt;option class=&quot;sep&quot; value=&quot;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_OPTION']; ?&gt;&lt;/option&gt;&lt;?php
-
-				foreach(array('default' =&gt; 'DEFAULT', 'approve' =&gt; 'APPROVE', 'demote' =&gt; 'DEMOTE', 'promote' =&gt; 'PROMOTE', 'deleteusers' =&gt; 'DELETE') as $option =&gt; $lang)
-				{
-					echo '&lt;option value=&quot;' . $option . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['GROUP_' . $lang] . '&lt;/option&gt;';
-				}
-
-?&gt;&lt;/select&gt; &lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;table width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;1&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td valign=&quot;top&quot;&gt;&lt;?php echo on_page($total_members, $config['topics_per_page'], $start); ?&gt;&lt;/td&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;b&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('list', true);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('list', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/b&gt;&nbsp;&lt;br /&gt;&lt;span class=&quot;nav&quot;&gt;&lt;?php echo generate_pagination('admin_groups&amp;action=list&amp;mode=member&amp;g='.$group_id, $total_members, $config['topics_per_page'], $start); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_GROUP_LEADER']; ?&gt;:&lt;/b&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;leader&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;leader&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_GROUP_DEFAULT']; ?&gt;:&lt;/b&gt; &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_GROUP_DEFAULT_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;default&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;default&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAMES_EXPLAIN']; ?&gt;&lt;br /&gt;[ &lt;a href=&quot;&lt;?php echo getlink('Members_List&amp;mode=searchuser&amp;form=mod&amp;field=usernames'); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea name=&quot;usernames&quot; cols=&quot;40&quot; rows=&quot;5&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;addusers&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;/form&gt;
-
-&lt;?php
-
-			adm_page_footer();
-		}
-
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_MANAGE_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_DEF_GROUPS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_DEF_GROUPS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo adminlink('forums&amp;file=admin_groups&amp;mode='.$mode); ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th width=&quot;95%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE']; ?&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOTAL_MEMBERS']; ?&gt;&lt;/th&gt;
-		&lt;th colspan=&quot;3&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTIONS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-				$sql = 'SELECT g.group_id, g.group_name, g.group_type, COUNT(ug.user_id) AS total_members 
-					FROM (' . GROUPS_TABLE . ' g
-					LEFT JOIN ' . USER_GROUP_TABLE . ' ug USING (group_id)) 
-					GROUP BY g.group_id 
-					ORDER BY g.group_type ASC, g.group_name';
-				$result = $db-&gt;sql_query($sql);
-
-				$special = $normal = 0;
-				$group_ary = array();
-				while ($row = $db-&gt;sql_fetchrow($result) )
-				{
-					$type = ($row['group_type'] == GROUP_SPECIAL) ? 'special' : 'normal';
-
-					$group_ary[$type][$$type]['group_id'] = $row['group_id'];
-					$group_ary[$type][$$type]['group_name'] = $row['group_name'];
-					$group_ary[$type][$$type]['group_type'] = $row['group_type'];
-					$group_ary[$type][$$type]['total_members'] = $row['total_members'];
-
-					$$type++;
-				}
-				$db-&gt;sql_freeresult($result);
-
-				$special_toggle = false;
-				foreach ($group_ary as $type =&gt; $row_ary)
-				{
-					if ($type == 'special')
-					{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_GROUP']; ?&gt;: &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_name&quot; maxlength=&quot;30&quot; /&gt; &lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SPECIAL_GROUPS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SPECIAL_GROUPS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th width=&quot;95%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOTAL_MEMBERS']; ?&gt;&lt;/th&gt;
-		&lt;th colspan=&quot;3&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTIONS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					}
-					$row_class = '';
-					foreach ($row_ary as $row)
-					{
-						$row_class = ($row_class != 'row1') ? 'row1' : 'row2';
-
-						$group_id = $row['group_id'];
-						$group_name = (!empty($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]))? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'];
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td width=&quot;95%&quot; class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;action=list&amp;g=$group_id&quot;); ?&gt;&quot;&gt;&lt;?php echo $group_name;?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php echo $row['total_members']; ?&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;action=default&amp;g=$group_id&quot;); ?&gt;&quot;&gt;Default&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;action=edit&amp;g=$group_id&quot;); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php 
-	
-						echo ($row['group_type'] != GROUP_SPECIAL) ? '&lt;a href=&quot;'.adminlink(&quot;forums&amp;file=admin_groups&amp;mode=$mode&amp;action=delete&amp;g=$group_id&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;lang['DELETE'] . '&lt;/a&gt;' : $_CLASS['core_user']-&gt;lang['DELETE'];
-
-?&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					}
-				}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot;&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		adm_page_footer();
-		break;
-
-	// Setting groupwide preferences
-	case 'prefs':
-		adm_page_header($_CLASS['core_user']-&gt;lang['GROUP_PREFS']);
-
-		if ($update)
-		{
-			$user_lang	= request_var('lang', '');
-			$user_tz	= request_var('tz', 0.0);
-			$user_dst	= request_var('dst', 0);
-		}
-		else
-		{
-		}
-
-?&gt;
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_SETTINGS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_SETTINGS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_groups&amp;action=edit&amp;g=$group_id&quot;); ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;90%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_SETTINGS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_LANG']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;user_lang&quot;&gt;&lt;?php echo '&lt;option value=&quot;-1&quot; selected=&quot;selected&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_DEFAULT'] . '&lt;/option&gt;' . language_select(); ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_TIMEZONE']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;user_tz&quot;&gt;&lt;?php echo '&lt;option value=&quot;-14&quot; selected=&quot;selected&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_DEFAULT'] . '&lt;/option&gt;' . tz_select(); ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_DST']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_dst&quot; value=&quot;0&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLED']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;user_dst&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['ENABLED']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;user_dst&quot; value=&quot;-1&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['USER_DEFAULT']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submitprefs&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		adm_page_footer();
-		break;
-
-	default:
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_MODE']);
-}
-
-exit;
-
-?&gt;
\ No newline at end of file

Deleted: trunk/includes/forums/admin/admin_users.php
===================================================================
--- trunk/includes/forums/admin/admin_users.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/admin/admin_users.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,2025 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_users.php,v 1.18 2004/05/31 17:59:52 acydburn Exp $
-//
-// FILENAME  : admin_users.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001,2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have permission?
-if (!$_CLASS['auth']-&gt;acl_get('a_user'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['No_admin']);
-}
-
-
-// Include files
-require_once($site_file_root.'includes/forums/functions_user.'.$phpEx);
-require_once($site_file_root.'includes/forums/functions_profile_fields.'.$phpEx);
-
-$_CLASS['core_user']-&gt;add_lang(array('posting', 'ucp'), 'Forums');
-
-//
-// Get and set basic vars
-//
-$mode		= request_var('mode', 'overview');
-$action		= request_var('action', '');
-
-$username	= request_var('username', '');
-$user_id	= request_var('u', 0);
-$gid		= request_var('g', 0);
-
-$start		= request_var('start', 0);
-$ip			= request_var('ip', '');
-$start		= request_var('start', 0);
-$delete		= request_var('delete', '');
-$deletetype	= request_var('deletetype', '');
-$marked		= request_var('mark', 0);
-$quicktools	= request_var('quicktools', '');
-
-$st			= request_var('st', 0);
-$sk			= request_var('sk', 'a');
-$sd			= request_var('sd', 'd');
-
-$submit		= (isset($_POST['update'])) ? true : false;
-$confirm	= (isset($_POST['confirm'])) ? true : false;
-$cancel		= (isset($_POST['cancel'])) ? true : false;
-$preview	= (isset($_POST['preview'])) ? true : false;
-$deletemark = (isset($_POST['delmarked'])) ? true : false;
-$deleteall	= (isset($_POST['delall'])) ? true : false;
-
-$error = array();
-$colspan = 0;
-
-//
-// Whois output
-//
-if ($action == 'whois')
-{
-	// Output relevant page
-	adm_page_header($_CLASS['core_user']-&gt;lang['WHOIS']);
-
-	if ($ip &amp;&amp; $domain = gethostbyaddr($ip))
-	{
-?&gt;
-
-&lt;table class=&quot;bg&quot; width=&quot;90%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;IP whois for &lt;?php echo $domain; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php
-
-		if ($ipwhois = user_ipwhois($ip))
-		{
-			$ipwhois = preg_replace('#(\s+?)([\w\-\._\+]+?@[\w\-\.]+?)(\s+?)#s', '\1&lt;a href=&quot;mailto:\2&quot;&gt;\2&lt;/a&gt;\3', $ipwhois);
-			echo '&lt;br /&gt;&lt;pre align=&quot;left&quot;&gt;' . trim($ipwhois) . '&lt;/pre&gt;';
-		}
-
-?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;?php
-
-	}
-
-	adm_page_footer();
-}
-
-//
-// Obtain user information if appropriate
-//
-if ($username || $user_id)
-{
-	$session_time = 0;
-	$sql_where = ($user_id) ? &quot;user_id = $user_id&quot; : &quot;username = '&quot; . $db-&gt;sql_escape($username) . &quot;'&quot;;
-	$sql = ($action == 'overview') ? 'SELECT u.*, s.session_time, s.session_page, s.session_ip FROM (' . USERS_TABLE . ' u LEFT JOIN ' . SESSIONS_TABLE . &quot; s ON s.session_user_id = u.user_id) WHERE u.$sql_where ORDER BY s.session_time DESC&quot; : 'SELECT * FROM ' . USERS_TABLE . &quot; WHERE $sql_where&quot;;
-	$result = $db-&gt;sql_query($sql);
-
-	if (!extract($db-&gt;sql_fetchrow($result)))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_USER']);
-	}
-	$db-&gt;sql_freeresult($result);
-
-	if ($session_time &gt; $user_lastvisit)
-	{
-		$user_lastvisit = $session_time;
-		$user_lastpage = $session_page;
-	}
-	
-	$user_password = '';
-}
-
-// Output page
-adm_page_header($_CLASS['core_user']-&gt;lang['MANAGE']);
-
-
-//
-// Output forms
-//
-
-// Begin program
-if ($username || $user_id)
-{
-	// Generate overall &quot;header&quot; for user admin
-	$form_options = '';
-	$forms_ary = array('overview' =&gt; 'OVERVIEW', 'feedback' =&gt; 'FEEDBACK', 'profile' =&gt; 'PROFILE', 'prefs' =&gt; 'PREFS', 'avatar' =&gt; 'AVATAR', 'sig' =&gt; 'SIG', 'groups' =&gt; 'GROUP', 'perm' =&gt; 'PERM', 'attach' =&gt; 'ATTACH');
-
-	foreach ($forms_ary as $value =&gt; $lang)
-	{
-		$selected = ($mode == $value) ? ' selected=&quot;selected&quot;' : '';
-		$form_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang['USER_ADMIN_' . $lang]  . '&lt;/option&gt;';
-	}
-
-	$pagination = '';
-
-?&gt;
-
-&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-
-var form_name = 'admin';
-var text_name = 'signature';
-
-// Define the bbCode tags
-bbcode = new Array();
-bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]');
-imageTag = false;
-
-// Helpline messages
-b_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_B_HELP']; ?&gt;&quot;;
-i_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_I_HELP']; ?&gt;&quot;;
-u_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_U_HELP']; ?&gt;&quot;;
-q_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_Q_HELP']; ?&gt;&quot;;
-c_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_C_HELP']; ?&gt;&quot;;
-l_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_L_HELP']; ?&gt;&quot;;
-o_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_O_HELP']; ?&gt;&quot;;
-p_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_P_HELP']; ?&gt;&quot;;
-w_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_W_HELP']; ?&gt;&quot;;
-a_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_A_HELP']; ?&gt;&quot;;
-s_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_S_HELP']; ?&gt;&quot;;
-f_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_F_HELP']; ?&gt;&quot;;
-e_help = &quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_E_HELP']; ?&gt;&quot;;
-
-//--&gt;
-&lt;/script&gt;
-&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; src=&quot;editor.js&quot;&gt;&lt;/script&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;admin&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_users&amp;mode=$mode&amp;u=$user_id&quot;); ?&gt;&quot;&lt;?php echo ($file_uploads) ? ' enctype=&quot;multipart/form-data&quot;' : ''; ?&gt;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORM']; ?&gt;: &lt;select name=&quot;mode&quot; onchange=&quot;if (this.options[this.selectedIndex].value != '') this.form.submit();&quot;&gt;&lt;?php echo $form_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;bg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-&lt;?php
-
-	if (sizeof($error))
-	{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row3&quot; colspan=&quot;&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;error&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-	}
-
-
-	switch ($mode)
-	{
-		case 'overview':
-
-			if ($submit)
-			{
-				if ($delete &amp;&amp; $user_type != USER_FOUNDER)
-				{
-					if (!$_CLASS['auth']-&gt;acl_get('a_userdel'))
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-					}
-
-					if (!$cancel &amp;&amp; !$confirm)
-					{
-						adm_page_confirm($_CLASS['core_user']-&gt;lang['CONFIRM'], $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION']);
-					}
-					else if (!$cancel) 
-					{
-						user_delete($deletetype, $user_id);
-
-						add_log('admin', 'LOG_USER_DELETED', $username);
-						trigger_error($_CLASS['core_user']-&gt;lang['USER_DELETED']);
-					}
-				}
-
-				// Handle quicktool actions
-				if ($quicktools &amp;&amp; $user_type != USER_FOUNDER)
-				{
-					switch ($quicktools)
-					{
-						case 'banuser':
-						case 'banemail':
-						case 'banip':
-							$ban = array();
-
-							switch ($quicktools)
-							{
-								case 'banuser':
-									$ban[] = $username;
-									$reason = 'USER_ADMIN_BAN_NAME_REASON';
-									$log = 'LOG_BAN_USERNAME_USER';
-									break;
-
-								case 'banemail':
-									$ban[] = $user_email;
-									$reason = 'USER_ADMIN_BAN_EMAIL_REASON';
-									$log = 'LOG_BAN_EMAIL_USER';
-									break;
-
-								case 'banip':
-									$ban[] = $user_ip;
-
-									$sql = 'SELECT DISTINCT poster_ip 
-										FROM ' . POSTS_TABLE . &quot; 
-										WHERE poster_id = $user_id&quot;;
-									$result = $db-&gt;sql_query($sql);
-
-									while ($row = $db-&gt;sql_fetchrow($result))
-									{
-										$ban[] = $row['poster_ip'];
-									}
-									$db-&gt;sql_freeresult($result);
-
-									$reason = 'USER_ADMIN_BAN_IP_REASON';
-									$log = 'LOG_BAN_IP_USER';
-									break;
-							}
-
-							user_ban(substr($quicktools, 3), $ban, 0, 0, 0, $_CLASS['core_user']-&gt;lang[$reason]);
-
-							add_log('user', $user_id, $log);
-
-							trigger_error($_CLASS['core_user']-&gt;lang['BAN_UPDATE_SUCESSFUL']);
-
-							break;
-
-						case 'reactivate':
-
-							if ($config['email_enable'])
-							{
-								require_once($site_file_root.'includes/forums/functions_messenger.'.$phpEx);
-
-								$user_actkey = gen_rand_string(10);
-								$key_len = 54 - (strlen($server_url));
-								$key_len = ($key_len &gt; 6) ? $key_len : 6;
-								$user_actkey = substr($user_actkey, 0, $key_len);
-
-								user_active_flip($user_id, $user_type, $user_actkey, $username);
-
-								$messenger = new messenger();
-
-								$messenger-&gt;template('user_welcome_inactive', $user_lang);
-								$messenger-&gt;subject();
-
-								$messenger-&gt;replyto($config['board_contact']);
-								$messenger-&gt;to($user_email, $username);
-
-								$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-								$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-								$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-								$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
-
-								$messenger-&gt;assign_vars(array(
-									'SITENAME'		=&gt; $config['sitename'],
-									'WELCOME_MSG'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $config['sitename']),
-									'USERNAME'		=&gt; $username,
-									'PASSWORD'		=&gt; $password_confirm,
-									'EMAIL_SIG'		=&gt; str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']),
-
-									'U_ACTIVATE'	=&gt; getlink(&quot;Control_Panel&amp;mode=activate&amp;u=$user_id&amp;k=$user_actkey&quot;))
-								);
-
-								$messenger-&gt;send(NOTIFY_EMAIL);
-								$messenger-&gt;queue-&gt;save();
-
-								add_log('admin', 'LOG_USER_REACTIVATE', $username);
-								add_log('user', $user_id, 'LOG_USER_REACTIVATE_USER');
-
-								trigger_error($_CLASS['core_user']-&gt;lang['USER_ADMIN_REACTIVATE']);
-							}
-
-							break;
-
-						case 'active':
-
-							user_active_flip($user_id, $user_type, false, $username);
-
-							$message = ($user_type == USER_NORMAL) ? 'USER_ADMIN_INACTIVE' : 'USER_ADMIN_ACTIVE';
-							$log = ($user_type == USER_NORMAL) ? 'LOG_USER_INACTIVE' : 'LOG_USER_ACTIVE';
-
-							add_log('admin', $log, $username);
-							add_log('user', $user_id, $log . '_USER');
-
-							trigger_error($_CLASS['core_user']-&gt;lang[$message]);
-							break;
-
-						case 'moveposts':
-
-							if (!($new_forum_id = request_var('new_f', 0)))
-							{
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_users&amp;action=$action&amp;quicktools=moveposts&amp;u=$user_id&quot;); ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_MOVE_POSTS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_POSTS_EXPLAIN']; ?&gt;&lt;br /&gt;&lt;br /&gt;&lt;select name=&quot;new_f&quot;&gt;&lt;?php 
-	
-							echo make_forum_select(false, false, false, true);
-			
-?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-&lt;?php
-
-								adm_page_footer();
-							}
-							else
-							{
-								// Two stage?
-								// Move topics comprising only posts from this user
-								$topic_id_ary = array();
-								$forum_id_ary = array($new_forum_id);
-
-								$sql = 'SELECT topic_id, COUNT(post_id) AS total_posts 
-									FROM ' . POSTS_TABLE . &quot; 
-									WHERE poster_id = $user_id
-										AND forum_id &lt;&gt; $new_forum_id
-									GROUP BY topic_id&quot;;
-								$result = $db-&gt;sql_query($sql);
-
-								while ($row = $db-&gt;sql_fetchrow($result))
-								{
-									$topic_id_ary[$row['topic_id']] = $row['total_posts'];
-								}
-								$db-&gt;sql_freeresult($result);
-
-								$sql = 'SELECT topic_id, forum_id, topic_title, topic_replies, topic_replies_real 
-									FROM ' . TOPICS_TABLE . ' 
-									WHERE topic_id IN (' . implode(', ', array_keys($topic_id_ary)) . ')';
-								$result = $db-&gt;sql_query($sql);
-
-								$move_topic_ary = $move_post_ary = array();
-								while ($row = $db-&gt;sql_fetchrow($result))
-								{
-									if (max($row['topic_replies'], $row['topic_replies_real']) + 1 == $topic_id_ary[$row['topic_id']])
-									{
-										$move_topic_ary[] = $row['topic_id'];
-									}
-									else
-									{
-										$move_post_ary[$row['topic_id']]['title'] = $row['topic_title'];
-										$move_post_ary[$row['topic_id']]['attach'] = ($row['attach']) ? 1 : 0;
-									}
-
-									$forum_id_ary[] = $row['forum_id'];
-								}
-								$db-&gt;sql_freeresult($result);
-
-								// Entire topic comprises posts by this user, move these topics
-								if (sizeof($move_topic_ary))
-								{
-									move_topics($move_topic_ary, $new_forum_id, false);
-								}
-
-								if (sizeof($move_post_ary))
-								{
-									// Create new topic
-									// Update post_ids, report_ids, attachment_ids
-									foreach ($move_post_ary as $topic_id =&gt; $post_ary)
-									{
-										// Create new topic
-										$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', array(
-											'topic_poster'				=&gt; $user_id,
-											'topic_time'				=&gt; time(),
-											'forum_id' 					=&gt; $new_forum_id,
-											'icon_id'					=&gt; 0,
-											'topic_approved'			=&gt; 1, 
-											'topic_title' 				=&gt; $post_ary['title'],
-											'topic_first_poster_name'	=&gt; $username,
-											'topic_type'				=&gt; POST_NORMAL,
-											'topic_time_limit'			=&gt; 0,
-											'topic_attachment'			=&gt; $post_ary['attach'],)
-										);
-										$db-&gt;sql_query($sql);
-
-										$new_topic_id = $db-&gt;sql_nextid();
-
-										// Move posts
-										$sql = 'UPDATE ' . POSTS_TABLE . &quot;
-											SET forum_id = $new_forum_id, topic_id = $new_topic_id 
-											WHERE topic_id = $topic_id
-												AND poster_id = $user_id&quot;;
-										$db-&gt;sql_query($sql);
-
-										if ($post_ary['attach'])
-										{
-											$sql = 'UPDATE ' . ATTACHMENTS_TABLE . &quot;
-												SET topic_id = $new_topic_id
-												WHERE topic_id = $topic_id
-													AND poster_id = $user_id&quot;;
-											$db-&gt;sql_query($sql);
-										}
-
-										$new_topic_id_ary[] = $new_topic_id;
-									}
-								}
-
-								$forum_id_ary = array_unique($forum_id_ary);
-								$topic_id_ary = array_unique(array_merge($topic_id_ary, $new_topic_id_ary));
-
-								sync('reported', 'topic_id', $topic_id_ary);
-								sync('topic', 'topic_id', $topic_id_ary);
-								sync('forum', 'forum_id', $forum_id_ary);
-							}
-
-							break;
-					}
-
-					$sql = 'SELECT forum_name
-						FROM ' . TOPICS_TABLE . &quot; 
-						WHERE topic_id = $new_forum_id&quot;;
-					$result = $db-&gt;sql_query($sql);
-
-					extract($db-&gt;sql_fetchrow($result));
-					$db-&gt;sql_freeresult($result);
-
-					add_log('admin', 'LOG_USER_MOVE_POSTS', $forum_name, $username);
-					add_log('user', $user_id, 'LOG_USER_MOVE_POSTS_USER', $forum_name);
-
-					trigger_error($_CLASS['core_user']-&gt;lang['USER_ADMIN_MOVE']);
-				}
-
-				// Handle registration info updates
-				$var_ary = array(
-					'username'			=&gt; (string) $username, 
-					'user_founder'		=&gt; (int) $user_founder, 
-					'user_type'			=&gt; (int) $user_type, 
-					'user_email'		=&gt; (string) $user_email, 
-					'email_confirm'		=&gt; (string) '',
-					'user_password'		=&gt; (string) '', 
-					'password_confirm'	=&gt; (string) '', 
-					'user_warnings'		=&gt; (int) $user_warnings, 
-				);
-
-				foreach ($var_ary as $var =&gt; $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'password_confirm'	=&gt; array('string', true, $config['min_pass_chars'], $config['max_pass_chars']), 
-					'user_password'		=&gt; array('string', true, $config['min_pass_chars'], $config['max_pass_chars']), 
-					'user_email'		=&gt; array(
-						array('string', false, 6, 60), 
-						array('email', $email)), 
-					'email_confirm'		=&gt; array('string', true, 6, 60), 
-					'user_warnings'		=&gt; array('num', 0, $config['max_warnings']), 
-				);
-
-				// Check username if altered
-				if ($username != $data['username'])
-				{
-					$var_ary += array(
-						'username'			=&gt; array(
-							array('string', false, $config['min_name_chars'], $config['max_name_chars']), 
-							array('username', $username)),
-					);
-				}
-
-				$error = validate_data($data, $var_ary);
-
-				if ($data['user_password'] &amp;&amp; $data['password_confirm'] != $data['user_password'])
-				{
-					$error[] = 'NEW_PASSWORD_ERROR';
-				}
-
-				if ($user_email != $data['user_email'] &amp;&amp; $data['email_confirm'] != $data['user_email'])
-				{
-					$error[] = 'NEW_EMAIL_ERROR';
-				}
-
-				// Which updates do we need to do?
-				$update_warning = ($user_warnings != $data['user_warnings']) ? true : false;
-				$update_username = ($username != $data['username']) ? $username : false;
-				$update_password = ($user_password != $data['user_password']) ? true : false;
-
-				extract($data);
-				unset($data);
-
-				if (!sizeof($error))
-				{
-					$sql_ary = array(
-						'username'			=&gt; $username, 
-						'user_founder'		=&gt; $user_founder, 
-						'user_email'		=&gt; $user_email, 
-						'user_email_hash'	=&gt; crc32(strtolower($user_email)) . strlen($user_email), 
-						'user_warnings'		=&gt; $user_warnings, 
-					);
-
-					if ($update_password)
-					{
-						$sql_ary += array(
-							'user_password' =&gt; md5($user_password),
-							'user_passchg'	=&gt; time(),
-						);
-					}
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
-						WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-					$db-&gt;sql_query($sql);
-
-					// TODO
-					if ($update_warning)
-					{
-					}
-
-					if ($update_username)
-					{
-						user_update_name($update_username, $username);
-					}
-
-					trigger_error($_CLASS['core_user']-&gt;lang['USER_OVERVIEW_UPDATED']);
-				}
-
-				// Replace &quot;error&quot; strings with their real, localised form
-				$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
-			}
-
-			$colspan = 2;
-
-			$user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
-			$quick_tool_ary = array('banuser' =&gt; 'BAN_USER', 'banemail' =&gt; 'BAN_EMAIL', 'banip' =&gt; 'BAN_IP', 'active' =&gt; (($user_type == USER_INACTIVE) ? 'ACTIVATE' : 'DEACTIVATE'), 'delsig' =&gt; 'DEL_SIG', 'delavatar' =&gt; 'DEL_AVATAR', 'moveposts' =&gt; 'MOVE_POSTS', 'delposts' =&gt; 'DEL_POSTS', 'delattach' =&gt; 'DEL_ATTACH');
-			if ($config['email_enable']) 
-			{
-				$quick_tool_ary['reactivate'] = 'FORCE';
-			}
-
-			$options = '&lt;option class=&quot;sep&quot; value=&quot;&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SELECT_OPTION'] . '&lt;/option&gt;';
-			foreach ($quick_tool_ary as $value =&gt; $lang)
-			{
-				$options .= '&lt;option value=&quot;' . $value . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_ADMIN_' . $lang]  . '&lt;/option&gt;';
-			}
-
-			$user_founder_yes = ($user_type == USER_FOUNDER) ? ' checked=&quot;checked&quot;' : '';
-			$user_founder_no = ($user_type != USER_FOUNDER) ? ' checked=&quot;checked&quot;' : (($_CLASS['core_user']-&gt;data['user_type'] != USER_FOUNDER) ? ' disabled=&quot;disabled&quot;' : '');
-
-?&gt;	
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_OVERVIEW']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[str_replace('\\\\', '\\', $config['allow_name_chars'])] . '_EXPLAIN'], $config['min_name_chars'], $config['max_name_chars']); ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;username&quot; value=&quot;&lt;?php echo $username; ?&gt;&quot; maxlength=&quot;60&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['REGISTERED']; ?&gt;: &lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;strong&gt;&lt;?php echo $_CLASS['core_user']-&gt;format_date($user_regdate); ?&gt;&lt;/strong&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			if ($user_ip)
-			{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['REGISTERED_IP']; ?&gt;: &lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;strong&gt;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_users&amp;action=$action&amp;u=$user_id&amp;ip=&quot; . ((!$ip || $ip == 'ip') ? 'hostname' : 'ip')) . '&quot;&gt;' . (($ip == 'hostname') ? gethostbyaddr($user_ip) : $user_ip) . '&lt;/a&gt; [ &lt;a href=&quot;'.adminlink('forums&amp;file=admin_users&amp;action=whois&amp;ip='.$user_ip).&quot;\&quot; onclick=\&quot;window.open('&quot;.adminlink('forums&amp;file=admin_users&amp;action=whois&amp;ip='.$user_ip).&quot;', '', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=600');return false;\&quot;&gt;&quot; . $_CLASS['core_user']-&gt;lang['WHOIS'] . '&lt;/a&gt; ]'; ?&gt;&lt;/strong&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-						
-			}
-			
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LAST_ACTIVE']; ?&gt;: &lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;strong&gt;&lt;?php echo $_CLASS['core_user']-&gt;format_date($user_lastvisit); ?&gt;&lt;/strong&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FOUNDER']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FOUNDER_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_founder&quot; value=&quot;1&quot;&lt;?php echo $user_founder_yes; ?&gt; /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_founder&quot; value=&quot;0&quot;&lt;?php echo $user_founder_no; ?&gt; /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EMAIL']; ?&gt;: &lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;user_email&quot; value=&quot;&lt;?php echo $user_email; ?&gt;&quot; maxlength=&quot;60&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CONFIRM_EMAIL']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CONFIRM_EMAIL_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;email_confirm&quot; value=&quot;&lt;?php echo $email_confirm; ?&gt;&quot; maxlength=&quot;60&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NEW_PASSWORD']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo sprintf($_CLASS['core_user']-&gt;lang['CHANGE_PASSWORD_EXPLAIN'], $config['min_pass_chars'], $config['max_pass_chars']) ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;password&quot; name=&quot;user_password&quot; value=&quot;&lt;?php echo ($submit) ? $user_password : ''; ?&gt;&quot; maxlength=&quot;60&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CONFIRM_PASSWORD']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CONFIRM_PASSWORD_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;password&quot; name=&quot;password_confirm&quot; value=&quot;&lt;?php echo ($submit) ? $user_password_confirm : ''; ?&gt;&quot; maxlength=&quot;60&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			if ($user_type != USER_FOUNDER)
-			{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_TOOLS']; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNINGS']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNINGS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;warnings&quot; size=&quot;2&quot; maxlength=&quot;2&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;data['user_warnings']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['QUICK_TOOLS']; ?&gt;: &lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;quicktools&quot;&gt;&lt;?php echo $options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_USER']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_USER_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;deletetype&quot;&gt;&lt;option value=&quot;retain&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RETAIN_POSTS']; ?&gt;&lt;/option&gt;&lt;option value=&quot;remove&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_POSTS']; ?&gt;&lt;/option&gt;&lt;/select&gt; &lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; value=&quot;1&quot; /&gt; &lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-		case 'feedback':
-
-			if ($submit)
-			{
-				if (($deletemark || $deleteall) &amp;&amp; $_CLASS['auth']-&gt;acl_get('a_clearlogs'))
-				{
-					$where_sql = '';
-					if ($deletemark &amp;&amp; $marked)
-					{
-						$sql_in = array();
-						foreach ($marked as $mark)
-						{
-							$sql_in[] =  $mark;
-						}
-						$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
-						unset($sql_in);
-					}
-
-					$sql = 'DELETE FROM ' . LOG_TABLE . '
-						WHERE log_type = ' . LOG_USERS . &quot; 
-							$where_sql&quot;;
-					$db-&gt;sql_query($sql);
-
-					add_log('admin', 'LOG_USERS_CLEAR');
-					trigger_error(&quot;&quot;);
-				}
-
-				if ($message = request_var('message', ''))
-				{
-					add_log('admin', 'LOG_USER_FEEDBACK', $username);
-					add_log('user', $user_id, 'LOG_USER_GENERAL', $message);
-
-					trigger_error($_CLASS['core_user']-&gt;lang['USER_FEEDBACK_ADDED']);
-				}
-			}
-
-			$colspan = 2;
-
-			$limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_ENTRIES'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
-			$sort_by_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['SORT_USERNAME'], 'b' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DATE'], 'c' =&gt; $_CLASS['core_user']-&gt;lang['SORT_IP'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['SORT_ACTION']);
-			$sort_by_sql = array('a' =&gt; 'l.user_id', 'b' =&gt; 'l.log_time', 'c' =&gt; 'l.log_ip', 'd' =&gt; 'l.log_operation');
-
-			$s_limit_days = $s_sort_key = $s_sort_dir = '';
-			gen_sort_selects($limit_days, $sort_by_text, $st, $sk, $sd, $s_limit_days, $s_sort_key, $s_sort_dir);
-
-			// Define where and sort sql for use in displaying logs
-			$sql_where = ($st) ? (time() - ($st * 86400)) : 0;
-			$sql_sort = $sort_by_sql[$sk] . ' ' . (($sd == 'd') ? 'DESC' : 'ASC');
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_FEEDBACK']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_LOG']; ?&gt;: &nbsp;&lt;?php echo $s_limit_days; ?&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['SORT_BY']; ?&gt;: &lt;?php echo $s_sort_key; ?&gt; &lt;?php echo $s_sort_dir; ?&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; name=&quot;sort&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			$log_data = array();
-			$log_count = 0;
-			view_log('user', $log_data, $log_count, $config['posts_per_page'], $start, 0, 0, $user_id, $sql_where, $sql_sort);
-
-			if ($log_count)
-			{
-				for($i = 0; $i &lt; sizeof($log_data); $i++)
-				{
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;Report by: &lt;b&gt;&lt;?php echo $log_data[$i]['username']; ?&gt;&lt;/b&gt; on &lt;?php echo $_CLASS['core_user']-&gt;format_date($log_data[$i]['time']); ?&gt;&lt;/span&gt;&lt;hr /&gt;&lt;?php echo $log_data[$i]['action']; ?&gt;&lt;/td&gt;
-					&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;5%&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $log_data[$i]['id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-
-				}
-			}
-			else
-			{
-
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;No reports exist for this user&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-
-			}
-
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;?php
-	
-			if ($_CLASS['auth']-&gt;acl_get('a_clearlogs'))
-			{
-
-?&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delmarked&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_MARKED']; ?&gt;&quot; /&gt;&nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delall&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL']; ?&gt;&quot; /&gt;&lt;?php
-	
-			}
-			
-?&gt;&nbsp;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;nav&quot;&gt;&lt;div style=&quot;float:left;&quot;&gt;&lt;?php echo on_page($log_count, $config['topics_per_page'], $start); ?&gt;&lt;/div&gt;&lt;div  style=&quot;float:right;&quot;&gt;&lt;b&gt;&lt;a href=&quot;javascript:marklist('admin', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('admin', false);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/b&gt;&nbsp;&lt;br /&gt;&lt;br /&gt;&lt;?php
-
-			echo generate_pagination(&quot;admin_users&amp;action=$action&amp;u=$user_id&amp;st=$st&amp;sk=$sk&amp;sd=$sd&quot;, $log_count, $config['posts_per_page'], $start); 
-	
-?&gt;&lt;/div&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-function marklist(match, status)
-{
-	len = eval('document.' + match + '.length');
-	for (i = 0; i &lt; len; i++)
-	{
-		eval('document.' + match + '.elements[i].checked = ' + status);
-	}
-}
-//--&gt;
-&lt;/script&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_FEEDBACK']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_FEEDBACK_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;bg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_' . strtoupper($action)]; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;textarea name=&quot;message&quot; rows=&quot;10&quot; cols=&quot;76&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-
-			break;
-
-
-		case 'profile':
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'icq'			=&gt; (string) '', 
-					'aim'			=&gt; (string) '', 
-					'msn'			=&gt; (string) '', 
-					'yim'			=&gt; (string) '', 
-					'jabber'		=&gt; (string) '', 
-					'website'		=&gt; (string) '', 
-					'location'		=&gt; (string) '',
-					'occupation'	=&gt; (string) '',
-					'interests'		=&gt; (string) '',
-					'bday_day'		=&gt; 0,
-					'bday_month'	=&gt; 0,
-					'bday_year'		=&gt; 0,
-				);
-
-				foreach ($var_ary as $var =&gt; $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'icq'			=&gt; array(
-						array('string', true, 3, 15), 
-						array('match', true, '#^[0-9]+$#i')), 
-					'aim'			=&gt; array('string', true, 5, 255), 
-					'msn'			=&gt; array('string', true, 5, 255), 
-					'jabber'		=&gt; array(
-						array('string', true, 5, 255), 
-						array('match', true, '#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}(/.*)?$#i')),
-					'yim'			=&gt; array('string', true, 5, 255), 
-					'website'		=&gt; array(
-						array('string', true, 12, 255), 
-						array('match', true, '#^http[s]?://(.*?\.)*?[a-z0-9\-]+\.[a-z]{2,4}#i')), 
-					'location'		=&gt; array('string', true, 2, 255), 
-					'occupation'	=&gt; array('string', true, 2, 500), 
-					'interests'		=&gt; array('string', true, 2, 500), 
-					'bday_day'		=&gt; array('num', true, 1, 31),
-					'bday_month'	=&gt; array('num', true, 1, 12),
-					'bday_year'		=&gt; array('num', true, 1901, gmdate('Y', time())),
-				);
-
-				$error = validate_data($data, $var_ary);
-				extract($data);
-				unset($data);
-
-				// validate custom profile fields
-	//			$cp-&gt;submit_cp_field('profile', $cp_data, $cp_error);
-
-				if (!sizeof($error) &amp;&amp; !sizeof($cp_error))
-				{
-					$sql_ary = array(
-						'user_icq'		=&gt; $icq,
-						'user_aim'		=&gt; $aim,
-						'user_msnm'		=&gt; $msn,
-						'user_yim'		=&gt; $yim,
-						'user_jabber'	=&gt; $jabber,
-						'user_website'	=&gt; $website,
-						'user_from'		=&gt; $location,
-						'user_occ'		=&gt; $occupation,
-						'user_interests'=&gt; $interests,
-						'user_birthday'	=&gt; sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year),
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . &quot;
-						WHERE user_id = $user_id&quot;;
-					$db-&gt;sql_query($sql);
-
-	/*
-					// Update Custom Fields
-					if (sizeof($cp_data))
-					{
-						$sql = 'UPDATE ' . PROFILE_DATA_TABLE . '
-							SET ' . $db-&gt;sql_build_array('UPDATE', $cp_data) . &quot;
-							WHERE user_id = $user_id&quot;;
-						$db-&gt;sql_query($sql);
-
-						if (!$db-&gt;sql_affectedrows())
-						{
-							$cp_data['user_id'] = $user_id;
-
-							$db-&gt;return_on_error = true;
-
-							$sql = 'INSERT INTO ' . PROFILE_DATA_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $cp_data);
-							$db-&gt;sql_query();
-
-							$db-&gt;return_on_error = false;
-						}
-					}
-	*/
-					trigger_error($_CLASS['core_user']-&gt;lang['USER_PROFILE_UPDATED']);
-				}
-			}
-
-			$colspan = 2;
-
-			$cp = new custom_profile();
-
-			$cp_data = $cp_error = array();
-
-			if (!isset($bday_day))
-			{
-				list($bday_day, $bday_month, $bday_year) = explode('-', $user_birthday);
-			}
-
-			$s_birthday_day_options = '&lt;option value=&quot;0&quot;' . ((!$bday_day) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-			for ($i = 1; $i &lt; 32; $i++)
-			{
-				$selected = ($i == $bday_day) ? ' selected=&quot;selected&quot;' : '';
-				$s_birthday_day_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
-			}
-
-			$s_birthday_month_options = '&lt;option value=&quot;0&quot;' . ((!$bday_month) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-			for ($i = 1; $i &lt; 13; $i++)
-			{
-				$selected = ($i == $bday_month) ? ' selected=&quot;selected&quot;' : '';
-				$s_birthday_month_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
-			}
-			$s_birthday_year_options = '';
-
-			$now = getdate();
-			$s_birthday_year_options = '&lt;option value=&quot;0&quot;' . ((!$bday_year) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-			for ($i = $now['year'] - 100; $i &lt; $now['year']; $i++)
-			{
-				$selected = ($i == $bday_year) ? ' selected=&quot;selected&quot;' : '';
-				$s_birthday_year_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
-			}
-			unset($now);
-
-			// Get additional profile fields and assign them to the template block var 'profile_fields'
-//			$_CLASS['core_user']-&gt;get_profile_fields($_CLASS['core_user']-&gt;data['user_id']);
-//			$cp-&gt;generate_profile_fields('profile', $_CLASS['core_user']-&gt;get_iso_lang_id(), $cp_error);
-
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_SIG']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UCP_ICQ']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;icq&quot; size=&quot;30&quot; maxlength=&quot;15&quot; value=&quot;&lt;?php echo $user_icq; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UCP_AIM']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;aim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $user_aim; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UCP_MSNM']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;msn&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $user_msnm; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UCP_YIM']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;yim&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $user_yim; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UCP_JABBER']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jabber&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $user_jabber; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WEBSITE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;website&quot; size=&quot;30&quot; maxlength=&quot;255&quot; value=&quot;&lt;?php echo $user_website; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOCATION']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;location&quot; size=&quot;30&quot; maxlength=&quot;100&quot; value=&quot;&lt;?php echo $user_location; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OCCUPATION']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;occ&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;&lt;?php echo $user_occ; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['INTERESTS']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;interests&quot; rows=&quot;3&quot; cols=&quot;30&quot;&gt;&lt;?php echo $user_interests; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BIRTHDAY']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BIRTHDAY_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DAY']; ?&gt;:&lt;/span&gt; &lt;select name=&quot;bday_day&quot;&gt;&lt;?php echo $s_birthday_day_options; ?&gt;&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MONTH']; ?&gt;:&lt;/span&gt; &lt;select name=&quot;bday_month&quot;&gt;&lt;?php echo $s_birthday_month_options; ?&gt;&lt;/select&gt; &lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YEAR']; ?&gt;:&lt;/span&gt; &lt;select name=&quot;bday_year&quot;&gt;&lt;?php echo $s_birthday_year_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-
-		case 'prefs':
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'user_dateformat'		=&gt; (string) $config['default_dateformat'], 
-					'user_lang'				=&gt; (string) $config['default_lang'], 
-					'user_tz'				=&gt; (float) $config['board_timezone'],
-					'user_style'			=&gt; (int) $config['default_style'], 
-					'user_dst'				=&gt; (bool) $config['board_dst'], 
-					'user_allow_viewemail'	=&gt; false, 
-					'user_allow_massemail'	=&gt; true, 
-					'user_allow_viewonline'	=&gt; true, 
-					'user_notify_type'		=&gt; 0, 
-					'user_notify_pm'		=&gt; true, 
-					'user_allow_pm'			=&gt; true, 
-					'user_notify'			=&gt; false, 
-					'user_min_karma'		=&gt; (int) -5, 
-
-					'sk'		=&gt; (string) 't', 
-					'sd'		=&gt; (string) 'd', 
-					'st'		=&gt; 0,
-
-					'popuppm'		=&gt; false, 
-					'viewimg'		=&gt; true, 
-					'viewflash'		=&gt; false, 
-					'viewsmilies'	=&gt; true, 
-					'viewsigs'		=&gt; true, 
-					'viewavatars'	=&gt; true, 
-					'viewcensors'	=&gt; false, 
-					'bbcode'		=&gt; true, 
-					'html'			=&gt; false, 
-					'smile'			=&gt; true,
-					'attachsig'		=&gt; true, 
-				);
-
-				foreach ($var_ary as $var =&gt; $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'user_dateformat'	=&gt; array('string', false, 3, 15), 
-					'user_lang'			=&gt; array('match', false, '#^[a-z_]{2,}$#i'),
-					'user_tz'			=&gt; array('num', false, -13, 13),
-					'user_min_karma'	=&gt; array('num', false, -5, 5),
-
-					'sk'	=&gt; array('string', false, 1, 1), 
-					'sd'	=&gt; array('string', false, 1, 1), 
-				);
-
-				$error = validate_data($data, $var_ary);
-				extract($data);
-				unset($data);
-
-				// Set the popuppm option
-				$option_ary = array('popuppm', 'viewimg', 'viewflash', 'viewsmilies', 'viewsigs', 'viewavatars', 'viewcensors', 'bbcode', 'html', 'smile', 'attachsig');
-
-				foreach ($option_ary as $option)
-				{
-					$user_options = $_CLASS['core_user']-&gt;optionset($option, $$option, $user_options);
-				}
-
-				if (!sizeof($error))
-				{
-					$sql_ary = array(
-						'user_allow_pm'			=&gt; $user_allow_pm, 
-						'user_allow_viewemail'	=&gt; $user_allow_viewemail, 
-						'user_allow_massemail'	=&gt; $user_allow_massemail, 
-						'user_allow_viewonline'	=&gt; $user_allow_viewonline, 
-						'user_notify_type'		=&gt; $user_notify_type, 
-						'user_notify_pm'		=&gt; $user_notify_pm,
-						'user_options'			=&gt; $user_options, 
-						'user_notify'			=&gt; $user_notify,
-						'user_min_karma'		=&gt; $user_min_karma, 
-						'user_dst'				=&gt; $user_dst,
-						'user_dateformat'		=&gt; $user_dateformat,
-						'user_lang'				=&gt; $user_lang,
-						'user_timezone'			=&gt; $user_tz,
-						'user_style'			=&gt; $user_style,
-						'user_sortby_type'		=&gt; $sk,
-						'user_sortby_dir'		=&gt; $sd,
-						'user_show_days'		=&gt; $st, 
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . &quot;
-						WHERE user_id = $user_id&quot;;
-					$db-&gt;sql_query($sql);
-
-					trigger_error($_CLASS['core_user']-&gt;lang['USER_PREFS_UPDATED']);
-				}
-
-				$user_sortby_type = $sk;
-				$user_sortby_dir = $sd;
-				$user_show_days = $st;
-			}
-
-			$colspan = 2;
-
-			$option_ary = array('user_allow_viewemail', 'user_allow_massemail', 'user_allow_pm', 'user_allow_viewonline', 'user_notify_pm', 'user_dst', 'user_notify', 'user_min_karma');
-
-			foreach ($option_ary as $option)
-			{
-				${$option . '_yes'} = ($$option) ? ' checked=&quot;checked&quot;' : '';
-				${$option . '_no'} = (!$$option) ? ' checked=&quot;checked&quot;' : '';
-			}
-			unset($option_ary);
-
-			$option_ary = array('popuppm', 'viewimg', 'viewflash', 'viewsmilies', 'viewsigs', 'viewavatars', 'viewcensors', 'bbcode', 'html', 'smile', 'attachsig');
-
-			foreach ($option_ary as $option)
-			{
-				${$option . '_yes'} = ($_CLASS['core_user']-&gt;optionget($option, $user_options)) ? ' checked=&quot;checked&quot;' : '';
-				${$option . '_no'} = (!$_CLASS['core_user']-&gt;optionget($option, $user_options)) ? ' checked=&quot;checked&quot;' : '';
-			}
-
-			$notify_email	= ($user_notify_type == NOTIFY_EMAIL) ? ' checked=&quot;checked&quot;' : '';
-			$notify_im		= ($user_notify_type == NOTIFY_IM) ? ' checked=&quot;checked&quot;' : '';
-			$notify_both	= ($user_notify_type == NOTIFY_BOTH) ? ' checked=&quot;checked&quot;' : '';
-
-			// Topic ordering display
-			$limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_TOPICS'], 0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_TOPICS'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
-
-			$sort_by_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['AUTHOR'], 't' =&gt; $_CLASS['core_user']-&gt;lang['POST_TIME'], 'r' =&gt; $_CLASS['core_user']-&gt;lang['REPLIES'], 's' =&gt; $_CLASS['core_user']-&gt;lang['SUBJECT'], 'v' =&gt; $_CLASS['core_user']-&gt;lang['VIEWS']);
-			$sort_by_sql = array('a' =&gt; 't.topic_first_poster_name', 't' =&gt; 't.topic_last_post_time', 'r' =&gt; 't.topic_replies', 's' =&gt; 't.topic_title', 'v' =&gt; 't.topic_views');
-
-			$s_limit_days = $s_sort_key = $s_sort_dir = '';
-			gen_sort_selects($limit_days, $sort_by_text, $user_show_days, $user_sortby_type, $user_sortby_dir, $s_limit_days, $s_sort_key, $s_sort_dir);
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_PREFS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_IMAGES']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewimg&quot; value=&quot;1&quot;&lt;?php echo $viewimg_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewimg&quot; value=&quot;0&quot;&lt;?php echo $viewimg_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_FLASH']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewflash&quot; value=&quot;1&quot;&lt;?php echo $viewflash_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewflash&quot; value=&quot;0&quot;&lt;?php echo $viewflash_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_SMILIES']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewsmilies&quot; value=&quot;1&quot;&lt;?php echo $viewsmilies_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewsmilies&quot; value=&quot;0&quot;&lt;?php echo $viewsmilies_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_SIGS']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewsigs&quot; value=&quot;1&quot;&lt;?php echo $viewsigs_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewsigs&quot; value=&quot;0&quot;&lt;?php echo $viewsigs_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_AVATARS']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewavatars&quot; value=&quot;1&quot;&lt;?php echo $viewavatars_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewavatars&quot; value=&quot;0&quot;&lt;?php echo $viewavatars_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLE_CENSORS']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;viewcensors&quot; value=&quot;1&quot;&lt;?php echo $viewcensors_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;viewcensors&quot; value=&quot;0&quot;&lt;?php echo $viewcensors_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;!-- tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MINIMUM_KARMA']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MINIMUM_KARMA_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;user_min_karma&quot;&gt;{S_MIN_KARMA_OPTIONS}&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr--&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_TOPICS_DAYS']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $s_limit_days; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_TOPICS_KEY']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $s_sort_key; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['VIEW_TOPICS_DIR']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $s_sort_dir; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_POSTING_PREFS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT_BBCODE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;1&quot;&lt;?php echo $bbcode_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;bbcode&quot; value=&quot;0&quot;&lt;?php echo $bbcode_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT_HTML']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;1&quot;&lt;?php echo $html_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;html&quot; value=&quot;0&quot;&lt;?php echo $html_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT_SMILE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;smile&quot; value=&quot;1&quot;&lt;?php echo $smile_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;smile&quot; value=&quot;0&quot;&lt;?php echo $smile_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT_ADD_SIG']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;attachsig&quot; value=&quot;1&quot;&lt;?php echo $attachsig_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;attachsig&quot; value=&quot;0&quot;&lt;?php echo $attachsig_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFAULT_NOTIFY']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_notify&quot; value=&quot;1&quot;&lt;?php echo $user_notify_yes; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_notify&quot; value=&quot;0&quot;&lt;?php echo $user_notify_no; ?&gt; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SHOW_EMAIL']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_allow_viewemail&quot; value=&quot;1&quot;&lt;?php echo $user_allow_viewemail_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_allow_viewemail&quot; value=&quot;0&quot;&lt;?php echo $user_allow_viewemail_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADMIN_EMAIL']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_allow_massemail&quot; value=&quot;1&quot;&lt;?php echo $user_allow_massemail_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_allow_massemail&quot; value=&quot;0&quot;&lt;?php echo $user_allow_massemail_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOW_PM']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOW_PM_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_allow_pm&quot; value=&quot;1&quot;&lt;?php echo $user_allow_pm_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_allow_pm&quot; value=&quot;0&quot;&lt;?php echo $user_allow_pm_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['HIDE_ONLINE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_allow_viewonline&quot; value=&quot;0&quot;&lt;?php echo $user_allow_viewonline_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_allow_viewonline&quot; value=&quot;1&quot;&lt;?php echo $user_allow_viewonline_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_METHOD']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_METHOD_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_notify_type&quot; value=&quot;0&quot;&lt;?php echo $notify_email; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_METHOD_EMAIL']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_notify_type&quot; value=&quot;1&quot;&lt;?php echo $notify_im; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_METHOD_IM']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_notify_type&quot; value=&quot;2&quot;&lt;?php echo $notify_both; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_METHOD_BOTH']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY_ON_PM']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_notify_pm&quot; value=&quot;1&quot;&lt;?php echo $user_notify_pm_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_notify_pm&quot; value=&quot;0&quot;&lt;?php echo $user_notify_pm_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['POPUP_ON_PM']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;1&quot;&lt;?php echo $popuppm_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;popuppm&quot; value=&quot;0&quot;&lt;?php echo $popuppm_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_LANGUAGE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;user_lang&quot;&gt;&lt;?php echo language_select($user_lang); ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_STYLE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;user_style&quot;&gt;&lt;?php echo style_select($user_style); ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_TIMEZONE']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;user_tz&quot;&gt;&lt;?php echo tz_select($user_timezone); ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_DST']; ?&gt;:&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;user_dst&quot; value=&quot;1&quot;&lt;?php echo $user_dst_yes; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&lt;/span&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;user_dst&quot; value=&quot;0&quot;&lt;?php echo $user_dst_no; ?&gt; /&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_DATE_FORMAT']; ?&gt;:&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BOARD_DATE_FORMAT_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;user_dateformat&quot; value=&quot;&lt;?php echo $user_dateformat; ?&gt;&quot; maxlength=&quot;14&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-		case 'avatar':
-
-			$can_upload = (file_exists($config['avatar_path']) &amp;&amp; is_writeable($config['avatar_path']) &amp;&amp; $file_uploads) ? true : false;
-
-			if ($submit)
-			{
-				$var_ary = array(
-					'uploadurl'		=&gt; (string) '', 
-					'remotelink'	=&gt; (string) '', 
-					'width'			=&gt; (string) '',
-					'height'		=&gt; (string) '', 
-				);
-
-				foreach ($var_ary as $var =&gt; $default)
-				{
-					$data[$var] = request_var($var, $default);
-				}
-
-				$var_ary = array(
-					'uploadurl'		=&gt; array('string', true, 5, 255), 
-					'remotelink'	=&gt; array('string', true, 5, 255), 
-					'width'			=&gt; array('string', true, 1, 3), 
-					'height'		=&gt; array('string', true, 1, 3), 
-				);
-
-				$error = validate_data($data, $var_ary);
-
-				if (!sizeof($error))
-				{
-					$data['user_id'] = $user_id;
-
-					if ((!empty($_FILES['uploadfile']['tmp_name']) || $data['uploadurl']) &amp;&amp; $can_upload)
-					{
-						list($type, $filename, $width, $height) = avatar_upload($data, $error);
-					}
-					else if ($data['remotelink'])
-					{
-						list($type, $filename, $width, $height) = avatar_remote($data, $error);
-					}
-					else if ($delete)
-					{
-						$type = $filename = $width = $height = '';
-					}
-				}
-
-				if (!sizeof($error))
-				{
-					// Do we actually have any data to update?
-					if (sizeof($data))
-					{
-						$sql_ary = array(
-							'user_avatar'			=&gt; $filename, 
-							'user_avatar_type'		=&gt; $type, 
-							'user_avatar_width'		=&gt; $width, 
-							'user_avatar_height'	=&gt; $height, 
-						);
-
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . &quot; 
-							WHERE user_id = $user_id&quot;;
-						$db-&gt;sql_query($sql);
-
-						// Delete old avatar if present
-						if ($user_avatar &amp;&amp; $filename != $user_avatar)
-						{
-							avatar_delete($user_avatar);
-						}
-					}
-
-					trigger_error($message);
-				}
-
-				extract($data);
-				unset($data);
-			}
-
-			$colspan = 2;
-
-			$display_gallery = (isset($_POST['displaygallery'])) ? true : false;
-			$avatar_category = request_var('category', '');
-
-			// Generate users avatar
-			$avatar_img = '';
-			if ($user_avatar)
-			{
-				switch ($user_avatar_type)
-				{
-					case AVATAR_UPLOAD:
-						$avatar_img = $config['avatar_path'] . '/';
-						break;
-					case AVATAR_GALLERY:
-						$avatar_img = $config['avatar_gallery_path'] . '/';
-						break;
-				}
-				$avatar_img .= $user_avatar;
-
-				$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $user_avatar_width . '&quot; height=&quot;' . $user_avatar_height . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
-			}
-			else
-			{
-				$avatar_img = '&lt;img src=&quot;images/no_avatar.gif&quot; alt=&quot;&quot; /&gt;';
-			}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_AVATAR']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CURRENT_IMAGE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo sprintf($_CLASS['core_user']-&gt;lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)); ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;?php echo $avatar_img; ?&gt;&lt;br /&gt;&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete&quot; /&gt;&nbsp;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_AVATAR']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			// Can we upload?
-			if ($can_upload)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_FILE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;MAX_FILE_SIZE&quot; value=&quot;&lt;?php echo $config['avatar_max_filesize']; ?&gt;&quot; /&gt;&lt;input class=&quot;post&quot; type=&quot;file&quot; name=&quot;uploadfile&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_URL']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_AVATAR_URL_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;uploadurl&quot; size=&quot;40&quot; value=&quot;&lt;?php echo $avatar_url; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_AVATAR']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_AVATAR_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;remotelink&quot; size=&quot;40&quot; value=&quot;&lt;?php echo $avatar_url; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_SIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LINK_REMOTE_SIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;width&quot; size=&quot;3&quot; value=&quot;&lt;?php echo $user_avatar_width; ?&gt;&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px X &lt;/span&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;height&quot; size=&quot;3&quot; value=&quot;&lt;?php echo $user_avatar_height; ?&gt;&quot; /&gt; &lt;span class=&quot;gen&quot;&gt;px&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			// Do we have a gallery?
-			if ($config['null'] &amp;&amp; !$display_gallery)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row2&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_GALLERY']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;displaygallery&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_GALLERY']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-			}
-
-			// Do we want to display it?
-			if ($config['null'] &amp;&amp; $display_gallery)
-			{
-
-?&gt;
-	&lt;tr&gt; 
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_GALLERY']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_CATEGORY']; ?&gt;: &lt;/span&gt;&lt;select name=&quot;avatarcat&quot;&gt;{S_CAT_OPTIONS}&lt;/select&gt;&nbsp; &lt;span class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AVATAR_PAGE']; ?&gt;: &lt;/span&gt;&lt;select name=&quot;avatarpage&quot;&gt;{S_PAGE_OPTIONS}&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; name=&quot;avatargallery&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-		
-			&lt;!-- BEGIN avatar_row --&gt;
-			&lt;tr&gt; 
-				&lt;!-- BEGIN avatar_column --&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;img src=&quot;{avatar_row.avatar_column.AVATAR_IMAGE}&quot; alt=&quot;{avatar_row.avatar_column.AVATAR_NAME}&quot; title=&quot;{avatar_row.avatar_column.AVATAR_NAME}&quot; /&gt;&lt;/td&gt;
-				&lt;!-- END avatar_column --&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;!-- BEGIN avatar_option_column --&gt;
-				&lt;td class=&quot;row2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;avatarselect&quot; value=&quot;{avatar_row.avatar_option_column.S_OPTIONS_AVATAR}&quot; /&gt;&lt;/td&gt;
-				&lt;!-- END avatar_option_column --&gt;
-			&lt;/tr&gt;
-			&lt;!-- END avatar_row --&gt;
-
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-
-		case 'sig':
-
-			if ($submit || $preview)
-			{
-				$var_ary = array(
-					'enable_html'		=&gt; (bool) $config['allow_html'], 
-					'enable_bbcode'		=&gt; (bool) $config['allow_bbcode'], 
-					'enable_smilies'	=&gt; (bool) $config['allow_smilies'],
-					'enable_urls'		=&gt; true,  
-					'signature'			=&gt; (string) $user_sig, 
-
-				);
-
-				foreach ($var_ary as $var =&gt; $default)
-				{
-					$$var = request_var($var, $default);
-				}
-
-				$img_status = ($config['allow_img']) ? true : false;
-				$flash_status = ($config['allow_flash']) ? true : false;
-				
-					require_once($site_file_root.'includes/forums/message_parser.'.$phpEx);
-					// Allowing Quote BBCode
-					$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
-					
-					if ($submit)
-					{
-
-					$message_parser = new parse_message($signature);
-
-					$sql_ary = array(
-						'user_sig'					=&gt; (string) $message_parser-&gt;message, 
-						'user_sig_bbcode_uid'		=&gt; (string) $message_parser-&gt;bbcode_uid, 
-						'user_sig_bbcode_bitfield'	=&gt; (int) $message_parser-&gt;bbcode_bitfield
-					);
-
-					$sql = 'UPDATE ' . USERS_TABLE . ' 
-						SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . &quot; 
-						WHERE user_id = $user_id&quot;;
-					$db-&gt;sql_query($sql);
-					
-					unset($message_parser);
-
-					trigger_error($_CLASS['core_user']-&gt;lang['PROFILE_UPDATED']);
-				}
-			}
-
-			$colspan = 2;
-
-			require_once($site_file_root.'includes/forums/functions_posting.'.$phpEx);
-
-			$signature_preview = '';
-			if ($preview)
-			{
-				// Now parse it for displaying
-				$signature_preview = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
-				unset($message_parser);
-			}
-
-			decode_message($user_sig, $user_sig_bbcode_uid);
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_SIG']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SIGNATURE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
-					&lt;tr align=&quot;center&quot; valign=&quot;middle&quot;&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;b&quot; name=&quot;addbbcode0&quot; value=&quot; B &quot; style=&quot;font-weight:bold; width: 30px&quot; onclick=&quot;bbstyle(0)&quot; onmouseover=&quot;helpline('b')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;i&quot; name=&quot;addbbcode2&quot; value=&quot; i &quot; style=&quot;font-style:italic; width: 30px&quot; onclick=&quot;bbstyle(2)&quot; onmouseover=&quot;helpline('i')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;u&quot; name=&quot;addbbcode4&quot; value=&quot; u &quot; style=&quot;text-decoration: underline; width: 30px&quot; onclick=&quot;bbstyle(4)&quot; onmouseover=&quot;helpline('u')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;q&quot; name=&quot;addbbcode6&quot; value=&quot;Quote&quot; style=&quot;width: 50px&quot; onclick=&quot;bbstyle(6)&quot; onmouseover=&quot;helpline('q')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;c&quot; name=&quot;addbbcode8&quot; value=&quot;Code&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(8)&quot; onmouseover=&quot;helpline('c')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;l&quot; name=&quot;addbbcode10&quot; value=&quot;List&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(10)&quot; onmouseover=&quot;helpline('l')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;o&quot; name=&quot;addbbcode12&quot; value=&quot;List=&quot; style=&quot;width: 40px&quot; onclick=&quot;bbstyle(12)&quot; onmouseover=&quot;helpline('o')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;p&quot; name=&quot;addbbcode14&quot; value=&quot;Img&quot; style=&quot;width: 40px&quot;  onclick=&quot;bbstyle(14)&quot; onmouseover=&quot;helpline('p')&quot; /&gt;&lt;/td&gt;
-						&lt;td&gt;&lt;input class=&quot;btnlite&quot; type=&quot;button&quot; accesskey=&quot;w&quot; name=&quot;addbbcode18&quot; value=&quot;URL&quot; style=&quot;text-decoration: underline; width: 40px&quot; onclick=&quot;bbstyle(18)&quot; onmouseover=&quot;helpline('w')&quot; /&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;9&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-							&lt;tr&gt;
-								&lt;td&gt;&lt;span class=&quot;genmed&quot;&gt; &nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_SIZE']; ?&gt;:&lt;/span&gt; &lt;select name=&quot;addbbcode20&quot; onchange=&quot;bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;&quot; onmouseover=&quot;helpline('f')&quot;&gt;
-									&lt;option value=&quot;7&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_TINY']; ?&gt;&lt;/option&gt;
-									&lt;option value=&quot;9&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_SMALL']; ?&gt;&lt;/option&gt;
-									&lt;option value=&quot;12&quot; selected=&quot;selected&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_NORMAL']; ?&gt;&lt;/option&gt;
-									&lt;option value=&quot;18&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_LARGE']; ?&gt;&lt;/option&gt;
-									&lt;option  value=&quot;24&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FONT_HUGE']; ?&gt;&lt;/option&gt;
-								&lt;/select&gt;&lt;/td&gt;
-								&lt;td class=&quot;gensmall&quot; nowrap=&quot;nowrap&quot; align=&quot;right&quot;&gt;&lt;a href=&quot;javascript:bbstyle(-1)&quot; onmouseover=&quot;helpline('a')&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CLOSE_TAGS']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-							&lt;/tr&gt;
-						&lt;/table&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;9&quot;&gt;&lt;input class=&quot;helpline&quot; type=&quot;text&quot; name=&quot;helpbox&quot; size=&quot;45&quot; maxlength=&quot;100&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['STYLES_TIP']; ?&gt;&quot; /&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;9&quot;&gt;&lt;textarea name=&quot;signature&quot; rows=&quot;6&quot; cols=&quot;60&quot; tabindex=&quot;3&quot; onselect=&quot;storeCaret(this);&quot; onclick=&quot;storeCaret(this);&quot; onkeyup=&quot;storeCaret(this);&quot;&gt;&lt;?php echo $user_sig; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;9&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-							&lt;tr&gt;
-								&lt;td bgcolor=&quot;black&quot;&gt;&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot;&gt;&lt;!--
-
-								colorPalette('h', 14, 5)
-
-								//--&gt;&lt;/script&gt;&lt;/td&gt;
-							&lt;/tr&gt;
-						&lt;/table&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTIONS']; ?&gt;&lt;/b&gt;&lt;br /&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo ($config['allow_html']) ? $_CLASS['core_user']-&gt;lang['HTML_IS_ON'] : $_CLASS['core_user']-&gt;lang['HTML_IS_OFF']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo ($config['allow_bbcode']) ? sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_ON'], '&lt;a href=&quot;'.getlink('Forums&amp;file=&amp;mode=bbcode').'&quot; target=&quot;_blank&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;lang['BBCODE_IS_OFF'], '&lt;a href=&quot;'.getlink('Forums&amp;file=&amp;mode=bbcode').'&quot; target=&quot;_blank&quot;&gt;', '&lt;/a&gt;'); ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo ($config['allow_img']) ? $_CLASS['core_user']-&gt;lang['IMAGES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['IMAGES_ARE_OFF']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo ($config['allow_flash']) ? $_CLASS['core_user']-&gt;lang['FLASH_IS_ON'] : $_CLASS['core_user']-&gt;lang['FLASH_IS_OFF']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo ($config['allow_smilies']) ? $_CLASS['core_user']-&gt;lang['SMILIES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['SMILIES_ARE_OFF']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot; valign=&quot;top&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;1&quot; border=&quot;0&quot;&gt;
-&lt;?php
-
-			if ($config['allow_html'])
-			{
-			
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_html&quot; /&gt;&lt;/td&gt;
-						&lt;td class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLE_HTML']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			}
-
-			if ($config['allow_bbcode'])
-			{
-			
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_bbcode&quot; /&gt;&lt;/td&gt;
-						&lt;td class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLE_BBCODE']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			}
-
-			if ($config['allow_smilies'])
-			{
-			
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_smilies&quot; /&gt;&lt;/td&gt;
-						&lt;td class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLE_SMILIES']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			}
-			
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;disable_magic_url&quot; /&gt;&lt;/td&gt;
-						&lt;td class=&quot;gen&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLE_MAGIC_URL']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;preview&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['PREVIEW']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			if ($signature_preview)
-			{
-			
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot; valign=&quot;middle&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADMIN_SIGNATURE_PREVIEW']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt; 
-				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;div class=&quot;postdetails&quot; style=&quot;padding: 6px;&quot;&gt;&lt;?php echo $signature_preview; ?&gt;&lt;/div&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			}
-			
-?&gt;
-&lt;?php
-
-			break;
-
-		case 'groups':
-
-			switch ($action)
-			{
-				case 'demote':
-				case 'promote':
-				case 'default':
-					group_user_attributes($action, $gid, $user_id);
-
-					if ($action == 'default')
-					{
-						$group_id = $gid;
-					}
-					break;
-
-				case 'delete':
-					if (!$cancel &amp;&amp; !$confirm)
-					{
-						adm_page_confirm($_CLASS['core_user']-&gt;lang['CONFIRM'], $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION']);
-					}
-					else if (!$cancel) 
-					{
-						if (!$gid)
-						{
-							trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-						}
-
-						if ($error = group_user_del($gid, $user_id))
-						{
-							trigger_error($_CLASS['core_user']-&gt;lang[$error]);
-						}
-					}
-				break;
-			}
-
-			// Add user to group?
-			if ($submit)
-			{
-				if (!$gid)
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang['NO_GROUP']);
-				}
-
-				// Add user/s to group
-				if ($error = group_user_add($gid, $user_id))
-				{
-					trigger_error($_CLASS['core_user']-&gt;lang[$error]);
-				}
-			}
-
-			$colspan = 4;
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;4&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_GROUPS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			$sql = 'SELECT ug.group_leader, g.* 
-				FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . &quot; ug 
-				WHERE ug.user_id = $user_id
-					AND g.group_id = ug.group_id
-				ORDER BY g.group_type DESC, ug.user_pending ASC, g.group_name&quot;;
-			$result = $db-&gt;sql_query($sql);
-	
-			$i = 0;
-			$group_data = $id_ary = array();
-			while ($row = $db-&gt;sql_fetchrow($result))
-			{
-				$type = ($row['group_type'] == GROUP_SPECIAL) ? 'special' : (($row['user_pending']) ? 'pending' : 'normal');
-
-				$group_data[$type][$i]['group_id']		= $row['group_id'];
-				$group_data[$type][$i]['group_name']	= $row['group_name'];
-				$group_data[$type][$i]['group_leader']	= ($row['group_leader']) ? 1 : 0;
-
-				$id_ary[] = $row['group_id'];
-
-				$i++;
-			}
-			$db-&gt;sql_freeresult($result);
-
-			// Select box for other groups
-			$sql = 'SELECT group_id, group_name, group_type 
-				FROM ' . GROUPS_TABLE . ' 
-				WHERE group_id NOT IN (' . implode(', ', $id_ary) . ')
-				ORDER BY group_type DESC, group_name ASC';
-			$result = $db-&gt;sql_query($sql);
-
-			$group_options = '';
-			while ($row = $db-&gt;sql_fetchrow($result))
-			{
-				$group_options .= '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-			}
-			$db-&gt;sql_freeresult($result);
-
-			$current_type = '';
-			foreach ($group_data as $group_type =&gt; $data_ary)
-			{
-				if ($current_type != $group_type)
-				{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row3&quot; colspan=&quot;4&quot;&gt;&lt;strong&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_GROUP_' . strtoupper($group_type)]; ?&gt;&lt;/strong&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-				}
-
-				foreach ($data_ary as $data)
-				{
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo adminlink('forums&amp;file=admin_groups&amp;mode=manage&amp;action=edit&amp;g=' . $data['group_id']); ?&gt;&quot;&gt;&lt;?php echo ($group_type == 'special') ? $_CLASS['core_user']-&gt;lang['G_' . $data['group_name']] : $data['group_name']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;10%&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php 
-
-					if ($group_id != $data['group_id'])
-					{
-
-?&gt;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_users&amp;mode=$mode&amp;action=default&amp;u=$user_id&amp;g=&quot; . $data['group_id']); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_DEFAULT']; ?&gt;&lt;/a&gt;&lt;?php
-	
-					}
-					else
-					{
-						echo $_CLASS['core_user']-&gt;lang['GROUP_DEFAULT'];
-					}
-					
-?&gt;&nbsp;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;10%&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php
-	
-					if ($group_type != 'special')
-					{
-
-?&gt;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=admin_users&amp;mode=$mode&amp;action=&quot; . (($data['group_leader']) ? 'demote' : 'promote') . &quot;&amp;u=$user_id&amp;g=&quot; . $data['group_id']); ?&gt;&quot;&gt;&lt;?php echo ($data['group_leader']) ? $_CLASS['core_user']-&gt;lang['GROUP_DEMOTE'] : $_CLASS['core_user']-&gt;lang['GROUP_PROMOTE']; ?&gt;&lt;/a&gt;&nbsp;&lt;?php
-	
-					}
-					
-?&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; width=&quot;10%&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo adminlink(&quot;forums&amp;file=&amp;mode=$mode&amp;action=delete&amp;u=$user_id&amp;g=&quot; . $data['group_id']); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_DELETE']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-				}
-			}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;4&quot; align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_GROUP_ADD']; ?&gt;: &lt;select name=&quot;g&quot;&gt;&lt;?php echo $group_options; ?&gt;&lt;/select&gt; &lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-
-		case 'perm':
-			break;
-
-
-		case 'attach':
-
-			if ($deletemark &amp;&amp; $marked)
-			{
-				if (!$cancel &amp;&amp; !$confirm)
-				{
-					adm_page_confirm($_CLASS['core_user']-&gt;lang['CONFIRM'], $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION']);
-				}
-				else if (!$cancel) 
-				{
-					$sql = 'SELECT real_filename
-						FROM ' . ATTACHMENTS_TABLE . '
-						WHERE attach_id IN (' . implode(', ', $marked) . ')';
-					$result = $db-&gt;sql_query($sql);
-
-					$log_attachments = array();
-					while ($row = $db-&gt;sql_fetchrow($result))
-					{
-						$log_attachments[] = $row['real_filename'];
-					}
-					$db-&gt;sql_freeresult($result);
-
-					delete_attachments('attach', $marked);
-
-					$log = (sizeof($delete_ids) == 1) ? 'ATTACHMENT_DELETED' : 'ATTACHMENTS_DELETED';
-					$meesage = (sizeof($delete_ids) == 1) ? $_CLASS['core_user']-&gt;lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']-&gt;lang['ATTACHMENTS_DELETED'];
-
-					add_log('admin', $log, implode(', ', $log_attachments));
-					trigger_error($message);
-				}
-			}
-
-			$colspan = 6;
-	
-			$uri = &quot;forums&amp;file=admin_users&amp;mode=$mode&amp;action=$action&amp;u=$user_id&quot;;
-
-			$sk_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['SORT_FILENAME'], 'b' =&gt; $_CLASS['core_user']-&gt;lang['SORT_COMMENT'], 'c' =&gt; $_CLASS['core_user']-&gt;lang['SORT_EXTENSION'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['SORT_SIZE'], 'e' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DOWNLOADS'], 'f' =&gt; $_CLASS['core_user']-&gt;lang['SORT_POST_TIME'], 'g' =&gt; $_CLASS['core_user']-&gt;lang['SORT_TOPIC_TITLE']);
-			$sk_sql = array('a' =&gt; 'a.real_filename', 'b' =&gt; 'a.comment', 'c' =&gt; 'a.extension', 'd' =&gt; 'a.filesize', 'e' =&gt; 'a.download_count', 'f' =&gt; 'a.filetime', 'g' =&gt; 't.topic_title');
-
-			$sd_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
-	
-			$s_sort_key = '';
-			foreach ($sk_text as $key =&gt; $value)
-			{
-				$selected = ($sk == $key) ? ' selected=&quot;selected&quot;' : '';
-				$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-			}
-
-			$s_sort_dir = '';
-			foreach ($sd_text as $key =&gt; $value)
-			{
-				$selected = ($sd == $key) ? ' selected=&quot;selected&quot;' : '';
-				$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-			}
-
-			$order_by = $sk_sql[$sk] . '  ' . (($sd == 'a') ? 'ASC' : 'DESC');
-	
-			$sql = 'SELECT COUNT(*) as num_attachments
-				FROM ' . ATTACHMENTS_TABLE . &quot;
-				WHERE poster_id = $user_id&quot;;
-			$result = $db-&gt;sql_query_limit($sql, 1);
-
-			$num_attachments = $db-&gt;sql_fetchfield('num_attachments', 0, $result);
-			$db-&gt;sql_freeresult($result);
-
-			$sql = 'SELECT a.*, t.topic_title
-				FROM ' . ATTACHMENTS_TABLE . ' a, ' . TOPICS_TABLE . &quot; t
-				WHERE a.topic_id = t.topic_id
-					AND a.poster_id = $user_id
-				ORDER BY $order_by&quot;;
-			$result = $db-&gt;sql_query_limit($sql, $config['posts_per_page'], $start);
-
-			$row_count = 0;
-			if ($row = $db-&gt;sql_fetchrow($result))
-			{
-				$class = 'row2';
-
-?&gt;
-				&lt;tr&gt;
-					&lt;th nowrap=&quot;nowrap&quot;&gt;#&lt;/th&gt;
-					&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;&lt;?php echo adminlink(&quot;$uri&amp;sk=a&amp;sd=&quot; . (($sk == 'a' &amp;&amp; $sd == 'a') ? 'd' : 'a')); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FILENAME']; ?&gt;&lt;/a&gt;&lt;/th&gt;
-					&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;&lt;?php echo adminlink(&quot;$uri&amp;sk=f&amp;sd=&quot; . (($sk == 'f' &amp;&amp; $sd == 'a') ? 'd' : 'a')); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['POST_TIME']; ?&gt;&lt;/a&gt;&lt;/th&gt;
-					&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;&lt;?php echo adminlink(&quot;$uri&amp;sk=d&amp;sd=&quot; . (($sk == 'd' &amp;&amp; $sd == 'a') ? 'd' : 'a')); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FILESIZE']; ?&gt;&lt;/a&gt;&lt;/th&gt;
-					&lt;th nowrap=&quot;nowrap&quot; width=&quot;5%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;&lt;?php echo adminlink(&quot;$uri&amp;sk=e&amp;sd=&quot; . (($sk == 'e' &amp;&amp; $sd == 'a') ? 'd' : 'a')); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DOWNLOADS']; ?&gt;&lt;/a&gt;&lt;/th&gt;
-					&lt;th width=&quot;2%&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&lt;/th&gt;
-				&lt;/tr&gt;
-&lt;?php
-
-				do
-				{
-					$view_topic = getlink('Forums&amp;file=viewtopic&amp;t=' . $row['topic_id'] . '&amp;p=' . $row['post_id'] . '#' . $row['post_id']);
-
-					$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; style=&quot;padding: 4px;&quot; width=&quot;2%&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&nbsp;&lt;?php echo $row_count + ($start + 1); ?&gt;&nbsp;&lt;/span&gt;&lt;/td&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; style=&quot;padding: 4px;&quot;&gt;&lt;a class=&quot;gen&quot; href=&quot;&lt;?php echo getlink('Forums&amp;file=download&amp;id=' . $row['attach_id']); ?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php echo $row['real_filename']; ?&gt;&lt;/a&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOPIC']; ?&gt;: &lt;a href=&quot;&lt;?php echo $view_topic; ?&gt;&quot; target=&quot;_blank&quot;&gt;&lt;?php echo $row['topic_title']; ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; class=&quot;gensmall&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;format_date($row['filetime'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']); ?&gt;&nbsp;&lt;/td&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo ($row['filesize'] &gt;= 1048576) ? (round($row['filesize'] / 1048576 * 100) / 100) . ' ' . $_CLASS['core_user']-&gt;lang['MB'] : (($row['filesize'] &gt;= 1024) ? (round($row['filesize'] / 1024 * 100) / 100) . ' ' . $_CLASS['core_user']-&gt;lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']-&gt;lang['BYTES']); ?&gt;&lt;/span&gt;&lt;/td&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;?php echo $row['download_count']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-						&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $row['attach_id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-					$row_count++;
-				} 
-				while ($row = $db-&gt;sql_fetchrow($result));
-			}
-			$db-&gt;sql_freeresult($result);
-			
-			$pagination = generate_pagination(&quot;$uri&amp;sk=$sk&amp;sd=$sd&quot;, $num_attachments, $config['topics_per_page'], $start);
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-							&lt;tr&gt;
-								&lt;td width=&quot;100%&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SORT_BY']; ?&gt;: &lt;/span&gt;&lt;select name=&quot;sk&quot;&gt;&lt;?php echo $s_sort_key; ?&gt;&lt;/select&gt; &lt;select name=&quot;sd&quot;&gt;&lt;?php echo $s_sort_dir; ?&gt;&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;sort&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SORT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-								&lt;td align=&quot;right&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delmarked&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_MARKED']; ?&gt;&quot; /&gt;&nbsp;&lt;/td&gt;
-							&lt;/tr&gt;
-						&lt;/table&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			break;
-	}
-
-
-?&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-
-&lt;?php
-
-
-	if ($pagination)
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $pagination; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-	adm_page_footer();
-
-}
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USER_ADMIN_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;post&quot; action=&quot;&lt;?php echo adminlink('forums&amp;file=admin_users'); ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;75%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_USER']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;&lt;?php echo getlink('Members_List&amp;mode=searchuser&amp;field=username'); ?&gt;&quot; onclick=&quot;window.open('&lt;?php echo getlink('Members_List&amp;mode=searchuser&amp;field=username')?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;username&quot; maxlength=&quot;50&quot; size=&quot;20&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submituser&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-
-// Module class
-class acp_admin_users extends module
-{
-
-
-
-
-}
-
-?&gt;
\ No newline at end of file

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/functions.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -499,28 +499,6 @@
 	return;
 }
 
-function language_select($default = '')
-{
-}
-
-// Pick a timezone
-function tz_select($default = '')
-{
-	global $sys_timezone, $_CLASS;
-
-	$tz_select = '';
-	foreach ($_CLASS['core_user']-&gt;lang['tz']['zones'] as $offset =&gt; $zone)
-	{
-		if (is_numeric($offset))
-		{
-			$selected = ($offset == $default) ? ' selected=&quot;selected&quot;' : '';
-			$tz_select .= '&lt;option value=&quot;' . $offset . '&quot;' . $selected . '&gt;' . $zone . '&lt;/option&gt;';
-		}
-	}
-
-	return $tz_select;
-}
-
 // Topic and forum watching common code
 function watch_topic_forum($mode, &amp;$s_watching, $user_id, $match_id, $notify_status = 'unset', $start = 0)
 {

Modified: trunk/includes/forums/message_parser.php
===================================================================
--- trunk/includes/forums/message_parser.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/forums/message_parser.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -942,7 +942,7 @@
 			// NOTE: obtain_* function? chaching the table contents?
 			
 
-			$sql = 'SELECT * FROM ' . SMILIES_TABLE;
+			$sql = 'SELECT * FROM ' . SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC';;
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/functions.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -647,45 +647,6 @@
 	return (STRIP_SLASHES) ? stripslashes($str) : $str ;
 }
 
-function theme_select($default = false)
-{
-	global $site_file_root, $_CLASS;
-	
-	$themetmp = array();
-	$default = ($default) ? $default : $_CLASS['core_display']-&gt;theme_name;
-	
-	$theme = '';
-	$handle = opendir($site_file_root.'themes');
-	while ($file = readdir($handle))
-	{
-		if ($file{0} !== '.')
-		{
-			if (file_exists($site_file_root.&quot;themes/$file/index.php&quot;))
-			{
-				$themetmp[] = array('file' =&gt; $file, 'template'=&gt; true);
-			}
-		}
-	}
-	
-	closedir($handle);
-	
-	$count = count($themetmp);
-	
-	for ($i = 0; $i &lt; $count; $i++)
-	{
-		if ($themetmp[$i]['file'] == $default)
-		{
-			$theme .= '&lt;option value=&quot;'.$themetmp[$i]['file'].'&quot; selected=&quot;selected&quot;&gt;'.$themetmp[$i]['file'].'&lt;/option&gt;';
-		}
-		else
-		{
-			$theme .= '&lt;option value=&quot;'.$themetmp[$i]['file'].'&quot;&gt;'.$themetmp[$i]['file'].'&lt;/option&gt;';
-		}
-	}
-	
-	return $theme;
-}
-
 function modify_lines($text, $replacement = '')
 {
 	return str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;, &quot;\n&quot;), $replacement, $text);
@@ -717,6 +678,78 @@
 	script_close($save);
 }
 
+function select_language($default = '')
+{
+}
+
+function select_theme($default = false)
+{
+	global $site_file_root, $_CLASS;
+	
+	if (!$default)
+	{
+		$default = $_CLASS['core_display']-&gt;theme_name;
+	}
+	
+	$theme_array = array();
+	$handle = opendir($site_file_root.'themes');
+	
+	while ($file = readdir($handle))
+	{
+		if ($file{0} !== '.')
+		{
+			if (file_exists($site_file_root.&quot;themes/$file/index.php&quot;))
+			{
+				$theme_array[] = array('file' =&gt; $file, 'template'=&gt; true);
+			}
+		}
+	}
+	
+	closedir($handle);
+	
+	$count = count($theme_array);
+	$select = '';
+
+	for ($i = 0; $i &lt; $count; $i++)
+	{
+		$selected = ($theme_array[$i]['file'] == $default) ? ' selected=&quot;selected&quot;' : '';
+		$select .= '&lt;option value=&quot;'.$theme_array[$i]['file'].&quot;\&quot; $selected&gt;&quot;.$theme_array[$i]['file'].&quot;&lt;/option&gt;\n&quot;;
+	}
+
+	return $select;
+}
+
+function tz_array()
+{
+	return array('-12', '-11', '-10', '-9', '-8', '-7', '-6', '-5', '-4', '-3.5', '-3', '-2', '-1', '0', 
+			'1', '2', '3','3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7', '8', '9.5', '10', '11', '12');
+}
+
+function select_tz($default = false)
+{
+	global $_CLASS;
+
+	$tz_array = tz_array();
+
+	$count = count($tz_array);
+	$select = '';
+	
+	/*if (!$default)
+	{
+		$default = $_CORE_CONFIG['global']['default_timezone'];
+	}*/
+	
+	for ($i = 0; $i &lt; $count; $i++)
+	{
+		$selected = ($tz_array[$i] == $default) ? ' selected=&quot;selected&quot;' : '';
+		$tz_dis = isset($_CLASS['core_user']-&gt;lang['tz']['zones'][$tz_array[$i]]) ? $_CLASS['core_user']-&gt;lang['tz']['zones'][$tz_array[$i]] : 'Zone '.$tz_array[$i];
+
+		$select .= '&lt;option value=&quot;'.$tz_array[$i].&quot;\&quot; $selected&gt;$tz_dis&lt;/option&gt;\n&quot;;
+	}
+
+	return $select;
+}
+
 function url_redirect($url = false, $save = false)
 {
 	redirect($url = false, $save = false);

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/functions_user.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -85,7 +85,8 @@
 		'group_id'		=&gt; (int) $data['user_group'],
 		'member_user_id'=&gt; (int) $user_id,
 		'member_status'	=&gt; $data['user_status']
-	);
+	));
+	
 	$_CLASS['core_db']-&gt;query($sql);
 
 	$_CLASS['core_db']-&gt;transaction('commit');
@@ -317,8 +318,8 @@
 {
 	global $_CLASS;
 
-	$group_ids = is_array($group_id) ? $group_id : array($group_id);
-	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+	$group_id = is_array($group_id) ? $group_id : array($group_id);
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
 	$group_id = array_map('intval', $group_id);
 
@@ -372,8 +373,8 @@
 {
 	global $_CLASS;
 
-	$group_ids = is_array($group_id) ? $group_id : array($group_id);
-	$user_ids = is_array($user_id) ? $user_id : array($user_id);
+	$group_id = is_array($group_id) ? $group_id : array($group_id);
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
 	$group_id = array_map('intval', $group_id);
 	$user_id = array_map('intval', $user_id);
@@ -383,42 +384,23 @@
 		return;
 	}
 
-	$sql = 'SELECT member_user_id, member_status FROM ' . USER_GROUP_TABLE . ' 
-				WHERE group_id IN (' . implode(', ', $group_id) . ')
-				AND member_user_id IN (' . implode(', ', $user_id) . ')
-				AND  = '.$status;
-	$result = $_CLASS['core_db']-&gt;query($sql);
+	$_CLASS['core_db']-&gt;transaction();
 
-	$update_array = array();
-	$ignore_array = array();
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	foreach ($user_id as $u_id)
 	{
-		$update_id[] = $row['user_id'];
+		foreach ($group_id as $g_id)
+		{
+			$data = array(
+				'group_id'		=&gt; (int) $g_id,
+				'user_id'		=&gt; (int) $u_id,
+				'member_status'	=&gt; (int) $status,
+			);
+		
+			$_CLASS['core_db']-&gt;query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']-&gt;sql_build_array('INSERT', $data));
+		}
 	}
-	$_CLASS['core_db']-&gt;free_result($result);
-	
-	// We move all users that are removed from the default groups to
-	// REGISTERED / REGISTERED_COPPA
-	if (!empty($defaults))
-	{
-// need to update/completion
-		$result = $_CLASS['core_db']-&gt;query('SELECT * FROM ' . GROUPS_TABLE . ' 	WHERE group_id = 4');
 
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		$sql = 'UPDATE FROM '. USERS_TABLE .' 
-					SET group_id = 4, user_rank = -1
-					WHERE user_id IN (' . implode(', ', $group_id) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-	}
-
-	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . '
-		WHERE group_id IN ('. implode(', ', $group_id) . ')
-		AND user_id IN ('. implode(', ', $user_id) .')';
-
-	$result = $_CLASS['core_db']-&gt;query($sql);
+	$_CLASS['core_db']-&gt;transaction('commit');
 }
 
 function validate_username($username)
@@ -436,14 +418,15 @@
 
 	if ($length &gt; $_CORE_CONFIG['user']['max_name_chars'] || $length &lt; $_CORE_CONFIG['user']['min_name_chars'])
 	{
-		return 'INVALID_LENGHT';
+		return 'USERNAME_INVALID_LENGHT';
 	}
 
 	if (!preg_match('#^' . $_CORE_CONFIG['user']['allow_name_chars'] . '$#i', $username))
 	{
-		return 'INVALID_CHARS';
+		return 'USERNAME_INVALID_CHARS';
 	}
-
+
+// wouldn't select limit be better ?
 	$sql = 'SELECT COUNT(*) as count
 		FROM ' . USERS_TABLE . &quot;
 		WHERE LOWER(username) = '&quot; . $_CLASS['core_db']-&gt;escape($username) . &quot;'&quot;;

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/includes/session.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -30,6 +30,8 @@
 	var $sid_link_prefex = 'sid';
 	var $sid_link = false;
 
+	var $autologin_code = false;
+
 	function start()
 	{
 		global $_CLASS, $_CORE_CONFIG, $SID, $mod;
@@ -253,10 +255,10 @@
 		{
 			$return = $user_id;
 			
-			$new_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
+			$this-&gt;autologin_code = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));
 
 			$data_array = array(
-				'auto_login_code'		=&gt; (string) $new_code,
+				'auto_login_code'		=&gt; (string) $this-&gt;autologin_code,
 				'auto_login_time'		=&gt; (int) $this-&gt;time,
 			);
 		
@@ -267,7 +269,7 @@
 
 			// need to update both the code and the user_id,
 			// since user_id cookie has an expiry time
-			$this-&gt;set_cookie('alc', $new_code, $this-&gt;time + 2592000);
+			$this-&gt;set_cookie('alc', $this-&gt;autologin_code, $this-&gt;time + 2592000);
 			$this-&gt;set_cookie('ali', $user_id, $this-&gt;time + 2592000);
 		}
 
@@ -293,14 +295,17 @@
 		{
 			$session_id = $this-&gt;data['session_id'];
 			
-			$this-&gt;set_cookie('sid', '', $this-&gt;time - 31536000);
+			if ($logout)
+			{
+				$this-&gt;set_cookie('sid', '', $this-&gt;time - 31536000);
+	
+				if ($this-&gt;autologin_code)
+				{
+					$this-&gt;autologin_destroy($this-&gt;data['user_id'], $this-&gt;autologin_code);
+				}
+			}
 		}
 
-		if ($logout)
-		{
-			
-		}
-
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . &quot;
 			WHERE session_id = '&quot; . $_CLASS['core_db']-&gt;escape($session_id).&quot;'&quot;;
 

Modified: trunk/javascript/collapse.js
===================================================================
--- trunk/javascript/collapse.js	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/javascript/collapse.js	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,41 +1,46 @@
 // Collapse Code by Ryan Marshall ( <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A> )
 
-// If we use this on news, we need some kind of true gc.
-// May not be possible tho without some php stuff
+/*
+* To do:
+*
+*	Add some kind of slide effect
+*	Auto opening on mouse over maybe ( closeing on mouse out ) ?	
+*/
 
-function get_cookie(Name)
+function get_cookie(cookie_name)
 {
-	var cookie_name = Name + &quot;=&quot;;
+	var cookie_prefix = cookie_name + &quot;=&quot;;
 	var cookie_length = document.cookie.length;
 
 	if (cookie_length &gt; 0)
 	{
-		var offset = document.cookie.indexOf(cookie_name);
+		var start = document.cookie.indexOf(cookie_prefix);
 
-		if (offset != -1)
+		if (start != -1)
 		{
-			offset += cookie_name.length;
-			var end = document.cookie.indexOf(';', offset);
+			start += cookie_prefix.length;
+			var end = document.cookie.indexOf(';', start);
 
 			if (end == -1)
 			{
 				end = cookie_length;
 			}
 
-			return unescape(document.cookie.substring(offset, end));
+			return unescape(document.cookie.substring(start, end));
 		}
-	}
+	}
+
 	return null;
 }
 
-function set_cookie(name, value, expires)
+function set_cookie(cookie_name, value, expires)
 {
-	document.cookie = name + '=' + escape(value) + '; path=/; expires=' + expires.toGMTString();
+	document.cookie = cookie_name + '=' + escape(value) + '; path=/; expires=' + expires.toGMTString();
 }
 
-function delete_cookie(name)
+function delete_cookie(cookie_name)
 {
-	document.cookie = name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
+	document.cookie = cookie_name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
 }
 
 function array_search(needle, haystack, strict)
@@ -50,55 +55,57 @@
 
 	return null;
 }
-
-function switch_collapse(id, name)
+
+function switch_collapse(identifier, cookie)
 {
-	var area = document.getElementById(id);
+	var area = document.getElementById(identifier);
+	var img = document.getElementById(identifier + '_img');
+
+	var item = document.getElementById(identifier + '_item');
 
 	if (area.style.display == 'none')
 	{
 		area.style.display = '';
-		switch_collapse_save(id, false, name);
+		switch_collapse_save(identifier, false, cookie);
+		
+		if (img)
+		{
+			img.src = img.src.replace('show', 'hide');
+		}
+
+		if (item)
+		{
+			item.className = item.className.replace('show', 'hide');
+		}
 	}
 	else
 	{
 		area.style.display = 'none';
-		switch_collapse_save(id, id, name);
-	}
-}
+		switch_collapse_save(identifier, true, cookie);
+		
+		if (img)
+		{
+			img.src = img.src.replace('hide', 'show');
+		}
 
-function switch_collapse_img(id, img_show, img_hide, name)
-{
-	var area = document.getElementById(id);
-	var img = document.getElementById(id+'_img');
-
-	if (area.style.display == 'none')
-	{
-		area.style.display = '';
-		img.src = img_show;
-
-		switch_collapse_save(id, false, name);
+		if (item)
+		{
+			item.className = item.className.replace('hide', 'show');
+		}
 	}
-	else
-	{
-		area.style.display = 'none';
-		img.src = img_hide;
-
-		switch_collapse_save(id, id, name);
-	}
 }
 
-function switch_collapse_save(id, save, name)
+function switch_collapse_save(identifier, save, cookie_name)
 {
 	// typeof name == 'undefined'
-	if (!name)
+	if (!cookie_name)
 	{
-		name = 'collapsed_items';
+		cookie_name = 'collapsed_items';
 	}
 
-	//alert(name);
+	//alert(cookie_name);
 
-	var collapsed_cookie = get_cookie(name);
+	var collapsed_cookie = get_cookie(cookie_name);
 	var collapsed_items = new Array();
 	var set = false;
 
@@ -108,7 +115,7 @@
 
 		for (var i in collapsed_cookie)
 		{
-			if (collapsed_cookie[i] == id)
+			if (collapsed_cookie[i] == identifier)
 			{
 				if (set == false)
 				{
@@ -116,7 +123,7 @@
 
 					if (save != false)
 					{
-						collapsed_items.push(id);
+						collapsed_items.push(identifier);
 					}
 				}
 			}
@@ -129,7 +136,7 @@
 
 	if (set == false &amp;&amp; save != false)
 	{
-		collapsed_items.push(id);
+		collapsed_items.push(identifier);
 	}
 
 	//alert(collapsed_items.join(':'));
@@ -138,10 +145,10 @@
 		var expires = new Date()
 
 		expires.setTime(expires.getTime() + 31536000000);
-		set_cookie(name, collapsed_items.join(':'), expires)
+		set_cookie(cookie_name, collapsed_items.join(':'), expires)
 	}
 	else
 	{
-		delete_cookie(name)
+		delete_cookie(cookie_name)
 	}
 }
\ No newline at end of file

Modified: trunk/javascript/menu.js
===================================================================
--- trunk/javascript/menu.js	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/javascript/menu.js	2005-08-24 15:00:26 UTC (rev 89)
@@ -116,9 +116,6 @@
 
 	menu.style.display	= '';
 	
-//Move to init function, once done
-	menu.style.position	= 'absolute';
-
 	if ((object_offsets['left'] + menu.offsetWidth) &gt; document.body.clientWidth)
 	{
 		// It to wide to show on the right so we have to put it on the left

Modified: trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -1,16 +1,26 @@
 &lt;?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_groups.php,v 1.1 2004/09/01 15:47:45 psotfx Exp $
-//
-// FILENAME  : ucp_groups.php
-// STARTED   : Sun Jun 6, 2004
-// COPYRIGHT : &#169; 2001, 2004 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS &#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_groups extends module
 {
 	function ucp_groups($id, $mode)
@@ -19,30 +29,34 @@
 
 		$_CLASS['core_user']-&gt;add_lang('groups');
 
-		$submit	= !empty($_POST['submit']);
+		$submit	= isset($_POST['submit']) ? $_POST['submit'] : false;
 
-		if (is_array($_POST['group_id']))
+		if ($submit &amp;&amp; !empty($_POST['group_id']))
 		{
-			$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
-		}
-		elseif 
-		{
-			if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+			if (is_array($_POST['group_id']))
 			{
-				$group_id = array($group_id);
+				$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
 			}
-		}
-	
-
-		if ($submit &amp;&amp; !empty($group_id))
-		{
+			else
+			{
+				if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+				{
+					$group_id = array($group_id);
+				}
+				else
+				{
+					die;
+				}
+			}
+//empty(array())
 			require_once($site_file_root.'includes/functions_user.php');
 
 			switch ($_POST['mode'])
 			{
 				case 'resign':
+// need to get member status and add other group types ( pending members can resign from all )
 					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
-								WHERE group_type = ' . GROUP_SPECIAL .'
+								WHERE group_type = ' . GROUP_SYSTEM .'
 								AND group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -60,30 +74,47 @@
 				break;
 
 				case 'apply':
+// users can be added 2x here, check to see if they are in the group first
+					$sql = 'SELECT group_id, FROM ' . USER_GROUP_TABLE . '
+						WHERE  group_id IN ('. implode(', ', $group_id) .')';
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$unset = array();
+
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$unset[] = $row['group_id'];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
 					$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
-								WHERE group_type IN (' . GROUP_REQUEST .', ' . GROUP_UNRESTRAINED .')
-								AND group_id IN ('. implode(', ', $group_id) .')';
+								WHERE group_id IN ('. implode(', ', $group_id) .')';
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
-					$group_id = array()
+					$group_id = array();
 
 					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 					{
-						if ($row['user_id'] == STATUS_ACTIVE)
+						$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
+
+						if ($row['group_status'] == STATUS_ACTIVE)
 						{
-							$group_id[] = $row['user_id'];
+							$group_id[$status][] = $row['group_id'];
 						}
 					}
 					$_CLASS['core_db']-&gt;free_result($result);
 
-					groups_user_remove($group_ids, $_CLASS['core_user']-&gt;data['user_id']);
+					foreach ($group_id as $status =&gt; $ids)
+					{
+						groups_user_add($ids, $_CLASS['core_user']-&gt;data['user_id'], $status);
+					}
 				break;		
 			}
 		}
 
 		$error = $data = array();
 
-		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.user_status
+		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
 			FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
 			WHERE ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 				AND g.group_id = ug.group_id
@@ -95,13 +126,13 @@
 		{
 			$row['group_status'] = STATUS_ACTIVE;
 
-			$block = ($row['user_status'] == STATUS_LEADER) ? 'leader' : (($row['user_status'] == STATUS_PENDING) ? 'pending' : 'member');
+			$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
 			$_CLASS['core_template']-&gt;assign_vars_array($block, array(
 				'GROUP_ID'			=&gt; $row['group_id'],
 				'GROUP_NAME'		=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'		=&gt; $row['group_description'],
-				'GROUP_RESIGN'		=&gt; ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL &amp;&amp; $row['user_status'] == STATUS_PENDING),
+				'GROUP_RESIGN'		=&gt; ($row['group_type'] != GROUP_SYSTEM || ($row['group_type'] == GROUP_SPECIAL &amp;&amp; $row['member_status'] == STATUS_PENDING)),
 				'U_VIEW_GROUP'		=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
 				'S_GROUP_DEFAULT'	=&gt; ($row['group_id'] == $_CLASS['core_user']-&gt;data['group_id']) ? true : false
 			));
@@ -110,33 +141,30 @@
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
-		// Hide hidden groups unless user is an admin with group privileges
-		$sql_and = ($_CLASS['auth']-&gt;acl_gets('a_group', 'a_groupadd', 'a_groupdel')) ? '&lt;&gt; ' . GROUP_SYSTEM : 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
+		$sql_and = 'NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
 		$sql = 'SELECT group_id, group_name, group_description, group_type
 			FROM ' . GROUPS_TABLE . '
-			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . &quot;)
-				AND group_type $sql_and
+			WHERE group_id NOT IN (' . implode(', ', $group_id_ary) . ')
+				AND group_status = '. STATUS_ACTIVE .&quot;
 			ORDER BY group_type DESC, group_name&quot;;
 		$result = $_CLASS['core_db']-&gt;query($sql);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$row['group_status'] = STATUS_ACTIVE;
-
 			$_CLASS['core_template']-&gt;assign_vars_array('nonmember', array(
 				'GROUP_ID'		=&gt; $row['group_id'],
 				'GROUP_NAME'	=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
 				'GROUP_DESC'	=&gt; $row['group_description'],
-				'GROUP_APPLY'	=&gt; ($row['group_type'] != GROUP_SYSTEM &amp;&amp; $row['group_status'] == STATUS_ACTIVE),
+				'GROUP_APPLY'	=&gt; true,
 				'U_VIEW_GROUP'	=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
 			));
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		$_CLASS['core_template']-&gt;assign(array(
-		'S_DISPLAY_FORM', true,
-		'S_UCP_ACTION' =&gt; ''
+			'S_DISPLAY_FORM', true,
+			'S_UCP_ACTION' =&gt; ''
 		));
 
 		$this-&gt;display($_CLASS['core_user']-&gt;get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');

Modified: trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -153,9 +153,9 @@
 
 					'DATE_FORMAT'		=&gt; $dateformat, 
 
-					'S_LANG_OPTIONS'	=&gt; language_select($lang), 
-					'S_THEME_OPTIONS'	=&gt; theme_select($theme),
-					'S_TZ_OPTIONS'		=&gt; tz_select($tz),
+					'S_LANG_OPTIONS'	=&gt; select_language($lang), 
+					'S_THEME_OPTIONS'	=&gt; select_theme($theme),
+					'S_TZ_OPTIONS'		=&gt; select_tz($tz),
 					'S_CAN_HIDE_ONLINE'	=&gt; true, 
 					'S_SELECT_NOTIFY'	=&gt; ($config['jab_enable'] &amp;&amp; $_CLASS['core_user']-&gt;data['user_jabber'] &amp;&amp; @extension_loaded('xml')) ? true : false)
 				);

Modified: trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-22 15:55:13 UTC (rev 88)
+++ trunk/modules/Control_Panel/ucp/ucp_register.php	2005-08-24 15:00:26 UTC (rev 89)
@@ -27,16 +27,18 @@
 	{
 		global $site_file_root, $config, $_CLASS, $_CORE_CONFIG;
 		
-		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE)
+		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
+		$submit		= isset($_POST['submit']);
+
+		if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_DISABLE
+			|| ($coppa || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+			&amp;&amp; !$_CORE_CONFIG['email']['email_enable'])
 		{
 			trigger_error('UCP_REGISTER_DISABLE');
 		}
 
 		$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
 
-		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
-		$submit		= isset($_POST['submit']);
-
 		$error = $data = array();
 		$s_hidden_fields = '';
 
@@ -85,8 +87,10 @@
 
 			$username	= get_variable('username', 'POST', false);
 			$password	= get_variable('password', 'POST', false);
-			$email		= get_variable('email', 'POST', false);
-			
+
+			$email			= get_variable('email', 'POST', false);
+			$email_confirm	= get_variable('email_confirm', 'POST', '');
+
 			//when we add this make sure to confirm that it's one of the installed langs
 			$lang		= $_CORE_CONFIG['global']['default_lang'];
 			$tz			= get_variable('tz', 'POST', false);
@@ -100,19 +104,28 @@
 
 			if ($username_validate !== true)
 			{
-				$error[] = $username_validate;
+				$error[] = $_CLASS['core_user']-&gt;get_lang($username_validate);
 			}
 
 			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
 			{
-				$error[] = 'PASSWORD_ERROR';
+				$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_ERROR');
 			}
 
-			if (!$email || $email !== get_variable('email_confirm', 'POST', ''))
+			if (!$email || $email !== $email_confirm)
 			{
-				$error[] = 'PASSWORD_ERROR';
+				$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_ERROR');
 			}
+			elseif (!check_email($email))
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_INVALID');
+			}
 
+			if (!$tz || !in_array($tz, tz_array()))
+			{
+				$tz = null;
+			}
+
 			if ($_CORE_CONFIG['user']['enable_confirm'])
 			{
 				$confirmation_code = $_CLASS['core_user']-&gt;session_data_get('confirmation_code');
@@ -120,22 +133,15 @@
 
 				if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
 				{
-					$error[] = $_CLASS['core_user']-&gt;lang['CONFIRM_CODE_WRONG'];
+					$error[] = $_CLASS['core_user']-&gt;get_lang('CONFIRM_CODE_WRONG');
 				}
 
 				// we don't need this any more
 				$_CLASS['core_user']-&gt;user_data_kill('confirmation_code');
 			}
 
-		//$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
 			if (empty($error))
 			{
-				// Tz need to be moved out of the lang file, only use it for languages
-				if (!$tz || !in_array($tz, $_CLASS['core_user']-&gt;lang['tz']['zones']))
-				{
-					$tz = null;
-				}
-	
 				$password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
 	
 				if (!$password)
@@ -151,14 +157,33 @@
 						//do some admin contact thing here
 						die('Try again later');
 					}
-	
+
 					$user_status = STATUS_PENDING;
 					$user_act_key = generate_string(10);
+
+					if ($coppa)
+					{
+						$message = $_CLASS['core_user']-&gt;lang['ACCOUNT_COPPA'];
+						$email_template = 'coppa_welcome_inactive';
+					}
+					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF)
+					{
+						$message = $_CLASS['core_user']-&gt;lang['ACCOUNT_INACTIVE'];
+						$email_template = 'user_welcome_inactive';
+					}
+					elseif ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
+					{
+						$message = $_CLASS['core_user']-&gt;lang['ACCOUNT_INACTIVE_ADMIN'];
+						$email_template = 'admin_welcome_inactive';
+					}
 				}
 				else
 				{
 					$user_status = STATUS_ACTIVE;
 					$user_act_key = null;
+
+					$email_template = 'user_welcome';
+					$message = $_CLASS['core_user']-&gt;lang['ACCOUNT_ADDED'];
 				}
 	
 				if ($user_status === STATUS_ACTIVE)
@@ -167,7 +192,7 @@
 					set_core_config('user', 'newest_username', $row['username'], false);
 					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
 				}
-	
+
 				$data = array(
 					'username'		=&gt; $username,
 					'user_email'	=&gt; $email,
@@ -179,7 +204,7 @@
 					'user_password'			=&gt; $password,
 					'user_password_encoding'=&gt; $_CORE_CONFIG['user']['password_encoding'],
 
-					'user_lang'			=&gt; ($lang == $_CORE_CONFIG['global']['default_lang']) ? null :$lang ,
+					'user_lang'			=&gt; ($lang == $_CORE_CONFIG['global']['default_lang']) ? null : $lang,
 					'user_type'			=&gt; USER_NORMAL,
 					'user_status'		=&gt; $user_status,
 					'user_act_key'		=&gt; $user_act_key,
@@ -187,38 +212,72 @@
 				);
 
 				user_add($data);
+				unset($data);
+
+				require_once($site_file_root.'includes/mailer.php');
+		
+				$mailer = new core_mailer();
+
+				$mailer-&gt;to($email, $username);
+				$mailer-&gt;subject($subject);
+
+				// change this don't want to use phpBBs template
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
+					'WELCOME_MSG'   =&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
+					'USERNAME'		=&gt; $username,
+					'PASSWORD'		=&gt; $password,
+					'EMAIL_SIG'		=&gt; '', //I like this
+					'U_ACTIVATE'	=&gt; generate_link(&quot;system&amp;mode=activate&amp;user_id=$user_id&amp;key=$user_act_key&quot;, array('sid' =&gt; false, 'full' =&gt; true))
+				));
+
+				if ($coppa)
+				{
+					$_CLASS['core_template']-&gt;assign_array(array(
+						'FAX_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_fax'],
+						'MAIL_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_mail'],
+						'EMAIL_ADDRESS' =&gt; $email,
+						'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'])
+					);
+				}
+
+				$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('modules/Control_Panel/email/'.$email_template, true));
+
+				$mailer-&gt;send();
+
+				$message = $message . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;'. generate_link() .'&quot;&gt;', '&lt;/a&gt;');
+				trigger_error($message);
 			}
 		}
 
 		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;coppa&quot; value=&quot;' . $coppa . '&quot; /&gt;';
 		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;agreed&quot; value=&quot;true&quot; /&gt;';
-		$confirm_image = '';
 		
-		// Visual Confirmation - Show images
 		if ($_CORE_CONFIG['user']['enable_confirm'])
 		{
-			if ($submit)
+			$_CLASS['core_user']-&gt;session_data_set('confirmation_code', generate_string(6));
+			$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';
+		}
+		else
+		{
+			$confirm_image = false;
+		}
+
+		if ($submit)
+		{
+			if ($_CORE_CONFIG['user']['max_reg_attempts'])
 			{
-				if ($_CORE_CONFIG['user']['max_reg_attempts'])
+				$attempts = (int) $_CLASS['core_user']-&gt;session_data_get('reg_attempts', 0);
+
+				if ($attempts &gt; $_CORE_CONFIG['user']['max_reg_attempts'])
 				{
-					$attempts = (int) $_CLASS['core_user']-&gt;session_data_get('reg_attempts');
-
-					if ($attempts &gt;= $_CORE_CONFIG['user']['max_reg_attempts'])
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['TOO_MANY_REGISTERS']);
-					}
-
-					$_CLASS['core_user']-&gt;session_data_get('reg_attempts', ($attempts + 1));
+					trigger_error($_CLASS['core_user']-&gt;lang['TOO_MANY_REGISTERS']);
 				}
 
-				$_CLASS['core_user']-&gt;session_data_set('confirmation_code', generate_string(6));
+				$_CLASS['core_user']-&gt;session_data_get('reg_attempts', ($attempts + 1));
 			}
-
-			$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';
 		}
 
-		$l_reg_cond = '';
-
 		switch ($_CORE_CONFIG['user']['require_activation'])
 		{
 			case USER_ACTIVATION_SELF:
@@ -228,25 +287,29 @@
 			case USER_ACTIVATION_ADMIN:
 				$l_reg_cond = $_CLASS['core_user']-&gt;lang['UCP_ADMIN_ACTIVATE'];
 			break;
+			
+			default:
+				$l_reg_cond = '';
+			break;
 		}
 
 		$user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
 
-		$_CLASS['core_template']-&gt;assign(array(
-			'ERROR'						=&gt; empty($error) ? false : implode('&lt;br /&gt;', $error), 
-			'USERNAME'					=&gt; isset($username) ? $username : '',
-			'PASSWORD'					=&gt; isset($password) ? $password : '',
-			'EMAIL'						=&gt; isset($email) ? $email : '',
-			'EMAIL_CONFIRM'				=&gt; isset($email_confirm) ? $email_confirm : '', // should remove this also maybe
-			'CONFIRM_IMG'				=&gt; $confirm_image,
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'ERROR'			=&gt; empty($error) ? false : implode('&lt;br /&gt;', $error), 
+			'USERNAME'		=&gt; isset($username) ? $username : '',
+			'PASSWORD'		=&gt; isset($password) ? $password : '',
+			'EMAIL'			=&gt; isset($email) ? $email : '',
+			'EMAIL_CONFIRM'	=&gt; isset($email_confirm) ? $email_confirm : '',
+			'CONFIRM_IMG'	=&gt; $confirm_image,
+			'SELECT_TZ'		=&gt; select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
 			'L_CONFIRM_EXPLAIN'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['CONFIRM_EXPLAIN'], '&lt;a href=&quot;mailto:' . htmlentities($config['board_contact']) . '&quot;&gt;', '&lt;/a&gt;'), 
 			'L_ITEMS_REQUIRED'			=&gt; $l_reg_cond, 
 			'L_USERNAME_EXPLAIN'		=&gt; sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
 			'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 
-			//'S_LANG_OPTIONS'	=&gt; language_select($lang), 
-			'S_TZ_OPTIONS'		=&gt; tz_select(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
+
 			'S_COPPA'			=&gt; $coppa, 
 			'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields,
 			'S_UCP_ACTION'		=&gt; generate_link(&quot;Control_Panel&amp;mode=register&quot;))


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000012.html">[Viperals-svncheckins] r88 - in trunk: admin images includes includes/auth includes/crons includes/forums includes/forums/admin includes/templates includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users includes/templates/modules includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Quick_Message install modules/Control_Panel modules/Control_Panel/ucp modules/Quick_Message
</A></li>
	<LI>Next message: <A HREF="000014.html">[Viperals-svncheckins] r90 - in trunk: . admin blocks includes includes/templates/admin includes/templates/admin/users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13">[ date ]</a>
              <a href="thread.html#13">[ thread ]</a>
              <a href="subject.html#13">[ subject ]</a>
              <a href="author.html#13">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
