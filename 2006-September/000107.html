<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r188 - in cms/trunk: . admin admin/functions	includes includes/auth includes/cache includes/display	includes/forums includes/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/forums/language
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2006-September/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r188%20-%20in%20cms/trunk%3A%20.%20admin%20admin/functions%0A%09includes%20includes/auth%20includes/cache%20includes/display%0A%09includes/forums%20includes/forums/admin%20install%20javascript%0A%09modules/control_panel/modules%20modules/forums%0A%09modules/forums/admin%20modules/forums/language&In-Reply-To=%3C200609210641.k8L6fbsO027554%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000106.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r188 - in cms/trunk: . admin admin/functions	includes includes/auth includes/cache includes/display	includes/forums includes/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/forums/language</H1>
    <B>viperal at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r188%20-%20in%20cms/trunk%3A%20.%20admin%20admin/functions%0A%09includes%20includes/auth%20includes/cache%20includes/display%0A%09includes/forums%20includes/forums/admin%20install%20javascript%0A%09modules/control_panel/modules%20modules/forums%0A%09modules/forums/admin%20modules/forums/language&In-Reply-To=%3C200609210641.k8L6fbsO027554%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r188 - in cms/trunk: . admin admin/functions	includes includes/auth includes/cache includes/display	includes/forums includes/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/forums/language">viperal at mail.berlios.de
       </A><BR>
    <I>Thu Sep 21 08:41:37 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000106.html">[Viperals-svncheckins] r187 - in cms/trunk: . admin includes	includes/auth includes/forums includes/forums/admin	includes/forums/mcp includes/templates/admin/modules	includes/templates/modules/control_panel	includes/templates/modules/forums	includes/templates/modules/forums/admin install	javascript/forums modules/control_panel	modules/control_panel/modules modules/forums	modules/forums/admin modules/forums/images	modules/forums/images/admin modules/forums/images/en	modules/forums/language modules/members_list
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#107">[ date ]</a>
              <a href="thread.html#107">[ thread ]</a>
              <a href="subject.html#107">[ subject ]</a>
              <a href="author.html#107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2006-09-21 08:41:32 +0200 (Thu, 21 Sep 2006)
New Revision: 188

Added:
   cms/trunk/admin/pages.php
   cms/trunk/admin/smiles.php
   cms/trunk/includes/forums/admin/admin_logs.php
   cms/trunk/includes/forums/admin/admin_permission_roles.php
   cms/trunk/modules/forums/language/admin_attachments.php
   cms/trunk/modules/forums/language/admin_board.php
   cms/trunk/modules/forums/language/admin_posting.php
   cms/trunk/modules/forums/language/admin_prune.php
Removed:
   cms/trunk/includes/forums/admin/admin_database.php
   cms/trunk/includes/forums/admin/admin_disallow.php
   cms/trunk/includes/forums/admin/admin_email.php
   cms/trunk/includes/forums/admin/admin_jabber.php
   cms/trunk/includes/forums/admin/admin_phpinfo.php
   cms/trunk/includes/forums/admin/admin_profile.php
   cms/trunk/includes/forums/admin/admin_prune_users.php
   cms/trunk/includes/forums/admin/admin_search.php
   cms/trunk/includes/forums/admin/admin_viewlogs.php
   cms/trunk/includes/forums/admin/admin_words.php
   cms/trunk/includes/forums/functions_compress.php
   cms/trunk/includes/forums/functions_jabber.php
   cms/trunk/includes/forums/functions_module.php
   cms/trunk/includes/forums/functions_profile_fields.php
   cms/trunk/includes/forums/functions_user.php
   cms/trunk/modules/forums/search.php
Modified:
   cms/trunk/admin.php
   cms/trunk/admin/blocks.php
   cms/trunk/admin/functions/block_functions.php
   cms/trunk/admin/functions/page_functions.php
   cms/trunk/admin/menu.php
   cms/trunk/admin/messages.php
   cms/trunk/admin/modules.php
   cms/trunk/admin/system.php
   cms/trunk/core.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/cache/cache.php
   cms/trunk/includes/cache/cache_eaccelerator.php
   cms/trunk/includes/cache/cache_file.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/forums/admin/admin_attachments.php
   cms/trunk/includes/forums/admin/admin_bbcodes.php
   cms/trunk/includes/forums/admin/admin_board.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/admin/admin_icons.php
   cms/trunk/includes/forums/admin/admin_permissions.php
   cms/trunk/includes/forums/admin/admin_prune.php
   cms/trunk/includes/forums/admin/admin_ranks.php
   cms/trunk/includes/forums/admin/auth.php
   cms/trunk/includes/forums/admin/links.php
   cms/trunk/includes/forums/admin/main.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/functions_upload.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/handler.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/editor.js
   cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
   cms/trunk/modules/control_panel/modules/ucp_profile.php
   cms/trunk/modules/control_panel/modules/ucp_register.php
   cms/trunk/modules/forums/admin/index.php
   cms/trunk/modules/forums/download.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/report.php
   cms/trunk/modules/forums/viewforum.php
Log:


Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/blocks.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -29,7 +29,7 @@
 global $_CLASS;
 
 
-$_CLASS['core_user']-&gt;add_lang('admin/blocks.php');
+$_CLASS['core_user']-&gt;add_lang('admin/blocks', null);
 $message = false;
 
 function check_position($position, $redirect = true)

Modified: cms/trunk/admin/functions/block_functions.php
===================================================================
--- cms/trunk/admin/functions/block_functions.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/functions/block_functions.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -75,6 +75,11 @@
 		trigger_error('BLOCK_NOT_FOUND');
 	}
 
+	if ($block['page_status'] != STATUS_ACTIVE &amp;&amp; $block['page_status'] != STATUS_DISABLED)
+	{
+		trigger_error('INVALID_STATUS');
+	}
+
 	check_position($block['block_position']);
 	$status = ($block['block_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 

Modified: cms/trunk/admin/functions/page_functions.php
===================================================================
--- cms/trunk/admin/functions/page_functions.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/functions/page_functions.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -121,9 +121,9 @@
 
 	if (display_confirmation())
 	{
-		if ($page['page_type'] === PAGE_TEMPLATE)
+		if ($page['page_type'] == PAGE_TEMPLATE)
 		{
-		// remove template
+			@unlink(SITE_FILE_ROOT.'includes/templates/'.$page['page_location']);
 		}
 
 		$_CLASS['core_db']-&gt;query('DELETE from ' . CORE_PAGES_TABLE . ' WHERE page_id = '.$id);

Modified: cms/trunk/admin/menu.php
===================================================================
--- cms/trunk/admin/menu.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/menu.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -48,9 +48,9 @@
 $menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMIN_INDEX'), 'link' =&gt; generate_link('forums', array('admin' =&gt; true)));
 $menu['forums'][] = '';
 $menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MANAGE_FORUMS'), 'link' =&gt; generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('PERMISSIONS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=forum', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMINISTRATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=admin', array('admin' =&gt; true)));
-$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MODERATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=mod', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('PERMISSIONS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=setting_forum_local', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('ADMINISTRATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=setting_admin_global', array('admin' =&gt; true)));
+$menu['forums'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('MODERATORS'), 'link' =&gt; generate_link('forums&amp;file=admin_permissions&amp;mode=setting_mod_local', array('admin' =&gt; true)));
 
 $menu['system'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SYSTEM'), 'link' =&gt; generate_link('system', array('admin' =&gt; true)));
 $menu['system'][] = array('lang' =&gt; $_CLASS['core_user']-&gt;get_lang('SITE_SETTINGS'), 'link' =&gt; generate_link('system&amp;mode=site', array('admin' =&gt; true)));

Modified: cms/trunk/admin/messages.php
===================================================================
--- cms/trunk/admin/messages.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/messages.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -29,7 +29,7 @@
 global $_CLASS;
 
 require_once SITE_FILE_ROOT.'admin/functions/block_functions.php';
-$_CLASS['core_user']-&gt;add_lang('admin/blocks.php');
+$_CLASS['core_user']-&gt;add_lang('admin/blocks', null);
 
 function check_position($position, $redirect = true)
 {

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/modules.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -28,7 +28,7 @@
 
 global $_CLASS;
 
-$_CLASS['core_user']-&gt;add_lang('admin/blocks.php');
+$_CLASS['core_user']-&gt;add_lang('admin/blocks', null);
 
 $mode = get_variable('mode', 'GET', false);
 
@@ -117,7 +117,7 @@
 			break;
 
 			case 'edit':
-				$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '. CORE_PAGES_TABLE .&quot; WHERE page_id = $id AND page_type = &quot;. PAGE_MODULE);
+				$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '. CORE_PAGES_TABLE .' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 				$_CLASS['core_db']-&gt;free_result($result);
 
@@ -125,9 +125,39 @@
 				{
 					trigger_error('MODULE_NOT_FOUND');
 				}
-				
+
+				if ($module['page_status'] != STATUS_ACTIVE &amp;&amp; $module['page_status'] != STATUS_DISABLED)
+				{
+					trigger_error('MODULE_NOT_INSTALLED');
+				}
+	
 				check_type($module['page_type']);
+
+				if (isset($_POST['submit']))
+				{
+					$blocks_array = get_variable('blocks_array', 'POST', array(), 'array:int');
+					$active = get_variable('active', 'POST', 0, 'int');
+
+					$data = array();
+					$data['page_title'] = get_variable('title', 'POST', null);
+					$data['page_status'] = ($active) ? STATUS_ACTIVE : STATUS_DISABLED;
+
+					$data['page_blocks'] = 0;
+
+					foreach ($blocks_array as $value)
+					{
+						$data['page_blocks'] |= (1 &lt;&lt; $value);
+					}
+
+					$_CLASS['core_db']-&gt;query('UPDATE '.CORE_PAGES_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $data) .'  WHERE page_id = '.$id);
+
+					unset($data, $blocks_array, $active);
+
+					break;
+				}
+
 				settype($module['page_status'], 'int');
+				settype($module['page_blocks'], 'int');
 
 				$page_blocks_array = array(
 					array(
@@ -163,11 +193,11 @@
 				);
 				
 				$_CLASS['core_template']-&gt;assign_array(array(
-					'ADMIN_PAGE_ACTION'			=&gt; generate_link('modules&amp;mode=edit', array('admin' =&gt; true)),
+					'ADMIN_PAGE_ACTION'			=&gt; generate_link('modules&amp;mode=edit&amp;id='.$id, array('admin' =&gt; true)),
 					'ADMIN_PAGE_TITLE'			=&gt; $module['page_title'],
 					'ADMIN_PAGE_NAME'			=&gt; mb_convert_case(preg_replace('/_/', ' ', $module['page_name']), MB_CASE_TITLE),
 					'ADMIN_PAGE_BLOCKS_ARRAY'	=&gt; $page_blocks_array,
-					'ADMIN_PAGE_STATUS'			=&gt; $module['page_status'],
+					'ADMIN_PAGE_ACTIVE'			=&gt; ($module['page_status'] == STATUS_ACTIVE) ? true : false,
 					'ADMIN_PAGE_ERROR'			=&gt; '',
 				));
 			
@@ -175,7 +205,7 @@
 			break;
 
 			case 'install':
-				$result = $_CLASS['core_db']-&gt;query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.&quot; WHERE page_id = $id AND page_type = &quot;. PAGE_MODULE);
+				$result = $_CLASS['core_db']-&gt;query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
 				$module = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 				$_CLASS['core_db']-&gt;free_result($result);
 

Added: cms/trunk/admin/pages.php
===================================================================
--- cms/trunk/admin/pages.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/pages.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,338 @@
+&lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (VIPERAL != 'Admin') 
+{
+	die;
+}
+
+global $_CLASS;
+
+$_CLASS['core_user']-&gt;add_lang('admin/blocks', null);
+
+$mode = get_variable('mode', 'GET', false);
+
+function check_type(&amp;$type, $redirect = true)
+{
+	$appoved_type = array(PAGE_TEMPLATE);
+	$type = (int) $type;
+	
+	if (!in_array($type, $appoved_type, true))
+	{
+		if ($redirect)
+		{
+			redirect(generate_link('pages', array('admin' =&gt; true, 'full' =&gt; true)));
+		}
+		return false;
+	}
+
+	return true;
+}
+		
+if (isset($_REQUEST['mode']))
+{
+	if ($_REQUEST['mode'] === 'upload')
+	{
+		//$page_name = get_variable('page_name', 'POST', false);
+		$page_title = get_variable('page_title', 'POST', false);
+		$page_name = mb_strtolower(str_replace(' ', '_', $page_title));
+
+		if (!empty($_FILES['file_upload']) &amp;&amp; $page_name)
+		{
+
+			if (!is_uploaded_file($_FILES['file_upload']['tmp_name']))
+			{
+				trigger_error('FILE_UPLOAD_ERROR');
+				die;
+			}
+
+			$destination = SITE_FILE_ROOT.'includes/templates/pages/'.$_FILES['file_upload']['name'];
+			if (file_exists($destination))
+			{
+				trigger_error('FILE_UPLOAD_ERROR');
+				die;
+			}
+
+			if (!@move_uploaded_file($_FILES['file_upload']['tmp_name'], $destination))
+			{
+				trigger_error('FILE_UPLOAD_ERROR');
+				die;
+			}
+
+			$insert_array =  array(
+				'page_name'			=&gt; (string) $page_name,
+				'page_title'		=&gt; (string) $page_title,
+				'page_type'			=&gt; PAGE_TEMPLATE,
+				'page_location'		=&gt; 'pages/'.$_FILES['file_upload']['name'],
+				'page_status'		=&gt; STATUS_PENDING,
+			);
+
+			$_CLASS['core_db']-&gt;sql_query_build('INSERT', $insert_array, CORE_PAGES_TABLE);
+			unset($insert_array, $page_name, $page_title);
+		}
+		else
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'ACTION_SUBMIT'			=&gt; generate_link('pages&amp;mode=upload', array('admin' =&gt; true)),
+			));
+	
+			$_CLASS['core_display']-&gt;display(false, 'admin/pages/upload.html');
+		}
+	}
+	elseif ($id = get_variable('id', 'GET', false, 'int'))
+	{
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
+
+				page_change($id);
+			break;
+
+			case 'edit':
+			case 'edit_content':
+				$result = $_CLASS['core_db']-&gt;query('SELECT * FROM '. CORE_PAGES_TABLE .' WHERE page_id = '.$id);
+				$page = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				if (!$page)
+				{
+					trigger_error('PAGE_NOT_FOUND');
+				}
+
+				if ($page['page_status'] != STATUS_ACTIVE &amp;&amp; $page['page_status'] != STATUS_DISABLED)
+				{
+					trigger_error('PAGE_NOT_INSTALLED');
+				}
+	
+				check_type($page['page_type']);
+
+				if ($_REQUEST['mode'] === 'edit_content')
+				{
+					if (isset($_POST['submit']))
+					{
+						$data = array();
+						$data['page_title'] = get_variable('title', 'POST', null);
+	
+						$_CLASS['core_db']-&gt;query('UPDATE '.CORE_PAGES_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $data) .'  WHERE page_id = '.$id);
+	
+						unset($data);
+						
+						$content = get_variable('file_content', 'POST', null);
+						file_put_contents(SITE_FILE_ROOT.'includes/templates/'.$page['page_location'], $content);
+
+						break;
+					}
+					
+					$content = file_get_contents(SITE_FILE_ROOT.'includes/templates/'.$page['page_location']);
+
+					$_CLASS['core_template']-&gt;assign_array(array(
+						'ADMIN_PAGE_ACTION'			=&gt; generate_link('pages&amp;mode=edit_content&amp;id='.$id, array('admin' =&gt; true)),
+						'ADMIN_PAGE_NAME'			=&gt; mb_convert_case(preg_replace('/_/', ' ', $page['page_name']), MB_CASE_TITLE),
+						'ADMIN_PAGE_TITLE'			=&gt; $page['page_title'],
+						'ADMIN_PAGE_CONTENT'		=&gt; $content,
+						'ADMIN_PAGE_ERROR'			=&gt; '',
+					));
+
+					unset($content);
+
+					$_CLASS['core_display']-&gt;display(false, 'admin/pages/edit_content.html');
+
+					break;
+				}
+				
+				if (isset($_POST['submit']))
+				{
+					$blocks_array = get_variable('blocks_array', 'POST', array(), 'array:int');
+					$active = get_variable('active', 'POST', 0, 'int');
+
+					$data = array();
+					$data['page_title'] = get_variable('title', 'POST', null);
+					$data['page_status'] = ($active) ? STATUS_ACTIVE : STATUS_DISABLED;
+
+					$data['page_blocks'] = 0;
+
+					foreach ($blocks_array as $value)
+					{
+						$data['page_blocks'] |= (1 &lt;&lt; $value);
+					}
+
+					$_CLASS['core_db']-&gt;query('UPDATE '.CORE_PAGES_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $data) .'  WHERE page_id = '.$id);
+
+					unset($data, $blocks_array, $active);
+
+					break;
+				}
+
+				settype($page['page_status'], 'int');
+				settype($page['page_blocks'], 'int');
+
+				$page_blocks_array = array(
+					array(
+						'value' =&gt; BLOCK_RIGHT,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_RIGHT'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_RIGHT))
+					),
+					array(
+						'value' =&gt; BLOCK_TOP,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_TOP'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_TOP))
+					),
+					array(
+						'value' =&gt; BLOCK_BOTTOM,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_BOTTOM'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_BOTTOM))
+					),
+					array(
+						'value' =&gt; BLOCK_LEFT,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_LEFT'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_LEFT))
+					),
+					array(
+						'value' =&gt; BLOCK_MESSAGE_TOP,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_MESSAGE_TOP'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_MESSAGE_TOP))
+					),
+					array(
+						'value' =&gt; BLOCK_MESSAGE_BOTTOM,
+						'name' =&gt; $_CLASS['core_user']-&gt;get_lang('BLOCK_MESSAGE_BOTTOM'),
+						'checked' =&gt; ($page['page_blocks'] &amp; (1 &lt;&lt; BLOCK_MESSAGE_BOTTOM))
+					)
+				);
+				
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'ADMIN_PAGE_ACTION'			=&gt; generate_link('pages&amp;mode=edit&amp;id='.$id, array('admin' =&gt; true)),
+					'ADMIN_PAGE_TITLE'			=&gt; $page['page_title'],
+					'ADMIN_PAGE_NAME'			=&gt; mb_convert_case(preg_replace('/_/', ' ', $page['page_name']), MB_CASE_TITLE),
+					'ADMIN_PAGE_BLOCKS_ARRAY'	=&gt; $page_blocks_array,
+					'ADMIN_PAGE_ACTIVE'			=&gt; ($page['page_status'] == STATUS_ACTIVE) ? true : false,
+					'ADMIN_PAGE_ERROR'			=&gt; '',
+				));
+
+				$_CLASS['core_display']-&gt;display(false, 'admin/pages/edit.html');
+			break;
+
+			case 'remove':
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
+				
+				page_remove($id);
+			break;
+
+			case 'auth':
+				require_once SITE_FILE_ROOT.'admin/functions/page_functions.php';
+
+				page_auth($id);
+			break;
+
+			case 'install':
+				$result = $_CLASS['core_db']-&gt;query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
+				$page = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				if (!$page || $page['page_status'] != STATUS_PENDING)
+				{
+					trigger_error($page ? 'PAGE_ALREADY_INSTALLED' : 'PAGE_NOT_FOUND');
+				}
+
+				check_type($page['page_type']);
+
+				if (display_confirmation())
+				{
+					$_CLASS['core_db']-&gt;query('UPDATE '.CORE_PAGES_TABLE.' set page_status = '.STATUS_DISABLED.' WHERE page_id = '.$id);
+				}
+			break;
+
+			case 'uninstall':
+				$result = $_CLASS['core_db']-&gt;query('SELECT page_status, page_name, page_type FROM '.CORE_PAGES_TABLE.' WHERE page_id = '.$id);
+				$page = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+			
+				if (!$page || $page['page_status'] == STATUS_PENDING)
+				{
+					trigger_error($page ? 'PAGE_NOT_UNINSTALLABLE' : 'PAGE_NOT_FOUND');
+				}
+			
+				check_type($page['page_type']);
+				
+				if (display_confirmation())
+				{
+					$_CLASS['core_db']-&gt;query('UPDATE ' . CORE_PAGES_TABLE . ' set page_status = ' . STATUS_PENDING . ' WHERE page_id = '.$id);
+				}
+			break;
+		}
+	}
+}
+
+$sql = 'SELECT * FROM '.CORE_PAGES_TABLE.'
+			WHERE page_type = '. PAGE_TEMPLATE .'
+				ORDER BY page_name';
+
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+$pages = array();
+$admin_auth = false;
+
+while ($pages = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	settype($pages['page_status'], 'int');
+
+	$active = ($pages['page_status'] === STATUS_ACTIVE);
+	if ($pages['page_status'] === STATUS_PENDING)
+	{
+		$installed = false;
+		$installer_link = generate_link('pages&amp;mode=install&amp;id='.$pages['page_id'], array('admin' =&gt; true));
+		$remove_link = generate_link('pages&amp;mode=remove&amp;id='.$pages['page_id'], array('admin' =&gt; true));
+	}
+	else
+	{
+		$installed = true;
+		$installer_link = generate_link('pages&amp;mode=uninstall&amp;id='.$pages['page_id'], array('admin' =&gt; true));
+		$remove_link = '';
+	}
+
+	$_CLASS['core_template']-&gt;assign_vars_array('normal_pages', array(
+			'ACTIVE'		=&gt; ($active),
+			'CHANGE'		=&gt; ($active) ? $_CLASS['core_user']-&gt;get_lang('DEACTIVATE') : $_CLASS['core_user']-&gt;get_lang('ACTIVATE'),
+			'ERROR'			=&gt; '',
+			'INSTALLED'		=&gt; $installed,
+			'TITLE'			=&gt; ($pages['page_title']) ? $pages['page_title'] : mb_convert_case(preg_replace('/_/', ' ', $pages['page_name']), MB_CASE_TITLE),
+
+			'LINK_ACTIVE'		=&gt; generate_link('pages&amp;mode=change&amp;id='.$pages['page_id'], array('admin' =&gt; true)),
+			'LINK_EDIT'			=&gt; generate_link('pages&amp;mode=edit&amp;id='.$pages['page_id'], array('admin' =&gt; true)),
+			'LINK_EDIT_CONTENT'	=&gt; generate_link('pages&amp;mode=edit_content&amp;id='.$pages['page_id'], array('admin' =&gt; true)),
+			'LINK_AUTH'			=&gt; generate_link('pages&amp;mode=auth&amp;id='.$pages['page_id'], array('admin' =&gt; true)),
+			'LINK_ADMIN_AUTH'	=&gt; ($admin_auth) ? generate_link('pages&amp;mode=admin_auth&amp;id='.$pages['page_id'], array('admin' =&gt; true)) : '' ,
+			'LINK_INSTALLER'	=&gt; $installer_link,
+			'LINK_REMOVE'		=&gt; $remove_link,
+	));
+}
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'LINK_UPLOAD_PAGE'		=&gt; generate_link('pages&amp;mode=upload', array('admin' =&gt; true)),
+	'LINK_CREATE_PAGE'		=&gt; generate_link('pages&amp;mode=create', array('admin' =&gt; true)),
+	'LINK_GENERATE_PAGE'	=&gt; generate_link('pages&amp;mode=generate', array('admin' =&gt; true)),
+));
+
+$_CLASS['core_display']-&gt;display(false, 'admin/pages/index.html');
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/admin/smiles.php
===================================================================
--- cms/trunk/admin/smiles.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/smiles.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,186 @@
+&lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+global $_CLASS, $_CORE_MODULE, $_CORE_CONFIG;
+
+$_CLASS['core_user']-&gt;add_lang('admin/system', null);
+
+$notice = '';
+$mode =	get_variable('mode', 'GET', false);
+$page_title = 'SMILES';
+
+if (!$mode || !in_array($mode, array('edit', 'delete', 'move_up', 'move_down')))
+{
+	$mode = '';
+}
+
+$smiley_id = get_variable('id', 'REQUEST', false, 'int');
+
+switch ($mode)
+{
+	case 'edit':
+		
+		if (isset($_POST['submit']))
+		{
+
+			$smiley_id 			= get_variable('id', 'POST', array(), 'array:int');
+			$image_width		= get_variable('width', 'POST', array(), 'array:int');
+			$image_height		= get_variable('height', 'POST', array(), 'array:int');
+			$image_code			= get_variable('code', 'POST', array(), 'array');
+			$image_description	= get_variable('description', 'POST', array(), 'array');
+			//$image_display_on_posting = (isset($_POST['display_on_posting'])) ? array_map('intval', $_POST['display_on_posting']) : array();
+	
+			$sql = 'SELECT * 
+				FROM ' . CORE_SMILIES_TABLE .'
+				WHERE smiley_id IN ('. implode(', ', $smiley_id).')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				if (!$image_width[$row['smiley_id']] || !$image_height[$row['smiley_id']])
+				{
+					$img_size = @getimagesize($_CORE_CONFIG['global']['path_smilies'] . '/' . $row['smiley_src']);
+					$image_width[$row['smiley_id']] = $img_size[0];
+					$image_height[$row['smiley_id']] = $img_size[1];
+				}
+
+				$img_sql = array(
+					'smiley_width'			=&gt; (int) $image_width[$row['smiley_id']],
+					'smiley_height'			=&gt; (int) $image_height[$row['smiley_id']],
+					'smiley_description'	=&gt; $image_description[$row['smiley_id']],
+					'smiley_code'			=&gt; $image_code[$row['smiley_id']]
+				);
+
+				$sql = 'UPDATE '.CORE_SMILIES_TABLE.'
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $img_sql) . &quot; 
+					WHERE smiley_id = &quot; . $row['smiley_id'];
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+			
+			break;
+		}
+
+		$sql = 'SELECT * 
+			FROM ' . CORE_SMILIES_TABLE .'
+			WHERE smiley_id ='.$smiley_id;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$_CLASS['core_template']-&gt;assign_vars_array('smilies', array(
+				'IMG'		=&gt; $row['smiley_src'],
+				'IMG_SRC'	=&gt; $_CORE_CONFIG['global']['path_smilies'] . '/' . $row['smiley_src'],
+
+				'CODE'		=&gt; $row['smiley_code'],
+				'EMOTION'	=&gt; $row['smiley_description'],
+
+				'ID'				=&gt; $row['smiley_id'],
+				'WIDTH'				=&gt; $row['smiley_width'],
+				'HEIGHT'			=&gt; $row['smiley_height'],
+				'POSTING_CHECKED'	=&gt; (!empty($row['display_on_posting']) || $mode === 'add') ? ' checked=&quot;checked&quot;' : '')
+			);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT'		=&gt; true,
+			'S_ADD'			=&gt; false,
+			'ID'			=&gt; $smiley_id,
+			'U_ACTION'		=&gt; generate_link('smiles&amp;mode='.$mode, array('admin' =&gt; true)),
+		));
+
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'admin/smiles/index.html');
+	break;
+	
+	case 'delete':
+		if (display_confirmation())
+		{
+			$sql = 'DELETE FROM '.CORE_SMILIES_TABLE.'
+				WHERE smiley_id = '.$smiley_id;
+			$_CLASS['core_db']-&gt;query($sql);
+	
+			$notice = $_CLASS['core_user']-&gt;lang['ICONS_DELETED'];
+	
+			$_CLASS['core_cache']-&gt;destroy('smiley_window');
+			$_CLASS['core_cache']-&gt;destroy('smiley_inline');
+		}
+	break;
+	
+	case 'move_up':
+	case 'move_down':
+		$image_order = get_variable('order', 'REQUEST', 0, 'int');
+		$order_total = $image_order * 2 + (($mode === 'move_up') ? -1 : 1);
+
+		$sql = 'UPDATE '.CORE_SMILIES_TABLE.&quot;
+			SET smiley_order = $order_total - smiley_order
+			WHERE smiley_order IN ($image_order, &quot; . (($mode == 'move_up') ? $image_order - 1 : $image_order + 1) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		$_CLASS['core_cache']-&gt;destroy('smiley_window');
+		$_CLASS['core_cache']-&gt;destroy('smiley_inline');
+	break;
+}
+
+$lang = 'ICONS';
+
+global $_CLASS, $_CORE_CONFIG;
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'S_EDIT'			=&gt; false,
+	'L_NOT_DISPLAYED'	=&gt; $_CLASS['core_user']-&gt;lang[$lang . '_NOT_DISPLAYED'],
+	'NOTICE'			=&gt; $notice,
+	'U_ACTION'			=&gt; generate_link('smiles&amp;mode='.$mode, array('admin' =&gt; true)),
+));
+
+
+$sql = 'SELECT * 
+	FROM '.CORE_SMILIES_TABLE.'
+	ORDER BY smiley_order ASC';
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign_vars_array('smilies', array(
+		'ALT_TEXT'		=&gt; $row['smiley_code'],
+		'IMG_SRC'		=&gt; $_CORE_CONFIG['global']['path_smilies'] . '/' . $row['smiley_src'],
+		'WIDTH'			=&gt; $row['smiley_width'],
+		'HEIGHT'		=&gt; $row['smiley_height'],
+		'CODE'			=&gt; $row['smiley_code'],
+		'EMOTION'		=&gt; $row['smiley_description'],
+		'U_EDIT'		=&gt; generate_link('smiles&amp;mode=edit&amp;id=' . $row['smiley_id'], array('admin' =&gt; true)),
+		'U_DELETE'		=&gt; generate_link('smiles&amp;mode=delete&amp;id=' . $row['smiley_id'], array('admin' =&gt; true)),
+		'U_MOVE_UP'		=&gt; generate_link('smiles&amp;mode=move_up&amp;order=' . $row['smiley_order'], array('admin' =&gt; true)),
+		'U_MOVE_DOWN'	=&gt; generate_link('smiles&amp;mode=move_down&amp;order=' . $row['smiley_order'], array('admin' =&gt; true))
+	));
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'admin/smiles/index.html');
+
+?&gt;
\ No newline at end of file

Modified: cms/trunk/admin/system.php
===================================================================
--- cms/trunk/admin/system.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin/system.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -28,7 +28,7 @@
 
 global $_CLASS, $_CORE_MODULE;
 
-$_CLASS['core_user']-&gt;add_lang('admin/system.php');
+$_CLASS['core_user']-&gt;add_lang('admin/system', null);
 
 $mode =	get_variable('mode', 'GET', false);
 

Modified: cms/trunk/admin.php
===================================================================
--- cms/trunk/admin.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/admin.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -13,14 +13,13 @@
 //																//
 //**************************************************************//
 define('VIPERAL', 'Admin');
-//define('NEED_SID', true);
 
 require_once 'core.php';
 
 $_CLASS['core_user']-&gt;user_setup(null);
 $_CLASS['core_display']-&gt;load_theme('viperal_admin', SITE_FILE_ROOT.'themes_admin/viperal_admin');
 
-$_CLASS['core_user']-&gt;add_lang('admin/common.php');
+$_CLASS['core_user']-&gt;add_lang('admin/common', null);
 $_CLASS['core_blocks']-&gt;blocks_loaded = true;
 
 if (!$_CLASS['core_user']-&gt;is_user)

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/core.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -62,9 +62,11 @@
 	}
 }
 
+define('SITE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))));
+
 if (!defined('SITE_FILE_ROOT'))
 {
-	define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
+	define('SITE_FILE_ROOT', SITE_ROOT.'/');
 }
 
 if (!extension_loaded('mbstring'))

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/auth/auth.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -97,18 +97,24 @@
 			{
 				$this-&gt;_admin_permission[$row['admin_section']]['core']['status'] = $row['admin_status'];
 
-				if (trim($row['admin_options']) &amp;&amp; is_array($row['admin_options'] = @unserialize($row['admin_options'])))
+				$row['admin_options'] = trim($row['admin_options']);
+
+				if ($row['admin_options'] === '_all_')
 				{
-					$this-&gt;_admin_permission[$row['admin_section']] += $row['options'];
+					$this-&gt;_admin_permission[$row['admin_section']]['_all_'] = true;
 				}
+				elseif ($row['admin_options'] &amp;&amp; is_array($row['admin_options'] = @unserialize($row['admin_options'])))
+				{
+					$this-&gt;_admin_permission[$row['admin_section']] += $row['admin_options'];
+				}
 			}
 		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
 		$this-&gt;_got_data = true;
-		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
-	function admin_power($section, $option = false)
+	function admin_power($section, $option = false, $setting = true)
 	{
 		global $_CLASS;
 
@@ -124,12 +130,62 @@
 
 		if ($option)
 		{
+			if (isset($this-&gt;_admin_permission[$section]['_all_']))
+			{
+				return true;
+			}
+
 			return isset($this-&gt;_admin_permission[$section][$option]) ? false : $this-&gt;_admin_permission[$section][$option];
 		}
 
 		return $this-&gt;_admin_permission[$section]['core']['status'];
 	}
 
+	function list_admin_power($section, $option = false, $setting = true)
+	{
+		global $_CLASS;
+
+		$return = array();
+
+		$sql = 'SELECT * FROM ' . CORE_ADMIN_AUTH_TABLE .&quot; 
+			WHERE admin_section IN ('_all_', '&quot;.$_CLASS['core_db']-&gt;escape($section).&quot;')
+			admin_status = &quot;.STATUS_ACTIVE;
+
+		if ($option)
+		{
+			$sql .= &quot; AND (admin_options = '_all_' OR admin_options LIKE '%&quot;.$_CLASS['core_db']-&gt;escape($option).&quot;%')&quot;;
+		}
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$value = $row['admin_status'];
+
+			if ($option)
+			{
+				$row['admin_options'] = trim($row['admin_options']);
+
+				if ($row['admin_options'] === '_all_')
+				{
+					$value = true;
+				}
+				elseif(is_array($row['admin_options'] = @unserialize($row['admin_options'])))
+				{
+					$value = $row['admin_options'][$option];
+				}
+			}
+
+			if ($row['group_id'])
+			{
+				$holding[$row['group_id']] = $value;
+				continue;
+			}
+
+			$return[$row['user_id']] = $value;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
 	function auth_login($login_options = array(), $template = false)
 	{
 		global $_CLASS, $_CORE_CONFIG;

Modified: cms/trunk/includes/cache/cache.php
===================================================================
--- cms/trunk/includes/cache/cache.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/cache/cache.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -22,8 +22,7 @@
 class cache
 {
 	var $vars = array();
-	var $var_expires = array();
-	var $sql_rowset = array();
+	var $expires = array();
 	
 	/*
 		Get a cached value
@@ -48,8 +47,19 @@
 		{
 			unset($this-&gt;vars[$name]);
 		}
+	
+		if (!empty($this-&gt;expires[$name]))
+		{
+			unset($this-&gt;expires[$name]);
+		}
 	}
 
+	function reset() 
+	{
+		$this-&gt;vars = array();
+		$this-&gt;expires = array();
+	}
+
 	function save() 
 	{
 

Modified: cms/trunk/includes/cache/cache_eaccelerator.php
===================================================================
--- cms/trunk/includes/cache/cache_eaccelerator.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/cache/cache_eaccelerator.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -80,17 +80,18 @@
 		}
 
 		$key_list = eaccelerator_list_keys();
+		$key_length = strlen($this-&gt;key);
 
 		foreach ($key_list as $key)
 		{
 			if (strpos($key['name'], $this-&gt;key) === 0)
 			{
-				$name = substr($key['name'], strlen($this-&gt;key));
-
 				eaccelerator_rm($key['name']);
-				$this-&gt;remove($name);
+				$this-&gt;remove(substr($key['name'], $key_length));
 			}
 		}
+
+		$this-&gt;reset();
 	}
 }
 

Modified: cms/trunk/includes/cache/cache_file.php
===================================================================
--- cms/trunk/includes/cache/cache_file.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/cache/cache_file.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -124,8 +124,11 @@
 			if (strpos($file, 'cache_') === 0)
 			{
 				unlink($this-&gt;cache_dir . $file);
+				$this-&gt;remove(substr($file, 6));
 			} 
 		}
+
+		$this-&gt;reset();
 	}
 }
 

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/display/template.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -270,7 +270,7 @@
 
 			if (!$compile)
 			{
-				if (strtoupper(trim($tag_blocks[1][$loop])) == 'ENDIGNORE')
+				if (strtoupper(trim($tag_blocks[1][$loop])) === 'ENDIGNORE')
 				{
 					$compile = true;
 				}

Modified: cms/trunk/includes/forums/admin/admin_attachments.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_attachments.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_attachments.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -15,961 +15,712 @@
 	die; 
 }
 
-if (!$_CLASS['auth']-&gt;acl_get('a_attach'))
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_attach'))
 {
 	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
 }
 
-require($site_file_root.'includes/forums/functions_posting.php');
+$_CLASS['core_user']-&gt;add_lang(array('posting', 'viewtopic', 'admin_attachments'));
 
-$_CLASS['core_user']-&gt;add_lang(array('posting', 'viewtopic'), 'forums');
-
-$mode = request_var('mode', '');
+$error = $notify = array();
 $submit = (isset($_POST['submit'])) ? true : false;
+$action = request_var('action', '');
+$mode = request_var('mode', 'attach');
+$u_action = 'forums&amp;file=admin_attachments&amp;mode='.$mode;
 
-$error = $notify = array();
-
 switch ($mode)
 {
 	case 'attach':
-		$l_title = 'ATTACHMENT_SETTINGS';
-		break;
+		$l_title = 'ACP_ATTACHMENT_SETTINGS';
+	break;
 
 	case 'extensions':
-		$l_title = 'MANAGE_EXTENSIONS';
-		break;
+		$l_title = 'ACP_MANAGE_EXTENSIONS';
+	break;
 
 	case 'ext_groups':
-		$l_title = 'EXTENSION_GROUPS_TITLE';
-		break;
-	
+		$l_title = 'ACP_EXTENSION_GROUPS';
+	break;
+
 	case 'orphan':
-		$l_title = 'ORPHAN_ATTACHMENTS';
-		break;
+		$l_title = 'ACP_ORPHAN_ATTACHMENTS';
+	break;
 
 	default:
-		trigger_error('NO_MODE');
+		trigger_error('NO_MODE', E_USER_ERROR);
+	break;
 }
 
-if ($mode == 'attach')
-{
-	$config_sizes = array('max_filesize' =&gt; 'size', 'attachment_quota' =&gt; 'quota_size', 'max_filesize_pm' =&gt; 'pm_size');
-	foreach ($config_sizes as $cfg_key =&gt; $var)
-	{
-		$$var = request_var($var, '');
-	}
+$page_title = $l_title;
 
-	// Pull all config data
-	$sql = 'SELECT *
-		FROM ' . FORUMS_CONFIG_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang[$l_title],
+	'L_TITLE_EXPLAIN'	=&gt; $_CLASS['core_user']-&gt;lang[$l_title . '_EXPLAIN'],
+	'U_ACTION'			=&gt; generate_link($u_action, array('admin' =&gt; true)),
+	)
+);
 
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$config_name = $row['config_name'];
-		$config_value = $row['config_value'];
+switch ($mode)
+{
+	case 'attach':
 
-		$default_config[$config_name] = $config_value;
-		$new[$config_name] = request_var($config_name, $default_config[$config_name]);
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
-		foreach ($config_sizes as $cfg_key =&gt; $var)
-		{
-			if (empty($$var) &amp;&amp; !$submit &amp;&amp; $config_name == $cfg_key)
-			{
-				$$var = (intval($default_config[$config_name]) &gt;= 1048576) ? 'mb' : ((intval($default_config[$config_name]) &gt;= 1024) ? 'kb' : 'b');
-			}
+		$sql = 'SELECT group_name, cat_id
+			FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . '
+			WHERE cat_id &gt; 0
+			ORDER BY cat_id';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-			if (!$submit &amp;&amp; $config_name == $cfg_key)
-			{
-				$new[$config_name] = ($new[$config_name] &gt;= 1048576) ? round($new[$config_name] / 1048576 * 100) / 100 : (($new[$config_name] &gt;= 1024) ? round($new[$config_name] / 1024 * 100) / 100 : $new[$config_name]);
-			}
-
-			if ($submit &amp;&amp; $config_name == $cfg_key)
-			{
-				$old = $new[$config_name];
-				$new[$config_name] = ($$var == 'kb') ? round($new[$config_name] * 1024) : (($$var == 'mb') ? round($new[$config_name] * 1048576) : $new[$config_name]);
-			}
-		} 
-
-		if ($submit)
+		$s_assigned_groups = array();
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			set_config($config_name, $new[$config_name]);
-	
-			if (in_array($config_name, array('max_filesize', 'attachment_quota', 'max_filesize_pm')))
-			{
-				$new[$config_name] = $old;
-			}
+			$s_assigned_groups[$row['cat_id']][] = $row['group_name'];
 		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
-	perform_site_list();
+		$l_legend_cat_images = $_CLASS['core_user']-&gt;lang['SETTINGS_CAT_IMAGES'] . ' [' . $_CLASS['core_user']-&gt;lang['ASSIGNED_GROUP'] . ': ' . ((sizeof($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])) ? implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) : $_CLASS['core_user']-&gt;lang['NO_EXT_GROUP']) . ']';
 
-	if ($submit)
-	{
-		add_log('admin', 'LOG_' . strtoupper($mode) . '_CONFIG');
+		$display_vars = array(
+			'title'	=&gt; 'ACP_ATTACHMENT_SETTINGS',
+			'vars'	=&gt; array(
+				'img_max_width' =&gt; false, 'img_max_height' =&gt; false, 'img_link_width' =&gt; false, 'img_link_height' =&gt; false,
 
-		// Check Settings
-		test_upload($error, $new['upload_path'], false);
+				'legend1'				=&gt; 'ACP_ATTACHMENT_SETTINGS',
+				'allow_attachments'		=&gt; array('lang' =&gt; 'ALLOW_ATTACHMENTS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_pm_attach'		=&gt; array('lang' =&gt; 'ALLOW_PM_ATTACHMENTS',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'upload_path'			=&gt; array('lang' =&gt; 'UPLOAD_DIR',			'validate' =&gt; 'path',	'type' =&gt; 'text:25:100', 'explain' =&gt; true),
+				'display_order'			=&gt; array('lang' =&gt; 'DISPLAY_ORDER',			'validate' =&gt; 'bool',	'type' =&gt; 'custom', 'method' =&gt; 'display_order', 'explain' =&gt; true),
+				'attachment_quota'		=&gt; array('lang' =&gt; 'ATTACH_QUOTA',			'validate' =&gt; 'int',	'type' =&gt; 'custom', 'method' =&gt; 'max_filesize', 'explain' =&gt; true),
+				'max_filesize'			=&gt; array('lang' =&gt; 'ATTACH_MAX_FILESIZE',	'validate' =&gt; 'int',	'type' =&gt; 'custom', 'method' =&gt; 'max_filesize', 'explain' =&gt; true),
+				'max_filesize_pm'		=&gt; array('lang' =&gt; 'ATTACH_MAX_PM_FILESIZE','validate' =&gt; 'int',	'type' =&gt; 'custom', 'method' =&gt; 'max_filesize', 'explain' =&gt; true),
+				'max_attachments'		=&gt; array('lang' =&gt; 'MAX_ATTACHMENTS',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:3', 'explain' =&gt; false),
+				'max_attachments_pm'	=&gt; array('lang' =&gt; 'MAX_ATTACHMENTS_PM',	'validate' =&gt; 'int',	'type' =&gt; 'text:3:3', 'explain' =&gt; false),
+				'secure_downloads'		=&gt; array('lang' =&gt; 'SECURE_DOWNLOADS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'secure_allow_deny'		=&gt; array('lang' =&gt; 'SECURE_ALLOW_DENY',		'validate' =&gt; 'int',	'type' =&gt; 'custom', 'method' =&gt; 'select_allow_deny', 'explain' =&gt; true),
+				'secure_allow_empty_referer' =&gt; array('lang' =&gt; 'SECURE_EMPTY_REFERRER', 'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
 
-		if (!sizeof($error))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['CONFIG_UPDATED']);
-		}
-	}
-}
+				'legend2'					=&gt; $l_legend_cat_images,
+				'img_display_inlined'		=&gt; array('lang' =&gt; 'DISPLAY_INLINED',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'img_create_thumbnail'		=&gt; array('lang' =&gt; 'CREATE_THUMBNAIL',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'img_max_thumb_width'		=&gt; array('lang' =&gt; 'MAX_THUMB_WIDTH',		'validate' =&gt; 'int',	'type' =&gt; 'text:7:15', 'explain' =&gt; true, 'append' =&gt; ' px'),
+				'img_min_thumb_filesize'	=&gt; array('lang' =&gt; 'MIN_THUMB_FILESIZE',	'validate' =&gt; 'int',	'type' =&gt; 'text:7:15', 'explain' =&gt; true, 'append' =&gt; ' ' . $_CLASS['core_user']-&gt;lang['BYTES']),
+				'img_imagick'				=&gt; array('lang' =&gt; 'IMAGICK_PATH',			'validate' =&gt; 'string',	'type' =&gt; 'text:20:200', 'explain' =&gt; true, 'append' =&gt; '&nbsp;&nbsp;&lt;span&gt;[ &lt;a href=&quot;' . generate_link($u_action . '&amp;action=imgmagick', array('admin' =&gt; true)).'&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SEARCH_IMAGICK'] . '&lt;/a&gt; ]&lt;/span&gt;'),
+				'img_max'					=&gt; array('lang' =&gt; 'MAX_IMAGE_SIZE',		'validate' =&gt; 'int',	'type' =&gt; 'dimension:3:4', 'explain' =&gt; true),
+				'img_link'					=&gt; array('lang' =&gt; 'IMAGE_LINK_SIZE',		'validate' =&gt; 'int',	'type' =&gt; 'dimension:3:4', 'explain' =&gt; true),
+			)
+		);
 
-adm_page_header($_CLASS['core_user']-&gt;lang[$l_title]);
+		$new_config = $config;
+		$cfg_array = (isset($_REQUEST['config'])) ? request_var('config', array('' =&gt; '')) : $new_config;
+		$error = array();
 
+		// We validate the complete config if whished
+		validate_config_vars($display_vars['vars'], $cfg_array, $error);
 
-if ($submit &amp;&amp; $mode == 'extensions')
-{
-	// Change Extensions ?
-	$extension_change_list	= (isset($_POST['extension_change_list'])) ? array_map('intval', $_POST['extension_change_list']) : array();
-	$group_select_list		= (isset($_POST['group_select'])) ? array_map('intval', $_POST['group_select']) : array();
-
-	// Generate correct Change List
-	$extensions = array();
-
-	for ($i = 0; $i &lt; count($extension_change_list); $i++)
-	{
-		$extensions[$extension_change_list[$i]]['group_id'] = $group_select_list[$i];
-	}
-
-	$sql = 'SELECT *
-		FROM ' . EXTENSIONS_TABLE . '
-		ORDER BY extension_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if ($row['group_id'] != $extensions[$row['extension_id']]['group_id'])
+		// Do not write values if there is an error
+		if (sizeof($error))
 		{
-			$sql = 'UPDATE ' . EXTENSIONS_TABLE . ' 
-				SET group_id = ' . (int) $extensions[$row['extension_id']]['group_id'] . '
-				WHERE extension_id = ' . $row['extension_id'];
-			$_CLASS['core_db']-&gt;query($sql);	
-			add_log('admin', 'LOG_ATTACH_EXT_UPDATE', $row['extension']);
+			$submit = false;
 		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
 
-	// Delete Extension ?
-	$extension_id_list = (isset($_POST['extension_id_list'])) ? array_map('intval', $_POST['extension_id_list']) : array();
-
-	if (sizeof($extension_id_list))
-	{
-		$sql = 'SELECT extension 
-			FROM ' . EXTENSIONS_TABLE . '
-			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		
-		$extension_list = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		// We go through the display_vars to make sure no one is trying to set variables he/she is not allowed to...
+		foreach ($display_vars['vars'] as $config_name =&gt; $null)
 		{
-			$extension_list .= ($extension_list == '') ? $row['extension'] : ', ' . $row['extension'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+			if (!isset($cfg_array[$config_name]) || strpos($config_name, 'legend') !== false)
+			{
+				continue;
+			}
 
-		$sql = 'DELETE 
-			FROM ' . EXTENSIONS_TABLE . '
-			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
+			$new_config[$config_name] = $config_value = $cfg_array[$config_name];
 
-		add_log('admin', 'LOG_ATTACH_EXT_DEL', $extension_list);
-	}
-		
-	// Add Extension ?
-	$add_extension			= strtolower(request_var('add_extension', ''));
-	$add_extension_group	= request_var('add_group_select', 0);
-	$add					= (isset($_POST['add_extension_check'])) ? true : false;
-
-	if ($add_extension != '' &amp;&amp; $add)
-	{
-		if (!sizeof($error))
-		{
-			$sql = 'SELECT extension_id
-				FROM ' . EXTENSIONS_TABLE . &quot;
-				WHERE extension = '&quot; . $_CLASS['core_db']-&gt;sql_escape($add_extension) . &quot;'&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-			
-			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			if (in_array($config_name, array('attachment_quota', 'max_filesize', 'max_filesize_pm')))
 			{
-				$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_EXIST'], $add_extension);
+				$size_var = request_var($config_name, '');
+				$new_config[$config_name] = $config_value = ($size_var == 'kb') ? round($config_value * 1024) : (($size_var == 'mb') ? round($config_value * 1048576) : $config_value);
 			}
-			$_CLASS['core_db']-&gt;free_result($result);
 
-			if (!sizeof($error))
+			if ($submit)
 			{
-				$sql_ary = array(
-					'group_id'	=&gt;	$add_extension_group,
-					'extension'	=&gt;	$add_extension
-				);
-				
-				$_CLASS['core_db']-&gt;query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
-				add_log('admin', 'LOG_ATTACH_EXT_ADD', $add_extension);
+				set_config($config_name, $config_value);
 			}
 		}
-	}
 
-	if (!sizeof($error))
-	{
-		$notify[] = $_CLASS['core_user']-&gt;lang['EXTENSIONS_UPDATED'];
-	}
-	$_CLASS['core_cache']-&gt;destroy('extensions');
-}
+		perform_site_list();
 
+		if ($submit)
+		{
+			add_log('admin', 'LOG_CONFIG_ATTACH');
 
-if ($submit &amp;&amp; $mode == 'ext_groups')
-{
-	$action = request_var('action', '');
-	$group_id = request_var('g', 0);
-	
-	if ($action != 'add' &amp;&amp; $action != 'edit')
-	{
-		trigger_error('WRONG_MODE');
-	}
+			// Check Settings
+			test_upload($error, $new_config['upload_path'], false);
 
-	if (!$group_id &amp;&amp; $action == 'edit')
-	{
-		trigger_error('NO_EXT_GROUP_SPECIFIED');
-	}
+			if (!sizeof($error))
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['CONFIG_UPDATED'] . adm_back_link($u_action));
+			}
+		}
 
-	if ($group_id)
-	{
-		$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . &quot;
-			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		$ext_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-	else
-	{
-		$ext_row = array();
-	}
+		$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_SETTINGS', true);
 
-	$group_name = request_var('group_name', '');
-	$new_group_name = ($action == 'add') ? $group_name : (($ext_row['group_name'] != $group_name) ? $group_name : '');
-
-	if (!$group_name)
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['NO_EXT_GROUP_NAME'];
-	}
-
-	// Check New Group Name
-	if ($new_group_name)
-	{
-		$sql = 'SELECT group_id 
-			FROM ' . EXTENSION_GROUPS_TABLE . &quot;
-			WHERE LOWER(group_name) = '&quot; . $_CLASS['core_db']-&gt;sql_escape(strtolower($new_group_name)) . &quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		if ($action === 'imgmagick')
 		{
-			$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_GROUP_EXIST'], $new_group_name);
+			$new_config['img_imagick'] = search_imagemagick();
 		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
 
-	if (!sizeof($error))
-	{
-		// Ok, build the update/insert array
-		$upload_icon	= request_var('upload_icon', 'no_image');
-		$size_select	= request_var('size_select', 'b');
-		$forum_select	= request_var('forum_select', false);
-		$allowed_forums	= isset($_POST['allowed_forums']) ? array_map('intval', array_values($_POST['allowed_forums'])) : array();
-		$allow_in_pm	= isset($_POST['allow_in_pm']) ? true : false;
-		$max_filesize	= request_var('max_filesize', 0);
-		$max_filesize	= ($size_select == 'kb') ? round($max_filesize * 1024) : (($size_select == 'mb') ? round($max_filesize * 1048576) : $max_filesize);
+		// We strip eventually manual added convert program, we only want the patch
+		$new_config['img_imagick'] = str_replace(array('convert', '.exe'), array('', ''), $new_config['img_imagick']);
 
-		if ($max_filesize == $config['max_filesize'])
-		{
-			$max_filesize = 0;
-		}	
+		$supported_types = get_supported_image_types();
 
-		if (!sizeof($allowed_forums))
+		// Check Thumbnail Support
+		if (!$new_config['img_imagick'] &amp;&amp; (!isset($supported_types['format']) || !sizeof($supported_types['format'])))
 		{
-			$forum_select = false;
+			$new_config['img_create_thumbnail'] = 0;
 		}
 
-		$group_ary = array(
-			'group_name'	=&gt; $group_name,
-			'cat_id'		=&gt; request_var('special_category', ATTACHMENT_CATEGORY_NONE),
-			'allow_group'	=&gt; (isset($_POST['allow_group'])) ? 1 : 0,
-			'download_mode'	=&gt; request_var('download_mode', INLINE_LINK),
-			'upload_icon'	=&gt; ($upload_icon == 'no_image') ? '' : $upload_icon,
-			'max_filesize'	=&gt; $max_filesize,
-			'allowed_forums'=&gt; ($forum_select) ? serialize($allowed_forums) : '',
-			'allow_in_pm'	=&gt; ($allow_in_pm) ? 1 : 0
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'U_SEARCH_IMAGICK'		=&gt; generate_link($u_action . '&amp;action=imgmagick', array('admin' =&gt; true)),
+			'S_THUMBNAIL_SUPPORT'	=&gt; (!$new_config['img_imagick'] &amp;&amp; (!isset($supported_types['format']) || !sizeof($supported_types['format']))) ? false : true,
+			)
 		);
 
-		$sql = ($action == 'add') ? 'INSERT INTO ' . EXTENSION_GROUPS_TABLE . ' ' : 'UPDATE ' . EXTENSION_GROUPS_TABLE . ' SET ';
-		$sql .= $_CLASS['core_db']-&gt;sql_build_array((($action == 'add') ? 'INSERT' : 'UPDATE'), $group_ary);
-		$sql .= ($action == 'edit') ? &quot; WHERE group_id = $group_id&quot; : '';
+		// Secure Download Options - Same procedure as with banning
+		$allow_deny = ($new_config['secure_allow_deny']) ? 'ALLOWED' : 'DISALLOWED';
 
-		$_CLASS['core_db']-&gt;query($sql);
-		
-		if ($action == 'add')
+		$sql = 'SELECT *
+			FROM ' . FORUMS_SITELIST_TABLE;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$defined_ips = '';
+		$ips = array();
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$group_id = $_CLASS['core_db']-&gt;sql_nextid();
+			$value = ($row['site_ip']) ? $row['site_ip'] : $row['site_hostname'];
+			if ($value)
+			{
+				$defined_ips .=  '&lt;option' . (($row['ip_exclude']) ? ' class=&quot;sep&quot;' : '') . ' value=&quot;' . $row['site_id'] . '&quot;&gt;' . $value . '&lt;/option&gt;';
+				$ips[$row['site_id']] = $value;
+			}
 		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-		add_log('admin', 'LOG_ATTACH_EXTGROUP_' . strtoupper($action), $group_name);
-	}
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_SECURE_DOWNLOADS'	=&gt; $new_config['secure_downloads'],
+			'S_DEFINED_IPS'			=&gt; ($defined_ips != '') ? true : false,
+			'S_WARNING'				=&gt; empty($error) ? false : true,
 
-	$extension_list = isset($_REQUEST['extensions']) ? array_map('intval', array_values($_REQUEST['extensions'])) : array();
+			'WARNING_MSG'			=&gt; implode('&lt;br /&gt;', $error),
+			'DEFINED_IPS'			=&gt; $defined_ips,
 
-	if ($action == 'edit' &amp;&amp; sizeof($extension_list))
-	{
-		$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot;
-			SET group_id = 0
-			WHERE group_id = $group_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
+			'L_SECURE_TITLE'		=&gt; $_CLASS['core_user']-&gt;lang['DEFINE_' . $allow_deny . '_IPS'],
+			'L_IP_EXCLUDE'			=&gt; $_CLASS['core_user']-&gt;lang['EXCLUDE_FROM_' . $allow_deny . '_IP'],
+			'L_REMOVE_IPS'			=&gt; $_CLASS['core_user']-&gt;lang['REMOVE_' . $allow_deny . '_IPS'],
+			)
+		);
 
-	if (sizeof($extension_list))
-	{
-		$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot; 
-			SET group_id = $group_id
-			WHERE extension_id IN (&quot; . implode(', ', $extension_list) . &quot;)&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	rewrite_extensions();
-
-	if (!sizeof($error))
-	{
-		$notify[] = $_CLASS['core_user']-&gt;lang['SUCCESS_EXTENSION_GROUP_' . strtoupper($action)];
-	}
-}
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$l_title]; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$l_title . '_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-if ($submit &amp;&amp; $mode == 'orphan')
-{
-	$delete_files = (isset($_POST['delete'])) ? array_keys(request_var('delete', array('' =&gt; 0))) : array();
-	$add_files = (isset($_POST['add'])) ? array_keys(request_var('add', array('' =&gt; 0))) : array();
-	$post_ids = request_var('post_id', 0);
-
-	foreach ($delete_files as $delete)
-	{
-		phpbb_unlink($delete);
-		phpbb_unlink($delete, 'thumbnail');
-	}
-
-	if (sizeof($delete_files))
-	{
-		add_log('admin', sprintf($_CLASS['core_user']-&gt;lang['LOG_ATTACH_ORPHAN_DEL'], implode(', ', $delete_files)));
-		$notify[] = sprintf($_CLASS['core_user']-&gt;lang['LOG_ATTACH_ORPHAN_DEL'], implode(', ', $delete_files));
-	}
-
-	$upload_list = array();
-	foreach ($add_files as $file)
-	{
-		if (!in_array($file, $delete_files) &amp;&amp; $post_ids[$file])
+		// Output relevant options
+		foreach ($display_vars['vars'] as $config_key =&gt; $vars)
 		{
-			$upload_list[$post_ids[$file]] = $file;
-		}
-	}
-	unset($add_files);
+			if (!is_array($vars) &amp;&amp; strpos($config_key, 'legend') === false)
+			{
+				continue;
+			}
 
-	if (sizeof($upload_list))
-	{
-?&gt;
-	&lt;h2&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOADING_FILES']; ?&gt;&lt;/h2&gt;
-&lt;?php
-		require($site_file_root.'includes/forums/message_parser.php');
-		$message_parser = new parse_message();
+			if (strpos($config_key, 'legend') !== false)
+			{
+				$_CLASS['core_template']-&gt;assign_vars_array('options', array(
+					'S_LEGEND'		=&gt; true,
+					'LEGEND'		=&gt; (isset($_CLASS['core_user']-&gt;lang[$vars])) ? $_CLASS['core_user']-&gt;lang[$vars] : $vars)
+				);
 
-		$sql = 'SELECT forum_id, forum_name
-			FROM ' . FORUMS_TABLE;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		
-		$forum_names = array();
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$forum_names[$row['forum_id']] = $row['forum_name'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+				continue;
+			}
 
-		$sql = 'SELECT forum_id, topic_id, post_id 
-			FROM ' . POSTS_TABLE . '
-			WHERE post_id IN (' . implode(', ', array_keys($upload_list)) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
+			$type = explode(':', $vars['type']);
 
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			echo sprintf($_CLASS['core_user']-&gt;lang['UPLOADING_FILE_TO'], $upload_list[$row['post_id']], $row['post_id']) . '&lt;br /&gt;';
-			if (!$_CLASS['auth']-&gt;acl_gets('f_attach', 'u_attach', $row['forum_id']))
+			$l_explain = '';
+			if ($vars['explain'] &amp;&amp; isset($vars['lang_explain']))
 			{
-				echo '&lt;span style=&quot;color:red&quot;&gt;' . sprintf($_CLASS['core_user']-&gt;lang['UPLOAD_DENIED_FORUM'], $forum_names[$row['forum_id']]) . '&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;';
+				$l_explain = (isset($_CLASS['core_user']-&gt;lang[$vars['lang_explain']])) ? $_CLASS['core_user']-&gt;lang[$vars['lang_explain']] : $vars['lang_explain'];
 			}
-			else
+			else if ($vars['explain'])
 			{
-				upload_file($row['post_id'], $row['topic_id'], $row['forum_id'], $config['upload_path'], $upload_list[$row['post_id']]);
+				$l_explain = (isset($_CLASS['core_user']-&gt;lang[$vars['lang'] . '_EXPLAIN'])) ? $_CLASS['core_user']-&gt;lang[$vars['lang'] . '_EXPLAIN'] : '';
 			}
-		}
-		unset($message_parser);
-	}
-}
 
- 
-if (sizeof($error))
-{
-?&gt;
+			$_CLASS['core_template']-&gt;assign_vars_array('options', array(
+				'KEY'			=&gt; $config_key,
+				'TITLE'			=&gt; $_CLASS['core_user']-&gt;lang[$vars['lang']],
+				'S_EXPLAIN'		=&gt; $vars['explain'],
+				'TITLE_EXPLAIN'	=&gt; $l_explain,
+				'CONTENT'		=&gt; build_cfg_template($type, $config_key, $new_config, $config_key, $vars),
+			));
 
-&lt;h2 style=&quot;color:red&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING']; ?&gt;&lt;/h2&gt;
+			unset($display_vars['vars'][$config_key]);
+		}
 
-&lt;p&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/p&gt;
+	break;
 
-&lt;?php
-}
+	case 'extensions':
 
-if (sizeof($notify))
-{
-?&gt;
+		if ($submit || isset($_POST['add_extension_check']))
+		{
+			if ($submit)
+			{
+				// Change Extensions ?
+				$extension_change_list	= (isset($_POST['extension_change_list'])) ? array_map('intval', $_POST['extension_change_list']) : array();
+				$group_select_list		= (isset($_POST['group_select'])) ? array_map('intval', $_POST['group_select']) : array();
 
-&lt;h2 style=&quot;color:green&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NOTIFY']; ?&gt;&lt;/h2&gt;
+				// Generate correct Change List
+				$extensions = array();
 
-&lt;p&gt;&lt;?php echo implode('&lt;br /&gt;', $notify); ?&gt;&lt;/p&gt;
+				for ($i = 0, $size = sizeof($extension_change_list); $i &lt; $size; $i++)
+				{
+					$extensions[$extension_change_list[$i]]['group_id'] = $group_select_list[$i];
+				}
 
-&lt;?php
-}
+				$sql = 'SELECT *
+					FROM ' . FORUMS_EXTENSIONS_TABLE . '
+					ORDER BY extension_id';
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-$modes = array('extensions', 'ext_groups', 'orphan');
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					if ($row['group_id'] != $extensions[$row['extension_id']]['group_id'])
+					{
+						$sql = 'UPDATE ' . FORUMS_EXTENSIONS_TABLE . ' 
+							SET group_id = ' . (int) $extensions[$row['extension_id']]['group_id'] . '
+							WHERE extension_id = ' . $row['extension_id'];
+						$_CLASS['core_db']-&gt;query($sql);	
 
-$s_select_mode = '&lt;select name=&quot;mode&quot;&gt;';
-foreach ($modes as $_mode)
-{
-	$s_select_mode .= '&lt;option value=&quot;' . $_mode . '&quot;' . (($mode == $_mode) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ATTACH_' . strtoupper($_mode) . '_URL'] . '&lt;/option&gt;';
-}
-$s_select_mode .= '&lt;/select&gt;';
-?&gt;
-&lt;form name=&quot;attachments&quot; method=&quot;post&quot; action=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;?php
-if ($mode != 'attach')
-{
-?&gt;
-	&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $s_select_mode; ?&gt; &nbsp; &lt;input type=&quot;submit&quot; name=&quot;select_mode&quot; class=&quot;btnlite&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;/table&gt;
-&lt;?php
-}
+						add_log('admin', 'LOG_ATTACH_EXT_UPDATE', $row['extension']);
+					}
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
 
-// Attachment Settings
-if ($mode == 'attach')
-{
-	$action = request_var('action', '');
+				// Delete Extension?
+				$extension_id_list = (isset($_POST['extension_id_list'])) ? array_map('intval', $_POST['extension_id_list']) : array();
 
-	if ($action == 'imgmagick')
-	{
-		$new['img_imagick'] = search_imagemagick();
-	}
+				if (sizeof($extension_id_list))
+				{
+					$sql = 'SELECT extension 
+						FROM ' . FORUMS_EXTENSIONS_TABLE . '
+						WHERE ' . $db-&gt;sql_in_set('extension_id', $extension_id_list);
+					$result = $_CLASS['core_db']-&gt;query($sql);
+					
+					$extension_list = '';
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$extension_list .= ($extension_list == '') ? $row['extension'] : ', ' . $row['extension'];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
 
-	// We strip eventually manual added convert program, we only want the patch
-	$new['img_imagick'] = str_replace(array('convert', '.exe'), array('', ''), $new['img_imagick']);
+					$sql = 'DELETE 
+						FROM ' . FORUMS_EXTENSIONS_TABLE . '
+						WHERE ' . $db-&gt;sql_in_set('extension_id', $extension_id_list);
+					$_CLASS['core_db']-&gt;query($sql);
 
-	$select_size_mode = size_select('size', $size);
-	$select_quota_size_mode = size_select('quota_size', $quota_size);
-	$select_pm_size_mode = size_select('pm_size', $pm_size);
+					add_log('admin', 'LOG_ATTACH_EXT_DEL', $extension_list);
+				}
+			}
 
-	$display_order_yes = ($new['display_order']) ? 'checked=&quot;checked&quot;' : '';
-	$display_order_no = (!$new['display_order']) ? 'checked=&quot;checked&quot;' : '';
+			// Add Extension?
+			$add_extension			= strtolower(request_var('add_extension', ''));
+			$add_extension_group	= request_var('add_group_select', 0);
+			$add					= (isset($_POST['add_extension_check'])) ? true : false;
 
-	$sql = 'SELECT group_name, cat_id
-		FROM ' . EXTENSION_GROUPS_TABLE . '
-		WHERE cat_id &gt; 0
-		ORDER BY cat_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
+			if ($add_extension != '' &amp;&amp; $add)
+			{
+				if (!sizeof($error))
+				{
+					$sql = 'SELECT extension_id
+						FROM ' . FORUMS_EXTENSIONS_TABLE . &quot;
+						WHERE extension = '&quot; . $db-&gt;sql_escape($add_extension) . &quot;'&quot;;
+					$result = $_CLASS['core_db']-&gt;query($sql);
+					
+					if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_EXIST'], $add_extension);
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
 
-	$s_assigned_groups = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$s_assigned_groups[$row['cat_id']][] = $row['group_name'];
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
+					if (!sizeof($error))
+					{
+						$sql_ary = array(
+							'group_id'	=&gt;	$add_extension_group,
+							'extension'	=&gt;	$add_extension
+						);
+						
+						$_CLASS['core_db']-&gt;query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
+						add_log('admin', 'LOG_ATTACH_EXT_ADD', $add_extension);
+					}
+				}
+			}
 
-	$display_inlined_yes = ($new['img_display_inlined']) ? 'checked=&quot;checked&quot;' : '';
-	$display_inlined_no = (!$new['img_display_inlined']) ? 'checked=&quot;checked&quot;' : '';
+			if (!sizeof($error))
+			{
+				$notify[] = $_CLASS['core_user']-&gt;lang['EXTENSIONS_UPDATED'];
+			}
+			
+			$_CLASS['core_cache']-&gt;destroy('extensions');
+		}
 
-	$create_thumbnail_yes = ($new['img_create_thumbnail']) ? 'checked=&quot;checked&quot;' : '';
-	$create_thumbnail_no = (!$new['img_create_thumbnail']) ? 'checked=&quot;checked&quot;' : '';
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EXTENSIONS'			=&gt; true,
+			'ADD_EXTENSION'			=&gt; (isset($add_extension)) ? $add_extension : '',
+			'GROUP_SELECT_OPTIONS'	=&gt; (isset($_POST['add_extension_check'])) ? group_select('add_group_select', $add_extension_group, 'extension_group') : group_select('add_group_select', false, 'extension_group'))
+		);
 
-	$secure_downloads_yes = ($new['secure_downloads']) ? 'checked=&quot;checked&quot;' : '';
-	$secure_downloads_no = (!$new['secure_downloads']) ? 'checked=&quot;checked&quot;' : '';
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_EXTENSIONS_TABLE . ' 
+			ORDER BY group_id, extension';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-	$secure_allow_deny_yes = ($new['secure_allow_deny']) ? 'checked=&quot;checked&quot;' : '';
-	$secure_allow_deny_no = (!$new['secure_allow_deny']) ? 'checked=&quot;checked&quot;' : '';
-	
-	$secure_allow_empty_referer_yes = ($new['secure_allow_empty_referer']) ? 'checked=&quot;checked&quot;' : '';
-	$secure_allow_empty_referer_no = (!$new['secure_allow_empty_referer']) ? 'checked=&quot;checked&quot;' : '';
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$old_group_id = $row['group_id'];
+			do
+			{
+				$s_spacer = false;
 
-?&gt;
+				$current_group_id = $row['group_id'];
+				if ($old_group_id != $current_group_id)
+				{
+					$s_spacer = true;
+					$old_group_id = $current_group_id;
+				}
 
-	&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$l_title]; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_DIR']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_DIR_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;25&quot; maxlength=&quot;100&quot; name=&quot;upload_path&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['upload_path'] ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_ORDER']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_ORDER_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;display_order&quot; value=&quot;0&quot; &lt;?php echo $display_order_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DESCENDING']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;display_order&quot; value=&quot;1&quot; &lt;?php echo $display_order_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['ASCENDING']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_QUOTA']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_QUOTA_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;8&quot; maxlength=&quot;15&quot; name=&quot;attachment_quota&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['attachment_quota']; ?&gt;&quot; /&gt; &lt;?php echo $select_quota_size_mode; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_MAX_FILESIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_MAX_FILESIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;8&quot; maxlength=&quot;15&quot; name=&quot;max_filesize&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['max_filesize']; ?&gt;&quot; /&gt; &lt;?php echo $select_size_mode; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_MAX_PM_FILESIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_MAX_PM_FILESIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;8&quot; maxlength=&quot;15&quot; name=&quot;max_filesize_pm&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['max_filesize_pm']; ?&gt;&quot; /&gt; &lt;?php echo $select_pm_size_mode; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAX_ATTACHMENTS'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;max_attachments&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['max_attachments']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAX_ATTACHMENTS_PM'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;max_attachments_pm&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $new['max_attachments_pm']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_DOWNLOADS']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_DOWNLOADS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;secure_downloads&quot; value=&quot;1&quot; &lt;?php echo $secure_downloads_yes ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;secure_downloads&quot; value=&quot;0&quot; &lt;?php echo $secure_downloads_no ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_ALLOW_DENY']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_ALLOW_DENY_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;secure_allow_deny&quot; value=&quot;1&quot; &lt;?php echo $secure_allow_deny_yes ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['ORDER_ALLOW_DENY']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;secure_allow_deny&quot; value=&quot;0&quot; &lt;?php echo $secure_allow_deny_no ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['ORDER_DENY_ALLOW']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_EMPTY_REFERER']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_EMPTY_REFERER_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;secure_allow_empty_referer&quot; value=&quot;1&quot; &lt;?php echo $secure_allow_empty_referer_yes ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;secure_allow_empty_referer&quot; value=&quot;0&quot; &lt;?php echo $secure_allow_empty_referer_no ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-	  &lt;th align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SETTINGS_CAT_IMAGES']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ASSIGNED_GROUP']; ?&gt;: &lt;?php echo (empty($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) ? $_CLASS['core_user']-&gt;lang['NONE'] : implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])); ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_INLINED']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_INLINED_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;img_display_inlined&quot; value=&quot;1&quot; &lt;?php echo $display_inlined_yes ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;img_display_inlined&quot; value=&quot;0&quot; &lt;?php echo $display_inlined_no ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	$supported_types = get_supported_image_types();
-	
-	// Check Thumbnail Support
-	if (!$new['img_imagick'] &amp;&amp; (!isset($supported_types['format']) || !sizeof($supported_types['format'])))
-	{
-		$new['img_create_thumbnail'] = '0';
-	}
-	else
-	{
+				$_CLASS['core_template']-&gt;assign_vars_array('extensions', array(
+					'S_SPACER'		=&gt; $s_spacer,
+					'EXTENSION_ID'	=&gt; $row['extension_id'],
+					'EXTENSION'		=&gt; $row['extension'],
+					'GROUP_OPTIONS'	=&gt; group_select('group_select[]', $row['group_id']))
+				);
+			}
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_THUMBNAIL']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_THUMBNAIL_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;img_create_thumbnail&quot; value=&quot;1&quot; &lt;?php echo $create_thumbnail_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;img_create_thumbnail&quot; value=&quot;0&quot; &lt;?php echo $create_thumbnail_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MIN_THUMB_FILESIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MIN_THUMB_FILESIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;7&quot; maxlength=&quot;15&quot; name=&quot;img_min_thumb_filesize&quot; value=&quot;&lt;?php echo $new['img_min_thumb_filesize']; ?&gt;&quot; class=&quot;post&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['BYTES']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
+	break;
 
-	}
+	case 'ext_groups':
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMAGICK_PATH']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMAGICK_PATH_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;20&quot; maxlength=&quot;200&quot; name=&quot;img_imagick&quot; value=&quot;&lt;?php echo $new['img_imagick']; ?&gt;&quot; class=&quot;post&quot; /&gt;&nbsp;&nbsp;&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&amp;action=imgmagick&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEARCH_IMAGICK']; ?&gt;&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAX_IMAGE_SIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAX_IMAGE_SIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;img_max_width&quot; value=&quot;&lt;?php echo $new['img_max_width']; ?&gt;&quot; class=&quot;post&quot; /&gt; px X &lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;img_max_height&quot; value=&quot;&lt;?php echo $new['img_max_height']; ?&gt;&quot; class=&quot;post&quot; /&gt; px&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMAGE_LINK_SIZE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMAGE_LINK_SIZE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;img_link_width&quot; value=&quot;&lt;?php echo $new['img_link_width']; ?&gt;&quot; class=&quot;post&quot; /&gt; px X &lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;img_link_height&quot; value=&quot;&lt;?php echo $new['img_link_height']; ?&gt;&quot; class=&quot;post&quot; /&gt; px&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;/table&gt;
-&lt;?php
-	// Secure Download Options - Same procedure as with banning
-	$allow_deny = ($new['secure_allow_deny']) ? 'ALLOWED' : 'DISALLOWED';
-		
-	$sql = 'SELECT *
-		FROM ' . FORUMS_SITELIST_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
+		$_CLASS['core_template']-&gt;assign('S_EXTENSION_GROUPS', true);
 
-	$defined_ips = '';
-	$ips = array();
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$value = ($row['site_ip']) ? $row['site_ip'] : $row['site_hostname'];
-		if ($value)
+		if ($submit)
 		{
-			$defined_ips .=  '&lt;option' . (($row['ip_exclude']) ? ' class=&quot;sep&quot;' : '') . ' value=&quot;' . $row['site_id'] . '&quot;&gt;' . $value . '&lt;/option&gt;';
-			$ips[$row['site_id']] = $value;
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
+			$action = request_var('action', '');
+			$group_id = request_var('g', 0);
 
-	if (!$new['secure_downloads'])
-	{
-?&gt;
-	&lt;br /&gt;
-	&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row3&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SECURE_DOWNLOAD_NOTICE']; ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-	&lt;/table&gt;
+			if ($action != 'add' &amp;&amp; $action != 'edit')
+			{
+				trigger_error('WRONG_MODE', E_USER_WARNING);
+			}
 
-&lt;?php
-	}
-?&gt;
+			if (!$group_id &amp;&amp; $action == 'edit')
+			{
+				trigger_error('NO_EXT_GROUP_SPECIFIED', E_USER_WARNING);
+			}
 
-	&lt;br /&gt;
-	&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-		&lt;tr&gt;
-			&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DEFINE_' . $allow_deny . '_IPS']; ?&gt;&lt;/th&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td colspan=&quot;2&quot; class=&quot;row3&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DOWNLOAD_ADD_IPS_EXPLAIN']; ?&gt;&lt;/td&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IP_HOSTNAME']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt;&lt;textarea cols=&quot;40&quot; rows=&quot;3&quot; name=&quot;ips&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXCLUDE_FROM_' . $allow_deny . '_IP']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXCLUDE_ENTERED_IP']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;ipexclude&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;ipexclude&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;securesubmit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['REMOVE_' . $allow_deny . '_IPS']; ?&gt;&lt;/th&gt;
-		&lt;/tr&gt;
-&lt;?php
+			if ($group_id)
+			{
+				$sql = 'SELECT * FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
+					WHERE group_id = $group_id&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				$ext_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+			else
+			{
+				$ext_row = array();
+			}
 
-	if ($defined_ips != '')
-	{
+			$group_name = request_var('group_name', '', true);
+			$new_group_name = ($action == 'add') ? $group_name : (($ext_row['group_name'] != $group_name) ? $group_name : '');
 
-?&gt;
-		&lt;tr&gt;
-			&lt;td colspan=&quot;2&quot; class=&quot;row3&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DOWNLOAD_REMOVE_IPS_EXPLAIN']; ?&gt;&lt;/td&gt;
-		&lt;tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; width=&quot;45%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IP_HOSTNAME']; ?&gt;: &lt;br /&gt;&lt;/td&gt;
-			&lt;td class=&quot;row2&quot;&gt; &lt;select name=&quot;unip[]&quot; multiple=&quot;multiple&quot; size=&quot;10&quot;&gt;&lt;?php echo $defined_ips; ?&gt;&lt;/select&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;unsecuresubmit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-&lt;?php
+			if (!$group_name)
+			{
+				$error[] = $_CLASS['core_user']-&gt;lang['NO_EXT_GROUP_NAME'];
+			}
 
-	}
-	else
-	{
+			// Check New Group Name
+			if ($new_group_name)
+			{
+				$sql = 'SELECT group_id 
+					FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
+					WHERE LOWER(group_name) = '&quot; . $db-&gt;sql_escape(strtolower($new_group_name)) . &quot;'&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-?&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_IPS_DEFINED']; ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-&lt;?php
-	}
-?&gt;
-	&lt;/table&gt;
-&lt;?php
-}
+				if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$error[] = sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_GROUP_EXIST'], $new_group_name);
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
 
-// Extension Groups
-if ($mode == 'ext_groups')
-{
-	$cat_lang = array(
-		ATTACHMENT_CATEGORY_NONE	=&gt; $_CLASS['core_user']-&gt;lang['NONE'],
-		ATTACHMENT_CATEGORY_IMAGE	=&gt; $_CLASS['core_user']-&gt;lang['CAT_IMAGES'],
-		ATTACHMENT_CATEGORY_WM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_WM_FILES'],
-		ATTACHMENT_CATEGORY_RM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_RM_FILES']
-	);
+			if (!sizeof($error))
+			{
+				// Ok, build the update/insert array
+				$upload_icon	= request_var('upload_icon', 'no_image');
+				$size_select	= request_var('size_select', 'b');
+				$forum_select	= request_var('forum_select', false);
+				$allowed_forums	= isset($_POST['allowed_forums']) ? array_map('intval', array_values($_POST['allowed_forums'])) : array();
+				$allow_in_pm	= isset($_POST['allow_in_pm']) ? true : false;
+				$max_filesize	= request_var('max_filesize', 0);
+				$max_filesize	= ($size_select == 'kb') ? round($max_filesize * 1024) : (($size_select == 'mb') ? round($max_filesize * 1048576) : $max_filesize);
+				$allow_group	= (isset($_POST['allow_group'])) ? 1 : 0;
 
+				if ($max_filesize == $config['max_filesize'])
+				{
+					$max_filesize = 0;
+				}
 
-	$action = request_var('action', 'show');
-	$group_id = request_var('g', 0);
-	$action = (isset($_POST['add'])) ? 'add' : $action;
-	$action = (($action == 'add' || $action == 'edit') &amp;&amp; $submit &amp;&amp; !sizeof($error)) ? 'show' : $action;
+				if (!sizeof($allowed_forums))
+				{
+					$forum_select = false;
+				}
 
-	if (isset($_POST['select_mode']))
-	{
-		$action = 'show';
-	}
+				$group_ary = array(
+					'group_name'	=&gt; $group_name,
+					'cat_id'		=&gt; request_var('special_category', ATTACHMENT_CATEGORY_NONE),
+					'allow_group'	=&gt; $allow_group,
+					'download_mode'	=&gt; request_var('download_mode', INLINE_LINK),
+					'upload_icon'	=&gt; ($upload_icon == 'no_image') ? '' : $upload_icon,
+					'max_filesize'	=&gt; $max_filesize,
+					'allowed_forums'=&gt; ($forum_select) ? serialize($allowed_forums) : '',
+					'allow_in_pm'	=&gt; ($allow_in_pm) ? 1 : 0
+				);
 
-	if ($action == 'delete')
-	{
-		$confirm	= (isset($_POST['confirm'])) ? true : false;
-		$cancel		= (isset($_POST['cancel'])) ? true : false;
-		
-		if (!$cancel &amp;&amp; !$confirm)
-		{
-			adm_page_confirm($_CLASS['core_user']-&gt;lang['CONFIRM'], $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION']);
-		}
-		else if ($confirm &amp;&amp; !$cancel)
-		{
-			$sql = 'SELECT group_name 
-				FROM ' . EXTENSION_GROUPS_TABLE . &quot;
-				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-			$group_name = $_CLASS['core_db']-&gt;sql_fetchfield('group_name', 0, $result);
-			$_CLASS['core_db']-&gt;free_result($result);
-			
-			$sql = 'DELETE 
-				FROM ' . EXTENSION_GROUPS_TABLE . &quot; 
-				WHERE group_id = $group_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
+				$sql = ($action === 'add') ? 'INSERT INTO ' . FORUMS_EXTENSION_GROUPS_TABLE . ' ' : 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . ' SET ';
+				$sql .= $_CLASS['core_db']-&gt;sql_build_array((($action === 'add') ? 'INSERT' : 'UPDATE'), $group_ary);
+				$sql .= ($action === 'edit') ? &quot; WHERE group_id = $group_id&quot; : '';
 
-			// Set corresponding Extensions to a pending Group
-			$sql = 'UPDATE ' . EXTENSIONS_TABLE . &quot;
-				SET group_id = 0
-				WHERE group_id = $group_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-	
-			add_log('admin', 'LOG_ATTACH_EXTGROUP_DEL', $group_name);
+				$_CLASS['core_db']-&gt;query($sql);
 
-			rewrite_extensions();
+				if ($action === 'add')
+				{
+					$group_id = $_CLASS['core_db']-&gt;insert_id(FORUMS_EXTENSION_GROUPS_TABLE, 'group_id');
+				}
 
-			trigger_error('EXTENSION_GROUP_DELETED');
-		}
-		else
-		{
-			$action = 'show';
-		}
-	}
+				add_log('admin', 'LOG_ATTACH_EXTGROUP_' . strtoupper($action), $group_name);
+			}
 
-	switch ($action)
-	{
-		case 'edit':
-		
-			if (!$group_id)
+			$extension_list = isset($_REQUEST['extensions']) ? array_map('intval', array_values($_REQUEST['extensions'])) : array();
+
+			if ($action == 'edit' &amp;&amp; sizeof($extension_list))
 			{
-				trigger_error('NO_EXTENSION_GROUP');
+				$sql = 'UPDATE ' . FORUMS_EXTENSIONS_TABLE . &quot;
+					SET group_id = 0
+					WHERE group_id = $group_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 
-			$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . &quot;
-				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-			extract($_CLASS['core_db']-&gt;fetch_row_assoc($result));
-			$_CLASS['core_db']-&gt;free_result($result);
+			if (sizeof($extension_list))
+			{
+				$sql = 'UPDATE ' . FORUMS_EXTENSIONS_TABLE . &quot; 
+					SET group_id = $group_id
+					WHERE extension_id IN (&quot; . implode(', ', $extension_list) .')';
+				$_CLASS['core_db']-&gt;query($sql);
+			}
 
-			$forum_ids = (!$allowed_forums) ? array() : unserialize(trim($allowed_forums));
+			rewrite_extensions();
 
-		case 'add':
-			
-			if ($action == 'add')
+			if (!sizeof($error))
 			{
-				$group_name = request_var('group_name', '');
-				$cat_id = 0;
-				$allow_group = 1;
-				$allow_in_pm = 1;
-				$download_mode = 1;
-				$upload_icon = '';
-				$max_filesize = 0;
-				$forum_ids = array();
+				$notify[] = $_CLASS['core_user']-&gt;lang['SUCCESS_EXTENSION_GROUP_' . strtoupper($action)];
 			}
+		}
+	
+		$cat_lang = array(
+			ATTACHMENT_CATEGORY_NONE	=&gt; $_CLASS['core_user']-&gt;lang['NO_FILE_CAT'],
+			ATTACHMENT_CATEGORY_IMAGE	=&gt; $_CLASS['core_user']-&gt;lang['CAT_IMAGES'],
+			ATTACHMENT_CATEGORY_WM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_WM_FILES'],
+			ATTACHMENT_CATEGORY_RM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_RM_FILES']
+		);
 
-			$extensions = array();
+		$group_id = request_var('g', 0);
+		$action = (isset($_POST['add'])) ? 'add' : $action;
+//				$action = (($action == 'add' || $action == 'edit') &amp;&amp; $submit &amp;&amp; !sizeof($error)) ? 'show' : $action;
 
-			$sql = 'SELECT * FROM ' . EXTENSIONS_TABLE . &quot;
-				WHERE group_id = $group_id OR group_id = 0
-				ORDER BY extension&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-			$extensions = $_CLASS['core_db']-&gt;fetch_row_assocset($result);
-			$_CLASS['core_db']-&gt;free_result($result);
+		switch ($action)
+		{
+			case 'delete':
 
-			$img_path = $config['upload_icons_path'];
+				if (confirm_box(true))
+				{
+					$sql = 'SELECT group_name 
+						FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
+						WHERE group_id = $group_id&quot;;
+					$result = $_CLASS['core_db']-&gt;query($sql);
+					$group_name = (string) $db-&gt;sql_fetchfield('group_name');
+					$_CLASS['core_db']-&gt;free_result($result);
 
-			$imglist = filelist($img_path);
-			$imglist = array_values($imglist);
-			$imglist = $imglist[0];
+					$sql = 'DELETE 
+						FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot; 
+						WHERE group_id = $group_id&quot;;
+					$_CLASS['core_db']-&gt;query($sql);
 
-			$filename_list = '';
-			foreach ($imglist as $key =&gt; $img)
-			{
-				$filename_list .= '&lt;option value=&quot;' . $img . '&quot;&gt;' . htmlspecialchars($img) . '&lt;/option&gt;';
-			}
+					// Set corresponding Extensions to a pending Group
+					$sql = 'UPDATE ' . FORUMS_EXTENSIONS_TABLE . &quot;
+						SET group_id = 0
+						WHERE group_id = $group_id&quot;;
+					$_CLASS['core_db']-&gt;query($sql);
+			
+					add_log('admin', 'LOG_ATTACH_EXTGROUP_DEL', $group_name);
 
-			if ($max_filesize == 0)
-			{
-				$max_filesize = (int) $config['max_filesize'];
-			}
+					rewrite_extensions();
 
-			$size_format = ($max_filesize &gt;= 1048576) ? 'mb' : (($max_filesize &gt;= 1024) ? 'kb' : 'b');
+					trigger_error($_CLASS['core_user']-&gt;lang['EXTENSION_GROUP_DELETED'] . adm_back_link($u_action));
+				}
+				else
+				{
+					confirm_box(false, $_CLASS['core_user']-&gt;lang['CONFIRM_OPERATION'], build_hidden_fields(array(
+						'i'			=&gt; $id,
+						'mode'		=&gt; $mode,
+						'action'	=&gt; $action,
+						'group_id'	=&gt; $group_id,
+						'action'	=&gt; 'delete',
+					)));
+				}
 
-			$max_filesize = ($max_filesize &gt;= 1048576) ? round($max_filesize / 1048576 * 100) / 100 : (($max_filesize &gt;= 1024) ? round($max_filesize / 1024 * 100) / 100 : $max_filesize);
+			break;
 
-			$s_allowed = ($allow_group) ? ' checked=&quot;checked&quot;' : '';
-			$s_in_pm_allowed = ($allow_in_pm) ? ' checked=&quot;checked&quot;' : '';
-
-			$filename_list = '';
-			$no_image_select = false;
-			foreach ($imglist as $key =&gt; $img)
-			{
-				if (!$upload_icon)
+			case 'edit':
+			
+				if (!$group_id)
 				{
-					$no_image_select = true;
-					$selected = '';
+					trigger_error($_CLASS['core_user']-&gt;lang['NO_EXTENSION_GROUP'] . adm_back_link($u_action), E_USER_WARNING);
 				}
-				else
+
+				$sql = 'SELECT *
+					FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
+					WHERE group_id = $group_id&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				$ext_group_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				$forum_ids = (!$ext_group_row['allowed_forums']) ? array() : unserialize(trim($ext_group_row['allowed_forums']));
+
+			// no break;
+
+			case 'add':
+				
+				if ($action == 'add')
 				{
-					$selected = ($upload_icon == $img) ? ' selected=&quot;selected&quot;' : '';
+					$ext_group_row = array(
+						'group_name'	=&gt; request_var('group_name', '', true),
+						'cat_id'		=&gt; 0,
+						'allow_group'	=&gt; 1,
+						'allow_in_pm'	=&gt; 1,
+						'download_mode'	=&gt; 1,
+						'upload_icon'	=&gt; '',
+						'max_filesize'	=&gt; 0,
+					);
+					
+					$forum_ids = array();
 				}
 
-				$filename_list .= '&lt;option value=&quot;' . htmlspecialchars($img) . '&quot;' . $selected . '&gt;' . htmlspecialchars($img) . '&lt;/option&gt;';
-			}
+				$extensions = array();
 
-			// Show Edit Screen
-?&gt;
-			&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; defer=&quot;defer&quot;&gt;
-			&lt;!--
-
-			function update_image(newimage)
-			{
-				if (newimage == 'no_image')
+				$sql = 'SELECT *
+					FROM ' . FORUMS_EXTENSIONS_TABLE . &quot;
+					WHERE group_id = $group_id
+						OR group_id = 0
+					ORDER BY extension&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
-					document.image.src = &quot;images/spacer.gif&quot;;
+					$extensions[] = $row;
 				}
-				else
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				if ($ext_group_row['max_filesize'] == 0)
 				{
-					document.image.src = &quot;&lt;?php echo $img_path; ?&gt;/&quot; + newimage;
+					$ext_group_row['max_filesize'] = (int) $config['max_filesize'];
 				}
-			}
 
-			function show_extensions(elem)
-			{
-				var str = '';
+				$size_format = ($ext_group_row['max_filesize'] &gt;= 1048576) ? 'mb' : (($ext_group_row['max_filesize'] &gt;= 1024) ? 'kb' : 'b');
 
-				for (i = 0; i &lt; elem.length; i++)
+				$ext_group_row['max_filesize'] = ($ext_group_row['max_filesize'] &gt;= 1048576) ? round($ext_group_row['max_filesize'] / 1048576 * 100) / 100 : (($ext_group_row['max_filesize'] &gt;= 1024) ? round($ext_group_row['max_filesize'] / 1024 * 100) / 100 : $ext_group_row['max_filesize']);
+
+				$img_path = $config['upload_icons_path'];
+
+				$filename_list = '';
+				$no_image_select = false;
+
+				$imglist = filelist($img_path);
+
+				if (sizeof($imglist))
 				{
-					var element = elem.options[i];
-					if (element.selected)
+					$imglist = array_values($imglist);
+					$imglist = $imglist[0];
+
+					foreach ($imglist as $key =&gt; $img)
 					{
-						if (str)
+						if (!$ext_group_row['upload_icon'])
 						{
-							str = str + ', ';
+							$no_image_select = true;
+							$selected = '';
 						}
+						else
+						{
+							$selected = ($ext_group_row['upload_icon'] == $img) ? ' selected=&quot;selected&quot;' : '';
+						}
 
-						str = str + element.innerHTML;
+						$filename_list .= '&lt;option value=&quot;' . htmlspecialchars($img) . '&quot;' . $selected . '&gt;' . htmlspecialchars($img) . '&lt;/option&gt;';
 					}
 				}
 
-				if (document.all)
+				$i = 0;
+				$assigned_extensions = '';
+				foreach ($extensions as $num =&gt; $row)
 				{
-					document.all.ext.innerText = str;
+					if ($row['group_id'] == $group_id &amp;&amp; $group_id)
+					{
+						$assigned_extensions .= ($i) ? ', ' . $row['extension'] : $row['extension'];
+						$i++;
+					}
 				}
-				else if (document.getElementById('ext').textContent)
+
+				$s_extension_options = '';
+				foreach ($extensions as $row)
 				{
-					document.getElementById('ext').textContent = str;
+					$s_extension_options .= '&lt;option' . ((!$row['group_id']) ? ' class=&quot;disabled&quot;' : '') . ' value=&quot;' . $row['extension_id'] . '&quot;' . (($row['group_id'] == $group_id &amp;&amp; $group_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $row['extension'] . '&lt;/option&gt;';
 				}
-				else if (document.getElementById('ext').firstChild.nodeValue)
-				{
-					document.getElementById('ext').firstChild.nodeValue = str;
-				}
-			}
 
-			//--&gt;
-			&lt;/script&gt;
-		
-			&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;&lt;?php echo $action; ?&gt;&quot; /&gt;
-			&lt;input type=&quot;hidden&quot; name=&quot;g&quot; value=&quot;&lt;?php echo $group_id; ?&gt;&quot; /&gt;
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'IMG_PATH'			=&gt; $img_path,
+					'ACTION'			=&gt; $action,
+					'GROUP_ID'			=&gt; $group_id,
+					'GROUP_NAME'		=&gt; $ext_group_row['group_name'],
+					'ALLOW_GROUP'		=&gt; $ext_group_row['allow_group'],
+					'ALLOW_IN_PM'		=&gt; $ext_group_row['allow_in_pm'],
+					'UPLOAD_ICON_SRC'	=&gt; $img_path . '/' . $ext_group_row['upload_icon'],
+					'EXTGROUP_FILESIZE'	=&gt; $ext_group_row['max_filesize'],
+					'ASSIGNED_EXTENSIONS'	=&gt; $assigned_extensions,
 
-			&lt;table class=&quot;tablebg&quot; width=&quot;99%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[strtoupper($action) . '_EXTENSION_GROUP']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GROUP_NAME']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;20&quot; maxlength=&quot;100&quot; name=&quot;group_name&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $group_name; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SPECIAL_CATEGORY']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SPECIAL_CATEGORY_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo category_select('special_category', $group_id); ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOWED']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;allow_group&quot; value=&quot;&lt;?php echo $group_id; ?&gt;&quot;&lt;?php echo $s_allowed; ?&gt; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOW_IN_PM']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;allow_in_pm&quot; value=&quot;1&quot;&lt;?php echo $s_in_pm_allowed; ?&gt; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DOWNLOAD_MODE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DOWNLOAD_MODE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo download_select('download_mode', $group_id); ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPLOAD_ICON']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot; align=&quot;left&quot;&gt;
-					&lt;table border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td align=&quot;center&quot;&gt;&lt;select name=&quot;upload_icon&quot; onChange=&quot;update_image(this.options[selectedIndex].value);&quot;&gt;&lt;option value=&quot;no_image&quot;&lt;?php echo (($no_image_select) ? ' selected=&quot;selected&quot;' : ''); ?&gt;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_IMAGE']; ?&gt;&lt;/option&gt;&lt;?php echo $filename_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-						&lt;td width=&quot;50&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;img src=&quot;&lt;?php echo (($no_image_select) ? 'images/spacer.gif' : $img_path . '/' . $upload_icon) ?&gt;&quot; name=&quot;image&quot; border=&quot;0&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;&nbsp;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;/table&gt;
-				&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAX_EXTGROUP_FILESIZE']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;15&quot; name=&quot;max_filesize&quot; class=&quot;post&quot; value=&quot;&lt;?php echo $max_filesize; ?&gt;&quot; /&gt; &lt;?php echo size_select('size_select', $size_format); ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;35%&quot; valign=&quot;top&quot;&gt;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td colspan=&quot;2&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ASSIGNED_EXTENSIONS']; ?&gt;: &lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;
-					&lt;tr&gt;&lt;td class=&quot;row1&quot; width=&quot;20&quot;&gt; &#187; &nbsp;&lt;/td&gt;
-					&lt;td class=&quot;row1&quot;&gt;&lt;div id=&quot;ext&quot; style=&quot;margin:0px; width:200px&quot;&gt;&nbsp;&lt;?php
-							$i = 0;
-							foreach ($extensions as $num =&gt; $row)
-							{
-								if ($row['group_id'] == $group_id &amp;&amp; $group_id)
-								{
-									echo ($i) ? ', ' . $row['extension'] : $row['extension'];
-									$i++;
-								}
-							}
-					?&gt;&lt;/div&gt;&lt;/td&gt;&lt;/tr&gt;
-					&lt;tr&gt;&lt;td class=&quot;row1&quot;&gt;&nbsp;&lt;/td&gt;&lt;td class=&quot;row1&quot;&gt;&lt;br /&gt;[ &lt;a href=&quot;&lt;?php echo generate_link('forums&amp;file=admin_attachments&amp;mode=extensions', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO_TO_EXTENSIONS']; ?&gt;&lt;/a&gt; ]&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
-				&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;extensions[]&quot; onChange=&quot;show_extensions(this);&quot; multiple=&quot;true&quot; size=&quot;8&quot; style=&quot;width:100px&quot;&gt;
-&lt;?php
-					foreach ($extensions as $row)
-					{
-						echo '&lt;option' . ((!$row['group_id']) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['extension_id'] . '&quot;' . (($row['group_id'] == $group_id &amp;&amp; $group_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $row['extension'] . '&lt;/option&gt;';
-					}
-?&gt;
-				&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOWED_FORUMS']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOWED_FORUMS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;forum_select&quot; value=&quot;0&quot;&lt;?php echo (!sizeof($forum_ids)) ? ' checked=&quot;checked&quot;' : ''; ?&gt; /&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOW_ALL_FORUMS']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;forum_select&quot; value=&quot;1&quot;&lt;?php echo (sizeof($forum_ids)) ? ' checked=&quot;checked&quot;' : ''; ?&gt; /&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALLOW_SELECTED_FORUMS']; ?&gt;&lt;br /&gt;&lt;br /&gt;
-				&lt;select name=&quot;allowed_forums[]&quot; multiple=&quot;true&quot; size=&quot;8&quot;&gt;
-&lt;?php
+					'S_CATEGORY_SELECT'			=&gt; category_select('special_category', $group_id, 'category'),
+					'S_DOWNLOAD_SELECT'			=&gt; download_select('download_mode', $group_id, 'download_mode'),
+					'S_EXT_GROUP_SIZE_OPTIONS'	=&gt; size_select_options($size_format),
+					'S_EXTENSION_OPTIONS'		=&gt; $s_extension_options,
+					'S_FILENAME_LIST'			=&gt; $filename_list,
+					'S_EDIT_GROUP'				=&gt; true,
+					'S_NO_IMAGE'				=&gt; $no_image_select,
+					'S_FORUM_IDS'				=&gt; (sizeof($forum_ids)) ? true : false,
 
+					'U_EXTENSIONS'				=&gt; generate_link($u_action, array('admin' =&gt; true)),
+					'L_LEGEND'					=&gt; $_CLASS['core_user']-&gt;lang[strtoupper($action) . '_EXTENSION_GROUP'],
+					)
+				);
+
+				$s_forum_id_options = '';
+
 				$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id
-					FROM ' . FORUMS_TABLE . '
+					FROM ' . FORUMS_FORUMS_TABLE . '
 					ORDER BY left_id ASC';
-				$result = $_CLASS['core_db']-&gt;query($sql);
+				$result = $_CLASS['core_db']-&gt;query($sql, 600);
 
 				$right = $cat_right = $padding_inc = 0;
 				$padding = $forum_list = $holding = '';
@@ -982,7 +733,7 @@
 						continue;
 					}
 
-					if (!$_CLASS['auth']-&gt;acl_get('f_list', $row['forum_id']))
+					if (!$_CLASS['forums_auth']-&gt;acl_get('f_list', $row['forum_id']))
 					{
 						// if the user does not have permissions to list this forum skip
 						continue;
@@ -1015,279 +766,272 @@
 					}
 					else
 					{
-						echo $holding . '&lt;option value=&quot;' . $row['forum_id'] . '&quot;' . (($row['forum_type'] == FORUM_POST) ? ' class=&quot;blue&quot;' : '') . $selected . '&gt;' . $padding . $row['forum_name'] . '&lt;/option&gt;';
+						$s_forum_id_options .= $holding . '&lt;option value=&quot;' . $row['forum_id'] . '&quot;' . (($row['forum_type'] == FORUM_POST) ? ' class=&quot;blue&quot;' : '') . $selected . '&gt;' . $padding . $row['forum_name'] . '&lt;/option&gt;';
 						$holding = '';
 					}
 				}
 				$_CLASS['core_db']-&gt;free_result($result);
 				unset($padding_store);
-?&gt;
-				&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;/table&gt;
-&lt;?php
-		
+
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'S_FORUM_ID_OPTIONS'	=&gt; $s_forum_id_options)
+				);
+			
 			break;
 
-		case 'deactivate':
-		case 'activate':
-	
-			if (!$group_id)
-			{
-				trigger_error('NO_EXTENSION_GROUP');
-			}
+			case 'deactivate':
+			case 'activate':
 
-			$sql = 'UPDATE ' . EXTENSION_GROUPS_TABLE . '
-				SET allow_group = ' . (($action == 'activate') ? '1' : '0') . &quot;
-				WHERE group_id = $group_id&quot;;
+				if (!$group_id)
+				{
+					trigger_error($_CLASS['core_user']-&gt;lang['NO_EXTENSION_GROUP'] . adm_back_link($u_action), E_USER_WARNING);
+				}
 
-			$_CLASS['core_db']-&gt;query($sql);
+				$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . '
+					SET allow_group = ' . (($action == 'activate') ? '1' : '0') . &quot;
+					WHERE group_id = $group_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
 
-			rewrite_extensions();
+				rewrite_extensions();
 
-		case 'show':
-	
-	$sql = 'SELECT *
-		FROM ' . EXTENSION_GROUPS_TABLE . '
-		ORDER BY allow_group DESC, group_name';
-	$result = $_CLASS['core_db']-&gt;query($sql);
+			break;
+		}
 
-?&gt;
+		$sql = 'SELECT *
+			FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . '
+			ORDER BY allow_group DESC, group_name';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-	&lt;table class=&quot;tablebg&quot; width=&quot;99%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th width=&quot;60%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXTENSION_GROUP']; ?&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SPECIAL_CATEGORY']; ?&gt;&lt;/th&gt;
-		&lt;th colspan=&quot;3&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTIONS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
+		$act_deact = 'activate';
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$s_add_spacer = ($row['allow_group'] == 0 &amp;&amp; $act_deact == 'deactivate') ? true : false;
 
-&lt;?php
+			$act_deact = ($row['allow_group']) ? 'deactivate' : 'activate';
 
-	$row_class = 'row2';
+			$_CLASS['core_template']-&gt;assign_vars_array('groups', array(
+				'S_ADD_SPACER'		=&gt; $s_add_spacer,
+				'S_ALLOWED_IN_PM'	=&gt; ($row['allow_in_pm']) ? true : false,
+				'S_GROUP_ALLOWED'	=&gt; ($row['allow_group']) ? true : false,
 
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-		
-		if ($row['allow_group'] == 0 &amp;&amp; $act_deact == 'deactivate')
-		{
-?&gt;
+				'U_EDIT'		=&gt; generate_link($u_action . &quot;&amp;action=edit&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)),
+				'U_DELETE'		=&gt; generate_link($u_action . &quot;&amp;action=delete&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)),
+				'U_ACT_DEACT'	=&gt; generate_link($u_action . &quot;&amp;action=$act_deact&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)),
 
-		&lt;tr&gt;
-			&lt;td class=&quot;spacer&quot; colspan=&quot;5&quot; height=&quot;1&quot;&gt;&lt;img src=&quot;../images/spacer.gif&quot; alt=&quot;&quot; width=&quot;1&quot; height=&quot;1&quot; /&gt;&lt;/td&gt;
-		&lt;/tr&gt;
+				'L_ACT_DEACT'	=&gt; $_CLASS['core_user']-&gt;lang[strtoupper($act_deact)],
+				'GROUP_NAME'	=&gt; $row['group_name'],
+				'CATEGORY'		=&gt; $cat_lang[$row['cat_id']],
+				)
+			);
 
-&lt;?php
-
 		}
-		
-		$act_deact = ($row['allow_group']) ? 'deactivate' : 'activate';
-?&gt;
+		$_CLASS['core_db']-&gt;free_result($result);
 
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&amp;action=edit&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $row['group_name']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;b&gt;&lt;?php echo $cat_lang[$row['cat_id']]; ?&gt;&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&amp;action=$act_deact&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[strtoupper($act_deact)]; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&amp;action=edit&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;forums&amp;file=admin_attachments&amp;mode=$mode&amp;action=delete&amp;g={$row['group_id']}&quot;, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-	&lt;/tr&gt;
+	break;
 
-&lt;?php
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
+	case 'orphan':
 
-?&gt;
-	&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_GROUP']; ?&gt;: &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;group_name&quot; maxlength=&quot;30&quot; /&gt; &lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/table&gt;
+		if ($submit)
+		{
+			$delete_files = (isset($_POST['delete'])) ? array_keys(request_var('delete', array('' =&gt; 0))) : array();
+			$add_files = (isset($_POST['add'])) ? array_keys(request_var('add', array('' =&gt; 0))) : array();
+			$post_ids = request_var('post_id', array('' =&gt; 0));
 
-&lt;?php
+			if (sizeof($delete_files))
+			{
+				$sql = 'SELECT *
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+					WHERE ' . $db-&gt;sql_in_set('attach_id', $delete_files) . '
+						AND is_orphan = 1';
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-			break;
-	}
+				$delete_files = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					phpbb_unlink($row['physical_filename']);
 
-}
+					if ($row['thumbnail'])
+					{
+						phpbb_unlink($row['physical_filename'], 'thumbnail');
+					}
 
-// Extensions
-if ($mode == 'extensions')
-{
-?&gt;
-	&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt; 
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXTENSION']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXTENSION_GROUP']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_EXTENSION']; ?&gt;&nbsp;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;text&quot; size=&quot;20&quot; maxlength=&quot;100&quot; name=&quot;add_extension&quot; class=&quot;post&quot; value=&quot;&lt;?php echo (isset($add_extension)) ? $add_extension : ''; ?&gt;&quot; /&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;?php echo (($submit) ? group_select('add_group_select', $add_extension_group) : group_select('add_group_select')) ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;add_extension_check&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr align=&quot;right&quot;&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;3&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXTENSION']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXTENSION_GROUP']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&nbsp;&lt;/th&gt;
-	&lt;/tr&gt;
+					$delete_files[$row['attach_id']] = $row['real_filename'];
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
 
-&lt;?php
-	$sql = 'SELECT * 
-		FROM ' . EXTENSIONS_TABLE . ' 
-		ORDER BY group_id, extension';
-	$result = $_CLASS['core_db']-&gt;query($sql);
+			if (sizeof($delete_files))
+			{
+				$sql = 'DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+					WHERE ' . $db-&gt;sql_in_set('attach_id', array_keys($delete_files));
+				$_CLASS['core_db']-&gt;query($sql);
 
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$old_group_id = $row['group_id'];
-		do
-		{
-			$current_group_id = $row['group_id'];
-			if ($old_group_id != $current_group_id)
+				add_log('admin', 'LOG_ATTACH_ORPHAN_DEL', implode(', ', $delete_files));
+				$notify[] = sprintf($_CLASS['core_user']-&gt;lang['LOG_ATTACH_ORPHAN_DEL'], implode(', ', $delete_files));
+			}
+
+			$upload_list = array();
+			foreach ($add_files as $attach_id)
 			{
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;spacer&quot; colspan=&quot;3&quot; height=&quot;1&quot;&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-				$old_group_id = $current_group_id;
+				if (!in_array($attach_id, array_keys($delete_files)) &amp;&amp; !empty($post_ids[$attach_id]))
+				{
+					$upload_list[$attach_id] = $post_ids[$attach_id];
+				}
 			}
-?&gt;
-	&lt;tr&gt; 
-		&lt;input type=&quot;hidden&quot; name=&quot;extension_change_list[]&quot; value=&quot;&lt;?php echo $row['extension_id']; ?&gt;&quot; /&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;b class=&quot;gen&quot;&gt;&lt;?php echo $row['extension']; ?&gt;&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;?php echo group_select('group_select[]', $row['group_id']); ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;extension_id_list[]&quot; value=&quot;&lt;?php echo $row['extension_id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	}
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;3&quot; align=&quot;right&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;/table&gt;
-&lt;?
-}
+			unset($add_files);
 
-// Orphan Attachments
-if ($mode == 'orphan')
-{
-	$attach_filelist = array();
+			if (sizeof($upload_list))
+			{
+				$_CLASS['core_template']-&gt;assign('S_UPLOADING_FILES', true);
 
-	$dir = @opendir($config['upload_path']);
-	while ($file = @readdir($dir))
-	{
-		if (is_file($config['upload_path'] . '/' . $file) &amp;&amp; filesize($config['upload_path'] . '/' . $file) &amp;&amp; $file{0} != '.' &amp;&amp; $file != 'index.htm' &amp;&amp; !preg_match('#^thumb\_#', $file))
-		{
-			$attach_filelist[$file] = $file;
-		}
-	}
-	@closedir($dir);
+				$sql = 'SELECT forum_id, forum_name
+					FROM ' . FORUMS_FORUMS_TABLE;
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-?&gt;
+				$forum_names = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$forum_names[$row['forum_id']] = $row['forum_name'];
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
 
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-function marklist(match, name, status)
-{
-	len = eval('document.' + match + '.length');
-	object = eval('document.' + match);
-	for (i = 0; i &lt; len; i++)
-	{
-		result = eval('object.elements[' + i + '].name.search(/' + name + '.+/)');
-		if (result != -1)
-			object.elements[i].checked = status;
-	}
-}
-//--&gt;
-&lt;/script&gt;
+				$sql = 'SELECT forum_id, topic_id, post_id, poster_id
+					FROM ' . FORUMS_POSTS_TABLE . '
+					WHERE ' . $db-&gt;sql_in_set('post_id', $upload_list);
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-&lt;?php
-	$sql = 'SELECT physical_filename 
-		FROM ' . ATTACHMENTS_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
+				$post_info = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$post_info[$row['post_id']] = $row;
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
 
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		unset($attach_filelist[$row['physical_filename']]);
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
+				// Select those attachments we want to change...
+				$sql = 'SELECT *
+					FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+					WHERE ' . $db-&gt;sql_in_set('attach_id', array_keys($upload_list)) . '
+						AND is_orphan = 1';
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-?&gt;
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$post_row = $post_info[$upload_list[$row['attach_id']]];
 
-	&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt; 
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['FILENAME']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['FILESIZE']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_POST_ID']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['ATTACH_TO_POST']; ?&gt;&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&nbsp;&lt;/th&gt;
-	&lt;/tr&gt;
+					$_CLASS['core_template']-&gt;assign_vars_array('upload', array(
+						'FILE_INFO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UPLOADING_FILE_TO'], $row['real_filename'], $post_row['post_id']),
+						'S_DENIED'		=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_attach', $post_row['forum_id'])) ? true : false,
+						'L_DENIED'		=&gt; (!$_CLASS['forums_auth']-&gt;acl_get('f_attach', $post_row['forum_id'])) ? sprintf($_CLASS['core_user']-&gt;lang['UPLOAD_DENIED_FORUM'], $forum_names[$row['forum_id']]) : '')
+					);
 
-&lt;?php
-	$i = 0;
-	foreach ($attach_filelist as $file)
-	{
-		$row_class = (++$i % 2 == 0) ? 'row2' : 'row1';
-		$filesize = @filesize($config['upload_path'] . '/' . $file);
-		$size_lang = ($filesize &gt;= 1048576) ? $_CLASS['core_user']-&gt;lang['MB'] : ( ($filesize &gt;= 1024) ? $_CLASS['core_user']-&gt;lang['KB'] : $_CLASS['core_user']-&gt;lang['BYTES'] );
-		$filesize = ($filesize &gt;= 1048576) ? round((round($filesize / 1048576 * 100) / 100), 2) : (($filesize &gt;= 1024) ? round((round($filesize / 1024 * 100) / 100), 2) : $filesize);
-?&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;&lt;?php echo $config['upload_path'] . '/' . $file; ?&gt;&quot; class=&quot;gen&quot; target=&quot;file&quot;&gt;&lt;?php echo $file; ?&gt;&lt;/a&gt;&lt;/td&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;?php echo $filesize . ' ' . $size_lang; ?&gt;&lt;/td&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;b class=&quot;gen&quot;&gt;ID: &lt;/b&gt;&lt;input type=&quot;text&quot; name=&quot;post_id[&lt;?php echo $file; ?&gt;]&quot; class=&quot;post&quot; size=&quot;7&quot; maxlength=&quot;10&quot; value=&quot;&lt;?php echo (!empty($post_ids[$file])) ? $post_ids[$file] : ''; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;add[&lt;?php echo $file; ?&gt;]&quot; /&gt;&lt;/td&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;delete[&lt;?php echo $file; ?&gt;]&quot; /&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-&lt;?php
-	}
+					if (!$_CLASS['forums_auth']-&gt;acl_get('f_attach', $post_row['forum_id']))
+					{
+						continue;
+					}
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;3&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;left&quot;&gt;&lt;b&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('attachments', 'add', true);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('attachments', 'add', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;left&quot;&gt;&lt;b&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('attachments', 'delete', true);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('attachments', 'delete', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/span&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-&lt;?php
-}
+					// Adjust attachment entry
+					$sql_ary = array(
+						'in_message'	=&gt; 0,
+						'is_orphan'		=&gt; 0,
+						'poster_id'		=&gt; $post_row['poster_id'],
+						'post_msg_id'	=&gt; $post_row['post_id'],
+						'topic_id'		=&gt; $post_row['topic_id'],
+					);
 
-?&gt;
+					$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . '
+						SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
+						WHERE attach_id = ' . $row['attach_id'];
+					$_CLASS['core_db']-&gt;query($sql);
 
-&lt;/form&gt;
+					$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+						SET post_attachment = 1
+						WHERE post_id = ' . $post_row['post_id'];
+					$_CLASS['core_db']-&gt;query($sql);
 
-&lt;br clear=&quot;all&quot; /&gt;
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+						SET topic_attachment = 1
+						WHERE topic_id = ' . $post_row['topic_id'];
+					$_CLASS['core_db']-&gt;query($sql);
 
-&lt;?php
+					add_log('admin', 'LOG_ATTACH_FILEUPLOAD', $post_row['post_id'], $row['real_filename']);
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+		}
 
-adm_page_footer();
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_ORPHAN'		=&gt; true)
+		);
 
-// Build Select for category items
-function category_select($select_name, $group_id = false)
+		// Just get the files with is_orphan set and older than 3 hours
+		$sql = 'SELECT *
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+			WHERE is_orphan = 1
+				AND filetime &lt; ' . (time() - 3*60*60) . '
+			ORDER BY filetime DESC';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$size_lang = ($row['filesize'] &gt;= 1048576) ? $_CLASS['core_user']-&gt;lang['MB'] : (($row['filesize'] &gt;= 1024) ? $_CLASS['core_user']-&gt;lang['KB'] : $_CLASS['core_user']-&gt;lang['BYTES']);
+			$row['filesize'] = ($row['filesize'] &gt;= 1048576) ? round((round($row['filesize'] / 1048576 * 100) / 100), 2) : (($row['filesize'] &gt;= 1024) ? round((round($row['filesize'] / 1024 * 100) / 100), 2) : $row['filesize']);
+
+			$_CLASS['core_template']-&gt;assign_vars_array('orphan', array(
+				'FILESIZE'			=&gt; $row['filesize'] . ' ' . $size_lang,
+				'FILETIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['filetime']),
+				'REAL_FILENAME'		=&gt; basename($row['real_filename']),
+				'PHYSICAL_FILENAME'	=&gt; basename($row['physical_filename']),
+				'ATTACH_ID'			=&gt; $row['attach_id'],
+				'POST_IDS'			=&gt; (!empty($post_ids[$row['attach_id']])) ? $post_ids[$row['attach_id']] : '',
+				'U_FILE'			=&gt; generate_link('forums&amp;file=download&amp;id=' . $row['attach_id'])
+			));
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+	break;
+}
+
+if (sizeof($error))
 {
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_WARNING'		=&gt; true,
+		'WARNING_MSG'	=&gt; implode('&lt;br /&gt;', $error))
+	);
+}
+
+if (sizeof($notify))
+{
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_NOTIFY'		=&gt; true,
+		'NOTIFY_MSG'	=&gt; implode('&lt;br /&gt;', $notify))
+	);
+}
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($l_title), 'modules/forums/admin/acp_attachments.html');
+
+/**
+* Build Select for category items
+*/
+function category_select($select_name, $group_id = false, $key = '')
+{
 	global $_CLASS;
 
 	$types = array(
-		ATTACHMENT_CATEGORY_NONE =&gt; $_CLASS['core_user']-&gt;lang['NONE'],
-		ATTACHMENT_CATEGORY_IMAGE =&gt; $_CLASS['core_user']-&gt;lang['CAT_IMAGES'],
-		ATTACHMENT_CATEGORY_WM =&gt; $_CLASS['core_user']-&gt;lang['CAT_WM_FILES'],
-		ATTACHMENT_CATEGORY_RM =&gt; $_CLASS['core_user']-&gt;lang['CAT_RM_FILES']
+		ATTACHMENT_CATEGORY_NONE	=&gt; $_CLASS['core_user']-&gt;lang['NO_FILE_CAT'],
+		ATTACHMENT_CATEGORY_IMAGE	=&gt; $_CLASS['core_user']-&gt;lang['CAT_IMAGES'],
+		ATTACHMENT_CATEGORY_WM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_WM_FILES'],
+		ATTACHMENT_CATEGORY_RM		=&gt; $_CLASS['core_user']-&gt;lang['CAT_RM_FILES']
 	);
 	
 	if ($group_id)
 	{
 		$sql = 'SELECT cat_id
-			FROM ' . EXTENSION_GROUPS_TABLE . '
+			FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . '
 			WHERE group_id = ' . (int) $group_id;
 		$result = $_CLASS['core_db']-&gt;query($sql);
-		
+
 		$cat_type = (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))) ? ATTACHMENT_CATEGORY_NONE : $row['cat_id'];
+
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
 	else
@@ -1295,7 +1039,7 @@
 		$cat_type = ATTACHMENT_CATEGORY_NONE;
 	}
 	
-	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;&gt;';
+	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;' . (($key) ? ' id=&quot;' . $key . '&quot;' : '') . '&gt;';
 
 	foreach ($types as $type =&gt; $mode)
 	{
@@ -1308,15 +1052,17 @@
 	return $group_select;
 }
 
-// Extension group select
-function group_select($select_name, $default_group = false)
+/**
+* Extension group select
+*/
+function group_select($select_name, $default_group = false, $key = '')
 {
 	global $_CLASS;
 		
-	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;&gt;';
+	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;' . (($key) ? ' id=&quot;' . $key . '&quot;' : '') . '&gt;';
 
 	$sql = 'SELECT group_id, group_name
-		FROM ' . EXTENSION_GROUPS_TABLE . '
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . '
 		ORDER BY group_name';
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -1350,23 +1096,25 @@
 	return $group_select;
 }
 
-// Build select for download modes
-function download_select($select_name, $group_id = false)
+/**
+* Build select for download modes
+*/
+function download_select($select_name, $group_id = false, $key = '')
 {
 	global $_CLASS;
 		
 	$types = array(
-		INLINE_LINK =&gt; $_CLASS['core_user']-&gt;lang['MODE_INLINE'],
-		PHYSICAL_LINK =&gt; $_CLASS['core_user']-&gt;lang['MODE_PHYSICAL']
+		INLINE_LINK		=&gt; $_CLASS['core_user']-&gt;lang['MODE_INLINE'],
+		PHYSICAL_LINK	=&gt; $_CLASS['core_user']-&gt;lang['MODE_PHYSICAL']
 	);
 	
 	if ($group_id)
 	{
 		$sql = &quot;SELECT download_mode
-			FROM &quot; . EXTENSION_GROUPS_TABLE . &quot;
+			FROM &quot; . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
 			WHERE group_id = &quot; . (int) $group_id;
 		$result = $_CLASS['core_db']-&gt;query($sql);
-		
+
 		$download_mode = (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))) ? INLINE_LINK : $row['download_mode'];
 
 		$_CLASS['core_db']-&gt;free_result($result);
@@ -1376,7 +1124,7 @@
 		$download_mode = INLINE_LINK;
 	}
 
-	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;&gt;';
+	$group_select = '&lt;select name=&quot;' . $select_name . '&quot;' . (($key) ? ' id=&quot;' . $key . '&quot;' : '') . '&gt;';
 
 	foreach ($types as $type =&gt; $mode)
 	{
@@ -1389,80 +1137,32 @@
 	return $group_select;
 }
 
-// Upload already uploaded file... huh? are you kidding?
-function upload_file($post_id, $topic_id, $forum_id, $upload_dir, $filename)
+/**
+* Search Imagick
+*/
+function search_imagemagick()
 {
-	global $message_parser, $_CLASS;
+	$imagick = '';
 
-	$message_parser-&gt;attachment_data = array();
+	$exe = ((defined('PHP_OS')) &amp;&amp; (preg_match('#^win#i', PHP_OS))) ? '.exe' : '';
 
-	$message_parser-&gt;filename_data['filecomment'] = '';
-	$message_parser-&gt;filename_data['filename'] = $upload_dir . '/' . $filename;
+	$magic_home = getenv('MAGICK_HOME');
 
-	$filedata = upload_attachment('local', $forum_id, true, $upload_dir . '/' . basename($filename));
-
-	if ($filedata['post_attach'] &amp;&amp; !sizeof($filedata['error']))
+	if (empty($magic_home))
 	{
-		$message_parser-&gt;attachment_data = array(
-			'post_msg_id'		=&gt; $post_id,
-			'poster_id'			=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-			'topic_id'			=&gt; $topic_id,
-			'in_message'		=&gt; 0,
-			'physical_filename'	=&gt; $filedata['physical_filename'],
-			'real_filename'		=&gt; $filedata['real_filename'],
-			'comment'			=&gt; $message_parser-&gt;filename_data['filecomment'],
-			'extension'			=&gt; $filedata['extension'],
-			'mimetype'			=&gt; $filedata['mimetype'],
-			'filesize'			=&gt; $filedata['filesize'],
-			'filetime'			=&gt; $filedata['filetime'],
-			'thumbnail'			=&gt; $filedata['thumbnail']
-		);
-
-		$message_parser-&gt;filename_data['filecomment'] = '';
-		$filedata['post_attach'] = FALSE;
-
-		// Submit Attachment
-		$attach_sql = $message_parser-&gt;attachment_data;
-
-		$_CLASS['core_db']-&gt;sql_transaction();
-
-		$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql);
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$sql = 'UPDATE ' . POSTS_TABLE . &quot;
-			SET post_attachment = 1
-			WHERE post_id = $post_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$sql = 'UPDATE ' . TOPICS_TABLE . &quot;
-			SET topic_attachment = 1
-			WHERE topic_id = $topic_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$_CLASS['core_db']-&gt;sql_transaction('commit');
-
-		add_log('admin', sprintf($_CLASS['core_user']-&gt;lang['LOG_ATTACH_FILEUPLOAD'], $post_id, $filename));
-		echo '&lt;span style=&quot;color:green&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SUCCESSFULLY_UPLOADED'] . '&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;';
-	}
-	else if (sizeof($filedata['error']))
-	{
-		echo '&lt;span style=&quot;color:red&quot;&gt;' . sprintf($_CLASS['core_user']-&gt;lang['ADMIN_UPLOAD_ERROR'], implode(&quot;&lt;br /&gt;\t&quot;, $filedata['error'])) . '&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;';
-	}
-}
-
-// Search Imagick
-function search_imagemagick()
-{
-	$imagick = '';
-	
-	$exe = ((defined('PHP_OS')) &amp;&amp; (preg_match('#win#i', PHP_OS))) ? '.exe' : '';
-
-	if (empty($_ENV['MAGICK_HOME']))
-	{
 		$locations = array('C:/WINDOWS/', 'C:/WINNT/', 'C:/WINDOWS/SYSTEM/', 'C:/WINNT/SYSTEM/', 'C:/WINDOWS/SYSTEM32/', 'C:/WINNT/SYSTEM32/', '/usr/bin/', '/usr/sbin/', '/usr/local/bin/', '/usr/local/sbin/', '/opt/', '/usr/imagemagick/', '/usr/bin/imagemagick/');
+		$path_locations = str_replace('\\', '/', (explode(($exe) ? ';' : ':', getenv('PATH'))));	
 
+		$locations = array_merge($path_locations, $locations);
+
 		foreach ($locations as $location)
 		{
+			// The path might not end properly, fudge it
+			if (substr($location, -1, 1) !== '/')
+			{
+				$location .= '/';
+			}
+
 			if (@is_readable($location . 'mogrify' . $exe) &amp;&amp; @filesize($location . 'mogrify' . $exe) &gt; 3000)
 			{
 				$imagick = str_replace('\\', '/', $location);
@@ -1472,13 +1172,15 @@
 	}
 	else
 	{
-		$imagick = str_replace('\\', '/', $_ENV['MAGICK_HOME']);
+		$imagick = str_replace('\\', '/', $magic_home);
 	}
 
 	return $imagick;
 }
 
-// Test Settings
+/**
+* Test Settings
+*/
 function test_upload(&amp;$error, $upload_dir, $create_directory = false)
 {
 	global $_CLASS;
@@ -1498,13 +1200,13 @@
 		$error[] = sprintf($_CLASS['core_user']-&gt;lang['NO_UPLOAD_DIR'], $upload_dir);
 		return;
 	}
-	
+
 	if (!is_dir($upload_dir))
 	{
 		$error[] = sprintf($_CLASS['core_user']-&gt;lang['UPLOAD_NOT_DIR'], $upload_dir);
 		return;
 	}
-	
+
 	if (!is_writable($upload_dir))
 	{
 		$error[] = sprintf($_CLASS['core_user']-&gt;lang['NO_WRITE_UPLOAD'], $upload_dir);
@@ -1512,9 +1214,12 @@
 	}
 }
 
+/**
+* Perform operations on sites for external linking
+*/
 function perform_site_list()
 {
-	global $_CLASS;
+	global $db, $user;
 
 	if (isset($_REQUEST['securesubmit']))
 	{
@@ -1541,7 +1246,7 @@
 					$ip_2_counter = ($ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[2] : 0;
 					$ip_2_end = ($ip_1_counter &lt; $ip_1_end) ? 254 : $ip_range_explode[6];
 
-					if($ip_2_counter == 0 &amp;&amp; $ip_2_end == 254)
+					if ($ip_2_counter == 0 &amp;&amp; $ip_2_end == 254)
 					{
 						$ip_2_counter = 256;
 						$ip_2_fragment = 256;
@@ -1620,7 +1325,7 @@
 				{
 					$hostlist_tmp[] = &quot;'&quot; . $row['site_hostname'] . &quot;'&quot;;
 				}
-				break;
+				// break;
 			}
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
@@ -1629,6 +1334,7 @@
 			unset($iplist_tmp);
 			unset($hostlist_tmp);
 		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
 		if (sizeof($iplist))
 		{
@@ -1661,25 +1367,26 @@
 	}
 	else if (isset($_POST['unsecuresubmit']))
 	{
-		$unip_sql = implode(', ', array_map('intval', $_POST['unip']));
+		$unip_sql = array_map('intval', $_POST['unip']);
 
-		if ($unip_sql != '')
+		if (sizeof($unip_sql))
 		{
 			$l_unip_list = '';
-		
+
 			// Grab details of ips for logging information later
 			$sql = 'SELECT site_ip, site_hostname
-				FROM ' . FORUMS_SITELIST_TABLE . &quot;
-				WHERE site_id IN ($unip_sql)&quot;;
+				FROM ' . FORUMS_SITELIST_TABLE . '
+				WHERE ' . $db-&gt;sql_in_set('site_id', $unip_sql);
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$l_unip_list .= (($l_unip_list != '') ? ', ' : '') . (($row['site_ip']) ? $row['site_ip'] : $row['site_hostname']);
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
-			$sql = 'DELETE FROM ' . FORUMS_SITELIST_TABLE . &quot;
-				WHERE site_id IN ($unip_sql)&quot;;
+			$sql = 'DELETE FROM ' . SITELIST_TABLE . '
+				WHERE ' . $db-&gt;sql_in_set('site_id', $unip_sql);
 			$_CLASS['core_db']-&gt;query($sql);
 
 			add_log('admin', 'LOG_DOWNLOAD_REMOVE_IP', $l_unip_list);
@@ -1689,13 +1396,15 @@
 	}
 }
 
-// Re-Write extensions cache file
+/**
+* Re-Write extensions cache file
+*/
 function rewrite_extensions()
 {
 	global $_CLASS;
 
 	$sql = 'SELECT e.extension, g.*
-		FROM ' . EXTENSIONS_TABLE . ' e, ' . EXTENSION_GROUPS_TABLE . ' g
+		FROM ' . FORUMS_EXTENSIONS_TABLE . ' e, ' . FORUMS_EXTENSION_GROUPS_TABLE . ' g
 		WHERE e.group_id = g.group_id
 			AND g.allow_group = 1';
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -1711,12 +1420,12 @@
 		$extensions[$extension]['max_filesize']	= (int) $row['max_filesize'];
 
 		$allowed_forums = ($row['allowed_forums']) ? unserialize(trim($row['allowed_forums'])) : array();
-			
+
 		if ($row['allow_in_pm'])
 		{
 			$allowed_forums = array_merge($allowed_forums, array(0));
 		}
-			
+
 		// Store allowed extensions forum wise
 		$extensions['_allowed_'][$extension] = (!sizeof($allowed_forums)) ? 0 : $allowed_forums;
 	}
@@ -1726,4 +1435,34 @@
 	$_CLASS['core_cache']-&gt;put('extensions', $extensions);
 }
 
-?&gt;
\ No newline at end of file
+/**
+* Write display_order config field
+*/
+function display_order($value, $key = '')
+{
+	$radio_ary = array(0 =&gt; 'DESCENDING', 1 =&gt; 'ASCENDING');
+
+	return h_radio('config[display_order]', $radio_ary, $value, $key);
+}
+
+/**
+* Adjust all three max_filesize config vars for display
+*/
+function max_filesize($value, $key = '')
+{
+	// Determine size var and adjust the value accordingly
+	$size_var = ($value &gt;= 1048576) ? 'mb' : (($value &gt;= 1024) ? 'kb' : 'b');
+	$value = ($value &gt;= 1048576) ? round($value / 1048576 * 100) / 100 : (($value &gt;= 1024) ? round($value / 1024 * 100) / 100 : $value);
+
+	return '&lt;input type=&quot;text&quot; id=&quot;' . $key . '&quot; size=&quot;8&quot; maxlength=&quot;15&quot; name=&quot;config[' . $key . ']&quot; value=&quot;' . $value . '&quot; /&gt; &lt;select name=&quot;' . $key . '&quot;&gt;' . size_select_options($size_var) . '&lt;/select&gt;';
+}
+
+/**
+* Write secure_allow_deny config field
+*/
+function select_allow_deny($value, $key = '')
+{
+	$radio_ary = array(1 =&gt; 'ORDER_ALLOW_DENY', 0 =&gt; 'ORDER_DENY_ALLOW');
+
+	return h_radio('config[' . $key . ']', $radio_ary, $value, $key);
+}

Modified: cms/trunk/includes/forums/admin/admin_bbcodes.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_bbcodes.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_bbcodes.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -15,314 +15,253 @@
 	die; 
 }
 
+global $_CLASS;
+
 // Do we have general permissions?
-if (!$_CLASS['auth']-&gt;acl_get('a_bbcode'))
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_bbcode'))
 {
 	trigger_error('NO_ADMIN');
 }
 
+
+
+$_CLASS['core_user']-&gt;add_lang('admin_posting', 'forums');
+
 // Set up general vars
-$mode = request_var('mode', '');
+$action	= request_var('action', '');
 $bbcode_id = request_var('bbcode', 0);
+$u_action = '';
 
+$tpl_name = 'acp_bbcodes';
+$page_title = 'ACP_BBCODES';
+
 // Set up mode-specific vars
-switch ($mode)
+switch ($action)
 {
 	case 'add':
-		$bbcode_match = $bbcode_tpl = '';
+		$bbcode_match = $bbcode_tpl = $bbcode_helpline = '';
+		$display_on_posting = 0;
 	break;
 
 	case 'edit':
-		$sql = 'SELECT bbcode_match, bbcode_tpl
-			FROM ' . BBCODES_TABLE . '
+		$sql = 'SELECT bbcode_match, bbcode_tpl, display_on_posting, bbcode_helpline
+			FROM ' . FORUMS_BBCODES_TABLE . '
 			WHERE bbcode_id = ' . $bbcode_id;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		if (!$row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (!$row)
 		{
-			trigger_error('BBCODE_NOT_EXIST');
+			trigger_error('BBCODE_NOT_EXIST', E_USER_WARNING);
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
 
 		$bbcode_match = $row['bbcode_match'];
 		$bbcode_tpl = htmlspecialchars($row['bbcode_tpl']);
+		$display_on_posting = $row['display_on_posting'];
+		$bbcode_helpline = html_entity_decode($row['bbcode_helpline']);
 	break;
 
 	case 'modify':
-		$sql = 'SELECT bbcode_id
-			FROM ' . BBCODES_TABLE . '
+		$sql = 'SELECT bbcode_id, bbcode_tag
+			FROM ' . FORUMS_BBCODES_TABLE . '
 			WHERE bbcode_id = ' . $bbcode_id;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		if (!$row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (!$row)
 		{
-			trigger_error('BBCODE_NOT_EXIST');
+			trigger_error('BBCODE_NOT_EXIST', E_USER_WARNING);
 		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
 
-		// No break here
+	// No break here
 
 	case 'create':
-		$bbcode_match = htmlspecialchars(strip_slashes($_POST['bbcode_match']));
-		$bbcode_tpl = strip_slashes($_POST['bbcode_tpl']);
+		$display_on_posting = request_var('display_on_posting', 0);
+
+		$bbcode_match = request_var('bbcode_match', '');
+		$bbcode_tpl = html_entity_decode(request_var('bbcode_tpl', ''));
+		$bbcode_helpline = htmlspecialchars(request_var('bbcode_helpline', ''));
 	break;
 }
 
 // Do major work
-switch ($mode)
+switch ($action)
 {
 	case 'edit':
 	case 'add':
-		adm_page_header($_CLASS['core_user']-&gt;lang['BBCODES']);
 
-?&gt;
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT_BBCODE'		=&gt; true,
+			'U_BACK'			=&gt; $u_action,
+			'U_ACTION'			=&gt; $u_action . '&amp;action=' . (($action == 'add') ? 'create' : 'modify') . (($bbcode_id) ? &quot;&amp;bbcode=$bbcode_id&quot; : ''),
 
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODES'] ?&gt;&lt;/h1&gt;
+			'L_BBCODE_USAGE_EXPLAIN'=&gt; sprintf($_CLASS['core_user']-&gt;lang['BBCODE_USAGE_EXPLAIN'], '&lt;a href=&quot;#down&quot;&gt;', '&lt;/a&gt;'),
+			'BBCODE_MATCH'			=&gt; $bbcode_match,
+			'BBCODE_TPL'			=&gt; $bbcode_tpl,
+			'BBCODE_HELPLINE'		=&gt; $bbcode_helpline,
+			'DISPLAY_ON_POSTING'	=&gt; $display_on_posting)
+		);
 
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODES_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_bbcodes&amp;mode=' . (($mode == 'add') ? 'create' : 'modify') . (($bbcode_id) ? &quot;&amp;bbcode=$bbcode_id&quot; : ''), array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;90%&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_USAGE'] ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_USAGE_EXPLAIN'] ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr valign=&quot;top&quot;&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXAMPLES'] ?&gt;&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_USAGE_EXAMPLE'] ?&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;textarea name=&quot;bbcode_match&quot; cols=&quot;60&quot; rows=&quot;5&quot;&gt;&lt;?php echo $bbcode_match ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;90%&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['HTML_REPLACEMENT'] ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['HTML_REPLACEMENT_EXPLAIN'] ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr valign=&quot;top&quot;&gt;
-				&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXAMPLES'] ?&gt;&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['HTML_REPLACEMENT_EXAMPLE'] ?&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;textarea name=&quot;bbcode_tpl&quot; cols=&quot;60&quot; rows=&quot;8&quot;&gt;&lt;?php echo $bbcode_tpl ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT'] ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;90%&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOKENS'] ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOKENS_EXPLAIN'] ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOKEN'] ?&gt;&lt;/th&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOKEN_DEFINITION'] ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-&lt;?php
-
 		foreach ($_CLASS['core_user']-&gt;lang['tokens'] as $token =&gt; $token_explain)
 		{
-			?&gt;&lt;tr valign=&quot;top&quot;&gt;
-				&lt;td class=&quot;row1&quot;&gt;{&lt;?php echo $token ?&gt;}&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $token_explain ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;&lt;?php
+			$_CLASS['core_template']-&gt;assign_vars_array('token', array(
+				'TOKEN'		=&gt; '{' . $token . '}',
+				'EXPLAIN'	=&gt; $token_explain)
+			);
 		}
 
-?&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-&lt;/form&gt;
+		return;
 
-&lt;?php
-
-		adm_page_footer();
 	break;
 
 	case 'modify':
 	case 'create':
-		adm_page_header($_CLASS['core_user']-&gt;lang['BBCODES']);
 
 		$data = build_regexp($bbcode_match, $bbcode_tpl);
 
+		// Make sure the user didn't pick a &quot;bad&quot; name for the BBCode tag.
+		$hard_coded = array('code', 'quote', 'quote=', 'attachment', 'attachment=', 'b', 'i', 'url', 'url=', 'img', 'size', 'size=', 'color', 'color=', 'u', 'list', 'list=', 'email', 'email=', 'flash', 'flash=');
+
+		if (($action == 'modify' &amp;&amp; $data['bbcode_tag'] !== $row['bbcode_tag']) || ($action == 'create'))
+		{
+			$sql = 'SELECT 1 as test
+				FROM ' . FORUMS_BBCODES_TABLE . &quot;
+				WHERE LOWER(bbcode_tag) = '&quot; . $db-&gt;sql_escape(strtolower($data['bbcode_tag'])) . &quot;'&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$info = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($info['test'] === '1' || in_array(strtolower($data['bbcode_tag']), $hard_coded))
+			{
+				trigger_error('BBCODE_INVALID_TAG_NAME', E_USER_WARNING);
+			}
+		}
+
 		$sql_ary = array(
-			'bbcode_tag'					=&gt;	$data['bbcode_tag'],
-			'bbcode_match'				=&gt;	$bbcode_match,
-			'bbcode_tpl'					=&gt;	$bbcode_tpl,
-			'first_pass_match'			=&gt;	$data['first_pass_match'],
-			'first_pass_replace'		=&gt;	$data['first_pass_replace'],
-			'second_pass_match'	=&gt;	$data['second_pass_match'],
-			'second_pass_replace'	=&gt;	$data['second_pass_replace']
+			'bbcode_tag'				=&gt; $data['bbcode_tag'],
+			'bbcode_match'				=&gt; $bbcode_match,
+			'bbcode_tpl'				=&gt; $bbcode_tpl,
+			'display_on_posting'		=&gt; $display_on_posting,
+			'bbcode_helpline'			=&gt; $bbcode_helpline,
+			'first_pass_match'			=&gt; $data['first_pass_match'],
+			'first_pass_replace'		=&gt; $data['first_pass_replace'],
+			'second_pass_match'			=&gt; $data['second_pass_match'],
+			'second_pass_replace'		=&gt; $data['second_pass_replace']
 		);
 
-		if ($mode == 'create')
+		if ($action == 'create')
 		{
-			/* TODO: look for SQL incompatibilities
-			// NOTE: I'm sure there was another simpler (and obvious) way of finding a suitable bbcode_id
-			$sql = 'SELECT b1.bbcode_id
-				FROM ' . BBCODES_TABLE . ' b1, ' . BBCODES_TABLE . ' b2
-				WHERE b2.bbcode_id &gt; b1.bbcode_id
-				GROUP BY b1.bbcode_id
-				HAVING MIN(b2.bbcode_id) &gt; b1.bbcode_id + 1
-				ORDER BY b1.bbcode_id ASC';
-			$result = $_CLASS['core_db']-&gt;sql_query_limit($sql, 1);
-			$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-			*/
-			
-			$sql = 'SELECT MAX(bbcode_id) as bbcode_id
-				FROM ' . BBCODES_TABLE;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-			$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-			
+			$sql = 'SELECT MAX(bbcode_id) as max_bbcode_id
+				FROM ' . FORUMS_BBCODES_TABLE;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
 			if ($row)
 			{
-				 $bbcode_id = $row['bbcode_id'] + 1;
-			}
-			else
-			{
-				$sql = 'SELECT MIN(bbcode_id) AS min_id, MAX(bbcode_id) AS max_id
-					FROM ' . BBCODES_TABLE;
-				$result = $_CLASS['core_db']-&gt;sql_query($sql);
-				$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-				$_CLASS['core_db']-&gt;sql_freeresult($result);
+				$bbcode_id = $row['max_bbcode_id'] + 1;
 
-				if (empty($row['min_id']) || $row['min_id'] &gt;= NUM_CORE_BBCODES)
+				// Make sure it is greater than the core bbcode ids...
+				if ($bbcode_id &lt;= NUM_CORE_BBCODES)
 				{
 					$bbcode_id = NUM_CORE_BBCODES + 1;
 				}
-				else
-				{
-					$bbcode_id = $row['max_id'] + 1;
-				}
 			}
+			else
+			{
+				$bbcode_id = NUM_CORE_BBCODES + 1;
+			}
 
-			if ($bbcode_id &gt; 31)
+			if ($bbcode_id &gt; 1511)
 			{
-				trigger_error('TOO_MANY_BBCODES');
+				trigger_error('TOO_MANY_BBCODES', E_USER_WARNING);
 			}
 
 			$sql_ary['bbcode_id'] = (int) $bbcode_id;
 
-			$_CLASS['core_db']-&gt;sql_query('INSERT INTO ' . BBCODES_TABLE . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
+			$_CLASS['core_db']-&gt;query('INSERT INTO ' . BBCODES_TABLE . $db-&gt;sql_build_array('INSERT', $sql_ary));
+
 			$lang = 'BBCODE_ADDED';
 			$log_action = 'LOG_BBCODE_ADD';
 		}
 		else
 		{
-			$_CLASS['core_db']-&gt;sql_query('UPDATE ' . BBCODES_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' WHERE bbcode_id = ' . $bbcode_id);
+			$sql = 'UPDATE ' . FORUMS_BBCODES_TABLE . '
+				SET ' . $db-&gt;sql_build_array('UPDATE', $sql_ary) . '
+				WHERE bbcode_id = ' . $bbcode_id;
+			$_CLASS['core_db']-&gt;query($sql);
+
 			$lang = 'BBCODE_EDITED';
 			$log_action = 'LOG_BBCODE_EDIT';
 		}
 
 		add_log('admin', $log_action, $data['bbcode_tag']);
 
-		trigger_error($lang);
+		trigger_error($_CLASS['core_user']-&gt;lang[$lang] . adm_back_link($u_action));
+
 	break;
 
 	case 'delete':
+
 		$sql = 'SELECT bbcode_tag
-			FROM ' . BBCODES_TABLE . &quot;
+			FROM ' . FORUMS_BBCODES_TABLE . &quot;
 			WHERE bbcode_id = $bbcode_id&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-		$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-		
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
 		if ($row)
 		{
-			$_CLASS['core_db']-&gt;sql_query('DELETE FROM ' . BBCODES_TABLE . &quot; WHERE bbcode_id = $bbcode_id&quot;);
+			$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_BBCODES_TABLE . &quot; WHERE bbcode_id = $bbcode_id&quot;);
 			add_log('admin', 'LOG_BBCODE_DELETE', $row['bbcode_tag']);
 		}
-		
 
-		// No break here
+	break;
+}
 
-	default:
+$_CLASS['core_template']-&gt;assign_array(array(
+	'U_ACTION'		=&gt; $u_action . '&amp;action=add')
+);
 
-		adm_page_header($_CLASS['core_user']-&gt;lang['BBCODES']);
+$sql = 'SELECT *
+	FROM ' . FORUMS_BBCODES_TABLE . '
+	ORDER BY bbcode_id';
+$result = $_CLASS['core_db']-&gt;query($sql);
 
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODES'] ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODES_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_bbcodes&amp;mode=add', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['BBCODE_TAG'] ?&gt;&lt;/th&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION'] ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;&lt;?php
-
-		$sql = 'SELECT *
-			FROM ' . BBCODES_TABLE . '
-			ORDER BY bbcode_id';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		$row_class = '';
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['bbcode_tag'] ?&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class ?&gt;&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link('forums&amp;file=admin_bbcodes&amp;mode=edit&amp;bbcode='.$row['bbcode_id'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT'] ?&gt;&lt;/a&gt; | &lt;a href=&quot;&lt;?php echo generate_link('forums&amp;file=admin_bbcodes&amp;mode=delete&amp;bbcode='.$row['bbcode_id'], array('admin' =&gt; true)) ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE'] ?&gt;&lt;/a&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-?&gt;
-
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_BBCODE'] ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-	adm_page_footer();
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign_vars_array('bbcodes', array(
+		'BBCODE_TAG'		=&gt; $row['bbcode_tag'],
+		'U_EDIT'			=&gt; generate_link($u_action . '&amp;action=edit&amp;bbcode=' . $row['bbcode_id'], array('admin' =&gt; true)),
+		'U_DELETE'			=&gt; generate_link($u_action . '&amp;action=delete&amp;bbcode=' . $row['bbcode_id'], array('admin' =&gt; true))
+	));
 }
+$_CLASS['core_db']-&gt;free_result($result);
 
-// -----------------------------
-// Functions
-function build_regexp($msg_bbcode, $msg_html)
+
+/*
+* Build regular expression for custom bbcode
+*/
+function build_regexp(&amp;$bbcode_match, &amp;$bbcode_tpl)
 {
-	$msg_bbcode = trim($msg_bbcode);
-	$msg_html = trim($msg_html);
+	$bbcode_match = trim($bbcode_match);
+	$bbcode_tpl = trim($bbcode_tpl);
 
-	$fp_match = preg_quote($msg_bbcode, '!');
-	$fp_replace = preg_replace('#^\[(.*?)\]#', '[$1:$uid]', $msg_bbcode);
+	$fp_match = preg_quote($bbcode_match, '!');
+	$fp_replace = preg_replace('#^\[(.*?)\]#', '[$1:$uid]', $bbcode_match);
 	$fp_replace = preg_replace('#\[/(.*?)\]$#', '[/$1:$uid]', $fp_replace);
 
-	$sp_match = preg_quote($msg_bbcode, '!');
+	$sp_match = preg_quote($bbcode_match, '!');
 	$sp_match = preg_replace('#^\\\\\[(.*?)\\\\\]#', '\[$1:$uid\]', $sp_match);
 	$sp_match = preg_replace('#\\\\\[/(.*?)\\\\\]$#', '\[/$1:$uid\]', $sp_match);
-	$sp_replace = $msg_html;
+	$sp_replace = $bbcode_tpl;
 
+	// @todo Make sure to change this too if something changed in message parsing
 	$tokens = array(
 		'URL'	 =&gt; array(
-			'!([a-z0-9]+://)?([^?].*?[^ \t\n\r&lt;&quot;]*)!ie'		=&gt;	&quot;(('\$1') ? '\$1\$2' : '<A HREF="http://\$2">http://\$2</A>')&quot;
+			'!([a-z0-9]+://)?([^?].*?[^ \t\n\r&lt;&quot;]*)!ie'	=&gt;	&quot;(('\$1') ? '\$1\$2' : '<A HREF="http://\$2">http://\$2</A>')&quot;
 		),
 		'LOCAL_URL'	 =&gt; array(
 			'!([^:]+/[^ \t\n\r&lt;&quot;]*)!'	=&gt;	'$1'
@@ -331,32 +270,32 @@
 			'!([a-z0-9]+[a-z0-9\-\._]*@(?:(?:[0-9]{1,3}\.){3,5}[0-9]{1,3}|[a-z0-9]+[a-z0-9\-\._]*\.[a-z]+))!i'	=&gt;	'$1'
 		),
 		'TEXT' =&gt; array(
-			'!(.*?)!es'	 =&gt;	&quot;str_replace('\\\&quot;', '&quot;', str_replace('\\'', '&#39;', '\$1'))&quot;
+			'!(.*?)!es'	 =&gt;	&quot;str_replace(\&quot;\\r\\n\&quot;,\&quot;\\n\&quot;, str_replace('\\\&quot;', '\&quot;', str_replace('\\'', '&#39;', trim('\$1'))))&quot;
 		),
 		'COLOR' =&gt; array(
-			'!([a-z]+|#[0-9abcdef]+!i'	=&gt;	'$1'
+			'!([a-z]+|#[0-9abcdef]+)!i'	=&gt;	'$1'
 		),
 		'NUMBER' =&gt; array(
 			'!([0-9]+)!'	=&gt;	'$1'
 		)
 	);
 
-	if (preg_match_all('/\{(' . implode('|', array_keys($tokens)) . ')[0-9]*\}/i', $msg_bbcode, $m))
-	{
-		$pad = 0;
-		$modifiers = 'i';
+	$pad = 0;
+	$modifiers = 'i';
 
+	if (preg_match_all('/\{(' . implode('|', array_keys($tokens)) . ')[0-9]*\}/i', $bbcode_match, $m))
+	{
 		foreach ($m[0] as $n =&gt; $token)
 		{
 			$token_type = $m[1][$n];
 
-			reset($tokens[$token_type]);
-			list($match, $replace) = each($tokens[$token_type]);
+			reset($tokens[strtoupper($token_type)]);
+			list($match, $replace) = each($tokens[strtoupper($token_type)]);
 
 			// Pad backreference numbers from tokens
 			if (preg_match_all('/(?&lt;!\\\\)\$([0-9]+)/', $replace, $repad))
 			{
-				$repad = $pad + count(array_unique($repad[0]));
+				$repad = $pad + sizeof(array_unique($repad[0]));
 				$replace = preg_replace('/(?&lt;!\\\\)\$([0-9]+)/e', &quot;'\$' . (\$1 + \$pad)&quot;, $replace);
 				$pad = $repad;
 			}
@@ -365,9 +304,9 @@
 			$regex = preg_replace('/!(.*)!([a-z]*)/', '$1', $match);
 			$regex_modifiers = preg_replace('/!(.*)!([a-z]*)/', '$2', $match);
 
-			for ($i = 0; $i &lt; strlen($regex_modifiers); ++$i)
+			for ($i = 0, $size = strlen($regex_modifiers); $i &lt; $size; ++$i)
 			{
-				if (strpos($modifiers, $regex_modifiers[$i]) === FALSE)
+				if (strpos($modifiers, $regex_modifiers[$i]) === false)
 				{
 					$modifiers .= $regex_modifiers[$i];
 
@@ -393,7 +332,7 @@
 		$fp_match = '!' . $fp_match . '!' . $modifiers;
 		$sp_match = '!' . $sp_match . '!s';
 
-		if (strpos($fp_match, 'e') !== FALSE)
+		if (strpos($fp_match, 'e') !== false)
 		{
 			$fp_replace = str_replace(&quot;'.'&quot;, '', $fp_replace);
 			$fp_replace = str_replace(&quot;.''.&quot;, '.', $fp_replace);
@@ -409,20 +348,19 @@
 	}
 
 	// Lowercase tags
-	$bbcode_tag = preg_replace('/.*?\[([a-z]+).*/i', '$1', $msg_bbcode);
+	$bbcode_tag = preg_replace('/.*?\[([a-z0-9_-]+=?).*/i', '$1', $bbcode_match);
 	$fp_match = preg_replace('#\[/?' . $bbcode_tag . '#ie', &quot;strtolower('\$0')&quot;, $fp_match);
 	$fp_replace = preg_replace('#\[/?' . $bbcode_tag . '#ie', &quot;strtolower('\$0')&quot;, $fp_replace);
 	$sp_match = preg_replace('#\[/?' . $bbcode_tag . '#ie', &quot;strtolower('\$0')&quot;, $sp_match);
 	$sp_replace = preg_replace('#\[/?' . $bbcode_tag . '#ie', &quot;strtolower('\$0')&quot;, $sp_replace);
 
 	return array(
-		'bbcode_tag'					=&gt;	$bbcode_tag,
-		'first_pass_match'			=&gt;	$fp_match,
-		'first_pass_replace'		=&gt;	$fp_replace,
-		'second_pass_match'	=&gt;	$sp_match,
-		'second_pass_replace'	=&gt;	$sp_replace
+		'bbcode_tag'				=&gt; $bbcode_tag,
+		'first_pass_match'			=&gt; $fp_match,
+		'first_pass_replace'		=&gt; $fp_replace,
+		'second_pass_match'			=&gt; $sp_match,
+		'second_pass_replace'		=&gt; $sp_replace
 	);
 }
-// End Functions
-// -----------------------------
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_board.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_board.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_board.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -15,179 +15,123 @@
 	die; 
 }
 
-// Get mode
-$mode	= request_var('mode', '');
+$_CLASS['core_user']-&gt;add_lang('admin_board', 'forums');
+
 $action	= request_var('action', '');
-$submit = isset($_POST['submit']);
+$mode	= request_var('mode', '');
+$submit = (isset($_POST['submit'])) ? true : false;
+$u_action = 'forums&amp;file=admin_board&amp;mode='.$mode;
 
-// Set config vars
-$display_vars = array(
-	'avatar' =&gt; array(
-		'auth'	=&gt; 'a_board',
-		'title'	=&gt; 'AVATAR_SETTINGS',
-		'vars'	=&gt; array(
-			'avatar_min_height' =&gt; false, 'avatar_min_width' =&gt; false, 'avatar_max_height' =&gt; false, 'avatar_max_width' =&gt; false,
-			'allow_avatar_local'	=&gt; array('lang' =&gt; 'ALLOW_LOCAL',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_avatar_remote'	=&gt; array('lang' =&gt; 'ALLOW_REMOTE',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'allow_avatar_upload'	=&gt; array('lang' =&gt; 'ALLOW_UPLOAD',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'avatar_filesize'		=&gt; array('lang' =&gt; 'MAX_FILESIZE',	'type' =&gt; 'text:4:10', 'explain' =&gt; true, 'append' =&gt; ' ' . $_CLASS['core_user']-&gt;lang['BYTES']),
-			'avatar_min'			=&gt; array('lang' =&gt; 'MIN_AVATAR_SIZE',	'type' =&gt; 'dimension:3:4', 'explain' =&gt; true),
-			'avatar_max'			=&gt; array('lang' =&gt; 'MAX_AVATAR_SIZE',	'type' =&gt; 'dimension:3:4', 'explain' =&gt; true),
-			'avatar_path'			=&gt; array('lang' =&gt; 'AVATAR_STORAGE_PATH',	'type' =&gt; 'text:20:255', 'explain' =&gt; true),
-			'avatar_gallery_path'	=&gt; array('lang' =&gt; 'AVATAR_GALLERY_PATH',	'type' =&gt; 'text:20:255', 'explain' =&gt; true)
-		)
-	),
-	'email'	=&gt; array(
-		'auth'	=&gt; 'a_server',
-		'title'	=&gt; 'EMAIL_SETTINGS',
-		'vars'	=&gt; array(
-			'email_enable'			=&gt; array('lang' =&gt; 'ENABLE_EMAIL',			'type' =&gt; 'radio:enabled_disabled', 'explain' =&gt; true),
-			'board_email_form'		=&gt; array('lang' =&gt; 'BOARD_EMAIL_FORM',		'type' =&gt; 'radio:enabled_disabled', 'explain' =&gt; true),
-			'email_function_name'	=&gt; array('lang' =&gt; 'EMAIL_FUNCTION_NAME',	'type' =&gt; 'text:20:50', 'explain' =&gt; true),
-			'email_package_size'	=&gt; array('lang' =&gt; 'EMAIL_PACKAGE_SIZE',	'type' =&gt; 'text:5:5', 'explain' =&gt; true),
-			'board_contact'			=&gt; array('lang' =&gt; 'CONTACT_EMAIL',			'type' =&gt; 'text:25:100', 'explain' =&gt; true),
-			'board_email'			=&gt; array('lang' =&gt; 'ADMIN_EMAIL',			'type' =&gt; 'text:25:100', 'explain' =&gt; true),
-			'board_email_sig'		=&gt; array('lang' =&gt; 'EMAIL_SIG',				'type' =&gt; 'textarea:5:30', 'explain' =&gt; true),
-			'smtp_delivery'			=&gt; array('lang' =&gt; 'USE_SMTP',				'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'smtp_host'				=&gt; array('lang' =&gt; 'SMTP_SERVER',			'type' =&gt; 'text:25:50', 'explain' =&gt; false),
-			'smtp_port'				=&gt; array('lang' =&gt; 'SMTP_PORT',				'type' =&gt; 'text:4:5', 'explain' =&gt; true),
-			'smtp_auth_method'		=&gt; array('lang' =&gt; 'SMTP_AUTH_METHOD',		'type' =&gt; 'select', 'options' =&gt; 'mail_auth_select(\'{VALUE}\')', 'explain' =&gt; true),
-			'smtp_username'			=&gt; array('lang' =&gt; 'SMTP_USERNAME',			'type' =&gt; 'text:25:255', 'explain' =&gt; true),
-			'smtp_password'			=&gt; array('lang' =&gt; 'SMTP_PASSWORD',			'type' =&gt; 'password:25:255', 'explain' =&gt; true)
-		)
-	),
-	'load'	=&gt; array(
-		'auth'	=&gt; 'a_server',
-		'title'	=&gt; 'SERVER_SETTINGS',
-		'vars'	=&gt; array(
-			'load_db_track'		=&gt; array('lang' =&gt; 'YES_POST_MARKING',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'load_db_lastread'	=&gt; array('lang' =&gt; 'YES_READ_MARKING',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'load_online'		=&gt; array('lang' =&gt; 'YES_ONLINE',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'load_onlinetrack'	=&gt; array('lang' =&gt; 'YES_ONLINE_TRACK',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'load_online_time'	=&gt; array('lang' =&gt; 'ONLINE_LENGTH',		'type' =&gt; 'text:4:3', 'explain' =&gt; true),
-			'load_birthdays'	=&gt; array('lang' =&gt; 'YES_BIRTHDAYS',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'load_moderators'	=&gt; array('lang' =&gt; 'YES_MODERATORS',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'load_jumpbox'		=&gt; array('lang' =&gt; 'YES_JUMPBOX',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'load_search'		=&gt; array('lang' =&gt; 'YES_SEARCH',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'search_interval'	=&gt; array('lang' =&gt; 'SEARCH_INTERVAL',	'type' =&gt; 'text:3:4', 'explain' =&gt; true),
-			'min_search_chars'	=&gt; array('lang' =&gt; 'MIN_SEARCH_CHARS',	'type' =&gt; 'text:3:3', 'explain' =&gt; true),
-			'max_search_chars'	=&gt; array('lang' =&gt; 'MAX_SEARCH_CHARS',	'type' =&gt; 'text:3:3', 'explain' =&gt; true),
-			'load_search_upd'	=&gt; array('lang' =&gt; 'YES_SEARCH_UPDATE',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-//			'load_search_phr'	=&gt; array('lang' =&gt; 'YES_SEARCH_PHRASE',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-		)
-	),
-	'default' =&gt; array(
-		'auth'	=&gt; 'a_defaults',
-		'title'	=&gt; 'BOARD_DEFAULTS',
-		'vars'	=&gt; array(
-			'allow_privmsg'			=&gt; array('lang' =&gt; 'BOARD_PM',				'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'allow_topic_notify'	=&gt; array('lang' =&gt; 'ALLOW_TOPIC_NOTIFY',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_forum_notify'	=&gt; array('lang' =&gt; 'ALLOW_FORUM_NOTIFY',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_attachments'		=&gt; array('lang' =&gt; 'ALLOW_ATTACHMENTS',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_html'			=&gt; array('lang' =&gt; 'ALLOW_HTML',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_html_tags'		=&gt; array('lang' =&gt; 'ALLOWED_TAGS',			'type' =&gt; 'text:30:255', 'explain' =&gt; true),
-			'allow_bbcode'			=&gt; array('lang' =&gt; 'ALLOW_BBCODE',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_smilies'			=&gt; array('lang' =&gt; 'ALLOW_SMILIES',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_sig'				=&gt; array('lang' =&gt; 'ALLOW_SIG',				'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'max_sig_chars'			=&gt; array('lang' =&gt; 'MAX_SIG_LENGTH',		'type' =&gt; 'text:5:4', 'explain' =&gt; true),
-			'allow_nocensors'		=&gt; array('lang' =&gt; 'ALLOW_NO_CENSORS',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'allow_bookmarks'		=&gt; array('lang' =&gt; 'ALLOW_BOOKMARKS',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; true)
-		)
-	),
-	'message' =&gt; array(
-		'auth'	=&gt; 'a_defaults',
-		'title'	=&gt; 'MESSAGE_SETTINGS',
-		'lang'	=&gt; 'ucp',
-		'vars'	=&gt; array(
-			'pm_max_boxes'			=&gt; array('lang' =&gt; 'BOXES_MAX',				'type' =&gt; 'text:4:4', 'explain' =&gt; true),
-			'pm_max_msgs'			=&gt; array('lang' =&gt; 'BOXES_LIMIT',			'type' =&gt; 'text:4:4', 'explain' =&gt; true),
-			'full_folder_action'	=&gt; array('lang' =&gt; 'FULL_FOLDER_ACTION',	'type' =&gt; 'select', 'options' =&gt; 'full_folder_select(\'{VALUE}\')', 'explain' =&gt; true),
-			'pm_edit_time'			=&gt; array('lang' =&gt; 'PM_EDIT_TIME',			'type' =&gt; 'text:3:3', 'explain' =&gt; true),
-			'allow_mass_pm'			=&gt; array('lang' =&gt; 'ALLOW_MASS_PM',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_html_pm'			=&gt; array('lang' =&gt; 'ALLOW_HTML_PM',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_bbcode_pm'		=&gt; array('lang' =&gt; 'ALLOW_BBCODE_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_smilies_pm'		=&gt; array('lang' =&gt; 'ALLOW_SMILIES_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_pm_attach'		=&gt; array('lang' =&gt; 'ALLOW_PM_ATTACHMENTS',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_download_pm'		=&gt; array('lang' =&gt; 'ALLOW_DOWNLOAD_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'allow_sig_pm'			=&gt; array('lang' =&gt; 'ALLOW_SIG_PM',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_report_pm'		=&gt; array('lang' =&gt; 'ALLOW_REPORT_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_quote_pm'			=&gt; array('lang' =&gt; 'ALLOW_QUOTE_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'print_pm'				=&gt; array('lang' =&gt; 'ALLOW_PRINT_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'email_pm'				=&gt; array('lang' =&gt; 'ALLOW_EMAIL_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'forward_pm'			=&gt; array('lang' =&gt; 'ALLOW_FORWARD_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_img_pm'			=&gt; array('lang' =&gt; 'ALLOW_IMG_PM',			'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'auth_flash_pm'			=&gt; array('lang' =&gt; 'ALLOW_FLASH_PM',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
-			'enable_pm_icons'		=&gt; array('lang' =&gt; 'ENABLE_PM_ICONS',		'type' =&gt; 'radio:yes_no', 'explain' =&gt; false)
-		)
-	),
-	'server' =&gt; array(
-		'auth'	=&gt; 'a_server',
-		'title'	=&gt; 'SERVER_SETTINGS',
-		'vars'	=&gt; array(
-			'smilies_path'		=&gt; array('lang' =&gt; 'SMILIES_PATH',	'type' =&gt; 'text:20:255', 'explain' =&gt; true),
-			'icons_path'		=&gt; array('lang' =&gt; 'ICONS_PATH',	'type' =&gt; 'text:20:255', 'explain' =&gt; true),
-			'upload_icons_path'	=&gt; array('lang' =&gt; 'UPLOAD_ICONS_PATH', 'type' =&gt; 'text:20:255', 'explain' =&gt; true),
-			'ranks_path'		=&gt; array('lang' =&gt; 'RANKS_PATH',	'type' =&gt; 'text:20:255', 'explain' =&gt; true)
-		)
-	),
-	'setting' =&gt; array(
-		'auth'	=&gt; 'a_board',
-		'title'	=&gt; 'BOARD_SETTINGS',
-		'vars'	=&gt; array(
-			'board_disable_msg'	=&gt; false, 'max_name_chars' =&gt; false, 'max_pass_chars' =&gt; false, 'bump_type' =&gt; false,
-			'edit_time'			=&gt; array('lang' =&gt; 'EDIT_TIME',			'type' =&gt; 'text:3:3', 'explain' =&gt; true),
-			'display_last_edited' =&gt; array('lang' =&gt; 'DISPLAY_LAST_EDITED', 'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
-			'flood_interval'	=&gt; array('lang' =&gt; 'FLOOD_INTERVAL',	'type' =&gt; 'text:3:4', 'explain' =&gt; true),
-			'bump_interval'		=&gt; array('lang' =&gt; 'BUMP_INTERVAL',		'type' =&gt; 'custom', 'options' =&gt; 'bump_interval(\'{VALUE}\')', 'explain' =&gt; true),
-			'topics_per_page'	=&gt; array('lang' =&gt; 'TOPICS_PER_PAGE',	'type' =&gt; 'text:3:4', 'explain' =&gt; false),
-			'posts_per_page'	=&gt; array('lang' =&gt; 'POSTS_PER_PAGE',	'type' =&gt; 'text:3:4', 'explain' =&gt; false),
-			'hot_threshold'		=&gt; array('lang' =&gt; 'HOT_THRESHOLD',		'type' =&gt; 'text:3:4', 'explain' =&gt; false),
-			'max_poll_options'	=&gt; array('lang' =&gt; 'MAX_POLL_OPTIONS',	'type' =&gt; 'text:4:4', 'explain' =&gt; false),
-			'max_post_chars'	=&gt; array('lang' =&gt; 'CHAR_LIMIT',		'type' =&gt; 'text:4:6', 'explain' =&gt; true),
-			'max_post_smilies'	=&gt; array('lang' =&gt; 'SMILIES_LIMIT',		'type' =&gt; 'text:4:4', 'explain' =&gt; true),
-			'max_quote_depth'	=&gt; array('lang' =&gt; 'QUOTE_DEPTH_LIMIT',	'type' =&gt; 'text:4:4', 'explain' =&gt; true)
-		)
-	)
-);
+$new_config = array();
 
-if (!in_array($mode, array_keys($display_vars)))
+// Validation types are: string, int, bool, rpath, path
+switch ($mode)
 {
-	return;
-}
+	case 'features':
+		$display_vars = array(
+			'title'	=&gt; 'ACP_BOARD_FEATURES',
+			'vars'	=&gt; array(
+				'legend1'				=&gt; 'ACP_BOARD_FEATURES',
+				'allow_topic_notify'	=&gt; array('lang' =&gt; 'ALLOW_TOPIC_NOTIFY',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_forum_notify'	=&gt; array('lang' =&gt; 'ALLOW_FORUM_NOTIFY',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_attachments'		=&gt; array('lang' =&gt; 'ALLOW_ATTACHMENTS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_pm_attach'		=&gt; array('lang' =&gt; 'ALLOW_PM_ATTACHMENTS',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_bbcode'			=&gt; array('lang' =&gt; 'ALLOW_BBCODE',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_smilies'			=&gt; array('lang' =&gt; 'ALLOW_SMILIES',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_sig'				=&gt; array('lang' =&gt; 'ALLOW_SIG',				'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_nocensors'		=&gt; array('lang' =&gt; 'ALLOW_NO_CENSORS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'allow_bookmarks'		=&gt; array('lang' =&gt; 'ALLOW_BOOKMARKS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
 
-// Perform the current mode
-$display_vars = $display_vars[$mode];
+				'legend2'				=&gt; 'ACP_LOAD_SETTINGS',
+				'load_birthdays'		=&gt; array('lang' =&gt; 'YES_BIRTHDAYS',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'load_moderators'		=&gt; array('lang' =&gt; 'YES_MODERATORS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'load_jumpbox'			=&gt; array('lang' =&gt; 'YES_JUMPBOX',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+			)
+		);
+	break;
 
-// Check permissions
-if (!$_CLASS['auth']-&gt;acl_get($display_vars['auth']))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+	case 'post':
+		$display_vars = array(
+			'title'	=&gt; 'ACP_POST_SETTINGS',
+			'vars'	=&gt; array(
+				'legend1'				=&gt; 'GENERAL_OPTIONS',
+				'allow_topic_notify'	=&gt; array('lang' =&gt; 'ALLOW_TOPIC_NOTIFY',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_forum_notify'	=&gt; array('lang' =&gt; 'ALLOW_FORUM_NOTIFY',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_bbcode'			=&gt; array('lang' =&gt; 'ALLOW_BBCODE',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_smilies'			=&gt; array('lang' =&gt; 'ALLOW_SMILIES',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'allow_post_links'		=&gt; array('lang' =&gt; 'ALLOW_POST_LINKS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'allow_nocensors'		=&gt; array('lang' =&gt; 'ALLOW_NO_CENSORS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'allow_bookmarks'		=&gt; array('lang' =&gt; 'ALLOW_BOOKMARKS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'enable_post_confirm'	=&gt; array('lang' =&gt; 'VISUAL_CONFIRM_POST',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+
+				'legend2'				=&gt; 'POSTING',
+				'bump_type'				=&gt; false,
+				'edit_time'				=&gt; array('lang' =&gt; 'EDIT_TIME',				'validate' =&gt; 'int',	'type' =&gt; 'text:3:3', 'explain' =&gt; true, 'append' =&gt; ' ' . $_CLASS['core_user']-&gt;lang['MINUTES']),
+				'display_last_edited'	=&gt; array('lang' =&gt; 'DISPLAY_LAST_EDITED',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'flood_interval'		=&gt; array('lang' =&gt; 'FLOOD_INTERVAL',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; true),
+				'bump_interval'			=&gt; array('lang' =&gt; 'BUMP_INTERVAL',			'validate' =&gt; 'int',	'type' =&gt; 'custom', 'method' =&gt; 'bump_interval', 'explain' =&gt; true),
+				'topics_per_page'		=&gt; array('lang' =&gt; 'TOPICS_PER_PAGE',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; false),
+				'posts_per_page'		=&gt; array('lang' =&gt; 'POSTS_PER_PAGE',		'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; false),
+				'hot_threshold'			=&gt; array('lang' =&gt; 'HOT_THRESHOLD',			'validate' =&gt; 'int',	'type' =&gt; 'text:3:4', 'explain' =&gt; false),
+				'max_poll_options'		=&gt; array('lang' =&gt; 'MAX_POLL_OPTIONS',		'validate' =&gt; 'int',	'type' =&gt; 'text:4:4', 'explain' =&gt; false),
+				'max_post_chars'		=&gt; array('lang' =&gt; 'CHAR_LIMIT',			'validate' =&gt; 'int',	'type' =&gt; 'text:4:6', 'explain' =&gt; true),
+				'max_post_smilies'		=&gt; array('lang' =&gt; 'SMILIES_LIMIT',			'validate' =&gt; 'int',	'type' =&gt; 'text:4:4', 'explain' =&gt; true),
+				'max_post_urls'			=&gt; array('lang' =&gt; 'MAX_POST_URLS',			'validate' =&gt; 'int',	'type' =&gt; 'text:5:4', 'explain' =&gt; true),
+				'max_post_font_size'	=&gt; array('lang' =&gt; 'MAX_POST_FONT_SIZE',	'validate' =&gt; 'int',	'type' =&gt; 'text:5:4', 'explain' =&gt; true),
+				'max_quote_depth'		=&gt; array('lang' =&gt; 'QUOTE_DEPTH_LIMIT',		'validate' =&gt; 'int',	'type' =&gt; 'text:4:4', 'explain' =&gt; true),
+				'max_post_img_width'	=&gt; array('lang' =&gt; 'MAX_POST_IMG_WIDTH',	'validate' =&gt; 'int',	'type' =&gt; 'text:5:4', 'explain' =&gt; true),
+				'max_post_img_height'	=&gt; array('lang' =&gt; 'MAX_POST_IMG_HEIGHT',	'validate' =&gt; 'int',	'type' =&gt; 'text:5:4', 'explain' =&gt; true),
+			)
+		);
+	break;
+
+	case 'load':
+		$display_vars = array(
+			'title'	=&gt; 'ACP_LOAD_SETTINGS',
+			'vars'	=&gt; array(
+				'legend2'				=&gt; 'GENERAL_OPTIONS',
+				'load_anon_lastread'	=&gt; array('lang' =&gt; 'YES_ANON_READ_MARKING',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'load_online'			=&gt; array('lang' =&gt; 'YES_ONLINE',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'load_online_guests'	=&gt; array('lang' =&gt; 'YES_ONLINE_GUESTS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'load_onlinetrack'		=&gt; array('lang' =&gt; 'YES_ONLINE_TRACK',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				'load_birthdays'		=&gt; array('lang' =&gt; 'YES_BIRTHDAYS',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'load_moderators'		=&gt; array('lang' =&gt; 'YES_MODERATORS',		'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'load_jumpbox'			=&gt; array('lang' =&gt; 'YES_JUMPBOX',			'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; false),
+				'load_user_activity'	=&gt; array('lang' =&gt; 'LOAD_USER_ACTIVITY',	'validate' =&gt; 'bool',	'type' =&gt; 'radio:yes_no', 'explain' =&gt; true),
+				
+				'legend3'				=&gt; 'CUSTOM_PROFILE_FIELDS',
+			)
+		);
+	break;
+
+	default:
+		trigger_error('NO_MODE', E_USER_ERROR);
+	break;
 }
 
-if (isset($display_vars['lang']))
+$new_config = $config;
+$cfg_array = (isset($_REQUEST['config'])) ? request_var('config', array('' =&gt; ''), true) : $new_config;
+$error = array();
+
+// We validate the complete config if whished
+validate_config_vars($display_vars['vars'], $cfg_array, $error);
+
+// Do not write values if there is an error
+if (sizeof($error))
 {
-	$_CLASS['core_user']-&gt;add_lang($display_vars['lang'], 'forums');
+	$submit = false;
 }
 
-$new = $config;
-$cfg_array = (isset($_REQUEST['config'])) ? request_var('config', array('' =&gt; '')) : $new;
-
 // We go through the display_vars to make sure no one is trying to set variables he/she is not allowed to...
 foreach ($display_vars['vars'] as $config_name =&gt; $null)
 {
-	if (!isset($cfg_array[$config_name]))
+	if (!isset($cfg_array[$config_name]) || strpos($config_name, 'legend') !== false)
 	{
 		continue;
 	}
 
-	$config_value = $cfg_array[$config_name];
-	$new[$config_name] = $config_value;
+	$new_config[$config_name] = $config_value = $cfg_array[$config_name];
 
-	if ($config_name == 'email_function_name')
-	{
-		$new['email_function_name'] = (empty($new['email_function_name']) || !function_exists($new['email_function_name'])) ? 'mail' : str_replace(array('(', ')'), array('', ''), trim($new['email_function_name']));
-	}
-	
 	if ($submit)
 	{
 		set_config($config_name, $config_value);
@@ -196,251 +140,122 @@
 
 if ($submit)
 {
-	add_log('admin', 'LOG_' . strtoupper($mode) . '_CONFIG');
+	add_log('admin', 'LOG_CONFIG_' . strtoupper($mode));
 
-	trigger_error($_CLASS['core_user']-&gt;lang['CONFIG_UPDATED']);
+	trigger_error($_CLASS['core_user']-&gt;lang['CONFIG_UPDATED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
-adm_page_header($_CLASS['core_user']-&gt;lang[$display_vars['title']]);
+$page_title = $display_vars['title'];
 
-?&gt;
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang[$display_vars['title']],
+	'L_TITLE_EXPLAIN'	=&gt; $_CLASS['core_user']-&gt;lang[$display_vars['title'] . '_EXPLAIN'],
 
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$display_vars['title']]; ?&gt;&lt;/h1&gt;
+	'S_ERROR'			=&gt; (sizeof($error)) ? true : false,
+	'ERROR_MSG'			=&gt; implode('&lt;br /&gt;', $error),
 
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$display_vars['title'] . '_EXPLAIN']; ?&gt;&lt;/p&gt;
+	'U_ACTION'			=&gt; generate_link($u_action, array('admin' =&gt; true))
+));
 
-&lt;form action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_board&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot; method=&quot;post&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$display_vars['title']]; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
 // Output relevant page
 foreach ($display_vars['vars'] as $config_key =&gt; $vars)
 {
-	if (!is_array($vars))
+	if (!is_array($vars) &amp;&amp; strpos($config_key, 'legend') === false)
 	{
 		continue;
 	}
 
-	$type = explode(':', $vars['type']);
-
-?&gt;
-
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$vars['lang']]; ?&gt;: &lt;/b&gt;&lt;?php echo ($vars['explain']) ? '&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;' . $_CLASS['core_user']-&gt;lang[$vars['lang'] . '_EXPLAIN'] . '&lt;/span&gt;' : ''; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo build_cfg_template($type, $config_key, ((isset($vars['options'])) ? $vars['options'] : '')) . ((isset($vars['append'])) ? str_replace('{VALUE}', $new[$config_key], $vars['append']) : ''); ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-
-&lt;?php
-	
-	unset($display_vars['vars'][$config_key]);
-}
-
-if ($mode == 'auth')
-{
-	$auth_plugins = array();
-
-	$dp = opendir($site_file_root.'includes/auth');
-	while ($file = readdir($dp))
+	if (strpos($config_key, 'legend') !== false)
 	{
-		if (preg_match('#^auth_(.*?)\.php$#', $file))
-		{
-			$auth_plugins[] = preg_replace('#^auth_(.*?)\.php$#', '\1', $file);
-		}
-	}
+		$_CLASS['core_template']-&gt;assign_vars_array('options', array(
+			'S_LEGEND'		=&gt; true,
+			'LEGEND'		=&gt; (isset($_CLASS['core_user']-&gt;lang[$vars])) ? $_CLASS['core_user']-&gt;lang[$vars] : $vars
+		));
 
-	sort($auth_plugins);
-
-	foreach ($auth_plugins as $method)
-	{
-		if ($method &amp;&amp; file_exists($site_file_root.'includes/auth/auth_' . $method . '.php'))
-		{
-			include_once($site_file_root.'includes/auth/auth_' . $method . '.php');
-
-			$method = 'admin_' . $method;
-			if (function_exists($method))
-			{
-				if ($config_fields = $method($new))
-				{
-					// Check if we need to create config fields for this plugin
-					foreach($config_fields as $field)
-					{
-						if (!isset($config[$field]))
-						{
-							set_config($field, '');
-						}
-					}
-				}
-				unset($config_fields);
-			}
-		}
+		continue;
 	}
-}
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
+	$type = explode(':', $vars['type']);
 
-&lt;?php
-
-adm_page_footer();
-
-function select_auth_method($selected_method)
-{
-	global $new, $site_file_root;
-
-	$auth_plugins = array();
-
-	$dp = opendir($site_file_root.'includes/auth');
-	while ($file = readdir($dp))
+	$l_explain = '';
+	if ($vars['explain'] &amp;&amp; isset($vars['lang_explain']))
 	{
-		if (preg_match('#^auth_(.*?)\.php$#', $file))
-		{
-			$auth_plugins[] = preg_replace('#^auth_(.*?)\.php$#', '\1', $file);
-		}
+		$l_explain = (isset($_CLASS['core_user']-&gt;lang[$vars['lang_explain']])) ? $_CLASS['core_user']-&gt;lang[$vars['lang_explain']] : $vars['lang_explain'];
 	}
-
-	sort($auth_plugins);
-
-	$auth_select = '';
-	foreach ($auth_plugins as $method)
+	else if ($vars['explain'])
 	{
-		$selected = ($selected_method == $method) ? ' selected=&quot;selected&quot;' : '';
-		$auth_select .= '&lt;option value=&quot;' . $method . '&quot;' . $selected . '&gt;' . ucfirst($method) . '&lt;/option&gt;';
+		$l_explain = (isset($_CLASS['core_user']-&gt;lang[$vars['lang'] . '_EXPLAIN'])) ? $_CLASS['core_user']-&gt;lang[$vars['lang'] . '_EXPLAIN'] : '';
 	}
 
-	return $auth_select;
-}
+	$_CLASS['core_template']-&gt;assign_vars_array('options', array(
+		'S_LEGEND'		=&gt; false,
+		'KEY'			=&gt; $config_key,
+		'TITLE'			=&gt; (isset($_CLASS['core_user']-&gt;lang[$vars['lang']])) ? $_CLASS['core_user']-&gt;lang[$vars['lang']] : $vars['lang'],
+		'S_EXPLAIN'		=&gt; $vars['explain'],
+		'TITLE_EXPLAIN'	=&gt; $l_explain,
+		'CONTENT'		=&gt; build_cfg_template($type, $config_key, $new_config, $config_key, $vars),
+	));
 
-function mail_auth_select($selected_method)
-{
-	global $_CLASS;
-
-	$auth_methods = array('PLAIN', 'LOGIN', 'CRAM-MD5', 'DIGEST-MD5', 'POP-BEFORE-SMTP');
-	$s_smtp_auth_options = '';
-
-	foreach ($auth_methods as $method)
-	{
-		$s_smtp_auth_options .= '&lt;option value=&quot;' . $method . '&quot;' . (($selected_method == $method) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['SMTP_' . str_replace('-', '_', $method)] . '&lt;/option&gt;';
-	}
-
-	return $s_smtp_auth_options;
+	unset($display_vars['vars'][$config_key]);
 }
 
-function full_folder_select($value)
-{
-	global $_CLASS;
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_board.html');
 
-	return '&lt;option value=&quot;1&quot;' . (($value == 1) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['DELETE_OLDEST_MESSAGES'] . '&lt;/option&gt;&lt;option value=&quot;2&quot;' . (($value == 2) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['HOLD_NEW_MESSAGES'] . '&lt;/option&gt;';
-}
-
-function select_ip_check($value)
+/**
+* Select bump interval
+*/
+function bump_interval($value, $key)
 {
-	global $_CLASS;
+	global $_CLASS, $new_config;
 
-	$ip_all = ($value == 4) ? ' checked=&quot;checked&quot;' : '';
-	$ip_classc = ($value == 3) ? ' checked=&quot;checked&quot;' : '';
-	$ip_classb = ($value == 2) ? ' checked=&quot;checked&quot;' : '';
-	$ip_none = ($value == 0) ? ' checked=&quot;checked&quot;' : '';
-
-	$options = &lt;&lt;&lt;EOT
-	&lt;input type=&quot;radio&quot; name=&quot;config[ip_check]&quot; value=&quot;4&quot;$ip_all /&gt; {$_CLASS['core_user']-&gt;lang['ALL']}&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[ip_check]&quot; value=&quot;3&quot;$ip_classc /&gt; {$_CLASS['core_user']-&gt;lang['CLASS_C']}&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[ip_check]&quot; value=&quot;2&quot;$ip_classb /&gt; {$_CLASS['core_user']-&gt;lang['CLASS_B']}&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[ip_check]&quot; value=&quot;0&quot;$ip_none /&gt; {$_CLASS['core_user']-&gt;lang['NONE']}&nbsp;&nbsp;
-EOT;
-	
-	return $options;
-}
-
-function select_acc_activation($value)
-{
-	global $_CLASS, $config;
-
-	$activation_none	= ($value == USER_ACTIVATION_NONE) ? ' checked=&quot;checked&quot;' : '';
-	$activation_user	= ($value == USER_ACTIVATION_SELF) ? ' checked=&quot;checked&quot;' : '';
-	$activation_admin	= ($value == USER_ACTIVATION_ADMIN) ? ' checked=&quot;checked&quot;' : '';
-	$activation_disable = ($value == USER_ACTIVATION_DISABLE) ? ' checked=&quot;checked&quot;' : '';
-
-	$options = '&lt;input type=&quot;radio&quot; name=&quot;config[require_activation]&quot; value=&quot;' . USER_ACTIVATION_NONE . '&quot;' . $activation_none . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['ACC_NONE'];
-
-	if ($config['email_enable'])
+	$s_bump_type = '';
+	$types = array('m' =&gt; 'MINUTES', 'h' =&gt; 'HOURS', 'd' =&gt; 'DAYS');
+	foreach ($types as $type =&gt; $lang)
 	{
-		$options .= '&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[require_activation]&quot; value=&quot;' . USER_ACTIVATION_SELF . '&quot;' . $activation_user . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['ACC_USER'];
-		$options .= '&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[require_activation]&quot; value=&quot;' . USER_ACTIVATION_ADMIN . '&quot;' . $activation_admin . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['ACC_ADMIN'];
+		$selected = ($new_config['bump_type'] == $type) ? ' selected=&quot;selected&quot;' : '';
+		$s_bump_type .= '&lt;option value=&quot;' . $type . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
 	}
-	$options .= '&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[require_activation]&quot; value=&quot;' . USER_ACTIVATION_DISABLE . '&quot;' . $activation_disable . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['ACC_DISABLE'];
 
-	return $options;
+	return '&lt;input id=&quot;' . $key . '&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;config[bump_interval]&quot; value=&quot;' . $value . '&quot; /&gt;&nbsp;&lt;select name=&quot;config[bump_type]&quot;&gt;' . $s_bump_type . '&lt;/select&gt;';
 }
 
-function username_length($value)
+/**
+* Board disable option and message
+*/
+function board_disable($value, $key)
 {
-	global $new, $_CLASS;
-
-	return '&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;config[min_name_chars]&quot; value=&quot;' . $value . '&quot; /&gt; ' . $_CLASS['core_user']-&gt;lang['MIN_CHARS'] . '&nbsp;&nbsp;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;config[max_name_chars]&quot; value=&quot;' . $new['max_name_chars'] . '&quot; /&gt; ' . $_CLASS['core_user']-&gt;lang['MAX_CHARS'];
-}
-
-function select_username_chars($selected_value)
-{
 	global $_CLASS;
 
-	$user_char_ary = array('USERNAME_CHARS_ANY' =&gt; '.*', 'USERNAME_ALPHA_ONLY' =&gt; '[\w]+', 'USERNAME_ALPHA_SPACERS' =&gt; '[\w_\+\. \-\[\]]+');
-	$user_char_options = '';
-	foreach ($user_char_ary as $lang =&gt; $value)
-	{
-		$selected = ($selected_value == $value) ? ' selected=&quot;selected&quot;' : '';
-		$user_char_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
-	}
+	$radio_ary = array(1 =&gt; 'YES', 0 =&gt; 'NO');
 
-	return $user_char_options;
+	return h_radio('config[board_disable]', $radio_ary, $value) . '&lt;br /&gt;&lt;input id=&quot;' . $key . '&quot; type=&quot;text&quot; name=&quot;config[board_disable_msg]&quot; maxlength=&quot;255&quot; size=&quot;40&quot; value=&quot;' . $new_config['board_disable_msg'] . '&quot; /&gt;';
 }
 
-function password_length($value)
+/**
+* Select default dateformat
+*/
+function dateformat_select($value, $key)
 {
-	global $new, $_CLASS;
-
-	return '&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;config[min_pass_chars]&quot; value=&quot;' . $value . '&quot; /&gt; ' . $_CLASS['core_user']-&gt;lang['MIN_CHARS'] . '&nbsp;&nbsp;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;3&quot; name=&quot;config[max_pass_chars]&quot; value=&quot;' . $new['max_pass_chars'] . '&quot; /&gt; ' . $_CLASS['core_user']-&gt;lang['MAX_CHARS'];
-}
-
-function select_password_chars($selected_value)
-{
 	global $_CLASS;
 
-	$pass_type_ary = array('PASS_TYPE_ANY' =&gt; '.*', 'PASS_TYPE_CASE' =&gt; '[a-zA-Z]', 'PASS_TYPE_ALPHA' =&gt; '[a-zA-Z0-9]', 'PASS_TYPE_SYMBOL' =&gt; '[a-zA-Z\W]'); 
-	$pass_char_options = '';
-	foreach ($pass_type_ary as $lang =&gt; $value)
+	$dateformat_options = '';
+
+	foreach ($_CLASS['core_user']-&gt;lang['dateformats'] as $format =&gt; $null)
 	{
-		$selected = ($selected_value == $value) ? ' selected=&quot;selected&quot;' : '';
-		$pass_char_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
+		$dateformat_options .= '&lt;option value=&quot;' . $format . '&quot;' . (($format == $value) ? ' selected=&quot;selected&quot;' : '') . '&gt;';
+		$dateformat_options .= $_CLASS['core_user']-&gt;format_date(time(), $format, true) . ((strpos($format, '|') !== false) ? ' [' . $_CLASS['core_user']-&gt;lang['RELATIVE_DAYS'] . ']' : '');
+		$dateformat_options .= '&lt;/option&gt;';
 	}
 
-	return $pass_char_options;
-}
-
-function bump_interval($value)
-{
-	global $new, $_CLASS;
-
-	$s_bump_type = '';
-	$types = array('m' =&gt; 'MINUTES', 'h' =&gt; 'HOURS', 'd' =&gt; 'DAYS');
-	foreach ($types as $type =&gt; $lang)
+	$dateformat_options .= '&lt;option value=&quot;custom&quot;';
+	if (!in_array($value, array_keys($_CLASS['core_user']-&gt;lang['dateformats'])))
 	{
-		$selected = ($new['bump_type'] == $type) ? 'selected=&quot;selected&quot; ' : '';
-		$s_bump_type .= '&lt;option value=&quot;' . $type . '&quot; ' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
+		$dateformat_options .= ' selected=&quot;selected&quot;';
 	}
+	$dateformat_options .= '&gt;' . $_CLASS['core_user']-&gt;lang['CUSTOM_DATEFORMAT'] . '&lt;/option&gt;';
 
-	return '&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; maxlength=&quot;4&quot; name=&quot;config[bump_interval]&quot; value=&quot;' . $value . '&quot; /&gt;&nbsp;&lt;select name=&quot;config[bump_type]&quot;&gt;' . $s_bump_type . '&lt;/select&gt;';
+	return &quot;&lt;select name=\&quot;dateoptions\&quot; id=\&quot;dateoptions\&quot; onchange=\&quot;if (this.value == 'custom') { document.getElementById('$key').value = '$value'; } else { document.getElementById('$key').value = this.value; }\&quot;&gt;$dateformat_options&lt;/select&gt;
+	&lt;input type=\&quot;text\&quot; name=\&quot;config[$key]\&quot; id=\&quot;$key\&quot; value=\&quot;$value\&quot; maxlength=\&quot;30\&quot; /&gt;&quot;;
 }
 
-function board_disable($value)
-{
-	global $new, $_CLASS;
-
-	$board_disable_yes = ($value) ? ' checked=&quot;checked&quot;' : '';
-	$board_disable_no = (!$value) ? ' checked=&quot;checked&quot;' : '';
-
-	return '&lt;input type=&quot;radio&quot; name=&quot;config[board_disable]&quot; value=&quot;1&quot;' . $board_disable_yes . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['YES'] . '&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;config[board_disable]&quot; value=&quot;0&quot;' . $board_disable_no . ' /&gt; ' . $_CLASS['core_user']-&gt;lang['NO'] . '&lt;br /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;config[board_disable_msg]&quot; maxlength=&quot;255&quot; size=&quot;40&quot; value=&quot;' . $new['board_disable_msg'] . '&quot; /&gt;';
-}
-
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_database.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_database.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_database.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,995 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_database.php,v 1.6 2004/05/02 13:05:36 acydburn Exp $
-//
-// FILENAME  : admin_database.php
-// STARTED   : Thu May 31, 2001
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-if (!empty($setmodules))
-{
-	$filename = basename(__FILE__);
-	$module['DB']['DB_BACKUP'] = ($auth-&gt;acl_get('a_backup')) ? $filename . &quot;$SID&amp;mode=backup&quot; : '';
-
-	$file_uploads = @ini_get('file_uploads');
-	/*if (!empty($file_uploads) &amp;&amp; $file_uploads !== 0 &amp;&amp; strtolower($file_uploads) != 'off' &amp;&amp; $auth-&gt;acl_get('a_restore'))
-	{*/
-		$module['DB']['DB_RESTORE'] = &quot;$filename$SID&amp;mode=restore&quot;;
-	/*}*/
-
-	return;
-}
-
-define('IN_PHPBB', 1);
-// Load default header
-$phpbb_root_path = '../';
-$phpEx = substr(strrchr(__FILE__, '.'), 1);
-require('pagestart.' . $phpEx);
-include($phpbb_root_path . 'includes/functions_compress.'.$phpEx);
-
<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">- at set_time_limit</A>(1200);
-
-
-// Get some vars
-$mode = (isset($_GET['mode'])) ? htmlspecialchars($_GET['mode']) : '';
-$action = (isset($_REQUEST['action'])) ? htmlspecialchars($_REQUEST['action']) : '';
-
-
-// --------------------
-// Begin program proper
-// --------------------
-switch($mode)
-{
-	case 'backup':
-		if (!$auth-&gt;acl_get('a_backup'))
-		{
-			trigger_error($user-&gt;lang['NO_ADMIN']);
-		}
-
-		$db_type = '';
-		switch (SQL_LAYER)
-		{
-			case 'oracle':
-				$db_type = 'Oracle';
-				break;
-			case 'odbc':
-				$db_type = 'ODBC';
-				break;
-			case 'mssql':
-				$db_type = 'MSSQL';
-				break;
-		}
-
-		if ($db_type)
-		{
-			trigger_error($user-&gt;lang['Backups_not_supported']);
-		}
-
-		$additional_tables	= (isset($_REQUEST['tables'])) ? htmlspecialchars($_REQUEST['tables']) : '';
-		$backup_type		= (isset($_REQUEST['type'])) ? intval($_REQUEST['type']) : false;
-		$search				= (!empty($_REQUEST['search'])) ? true : false;
-		$store				= (!empty($_REQUEST['store'])) ? true : false;
-		$compress			= (isset($_REQUEST['compress'])) ? htmlspecialchars($_REQUEST['compress']) : '';
-
-		if (!isset($_POST['backupstart']) &amp;&amp; !isset($_GET['backupstart']))
-		{
-			adm_page_header($user-&gt;lang['DB_BACKUP']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['DB_BACKUP']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['Backup_explain']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo &quot;admin_database.$phpEx$SID&amp;mode=$mode&quot;; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['Backup_options']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['Backup_type']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;type&quot; value=&quot;full&quot;  checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['Full_backup']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;type&quot; value=&quot;structure&quot; /&gt; &lt;?php echo $user-&gt;lang['Structure_only']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;type&quot; value=&quot;data&quot; /&gt; &lt;?php echo $user-&gt;lang['Data_only']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['Additional_tables']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['Additional_tables_explain']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;tables&quot; maxlength=&quot;255&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['INC_SEARCH_INDEX']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['INC_SEARCH_INDEX_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;search&quot; value=&quot;1&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;search&quot; value=&quot;0&quot; /&gt; &lt;?php echo $user-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['DOWNLOAD_STORE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['DOWNLOAD_STORE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;store&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['EXPORT_DOWNLOAD']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;store&quot; value=&quot;1&quot; /&gt; &lt;?php echo $user-&gt;lang['EXPORT_STORE']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			if (@extension_loaded('zlib') || extension_loaded('bz2'))
-			{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['Compress_file']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;compress&quot; value=&quot;none&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['NONE']; ?&gt;&lt;?php
-
-				if (extension_loaded('zlib'))
-				{
-
-
-?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;compress&quot; value=&quot;gzip&quot; /&gt;.gz&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;compress&quot; value=&quot;zip&quot; /&gt;.zip&lt;?php
-
-				}
-
-				if (extension_loaded('bz2'))
-				{
-
-?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;compress&quot; value=&quot;bzip&quot; /&gt;.bz2&lt;?php
-
-				}
-
-?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;backupstart&quot; value=&quot;&lt;?php echo $user-&gt;lang['Start_backup']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-			break;
-		}
-		else if (!isset($_POST['startdownload']) &amp;&amp; !isset($_GET['startdownload']))
-		{
-			$meta = &quot;&lt;meta http-equiv=\&quot;refresh\&quot; content=\&quot;0;url=admin_database.$phpEx?mode=backup&amp;type=$backup_type&amp;tables=&quot; . quotemeta($additional_tables) . &quot;&amp;search=$search&amp;store=&quot; . quotemeta($store_path) . &quot;&amp;compress=$compress&amp;backupstart=1&amp;startdownload=1\&quot;&gt;&quot;;
-
-			$message = (empty($store_path)) ? $user-&gt;lang['Backup_download'] : $user-&gt;lang['Backup_writing'];
-
-			adm_page_header($user-&gt;lang['DB_Backup'], $meta);
-			page_message($user-&gt;lang['DB_Backup'], $message);
-			adm_page_footer();
-		}
-
-		$tables = (SQL_LAYER != 'postgresql') ? mysql_get_tables() : pg_get_tables();
-		@sort($tables);
-
-		if (!empty($additional_tables))
-		{
-			$additional_tables = explode(',', $additional_tables);
-
-			for($i = 0; $i &lt; count($additional_tables); $i++)
-			{
-				$tables[] = trim($additional_tables[$i]);
-			}
-			unset($additional_tables);
-		}
-
-		// Enable output buffering
-		@ob_start();
-		@ob_implicit_flush(0);
-
-		// Build the sql script file...
-		echo &quot;#\n&quot;;
-		echo &quot;# phpBB Backup Script\n&quot;;
-		echo &quot;# Dump of tables for $dbname\n&quot;;
-		echo &quot;#\n# DATE : &quot; .  gmdate(&quot;d-m-Y H:i:s&quot;, time()) . &quot; GMT\n&quot;;
-		echo &quot;#\n&quot;;
-
-		if (SQL_LAYER == 'postgresql')
-		{
-			 echo &quot;\n&quot; . pg_get_sequences(&quot;\n&quot;, $backup_type);
-		}
-
-		for($i = 0; $i &lt; count($tables); $i++)
-		{
-			$table_name = $tables[$i];
-
-			if (SQL_LAYER != 'mysql4')
-			{
-				$table_def_function = &quot;get_table_def_&quot; . SQL_LAYER;
-				$table_content_function = &quot;get_table_content_&quot; . SQL_LAYER;
-			}
-			else
-			{
-				$table_def_function = &quot;get_table_def_mysql&quot;;
-				$table_content_function = &quot;get_table_content_mysql&quot;;
-			}
-
-			if ($backup_type != 'data')
-			{
-				echo &quot;#\n# TABLE: &quot; . $table_name . &quot;\n#\n&quot;;
-				echo $table_def_function($table_name, &quot;\n&quot;) . &quot;\n&quot;;
-			}
-
-			if ($backup_type != 'structure')
-			{
-				//
-				// Skip search table data?
-				//
-				if ($search || (!$search &amp;&amp; !preg_match('/search_word/', $table_name)))
-				{
-					$table_content_function($table_name, &quot;output_table_content&quot;);
-				}
-			}
-		}
-
-		// Flush the buffer, send the file
-		switch ($compress)
-		{/*
-			case 'gzip':
-				$extension = 'sql.gz';
-				$contents = gzencode(ob_get_contents());
-				ob_end_clean();
-				break;
-
-			case 'zip':
-				$extension = 'zip';
-				$zip = new zipfile;
-				$zip-&gt;add_file(ob_get_contents(), &quot;phpbb_db_backup.sql&quot;, time());
-				ob_end_clean();
-				$contents = $zip-&gt;file();
-				break;
-
-			case 'bzip':
-				$extension = 'bz2';
-				$contents = bzcompress(ob_get_contents());
-				ob_end_clean();
-				break;*/
-
-			default:
-				$extension = 'sql';
-				$contents = ob_get_contents();
-				ob_end_clean();
-		}
-
-		add_log('admin', 'log_db_backup');
-
-		if (empty($store_path))
-		{
-			header(&quot;Pragma: no-cache&quot;);
-			header(&quot;Content-Type: text/x-delimtext; name=\&quot;phpbb_db_backup.$extension\&quot;&quot;);
-			header(&quot;Content-disposition: attachment; filename=phpbb_db_backup.$extension&quot;);
-
-			echo $contents;
-			unset($contents);
-		}
-		else
-		{
-			if (!($fp = fopen('./../' . $store_path . &quot;/phpbb_db_backup.$extension&quot;, 'wb')))
-			{
-				message_die(ERROR, 'Could not open backup file');
-			}
-
-			if (!fwrite($fp, $contents))
-			{
-				message_die(ERROR, 'Could not write backup file content');
-			}
-
-			fclose($fp);
-			unset($contents);
-
-			trigger_error($user-&gt;lang['Backup_success']);
-		}
-
-		exit;
-		break;
-
-	case 'restore':
-		if (!$auth-&gt;acl_get('a_restore'))
-		{
-			trigger_error($user-&gt;lang['NO_ADMIN']);
-		}
-
-		if (isset($_POST['restorestart']))
-		{
-			// Handle the file upload ....
-			// If no file was uploaded report an error...
-			if (!empty($_POST['local']))
-			{
-				$file_tmpname = './../' . str_replace('\\\\', '/', $_POST['local']);
-				$filename = substr($file_tmpname, strrpos($file_tmpname, '/'));
-			}
-			else
-			{
-				$filename = (!empty($_POST['backup_file']['name'])) ? $HTTP_POST_FILES['backup_file']['name'] : '';
-				$file_tmpname = ($HTTP_POST_FILES['backup_file']['tmp_name'] != 'none') ? $HTTP_POST_FILES['backup_file']['tmp_name'] : '';
-			}
-
-			if ($file_tmpname == '' || $filename == '' || !file_exists($file_tmpname))
-			{
-				trigger_error($user-&gt;lang['Restore_Error_no_file']);
-			}
-
-			$ext = substr($filename, strrpos($filename, '.') + 1);
-
-			if (!preg_match('/^(sql|gz|bz2)$/', $ext))
-			{
-				trigger_error($user-&gt;lang['Restore_Error_filename']);
-			}
-
-			if ((!extension_loaded('zlib') &amp;&amp; $ext == 'gz') || (!extension_loaded('zip') &amp;&amp; $ext == 'zip') || ($ext == 'bz2' &amp;&amp; !extension_loaded('bz2')))
-			{
-				trigger_error($user-&gt;lang['Compress_unsupported']);
-			}
-
-			$sql_query = '';
-			switch ($ext)
-			{
-				case 'gz':
-					$fp = gzopen($file_tmpname, 'rb');
-					while (!gzeof($fp))
-					{
-						$sql_query .= gzgets($fp, 100000);
-					}
-					gzclose($fp);
-					break;
-
-				case 'bz2':
-					$sql_query = bzdecompress(fread(fopen($file_tmpname, 'rb'), filesize($file_tmpname)));
-					break;
-
-				case 'zip':
-
-
-				default;
-					$sql_query = fread(fopen($file_tmpname, 'r'), filesize($file_tmpname));
-			}
-
-			if ($sql_query != '')
-			{
-				// Strip out sql comments...
-				$sql_query = remove_remarks($sql_query);
-				$pieces = split_sql_file($sql_query, ';');
-
-				$sql_count = count($pieces);
-				for($i = 0; $i &lt; $sql_count; $i++)
-				{
-					$sql = trim($pieces[$i]);
-
-					if (!empty($sql) &amp;&amp; $sql[0] != '#')
-					{
-						$db-&gt;sql_query($sql);
-					}
-				}
-			}
-
-			add_log('admin', 'log_db_restore');
-
-			trigger_error($user-&gt;lang['Restore_success']);
-		}
-
-		//
-		// Restore page
-		//
-		adm_page_header($user-&gt;lang['DB_RESTORE']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['DB_RESTORE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['Restore_explain']; ?&gt;&lt;/p&gt;
-
-&lt;form enctype=&quot;multipart/form-data&quot; method=&quot;post&quot; action=&quot;&lt;?php echo &quot;admin_database.$phpEx$SID&amp;mode=$mode&quot;; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['Select_file']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $user-&gt;lang['Upload_file']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php
-
-		echo $user-&gt;lang['Supported_extensions'];
-
-		$types = ': &lt;u&gt;sql&lt;/u&gt;';
-		if (extension_loaded('zlib'))
-		{
-			$types .= ', &lt;u&gt;sql.gz&lt;/u&gt;';
-		}
-		if (extension_loaded('bz2'))
-		{
-			$types .= ', &lt;u&gt;bz2&lt;/u&gt;';
-		}
-
-		echo $types;
-
-?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;file&quot; name=&quot;backup_file&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $user-&gt;lang['Local_backup_file']; ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['Local_backup_file_explain']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;local&quot; size=&quot;40&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;restorestart&quot; value=&quot;&lt;?php echo $user-&gt;lang['Start_Restore']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		break;
-
-	default:
-		trigger_error($user-&gt;lang['No_admin']);
-		exit;
-
-}
-
-adm_page_footer();
-
-// -----------------------------------------------
-// Begin Functions
-//
-
-//
-// Table defns (not from phpMyAdmin)
-//
-function mysql_get_tables()
-{
-	global $db, $table_prefix;
-
-	$tables = array();
-
-	$result = mysql_list_tables($db-&gt;dbname, $db-&gt;db_connect_id);
-	if ($row = $db-&gt;sql_fetchrow($result))
-	{
-		do
-		{
-			if (preg_match('/^' . $table_prefix . '/', $row[0]))
-			{
-				$tables[] = $row[0];
-			}
-		}
-		while ($row = $db-&gt;sql_fetchrow($result));
-	}
-
-	return $tables;
-}
-
-//
-// The following functions are adapted from phpMyAdmin and upgrade_20.php
-//
-// This function is used for grabbing the sequences for postgres...
-//
-function pg_get_sequences($crlf, $backup_type)
-{
-	global $db;
-
-	$get_seq_sql = &quot;SELECT relname FROM pg_class WHERE NOT relname ~ 'pg_.*'
-		AND relkind = 'S' ORDER BY relname&quot;;
-
-	$seq = $db-&gt;sql_query($get_seq_sql);
-
-	if (!$num_seq = $db-&gt;sql_numrows($seq))
-	{
-
-		$return_val = &quot;# No Sequences Found $crlf&quot;;
-
-	}
-	else
-	{
-		$return_val = &quot;# Sequences $crlf&quot;;
-		$i_seq = 0;
-
-		while($i_seq &lt; $num_seq)
-		{
-			$row = $db-&gt;sql_fetchrow($seq);
-			$sequence = $row['relname'];
-
-			$get_props_sql = &quot;SELECT * FROM $sequence&quot;;
-			$seq_props = $db-&gt;sql_query($get_props_sql);
-
-			if ($db-&gt;sql_numrows($seq_props) &gt; 0)
-			{
-				$row1 = $db-&gt;sql_fetchrow($seq_props);
-
-				if ($backup_type == 'structure')
-				{
-					$row['last_value'] = 1;
-				}
-
-				$return_val .= &quot;CREATE SEQUENCE $sequence start &quot; . $row['last_value'] . ' increment ' . $row['increment_by'] . ' maxvalue ' . $row['max_value'] . ' minvalue ' . $row['min_value'] . ' cache ' . $row['cache_value'] . &quot;; $crlf&quot;;
-
-			}  // End if numrows &gt; 0
-
-			if (($row['last_value'] &gt; 1) &amp;&amp; ($backup_type != 'structure'))
-			{
-				$return_val .= &quot;SELECT NEXTVALE('$sequence'); $crlf&quot;;
-				unset($row['last_value']);
-			}
-
-			$i_seq++;
-
-		} // End while..
-
-	} // End else...
-
-	return $returnval;
-
-} // End function...
-
-//
-// The following functions will return the &quot;CREATE TABLE syntax for the
-// varying DBMS's
-//
-// This function returns, will return the table def's for postgres...
-//
-function get_table_def_postgresql($table, $crlf)
-{
-	global $db;
-
-	$schema_create = &quot;&quot;;
-	//
-	// Get a listing of the fields, with their associated types, etc.
-	//
-
-	$field_query = &quot;SELECT a.attnum, a.attname AS field, t.typname as type, a.attlen AS length, a.atttypmod as lengthvar, a.attnotnull as notnull
-		FROM pg_class c, pg_attribute a, pg_type t
-		WHERE c.relname = '$table'
-			AND a.attnum &gt; 0
-			AND a.attrelid = c.oid
-			AND a.atttypid = t.oid
-		ORDER BY a.attnum&quot;;
-	$result = $db-&gt;sql_query($field_query);
-
-	if (!$result)
-	{
-		message_die(GENERAL_ERROR, &quot;Failed in get_table_def (show fields)&quot;, &quot;&quot;, __LINE__, __FILE__, $field_query);
-	} // end if..
-
-	$schema_create .= &quot;DROP TABLE $table;$crlf&quot;;
-
-	//
-	// Ok now we actually start building the SQL statements to restore the tables
-	//
-
-	$schema_create .= &quot;CREATE TABLE $table($crlf&quot;;
-
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		//
-		// Get the data from the table
-		//
-		$sql_get_default = &quot;SELECT d.adsrc AS rowdefault
-			FROM pg_attrdef d, pg_class c
-			WHERE (c.relname = '$table')
-				AND (c.oid = d.adrelid)
-				AND d.adnum = &quot; . $row['attnum'];
-		$def_res = $db-&gt;sql_query($sql_get_default);
-
-		if (!$def_res)
-		{
-			unset($row['rowdefault']);
-		}
-		else
-		{
-			$row['rowdefault'] = @pg_result($def_res, 0, 'rowdefault');
-		}
-
-		if ($row['type'] == 'bpchar')
-		{
-			// Internally stored as bpchar, but isn't accepted in a CREATE TABLE statement.
-			$row['type'] = 'char';
-		}
-
-		$schema_create .= '	' . $row['field'] . ' ' . $row['type'];
-
-		if (eregi('char', $row['type']))
-		{
-			if ($row['lengthvar'] &gt; 0)
-			{
-				$schema_create .= '(' . ($row['lengthvar'] -4) . ')';
-			}
-		}
-
-		if (eregi('numeric', $row['type']))
-		{
-			$schema_create .= '(';
-			$schema_create .= sprintf(&quot;%s,%s&quot;, (($row['lengthvar'] &gt;&gt; 16) &amp; 0xffff), (($row['lengthvar'] - 4) &amp; 0xffff));
-			$schema_create .= ')';
-		}
-
-		if (!empty($row['rowdefault']))
-		{
-			$schema_create .= ' DEFAULT ' . $row['rowdefault'];
-		}
-
-		if ($row['notnull'] == 't')
-		{
-			$schema_create .= ' NOT NULL';
-		}
-
-		$schema_create .= &quot;,$crlf&quot;;
-
-	}
-	//
-	// Get the listing of primary keys.
-	//
-
-	$sql_pri_keys = &quot;SELECT ic.relname AS index_name, bc.relname AS tab_name, ta.attname AS column_name, i.indisunique AS unique_key, i.indisprimary AS primary_key
-		FROM pg_class bc, pg_class ic, pg_index i, pg_attribute ta, pg_attribute ia
-		WHERE (bc.oid = i.indrelid)
-			AND (ic.oid = i.indexrelid)
-			AND (ia.attrelid = i.indexrelid)
-			AND	(ta.attrelid = bc.oid)
-			AND (bc.relname = '$table')
-			AND (ta.attrelid = i.indrelid)
-			AND (ta.attnum = i.indkey[ia.attnum-1])
-		ORDER BY index_name, tab_name, column_name &quot;;
-	$result = $db-&gt;sql_query($sql_pri_keys);
-
-	if (!$result)
-	{
-		message_die(GENERAL_ERROR, &quot;Failed in get_table_def (show fields)&quot;, &quot;&quot;, __LINE__, __FILE__, $sql_pri_keys);
-	}
-
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		if ($row['primary_key'] == 't')
-		{
-			if (!empty($primary_key))
-			{
-				$primary_key .= ', ';
-			}
-
-			$primary_key .= $row['column_name'];
-			$primary_key_name = $row['index_name'];
-
-		}
-		else
-		{
-			//
-			// We have to store this all this info because it is possible to have a multi-column key...
-			// we can loop through it again and build the statement
-			//
-			$index_rows[$row['index_name']]['table'] = $table;
-			$index_rows[$row['index_name']]['unique'] = ($row['unique_key'] == 't') ? ' UNIQUE ' : '';
-			$index_rows[$row['index_name']]['column_names'] .= $row['column_name'] . ', ';
-		}
-	}
-
-	if (!empty($index_rows))
-	{
-		while(list($idx_name, $props) = each($index_rows))
-		{
-			$props['column_names'] = ereg_replace(&quot;, $&quot;, &quot;&quot; , $props['column_names']);
-			$index_create .= 'CREATE ' . $props['unique'] . &quot; INDEX $idx_name ON $table (&quot; . $props['column_names'] . &quot;);$crlf&quot;;
-		}
-	}
-
-	if (!empty($primary_key))
-	{
-		$schema_create .= &quot;	CONSTRAINT $primary_key_name PRIMARY KEY ($primary_key),$crlf&quot;;
-	}
-
-	//
-	// Generate constraint clauses for CHECK constraints
-	//
-	$sql_checks = &quot;SELECT rcname as index_name, rcsrc
-		FROM pg_relcheck, pg_class bc
-		WHERE rcrelid = bc.oid
-			AND bc.relname = '$table'
-			AND NOT EXISTS (
-				SELECT *
-					FROM pg_relcheck as c, pg_inherits as i
-					WHERE i.inhrelid = pg_relcheck.rcrelid
-						AND c.rcname = pg_relcheck.rcname
-						AND c.rcsrc = pg_relcheck.rcsrc
-						AND c.rcrelid = i.inhparent
-			)&quot;;
-	$result = $db-&gt;sql_query($sql_checks);
-
-	if (!$result)
-	{
-		message_die(GENERAL_ERROR, &quot;Failed in get_table_def (show fields)&quot;, &quot;&quot;, __LINE__, __FILE__, $sql_checks);
-	}
-
-	//
-	// Add the constraints to the sql file.
-	//
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		$schema_create .= '	CONSTRAINT ' . $row['index_name'] . ' CHECK ' . $row['rcsrc'] . &quot;,$crlf&quot;;
-	}
-
-	$schema_create = ereg_replace(',' . $crlf . '$', '', $schema_create);
-	$index_create = ereg_replace(',' . $crlf . '$', '', $index_create);
-
-	$schema_create .= &quot;$crlf);$crlf&quot;;
-
-	if (!empty($index_create))
-	{
-		$schema_create .= $index_create;
-	}
-
-	//
-	// Ok now we've built all the sql return it to the calling function.
-	//
-	return (stripslashes($schema_create));
-
-}
-
-//
-// This function returns the &quot;CREATE TABLE&quot; syntax for mysql dbms...
-//
-function get_table_def_mysql($table, $crlf)
-{
-	global $db;
-
-	$schema_create = &quot;&quot;;
-	$field_query = &quot;SHOW FIELDS FROM $table&quot;;
-	$key_query = &quot;SHOW KEYS FROM $table&quot;;
-
-	// If the user has selected to drop existing tables when doing a restore.
-	// Then we add the statement to drop the tables....
-	$schema_create .= &quot;DROP TABLE IF EXISTS $table;$crlf&quot;;
-	$schema_create .= &quot;CREATE TABLE $table($crlf&quot;;
-
-	// Ok lets grab the fields...
-	$result = $db-&gt;sql_query($field_query);
-
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		$schema_create .= '	' . $row['Field'] . ' ' . $row['Type'];
-
-		if (!empty($row['Default']))
-		{
-			$schema_create .= ' DEFAULT \'' . $row['Default'] . '\'';
-		}
-
-		if ($row['Null'] != &quot;YES&quot;)
-		{
-			$schema_create .= ' NOT NULL';
-		}
-
-		if ($row['Extra'] != &quot;&quot;)
-		{
-			$schema_create .= ' ' . $row['Extra'];
-		}
-
-		$schema_create .= &quot;,$crlf&quot;;
-	}
-	//
-	// Drop the last ',$crlf' off ;)
-	//
-	$schema_create = ereg_replace(',' . $crlf . '$', &quot;&quot;, $schema_create);
-
-	//
-	// Get any Indexed fields from the database...
-	//
-	$result = $db-&gt;sql_query($key_query);
-
-	while($row = $db-&gt;sql_fetchrow($result))
-	{
-		$kname = $row['Key_name'];
-
-		if (($kname != 'PRIMARY') &amp;&amp; ($row['Non_unique'] == 0))
-		{
-			$kname = &quot;UNIQUE|$kname&quot;;
-		}
-
-		if (!is_array($index[$kname]))
-		{
-			$index[$kname] = array();
-		}
-
-		$index[$kname][] = $row['Column_name'];
-	}
-
-	foreach ($index as $x =&gt; $columns)
-	{
-		$schema_create .= &quot;, $crlf&quot;;
-
-		if ($x == 'PRIMARY')
-		{
-			$schema_create .= '	PRIMARY KEY (' . implode($columns, ', ') . ')';
-		}
-		elseif (substr($x,0,6) == 'UNIQUE')
-		{
-			$schema_create .= '	UNIQUE ' . substr($x,7) . ' (' . implode($columns, ', ') . ')';
-		}
-		else
-		{
-			$schema_create .= &quot;	KEY $x (&quot; . implode($columns, ', ') . ')';
-		}
-	}
-
-	$schema_create .= &quot;$crlf);&quot;;
-
-	if (get_magic_quotes_runtime())
-	{
-		return(stripslashes($schema_create));
-	}
-	else
-	{
-		return($schema_create);
-	}
-
-} // End get_table_def_mysql
-
-
-//
-// This fuction will return a tables create definition to be used as an sql
-// statement.
-//
-//
-// The following functions Get the data from the tables and format it as a
-// series of INSERT statements, for each different DBMS...
-// After every row a custom callback function $handler gets called.
-// $handler must accept one parameter ($sql_insert);
-//
-//
-// Here is the function for postgres...
-//
-function get_table_content_postgresql($table, $handler)
-{
-	global $db;
-
-	// Grab all of the data from current table.
-	$result = $db-&gt;sql_query(&quot;SELECT * FROM $table&quot;);
-
-	$i_num_fields = $db-&gt;sql_numfields($result);
-
-	for ($i = 0; $i &lt; $i_num_fields; $i++)
-	{
-		$aryType[] = $db-&gt;sql_fieldtype($i, $result);
-		$aryName[] = $db-&gt;sql_fieldname($i, $result);
-	}
-
-	$iRec = 0;
-
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		unset($schema_vals);
-		unset($schema_fields);
-		unset($schema_insert);
-
-		// Build the SQL statement to recreate the data.
-		for($i = 0; $i &lt; $i_num_fields; $i++)
-		{
-			$strVal = $row[$aryName[$i]];
-			if (preg_match('#char|text|bool#i', $aryType[$i]))
-			{
-				$strQuote = &quot;'&quot;;
-				$strEmpty = &quot;&quot;;
-				$strVal = addslashes($strVal);
-			}
-			elseif (preg_match('#date|timestamp#i', $aryType[$i]))
-			{
-				if ($empty($strVal))
-				{
-					$strQuote = &quot;&quot;;
-				}
-				else
-				{
-					$strQuote = &quot;'&quot;;
-				}
-			}
-			else
-			{
-				$strQuote = &quot;&quot;;
-				$strEmpty = &quot;NULL&quot;;
-			}
-
-			if (empty($strVal) &amp;&amp; $strVal != &quot;0&quot;)
-			{
-				$strVal = $strEmpty;
-			}
-
-			$schema_vals .= &quot; $strQuote$strVal$strQuote,&quot;;
-			$schema_fields .= &quot; $aryName[$i],&quot;;
-		}
-
-		$schema_vals = preg_replace('#,$#', '', $schema_vals);
-		$schema_vals = preg_replace('#^ #', '', $schema_vals);
-		$schema_fields = preg_replace('#,$#', '', $schema_fields);
-		$schema_fields = preg_replace('#^ #', '', $schema_fields);
-
-		// Take the ordered fields and their associated data and build it
-		// into a valid sql statement to recreate that field in the data.
-		$schema_insert = &quot;INSERT INTO $table ($schema_fields) VALUES($schema_vals);&quot;;
-
-		$handler(trim($schema_insert));
-	}
-
-	return(true);
-
-}// end function get_table_content_postgres...
-
-//
-// This function is for getting the data from a mysql table.
-//
-
-function get_table_content_mysql($table, $handler)
-{
-	global $db;
-
-	// Grab the data from the table.
-	$result = $db-&gt;sql_query(&quot;SELECT * FROM $table&quot;);
-
-	// Loop through the resulting rows and build the sql statement.
-	$schema_insert = &quot;&quot;;
-	if ($row = $db-&gt;sql_fetchrow($result))
-	{
-		$schema_insert = &quot;\n#\n# Table Data for $table\n#\n&quot;;
-
-		$handler($schema_insert);
-
-		do
-		{
-			$table_list = '(';
-			$num_fields = $db-&gt;sql_numfields($result);
-			//
-			// Grab the list of field names.
-			//
-			for ($j = 0; $j &lt; $num_fields; $j++)
-			{
-				$table_list .= $db-&gt;sql_fieldname($j, $result) . ', ';
-			}
-			//
-			// Get rid of the last comma
-			//
-			$table_list = preg_replace('#, $#', '', $table_list);
-			$table_list .= ')';
-			//
-			// Start building the SQL statement.
-			//
-			$schema_insert = &quot;INSERT INTO $table $table_list VALUES(&quot;;
-			//
-			// Loop through the rows and fill in data for each column
-			//
-			for ($j = 0; $j &lt; $num_fields; $j++)
-			{
-				if (!isset($row[$j]))
-				{
-					//
-					// If there is no data for the column set it to null.
-					// There was a problem here with an extra space causing the
-					// sql file not to reimport if the last column was null in
-					// any table.  Should be fixed now :) JLH
-					//
-					$schema_insert .= ' NULL,';
-				}
-				elseif ($row[$j] != '')
-				{
-					$schema_insert .= ' \'' . addslashes($row[$j]) . '\',';
-				}
-				else
-				{
-					$schema_insert .= '\'\',';
-				}
-			}
-			//
-			// Get rid of the the last comma.
-			//
-			$schema_insert = preg_replace('#,$#', '', $schema_insert);
-			$schema_insert .= ');';
-			//
-			// Go ahead and send the insert statement to the handler function.
-			//
-			$handler(trim($schema_insert));
-		}
-		while ($row = $db-&gt;sql_fetchrow($result));
-	}
-
-	return true;
-}
-
-function output_table_content($content)
-{
-	global $tempfile;
-
-	//fwrite($tempfile, $content . &quot;\n&quot;);
-	//$backup_sql .= $content . &quot;\n&quot;;
-	echo $content .&quot;\n&quot;;
-	return;
-}
-//
-// End Functions
-// -----------------------------------------------
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_disallow.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_disallow.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_disallow.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,150 +0,0 @@
-&lt;?php
-/** 
-*
-* @package acp
-* @version $Id: admin_disallow.php,v 1.6 2005/04/09 12:26:28 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-*/
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Check permissions
-if (!$_CLASS['auth']-&gt;acl_get('a_names'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-require($site_file_root . 'includes/forums/functions_user.php');
-
-if (isset($_POST['disallow']))
-{
-	$disallowed_user = (isset($_REQUEST['disallowed_user'])) ? htmlspecialchars($_REQUEST['disallowed_user']) : '';
-	$disallowed_user = str_replace('*', '%', $disallowed_user);
-
-	if (!$disallowed_user)
-	{
-		trigger_error('No_VALUE');
-	}
-	
-	if (validate_username($disallowed_user))
-	{
-		$message = $_CLASS['core_user']-&gt;lang['Disallowed_already'];
-	}
-	else
-	{
-		$sql = 'INSERT INTO ' . DISALLOW_TABLE . &quot; (disallow_username)
-			VALUES('&quot; . $_CLASS['core_db']-&gt;sql_escape(stripslashes($disallowed_user)) . &quot;')&quot;;
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		$message = $_CLASS['core_user']-&gt;lang['Disallow_successful'];
-	}
-
-	add_log('admin', 'log_disallow_add', str_replace('%', '*', $disallowed_user));
-
-	trigger_error($message);
-}
-else if (isset($_POST['allow']))
-{
-	$disallowed_id = (isset($_REQUEST['disallowed_id'])) ? intval($_REQUEST['disallowed_id']) : '';
-
-	if (empty($disallowed_id))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['No_user_selected']);
-	}
-
-	$sql = 'DELETE FROM ' . DISALLOW_TABLE . &quot;
-		WHERE disallow_id = $disallowed_id&quot;;
-	$_CLASS['core_db']-&gt;sql_query($sql);
-
-	add_log('admin', 'log_disallow_delete');
-
-	trigger_error($_CLASS['core_user']-&gt;lang['Disallowed_deleted']);
-}
-
-// Grab the current list of disallowed usernames...
-$sql = 'SELECT *
-	FROM ' . DISALLOW_TABLE;
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-$disallow_select = '';
-if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-{
-	do
-	{
-		$disallow_select .= '&lt;option value=&quot;' . $row['disallow_id'] . '&quot;&gt;' . str_replace('%', '*', $row['disallow_username']) . '&lt;/option&gt;';
-	}
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-}
-
-// Output page
-adm_page_header($_CLASS['core_user']-&gt;lang['DISALLOW']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISALLOW']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Disallow_explain']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_disallow', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Add_disallow_title']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Add_disallow_explain']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;disallowed_user&quot; size=&quot;30&quot; /&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;disallow&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Delete_disallow_title']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Delete_disallow_explain']; ?&gt;&lt;/p&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['Delete_disallow_title']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if ($disallow_select != '')
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select class=&quot;post&quot; name=&quot;disallowed_id&quot;&gt;&lt;?php echo $disallow_select; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;allow&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-	else
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['No_disallowed']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_email.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_email.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_email.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,266 +0,0 @@
-&lt;?php
-/** 
-*
-* @package acp
-* @version $Id: admin_email.php,v 1.15 2005/04/09 12:26:28 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-*/
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Check permissions
-if (!$_CLASS['auth']-&gt;acl_get('a_email'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Set some vars
-$message = $subject = $usernames = $group_id = '';
-$error = array();
-
-// Do the job ...
-if (isset($_POST['submit']))
-{
-	// Error checking needs to go here ... if no subject and/or no message then skip 
-	// over the send and return to the form
-	$group_id	= request_var('g', 0);
-	$usernames	= request_var('usernames', '');
-	$subject	= preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', strtr(request_var('subject', ''), array_flip(get_html_translation_table(HTML_ENTITIES))));
-	$message	= preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', strtr(request_var('message', ''), array_flip(get_html_translation_table(HTML_ENTITIES))));
-	$use_queue	= (isset($_POST['send_immediatly'])) ? false : true;
-	$priority	= request_var('mail_priority_flag', MAIL_NORMAL_PRIORITY);
-
-	// NOTE: Only temporary, i do not think this is a good idea for the final code, but i have to test this more than once. ;)
-	$log_session= (isset($_POST['log_session'])) ? true : false;
-
-	if (!$subject)
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['NO_EMAIL_SUBJECT'];
-	}
-
-	if (!$message)
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['NO_EMAIL_MESSAGE'];
-	}
-
-	if (!sizeof($error))	
-	{
-		if ($usernames)
-		{
-			$usernames = implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', &quot;\&quot;'\&quot; . \$_CLASS['core_db']-&gt;sql_escape('\\1') . \&quot;'\&quot;&quot;, explode(&quot;\n&quot;, $usernames)));
-
-			$sql = 'SELECT username, user_email, user_jabber, user_notify_type, user_lang 
-				FROM ' . USERS_TABLE . &quot; 
-				WHERE username IN ($usernames)
-					AND user_allow_massemail = 1
-				ORDER BY user_lang, user_notify_type, SUBSTRING(user_email FROM INSTR(user_email,'@'))&quot;;
-		}
-		else
-		{
-			$sql = ($group_id) ? 'SELECT u.user_email, u.username, u.user_lang, u.user_jabber, u.user_notify_type FROM ' . USERS_TABLE . ' u, ' . USER_GROUP_TABLE . &quot; ug WHERE ug.group_id = $group_id AND ug.user_pending &lt;&gt; 1 AND u.user_id = ug.user_id AND u.user_allow_massemail = 1&quot; : 'SELECT u.username, u.user_email, u.user_jabber, u.user_notify_type, u.user_lang FROM ' . USERS_TABLE . ' u WHERE u.user_allow_massemail = 1';
-
-			// TODO: different for other db servers?
-			$sql .= &quot; ORDER BY u.user_lang, u.user_notify_type, SUBSTRING(u.user_email FROM INSTR(u.user_email,'@'))&quot;;
-		}
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_USER']);
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-	
-		$i = $j = 0;
-		// Send with BCC, no more than 50 recipients for one mail (to not exceed the limit)
-		$max_chunk_size = 50;
-		$email_list = array();
-		$old_lang = $row['user_lang'];
-		$old_notify_type = $row['user_notify_type'];
-
-		do
-		{
-			if (($row['user_notify'] == NOTIFY_EMAIL &amp;&amp; $row['user_email']) ||
-				($row['user_notify'] == NOTIFY_IM &amp;&amp; $row['user_jabber']) ||
-				($row['user_notify'] == NOTIFY_BOTH &amp;&amp; $row['user_email'] &amp;&amp; $row['user_jabber']))
-			{
-				if ($i == $max_chunk_size || $row['user_lang'] != $old_lang || $row['user_notify_type'] != $old_notify_type)
-				{
-					$i = 0;
-					$j++;
-					$old_lang = $row['user_lang'];
-					$old_notify_type = $row['user_notify_type'];
-				}
-
-				$email_list[$j][$i]['lang']		= $row['user_lang'];
-				$email_list[$j][$i]['method']	= $row['user_notify_type'];
-				$email_list[$j][$i]['email']	= $row['user_email'];
-				$email_list[$j][$i]['name']		= $row['username'];
-				$email_list[$j][$i]['jabber']	= $row['user_jabber'];
-				$i++;
-			}
-		} 
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-		// Send the messages
-		include_once($site_file_root.'includes/forums/functions_messenger.php');
-		$messenger = new messenger($use_queue);
-
-		$errored = false;
-
-		for ($i = 0; $i &lt; sizeof($email_list); $i++)
-		{
-			$used_lang = $email_list[$i][0]['lang'];
-			$used_method = $email_list[$i][0]['method'];
-
-			for ($j = 0; $j &lt; sizeof($email_list[$i]); $j++)
-			{
-				$email_row = $email_list[$i][$j];
-
-				$messenger-&gt;{((sizeof($email_list[$i]) == 1) ? 'to' : 'bcc')}($email_row['email'], $email_row['name']);
-				$messenger-&gt;im($email_row['jabber'], $email_row['name']);
-			}
-
-			$messenger-&gt;template('admin_send_email', $used_lang);
-
-			$messenger-&gt;headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-			$messenger-&gt;headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']-&gt;data['user_id']);
-			$messenger-&gt;headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']-&gt;data['username']);
-			$messenger-&gt;headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']-&gt;ip);
-			
-			$messenger-&gt;subject($subject);
-			$messenger-&gt;replyto($config['board_email']);
-			$messenger-&gt;set_mail_priority($priority);
-
-			$messenger-&gt;assign_vars(array(
-				'SITENAME'		=&gt; $config['sitename'],
-				'CONTACT_EMAIL' =&gt; $config['board_contact'],
-				'MESSAGE'		=&gt; $message)
-			);
-	
-			if (!($messenger-&gt;send($used_method, $log_session)))
-			{
-				$errored = true;
-			}
-		}
-		unset($email_list);
-
-		$messenger-&gt;save_queue();
-
-		if ($group_id)
-		{
-			$sql = 'SELECT group_name 
-				FROM ' . GROUPS_TABLE . &quot; 
-				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-			$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-			extract($row);
-		}
-		else
-		{
-			// Not great but the logging routine doesn't cope well with localising
-			// on the fly
-			$group_name = $_CLASS['core_user']-&gt;lang['ALL_USERS'];
-		}
-
-		add_log('admin', 'LOG_MASS_EMAIL', $group_name);
-		$message = (!$errored) ? $_CLASS['core_user']-&gt;lang['EMAIL_SENT'] : sprintf($_CLASS['core_user']-&gt;lang['EMAIL_SEND_ERROR'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=admin_viewlogs&amp;mode=critical', array('admin' =&gt; true)).'&quot; class=&quot;gen&quot;&gt;', '&lt;/a&gt;');
-		trigger_error($message);
-	}
-}
-
-// Initial selection
-$sql = 'SELECT group_id, group_type, group_name
-	FROM ' . GROUPS_TABLE . ' 
-	ORDER BY group_type DESC, group_name ASC';
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-$select_list = '&lt;option value=&quot;0&quot;' . ((!$group_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ALL_USERS'] . '&lt;/option&gt;';
-if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-{
-	do
-	{
-		$selected = ($group_id == $row['group_id']) ? ' selected=&quot;selected&quot;' : '';
-		$select_list .= '&lt;option value = &quot;' . $row['group_id'] . '&quot;' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . $selected . '&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-	}
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-}
-$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-$s_priority_options = '&lt;option value=&quot;' . MAIL_LOW_PRIORITY . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAIL_LOW_PRIORITY'] . '&lt;/option&gt;';
-$s_priority_options .= '&lt;option value=&quot;' . MAIL_NORMAL_PRIORITY . '&quot; selected=&quot;selected&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAIL_NORMAL_PRIORITY'] . '&lt;/option&gt;';
-$s_priority_options .= '&lt;option value=&quot;' . MAIL_HIGH_PRIORITY . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['MAIL_HIGH_PRIORITY'] . '&lt;/option&gt;';
-
-adm_page_header($_CLASS['core_user']-&gt;lang['MASS_EMAIL']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MASS_EMAIL']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MASS_EMAIL_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_email', array('admin' =&gt; true)); ?&gt;&quot; name=&quot;email&quot;&gt;&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['COMPOSE']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if (sizeof($error))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;error&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEND_TO_GROUP']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;g&quot;&gt;&lt;?php echo $select_list; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEND_TO_USERS']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEND_TO_USERS_EXPLAIN']; ?&gt;&lt;br /&gt;[ &lt;a href=&quot;&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=email&amp;field=usernames'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; align=&quot;left&quot;&gt;&lt;textarea name=&quot;usernames&quot; rows=&quot;5&quot; cols=&quot;40&quot;&gt;&lt;?php echo $usernames; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBJECT']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;subject&quot; size=&quot;45&quot; maxlength=&quot;100&quot; tabindex=&quot;2&quot; value=&quot;&lt;?php echo $subject; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MASS_MESSAGE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MASS_MESSAGE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; name=&quot;message&quot; rows=&quot;10&quot; cols=&quot;60&quot; tabindex=&quot;3&quot;&gt;&lt;?php echo $message; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MAIL_PRIORITY']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;mail_priority_flag&quot;&gt;&lt;?php echo $s_priority_options; ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEND_IMMEDIATLY']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;send_immediatly&quot; class=&quot;text&quot; checked=&quot;checked&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOG_SESSION']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;log_session&quot; class=&quot;text&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['EMAIL']; ?&gt;&quot; name=&quot;submit&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -287,12 +287,12 @@
 		if ($update)
 		{
 			$forum_data['forum_flags'] = 0;
-			$forum_data['forum_flags'] += (request_var('forum_link_track', false)) ? 1 : 0;
-			$forum_data['forum_flags'] += (request_var('prune_old_polls', false)) ? 2 : 0;
-			$forum_data['forum_flags'] += (request_var('prune_announce', false)) ? 4 : 0;
-			$forum_data['forum_flags'] += (request_var('prune_sticky', false)) ? 8 : 0;
-			$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
-			$forum_data['forum_flags'] += (request_var('enable_post_review', true)) ? 32 : 0;
+			$forum_data['forum_flags'] += (request_var('forum_link_track', false)) ? FORUM_FLAG_LINK_TRACK : 0;
+			$forum_data['forum_flags'] += (request_var('prune_old_polls', false)) ? FORUM_FLAG_PRUNE_POLL : 0;
+			$forum_data['forum_flags'] += (request_var('prune_announce', false)) ? FORUM_FLAG_PRUNE_ANNOUNCE : 0;
+			$forum_data['forum_flags'] += (request_var('prune_sticky', false)) ? FORUM_FLAG_PRUNE_STICKY : 0;
+			$forum_data['forum_flags'] += ($forum_data['show_active']) ? FORUM_FLAG_ACTIVE_TOPICS : 0;
+			$forum_data['forum_flags'] += (request_var('enable_post_review', true)) ? FORUM_FLAG_POST_REVIEW : 0;
 		}
 
 		// Show form to create/modify a forum
@@ -345,7 +345,6 @@
 					'forum_rules'			=&gt; '',
 					'forum_rules_link'		=&gt; '',
 					'forum_image'			=&gt; '',
-					'forum_style'			=&gt; 0,
 					'display_on_index'		=&gt; false,
 					'forum_topics_per_page'	=&gt; 0, 
 					'enable_indexing'		=&gt; true, 
@@ -354,7 +353,7 @@
 					'prune_days'			=&gt; 7,
 					'prune_viewed'			=&gt; 7,
 					'prune_freq'			=&gt; 1,
-					'forum_flags'			=&gt; 0,
+					'forum_flags'			=&gt; FORUM_FLAG_POST_REVIEW,
 					'forum_password'		=&gt; '',
 					'forum_password_confirm'=&gt; '',
 				);
@@ -504,12 +503,12 @@
 			'S_TOPIC_ICONS'				=&gt; ($forum_data['enable_icons']) ? true : false,
 			'S_DISPLAY_ON_INDEX'		=&gt; ($forum_data['display_on_index']) ? true : false,
 			'S_PRUNE_ENABLE'			=&gt; ($forum_data['enable_prune']) ? true : false,
-			'S_FORUM_LINK_TRACK'		=&gt; ($forum_data['forum_flags'] &amp; 1) ? true : false,
-			'S_PRUNE_OLD_POLLS'			=&gt; ($forum_data['forum_flags'] &amp; 2) ? true : false,
-			'S_PRUNE_ANNOUNCE'			=&gt; ($forum_data['forum_flags'] &amp; 4) ? true : false,
-			'S_PRUNE_STICKY'			=&gt; ($forum_data['forum_flags'] &amp; 8) ? true : false,
-			'S_DISPLAY_ACTIVE_TOPICS'	=&gt; ($forum_data['forum_flags'] &amp; 16) ? true : false,
-			'S_ENABLE_POST_REVIEW'		=&gt; ($forum_data['forum_flags'] &amp; 32) ? true : false,
+			'S_FORUM_LINK_TRACK'		=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_LINK_TRACK) ? true : false,
+			'S_PRUNE_OLD_POLLS'			=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_PRUNE_POLL) ? true : false,
+			'S_PRUNE_ANNOUNCE'			=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_PRUNE_ANNOUNCE) ? true : false,
+			'S_PRUNE_STICKY'			=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_PRUNE_STICKY) ? true : false,
+			'S_DISPLAY_ACTIVE_TOPICS'	=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_ACTIVE_TOPICS) ? true : false,
+			'S_ENABLE_POST_REVIEW'		=&gt; ($forum_data['forum_flags'] &amp; FORUM_FLAG_POST_REVIEW) ? true : false,
 			)
 		);
 
@@ -748,12 +747,12 @@
 	// 16 = show active topics
 	// 32 = enable post review
 	$forum_data['forum_flags'] = 0;
-	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? 1 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? 2 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? 4 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? 8 : 0;
-	$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
-	$forum_data['forum_flags'] += ($forum_data['enable_post_review']) ? 32 : 0;
+	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? FORUM_FLAG_LINK_TRACK : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? FORUM_FLAG_PRUNE_POLL : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? FORUM_FLAG_PRUNE_ANNOUNCE : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? FORUM_FLAG_PRUNE_STICKY : 0;
+	$forum_data['forum_flags'] += ($forum_data['show_active']) ? FORUM_FLAG_ACTIVE_TOPICS : 0;
+	$forum_data['forum_flags'] += ($forum_data['enable_post_review']) ? FORUM_FLAG_POST_REVIEW : 0;
 
 	// Unset data that are not database fields
 	$forum_data_sql = $forum_data;

Modified: cms/trunk/includes/forums/admin/admin_icons.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_icons.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_icons.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,766 +1,579 @@
-&lt;?php
-/** 
-*
-* @package acp
-* @version $Id: admin_icons.php,v 1.14 2005/04/30 14:12:20 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-*/
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have general permissions?
-if (!$_CLASS['auth']-&gt;acl_get('a_icons'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Grab some basic parameters
-$mode = request_var('mode', '');
-$action = request_var('action', '');
-$action = (isset($_POST['add'])) ? 'add' : $action;
-$action = (isset($_POST['edit'])) ? 'edit' : $action;
-$id = request_var('id', 0);
-
-// What are we working on?
-switch ($mode)
-{
-/*	case 'smilies':
-		$table = FORUMS_SMILIES_TABLE;
-		$lang = 'SMILIES';
-		$fields = 'smiley';
-		$img_path = $config['smilies_path'];
-	break;*/
-
-	//case 'icons':
-	default:
-		$table = FORUMS_ICONS_TABLE;
-		$lang = 'ICONS';
-		$fields = 'icons';
-		$img_path = $config['icons_path'];
-	break;
-}
-
-// Clear some arrays
-$_images = $_paks = array();
-$notice = '';
-
-
-// Grab file list of paks and images
-if ($action == 'edit' || $action == 'add' || $action == 'import')
-{
-	$imglist = filelist($img_path, '');
-	
-	foreach ($imglist as $path =&gt; $img_ary)
-	{
-		foreach ($img_ary as $img)
-		{
-			$img_size = @getimagesize($img_path . '/' . $path . $img);
-
-			$_images[$path.$img]['file'] = $path.$img;
-			$_images[$path.$img]['width'] = $img_size[0];
-			$_images[$path.$img]['height'] = $img_size[1];
-		}
-	}
-	unset($imglist);
-
-	$dir = @opendir($img_path);
-	while ($file = @readdir($dir))
-	{
-		if (is_file($img_path . '/' . $file) &amp;&amp; preg_match('#\.pak$#i', $file))
-		{
-			$_paks[] = $file;
-		}
-	}
-	@closedir($dir);
-}
-
-$data = array();
-
-// What shall we do today? Oops, I believe that's trademarked ...
-switch ($action)
-{
-	case 'edit':
-		unset($_images);
-		$_images = array();
-
-	case 'add':
-
-		$order_list = '';
-
-		$sql = &quot;SELECT * 
-			FROM $table 
-			ORDER BY {$fields}_order &quot; . (($id || $action == 'add') ? 'DESC' : 'ASC');
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			do
-			{
-				if ($action == 'add')
-				{
-					unset($_images[$row[$fields . '_url']]);
-				}
-
-				if ($row[$fields . '_id'] == $id)
-				{
-					$after = TRUE;
-					$data[$row[$fields . '_url']] = $row;
-				}
-				else
-				{
-					if ($action == 'edit' &amp;&amp; !$id)
-					{
-						$data[$row[$fields . '_url']] = $row;
-					}
-					
-					$selected = '';
-					if (!empty($after))
-					{
-						$selected = ' selected=&quot;selected&quot;';
-						$after = FALSE;
-					}
-
-					$after_txt = ($mode == 'smilies') ? $row['code'] : $row['icons_url'];
-					$order_list = '&lt;option value=&quot;' . ($row[$fields . '_order']) . '&quot;' . $selected . '&gt;' . sprintf($_CLASS['core_user']-&gt;lang['AFTER_' . $lang], ' -&gt; ' . htmlspecialchars($after_txt)) . '&lt;/option&gt;' . $order_list;
-				}
-			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		$order_list = '&lt;option value=&quot;1&quot;' . ((!isset($after)) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['FIRST'] . '&lt;/option&gt;' . $order_list;
-
-		if ($action == 'add')
-		{
-			$data = $_images;
-		}
-
-		$colspan = (($mode == 'smilies') ? '7' : '5');
-		$colspan += ($id) ? 1 : 0;
-		$colspan += ($action == 'add') ? 2 : 0;
-
-		adm_page_header($_CLASS['core_user']-&gt;lang[$lang]);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang]; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang .'_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link(&quot;Forums&amp;file=admin_icons&amp;mode=$mode&amp;action=&quot; . (($action == 'add') ? 'create' : 'modify'), array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;tr&gt;
-	&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_CONFIG'] ?&gt;&lt;/th&gt;
-&lt;/tr&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_URL'] ?&gt;&lt;/td&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_LOCATION'] ?&gt;&lt;/td&gt;
-&lt;?php
-	if ($mode == 'smilies')
-	{
-?&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_CODE'] ?&gt;&lt;/td&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_EMOTION'] ?&gt;&lt;/td&gt;
-&lt;?php
-	}
-?&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_WIDTH'] ?&gt;&lt;/td&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_HEIGHT'] ?&gt;&lt;/td&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_ON_POSTING'] ?&gt;&lt;/td&gt;
-&lt;?php
-	if ($id || $action == 'add')
-	{
-?&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_ORDER'] ?&gt;&lt;/td&gt;
-&lt;?php
-	}
-?&gt;
-&lt;?php
-	if ($action == 'add')
-	{
-?&gt;
-	&lt;td class=&quot;cat&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD'] ?&gt;&lt;/td&gt;
-&lt;?php
-	}
-?&gt;
-&lt;/tr&gt;
-&lt;?php
-	$row = 0;
-	
-	foreach ($data as $img =&gt; $img_row)
-	{
-		$row_class = (($row % 2) == 0) ? 'row1' : 'row2';
-?&gt;
-&lt;tr&gt;
-	&lt;td align=&quot;center&quot; class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;img src=&quot;&lt;?php echo $img_path . '/' . $img ?&gt;&quot; border=&quot;0&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;image[&lt;?php echo $img; ?&gt;]&quot; value=&quot;1&quot; /&gt;&lt;/td&gt;
-	&lt;td valign=&quot;top&quot; class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;[&lt;?php echo $img; ?&gt;]&lt;/td&gt;
-&lt;?php
-
-	if ($mode == 'smilies')
-	{
-
-?&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;code[&lt;?php echo $img; ?&gt;]&quot; value=&quot;&lt;?php echo (!empty($img_row['code'])) ? $img_row['code'] : '' ?&gt;&quot; size=&quot;10&quot; /&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;emotion[&lt;?php echo $img; ?&gt;]&quot; value=&quot;&lt;?php echo (!empty($img_row['emotion'])) ? $img_row['emotion'] : '' ?&gt;&quot; size=&quot;10&quot; /&gt;&lt;/td&gt;
-&lt;?php
-
-	}
-
-?&gt;
-	&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; name=&quot;width[&lt;?php echo $img; ?&gt;]&quot; value=&quot;&lt;?php echo (!empty($img_row[$fields .'_width'])) ? $img_row[$fields .'_width'] : $img_row['width'] ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;3&quot; name=&quot;height[&lt;?php echo $img; ?&gt;]&quot; value=&quot;&lt;?php echo (!empty($img_row[$fields .'_height'])) ? $img_row[$fields .'_height'] : $img_row['height'] ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;display_on_posting[&lt;?php echo $img; ?&gt;]&quot;&lt;?php echo (!empty($img_row['display_on_posting']) || $action == 'add') ? ' checked=&quot;checked&quot;' : '' ?&gt; /&gt;&lt;/td&gt;
-&lt;?php
-		if ($id || $action == 'add')
-		{
-?&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;select name=&quot;order[&lt;?php echo $img; ?&gt;]&quot;&gt;&lt;?php echo $order_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-&lt;?php
-		}
-	
-		if ($action == 'add')
-		{
-?&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;add_img[&lt;?php echo $img; ?&gt;]&quot; value=&quot;1&quot; /&gt;&lt;?php
-	
-	}
-?&gt;
-&lt;/tr&gt;
-&lt;?php
-	if (isset($img_row[$fields . '_id']))
-	{
-
-?&gt;&lt;input type=&quot;hidden&quot; name=&quot;id[&lt;?php echo $img; ?&gt;]&quot; value=&quot;&lt;?php echo $img_row[$fields . '_id'] ?&gt;&quot; /&gt;&lt;?php
-	
-	}
-	$row++;
-}
-?&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php 
-			
-	
-?&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT'] ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-
-		adm_page_footer();
-		break;
-
-	case 'create':
-	case 'modify':
-
-		// Get items to create/modify
-		$images = (isset($_POST['image'])) ? array_keys($_POST['image']) : array();
-		
-		// Now really get the items
-		$image_id		= (isset($_POST['id'])) ? array_map('intval', $_POST['id']) : array();
-		$image_order	= (isset($_POST['order'])) ? array_map('intval', $_POST['order']) : array();
-		$image_width	= (isset($_POST['width'])) ? array_map('intval', $_POST['width']) : array();
-		$image_height	= (isset($_POST['height'])) ? array_map('intval', $_POST['height']) : array();
-		$image_add		= (isset($_POST['add_img'])) ? array_map('intval', $_POST['add_img']) : array();
-		$image_emotion	= request_var('emotion', '');
-		$image_code		= request_var('code', '');
-		$image_display_on_posting = (isset($_POST['display_on_posting'])) ? array_map('intval', $_POST['display_on_posting']) : array();
-
-		foreach ($images as $image)
-		{
-			if (($mode == 'smilies' &amp;&amp; ($image_emotion[$image] == '' || $image_code[$image] == '')) ||
-				($action == 'create' &amp;&amp; !isset($image_add[$image])))
-			{
-			}
-			else
-			{
-				if ($image_width[$image] == 0 || $image_height[$image] == 0)
-				{
-					$img_size = @getimagesize($img_path . '/' . $image);
-					$image_width[$image] = $img_size[0];
-					$image_height[$image] = $img_size[1];
-				}
-
-				$img_sql = array(
-					$fields . '_url'	=&gt;	$image,
-					$fields . '_width'	=&gt;	$image_width[$image],
-					$fields . '_height'	=&gt;	$image_height[$image],
-					'display_on_posting'=&gt;	(isset($image_display_on_posting[$image])) ? 1 : 0,
-				);
-
-				if ($mode == 'smilies')
-				{
-					$img_sql = array_merge($img_sql, array(
-						'emotion'	=&gt;	$image_emotion[$image],
-						'code'		=&gt;	$image_code[$image])
-					);
-				}
-				
-				if (!empty($image_order[$image]))
-				{
-					$img_sql = array_merge($img_sql, array(
-						$fields . '_order'	=&gt;	$image_order[$image] . '.5')
-					);
-				}
-
-				if ($action == 'modify')
-				{
-					$sql = &quot;UPDATE $table
-						SET &quot; . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $img_sql) . &quot; 
-						WHERE {$fields}_id = &quot; . $image_id[$image];
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-				else
-				{
-					$sql = &quot;INSERT INTO $table &quot; . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $img_sql);
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-
-				$update = FALSE;
-
-				if ($action == 'modify' &amp;&amp; !empty($image_order[$image]))
-				{
-					$update = TRUE;
-
-					$result = $_CLASS['core_db']-&gt;query(&quot;SELECT {$fields}_order 
-						FROM $table
-						WHERE {$fields}_id = &quot; . $image_id[$image]);
-					$order_old = $_CLASS['core_db']-&gt;sql_fetchfield($fields . '_order', 0, $result);
-
-					if ($order_old == $image_order[$image])
-					{
-						$update = FALSE;
-					}
-
-					if ($order_old &gt; $image_order[$image])
-					{
-						$sign = '+';
-						$where = $fields . '_order &gt;= ' . $image_order[$image] . &quot; AND {$fields}_order &lt; $order_old&quot;;
-					}
-					else if ($order_old &lt; $image_order[$image])
-					{
-						$sign = '-';
-						$where = &quot;{$fields}_order &gt; $order_old AND {$fields}_order &lt; &quot; . $image_order[$image];
-						$sql[$fields . '_order'] = $image_order[$image] - 1;
-					}
-				}
-
-				if ($update)
-				{
-					$sql = &quot;UPDATE $table
-						SET {$fields}_order = {$fields}_order $sign 1
-						WHERE $where&quot;;
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-			
-			}
-		}
-		
-		$_CLASS['core_cache']-&gt;destroy('icons');
-
-		if ($action == 'modify')
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang[$lang . '_EDITED']);
-		}
-		else
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang[$lang . '_ADDED']);
-		}
-
-		break;
-
-	case 'import':
-
-		$pak = request_var('pak', '');
-		$current = request_var('current', '');
-
-		if ($pak != '')
-		{
-			$order = 0;
-
-			// The user has already selected a smilies_pak file
-			if ($current == 'delete')
-			{
-				$_CLASS['core_db']-&gt;query(&quot;TRUNCATE $table&quot;);
-
-				switch ($mode)
-				{
-					case 'smilies':
-						break;
-
-					case 'icons':
-						// Reset all icon_ids
-						$_CLASS['core_db']-&gt;query('UPDATE ' . TOPICS_TABLE . ' 
-							SET icon_id = 0');
-						$_CLASS['core_db']-&gt;query('UPDATE ' . POSTS_TABLE . ' 
-							SET icon_id = 0');
-						break;
-				}
-			}
-			else 
-			{
-				$cur_img = array();
-
-				$field_sql = ($mode == 'smilies') ? 'code' : 'icons_url';
-				$result = $_CLASS['core_db']-&gt;query(&quot;SELECT $field_sql FROM $table&quot;);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					++$order;
-					$cur_img[$row[$field_sql]] = 1;
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-			}
-
-			if (!($pak_ary = @file($img_path . '/' . $pak)))
-			{
-				trigger_error('Could not read pak file', E_USER_ERROR);
-			}
-
-			foreach ($pak_ary as $pak_entry)
-			{
-				$data = array();
-				if (preg_match_all(&quot;#'(.*?)', #&quot;, $pak_entry, $data))
-				{
-					if ((sizeof($data[1]) != 3 &amp;&amp; $mode == 'icons') || 
-						(sizeof($data[1]) != 5 &amp;&amp; $mode == 'smilies'))
-					{
-						trigger_error($_CLASS['core_user']-&gt;lang['WRONG_PAK_TYPE']);
-					}
-
-					$img = stripslashes($data[1][0]);
-					$width = stripslashes($data[1][1]);
-					$height = stripslashes($data[1][2]);
-					if (isset($data[1][3]) &amp;&amp; isset($data[1][4]))
-					{
-						$emotion = stripslashes($data[1][3]);
-						$code = htmlentities(stripslashes($data[1][4]));
-					}
-
-					if ($current == 'replace' &amp;&amp; 
-						(($mode == 'smilies' &amp;&amp; !empty($cur_img[$code])) || 
-						($mode == 'icons' &amp;&amp; !empty($cur_img[$img]))))
-					{
-						$replace_sql = ($mode == 'smilies') ? $code : $img;
-						$sql = array(
-							$fields . '_url'	=&gt;	$img,
-							$fields . '_height'	=&gt;	(int) $height,
-							$fields . '_width'	=&gt;	(int) $width,
-						);
-						if ($mode == 'smilies')
-						{
-							$sql = array_merge($sql, array(
-								'emotion'	=&gt;	$emotion
-							));
-						}
-
-						$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET &quot; . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . &quot; 
-							WHERE $field_sql = '&quot; . $_CLASS['core_db']-&gt;sql_escape($replace_sql) . &quot;'&quot;);
-					}
-					else
-					{
-						++$order;
-
-						$sql = array(
-							$fields . '_url'	=&gt;	$img,
-							$fields . '_height'	=&gt;	(int) $height,
-							$fields . '_width'	=&gt;	(int) $width,
-							$fields . '_order'	=&gt;	(int) $order,
-						);
-
-						if ($mode == 'smilies')
-						{
-							$sql = array_merge($sql, array(
-								'code'		=&gt;	$code,
-								'emotion'	=&gt;	$emotion
-							));
-						}
-						$_CLASS['core_db']-&gt;query(&quot;INSERT INTO $table &quot; . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql));
-					}
-
-				}
-			}
-
-			$_CLASS['core_cache']-&gt;destroy('icons');
-			trigger_error($_CLASS['core_user']-&gt;lang[$lang . '_IMPORT_SUCCESS']);
-		}
-		else
-		{
-			$pak_options = '';
-
-			foreach ($_paks as $pak)
-			{
-				$pak_options .= '&lt;option value=&quot;' . $pak . '&quot;&gt;' . htmlspecialchars($pak) . '&lt;/option&gt;';
-			}
-
-			adm_page_header($_CLASS['core_user']-&gt;lang[$lang]);
-
-?&gt;
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang] ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang .'_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_icons&amp;mode=' . $mode . '&amp;action=import', array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;tr&gt;
-	&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_IMPORT'] ?&gt;&lt;/th&gt;
-&lt;/tr&gt;
-&lt;?php
-
-			if ($pak_options == '')
-			{
-
-?&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_' . $lang . '_PAK']; ?&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;?php
-
-			}
-			else
-			{
-
-?&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_PACKAGE'] ?&gt;&lt;/td&gt;
-	&lt;td class=&quot;row1&quot;&gt;&lt;select name=&quot;pak&quot;&gt;&lt;?php echo $pak_options ?&gt;&lt;/select&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CURRENT_' . $lang] ?&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CURRENT_' . $lang . '_EXPLAIN'] ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;td class=&quot;row1&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;current&quot; value=&quot;keep&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['KEEP_ALL'] ?&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;current&quot; value=&quot;replace&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['REPLACE_MATCHES'] ?&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;current&quot; value=&quot;delete&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL'] ?&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; name=&quot;import&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMPORT_' . $lang] ?&gt;&quot; /&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-			adm_page_footer();
-
-		}
-		break;
-
-	case 'export':
-
-		adm_page_header($_CLASS['core_user']-&gt;lang['EXPORT_' . $lang]);
-		trigger_error(sprintf($_CLASS['core_user']-&gt;lang['EXPORT_' . $lang . '_EXPLAIN'], '&lt;a href=&quot;'.generate_link('Forums&amp;file=admin_icons&amp;mode=' . $mode . '&amp;action=send', array('admin' =&gt; true)).'&quot;&gt;', '&lt;/a&gt;'));
-		break;
-
-	case 'send':
-
-		$sql = &quot;SELECT * 
-			FROM $table
-			ORDER BY {$fields}_order&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$pak = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$pak .= &quot;'&quot; . addslashes($row[$fields . '_url']) . &quot;', &quot;;
-			$pak .= &quot;'&quot; . addslashes($row[$fields . '_height']) . &quot;', &quot;;
-			$pak .= &quot;'&quot; . addslashes($row[$fields . '_width']) . &quot;', &quot;;
-			if ($mode == 'smilies')
-			{
-				$pak .= &quot;'&quot; . addslashes($row['emotion']) . &quot;', &quot;;
-				$pak .= &quot;'&quot; . addslashes($row['code']) . &quot;', &quot;;
-			}
-			$pak .= &quot;\n&quot;;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if ($pak != '')
-		{
-			$_CLASS['core_db']-&gt;sql_close();
-
-			header('Content-Type: text/x-delimtext; name=&quot;' . $fields . '.pak&quot;');
-			header('Content-disposition: attachment; filename=' . $fields . '.pak&quot;');
-			echo $pak;
-			exit;
-		}
-		else
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_' . $fields . '_EXPORT']);
-		}
-		break;
-
-	case 'delete':
-
-		$_CLASS['core_db']-&gt;query(&quot;DELETE FROM $table 
-			WHERE {$fields}_id = $id&quot;);
-
-		switch ($mode)
-		{
-			case 'smilies':
-				break;
-
-			case 'icons':
-				// Reset appropriate icon_ids
-				$_CLASS['core_db']-&gt;query('UPDATE ' . TOPICS_TABLE . &quot; 
-					SET icon_id = 0 
-					WHERE icon_id = $id&quot;);
-				$_CLASS['core_db']-&gt;query('UPDATE ' . POSTS_TABLE . &quot; 
-					SET icon_id = 0 
-					WHERE icon_id = $id&quot;);
-				break;
-		}
-
-		$notice = $_CLASS['core_user']-&gt;lang[$lang . '_DELETED'];
-
-	case 'move_up':
-	case 'move_down':
-
-		if ($action != 'delete')
-		{
-			$image_order = intval($_GET['order']);
-			$order_total = $image_order * 2 + (($action == 'move_up') ? -1 : 1);
-
-			$sql = 'UPDATE ' . $table . '
-				SET ' . $fields . &quot;_order = $order_total - &quot; . $fields . '_order
-				WHERE ' . $fields . &quot;_order IN ($image_order, &quot; . (($action == 'move_up') ? $image_order - 1 : $image_order + 1) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$_CLASS['core_cache']-&gt;destroy('icons');
-
-		}
-		// No break; here, display the smilies admin back
-
-	default:
-
-		// By default, check that image_order is valid and fix it if necessary
-		$sql = &quot;SELECT {$fields}_id AS order_id, {$fields}_order AS fields_order
-			FROM $table
-			ORDER BY {$fields}_order&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$order = 0;
-			do
-			{
-				++$order;
-				if ($row['fields_order'] != $order)
-				{
-					$_CLASS['core_db']-&gt;query(&quot;UPDATE $table
-						SET {$fields}_order = $order
-						WHERE {$fields}_id = &quot; . $row['order_id']);
-				}
-			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		// Output the page
-		adm_page_header($_CLASS['core_user']-&gt;lang[$lang]);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang]; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang .'_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	if ($notice != '')
-	{
-
-?&gt;
-		&lt;b style=&quot;color:green&quot;&gt;&lt;?php echo $notice; ?&gt;&lt;/b&gt;
-&lt;?php
-	
-	}
-
-?&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_icons&amp;mode=' . $mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;tr&gt;
-	&lt;td align=&quot;right&quot;&gt; &nbsp;&nbsp; &lt;a href=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_icons&amp;mode=' . $mode . '&amp;action=import', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IMPORT_' . $lang]; ?&gt;&lt;/a&gt; | &lt;a href=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_icons&amp;mode=' . $mode . '&amp;action=export', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EXPORT_' . $lang]; ?&gt;&lt;/a&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;tr&gt;
-	&lt;td&gt;
-		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-		&lt;tr&gt;
-			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang]; ?&gt;&lt;/th&gt;
-&lt;?php
-			if ($mode == 'smilies')
-			{
-?&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['CODE']; ?&gt;&lt;/th&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EMOTION']; ?&gt;&lt;/th&gt;
-&lt;?php
-			}
-?&gt;
-			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION']; ?&gt;&lt;/th&gt;
-			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['REORDER']; ?&gt;&lt;/th&gt;
-		&lt;/tr&gt;
-&lt;?php
-		$spacer = FALSE;
-
-		$sql = &quot;SELECT * 
-			FROM $table
-			ORDER BY display_on_posting DESC, {$fields}_order ASC&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		
-		$row_class = 'row1';
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			if (!$spacer &amp;&amp; !$row['display_on_posting'])
-			{
-				$spacer = TRUE;
-?&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row3&quot; colspan=&quot;&lt;?php echo ($mode == 'smilies') ? 5 : 3; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$lang . '_NOT_DISPLAYED'] ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-&lt;?php
-			}
-
-			$row_class = ($row_class != 'row1') ? 'row1' : 'row2';
-			$alt_text = ($mode == 'smilies') ? htmlspecialchars($row['code']) : '';
-?&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;img src=&quot;&lt;?php echo $img_path . '/' . $row[$fields . '_url']; ?&gt;&quot; width=&quot;&lt;?php echo $row[$fields . '_width']; ?&gt;&quot; height=&quot;&lt;?php echo $row[$fields . '_height']; ?&gt;&quot; alt=&quot;&lt;?php echo $alt_text; ?&gt;&quot; title=&quot;&lt;?php echo $alt_text; ?&gt;&quot; /&gt;&lt;/td&gt;
-&lt;?php
-
-			if ($mode == 'smilies')
-			{
-?&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo htmlspecialchars($row['code']); ?&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['emotion']; ?&gt;&lt;/td&gt;
-&lt;?php
-			}
-?&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;Forums&amp;file=admin_icons&amp;mode=$mode&amp;action=edit&amp;id=&quot; . $row[$fields . '_id'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT']; ?&gt;&lt;/a&gt; | &lt;a href=&quot;&lt;?php echo generate_link(&quot;Forums&amp;file=admin_icons&amp;mode=$mode&amp;action=delete&amp;id=&quot; . $row[$fields . '_id'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-			&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link(&quot;Forums&amp;file=admin_icons&amp;mode=$mode&amp;action=move_up&amp;order=&quot; . $row[$fields . '_order'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_UP']; ?&gt;&lt;/a&gt; &lt;br /&gt; &lt;a href=&quot;&lt;?php echo generate_link(&quot;Forums&amp;file=admin_icons&amp;mode=$mode&amp;action=move_down&amp;order=&quot; . $row[$fields . '_order'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_DOWN']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-&lt;?php
-
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-?&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo ($mode == 'smilies') ? 5 : 3; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_' . $lang]; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;edit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT_' . $lang]; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;/table&gt;
-	&lt;/td&gt;
-&lt;/tr&gt;
-&lt;/table&gt;
-&lt;/form&gt;
-
-&lt;?php
-		adm_page_footer();
-
-		break;
-}
-
+&lt;?php
+/** 
+*
+* @package acp
+* @version $Id: admin_icons.php,v 1.14 2005/04/30 14:12:20 acydburn Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+/**
+*/
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// Do we have general permissions?
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_icons'))
+{
+	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+}
+
+$_CLASS['core_user']-&gt;add_lang('admin_posting', 'forums');
+
+// Set up general vars
+$action = request_var('action', '');
+$action = (isset($_POST['add'])) ? 'add' : $action;
+$action = (isset($_POST['edit'])) ? 'edit' : $action;
+$action = (isset($_POST['import'])) ? 'import' : $action;
+$icon_id = request_var('id', 0);
+
+$u_action = 'forums&amp;file=admin_icons';
+
+$page_title = 'ACP_ICONS';
+
+// Clear some arrays
+$_images = $_paks = array();
+$notice = '';
+
+// Grab file list of paks and images
+if ($action == 'edit' || $action == 'add' || $action == 'import')
+{
+	$imglist = filelist($config['icons_path'], '');
+
+	foreach ($imglist as $path =&gt; $img_ary)
+	{
+		foreach ($img_ary as $img)
+		{
+			$img_size = @getimagesize($config['icons_path'] . '/' . $path . $img);
+
+			if (!$img_size[0] || !$img_size[1])
+			{
+				continue;
+			}
+
+			$_images[$path . $img]['file'] = $path . $img;
+			$_images[$path . $img]['width'] = $img_size[0];
+			$_images[$path . $img]['height'] = $img_size[1];
+		}
+	}
+	unset($imglist);
+
+	$dir = @opendir($config['icons_path']);
+	while (($file = @readdir($dir)) !== false)
+	{
+		if (is_file($config['icons_path'] . '/' . $file) &amp;&amp; preg_match('#\.pak$#i', $file))
+		{
+			$_paks[] = $file;
+		}
+	}
+	@closedir($dir);
+}
+
+// What shall we do today? Oops, I believe that's trademarked ...
+switch ($action)
+{
+	case 'edit':
+		unset($_images);
+		$_images = array();
+
+	// no break;
+
+	case 'add':
+
+		$order_list = '';
+
+		$sql = 'SELECT * 
+			FROM '.FORUMS_ICONS_TABLE.'
+			ORDER BY icons_order ' . (($icon_id || $action == 'add') ? 'DESC' : 'ASC');
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$data = array();
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			if ($action == 'add')
+			{
+				unset($_images[$row['icons_url']]);
+			}
+
+			if ($row['icons_id'] == $icon_id)
+			{
+				$after = true;
+				$data[$row['icons_url']] = $row;
+			}
+			else
+			{
+				if ($action == 'edit' &amp;&amp; !$icon_id)
+				{
+					$data[$row['icons_url']] = $row;
+				}
+
+				$selected = '';
+				if (!empty($after))
+				{
+					$selected = ' selected=&quot;selected&quot;';
+					$after = false;
+				}
+
+				$after_txt = $row['icons_url'];
+				$order_list = '&lt;option value=&quot;' . ($row['icons_order']) . '&quot;' . $selected . '&gt;' . sprintf($_CLASS['core_user']-&gt;lang['AFTER_ICONS'], ' -&gt; ' . htmlspecialchars($after_txt)) . '&lt;/option&gt;' . $order_list;
+			}
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$order_list = '&lt;option value=&quot;1&quot;' . ((!isset($after)) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['FIRST'] . '&lt;/option&gt;' . $order_list;
+
+		if ($action === 'add')
+		{
+			$data = $_images;
+		}
+
+		$colspan = '5';
+		$colspan += ($icon_id) ? 1 : 0;
+		$colspan += ($action == 'add') ? 2 : 0;
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT'		=&gt; true,
+			'S_ADD'			=&gt; ($action === 'add') ? true : false,
+			'S_ORDER_LIST'	=&gt; $order_list,
+
+			'L_TITLE'		=&gt; $_CLASS['core_user']-&gt;lang['ACP_ICONS'],
+			'L_EXPLAIN'		=&gt; $_CLASS['core_user']-&gt;lang['ACP_ICONS_EXPLAIN'],
+			'L_CONFIG'		=&gt; $_CLASS['core_user']-&gt;lang['ICONS_CONFIG'],
+			'L_URL'			=&gt; $_CLASS['core_user']-&gt;lang['ICONS_URL'],
+			'L_LOCATION'	=&gt; $_CLASS['core_user']-&gt;lang['ICONS_LOCATION'],
+			'L_WIDTH'		=&gt; $_CLASS['core_user']-&gt;lang['ICONS_WIDTH'],
+			'L_HEIGHT'		=&gt; $_CLASS['core_user']-&gt;lang['ICONS_HEIGHT'],
+			'L_ORDER'		=&gt; $_CLASS['core_user']-&gt;lang['ICONS_ORDER'],
+
+			'COLSPAN'		=&gt; $colspan,
+			'ID'			=&gt; $icon_id,
+
+			'U_BACK'		=&gt; generate_link($u_action, array('admin' =&gt; true)),
+			'U_ACTION'		=&gt; generate_link($u_action . '&amp;action=' . (($action == 'add') ? 'create' : 'modify'), array('admin' =&gt; true)),
+		));
+
+		foreach ($data as $img =&gt; $img_row)
+		{
+			$_CLASS['core_template']-&gt;assign_vars_array('items', array(
+				'IMG'		=&gt; $img,
+				'IMG_SRC'	=&gt; $config['icons_path'] . '/' . $img,
+
+				'S_ID'				=&gt; (isset($img_row['icons_id'])) ? true : false,
+				'ID'				=&gt; (isset($img_row['icons_id'])) ? $img_row['icons_id'] : 0,
+				'WIDTH'				=&gt; (!empty($img_row['icons_width'])) ? $img_row['icons_width'] : $img_row['width'],
+				'HEIGHT'			=&gt; (!empty($img_row['icons_height'])) ? $img_row['icons_height'] : $img_row['height'],
+				'POSTING_CHECKED'	=&gt; (!empty($img_row['display_on_posting']) || $action === 'add') ? ' checked=&quot;checked&quot;' : '')
+			);
+		}
+
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_icons.html');
+
+		return;
+
+	break;
+
+	case 'create':
+	case 'modify':
+
+		// Get items to create/modify
+		$images = (isset($_POST['image'])) ? array_keys(request_var('image', array('' =&gt; 0))) : array();
+		
+		// Now really get the items
+		$image_id		= (isset($_POST['id'])) ? array_map('intval', $_POST['id']) : array();
+		$image_order	= (isset($_POST['order'])) ? array_map('intval', $_POST['order']) : array();
+		$image_width	= (isset($_POST['width'])) ? array_map('intval', $_POST['width']) : array();
+		$image_height	= (isset($_POST['height'])) ? array_map('intval', $_POST['height']) : array();
+		$image_add		= (isset($_POST['add_img'])) ? array_map('intval', $_POST['add_img']) : array();
+		$image_emotion	= request_var('emotion', array('' =&gt; ''));
+		$image_code		= request_var('code', array('' =&gt; ''));
+		$image_display_on_posting = (isset($_POST['display_on_posting'])) ? array_map('intval', $_POST['display_on_posting']) : array();
+
+		foreach ($images as $image)
+		{
+			if ($action == 'create' &amp;&amp; !isset($image_add[$image]))
+			{
+			}
+			else
+			{
+				if ($image_width[$image] == 0 || $image_height[$image] == 0)
+				{
+					$img_size = @getimagesize($config['icons_path'] . '/' . $image);
+					$image_width[$image] = $img_size[0];
+					$image_height[$image] = $img_size[1];
+				}
+
+				$img_sql = array(
+					'icons_url'				=&gt; $image,
+					'icons_width'			=&gt; $image_width[$image],
+					'icons_height'			=&gt; $image_height[$image],
+					'display_on_posting'	=&gt; (isset($image_display_on_posting[$image])) ? 1 : 0,
+				);
+
+				if (!empty($image_order[$image]))
+				{
+					$img_sql = array_merge($img_sql, array(
+						'icons_order'	=&gt;	$image_order[$image] . '.5')
+					);
+				}
+
+				if ($action == 'modify')
+				{
+					$sql = 'UPDATE '.FORUMS_ICONS_TABLE.'
+						SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $img_sql) . &quot; 
+						WHERE icons_id = &quot; . $image_id[$image];
+					$_CLASS['core_db']-&gt;query($sql);
+				}
+				else
+				{
+					$sql = 'INSERT INTO '.FORUMS_ICONS_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $img_sql);
+					$_CLASS['core_db']-&gt;query($sql);
+				}
+
+				$update = false;
+
+				if ($action == 'modify' &amp;&amp; !empty($image_order[$image]))
+				{
+					$update = true;
+
+					$sql = 'SELECT icons_order 
+						FROM '.FORUMS_ICONS_TABLE.'
+						WHERE icons_id = ' . $image_id[$image];
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$order_old = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+					$order_old = (int) $order_old['icons_order'];
+
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					if ($order_old == $image_order[$image])
+					{
+						$update = false;
+					}
+
+					if ($order_old &gt; $image_order[$image])
+					{
+						$sign = '+';
+						$where =  'icons_order &gt;= ' . $image_order[$image] . &quot; AND icons_order &lt; $order_old&quot;;
+					}
+					else if ($order_old &lt; $image_order[$image])
+					{
+						$sign = '-';
+						$where = &quot;icons_order &gt; $order_old AND icons_order &lt; &quot; . $image_order[$image];
+						$sql['icons_order'] = $image_order[$image] - 1;
+					}
+				}
+
+				if ($update)
+				{
+					$sql = 'UPDATE '.FORUMS_ICONS_TABLE.&quot;
+						SET icons_order = icons_order $sign 1
+						WHERE $where&quot;;
+					$_CLASS['core_db']-&gt;query($sql);
+				}
+			}
+		}
+		
+		$_CLASS['core_cache']-&gt;destroy('icons');
+
+		if ($action == 'modify')
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['ICONS_EDITED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
+		}
+		else
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['ICONS_ADDED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
+		}
+
+	break;
+
+	case 'import':
+
+		$pak = request_var('pak', '');
+		$current = request_var('current', '');
+
+		if ($pak != '')
+		{
+			$order = 0;
+
+			// The user has already selected a icon_pak file
+			if ($current == 'delete')
+			{
+				$_CLASS['core_db']-&gt;query('TRUNCATE TABLE '.FORUMS_ICONS_TABLE);
+
+				// Reset all icon_ids
+				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . ' SET icon_id = 0');
+				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . ' SET icon_id = 0');
+			}
+			else 
+			{
+				$cur_img = array();
+
+				$sql = 'SELECT icons_url
+					FROM '.FORUMS_ICONS_TABLE;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					++$order;
+					$cur_img[$row[$field_sql]] = 1;
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+
+			if (!($pak_ary = @file($config['icons_path'] . '/' . $pak)))
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['PAK_FILE_NOT_READABLE'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			foreach ($pak_ary as $pak_entry)
+			{
+				$data = array();
+				if (preg_match_all(&quot;#'(.*?)', #&quot;, $pak_entry, $data))
+				{
+					if (sizeof($data[1]) != 4)
+					{
+						trigger_error($_CLASS['core_user']-&gt;lang['WRONG_PAK_TYPE'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+					}
+
+					// Stripslash here because it got addslashed before... (on export)
+					$img = stripslashes($data[1][0]);
+					$width = stripslashes($data[1][1]);
+					$height = stripslashes($data[1][2]);
+					$display_on_posting = stripslashes($data[1][3]);
+
+					if (isset($data[1][4]) &amp;&amp; isset($data[1][5]))
+					{
+						$emotion = stripslashes($data[1][4]);
+						$code = stripslashes($data[1][5]);
+					}
+
+					if ($current == 'replace' &amp;&amp; !empty($cur_img[$img]))
+					{
+						$replace_sql = $img;
+						$sql = array(
+							'icons_url'		=&gt; $img,
+							'icons_height'		=&gt; (int) $height,
+							'icons_width'		=&gt; (int) $width,
+							'display_on_posting'	=&gt; (int) $display_on_posting,
+						);
+
+						$sql = 'UPDATE '.FORUMS_ICONS_TABLE.' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . &quot; 
+							WHERE $field_sql = '&quot; . $_CLASS['core_db']-&gt;escape($replace_sql) . &quot;'&quot;;
+						$_CLASS['core_db']-&gt;query($sql);
+					}
+					else
+					{
+						++$order;
+
+						$sql = array(
+							'icons_url'	=&gt; $img,
+							'icons_height'	=&gt; (int) $height,
+							'icons_width'	=&gt; (int) $width,
+							'icons_order'	=&gt; (int) $order,
+							'display_on_posting'=&gt; (int) $display_on_posting,
+						);
+
+						$_CLASS['core_db']-&gt;query('INSERT INTO '.FORUMS_ICONS_TABLE.' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql));
+					}
+				}
+			}
+
+			$_CLASS['core_cache']-&gt;destroy('icons');
+
+			trigger_error($_CLASS['core_user']-&gt;lang['ICONS_IMPORT_SUCCESS'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
+		}
+		else
+		{
+			$pak_options = '';
+
+			foreach ($_paks as $pak)
+			{
+				$pak_options .= '&lt;option value=&quot;' . $pak . '&quot;&gt;' . htmlspecialchars($pak) . '&lt;/option&gt;';
+			}
+
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'S_CHOOSE_PAK'		=&gt; true,
+				'S_PAK_OPTIONS'		=&gt; $pak_options,
+
+				'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['ACP_ICONS'],
+				'L_EXPLAIN'			=&gt; $_CLASS['core_user']-&gt;lang['ACP_ICONS_EXPLAIN'],
+				'L_NO_PAK_OPTIONS'	=&gt; $_CLASS['core_user']-&gt;lang['NO_ICONS_PAK'],
+				'L_CURRENT'			=&gt; $_CLASS['core_user']-&gt;lang['CURRENT_ICONS'],
+				'L_CURRENT_EXPLAIN'	=&gt; $_CLASS['core_user']-&gt;lang['CURRENT_ICONS_EXPLAIN'],
+				'L_IMPORT_SUBMIT'	=&gt; $_CLASS['core_user']-&gt;lang['IMPORT_ICONS'],
+
+				'U_BACK'		=&gt; generate_link($u_action, array('admin' =&gt; true)),
+				'U_ACTION'		=&gt; generate_link($u_action . '&amp;action=import', array('admin' =&gt; true)),
+			));
+		}
+	break;
+
+	case 'export':
+
+		$page_title = 'EXPORT_ICONS';
+		$tpl_name = 'message_body';
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'MESSAGE_TITLE'		=&gt; $_CLASS['core_user']-&gt;lang['EXPORT_ICONS'],
+			'MESSAGE_TEXT'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['EXPORT_ICONS_EXPLAIN'], '&lt;a href=&quot;' . generate_link($u_action . '&amp;action=send', array('admin' =&gt; true)).'&quot;&gt;', '&lt;/a&gt;'))
+		);
+
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_icons.html');
+
+	break;
+
+	case 'send':
+
+		$sql = 'SELECT * 
+			FROM '.FORUMS_ICONS_TABLE.'
+			ORDER BY icons_order';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$pak = '';
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$pak .= &quot;'&quot; . addslashes($row['icons_url']) . &quot;', &quot;;
+			$pak .= &quot;'&quot; . addslashes($row['icons_width']) . &quot;', &quot;;
+			$pak .= &quot;'&quot; . addslashes($row['icons_height']) . &quot;', &quot;;
+			$pak .= &quot;'&quot; . addslashes($row['display_on_posting']) . &quot;', &quot;;
+			$pak .= &quot;\n&quot;;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if ($pak != '')
+		{
+			garbage_collection();
+
+			header('Pragma: public');
+
+			// Send out the Headers
+			header('Content-Type: text/x-delimtext; name=&quot;icons.pak&quot;');
+			header('Content-Disposition: inline; filename=&quot;icons.pak&quot;');
+			echo $pak;
+
+			flush();
+			exit;
+		}
+		else
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_ICONS_EXPORT'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+		}
+
+	break;
+
+	case 'delete':
+		if (display_confirmation())
+		{
+			$sql = 'DELETE FROM '.FORUMS_ICONS_TABLE.'
+				WHERE icons_id = '.$icon_id;
+			$_CLASS['core_db']-&gt;query($sql);
+	
+			// Reset appropriate icon_ids
+			$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . &quot; 
+				SET icon_id = 0 
+				WHERE icon_id = $icon_id&quot;);
+	
+			$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . &quot; 
+				SET icon_id = 0 
+				WHERE icon_id = $icon_id&quot;);
+	
+			$notice = $_CLASS['core_user']-&gt;lang['ICONS_DELETED'];
+	
+			$_CLASS['core_cache']-&gt;destroy('icons');
+		}
+
+	break;
+
+	case 'move_up':
+	case 'move_down':
+
+		$image_order = request_var('order', 0);
+		$order_total = $image_order * 2 + (($action == 'move_up') ? -1 : 1);
+
+		$sql = 'UPDATE '.FORUMS_ICONS_TABLE.&quot;
+			SET icons_order = $order_total - icons_order
+			WHERE icons_order IN ($image_order, &quot; . (($action == 'move_up') ? $image_order - 1 : $image_order + 1) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		$_CLASS['core_cache']-&gt;destroy('icons');
+
+	break;
+}
+
+// By default, check that image_order is valid and fix it if necessary
+$sql = 'SELECT icons_id AS order_id, icons_order AS fields_order
+	FROM '.FORUMS_ICONS_TABLE.'
+	ORDER BY display_on_posting DESC, icons_order';
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$order = 0;
+	do
+	{
+		++$order;
+		if ($row['fields_order'] != $order)
+		{
+			$_CLASS['core_db']-&gt;query('UPDATE '.FORUMS_ICONS_TABLE.&quot;
+				SET icons_order = $order
+				WHERE icons_id = &quot; . $row['order_id']);
+		}
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['ACP_ICONS'],
+	'L_EXPLAIN'			=&gt; $_CLASS['core_user']-&gt;lang['ACP_' . 'ICONS_EXPLAIN'],
+	'L_IMPORT'			=&gt; $_CLASS['core_user']-&gt;lang['IMPORT_ICONS'],
+	'L_EXPORT'			=&gt; $_CLASS['core_user']-&gt;lang['EXPORT_ICONS'],
+	'L_NOT_DISPLAYED'	=&gt; $_CLASS['core_user']-&gt;lang['ICONS_NOT_DISPLAYED'],
+	'L_ICON_ADD'		=&gt; $_CLASS['core_user']-&gt;lang['ADD_ICONS'],
+	'L_ICON_EDIT'		=&gt; $_CLASS['core_user']-&gt;lang['EDIT_ICONS'],
+
+	'NOTICE'			=&gt; $notice,
+	'COLSPAN'			=&gt; 3,
+
+	'U_ACTION'			=&gt; generate_link($u_action, array('admin' =&gt; true)),
+	'U_IMPORT'			=&gt; generate_link($u_action . '&amp;action=import', array('admin' =&gt; true)),
+	'U_EXPORT'			=&gt; generate_link($u_action . '&amp;action=export', array('admin' =&gt; true)),
+));
+
+$spacer = false;
+
+$sql = 'SELECT * 
+	FROM '.FORUMS_ICONS_TABLE.'
+	ORDER BY icons_order ASC';
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+
+	$_CLASS['core_template']-&gt;assign_vars_array('items', array(
+		'S_SPACER'		=&gt; (!$spacer &amp;&amp; !$row['display_on_posting']) ? true : false,
+		'ALT_TEXT'		=&gt; '',
+		'IMG_SRC'		=&gt; $config['icons_path'] . '/' . $row['icons_url'],
+		'WIDTH'			=&gt; $row['icons_width'],
+		'HEIGHT'		=&gt; $row['icons_height'],
+		'CODE'			=&gt; (isset($row['code'])) ? $row['code'] : '',
+		'EMOTION'		=&gt; (isset($row['emotion'])) ? $row['emotion'] : '',
+		'U_EDIT'		=&gt; generate_link($u_action . '&amp;action=edit&amp;id=' . $row['icons_id'], array('admin' =&gt; true)),
+		'U_DELETE'		=&gt; generate_link($u_action . '&amp;action=delete&amp;id=' . $row['icons_id'], array('admin' =&gt; true)),
+		'U_MOVE_UP'		=&gt; generate_link($u_action . '&amp;action=move_up&amp;order=' . $row['icons_order'], array('admin' =&gt; true)),
+		'U_MOVE_DOWN'	=&gt; generate_link($u_action . '&amp;action=move_down&amp;order=' . $row['icons_order'], array('admin' =&gt; true))
+	));
+
+	if (!$spacer &amp;&amp; !$row['display_on_posting'])
+	{
+		$spacer = true;
+	}
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_icons.html');
+
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_jabber.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_jabber.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_jabber.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,196 +0,0 @@
-&lt;?php
-/** 
-*
-* @package acp
-* @version $Id: admin_jabber.php,v 1.9 2005/04/09 12:26:30 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-* @todo Check/enter/update transport info
-*/
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have general permissions?
-if (!$_CLASS['auth']-&gt;acl_get('a_server'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Grab some basic parameters
-$submit = (isset($_POST['submit'])) ? true : false;
-
-$jab_enable		= request_var('jab_enable', $config['jab_enable']);
-$jab_host		= request_var('jab_host', $config['jab_host']);
-$jab_port		= request_var('jab_port', $config['jab_port']);
-$jab_username	= request_var('jab_username', $config['jab_username']);
-$jab_password	= request_var('jab_password', $config['jab_password']);
-$jab_resource	= request_var('jab_resource', $config['jab_resource']);
-
-include($site_file_root.'includes/forums/functions_jabber.php');
-
-$jabber = new jabber();
-$error = array();
-
-// Setup the basis vars for jabber connection
-$jabber-&gt;server		= $jab_host;
-$jabber-&gt;port		= ($jab_port) ? $jab_port : 5222;
-$jabber-&gt;username	= $jab_username;
-$jabber-&gt;password	= $jab_password;
-$jabber-&gt;resource	= $jab_resource;
-
-// Are changing (or initialising) a new host or username? If so run some checks and 
-// try to create account if it doesn't exist
-if ($jab_enable)
-{
-	if ($jab_host != $config['jab_host'] || $jab_username != $config['jab_username'])
-	{
-		if (!$jabber-&gt;connect())
-		{
-			trigger_error('Could not connect to Jabber server', E_USER_ERROR);
-		}
-		// First we'll try to authorise using this account, if that fails we'll
-		// try to create it.
-		if (!($result = $jabber-&gt;send_auth()))
-		{
-			if (($result = $jabber-&gt;account_registration($config['board_email'], $_CORE_CONFIG['global']['site_name'])) &lt;&gt; 2)
-			{
-				$error[] = ($result == 1) ? $_CLASS['core_user']-&gt;lang['ERR_JAB_USERNAME'] : sprintf($_CLASS['core_user']-&gt;lang['ERR_JAB_REGISTER'], $result);
-			}
-			else
-			{
-				$message = $_CLASS['core_user']-&gt;lang['JAB_REGISTERED'];
-				$log = 'JAB_REGISTER';
-			}
-		}
-		else
-		{
-			$message = $_CLASS['core_user']-&gt;lang['JAB_CHANGED'];
-			$log = 'JAB_CHANGED';
-		}
-
-		sleep(1);
-		$jabber-&gt;disconnect();
-	}
-	else if ($jab_password != $config['jab_password'])
-	{echo 'test';
-		
-		if (!$jabber-&gt;connect())
-		{
-			trigger_error('Could not connect to Jabber server', E_USER_ERROR);
-		}
-
-		if (!$jabber-&gt;send_auth())
-		{
-			trigger_error('Could not authorise on Jabber server', E_USER_ERROR);
-		}
-		$jabber-&gt;send_presence(NULL, NULL, 'online');
-
-		if (($result = $jabber-&gt;change_password($jab_password))  &lt;&gt; 2)
-		{
-			$error[] = ($result == 1) ? $_CLASS['core_user']-&gt;lang['ERR_JAB_PASSCHG'] : sprintf($_CLASS['core_user']-&gt;lang['ERR_JAB_PASSFAIL'], $result);
-		}
-		else
-		{
-			$message = $_CLASS['core_user']-&gt;lang['JAB_PASS_CHANGED'];
-			$log = 'JAB_PASSCHG';
-		}
-
-		sleep(1);
-		$jabber-&gt;disconnect();
-	}
-}
-
-// Pull relevant config data
-$sql = 'SELECT *
-	FROM ' . CONFIG_TABLE . &quot;
-	WHERE config_name LIKE 'jab_%'&quot;;
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-{
-	$config_name = $row['config_name'];
-	$config_value = $row['config_value'];
-
-	$default_config[$config_name] = $config_value;
-	$new[$config_name] = (isset($_POST[$config_name])) ? request_var($config_name, '') : $default_config[$config_name];
-
-	if ($submit &amp;&amp; !sizeof($error))
-	{
-		set_config($config_name, $new[$config_name]);
-	}
-}
-
-if ($submit &amp;&amp; !sizeof($error))
-{
-	add_log('admin', 'LOG_' . $log);
-	trigger_error($message);
-}
-
-
-
-// Output the page
-adm_page_header($_CLASS['core_user']-&gt;lang['IM']);
-
-$jab_enable_yes		= ($new['jab_enable']) ? 'checked=&quot;checked&quot;' : '';
-$jab_enable_no		= (!$new['jab_enable']) ? 'checked=&quot;checked&quot;' : '';
-
-?&gt;
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IM']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IM_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_jabber', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IM']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if (sizeof($error))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_ENABLE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_ENABLE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;jab_enable&quot; value=&quot;1&quot;&lt;?php echo $jab_enable_yes; ?&gt; /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ENABLED']; ?&gt;&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;jab_enable&quot; value=&quot;0&quot;&lt;?php echo $jab_enable_no; ?&gt; /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISABLED']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_SERVER']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo sprintf($_CLASS['core_user']-&gt;lang['JAB_SERVER_EXPLAIN'], '&lt;a href=&quot;<A HREF="http://www.jabber.org/user/publicservers.php">http://www.jabber.org/user/publicservers.php</A>&quot; target=&quot;_blank&quot;&gt;', '&lt;/a&gt;'); ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jab_host&quot; value=&quot;&lt;?php echo $new['jab_host']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_PORT']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_PORT_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jab_port&quot; value=&quot;&lt;?php echo $new['jab_port']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_USERNAME']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_USERNAME_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jab_username&quot; value=&quot;&lt;?php echo $new['jab_username']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_PASSWORD']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jab_password&quot; value=&quot;&lt;?php echo $new['jab_password']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_RESOURCE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['JAB_RESOURCE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;jab_resource&quot; value=&quot;&lt;?php echo $new['jab_resource']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-	adm_page_footer();
-
-?&gt;
\ No newline at end of file

Added: cms/trunk/includes/forums/admin/admin_logs.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_logs.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_logs.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,138 @@
+&lt;?php
+// -------------------------------------------------------------
+//
+// $Id: admin_viewlogs.php,v 1.13 2004/11/06 14:11:47 acydburn Exp $
+//
+// FILENAME  : admin_viewlogs.php 
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : &#169; 2001, 2003 phpBB Group
+// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_'))
+{
+	trigger_error('NO_ADMIN');
+}
+
+$_CLASS['core_user']-&gt;add_lang('mcp', 'forums');
+
+// Set up general vars
+$action		= request_var('action', '');
+$mode		= request_var('mode', '');
+$forum_id	= request_var('f', 0);
+$start		= request_var('start', 0);
+$deletemark = isset($_POST['delmarked']) ? true : false;
+$deleteall	= isset($_POST['delall']) ? true : false;
+$marked		= request_var('mark', array(0));
+
+$u_action = 'forums&amp;file=admin_logs&amp;mode='.$mode;
+
+// Sort keys
+$sort_days	= request_var('st', 0);
+$sort_key	= request_var('sk', 't');
+$sort_dir	= request_var('sd', 'd');
+
+$log_type = constant('LOG_' . strtoupper($mode));
+
+// Delete entries if requested and able
+if (($deletemark || $deleteall) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_clearlogs'))
+{
+	$where_sql = '';
+
+	if ($deletemark &amp;&amp; sizeof($marked))
+	{
+		$sql_in = array();
+		foreach ($marked as $mark)
+		{
+			$sql_in[] = $mark;
+		}
+		$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
+		unset($sql_in);
+	}
+
+	if ($where_sql || $deleteall)
+	{
+		$sql = 'DELETE FROM ' . LOG_TABLE . &quot;
+			WHERE log_type = $log_type
+			$where_sql&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+
+		add_log('admin', 'LOG_CLEAR_' . strtoupper($mode));
+	}
+}
+
+// Sorting
+$limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_ENTRIES'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 365 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
+$sort_by_text = array('u' =&gt; $_CLASS['core_user']-&gt;lang['SORT_USERNAME'], 't' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DATE'], 'i' =&gt; $_CLASS['core_user']-&gt;lang['SORT_IP'], 'o' =&gt; $_CLASS['core_user']-&gt;lang['SORT_ACTION']);
+$sort_by_sql = array('u' =&gt; 'u.username', 't' =&gt; 'l.log_time', 'i' =&gt; 'l.log_ip', 'o' =&gt; 'l.log_operation');
+
+$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
+gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
+
+// Define where and sort sql for use in displaying logs
+$sql_where = ($sort_days) ? ($_CLASS['core_user']-&gt;time - ($sort_days * 86400)) : 0;
+$sql_sort = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
+
+$l_title = $_CLASS['core_user']-&gt;lang['ACP_' . strtoupper($mode) . '_LOGS'];
+$l_title_explain = $_CLASS['core_user']-&gt;lang['ACP_' . strtoupper($mode) . '_LOGS_EXPLAIN'];
+
+// Define forum list if we're looking @ mod logs
+if ($mode == 'mod')
+{
+	$forum_box = '&lt;option value=&quot;0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_FORUMS'] . '&lt;/option&gt;' . make_forum_select($forum_id);
+	
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_SHOW_FORUMS'			=&gt; true,
+		'S_FORUM_BOX'			=&gt; $forum_box
+	));
+}
+
+// Grab log data
+$log_data = array();
+$log_count = 0;
+view_log($mode, $log_data, $log_count, $config['topics_per_page'], $start, $forum_id, 0, 0, $sql_where, $sql_sort);
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'		=&gt; $l_title,
+	'L_EXPLAIN'		=&gt; $l_title_explain,
+	'U_ACTION'		=&gt; generate_link($u_action, array('admin' =&gt; true)),
+
+	'S_ON_PAGE'		=&gt; on_page($log_count, $config['topics_per_page'], $start),
+	'PAGINATION'	=&gt; generate_pagination($u_action . &quot;&amp;$u_sort_param&quot;, $log_count, $config['topics_per_page'], $start, true),
+
+	'S_LIMIT_DAYS'	=&gt; $s_limit_days,
+	'S_SORT_KEY'	=&gt; $s_sort_key,
+	'S_SORT_DIR'	=&gt; $s_sort_dir,
+	'S_CLEARLOGS'	=&gt; true,//$_CLASS['forums_auth']-&gt;acl_get('a_clearlogs'),
+));
+
+foreach ($log_data as $row)
+{
+	$data = array();
+		
+	$checks = array('viewtopic', 'viewlogs', 'viewforum');
+	foreach ($checks as $check)
+	{
+		if (isset($row[$check]) &amp;&amp; $row[$check])
+		{
+			$data[] = '&lt;a href=&quot;' . $row[$check] . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['LOGVIEW_' . strtoupper($check)] . '&lt;/a&gt;';
+		}
+	}
+
+	$_CLASS['core_template']-&gt;assign_vars_array('log', array(
+		'USERNAME'			=&gt; $row['username'],
+		'REPORTEE_USERNAME'	=&gt; ($row['reportee_username'] &amp;&amp; $row['user_id'] != $row['reportee_id']) ? $row['reportee_username'] : '',
+
+		'IP'				=&gt; $row['ip'],
+		'DATE'				=&gt; $_CLASS['core_user']-&gt;format_date($row['time']),
+		'ACTION'			=&gt; $row['action'],
+		'DATA'				=&gt; (sizeof($data)) ? implode(' | ', $data) : '',
+		'ID'				=&gt; $row['id'],
+	));
+}
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($l_title), 'modules/forums/admin/acp_logs.html');
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/includes/forums/admin/admin_permission_roles.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_permission_roles.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_permission_roles.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,534 @@
+&lt;?php
+/** 
+*
+* @package acp
+* @version $Id: acp_permission_roles.php,v 1.12 2006/08/28 15:50:31 acydburn Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+/**
+* @package acp
+*/
+
+load_class(SITE_FILE_ROOT.'includes/forums/admin/auth.php', 'forums_auth_admin');
+
+$_CLASS['core_user']-&gt;add_lang('admin_permissions');
+$_CLASS['core_user']-&gt;add_lang('admin_permissions_phpbb');
+
+$submit = (isset($_POST['submit'])) ? true : false;
+$role_id = request_var('role_id', 0);
+$action = request_var('action', '');
+$action = (isset($_POST['add'])) ? 'add' : $action;
+$mode = request_var('mode', '');
+
+$u_action = 'forums&amp;file=admin_permission_roles&amp;mode='.$mode;
+
+switch ($mode)
+{
+	case 'admin_roles':
+		$permission_type = 'a_';
+		$page_title = 'ACP_ADMIN_ROLES';
+	break;
+
+	case 'user_roles':
+		$permission_type = 'u_';
+		$page_title = 'ACP_USER_ROLES';
+	break;
+
+	case 'mod_roles':
+		$permission_type = 'm_';
+		$page_title = 'ACP_MOD_ROLES';
+	break;
+
+	case 'forum_roles':
+		$permission_type = 'f_';
+		$page_title = 'ACP_FORUM_ROLES';
+	break;
+
+	default:
+		trigger_error('INVALID_MODE', E_USER_ERROR);
+	break;
+}
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'		=&gt; $_CLASS['core_user']-&gt;lang[$page_title],
+	'L_EXPLAIN'		=&gt; $_CLASS['core_user']-&gt;lang[$page_title . '_EXPLAIN'])
+);
+
+// Take action... admin submitted something
+if ($submit || $action === 'remove')
+{
+	switch ($action)
+	{
+		case 'remove':
+
+			if (!$role_id)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			$sql = 'SELECT *
+				FROM ' . FORUMS_ACL_ROLES_TABLE . '
+				WHERE role_id = ' . $role_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$role_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$role_row)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			$hidden_fields = generate_hidden_fields(array(
+				'i'			=&gt; $id,
+				'mode'		=&gt; $mode,
+				'role_id'	=&gt; $role_id,
+				'action'	=&gt; $action,
+			));
+
+			if (display_confirmation('DELETE_ROLE', $hidden_fields))
+			{
+				remove_role($role_id, $permission_type);
+
+				add_log('admin', 'LOG_' . strtoupper($permission_type) . 'ROLE_REMOVED', $role_row['role_name']);
+				trigger_error($_CLASS['core_user']-&gt;lang['ROLE_DELETED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
+			}
+
+		break;
+
+		case 'edit':
+			if (!$role_id)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			// Get role we edit
+			$sql = 'SELECT *
+				FROM ' . FORUMS_ACL_ROLES_TABLE . '
+				WHERE role_id = ' . $role_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$role_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$role_row)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+		// no break;
+
+		case 'add':
+
+			$role_name = request_var('role_name', '', true);
+			$role_description = request_var('role_description', '', true);
+			$auth_settings = request_var('setting', array('' =&gt; 0));
+
+			if (!$role_name)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_NAME_SPECIFIED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			// if we add/edit a role we check the name to be unique among the settings...
+			$sql = 'SELECT role_id
+				FROM ' . FORUMS_ACL_ROLES_TABLE . &quot;
+				WHERE role_type = '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;'
+					AND LOWER(role_name) = '&quot; . $_CLASS['core_db']-&gt;escape(strtolower($role_name)) . &quot;'&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			// Make sure we only print out the error if we add the role or change it's name
+			if ($row &amp;&amp; ($mode === 'add' || ($mode === 'edit' &amp;&amp; strtolower($role_row['role_name']) != strtolower($role_name))))
+			{
+				trigger_error(sprintf($_CLASS['core_user']-&gt;lang['ROLE_NAME_ALREADY_EXIST'], $role_name) . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+
+			$sql_ary = array(
+				'role_name'			=&gt; (string) $role_name,
+				'role_description'	=&gt; (string) $role_description,
+				'role_type'			=&gt; (string) $permission_type,
+			);
+
+			if ($action === 'edit')
+			{
+				$sql = 'UPDATE ' . FORUMS_ACL_ROLES_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
+					WHERE role_id = ' . $role_id;
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			else
+			{
+				// Get maximum role order for inserting a new role...
+				$sql = 'SELECT MAX(role_order) as max_order
+					FROM ' . FORUMS_ACL_ROLES_TABLE . &quot;
+					WHERE role_type = '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;'&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+				$max_order = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				$max_order = (int) $max_order['max_order'];
+
+				$sql_ary['role_order'] = $max_order + 1;
+
+				$sql = 'INSERT INTO ' . FORUMS_ACL_ROLES_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary);
+				$_CLASS['core_db']-&gt;query($sql);
+
+				$role_id = $_CLASS['core_db']-&gt;insert_id(FORUMS_ACL_ROLES_TABLE, 'role_id');
+			}
+
+			// Now add the auth settings
+			$_CLASS['forums_auth_admin']-&gt;acl_set_role($role_id, $auth_settings);
+
+			add_log('admin', 'LOG_' . strtoupper($permission_type) . 'ROLE_' . strtoupper($action), $role_name);
+
+			trigger_error($_CLASS['core_user']-&gt;lang['ROLE_' . strtoupper($action) . '_SUCCESS'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
+
+		break;
+	}
+}
+
+// Display screens
+switch ($action)
+{
+	case 'add':
+
+		$options_from = request_var('options_from', 0);
+
+		$role_row = array(
+			'role_name'			=&gt; request_var('role_name', '', true),
+			'role_description'	=&gt; request_var('role_description', '', true),
+			'role_type'			=&gt; $permission_type,
+		);
+
+		if ($options_from)
+		{
+			$sql = 'SELECT p.auth_option_id, p.auth_setting, o.auth_option
+				FROM ' . FORUMS_ACL_ROLES_DATA_TABLE . ' p, ' . FORUMS_ACL_OPTIONS_TABLE . ' o
+				WHERE o.auth_option_id = p.auth_option_id
+					AND p.role_id = ' . $options_from . '
+				ORDER BY p.auth_option_id';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$auth_options = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$auth_options[$row['auth_option']] = $row['auth_setting'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+		else
+		{
+			$sql = 'SELECT auth_option_id, auth_option
+				FROM ' . FORUMS_ACL_OPTIONS_TABLE . &quot;
+				WHERE auth_option LIKE '{$permission_type}%'
+					AND auth_option &lt;&gt; '{$permission_type}'
+				ORDER BY auth_option_id&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$auth_options = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$auth_options[$row['auth_option']] = ACL_NO;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+	// no break;
+
+	case 'edit':
+
+		if ($action == 'edit')
+		{
+			if (!$role_id)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+			}
+			
+			$sql = 'SELECT *
+				FROM ' . FORUMS_ACL_ROLES_TABLE . '
+				WHERE role_id = ' . $role_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$role_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$sql = 'SELECT p.auth_option_id, p.auth_setting, o.auth_option
+				FROM ' . FORUMS_ACL_ROLES_DATA_TABLE . ' p, ' . FORUMS_ACL_OPTIONS_TABLE . ' o
+				WHERE o.auth_option_id = p.auth_option_id
+					AND p.role_id = ' . $role_id . '
+				ORDER BY p.auth_option_id';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$auth_options = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$auth_options[$row['auth_option']] = $row['auth_setting'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		if (!$role_row)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_ROLE_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+		}
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT'			=&gt; true,
+
+			'U_ACTION'			=&gt; generate_link($u_action . &quot;&amp;action={$action}&amp;role_id={$role_id}&quot;, array('admin' =&gt; true)),
+			'U_BACK'			=&gt; generate_link($u_action, array('admin' =&gt; true)),
+
+			'ROLE_NAME'			=&gt; $role_row['role_name'],
+			'ROLE_DESCRIPTION'	=&gt; $role_row['role_description'],
+			'L_ACL_TYPE'		=&gt; $_CLASS['core_user']-&gt;lang['ACL_TYPE_' . strtoupper($permission_type)],
+			)
+		);
+
+		// We need to fill the auth options array with ACL_NO options ;)
+		$sql = 'SELECT auth_option_id, auth_option
+			FROM ' . FORUMS_ACL_OPTIONS_TABLE . &quot;
+			WHERE auth_option LIKE '{$permission_type}%'
+				AND auth_option &lt;&gt; '{$permission_type}'
+			ORDER BY auth_option_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			if (!isset($auth_options[$row['auth_option']]))
+			{
+				$auth_options[$row['auth_option']] = ACL_NO;
+			}
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		// Unset global permission option
+		unset($auth_options[$permission_type]);
+
+		// Display auth options
+		display_auth_options($auth_options);
+
+		// Get users/groups/forums using this preset...
+		if ($action == 'edit')
+		{
+			$hold_ary = $_CLASS['forums_auth_admin']-&gt;get_role_mask($role_id);
+
+			if (sizeof($hold_ary))
+			{
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'S_DISPLAY_ROLE_MASK'	=&gt; true,
+					'L_ROLE_ASSIGNED_TO'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['ROLE_ASSIGNED_TO'], $role_row['role_name']))
+				);
+
+				$_CLASS['forums_auth_admin']-&gt;display_role_mask($hold_ary);
+			}
+		}
+
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_permission_roles.html');
+
+		return;
+	break;
+
+	case 'move_up':
+	case 'move_down':
+
+		$order = request_var('order', 0);
+		$order_total = $order * 2 + (($action == 'move_up') ? -1 : 1);
+
+		$sql = 'UPDATE ' . FORUMS_ACL_ROLES_TABLE . '
+			SET role_order = ' . $order_total  . &quot; - role_order
+			WHERE role_type = '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;'
+				AND role_order IN ($order, &quot; . (($action == 'move_up') ? $order - 1 : $order + 1) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+	break;
+}
+
+// By default, check that role_order is valid and fix it if necessary
+$sql = 'SELECT role_id, role_order
+	FROM ' . FORUMS_ACL_ROLES_TABLE . &quot;
+	WHERE role_type = '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;'
+	ORDER BY role_order ASC&quot;;
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$order = 0;
+	do
+	{
+		$order++;
+		if ($row['role_order'] != $order)
+		{
+			$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_ACL_ROLES_TABLE . &quot; SET role_order = $order WHERE role_id = {$row['role_id']}&quot;);
+		}
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+// Display assigned items?
+$display_item = request_var('display_item', 0);
+
+// Select existing roles
+$sql = 'SELECT *
+	FROM ' . FORUMS_ACL_ROLES_TABLE . &quot;
+	WHERE role_type = '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;'
+	ORDER BY role_order ASC&quot;;
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+$s_role_options = '';
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign_vars_array('roles', array(
+		'ROLE_NAME'				=&gt; $row['role_name'],
+		'ROLE_DESCRIPTION'		=&gt; (!empty($_CLASS['core_user']-&gt;lang[$row['role_description']])) ? $_CLASS['core_user']-&gt;lang[$row['role_description']] : nl2br($row['role_description']),
+
+		'U_EDIT'			=&gt; generate_link($u_action . '&amp;action=edit&amp;role_id=' . $row['role_id'], array('admin' =&gt; true)),
+		'U_REMOVE'			=&gt; generate_link($u_action . '&amp;action=remove&amp;role_id=' . $row['role_id'], array('admin' =&gt; true)),
+		'U_MOVE_UP'			=&gt; generate_link($u_action . '&amp;action=move_up&amp;order=' . $row['role_order'], array('admin' =&gt; true)),
+		'U_MOVE_DOWN'		=&gt; generate_link($u_action . '&amp;action=move_down&amp;order=' . $row['role_order'], array('admin' =&gt; true)),
+		'U_DISPLAY_ITEMS'	=&gt; ($row['role_id'] == $display_item) ? '' : generate_link($u_action . '&amp;display_item=' . $row['role_id'] . '#assigned_to', array('admin' =&gt; true))
+	));
+
+	$s_role_options .= '&lt;option value=&quot;' . $row['role_id'] . '&quot;&gt;' . $row['role_name'] . '&lt;/option&gt;';
+
+	if ($display_item == $row['role_id'])
+	{
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'L_ROLE_ASSIGNED_TO'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['ROLE_ASSIGNED_TO'], $row['role_name']))
+		);
+	}
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'S_ROLE_OPTIONS'		=&gt; $s_role_options)
+);
+
+if ($display_item)
+{
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_DISPLAY_ROLE_MASK'	=&gt; true)
+	);
+
+	$hold_ary = $_CLASS['forums_auth_admin']-&gt;get_role_mask($display_item);
+	$_CLASS['forums_auth_admin']-&gt;display_role_mask($hold_ary);
+}
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_permission_roles.html');
+
+/**
+* Display permission settings able to be set
+*/
+function display_auth_options($auth_options)
+{
+	global $_CLASS;
+
+	$content_array = $categories = array();
+	$key_sort_array = array(0);
+	$auth_options = array(0 =&gt; $auth_options);
+
+	// Making use of auth_admin method here (we do not really want to change two similar code fragments)
+	$_CLASS['forums_auth_admin']-&gt;build_permission_array($auth_options, $content_array, $categories, $key_sort_array);
+
+	$content_array = $content_array[0];
+
+	$_CLASS['core_template']-&gt;assign('S_NUM_PERM_COLS', sizeof($categories));
+
+	// Assign to template
+	foreach ($content_array as $cat =&gt; $cat_array)
+	{
+		$auth = array(
+			'CAT_NAME'	=&gt; $_CLASS['core_user']-&gt;lang['permission_cat'][$cat],
+
+			'S_YES'		=&gt; ($cat_array['S_YES'] &amp;&amp; !$cat_array['S_NEVER'] &amp;&amp; !$cat_array['S_NO']) ? true : false,
+			'S_NEVER'	=&gt; ($cat_array['S_NEVER'] &amp;&amp; !$cat_array['S_YES'] &amp;&amp; !$cat_array['S_NO']) ? true : false,
+			'S_NO'		=&gt; ($cat_array['S_NO'] &amp;&amp; !$cat_array['S_NEVER'] &amp;&amp; !$cat_array['S_YES']) ? true : false
+		);
+
+		foreach ($cat_array['permissions'] as $permission =&gt; $allowed)
+		{
+			$auth['mask'][] = array(
+				'S_YES'		=&gt; ($allowed == ACL_YES) ? true : false,
+				'S_NEVER'	=&gt; ($allowed == ACL_NEVER) ? true : false,
+				'S_NO'		=&gt; ($allowed == ACL_NO) ? true : false,
+
+				'FIELD_NAME'	=&gt; $permission,
+				'PERMISSION'	=&gt; $_CLASS['core_user']-&gt;lang['acl_' . $permission]['lang']
+			);
+		}
+		$_CLASS['core_template']-&gt;assign_vars_array('auth', $auth);
+	}
+}
+
+/**
+* Remove role
+*/
+function remove_role($role_id, $permission_type)
+{
+	global $_CLASS;
+
+	$auth_admin = new forums_auth_admin();
+
+	// Get complete auth array
+	$sql = 'SELECT auth_option, auth_option_id
+		FROM ' . FORUMS_ACL_OPTIONS_TABLE . &quot;
+		WHERE auth_option LIKE '&quot; . $_CLASS['core_db']-&gt;escape($permission_type) . &quot;%'&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$auth_settings = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$auth_settings[$row['auth_option']] = ACL_NO;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	// Get the role auth settings we need to re-set...
+	$sql = 'SELECT o.auth_option, r.auth_setting
+		FROM ' . FORUMS_ACL_ROLES_DATA_TABLE . ' r, ' . FORUMS_ACL_OPTIONS_TABLE . ' o
+		WHERE o.auth_option_id = r.auth_option_id
+			AND r.role_id = ' . $role_id;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$auth_settings[$row['auth_option']] = $row['auth_setting'];
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	// Get role assignments
+	$hold_ary = $auth_admin-&gt;get_role_mask($role_id);
+
+	// Re-assign permissions
+	foreach ($hold_ary as $forum_id =&gt; $forum_ary)
+	{
+		if (isset($forum_ary['users']))
+		{
+			$auth_admin-&gt;acl_set('user', $forum_id, $forum_ary['users'], $auth_settings, 0, false);
+		}
+
+		if (isset($forum_ary['groups']))
+		{
+			$auth_admin-&gt;acl_set('group', $forum_id, $forum_ary['groups'], $auth_settings, 0, false);
+		}
+	}
+
+	// Remove role from users and groups just to be sure (happens through acl_set)
+	$sql = 'DELETE FROM ' . FORUMS_ACL_TABLE . '
+		WHERE auth_role_id = ' . $role_id;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	// Remove role data and role
+	$sql = 'DELETE FROM ' . FORUMS_ACL_ROLES_DATA_TABLE . '
+		WHERE role_id = ' . $role_id;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$sql = 'DELETE FROM ' . FORUMS_ACL_ROLES_TABLE . '
+		WHERE role_id = ' . $role_id;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$auth_admin-&gt;acl_clear_prefetch();
+}
+
+
+?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_permissions.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_permissions.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -15,9 +15,10 @@
 	die; 
 }
 
-$u_action = '';
 $permission_dropdown = '';
 $mode = request_var('mode', 'view_forum_local');
+
+$u_action = 'forums&amp;file=admin_permissions&amp;mode='.$mode;
 
 load_class(SITE_FILE_ROOT.'includes/forums/admin/auth.php', 'forums_auth_admin');
 
@@ -88,19 +89,21 @@
 {
 	$username = explode(&quot;\n&quot;, $usernames);
 }
-unset($usernames);
-
-if (sizeof($username) &amp;&amp; !sizeof($user_id))
+unset($usernames);
+
+if (count($username) &amp;&amp; !count($user_id))
 {
-	user_get_id_name($user_id, $username);
+	require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+	$user_id = user_get_id($username, $difference);
 
-	if (!sizeof($user_id))
+	if (count($username) === count($difference))
 	{
-		trigger_error($_CLASS['core_user']-&gt;lang['SELECTED_USER_NOT_EXIST'] . adm_back_link($u_action));
+		trigger_error($_CLASS['core_user']-&gt;lang['SELECTED_USER_NOT_EXIST'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 	}
 }
-unset($username);
-
+unset($username);
+	
 // Build forum ids (of all forums are checked or subforum listing used)
 if ($all_forums)
 {
@@ -216,7 +219,7 @@
 
 if (!in_array($permission_type, $permission_dropdown))
 {
-	trigger_error($_CLASS['core_user']-&gt;lang['WRONG_PERMISSION_TYPE'] . adm_back_link($u_action));
+	trigger_error($_CLASS['core_user']-&gt;lang['WRONG_PERMISSION_TYPE'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
 
@@ -250,14 +253,14 @@
 			}
 			else
 			{
-				trigger_error($_CLASS['core_user']-&gt;lang['NO_USER_GROUP_SELECTED'] . adm_back_link($u_action));
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_USER_GROUP_SELECTED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 			}
 		break;
 
 		case 'apply_permissions':
 			if (!isset($_POST['setting']))
 			{
-				trigger_error($_CLASS['core_user']-&gt;lang['NO_AUTH_SETTING_FOUND'] . adm_back_link($u_action));
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_AUTH_SETTING_FOUND'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 			}
 
 			set_permissions($mode, $permission_type, $_CLASS['forums_auth_admin'], $user_id, $group_id);
@@ -266,7 +269,7 @@
 		case 'apply_all_permissions':
 			if (!isset($_POST['setting']))
 			{
-				trigger_error($_CLASS['core_user']-&gt;lang['NO_AUTH_SETTING_FOUND'] . adm_back_link($u_action));
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_AUTH_SETTING_FOUND'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 			}
 
 			set_all_permissions($mode, $permission_type, $_CLASS['forums_auth_admin'], $user_id, $group_id);
@@ -344,6 +347,7 @@
 			$_CLASS['core_template']-&gt;assign_array(array(
 				'S_SELECT_USER'			=&gt; true,
 				'U_FIND_USERNAME'		=&gt; generate_link('members_list&amp;mode=searchuser&amp;form=select_victim&amp;field=username')
+				'UA_FIND_USERNAME'		=&gt; generate_link('members_list&amp;mode=searchuser&amp;form=select_victim&amp;field=username')
 			));
 
 		break;
@@ -406,16 +410,22 @@
 				'S_DEFINED_GROUP_OPTIONS'	=&gt; $items['group_ids_options'],
 				'S_ADD_GROUP_OPTIONS'		=&gt; group_select_options(false, $items['group_ids']),
 				'U_FIND_USERNAME'			=&gt; generate_link('members_list&amp;mode=searchuser&amp;form=add_user&amp;field=username')
+				'UA_FIND_USERNAME'			=&gt; generate_link('members_list&amp;mode=searchuser&amp;form=add_user&amp;field=username')
 			));
 
 		break;
-	}
+	}
+	
+	// The S_ALLOW_SELECT parameter below is a measure to lower memory usage.
+	// If there are more than 5 forums selected the admin is not able to select all users/groups too.
+	// We need to see if the number of forums can be increased or need to be decreased.
 
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'U_ACTION'				=&gt; $u_action,
+		'U_ACTION'				=&gt; generate_link($u_action, array('admin' =&gt; true)),
 		'ANONYMOUS_USER_ID'		=&gt; ANONYMOUS,
 
-		'S_SELECT_VICTIM'		=&gt; true,
+		'S_SELECT_VICTIM'		=&gt; true,
+		'S_ALLOW_ALL_SELECT'	=&gt; (sizeof($forum_id) &gt; 5) ? false : true,
 		'S_CAN_SELECT_USER'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers')) ? true : false,
 		'S_CAN_SELECT_GROUP'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('a_authgroups')) ? true : false,
 		'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields
@@ -451,14 +461,14 @@
 // Do not allow forum_ids being set and no other setting defined (will bog down the server too much)
 if (sizeof($forum_id) &amp;&amp; !sizeof($user_id) &amp;&amp; !sizeof($group_id))
 {
-	trigger_error($_CLASS['core_user']-&gt;lang['ONLY_FORUM_DEFINED'] . adm_back_link($u_action));
+	trigger_error($_CLASS['core_user']-&gt;lang['ONLY_FORUM_DEFINED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
 $_CLASS['core_template']-&gt;assign_array(array(
 	'S_PERMISSION_DROPDOWN'		=&gt; (sizeof($permission_dropdown) &gt; 1) ? build_permission_dropdown($permission_dropdown, $permission_type) : false,
 	'L_PERMISSION_TYPE'			=&gt; $_CLASS['core_user']-&gt;get_lang('ACL_TYPE_' . strtoupper($permission_type)),
 
-	'U_ACTION'					=&gt; $u_action,
+	'U_ACTION'					=&gt; generate_link($u_action, array('admin' =&gt; true)),
 	'S_HIDDEN_FIELDS'			=&gt; $s_hidden_fields
 ));
 
@@ -583,7 +593,7 @@
 
 	if (!sizeof($ids))
 	{
-		trigger_error($_CLASS['core_user']-&gt;lang['SELECTED_' . strtoupper($mode) . '_NOT_EXIST'] . adm_back_link($u_action));
+		trigger_error($_CLASS['core_user']-&gt;lang['SELECTED_' . strtoupper($mode) . '_NOT_EXIST'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 	}
 }
 
@@ -602,7 +612,7 @@
 	// Check the permission setting again
 	if (!$_CLASS['forums_auth']-&gt;acl_get('a_' . str_replace('_', '', $permission_type) . 'auth') || !$_CLASS['forums_auth']-&gt;acl_get('a_auth' . $ug_type . 's'))
 	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link($u_action));
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 	}
 	
 	$ug_id = $forum_id = 0;
@@ -665,7 +675,7 @@
 
 	log_action($mode, 'add', $permission_type, $ug_type, $ug_id, $forum_id);
 
-	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link($u_action));
+	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
 /** 
@@ -681,7 +691,7 @@
 	// Check the permission setting again
 	if (!$_CLASS['forums_auth']-&gt;acl_get('a_' . str_replace('_', '', $permission_type) . 'auth') || !$_CLASS['forums_auth']-&gt;acl_get('a_auth' . $ug_type . 's'))
 	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link($u_action));
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 	}
 
 	$auth_settings = (isset($_POST['setting'])) ? $_POST['setting'] : array();
@@ -732,7 +742,7 @@
 
 	log_action($mode, 'add', $permission_type, $ug_type, $ug_ids, $forum_ids);
 
-	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link($u_action));
+	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
 /**
@@ -786,7 +796,7 @@
 	// Check the permission setting again
 	if (!$_CLASS['forums_auth']-&gt;acl_get('a_' . str_replace('_', '', $permission_type) . 'auth') || !$_CLASS['forums_auth']-&gt;acl_get('a_auth' . $ug_type . 's'))
 	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link($u_action));
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 	}
 
 	$forums_auth_admin-&gt;acl_delete($ug_type, (($ug_type == 'user') ? $user_id : $group_id), (sizeof($forum_id) ? $forum_id : false), $permission_type);
@@ -799,7 +809,7 @@
 
 	log_action($mode, 'del', $permission_type, $ug_type, (($ug_type == 'user') ? $user_id : $group_id), (sizeof($forum_id) ? $forum_id : array(0 =&gt; 0)));
 
-	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link($u_action));
+	trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 }
 
 /**
@@ -857,32 +867,6 @@
 }
 
 /**
-* Update foes - remove moderators and administrators from foe lists...
-*/
-function update_foes()
-{
-	global $_CLASS;
-
-	$perms = array();
-	foreach ($_CLASS['forums_auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
-	{
-		foreach ($forum_ary as $auth_option =&gt; $user_ary)
-		{
-			$perms = array_merge($perms, $user_ary);
-		}
-	}
-
-	if (sizeof($perms))
-	{
-		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-			WHERE zebra_id IN (' . implode(', ', array_unique($perms)) . ')
-				AND foe = 1';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	unset($perms);
-}
-
-/**
 * Display a complete trace tree for the selected permission to determine where settings are set/unset
 */
 function permission_trace($user_id, $forum_id, $permission)
@@ -929,7 +913,7 @@
 		'U_BACK'				=&gt; ($back) ? build_url(array('f', 'back')) . &quot;&amp;f=$back&quot; : '')
 	);
 
-	$template-&gt;assign_block_vars('trace', array(
+	$_CLASS['core_template']-&gt;assign_vars_array('trace', array(
 		'WHO'			=&gt; $_CLASS['core_user']-&gt;lang['DEFAULT'],
 		'INFORMATION'	=&gt; $_CLASS['core_user']-&gt;lang['TRACE_DEFAULT'],
 
@@ -986,7 +970,7 @@
 				break;
 			}
 
-			$template-&gt;assign_block_vars('trace', array(
+			$_CLASS['core_template']-&gt;assign_vars_array('trace', array(
 				'WHO'			=&gt; $row['group_name'],
 				'INFORMATION'	=&gt; $information,
 
@@ -1022,7 +1006,7 @@
 		break;
 	}
 
-	$template-&gt;assign_block_vars('trace', array(
+	$_CLASS['core_template']-&gt;assign_vars_array('trace', array(
 		'WHO'			=&gt; $userdata['username'],
 		'INFORMATION'	=&gt; $information,
 
@@ -1058,9 +1042,9 @@
 			$information = $_CLASS['core_user']-&gt;lang['TRACE_USER_GLOBAL_NEVER_TOTAL_KEPT'];
 		}
 
-		$template-&gt;assign_block_vars('trace', array(
+		$_CLASS['core_template']-&gt;assign_vars_array('trace', array(
 			'WHO'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['TRACE_GLOBAL_SETTING'], $userdata['username']),
-			'INFORMATION'	=&gt; sprintf($information, '&lt;a href=&quot;' . $u_action . &quot;&amp;u=$user_id&amp;f=0&amp;auth=$permission&amp;back=$forum_id\&quot;&gt;&quot;, '&lt;/a&gt;'),
+			'INFORMATION'	=&gt; sprintf($information, '&lt;a href=&quot;' . generate_link(&quot;$u_action&amp;u=$user_id&amp;f=0&amp;auth=$permission&amp;back=$forum_id&quot;, array('admin' =&gt; true)) . '&quot;&gt;', '&lt;/a&gt;'),
 
 			'S_SETTING_NO'		=&gt; false,
 			'S_SETTING_YES'		=&gt; $auth_setting,
@@ -1074,7 +1058,7 @@
 	// Take founder status into account, overwriting the default values
 	if ($userdata['user_type'] == USER_FOUNDER &amp;&amp; strpos($permission, 'a_') === 0)
 	{
-		$template-&gt;assign_block_vars('trace', array(
+		$_CLASS['core_template']-&gt;assign_vars_array('trace', array(
 			'WHO'			=&gt; $userdata['username'],
 			'INFORMATION'	=&gt; $_CLASS['core_user']-&gt;lang['TRACE_USER_FOUNDER'],
 

Deleted: cms/trunk/includes/forums/admin/admin_phpinfo.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_phpinfo.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_phpinfo.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,80 +0,0 @@
-&lt;?php
-/** 
-*
-* @package acp
-* @version $Id: admin_phpinfo.php,v 1.6 2005/04/09 12:26:30 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-*/
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Check permissions
-if (!$_CLASS['auth']-&gt;acl_get('a_server'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-ob_start(); 
-phpinfo(INFO_GENERAL | INFO_CONFIGURATION);
-//Make a seperat option to display the others
-//phpinfo(INFO_GENERAL | INFO_CONFIGURATION | INFO_MODULES | INFO_VARIABLES); 
-
-$phpinfo = ob_get_contents(); 
-ob_end_clean(); 
-
-// Get used layout
-$layout = (preg_match('#bgcolor#i', $phpinfo)) ? 'old' : 'new';
-
-// Here we play around a little with the PHP Info HTML to try and stylise
-// it along phpBB's lines ... hopefully without breaking anything. The idea
-// for this was nabbed from the PHP annotated manual
-preg_match_all('#&lt;body[^&gt;]*&gt;(.*)&lt;/body&gt;#siU', $phpinfo, $output); 
-
-switch ($layout)
-{
-	case 'old':
-		$output = preg_replace('#&lt;table#', '&lt;table class=&quot;tablebg&quot;', $output[1][0]);
-		$output = preg_replace('# bgcolor=&quot;\#(\w){6}&quot;#', '', $output);
-		$output = preg_replace('#(\w),(\w)#', '\1, \2', $output);
-		$output = preg_replace('#border=&quot;0&quot; cellpadding=&quot;3&quot; cellspacing=&quot;1&quot; width=&quot;600&quot;#', 'border=&quot;0&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; width=&quot;95%&quot;', $output);
-		$output = preg_replace('#&lt;tr valign=&quot;top&quot;&gt;&lt;td align=&quot;left&quot;&gt;(.*?&lt;a .*?&lt;/a&gt;)(.*?)&lt;/td&gt;&lt;/tr&gt;#s', '&lt;tr class=&quot;row1&quot;&gt;&lt;td style=&quot;{background-color: #9999cc;}&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;&lt;tr&gt;&lt;td style=&quot;{background-color: #9999cc;}&quot;&gt;\2&lt;/td&gt;&lt;td style=&quot;{background-color: #9999cc;}&quot;&gt;\1&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;', $output);
-		$output = preg_replace('#&lt;tr valign=&quot;baseline&quot;&gt;&lt;td[ ]{0,1}&gt;&lt;b&gt;(.*?)&lt;/b&gt;#', '&lt;tr&gt;&lt;td class=&quot;row1&quot; nowrap=&quot;nowrap&quot;&gt;\1', $output);
-		$output = preg_replace('#&lt;td align=&quot;(center|left)&quot;&gt;#', '&lt;td class=&quot;row2&quot;&gt;', $output);
-		$output = preg_replace('#&lt;td&gt;#', '&lt;td class=&quot;row2&quot;&gt;', $output);
-		$output = preg_replace('#valign=&quot;middle&quot;#', '', $output);
-		$output = preg_replace('#&lt;tr &gt;#', '&lt;tr&gt;', $output);
-		$output = preg_replace('#&lt;hr(.*?)&gt;#', '', $output);
-		$output = preg_replace('#&lt;h1 align=&quot;center&quot;&gt;#i', '&lt;h1&gt;', $output);
-		$output = preg_replace('#&lt;h2 align=&quot;center&quot;&gt;#i', '&lt;h2&gt;', $output);
-		break;
-	case 'new':
-		$output = preg_replace('#&lt;table#', '&lt;table class=&quot;tablebg&quot; align=&quot;center&quot;', $output[1][0]);
-		$output = preg_replace('#(\w),(\w)#', '\1, \2', $output);
-		$output = preg_replace('#border=&quot;0&quot; cellpadding=&quot;3&quot; width=&quot;600&quot;#', 'border=&quot;0&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; width=&quot;95%&quot;', $output);
-		$output = preg_replace('#&lt;tr class=&quot;v&quot;&gt;&lt;td&gt;(.*?&lt;a .*?&lt;/a&gt;)(.*?)&lt;/td&gt;&lt;/tr&gt;#s', '&lt;tr class=&quot;row1&quot;&gt;&lt;td&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;&lt;tr&gt;&lt;td&gt;\2&lt;/td&gt;&lt;td&gt;\1&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;&lt;/tr&gt;', $output);
-		$output = preg_replace('#&lt;td&gt;#', '&lt;td style=&quot;{background-color: #9999cc;}&quot;&gt;', $output);
-		$output = preg_replace('#class=&quot;e&quot;#', 'class=&quot;row1&quot; nowrap=&quot;nowrap&quot;', $output);
-		$output = preg_replace('#class=&quot;v&quot;#', 'class=&quot;row2&quot;', $output);
-		$output = preg_replace('# class=&quot;h&quot;#', '', $output);
-		$output = preg_replace('#&lt;hr /&gt;#', '', $output);
-		preg_match_all('#&lt;div class=&quot;center&quot;&gt;(.*)&lt;/div&gt;#siU', $output, $output); 
-		$output = $output[1][0];
-		break;
-}
-
-adm_page_header($_CLASS['core_user']-&gt;lang['PHP_INFO']);
-
-echo '&lt;h1&gt;' . $_CLASS['core_user']-&gt;lang['PHP_INFO'] . '&lt;/h1&gt;';
-echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang['PHP_INFO_EXPLAIN'] . '&lt;/p&gt;';
-echo $output; 
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_profile.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_profile.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_profile.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,1265 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_profile.php,v 1.7 2004/09/19 20:40:19 acydburn Exp $
-//
-// FILENAME  : admin_profile.php
-// STARTED   : Sun Apr 20, 2003
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-/*
-	Remind if...
-	... one or more language entries are missing
-	
-	Taking into consideration
-	... admin is NOT able to change the field type later
-
-	Admin is able to preview/test the input and output of a profile field at any time.
-
-	If the admin adds a field, he have to enter at least the default board language params. Without doing so, he
-	is not able to activate the field.
-	
-	If the default board language is changed, a check has to be made if the profile field language entries are
-	still valid.
-
-	TODO:
-	* Show at profile view (yes/no)
-	* Viewtopic Integration (Load Switch, Able to show fields with additional template vars populated if enabled)
-	* Custom Validation (Regex) - not in 2.2
-	* Able to use bbcode/smilies/urls - not in 2.2
-*/
-
-
-if (!empty($setmodules))
-{
-	$filename = basename(__FILE__);
-	$module['USER']['CUSTOM_PROFILE_FIELDS'] = ($auth-&gt;acl_get('a_user')) ? &quot;$filename$SID&amp;mode=manage&quot; : '';
-
-	return;
-}
-
-define('IN_PHPBB', 1);
-// Include files
-$phpbb_root_path = './../';
-$phpEx = substr(strrchr(__FILE__, '.'), 1);
-require('pagestart.' . $phpEx);
-include($phpbb_root_path . 'includes/functions_posting.' . $phpEx);
-include($phpbb_root_path . 'includes/functions_user.' . $phpEx);
-include($phpbb_root_path . 'includes/functions_profile_fields.' . $phpEx);
-
-if (!$auth-&gt;acl_get('a_user'))
-{
-	trigger_error($user-&gt;lang['NO_ADMIN']);
-}
-
-$user-&gt;add_lang('ucp');
-
-$mode = (isset($_POST['add'])) ? 'create' : request_var('mode', '');
-$submit = (isset($_POST['submit'])) ? TRUE : FALSE;
-$create = (isset($_POST['create'])) ? TRUE : FALSE;
-$error = $notify = array();
-
-adm_page_header($user-&gt;lang['CUSTOM_PROFILE_FIELDS']);
-
-// Define some default values for each field type
-$default_values = array(
-	FIELD_STRING	=&gt; array('field_length' =&gt; 10, 'field_minlen' =&gt; 0, 'field_maxlen' =&gt; 20, 'field_validation' =&gt; '.*', 'field_novalue' =&gt; '', 'field_default_value' =&gt; ''),
-	FIELD_TEXT		=&gt; array('field_length' =&gt; '5|80', 'field_minlen' =&gt; 0, 'field_maxlen' =&gt; 1000, 'field_validation' =&gt; '.*', 'field_novalue' =&gt; '', 'field_default_value' =&gt; ''),
-	FIELD_INT		=&gt; array('field_length' =&gt; 5, 'field_minlen' =&gt; 0, 'field_maxlen' =&gt; 100, 'field_validation' =&gt; '', 'field_novalue' =&gt; 0, 'field_default_value' =&gt; 0),
-	FIELD_DATE		=&gt; array('field_length' =&gt; 10, 'field_minlen' =&gt; 10, 'field_maxlen' =&gt; 10, 'field_validation' =&gt; '', 'field_novalue' =&gt; ' 0- 0-   0', 'field_default_value' =&gt; ' 0- 0-   0'),
-	FIELD_BOOL		=&gt; array('field_length' =&gt; 1, 'field_minlen' =&gt; 0, 'field_maxlen' =&gt; 0, 'field_validation' =&gt; '', 'field_novalue' =&gt; 0, 'field_default_value' =&gt; 0),
-	FIELD_DROPDOWN	=&gt; array('field_length' =&gt; 0, 'field_minlen' =&gt; 0, 'field_maxlen' =&gt; 5, 'field_validation' =&gt; '', 'field_novalue' =&gt; 1, 'field_default_value' =&gt; 1),
-);
-
-$cp = new custom_profile_admin();
-
-// Build Language array
-// Based on this, we decide which elements need to be edited later and which language items are missing
-$lang_defs = array();
-
-$sql = 'SELECT lang_id, lang_iso
-	FROM ' . LANG_TABLE;
-$result = $db-&gt;sql_query($sql);
-
-while ($row = $db-&gt;sql_fetchrow($result))
-{
-	$lang_defs['id'][] = $row['lang_id'];
-	$lang_defs['iso'][$row['lang_iso']] = $row['lang_id'];
-}
-$db-&gt;sql_freeresult($result);
-
-$sql = 'SELECT field_id, lang_id
-	FROM ' . PROFILE_LANG_TABLE . '
-		ORDER BY lang_id';
-$result = $db-&gt;sql_query($sql);
-	
-while ($row = $db-&gt;sql_fetchrow($result))
-{
-	$lang_defs['entry'][$row['field_id']][] = $row['lang_id'];
-}
-$db-&gt;sql_freeresult($result);
-
-if (isset($lang_defs['entry']))
-{
-	foreach ($lang_defs['entry'] as $field_id =&gt; $field_ary)
-	{
-		$lang_defs['diff'][$field_id] = array_diff($lang_defs['id'], $field_ary);
-	}
-}
-
-if ($mode == '')
-{
-	trigger_error('INVALID_MODE');
-}
-
-if ($mode == 'create' || $mode == 'edit')
-{
-	$field_id = request_var('field_id', 0);
-	$step = request_var('step', 1);
-	$error = array();
-	
-	$submit = (isset($_REQUEST['next']) || isset($_REQUEST['prev'])) ? true : false;
-	$update = (isset($_REQUEST['update'])) ? true : false;
-	$save = (isset($_REQUEST['save'])) ? true : false;
-
-	// We are editing... we need to grab basic things
-	if ($mode == 'edit')
-	{
-		if (!$field_id)
-		{
-			trigger_error('No field id specified');
-		}
-
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
-			WHERE l.lang_id = ' . $lang_defs['iso'][$config['default_lang']] . &quot;
-				AND f.field_id = $field_id
-				AND l.field_id = f.field_id&quot;;
-		$result = $db-&gt;sql_query($sql);
-		$field_row = $db-&gt;sql_fetchrow($result);
-		$db-&gt;sql_freeresult($result);
-
-		if (!$field_row)
-		{
-			trigger_error('Profile field not found');
-		}
-		$field_type = $field_row['field_type'];
-
-		// Get language entries
-		$sql = 'SELECT * FROM ' . PROFILE_FIELDS_LANG_TABLE . ' 
-			WHERE lang_id = ' . $lang_defs['iso'][$config['default_lang']] . &quot;
-				AND field_id = $field_id
-				ORDER BY option_id ASC&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		$lang_options = array();
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			$lang_options[$row['option_id']] = $row['value'];
-		}
-		$db-&gt;sql_freeresult($result);
-
-		$field_row['pf_preview'] = '';
-
-		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;field_id&quot; value=&quot;' . $field_id . '&quot; /&gt;';
-	}
-	else
-	{
-		// We are adding a new field, define basic params
-		$lang_options = array();
-		$field_row = array();
-	
-		$field_type = request_var('field_type', 0);
-		
-		if (!$field_type)
-		{
-			trigger_error('NO_FIELD_TYPE');
-		}
-
-		$field_row = array_merge($default_values[$field_type], array(
-			'field_name'		=&gt; request_var('field_name', ''),
-			'field_required'	=&gt; 0,
-			'field_hide'		=&gt; 0,
-			'field_show_on_reg'	=&gt; 0,
-			'lang_name'			=&gt; '',
-			'lang_explain'		=&gt; '',
-			'lang_default_value'=&gt; '',
-			'pf_preview'		=&gt; '')
-		);
-
-		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;field_type&quot; value=&quot;' . $field_type . '&quot; /&gt;';
-	}
-
-	// Get all relevant informations about entered values within all steps
-	$exclude = array(
-		1	=&gt; array('lang_name', 'lang_explain', 'field_name'),
-		2	=&gt; array('field_length', 'pf_preview', 'field_maxlen', 'field_minlen', 'field_validation', 'field_novalue', 'field_default_value', 'field_required', 'field_show_on_reg', 'field_hide'),
-		3	=&gt; array('l_lang_name', 'l_lang_explain', 'l_lang_default_value', 'l_lang_options')
-	);
-
-	// Text-based fields require lang_default_value to be excluded
-	if ($field_type == FIELD_STRING || $field_type == FIELD_TEXT)
-	{
-		$exclude[1][] = 'lang_default_value';
-	}
-
-	// option-specific fields require lang_options to be excluded
-	if ($field_type == FIELD_BOOL || $field_type == FIELD_DROPDOWN)
-	{
-		$exclude[1][] = 'lang_options';
-	}
-
-	$cp-&gt;vars['field_name']			= request_var('field_name', $field_row['field_name']);
-	$cp-&gt;vars['lang_name']			= request_var('lang_name', $field_row['lang_name']);
-	$cp-&gt;vars['lang_explain']		= request_var('lang_explain', $field_row['lang_explain']);
-	$cp-&gt;vars['lang_default_value']	= request_var('lang_default_value', $field_row['lang_default_value']);
-
-	$options = request_var('lang_options', '');
-	if ($options)
-	{	
-		if (sizeof(explode(&quot;\n&quot;, $options)) == sizeof($lang_options))
-		{
-			$cp-&gt;vars['lang_options']	= explode(&quot;\n&quot;, $options);
-		}
-		else
-		{
-			$cp-&gt;vars['lang_options']	= $lang_options;
-			$error[] = 'You are not allowed to remove or add options within already existing profile fields';
-		}
-	}
-	else
-	{
-		$cp-&gt;vars['lang_options']	= $lang_options;
-	}
-
-	// step 2
-	foreach ($exclude[2] as $key)
-	{
-		if ($key == 'field_required' || $key == 'field_show_on_reg' || $key == 'field_hide')
-		{
-			$var = (!$submit &amp;&amp; $step == 1) ? $field_row[$key] : request_var($key, 0);
-			
-			// Damn checkboxes...
-			if (!$submit &amp;&amp; $step == 1)
-			{
-				$_REQUEST[$key] = $var;
-			}
-		}
-		else
-		{
-			$var = request_var($key, $field_row[$key]);
-		}
-
-		// Manipulate the intended variables a little bit if needed
-		if ($field_type == FIELD_DROPDOWN &amp;&amp; $key == 'field_maxlen')
-		{
-			$var = sizeof(explode(&quot;\n&quot;, request_var('lang_options', '')));
-		}
-
-		if ($field_type == FIELD_TEXT &amp;&amp; $key == 'field_length')
-		{
-			if (isset($_REQUEST['rows']))
-			{
-				$cp-&gt;vars['rows'] = request_var('rows', 0);
-				$cp-&gt;vars['columns'] = request_var('columns', 0);
-				$var = $cp-&gt;vars['rows'] . '|' . $cp-&gt;vars['columns'];
-			}
-			else
-			{
-				$row_col = explode('|', $var);
-				$cp-&gt;vars['rows'] = $row_col[0];
-				$cp-&gt;vars['columns'] = $row_col[1];
-			}
-		}
-
-		if ($field_type == FIELD_DATE &amp;&amp; $key == 'field_default_value')
-		{
-			if (isset($_REQUEST['always_now']) || $var == 'now')
-			{
-				$now = getdate();
-
-				$cp-&gt;vars['field_default_value_day'] = $now['mday'];
-				$cp-&gt;vars['field_default_value_month'] = $now['mon'];
-				$cp-&gt;vars['field_default_value_year'] = $now['year'];
-				$var = $_POST['field_default_value'] = 'now';
-			}
-			else
-			{
-				if (isset($_REQUEST['field_default_value_day']))
-				{
-					$cp-&gt;vars['field_default_value_day'] = request_var('field_default_value_day', 0);
-					$cp-&gt;vars['field_default_value_month'] = request_var('field_default_value_month', 0);
-					$cp-&gt;vars['field_default_value_year'] = request_var('field_default_value_year', 0);
-					$var = $_POST['field_default_value'] = sprintf('%2d-%2d-%4d', $cp-&gt;vars['field_default_value_day'], $cp-&gt;vars['field_default_value_month'], $cp-&gt;vars['field_default_value_year']);
-				}
-				else
-				{
-					list($cp-&gt;vars['field_default_value_day'], $cp-&gt;vars['field_default_value_month'], $cp-&gt;vars['field_default_value_year']) = explode('-', $var);
-				}
-			}	
-		}
-
-		$cp-&gt;vars[$key] = $var;
-	}
-
-	// step 3 - all arrays
-	if ($mode == 'edit')
-	{
-		// Get language entries
-		$sql = 'SELECT * FROM ' . PROFILE_FIELDS_LANG_TABLE . ' 
-			WHERE lang_id &lt;&gt; ' . $lang_defs['iso'][$config['default_lang']] . &quot;
-				AND field_id = $field_id
-			ORDER BY option_id ASC&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		$l_lang_options = array();
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			$l_lang_options[$row['lang_id']][$row['option_id']] = $row['value'];
-		}
-		$db-&gt;sql_freeresult($result);
-
-	
-		$sql = 'SELECT lang_id, lang_name, lang_explain, lang_default_value FROM ' . PROFILE_LANG_TABLE . ' 
-			WHERE lang_id &lt;&gt; ' . $lang_defs['iso'][$config['default_lang']] . &quot;
-				AND field_id = $field_id
-			ORDER BY lang_id ASC&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		$l_lang_name = $l_lang_explain = $l_lang_default_value = array();
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			$l_lang_name[$row['lang_id']] = $row['lang_name'];
-			$l_lang_explain[$row['lang_id']] = $row['lang_explain'];
-			$l_lang_default_value[$row['lang_id']] = $row['lang_default_value'];
-		}
-		$db-&gt;sql_freeresult($result);
-	}
-	
-	foreach ($exclude[3] as $key)
-	{
-		$cp-&gt;vars[$key] = request_var($key, '');
-
-		if (!$cp-&gt;vars[$key] &amp;&amp; $mode == 'edit')
-		{
-			$cp-&gt;vars[$key] = $$key;
-		}
-		else if ($key == 'l_lang_options')
-		{
-			foreach ($cp-&gt;vars[$key] as $lang_id =&gt; $options)
-			{
-				$cp-&gt;vars[$key][$lang_id] = explode(&quot;\n&quot;, $options);
-			}
-		}
-	}
-
-	if ($submit &amp;&amp; $step == 1)
-	{
-		// Check values for step 1
-		if ($cp-&gt;vars['field_name'] == '')
-		{
-			$error[] = $user-&gt;lang['EMPTY_FIELD_NAME'];
-		}
-		if ($cp-&gt;vars['lang_name'] == '')
-		{
-			$error[] = $user-&gt;lang['EMPTY_USER_FIELD_NAME'];
-		}
-
-		if ($field_type == FIELD_BOOL || $field_type == FIELD_DROPDOWN)
-		{
-			if (!sizeof($cp-&gt;vars['lang_options']))
-			{
-				$error[] = 'No Entries defined';
-			}
-		}	
-	}
-
-	$user_error = false;
-	if ($update &amp;&amp; $step == 2)
-	{
-		// Validate Field
-		$user_error = $cp-&gt;validate_profile_field($field_type, $cp-&gt;vars['pf_preview'], $cp-&gt;vars);
-	}
-
-	$step = (isset($_REQUEST['next'])) ? $step + 1 : ((isset($_REQUEST['prev'])) ? $step - 1 : $step);
-
-	if (sizeof($error))
-	{
-		$step--;
-		$submit = false;
-	}
-
-	if (isset($_REQUEST['prev']) || isset($_REQUEST['next']))
-	{
-		$update = false;
-		$pf_preview = '';
-		unset($_REQUEST['pf_preview']);
-	}
-
-	// Build up the specific hidden fields
-	foreach ($exclude as $num =&gt; $key_ary)
-	{
-		if ($num == $step)
-		{
-			continue;
-		}
-
-		$s_hidden_fields .= build_hidden_fields($key_ary);
-	}
-
-	if (!sizeof($error))
-	{
-		if ($step == 3 &amp;&amp; (sizeof($lang_defs['iso']) == 1 || $save))
-		{
-			save_profile_field($field_type, $mode);
-		}
-	}
-
-?&gt;
-	
-	&lt;p&gt;&lt;?php echo $user-&gt;lang['STEP_' . $step . '_EXPLAIN_' . strtoupper($mode)]; ?&gt;&lt;/p&gt;
-
-	&lt;form name=&quot;add_profile_field&quot; method=&quot;post&quot; action=&quot;admin_profile.&lt;?php echo &quot;$phpEx$SID&amp;mode=$mode&amp;step=$step&quot;; ?&gt;&quot;&gt;
-	&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['STEP_' . $step . '_TITLE_' . strtoupper($mode)]; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if (sizeof($error))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $error); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-	// Now go through the steps
-	switch ($step)
-	{
-		// Create basic options - only small differences between field types
-		case 1: 
-	
-			// Build common create options
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['FIELD_TYPE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['FIELD_TYPE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['FIELD_' . strtoupper($cp-&gt;profile_types[$field_type])]; ?&gt;&lt;/b&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['FIELD_NAME']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['FIELD_NAME_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_name&quot; size=&quot;20&quot; value=&quot;&lt;?php echo $cp-&gt;vars['field_name']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;th align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;?php echo sprintf($user-&gt;lang['LANG_SPECIFIC_OPTIONS'], $config['default_lang']); ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['USER_FIELD_NAME']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;lang_name&quot; size=&quot;20&quot; value=&quot;&lt;?php echo $cp-&gt;vars['lang_name']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['FIELD_DESCRIPTION']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['FIELD_DESCRIPTION_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;textarea name=&quot;lang_explain&quot; rows=&quot;3&quot; cols=&quot;80&quot;&gt;&lt;?php echo $cp-&gt;vars['lang_explain']; ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-			// String and Text needs to set default values here...
-			if ($field_type == FIELD_STRING || $field_type == FIELD_TEXT)
-			{
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['DEFAULT_VALUE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang[strtoupper($cp-&gt;profile_types[$field_type]) . '_DEFAULT_VALUE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot;&gt;&lt;?php echo ($field_type == FIELD_STRING) ? '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;lang_default_value&quot; size=&quot;20&quot; value=&quot;' . $cp-&gt;vars['lang_default_value'] . '&quot; /&gt;' : '&lt;textarea name=&quot;lang_default_value&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;' . $cp-&gt;vars['lang_default_value'] . '&lt;/textarea&gt;'; ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-			}
-			
-			if ($field_type == FIELD_BOOL || $field_type == FIELD_DROPDOWN)
-			{
-				if ($field_type == FIELD_BOOL &amp;&amp; !sizeof($cp-&gt;vars['lang_options']))
-				{
-					$cp-&gt;vars['lang_options'][0] = '';
-					$cp-&gt;vars['lang_options'][1] = '';
-				}
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['ENTRIES']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang[strtoupper($cp-&gt;profile_types[$field_type]) . '_ENTRIES_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot;&gt;&lt;?php echo ($field_type == FIELD_DROPDOWN) ? '&lt;textarea name=&quot;lang_options&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;' . implode(&quot;\n&quot;, $cp-&gt;vars['lang_options']) . '&lt;/textarea&gt;' : '&lt;table border=0&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;lang_options[0]&quot; size=&quot;20&quot; value=&quot;' . $cp-&gt;vars['lang_options'][0] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $user-&gt;lang['FIRST_OPTION'] . ' ]&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;lang_options[1]&quot; size=&quot;20&quot; value=&quot;' . $cp-&gt;vars['lang_options'][1] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $user-&gt;lang['SECOND_OPTION'] . ' ]&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'; ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-			}
-?&gt;
-			&lt;tr&gt;
-				&lt;td width=&quot;100%&quot; colspan=&quot;2&quot; class=&quot;cat&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;next&quot; value=&quot;&lt;?php echo $user-&gt;lang['PROFILE_TYPE_OPTIONS']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;?php echo $s_hidden_fields; ?&gt;
-			&lt;/table&gt;
-			&lt;/form&gt;
-&lt;?php
-			break;
-
-		case 2:
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['REQUIRED_FIELD']; ?&gt;&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['REQUIRED_FIELD_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;field_required&quot; value=&quot;1&quot;&lt;?php echo (($cp-&gt;vars['field_required']) ? ' checked=&quot;checked&quot;' : ''); ?&gt; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['DISPLAY_AT_REGISTRATION']; ?&gt;&lt;/b&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;field_show_on_reg&quot; value=&quot;1&quot;&lt;?php echo (($cp-&gt;vars['field_show_on_reg']) ? ' checked=&quot;checked&quot;' : ''); ?&gt; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['HIDE_PROFILE_FIELD']; ?&gt;&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['HIDE_PROFILE_FIELD_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;field_hide&quot; value=&quot;1&quot;&lt;?php echo (($cp-&gt;vars['field_hide']) ? ' checked=&quot;checked&quot;' : ''); ?&gt; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			
-&lt;?php
-			// Build options based on profile type
-			$function = 'get_' . $cp-&gt;profile_types[$field_type] . '_options';
-			$options = $cp-&gt;$function();
-			foreach ($options as $num =&gt; $option_ary)
-			{
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $option_ary['TITLE']; ?&gt;: &lt;/b&gt;&lt;?php echo (isset($option_ary['EXPLAIN'])) ? '&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;' . $option_ary['EXPLAIN'] . '&lt;/span&gt;' : ''; ?&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $option_ary['FIELD']; ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-			}
-?&gt;
-			&lt;tr&gt;
-				&lt;td width=&quot;100%&quot; colspan=&quot;2&quot; class=&quot;cat&quot;&gt;&lt;table border=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td align=&quot;left&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;prev&quot; value=&quot;&lt;?php echo $user-&gt;lang['PROFILE_BASIC_OPTIONS']; ?&gt;&quot; /&gt;&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $user-&gt;lang['UPDATE_PREVIEW']; ?&gt;&quot; /&gt;&nbsp;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;next&quot; value=&quot;&lt;?php echo (sizeof($lang_defs['iso']) == 1) ? $user-&gt;lang['SAVE'] : $user-&gt;lang['PROFILE_LANG_OPTIONS']; ?&gt;&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;?php echo $s_hidden_fields; ?&gt;
-			&lt;/table&gt;
-
-			&lt;br /&gt;&lt;br /&gt;
-			&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-			&lt;tr&gt;
-				&lt;th align=&quot;center&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['PREVIEW_PROFILE_FIELD']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-&lt;?php 
-			if (!empty($user_error) || $update) 
-			{
-				// If not and only showing common error messages, use this one
-				switch ($user_error)
-				{
-					case 'FIELD_INVALID_DATE':
-					case 'FIELD_REQUIRED':
-						$user_error = sprintf($user-&gt;lang[$user_error], $cp-&gt;vars['lang_name']);
-						break;
-					case 'FIELD_TOO_SHORT':
-					case 'FIELD_TOO_SMALL':
-						$user_error = sprintf($user-&gt;lang[$user_error], $cp-&gt;vars['lang_name'], $cp-&gt;vars['field_minlen']);
-						break;
-					case 'FIELD_TOO_LONG':
-					case 'FIELD_TOO_LARGE':
-						$user_error = sprintf($user-&gt;lang[$user_error], $cp-&gt;vars['lang_name'], $cp-&gt;vars['field_maxlen']);
-						break;
-					case 'FIELD_INVALID_CHARS':
-						switch ($cp-&gt;vars['field_validation'])
-						{
-							case '[0-9]+':
-								$user_error = sprintf($user-&gt;lang[$user_error . '_NUMBERS_ONLY'], $cp-&gt;vars['lang_name']);
-								break;
-							case '[\w]+':
-								$user_error = sprintf($user-&gt;lang[$user_error . '_ALPHA_ONLY'], $cp-&gt;vars['lang_name']);
-								break;
-							case '[\w_\+\. \-\[\]]+':
-								$user_error = sprintf($user-&gt;lang[$user_error . '_SPACERS_ONLY'], $cp-&gt;vars['lang_name']);
-								break;
-						}
-
-					default:
-						$user_error = '';
-				}
-
-?&gt;				&lt;tr&gt;
-					&lt;td class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;?php echo (!empty($user_error)) ? '&lt;span style=&quot;color:red&quot;&gt;' . $user_error . '&lt;/span&gt;' : '&lt;span style=&quot;color:green&quot;&gt;' . $user-&gt;lang['EVERYTHING_OK'] . '&lt;/span&gt;'; ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-			}
-			
-			$field_data = array(
-				'lang_name'		=&gt; $cp-&gt;vars['lang_name'],
-				'lang_explain'	=&gt; $cp-&gt;vars['lang_explain'],
-				'lang_id'		=&gt; $lang_defs['iso'][$config['default_lang']],
-				'field_id'		=&gt; 1,
-
-				'lang_default_value'	=&gt; $cp-&gt;vars['lang_default_value'],
-				'field_default_value'	=&gt; $cp-&gt;vars['field_default_value'],
-				'field_ident'			=&gt; 'preview',
-				'field_type'			=&gt; $field_type,
-
-				'field_length'	=&gt; $cp-&gt;vars['field_length'],
-				'field_maxlen'	=&gt; $cp-&gt;vars['field_maxlen'],
-				'lang_options'	=&gt; $cp-&gt;vars['lang_options']
-			);
-
-			preview_field($field_data);
-?&gt;			
-			&lt;tr&gt;
-				&lt;td width=&quot;100%&quot; colspan=&quot;2&quot; class=&quot;cat&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $user-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;/table&gt;
-			&lt;/form&gt;
-&lt;?php
-			break;
-
-		// Define remaining language variables
-		case 3: 
-			$options = build_language_options($field_type, $mode);
-
-			foreach ($options as $lang_id =&gt; $lang_ary)
-			{
-?&gt;
-				&lt;tr&gt;
-					&lt;td align=&quot;center&quot; class=&quot;row3&quot; colspan=&quot;2&quot;&gt;&lt;?php echo ($lang_ary['lang_iso'] == $config['default_lang']) ? sprintf($user-&gt;lang['DEFAULT_ISO_LANGUAGE'], $config['default_lang']) : sprintf($user-&gt;lang['ISO_LANGUAGE'], $lang_ary['lang_iso']) ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php
-				foreach ($lang_ary['fields'] as $field_name =&gt; $field_ary)
-				{
-?&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $field_ary['TITLE']; ?&gt;: &lt;/b&gt;&lt;?php echo (isset($field_ary['EXPLAIN'])) ? '&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;' . $field_ary['EXPLAIN'] . '&lt;/span&gt;' : ''; ?&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $field_ary['FIELD']; ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-&lt;?php			
-				}
-			}
-?&gt;
-			&lt;tr&gt;
-				&lt;td width=&quot;100%&quot; colspan=&quot;2&quot; class=&quot;cat&quot;&gt;&lt;table border=&quot;0&quot; width=&quot;100%&quot;&gt;&lt;tr&gt;&lt;td align=&quot;left&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;prev&quot; value=&quot;&lt;?php echo $user-&gt;lang['PROFILE_TYPE_OPTIONS']; ?&gt;&quot; /&gt;&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;&lt;div style=&quot;align:right&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;save&quot; class=&quot;btnmain&quot; value=&quot;&lt;?php echo $user-&gt;lang['SAVE']; ?&gt;&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;?php echo $s_hidden_fields; ?&gt;
-			&lt;/table&gt;
-			&lt;/form&gt;
-&lt;?php
-			break;
-	}
-}
-
-// Delete field
-if ($mode == 'delete')
-{
-	$confirm = (isset($_POST['confirm'])) ? true : false;
-	$cancel = (isset($_POST['cancel'])) ? true : false;
-	$field_id = request_var('field_id', 0);
-
-	if (!$field_id)
-	{
-		trigger_error('INVALID_MODE');
-	}
-
-	if ($confirm)
-	{
-		$sql = 'SELECT field_ident 
-			FROM ' . PROFILE_FIELDS_TABLE . &quot; 
-			WHERE field_id = $field_id&quot;;
-		$result = $db-&gt;sql_query($sql);
-		$field_ident = $db-&gt;sql_fetchfield('field_ident', 0, $result);
-		$db-&gt;sql_freeresult($result);
-
-		$db-&gt;sql_query('DELETE FROM ' . PROFILE_FIELDS_TABLE . &quot; WHERE field_id = $field_id&quot;);
-		$db-&gt;sql_query('DELETE FROM ' . PROFILE_FIELDS_LANG_TABLE . &quot; WHERE field_id = $field_id&quot;);
-		$db-&gt;sql_query('DELETE FROM ' . PROFILE_LANG_TABLE . &quot; WHERE field_id = $field_id&quot;);
-		$db-&gt;sql_query('ALTER TABLE ' . PROFILE_DATA_TABLE . &quot; DROP $field_ident&quot;);
-
-		$order = 0;
-
-		$sql = 'SELECT *
-			FROM ' . PROFILE_FIELDS_TABLE . '
-			ORDER BY field_order';
-		$result = $db-&gt;sql_query($sql);
-
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			$order++;
-			if ($row['field_order'] != $order)
-			{
-				$sql = 'UPDATE ' . 
-					PROFILE_FIELDS_TABLE . &quot; 
-					SET field_order = $order 
-					WHERE field_id = {$row['field_id']}&quot;;
-				$db-&gt;sql_query($sql);
-			}
-		}
-
-		// TODO: add_log
-		trigger_error($user-&gt;lang['DELETED_PROFILE_FIELD']);
-	}
-	else if (!$cancel)
-	{
-		$l_message = '&lt;form method=&quot;post&quot; action=&quot;admin_profile.' . $phpEx . $SID . '&amp;mode=delete&amp;field_id=' . $field_id . '&quot;&gt;' . $user-&gt;lang['CONFIRM_DELETE_PROFILE_FIELD'] . '&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;' . $user-&gt;lang['YES'] . '&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;' . $user-&gt;lang['NO'] . '&quot; /&gt;&lt;/form&gt;';
-
-		adm_page_message($user-&gt;lang['CONFIRM'], $l_message, false, false);
-
-		adm_page_footer();
-	}
-	
-	$mode = 'manage';
-}
-
-if ($mode == 'activate')
-{
-	$field_id = request_var('field_id', 0);
-
-	if (!$field_id)
-	{
-		trigger_error('INVALID_MODE');
-	}
-	
-	$sql = 'SELECT lang_id 
-		FROM ' . LANG_TABLE . &quot; 
-		WHERE lang_iso = '{$config['default_lang']}'&quot;;
-	$result = $db-&gt;sql_query($sql);
-	$default_lang_id = (int) $db-&gt;sql_fetchfield('lang_id', 0, $result);
-	$db-&gt;sql_freeresult($result);
-
-	if (!in_array($default_lang_id, $lang_defs['entry'][$field_id]))
-	{
-		trigger_error('DEFAULT_LANGUAGE_NOT_FILLED');
-	}
-
-	$sql = 'UPDATE ' . PROFILE_FIELDS_TABLE . &quot; 
-		SET field_active = 1 
-		WHERE field_id = $field_id&quot;;
-	$db-&gt;sql_query($sql);
-
-	// TODO: add_log
-	trigger_error($user-&gt;lang['PROFILE_FIELD_ACTIVATED']);
-}
-
-if ($mode == 'deactivate')
-{
-	$field_id = request_var('field_id', 0);
-
-	if (!$field_id)
-	{
-		trigger_error('INVALID_MODE');
-	}
-	
-	$sql = 'UPDATE ' . PROFILE_FIELDS_TABLE . &quot;
-		SET field_active = 0 
-		WHERE field_id = $field_id&quot;;
-	$db-&gt;sql_query($sql);
-
-	// TODO: add_log
-	trigger_error($user-&gt;lang['PROFILE_FIELD_DEACTIVATED']);
-}
-
-if ($mode == 'move_up' || $mode == 'move_down')
-{
-	$field_order = request_var('order', 0);
-	$order_total = $field_order * 2 + (($mode == 'move_up') ? -1 : 1);
-
-	$sql = 'UPDATE ' . PROFILE_FIELDS_TABLE . &quot;
-		SET field_order = $order_total - field_order
-		WHERE field_order IN ($field_order, &quot; . (($mode == 'move_up') ? $field_order - 1 : $field_order + 1) . ')';
-	$db-&gt;sql_query($sql);
-
-	$mode = 'manage';
-}
-
-if ($mode == 'manage')
-{
-?&gt;
-	&lt;form name=&quot;profile_fields&quot; method=&quot;post&quot; action=&quot;admin_profile.&lt;?php echo &quot;$phpEx$SID&quot;; ?&gt;&quot;&gt;
-	&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; width=&quot;99%&quot;&gt;
-	&lt;tr&gt; 
-		&lt;th nowrap=&quot;nowrap&quot;&gt;Name&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;Template Variable&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;Type&lt;/th&gt;
-		&lt;th colspan=&quot;3&quot; nowrap=&quot;nowrap&quot;&gt;Options&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;Reorder&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-	$sql = 'SELECT *
-		FROM ' . PROFILE_FIELDS_TABLE . '
-		ORDER BY field_order';
-	$result = $db-&gt;sql_query($sql);
-
-	$row_class = '';
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-		$active_lang = (!$row['field_active']) ? 'ACTIVATE' : 'DEACTIVATE';
-		$active_value = (!$row['field_active']) ? 'activate' : 'deactivate';
-		$id = $row['field_id'];
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;?php echo $row['field_name']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;?php echo $row['field_ident']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['FIELD_' . strtoupper($cp-&gt;profile_types[$row['field_type']])]; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;admin_profile.&lt;?php echo $phpEx . $SID; ?&gt;&amp;mode=&lt;?php echo $active_value; ?&gt;&amp;field_id=&lt;?php echo $id; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang[$active_lang]; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;admin_profile.&lt;?php echo $phpEx . $SID; ?&gt;&amp;mode=edit&amp;field_id=&lt;?php echo $id; ?&gt;&quot;&gt;&lt;?php echo ((sizeof($lang_defs['diff'][$row['field_id']])) ? '&lt;span style=&quot;color:red&quot;&gt;' . $user-&gt;lang['EDIT'] . '&lt;/span&gt;' : $user-&gt;lang['EDIT']) . '&lt;/a&gt;' . ((sizeof($lang_defs['diff'][$row['field_id']])) ? '&lt;/span&gt;' : ''); ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;a href=&quot;admin_profile.&lt;?php echo $phpEx . $SID; ?&gt;&amp;mode=delete&amp;field_id=&lt;?php echo $id; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;admin_profile.&lt;?php echo $phpEx . $SID; ?&gt;&amp;mode=move_up&amp;order=&lt;?php echo $row['field_order']; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['MOVE_UP']; ?&gt;&lt;/a&gt; | &lt;a href=&quot;admin_profile.&lt;?php echo $phpEx . $SID; ?&gt;&amp;mode=move_down&amp;order=&lt;?php echo $row['field_order']; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['MOVE_DOWN']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	}
-	$db-&gt;sql_freeresult($result);
-
-	$s_select_type = '';
-	foreach ($cp-&gt;profile_types as $key =&gt; $value)
-	{
-		$s_select_type .= '&lt;option value=&quot;' . $key . '&quot;&gt;' . $user-&gt;lang['FIELD_' . strtoupper($value)] . '&lt;/option&gt;';
-	}
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;7&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_name&quot; size=&quot;20&quot; /&gt; &lt;select name=&quot;field_type&quot;&gt;&lt;?php echo $s_select_type; ?&gt;&lt;/select&gt; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $user-&gt;lang['CREATE_NEW_FIELD']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;/table&gt;
-	&lt;/form&gt;
-&lt;?php
-}
-
-adm_page_footer();
-
-
-function preview_field($field_data)
-{
-	global $cp;
-
-	$field = $cp-&gt;process_field_row('preview', $field_data);
-?&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $field_data['lang_name']; ?&gt;: &lt;/b&gt;&lt;?php echo (!empty($field_data['lang_explain'])) ? '&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;' . $field_data['lang_explain'] . '&lt;/span&gt;' : ''; ?&gt;&lt;/td&gt; 
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $field; ?&gt;&lt;/td&gt; 
-	&lt;/tr&gt;
-&lt;?php
-}
-
-// Build all Language specific options
-function build_language_options($field_type, $mode = 'create')
-{
-	global $user, $config, $db, $cp;
-
-	$sql = 'SELECT lang_id, lang_iso 
-		FROM ' . LANG_TABLE . &quot;
-		WHERE lang_iso &lt;&gt; '&quot; . $config['default_lang'] . &quot;'&quot;;
-	$result = $db-&gt;sql_query($sql);
-
-	$languages = array();
-	while ($row = $db-&gt;sql_fetchrow($result))
-	{
-		$languages[$row['lang_id']] = $row['lang_iso'];
-	}
-	$db-&gt;sql_freeresult($result);
-		
-	$options = array();
-	$options['lang_name'] = 'string';
-	if (!empty($cp-&gt;vars['lang_explain']))
-	{
-		$options['lang_explain'] = 'text';
-	}
-	
-	switch ($field_type)
-	{
-		case FIELD_BOOL:
-			$options['lang_options'] = 'two_options';
-			break;
-		case FIELD_DROPDOWN:
-			$options['lang_options'] = 'optionfield';
-			break;
-		case FIELD_TEXT:
-		case FIELD_STRING:
-			if (!empty($cp-&gt;vars['lang_default_value']))
-			{
-				$options['lang_default_value'] = ($field_type == FIELD_STRING) ? 'string' : 'text';
-			}
-			break;
-	}
-	
-	$lang_options = array();
-
-	foreach ($options as $field =&gt; $field_type)
-	{
-		$lang_options[1]['lang_iso'] = $config['default_lang'];
-		$lang_options[1]['fields'][$field] = array(
-			'TITLE'		=&gt; $user-&gt;lang['CP_' . strtoupper($field)],
-			'FIELD'		=&gt; '&lt;b&gt;' . ((is_array($cp-&gt;vars[$field])) ? implode('&lt;br /&gt;', $cp-&gt;vars[$field]) : str_replace(&quot;\n&quot;, '&lt;br /&gt;', $cp-&gt;vars[$field])) . '&lt;/b&gt;'
-		);
-
-		if (isset($user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN']))
-		{
-			$lang_options[1]['fields'][$field]['EXPLAIN'] = $user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN'];
-		}
-	}
-
-	foreach ($languages as $lang_id =&gt; $lang_iso)
-	{
-		$lang_options[$lang_id]['lang_iso'] = $lang_iso;
-		foreach ($options as $field =&gt; $field_type)
-		{
-			$value = ($mode == 'create') ? request_var('l_' . $field, '') : $cp-&gt;vars['l_' . $field];
-				 
-			if ($field == 'lang_options')
-			{
-				$var = ($mode == 'create') ? $cp-&gt;vars['lang_options'] : $cp-&gt;vars['lang_options'][$lang_id];
-					
-				switch ($field_type)
-				{
-					case 'two_options':
-
-						$lang_options[$lang_id]['fields'][$field] = array(
-							'TITLE'		=&gt; $user-&gt;lang['CP_' . strtoupper($field)],
-							'FIELD'		=&gt; '&lt;table border=0&gt;&lt;tr&gt;&lt;td&gt;&lt;span class=&quot;genmed&quot;&gt;' . $user-&gt;lang['FIRST_OPTION'] . ': &lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;input name=&quot;l_' . $field . '[' . $lang_id . '][]&quot; size=&quot;20&quot; value=&quot;' . ((isset($value[$lang_id][0])) ? $value[$lang_id][0] : $var[0]) . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;span class=&quot;genmed&quot;&gt;' . $user-&gt;lang['SECOND_OPTION'] . ': &lt;/span&gt;&lt;/td&gt;&lt;td&gt;&lt;input name=&quot;l_' . $field . '[' . $lang_id . '][]&quot; size=&quot;20&quot; value=&quot;' . ((isset($value[$lang_id][1])) ? $value[$lang_id][1] : $var[1]) . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'
-						);
-						break;
-
-					case 'optionfield':
-
-						$lang_options[$lang_id]['fields'][$field] = array(
-							'TITLE'		=&gt; $user-&gt;lang['CP_' . strtoupper($field)],
-							'FIELD'		=&gt; '&lt;textarea name=&quot;l_' . $field . '[' . $lang_id . ']&quot; rows=&quot;7&quot; cols=&quot;80&quot;&gt;' . ((isset($value[$lang_id])) ? implode(&quot;\n&quot;, $value[$lang_id]) : implode(&quot;\n&quot;, $var)) . '&lt;/textarea&gt;'
-						);
-						break;
-				}
-				
-				if (isset($user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN']))
-				{
-					$lang_options[$lang_id]['fields'][$field]['EXPLAIN'] = $user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN'];
-				}
-			}
-			else
-			{
-				$var = ($mode == 'create') ? $cp-&gt;vars[$field] : $cp-&gt;vars[$field][$lang_id];
-
-				$lang_options[$lang_id]['fields'][$field] = array(
-					'TITLE'		=&gt; $user-&gt;lang['CP_' . strtoupper($field)],
-					'FIELD'		=&gt; ($field_type == 'string') ? '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;l_' . $field . '[' . $lang_id . ']&quot; value=&quot;' . ((isset($value[$lang_id])) ? $value[$lang_id] : $var) . '&quot; size=&quot;20&quot; /&gt;' : '&lt;textarea name=&quot;l_' . $field . '[' . $lang_id . ']&quot; rows=&quot;3&quot; cols=&quot;80&quot;&gt;' . ((isset($value[$lang_id])) ? $value[$lang_id] : $var) . '&lt;/textarea&gt;'
-				);
-		
-				if (isset($user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN']))
-				{
-					$lang_options[$lang_id]['fields'][$field]['EXPLAIN'] = $user-&gt;lang['CP_' . strtoupper($field) . '_EXPLAIN'];
-				}
-			}
-		}
-	}
-
-	return $lang_options;
-}
-
-function save_profile_field($field_type, $mode = 'create')
-{
-	global $cp, $db, $config, $user, $lang_defs;
-
-	$field_id = request_var('field_id', 0);
-
-	// Collect all informations, if something is going wrong, abort the operation
-	$profile_sql = $profile_lang = $empty_lang = $profile_lang_fields = array();
-
-	$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-	if ($mode == 'create')
-	{
-		$result = $db-&gt;sql_query('SELECT MAX(field_order) as max_field_order FROM ' . PROFILE_FIELDS_TABLE);
-		$new_field_order = (int) $db-&gt;sql_fetchfield('max_field_order', 0, $result);
-		$db-&gt;sql_freeresult($result);
-
-		// We do not use a stripped down field name as identifier in order to retain sql compatibility, of course it would be nice to not have to look up the identifier and instead having a descriptive name, but this would produce more errors than needed, and do you want to have a totally crypted name just because of stripped characters? ;)
-		$field_ident = 'field_' . ($new_field_order + 1);
-	}
-
-	// Save the field
-	$profile_fields = array(
-		'field_name'		=&gt; $cp-&gt;vars['field_name'],
-		'field_length'		=&gt; $cp-&gt;vars['field_length'],
-		'field_minlen'		=&gt; $cp-&gt;vars['field_minlen'],
-		'field_maxlen'		=&gt; $cp-&gt;vars['field_maxlen'],
-		'field_novalue'		=&gt; $cp-&gt;vars['field_novalue'],
-		'field_default_value'	=&gt; $cp-&gt;vars['field_default_value'],
-		'field_validation'	=&gt; $cp-&gt;vars['field_validation'],
-		'field_required'	=&gt; $cp-&gt;vars['field_required'],
-		'field_show_on_reg'	=&gt; $cp-&gt;vars['field_show_on_reg'],
-		'field_hide'		=&gt; $cp-&gt;vars['field_hide']
-	);
-
-	if ($mode == 'create')
-	{
-		$profile_fields += array(
-			'field_type'		=&gt; $field_type,
-			'field_ident'		=&gt; $field_ident,
-			'field_order'		=&gt; $new_field_order + 1,
-			'field_active'		=&gt; 1
-		);
-
-		$db-&gt;sql_query('INSERT INTO ' . PROFILE_FIELDS_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $profile_fields));
-
-		$field_id = $db-&gt;sql_nextid();
-	}
-	else
-	{
-		$db-&gt;sql_query('UPDATE ' . PROFILE_FIELDS_TABLE . ' SET ' . $db-&gt;sql_build_array('UPDATE', $profile_fields) . &quot;
-			WHERE field_id = $field_id&quot;);
-	}
-		
-	if ($mode == 'create')
-	{
-		// We are defining the biggest common value, because of the possibility to edit the min/max values of each field.
-		$sql = 'ALTER TABLE ' . PROFILE_DATA_TABLE . &quot; ADD $field_ident &quot;;
-		switch ($field_type)
-		{
-			case FIELD_STRING:
-				$sql .= ' VARCHAR(255) DEFAULT NULL NULL';
-				break;
-
-			case FIELD_DATE:
-				$sql .= 'VARCHAR(10) DEFAULT NULL NULL';
-				break;
-
-			case FIELD_TEXT:
-				$sql .= 'TEXT NULL';
-				break;
-
-			case FIELD_BOOL:
-				$sql .= 'TINYINT(2) DEFAULT NULL NULL';
-				break;
-		
-			case FIELD_DROPDOWN:
-				$sql .= 'MEDIUMINT(8) DEFAULT NULL NULL';
-				break;
-
-			case FIELD_INT:
-				$sql .= 'BIGINT(20) DEFAULT NULL NULL';
-				break;
-		}
-		$profile_sql[] = $sql;
-	}
-
-	$sql_ary = array(
-		'lang_name'		=&gt; $cp-&gt;vars['lang_name'],
-		'lang_explain'	=&gt; $cp-&gt;vars['lang_explain'],
-		'lang_default_value'	=&gt; $cp-&gt;vars['lang_default_value']
-	);
-
-	if ($mode == 'create')
-	{
-		$sql_ary['field_id'] = $field_id;
-		$sql_ary['lang_id'] = $default_lang_id;
-	
-		$profile_sql[] = 'INSERT INTO ' . PROFILE_LANG_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql_ary);
-	}
-	else
-	{
-		update_insert(PROFILE_LANG_TABLE, $sql_ary, array('field_id' =&gt; $field_id, 'lang_id' =&gt; $default_lang_id));
-	}
-
-	if (sizeof($cp-&gt;vars['l_lang_name']))
-	{
-		foreach ($cp-&gt;vars['l_lang_name'] as $lang_id =&gt; $data)
-		{
-			if (($cp-&gt;vars['lang_name'] != '' &amp;&amp; $cp-&gt;vars['l_lang_name'][$lang_id] == '')
-				|| ($cp-&gt;vars['lang_explain'] != '' &amp;&amp; $cp-&gt;vars['l_lang_explain'][$lang_id] == '')
-				|| ($cp-&gt;vars['lang_default_value'] != '' &amp;&amp; $cp-&gt;vars['l_lang_default_value'][$lang_id] == ''))
-			{
-				$empty_lang[$lang_id] = true;
-				break;
-			}
-				
-			if (!isset($empty_lang[$lang_id]))
-			{
-				$profile_lang[] = array(
-					'field_id'		=&gt; $field_id,
-					'lang_id'		=&gt; $lang_id,
-					'lang_name'		=&gt; $cp-&gt;vars['l_lang_name'][$lang_id],
-					'lang_explain'	=&gt; $cp-&gt;vars['l_lang_explain'][$lang_id],
-					'lang_default_value'	=&gt; $cp-&gt;vars['l_lang_default_value'][$lang_id]
-				);
-			}
-		}
-	}
-
-	$cp-&gt;vars['l_lang_name']			= request_var('l_lang_name', '');
-	$cp-&gt;vars['l_lang_explain']			= request_var('l_lang_explain', '');
-	$cp-&gt;vars['l_lang_default_value']	= request_var('l_lang_default_value', '');
-	$cp-&gt;vars['l_lang_options']			= request_var('l_lang_options', '');
-
-	if (!empty($cp-&gt;vars['lang_options']))
-	{
-		if (!is_array($cp-&gt;vars['lang_options']))
-		{
-			$cp-&gt;vars['lang_options'] = explode(&quot;\n&quot;, $cp-&gt;vars['lang_options']);
-		}
-
-		foreach ($cp-&gt;vars['lang_options'] as $option_id =&gt; $value)
-		{
-			$sql_ary = array(
-				'field_type'	=&gt; (int) $field_type,
-				'value'			=&gt; $value
-			);
-
-			if ($mode == 'create')
-			{
-				$sql_ary['field_id'] = $field_id;
-				$sql_ary['lang_id'] = $default_lang_id;
-				$sql_ary['option_id'] = (int) $option_id;
-
-				$profile_sql[] = 'INSERT INTO ' . PROFILE_FIELDS_LANG_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql_ary);
-			}
-			else
-			{
-				update_insert(PROFILE_FIELDS_LANG_TABLE, $sql_ary, array(
-					'field_id' =&gt; $field_id,
-					'lang_id' =&gt; (int) $default_lang_id,
-					'option_id' =&gt; (int) $option_id)
-				);
-			}
-		}
-	}
-
-	if (sizeof($cp-&gt;vars['l_lang_options']))
-	{
-		foreach ($cp-&gt;vars['l_lang_options'] as $lang_id =&gt; $lang_ary)
-		{
-			if (!is_array($lang_ary))
-			{
-				$lang_ary = explode(&quot;\n&quot;, $lang_ary);
-			}
-
-			if (sizeof($lang_ary) != sizeof($cp-&gt;vars['lang_options']))
-			{
-				$empty_lang[$lang_id] = true;
-			}
-
-			if (!isset($empty_lang[$lang_id]))
-			{
-				foreach ($lang_ary as $option_id =&gt; $value)
-				{
-					$profile_lang_fields[] = array(
-						'field_id'		=&gt; (int) $field_id,
-						'lang_id'		=&gt; (int) $lang_id,
-						'option_id'		=&gt; (int) $option_id,
-						'field_type'	=&gt; (int) $field_type,
-						'value'			=&gt; $value
-					);
-				}
-			}
-		}
-	}
-
-	foreach ($profile_lang as $sql)
-	{
-		if ($mode == 'create')
-		{
-			$profile_sql[] = 'INSERT INTO ' . PROFILE_LANG_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql);
-		}
-		else
-		{
-			$lang_id = $sql['lang_id'];
-			unset($sql['lang_id'], $sql['field_id']);
-			update_insert(PROFILE_LANG_TABLE, $sql, array('lang_id' =&gt; (int) $lang_id, 'field_id' =&gt; $field_id));
-		}
-	}
-
-	if (sizeof($profile_lang_fields))
-	{
-		foreach ($profile_lang_fields as $sql)
-		{
-			if ($mode == 'create')
-			{
-				$profile_sql[] = 'INSERT INTO ' . PROFILE_FIELDS_LANG_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql);
-			}
-			else
-			{
-				$lang_id = $sql['lang_id'];
-				$option_id = $sql['option_id'];
-				unset($sql['lang_id'], $sql['field_id'], $sql['option_id']);
-				update_insert(PROFILE_FIELDS_LANG_TABLE, $sql, array(
-					'lang_id'	=&gt; $lang_id, 
-					'field_id'	=&gt; $field_id,
-					'option_id'	=&gt; $option_id)
-				);
-			}
-		}
-	}
-
-//		$db-&gt;sql_transaction();
-	if ($mode == 'create')
-	{
-		foreach ($profile_sql as $sql)
-		{
-			$db-&gt;sql_query($sql);
-		}
-	}
-//	$db-&gt;sql_transaction('commit');
-
-	// TODO: add_log
-	trigger_error($user-&gt;lang['ADDED_PROFILE_FIELD']);
-}
-
-// Update, then insert if not successfull
-function update_insert($table, $sql_ary, $where_fields)
-{
-	global $db;
-
-	$where_sql = array();
-	foreach ($where_fields as $key =&gt; $value)
-	{
-		$where_sql[] = $key . ' = ' . ((is_string($value)) ? &quot;'&quot; . $db-&gt;sql_escape($value) . &quot;'&quot; : $value);
-	}
-
-	$db-&gt;sql_return_on_error(true);
-	
-	$sql = &quot;UPDATE $table SET &quot; . $db-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
-		WHERE ' . implode(' AND ', $where_sql);
-	$result = $db-&gt;sql_query($sql);
-
-	$db-&gt;sql_return_on_error(false);
-	
-	if (!$result)
-	{
-		$sql_ary = array_merge($where_fields, $sql_ary);
-		$db-&gt;sql_query(&quot;INSERT INTO $table &quot; . $db-&gt;sql_build_array('INSERT', $sql_ary));
-	}
-
-}
-
-function build_hidden_fields($key_ary)
-{
-	$hidden_fields = '';
-
-	foreach ($key_ary as $key)
-	{
-		$var = isset($_REQUEST[$key]) ? $_REQUEST[$key] : false;
-
-		if ($var === false)
-		{
-			continue;
-		}
-
-		if (is_array($var))
-		{
-			foreach ($var as $num =&gt; $__var)
-			{
-				if (is_array($__var))
-				{
-					foreach ($__var as $_num =&gt; $___var)
-					{
-						$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;' . $key . '[' . $num . '][' . $_num . ']&quot; value=&quot;' . stripslashes(htmlspecialchars($___var)) . '&quot; /&gt;' . &quot;\n&quot;;
-					}
-				}
-				else
-				{
-					$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;' . $key . '[' . $num . ']&quot; value=&quot;' . stripslashes(htmlspecialchars($__var)) . '&quot; /&gt;' . &quot;\n&quot;;
-				}
-			}
-		}
-		else
-		{
-			$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;' . $key . '&quot; value=&quot;' . stripslashes(htmlspecialchars($var)) . '&quot; /&gt;' . &quot;\n&quot;;
-		}
-	}
-	return $hidden_fields;
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_prune.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_prune.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_prune.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -16,226 +16,155 @@
 }
 
 // Do we have permission?
-if (!$_CLASS['auth']-&gt;acl_get('a_prune'))
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_prune'))
 {
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+	trigger_error('NO_ADMIN');
 }
-
-// Get the forum ID for pruning
-$forum_id = (isset($_REQUEST['f'])) ? array_map('intval', $_REQUEST['f']) : array();
-
-// Check for submit to be equal to Prune. If so then proceed with the pruning.
-if (isset($_POST['submit']))
-{
-	$prune_posted = (isset($_POST['prune_days'])) ? intval($_POST['prune_days']) : 0;
-	$prune_viewed = (isset($_POST['prune_vieweddays'])) ? intval($_POST['prune_vieweddays']) : 0;
-	$prune_all = !$prune_posted &amp;&amp; !$prune_viewed;
-	
-	$prune_flags = 0;
-	$prune_flags += (!empty($_POST['prune_old_polls'])) ? 2 : 0;
-	$prune_flags += (!empty($_POST['prune_announce'])) ? 4 : 0;
-	$prune_flags += (!empty($_POST['prune_sticky'])) ? 8 : 0;
-
-	// Convert days to seconds for timestamp functions...
-	$prunedate_posted = time() - ($prune_posted * 86400);
-	$prunedate_viewed = time() - ($prune_viewed * 86400);
-
-	adm_page_header($_CLASS['core_user']-&gt;lang['PRUNE']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_SUCCESS']; ?&gt;&lt;/p&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOPICS_PRUNED']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['POSTS_PRUNED']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	$sql_forum = (sizeof($forum_id)) ? ' AND forum_id IN (' . implode(', ', $forum_id) . ')' : '';
-
-	// Get a list of forum's or the data for the forum that we are pruning.
-	$sql = 'SELECT forum_id, forum_name 
-		FROM ' . FORUMS_TABLE . '
-		WHERE forum_type = ' . FORUM_POST . &quot;
-			$sql_forum 
-		ORDER BY left_id ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-	{
-		$prune_ids = array();
-		$p_result['topics'] = 0;
-		$p_result['posts'] = 0;
-		$log_data = '';
-		do
-		{
-			if ($_CLASS['auth']-&gt;acl_get('f_list', $row['forum_id']))
-			{
-				if ($prune_all)
-				{
-					$p_result = prune($row['forum_id'], 'posted', time(), $prune_flags, false);
-				}
-				else
-				{
-					if ($prune_posted)
-					{
-						$return = prune($row['forum_id'], 'posted', $prunedate_posted, $prune_flags, false);
-						$p_result['topics'] += $return['topics'];
-						$p_result['posts'] += $return['posts'];
-					}
-					if ($prune_viewed)
-					{
-						$return = prune($row['forum_id'], 'viewed', $prunedate_viewed, $prune_flags, false);
-						$p_result['topics'] += $return['topics'];
-						$p_result['posts'] += $return['posts'];
-					}
-				}
-
-				
-				$prune_ids[] = $row['forum_id'];
-
-				$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['forum_name']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $p_result['topics']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $p_result['posts']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	
-				$log_data .= (($log_data != '') ? ', ' : '') . $row['forum_name'];
-			}
-		}
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-
-		// Sync all pruned forums at once
-		sync('forum', 'forum_id', $prune_ids, TRUE);
-
-		add_log('admin', 'LOG_PRUNE', $log_data);
-	}
-	else
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_PRUNE']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-?&gt;
-&lt;/table&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;?php
-
-	adm_page_footer();
-
+
+$_CLASS['core_user']-&gt;add_lang('admin_prune', 'forums');
+
+$tpl_name = 'acp_prune_forums';
+$page_title = 'ACP_PRUNE_FORUMS';
+$u_action = 'forums&amp;file=admin_prune';
+
+global $_CLASS, $config;
+
+$forum_id = request_var('f', array(0));
+$submit = (isset($_POST['submit'])) ? true : false;
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'S_PRUNED'			=&gt; false,
+	'S_SELECT_FORUM'	=&gt; false,
+));
+	
+if ($submit)
+{
+	$prune_posted = request_var('prune_days', 0);
+	$prune_viewed = request_var('prune_vieweddays', 0);
+	$prune_all = !$prune_posted &amp;&amp; !$prune_viewed;
+
+	$prune_flags = 0;
+	$prune_flags += (request_var('prune_old_polls', 0)) ? 2 : 0;
+	$prune_flags += (request_var('prune_announce', 0)) ? 4 : 0;
+	$prune_flags += (request_var('prune_sticky', 0)) ? 8 : 0;
+
+	// Convert days to seconds for timestamp functions...
+	$prunedate_posted = time() - ($prune_posted * 86400);
+	$prunedate_viewed = time() - ($prune_viewed * 86400);
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_PRUNED'		=&gt; true)
+	);
+
+	$sql_forum = (sizeof($forum_id)) ? ' AND forum_id IN (' . implode(', ', $forum_id) .')' : '';
+
+	// Get a list of forum's or the data for the forum that we are pruning.
+	$sql = 'SELECT forum_id, forum_name 
+		FROM ' . FORUMS_FORUMS_TABLE . '
+		WHERE forum_type = ' . FORUM_POST . &quot;
+			$sql_forum 
+		ORDER BY left_id ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$prune_ids = array();
+		$p_result['topics'] = 0;
+		$p_result['posts'] = 0;
+		$log_data = '';
+
+		do
+		{
+			if (!$_CLASS['forums_auth']-&gt;acl_get('f_list', $row['forum_id']))
+			{
+				continue;
+			}
+
+			if ($prune_all)
+			{
+				$p_result = prune($row['forum_id'], 'posted', time(), $prune_flags, false);
+			}
+			else
+			{
+				if ($prune_posted)
+				{
+					$return = prune($row['forum_id'], 'posted', $prunedate_posted, $prune_flags, false);
+					$p_result['topics'] += $return['topics'];
+					$p_result['posts'] += $return['posts'];
+				}
+
+				if ($prune_viewed)
+				{
+					$return = prune($row['forum_id'], 'viewed', $prunedate_viewed, $prune_flags, false);
+					$p_result['topics'] += $return['topics'];
+					$p_result['posts'] += $return['posts'];
+				}
+			}
+
+			$prune_ids[] = $row['forum_id'];
+
+			$_CLASS['core_template']-&gt;assign_vars_array('pruned', array(
+				'FORUM_NAME'	=&gt; $row['forum_name'],
+				'NUM_TOPICS'	=&gt; $p_result['topics'],
+				'NUM_POSTS'		=&gt; $p_result['posts'])
+			);
+
+			$log_data .= (($log_data != '') ? ', ' : '') . $row['forum_name'];
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+		// Sync all pruned forums at once
+		sync('forum', 'forum_id', $prune_ids, true);
+		add_log('admin', 'LOG_PRUNE', $log_data);
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+}
+
+// If they haven't selected a forum for pruning yet then
+// display a select box to use for pruning.
+if (!sizeof($forum_id))
+{
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'U_ACTION'			=&gt; generate_link($u_action, array('admin' =&gt; true)),
+		'S_SELECT_FORUM'	=&gt; true,
+		'S_FORUM_OPTIONS'	=&gt; make_forum_select(false, false, false))
+	);
+}
+else
+{
+	$sql = 'SELECT forum_id, forum_name 
+		FROM ' . FORUMS_FORUMS_TABLE . ' 
+		WHERE forum_id IN (' . implode(', ', $forum_id).')';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+
+	if (!$row)
+	{
+		$_CLASS['core_db']-&gt;free_result($result);
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+	}
+
+	$forum_list = $s_hidden_fields = '';
+	do
+	{
+		$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
+		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;f[]&quot; value=&quot;' . $row['forum_id'] . '&quot; /&gt;';
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	$l_selected_forums = (sizeof($forum_id) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'L_SELECTED_FORUMS'		=&gt; $_CLASS['core_user']-&gt;get_lang($l_selected_forums),
+		'U_ACTION'				=&gt; generate_link($u_action, array('admin' =&gt; true)),
+		'U_BACK'				=&gt; generate_link($u_action, array('admin' =&gt; true)),
+		'FORUM_LIST'			=&gt; $forum_list,
+		'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields
+	));
 }
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_prune.html');
 
-adm_page_header($_CLASS['core_user']-&gt;lang['PRUNE']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PRUNE_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-// If they haven't selected a forum for pruning yet then
-// display a select box to use for pruning.
-if (!$forum_id)
-{
-
-?&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_prune', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;f[]&quot; multiple=&quot;true&quot; size=&quot;5&quot;&gt;&lt;?php echo make_forum_select(false, false, false); ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-else
-{
-	$sql = 'SELECT forum_id, forum_name 
-		FROM ' . FORUMS_TABLE . ' 
-		WHERE forum_id IN (' . implode(', ', $forum_id) . ')';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-	if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
-	}
-
-	$forum_list = $s_hidden_fields = '';
-	do
-	{
-		$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;f[]&quot; value=&quot;' . $row['forum_id'] . '&quot; /&gt;';
-	}
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-	$l_selected_forums = (sizeof($forum_id) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
-
-?&gt;
-
-&lt;h2&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM']; ?&gt;&lt;/h2&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang[$l_selected_forums] . ': ' . $forum_list; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot;	action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_prune', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PRUNE']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_NOT_POSTED']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;prune_days&quot; size=&quot;4&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_NOT_VIEWED']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;prune_vieweddays&quot; size=&quot;4&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_OLD_POLLS'] ?&gt;: &lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_OLD_POLLS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_ANNOUNCEMENTS'] ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_STICKY'] ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;1&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $s_hidden_fields; ?&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot;&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-
-adm_page_footer();
-
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_prune_users.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_prune_users.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_prune_users.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,261 +0,0 @@
-&lt;?php
-/***************************************************************************
- *                           admin_prune_users.php
- *                            -------------------
- *   begin                : Saturday, Feb 13, 2001
- *   copyright            : (C) 2001 The phpBB Group
- *   email                : <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">support at phpbb.com</A>
- *
- *   $Id: admin_prune_users.php,v 1.6 2004/05/02 13:05:36 acydburn Exp $
- *
- ***************************************************************************/
-
-/***************************************************************************
- *
- *   This program is free software; you can redistribute it and/or modify
- *   it under the terms of the GNU General Public License as published by
- *   the Free Software Foundation; either version 2 of the License, or
- *   (at your option) any later version.
- *
- ***************************************************************************/
-
-if (!empty($setmodules))
-{
-	if (!$auth-&gt;acl_get('a_userdel'))
-	{
-		return;
-	}
-
-	$module['USER']['PRUNE_USERS'] = basename(__FILE__) . $SID;
-
-	return;
-}
-
-define('IN_PHPBB', 1);
-
-require('pagestart.' . $phpEx);
-
-// Do we have forum admin permissions?
-if (!$auth-&gt;acl_get('a_userdel'))
-{
-	trigger_error($user-&gt;lang['NO_ADMIN']);
-}
-
-// Set mode
-$mode = (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
-
-// Do prune
-if (isset($_POST['prune']))
-{
-	if (empty($_POST['confirm']))
-	{
-		$values = array('prune', 'deactivate', 'delete', 'users', 'username', 'email', 'joined_select', 'active_select', 'count_select', 'joined', 'active', 'count', 'deleteposts');
-
-		$l_message = '&lt;form method=&quot;post&quot; action=&quot;admin_prune_users.' . $phpEx . $SID . '&quot;&gt;' . $user-&gt;lang['Confirm_prune_users'] . '&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;' . $user-&gt;lang['Yes'] . '&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;' . $user-&gt;lang['No'] . '&quot; /&gt;';
-
-		foreach ($values as $field)
-		{
-			$l_message .= (!empty($_POST[$field])) ? '&lt;input type=&quot;hidden&quot; name=&quot;' . $field . '&quot; value=&quot;' . urlencode($_POST[$field]) . '&quot; /&gt;' : '';
-		}
-
-		$l_message .= '&lt;/form&gt;';
-
-		adm_page_header($user-&gt;lang['Prune_users']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-		page_message($user-&gt;lang['CONFIRM'], $l_message, false);
-		adm_page_footer();
-
-	}
-	else if (isset($_POST['confirm']))
-	{
-		if (!empty($_POST['users']))
-		{
-			$users = explode(&quot;\n&quot;, urldecode($_POST['users']));
-
-			$where_sql = '';
-			foreach ($users as $username)
-			{
-				$where_sql .= (($where_sql != '') ? ', ' : '') . '\'' . trim($username) . '\'';
-			}
-			$where_sql = &quot; AND username IN ($where_sql)&quot;;
-		}
-		else
-		{
-			$username = (!empty($_POST['username'])) ? urldecode($_POST['username']) : '';
-			$email = (!empty($_POST['email'])) ? urldecode($_POST['email']) : '';
-
-			$joined_select = (!empty($_POST['joined_select'])) ? $_POST['joined_select'] : 'lt';
-			$active_select = (!empty($_POST['active_select'])) ? $_POST['active_select'] :'lt';
-			$count_select = (!empty($_POST['count_select'])) ? $_POST['count_select'] : 'eq';
-			$joined = (!empty($_POST['joined'])) ? explode('-', $_POST['joined']) : array();
-			$active = (!empty($_POST['active'])) ? explode('-', $_POST['active']) :array();
-			$count = (!empty($_POST['count'])) ? intval($_POST['count']) : '';
-
-			$key_match = array('lt' =&gt; '&lt;', 'gt' =&gt; '&gt;', 'eq' =&gt; '=');
-			$sort_by_types = array('username', 'user_email', 'user_posts', 'user_regdate', 'user_lastvisit');
-
-			$where_sql = '';
-			$where_sql .= ($username) ? &quot; AND username LIKE '&quot; . str_replace('*', '%', $username) .&quot;'&quot; : '';
-			$where_sql .= ($email) ? &quot; AND user_email LIKE '&quot; . str_replace('*', '%', $email) .&quot;' &quot; : '';
-			$where_sql .= ($joined) ? &quot; AND user_regdate &quot; . $key_match[$joined_select] . &quot; &quot; . gmmktime(0, 0, 0, intval($joined[1]), intval($joined[2]), intval($joined[0])) : '';
-			$where_sql .= ($count) ? &quot; AND user_posts &quot; . $key_match[$count_select] . &quot; $count &quot; : '';
-			$where_sql .= ($active) ? &quot; AND user_lastvisit &quot; . $key_match[$active_select] . &quot; &quot; . gmmktime(0, 0, 0, $active[1], intval($active[2]), intval($active[0])) : '';
-		}
-
-		$sql = 'SELECT username, user_id FROM ' . USERS_TABLE . '
-			WHERE user_id &lt;&gt; ' . ANONYMOUS . &quot;
-			$where_sql&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		$where_sql = '';
-		$user_ids = array();
-		$usernames = array();
-		if ($row = $db-&gt;sql_fetchrow($result))
-		{
-			do
-			{
-				$where_sql .= (($where_sql != '') ? ', ' : '') . $row['user_id'];
-				$user_ids[] = $row['user_id'];
-				$usernames[] = $row['username'];
-			}
-			while ($row = $db-&gt;sql_fetchrow($result));
-
-			$where_sql = &quot; AND user_id IN ($where_sql)&quot;;
-		}
-		$db-&gt;sql_freeresult($result);
-
-		if ($where_sql != '')
-		{
-			$sql = '';
-			if (!empty($_POST['delete']))
-			{
-				if (!empty($_POST['deleteposts']))
-				{
-					// Call unified post deletion routine?
-
-					$l_log = 'LOG_PRUNE_USER_DEL_DEL';
-				}
-				else
-				{
-					for($i = 0; $i &lt; sizeof($user_ids); $i++)
-					{
-						$sql = 'UPDATE ' . POSTS_TABLE . '
-							SET poster_id = ' . ANONYMOUS . &quot;, post_username = '&quot; . $usernames[$i] . &quot;'
-							WHERE user_id = &quot; . $userids[$i];
-//						$db-&gt;sql_query($sql);
-					}
-
-					$l_log = 'LOG_PRUNE_USER_DEL_ANON';
-				}
-
-				$sql = 'DELETE FROM ' . USERS_TABLE;
-			}
-			else if (!empty($_POST['deactivate']))
-			{
-				$sql = 'UPDATE ' . USERS_TABLE . &quot; 
-					SET user_active = 0&quot;;
-
-				$l_log = 'LOG_PRUNE_USER_DEAC';
-			}
-
-			$sql .= ' WHERE user_id &lt;&gt; ' . ANONYMOUS . &quot;
-				$where_sql&quot;;
-//			$db-&gt;sql_query($sql);
-
-			add_log('admin', $l_log, implode(', ', $usernames));
-
-			unset($user_ids);
-			unset($usernames);
-		}
-
-		trigger_error($user-&gt;lang['SUCCESS_USER_PRUNE']);
-	}
-}
-
-
-// Front end
-$find_count = array('lt' =&gt; $user-&gt;lang['LESS_THAN'], 'eq' =&gt; $user-&gt;lang['EQUAL_TO'], 'gt' =&gt; $user-&gt;lang['MORE_THAN']);
-$s_find_count = '';
-foreach ($find_count as $key =&gt; $value)
-{
-	$selected = ($key == 'eq') ? ' selected=&quot;selected&quot;' : '';
-	$s_find_count .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-}
-
-$find_time = array('lt' =&gt; $user-&gt;lang['BEFORE'], 'gt' =&gt; $user-&gt;lang['AFTER']);
-$s_find_join_time = '';
-foreach ($find_time as $key =&gt; $value)
-{
-	$s_find_join_time .= '&lt;option value=&quot;' . $key . '&quot;&gt;' . $value . '&lt;/option&gt;';
-}
-$s_find_active_time = '';
-foreach ($find_time as $key =&gt; $value)
-{
-	$s_find_active_time .= '&lt;option value=&quot;' . $key . '&quot;&gt;' . $value . '&lt;/option&gt;';
-}
-
-//
-//
-//
-adm_page_header($user-&gt;lang['PRUNE_USERS']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;post&quot; action=&quot;&lt;?php echo &quot;admin_prune_users.$phpEx$SID&quot;; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; width=&quot;95%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['USERNAME']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;username&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['EMAIL']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;email&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['JOINED']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['Joined_explain']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;joined_select&quot;&gt;&lt;?php echo $s_find_join_time; ?&gt;&lt;/select&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;joined&quot; maxlength=&quot;10&quot; size=&quot;10&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['LAST_ACTIVE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['Last_active_explain']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;active_select&quot;&gt;&lt;?php echo $s_find_active_time; ?&gt;&lt;/select&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;active&quot; maxlength=&quot;10&quot; size=&quot;10&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['POSTS']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;count_select&quot;&gt;&lt;?php echo $s_find_count; ?&gt;&lt;/select&gt; &lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;count&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['PRUNE_USERS']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['SELECT_USERS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea name=&quot;users&quot; cols=&quot;40&quot; rows=&quot;5&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['DELETE_USER_POSTS']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['DELETE_USER_POSTS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;deleteposts&quot; value=&quot;1&quot; /&gt; &lt;?php echo $user-&gt;lang['YES']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;deleteposts&quot; value=&quot;0&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['DEACTIVATE_DELETE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $user-&gt;lang['DEACTIVATE_DELETE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;delete&quot; /&gt; &lt;?php echo $user-&gt;lang['DELETE_USERS']; ?&gt;&nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;deactivate&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $user-&gt;lang['DEACTIVATE']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $user-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;usersubmit&quot; value=&quot;&lt;?php echo $user-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onClick=&quot;window.open('&lt;?php echo &quot;../search.$phpEx$SID&amp;mode=searchuser&amp;field=users&quot;; ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=650');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;prune&quot; value=&quot;1&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_ranks.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_ranks.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_ranks.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -22,303 +22,189 @@
 // needs work
 
 // Do we have permission?
-if (!$_CLASS['auth']-&gt;acl_get('a_ranks'))
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_ranks'))
 {
 	trigger_error('NO_ADMIN');
 }
 
-// Check mode
-if (isset($_REQUEST['mode']))
-{
-	$mode = $_REQUEST['mode'];
-}
-else
-{
-	// These could be entered via a form button
-	if (isset($_POST['add']))
-	{
-		$mode = 'add';
-	}
-	elseif (isset($_POST['save']))
-	{
-		$mode = 'save';
-	}
-	else
-	{
-		$mode = '';
-	}
-}
 
-$rank_id = (isset($_GET['id'])) ? intval($_GET['id']) : 0;
+$u_action = 'forums&amp;file=admin_ranks';
 
+$_CLASS['core_user']-&gt;add_lang('admin_posting', 'forums');
 
-//
-switch ($mode)
-{
-	case 'edit':
-	case 'add':
+// Set up general vars
+$action = request_var('action', '');
+$action = (isset($_POST['add'])) ? 'add' : $action;
+$action = (isset($_POST['save'])) ? 'save' : $action;
+$rank_id = request_var('id', 0);
 
-		$data = $ranks = $existing_imgs = array();
+$page_title = 'ACP_MANAGE_RANKS';
 
-		$result = $_CLASS['core_db']-&gt;query('SELECT * 
-			FROM ' . FORUMS_RANKS_TABLE . ' 
-			ORDER BY rank_special DESC, rank_min DESC');
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$existing_imgs[] = $row['rank_image'];
-
-			if ($mode == 'edit' &amp;&amp; $rank_id == $row['rank_id'])
-			{
-				$ranks = $row;
-			}
-		}
-// temp stuff
-if (empty($ranks))
+switch ($action)
 {
-$ranks['rank_title'] = $ranks['rank_image'] = $ranks['rank_special'] = $ranks['rank_min'] = '';
-}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		$imglist = filelist($config['ranks_path'], '');
-
-		$edit_img = $filename_list = '';
-		foreach ($imglist as $path =&gt; $img_ary)
-		{
-			foreach ($img_ary as $img)
-			{
-				$img = substr($path, 1) . (($path != '') ? '/' : '') . $img; 
-
-				if (!in_array($img, $existing_imgs) || $mode == 'edit')
-				{
-					if ($ranks &amp;&amp; $img == $ranks['rank_image'])
-					{
-						$selected = ' selected=&quot;selected&quot;';
-						$edit_img = $img;
-					}
-					else
-					{
-						$selected = '';
-					}
-
-					$filename_list .= '&lt;option value=&quot;' . htmlspecialchars($img) . '&quot;' . $selected . '&gt;' . $img . '&lt;/option&gt;';
-				}
-			}
-		}
-		$filename_list = '&lt;option value=&quot;&quot;' . (($edit_img == '') ? ' selected=&quot;selected&quot;' : '') . '&gt;----------&lt;/option&gt;' . $filename_list;
-		unset($existing_imgs);
-		unset($imglist);
-
-		// They want to add a new rank, show the form.
-		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;save&quot; /&gt;';
-
-		adm_page_header($_CLASS['core_user']-&gt;lang['RANKS']);
-
-?&gt;
-
-&lt;script language=&quot;javascript&quot; type=&quot;text/javascript&quot; defer=&quot;defer&quot;&gt;
-&lt;!--
-
-function update_image(newimage)
-{
-	document.image.src = (newimage) ? &quot;&lt;?php echo $config['ranks_path']; ?&gt;/&quot; + newimage : &quot;../images/spacer.gif&quot;;
-}
-
-function update_image_dimensions()
-{
-	if (document.image.height &amp;&amp; document.forms[0].height)
-	{
-		document.forms[0].height.value = document.image.height;
-		document.forms[0].width.value = document.image.width;
-	}
-}
-
-//--&gt;
-&lt;/script&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANKS']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANKS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_ranks&amp;id='.$rank_id, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANKS']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_TITLE']; ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;title&quot; size=&quot;25&quot; maxlength=&quot;40&quot; value=&quot;&lt;?php echo $ranks['rank_title']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_IMAGE']; ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;td valign=&quot;middle&quot;&gt;&lt;select name=&quot;rank_image&quot; onchange=&quot;update_image(this.options[selectedIndex].value);&quot;&gt;&lt;?php echo $filename_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-				&lt;td&gt;&nbsp;&nbsp;&lt;/td&gt;
-				&lt;td valign=&quot;middle&quot;&gt;&lt;img src=&quot;&lt;?php echo ($edit_img) ? $config['ranks_path'] . '/' . $edit_img : '../images/spacer.gif' ?&gt;&quot; name=&quot;image&quot; border=&quot;0&quot; alt=&quot;&quot; title=&quot;&quot; onload=&quot;update_image_dimensions()&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_SPECIAL']; ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;special_rank&quot; value=&quot;1&quot;&lt;?php echo ($ranks['rank_special']) ? ' checked=&quot;checked&quot;' : ''; ?&gt; /&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;special_rank&quot; value=&quot;0&quot;&lt;?php echo (!$ranks['rank_special']) ? ' checked=&quot;checked&quot;' : ''; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_MINIMUM']; ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;min_posts&quot; size=&quot;5&quot; maxlength=&quot;10&quot; value=&quot;&lt;?php echo ($ranks['rank_special']) ? '' : $ranks['rank_min']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $s_hidden_fields; ?&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		adm_page_footer();
-
-		break;
-
 	case 'save':
+		
+		$rank_title = request_var('title', '', true);
+		$special_rank = request_var('special_rank', 0);
+		$min_posts = ($special_rank) ? 0 : request_var('min_posts', 0);
+		$rank_image = request_var('rank_image', '');
 
-		//
-		// Ok, they sent us our info, let's update it.
-		//
-
-		$rank_id = (isset($_REQUEST['id'])) ? intval($_REQUEST['id']) : 0;
-		$rank_title = (isset($_POST['title'])) ? trim($_POST['title']) : '';
-		$special_rank = (!empty($_POST['special_rank'])) ? 1 : 0;
-		$min_posts = (isset($_POST['min_posts'])) ? intval($_POST['min_posts']) : -1;
-		$rank_image = (isset($_POST['rank_image'])) ? trim(htmlspecialchars($_POST['rank_image'])) : '';
-
-		if ($special_rank == 1)
-		{
-			$min_posts = -1;
-		}
-
 		// The rank image has to be a jpg, gif or png
 		if ($rank_image != '' &amp;&amp; !preg_match('#(\.gif|\.png|\.jpg|\.jpeg)$#i', $rank_image))
 		{
 			$rank_image = '';
 		}
 
-		if ($rank_id)
+		if (!$rank_title)
 		{
-			$sql = &quot;UPDATE &quot; . FORUMS_RANKS_TABLE . &quot;
-				SET rank_title = '&quot; . $_CLASS['core_db']-&gt;escape($rank_title) . &quot;', rank_special = $special_rank, rank_min = $min_posts, rank_image = '&quot; . $_CLASS['core_db']-&gt;escape($rank_image) . &quot;'
-				WHERE rank_id = $rank_id&quot;;
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_RANK_TITLE'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
+		}
 
+		$sql_ary = array(
+			'rank_title'		=&gt; $rank_title,
+			'rank_special'		=&gt; $special_rank,
+			'rank_min'			=&gt; $min_posts,
+			'rank_image'		=&gt; html_entity_decode($rank_image)
+		);
+		
+		if ($rank_id)
+		{
+			$sql = 'UPDATE ' . FORUMS_RANKS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . &quot; WHERE rank_id = $rank_id&quot;;
 			$message = $_CLASS['core_user']-&gt;lang['RANK_UPDATED'];
 		}
 		else
 		{
-			$sql = &quot;INSERT INTO &quot; . FORUMS_RANKS_TABLE . &quot; (rank_title, rank_special, rank_min, rank_image)
-				VALUES ('&quot; . $_CLASS['core_db']-&gt;escape($rank_title) . &quot;', $special_rank, $min_posts, '&quot; . $_CLASS['core_db']-&gt;escape($rank_image) . &quot;')&quot;;
-
+			$sql = 'INSERT INTO ' . FORUMS_RANKS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary);
 			$message = $_CLASS['core_user']-&gt;lang['RANK_ADDED'];
 		}
 		$_CLASS['core_db']-&gt;query($sql);
 
 		$_CLASS['core_cache']-&gt;destroy('ranks');
 
-		trigger_error($message);
+		trigger_error($message . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 
-		break;
+	break;
 
 	case 'delete':
 
 		// Ok, they want to delete their rank
-		$rank_id = (isset($_REQUEST['id'])) ? intval($_REQUEST['id']) : 0;
-
 		if ($rank_id)
 		{
-			$sql = &quot;DELETE FROM &quot; . FORUMS_RANKS_TABLE . &quot;
+			$sql = 'DELETE FROM ' . FORUMS_RANKS_TABLE . &quot;
 				WHERE rank_id = $rank_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
 
-			$sql = &quot;UPDATE &quot; . USERS_TABLE . &quot;
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . &quot;
 				SET user_rank = 0
 				WHERE user_rank = $rank_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
 
 			$_CLASS['core_cache']-&gt;destroy('ranks');
 
-			trigger_error($_CLASS['core_user']-&gt;lang['RANK_REMOVED']);
+			trigger_error($_CLASS['core_user']-&gt;lang['RANK_REMOVED'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))));
 		}
 		else
 		{
-			trigger_error($_CLASS['core_user']-&gt;lang['MUST_SELECT_RANK']);
+			trigger_error($_CLASS['core_user']-&gt;lang['MUST_SELECT_RANK'] . adm_back_link(generate_link($u_action, array('admin' =&gt; true))), E_USER_WARNING);
 		}
 
-		break;
+	break;
 
-	default:
+	case 'edit':
+	case 'add':
 
-		adm_page_header($_CLASS['core_user']-&gt;lang['RANKS']);
+		$data = $ranks = $existing_imgs = array();
+		
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_RANKS_TABLE . ' 
+			ORDER BY rank_min ASC, rank_special ASC';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-?&gt;
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$existing_imgs[] = $row['rank_image'];
 
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANKS']; ?&gt;&lt;/h1&gt;
+			if ($action === 'edit' &amp;&amp; $rank_id == $row['rank_id'])
+			{
+				$ranks = $row;
+			}
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANKS_EXPLAIN']; ?&gt;&lt;/p&gt;
+		$imglist = filelist($config['ranks_path'], '');
 
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_ranks', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_IMAGE']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_TITLE']; ?&gt;&lt;/th&gt;
-        &lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RANK_MINIMUM']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
+		$edit_img = $filename_list = '';
 
-		// Show the default page
-		$sql = &quot;SELECT * FROM &quot; . FORUMS_RANKS_TABLE . &quot;
-			ORDER BY rank_min ASC, rank_special ASC&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		foreach ($imglist as $path =&gt; $img_ary)
 		{
-			$row_class = 'row2';
-			
-			do
+			foreach ($img_ary as $img)
 			{
-				$row_class = ($row_class != 'row1') ? 'row1' : 'row2';
+				$img = $path . $img; 
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php
-	
-				if ($row['rank_image'])
+				if (!in_array($img, $existing_imgs) || $action == 'edit')
 				{
-		
-?&gt;&lt;img src=&quot;&lt;?php echo $config['ranks_path'] . '/' . $row['rank_image']; ?&gt;&quot;&quot; border=&quot;0&quot; alt=&quot;&lt;?php echo $row['rank_title']; ?&gt;&quot; title=&quot;&lt;?php echo $row['rank_title']; ?&gt;&quot; /&gt;&lt;?php
+					if ($ranks &amp;&amp; $img == $ranks['rank_image'])
+					{
+						$selected = ' selected=&quot;selected&quot;';
+						$edit_img = $img;
+					}
+					else
+					{
+						$selected = '';
+					}
 
+					$filename_list .= '&lt;option value=&quot;' . htmlspecialchars($img) . '&quot;' . $selected . '&gt;' . $img . '&lt;/option&gt;';
 				}
-				else
-				{
-					echo '-';
-				}
-
-?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['rank_title']; ?&gt;&lt;/td&gt;
-        &lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo ($row['rank_special']) ? '-' : $row['rank_min']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo generate_link('forums&amp;file=admin_ranks&amp;mode=edit&amp;id=' . $row['rank_id'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT']; ?&gt;&lt;/a&gt; | &lt;a href=&quot;&lt;?php echo generate_link('forums&amp;file=admin_ranks&amp;mode=delete&amp;id=' . $row['rank_id'], array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
 			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 		}
 
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; class=&quot;btnmain&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_RANK']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
+		$filename_list = '&lt;option value=&quot;&quot;' . (($edit_img == '') ? ' selected=&quot;selected&quot;' : '') . '&gt;----------&lt;/option&gt;' . $filename_list;
+		unset($existing_imgs, $imglist);
 
-&lt;?php
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT'			=&gt; true,
+			'U_BACK'			=&gt; generate_link($u_action, array('admin' =&gt; true)),
+			'RANKS_PATH'		=&gt; $config['ranks_path'],
+			'U_ACTION'			=&gt; generate_link($u_action . '&amp;id=' . $rank_id, array('admin' =&gt; true)),
 
-		adm_page_footer();
+			'RANK_TITLE'		=&gt; (isset($ranks['rank_title'])) ? $ranks['rank_title'] : '',
+			'S_FILENAME_LIST'	=&gt; $filename_list,
+			'RANK_IMAGE'		=&gt; ($edit_img) ? $config['ranks_path'] . '/' . $edit_img : 'images/spacer.gif',
+			'S_SPECIAL_RANK'	=&gt; (!isset($ranks['rank_special']) || $ranks['rank_special']) ? true : false,
+			'MIN_POSTS'			=&gt; (isset($ranks['rank_min']) &amp;&amp; !$ranks['rank_special']) ? $ranks['rank_min'] : 0)
+		);
+				
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_ranks.html');
+		return;
 
-		break;
+	break;
 }
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'U_ACTION'		=&gt; generate_link($u_action, array('admin' =&gt; true))
+));
+
+$sql = 'SELECT *
+	FROM ' . FORUMS_RANKS_TABLE . '
+	ORDER BY rank_min ASC, rank_special ASC, rank_title ASC';
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign_vars_array('ranks', array(
+		'S_RANK_IMAGE'		=&gt; ($row['rank_image']) ? true : false,
+		'S_SPECIAL_RANK'	=&gt; ($row['rank_special']) ? true : false,
+
+		'RANK_IMAGE'		=&gt; $config['ranks_path'] . '/' . $row['rank_image'],
+		'RANK_TITLE'		=&gt; $row['rank_title'],
+		'MIN_POSTS'			=&gt; $row['rank_min'],
+
+		'U_EDIT'			=&gt; generate_link($u_action . '&amp;action=edit&amp;id=' . $row['rank_id'], array('admin' =&gt; true)),
+		'U_DELETE'			=&gt; generate_link($u_action . '&amp;action=delete&amp;id=' . $row['rank_id'], array('admin' =&gt; true))
+	));	
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($page_title), 'modules/forums/admin/acp_ranks.html');
+
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_search.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_search.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_search.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,140 +0,0 @@
-&lt;?php
-/*
-||**************************************************************||
-||  Viperal CMS &#194;&#169; :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
-||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
-||																||
-||**************************************************************||
-||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-// Check permissions
-if (!$_CLASS['auth']-&gt;acl_get('a_search'))
-{
-	trigger_error('NO_ADMIN');
-}
-
-// Start indexing
-if (isset($_POST['start']) || isset($_GET['position']))
-{
-	$limit = 5000; // Process this many posts per batch
-	$start = get_variable('position', 'REQUEST', 0, 'int');
-
-	$count = 0;
-
-	if (!$start)
-	{
-		switch ($_CLASS['core_db']-&gt;db_layer)
-		{
-			case 'sqlite':
-			case 'sqlite_pdo':
-				$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_SEARCH_TABLE);
-				$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_SEARCH_WORD_TABLE);
-				$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_SEARCH_MATCH_TABLE);
-			break;
-			
-			default:
-				$_CLASS['core_db']-&gt;query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
-				$_CLASS['core_db']-&gt;query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
-				$_CLASS['core_db']-&gt;query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
-			break;
-		}
-	}
-
-	// Fetch a batch of posts_text entries
-	$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) AS total FROM ' . FORUMS_POSTS_TABLE);
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if ($total_posts = $row['total'])
-	{
-		require_once(SITE_FILE_ROOT . 'includes/forums/message_parser.php');
-		$fulltext = new fulltext_search();
-
-		$sql = 'SELECT post_id, post_subject, post_text
-			FROM ' . FORUMS_POSTS_TABLE . '
-			ORDER BY post_id';
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, $limit, $start);
-	
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$fulltext-&gt;add('admin', $row['post_id'], $row['post_text'], $row['post_subject']);
-			$count++;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (($start + $count) &lt; $total_posts)
-		{
-			redirect(generate_link('Forums&amp;file=admin_search&amp;position=' . ($start + $count), array('admin' =&gt; true)), 3);
-		}
-		else
-		{
-			// search tidy
-			$fulltext-&gt;search_tidy();
-			$_CLASS['core_db']-&gt;optimize_tables();
-		}
-	}
-
-	adm_page_header($_CLASS['core_user']-&gt;get_lang('SEARCH_INDEX'));
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;get_lang('SEARCH_INDEX'); ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;get_lang('SEARCH_INDEX_COMPLETE'); ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	adm_page_footer();
-
-	die;
-}
-else if (isset($_POST['cancel']))
-{
-	adm_page_header($_CLASS['core_user']-&gt;lang['SEARCH_INDEX']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEARCH_INDEX']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEARCH_INDEX_CANCEL']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	adm_page_footer();
-	die;
-
-}
-
-adm_page_header($_CLASS['core_user']-&gt;lang['SEARCH_INDEX']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEARCH_INDEX']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SEARCH_INDEX_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_search', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot; bgcolor=&quot;#98AAB1&quot;&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;start&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['START']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt; &nbsp; &lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CANCEL']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_viewlogs.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_viewlogs.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_viewlogs.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,230 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_viewlogs.php,v 1.13 2004/11/06 14:11:47 acydburn Exp $
-//
-// FILENAME  : admin_viewlogs.php 
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// Do we have styles admin permissions?
-if (!$_CLASS['auth']-&gt;acl_get('a_'))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-// Set some variables
-$mode		= request_var('mode', 'admin');
-$forum_id	= request_var('f', 0);
-$start		= request_var('start', 0);
-$deletemark = (isset($_POST['delmarked'])) ? true : false;
-$deleteall	= (isset($_POST['delall'])) ? true : false;
-$marked		= request_var('mark', array('' =&gt; ''));
-
-// Sort keys
-$sort_days	= request_var('st', 0);
-$sort_key	= request_var('sk', 't');
-$sort_dir	= request_var('sd', 'd');
-
-// Define some vars depending on which logs we're looking at
-$log_type = ($mode == 'admin') ? LOG_ADMIN : (($mode == 'mod') ? LOG_MOD : LOG_CRITICAL);
-
-$_CLASS['core_user']-&gt;add_lang('mcp');
-
-// Delete entries if requested and able
-if (($deletemark || $deleteall) &amp;&amp; $_CLASS['auth']-&gt;acl_get('a_clearlogs'))
-{
-	$where_sql = '';
-	if ($deletemark &amp;&amp; $marked)
-	{
-		$sql_in = array();
-		foreach ($marked as $mark)
-		{
-			$sql_in[] =  $mark;
-		}
-		$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
-		unset($sql_in);
-	}
-
-	$sql = 'DELETE FROM ' . LOG_TABLE . &quot;
-		WHERE log_type = $log_type 
-			$where_sql&quot;;
-	$_CLASS['core_db']-&gt;sql_query($sql);
-
-	add_log('admin', 'LOG_' . strtoupper($mode) . '_CLEAR');
-}
-
-// Sorting
-$limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_ENTRIES'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
-$sort_by_text = array('u' =&gt; $_CLASS['core_user']-&gt;lang['SORT_USERNAME'], 't' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DATE'], 'i' =&gt; $_CLASS['core_user']-&gt;lang['SORT_IP'], 'o' =&gt; $_CLASS['core_user']-&gt;lang['SORT_ACTION']);
-$sort_by_sql = array('u' =&gt; 'l.user_id', 't' =&gt; 'l.log_time', 'i' =&gt; 'l.log_ip', 'o' =&gt; 'l.log_operation');
-
-$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
-gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
-
-// Define where and sort sql for use in displaying logs
-$sql_where = ($sort_days) ? (time() - ($sort_days * 86400)) : 0;
-$sql_sort = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
-
-$l_title = $_CLASS['core_user']-&gt;lang[strtoupper($mode) . '_LOGS'];
-$l_title_explain = $_CLASS['core_user']-&gt;lang[strtoupper($mode) . '_LOGS_EXPLAIN'];
-
-// Output page
-adm_page_header($l_title);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
-
-&lt;form name=&quot;list&quot; method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_viewlogs&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;
-&lt;?php
-
-// Define forum list if we're looking @ mod logs
-if ($mode == 'mod')
-{
-
-	$forum_box = '&lt;option value=&quot;0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_FORUMS'] . '&lt;/option&gt;' . make_forum_select($forum_id);
-
-?&gt;
-&lt;table width=&quot;100%&quot; cellpadding=&quot;1&quot; cellspacing=&quot;1&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;: &lt;select name=&quot;f&quot; onchange=&quot;if(this.options[this.selectedIndex].value != -1){ this.form.submit() }&quot;&gt;&lt;?php echo $forum_box; ?&gt;&lt;/select&gt; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-&lt;?php
-
-}
-
-//
-// Grab log data
-//
-$log_data = array();
-$log_count = 0;
-view_log($mode, $log_data, $log_count, $config['topics_per_page'], $start, $forum_id, 0, 0, $sql_where, $sql_sort);
-
-?&gt;
-&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;tr&gt;
-	&lt;td align=&quot;left&quot; valign=&quot;top&quot;&gt;&nbsp;&lt;span class=&quot;nav&quot;&gt;&lt;?php echo on_page($log_count, $config['topics_per_page'], $start); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;
-		&lt;span class=&quot;nav&quot;&gt;&lt;?php	echo generate_pagination(&quot;admin_viewlogs&amp;mode=$mode&amp;$u_sort_param&quot;, $log_count, $config['topics_per_page'], $start, true); ?&gt;&lt;/span&gt;
-	&lt;/td&gt;
-&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DISPLAY_LOG']; ?&gt;: &nbsp;&lt;?php echo $s_limit_days; ?&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['SORT_BY']; ?&gt;: &lt;?php echo $s_sort_key; ?&gt; &lt;?php echo $s_sort_dir; ?&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; name=&quot;sort&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;th width=&quot;15%&quot; height=&quot;25&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['USERNAME']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;15%&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['IP']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;20%&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['TIME']; ?&gt;&lt;/th&gt;
-		&lt;th width=&quot;45%&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION']; ?&gt;&lt;/th&gt;
-		&lt;th nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-if ($log_count)
-{
-	for($i = 0; $i &lt; sizeof($log_data); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-		
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $log_data[$i]['username']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $log_data[$i]['ip']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;format_date($log_data[$i]['time']); ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&lt;?php 
-			echo $log_data[$i]['action']; 
-
-			$data = array();
-				
-			foreach (array('viewtopic', 'viewlogs', 'viewforum') as $check)
-			{
-				if ($log_data[$i][$check])
-				{
-					$data[] = '&lt;a href=&quot;' . $log_data[$i][$check] . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['LOGVIEW_' . strtoupper($check)] . '&lt;/a&gt;';
-				}
-			}
-
-			if (sizeof($data))
-			{
-				echo '&lt;br /&gt;&#187; &lt;span class=&quot;gensmall&quot;&gt;[ ' . implode(' | ', $data) . ' ]&lt;/span&gt;';
-			}
-?&gt;
-		&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;mark[]&quot; value=&quot;&lt;?php echo $log_data[$i]['id']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-	if ($_CLASS['auth']-&gt;acl_get('a_clearlogs'))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; height=&quot;28&quot; align=&quot;right&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delmarked&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_MARKED']; ?&gt;&quot; /&gt;&nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;delall&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL']; ?&gt;&quot; /&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-}
-else
-{
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;5&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_ENTRIES']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-}
-
-?&gt;
-&lt;/table&gt;
-
-&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;left&quot; valign=&quot;top&quot;&gt;&nbsp;&lt;span class=&quot;nav&quot;&gt;&lt;?php echo on_page($log_count, $config['topics_per_page'], $start); ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;span class=&quot;nav&quot;&gt;&lt;?php
-
-	if ($_CLASS['auth']-&gt;acl_get('a_clearlogs'))
-	{
-
-
-?&gt;&lt;b&gt;&lt;a href=&quot;javascript:marklist('list', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('list', false);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/b&gt;&nbsp;&lt;br /&gt;&lt;br /&gt;&lt;?php
-
-	}
-
-	echo generate_pagination(&quot;Forums&amp;file=admin_viewlogs&amp;mode=$mode&amp;$u_sort_param&quot;, $log_count, $config['topics_per_page'], $start, true);
-	
-?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-function marklist(match, status)
-{
-	len = eval('document.' + match + '.length');
-	for (i = 0; i &lt; len; i++)
-	{
-		eval('document.' + match + '.elements[i].checked = ' + status);
-	}
-}
-//--&gt;
-&lt;/script&gt;
-
-&lt;?php
-
-adm_page_footer();
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/admin_words.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_words.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/admin_words.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,205 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_words.php,v 1.8 2004/05/30 19:24:48 acydburn Exp $
-//
-// FILENAME  : admin_words.php 
-// STARTED   : Thu Jul 12, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-if (!empty($setmodules))
-{
-	if (!$auth-&gt;acl_get('a_words'))
-	{
-		return;
-	}
-
-	$module['POST']['WORD_CENSOR'] = basename(__FILE__) . $SID;
-	return;
-}
-
-define('IN_PHPBB', 1);
-// Include files
-$phpbb_root_path = './../';
-$phpEx = substr(strrchr(__FILE__, '.'), 1);
-require('pagestart.' . $phpEx);
-
-// Do we have forum admin permissions?
-if (!$auth-&gt;acl_get('a_words'))
-{
-	trigger_error($user-&gt;lang['NO_ADMIN']);
-}
-
-$mode = request_var('mode', '');
-$mode = (isset($_POST['add'])) ? 'add' : ((isset($_POST['save'])) ? 'save' : $mode);
-
-$s_hidden_fields = '';
-$word_info = array();
-
-switch ($mode)
-{
-	case 'edit':
-		$word_id = request_var('id', 0);
-		
-		if (!$word_id)
-		{
-			trigger_error($user-&gt;lang['NO_WORD']);
-		}
-
-		$sql = 'SELECT *
-			FROM ' . WORDS_TABLE . &quot;
-			WHERE word_id = $word_id&quot;;
-		$result = $db-&gt;sql_query_limit($sql, 1);
-
-		$word_info = $db-&gt;sql_fetchrow($result);
-		$db-&gt;sql_freeresult($result);
-
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;' . $word_id . '&quot; /&gt;';
-
-	case 'add':
-
-		adm_page_header($user-&gt;lang['WORDS_TITLE']);
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['WORDS_TITLE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['WORDS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo &quot;admin_words.$phpEx$SID&quot;; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['EDIT_WORD']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['WORD']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;word&quot; value=&quot;&lt;?php echo $word_info['word']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $user-&gt;lang['REPLACEMENT']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;replacement&quot; value=&quot;&lt;?php echo $word_info['replacement']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;?php echo $s_hidden_fields; ?&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;save&quot; value=&quot;&lt;?php echo $user-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-			adm_page_footer();
-			break;
-
-		case 'save':
-			$word_id = request_var('id', 0);
-			$word = request_var('word', '');
-			$replacement = request_var('replacement', '');
-
-			if (!$word || !$replacement)
-			{
-				trigger_error($user-&gt;lang['ENTER_WORD']);
-			}
-
-			$sql = ($word_id) ? &quot;UPDATE &quot; . WORDS_TABLE . &quot; SET word = '&quot; . $db-&gt;sql_escape($word) . &quot;', replacement = '&quot; . $db-&gt;sql_escape($replacement) . &quot;' WHERE word_id = $word_id&quot; : &quot;INSERT INTO &quot; . WORDS_TABLE . &quot; (word, replacement) VALUES ('&quot; . $db-&gt;sql_escape($word) . &quot;', '&quot; . $db-&gt;sql_escape($replacement) . &quot;')&quot;;
-			$db-&gt;sql_query($sql);
-
-			$cache-&gt;destroy('word_censors');
-
-			$log_action = ($word_id) ? 'LOG_EDIT_WORD' : 'LOG_ADD_WORD';
-			add_log('admin', $log_action, $word);
-
-			$message = ($word_id) ? $user-&gt;lang['WORD_UPDATED'] : $user-&gt;lang['WORD_ADDED'];
-			trigger_error($message);
-			break;
-
-		case 'delete':
-
-			$word_id = request_var('id', 0);
-
-			if (!$word_id)
-			{
-				trigger_error($user-&gt;lang['NO_WORD']);
-			}
-
-			$sql = 'SELECT word
-				FROM ' . WORDS_TABLE . &quot;
-				WHERE word_id = $word_id&quot;;
-			$result = $db-&gt;sql_query($sql);
-			$deleted_word = $db-&gt;sql_fetchfield('word', 0, $result);
-			$db-&gt;sql_freeresult($result);
-
-			$sql = 'DELETE FROM ' . WORDS_TABLE . &quot;
-				WHERE word_id = $word_id&quot;;
-			$db-&gt;sql_query($sql);
-
-			$cache-&gt;destroy('word_censors');
-
-			add_log('admin', 'LOG_DELETE_WORD', $deleted_word);
-
-			$message = $user-&gt;lang['WORD_REMOVE'];
-			trigger_error($message);
-		
-			break;
-
-		default:
-
-			adm_page_header($user-&gt;lang['WORDS_TITLE']);
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $user-&gt;lang['WORDS_TITLE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $user-&gt;lang['WORDS_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;admin_words.&lt;?php echo $phpEx . $SID; ?&gt;&quot;&gt;&lt;table class=&quot;bg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;&lt;?php echo $user-&gt;lang['WORD']; ?&gt;&lt;/th&gt;
-		&lt;th&gt;&lt;?php echo $user-&gt;lang['REPLACEMENT']; ?&gt;&lt;/th&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $user-&gt;lang['ACTION']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-
-&lt;?php
-
-		$sql = 'SELECT *
-			FROM ' . WORDS_TABLE . '
-			ORDER BY word';
-		$result = $db-&gt;sql_query($sql);
-
-		$row_class = '';
-		if ($row = $db-&gt;sql_fetchrow($result))
-		{
-			do
-			{
-				$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['word']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;?php echo $row['replacement']; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo &quot;admin_words.$phpEx$SID&amp;mode=edit&amp;id=&quot; . $row['word_id']; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['EDIT']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-		&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo &quot;admin_words.$phpEx$SID&amp;mode=delete&amp;id=&quot; . $row['word_id']; ?&gt;&quot;&gt;&lt;?php echo $user-&gt;lang['DELETE']; ?&gt;&lt;/a&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			}
-			while ($row = $db-&gt;sql_fetchrow($result));
-		}
-		$db-&gt;sql_freeresult($result);
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;5&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;?php echo $s_hidden_fields; ?&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;add&quot; value=&quot;&lt;?php echo $user-&gt;lang['ADD_WORD']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-		adm_page_footer();
-		break;
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/auth.php
===================================================================
--- cms/trunk/includes/forums/admin/auth.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/auth.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -95,14 +95,14 @@
 		global $_CLASS;
 
 		$hold_ary = array();
-		$view_user_mask = ($mode == 'view' &amp;&amp; $group_id === false) ? true : false;
+		$view_user_mask = ($mode === 'view' &amp;&amp; $group_id === false) ? true : false;
 
 		if ($auth_option === false || $scope === false)
 		{
 			return array();
 		}
 
-		$acl_user_function = ($mode == 'set') ? 'acl_user_raw_data' : 'acl_raw_data';
+		$acl_user_function = ($mode === 'set') ? 'acl_user_raw_data' : 'acl_raw_data';
 
 		if (!$view_user_mask)
 		{
@@ -112,7 +112,7 @@
 			}
 			else
 			{
-				$hold_ary = ($group_id !== false) ? $this-&gt;acl_group_raw_data($group_id, $auth_option . '%', ($scope == 'global') ? 0 : false) : $this-&gt;$acl_user_function($user_id, $auth_option . '%', ($scope == 'global') ? 0 : false);
+				$hold_ary = ($group_id !== false) ? $this-&gt;acl_group_raw_data($group_id, $auth_option . '%', ($scope === 'global') ? 0 : false) : $this-&gt;$acl_user_function($user_id, $auth_option . '%', ($scope === 'global') ? 0 : false);
 			}
 		}
 
@@ -308,7 +308,7 @@
 		$ug_names_ary = array();
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$ug_names_ary[$row['ug_id']] = ($user_mode == 'user') ? $row['ug_name'] : (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['ug_name']] : $row['ug_name']);
+			$ug_names_ary[$row['ug_id']] = ($user_mode === 'user') ? $row['ug_name'] : (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['ug_name']] : $row['ug_name']);
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -384,38 +384,31 @@
 
 		// Now obtain memberships
 		$user_groups_default = $user_groups_custom = array();
-		if ($user_mode == 'user' &amp;&amp; $group_display)
+		if ($user_mode === 'user' &amp;&amp; $group_display)
 		{
-			$sql = 'SELECT group_id, group_name, group_type
-				FROM ' . CORE_GROUPS_TABLE . '
-				ORDER BY group_type DESC, group_name ASC';
-			$result = $_CLASS['core_db']-&gt;query($sql);
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
-			$groups = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$groups[$row['group_id']] = $row;
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
+			$memberships = group_membership(array_keys($hold_ary));
 
-			$memberships = group_memberships(false, array_keys($hold_ary), false);
-
 			// User is not a member of any group? Bad admin, bad bad admin...
 			if ($memberships)
 			{
-				foreach ($memberships as $row)
+				foreach ($memberships as $user_id =&gt; $group_array)
 				{
-					if ($groups[$row['group_id']]['group_type'] == GROUP_SPECIAL)
+					foreach ($group_array as $row)
 					{
-						$user_groups_default[$row['user_id']][] = $_CLASS['core_user']-&gt;lang['G_' . $groups[$row['group_id']]['group_name']];
+						if ($row['group_type'] == GROUP_SYSTEM)
+						{
+							$user_groups_default[$row['user_id']][] = $_CLASS['core_user']-&gt;get_lang('G_' . $row['group_name']);
+						}
+						else
+						{
+							$user_groups_custom[$row['user_id']][] = $_CLASS['core_user']-&gt;get_lang('G_' . $row['group_name']);
+						}
 					}
-					else
-					{
-						$user_groups_custom[$row['user_id']][] = $groups[$row['group_id']]['group_name'];
-					}
 				}
 			}
-			unset($memberships, $groups);
+			unset($memberships);
 		}
 
 		// If we only have one forum id to display or being in local mode and more than one user/group to display, 
@@ -615,13 +608,16 @@
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
+		$count = 0;
+
 		foreach ($hold_ary as $forum_id =&gt; $auth_ary)
 		{
-			$_CLASS['core_template']-&gt;assign_vars_array('role_mask', array(
+			$role_mask[$count] = array(
 				'NAME'				=&gt; ($forum_id == 0) ? $_CLASS['core_user']-&gt;lang['GLOBAL_MASK'] : $forum_names[$forum_id],
-				'FORUM_ID'			=&gt; $forum_id)
+				'FORUM_ID'			=&gt; $forum_id
 			);
 
+
 			if (isset($auth_ary['users']) &amp;&amp; sizeof($auth_ary['users']))
 			{
 				$sql = 'SELECT user_id, username
@@ -632,10 +628,10 @@
 
 				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
-					$_CLASS['core_template']-&gt;assign_vars_array('role_mask.users', array(
+					$role_mask[$count]['users'][] = array(
 						'USER_ID'		=&gt; $row['user_id'],
 						'USERNAME'		=&gt; $row['username'],
-						'U_PROFILE'		=&gt; append_sid(&quot;{$phpbb_root_path}memberlist.$phpEx&quot;, &quot;mode=viewprofile&amp;u={$row['user_id']}&quot;))
+						'U_PROFILE'		=&gt; generate_link(&quot;members_list&amp;mode=viewprofile&amp;u={$row['user_id']}&quot;)
 					);
 				}
 				$_CLASS['core_db']-&gt;free_result($result);
@@ -651,15 +647,17 @@
 
 				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
-					$_CLASS['core_template']-&gt;assign_vars_array('role_mask.groups', array(
+					$role_mask[$count]['groups'][] = array(
 						'GROUP_ID'		=&gt; $row['group_id'],
-						'GROUP_NAME'	=&gt; ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
-						'U_PROFILE'		=&gt; append_sid(&quot;{$phpbb_root_path}memberlist.$phpEx&quot;, &quot;mode=group&amp;g={$row['group_id']}&quot;))
+						'GROUP_NAME'	=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
+						'U_PROFILE'		=&gt; generate_link(&quot;members_list&amp;mode=group&amp;g={$row['group_id']}&quot;)
 					);
 				}
 				$_CLASS['core_db']-&gt;free_result($result);
 			}
+			$count++;
 		}
+		$_CLASS['core_template']-&gt;assign('role_mask', $role_mask);
 	}
 
 	/**

Modified: cms/trunk/includes/forums/admin/links.php
===================================================================
--- cms/trunk/includes/forums/admin/links.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/links.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -4,47 +4,38 @@
 	die; 
 }
 
-//Need to be in the admin menu look into making a new one or using this one :-)
-/*if ($_CLASS['forums_auth']-&gt;acl_get('a_ban'))
-{
-	$module['USER']['BAN_USERS'] = generate_link('forums&amp;file=admin_ban'..'&amp;mode=user');
-	$module['USER']['BAN_EMAILS'] = generate_link('forums&amp;file=admin_ban'..'&amp;mode=email');
-	$module['USER']['BAN_IPS'] = generate_link('forums&amp;file=admin_ban'..'&amp;mode=ip');
-}*/
 
-$module['LOG']['ADMIN_LOGS']			 =  ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_viewlogs&amp;mode=admin', array('admin' =&gt; true)) : false;
-$module['LOG']['MOD_LOGS']				 = ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_viewlogs&amp;mode=mod', array('admin' =&gt; true)) : false;
-$module['LOG']['CRITICAL_LOGS']			 = ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_viewlogs&amp;mode=critical', array('admin' =&gt; true)) : false;
-	
-$module['DB']['SEARCH_INDEX'] 				= ($_CLASS['forums_auth']-&gt;acl_get('a_search')) ? generate_link('forums&amp;file=admin_search', array('admin' =&gt; true)) : false;
+$module['ACP_LOGGING']['ACP_ADMIN_LOGS']			 =  ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_logs&amp;mode=admin', array('admin' =&gt; true)) : false;
+$module['ACP_LOGGING']['ACP_MOD_LOGS']				 = ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_logs&amp;mode=mod', array('admin' =&gt; true)) : false;
+$module['ACP_LOGGING']['ACP_CRITICAL_LOGS']			 = ($_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('forums&amp;file=admin_logs&amp;mode=critical', array('admin' =&gt; true)) : false;
 
-$module['USER']['RANKS']					= ($_CLASS['forums_auth']-&gt;acl_get('a_ranks')) ? generate_link('forums&amp;file=admin_ranks', array('admin' =&gt; true)) : '';
-$module['USER']['DISALLOW']					= ($_CLASS['forums_auth']-&gt;acl_get('a_names')) ? generate_link('forums&amp;file=admin_disallow', array('admin' =&gt; true)) : '';
+$module['ACP_MANAGE_FORUMS']['ACP_MANAGE_FORUMS']		= ($_CLASS['forums_auth']-&gt;acl_gets('a_forum', 'a_forumadd', 'a_forumdel')) ? generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) : false;
+$module['ACP_MANAGE_FORUMS']['ACP_PRUNE_FORUMS']   		= ($_CLASS['forums_auth']-&gt;acl_get('a_prune')) ? generate_link('forums&amp;file=admin_prune&amp;mode=forums', array('admin' =&gt; true)) : false;
 
-$module['FORUM']['MANAGE']					= ($_CLASS['forums_auth']-&gt;acl_gets('a_forum', 'a_forumadd', 'a_forumdel')) ? generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) : false;
-$module['FORUM']['PRUNE']   				= ($_CLASS['forums_auth']-&gt;acl_get('a_prune')) ? generate_link('forums&amp;file=admin_prune&amp;mode=forums', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_FORUM_PERMISSIONS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups') || $_CLASS['forums_auth']-&gt;acl_get('a_viewauth')) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_forum_local', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_FORUM_MODERATORS'] 		= ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_mod_local', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_USERS_FORUM_PERMISSIONS']	= ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') || $_CLASS['forums_auth']-&gt;acl_get('a_fauth'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_user_local', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_GROUPS_FORUM_PERMISSIONS']	= ($_CLASS['forums_auth']-&gt;acl_get('a_authgroups') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') || $_CLASS['forums_auth']-&gt;acl_get('a_fauth'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_group_local', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_ADMINISTRATORS']			= ($_CLASS['forums_auth']-&gt;acl_get('a_aauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_admin_global', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_MASKS']['ACP_GLOBAL_MODERATORS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_mod_global', array('admin' =&gt; true)) : false;
 
-$module['PERM']['ACP_FORUM_PERMISSIONS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups') || $_CLASS['forums_auth']-&gt;acl_get('a_viewauth')) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_forum_local', array('admin' =&gt; true)) : '';
-$module['PERM']['ACP_FORUM_MODERATORS'] 		= ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_mod_local', array('admin' =&gt; true)) : '';
-$module['PERM']['ACP_USERS_FORUM_PERMISSIONS']	= ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') || $_CLASS['forums_auth']-&gt;acl_get('a_fauth'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_user_local', array('admin' =&gt; true)) : '';
-$module['PERM']['ACP_GROUPS_FORUM_PERMISSIONS']	= ($_CLASS['forums_auth']-&gt;acl_get('a_authgroups') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') || $_CLASS['forums_auth']-&gt;acl_get('a_fauth'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_group_local', array('admin' =&gt; true)) : '';
-$module['PERM']['ACP_ADMINISTRATORS']			= ($_CLASS['forums_auth']-&gt;acl_get('a_aauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_admin_global', array('admin' =&gt; true)) : '';
-$module['PERM']['ACP_GLOBAL_MODERATORS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_mauth') &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('a_authusers') || $_CLASS['forums_auth']-&gt;acl_get('a_authgroups'))) ? generate_link('forums&amp;file=admin_permissions&amp;mode=setting_mod_global', array('admin' =&gt; true)) : '';
+$module['ACP_PERMISSION_ROLES']['ACP_ADMIN_ROLES']		= ($_CLASS['forums_auth']-&gt;acl_get('a_roles') &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_aauth')) ? generate_link('forums&amp;file=admin_permission_roles&amp;mode=admin_roles', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_ROLES']['ACP_USER_ROLES']		= ($_CLASS['forums_auth']-&gt;acl_get('a_roles') &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_uauth')) ? generate_link('forums&amp;file=admin_permission_roles&amp;mode=user_roles', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_ROLES']['ACP_MOD_ROLES']		= ($_CLASS['forums_auth']-&gt;acl_get('a_roles') &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_mauth')) ? generate_link('forums&amp;file=admin_permission_roles&amp;mode=mod_roles', array('admin' =&gt; true)) : false;
+$module['ACP_PERMISSION_ROLES']['ACP_FORUM_ROLES']		= ($_CLASS['forums_auth']-&gt;acl_get('a_roles') &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_fauth')) ? generate_link('forums&amp;file=admin_permission_roles&amp;mode=forum_roles', array('admin' =&gt; true)) : false;
 
-$module['GENERAL']['AVATAR_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_board')) ? generate_link('forums&amp;file=admin_board&amp;mode=avatar', array('admin' =&gt; true)) : '';
-$module['GENERAL']['BOARD_DEFAULTS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_defaults')) ? generate_link('forums&amp;file=admin_board&amp;mode=default', array('admin' =&gt; true)) : '';
-$module['GENERAL']['BOARD_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_board')) ? generate_link('forums&amp;file=admin_board&amp;mode=setting', array('admin' =&gt; true)) : '';
-$module['GENERAL']['EMAIL_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_board&amp;mode=email', array('admin' =&gt; true)) : '';
-$module['GENERAL']['LOAD_SETTINGS']			= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_board&amp;mode=load', array('admin' =&gt; true)) : '';
-$module['GENERAL']['SERVER_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_board&amp;mode=server', array('admin' =&gt; true)) : '';
-$module['GENERAL']['MESSAGE_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_defaults')) ? generate_link('forums&amp;file=admin_board&amp;mode=message', array('admin' =&gt; true)) : '';
-$module['GENERAL']['ATTACHMENT_SETTINGS'] 	= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=attach', array('admin' =&gt; true)) : '';
-$module['GENERAL']['IM'] 					= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_jabber', array('admin' =&gt; true)) : '';
-$module['GENERAL']['PHP_INFO'] 				= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_phpinfo', array('admin' =&gt; true)) : '';
-$module['GENERAL']['MASS_EMAIL']			= ($_CLASS['forums_auth']-&gt;acl_get('a_email')) ? generate_link('forums&amp;file=admin_email', array('admin' =&gt; true)) : '';
 
-$module['POST']['ATTACHMENTS'] 				= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=ext_groups', array('admin' =&gt; true)) : '';
-$module['POST']['BBCODES']					= ($_CLASS['forums_auth']-&gt;acl_get('a_bbcode')) ? generate_link('forums&amp;file=admin_bbcodes', array('admin' =&gt; true)) : '';
-$module['POST']['ICONS']					= ($_CLASS['forums_auth']-&gt;acl_get('a_icons')) ? generate_link('forums&amp;file=admin_icons&amp;mode=icons', array('admin' =&gt; true)) : '';
+$module['ACP_GENERAL_CONFIGURATION']['ACP_BOARD_FEATURES']		= ($_CLASS['forums_auth']-&gt;acl_get('a_board')) ? generate_link('forums&amp;file=admin_board&amp;mode=features', array('admin' =&gt; true)) : false;
+$module['ACP_GENERAL_CONFIGURATION']['ACP_POST_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_board')) ? generate_link('forums&amp;file=admin_board&amp;mode=post', array('admin' =&gt; true)) : false;
+$module['ACP_GENERAL_CONFIGURATION']['ACP_LOAD_SETTINGS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_server')) ? generate_link('forums&amp;file=admin_board&amp;mode=load', array('admin' =&gt; true)) : false;
 
+$module['ATTACHMENTS']['ACP_ATTACHMENT_SETTINGS'] 	= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=attach', array('admin' =&gt; true)) : false;
+$module['ATTACHMENTS']['ACP_MANAGE_EXTENSIONS'] 	= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=extensions', array('admin' =&gt; true)) : false;
+$module['ATTACHMENTS']['ACP_ORPHAN_ATTACHMENTS'] 	= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=orphan', array('admin' =&gt; true)) : false;
+$module['ATTACHMENTS']['ACP_EXTENSION_GROUPS'] 		= ($_CLASS['forums_auth']-&gt;acl_get('a_attach')) ? generate_link('forums&amp;file=admin_attachments&amp;mode=ext_groups', array('admin' =&gt; true)) : false;
+
+$module['ACP_CAT_POSTING']['ACP_RANKS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_ranks')) ? generate_link('forums&amp;file=admin_ranks', array('admin' =&gt; true)) : false;
+$module['ACP_CAT_POSTING']['ACP_BBCODES']	= ($_CLASS['forums_auth']-&gt;acl_get('a_bbcode')) ? generate_link('forums&amp;file=admin_bbcodes', array('admin' =&gt; true)) : false;
+$module['ACP_CAT_POSTING']['ACP_ICONS']		= ($_CLASS['forums_auth']-&gt;acl_get('a_icons')) ? generate_link('forums&amp;file=admin_icons&amp;mode=icons', array('admin' =&gt; true)) : false;
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/main.php
===================================================================
--- cms/trunk/includes/forums/admin/main.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/admin/main.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -82,7 +82,8 @@
 		set_config('num_topics', (int) $row['stat'], true);
 
 		$sql = 'SELECT COUNT(attach_id) as stat
-			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+			FROM ' . FORUMS_ATTACHMENTS_TABLE.'
+			WHERE is_orphan = 0';
 		$result = $_CLASS['core_db']-&gt;query($sql);
 		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	
@@ -90,7 +91,8 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		$sql = 'SELECT SUM(filesize) as stat
-			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+			FROM ' . FORUMS_ATTACHMENTS_TABLE.'
+			WHERE is_orphan = 0';
 		$result = $_CLASS['core_db']-&gt;query($sql);
 		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 
@@ -183,6 +185,14 @@
 	$files_per_day = $total_files;
 }
 
+$sql = 'SELECT COUNT(attach_id) AS total_orphan
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+			WHERE is_orphan = 1';
+$result = $_CLASS['core_db']-&gt;query($sql);
+$total_orphan = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+$total_orphan = (int) $total_orphan['total_orphan'];
+$_CLASS['core_db']-&gt;free_result($result);
+
 // Remove
 $dbsize = $_CLASS['core_user']-&gt;lang['NOT_AVAILABLE'];
 $s_action_options = build_select(array('online' =&gt; 'RESET_ONLINE', 'date' =&gt; 'RESET_DATE', 'stats' =&gt; 'RESYNC_STATS', 'user' =&gt; 'RESYNC_POSTCOUNTS'));
@@ -195,6 +205,7 @@
 	'TOTAL_USERS'		=&gt; $total_users,
 	'USERS_PER_DAY'		=&gt; $users_per_day,
 	'TOTAL_FILES'		=&gt; $total_files,
+	'TOTAL_ORPHAN'		=&gt; $total_orphan,
 	'FILES_PER_DAY'		=&gt; $files_per_day,
 	'START_DATE'		=&gt; $start_date,
 	'AVATAR_DIR_SIZE'	=&gt; $avatar_dir_size,

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/auth.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -458,51 +458,42 @@
 	{
 		global $_CLASS;
 
-		$sql_user = ($user_id) ? (is_array($user_id) ? 'user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
-		$sql_forum = ($forum_id) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
+		$sql_user = ($user_id !== false) ? (is_array($user_id) ? 'a.user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
+		$sql_forum = ($forum_id !== false) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
 
-		$sql_opts = '';
+		$sql_opts = $sql_escape = '';
 
 		if ($opts !== false)
 		{
-			if (!is_array($opts))
-			{
-				$sql_opts = (strpos($opts, '%') !== false) ? &quot;AND ao.auth_option LIKE '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot; : &quot;AND ao.auth_option = '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot;;
-			}
-			else
-			{
-				$sql_opts = &quot;AND ao.auth_option IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($opts)) . &quot;')&quot;;
-			}
+			$this-&gt;build_auth_option_statement('ao.auth_option', $opts, $sql_opts, $sql_escape);
 		}
 
 		$groups = $group_id_array = $group_members = $hold_ary = array();
 
 		if ($sql_user)
 		{
-			$sql = 'SELECT group_id, user_id FROM ' . CORE_USER_GROUP_TABLE .&quot; WHERE $sql_user AND member_status &lt;&gt; &quot;.STATUS_PENDING;
+			$sql = 'SELECT group_id, user_id FROM ' . CORE_USER_GROUP_TABLE .&quot; WHERE $sql_user AND member_status IN (&quot;.STATUS_ACTIVE.', '.STATUS_LEADER.')';
 
 			$result = $_CLASS['core_db']-&gt;query($sql);
 	
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$groups[$row['group_id']] = true;
+				$groups[] = $row['group_id'];
 				$group_members[$row['group_id']][] = $row['user_id'];
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
 
-			$sql_user = empty($groups) ? ' AND a.' . $sql_user :  'AND (a.'.$sql_user.' OR a.group_id IN ('.implode(', ', array_keys($groups)).'))';
+			$sql_user = empty($groups) ? ' AND '.$sql_user :  'AND ('.$sql_user.' OR a.group_id IN ('.implode(', ', $groups).'))';
 			unset($groups);
 		}
 
-		// Sort by group_id since we want user setting to over right grp..  specific &gt; broad
 		$sql = 'SELECT ao.auth_option, a.auth_role_id, r.auth_setting as role_auth_setting, a.user_id, a.group_id, a.forum_id, a.auth_setting
 					FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_TABLE . ' a
-					LEFT JOIN '.FORUMS_ACL_ROLES_DATA_TABLE.&quot; r ON a.auth_role_id = r.role_id
+					LEFT JOIN '.FORUMS_ACL_ROLES_DATA_TABLE.&quot; r ON (a.auth_role_id = r.role_id)
 					WHERE (ao.auth_option_id = a.auth_option_id OR ao.auth_option_id = r.auth_option_id)
-						$sql_user $sql_forum $sql_opts
-						ORDER BY a.group_id, ao.auth_option&quot;;
+						$sql_user $sql_forum $sql_opts&quot;;
 
-		$result = $_CLASS['core_db']-&gt;query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql . $sql_escape);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
@@ -514,34 +505,18 @@
 
 			if ($row['group_id'])
 			{
+
 				$group_id_array[$row['group_id']][] = $row;
 
 				continue;
 			}
-
 			$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $auth_setting;
-
-			/*	// Check for existence of ACL_YES if an option got set to ACL_NEVER
-				if ($setting == ACL_NEVER)
-				{
-					$flag = substr($row['auth_option'], 0, strpos($row['auth_option'], '_') + 1);
-
-					if (isset($hold_ary[$row['user_id']][$row['forum_id']][$flag]) &amp;&amp; $hold_ary[$row['user_id']][$row['forum_id']][$flag] == ACL_YES)
-					{
-						unset($hold_ary[$row['user_id']][$row['forum_id']][$flag]);
-
-						if (in_array(ACL_YES, $hold_ary[$row['user_id']][$row['forum_id']]))
-						{
-							$hold_ary[$row['user_id']][$row['forum_id']][$flag] = ACL_YES;
-						}
-					}
-				}*/
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		if (!empty($group_id_array))
 		{
-			if (empty($group_members))
+			if (!$sql_user)
 			{
 				$sql = 'SELECT user_group, user_id FROM ' . CORE_USERS_TABLE .' 
 					WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).')
@@ -568,74 +543,171 @@
 					{
 						if (!isset($hold_ary[$user_id][$row['forum_id']][$row['auth_option']]) || (isset($hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']]) &amp;&amp; $hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] != ACL_NEVER))
 						{
+							$auth_setting = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
+
 							$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
 						}
-						/*	
-						// Check for existence of ACL_YES if an option got set to ACL_NEVER
-						if ($setting == ACL_NEVER)
-						{
-							$flag = substr($row['auth_option'], 0, strpos($row['auth_option'], '_') + 1);
-		
-							if (isset($hold_ary[$row['user_id']][$row['forum_id']][$flag]) &amp;&amp; $hold_ary[$row['user_id']][$row['forum_id']][$flag] == ACL_YES)
-							{
-								unset($hold_ary[$row['user_id']][$row['forum_id']][$flag]);
-		
-								if (in_array(ACL_YES, $hold_ary[$row['user_id']][$row['forum_id']]))
-								{
-									$hold_ary[$row['user_id']][$row['forum_id']][$flag] = ACL_YES;
-								}
-							}
-						}*/	
 					}
 				}
 			}
+			unset($group_members);
 		}
 
 		return $hold_ary;
 	}
 
+	/**
+	* Get raw user based permission settings
+	*/
+	function acl_user_raw_data($user_id = false, $opts = false, $forum_id = false)
+	{
+		global $_CLASS;
+
+		$sql_user = ($user_id !== false) ? (is_array($user_id) ? 'AND a.user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
+		$sql_forum = ($forum_id !== false) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
+
+		$sql_opts = $sql_escape = '';
+
+		if ($opts !== false)
+		{
+			$this-&gt;build_auth_option_statement('ao.auth_option', $opts, $sql_opts, $sql_escape);
+		}
+
+		$hold_ary = array();
+
+		// Grab user settings...
+		$sql = 'SELECT ao.auth_option, a.auth_role_id, r.auth_setting as role_auth_setting, a.user_id, a.forum_id, a.auth_setting
+			FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_TABLE . ' a
+			LEFT JOIN '.FORUMS_ACL_ROLES_DATA_TABLE.&quot; r ON (a.auth_role_id = r.role_id)
+			WHERE (ao.auth_option_id = a.auth_option_id OR ao.auth_option_id = r.auth_option_id)
+				$sql_user $sql_forum $sql_opts
+			ORDER BY a.forum_id, ao.auth_option&quot;;
+
+		$result = $_CLASS['core_db']-&gt;query($sql . $sql_escape);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			if (!isset($hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']]) || (isset($hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']]) &amp;&amp; $hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] != ACL_NEVER))
+			{
+				$setting = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
+				$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $setting;
+			}
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		return $hold_ary;
+	}
+
 	function acl_group_raw_data($group_id = false, $opts = false, $forum_id = false)
 	{
 		global $_CLASS;
 
-		$sql_group = ($group_id) ? ((!is_array($group_id)) ? &quot;group_id = $group_id&quot; : 'group_id IN (' . implode(', ', $group_id) . ')') : '';
-		$sql_forum = ($forum_id) ? ((!is_array($forum_id)) ? &quot;AND a.forum_id = $forum_id&quot; : 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')') : '';
+		$sql_group = ($group_id !== false) ? (is_array($group_id) ? 'AND a.group_id IN (' . implode(', ', $group_id) . ')' : 'group_id = '.$group_id) : '';
+		$sql_forum = ($forum_id !== false) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
 
-		$sql_opts = '';
+		$sql_opts = $sql_escape = '';
 
 		if ($opts !== false)
 		{
-			if (!is_array($opts))
-			{
-				$sql_opts = (strpos($opts, '%') !== false) ? &quot;AND ao.auth_option LIKE '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot; : &quot;AND ao.auth_option = '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot;;
-			}
-			else
-			{
-				$sql_opts = &quot;AND ao.auth_option IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($opts)) . &quot;')&quot;;
-			}
+			$this-&gt;build_auth_option_statement('ao.auth_option', $opts, $sql_opts, $sql_escape);
 		}
 
 		$hold_ary = array();
 
 		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
-		$sql = 'SELECT a.group_id, ao.auth_option, a.forum_id, a.auth_setting
+		$sql = 'SELECT ao.auth_option, a.auth_role_id, r.auth_setting as role_auth_setting, a.group_id, a.forum_id, a.auth_setting
 			FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_TABLE . ' a
-			WHERE ao.auth_option_id = a.auth_option_id
-				AND a.group_id IS NOT NULL AND a.group_id &lt;&gt; 0
-				' . (($sql_group) ? 'AND a.' . $sql_group : '') . &quot;
-				$sql_forum
-				$sql_opts
+			LEFT JOIN '.FORUMS_ACL_ROLES_DATA_TABLE.&quot; r ON (a.auth_role_id = r.role_id)
+			WHERE (ao.auth_option_id = a.auth_option_id OR ao.auth_option_id = r.auth_option_id)
+				$sql_group $sql_forum $sql_opts
 			ORDER BY a.forum_id, ao.auth_option&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+		$result = $_CLASS['core_db']-&gt;query($sql. $sql_escape);
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+			if (!isset($hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']]) || (isset($hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']]) &amp;&amp; $hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] != ACL_NEVER))
+			{
+				$setting = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
+				$hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']] = $setting;
+			}
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		return $hold_ary;
 	}
+
+	/**
+	* Fill auth_option statement for later querying based on the supplied options
+	*/
+	function build_auth_option_statement($key, $auth_options, &amp;$sql_opts, &amp;$sql_escape)
+	{
+		global $_CLASS;
+
+		if (!is_array($auth_options))
+		{
+			if (strpos($auth_options, '%') !== false)
+			{
+				if (strpos($auth_options, '_') !== false)
+				{
+					$sql_opts = &quot;AND $key LIKE '&quot; . $_CLASS['core_db']-&gt;escape(str_replace('_', &quot;\_&quot;, $auth_options)) . &quot;'&quot;;
+					$sql_escape = ($_CLASS['core_db']-&gt;db_layer == 'mssql' || $_CLASS['core_db']-&gt;db_layer == 'mssql_odbc') ? &quot; ESCAPE '\\'&quot; : '';
+				}
+				else
+				{
+					$sql_opts = &quot;AND $key LIKE '&quot; . $_CLASS['core_db']-&gt;escape($auth_options) . &quot;'&quot;;
+				}
+			}
+			else
+			{
+				$sql_opts = &quot;AND $key = '&quot; . $_CLASS['core_db']-&gt;escape($auth_options) . &quot;'&quot;;
+			}
+		}
+		else
+		{
+			$is_like_expression = $is_underline = false;
+
+			foreach ($auth_options as $option)
+			{
+				if (strpos($option, '%') !== false)
+				{
+					$is_like_expression = true;
+				}
+
+				if (strpos($option, '_') !== false)
+				{
+					$is_underline = true;
+				}
+			}
+
+			if (!$is_like_expression)
+			{
+				$sql_opts = &quot;AND $key IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($auth_options)) . &quot;')&quot;;
+			}
+			else
+			{
+				$sql = array();
+
+				foreach ($auth_options as $option)
+				{
+					if (strpos($option, '%') !== false)
+					{
+						$sql[] = $key . &quot; LIKE '&quot; . $_CLASS['core_db']-&gt;escape(str_replace('_', &quot;\_&quot;, $option)) . &quot;'&quot;;
+					}
+					else
+					{
+						$sql[] = $key . &quot; = '&quot; . $_CLASS['core_db']-&gt;escape(str_replace('_', &quot;\_&quot;, $option)) . &quot;'&quot;;
+					}
+				}
+
+				$sql_opts = 'AND (' . implode(' OR ', $sql) . ')';
+
+				if ($is_underline)
+				{
+					$sql_escape = ($_CLASS['core_db']-&gt;db_layer == 'mssql' || $_CLASS['core_db']-&gt;db_layer == 'mssql_odbc') ? &quot; ESCAPE '\\'&quot; : '';
+				}
+			}
+		}
+	}
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -237,22 +237,29 @@
 
 	$message = str_replace($match, $replace, $message);
 
-	$match = array(
-		'#&lt;!\-\- e \-\-&gt;&lt;a href=&quot;mailto:(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- e \-\-&gt;#',
-		'#&lt;!\-\- m \-\-&gt;&lt;a href=&quot;(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- m \-\-&gt;#',
-		'#&lt;!\-\- w \-\-&gt;&lt;a href=&quot;http:\/\/(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- w \-\-&gt;#',
-		'#&lt;!\-\- l \-\-&gt;&lt;a href=&quot;(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- l \-\-&gt;#',
-		'#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#',
-		'#&lt;!\-\- .*? \-\-&gt;#s',
-		'#&lt;.*?&gt;#s'
-	);
+	$match = get_preg_expression('bbcode_htm');
+	$replace = array('\1', '\2', '\1', '', '');
 	
-	$replace = array('\1', '\1', '\1', '\1', '\1', '', '');
-	
 	$message = preg_replace($match, $replace, $message);
+}
 
-	return;
-}
+/**
+* Strips all bbcode from a text and returns the plain content
+*/
+function strip_bbcode(&amp;$text, $uid = '')
+{
+	if (!$uid)
+	{
+		$uid = '[0-9a-z]{5,}';
+	}
+
+	$text = preg_replace(&quot;#\[\/?[a-z0-9\*\+\-]+(?:=.*?)?(?::[a-z])?(\:?$uid)\]#&quot;, ' ', $text);
+
+	$match = get_preg_expression('bbcode_htm');
+	$replace = array('\1', '\2', '\1', '', '');
+	
+	$text = preg_replace($match, $replace, $text);
+}
 
 /**
 * For display of custom parsed text on user-facing pages
@@ -268,7 +275,7 @@
 	}
 
 	// Parse bbcode if bbcode uid stored and bbcode enabled
-	if ($uid &amp;&amp; ($flags &amp; 1))
+	if ($uid &amp;&amp; ($flags &amp; OPTION_FLAG_BBCODE))
 	{
 		if (!class_exists('bbcode'))
 		{
@@ -287,7 +294,7 @@
 		$bbcode-&gt;bbcode_second_pass($text, $uid);
 	}
 
-	$text = smiley_text($text, !($flags &amp; 2));
+	$text = smiley_text($text, !($flags &amp; OPTION_FLAG_SMILIES));
 	$text = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($text));
 
 	return $text;
@@ -340,9 +347,9 @@
 	decode_message($text, $uid);
 
 	return array(
-		'allow_bbcode'	=&gt; ($flags &amp; 1) ? 1 : 0,
-		'allow_smilies'	=&gt; ($flags &amp; 2) ? 1 : 0,
-		'allow_urls'	=&gt; ($flags &amp; 4) ? 1 : 0,
+		'allow_bbcode'  =&gt; ($flags &amp; OPTION_FLAG_BBCODE) ? 1 : 0,
+		'allow_smilies' =&gt; ($flags &amp; OPTION_FLAG_SMILIES) ? 1 : 0,
+		'allow_urls'    =&gt; ($flags &amp; OPTION_FLAG_LINKS) ? 1 : 0,
 		'text'			=&gt; $text
 	);
 }
@@ -889,8 +896,6 @@
 				$inline_attachments[$key] = false;
 			}
 		}
-//print_r($inline_attachments);
-		//$inline_attachments = display_attachments($forum_id, $inline_attachments, $update_count, $preview, true);
 
 		$replace = array();
 		foreach ($matches[1] as $key =&gt; $index)
@@ -1341,6 +1346,16 @@
 		case 'email':
 			return '[a-z0-9&amp;\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*[a-z]+';
 		break;
+
+		case 'bbcode_htm':
+			return array(
+				'#&lt;!\-\- e \-\-&gt;&lt;a href=&quot;mailto:(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- e \-\-&gt;#',
+				'#&lt;!\-\- (l|m|w) \-\-&gt;&lt;a href=&quot;(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- \1 \-\-&gt;#',
+				'#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#',
+				'#&lt;!\-\- .*? \-\-&gt;#s',
+				'#&lt;.*?&gt;#s',
+			);
+		break;
 	}
 
 	return '';
@@ -1374,11 +1389,11 @@
 
 		// matches a <A HREF="xxxx://aaaaa.bbb.cccc.">xxxx://aaaaa.bbb.cccc.</A> ...
 		$magic_url_match[] = '#(^|[\n ]|\()([\w]+:/{2}.*?([^[ \t\n\r&lt;&quot;\'\)&amp;]+|&amp;(?!lt;|quot;))*)#ie';
-		$magic_url_replace[] = &quot;'\$1&lt;!-- m --&gt;&lt;a href=\&quot;\$2\&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- m --&gt;'&quot;;
+		$magic_url_replace[] = &quot;'\$1&lt;!-- m --&gt;&lt;a href=\&quot;\$2\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- m --&gt;'&quot;;
 
 		// matches a &quot;www.xxxx.yyyy[/zzzz]&quot; kinda lazy URL thing
 		$magic_url_match[] = '#(^|[\n ]|\()(w{3}\.[\w\-]+\.[\w\-.\~]+(?:[^[ \t\n\r&lt;&quot;\'\)&amp;]+|&amp;(?!lt;|quot;))*)#ie';
-		$magic_url_replace[] = &quot;'\$1&lt;!-- w --&gt;&lt;a href=\&quot;<A HREF="http://\$2\">http://\$2\</A>&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- w --&gt;'&quot;;
+		$magic_url_replace[] = &quot;'\$1&lt;!-- w --&gt;&lt;a href=\&quot;<A HREF="http://\$2\">http://\$2\</A>&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- w --&gt;'&quot;;
 
 		// matches an <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">email at domain</A> type address at the start of a line, or after a space or after what might be a BBCode.
 		$magic_url_match[] = '/(^|[\n ]|\()(' . get_preg_expression('email') . ')/ie';
@@ -1388,4 +1403,25 @@
 	return preg_replace($magic_url_match, $magic_url_replace, $text);
 }
 
+/**
+* Generate size select options
+*/
+function size_select_options($size_compare)
+{
+	global $_CLASS;
+
+	$size_types_text = array($_CLASS['core_user']-&gt;lang['BYTES'], $_CLASS['core_user']-&gt;lang['KB'], $_CLASS['core_user']-&gt;lang['MB']);
+	$size_types = array('b', 'kb', 'mb');
+
+	$s_size_options = '';
+
+	for ($i = 0, $size = sizeof($size_types_text); $i &lt; $size; $i++)
+	{
+		$selected = ($size_compare == $size_types[$i]) ? ' selected=&quot;selected&quot;' : '';
+		$s_size_options .= '&lt;option value=&quot;' . $size_types[$i] . '&quot;' . $selected . '&gt;' . $size_types_text[$i] . '&lt;/option&gt;';
+	}
+
+	return $s_size_options;
+}
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_admin.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1579,15 +1579,25 @@
 {
 	global $_CLASS;
 
+	if (!is_array($forum_id))
+	{
+		$forum_id = array($forum_id);
+	}
+
+	if (!sizeof($forum_id))
+	{
+		return;
+	}
+	
 	$sql_forum = (is_array($forum_id)) ? ' IN (' . implode(', ', array_map('intval', $forum_id)) . ')' : ' = '. (int) $forum_id;
 
 	$sql_and = '';
-	if (!($prune_flags &amp; 4))
+	if (!($prune_flags &amp; FORUM_FLAG_PRUNE_ANNOUNCE))
 	{
 		$sql_and .= ' AND topic_type &lt;&gt; ' . POST_ANNOUNCE;
 	}
 
-	if (!($prune_flags &amp; 8))
+	if (!($prune_flags &amp; FORUM_FLAG_PRUNE_STICKY))
 	{
 		$sql_and .= ' AND topic_type &lt;&gt; ' . POST_STICKY;
 	}
@@ -1603,7 +1613,7 @@
 	}
 
 	$sql = 'SELECT topic_id
-		FROM ' . TOPICS_TABLE . &quot;
+		FROM ' . FORUMS_TOPICS_TABLE . &quot;
 		WHERE forum_id $sql_forum
 			AND poll_start = 0 
 			$sql_and&quot;;
@@ -1616,10 +1626,10 @@
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	if ($prune_flags &amp; 2)
+	if ($prune_flags &amp; FORUM_FLAG_PRUNE_POLL)
 	{
 		$sql = 'SELECT topic_id
-			FROM ' . TOPICS_TABLE . &quot;
+			FROM ' . FORUMS_TOPICS_TABLE . &quot;
 			WHERE forum_id $sql_forum 
 				AND poll_start &gt; 0 
 				AND poll_last_vote &lt; $prune_date 
@@ -1646,7 +1656,7 @@
 	global $_CLASS;
 
 	$sql = 'SELECT forum_name
-		FROM ' . FORUMS_TABLE . &quot;
+		FROM ' . FORUMS_FORUMS_TABLE . &quot;
 		WHERE forum_id = $forum_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
@@ -1659,7 +1669,7 @@
 
 		prune($forum_id, $prune_mode, $prune_date, $prune_flags, true);
 
-		$sql = 'UPDATE ' . FORUMS_TABLE . &quot;
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
 			SET prune_next = $next_prune
 			WHERE forum_id = $forum_id&quot;;
 		$_CLASS['core_db']-&gt;query($sql);
@@ -1994,6 +2004,32 @@
 	return;
 }
 
+/**
+* Update foes - remove moderators and administrators from foe lists...
+*/
+function update_foes()
+{
+	global $_CLASS;
+
+	$perms = array();
+	foreach ($_CLASS['forums_auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
+	{
+		foreach ($forum_ary as $auth_option =&gt; $user_ary)
+		{
+			$perms = array_merge($perms, $user_ary);
+		}
+	}
+
+	if (sizeof($perms))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE zebra_id IN (' . implode(', ', array_unique($perms)) . ')
+				AND foe = 1';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	unset($perms);
+}
+
 // Extension of auth class for changing permissions
 if (class_exists('forums_auth'))
 {

Deleted: cms/trunk/includes/forums/functions_compress.php
===================================================================
--- cms/trunk/includes/forums/functions_compress.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_compress.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,627 +0,0 @@
-&lt;?
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------------------
-//
-// $Id: functions_compress.php,v 1.16 2003/08/22 00:35:59 psotfx Exp $
-//
-// FILENAME  : functions_compress.php
-// STARTED   : Sat Jul 19 2003
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------------------
-
-class compress 
-{
-	var $fp = 0;
-
-	function add_file($src, $src_rm_prefix = '', $src_add_prefix = '', $skip_files = '')
-	{
-		$skip_files = explode(',', $skip_files);
-
-		// Remove rm prefix from src path 
-		$src_path = ($src_rm_prefix) ? preg_replace('#^(' . preg_quote($src_rm_prefix) . ')#', '', $src) : $src;
-		// Add src prefix
-		$src_path = ($src_add_prefix) ? ($src_add_prefix . ((substr($src_add_prefix, -1) != '/') ? '/' : '') . $src_path) : $src_path;
-		// Remove initial &quot;/&quot; if present
-		$src_path = (substr($src_path, 0, 1) == '/') ? substr($src_path, 1) : $src_path;
-
-		if (is_file($src))
-		{
-			if (!($fp = @fopen(&quot;$src&quot;, 'rb')))
-			{
-				return false;
-			}
-
-			$data = fread($fp, filesize(&quot;$src&quot;));
-			fclose($fp);
-
-			$this-&gt;data($src_path, $data, filemtime(&quot;$src&quot;), false);
-		}
-		else if (is_dir($src))
-		{
-			// Clean up path, add closing / if not present
-			$src_path = ($src_path &amp;&amp; substr($src_path, -1) != '/') ? $src_path . '/' : $src_path;
-
-			$filelist = array();
-			$filelist = filelist(&quot;$src&quot;, '', '*');
-			krsort($filelist);
-
-			if ($src_path)
-			{
-				$mtime = (file_exists(&quot;$src_path&quot;)) ? filemtime(&quot;$src_path&quot;) : time();
-				$this-&gt;data($src_path, '', $mtime, true);
-			}
-
-			foreach ($filelist as $path =&gt; $file_ary)
-			{
-				if ($path)
-				{
-					// Same as for src_path
-					$path = (substr($path, 0, 1) == '/') ? substr($path, 1) : $path;
-					$path = ($path &amp;&amp; substr($path, -1) != '/') ? $path . '/' : $path;
-
-					$this-&gt;data(&quot;$src_path$path&quot;, '', filemtime(&quot;$src_path$path&quot;), true);
-				}
-
-				foreach ($file_ary as $file)
-				{
-					if (in_array($path . $file, $skip_files))
-					{
-						continue;
-					}
-
-					$this-&gt;data(&quot;$src_path$path$file&quot;, implode('', file(&quot;$src_path$path$file&quot;)), filemtime(&quot;$src_path$path$file&quot;), false);
-				}
-			}
-
-		}
-		return true;
-	}
-
-	function add_data($src, $name)
-	{
-		$this-&gt;data($name, $src);
-		return true;
-	}
-
-	function methods()
-	{
-		$methods = array('tar');
-
-		foreach (array('tar.gz' =&gt; 'zlib', 'tar.bz2' =&gt; 'bz2', 'zip' =&gt; 'zlib') as $type =&gt; $module)
-		{
-			if (!@extension_loaded($module))
-			{
-				break;
-			}
-			$methods[] = $type;
-		}
-
-		return $methods;
-	}
-}
-
-/**
-* @package phpBB3
-*
-* Zip creation class from phpMyAdmin 2.3.0 &#169; Tobias Ratschiller, Olivier M&#252;ller, Lo&#239;c Chapeaux, 
-* Marc Delisle, <A HREF="http://www.phpmyadmin.net/">http://www.phpmyadmin.net/</A>
-*
-* Modified extensively by psoTFX, &#169; phpBB Group, 2003
-*
-* Based on work by Eric Mueller and Denis125
-* Official ZIP file format: <A HREF="http://www.pkware.com/appnote.txt">http://www.pkware.com/appnote.txt</A>
-*/
-
-class compress_zip extends compress
-{
-	var $datasec = array();
-	var $ctrl_dir = array();
-	var $eof_cdh = &quot;\x50\x4b\x05\x06\x00\x00\x00\x00&quot;;
-
-	var $old_offset = 0;
-	var $datasec_len = 0;
-
-	function compress_zip($mode, $file)
-	{
-		return $this-&gt;fp = @fopen($file, $mode . 'b');
-	}
-
-	function unix_to_dos_time($time)
-	{
-		$timearray = (!$time) ? getdate() : getdate($time);
-
-		if ($timearray['year'] &lt; 1980)
-		{
-			$timearray['year'] = 1980;
-			$timearray['mon'] = $timearray['mday'] = 1;
-			$timearray['hours'] = $timearray['minutes'] = $timearray['seconds'] = 0;
-		}
-
-		return (($timearray['year'] - 1980) &lt;&lt; 25) | ($timearray['mon'] &lt;&lt; 21) | ($timearray['mday'] &lt;&lt; 16) | ($timearray['hours'] &lt;&lt; 11) | ($timearray['minutes'] &lt;&lt; 5) | ($timearray['seconds'] &gt;&gt; 1);
-	}
-
-	function extract($dst)
-	{
-		$header = $data = '';
-		$seek_ary = $mkdir_ary = array();
-		$j = 0;
-
-		fseek($this-&gt;fp, -14, SEEK_END);
-		$tmp = unpack(&quot;ventries/vtotentries/Vctsize/Vctpos&quot;, fread($this-&gt;fp, 12));
-		$entries = (int) trim($tmp['entries']);
-		$totentries = (int) trim($tmp['totentries']);
-		$ctsize = (int) trim($tmp['ctsize']);
-		$ctpos = (int) trim($tmp['ctpos']);
-
-		fseek($this-&gt;fp, $ctpos);
-
-		// First scan entries, pull out position of data, length, etc.
-		// and directory structure
-		for ($i = 0; $i &lt; $entries; $i++)
-		{
-			$buffer = fread($this-&gt;fp, 46);
-
-			$tmp = unpack(&quot;vc_method/Vmtime/Vcrc/Vc_size/Vuc_size/vstrlen&quot;, substr($buffer, 10, 20));
-			$c_method = (int) trim($tmp['c_method']);
-			$crc = (int) trim($tmp['crc']);
-			$strlen = (int) trim($tmp['strlen']);
-			$uc_size = (int) trim($tmp['uc_size']);
-			$c_size = (int) trim($tmp['c_size']);
-
-			$tmp = unpack(&quot;Vattrib/Voffset&quot;, substr($buffer, 38, 8));
-			$attrib = (int) trim($tmp['attrib']);
-			$offset = (int) trim($tmp['offset']);
-
-			$filename =  fread($this-&gt;fp, $strlen);
-
-			if ($attrib == 16 || $attrib == 0x41FF0010 || (!$uc_size &amp;&amp; !$crc))
-			{
-				$mkdir_ary[] = &quot;$dst$filename&quot;;
-			}
-			else
-			{
-				$seek_ary[$j]['c_method'] = $c_method;
-				$seek_ary[$j]['crc'] = $crc;
-				$seek_ary[$j]['strlen'] = $strlen;
-				$seek_ary[$j]['uc_size'] = $uc_size;
-				$seek_ary[$j]['c_size'] = $c_size;
-
-				$seek_ary[$j]['offset'] = $offset;
-				$seek_ary[$j]['filename'] = &quot;$dst$filename&quot;;
-
-				$j++;
-			}
-		}
-
-		// Create directory structure on fs
-		if (is_array($mkdir_ary))
-		{
-			sort($mkdir_ary);
-			foreach ($mkdir_ary as $dir)
-			{
-				if (!@mkdir($dir, 0777))
-				{
-					trigger_error(&quot;Could not create directory $dir&quot;);
-				}
-				@chmod(&quot;$dir&quot;, 0777);
-			}
-		}
-
-		// Extract files
-		foreach ($seek_ary as $seek)
-		{
-			$filename = $seek['filename'];
-
-//			fseek($this-&gt;fp, $seek['offset'] + 8); // To grab file header info
-//			fseek($this-&gt;fp, $seek['offset'] + 30 + $tmp['strlen'] + $tmp['c_size']); // To grab file header info2
-
-			// Jump to data
-			fseek($this-&gt;fp, $seek['offset'] + 30 + $seek['strlen']);
-
-			// Was data compressed? If so we have to fudge a solution thanks
-			// to some &quot;issues&quot; with gzuncompress. Else we just write out the
-			// data
-			if ($seek['c_method'] == 8)
-			{
-				// Temp gzip file -&gt; .gz header -&gt; data -&gt; gz footer
-				if (!($fp = fopen($filename . '.gz', 'wb')))
-				{
-					trigger_error(&quot;Could not open temporary $filename.gz&quot;);
-				}
-				fwrite($fp, pack('va1a1Va1a1', 0x8b1f, chr(0x08), chr(0x00), time(), chr(0x00), chr(3)));
-				fwrite($fp, fread($this-&gt;fp, $seek['c_size']));
-				fwrite($fp, pack(&quot;VV&quot;, $seek['crc'], $seek['uc_size']));
-				fclose($fp);
-
-				if (!($fp = fopen($filename, 'wb')))
-				{
-					trigger_error(&quot;Could not create $filename&quot;);
-				}
-				@chmod($filename, 0777);
-
-				if (!($gzfp = gzopen($filename . '.gz', 'rb')))
-				{
-					die(&quot;Could not open temporary $filename.gz&quot;);
-				}
-
-				while ($buffer = gzread($gzfp, 1024))
-				{
-					fwrite($fp, $buffer);
-				}
-				gzclose($gzfp);
-				fclose($fp);
-				unlink($filename . '.gz');
-			}
-			else
-			{
-				if (!($fp = fopen($filename, 'wb')))
-				{
-					trigger_error(&quot;Could not create $filename&quot;);
-				}
-				@chmod($filename, 0777);
-
-				fwrite($fp, fread($this-&gt;fp, $seek['uc_size']));
-				fclose($fp);
-			}
-		}
-	}
-
-	function close()
-	{
-		// Write out central file directory and footer ... if it exists
-		if (sizeof($this-&gt;ctrl_dir))
-		{
-			fwrite($this-&gt;fp, $this-&gt;file());
-		}
-		fclose($this-&gt;fp);
-	}
-
-	// Create the structures ... note we assume version made by is MSDOS
-	function data($name, $data, $mtime = false, $is_dir = false)
-	{
-		$name = str_replace('\\', '/', $name);
-
-		$dtime = dechex($this-&gt;unix_to_dos_time($mtime));
-		$hexdtime = '\x' . $dtime[6] . $dtime[7] . '\x' . $dtime[4] . $dtime[5] . '\x' . $dtime[2] . $dtime[3] . '\x' . $dtime[0] . $dtime[1];
-		eval('$hexdtime = &quot;' . $hexdtime . '&quot;;');
-
-		if ($is_dir)
-		{
-			$unc_len = $c_len = $crc = 0;
-			$zdata = '';
-		}
-		else
-		{
-			$unc_len = strlen($data);
-			$crc = crc32($data);
-			$zdata = gzcompress($data);
-			$zdata = substr(substr($zdata, 0, strlen($zdata) - 4), 2); // fix crc bug
-			$c_len = strlen($zdata);
-
-			// Did we compress? No, then use data as is
-			if ($c_len &gt;= $unc_len)
-			{
-				$zdata = $data;
-				$c_len = $unc_len;
-			}
-		}
-		unset($data);
-
-		// If we didn't compress set method to store, else deflate
-		$c_method = ($c_len == $unc_len) ? &quot;\x00\x00&quot; : &quot;\x08\x00&quot;; 
-
-		// Are we a file or a directory? Set archive for file
-		$attrib = ($is_dir) ? 16 : 32;
-		$var_ext = ($is_dir) ? &quot;\x0a&quot; : &quot;\x14&quot;;
-
-		// File Record Header
-		$fr = &quot;\x50\x4b\x03\x04&quot;;		// Local file header 4bytes
-		$fr .= &quot;$var_ext\x00&quot;;			// ver needed to extract 2bytes
-		$fr .= &quot;\x00\x00&quot;;				// gen purpose bit flag 2bytes
-		$fr .= $c_method;				// compression method 2bytes
-		$fr .= $hexdtime;				// last mod time and date 2+2bytes
-		$fr .= pack('V', $crc);			// crc32 4bytes
-		$fr .= pack('V', $c_len);		// compressed filesize 4bytes
-		$fr .= pack('V', $unc_len);		// uncompressed filesize 4bytes
-		$fr .= pack('v', strlen($name));// length of filename 2bytes
-
-		$fr .= pack('v', 0);			// extra field length 2bytes
-		$fr .= $name;
-		$fr .= $zdata;
-		unset($zdata);
-		$fr .= pack('V', $crc);			// crc32 4bytes
-		$fr .= pack('V', $c_len);		// compressed filesize 4bytes
-		$fr .= pack('V', $unc_len);		// uncompressed filesize 4bytes
-
-		$this-&gt;datasec_len += strlen($fr);
-
-		// Add data to file ... by writing data out incrementally we save some memory
-		fwrite($this-&gt;fp, $fr);
-		unset($fr);
-
-		// Central Directory Header
-		$cdrec = &quot;\x50\x4b\x01\x02&quot;;		// header 4bytes
-		$cdrec .= &quot;\x00\x00&quot;;               // version made by
-		$cdrec .= &quot;$var_ext\x00&quot;;           // version needed to extract
-		$cdrec .= &quot;\x00\x00&quot;;               // gen purpose bit flag
-		$cdrec .= $c_method;				// compression method 
-		$cdrec .= $hexdtime;                // last mod time &amp; date
-		$cdrec .= pack('V', $crc);          // crc32
-		$cdrec .= pack('V', $c_len);        // compressed filesize
-		$cdrec .= pack('V', $unc_len);      // uncompressed filesize
-		$cdrec .= pack('v', strlen($name)); // length of filename
-		$cdrec .= pack('v', 0);             // extra field length
-		$cdrec .= pack('v', 0);             // file comment length
-		$cdrec .= pack('v', 0);             // disk number start
-		$cdrec .= pack('v', 0);             // internal file attributes
-		$cdrec .= pack('V', $attrib);		// external file attributes
-		$cdrec .= pack('V', $this-&gt;old_offset); // relative offset of local header
-		$cdrec .= $name;
-
-		// Save to central directory
-		$this-&gt;ctrl_dir[] = $cdrec;
-
-		$this-&gt;old_offset = $this-&gt;datasec_len;
-	}
-
-	function file()
-	{
-		$ctrldir = implode('', $this-&gt;ctrl_dir);
-
-		return $ctrldir . $this-&gt;eof_cdh . 
-			pack('v', sizeof($this-&gt;ctrl_dir)) .	// total # of entries &quot;on this disk&quot;
-			pack('v', sizeof($this-&gt;ctrl_dir)) .	// total # of entries overall
-			pack('V', strlen($ctrldir)) .			// size of central dir
-			pack('V', $this-&gt;datasec_len) .			// offset to start of central dir
-			&quot;\x00\x00&quot;;								// .zip file comment length
-	}
-	
-	function download($filename)
-	{
-		global $phpbb_root_path;
-
-		$mimetype = 'application/zip';
-
-		header('Pragma: no-cache');
-		header(&quot;Content-Type: $mimetype; name=\&quot;$filename.zip\&quot;&quot;);
-		header(&quot;Content-disposition: attachment; filename=$filename.zip&quot;);
-
-		$fp = fopen(&quot;store/$filename.zip&quot;, 'rb');
-		while ($buffer = fread($fp, 1024))
-		{
-			echo $buffer;
-		}
-		fclose($fp);
-	}
-}
-
-// Tar/tar.gz compression routine
-// Header/checksum creation derived from tarfile.pl, &#169; Tom Horsley, 1994
-class compress_tar extends compress 
-{
-	var $isgz = false;
-	var $isbz = false;
-	var $filename = '';
-	var $mode = '';
-	var $type = '';
-
-	function compress_tar($mode, $file, $type = '')
-	{
-		$type = (!$type) ? $file : $type;
-		$this-&gt;isgz = (strpos($type, '.tar.gz') !== false || strpos($type, '.tgz') !== false) ? true : false;
-		$this-&gt;isbz = (strpos($type, '.tar.bz2') !== false) ? true : false;
-
-		$this-&gt;mode = &amp;$mode;
-		$this-&gt;file = &amp;$file;
-		$this-&gt;type = &amp;$type;
-		$this-&gt;open();
-	}
-
-	function extract($dst)
-	{
-		$fzread = ($this-&gt;isbz &amp;&amp; function_exists('bzread')) ? 'bzread' : (($this-&gt;isgz &amp;&amp; extension_loaded('zlib')) ? 'gzread' : 'fread');
-
-		// Run through the file and grab directory entries
-		while ($buffer = $fzread($this-&gt;fp, 512))
-		{
-			$tmp = unpack(&quot;A6magic&quot;, substr($buffer, 257, 6));
-
-			if (trim($tmp['magic']) == 'ustar')
-			{
-				$tmp = unpack(&quot;A100name&quot;, $buffer);
-				$filename = trim($tmp['name']);
-
-				$tmp = unpack(&quot;Atype&quot;, substr($buffer, 156, 1));
-				$filetype = (int) trim($tmp['type']);
-
-				if ($filetype == 5)
-				{
-					$mkdir_ary[] = &quot;$dst$filename&quot;;
-				}
-				else if (dirname($filename) != '.')
-				{
-					$mkdir_alt_ary[] = $dst . dirname($filename);
-				}
-			}
-		}
-
-		$mkdir_alt_ary = array_unique($mkdir_alt_ary);
-
-		// Create the directory structure
-		if (sizeof($mkdir_ary) || sizeof($mkdir_alt_ary))
-		{
-			if (!sizeof($mkdir_ary) &amp;&amp; sizeof($mkdir_alt_ary))
-			{
-				$mkdir_ary = $mkdir_alt_ary;
-				unset($mkdir_alt_ary);
-			}
-
-			sort($mkdir_ary);
-			foreach ($mkdir_ary as $dir)
-			{
-				if (!@mkdir($dir, 0777))
-				{
-					trigger_error(&quot;Could not create directory $dir&quot;);
-				}
-				@chmod(&quot;$dir&quot;, 0777);
-			}
-		}
-
-		// If this is a .bz2 we need to close and re-open the file in order
-		// to reset the file pointer since we cannot apparently rewind it
-		if ($this-&gt;isbz)
-		{
-			$this-&gt;close();
-			$this-&gt;open();
-		}
-		else
-		{
-			fseek($this-&gt;fp, 0);
-		}
-
-		// Write out the files
-		$size = 0;
-		while ($buffer = $fzread($this-&gt;fp, 512))
-		{
-			$tmp = unpack(&quot;A6magic&quot;, substr($buffer, 257, 6));
-
-			if (trim($tmp['magic']) == 'ustar')
-			{
-				$tmp = unpack(&quot;A100name&quot;, $buffer);
-				$filename = trim($tmp['name']);
-
-				$tmp = unpack(&quot;Atype&quot;, substr($buffer, 156, 1));
-				$filetype = (int) trim($tmp['type']);
-
-				if ($filetype == 0 || $filetype == &quot;\0&quot;)
-				{
-					$tmp = unpack(&quot;A12size&quot;, substr($buffer, 124, 12));
-					$filesize = octdec((int) trim($tmp['size']));
-
-					if (!($fp = fopen(&quot;$dst$filename&quot;, 'wb')))
-					{
-						trigger_error(&quot;Could create file $filename&quot;);
-					}
-					@chmod(&quot;$dst$filename&quot;, 0777);
-
-					$size = 0;
-					continue;
-				}
-			}
-
-			$size += 512;
-			$length = ($size &gt; $filesize) ? 512 - ($size - $filesize) : 512;
-
-			$tmp = unpack(&quot;A512data&quot;, $buffer);
-
-			fwrite($fp, (string) $tmp['data'], $length);
-			unset($buffer);
-		}
-	}
-
-	function close()
-	{
-		$fzclose = ($this-&gt;isbz &amp;&amp; function_exists('bzclose')) ? 'bzclose' : (($this-&gt;isgz &amp;&amp; extension_loaded('zlib')) ? 'gzclose' : 'fclose');
-		$fzclose($this-&gt;fp);
-	}
-
-	function data($name, $data, $mtime = false, $is_dir = false)
-	{
-		$fzwrite = 	($this-&gt;isbz &amp;&amp; function_exists('bzwrite')) ? 'bzwrite' : (($this-&gt;isgz &amp;&amp; extension_loaded('zlib')) ? 'gzwrite' : 'fwrite');
-
-		$mode = ($is_dir) ? '493' : '436';
-		$mtime = (!$mtime) ? time() : $mtime;
-		$filesize = ($is_dir) ? 0 : strlen($data);
-		$typeflag = ($is_dir) ? '5' : '';
-
-		$header = '';
-		$header .= pack(&quot;a100&quot;, $name);
-		$header .= pack(&quot;a8&quot;, sprintf(&quot;%07o&quot;, $mode));
-		$header .= pack(&quot;a8&quot;, sprintf(&quot;%07o&quot;, 0));
-		$header .= pack(&quot;a8&quot;, sprintf(&quot;%07o&quot;, 0));
-		$header .= pack(&quot;a12&quot;, sprintf(&quot;%011o&quot;, $filesize));
-		$header .= pack(&quot;a12&quot;, sprintf(&quot;%011o&quot;, $mtime));
-		$header .= '        ';
-		$header .= pack(&quot;a&quot;, $typeflag);
-		$header .= pack(&quot;a100&quot;, '');
-		$header .= 'ustar';
-		$header .= pack(&quot;x&quot;);
-		$header .= '00';
-		$header .= pack(&quot;x247&quot;);
-
-		// Checksum
-		$checksum = 0;
-		for ($i = 0; $i &lt; 512; $i++)
-		{
-			$b = unpack(&quot;c1char&quot;, substr($header, $i, 1));
-			$checksum += $b['char'];
-		}
-		$header = substr_replace($header, pack(&quot;a8&quot;,sprintf(&quot;%07o&quot;, $checksum)), 148, 8);
-
-		$fzwrite($this-&gt;fp, $header);
-
-		$i = 0;
-		// Read the data 512 bytes at a time and write it out
-		while ($buffer = substr($data, $i, 512))
-		{
-			$fzwrite($this-&gt;fp, pack(&quot;a512&quot;, $buffer));
-			$i += 512;
-		}
-		unset($data);
-	}
-
-	function open()
-	{
-		$fzopen = ($this-&gt;isbz &amp;&amp; function_exists('bzopen')) ? 'bzopen' : (($this-&gt;isgz &amp;&amp; extension_loaded('zlib')) ? 'gzopen' : 'fopen');
-		return $this-&gt;fp = @$fzopen($this-&gt;file, $this-&gt;mode . 'b');
-	}
-	
-	function download($filename)
-	{
-		switch ($this-&gt;type)
-		{
-			case 'tar':
-				$mimetype = 'application/x-tar';
-				break;
-
-			case 'tar.gz':
-				$mimetype = 'application/x-gzip';
-				break;
-
-			case 'tar.bz2':
-				$mimetype = 'application/x-bzip2';
-				break;
-			
-			default:
-				$mimetype = 'application/octet-stream';
-				break;
-		}
-
-		header('Pragma: no-cache');
-		header(&quot;Content-Type: $mimetype; name=\&quot;$filename.$this-&gt;type\&quot;&quot;);
-		header(&quot;Content-disposition: attachment; filename=$filename.$this-&gt;type&quot;);
-
-		$fp = fopen(&quot;store/$filename.$this-&gt;type&quot;, 'rb');
-		while ($buffer = fread($fp, 1024))
-		{
-			echo $buffer;
-		}
-		fclose($fp);
-	}
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_display.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -52,7 +52,7 @@
 	}
 
 	// Display list of active topics for this category?
-	$show_active = (isset($root_data['forum_flags']) &amp;&amp; $root_data['forum_flags'] &amp; 16) ? true : false;
+	$show_active = (isset($root_data['forum_flags']) &amp;&amp; ($root_data['forum_flags'] &amp; FORUM_FLAG_ACTIVE_TOPICS)) ? true : false;
 
 	if ($_CLASS['core_user']-&gt;is_user &amp;&amp;  $config['load_db_lastread'])
 	{
@@ -110,7 +110,7 @@
 		}
 
 		// Display active topics from this forum?
-		if ($show_active &amp;&amp; $row['forum_type'] == FORUM_POST &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id']) &amp;&amp; ($row['forum_flags'] &amp; 16))
+		if ($show_active &amp;&amp; $row['forum_type'] == FORUM_POST &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id']) &amp;&amp; ($row['forum_flags'] &amp; FORUM_FLAG_ACTIVE_TOPICS))
 		{
 			if (!isset($active_forum_ary['forum_topics']))
 			{
@@ -306,7 +306,7 @@
 		}
 
 		$l_post_click_count = ($row['forum_type'] == FORUM_LINK) ? 'CLICKS' : 'POSTS';
-		$post_click_count = ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] &amp; 1) ? $row['forum_posts'] : '';
+		$post_click_count = ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] &amp; FORUM_FLAG_LINK_TRACK) ? $row['forum_posts'] : '';
 
 		$_CLASS['core_template']-&gt;assign_vars_array('forumrow', array(
 			'S_IS_CAT'			=&gt; false, 
@@ -335,7 +335,7 @@
 			
 			'U_LAST_POSTER'		=&gt; $last_poster_url, 
 			'U_LAST_POST'		=&gt; $last_post_url, 
-			'U_VIEWFORUM'		=&gt; ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] &amp; 1) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : $row['forum_link'])
+			'U_VIEWFORUM'		=&gt; ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] &amp; FORUM_FLAG_LINK_TRACK) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : $row['forum_link'])
 		);
 	}
 
@@ -589,7 +589,7 @@
 				$folder = 'topic_read';
 				$folder_new = 'topic_unread';
 
-				if ($config['hot_threshold'] &amp;&amp; $replies &gt;= $config['hot_threshold'])
+				if ($config['hot_threshold'] &amp;&amp; $replies &gt;= $config['hot_threshold'] &amp;&amp; $topic_row['topic_status'] != ITEM_LOCKED)
 				{
 					$folder .= '_hot';
 					$folder_new .= '_hot';
@@ -633,9 +633,49 @@
 	{
 		$update_count = array();
 	}
+	// Look for missing attachment informations...
+	$attach_ids = array();
+	foreach ($attachment_data as $pos =&gt; $attachment)
+	{
+		// If is_orphan is set, we need to retrieve the attachments again...
+		if (!isset($attachment['extension']) &amp;&amp; !isset($attachment['physical_filename']))
+		{
+			$attach_ids[(int) $attachment['attach_id']] = $pos;
+		}
+	}
+
+	if (sizeof($attach_ids))
+	{
+		global $db;
+
+		$attachment_data = array();
+
+		$sql = 'SELECT *
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+			WHERE attach_id IN (' . implode(', ', array_keys($attach_ids)) . ')';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $db-&gt;sql_fetchrow($result))
+		{
+			if (!isset($attach_ids[$row['attach_id']]))
+			{
+				continue;
+			}
+
+			$attachment_data[$attach_ids[$row['attach_id']]] = $row;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		ksort($attachment_data);
+	}
 
 	foreach ($attachment_data as $attachment)
 	{
+		if (!sizeof($attachment))
+		{
+			continue;
+		}
+
 		$attachment['extension'] = strtolower(trim($attachment['extension']));
 
 		if (!extension_allowed($forum_id, $attachment['extension'], $extensions))

Deleted: cms/trunk/includes/forums/functions_jabber.php
===================================================================
--- cms/trunk/includes/forums/functions_jabber.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_jabber.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,1083 +0,0 @@
-&lt;?php
-/** 
-*
-* @package phpBB3
-* @version $Id: functions_jabber.php,v 1.11 2005/04/10 18:06:59 acydburn Exp $
-* @copyright (c) 2005 phpBB Group 
-* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
-*
-*/
-
-/**
-* @package phpBB3
-*
-*	Class.Jabber.PHP v0.4
-*	(c) 2002 Carlo &quot;Gossip&quot; Zottmann
-*	<A HREF="http://phpjabber.g-blog.net">http://phpjabber.g-blog.net</A> *** <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">gossip at jabber.g-blog.net</A>
-*
-*	The FULL documentation and examples for this software can be found at
-*	<A HREF="http://phpjabber.g-blog.net">http://phpjabber.g-blog.net</A> (not many doc comments in here, sorry)
-*
-*	last modified: 27.04.2003 13:01:53 CET
-*
-* 
-*	Modified by psoTFX, phpBB Group, 2003.
-*	Removed functions/support not critical to integration with phpBB
-*
-*/
-class jabber
-{
-	var $server;
-	var $port;
-	var $username;
-	var $password;
-	var $resource;
-	var $jid;
-
-	var $connection;
-	var $delay_disconnect;
-
-	var $stream_id;
-	var $roster;
-
-	var $iq_sleep_timer;
-	var $last_ping_time;
-
-	var $packet_queue;
-	var $subscription_queue;
-
-	var $iq_version_name;
-	var $iq_version_os;
-	var $iq_version_version;
-
-	var $error_codes;
-
-	var $connected;
-	var $keep_alive_id;
-	var $returned_keep_alive;
-	var $txnid;
-
-	var $connector;
-
-	function jabber()
-	{
-		$this-&gt;port					= '5222';
-		$this-&gt;resource				= NULL;
-		$this-&gt;packet_queue			= $this-&gt;subscription_queue = array();
-		$this-&gt;iq_sleep_timer		= $this-&gt;delay_disconnect = 1;
-
-		$this-&gt;returned_keep_alive	= true;
-		$this-&gt;txnid				= 0;
-
-		$this-&gt;iq_version_name		= &quot;Class.Jabber.PHP -- <A HREF="http://phpjabber.g-blog.net">http://phpjabber.g-blog.net</A> -- by Carlo 'Gossip' Zottmann, <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">gossip at jabber.g-blog.net</A>&quot;;
-		$this-&gt;iq_version_version	= '0.4';
-		$this-&gt;iq_version_os		= $_SERVER['SERVER_SOFTWARE'];
-
-		$this-&gt;error_codes			= array(
-			400 =&gt; 'Bad Request',
-			401 =&gt; 'Unauthorized',
-			402 =&gt; 'Payment Required',
-			403 =&gt; 'Forbidden',
-			404 =&gt; 'Not Found',
-			405 =&gt; 'Not Allowed',
-			406 =&gt; 'Not Acceptable',
-			407 =&gt; 'Registration Required',
-			408 =&gt; 'Request Timeout',
-			409 =&gt; 'Conflict',
-			500 =&gt; 'Internal Server Error',
-			501 =&gt; 'Not Implemented',
-			502 =&gt; 'Remove Server Error',
-			503 =&gt; 'Service Unavailable',
-			504 =&gt; 'Remove Server Timeout',
-			510 =&gt; 'Disconnected'
-		);
-	}
-
-	function connect()
-	{
-		$this-&gt;connector = new cjp_standard_connector;
-
-		if ($this-&gt;connector-&gt;open_socket($this-&gt;server, $this-&gt;port))
-		{
-			$this-&gt;send_packet(&quot;&lt;?xml version='1.0' encoding='UTF-8' ?&quot; . &quot;&gt;\n&quot;);
-			$this-&gt;send_packet(&quot;&lt;stream:stream to='{$this-&gt;server}' xmlns='jabber:client' xmlns:stream='<A HREF="http://etherx.jabber.org/streams">http://etherx.jabber.org/streams</A>'&gt;\n&quot;);
-
-			sleep(2);
-
-			if ($this-&gt;_check_connected())
-			{
-				$this-&gt;connected = true; // Nathan Fritz
-				return true;
-			}
-			else
-			{
-				return false;
-			}
-		}
-		else
-		{
-			return false;
-		}
-	}
-
-	function disconnect()
-	{
-		if (is_int($this-&gt;delay_disconnect))
-		{
-			sleep($this-&gt;delay_disconnect);
-		}
-
-		$this-&gt;send_packet('&lt;/stream:stream&gt;');
-		$this-&gt;connector-&gt;close_socket();
-	}
-
-	function cruise_control($seconds = -1)
-	{
-		$count = 0;
-
-		while ($count != $seconds)
-		{
-			$this-&gt;listen();
-
-			do
-			{
-				$packet = $this-&gt;get_first_from_queue();
-
-				if ($packet)
-				{
-					$this-&gt;call_handler($packet);
-				}
-
-			}
-			while (sizeof($this-&gt;packet_queue) &gt; 1);
-
-			$count += 0.25;
-			usleep(250000);
-			
-			if ($this-&gt;last_ping_time != date('H:i'))
-			{
-				// Modified by Nathan Fritz
-				if ($this-&gt;returned_keep_alive == false)
-				{
-					$this-&gt;connected = false;
-					//EVENT: Disconnected
-				}
-
-				$this-&gt;returned_keep_alive = FALSE;
-				$this-&gt;keep_alive_id = 'keep_alive_' . time();
-				$this-&gt;send_packet(&quot;&lt;iq id='{$this-&gt;keep_alive_id}'/&gt;&quot;, 'cruise_control');
-				$this-&gt;last_ping_time = date('H:i');
-			}
-		}
-
-		return true;
-	}
-
-	function send_auth()
-	{
-		$this-&gt;auth_id	= 'auth_' . md5(time() . $_SERVER['REMOTE_ADDR']);
-		$this-&gt;jid		= &quot;{$this-&gt;username}@{$this-&gt;server}/{$this-&gt;resource}&quot;;
-
-		// request available authentication methods
-		$payload	= &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;&quot;;
-		$packet		= $this-&gt;send_iq(NULL, 'get', $this-&gt;auth_id, 'jabber:iq:auth', $payload);
-
-		// was a result returned?
-		if ($this-&gt;get_info_from_iq_type($packet) == 'result' &amp;&amp; $this-&gt;get_info_from_iq_id($packet) == $this-&gt;auth_id)
-		{
-			if (@function_exists('mhash') &amp;&amp; isset($packet['iq']['#']['query'][0]['#']['sequence'][0]['#']) &amp;&amp; isset($packet['iq']['#']['query'][0]['#']['token'][0]['#']))
-			{
-				// auth_0k
-				return $this-&gt;_sendauth_ok($packet['iq']['#']['query'][0]['#']['token'][0]['#'], $packet['iq']['#']['query'][0]['#']['sequence'][0]['#']);
-			}
-			elseif (@function_exists('mhash') &amp;&amp; isset($packet['iq']['#']['query'][0]['#']['digest']))
-			{
-				// digest
-				return $this-&gt;_sendauth_digest();
-			}
-			elseif ($packet['iq']['#']['query'][0]['#']['password'])
-			{
-				// plain text
-				return $this-&gt;_sendauth_plaintext();
-			}
-		}
-		else
-		{
-			// no result returned
-			return false;
-		}
-	}
-
-	function account_registration($reg_email = NULL, $reg_name = NULL)
-	{
-		$packet = $this-&gt;send_iq($this-&gt;server, 'get', 'reg_01', 'jabber:iq:register');
-
-		if ($packet)
-		{
-			$key = $this-&gt;get_info_from_iq_key($packet); // just in case a key was passed back from the server
-			unset($packet);
-
-			$payload = &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;
-						&lt;password&gt;{$this-&gt;password}&lt;/password&gt;
-						&lt;email&gt;$reg_email&lt;/email&gt;
-						&lt;name&gt;$reg_name&lt;/name&gt;\n&quot;;
-
-			$payload .= ($key) ? &quot;&lt;key&gt;$key&lt;/key&gt;\n&quot; : '';
-
-			$packet = $this-&gt;send_iq($this-&gt;server, 'set', 'reg_01', 'jabber:iq:register', $payload);
-
-			if ($this-&gt;get_info_from_iq_type($packet) == 'result')
-			{
-				$return_code = (isset($packet['iq']['#']['query'][0]['#']['registered'][0]['#'])) ? 1 : 2;
-				$this-&gt;jid = ($this-&gt;resource) ? &quot;{$this-&gt;username}@{$this-&gt;server}/{$this-&gt;resource}&quot; : &quot;{$this-&gt;username}@{$this-&gt;server}&quot;;
-			}
-			elseif ($this-&gt;get_info_from_iq_type($packet) == 'error' &amp;&amp; isset($packet['iq']['#']['error'][0]['#']))
-			{
-				// &quot;conflict&quot; error, i.e. already registered
-				if ($packet['iq']['#']['error'][0]['@']['code'] == '409')
-				{
-					$return_code = 1;
-				}
-				else
-				{
-					$return_code = 'Error ' . $packet['iq']['#']['error'][0]['@']['code'] . ': ' . $packet['iq']['#']['error'][0]['#'];
-				}
-			}
-
-			return $return_code;
-		}
-		else
-		{
-			return 3;
-		}
-	}
-
-	function change_password($new_password)
-	{
-		$packet = $this-&gt;send_iq($this-&gt;server, 'get', 'A0', 'jabber:iq:register');
-
-		if ($packet)
-		{
-			$key = $this-&gt;get_info_from_iq_key($packet); // just in case a key was passed back from the server
-			unset($packet);
-
-			$payload = &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;
-						&lt;password&gt;{$new_password}&lt;/password&gt;\n&quot;;
-			$payload .= ($key) ? &quot;&lt;key&gt;$key&lt;/key&gt;\n&quot; : '';
-
-			$packet = $this-&gt;send_iq($this-&gt;server, 'set', 'A0', 'jabber:iq:register', $payload);
-
-			if ($this-&gt;get_info_from_iq_type($packet) == 'result')
-			{
-				$return_code = (isset($packet['iq']['#']['query'][0]['#']['registered'][0]['#'])) ? 1 : 2;
-			}
-			elseif ($this-&gt;get_info_from_iq_type($packet) == 'error' &amp;&amp; isset($packet['iq']['#']['error'][0]['#']))
-			{
-				// &quot;conflict&quot; error, i.e. already registered
-				if ($packet['iq']['#']['error'][0]['@']['code'] == '409')
-				{
-					$return_code = 1;
-				}
-				else
-				{
-					$return_code = 'Error ' . $packet['iq']['#']['error'][0]['@']['code'] . ': ' . $packet['iq']['#']['error'][0]['#'];
-				}
-			}
-
-			return $return_code;
-		}
-		else
-		{
-			return 3;
-		}
-	}
-
-	function send_packet($xml)
-	{
-		$xml = trim($xml);
-
-		return ($this-&gt;connector-&gt;write_to_socket($xml)) ? true : false;
-	}
-
-	// get the transport registration fields
-	// method written by Steve Blinch, <A HREF="http://www.blitzaffe.com">http://www.blitzaffe.com</A> 
-	function transport_registration_details($transport)
-	{
-		$this-&gt;txnid++;
-		$packet = $this-&gt;send_iq($transport, 'get', &quot;reg_{$this-&gt;txnid}&quot;, &quot;jabber:iq:register&quot;, NULL, $this-&gt;jid);
-
-		if ($packet)
-		{
-			$res = array();
-
-			foreach ($packet['iq']['#']['query'][0]['#'] as $element =&gt; $data)
-			{
-				if ($element != 'instructions' &amp;&amp; $element != 'key')
-				{
-					$res[] = $element;
-				}
-			}
-
-			return $res;
-		}
-		else
-		{
-			return 3;
-		}
-	}
-
-	// register with the transport
-	// method written by Steve Blinch, <A HREF="http://www.blitzaffe.com">http://www.blitzaffe.com</A> 
-	function transport_registration($transport, $details)
-	{
-		$this-&gt;txnid++;
-		$packet = $this-&gt;send_iq($transport, 'get', &quot;reg_{$this-&gt;txnid}&quot;, &quot;jabber:iq:register&quot;, NULL, $this-&gt;jid);
-
-		if ($packet)
-		{
-			$key = $this-&gt;get_info_from_iq_key($packet); // just in case a key was passed back from the server
-			unset($packet);
-		
-			$payload = ($key) ? &quot;&lt;key&gt;$key&lt;/key&gt;\n&quot; : '';
-			foreach ($details as $element =&gt; $value)
-			{
-				$payload .= &quot;&lt;$element&gt;$value&lt;/$element&gt;\n&quot;;
-			}
-		
-			$packet = $this-&gt;send_iq($transport, 'set', &quot;reg_{$this-&gt;txnid}&quot;, &quot;jabber:iq:register&quot;, $payload);
-		
-			if ($this-&gt;get_info_from_iq_type($packet) == 'result')
-			{
-				if (isset($packet['iq']['#']['query'][0]['#']['registered'][0]['#']))
-				{
-					$return_code = 1;
-				}
-				else
-				{
-					$return_code = 2;
-				}
-			}
-			elseif ($this-&gt;get_info_from_iq_type($packet) == 'error')
-			{
-				if (isset($packet['iq']['#']['error'][0]['#']))
-				{
-					$return_code = &quot;Error &quot; . $packet['iq']['#']['error'][0]['@']['code'] . &quot;: &quot; . $packet['iq']['#']['error'][0]['#'];
-					// ERROR: TransportRegistration()
-				}
-			}
-
-			return $return_code;
-		}
-		else
-		{
-			return 3;
-		}
-	}
-
-	function listen()
-	{
-		$incoming = '';
-
-		while ($line = $this-&gt;connector-&gt;read_from_socket(4096))
-		{
-			$incoming .= $line;
-		}
-
-		$incoming = trim($incoming);
-
-		if ($incoming != '')
-		{
-			$temp = $this-&gt;_split_incoming($incoming);
-
-			for ($a = 0, $size = sizeof($temp); $a &lt; $size; $a++)
-			{
-				$this-&gt;packet_queue[] = $this-&gt;xmlize($temp[$a]);
-			}
-		}
-
-		return true;
-	}
-
-	function strip_jid($jid = NULL)
-	{
-		preg_match('#(.*)\/(.*)#Ui', $jid, $temp);
-		return ($temp[1] != '') ? $temp[1] : $jid;
-	}
-
-	function send_message($to, $type = 'normal', $id = NULL, $content = NULL, $payload = NULL)
-	{
-		if ($to &amp;&amp; is_array($content))
-		{
-			if (!$id)
-			{
-				$id = $type . '_' . time();
-			}
-
-			$content = $this-&gt;_array_htmlspecialchars($content);
-
-			$xml = &quot;&lt;message to='$to' type='$type' id='$id'&gt;\n&quot;;
-
-			if (isset($content['subject']) &amp;&amp; $content['subject'])
-			{
-				$xml .= '&lt;subject&gt;' . $content['subject'] . &quot;&lt;/subject&gt;\n&quot;;
-			}
-
-			if (isset($content['thread']) &amp;&amp; $content['thread'])
-			{
-				$xml .= '&lt;thread&gt;' . $content['thread'] . &quot;&lt;/thread&gt;\n&quot;;
-			}
-
-			$xml .= '&lt;body&gt;' . $content['body'] . &quot;&lt;/body&gt;\n&quot;;
-			$xml .= $payload;
-			$xml .= &quot;&lt;/message&gt;\n&quot;;
-
-			if ($this-&gt;send_packet($xml))
-			{
-				return true;
-			}
-			else
-			{
-				return false;
-			}
-		}
-		else
-		{
-			return false;
-		}
-	}
-
-	function send_presence($type = NULL, $to = NULL, $status = NULL, $show = NULL, $priority = NULL)
-	{
-		$xml = '&lt;presence';
-		$xml .= ($to) ? &quot; to='$to'&quot; : '';
-		$xml .= ($type) ? &quot; type='$type'&quot; : '';
-		$xml .= ($status || $show || $priority) ? &quot;&gt;\n&quot; : &quot; /&gt;\n&quot;;
-
-		$xml .= ($status) ? &quot; &lt;status&gt;$status&lt;/status&gt;\n&quot; : '';
-		$xml .= ($show) ? &quot;	&lt;show&gt;$show&lt;/show&gt;\n&quot; : '';
-		$xml .= ($priority) ? &quot;	&lt;priority&gt;$priority&lt;/priority&gt;\n&quot; : '';
-
-		$xml .= ($status || $show || $priority) ? &quot;&lt;/presence&gt;\n&quot; : '';
-
-		return ($this-&gt;send_packet($xml)) ? true : false;
-	}
-
-	function send_error($to, $id = NULL, $error_number, $error_message = NULL)
-	{
-		$xml = &quot;&lt;iq type='error' to='$to'&quot;;
-		$xml .= ($id) ? &quot; id='$id'&quot; : '';
-		$xml .= &quot;&gt;\n&quot;;
-		$xml .= &quot;	&lt;error code='$error_number'&gt;&quot;;
-		$xml .= ($error_message) ? $error_message : $this-&gt;error_codes[$error_number];
-		$xml .= &quot;&lt;/error&gt;\n&quot;;
-		$xml .= '&lt;/iq&gt;';
-
-		$this-&gt;send_packet($xml);
-	}
-
-	function get_first_from_queue()
-	{
-		return array_shift($this-&gt;packet_queue);
-	}
-
-	function get_from_queue_by_id($packet_type, $id)
-	{
-		$found_message = false;
-
-		foreach ($this-&gt;packet_queue as $key =&gt; $value)
-		{
-			if ($value[$packet_type]['@']['id'] == $id)
-			{
-				$found_message = $value;
-				unset($this-&gt;packet_queue[$key]);
-
-				break;
-			}
-		}
-
-		return (is_array($found_message)) ? $found_message : false;
-	}
-
-	function call_handler($packet = NULL)
-	{
-		$packet_type = $this-&gt;_get_packet_type($packet);
-
-		if ($packet_type == 'message')
-		{
-			$type		= $packet['message']['@']['type'];
-			$type		= ($type != '') ? $type : 'normal';
-			$funcmeth	= &quot;handler_message_$type&quot;;
-		}
-		elseif ($packet_type == 'iq')
-		{
-			$namespace	= $packet['iq']['#']['query'][0]['@']['xmlns'];
-			$namespace	= str_replace(':', '_', $namespace);
-			$funcmeth	= &quot;handler_iq_$namespace&quot;;
-		}
-		elseif ($packet_type == 'presence')
-		{
-			$type		= $packet['presence']['@']['type'];
-			$type		= ($type != '') ? $type : 'available';
-			$funcmeth	= &quot;handler_presence_$type&quot;;
-		}
-
-		if ($funcmeth != '')
-		{
-			if (function_exists($funcmeth))
-			{
-				call_user_func($funcmeth, $packet);
-			}
-			elseif (method_exists($this, $funcmeth))
-			{
-				call_user_func(array(&amp;$this, $funcmeth), $packet);
-			}
-			else
-			{
-				$this-&gt;handler_not_implemented($packet);
-			}
-		}
-	}
-
-	function send_iq($to = NULL, $type = 'get', $id = NULL, $xmlns = NULL, $payload = NULL, $from = NULL)
-	{
-		if (!preg_match('#^(get|set|result|error)$#', $type))
-		{
-			unset($type);
-
-			return false;
-		}
-		else if ($id &amp;&amp; $xmlns)
-		{
-			$xml = &quot;&lt;iq type='$type' id='$id'&quot;;
-			$xml .= ($to) ? &quot; to='$to'&quot; : '';
-			$xml .= ($from) ? &quot; from='$from'&quot; : '';
-			$xml .= &quot;&gt;
-						&lt;query xmlns='$xmlns'&gt;
-							$payload
-						&lt;/query&gt;
-					&lt;/iq&gt;&quot;;
-
-			$this-&gt;send_packet($xml);
-			sleep($this-&gt;iq_sleep_timer);
-			$this-&gt;listen();
-
-			return (preg_match('#^(get|set)$#', $type)) ? $this-&gt;get_from_queue_by_id('iq', $id) : true;
-		}
-		else
-		{
-			return false;
-		}
-	}
-
-
-	// ======================================================================
-	// private methods
-	// ======================================================================
-
-	function _sendauth_ok($zerok_token, $zerok_sequence)
-	{
-		// initial hash of password
-		$zerok_hash = @mhash(MHASH_SHA1, $this-&gt;password);
-		$zerok_hash = bin2hex($zerok_hash);
-
-		// sequence 0: hash of hashed-password and token
-		$zerok_hash = @mhash(MHASH_SHA1, $zerok_hash . $zerok_token);
-		$zerok_hash = bin2hex($zerok_hash);
-
-		// repeat as often as needed
-		for ($a = 0; $a &lt; $zerok_sequence; $a++)
-		{
-			$zerok_hash = @mhash(MHASH_SHA1, $zerok_hash);
-			$zerok_hash = bin2hex($zerok_hash);
-		}
-
-		$payload = &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;
-					&lt;hash&gt;$zerok_hash&lt;/hash&gt;
-					&lt;resource&gt;{$this-&gt;resource}&lt;/resource&gt;&quot;;
-
-		$packet = $this-&gt;send_iq(NULL, 'set', $this-&gt;auth_id, 'jabber:iq:auth', $payload);
-
-		// was a result returned?
-		return ($this-&gt;get_info_from_iq_type($packet) == 'result' &amp;&amp; $this-&gt;get_info_from_iq_id($packet) == $this-&gt;auth_id) ? true : false;
-	}
-
-	function _sendauth_digest()
-	{
-		$payload = &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;
-					&lt;resource&gt;{$this-&gt;resource}&lt;/resource&gt;
-					&lt;digest&gt;&quot; . bin2hex(mhash(MHASH_SHA1, $this-&gt;stream_id . $this-&gt;password)) . &quot;&lt;/digest&gt;&quot;;
-
-		$packet = $this-&gt;send_iq(NULL, 'set', $this-&gt;auth_id, 'jabber:iq:auth', $payload);
-
-		// was a result returned?
-		return ($this-&gt;get_info_from_iq_type($packet) == 'result' &amp;&amp; $this-&gt;get_info_from_iq_id($packet) == $this-&gt;auth_id) ? true : false;
-	}
-
-	function _sendauth_plaintext()
-	{
-		$payload = &quot;&lt;username&gt;{$this-&gt;username}&lt;/username&gt;
-					&lt;password&gt;{$this-&gt;password}&lt;/password&gt;
-					&lt;resource&gt;{$this-&gt;resource}&lt;/resource&gt;&quot;;
-
-		$packet = $this-&gt;send_iq(NULL, 'set', $this-&gt;auth_id, 'jabber:iq:auth', $payload);
-
-		// was a result returned?
-		return ($this-&gt;get_info_from_iq_type($packet) == 'result' &amp;&amp; $this-&gt;get_info_from_iq_id($packet) == $this-&gt;auth_id) ? true : false;
-	}
-
-	function _listen_incoming()
-	{
-		$incoming = '';
-		
-		while ($line = $this-&gt;connector-&gt;read_from_socket(4096))
-		{
-			$incoming .= $line;
-		}
-
-		$incoming = trim($incoming);
-		return $this-&gt;xmlize($incoming);
-	}
-
-	function _check_connected()
-	{
-		$incoming_array = $this-&gt;_listen_incoming();
-
-		if (is_array($incoming_array))
-		{
-			if ($incoming_array['stream:stream']['@']['from'] == $this-&gt;server
-				&amp;&amp; $incoming_array['stream:stream']['@']['xmlns'] == 'jabber:client'
-				&amp;&amp; $incoming_array['stream:stream']['@']['xmlns:stream'] == '<A HREF="http://etherx.jabber.org/streams">http://etherx.jabber.org/streams</A>')
-			{
-				$this-&gt;stream_id = $incoming_array['stream:stream']['@']['id'];
-
-				return true;
-			}
-			else
-			{
-				return false;
-			}
-		}
-		else
-		{
-			return false;
-		}
-	}
-
-	function _split_incoming($incoming)
-	{
-		$temp = preg_split('#&lt;(message|iq|presence|stream)#', $incoming, -1, PREG_SPLIT_DELIM_CAPTURE);
-		$array = array();
-
-		for ($a = 1; $a &lt; sizeof($temp); $a = $a + 2)
-		{
-			$array[] = '&lt;' . $temp[$a] . $temp[($a + 1)];
-		}
-
-		return $array;
-	}
-
-	function _get_packet_type($packet = NULL)
-	{
-		if (is_array($packet))
-		{
-			reset($packet);
-			$packet_type = key($packet);
-		}
-
-		return ($packet_type) ? $packet_type : false;
-	}
-
-	// _array_htmlspecialchars()
-	// applies htmlspecialchars() to all values in an array
-	function _array_htmlspecialchars(&amp;$array)
-	{
-		if (is_array($array))
-		{
-			foreach ($array as $k =&gt; $v)
-			{
-				$v = (is_array($v)) ? $this-&gt;_array_htmlspecialchars($v) : htmlspecialchars($v);
-			}
-		}
-
-		return $array;
-	}
-
-	// ======================================================================
-	// &lt;message/&gt; parsers
-	// ======================================================================
-
-	function get_info_from_message_from($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['@']['from'] : false;
-	}
-
-	function get_info_from_message_type($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['@']['type'] : false;
-	}
-
-	function get_info_from_message_id($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['@']['id'] : false;
-	}
-
-	function get_info_from_message_thread($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['#']['thread'][0]['#'] : false;
-	}
-
-	function get_info_from_message_subject($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['#']['subject'][0]['#'] : false;
-	}
-
-	function get_info_from_message_body($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['message']['#']['body'][0]['#'] : false;
-	}
-
-	function get_info_from_message_error($packet = NULL)
-	{
-		$error = preg_replace('#^\/$#', '', ($packet['message']['#']['error'][0]['@']['code'] . '/' . $packet['message']['#']['error'][0]['#']));
-		return (is_array($packet)) ? $error : false;
-	}
-
-	// ======================================================================
-	// &lt;iq/&gt; parsers
-	// ======================================================================
-
-	function get_info_from_iq_from($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['iq']['@']['from'] : false;
-	}
-
-	function get_info_from_iq_type($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['iq']['@']['type'] : false;
-	}
-
-	function get_info_from_iq_id($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['iq']['@']['id'] : false;
-	}
-
-	function get_info_from_iq_key($packet = NULL)
-	{
-		return (is_array($packet)) ? $packet['iq']['#']['query'][0]['#']['key'][0]['#'] : false;
-	}
-
-	function get_info_from_iq_error($packet = NULL)
-	{
-		$error = preg_replace('#^\/$#', '', ($packet['iq']['#']['error'][0]['@']['code'] . '/' . $packet['iq']['#']['error'][0]['#']));
-		return (is_array($packet)) ? $error : false;
-	}
-
-	// ======================================================================
-	// &lt;message/&gt; handlers
-	// ======================================================================
-
-	function handler_message_normal($packet)
-	{
-		$from = $packet['message']['@']['from'];
-	}
-
-	function handler_message_error($packet)
-	{
-		$from = $packet['message']['@']['from'];
-	}
-
-	// ======================================================================
-	// &lt;iq/&gt; handlers
-	// ======================================================================
-
-	// simple client authentication
-	function handler_iq_jabber_iq_auth($packet)
-	{
-		$from	= $this-&gt;get_info_from_iq_from($packet);
-		$id		= $this-&gt;get_info_from_iq_id($packet);
-
-		$this-&gt;send_error($from, $id, 501);
-	}
-
-	// method for interactive registration
-	function handler_iq_jabber_iq_register($packet)
-	{
-		$from	= $this-&gt;get_info_from_iq_from($packet);
-		$id		= $this-&gt;get_info_from_iq_id($packet);
-
-		$this-&gt;send_error($from, $id, 501);
-	}
-
-	// keepalive method, added by Nathan Fritz
-	function handler_iq_($packet)
-	{
-		if ($this-&gt;keep_alive_id == $this-&gt;get_info_from_iq_id($packet))
-		{
-			$this-&gt;returned_keep_alive = true;
-		}
-	}
-	
-	// ======================================================================
-	// Generic handlers
-	// ======================================================================
-
-	// Generic handler for unsupported requests
-	function handler_not_implemented($packet)
-	{
-		$packet_type	= $this-&gt;_get_packet_type($packet);
-		$from			= call_user_func(array(&amp;$this, 'get_info_from_' . strtolower($packet_type) . '_from'), $packet);
-		$id				= call_user_func(array(&amp;$this, 'get_info_from_' . strtolower($packet_type) . '_id'), $packet);
-
-		$this-&gt;send_error($from, $id, 501);
-	}
-
-	// Third party code
-	// <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">m at d</A> pr0ps to the coders ;)
-
-	// xmlize()
-	// (c) Hans Anderson / <A HREF="http://www.hansanderson.com/php/xml/">http://www.hansanderson.com/php/xml/</A>
-	function xmlize($data)
-	{
-		$vals = $index = $array = array();
-		$parser = @xml_parser_create();
-		@xml_parser_set_option($parser, XML_OPTION_CASE_FOLDING, 0);
-		@xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);
-		@xml_parse_into_struct($parser, $data, $vals, $index);
-		@xml_parser_free($parser);
-
-		$i = 0;
-
-		$tagname = $vals[$i]['tag'];
-		$array[$tagname]['@'] = $vals[$i]['attributes'];
-		$array[$tagname]['#'] = $this-&gt;_xml_depth($vals, $i);
-
-		return $array;
-	}
-
-	// _xml_depth()
-	// (c) Hans Anderson / <A HREF="http://www.hansanderson.com/php/xml/">http://www.hansanderson.com/php/xml/</A>
-	function _xml_depth($vals, &amp;$i)
-	{
-		$children = array();
-
-		if (isset($vals[$i]['value']) &amp;&amp; $vals[$i]['value'])
-		{
-			array_push($children, trim($vals[$i]['value']));
-		}
-
-		while (++$i &lt; sizeof($vals))
-		{
-			switch ($vals[$i]['type'])
-			{
-				case 'cdata':
-					array_push($children, trim($vals[$i]['value']));
-	 				break;
-
-				case 'complete':
-					$tagname = $vals[$i]['tag'];
-					$size = (isset($children[$tagname])) ? sizeof($children[$tagname]) : 0;
-					$children[$tagname][$size]['#'] = (isset($vals[$i]['value'])) ? trim($vals[$i]['value']) : '';
-					if (isset($vals[$i]['attributes']) &amp;&amp; $vals[$i]['attributes'])
-					{
-						$children[$tagname][$size]['@'] = $vals[$i]['attributes'];
-					}
-					break;
-
-				case 'open':
-					$tagname = $vals[$i]['tag'];
-					$size = (isset($children[$tagname])) ? sizeof($children[$tagname]) : 0;
-					if ($vals[$i]['attributes'])
-					{
-						$children[$tagname][$size]['@'] = $vals[$i]['attributes'];
-						$children[$tagname][$size]['#'] = $this-&gt;_xml_depth($vals, $i);
-					}
-					else
-					{
-						$children[$tagname][$size]['#'] = $this-&gt;_xml_depth($vals, $i);
-					}
-					break;
-
-				case 'close':
-					return $children;
-					break;
-			}
-		}
-
-		return $children;
-	}
-
-	// traverse_xmlize()
-	// (c) <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">acebone at f2s.com</A>, a HUGE help!
-	function traverse_xmlize($array, $arr_name = 'array', $level = 0)
-	{
-		if ($level == 0)
-		{
-			echo '&lt;pre&gt;';
-		}
-
-		while (list($key, $val) = @each($array))
-		{
-			if (is_array($val))
-			{
-				$this-&gt;traverse_xmlize($val, $arr_name . '[' . $key . ']', $level + 1);
-			}
-			else
-			{
-				echo '$' . $arr_name . '[' . $key . '] = &quot;' . $val . &quot;\&quot;\n&quot;;
-			}
-		}
-
-		if ($level == 0)
-		{
-			echo '&lt;/pre&gt;';
-		}
-	}
-}
-
-/**
-* @package phpBB3
-* make_xml
-* Currently not in use
-*/
-class make_xml extends jabber
-{
-	var $nodes;
-
-	function make_xml()
-	{
-		$nodes = array();
-	}
-
-	function add_packet_details($string, $value = NULL)
-	{
-		if (preg_match('#\(([0-9]*)\)$#i', $string))
-		{
-			$string .= '/[&quot;#&quot;]';
-		}
-
-		$temp = @explode('/', $string);
-
-		for ($a = 0, $size = sizeof($temp); $a &lt; $size; $a++)
-		{
-			$temp[$a] = preg_replace('#^[@]{1}([a-z0-9_]*)$#i', '[&quot;@&quot;][&quot;\1&quot;]', $temp[$a]);
-			$temp[$a] = preg_replace('#^([a-z0-9_]*)\(([0-9]*)\)$/i', '[&quot;\1&quot;][\2]', $temp[$a]);
-			$temp[$a] = preg_replace('#^([a-z0-9_]*)$#i', '[&quot;\1&quot;]', $temp[$a]);
-		}
-
-		$node = implode('', $temp);
-
-		// Yeahyeahyeah, I know it's ugly... get over it. ;)
-		echo '$this-&gt;nodes' . $node . ' = &quot;' . htmlspecialchars($value) . '&quot;;&lt;br/&gt;';
-		eval('$this-&gt;nodes' . $node . ' = &quot;' . htmlspecialchars($value) . '&quot;;');
-	}
-
-	function build_packet($array = NULL)
-	{
-		if (!$array)
-		{
-			$array = $this-&gt;nodes;
-		}
-
-		if (is_array($array))
-		{
-			array_multisort($array, SORT_ASC, SORT_STRING);
-
-			foreach ($array as $key =&gt; $value)
-			{
-				if (is_array($value) &amp;&amp; $key == '@')
-				{
-					foreach ($value as $subkey =&gt; $subvalue)
-					{
-						$subvalue = htmlspecialchars($subvalue);
-						$text .= &quot; $subkey='$subvalue'&quot;;
-					}
-
-					$text .= &quot;&gt;\n&quot;;
-
-				}
-				elseif ($key == '#')
-				{
-					$text .= htmlspecialchars($value);
-				}
-				elseif (is_array($value))
-				{
-					for ($a = 0, $size = sizeof($value); $a &lt; $size; $a++)
-					{
-						$text .= &quot;&lt;$key&quot;;
-
-						if (!$this-&gt;_preg_grep_keys('#^@#', $value[$a]))
-						{
-							$text .= '&gt;';
-						}
-
-						$text .= $this-&gt;build_packet($value[$a]);
-						$text .= &quot;&lt;/$key&gt;\n&quot;;
-					}
-				}
-				else
-				{
-					$value = htmlspecialchars($value);
-					$text .= &quot;&lt;$key&gt;$value&lt;/$key&gt;\n&quot;;
-				}
-			}
-
-			return $text;
-		}
-	}
-
-	function _preg_grep_keys($pattern, $array)
-	{
-		foreach ($array as $key =&gt; $val)
-		{
-			if (preg_match($pattern, $key))
-			{
-				$newarray[$key] = $val;
-			}
-		}
-		return (is_array($newarray)) ? $newarray : false;
-	}
-}
-
-/**
-* @package phpBB3
-* connector
-*/
-class cjp_standard_connector
-{
-	var $active_socket;
-
-	function open_socket($server, $port)
-	{
-		if ($this-&gt;active_socket = @fsockopen($server, $port, $err, $err2, 5))
-		{
-			@socket_set_blocking($this-&gt;active_socket, 0);
-			@socket_set_timeout($this-&gt;active_socket, 31536000);
-
-			return true;
-		}
-		else
-		{
-			return false;
-		}
-	}
-
-	function close_socket()
-	{
-		return @fclose($this-&gt;active_socket);
-	}
-
-	function write_to_socket($data)
-	{
-		return @fwrite($this-&gt;active_socket, $data);
-	}
-
-	function read_from_socket($chunksize)
-	{
-		$buffer = stripslashes(@fread($this-&gt;active_socket, $chunksize));
-		//@set_magic_quotes_runtime(get_magic_quotes_gpc());
-
-		return $buffer;
-	}
-}
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/functions_module.php
===================================================================
--- cms/trunk/includes/forums/functions_module.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_module.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,217 +0,0 @@
-&lt;?
-// -------------------------------------------------------------------------
-//
-// $Id: functions_module.php,v 1.1 2004/10/31 13:26:38 psotfx Exp $
-//
-// FILENAME  : functions_module.php
-// STARTED   : Sat Oct 30 2004
-// COPYRIGHT : &#169; 2004 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------------------
-
-class module
-{
-	var $id = 0;
-	var $filename;
-	var $mode;
-	var $module_ary = array();
-	var $module_y_ary = array();
-	var $module_url = '';
-	var $module_path = '';
-	var $acl_forum_id = false;
-
-	// Private methods, should not be overwritten
-	function create($module_type, $module_path, $module_url, $selected_module = false)
-	{
-		global $template, $auth, $db, $user, $config, $phpbb_root_path, $phpEx;
-
-		$active = $category = false;
-		$this-&gt;module_url = htmlspecialchars($module_url);
-		// TODO Do some checking here?
-		$this-&gt;module_path = $module_path;
-
-		if (file_exists($phpbb_root_path . 'cache/' . $module_type . '_modules.'.$phpEx))
-		{
-			include($phpbb_root_path . 'cache/' . $module_type . '_modules.'.$phpEx);
-		}
-
-		$sql = 'SELECT *
-			FROM ' . MODULES_TABLE . &quot;
-			WHERE module_type = '&quot; . $db-&gt;sql_escape($module_type) . &quot;'
-				AND module_enabled = 1
-				$sql_and
-			ORDER BY left_id&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		$padding = $i = 0;
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			// Authorisation is required ... not authed, skip
-			if ($row['module_auth'])
-			{
-				$is_auth = false;
-				eval('$is_auth = (int) (' . preg_replace(array('#acl_([a-z_]+)(,\$id)?#e', '#\$id#', '#cfg_([a-z_]+)#e'), array('(int) $auth-&gt;acl_get(&quot;\\1&quot;\\2)', '$this-&gt;acl_forum_id', '(int) $config[&quot;\\1&quot;]'), trim($row['module_auth'])) . ');');
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			if ($row['module_cat'] &amp;&amp; ($row['left_id'] + 1 == $row['right_id']))
-			{
-				// Categoriy with no members, ignore
-				continue;
-			}
-
-			if ($row['left_id'] &lt; $right)
-			{
-				$padding++;
-				$padding_store[$row['parent_id']] = $padding;
-			}
-			else if ($row['left_id'] &gt; $right + 1)
-			{
-				$padding = $padding_store[$row['parent_id']];
-			}
-
-			$right = $row['right_id'];
-
-			$this-&gt;module_y_ary[$i] 			= ($padding) ? $padding : 0;
-
-			$this-&gt;module_ary[$i]['id'] 		= (int) $row['module_id'];
-			$this-&gt;module_ary[$i]['name'] 		= (function_exists($row['module_filename'])) ? $row['module_filename']($row['module_name']) : ((!empty($user-&gt;lang[$row['module_name']])) ? $user-&gt;lang[$row['module_name']] : ucfirst(str_replace('_', ' ', strtolower($row['module_name']))));
-			$this-&gt;module_ary[$i]['filename']	= (string) $row['module_filename'];
-			$this-&gt;module_ary[$i]['parent'] 	= (int) $row['parent_id'];
-			$this-&gt;module_ary[$i]['category']	= (bool) $row['module_cat'];
-			$this-&gt;module_ary[$i]['hilit'] 		= (bool) $row['module_hilit'];
-			$this-&gt;module_ary[$i]['active'] 	= false;
-
-			// If this is a module and it's selected, active
-			// If this is a category and the module is the first within it, active
-			// If no category or module selected, go active for first module in first category
-			if (!$active &amp;&amp; ((!$row['module_cat'] &amp;&amp; $row['module_id'] == $selected_module) || $row['parent_id'] === $category || (!$selected_module &amp;&amp; !$row['module_cat'])))
-			{
-				$this-&gt;module_ary[$i]['active'] = true;
-
-				$this-&gt;id		= (int) $row['module_id'];
-				$this-&gt;parent	= (int) $row['parent_id'];
-				$this-&gt;filename = (string) $row['module_filename'];
-				$this-&gt;mode 	= (string) $row['module_mode'];
-
-				$active = true;
-			}
-			else if ($row['module_cat'] &amp;&amp; $row['module_id'] == $selected_module)
-			{
-				$category = $row['module_id'];
-			}
-
-			$i++;
-		}
-		$db-&gt;sql_freeresult($result);
-	}
-
-	function load($mode = false, $run = true)
-	{
-		global $phpbb_root_path, $phpEx;
-
-		if (!class_exists($this-&gt;filename))
-		{
-			require_once($phpbb_root_path . &quot;$this-&gt;module_path/$this-&gt;filename.$phpEx&quot;);
-
-			if ($run)
-			{
-				if (!empty($mode))
-				{
-					$this-&gt;mode = $mode;
-				}
-
-				eval(&quot;\$this-&gt;module = new $this-&gt;filename(\$this-&gt;id, \$this-&gt;mode);&quot;);
-				if (method_exists($this-&gt;module, 'init'))
-				{
-					$this-&gt;module-&gt;init();
-				}
-			}
-		}
-	}
-
-	// Displays the appropriate template with the given title
-	function display($page_title, $tpl_name)
-	{
-		global $template;
-
-		$current_padding = 0;
-		$linear_offset 	= 'l_block1';
-		$tabular_offset = 't_block2';
-
-		// Generate the list of modules, we'll do this in two ways ...
-		// 1) In a linear fashion
-		// 2) In a combined tabbed + linear fashion ... tabs for the categories
-		//    and a linear list for subcategories/items
-		foreach ($this-&gt;module_ary as $row_id =&gt; $item_ary)
-		{
-			$padding = $this-&gt;module_y_ary[$row_id];
-
-			if ($padding &gt; $current_padding)
-			{
-				$linear_offset = $linear_offset . '.l_block' . ($padding + 1);
-				$tabular_offset = ($padding + 1 &gt; 2) ? $tabular_offset . '.t_block' . ($padding + 1) : $tabular_offset;
-			}
-			else if ($padding &lt; $current_padding)
-			{
-				for ($i = $current_padding - $padding; $i &gt; 0; $i--)
-				{
-					$linear_offset = substr($linear_offset, 0, strrpos($linear_offset, '.'));
-					$tabular_offset = ($i + $padding &gt; 1) ? substr($tabular_offset, 0, strrpos($tabular_offset, '.')) : $tabular_offset;
-				}
-			}
-
-			$current_padding = $padding;
-
-			// Only output a categories items if it's currently selected
-			if (!$padding || ($padding &amp;&amp; $item_ary['parent'] == $this-&gt;parent))
-			{
-				$use_tabular_offset = (!$padding) ? 't_block1' : $tabular_offset;
-				$template-&gt;assign_block_vars($use_tabular_offset, array(
-					'L_TITLE'		=&gt; $item_ary['name'],
-					'S_SELECTED'	=&gt; ($item_ary['id'] == $this-&gt;parent || $item_ary['active']) ? true : false,
-					'U_TITLE'		=&gt; $this-&gt;module_url . '&amp;i=' . $item_ary['id'])
-				);
-			}
-
-			$template-&gt;assign_block_vars($linear_offset, array(
-				'L_TITLE'		=&gt; $item_ary['name'],
-				'S_SELECTED'	=&gt; ($item_ary['id'] == $this-&gt;parent || $item_ary['active']) ? true : false,
-				'U_TITLE'		=&gt; $this-&gt;module_url . '&amp;i=' . $item_ary['id'])
-			);
-		}
-
-		page_header($page_title);
-
-		$template-&gt;set_filenames(array(
-			'body' =&gt; $tpl_name . '_' . $this-&gt;mode . '.html')
-		);
-
-		page_footer();
-	}
-
-	//
-	// Public methods to be overwritten by modules
-	//
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_posting.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -108,17 +108,32 @@
 	}
 
 	$update_sql = $empty_forums = array();
+	
+	if (sizeof($ids) == 1)
+	{
+		$sql = 'SELECT MAX(post_id) as last_post_id
+			FROM ' . POSTS_TABLE . '
+			WHERE post_approved = 1
+				AND '. $type . '_id = '.$ids[0];
+	}
+	else
+	{
+		$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
+			FROM ' . FORUMS_POSTS_TABLE . &quot;
+			WHERE post_approved = 1
+				AND {$type}_id IN (&quot; . implode(', ', $ids) . &quot;)
+			GROUP BY {$type}_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+	}
 
-	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . FORUMS_POSTS_TABLE . &quot;
-		WHERE post_approved = 1
-			AND {$type}_id IN (&quot; . implode(', ', $ids) . &quot;)
-		GROUP BY {$type}_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
 	$last_post_ids = array();
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
+		if (sizeof($ids) == 1)
+		{
+			$row[$type . '_id'] = $ids[0];
+		}
+
 		if ($type === 'forum')
 		{
 			$empty_forums[] = $row['forum_id'];
@@ -202,7 +217,7 @@
 
 	if (!$filedata['post_attach'])
 	{
-		$filedata['error'][] = 'No filedata found';
+		$filedata['error'][] = $_CLASS['core_user']-&gt;lang['NO_UPLOAD_FORM_FOUND'];
 		return $filedata;
 	}
 
@@ -223,6 +238,16 @@
 
 	$cat_id = (isset($extensions[$file-&gt;get('extension')]['display_cat'])) ? $extensions[$file-&gt;get('extension')]['display_cat'] : ATTACHMENT_CATEGORY_NONE;
 
+	// Make sure the image category only holds valid images...
+	if ($cat_id == ATTACHMENT_CATEGORY_IMAGE &amp;&amp; !$file-&gt;is_image())
+	{
+		$file-&gt;remove();
+
+		// If this error occurs a user tried to exploit an IE Bug by renaming extensions
+		// Since the image category is displaying content inline we need to catch this.
+		trigger_error('UNABLE_GET_IMAGE_SIZE');
+	}
+
 	// Do we have to create a thumbnail?
 	$filedata['thumbnail'] = ($cat_id == ATTACHMENT_CATEGORY_IMAGE &amp;&amp; $config['img_create_thumbnail']) ? 1 : 0;
 
@@ -533,7 +558,7 @@
 	
 	foreach ($attachment_data as $i =&gt; $attachment)
 	{
-		$s_inline_attachment_options .= '&lt;option value=&quot;' . $i . '&quot;&gt;' . $attachment['real_filename'] . '&lt;/option&gt;';
+		$s_inline_attachment_options .= '&lt;option value=&quot;' . $i . '&quot;&gt;' . basename($attachment['real_filename']) . '&lt;/option&gt;';
 	}
 
 	$_CLASS['core_template']-&gt;assign('S_INLINE_ATTACHMENT_OPTIONS', $s_inline_attachment_options);
@@ -618,18 +643,16 @@
 				$hidden .= '&lt;input type=&quot;hidden&quot; name=&quot;attachment_data[' . $count . '][' . $key . ']&quot; value=&quot;' . $value . '&quot; /&gt;';
 			}
 			
-			$download_link = (!$attach_row['attach_id']) ? $config['upload_path'] . '/' . basename($attach_row['physical_filename']) : generate_link('Forums&amp;file=download&amp;id=' . intval($attach_row['attach_id']));
-			
 			$_CLASS['core_template']-&gt;assign_vars_array('attach_row', array(
 				'FILENAME'			=&gt; basename($attach_row['real_filename']),
-				'ATTACH_FILENAME'	=&gt; basename($attach_row['physical_filename']),
-				'FILE_COMMENT'		=&gt; $attach_row['comment'],
+				'FILE_COMMENT'		=&gt; $attach_row['attach_comment'],
 				'ATTACH_ID'			=&gt; $attach_row['attach_id'],
+				'S_IS_ORPHAN'		=&gt; $attach_row['is_orphan'],
 				'ASSOC_INDEX'		=&gt; $count,
 
-				'U_VIEW_ATTACHMENT' =&gt; $download_link,
-				'S_HIDDEN'			=&gt; $hidden)
-			);
+				'U_VIEW_ATTACHMENT' =&gt; generate_link('forums&amp;file=download&amp;id=' . (int) $attach_row['attach_id']),
+				'S_HIDDEN'			=&gt; $hidden
+			));
 
 			$count++;
 		}
@@ -855,7 +878,7 @@
 		'notify_forum'		=&gt; 'Forum Post Notification - '. $forum_name,
 	);
 
-	if ($mode == 'reply' || $mode == 'quote')
+	if ($mode === 'reply' || $mode === 'quote')
 	{
 		$topic_title = $subject;
 
@@ -863,7 +886,7 @@
 		$template = 'notify_topic'; //notify_forum
 		$where = &quot;(w.forum_id = $forum_id OR w.topic_id = $topic_id)&quot;;
 	}
-	else
+	elseif ($mode == 'post')
 	{
 		$topic_title = $topic_title;
 
@@ -871,6 +894,10 @@
 		$template = 'notify_newtopic';
 		$where = 'w.forum_id = '.$forum_id;
 	}
+	else
+	{
+		trigger_error('WRONG_NOTIFICATION_MODE');
+	}
 
 	$topic_title = censor_text($topic_title);
 	$holding = array();
@@ -1255,7 +1282,7 @@
 				'post_subject'		=&gt; $subject,
 				'post_text'			=&gt; $data['message'],
 				'post_checksum'		=&gt; $data['message_md5'],
-				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'post_attachment'	=&gt; empty($data['attachment_data']) ? 0 : 1,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid'],
 				'post_postcount'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('f_postcount', $data['forum_id'])) ? 1 : 0,
@@ -1309,7 +1336,7 @@
 				'post_edit_reason'	=&gt; $data['post_edit_reason'],
 				'post_edit_user'	=&gt; (int) $data['post_edit_user'],
 				'post_checksum'		=&gt; $data['message_md5'],
-				'post_attachment'	=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'post_attachment'	=&gt; empty($data['attachment_data']) ? 0 : 1,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid'],
 				'post_edit_locked'	=&gt; $data['post_edit_locked'])
@@ -1337,7 +1364,7 @@
 				'topic_first_poster_name'	=&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : (($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']-&gt;data['username'] : ''),
 				'topic_type'				=&gt; $topic_type,
 				'topic_time_limit'			=&gt; ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'topic_attachment'			=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0,
+				'topic_attachment'			=&gt; empty($data['attachment_data']) ? 0 : 1,
 				'topic_status'				=&gt; 0,
 				'topic_replies_real'		=&gt; 0,
 				'topic_replies'				=&gt; 0,
@@ -1395,7 +1422,7 @@
 				'poll_length'				=&gt; (isset($poll['poll_options'])) ? ($poll['poll_length'] * 86400) : 0,
 				'poll_vote_change'			=&gt; (isset($poll['poll_vote_change'])) ? $poll['poll_vote_change'] : 0,
 
-				'topic_attachment'			=&gt; ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) &amp;&amp; sizeof($data['filename_data'])) ? 1 : 0) : (isset($data['topic_attachment']) ? $data['topic_attachment'] : 0)
+				'topic_attachment'			=&gt; empty($data['attachment_data']) ? 0 : 1
 			);
 		break;
 	}
@@ -1572,71 +1599,78 @@
 	if (count($data['attachment_data']) &amp;&amp; $data['post_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit')))
 	{
 		$space_taken = $files_added = $files_updated = 0;
-		$attach_sql_array = array();
+		$orphan_rows = array();
 
 		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
 		{
-			if ($attach_row['attach_id'])
+			$orphan_rows[(int) $attach_row['attach_id']] = array();
+		}
+
+		if (sizeof($orphan_rows))
+		{
+			$sql = 'SELECT attach_id, filesize, physical_filename
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', array_keys($orphan_rows)) . ')
+					AND is_orphan = 1
+					AND poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$orphan_rows = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
+				$orphan_rows[$row['attach_id']] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
+		{
+			if ($attach_row['is_orphan'] &amp;&amp; !in_array($attach_row['attach_id'], array_keys($orphan_rows)))
+			{
+				continue;
+			}
+
+			if (!$attach_row['is_orphan'])
+			{
 				// update entry in db if attachment already stored in db and filespace
 				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot;
-					SET comment = '&quot; . $_CLASS['core_db']-&gt;escape($attach_row['comment']) . &quot;'
-					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']-&gt;query($sql);
-				
-				$files_updated++;
+					SET attach_comment = '&quot; . $_CLASS['core_db']-&gt;escape($attach_row['attach_comment']) . &quot;'
+					WHERE attach_id = &quot; . (int) $attach_row['attach_id'] . '
+						AND is_orphan = 0';
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 			else
 			{
 				// insert attachment into db
-				if (!@file_exists($config['upload_path'] . '/' . basename($attach_row['physical_filename'])))
+				if (!@file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/' . basename($orphan_rows[$attach_row['attach_id']]['physical_filename'])))
 				{
 					continue;
 				}
 
-				$attach_sql_array[] = array(
-					'post_msg_id'		=&gt; (int) $data['post_id'],
-					'topic_id'			=&gt; (int) $data['topic_id'],
-					'in_message'		=&gt; 0,
-					'poster_id'			=&gt; (int) $poster_id,
-					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
-					'real_filename'		=&gt; basename($attach_row['real_filename']),
-					'download_count'	=&gt; 0,
-					'comment'			=&gt; $attach_row['comment'],
-					'extension'			=&gt; $attach_row['extension'],
-					'mimetype'			=&gt; $attach_row['mimetype'],
-					'filesize'			=&gt; $attach_row['filesize'],
-					'filetime'			=&gt; $attach_row['filetime'],
-					'thumbnail'			=&gt; $attach_row['thumbnail']
+				$space_taken += $orphan_rows[$attach_row['attach_id']]['filesize'];
+				$files_added++;
+
+				$attach_sql = array(
+					'post_msg_id'		=&gt; $data['post_id'],
+					'topic_id'			=&gt; $data['topic_id'],
+					'is_orphan'			=&gt; 0,
+					'poster_id'			=&gt; $poster_id,
+					'attach_comment'	=&gt; $attach_row['attach_comment'],
 				);
 
-				$space_taken += $attach_row['filesize'];
-				$files_added++;
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $attach_sql) . '
+					WHERE attach_id = ' . $attach_row['attach_id'] . '
+						AND is_orphan = 1
+						AND poster_id = ' . $user-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 		}
 
-		if (!empty($attach_sql_array))
-		{
-			$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_ATTACHMENTS_TABLE);
-			unset($attach_sql_array);
-		}
-
 		if ($files_updated || $files_added)
 		{
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET post_attachment = 1
-				WHERE post_id = ' . $data['post_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
-				SET topic_attachment = 1
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']-&gt;query($sql);
+			set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
+			set_config('num_files', $config['num_files'] + $files_added, true);
 		}
-		unset($attach_sql_array);
-
-		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
-		set_config('num_files', $config['num_files'] + $files_added, true);
 	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');
@@ -1734,7 +1768,7 @@
 			trigger_error($error);
 		}
 
-		$search-&gt;index($mode, $data['post_id'], $data['message'], $subject, $_CLASS['core_user']-&gt;lang['ENCODING'], $poster_id, ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id']);
+		$search-&gt;index($mode, $data['post_id'], $data['message'], $subject, $poster_id, ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id']);
 	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -797,7 +797,7 @@
 		
 		if ($_CLASS['core_user']-&gt;data['user_id'] == $user_id)
 		{
-			$_CLASS['core_user']-&gt;data['user_unread_privmsg'] = $_CLASS['core_user']-&gt;data['user_unread_privmsg'] + (($read) ? $count : -$count));
+			$_CLASS['core_user']-&gt;data['user_unread_privmsg'] = ($_CLASS['core_user']-&gt;data['user_unread_privmsg'] + (($read) ? $count : -$count));
 		}
 	}
 
@@ -1181,8 +1181,8 @@
 						'IS_USER'	=&gt; ($type === 'user'),
 						'COLOUR'	=&gt; ($row['colour']) ? $row['colour'] : '',
 						'UG_ID'		=&gt; $id,
-						'U_VIEW'	=&gt; ($type === 'user') ? (($id != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) ? '') : generate_link('members_list&amp;mode=group&amp;g=' . $id))
-					);
+						'U_VIEW'	=&gt; ($type === 'user') ? (($id != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) : '') : generate_link('members_list&amp;mode=group&amp;g=' . $id)
+					));
 				}
 			}
 		}
@@ -1333,7 +1333,7 @@
 				'enable_sig' 		=&gt; $data['enable_sig'],
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=&gt; empty($data['attachment_data']) ? 0 : 1,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid'],
 				'to_address'		=&gt; implode(':', $to),
@@ -1352,7 +1352,7 @@
 				'enable_sig' 		=&gt; $data['enable_sig'],
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
-				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=&gt; empty($data['attachment_data']) ? 0 : 1,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid']
 			);
@@ -1438,50 +1438,73 @@
 	if (!empty($data['attachment_data']) &amp;&amp; $data['msg_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'quotepost', 'edit', 'forward')))
 	{
 		$space_taken = $files_added = 0;
+		$orphan_rows = array();
 
 		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
 		{
-			if ($attach_row['attach_id'])
+			$orphan_rows[(int) $attach_row['attach_id']] = array();
+		}
+
+		if (sizeof($orphan_rows))
+		{
+			$sql = 'SELECT attach_id, filesize, physical_filename
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', array_keys($orphan_rows)) . ')
+					AND in_message = 1
+					AND is_orphan = 1
+					AND poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$orphan_rows = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$orphan_rows[$row['attach_id']] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		foreach ($data['attachment_data'] as $pos =&gt; $attach_row)
+		{
+			if ($attach_row['is_orphan'] &amp;&amp; !in_array($attach_row['attach_id'], array_keys($orphan_rows)))
+			{
+				continue;
+			}
+
+			if (!$attach_row['is_orphan'])
 			{
 				// update entry in db if attachment already stored in db and filespace
 				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . &quot; 
 					SET comment = '&quot; . $_CLASS['core_db']-&gt;sql_escape($attach_row['comment']) . &quot;' 
-					WHERE attach_id = &quot; . (int) $attach_row['attach_id'];
+					WHERE attach_id = &quot; . (int) $attach_row['attach_id'] . '
+						AND is_orphan = 0';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
 			else
 			{
-				// insert attachment into db 
-				$attach_sql = array(
-					'post_msg_id'		=&gt; $data['msg_id'],
-					'download_count'	=&gt; 0,
-					'topic_id'			=&gt; 0,
-					'in_message'		=&gt; 1,
-					'poster_id'			=&gt; $data['from_user_id'],
-					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
-					'real_filename'		=&gt; basename($attach_row['real_filename']),
-					'comment'			=&gt; $attach_row['comment'],
-					'extension'			=&gt; $attach_row['extension'],
-					'mimetype'			=&gt; $attach_row['mimetype'],
-					'filesize'			=&gt; $attach_row['filesize'],
-					'filetime'			=&gt; $attach_row['filetime'],
-					'thumbnail'			=&gt; $attach_row['thumbnail']
-				);
-
-				$_CLASS['core_db']-&gt;sql_query_build('INSERT', $attach_sql, FORUMS_ATTACHMENTS_TABLE);
-
-				$space_taken += $attach_row['filesize'];
-				$files_added++;
+				// insert attachment into db
+				if (!@file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/' . basename($orphan_rows[$attach_row['attach_id']]['physical_filename'])))
+				{
+					continue;
+				}
+
+				$space_taken += $orphan_rows[$attach_row['attach_id']]['filesize'];
+				$files_added++;
+
+				$attach_sql = array(
+					'post_msg_id'		=&gt; $data['msg_id'],
+					'topic_id'			=&gt; 0,
+					'is_orphan'			=&gt; 0,
+					'poster_id'			=&gt; $data['from_user_id'],
+					'attach_comment'	=&gt; $attach_row['attach_comment'],
+				);
+
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $attach_sql) . '
+					WHERE attach_id = ' . $attach_row['attach_id'] . '
+						AND is_orphan = 1
+						AND poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;query($sql);
 			}
 		}
-		
-		if (!empty($data['attachment_data']))
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
-				SET message_attachment = 1
-				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
 
 		if ($space_taken &amp;&amp; $files_added)
 		{

Deleted: cms/trunk/includes/forums/functions_profile_fields.php
===================================================================
--- cms/trunk/includes/forums/functions_profile_fields.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_profile_fields.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,894 +0,0 @@
-&lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_profile_fields.php,v 1.10 2004/09/19 20:40:20 acydburn Exp $
-//
-// FILENAME  : functions_profile_fields.php
-// STARTED   : Tue Oct 21, 2003
-// COPYRIGHT : &#169; 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-class custom_profile
-{
-	var $profile_types = array(1 =&gt; 'int', 2 =&gt; 'string', 3 =&gt; 'text', 4 =&gt; 'bool', 5 =&gt; 'dropdown', 6 =&gt; 'date');
-	var $profile_cache = array();
-	var $options_lang = array();
-
-	// Build language options cache, useful for viewtopic display
-	function build_cache()
-	{
-		global $_CLASS;
-
-		$this-&gt;profile_cache = array();
-
-		// Display hidden/no_view fields for admin/moderator
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
-			WHERE l.lang_id = ' . $_CLASS['core_user']-&gt;get_iso_lang_id() . '
-				AND f.field_active = 1 ' .
-				((!$_CLASS['auth']-&gt;acl_gets('a_', 'm_')) ? '     AND f.field_hide = 0 AND f.field_no_view = 0 ' : '') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			$this-&gt;profile_cache[$row['field_ident']] = $row;
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-	}
-
-	// Get language entries for options and store them here for later use
-	function get_option_lang($field_id, $lang_id, $field_type, $preview)
-	{
-		global $_CLASS;
-
-		if ($preview)
-		{
-			$lang_options = (!is_array($this-&gt;vars['lang_options'])) ? explode(&quot;\n&quot;, $this-&gt;vars['lang_options']) : $this-&gt;vars['lang_options'];
-			
-			foreach ($lang_options as $num =&gt; $var)
-			{
-				$this-&gt;options_lang[$field_id][$lang_id][($num+1)] = $var;
-			}
-		}
-		else
-		{
-			$sql = 'SELECT option_id, value
-				FROM ' . PROFILE_FIELDS_LANG_TABLE . &quot;
-					WHERE field_id = $field_id
-					AND lang_id = $lang_id
-					AND field_type = $field_type
-				ORDER BY option_id&quot;;
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-			{
-				$this-&gt;options_lang[$field_id][$lang_id][$row['option_id']] = $row['value'];
-			}
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-		}
-	}
-
-	// Functions performing operations on register/profile/profile admin
-	function submit_cp_field($mode, $lang_id, &amp;$cp_data, &amp;$cp_error)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . &quot; f 
-			WHERE l.lang_id = $lang_id
-				AND f.field_active = 1
-				&quot; . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
-				(($_CLASS['auth']-&gt;acl_gets('a_', 'm_') &amp;&amp; $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-					
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			$cp_data[$row['field_ident']] = $this-&gt;get_profile_field($row);
-
-			// get_profile_field returns an array with values for TEXT fields.
-			if(is_array($cp_data[$row['field_ident']]))
-			{
-				// Contains the original text without bbcode processing etc
-				$check_value = $cp_data[$row['field_ident']]['submitted'];
-				
-				foreach($cp_data[$row['field_ident']] as $key =&gt; $value)
-				{
-					if($key != 'submitted')
-					{
-						$cp_data[$key] = $value;
-					}
-				}
-			}
-			else
-			{
-				$check_value = $cp_data[$row['field_ident']];
-			}
-			
-			if (($cp_result = $this-&gt;validate_profile_field($row['field_type'], $check_value, $row)) !== false)
-			{
-				// If not and only showing common error messages, use this one
-				$error = false;
-
-				switch ($cp_result)
-				{
-					case 'FIELD_INVALID_DATE':
-					case 'FIELD_REQUIRED':
-						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name']);
-						break;
-					case 'FIELD_TOO_SHORT':
-					case 'FIELD_TOO_SMALL':
-						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name'], $row['field_minlen']);
-						break;
-					case 'FIELD_TOO_LONG':
-					case 'FIELD_TOO_LARGE':
-						$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result], $row['lang_name'], $row['field_maxlen']);
-						break;
-					case 'FIELD_INVALID_CHARS':
-						switch ($row['field_validation'])
-						{
-							case '[0-9]+':
-								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_NUMBERS_ONLY'], $row['lang_name']);
-								break;
-							case '[\w]+':
-								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_ALPHA_ONLY'], $row['lang_name']);
-								break;
-							case '[\w_\+\. \-\[\]]+':
-								$error = sprintf($_CLASS['core_user']-&gt;lang[$cp_result . '_SPACERS_ONLY'], $row['lang_name']);
-								break;
-						}
-						break;
-				}
-
-				if ($error)
-				{
-					$cp_error[] = $error;
-				}
-			}
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-	}
-	
-	// Assign fields to template, mode can be profile (for profile change) or register (for registration)
-//	function generate_profile_fields($mode, $lang_id, $cp_error)
-	function generate_profile_fields($mode, $lang_id)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . &quot; f 
-			WHERE l.lang_id = $lang_id
-				AND f.field_active = 1
-				&quot; . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
-				(($_CLASS['auth']-&gt;acl_gets('a_', 'm_') &amp;&amp; $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			$_CLASS['core_template']-&gt;assign_vars_array('profile_fields', array(
-				'LANG_NAME' =&gt; $row['lang_name'],
-				'LANG_EXPLAIN' =&gt; $row['lang_explain'],
-				'FIELD' =&gt; $this-&gt;process_field_row('change', $row))
-//				'ERROR' =&gt; $error)
-			);
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-	}
-
-	// Assign fields to template, used for viewprofile, viewtopic and memberlist (if load setting is enabled)
-	// This is directly connected to the user -&gt; mode == grab is to grab the user specific fields, mode == show is for assigning the row to the template
-	function generate_profile_fields_template($mode, $user_id = 0, $profile_row = false)
-	{
-		global $_CLASS;
-
-		if ($mode == 'grab')
-		{
-			if (!is_array($user_id))
-			{
-				$user_id = array($user_id);
-			}
-			
-			if (!sizeof($this-&gt;profile_cache))
-			{
-				$this-&gt;build_cache();
-			}
-
-			if (!implode(', ', $user_id))
-			{
-				return array();
-			}
-
-			$sql = 'SELECT *
-				FROM ' . PROFILE_DATA_TABLE . '
-				WHERE user_id IN (' . implode(', ', array_map('intval', $user_id)) . ')';
-			$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']-&gt;sql_fetchrow($result)))
-			{
-				return array();
-			}
-			
-			$user_fields = array();
-			do
-			{
-				foreach ($row as $ident =&gt; $value)
-				{
-					if (isset($this-&gt;profile_cache[$ident]))
-					{
-						$user_fields[$row['user_id']][$ident]['value'] = $value;
-						$user_fields[$row['user_id']][$ident]['data'] = $this-&gt;profile_cache[$ident];
-					}
-					else if($i = strpos($ident, '_bbcode'))
-					{
-						// Add extra data (bbcode_uid and bbcode_bitfield) to the data for this profile field.
-						// TODO: Maybe we should try to make this a bit more generic (not limited to bbcode)?
-						$field = substr($ident, 0, $i);
-						$subfield = substr($ident, $i+1);
-						$user_fields[$row['user_id']][$field]['data'][$subfield] = $value;
-					}
-				}
-			} 
-			while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result));
-			
-			$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-			return $user_fields;
-
-		}
-		elseif ($mode == 'show')
-		{
-			// $profile_row == $user_fields[$row['user_id']];
-			$tpl_fields = array();
-			$tpl_fields['row'] = $tpl_fields['blockrow'] = array();
-
-			foreach ($profile_row as $ident =&gt; $ident_ary)
-			{
-				$tpl_fields['row'] += array(
-					'PROFILE_' . strtoupper($ident) . '_VALUE'	=&gt; $this-&gt;get_profile_value($ident_ary),
-					'PROFILE_' . strtoupper($ident) . '_TYPE'	=&gt; $ident_ary['data']['field_type'],
-					'PROFILE_' . strtoupper($ident) . '_NAME'	=&gt; $ident_ary['data']['lang_name'],
-					'PROFILE_' . strtoupper($ident) . '_EXPLAIN'=&gt; $ident_ary['data']['lang_explain'],
-
-					'S_PROFILE_' . strtoupper($ident)			=&gt; true
-				);
-				
-				$tpl_fields['blockrow'][] = array(
-					'PROFILE_FIELD_VALUE'   =&gt; $this-&gt;get_profile_value($ident_ary),
-					'PROFILE_FIELD_TYPE'    =&gt; $ident_ary['data']['field_type'],
-					'PROFILE_FIELD_NAME'    =&gt; $ident_ary['data']['lang_name'],
-					'PROFILE_FIELD_EXPLAIN' =&gt; $ident_ary['data']['lang_explain'],
-					'S_PROFILE_' . strtoupper($ident)               =&gt; true
-				);
-			}
-		
-			return $tpl_fields;
-		}
-	}
-	
-	// VALIDATE Function - validate entered data
-	function validate_profile_field($field_type, &amp;$field_value, $field_data)
-	{
-		switch ($field_type)
-		{
-			case FIELD_INT:
-			case FIELD_DROPDOWN:
-				$field_value = (int) $field_value;
-				break;
-
-			case FIELD_BOOL:
-				$field_value = (bool) $field_value;
-				break;
-		}
-
-		switch ($field_type)
-		{
-			case FIELD_DATE:
-				$field_validate = explode('-', $field_value);
-				
-				$day = (int) $field_validate[0];
-				$month = (int) $field_validate[1];
-				$year = (int) $field_validate[2];
-
-				if ((!$day || !$month || !$year) &amp;&amp; !$field_data['field_required'])
-				{
-					return false;
-				}
-
-				if ((!$day || !$month || !$year) &amp;&amp; $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-
-				if ($day &lt; 0 || $day &gt; 31 || $month &lt; 0 || $month &gt; 12 || ($year &lt; 1901 &amp;&amp; $year &gt; 0) || $year &gt; gmdate('Y', time()))
-				{
-					return 'FIELD_INVALID_DATE';
-				}
-				break;
-
-			case FIELD_INT:
-				if (empty($field_value) &amp;&amp; !$field_data['field_required'])
-				{
-					return false;
-				}
-
-				if ($field_value &lt; $field_data['field_minlen'])
-				{
-					return 'FIELD_TOO_SMALL';
-				}
-				else if ($field_value &gt; $field_data['field_maxlen']) 
-				{
-					return 'FIELD_TOO_LARGE';
-				}
-				break;
-		
-			case FIELD_DROPDOWN:
-				if ($field_value == $field_data['field_novalue'] &amp;&amp; $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-				break;
-			
-			case FIELD_STRING:
-			case FIELD_TEXT:
-				if (empty($field_value) &amp;&amp; !$field_data['field_required'])
-				{
-					return false;
-				}
-				else if (empty($field_value) &amp;&amp; $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-
-				if ($field_data['field_minlen'] &amp;&amp; strlen($field_value) &lt; $field_data['field_minlen'])
-				{
-					return 'FIELD_TOO_SHORT';
-				}
-				else if ($field_data['field_maxlen'] &amp;&amp; strlen($field_value) &gt; $field_data['field_maxlen'])
-				{
-					return 'FIELD_TOO_LONG';
-				}
-
-				if (!empty($field_data['field_validation']) &amp;&amp; $field_data['field_validation'] != '.*')
-				{
-					$field_validate = ($field_type == FIELD_STRING) ? $field_value : str_replace(&quot;\n&quot;, ' ', $field_value);
-					if (!preg_match('#^' . str_replace('\\\\', '\\', $field_data['field_validation']) . '$#i', $field_validate))
-					{
-						return 'FIELD_INVALID_CHARS';
-					}
-				}
-				break;
-		}
-
-		return false;
-	}
-
-	// Get Profile Value for display
-	function get_profile_value($ident_ary)
-	{
-		$value = $ident_ary['value'];
-		$field_type = $ident_ary['data']['field_type'];
-		
-		switch ($this-&gt;profile_types[$field_type])
-		{
-			case 'int':
-				return (int) $value;
-				break;
-			case 'string':
-				return str_replace(&quot;\n&quot;, '&lt;br /&gt;', $value);
-				break;
-			case 'text':
-				// Prepare further, censor_text, smilies, bbcode, html, whatever
-				if ($ident_ary['data']['bbcode_bitfield'])
-				{
-					$bbcode = new bbcode($ident_ary['data']['bbcode_bitfield']);
-					$bbcode-&gt;bbcode_second_pass($value, $ident_ary['data']['bbcode_uid'], $ident_ary['data']['bbcode_bitfield']);
-					$value = smiley_text($value);
-					$value = censor_text($value);
-				}
-				
-				return str_replace(&quot;\n&quot;, '&lt;br /&gt;', $value);
-				break;
-			case 'date':
-				break;
-			case 'dropdown':
-				$field_id = $ident_ary['data']['field_id'];
-				$lang_id = $ident_ary['data']['lang_id'];
-				if (!isset($this-&gt;options_lang[$field_id][$lang_id]))
-				{
-					$this-&gt;get_option_lang($field_id, $lang_id, FIELD_DROPDOWN, false);
-				}
-
-				return $this-&gt;options_lang[$field_id][$lang_id][(int) $value];
-				break;
-			case 'bool':
-				break;
-			default:
-				trigger_error('Unknown profile type');
-				break;
-		}
-	}
-
-	// Get field value for registration/profile
-	function get_var($field_validation, &amp;$profile_row, $default_value, $preview)
-	{
-		global $_CLASS;
-
-		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
-		
-		// checkbox - only testing for isset
-		if ($profile_row['field_type'] == FIELD_BOOL &amp;&amp; $profile_row['field_length'] == 2)
-		{
-			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? true : ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $default_value : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]);
-		}
-		else
-		{
-			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? request_var($profile_row['field_ident'], $default_value) : ((!isset($_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]) || $preview) ? $default_value : $_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]);
-		}
-
-		switch ($field_validation)
-		{
-			case 'int':
-				return (int) $value;
-				break;
-		}
-
-		return $value;
-	}
-	
-	// GENERATE_* Functions - return templated, storable profile fields
-	function generate_int($profile_row, $preview = false)
-	{
-		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-		$this-&gt;set_tpl_vars($profile_row, $value);
-
-		return $this-&gt;get_cp_html();
-	}
-
-	function generate_date($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
-		$now = getdate();
-
-		if (!isset($_REQUEST[$profile_row['field_ident'] . '_day']))
-		{
-			if ($profile_row['field_default_value'] == 'now')
-			{
-				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-			}
-			list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]));
-		}
-		else
-		{
-			if ($preview &amp;&amp; $profile_row['field_default_value'] == 'now')
-			{
-				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-				list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']-&gt;profile_fields[$profile_row['field_ident']]));
-			}
-			else
-			{
-				$day = request_var($profile_row['field_ident'] . '_day', 0);
-				$month = request_var($profile_row['field_ident'] . '_month', 0);
-				$year = request_var($profile_row['field_ident'] . '_year', 0);
-			}
-		}
-
-		$profile_row['s_day_options'] = '&lt;option value=&quot;0&quot;' . ((!$day) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-		for ($i = 1; $i &lt; 32; $i++)
-		{
-			$profile_row['s_day_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $day) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
-		}
-
-		$profile_row['s_month_options'] = '&lt;option value=&quot;0&quot;' . ((!$month) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-		for ($i = 1; $i &lt; 13; $i++)
-		{
-			$profile_row['s_month_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $month) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
-		}
-
-		$profile_row['s_year_options'] = '&lt;option value=&quot;0&quot;' . ((!$year) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-		for ($i = $now['year'] - 100; $i &lt;= $now['year']; $i++)
-		{
-			$profile_row['s_year_options'] .= '&lt;option value=&quot;' . $i . '&quot;' . (($i == $year) ? ' selected=&quot;selected&quot;' : '') . &quot;&gt;$i&lt;/option&gt;&quot;;
-		}
-		unset($now);
-		
-		$this-&gt;set_tpl_vars($profile_row, 0);
-		return $this-&gt;get_cp_html();
-	}
-
-	function generate_bool($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-
-		$this-&gt;set_tpl_vars($profile_row, $value);
-
-		if ($profile_row['field_length'] == 1)
-		{
-			if (!isset($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]) || !sizeof($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
-			{
-				$this-&gt;get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_BOOL, $preview);
-			}
-
-			foreach ($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id =&gt; $option_value)
-			{
-				$_CLASS['core_template']-&gt;assign_vars_array('bool.options', array(
-					'OPTION_ID' =&gt; $option_id,
-					'CHECKED' =&gt; ($value == $option_id) ? ' checked=&quot;checked&quot;' : '',
-					'VALUE' =&gt; $option_value)
-				);
-			}
-		}
-
-		return $this-&gt;get_cp_html();
-	}
-
-	// Get the data associated with this field for this user
-	function generate_string($profile_row, $preview = false)
-	{
-		$value = $this-&gt;get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
-		$this-&gt;set_tpl_vars($profile_row, $value);
-
-		return $this-&gt;get_cp_html();
-	}
-
-	function generate_text($profile_row, $preview = false)
-	{
-		global $_CLASS, $site_file_root;
-		
-		$value = $this-&gt;get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
-		
-		if($preview == false)
-		{
-			include_once($site_file_root.'includes/forums/message_parser.php');
-			include_once($site_file_root.'includes/forums/functions_posting.php');
-			
-			$message_parser = new parse_message();
-			$message_parser-&gt;message = $value;
-			$message_parser-&gt;decode_message($_CLASS['core_user']-&gt;profile_fields[str_replace('pf_', '', $profile_row['field_ident']) . '_bbcode_uid']);
-			$value = $message_parser-&gt;message;
-		}
-		
-		$field_length = explode('|', $profile_row['field_length']);
-		$profile_row['field_rows'] = $field_length[0];
-		$profile_row['field_cols'] = $field_length[1];
-
-		$this-&gt;set_tpl_vars($profile_row, $value);
-
-		return $this-&gt;get_cp_html();
-	}
-
-	function generate_dropdown($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$value = $this-&gt;get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-
-		if (!isset($this-&gt;options_lang[$profile_row['field_id']]) || !sizeof($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
-		{
-			$this-&gt;get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_DROPDOWN, $preview);
-		}
-
-		$this-&gt;set_tpl_vars($profile_row, $value);
-
-		foreach ($this-&gt;options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id =&gt; $option_value)
-		{
-			$_CLASS['core_template']-&gt;assign_vars_array('dropdown.options', array(
-				'OPTION_ID' =&gt; $option_id,
-				'SELECTED' =&gt; ($value == $option_id) ? ' selected=&quot;selected&quot;' : '',
-				'VALUE' =&gt; $option_value)
-			);
-		}
-
-		return $this-&gt;get_cp_html();
-	}
-
-
-	// Return Templated value (change == user is able to set/enter profile values; show == just show the value)
-	function process_field_row($mode, $profile_row)
-	{
-		$preview = false;
-
-		switch ($mode)
-		{
-			case 'preview':
-				$preview = true;
-			case 'change':
-				$type_func = 'generate_' . $this-&gt;profile_types[$profile_row['field_type']];
-				break;
-			default:
-				return;
-		}
-
-		return $this-&gt;$type_func($profile_row, $preview);
-	}
-
-	// Build Array for user insertion into custom profile fields table
-	function build_insert_sql_array($cp_data)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT f.field_type, f.field_ident, f.field_default_value, l.lang_default_value
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
-			WHERE l.lang_id = ' . $_CLASS['core_user']-&gt;get_iso_lang_id() . ' 
-				AND f.field_active = 1
-				AND f.field_show_on_reg = 0
-				' . (($_CLASS['auth']-&gt;acl_gets('a_', 'm_')) ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id';
-		$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-		{
-			if ($row['field_default_value'] == 'now' &amp;&amp; $row['field_type'] == FIELD_DATE)
-			{
-				$now = getdate();
-				$row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-			}
-			$cp_data[$row['field_ident']] = (in_array($row['field_type'], array(FIELD_TEXT, FIELD_STRING))) ? $row['lang_default_value'] : $row['field_default_value'];
-		}
-		$_CLASS['core_db']-&gt;sql_freeresult($result);
-		
-		return $cp_data;
-	}
-
-	function get_profile_field($profile_row)
-	{
-		global $site_file_root;
-		
-		switch ($profile_row['field_type'])
-		{
-			case FIELD_DATE:
-
-				if (!isset($_REQUEST[$var_name . '_day']))
-				{
-					if ($profile_row['field_default_value'] == 'now')
-					{
-						$now = getdate();
-						$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-					}
-					list($day, $month, $year) = explode('-', $profile_row['field_default_value']);
-				}
-				else
-				{
-					$day = request_var($var_name . '_day', 0);
-					$month = request_var($var_name . '_month', 0);
-					$year = request_var($var_name . '_year', 0);
-				}
-				
-				$var = sprintf('%2d-%2d-%4d', $day, $month, $year);
-				break;
-
-			case FIELD_TEXT:
-				include_once($site_file_root.'includes/forums/message_parser.php');
-				$message_parser = new parse_message(request_var($var_name, ''));
-				
-				// Get the allowed settings from the global settings. Magic URLs are always set to true.
-				// TODO: It might be nice to make this a per field setting.
-				$message_parser-&gt;parse($config['allow_html'], $config['allow_bbcode'], true, $config['allow_smilies']);
-				
-				$var = array(
-					$profile_row['field_ident'] =&gt; $message_parser-&gt;message,
-					$profile_row['field_ident'] . '_bbcode_uid' =&gt; $message_parser-&gt;bbcode_uid,
-					$profile_row['field_ident'] . '_bbcode_bitfield' =&gt; $message_parser-&gt;bbcode_bitfield,
-					 'submitted' =&gt; request_var($var_name, '')
-				);
-				break;
-
-			default:
-				$var = request_var($var_name, $profile_row['field_default_value']);
-				break;
-		}
-
-		return $var;
-	}
-
-	function set_tpl_vars($profile_row, $field_value)
-	{
-		global $_CLASS;
-		
-		foreach ($this-&gt;profile_types as $field_case =&gt; $field_type)
-		{
-			unset($_CLASS['core_template']-&gt;_tpl_vars[$field_type]);
-		}
-
-		foreach ($profile_row as $key =&gt; $value)
-		{
-			unset($profile_row[$key]);
-			$profile_row[strtoupper($key)] = $value;
-		}
-
-		$profile_row['FIELD_VALUE'] = $field_value;
-
-		$_CLASS['core_template']-&gt;assign_vars_array($this-&gt;profile_types[$profile_row['FIELD_TYPE']], $profile_row);
-	}
-
-	function get_cp_html()
-	{
-		global $_CLASS;
-
-		ob_start();
-
-		$_CLASS['core_template']-&gt;display('forums/custom_profile_fields.html');
-
-		$data = ob_get_contents();
-		ob_end_clean();
-
-		return $data;
-	}
-}
-
-class custom_profile_admin extends custom_profile
-{
-	var $vars = array();
-	
-
-	function validate_options()
-	{
-		global $_CLASS;
-
-		$validate_ary = array('CHARS_ANY' =&gt; '.*', 'NUMBERS_ONLY' =&gt; '[0-9]+', 'ALPHA_ONLY' =&gt; '[\w]+', 'ALPHA_SPACERS' =&gt; '[\w_\+\. \-\[\]]+');
-
-		$validate_options = '';
-		foreach ($validate_ary as $lang =&gt; $value)
-		{
-			$selected = ($this-&gt;vars['field_validation'] == $value) ? ' selected=&quot;selected&quot;' : '';
-			$validate_options .= '&lt;option value=&quot;' . $value . '&quot;' . $selected . '&gt;' . $_CLASS['core_user']-&gt;lang[$lang] . '&lt;/option&gt;';
-		}
-
-		return $validate_options;
-	}
-	
-	// GET_* get admin options for second step
-	function get_string_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_length&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;'),
-			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
-			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
-			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_VALIDATION'], 'FIELD' =&gt; '&lt;select name=&quot;field_validation&quot;&gt;' . $this-&gt;validate_options() . '&lt;/select&gt;')
-		);
-
-		return $options;
-	}
-
-	function get_text_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;table border=0&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;rows&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['rows'] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $_CLASS['core_user']-&gt;lang['ROWS'] . ' ]&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;input name=&quot;columns&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['columns'] . '&quot; class=&quot;post&quot; /&gt;&lt;/td&gt;&lt;td&gt;[ ' . $_CLASS['core_user']-&gt;lang['COLUMNS'] . ' ] &lt;input type=&quot;hidden&quot; name=&quot;field_length&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;'),
-			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;10&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
-			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_CHARS'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;10&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
-			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_VALIDATION'], 'FIELD' =&gt; '&lt;select name=&quot;field_validation&quot;&gt;' . $this-&gt;validate_options() . '&lt;/select&gt;')
-		);
-
-		return $options;
-	}
-
-	function get_int_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_LENGTH'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_length&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_length'] . '&quot; /&gt;'),
-			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MIN_FIELD_NUMBER'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_minlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_minlen'] . '&quot; /&gt;'),
-			2 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['MAX_FIELD_NUMBER'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;field_maxlen&quot; size=&quot;5&quot; value=&quot;' . $this-&gt;vars['field_maxlen'] . '&quot; /&gt;'),
-			3 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; '&lt;input class=&quot;post&quot; type=&quot;post&quot; name=&quot;field_default_value&quot; value=&quot;' . $this-&gt;vars['field_default_value'] . '&quot; /&gt;')
-		);
-
-		return $options;
-	}
-
-	function get_bool_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row = array(
-			'var_name'				=&gt; 'field_default_value',
-			'field_id'				=&gt; 1,
-			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
-			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
-			'lang_id'				=&gt; $default_lang_id,
-			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
-			'field_ident'			=&gt; 'field_default_value',
-			'field_type'			=&gt; FIELD_BOOL,
-			'field_length'			=&gt; $this-&gt;vars['field_length'],
-			'lang_options'			=&gt; $this-&gt;vars['lang_options']
-		);
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['FIELD_TYPE'], 'EXPLAIN' =&gt; $_CLASS['core_user']-&gt;lang['BOOL_TYPE_EXPLAIN'], 'FIELD' =&gt; '&lt;input type=&quot;radio&quot; name=&quot;field_length&quot; value=&quot;1&quot;' . (($this-&gt;vars['field_length'] == 1) ? ' checked=&quot;checked&quot;' : '') . ' /&gt;' . $_CLASS['core_user']-&gt;lang['RADIO_BUTTONS'] . '&nbsp; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;field_length&quot; value=&quot;2&quot;' . (($this-&gt;vars['field_length'] == 2) ? ' checked=&quot;checked&quot;' : '') . ' /&gt;' . $_CLASS['core_user']-&gt;lang['CHECKBOX'] . '&nbsp; &nbsp;'),
-			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_bool($profile_row, true))
-		);
-
-		return $options;
-	}
-
-	function get_dropdown_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row[0] = array(
-			'var_name'				=&gt; 'field_default_value',
-			'field_id'				=&gt; 1,
-			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
-			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
-			'lang_id'				=&gt; $default_lang_id,
-			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
-			'field_ident'			=&gt; 'field_default_value',
-			'field_type'			=&gt; FIELD_DROPDOWN,
-			'lang_options'			=&gt; $this-&gt;vars['lang_options']
-		);
-
-		$profile_row[1] = $profile_row[0];
-		$profile_row[1]['var_name'] = 'field_novalue';
-		$profile_row[1]['field_ident'] = 'field_novalue';
-		$profile_row[1]['field_default_value']	= $this-&gt;vars['field_novalue'];
-
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_dropdown($profile_row[0], true)),
-			1 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['NO_VALUE_OPTION'], 'EXPLAIN' =&gt; $_CLASS['core_user']-&gt;lang['NO_VALUE_OPTION_EXPLAIN'], 'FIELD' =&gt; $this-&gt;generate_dropdown($profile_row[1], true))
-		);
-
-		return $options;
-	}
-
-	function get_date_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row = array(
-			'var_name'				=&gt; 'field_default_value',
-			'lang_name'				=&gt; $this-&gt;vars['lang_name'],
-			'lang_explain'			=&gt; $this-&gt;vars['lang_explain'],
-			'lang_id'				=&gt; $default_lang_id,
-			'field_default_value'	=&gt; $this-&gt;vars['field_default_value'],
-			'field_ident'			=&gt; 'field_default_value',
-			'field_type'			=&gt; FIELD_DATE,
-			'field_length'			=&gt; $this-&gt;vars['field_length']
-		);
-
-		$options = array(
-			0 =&gt; array('TITLE' =&gt; $_CLASS['core_user']-&gt;lang['DEFAULT_VALUE'], 'FIELD' =&gt; $this-&gt;generate_date($profile_row, true) . '&lt;br /&gt;&lt;input type=&quot;checkbox&quot; name=&quot;always_now&quot;' . ((isset($_REQUEST['always_now']) || $this-&gt;vars['field_default_value'] == 'now') ? ' checked=&quot;checked&quot;' : '') . ' /&gt;&nbsp; ' . $_CLASS['core_user']-&gt;lang['ALWAYS_TODAY'])
-		);
-
-		return $options;
-	}
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_upload.php
===================================================================
--- cms/trunk/includes/forums/functions_upload.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_upload.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -233,12 +233,27 @@
 			$destination = '';
 		}
 
+		// We need to trust the admin in specifying valid upload directories and an attacker not being able to overwrite it...
 		$this-&gt;destination_path = SITE_FILE_ROOT.$destination;
 
+		// Check if the destination path exist...
+		if (!file_exists($this-&gt;destination_path))
+		{
+			@unlink($this-&gt;filename);
+			return false;
+		}
+
 		$upload_mode = (@ini_get('open_basedir') || @ini_get('safe_mode')) ? 'move' : 'copy';
 		$upload_mode = ($this-&gt;local) ? 'local' : $upload_mode;
 		$this-&gt;destination_file = $this-&gt;destination_path . '/' . basename($this-&gt;realname);
 
+		// Check if the file already exist, else there is something wrong...
+		if (file_exists($this-&gt;destination_file))
+		{
+			@unlink($this-&gt;filename);
+			return false;
+		}
+
 		switch ($upload_mode)
 		{
 			case 'copy':

Deleted: cms/trunk/includes/forums/functions_user.php
===================================================================
--- cms/trunk/includes/forums/functions_user.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/functions_user.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,1667 +0,0 @@
-&lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_user.php,v 1.37 2004/05/02 13:05:38 acydburn Exp $
-//
-// FILENAME  : functions_user.php
-// STARTED   : Sat Dec 16, 2000
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//
-// User functions
-//
-
-// Obtain user_ids from usernames or vice versa. Returns false on
-// success else the error string
-function user_get_id_name(&amp;$user_id_ary, &amp;$username_ary)
-{
-	global $_CLASS;
-
-	// Are both arrays already filled? Yep, return else
-	// are neither array filled? 
-	if ($user_id_ary &amp;&amp; $username_ary)
-	{
-		return;
-	}
-	else if (!$user_id_ary &amp;&amp; !$username_ary)
-	{
-		return 'NO_USERS';
-	}
-
-	$which_ary = ($user_id_ary) ? 'user_id_ary' : 'username_ary';
-
-	if ($$which_ary  &amp;&amp; !is_array($$which_ary))
-	{
-		$$which_ary = array($$which_ary);
-	}
-
-	$sql_in = ($which_ary == 'user_id_ary') ? array_map('intval', $$which_ary) : preg_replace('#^[\s]*(.*?)[\s]*$#e', &quot;\&quot;'\&quot; . \$_CLASS['core_db']-&gt;escape('\\1') . \&quot;'\&quot;&quot;, $$which_ary);
-	unset($$which_ary);
-
-	// Grab the user id/username records
-	$sql_where = ($which_ary == 'user_id_ary') ? 'user_id' : 'username';
-	$sql = 'SELECT user_id, username 
-		FROM ' . USERS_TABLE . &quot; 
-		WHERE $sql_where IN (&quot; . implode(', ', $sql_in) . ')';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-	{
-		return 'NO_USERS';
-	}
-
-	$id_ary = $username_ary = array();
-	do
-	{
-		$username_ary[$row['user_id']] = $row['username'];
-		$user_id_ary[] = $row['user_id'];
-	}
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	return false;
-}
-
-// Updates a username across all relevant tables/fields
-function user_update_name($old_name, $new_name)
-{
-	global $config, $_CLASS;
-
-	$update_ary = array(
-		FORUMS_TABLE	=&gt; array('forum_last_poster_name'), 
-		MODERATOR_TABLE	=&gt; array('username'), 
-		POSTS_TABLE		=&gt; array('post_username'), 
-		TOPICS_TABLE	=&gt; array('topic_first_poster_name', 'topic_last_poster_name'),
-	);
-
-	foreach ($update_ary as $table =&gt; $field_ary)
-	{
-		foreach ($field_ary as $field)
-		{
-			$sql = &quot;UPDATE $table 
-				SET $field = '$new_name' 
-				WHERE $field = '$old_name'&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-
-	if ($config['newest_username'] == $old_name)
-	{
-		set_config('newest_username', $new_name);
-	}
-}
-
-function user_delete($mode, $user_id)
-{
-	global $config, $_CLASS;
-	
-	$_CLASS['core_db']-&gt;sql_transaction();
-
-	switch ($mode)
-	{
-		case 'retain':
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
-				SET forum_last_poster_id = ' . ANONYMOUS . &quot; 
-				WHERE forum_last_poster_id = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . POSTS_TABLE . '
-				SET poster_id = ' . ANONYMOUS . &quot; 
-				WHERE poster_id = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
-				SET topic_poster = ' . ANONYMOUS . &quot;
-				WHERE topic_poster = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
-				SET topic_last_poster_id = ' . ANONYMOUS . &quot;
-				WHERE topic_last_poster_id = $user_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-			break;
-
-		case 'remove':
-
-			if (!function_exists('delete_posts'))
-			{
-				global $site_file_root;
-
-				include($site_file_root.'includes/forums/functions_admin.php');
-			}
-
-			$sql = 'SELECT topic_id, COUNT(post_id) AS total_posts 
-				FROM ' . POSTS_TABLE . &quot; 
-				WHERE poster_id = $user_id
-				GROUP BY topic_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$topic_id_ary = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$topic_id_ary[$row['topic_id']] = $row['total_posts'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-			
-			if (!count($topic_id_ary))
-			{
-				break;
-			}
-
-			$sql = 'SELECT topic_id, topic_replies, topic_replies_real 
-				FROM ' . TOPICS_TABLE . ' 
-				WHERE topic_id IN (' . implode(', ', array_keys($topic_id_ary)) . ')';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$del_topic_ary = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				if (max($row['topic_replies'], $row['topic_replies_real']) + 1 == $topic_id_ary[$row['topic_id']])
-				{
-					$del_topic_ary[] = $row['topic_id'];
-				}
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if (sizeof($del_topic_ary))
-			{
-				$sql = 'DELETE FROM ' . TOPICS_TABLE . ' 
-					WHERE topic_id IN (' . implode(', ', $del_topic_ary) . ')';
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-
-			// Delete posts, attachments, etc.
-			delete_posts('poster_id', $user_id);
-
-			break;
-	}
-
-	$table_ary = array(USERS_TABLE, USER_GROUP_TABLE, TOPICS_WATCH_TABLE, FORUMS_WATCH_TABLE, ACL_USERS_TABLE, TOPICS_TRACK_TABLE, FORUMS_TRACK_TABLE);
-
-	foreach ($table_ary as $table)
-	{
-		$sql = &quot;DELETE FROM $table 
-			WHERE user_id = $user_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Reset newest user info if appropriate
-	if ($config['newest_user_id'] == $user_id)
-	{
-		$sql = 'SELECT user_id, username 
-			FROM ' . USERS_TABLE . '
-			WHERE user_type IN (' . USER_NORMAL . ', ' . USER_FOUNDER . ')
-			ORDER BY user_id DESC
-			LIMIT 1';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			set_config('newest_user_id', $row['user_id']);
-			set_config('newest_username', $row['username']);
-		}
-		$_CLASS['core_db']-&gt;freeresult($result);
-	}
-
-	set_config('num_users', $config['num_users'] - 1, TRUE);
-
-	$_CLASS['core_db']-&gt;sql_transaction('commit');
-
-	return false;
-}
-
-// Flips user_type from active to inactive and vice versa, handles
-// group membership updates
-function user_active_flip($user_id, $user_type, $user_actkey = false, $username = false)
-{
-	global $_CLASS;
-
-	$sql = 'SELECT group_id, group_name 
-		FROM ' . GROUPS_TABLE . &quot; 
-		WHERE group_name IN ('REGISTERED', 'REGISTERED_COPPA', 'INACTIVE', 'INACTIVE_COPPA')&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$group_id_ary = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$group_id_ary[$row['group_name']] = $row['group_id'];
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$sql = 'SELECT group_id 
-		FROM ' . USER_GROUP_TABLE . &quot; 
-		WHERE user_id = $user_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if ($group_name = array_search($row['group_id'], $group_id_ary))
-		{
-			break;
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$current_group = ($user_type == USER_NORMAL) ? 'REGISTERED' : 'INACTIVE';
-	$switch_group = ($user_type == USER_NORMAL) ? 'INACTIVE' : 'REGISTERED';
-
-	$new_group_id = $group_id_ary[str_replace($current_group, $switch_group, $group_name)];
-
-	$sql = 'UPDATE ' . USER_GROUP_TABLE . &quot; 
-		SET group_id = $new_group_id 
-		WHERE user_id = $user_id
-			AND group_id = &quot; . $group_id_ary[$group_name];
-	$_CLASS['core_db']-&gt;query($sql);
-
-	$sql_ary = array(
-		'user_type'		=&gt; ($user_type == USER_NORMAL) ? USER_INACTIVE : USER_NORMAL
-	);
-
-	if ($group_id == $group_id_ary[$group_name])
-	{
-		$sql_ary['group_id'] = $new_group_id;
-	}
-
-	if ($user_actkey !== false)
-	{
-		$sql_ary['user_actkey'] = $user_actkey;
-	}
-
-	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . &quot;
-		WHERE user_id = $user_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	$_CLASS['auth']-&gt;acl_clear_prefetch($user_id);
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	if (!$username)
-	{
-		$sql = 'SELECT username
-			FROM ' . USERS_TABLE . &quot; 
-			WHERE user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		
-		extract($_CLASS['core_db']-&gt;fetch_row_assoc($result));
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	$log = ($user_type == USER_NORMAL) ? 'LOG_USER_INACTIVE' : 'LOG_USER_ACTIVE';
-	add_log('admin', $log, $username);
-
-	return false;
-}
-
-function user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason)
-{
-	global $_CLASS;
-
-	// Delete stale bans
-	$sql = &quot;DELETE FROM &quot; . BANLIST_TABLE . &quot;
-		WHERE ban_end &lt; &quot; . time() . &quot;
-			AND ban_end &lt;&gt; 0&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	$ban_list = (!is_array($ban)) ? array_unique(explode(&quot;\n&quot;, $ban)) : $ban;
-	$ban_list_log = implode(', ', $ban_list);
-
-	$current_time = time();
-
-	if ($ban_len)
-	{
-		if ($ban_len != -1 || !$ban_len_other)
-		{
-			$ban_end = max($current_time, $current_time + ($ban_len) * 60);
-		}
-		else
-		{
-			$ban_other = explode('-', $ban_len_other);
-			$ban_end = max($current_time, gmmktime(0, 0, 0, $ban_other[1], $ban_other[2], $ban_other[0]));
-		}
-	}
-	else
-	{
-		$ban_end = 0;
-	}
-
-	$banlist = array();
-
-	switch ($mode)
-	{
-		case 'user':
-			$type = 'ban_userid';
-
-			if (in_array('*', $ban_list))
-			{
-				$banlist[] = '*';
-			}
-			else
-			{
-				$sql = 'SELECT user_id
-					FROM ' . USERS_TABLE . '
-					WHERE username IN (' . implode(', ', array_diff(preg_replace('#^[\s]*(.*?)[\s]*$#', &quot;'\\1'&quot;, $ban_list), array(&quot;''&quot;))) . ')';
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					do
-					{
-						$banlist[] = $row['user_id'];
-					}
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-				}
-			}
-			break;
-
-		case 'ip':
-			$type = 'ban_ip';
-
-			foreach ($ban_list as $ban_item)
-			{
-				if (preg_match('#^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})[ ]*\-[ ]*([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$#', trim($ban_item), $ip_range_explode))
-				{
-					// Don't ask about all this, just don't ask ... !
-					$ip_1_counter = $ip_range_explode[1];
-					$ip_1_end = $ip_range_explode[5];
-
-					while ($ip_1_counter &lt;= $ip_1_end)
-					{
-						$ip_2_counter = ($ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[2] : 0;
-						$ip_2_end = ($ip_1_counter &lt; $ip_1_end) ? 254 : $ip_range_explode[6];
-
-						if($ip_2_counter == 0 &amp;&amp; $ip_2_end == 254)
-						{
-							$ip_2_counter = 256;
-							$ip_2_fragment = 256;
-
-							$banlist[] = &quot;'$ip_1_counter.*'&quot;;
-						}
-
-						while ($ip_2_counter &lt;= $ip_2_end)
-						{
-							$ip_3_counter = ($ip_2_counter == $ip_range_explode[2] &amp;&amp; $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[3] : 0;
-							$ip_3_end = ($ip_2_counter &lt; $ip_2_end || $ip_1_counter &lt; $ip_1_end) ? 254 : $ip_range_explode[7];
-
-							if ($ip_3_counter == 0 &amp;&amp; $ip_3_end == 254)
-							{
-								$ip_3_counter = 256;
-								$ip_3_fragment = 256;
-
-								$banlist[] = &quot;'$ip_1_counter.$ip_2_counter.*'&quot;;
-							}
-
-							while ($ip_3_counter &lt;= $ip_3_end)
-							{
-								$ip_4_counter = ($ip_3_counter == $ip_range_explode[3] &amp;&amp; $ip_2_counter == $ip_range_explode[2] &amp;&amp; $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[4] : 0;
-								$ip_4_end = ($ip_3_counter &lt; $ip_3_end || $ip_2_counter &lt; $ip_2_end) ? 254 : $ip_range_explode[8];
-
-								if ($ip_4_counter == 0 &amp;&amp; $ip_4_end == 254)
-								{
-									$ip_4_counter = 256;
-									$ip_4_fragment = 256;
-
-									$banlist[] = &quot;'$ip_1_counter.$ip_2_counter.$ip_3_counter.*'&quot;;
-								}
-
-								while ($ip_4_counter &lt;= $ip_4_end)
-								{
-									$banlist[] = &quot;'$ip_1_counter.$ip_2_counter.$ip_3_counter.$ip_4_counter'&quot;;
-									$ip_4_counter++;
-								}
-								$ip_3_counter++;
-							}
-							$ip_2_counter++;
-						}
-						$ip_1_counter++;
-					}
-				}
-				else if (preg_match('#^([\w\-_]\.?){2,}$#is', trim($ban_item)))
-				{
-					$ip_ary = gethostbynamel(trim($ban_item));
-
-					foreach ($ip_ary as $ip)
-					{
-						if (!empty($ip))
-						{
-							$banlist[] = &quot;'&quot; . $ip . &quot;'&quot;;
-						}
-					}
-				}
-				else if (preg_match('#^([0-9]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})$#', trim($ban_item)) || preg_match('#^[a-f0-9:]+\*?$#i', trim($ban_item)))
-				{
-					$banlist[] = &quot;'&quot; . trim($ban_item) . &quot;'&quot;;
-				}
-				else if (preg_match('#^\*$#', trim($ban_item)))
-				{
-					$banlist[] = &quot;'*'&quot;;
-				}
-			}
-			break;
-
-		case 'email':
-			$type = 'ban_email';
-
-			foreach ($ban_list as $ban_item)
-			{
-				if (preg_match('#^.*?@*|(([a-z0-9\-]+\.)+([a-z]{2,3}))$#i', trim($ban_item)))
-				{
-					$banlist[] = &quot;'&quot; . trim($ban_item) . &quot;'&quot;;
-				}
-			}
-			break;
-	}
-
-	$sql = &quot;SELECT $type
-		FROM &quot; . BANLIST_TABLE . &quot;
-		WHERE $type &lt;&gt; '' 
-			AND ban_exclude = $ban_exclude&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$banlist_tmp = array();
-		do
-		{
-			switch ($mode)
-			{
-				case 'user':
-					$banlist_tmp[] = $row['ban_userid'];
-					break;
-
-				case 'ip':
-					$banlist_tmp[] = &quot;'&quot; . $row['ban_ip'] . &quot;'&quot;;
-					break;
-
-				case 'email':
-					$banlist_tmp[] = &quot;'&quot; . $row['ban_email'] . &quot;'&quot;;
-					break;
-			}
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-		$banlist = array_unique(array_diff($banlist, $banlist_tmp));
-		unset($banlist_tmp);
-	}
-
-	if (sizeof($banlist))
-	{
-		$sql = '';
-		foreach ($banlist as $ban_entry)
-		{
-			switch (SQL_LAYER)
-			{
-				case 'mysql':
-					$sql .= (($sql != '') ? ', ' : '') . &quot;($ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason')&quot;;
-					break;
-					
-				case 'mysql4':
-				case 'mysqli':
-				case 'mssql':
-				case 'sqlite':
-					$sql .= (($sql != '') ? ' UNION ALL ' : '') . &quot; SELECT $ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason'&quot;;
-					break;
-
-				default:
-					$sql = 'INSERT INTO ' . BANLIST_TABLE . &quot; ($type, ban_start, ban_end, ban_exclude, ban_reason)
-						VALUES ($ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason')&quot;;
-					$_CLASS['core_db']-&gt;query($sql);
-			}
-		}
-
-		if ($sql)
-		{
-			$sql = 'INSERT INTO ' . BANLIST_TABLE . &quot; ($type, ban_start, ban_end, ban_exclude, ban_reason)
-				VALUES $sql&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		if (!$ban_exclude)
-		{
-			$sql = '';
-			switch ($mode)
-			{
-				case 'user':
-					$sql = 'WHERE session_user_id IN (' . implode(', ', $banlist) . ')';
-					break;
-
-				case 'ip':
-					$sql = 'WHERE session_ip IN (' . implode(', ', $banlist) . ')';
-					break;
-
-				case 'email':
-					$sql = 'SELECT user_id
-						FROM ' . USERS_TABLE . '
-						WHERE user_email IN (' . implode(', ', $banlist) . ')';
-					$result = $_CLASS['core_db']-&gt;query($sql);
-
-					$sql_in = array();
-					if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						do
-						{
-							$sql_in[] = $row['user_id'];
-						}
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-						$sql = 'WHERE session_user_id IN (' . str_replace('*', '%', implode(', ', $sql_in)) . &quot;)&quot;;
-					}
-					break;
-			}
-
-			if ($sql)
-			{
-				$sql = 'DELETE FROM ' . SESSIONS_TABLE . &quot;
-					$sql&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-		}
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		// Update log
-		$log_entry = ($ban_exclude) ? 'LOG_BAN_EXCLUDE_' : 'LOG_BAN_';
-		add_log('admin', $log_entry . strtoupper($mode), $ban_reason, $ban_list_log);
-	}
-
-	return false;
-}
-
-function user_unban($mode, $ban)
-{
-	global $_CLASS;
-
-	// Delete stale bans
-	$sql = &quot;DELETE FROM &quot; . BANLIST_TABLE . &quot;
-		WHERE ban_end &lt; &quot; . time() . &quot;
-			AND ban_end &lt;&gt; 0&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	$unban_sql = implode(', ', $ban);
-
-	if ($unban_sql)
-	{
-		$l_unban_list = '';
-		// Grab details of bans for logging information later
-		switch ($mode)
-		{
-			case 'user':
-				$sql = 'SELECT u.username AS unban_info
-					FROM ' . USERS_TABLE . ' u, ' . BANLIST_TABLE . &quot; b 
-					WHERE b.ban_id IN ($unban_sql) 
-						AND u.user_id = b.ban_userid&quot;;
-				break;
-
-			case 'email':
-				$sql = 'SELECT ban_email AS unban_info 
-					FROM ' . BANLIST_TABLE . &quot;
-					WHERE ban_id IN ($unban_sql)&quot;;
-				break;
-
-			case 'ip':
-				$sql = 'SELECT ban_ip AS unban_info 
-					FROM ' . BANLIST_TABLE . &quot;
-					WHERE ban_id IN ($unban_sql)&quot;;
-				break;
-		}
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$l_unban_list .= (($l_unban_list != '') ? ', ' : '') . $row['unban_info'];
-		}
-
-		$sql = 'DELETE FROM ' . BANLIST_TABLE . &quot;
-			WHERE ban_id IN ($unban_sql)&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		add_log('admin', 'LOG_UNBAN_' . strtoupper($mode), $l_unban_list);
-	}
-
-	return false;
-
-}
-
-// Whois facility
-function user_ipwhois($ip)
-{
-	$ipwhois = '';
-
-	$match = array(
-		'#RIPE\.NET#is'				=&gt; 'whois.ripe.net',
-		'#whois\.apnic\.net#is'		=&gt; 'whois.apnic.net',
-		'#nic\.ad\.jp#is'			=&gt; 'whois.nic.ad.jp',
-		'#whois\.registro\.br#is'	=&gt; 'whois.registro.br'
-	);
-
-	if (($fsk = @fsockopen('whois.arin.net', 43)))
-	{
-		fputs($fsk, &quot;$ip\n&quot;);
-		while (!feof($fsk))
-		{
-			$ipwhois .= fgets($fsk, 1024);
-		}
-		@fclose($fsk);
-	}
-
-	foreach (array_keys($match) as $server)
-	{
-		if (preg_match($server, $ipwhois))
-		{
-			$ipwhois = '';
-			if (($fsk = @fsockopen($match[$server], 43)))
-			{
-				fputs($fsk, &quot;$ip\n&quot;);
-				while (!feof($fsk))
-				{
-					$ipwhois .= fgets($fsk, 1024);
-				}
-				@fclose($fsk);
-			}
-			break;
-		}
-	}
-
-	return $ipwhois;
-}
-//
-// Data validation ... used primarily but not exclusively by
-// ucp modules
-//
-
-// &quot;Master&quot; function for validating a range of data types
-function validate_data($data, $val_ary)
-{
-	$error = array();
-
-	foreach ($val_ary as $var =&gt; $val_seq)
-	{
-		if (!is_array($val_seq[0]))
-		{
-			$val_seq = array($val_seq);
-		}
-
-		foreach ($val_seq as $validate)
-		{
-			$function = array_shift($validate);
-			array_unshift($validate, $data[$var]);
-
-			if ($result = call_user_func_array('validate_' . $function, $validate))
-			{
-				$error[] = $result . '_' . strtoupper($var);
-			}
-		}
-	}
-
-	return $error;
-}
-
-function validate_string($string, $optional = false, $min = 0, $max = 0)
-{
-	if (empty($string) &amp;&amp; $optional)
-	{
-		return false;
-	}
-
-	if ($min &amp;&amp; strlen($string) &lt; $min)
-	{
-		return 'TOO_SHORT';
-	}
-	else if ($max &amp;&amp; strlen($string) &gt; $max)
-	{
-		return 'TOO_LONG';
-	}
-
-	return false;
-}
-
-function validate_num($num, $optional = false, $min = 0, $max = 1E99)
-{
-	if (empty($num) &amp;&amp; $optional)
-	{
-		return false;
-	}
-
-	if ($num &lt; $min)
-	{
-		return 'TOO_SMALL';
-	}
-	else if ($num &gt; $max) 
-	{
-		return 'TOO_LARGE';
-	}
-
-	return false;
-}
-
-function validate_match($string, $optional = false, $match)
-{
-	if (empty($string) &amp;&amp; $optional)
-	{
-		return false;
-	}
-
-	if (!preg_match($match, $string))
-	{
-		return 'WRONG_DATA';
-	}
-	return false;
-}
-
-// Check to see if the username has been taken, or if it is disallowed.
-// Also checks if it includes the &quot; character, which we don't allow in usernames.
-// Used for registering, changing names, and posting anonymously with a username
-function validate_username($username)
-{
-	global $_CORE_CONFIG, $_CLASS;
-
-	if (strtolower($_CLASS['core_user']-&gt;data['username']) == strtolower($username))
-	{
-		return false;
-	}
-
-	if (!preg_match('#^' . str_replace('\\\\', '\\', $_CORE_CONFIG['user']['allow_name_chars']) . '$#i', $username))
-	{
-		return 'INVALID_CHARS';
-	}
-
-	$sql = 'SELECT username
-		FROM ' . USERS_TABLE . &quot;
-		WHERE LOWER(username) = '&quot; . strtolower($_CLASS['core_db']-&gt;escape($username)) . &quot;'&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		return 'USERNAME_TAKEN';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$sql = 'SELECT group_name
-		FROM ' . GROUPS_TABLE . &quot;
-		WHERE LOWER(group_name) = '&quot; . strtolower($_CLASS['core_db']-&gt;escape($username)) . &quot;'&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		return 'USERNAME_TAKEN';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$sql = 'SELECT disallow_username
-		FROM ' . DISALLOW_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (preg_match('#' . str_replace('*', '.*?', preg_quote($row['disallow_username'], '#')) . '#i', $username))
-		{
-			return 'USERNAME_DISALLOWED';
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$sql = 'SELECT word
-		FROM  ' . WORDS_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (preg_match('#(' . str_replace('\*', '.*?', preg_quote($row['word'], '#')) . ')#i', $username))
-		{
-			return 'USERNAME_DISALLOWED';
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	return false;
-}
-
-// TODO?
-// Ability to limit types of email address ... not by banning, seperate table
-// capability to require (or deny) use of certain addresses when user is
-// registering from certain IP's/hosts
-
-// Check to see if email address is banned or already present in the DB
-function validate_email($email)
-{
-	global $_CORE_CONFIG, $_CLASS;
-
-	if (strtolower($_CLASS['core_user']-&gt;data['user_email']) == strtolower($email))
-	{
-		return false;
-	}
-
-	if (!preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email))
-	{
-		return 'EMAIL_INVALID';
-	}
-
-	$sql = 'SELECT ban_email
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (preg_match('#^' . str_replace('*', '.*?', $row['ban_email']) . '$#i', $email))
-		{
-			return 'EMAIL_BANNED';
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if (!$_CORE_CONFIG['user']['allow_emailreuse'])
-	{
-		$sql = 'SELECT user_email_hash
-			FROM ' . USERS_TABLE . &quot;
-			WHERE user_email_hash = &quot; . crc32(strtolower($email)) . strlen($email);
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			return 'EMAIL_TAKEN';
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	return false;
-}
-
-//
-// Avatar functions
-//
-
-function avatar_delete($id)
-{
-	global $config, $_CORE_CONFIG;
-
-	if (file_exists($config['avatar_path'] . '/' . $id))
-	{
-		@unlink($config['avatar_path'] . '/' . $id);
-	}
-
-	return false;
- }
-
-function avatar_remote($data, &amp;$error)
-{
-	global $config, $_CLASS;
-
-	if (!preg_match('#^(http|https|ftp)://#i', $data['remotelink']))
-	{
-		$data['remotelink'] = '<A HREF="http://">http://</A>' . $data['remotelink'];
-	}
-
-	if (!preg_match('#^(http|https|ftp)://(.*?\.)*?[a-z0-9\-]+?\.[a-z]{2,4}:?([0-9]*?).*?\.(gif|jpg|jpeg|png)$#i', $data['remotelink']))
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['AVATAR_URL_INVALID'];
-		return false;
-	}
-
-	if ((!($data['width'] || $data['height']) || $data['remotelink'] != $_CLASS['core_user']-&gt;data['user_avatar']) &amp;&amp; ($config['avatar_max_width'] || $config['avatar_max_height']))
-	{
-		list($width, $height) = @getimagesize($data['remotelink']);
-
-		if (!$width || !$height)
-		{
-			$error[] = $_CLASS['core_user']-&gt;lang['AVATAR_NO_SIZE'];
-			return false;
-		}
-		else if ($width &gt; $config['avatar_max_width'] || $height &gt; $config['avatar_max_height'])
-		{
-			$error[] = sprintf($_CLASS['core_user']-&gt;lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
-			return false;
-		}
-	}
-	else if ($data['width'] &gt; $config['avatar_max_width'] || $data['height'] &gt; $config['avatar_max_height'])
-	{
-		$error[] = sprintf($_CLASS['core_user']-&gt;lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
-		return false;
-	}
-
-	return array(AVATAR_REMOTE, $data['remotelink'], $width, $height);
-}
-
-function avatar_upload($data, &amp;$error)
-{
-	global $site_file_root, $config, $_CLASS;
-
-	// Init upload class
-	include_once($site_file_root.'includes/forums/functions_upload.php');
-	
-	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
-							
-	if (!empty($_FILES['uploadfile']['name']))
-	{
-		$file = $upload-&gt;form_upload('uploadfile');
-	}
-	else
-	{
-		$file = $upload-&gt;remote_upload($data['uploadurl']);
-	}
-
-	$file-&gt;clean_filename('real', $_CLASS['core_user']-&gt;data['user_id'] . '_');
-	$file-&gt;move_file($config['avatar_path']);
-
-	if (sizeof($file-&gt;error))
-	{
-		$file-&gt;remove();
-		$error = array_merge($error, $file-&gt;error);
-	}
-	
-	return array(AVATAR_UPLOAD, $file-&gt;get('realname'), $file-&gt;get('width'), $file-&gt;get('height'));
-}
-
-//
-// Usergroup functions
-//
-
-// Add or edit a group. If we're editing a group we only update user
-// parameters such as rank, etc. if they are changed
-function group_create($group_id, $type, $name, $desc)
-{
-	global $config, $_CLASS, $file_upload;
-
-	$error = array();
-
-	// Check data
-	if (!strlen($name) || strlen($name) &gt; 40)
-	{
-		$error[] = (!strlen($name)) ? $_CLASS['core_user']-&gt;lang['GROUP_ERR_USERNAME'] : $_CLASS['core_user']-&gt;lang['GROUP_ERR_USER_LONG'];
-	}
-
-	if (strlen($desc) &gt; 255)
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['GROUP_ERR_DESC_LONG'];
-	}
-
-	if (!in_array($type, array(GROUP_OPEN, GROUP_CLOSED, GROUP_HIDDEN, GROUP_SPECIAL, GROUP_FREE)))
-	{
-		$error[] = $_CLASS['core_user']-&gt;lang['GROUP_ERR_TYPE'];
-	}
-
-	if (!sizeof($error))
-	{
-		$sql_ary = array(
-			'group_name'			=&gt; (string) $name,
-			'group_description'		=&gt; (string) $desc,
-			'group_type'			=&gt; (int) $type,
-		);
-
-		$attribute_ary = array('group_colour' =&gt; 'string', 'group_rank' =&gt; 'int', 'group_avatar' =&gt; 'string', 'group_avatar_type' =&gt; 'int', 'group_avatar_width' =&gt; 'int', 'group_avatar_height' =&gt; 'int', 'group_receive_pm' =&gt; 'int', 'group_message_limit' =&gt; 'int');
-
-		$i = 4;
-		foreach ($attribute_ary as $attribute =&gt; $type)
-		{
-			if (func_num_args() &gt; $i &amp;&amp; ($value = func_get_arg($i)) !== false)
-			{
-				settype($value, $type);
-
-				$sql_ary[$attribute] = $$attribute = $value;
-			}
-			$i++;
-		}
-		
-		$group_only_ary = array('group_receive_pm' =&gt; 'int', 'group_message_limit' =&gt; 'int');
-
-		foreach ($group_only_ary as $attribute =&gt; $type)
-		{
-			if (func_num_args() &gt; $i &amp;&amp; ($value = func_get_arg($i)) !== false)
-			{
-				settype($value, $type);
-
-				$sql_ary[$attribute] = $value;
-			}
-			$i++;
-		}
-		
-		$sql = ($group_id) ? 'UPDATE ' . GROUPS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . &quot;	WHERE group_id = $group_id&quot; : 'INSERT INTO ' . GROUPS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$sql_ary = array();
-		foreach ($attribute_ary as $attribute =&gt; $type)
-		{
-			if (isset($$attribute))
-			{
-				$sql_ary[str_replace('group', 'user', $attribute)] = $$attribute;
-			}
-		}
-
-		if (sizeof($sql_ary))
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . &quot;
-				WHERE group_id = $group_id&quot;;
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		$log = ($group_id) ? 'LOG_GROUP_UPDATED' : 'LOG_GROUP_CREATED';
-		add_log('admin', $log, $name);
-	}
-
-	return (sizeof($error)) ? $error : false;
-}
-
-function group_delete($group_id, $group_name = false)
-{
-	global $_CLASS;
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . &quot; 
-			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error(&quot;Could not obtain name of group $group_id&quot;, E_USER_ERROR);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	$start = 0;
-
-	do
-	{
-		$user_id_ary = $username_ary = array();
-
-		// Batch query for group members, call group_user_del
-		$sql = 'SELECT u.user_id, u.username
-			FROM ' . USER_GROUP_TABLE . ' ug, ' . USERS_TABLE . &quot; u
-			WHERE ug.group_id = $group_id
-				AND u.user_id = ug.user_id 
-			LIMIT $start, 200&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			do
-			{
-				$user_id_ary[] = $row['user_id'];
-				$username_ary[] = $row['username'];
-
-				$start++;
-			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-			group_user_del($group_id, $user_id_ary, $username_ary, $group_name);
-		}
-		else
-		{
-			$start = 0;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-	while ($start);
-	
-	// Delete group
-	$sql = 'DELETE FROM ' . GROUPS_TABLE . &quot; 
-		WHERE group_id = $group_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	add_log('admin', 'LOG_GROUP_DELETE', $group_name);
-
-	return false;
-}
-
-function group_user_add($group_id, $user_id_ary = false, $username_ary = false, $group_name = false, $default = false, $leader = 0)
-{
-	global $_CLASS;
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	// Remove users who are already members of this group
-	$sql = 'SELECT user_id, group_leader  
-		FROM ' . USER_GROUP_TABLE . '   
-		WHERE user_id IN (' . implode(', ', $user_id_ary) . &quot;) 
-			AND group_id = $group_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$add_id_ary = $update_id_ary = array();
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		do
-		{
-			$add_id_ary[] = $row['user_id'];
-
-			if ($leader &amp;&amp; !$row['group_leader'])
-			{
-				$update_id_ary[] = $row['user_id'];
-			}
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	// Do all the users exist in this group?
-	$add_id_ary = array_diff($user_id_ary, $add_id_ary);
-	unset($id_ary);
-
-	// If we have no users 
-	if (!sizeof($add_id_ary) &amp;&amp; !sizeof($update_id_ary))
-	{
-		return 'GROUP_USERS_EXIST';
-	}
-
-	if (sizeof($add_id_ary))
-	{
-		// Insert the new users 
-		switch (SQL_LAYER)
-		{
-			case 'mysql':
-			case 'mysql4':
-			case 'mysqli':
-			case 'mssql':
-			case 'sqlite':
-
-				$sql = 'INSERT INTO ' . USER_GROUP_TABLE . &quot; (user_id, group_id, group_leader) 
-					VALUES &quot; . implode(', ', preg_replace('#^([0-9]+)$#', &quot;(\\1, $group_id, $leader)&quot;,  $add_id_ary));
-				$_CLASS['core_db']-&gt;query($sql);
-				break;
-			
-			default:
-				foreach ($add_id_ary as $user_id)
-				{
-					$sql = 'INSERT INTO ' . USER_GROUP_TABLE . &quot; (user_id, group_id, group_leader)
-						VALUES ($user_id, $group_id, $leader)&quot;;
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-				break;
-		}
-	}
-
-	$usernames = array();
-	if (sizeof($update_id_ary))
-	{
-		$sql = 'UPDATE ' . USER_GROUP_TABLE . ' 
-			SET group_leader = 1 
-			WHERE user_id IN (' . implode(', ', $update_id_ary) . &quot;)
-				AND group_id = $group_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		foreach ($update_id_ary as $id)
-		{
-			$usernames[] = $username_ary[$id];
-		}
-	}
-	else
-	{
-		foreach ($add_id_ary as $id)
-		{
-			$usernames[] = $username_ary[$id];
-		}
-	}
-
-	if ($default)
-	{
-		$attribute_ary = array('group_colour' =&gt; 'string', 'group_rank' =&gt; 'int', 'group_avatar' =&gt; 'string', 'group_avatar_type' =&gt; 'int', 'group_avatar_width' =&gt; 'int', 'group_avatar_height' =&gt; 'int');
-	
-		// Were group attributes passed to the function? If not we need to obtain them
-		if (func_num_args() &gt; 6)
-		{
-			$i = 6;
-			foreach ($attribute_ary as $attribute =&gt; $type)
-			{
-				if (func_num_args() &gt; $i &amp;&amp; ($value = func_get_arg($i)) !== false)
-				{
-					settype($value, $type);
-
-					$sql_ary[$attribute] = $$attribute = $value;
-				}
-				$i++;
-			}
-		}
-		else
-		{
-			$sql = 'SELECT group_colour, group_rank, group_avatar, group_avatar_type, group_avatar_width, group_avatar_height  
-				FROM ' . GROUPS_TABLE . &quot; 
-				WHERE group_id = $group_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-			{
-				trigger_error(&quot;Could not obtain group attributes for group_id $group_id&quot;, E_USER_ERROR);
-			}
-
-			if (!$group_avatar_width)
-			{
-				unset($group_avatar_width);
-			}
-			if (!$group_avatar_height)
-			{
-				unset($group_avatar_height);
-			}
-		}
-
-		$sql_set = '';
-		foreach ($attribute_ary as $attribute =&gt; $type)
-		{
-			if (isset($$attribute))
-			{
-				$field = str_replace('group_', 'user_', $attribute);
-
-				switch ($type)
-				{
-					case 'int':
-						$sql_set .= &quot;, $field = &quot; . (int) $$attribute;
-						break;
-					case 'double':
-						$sql_set .= &quot;, $field = &quot; . (double) $$attribute;
-						break;
-					case 'string':
-						$sql_set .= &quot;, $field = '&quot; . (string) $_CLASS['core_db']-&gt;escape($$attribute) . &quot;'&quot;;
-						break;
-				}
-			}
-		}
-
-		$sql = 'UPDATE ' . USERS_TABLE . &quot;
-			SET group_id = $group_id$sql_set  
-			WHERE user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']-&gt;acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . &quot; 
-			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error(&quot;Could not obtain name of group $group_id&quot;, E_USER_ERROR);
-		}
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	$log = ($leader) ? 'LOG_MODS_ADDED' : 'LOG_USERS_ADDED';
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-// Remove a user/s from a given group. When we remove users we update their
-// default group_id. We do this by examining which &quot;special&quot; groups they belong
-// to. The selection is made based on a reasonable priority system
-function group_user_del($group_id, $user_id_ary = false, $username_ary = false, $group_name = false)
-{
-	global $_CLASS;
-
-	$group_order = array('ADMINISTRATORS', 'SUPER_MODERATORS', 'REGISTERED_COPPA', 'REGISTERED', 'BOTS', 'GUESTS');
-
-	$attribute_ary = array('group_colour' =&gt; 'string', 'group_rank' =&gt; 'int', 'group_avatar' =&gt; 'string', 'group_avatar_type' =&gt; 'int', 'group_avatar_width' =&gt; 'int', 'group_avatar_height' =&gt; 'int');
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	$sql = 'SELECT * 
-		FROM ' . GROUPS_TABLE . ' 
-		WHERE group_name IN (' . implode(', ', preg_replace('#^(.*)$#', &quot;'\\1'&quot;, $group_order)) . ')';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$group_order_id = $special_group_data = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$group_order_id[$row['group_name']] = $row['group_id'];
-
-		$special_group_data[$row['group_id']]['group_colour']			= $row['group_colour'];
-		$special_group_data[$row['group_id']]['group_rank']				= $row['group_rank'];
-		$special_group_data[$row['group_id']]['group_avatar']			= $row['group_avatar'];
-		$special_group_data[$row['group_id']]['group_avatar_type']		= $row['group_avatar_type'];
-		$special_group_data[$row['group_id']]['group_avatar_width']		= $row['group_avatar_width'];
-		$special_group_data[$row['group_id']]['group_avatar_height']	= $row['group_avatar_height'];
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	// What special group memberships exist for these users?
-	$sql = 'SELECT g.group_id, g.group_name, ug.user_id 
-		FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . ' g 
-		WHERE ug.user_id IN (' . implode(', ', $user_id_ary) . &quot;) 
-			AND g.group_id = ug.group_id
-			AND g.group_id &lt;&gt; $group_id 
-			AND g.group_type = &quot; . GROUP_SPECIAL . '
-		ORDER BY ug.user_id, g.group_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$temp_ary = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (!isset($temp_ary[$row['user_id']]) || array_search($row['group_name'], $group_order) &lt; $temp_ary[$row['user_id']])
-		{
-			$temp_ary[$row['user_id']] = $row['group_id'];
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	$sql_where_ary = array();
-	foreach ($temp_ary as $uid =&gt; $gid)
-	{
-		$sql_where_ary[$gid][] = $uid;
-	}
-	unset($temp_ary);
-
-	foreach ($special_group_data as $gid =&gt; $default_data_ary)
-	{
-		if ($sql_where = implode(', ', $sql_where_ary[$gid]))
-		{
-			$sql_set = '';
-			foreach ($special_group_data[$gid] as $attribute =&gt; $value)
-			{
-				$field = str_replace('group_', 'user_', $attribute);
-
-				switch ($attribute_ary[$attribute])
-				{
-					case 'int':
-						$sql_set .= &quot;, $field = &quot; . (int) $value;
-						break;
-					case 'double':
-						$sql_set .= &quot;, $field = &quot; . (double) $value;
-						break;
-					case 'string':
-						$sql_set .= &quot;, $field = '&quot; . $_CLASS['core_db']-&gt;escape($value) . &quot;'&quot;;
-						break;
-				}
-			}
-
-			// Set new default
-			$sql = 'UPDATE ' . USERS_TABLE . &quot; 
-				SET group_id = $gid$sql_set 
-				WHERE user_id IN (&quot; . implode(', ', $sql_where_ary[$gid]) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-	}
-	unset($special_group_data);
-
-	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . &quot; 
-		WHERE group_id = $group_id
-			AND user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-	$_CLASS['core_db']-&gt;query($sql);
-	unset($default_ary);
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']-&gt;acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . &quot; 
-			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error(&quot;Could not obtain name of group $group_id&quot;, E_USER_ERROR);
-		}
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	$log = 'LOG_GROUP_REMOVE';
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-// This is used to promote (to leader), demote or set as default a member/s
-function group_user_attributes($action, $group_id, $user_id_ary = false, $username_ary = false, $group_name = false)
-{
-	global $_CLASS;
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	switch ($action)
-	{
-		case 'demote':
-		case 'promote':
-			$sql = 'UPDATE ' . USER_GROUP_TABLE . '
-				SET group_leader = ' . (($action == 'promote') ? 1 : 0) . &quot;  
-				WHERE group_id = $group_id
-					AND user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$log = ($action == 'promote') ? 'LOG_GROUP_PROMOTED' : 'LOG_GROUP_DEMOTED';
-			break;
-
-		case 'approve':
-			$sql = 'UPDATE ' . USER_GROUP_TABLE . &quot; 
-				SET user_pending = 0 
-				WHERE group_id = $group_id 
-					AND user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$log = 'LOG_GROUP_APPROVE';
-			break;
-
-		case 'default':
-			$attribute_ary = array('group_colour' =&gt; 'string', 'group_rank' =&gt; 'int', 'group_avatar' =&gt; 'string', 'group_avatar_type' =&gt; 'int', 'group_avatar_width' =&gt; 'int', 'group_avatar_height' =&gt; 'int');
-
-			// Were group attributes passed to the function? If not we need
-			// to obtain them
-			if (func_num_args() &gt; 5)
-			{
-				$i = 5;
-				foreach ($attribute_ary as $attribute =&gt; $type)
-				{
-					if (func_num_args() &gt; $i &amp;&amp; ($value = func_get_arg($i)) !== false)
-					{
-						settype($value, $type);
-
-						$sql_ary[$attribute] = $$attribute = $value;
-					}
-					$i++;
-				}
-			}
-			else
-			{
-				$sql = 'SELECT group_colour, group_rank, group_avatar, group_avatar_type, group_avatar_width, group_avatar_height 
-					FROM ' . GROUPS_TABLE . &quot; 
-					WHERE group_id = $group_id&quot;;
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-				{
-					return 'NO_GROUP';
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				if (!$group_avatar_width)
-				{
-					unset($group_avatar_width);
-				}
-				if (!$group_avatar_height)
-				{
-					unset($group_avatar_height);
-				}
-			}
-
-			// FAILURE HERE when grabbing data from DB and checking &quot;isset&quot; ... will
-			// be true for all similar functionality
-
-			$sql_set = '';
-			foreach ($attribute_ary as $attribute =&gt; $type)
-			{
-				if (isset($$attribute))
-				{
-					$field = str_replace('group_', 'user_', $attribute);
-
-					switch ($type)
-					{
-						case 'int':
-							$sql_set .= &quot;, $field = &quot; . (int) $$attribute;
-							break;
-						case 'double':
-							$sql_set .= &quot;, $field = &quot; . (double) $$attribute;
-							break;
-						case 'string':
-							$sql_set .= &quot;, $field = '&quot; . (string) $_CLASS['core_db']-&gt;escape($$attribute) . &quot;'&quot;;
-							break;
-					}
-				}
-			}
-
-			$sql = 'UPDATE ' . USERS_TABLE . &quot;
-				SET group_id = $group_id$sql_set  
-				WHERE user_id IN (&quot; . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$log = 'LOG_GROUP_DEFAULTS';
-			break;
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']-&gt;acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . &quot; 
-			WHERE group_id = $group_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!extract($_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error(&quot;Could not obtain name of group $group_id&quot;, E_USER_ERROR);
-		}
-	}
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-/**
-* Obtain either the members of a specified group, the groups the specified user is subscribed to
-* or checking if a specified user is in a specified group
-*
-* Note: Extend select statement as needed
-* Note2: Never use this more than once... first group your users/groups
-*/
-function group_memberships($group_id_ary = false, $user_id_ary = false, $return_bool = false)
-{
-	global $_CLASS;
-
-	if (!$group_id_ary &amp;&amp; !$user_id_ary)
-	{
-		return true;
-	}
-
-	$sql = 'SELECT group_id, user_id, user_status
-		FROM ' . USER_GROUP_TABLE . '
-		WHERE ';
-
-	if ($group_id_ary &amp;&amp; $user_id_ary)
-	{
-		$sql .= &quot; group_id &quot; . ((is_array($group_id_ary)) ? ' IN (' . implode(', ', $group_id_ary) . ')' : &quot; = $group_id_ary&quot;) . &quot;
-				AND user_id &quot; . ((is_array($user_id_ary)) ? ' IN (' . implode(', ', $user_id_ary) . ')' : &quot; = $user_id_ary&quot;);
-	}
-	else if ($group_id)
-	{
-		$sql .= &quot; group_id &quot; . ((is_array($group_id_ary)) ? ' IN (' . implode(', ', $group_id_ary) . ')' : &quot; = $group_id_ary&quot;);
-	}
-	else if ($user_id_ary)
-	{
-		$sql .= &quot; user_id &quot; . ((is_array($user_id_ary)) ? ' IN (' . implode(', ', $user_id_ary) . ')' : &quot; = $user_id_ary&quot;);
-	}
-	
-	$result = ($return_bool) ? $_CLASS['core_db']-&gt;query_limit($sql, 1) : $_CLASS['core_db']-&gt;query($sql);
-	
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-
-	if ($return_bool)
-	{
-		$_CLASS['core_db']-&gt;free_result($result);
-		return ($row) ? true : false;
-	}
-
-	$result = array();
-
-	do
-	{
-		$result[] = $row;
-	}
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	
-	return $result;
-}
-
-?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/forums/message_parser.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -367,17 +367,11 @@
 		// We remove the hardcoded elements from the code block here because it is not used in code blocks
 		// Having it here saves us one preg_replace per message containing [code] blocks
 		// Additionally, magic url parsing should go after parsing bbcodes, but for safety those are stripped out too...
-		$htm_match = array(
-			'#&lt;!\-\- e \-\-&gt;&lt;a href=&quot;mailto:(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- e \-\-&gt;#',
-			'#&lt;!\-\- m \-\-&gt;&lt;a href=&quot;(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- m \-\-&gt;#',
-			'#&lt;!\-\- w \-\-&gt;&lt;a href=&quot;http:\/\/(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- w \-\-&gt;#',
-			'#&lt;!\-\- l \-\-&gt;&lt;a href=&quot;(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- l \-\-&gt;#',
-			'#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#',
-			'#&lt;!\-\- h \-\-&gt;&lt;(.*?)&gt;&lt;!\-\- h \-\-&gt;#',
-			'#&amp;\#([0-9]+);#',
-		);
-		$htm_replace = array('\1', '\1', '\1', '\1', '\1', '&lt;\1&gt;', '&amp;#\1;');
+		$htm_match = get_preg_expression('bbcode_htm');
+		$htm_match[3] = '#&amp;\#([0-9]+);#';
+		Unset($htm_match[4]);
 
+		$htm_replace = array('\1', '\2', '\1', '&amp;#\1;');
 		$out = '';
 
 		do
@@ -512,8 +506,9 @@
 
 		do
 		{
-			$pos = strlen($in);
-			for ($i = 0; $i &lt; strlen($tok); ++$i)
+			$pos = strlen($in);
+			$tok_len = strlen($tok);
+			for ($i = 0; $i &lt; $tok_len; ++$i)
 			{
 				$tmp_pos = strpos($in, $tok{$i});
 
@@ -531,7 +526,7 @@
 			if ($tok == ']')
 			{
 				// if $tok is ']' the buffer holds a tag
-				if ($buffer == '/list' &amp;&amp; sizeof($list_end_tags))
+				if (strtolower($buffer) == '/list' &amp;&amp; sizeof($list_end_tags))
 				{
 					$out .= array_pop($list_end_tags) . ']';
 					$tok = '[';
@@ -546,7 +541,13 @@
 					else
 					{
 						array_push($list_end_tags, '/list:o:' . $this-&gt;bbcode_uid);
-					}
+					}
+
+					if (strtolower(substr($buffer, 0, 4)) == 'list')
+					{
+						$buffer = 'list' . substr($buffer, 4, $pos);
+					}
+					
 					$out .= $buffer . ':' . $this-&gt;bbcode_uid . ']';
 					$tok = '[';
 				}
@@ -862,6 +863,7 @@
 	var $allow_img_bbcode = true;
 	var $allow_flash_bbcode = true;
 	var $allow_quote_bbcode = true;
+	var $allow_url_bbcode = true;
 
 	var $mode;
 
@@ -882,7 +884,7 @@
 	/**
 	* Parse Message
 	*/
-	function parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $allow_img_bbcode = true, $allow_flash_bbcode = true, $allow_quote_bbcode = true, $update_this_message = true, $mode = 'post')
+	function parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $allow_img_bbcode = true, $allow_flash_bbcode = true, $allow_quote_bbcode = true, $allow_url_bbcode = true, $update_this_message = true, $mode = 'post')
 	{
 		global $config, $_CLASS;
 		
@@ -893,6 +895,7 @@
 		$this-&gt;allow_img_bbcode = $allow_img_bbcode;
 		$this-&gt;allow_flash_bbcode = $allow_flash_bbcode;
 		$this-&gt;allow_quote_bbcode = $allow_quote_bbcode;
+		$this-&gt;allow_url_bbcode = $allow_url_bbcode;
 
 		// If false, then $this-&gt;message won't be altered, the text will be returned instead.
 		if (!$update_this_message)
@@ -935,7 +938,7 @@
 		if ($allow_bbcode &amp;&amp; strpos($this-&gt;message, '[') !== false)
 		{
 			$this-&gt;bbcode_init();
-			$disallow = array('img', 'flash', 'quote');
+			$disallow = array('img', 'flash', 'quote', 'url');
 			foreach ($disallow as $bool)
 			{
 				if (!${'allow_' . $bool . '_bbcode'})
@@ -1007,7 +1010,7 @@
 		if ($this-&gt;message_status === 'plain')
 		{
 			// Force updating message - of course.
-			$this-&gt;parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $this-&gt;allow_img_bbcode, $this-&gt;allow_flash_bbcode, $this-&gt;allow_quote_bbcode, true);
+			$this-&gt;parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $this-&gt;allow_img_bbcode, $this-&gt;allow_flash_bbcode, $this-&gt;allow_quote_bbcode, $this-&gt;allow_url_bbcode, true);
 		}
 
 		// Parse BBcode
@@ -1102,7 +1105,7 @@
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$smiley['match'][] = '#(?&lt;=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
-				$smiley['replace'][] = '&lt;!-- s' . $row['smiley_code'] . ' --&gt;&lt;img src=&quot;{SMILIES_PATH}/' . $row['smiley_src'] . '&quot; border=&quot;0&quot; alt=&quot;' . $row['smiley_description'] . '&quot; title=&quot;' . $row['smiley_description'] . '&quot; /&gt;&lt;!-- s' . $row['smiley_code'] . ' --&gt;';
+				$smiley['replace'][] = '&lt;!-- s' . $row['smiley_code'] . ' --&gt;&lt;img src=&quot;{SMILIES_PATH}/' . $row['smiley_src'] . '&quot; alt=&quot;' . $row['smiley_description'] . '&quot; title=&quot;' . $row['smiley_description'] . '&quot; /&gt;&lt;!-- s' . $row['smiley_code'] . ' --&gt;';
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
 
@@ -1157,18 +1160,30 @@
 
 				if ($filedata['post_attach'] &amp;&amp; empty($error))
 				{
-					$new_entry = array(
-						'physical_filename'	=&gt; $filedata['physical_filename'],
-						'comment'			=&gt; $this-&gt;filename_data['filecomment'],
-						'real_filename'		=&gt; $filedata['real_filename'],
-						'extension'			=&gt; $filedata['extension'],
-						'mimetype'			=&gt; $filedata['mimetype'],
-						'filesize'			=&gt; $filedata['filesize'],
-						'filetime'			=&gt; $filedata['filetime'],
-						'attach_id'			=&gt; 0,
-						'thumbnail'			=&gt; $filedata['thumbnail']
+					$sql_insert_ary = array(
+						'physical_filename'	=&gt; $filedata['physical_filename'],
+						'attach_comment'	=&gt; $this-&gt;filename_data['filecomment'],
+						'real_filename'		=&gt; $filedata['real_filename'],
+						'extension'			=&gt; $filedata['extension'],
+						'mimetype'			=&gt; $filedata['mimetype'],
+						'filesize'			=&gt; $filedata['filesize'],
+						'filetime'			=&gt; $filedata['filetime'],
+						'thumbnail'			=&gt; $filedata['thumbnail'],
+						'is_orphan'			=&gt; 1,
+						'in_message'		=&gt; ($is_message) ? 1 : 0,
+						'poster_id'			=&gt; $user-&gt;data['user_id'],
 					);
 
+					$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_insert_ary, FORUMS_ATTACHMENTS_TABLE);
+					unset($sql_insert_ary);
+
+					$new_entry = array(
+						'attach_id'		=&gt; $_CLASS['core_db']-&gt;insert_id(FORUMS_ATTACHMENTS_TABLE, 'attach_id'),
+						'is_orphan'		=&gt; 1,
+						'real_filename'	=&gt; $filedata['real_filename'],
+						'attach_comment'=&gt; $this-&gt;filename_data['filecomment'],
+					);
+
 					$this-&gt;attachment_data = array_merge(array(0 =&gt; $new_entry), $this-&gt;attachment_data);
 					$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;'[attachment='.(\\1 + 1).']\\2[/attachment]'&quot;, $this-&gt;message);
 
@@ -1198,26 +1213,43 @@
 			{
 				$index = (int) key($_POST['delete_file']);
 
-				// delete selected attachment
-				if (!$this-&gt;attachment_data[$index]['attach_id'])
+				if (!empty($this-&gt;attachment_data[$index]))
 				{
-					phpbb_unlink($this-&gt;attachment_data[$index]['physical_filename'], 'file');
-
-					if ($this-&gt;attachment_data[$index]['thumbnail'])
-					{
-						phpbb_unlink($this-&gt;attachment_data[$index]['physical_filename'], 'thumbnail');
+					// delete selected attachment
+					if ($this-&gt;attachment_data[$index]['is_orphan'])
+					{
+						$sql = 'SELECT attach_id, physical_filename, thumbnail
+							FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+							WHERE attach_id = ' . (int) $this-&gt;attachment_data[$index]['attach_id'] . '
+								AND is_orphan = 1
+								AND poster_id = ' . $user-&gt;data['user_id'];
+						$result = $_CLASS['core_db']-&gt;query($sql);
+						$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+						$_CLASS['core_db']-&gt;free_result($result);
+
+						if ($row)
+						{
+							phpbb_unlink($row['physical_filename'], 'file');
+
+							if ($row['thumbnail'])
+							{
+								phpbb_unlink($row['physical_filename'], 'thumbnail');
+							}
+
+							$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' WHERE attach_id = ' . (int) $this-&gt;attachment_data[$index]['attach_id']);
+						}
+					}
+					else
+					{
+						delete_attachments('attach', array(intval($this-&gt;attachment_data[$index]['attach_id'])));
 					}
+					
+					unset($this-&gt;attachment_data[$index]);
+					$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;(\\1 == \$index) ? '' : ((\\1 &gt; \$index) ? '[attachment=' . (\\1 - 1) . ']\\2[/attachment]' : '\\0')&quot;, $this-&gt;message);
+	
+					// Reindex Array
+					$this-&gt;attachment_data = array_values($this-&gt;attachment_data);
 				}
-				else
-				{
-					delete_attachments('attach', array(intval($this-&gt;attachment_data[$index]['attach_id'])));
-				}
-				
-				unset($this-&gt;attachment_data[$index]);
-				$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;(\\1 == \$index) ? '' : ((\\1 &gt; \$index) ? '[attachment=' . (\\1 - 1) . ']\\2[/attachment]' : '\\0')&quot;, $this-&gt;message);
-
-				// Reindex Array
-				$this-&gt;attachment_data = array_values($this-&gt;attachment_data);
 			}
 			else if ($edit_comment || $add_file || $preview)
 			{
@@ -1240,18 +1272,30 @@
 
 						if (!sizeof($error))
 						{
-							$new_entry = array(
-								'physical_filename'	=&gt; $filedata['physical_filename'],
-								'comment'			=&gt; $this-&gt;filename_data['filecomment'],
-								'real_filename'		=&gt; $filedata['real_filename'],
-								'extension'			=&gt; $filedata['extension'],
-								'mimetype'			=&gt; $filedata['mimetype'],
-								'filesize'			=&gt; $filedata['filesize'],
-								'filetime'			=&gt; $filedata['filetime'],
-								'attach_id'			=&gt; 0,
-								'thumbnail'			=&gt; $filedata['thumbnail']
+							$sql_ary = array(
+								'physical_filename'	=&gt; $filedata['physical_filename'],
+								'attach_comment'	=&gt; $this-&gt;filename_data['filecomment'],
+								'real_filename'		=&gt; $filedata['real_filename'],
+								'extension'			=&gt; $filedata['extension'],
+								'mimetype'			=&gt; $filedata['mimetype'],
+								'filesize'			=&gt; $filedata['filesize'],
+								'filetime'			=&gt; $filedata['filetime'],
+								'thumbnail'			=&gt; $filedata['thumbnail'],
+								'is_orphan'			=&gt; 1,
+								'in_message'		=&gt; ($is_message) ? 1 : 0,
+								'poster_id'			=&gt; $user-&gt;data['user_id'],
 							);
 
+							$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_insert_ary, FORUMS_ATTACHMENTS_TABLE);
+							unset($sql_insert_ary);
+
+							$new_entry = array(
+								'attach_id'		=&gt; $_CLASS['core_db']-&gt;insert_id(FORUMS_ATTACHMENTS_TABLE, 'attach_id'),
+								'is_orphan'		=&gt; 1,
+								'real_filename'	=&gt; $filedata['real_filename'],
+								'attach_comment'=&gt; $this-&gt;filename_data['filecomment'],
+							);
+
 							$this-&gt;attachment_data = array_merge(array(0 =&gt; $new_entry), $this-&gt;attachment_data);
 							$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;'[attachment='.(\\1 + 1).']\\2[/attachment]'&quot;, $this-&gt;message);
 							$this-&gt;filename_data['filecomment'] = '';
@@ -1279,101 +1323,85 @@
 		global $_CLASS, $config;
 
 		$this-&gt;filename_data['filecomment'] = request_var('filecomment', '', true);
-		$this-&gt;attachment_data = isset($_POST['attachment_data']) ? $_POST['attachment_data'] : array();
+		$attachment_data = (isset($_POST['attachment_data'])) ? $_POST['attachment_data'] : array();
 
+		if (empty($attachment_data))
+		{
+			return;
+		}
+
 		$check_user_id = ($check_user_id === false) ? $_CLASS['core_user']-&gt;data['user_id'] : $check_user_id;
-
-		// Regenerate data array...
-		$attach_ids = $filenames = array();
+		$not_orphan = $orphan = array();
 
-		foreach ($this-&gt;attachment_data as $pos =&gt; $var_ary)
+		foreach ($attachment_data as $pos =&gt; $var_ary)
 		{
-			if ($var_ary['attach_id'])
+			if ($var_ary['is_orphan'])
 			{
-				$attach_ids[$this-&gt;attachment_data[$pos]['attach_id']] = $pos;
+				$orphan[(int) $var_ary['attach_id']] = $pos;
 			}
 			else
 			{
-				$filenames[$pos] = '';
-				set_var($filenames[$pos], $this-&gt;attachment_data[$pos]['physical_filename'], 'string');
-				$filenames[$pos] = basename($filenames[$pos]);
+				$not_orphan[(int) $var_ary['attach_id']] = $pos;
 			}
 		}
 
 		$this-&gt;attachment_data = array();
 
 		// Regenerate already posted attachments...
-		if (!empty($attach_ids))
+		if (!empty($not_orphan))
 		{
 			// Get the data from the attachments
-			$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment
 				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
-				WHERE attach_id IN (' . implode(', ', array_unique(array_map('intval', array_keys($attach_ids)))) . ')
+				WHERE attach_id IN (' . implode(', ', array_keys($not_orphan)) . ')
 					AND poster_id = ' . $check_user_id;
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				if (isset($attach_ids[$row['attach_id']]))
-				{
-					$pos = $attach_ids[$row['attach_id']];
-					$this-&gt;attachment_data[$pos] = $row;
-					set_var($this-&gt;attachment_data[$pos]['comment'], $_POST['attachment_data'][$pos]['comment'], 'string', true);
+				$pos = $not_orphan[$row['attach_id']];
+				$this-&gt;attachment_data[$pos] = $row;
+				set_var($this-&gt;attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
 
-					unset($attach_ids[$row['attach_id']]);
-				}
+				unset($not_orphan[$row['attach_id']]);
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
+		}
 
-			if (!empty($attach_ids))
-			{
-				trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
-			}
+		if (!empty($not_orphan))
+		{
+			trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
 		}
 
 		// Regenerate newly uploaded attachments
-		if (sizeof($filenames))
+		if (!empty($orphan))
 		{
-			require_once SITE_FILE_ROOT.'includes/forums/functions_upload.php';
+			$sql = 'SELECT attach_id, is_orphan, real_filename, attach_comment
+				FROM ' . ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', array_keys($orphan)) . ')
+					AND poster_id = ' . $user-&gt;data['user_id'] . '
+					AND is_orphan = 1';
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
-			$sql = 'SELECT attach_id
-				FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
-				WHERE LOWER(physical_filename) IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array(array_map('strtolower', $filenames))) . &quot;')&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if ($row)
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
-			}
+				$pos = $orphan[$row['attach_id']];
+				$this-&gt;attachment_data[$pos] = $row;
+				set_var($this-&gt;attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
 
-			foreach ($filenames as $pos =&gt; $physical_filename)
-			{
-				$this-&gt;attachment_data[$pos] = array(
-					'physical_filename'	=&gt; $physical_filename,
-					'extension'			=&gt; strtolower(filespec::get_extension(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename)),
-					'filesize'			=&gt; filespec::get_filesize(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename),
-					'attach_id'			=&gt; 0,
-					'thumbnail'			=&gt; (file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/thumb_' . $physical_filename)) ? 1 : 0,
-				);
-
-				set_var($this-&gt;attachment_data[$pos]['comment'], $_POST['attachment_data'][$pos]['comment'], 'string', true);
-				set_var($this-&gt;attachment_data[$pos]['real_filename'], $_POST['attachment_data'][$pos]['real_filename'], 'string', true);
-				set_var($this-&gt;attachment_data[$pos]['filetime'], $_POST['attachment_data'][$pos]['filetime'], 'int');
-
-				if (strpos($_POST['attachment_data'][$pos]['mimetype'], 'image/') !== false)
-				{
-					set_var($this-&gt;attachment_data[$pos]['mimetype'], $_POST['attachment_data'][$pos]['mimetype'], 'string');
-				}
-				else
-				{
-					$this-&gt;attachment_data[$pos]['mimetype'] = filespec::get_mimetype(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename);
-				}
+				unset($orphan[$row['attach_id']]);
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 		}
+
+		if (!empty($orphan))
+		{
+			trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
+		}
+
+		ksort($this-&gt;attachment_data);
 	}
-	
+
 	/**
 	* Parse Poll
 	*/
@@ -1386,11 +1414,10 @@
 		// Parse Poll Option text ;)
 		$tmp_message = $this-&gt;message;
 		$this-&gt;message = $poll['poll_option_text'];
+
 
+		$poll['poll_option_text'] = $this-&gt;parse(false, $poll['enable_bbcode'], ($config['allow_post_links']) ? $poll['enable_urls'] : false, $poll['enable_smilies'], $poll['img_status'], false, false, $config['allow_post_links'], false);
 
-		$poll['poll_option_text'] = $this-&gt;parse(false, $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-
-
 		$this-&gt;message = $tmp_message;
 
 		// Parse Poll Title
@@ -1398,8 +1425,8 @@
 		$this-&gt;message = $poll['poll_title'];
 
 
-		$poll['poll_title'] = $this-&gt;parse(false, $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-
+		$poll['poll_title'] = $this-&gt;parse(false, $poll['enable_bbcode'], ($config['allow_post_links']) ? $poll['enable_urls'] : false, $poll['enable_smilies'], $poll['img_status'], false, false, $config['allow_post_links'], false);
+
 		$this-&gt;message = $tmp_message;
 
 		unset($tmp_message);

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/functions.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -21,6 +21,45 @@
 $Id$
 */
 
+function array_filter_int($var)
+{
+	return validate_integer($var, true);
+}
+
+function validate_integer($value, $bool = false)
+{
+	if (is_null($value) || $value === '')
+	{
+		return false;
+	}
+
+	$value = (string) trim($value);
+	$value = str_replace(array(',', '$'), '', $value);
+
+	if ($value{0} === '+')
+	{
+		$value = substr($value, 1);
+	}
+
+	$check = (string) intval($value);
+
+	/*$position = 0;
+	while (substr($value, $position, 1) === '0')
+	{
+		$position++;
+		$check = '0'.$check;
+	}*/
+
+
+	if ($check === $value)
+	{
+		$return = $bool ? true : (int) $value;
+		return $return;
+	}
+
+	return false;
+}
+
 function censor_text($text, $force = false)
 {
 	global $_CLASS;

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/functions_user.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -104,19 +104,10 @@
 function check_user_id(&amp;$user_id, $bypass = false)
 {
 	// should we just return false, if this array map is different from the one sent
-
-	$user_id = array_map('intval', $user_id);
+	$user_id = array_map('intval', array_filter($user_id, 'array_filter_int'));
 	$user_id = array_unique($user_id);
 
-	// array map should make 0 values for notint values
-	$key = array_search(0, $user_id);
-
-	if ($key !== false &amp;&amp; !is_null($key))
-	{
-		unset($user_id[$key]);
-	}
-
-// make bypass an array maybe, along with protected id. would be better if you want to extend this
+	// make bypass an array maybe, along with protected id. would be better if you want to extend this
 	if ($bypass)
 	{
 		// You shouldn'y do anything to guest
@@ -124,8 +115,8 @@
 		{
 			unset($user_id[$key]);
 		}
-	
-		// First admin is always specail
+
+		// First admin is always special
 		if (($key = array_search(2, $user_id)) === false)
 		{
 			unset($user_id[$key]);
@@ -157,18 +148,17 @@
 	);
 
 	$default_data['user_data'] = serialize(array(
-		'viewimg' =&gt; 1,
-		'viewflash' =&gt; 1,
-		'viewsmilies' =&gt; 1,
-		'viewsigs'	=&gt; 1,
-		'viewavatars' =&gt; 1,
-		'viewcensors' =&gt; 1,
+		'viewimg'		=&gt; 1,
+		'viewflash'		=&gt; 1,
+		'viewsmilies'	=&gt; 1,
+		'viewsigs'		=&gt; 1,
+		'viewavatars'	=&gt; 1,
+		'viewcensors'	=&gt; 1,
 
-		'bbcode' =&gt; 1,
-		'html'	=&gt; 1,
-		'smilies' =&gt; 1,
+		'bbcode'	=&gt; 1,
+		'html'		=&gt; 1,
+		'smilies' 	=&gt; 1,
 		'attachsig' =&gt; 1,
-		'html'	=&gt; 1,
 	));
 
 	$data = array_merge($default_data, $data);
@@ -188,7 +178,7 @@
 			'member_status'	=&gt; $data['user_status']
 		);
 
-		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $data2, CORE_USER_GROUP_TABLE);
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $data2, CORE_GROUPS_MEMBERS_TABLE);
 	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');
@@ -200,7 +190,7 @@
 
 	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (check_user_id($user_id) == false)
+	if (check_user_id($user_id) === false)
 	{
 		return;
 	}
@@ -215,7 +205,7 @@
 
 	$_CLASS['core_db']-&gt;query($sql);
 
-	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
+	$sql = 'UPDATE ' . CORE_GROUPS_MEMBERS_TABLE . '
 		SET member_status = ' . STATUS_ACTIVE . '
 			WHERE user_id  IN (' . implode(', ', $user_id) . ') 
 			AND member_status = ' . STATUS_DISABLED;
@@ -243,7 +233,7 @@
 
 	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (check_user_id($user_id) == false)
+	if (check_user_id($user_id) === false)
 	{
 		return;
 	}
@@ -259,15 +249,14 @@
 	$_CLASS['core_db']-&gt;query($sql);
 
 	// Now we disable the user in his active groups
-	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
+	$sql = 'UPDATE ' . CORE_GROUPS_MEMBERS_TABLE . '
 		SET member_status = ' . STATUS_DISABLED . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')
 			AND member_status = ' . STATUS_ACTIVE;
 	$_CLASS['core_db']-&gt;query($sql);
 
 	$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
-		WHERE user_id IN (' . implode(', ', $user_id) . &quot;)
-		AND auto_login_code = '&quot; . $_CLASS['core_db']-&gt;escape($code) . &quot;'&quot;;
+		WHERE user_id IN (' . implode(', ', $user_id) . &quot;)&quot;;
 	$_CLASS['core_db']-&gt;query($sql);
 
 	if ($update_stats)
@@ -301,7 +290,7 @@
 
 	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	if (check_user_id($user_id) == false)
+	if (check_user_id($user_id) === false)
 	{
 		return;
 	}
@@ -331,7 +320,7 @@
 	$_CLASS['core_db']-&gt;transaction();
 
 	$optimize_array = array();
-	$tables = array(CORE_USERS_TABLE =&gt; 'user_id', CORE_SESSIONS_AUTOLOGIN_TABLE =&gt; 'user_id', CORE_USER_GROUP_TABLE =&gt; 'user_id');
+	$tables = array(CORE_USERS_TABLE =&gt; 'user_id', CORE_SESSIONS_AUTOLOGIN_TABLE =&gt; 'user_id', CORE_GROUPS_MEMBERS_TABLE =&gt; 'user_id');
 // hook here
 
 // Move this to hooks on seperation
@@ -441,21 +430,21 @@
 	return $data['username'];
 }
 
-function groups_user_remove($group_id, $user_id)
+function group_user_remove($group_id, $user_id)
 {
 	global $_CLASS;
 
 	$group_id = is_array($group_id) ? $group_id : array($group_id);
 	$user_id = is_array($user_id) ? $user_id : array($user_id);
 
-	$group_id = array_map('intval', $group_id);
+	$group_id = array_unique(array_map('intval', array_filter($group_id, 'array_filter_int')));
 
-	if (check_user_id($user_id) == false)
+	if (empty($group_id))
 	{
 		return;
 	}
 
-	if (empty($group_id))
+	if (check_user_id($user_id) === false)
 	{
 		return;
 	}
@@ -489,14 +478,13 @@
 		$result = $_CLASS['core_db']-&gt;query($sql);
 	}
 
-	$sql = 'DELETE FROM ' . CORE_USER_GROUP_TABLE . '
+	$sql = 'DELETE FROM ' . CORE_GROUPS_MEMBERS_TABLE . '
 		WHERE group_id IN ('. implode(', ', $group_id) . ')
 		AND user_id IN ('. implode(', ', $user_id) .')';
-
-	$result = $_CLASS['core_db']-&gt;query($sql);
+	$_CLASS['core_db']-&gt;query($sql);
 }
 
-function groups_user_add($group_id, $user_id, $status)
+function group_user_add($group_id, $user_id, $status)
 {
 	global $_CLASS;
 
@@ -530,12 +518,39 @@
 
 	if (!empty($data)) 
 	{
-		$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $data, USER_GROUP_TABLE);
+		$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $data, CORE_GROUPS_MEMBERS_TABLE);
 	}
 
 	$_CLASS['core_db']-&gt;transaction('commit');
 }
 
+function group_membership($user_id, $group_id = false)
+{
+	global $_CLASS;
+
+	$user_id = is_array($user_id) ? $user_id : array($user_id);
+
+	if ($group_id)
+	{
+		$group_id = is_array($group_id) ? $group_id : array($group_id);
+		$group_id = array_map('intval', array_filter($group_id, 'array_filter_int'));
+	}
+
+	$sql = 'SELECT *
+		FROM ' . CORE_GROUPS_MEMBERS_TABLE . ' ug, '. CORE_GROUPS_TABLE .' g
+		WHERE ug.user_id IN (' . implode(', ', $user_id) . ')
+		AND g.group_id = ug.group_id ORDER by g.group_name';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$return[$row['user_id']][$row['group_id']] = $row;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	return $return;
+}
+
 function validate_username($username)
 {
 	global $_CORE_CONFIG, $_CLASS;

Modified: cms/trunk/includes/handler.php
===================================================================
--- cms/trunk/includes/handler.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/handler.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -57,6 +57,20 @@
 		set_error_handler(array(&amp;$this, 'error_handler'));
 	}
 	
+	function add_log($type, $operation, $data = false)
+	{
+		$sql_array = array(
+			'user_id'		=&gt; empty($_CLASS['core_user']-&gt;data['user_id']) ? ANONYMOUS : $_CLASS['core_user']-&gt;data['user_id'],
+			'log_type'		=&gt; $type,
+			'log_ip'		=&gt; $_CLASS['core_user']-&gt;ip,
+			'log_time'		=&gt; $_CLASS['core_user']-&gt;time,
+			'log_operation'	=&gt; $operation,
+			'log_data'		=&gt; ($data) ? serialize($data) : '',
+		);
+
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, CORE_LOG_TABLE);
+	}
+
 	function stop($level = false)
 	{
 		if (!$this-&gt;active)

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/tables.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -97,6 +97,19 @@
 define('ITEM_MOVED', 2);
 define('ITEM_DELETING', 3);
 
+// Forum Flags
+define('FORUM_FLAG_LINK_TRACK', 1);
+define('FORUM_FLAG_PRUNE_POLL', 2);
+define('FORUM_FLAG_PRUNE_ANNOUNCE', 4);
+define('FORUM_FLAG_PRUNE_STICKY', 8);
+define('FORUM_FLAG_ACTIVE_TOPICS', 16);
+define('FORUM_FLAG_POST_REVIEW', 32);
+
+// Optional text flags
+define('OPTION_FLAG_BBCODE', 1);
+define('OPTION_FLAG_SMILIES', 2);
+define('OPTION_FLAG_LINKS', 4);
+
 // Topic types
 define('POST_NORMAL', 0);
 define('POST_STICKY', 1);

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/includes/user.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -43,7 +43,6 @@
 	var $user_setup = false;
 
 	var $lang_name;
-	var $lang_path;
 
 	function core_user()
 	{
@@ -271,7 +270,6 @@
 		}
 
 		$this-&gt;lang_name = $_CORE_CONFIG['global']['default_lang'];
-		$this-&gt;lang_path = SITE_FILE_ROOT.'language/' . $this-&gt;lang_name . '/';
 
 		$this-&gt;time_format = ($this-&gt;data['user_time_format']) ? $this-&gt;data['user_time_format'] : $_CORE_CONFIG['global']['default_dateformat'];
 		$this-&gt;time_offset = ($this-&gt;data['user_timezone']) ? $this-&gt;data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
@@ -281,7 +279,7 @@
 			$this-&gt;time_offset += 3600;
 		}
 
-		require($this-&gt;lang_path . 'common.php');
+		$this-&gt;add_lang('common', null);
 	}
 
 	function add_img($img_file = false, $module = false, $lang = false)

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/install/build_data.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -23,7 +23,7 @@
 
 $time = gmtime();
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_AUTH_TABLE .&quot; (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_AUTH_TABLE .&quot; (admin_section, user_id, admin_status, admin_options) VALUES ('_all_', 2, 2, '_all_')&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_upload', 'images/avatars/upload', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_gallery', 'images/avatars/gallery', 'string', 1)&quot;);
@@ -73,6 +73,7 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'activation', '0', 'int', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'total_users', '1', 'int', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'password_encoding', 'md5', 'string', 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'pass_complex', '.*', 'string', 1)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'path', '/', 'string', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONFIG_TABLE  .&quot; (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_domain', '', 'string', 1)&quot;);
@@ -252,12 +253,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_hideonline', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_viewonline', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_viewprofile', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chgavatar', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chggrp', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chgemail', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chgname', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chgpasswd', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_chgcensors', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_search', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_savedrafts', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_download', 1)&quot;);
@@ -270,11 +265,9 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_attach', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_authgroups', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_authusers', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_backup', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_bbcode', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_board', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_clearlogs', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_email', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_fauth', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_forum', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_forumadd', 1)&quot;);
@@ -282,8 +275,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_icons', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_mauth', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_modules', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_names', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_profile', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_prune', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_ranks', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_reasons', 1)&quot;);
@@ -295,19 +286,6 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_user', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_viewauth', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_viewlogs', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('a_words', 1)&quot;);
-
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_attach', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_bbcode', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_smilies', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_download', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_edit', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_printpm', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_emailpm', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_forward', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_delete', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_img', 1)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  .&quot; (auth_option, is_global) VALUES ('u_pm_flash', 1)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . &quot; (role_name, role_description, role_type, role_order) VALUES ('Standard Admin', 'ROLE_DESCRIPTION_ADMIN_STANDARD', 'a_', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . &quot; (role_name, role_description, role_type, role_order) VALUES ('Forum Admin', 'ROLE_DESCRIPTION_ADMIN_FORUM', 'a_', 3)&quot;);
@@ -339,14 +317,9 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)&quot;);
@@ -358,80 +331,64 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)&quot;);// maybe keep
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)&quot;);
-
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)&quot;);
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('limit_search_load', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_anon_lastread', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_user_activity', '1', 0)&quot;);
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_block_size', '250', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_indexing_state', '', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_interval', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_anonymous_interval', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_type', 'fulltext_native', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_store_results', '1800', 0)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)&quot;);
 
-//$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)&quot;);
-//$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_font_size', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_img_height', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_img_width', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('min_search_author_chars', '3', 0)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_start_date', $time, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_start_date', $time, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('bump_type', 'd', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)&quot;);
 
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)&quot;);
+
+//$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)&quot;);
+
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)&quot;);
+
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_max_height', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_max_width', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_link_height', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_link_width', '0', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('record_online_users', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('record_online_date', '0', 1)&quot;);
@@ -444,15 +401,8 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_CONFIG_TABLE  .&quot; (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  .&quot; (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  .&quot; (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')&quot;);
@@ -504,7 +454,7 @@
 # -- Roles data
 
 # Standard Admin (a_)
-$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  .&quot; (role_id, auth_option_id, auth_setting) SELECT 1, auth_option_id, 1 FROM  &quot;. FORUMS_ACL_OPTIONS_TABLE  .&quot;  WHERE auth_option LIKE 'a_%' AND auth_option NOT IN ('a_switchperm', 'a_jabber', 'a_phpinfo', 'a_server', 'a_backup', 'a_styles', 'a_clearlogs', 'a_modules', 'a_language', 'a_email', 'a_bots', 'a_search', 'a_aauth', 'a_roles')&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  .&quot; (role_id, auth_option_id, auth_setting) SELECT 1, auth_option_id, 1 FROM  &quot;. FORUMS_ACL_OPTIONS_TABLE  .&quot;  WHERE auth_option LIKE 'a_%' AND auth_option NOT IN ('a_switchperm', 'a_jabber', 'a_phpinfo', 'a_server', 'a_styles', 'a_clearlogs', 'a_modules', 'a_language', 'a_bots', 'a_search', 'a_aauth', 'a_roles')&quot;);
 
 # Forum admin (a_)
 $_CLASS['core_db']-&gt;query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  .&quot; (role_id, auth_option_id, auth_setting) SELECT 2, auth_option_id, 1 FROM  &quot;. FORUMS_ACL_OPTIONS_TABLE  .&quot;  WHERE auth_option LIKE 'a_%' AND auth_option IN ('a_', 'a_authgroups', 'a_authusers', 'a_fauth', 'a_forum', 'a_forumadd', 'a_forumdel', 'a_mauth', 'a_prune', 'a_uauth', 'a_viewauth', 'a_viewlogs')&quot;);

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/install/build_tables.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -34,13 +34,14 @@
 
 $_CLASS['core_db']-&gt;table_create('start', CORE_ADMIN_AUTH_TABLE);
 
+$_CLASS['core_db']-&gt;add_table_field_int('admin_access_id', array('max' =&gt; 16000000, 'auto_increment' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_char('admin_section', 100);
-
+$_CLASS['core_db']-&gt;add_table_field_int('admin_status', array('max' =&gt; 10));
+$_CLASS['core_db']-&gt;add_table_field_text('admin_options', 60000, true);
 $_CLASS['core_db']-&gt;add_table_field_int('user_id', array('max' =&gt; 16000000, 'null' =&gt; true));
 $_CLASS['core_db']-&gt;add_table_field_int('group_id', array('max' =&gt; 16000000, 'null' =&gt; true));
-$_CLASS['core_db']-&gt;add_table_field_int('admin_status', array('max' =&gt; 10));
-$_CLASS['core_db']-&gt;add_table_field_text('admin_options', 60000, true);
 
+$_CLASS['core_db']-&gt;add_table_index('admin_access_id', 'primary');
 $_CLASS['core_db']-&gt;add_table_index('user_id');
 $_CLASS['core_db']-&gt;add_table_index('group_id');
 $_CLASS['core_db']-&gt;add_table_index('admin_status');
@@ -365,6 +366,7 @@
 $_CLASS['core_db']-&gt;add_table_field_int('poster_id', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_int('download_count', array('max' =&gt; 16000000));
 $_CLASS['core_db']-&gt;add_table_field_int('in_message', array('max' =&gt; 1));
+$_CLASS['core_db']-&gt;add_table_field_int('is_orphan', array('max' =&gt; 1));
 
 $_CLASS['core_db']-&gt;add_table_field_text('comment', 200);
 $_CLASS['core_db']-&gt;add_table_field_char('physical_filename', 255);

Modified: cms/trunk/javascript/editor.js
===================================================================
--- cms/trunk/javascript/editor.js	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/javascript/editor.js	2006-09-21 06:41:32 UTC (rev 188)
@@ -490,7 +490,7 @@
 			{
 				color = String(numberList[r]) + String(numberList[g]) + String(numberList[b]);
 				document.write('&lt;td bgcolor=&quot;#' + color + '&quot;&gt;');
-				document.write('&lt;a href=&quot;javascript:bbfontstyle(\'[color=#' + color + ']\', \'[/color]\');&quot; onmouseover=&quot;helpline(\'s\');&quot;&gt;&lt;img src=&quot;images/spacer.gif&quot; width=&quot;' + width + '&quot; height=&quot;' + height + '&quot; border=&quot;0&quot; alt=&quot;#' + color + '&quot; title=&quot;#' + color + '&quot; /&gt;&lt;/a&gt;');
+				document.write('&lt;a href=&quot;#&quot; onclick=&quot;bbfontstyle(\'[color=#' + color + ']\', \'[/color]\'); return false;&quot; onmouseover=&quot;helpline(\'s\');&quot;&gt;&lt;img src=&quot;images/spacer.gif&quot; width=&quot;' + width + '&quot; height=&quot;' + height + '&quot; alt=&quot;#' + color + '&quot; title=&quot;#' + color + '&quot; /&gt;&lt;/a&gt;');
 				document.writeln('&lt;/td&gt;');
 			}
 

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -318,19 +318,23 @@
 		$error[] = $_CLASS['core_user']-&gt;lang['TOO_MANY_RECIPIENTS'];
 	}
 
+	// Always check if the submitted attachment data is valid and belongs to the user.
+	// Further down (especially in submit_post()) we do not check this again.
 	$message_parser-&gt;get_submitted_attachment_data();
 
 	if ($message_attachment &amp;&amp; !$submit &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; $action == 'edit')
 	{
-		$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+		// Do not change to SELECT *
+		$sql = 'SELECT attach_id, is_orphan, attach_comment, real_filename
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 			WHERE post_msg_id = $msg_id
 				AND in_message = 1
+				AND is_orphan = 0
 				ORDER BY filetime &quot; . ((!$config['display_order']) ? 'DESC' : 'ASC');
 		$result = $_CLASS['core_db']-&gt;query($sql);
 
 		$message_parser-&gt;attachment_data = array_merge($message_parser-&gt;attachment_data, $_CLASS['core_db']-&gt;fetch_row_assocset($result));
-		
+
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
@@ -375,11 +379,12 @@
 	$img_status		= ($config['auth_img_pm'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_pm_img'));
 	$flash_status	= ($config['auth_flash_pm'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_pm_flash'));
 */
-	$html_status	= ($config['allow_html'] &amp;&amp; $config['auth_html_pm']);
-	$bbcode_status	= ($config['allow_bbcode'] &amp;&amp; $config['auth_bbcode_pm']);
-	$smilies_status	= ($config['allow_smilies'] &amp;&amp; $config['auth_smilies_pm']);
-	$img_status		= ($config['auth_img_pm']);
-	$flash_status	= ($config['auth_flash_pm']);
+	$html_status	= ($config['allow_html'] &amp;&amp; $config['auth_html_pm']) ? true : false;
+	$bbcode_status	= ($config['allow_bbcode'] &amp;&amp; $config['auth_bbcode_pm']) ? true : false;
+	$smilies_status	= ($config['allow_smilies'] &amp;&amp; $config['auth_smilies_pm']) ? true : false;
+	$img_status		= ($config['auth_img_pm']) ? true : false;
+	$flash_status	= ($config['auth_flash_pm']) ? true : false;
+	$url_status		= ($config['allow_post_links']) ? true : false;
 
 	// Save Draft
 	if ($save &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'))
@@ -483,7 +488,7 @@
 		$message_parser-&gt;parse_attachments('fileupload', $action, 0, $submit, $preview, $refresh, true);
 
 		// Parse message
-		$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
+		$message_parser-&gt;parse(false, $enable_bbcode, ($config['allow_post_links']) ? $enable_urls : false, $enable_smilies, $img_status, $flash_status, true, $config['allow_sig_links']);
 
 		if ($action != 'edit' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $config['flood_interval'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('u_ignoreflood'))
 		{
@@ -629,8 +634,16 @@
 	{
 		if ($action === 'quotepost')
 		{
-			$post_id = request_var('p', 0);
-			$message_link = &quot;[url=&quot; . generate_link(&quot;forums&amp;file=viewtopic&amp;p={$post_id}#p{$post_id}&quot;).&quot;]{$message_subject}[/url]\n&quot;;
+			$post_id = request_var('p', 0);
+
+			if ($config['allow_post_links'])
+			{
+				$message_link = &quot;[url=&quot; . generate_link(&quot;forums&amp;file=viewtopic&amp;p={$post_id}#p{$post_id}&quot;).&quot;]{$message_subject}[/url]\n\n&quot;;
+			}
+			else
+			{
+				$message_link = $_CLASS['core_user']-&gt;lang['SUBJECT'] . ': ' . $message_subject . &quot; (&quot; . generate_link(&quot;forums&amp;file=viewtopic&amp;p={$post_id}#p{$post_id}&quot;).&quot;)\n\n&quot;;
+			}
 		}
 		else 
 		{
@@ -648,14 +661,23 @@
 	{
 		$fwd_to_field = write_pm_addresses(array('to' =&gt; $post['to_address']), 0, true);
 
+		if ($config['allow_post_links'])
+		{
+			$quote_username_text = '[url=' . generate_link(&quot;members_list&amp;mode=viewprofile&amp;u={$post['author_id']}&quot;).&quot;]{$quote_username}[/url]&quot;;
+		}
+		else
+		{
+			$quote_username_text = $quote_username . ' (' . generate_link(&quot;members_list&amp;mode=viewprofile&amp;u={$post['author_id']}&quot;).&quot;)&quot;;
+		}
+
 		$forward_text = array();
 		$forward_text[] = $_CLASS['core_user']-&gt;lang['FWD_ORIGINAL_MESSAGE'];
 		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_SUBJECT'], censor_text($message_subject));
 		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_DATE'], $_CLASS['core_user']-&gt;format_date($message_time));
-		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_FROM'], $quote_username);
+		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_FROM'], $quote_username_text);
 		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_TO'], implode(', ', $fwd_to_field['to']));
 
-		$message_parser-&gt;message = implode(&quot;\n&quot;, $forward_text) . &quot;\n\n[quote=\&quot;[url=&quot; . generate_link(&quot;members_list&amp;mode=viewprofile&amp;u={$post['author_id']}&quot;).&quot;{$quote_username}[/url]\&quot;]\n&quot; . censor_text(trim($message_parser-&gt;message)) . &quot;\n[/quote]&quot;;
+		$message_parser-&gt;message = implode(&quot;\n&quot;, $forward_text) . &quot;\n\n[quote=\&quot;{$quote_username}\&quot;]\n&quot; . censor_text(trim($message_parser-&gt;message)) . &quot;\n[/quote]&quot;;
 		$message_subject = ((!preg_match('/^Fwd:/', $message_subject)) ? 'Fwd: ' : '') . censor_text($message_subject);
 	}
 
@@ -811,6 +833,7 @@
 		'IMG_STATUS'			=&gt; ($img_status) ? $_CLASS['core_user']-&gt;lang['IMAGES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['IMAGES_ARE_OFF'],
 		'FLASH_STATUS'			=&gt; ($flash_status) ? $_CLASS['core_user']-&gt;lang['FLASH_IS_ON'] : $_CLASS['core_user']-&gt;lang['FLASH_IS_OFF'],
 		'SMILIES_STATUS'		=&gt; ($smilies_status) ? $_CLASS['core_user']-&gt;lang['SMILIES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['SMILIES_ARE_OFF'],
+		'URL_STATUS'			=&gt; ($url_status) ? $_CLASS['core_user']-&gt;lang['URL_IS_ON'] : $_CLASS['core_user']-&gt;lang['URL_IS_OFF'],
 		'MINI_POST_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_post', $_CLASS['core_user']-&gt;lang['PM']),
 		'ERROR'					=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
 
@@ -826,15 +849,21 @@
 		'S_SMILIES_CHECKED' 	=&gt; ($smilies_checked) ? ' checked=&quot;checked&quot;' : '',
 		'S_SIG_ALLOWED'			=&gt; ($config['allow_sig'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_sig')),
 		'S_SIGNATURE_CHECKED' 	=&gt; ($sig_checked) ? ' checked=&quot;checked&quot;' : '',
+		'S_LINKS_ALLOWED'               =&gt; $url_status,
 		'S_MAGIC_URL_CHECKED' 	=&gt; ($urls_checked) ? ' checked=&quot;checked&quot;' : '',
 		'S_SAVE_ALLOWED'		=&gt; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'),
 		'S_HAS_DRAFTS'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $drafts),
 		'S_FORM_ENCTYPE'		=&gt; $form_enctype,
 		
+		'S_BBCODE_IMG'			=&gt; $img_status,
+		'S_BBCODE_FLASH'		=&gt; $flash_status,
+		'S_BBCODE_QUOTE'		=&gt; true,
+		'S_BBCODE_URL'			=&gt; $url_status,
+		
 		'S_POST_ACTION' 		=&gt; generate_link($s_action),
 		'S_HIDDEN_ADDRESS_FIELD'=&gt; $s_hidden_address_field,
-		'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields)
-	);
+		'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields
+	));
 
 	// Attachment entry
 	if ($_CLASS['forums_auth']-&gt;acl_get('u_pm_attach') &amp;&amp; $config['allow_pm_attach'] &amp;&amp; $form_enctype)

Modified: cms/trunk/modules/control_panel/modules/ucp_profile.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_profile.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/control_panel/modules/ucp_profile.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -110,7 +110,7 @@
 				$message_parser = new parse_message($signature);
 
 				// Allowing Quote BBCode
-				$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
+				$message_parser-&gt;parse(false, $enable_bbcode, ($config['allow_sig_links']) ? $enable_urls : false, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, $config['allow_sig_links'], true, 'sig');
 				
 				if (!empty($message_parser-&gt;warn_msg))
 				{
@@ -176,6 +176,7 @@
 			'SMILIES_STATUS'		=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_OFF'),
 			'IMG_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_OFF'),
 			'FLASH_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('FLASH_IS_ON') : $_CLASS['core_user']-&gt;get_lang('FLASH_IS_OFF'),
+			'URL_STATUS'			=&gt; ($config['allow_sig_links']) ? $_CLASS['core_user']-&gt;lang['URL_IS_ON'] : $_CLASS['core_user']-&gt;lang['URL_IS_OFF'],
 
 			'L_SIGNATURE_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
 

Modified: cms/trunk/modules/control_panel/modules/ucp_register.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_register.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/control_panel/modules/ucp_register.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -106,6 +106,23 @@
 		$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_ERROR');
 	}
 
+	if ($password)
+	{
+		if (!preg_match('#' . str_replace('\\\\', '\\', $_CORE_CONFIG['user']['pass_complex']) . '#i', $password))
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_INVALID_CHARS');
+		}
+
+		if ($_CORE_CONFIG['user']['min_pass_chars'] &amp;&amp; mb_strlen($password) &lt; $_CORE_CONFIG['user']['min_pass_chars'])
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_TOO_SHORT');
+		}
+		elseif ($_CORE_CONFIG['user']['max_pass_chars'] &amp;&amp; mb_strlen($password) &gt; $_CORE_CONFIG['user']['max_pass_chars'])
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_TOO_LONG');
+		}
+	}
+
 	if (!$email || $email !== $email_confirm)
 	{
 		$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_ERROR');
@@ -177,7 +194,7 @@
 		$data = array(
 			'username'		=&gt; (string) $username,
 			'user_email'	=&gt; (string) $email,
-// add an option so admin can set with group they added to
+// add an option so admin can set with group they added to ( default registration group )
 			'user_group'	=&gt; ($coppa) ? 3 : 2,
 			'user_reg_date'	=&gt; (int) $_CLASS['core_user']-&gt;time,
 			'user_timezone'	=&gt; (string) $tz,
@@ -206,14 +223,13 @@
 		$mailer = new core_mailer();
 
 		$mailer-&gt;to($email, $username);
-		$mailer-&gt;subject('Welcome to ');
+		$mailer-&gt;subject('Welcome');
 
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
 			'WELCOME_MSG'   =&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
 			'USERNAME'		=&gt; $username,
 			'PASSWORD'		=&gt; $password,
-			'EMAIL_SIG'		=&gt; '', //I like this
 			'U_ACTIVATE'	=&gt; generate_link('system&amp;mode=activate&amp;user_id='.$data['user_id'].'&amp;key='.$user_act_key, array('sid' =&gt; false, 'full' =&gt; true))
 		));
 
@@ -228,9 +244,13 @@
 		}
 
 		$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/core/'.$email_template, true));
-
 		$mailer-&gt;send();
 
+		if $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
+		{
+			sele
+		}
+
 		$message = $message . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;'. generate_link() .'&quot;&gt;', '&lt;/a&gt;');
 		trigger_error($message);
 	}
@@ -280,6 +300,7 @@
 }
 
 $user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
+$pass_char_ary = array('.*' =&gt; 'PASS_TYPE_ANY', '[a-zA-Z]' =&gt; 'PASS_TYPE_CASE', '[a-zA-Z0-9]' =&gt; 'PASS_TYPE_ALPHA', '[a-zA-Z\W]' =&gt; 'PASS_TYPE_SYMBOL');
 
 $_CLASS['core_template']-&gt;assign_array(array(
 	'ERROR'			=&gt; empty($error) ? false : implode('&lt;br /&gt;', $error), 
@@ -293,9 +314,9 @@
 	'L_CONFIRM_EXPLAIN'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['CONFIRM_EXPLAIN'], '&lt;a href=&quot;mailto:' . htmlentities('') . '&quot;&gt;', '&lt;/a&gt;'), 
 	'L_ITEMS_REQUIRED'			=&gt; $l_reg_cond, 
 	'L_USERNAME_EXPLAIN'		=&gt; sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
-	'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+	//'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+	'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang[$pass_char_ary[str_replace('\\\\', '\\', $_CORE_CONFIG['user']['pass_complex'])] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']),
 
-
 	'S_COPPA'			=&gt; $coppa, 
 	'S_HIDDEN_FIELDS'	=&gt; $hidden_fields,
 	'S_UCP_ACTION'		=&gt; generate_link(&quot;control_panel&amp;mode=register&quot;))

Modified: cms/trunk/modules/forums/admin/index.php
===================================================================
--- cms/trunk/modules/forums/admin/index.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/admin/index.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -161,7 +161,7 @@
 			$size = (int) $tpl_type[1];
 			$maxlength = (int) $tpl_type[2];
 
-			$tpl = '&lt;input id=&quot;' . $key . '&quot; type=&quot;' . $tpl_type[0] . '&quot;' . (($size) ? ' size=&quot;' . $size . '&quot;' : '') . ' maxlength=&quot;' . (($maxlength) ? $maxlength : 255) . '&quot; name=&quot;' . $name . '&quot; value=&quot;' . $new[$config_key] . '&quot; /&gt;';
+			$tpl = '&lt;input id=&quot;' . $key . '&quot; type=&quot;' . $tpl_type[0] . '&quot;' . (($size) ? ' size=&quot;' . $size . '&quot;' : '') . ' maxlength=&quot;' . (($maxlength) ? $maxlength : 255) . '&quot; name=&quot;' . $name . '&quot; value=&quot;' . @$new[$config_key] . '&quot; /&gt;';
 		break;
 
 		case 'dimension':
@@ -198,7 +198,7 @@
 
 			if (isset($vars['method']))
 			{
-				$call = array($module-&gt;module, $vars['method']);
+				$call = $vars['method'];
 			}
 			else if (isset($vars['function']))
 			{
@@ -258,4 +258,82 @@
 	return $tpl;
 }
 
+/**
+* Going through a config array and validate values, writing errors to $error.
+*/
+function validate_config_vars($config_vars, &amp;$cfg_array, &amp;$error)
+{
+	global $_CLASS;
+
+	foreach ($config_vars as $config_name =&gt; $config_definition)
+	{
+		if (!isset($cfg_array[$config_name]) || strpos($config_name, 'legend') !== false)
+		{
+			continue;
+		}
+
+		if (!isset($config_definition['validate']))
+		{
+			continue;
+		}
+
+		// Validate a bit. ;) String is already checked through request_var(), therefore we do not check this again
+		switch ($config_definition['validate'])
+		{
+			case 'bool':
+				$cfg_array[$config_name] = ($cfg_array[$config_name]) ? 1 : 0;
+			break;
+
+			case 'int':
+				$cfg_array[$config_name] = (int) $cfg_array[$config_name];
+			break;
+
+			case 'rpath':
+				if (!$cfg_array[$config_name])
+				{
+					break;
+				}
+
+				$destination = $cfg_array[$config_name];
+
+				// Adjust destination path (no trailing slash)
+				if ($destination{(sizeof($destination)-1)} == '/' || $destination{(sizeof($destination)-1)} == '\\')
+				{
+					$destination = substr($destination, 0, sizeof($destination)-2);
+				}
+
+				$destination = str_replace(array('../', '..\\', './', '.\\'), '', $destination);
+				if ($destination &amp;&amp; ($destination{0} == '/' || $destination{0} == &quot;\\&quot;))
+				{
+					$destination = '';
+				}
+
+				$cfg_array[$config_name] = $destination;
+
+			case 'path':
+
+				if (!$cfg_array[$config_name])
+				{
+					break;
+				}
+
+				$cfg_array[$config_name] = trim($cfg_array[$config_name]);
+
+				if (!file_exists($cfg_array[$config_name]))
+				{
+					$error[] = sprintf($_CLASS['core_user']-&gt;lang['DIRECTORY_DOES_NOT_EXIST'], $cfg_array[$config_name]);
+				}
+
+				if (file_exists($cfg_array[$config_name]) &amp;&amp; !is_dir($cfg_array[$config_name]))
+				{
+					$error[] = sprintf($_CLASS['core_user']-&gt;lang['DIRECTORY_NOT_DIR'], $cfg_array[$config_name]);
+				}
+
+			break;
+		}
+	}
+
+	return;
+}
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/download.php
===================================================================
--- cms/trunk/modules/forums/download.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/download.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -45,7 +45,7 @@
 	trigger_error('ATTACHMENT_FUNCTIONALITY_DISABLED');
 }
 
-$sql = 'SELECT attach_id, in_message, post_msg_id, extension
+$sql = 'SELECT attach_id, in_message, post_msg_id, extension, is_orphan, poster_id
 	FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 	WHERE attach_id = $download_id&quot;;
 $result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -64,48 +64,63 @@
 
 $row = array();
 
-if (!$attachment['in_message'])
+if ($attachment['is_orphan'])
+{
+	// We allow admins having attachment permissions to see orphan attachments...
+	$own_attachment = ($_CLASS['auth']-&gt;acl_get('a_attach') || $attachment['poster_id'] == $_CLASS['core_user']-&gt;data['user_id']) ? true : false;
+
+	if (!$own_attachment || ($attachment['in_message'] &amp;&amp; !$_CLASS['auth']-&gt;acl_get('u_pm_download')) || (!$attachment['in_message'] &amp;&amp; !$_CLASS['auth']-&gt;acl_get('u_download')))
+	{
+		trigger_error('ERROR_NO_ATTACHMENT');
+	}
+
+	$extensions = obtain_attach_extensions();
+}
+else
 {
-	$sql = 'SELECT p.forum_id, f.forum_password, f.parent_id
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
-		WHERE p.post_id = ' . $attachment['post_msg_id'] . '
-			AND p.forum_id = f.forum_id';
-
-	$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if ($_CLASS['auth']-&gt;acl_get('u_download') &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_download', $row['forum_id']))
+	if (!$attachment['in_message'])
 	{
-		if ($row['forum_password'])
+		$sql = 'SELECT p.forum_id, f.forum_password, f.parent_id
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
+			WHERE p.post_id = ' . $attachment['post_msg_id'] . '
+				AND p.forum_id = f.forum_id';
+	
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+	
+		if ($_CLASS['auth']-&gt;acl_get('u_download') &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_download', $row['forum_id']))
 		{
-			// Do something else ... ?
-			login_forum_box($row);
+			if ($row['forum_password'])
+			{
+				// Do something else ... ?
+				login_forum_box($row);
+			}
 		}
+		else
+		{
+			trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		}
 	}
 	else
 	{
-		trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		$row['forum_id'] = 0;
+	
+		if (!$_CLASS['auth']-&gt;acl_get('u_pm_download') || !$config['auth_download_pm'])
+		{
+			trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		}
 	}
-}
-else
-{
-	$row['forum_id'] = 0;
-
-	if (!$_CLASS['auth']-&gt;acl_get('u_pm_download') || !$config['auth_download_pm'])
+	
+	// disallowed ?
+	$extensions = obtain_attach_extensions();
+	
+	if (!extension_allowed($row['forum_id'], $attachment['extension'], $extensions))
 	{
-		trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		trigger_error(sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_DISABLED_AFTER_POSTING'], $attachment['extension']));
 	}
 }
 
-// disallowed ?
-$extensions = obtain_attach_extensions();
-
-if (!extension_allowed($row['forum_id'], $attachment['extension'], $extensions))
-{
-	trigger_error(sprintf($_CLASS['core_user']-&gt;lang['EXTENSION_DISABLED_AFTER_POSTING'], $attachment['extension']));
-}
-
 if (!download_allowed())
 {
 	trigger_error('LINKAGE_FORBIDDEN');
@@ -114,7 +129,7 @@
 $download_mode = (int) $extensions[$attachment['extension']]['download_mode'];
 
 // Fetching filename here to prevent sniffing of filename
-$sql = 'SELECT attach_id, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype
+$sql = 'SELECT attach_id, is_orphan, in_message, post_msg_id, extension, physical_filename, real_filename, mimetype
 	FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 	WHERE attach_id = $download_id&quot;;
 $result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -133,7 +148,7 @@
 {
 	$attachment['physical_filename'] = 'thumb_' . $attachment['physical_filename'];
 }
-elseif ($display_cat == ATTACHMENT_CATEGORY_NONE || $display_cat == ATTACHMENT_CATEGORY_IMAGE)
+elseif (($display_cat == ATTACHMENT_CATEGORY_NONE || $display_cat == ATTACHMENT_CATEGORY_IMAGE) &amp;&amp; !$attachment['is_orphan'])
 {
 	// Update download count
 	$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
@@ -184,9 +199,9 @@
 		Correct the mime type - we force application/octetstream for all files, except images
 		Please do not change this, it is a security precaution
 	*/
-	if ($category == ATTACHMENT_CATEGORY_NONE &amp;&amp; strpos($attachment['mimetype'], 'image') === false)
+	if (strpos($attachment['mimetype'], 'image') !== 0)
 	{
-		$attachment['mimetype'] = (strpos(strtolower($user-&gt;browser), 'msie') !== false || strpos(strtolower($user-&gt;browser), 'opera') !== false) ? 'application/octetstream' : 'application/octet-stream';
+		$attachment['mimetype'] = (strpos(strtolower($_CLASS['core_user']-&gt;browser), 'msie') !== false || strpos(strtolower($_CLASS['core_user']-&gt;browser), 'opera') !== false) ? 'application/octetstream' : 'application/octet-stream';
 	}
 
 	/* Clean all output buffers */
@@ -200,12 +215,15 @@
 	/* Send out required headers */
 	header('Pragma: public');
 	
-	// Try X-Sendfile since it is much more server friendly.
+	// Try X-Sendfile since it is much more server friendly - only works if the path is *not* outside of the root path...
 	// lighttpd has core support for it. An apache2 module is available at <A HREF="http://celebnamer.celebworld.ws/stuff/mod_xsendfile/">http://celebnamer.celebworld.ws/stuff/mod_xsendfile/</A>
-	header('X-Sendfile: ' . $filename);
+	if (strpos($upload_dir, '/') !== 0 &amp;&amp; strpos($upload_dir, '../') === false &amp;&amp; (!SITE_ROOT || (strpos($upload_dir, SITE_ROOT) || @file_exists(SITE_ROOT.$filename))))
+	{
+		header('X-Sendfile: ' . $filename);
+	}
 
 	header('Content-Type: ' . $attachment['mimetype'] . '; name=&quot;' . $attachment['real_filename'] . '&quot;');
-	header('Content-Disposition: attachment; filename=&quot;' . $attachment['real_filename'] . '&quot;');
+	header('Content-Disposition: ' . ((strpos($attachment['mimetype'], 'image') === 0) ? 'inline' : 'attachment') . '; filename=&quot;' . $attachment['real_filename'] . '&quot;');
 
 	/* Now send the File Contents to the Browser */
 	$size = @filesize($filename);

Added: cms/trunk/modules/forums/language/admin_attachments.php
===================================================================
--- cms/trunk/modules/forums/language/admin_attachments.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/language/admin_attachments.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,144 @@
+&lt;?php
+/** 
+*
+* acp_attachments [English]
+*
+* @package language
+* @version $Id: attachments.php,v 1.10 2006/08/28 15:50:32 acydburn Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+$this-&gt;lang += array(
+	'ACP_ATTACHMENT_SETTINGS_EXPLAIN'	=&gt; 'Here you can configure the Main Settings for Attachments and the associated Special Categories.',
+	'ACP_EXTENSION_GROUPS_EXPLAIN'		=&gt; 'Here you can add, delete and modify your Extension Groups, you can disable Extension Groups, assign a special Category to them, change the download mechanism and you can define an Upload Icon which will be displayed in front of an Attachment belonging to the Group.',
+	'ACP_MANAGE_EXTENSIONS_EXPLAIN'		=&gt; 'Here you can manage your allowed extensions. To activate your Extensions, please refer to the extension groups management panel. We strongly recommend not to allow scripting extensions (such as php, php3, php4, phtml, pl, cgi, asp, aspx...)',
+	'ACP_ORPHAN_ATTACHMENTS_EXPLAIN'	=&gt; 'Here you are able to see files within the Attachments upload directory but not assigned to posts. This happens mostly if users are attaching files but not submitting the post. You are able to delete the files or attach them to existing posts. Attaching to posts requires a valid post id, you have to determine this id by yourself, this feature is mainly for those people wanting to upload files with another program and assigning those (mostly large) files to an existing post.',
+	'ADD_EXTENSION'						=&gt; 'Add extension',
+	'ADD_EXTENSION_GROUP'				=&gt; 'Add Extension Group',
+	'ADMIN_UPLOAD_ERROR'				=&gt; 'Errors while trying to attach file: %s',
+	'ALLOWED_FORUMS'					=&gt; 'Allowed Forums',
+	'ALLOWED_FORUMS_EXPLAIN'			=&gt; 'Able to post the assigned extensions at the selected (or all if selected) forums',
+	'ALLOW_ATTACHMENTS'					=&gt; 'Allow Attachments',
+	'ALLOW_ALL_FORUMS'					=&gt; 'Allow All Forums',
+	'ALLOW_IN_PM'						=&gt; 'Allowed in private messaging',
+	'ALLOW_PM_ATTACHMENTS'				=&gt; 'Allow Attachments in Private Messages',
+	'ALLOW_SELECTED_FORUMS'				=&gt; 'Only Forums selected below',
+	'ASSIGNED_EXTENSIONS'				=&gt; 'Assigned Extensions',
+	'ASSIGNED_GROUP'					=&gt; 'Assigned Group',
+	'ATTACH_EXTENSIONS_URL'				=&gt; 'Extensions',
+	'ATTACH_EXT_GROUPS_URL'				=&gt; 'Extension Groups',
+	'ATTACH_MAX_FILESIZE'				=&gt; 'Maximum filesize',
+	'ATTACH_MAX_FILESIZE_EXPLAIN'		=&gt; 'Maximum size of each file, 0 is unlimited.',
+	'ATTACH_MAX_PM_FILESIZE'			=&gt; 'Maximum filesize messaging',
+	'ATTACH_MAX_PM_FILESIZE_EXPLAIN'	=&gt; 'Maximum drive space available per user for private message attachments, 0 is unlimited.',
+	'ATTACH_ORPHAN_URL'					=&gt; 'Orphan Attachments',
+	'ATTACH_POST_ID'					=&gt; 'Post ID',
+	'ATTACH_QUOTA'						=&gt; 'Total attachment quota',
+	'ATTACH_QUOTA_EXPLAIN'				=&gt; 'Maximum drive space available for attachments in total, 0 is unlimited.',
+	'ATTACH_TO_POST'					=&gt; 'Attach file to post',
+
+	'CAT_IMAGES'				=&gt; 'Images',
+	'CAT_RM_FILES'				=&gt; 'Real Media Streams',
+	'CAT_WM_FILES'				=&gt; 'Win Media Streams',
+	'CREATE_GROUP'				=&gt; 'Create new group',
+	'CREATE_THUMBNAIL'			=&gt; 'Create thumbnail',
+	'CREATE_THUMBNAIL_EXPLAIN'	=&gt; 'Create a thumbnail in all possible situations.',
+
+	'DEFINE_ALLOWED_IPS'			=&gt; 'Define allowed IPs/Hostnames',
+	'DEFINE_DISALLOWED_IPS'			=&gt; 'Define disallowed IPs/Hostnames',
+	'DOWNLOAD_ADD_IPS_EXPLAIN'		=&gt; 'To specify several different IP\'s or hostnames enter each on a new line. To specify a range of IP addresses separate the start and end with a hyphen (-), to specify a wildcard use *',
+	'DOWNLOAD_MODE'					=&gt; 'Download Mode',
+	'DOWNLOAD_MODE_EXPLAIN'			=&gt; 'If you experience problems downloading files, set this to &quot;physical&quot;, the user will be directed to the file directly. Do not set it to physical if not really needed, it discloses the filename.',
+	'DOWNLOAD_REMOVE_IPS_EXPLAIN'	=&gt; 'You can remove (or un-exclude) multiple IP addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded IP\'s have a blue background.',
+	'DISPLAY_INLINED'				=&gt; 'Display images inline',
+	'DISPLAY_INLINED_EXPLAIN'		=&gt; 'If set to No image attachments will show as a link.',
+	'DISPLAY_ORDER'					=&gt; 'Attachment Display Order',
+	'DISPLAY_ORDER_EXPLAIN'			=&gt; 'Display attachments ordered by time.',
+	
+	'EDIT_EXTENSION_GROUP'			=&gt; 'Edit Extension Group',
+	'EXCLUDE_ENTERED_IP'			=&gt; 'Enable this to exclude the entered IP/Hostname.',
+	'EXCLUDE_FROM_ALLOWED_IP'		=&gt; 'Exclude IP from allowed IPs/Hostnames',
+	'EXCLUDE_FROM_DISALLOWED_IP'	=&gt; 'Exclude IP from disallowed IPs/Hostnames',
+	'EXTENSIONS_UPDATED'			=&gt; 'Extensions successfully updated',
+	'EXTENSION_EXIST'				=&gt; 'The Extension %s already exist',
+	'EXTENSION_GROUP'				=&gt; 'Extension Group',
+	'EXTENSION_GROUPS'				=&gt; 'Extension Groups',
+	'EXTENSION_GROUP_DELETED'		=&gt; 'Extension Group successfully deleted',
+	'EXTENSION_GROUP_EXIST'			=&gt; 'The Extension Group %s already exist',
+
+	'GO_TO_EXTENSIONS'		=&gt; 'Go to Extension Management Screen',
+	'GROUP_NAME'			=&gt; 'Group name',
+
+	'IMAGE_LINK_SIZE'			=&gt; 'Image Link Dimensions',
+	'IMAGE_LINK_SIZE_EXPLAIN'	=&gt; 'Display image attachment as link if image is larger than this, set to 0px by 0px to disable.',
+	'IMAGICK_PATH'				=&gt; 'Imagemagick path',
+	'IMAGICK_PATH_EXPLAIN'		=&gt; 'Full path to the imagemagick convert application, e.g. /usr/bin/',
+
+	'MAX_ATTACHMENTS'				=&gt; 'Max attachments per post',
+	'MAX_ATTACHMENTS_PM'			=&gt; 'Max attachments per message',
+	'MAX_EXTGROUP_FILESIZE'			=&gt; 'Maximum Filesize',
+	'MAX_IMAGE_SIZE'				=&gt; 'Maximum Image Dimensions',
+	'MAX_IMAGE_SIZE_EXPLAIN'		=&gt; 'Maximum size of image attachments, 0px by 0px disables image attachments.',
+	'MAX_THUMB_WIDTH'				=&gt; 'Maximum thumbnail width in pixel',
+	'MAX_THUMB_WIDTH_EXPLAIN'		=&gt; 'A generated thumbnail will not exceed the width set here',
+	'MIN_THUMB_FILESIZE'			=&gt; 'Minimum thumbnail filesize',
+	'MIN_THUMB_FILESIZE_EXPLAIN'	=&gt; 'Do not create a thumbnail for images smaller than this.',
+	'MODE_INLINE'					=&gt; 'Inline',
+	'MODE_PHYSICAL'					=&gt; 'Physical',
+
+	'NOT_ALLOWED_IN_PM'			=&gt; 'Not allowed in private messages',
+	'NOT_ASSIGNED'				=&gt; 'Not assigned',
+	'NO_EXT_GROUP'				=&gt; 'None',
+	'NO_EXT_GROUP_NAME'			=&gt; 'No Group Name entered',
+	'NO_EXT_GROUP_SPECIFIED'	=&gt; 'No Extension Group specified',
+	'NO_FILE_CAT'				=&gt; 'None',
+	'NO_IMAGE'					=&gt; 'No Image',
+	'NO_THUMBNAIL_SUPPORT'		=&gt; 'Thumbnail support has been disabled because there is no supported GD library available and the imagemagick executable could not be found.',
+	'NO_UPLOAD_DIR'				=&gt; 'The upload directory you specified does not exist.',
+	'NO_WRITE_UPLOAD'			=&gt; 'The upload directory you specified cannot be written to. Please alter the permissions to allow the webserver to write to it.',
+
+	'ORDER_ALLOW_DENY'		=&gt; 'Allow',
+	'ORDER_DENY_ALLOW'		=&gt; 'Deny',
+
+	'REMOVE_ALLOWED_IPS'		=&gt; 'Remove or Un-exclude allowed IPs/Hostnames',
+	'REMOVE_DISALLOWED_IPS'		=&gt; 'Remove or Un-exclude disallowed IPs/Hostnames',
+
+	'SEARCH_IMAGICK'				=&gt; 'Search for Imagemagick',
+	'SECURE_ALLOW_DENY'				=&gt; 'Allow/Deny List',
+	'SECURE_ALLOW_DENY_EXPLAIN'		=&gt; 'Allow or Deny the list of addresses, this setting only applies to downloading files',
+	'SECURE_DOWNLOADS'				=&gt; 'Enable secure downloads',
+	'SECURE_DOWNLOADS_EXPLAIN'		=&gt; 'With this option enabled, downloads are limited to IP\'s/hostnames you defined.',
+	'SECURE_DOWNLOAD_NOTICE'		=&gt; 'Secure Downloads are not enabled. The settings below will be applied after enabling secure downloads.',
+	'SECURE_DOWNLOAD_UPDATE_SUCCESS'=&gt; 'The IP list has been updated successfully',
+	'SECURE_EMPTY_REFERRER'			=&gt; 'Allow empty referrer',
+	'SECURE_EMPTY_REFERRER_EXPLAIN'	=&gt; 'Secure downloads are based on referrers. Do you want to allow downloads for those ommitting the referrer?',
+	'SETTINGS_CAT_IMAGES'			=&gt; 'Image category settings',
+	'SPECIAL_CATEGORY'				=&gt; 'Special Category',
+	'SPECIAL_CATEGORY_EXPLAIN'		=&gt; 'Special Categories differ between the way presented within posts.',
+	'SUCCESSFULLY_UPLOADED'			=&gt; 'Succeessfully uploaded',
+	'SUCCESS_EXTENSION_GROUP_ADD'	=&gt; 'Extension Group successfully added',
+	'SUCCESS_EXTENSION_GROUP_EDIT'	=&gt; 'Extension Group successfully updated',
+
+	'UPLOADING_FILES'				=&gt; 'Uploading Files',
+	'UPLOADING_FILE_TO'				=&gt; 'Uploading File &quot;%1$s&quot; to Post Number %2$d...',
+	'UPLOAD_DENIED_FORUM'			=&gt; 'You do not have the permission to upload files to forum &quot;%s&quot;',
+	'UPLOAD_DIR'					=&gt; 'Upload Directory',
+	'UPLOAD_DIR_EXPLAIN'			=&gt; 'Storage Path for Attachments.',
+	'UPLOAD_ICON'					=&gt; 'Upload Icon',
+	'UPLOAD_NOT_DIR'				=&gt; 'The upload location you specified does not appear to be a directory.',
+);
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/modules/forums/language/admin_board.php
===================================================================
--- cms/trunk/modules/forums/language/admin_board.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/language/admin_board.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,139 @@
+&lt;?php
+/** 
+*
+* acp_board [English]
+*
+* @package language
+* @version $Id: board.php,v 1.38 2006/09/13 16:08:36 acydburn Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+// Board Settings
+$this-&gt;lang += array(
+	'ACP_BOARD_SETTINGS_EXPLAIN'	=&gt; 'Here you can determine the basic operation of your board, from the site name through user registration to private messaging.',
+
+	'CUSTOM_DATEFORMAT'				=&gt; 'Custom...',
+	'DEFAULT_DATE_FORMAT'			=&gt; 'Date Format',
+	'DEFAULT_DATE_FORMAT_EXPLAIN'	=&gt; 'The date format is the same as the PHP date function.',
+	'DEFAULT_LANGUAGE'				=&gt; 'Default Language',
+	'DEFAULT_STYLE'					=&gt; 'Default Style',
+	'DISABLE_BOARD'					=&gt; 'Disable board',
+	'DISABLE_BOARD_EXPLAIN'			=&gt; 'This will make the board unavailable to users. You can also enter a short (255 character) message to display if you wish.',
+	'OVERRIDE_STYLE'				=&gt; 'Override user style',
+	'OVERRIDE_STYLE_EXPLAIN'		=&gt; 'Replaces users style with the default.',
+	'RELATIVE_DAYS'					=&gt; 'Relative days',
+	'SITE_DESC'						=&gt; 'Site description',
+	'SITE_NAME'						=&gt; 'Site name',
+	'SYSTEM_DST'					=&gt; 'Enable Daylight Savings Time',
+	'SYSTEM_TIMEZONE'				=&gt; 'System Timezone',
+	'WARNINGS_EXPIRE'				=&gt; 'Warning duration',
+	'WARNINGS_EXPIRE_EXPLAIN'		=&gt; 'Number of days after it is issued before a warning will expire from a user\'s record',
+);
+
+// Board Features
+$this-&gt;lang += array(
+	'ACP_BOARD_FEATURES_EXPLAIN'	=&gt; 'Here you can enable/disable several board features',
+
+	'ALLOW_ATTACHMENTS'			=&gt; 'Allow Attachments',
+	'ALLOW_BOOKMARKS'			=&gt; 'Allow bookmarking topics',
+	'ALLOW_BOOKMARKS_EXPLAIN'	=&gt; 'User is able to store personal bookmarks',
+	'ALLOW_BBCODE'				=&gt; 'Allow BBCode',
+	'ALLOW_FORUM_NOTIFY'		=&gt; 'Allow Forum Watching',
+	'ALLOW_NAME_CHANGE'			=&gt; 'Allow Username changes',
+	'ALLOW_NO_CENSORS'			=&gt; 'Allow Disable of Censors',
+	'ALLOW_NO_CENSORS_EXPLAIN'	=&gt; 'User can disable word censoring.',
+	'ALLOW_PM_ATTACHMENTS'		=&gt; 'Allow Attachments in Private Messages',
+	'ALLOW_SIG'					=&gt; 'Allow Signatures',
+	'ALLOW_SIG_BBCODE'			=&gt; 'Allow BBCode in user signatures',
+	'ALLOW_SIG_FLASH'			=&gt; 'Allow use of FLASH BBCode Tag in user signatures',
+	'ALLOW_SIG_IMG'				=&gt; 'Allow use of IMG BBCode Tag in user signatures',
+	'ALLOW_SIG_LINKS'			=&gt; 'Allow use of links in user signatures',
+	'ALLOW_SIG_LINKS_EXPLAIN'	=&gt; 'If disallowed the URL bbcode tag and automatic/magic urls are disabled.',
+	'ALLOW_SIG_SMILIES'			=&gt; 'Allow use of smilies in user signatures',
+	'ALLOW_SMILIES'				=&gt; 'Allow Smilies',
+	'ALLOW_TOPIC_NOTIFY'		=&gt; 'Allow Topic Watching',
+	'BOARD_PM'					=&gt; 'Private Messaging',
+	'BOARD_PM_EXPLAIN'			=&gt; 'Enable or disable private messaging for all users.',
+);
+
+// Post Settings
+$this-&gt;lang += array(
+	'ACP_POST_SETTINGS_EXPLAIN'			=&gt; 'Here you can set all default settings for posting',
+	'ALLOW_POST_LINKS'					=&gt; 'Allow links in posts/private messages',
+	'ALLOW_POST_LINKS_EXPLAIN'			=&gt; 'If disallowed the URL bbcode tag and automatic/magic urls are disabled.',
+
+	'BUMP_INTERVAL'					=&gt; 'Bump Interval',
+	'BUMP_INTERVAL_EXPLAIN'			=&gt; 'Number of minutes, hours or days between the last post to a topic and the ability to bump this topic.',
+	'CHAR_LIMIT'					=&gt; 'Max characters per post',
+	'CHAR_LIMIT_EXPLAIN'			=&gt; 'Set to 0 for unlimited characters.',
+	'DISPLAY_LAST_EDITED'			=&gt; 'Display last edited time information',
+	'DISPLAY_LAST_EDITED_EXPLAIN'	=&gt; 'Choose if the last edited by information to be displayed on posts',
+	'EDIT_TIME'						=&gt; 'Limit editing time',
+	'EDIT_TIME_EXPLAIN'				=&gt; 'Limits the time available to edit a new post, zero equals infinity',
+	'FLOOD_INTERVAL'				=&gt; 'Flood Interval',
+	'FLOOD_INTERVAL_EXPLAIN'		=&gt; 'Number of seconds a user must wait between posting new messages. To enable users to ignore this alter their permissions.',
+	'HOT_THRESHOLD'					=&gt; 'Posts for Popular Threshold, Set to 0 to disable hot topics.',
+	'MAX_POLL_OPTIONS'				=&gt; 'Max number of poll options',
+	'MAX_POST_FONT_SIZE'			=&gt; 'Max font size per post',
+	'MAX_POST_FONT_SIZE_EXPLAIN'	=&gt; 'Set to 0 for unlimited font size.',
+	'MAX_POST_IMG_HEIGHT'			=&gt; 'Max image height per post',
+	'MAX_POST_IMG_HEIGHT_EXPLAIN'	=&gt; 'Maximum height of an image/flash file in postings. Set to 0 for unlimited size.',
+	'MAX_POST_IMG_WIDTH'			=&gt; 'Max image width per post',
+	'MAX_POST_IMG_WIDTH_EXPLAIN'	=&gt; 'Maximum width of an image/flash file in postings. Set to 0 for unlimited size.',
+	'MAX_POST_URLS'					=&gt; 'Max links per post',
+	'MAX_POST_URLS_EXPLAIN'			=&gt; 'Set to 0 for unlimited links.',
+	'POSTING'						=&gt; 'Posting',
+	'POSTS_PER_PAGE'				=&gt; 'Posts Per Page',
+	'QUOTE_DEPTH_LIMIT'				=&gt; 'Max nested quotes per post',
+	'QUOTE_DEPTH_LIMIT_EXPLAIN'		=&gt; 'Set to 0 for unlimited depth.',
+	'SMILIES_LIMIT'					=&gt; 'Max smilies per post',
+	'SMILIES_LIMIT_EXPLAIN'			=&gt; 'Set to 0 for unlimited smilies.',
+	'TOPICS_PER_PAGE'				=&gt; 'Topics Per Page',
+);
+// Load Settings
+$this-&gt;lang += array(
+	'ACP_LOAD_SETTINGS_EXPLAIN'	=&gt; 'Here you can enable and disable certain board functions to reduce the amount of processing required. On most servers there is no need to disable any functions. However on certain systems or in shared hosting environments it may be beneficial to disable capabilities you do not really need. You can also specify limits for system load and active sessions beyond which the board will go offline.',
+
+	'CUSTOM_PROFILE_FIELDS'			=&gt; 'Custom Profile Fields',
+	'LIMIT_LOAD'					=&gt; 'Limit system load',
+	'LIMIT_LOAD_EXPLAIN'			=&gt; 'If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.',
+	'LIMIT_SESSIONS'				=&gt; 'Limit sessions',
+	'LIMIT_SESSIONS_EXPLAIN'		=&gt; 'If the number of sessions exceeds this value within a one minute period the board will go offline. Set to 0 for unlimited sessions.',
+	'LOAD_CPF_MEMBERLIST'			=&gt; 'Display custom profile fields in memberlist',
+	'LOAD_CPF_VIEWPROFILE'			=&gt; 'Display custom profile fields in user profiles',
+	'LOAD_CPF_VIEWTOPIC'			=&gt; 'Display custom profile fields on viewtopic',
+	'LOAD_USER_ACTIVITY'			=&gt; 'Show users activity',
+	'LOAD_USER_ACTIVITY_EXPLAIN'	=&gt; 'Displays active topic/forum in user profiles and user control panel. It is recommended to disable this on boards with more than one million posts.',
+	'RECOMPILE_TEMPLATES'			=&gt; 'Recompile stale templates',
+	'RECOMPILE_TEMPLATES_EXPLAIN'	=&gt; 'Check for updated template files on filesystem and recompile.',
+	'YES_ANON_READ_MARKING'			=&gt; 'Enable topic marking for guests',
+	'YES_ANON_READ_MARKING_EXPLAIN'	=&gt; 'Stores read/unread status information for guests. If disabled posts are always read for guests.',
+	'YES_BIRTHDAYS'					=&gt; 'Enable birthday listing',
+	'YES_JUMPBOX'					=&gt; 'Enable display of Jumpbox',
+	'YES_MODERATORS'				=&gt; 'Enable display of Moderators',
+	'YES_ONLINE'					=&gt; 'Enable online user listings',
+	'YES_ONLINE_EXPLAIN'			=&gt; 'Display online user information on index, forum and topic pages.',
+	'YES_ONLINE_GUESTS'				=&gt; 'Enable online guest listings in viewonline',
+	'YES_ONLINE_GUESTS_EXPLAIN'		=&gt; 'Allow display of guest user informations in viewonline.',
+	'YES_ONLINE_TRACK'				=&gt; 'Enable display of user online img',
+	'YES_ONLINE_TRACK_EXPLAIN'		=&gt; 'Display online information for user in profiles and viewtopic.',
+	'YES_POST_MARKING'				=&gt; 'Enable dotted topics',
+	'YES_POST_MARKING_EXPLAIN'		=&gt; 'Indicates whether user has posted to a topic.',
+	'YES_READ_MARKING'				=&gt; 'Enable server-side topic marking',
+	'YES_READ_MARKING_EXPLAIN'		=&gt; 'Stores read/unread status information in the database rather than a cookie.',
+);
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/modules/forums/language/admin_posting.php
===================================================================
--- cms/trunk/modules/forums/language/admin_posting.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/language/admin_posting.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,229 @@
+&lt;?php
+/** 
+*
+* posting [English]
+*
+* @package language
+* @version $Id: posting.php,v 1.17 2006/08/30 01:31:50 davidmj Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+// BBCodes 
+// Note to translators: you can translate everything but what's between { and }
+$this-&gt;lang += array(
+	'ACP_BBCODES_EXPLAIN'		=&gt; 'BBCode is a special implementation of HTML offering greater control over what and how something is displayed. From this page you can add, remove and edit custom BBCodes',
+	'ADD_BBCODE'				=&gt; 'Add a new BBCode',
+
+	'BBCODE_ADDED'				=&gt; 'BBCode added successfully',
+	'BBCODE_EDITED'				=&gt; 'BBCode edited successfully',
+	'BBCODE_INVALID_TAG_NAME'	=&gt; 'The BBCode tag name that you selected already exists',
+	'BBCODE_NOT_EXIST'			=&gt; 'The BBCode you selected does not exist',
+	'BBCODE_HELPLINE'			=&gt; 'Helpline',
+	'BBCODE_HELPLINE_EXPLAIN'	=&gt; 'This field contains the mouseover text of the BBCode',
+	'BBCODE_HELPLINE_TEXT'		=&gt; 'Helpline text',
+	'BBCODE_TAG'				=&gt; 'Tag',
+	'BBCODE_TAG_TOO_LONG'		=&gt; 'The tag definition that you have entered is too long, please shorten your tag definition.',
+	'BBCODE_USAGE'				=&gt; 'BBCode usage',
+	'BBCODE_USAGE_EXAMPLE'		=&gt; '[colour={COLOR}]{TEXT}[/colour]&lt;br /&gt;&lt;br /&gt;[font={TEXT1}]{TEXT2}[/font]',
+	'BBCODE_USAGE_EXPLAIN'		=&gt; 'Here you define how to use the bbcode. Replace any variable input by the corresponding token (%ssee below%s)',
+
+	'EXAMPLE'						=&gt; 'Example:',
+	'EXAMPLES'						=&gt; 'Examples:',
+
+	'HTML_REPLACEMENT'				=&gt; 'HTML replacement',
+	'HTML_REPLACEMENT_EXAMPLE'		=&gt; '&lt;font color=&quot;{COLOR}&quot;&gt;{TEXT}&lt;/font&gt;&lt;br /&gt;&lt;br /&gt;&lt;font face=&quot;{TEXT1}&quot;&gt;{TEXT2}&lt;/font&gt;',
+	'HTML_REPLACEMENT_EXPLAIN'		=&gt; 'Here you define the default HTML replacement (each template can have its own HTML replacement). Do not forget to put back tokens you used above!',
+
+	'TOKEN'					=&gt; 'Token',
+	'TOKENS'				=&gt; 'Tokens',
+	'TOKENS_EXPLAIN'		=&gt; 'Tokens are placeholders for user input. The input will be validated only if it matches the corresponding definition. If needed, you can number them by adding a number as the last character between the braces, e.g. {USERNAME1}, {USERNAME2}.&lt;br /&gt;&lt;br /&gt;In addition to these tokens you can use any of lang string present in your language/ directory like this: {L_&lt;i&gt;&lt;stringname&gt;&lt;/i&gt;} where &lt;i&gt;&lt;stringname&gt;&lt;/i&gt; is the name of the translated string you want to add. For example, {L_WROTE} will be displayed as &quot;wrote&quot; or its translation according to user\'s locale',
+	'TOKEN_DEFINITION'		=&gt; 'What can it be?',
+	'TOO_MANY_BBCODES'		=&gt; 'You cannot create any more BBCodes. Please remove one or more BBCodes then try again',
+
+	'tokens'	=&gt;	array(
+		'TEXT'			=&gt; 'Any text, including foreign characters, numbers, etc...',
+		'NUMBER'		=&gt; 'Any series of digits',
+		'EMAIL'			=&gt; 'A valid email address',
+		'URL'			=&gt; 'A valid URL using any protocol (http, ftp, etc... cannot be used for javascript exploits). If none is given, &quot;<A HREF="http://">http://</A>&quot; is prepended to to the string',
+		'LOCAL_URL'		=&gt; 'A local URL. The URL must be relative to the topic page and cannot contain a server name or protocol',
+		'COLOR'			=&gt; 'A HTML color, can be either in the numeric form #FF1234 or an english name such as &quot;blue&quot;'
+	)
+);
+
+// Smilies and topic icons
+$this-&gt;lang += array(
+	'ACP_ICONS_EXPLAIN'		=&gt; 'From this page you can add, remove and edit the icons users may add to their topics or posts. These icons are generally displayed next to topic titles on the forum listing, or the post subjects in topic listings. You can also install and create new packages of icons.',
+	'ACP_SMILIES_EXPLAIN'	=&gt; 'Smilies or emoticons are typically small, sometimes animated images used to convey an emotion or feeling. From this page you can add, remove and edit the emoticons users can use in their posts and private messages. You can also install and create new packages of smilies.',
+	'ADD_SMILIES'			=&gt; 'Add multiple smilies',
+	'ADD_ICONS'				=&gt; 'Add multiple icons',
+	'AFTER_ICONS'			=&gt; 'After %s',
+	'AFTER_SMILIES'			=&gt; 'After %s',
+
+	'CODE'						=&gt; 'Code',
+	'CURRENT_ICONS'				=&gt; 'Current icons',
+	'CURRENT_ICONS_EXPLAIN'		=&gt; 'Choose what to do with the currently installed icons',
+	'CURRENT_SMILIES'			=&gt; 'Current smilies',
+	'CURRENT_SMILIES_EXPLAIN'	=&gt; 'Choose what to do with the currently installed smilies',
+
+	'DISPLAY_ON_POSTING'	=&gt; 'Display on posting',
+
+	'EDIT_ICONS'				=&gt; 'Edit Icons',
+	'EDIT_SMILIES'				=&gt; 'Edit smilies',
+	'EMOTION'					=&gt; 'Emotion',
+	'EXPORT_ICONS'				=&gt; 'Create icons pak',
+	'EXPORT_ICONS_EXPLAIN'		=&gt; 'To create a package of your currently installed icons, click %sHERE%s to download the icons package file. Once downloaded create a zip or tgz file containing all of your icons plus this .pak configuration file.',
+	'EXPORT_SMILIES'			=&gt; 'Create smilies pak',
+	'EXPORT_SMILIES_EXPLAIN'	=&gt; 'To create a package of your currently installed smilies, click %sHERE%s to download the smilies.pak file. Once downloaded create a zip or tgz file containing all of your smilies plus this .pak configuration file.',
+
+	'FIRST'			=&gt; 'First',
+
+	'ICONS_ADD'				=&gt; 'Add a new Icon',
+	'ICONS_ADDED'			=&gt; 'The icon has been added successfully.',
+	'ICONS_CONFIG'			=&gt; 'Icon configuration',
+	'ICONS_DELETED'			=&gt; 'The icon has been removed successfully.',
+	'ICONS_EDIT'			=&gt; 'Edit Icon',
+	'ICONS_EDITED'			=&gt; 'The icon has been updated successfully.',
+	'ICONS_HEIGHT'			=&gt; 'Icon height',
+	'ICONS_IMAGE'			=&gt; 'Icon image',
+	'ICONS_IMPORTED'		=&gt; 'The icons pack has been installed successfully.',
+	'ICONS_IMPORT_SUCCESS'	=&gt; 'The icons pack was imported successfully',
+	'ICONS_LOCATION'		=&gt; 'Icon location',
+	'ICONS_NOT_DISPLAYED'	=&gt; 'The following icons are not displayed on the posting page',
+	'ICONS_ORDER'			=&gt; 'Icon order',
+	'ICONS_URL'				=&gt; 'Icon image file',
+	'ICONS_WIDTH'			=&gt; 'Icon width',
+	'IMPORT_ICONS'			=&gt; 'Install icons pak',
+	'IMPORT_SMILIES'		=&gt; 'Install smilies pak',
+
+	'KEEP_ALL'			=&gt; 'Keep all',
+
+	'MASS_ADD_SMILIES'	=&gt; 'Add multiple smilies',
+
+	'NO_ICONS_EXPORT'	=&gt; 'You have no icons with which to create a package.',
+	'NO_ICONS_PAK'		=&gt; 'No icon packages found.',
+	'NO_SMILIES_EXPORT'	=&gt; 'You have no smilies with which to create a package.',
+	'NO_SMILIES_PAK'	=&gt; 'No smiley packages found.',
+
+	'PAK_FILE_NOT_READABLE'		=&gt; 'Could not read pak file',
+
+	'REPLACE_MATCHES'	=&gt; 'Replace matches',
+
+	'SELECT_PACKAGE'			=&gt; 'Select a package file',
+	'SMILIES_ADD'				=&gt; 'Add a new Smiley',
+	'SMILIES_ADDED'				=&gt; 'The smiley has been added successfully.',
+	'SMILIES_CODE'				=&gt; 'Smiley code',
+	'SMILIES_CONFIG'			=&gt; 'Smiley configuration',
+	'SMILIES_DELETED'			=&gt; 'The smiley has been removed successfully.',
+	'SMILIES_EDIT'				=&gt; 'Edit Smiley',
+	'SMILIES_EDITED'			=&gt; 'The smiley has been updated successfully.',
+	'SMILIES_EMOTION'			=&gt; 'Emotion',
+	'SMILIES_HEIGHT'			=&gt; 'Smiley height',
+	'SMILIES_IMAGE'				=&gt; 'Smiley image',
+	'SMILIES_IMPORTED'			=&gt; 'The smilies pack has been installed successfully.',
+	'SMILIES_IMPORT_SUCCESS'	=&gt; 'The smilies pack was imported successfully',
+	'SMILIES_LOCATION'			=&gt; 'Smiley location',
+	'SMILIES_NOT_DISPLAYED'		=&gt; 'The following smilies are not displayed on the posting page',
+	'SMILIES_ORDER'				=&gt; 'Smiley order',
+	'SMILIES_URL'				=&gt; 'Smiley image file',
+	'SMILIES_WIDTH'				=&gt; 'Smiley width',
+
+	'WRONG_PAK_TYPE'	=&gt; 'The specified package does not contain the appropriate data.',
+);
+
+// Word censors
+$this-&gt;lang += array(
+	'ACP_WORDS_EXPLAIN'		=&gt; 'From this control panel you can add, edit, and remove words that will be automatically censored on your forums. In addition people will not be allowed to register with usernames containing these words. Wildcards (*) are accepted in the word field, eg. *test* will match detestable, test* would match testing, *test would match detest.',
+	'ADD_WORD'				=&gt; 'Add new word',
+
+	'EDIT_WORD'		=&gt; 'Edit word censor',
+	'ENTER_WORD'	=&gt; 'You must enter a word and its replacement',
+
+	'NO_WORD'	=&gt; 'No word selected for editing',
+
+	'REPLACEMENT'	=&gt; 'Replacement',
+
+	'UPDATE_WORD'	=&gt; 'Update word censor',
+
+	'WORD'				=&gt; 'Word',
+	'WORD_ADDED'		=&gt; 'The word censor has been successfully added',
+	'WORD_REMOVED'		=&gt; 'The selected word censor has been successfully removed',
+	'WORD_UPDATED'		=&gt; 'The selected word censor has been successfully updated',
+);
+
+// Ranks
+$this-&gt;lang += array(
+	'ACP_RANKS_EXPLAIN'		=&gt; 'Using this form you can add, edit, view and delete ranks. You can also create custom ranks which can be applied to a user via the user management facility.',
+	'ADD_RANK'				=&gt; 'Add new rank',
+
+	'MUST_SELECT_RANK'		=&gt; 'You must select a rank.',
+	
+	'NO_ASSIGNED_RANK'		=&gt; 'No special rank assigned.',
+	'NO_RANK_TITLE'			=&gt; 'You haven\'t specified a title for the rank.',
+	'NO_UPDATE_RANKS'		=&gt; 'The rank was successfully deleted. However user accounts using this rank were not updated.  You will need to manually reset the rank on these accounts.',
+
+	'RANK_ADDED'			=&gt; 'The rank was successfully added.',
+	'RANK_IMAGE'			=&gt; 'Rank Image',
+	'RANK_IMAGE_EXPLAIN'	=&gt; 'Use this to define a small image associated with the rank. The path is relative to the root phpBB directory.',
+	'RANK_MINIMUM'			=&gt; 'Minimum Posts',
+	'RANK_REMOVED'			=&gt; 'The rank was successfully deleted.',
+	'RANK_SPECIAL'			=&gt; 'Set as Special Rank',
+	'RANK_TITLE'			=&gt; 'Rank Title',
+	'RANK_UPDATED'			=&gt; 'The rank was successfully updated.',
+);
+
+// Disallow Usernames
+$this-&gt;lang += array(
+	'ACP_DISALLOW_EXPLAIN'	=&gt; 'Here you can control usernames which will not be allowed to be used.  Disallowed usernames are allowed to contain a wildcard character of *.  Please note that you will not be allowed to specify any username that has already been registered, you must first delete that name then disallow it',
+	'ADD_DISALLOW_EXPLAIN'	=&gt; 'You can disallow a username using the wildcard character * to match any character',
+	'ADD_DISALLOW_TITLE'	=&gt; 'Add a disallowed username',
+
+	'DELETE_DISALLOW_EXPLAIN'	=&gt; 'You can remove a disallowed username by selecting the username from this list and clicking submit',
+	'DELETE_DISALLOW_TITLE'		=&gt; 'Remove a Disallowed Username',
+	'DISALLOWED_ALREADY'		=&gt; 'The name you entered could not be disallowed. It either already exists in the list, exists in the word censor list, or a matching username is present.',
+	'DISALLOWED_DELETED'		=&gt; 'The disallowed username has been successfully removed',
+	'DISALLOW_SUCCESSFUL'		=&gt; 'The disallowed username has been successfully added',
+
+	'NO_DISALLOWED'				=&gt; 'No Disallowed Usernames',
+	'NO_USERNAME_SPECIFIED'		=&gt; 'You haven\'t selected or entered a username to operate with.',
+);
+
+// Reasons
+$this-&gt;lang += array(
+	'ACP_REASONS_EXPLAIN'	=&gt; 'Here you can manage the reasons used in reports and denial messages when disapproving posts. There is one default reason (marked with a *) you are not able to remove, this reason is normally used for custom messages if no reason fits.',
+
+	'ADD_NEW_REASON'		=&gt; 'Add new reason',
+	
+	'IS_NOT_TRANSLATED'		=&gt; 'Reason has not been localized',
+	'IS_TRANSLATED'			=&gt; 'Reason has been localized',
+	
+	'NO_REASON'					=&gt; 'Reason could not be found',
+	'NO_REASON_INFO'			=&gt; 'You have to specify a title and a description for this reason.',
+	'NO_REMOVE_DEFAULT_REASON'	=&gt; 'You are not able to remove the default reason &quot;Other&quot;.',
+
+	'REASON_ADD'			=&gt; 'Add report/denial reason',
+	'REASON_ADDED'			=&gt; 'Report/denial reason successfully added',
+	'REASON_ALREADY_EXIST'	=&gt; 'A reason with this title already exist, please enter another title for this reason.',
+	'REASON_DESCRIPTION'	=&gt; 'Reason Description',
+	'REASON_EDIT'			=&gt; 'Edit report/denial reason',
+	'REASON_EDIT_EXPLAIN'	=&gt; 'Here you are able to add or edit a reason. If the reason is translated the localized version is used instead of the description entered here.',
+	'REASON_REMOVED'		=&gt; 'Report/denial reason successfully removed',
+	'REASON_TITLE'			=&gt; 'Reason Title',
+	'REASON_UPDATED'		=&gt; 'Report/denial reason successfully updated',
+
+	'USED_IN_REPORTS'		=&gt; 'Used in reports',
+);
+
+?&gt;
\ No newline at end of file

Added: cms/trunk/modules/forums/language/admin_prune.php
===================================================================
--- cms/trunk/modules/forums/language/admin_prune.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/language/admin_prune.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -0,0 +1,69 @@
+&lt;?php
+/** 
+*
+* acp_prune [English]
+*
+* @package language
+* @version $Id: prune.php,v 1.3 2006/05/12 23:45:27 naderman Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+// User pruning
+$this-&gt;lang += array(
+	'ACP_PRUNE_USERS_EXPLAIN'	=&gt; 'Here you can delete (or deactivate) users from you board. This can be done in a variety of ways; by post count, last activity, etc. Each of these criteria can be combined, i.e. you can prune users last active before 2002-01-01 with fewer than 10 posts. Alternatively you can enter a list of users directly into the text box, any criteria entered will be ignored. Take care with this facility! Once a user is deleted there is no way back.',
+
+	'DEACTIVATE_DELETE'			=&gt; 'Deactivate or delete',
+	'DEACTIVATE_DELETE_EXPLAIN'	=&gt; 'Choose whether to deactivate users or delete them entirely, note there is no undo!',
+	'DELETE_USERS'				=&gt; 'Delete',
+	'DELETE_USER_POSTS'			=&gt; 'Delete pruned user posts',
+	'DELETE_USER_POSTS_EXPLAIN' =&gt; 'Removes posts made by deleted users, has no effect if users are deactivated.',
+
+	'JOINED_EXPLAIN'			=&gt; 'Enter a date in YYYY-MM-DD format.',
+
+	'LAST_ACTIVE_EXPLAIN'		=&gt; 'Enter a date in YYYY-MM-DD format.',
+
+	'SELECT_USERS_EXPLAIN'		=&gt; 'Enter specific usernames here, they will be used in preference to the criteria above.',
+
+	'USER_DEACTIVATE_SUCCESS'	=&gt; 'The selected users have been deactivated successfully',
+	'USER_DELETE_SUCCESS'		=&gt; 'The selected users have been deleted successfully',
+);
+
+// Forum Pruning
+$this-&gt;lang += array(
+	'ACP_PRUNE_FORUMS_EXPLAIN'	=&gt; 'This will delete any topic which has not been posted to within the number of days you select. If you do not enter a number then all topics will be deleted. It will not remove topics in which polls are still running nor will it remove announcements. You will need to remove these topics manually.',
+
+	'FORUM_PRUNE'		=&gt; 'Forum Prune',
+
+	'NO_PRUNE'			=&gt; 'No forums pruned',
+
+	'SELECTED_FORUM'	=&gt; 'Selected Forum',
+	'SELECTED_FORUMS'	=&gt; 'Selected Forums',
+
+	'POSTS_PRUNED'					=&gt; 'Posts pruned',
+	'PRUNE_ANNOUNCEMENTS'			=&gt; 'Prune Announcements',
+	'PRUNE_FINISHED_POLLS'			=&gt; 'Prune Closed Polls',
+	'PRUNE_FINISHED_POLLS_EXPLAIN'	=&gt; 'Removes topics with polls which have ended.',
+	'PRUNE_NOT_POSTED'				=&gt; 'Days since last posted',
+	'PRUNE_NOT_VIEWED'				=&gt; 'Days since last viewed',
+	'PRUNE_OLD_POLLS'				=&gt; 'Prune Old Polls',
+	'PRUNE_OLD_POLLS_EXPLAIN'		=&gt; 'Removes topics with polls not voted in for post age days.',
+	'PRUNE_STICKY'					=&gt; 'Prune Stickies',
+	'PRUNE_SUCCESS'					=&gt; 'Pruning of forums was successful',
+
+	'TOPICS_PRUNED'		=&gt; 'Topics pruned',
+);
+
+?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/posting.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -356,10 +356,12 @@
 
 if ($post_data['post_attachment'] &amp;&amp; !$submit &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; $mode == 'edit')
 {
-	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+	//$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+	$sql = 'SELECT attach_id, is_orphan, attach_comment, real_filename
 		FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot;
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
+			AND is_orphan = 0
 		ORDER BY filetime &quot; . ((!$config['display_order']) ? 'DESC' : 'ASC');
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -516,6 +518,7 @@
 $bbcode_status	= ($config['allow_bbcode'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_bbcode', $forum_id));
 $smilies_status	= ($config['allow_smilies'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_smilies', $forum_id));
 $img_status		= ($_CLASS['forums_auth']-&gt;acl_get('f_img', $forum_id));
+$url_status		= ($config['allow_post_links']) ? true : false;
 $flash_status	= ($_CLASS['forums_auth']-&gt;acl_get('f_flash', $forum_id));
 $quote_status	= ($_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id));
 
@@ -714,12 +717,16 @@
 	// notify and show user the post made between his request and the final submit
 	if (($mode === 'reply' || $mode === 'quote') &amp;&amp; $post_data['topic_cur_post_id'] &amp;&amp; $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
-		if (topic_review($topic_id, $forum_id, 'post_review', $post_data['topic_cur_post_id']))
+		// Only do so if it is allowed forum-wide
+		if ($post_data['forum_flags'] &amp; FORUM_FLAG_POST_REVIEW)
 		{
-			$_CLASS['core_template']-&gt;assign('S_POST_REVIEW',  true);
+			if (topic_review($topic_id, $forum_id, 'post_review', $post_data['topic_cur_post_id']))
+			{
+				$_CLASS['core_template']-&gt;assign('S_POST_REVIEW',  true);
+			}
+			$submit = false;
+			$refresh = true;
 		}
-		$submit = false;
-		$refresh = true;
 	}
 
 	// Parse Attachments - before checksum is calculated
@@ -734,7 +741,7 @@
 	// Parse message
 	if ($update_message)
 	{
-		$message_parser-&gt;parse($post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies'], $img_status, $flash_status, $quote_status);
+		$message_parser-&gt;parse(false, $post_data['enable_bbcode'], ($config['allow_post_links']) ? $post_data['enable_urls'] : false, $post_data['enable_smilies'], $img_status, $flash_status, $quote_status, $config['allow_post_links']);
 	}
 	else
 	{
@@ -872,7 +879,7 @@
 		}
 	}
 
-	if (!empty($message_parser-&gt;warn_msg))
+	if (!empty($message_parser-&gt;warn_msg) &amp;&amp; !$refresh)
 	{
 		$error[] = implode('&lt;br /&gt;', $message_parser-&gt;warn_msg);
 	}
@@ -1257,6 +1264,7 @@
 	'IMG_STATUS'			=&gt; ($img_status) ? $_CLASS['core_user']-&gt;lang['IMAGES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['IMAGES_ARE_OFF'],
 	'FLASH_STATUS'			=&gt; ($flash_status) ? $_CLASS['core_user']-&gt;lang['FLASH_IS_ON'] : $_CLASS['core_user']-&gt;lang['FLASH_IS_OFF'],
 	'SMILIES_STATUS'		=&gt; ($smilies_status) ? $_CLASS['core_user']-&gt;lang['SMILIES_ARE_ON'] : $_CLASS['core_user']-&gt;lang['SMILIES_ARE_OFF'],
+	'URL_STATUS'			=&gt; ($url_status) ? $_CLASS['core_user']-&gt;lang['URL_IS_ON'] : $_CLASS['core_user']-&gt;lang['URL_IS_OFF'],
 	'MINI_POST_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_post', $_CLASS['core_user']-&gt;lang['POST']),
 	'POST_DATE'				=&gt; ($post_data['post_time']) ? $_CLASS['core_user']-&gt;format_date($post_data['post_time']) : '',
 	'ERROR'					=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
@@ -1285,13 +1293,15 @@
 	'S_LOCK_TOPIC_CHECKED'	=&gt; ($lock_topic_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_LOCK_POST_ALLOWED'	=&gt; ($mode == 'edit' &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id)),
 	'S_LOCK_POST_CHECKED'	=&gt; ($lock_post_checked) ? ' checked=&quot;checked&quot;' : '',
+	'S_LINKS_ALLOWED'		=&gt; $url_status,
 	'S_MAGIC_URL_CHECKED' 	=&gt; ($urls_checked) ? ' checked=&quot;checked&quot;' : '',
 	'S_TYPE_TOGGLE'			=&gt; $topic_type_toggle,
 	'S_SAVE_ALLOWED'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user),
 	'S_HAS_DRAFTS'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $_CLASS['core_user']-&gt;is_user &amp;&amp; $post_data['drafts']),
 	'S_FORM_ENCTYPE'		=&gt; $form_enctype,
 
-	'S_BBCODE_IMG'			=&gt; $img_status,
+	'S_BBCODE_IMG'			=&gt; $img_status,
+	'S_BBCODE_URL'			=&gt; $url_status,
 	'S_BBCODE_FLASH'		=&gt; $flash_status,
 	'S_BBCODE_QUOTE'		=&gt; $quote_status,
 

Modified: cms/trunk/modules/forums/report.php
===================================================================
--- cms/trunk/modules/forums/report.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/report.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,413 +1,165 @@
-&lt;?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright &#169; 2004 by Viperal									//
-//  <A HREF="http://www.viperal.com">http://www.viperal.com</A>										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: report.php,v 1.16 2004/07/10 22:47:43 acydburn Exp $
-//
-// FILENAME  : report.php 
-// STARTED   : Thu Apr 3, 2003
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
-$_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
-
-$_CLASS['core_user']-&gt;add_lang('mcp');
-
-// Report PM or Post?
-$id = request_var('p', request_var('pm', 0));
-$report_post = (request_var('p', 0)) ? true : false;
-$reason_id	= request_var('reason_id', 0);
-$user_notify= (!empty($_REQUEST['notify']) &amp;&amp; $_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS) ? true : false;
-$report_text= request_var('report_text', '');
-
-if (!$id)
-{
-	trigger_error('INVALID_MODE');
-}
-
-$redirect_url = ($report_post) ? generate_link(&quot;Forums&amp;file=viewtopic&amp;p=$id#$id&quot;) : generate_link('Control_Panel&amp;i=pm&amp;p='.$id);
-// Has the report been cancelled?
-if (isset($_POST['cancel']))
-{
-	redirect($redirect_url);
-}
-
-// Grab all relevant data
-if ($report_post)
-{
-	$sql = 'SELECT f.*, t.*, p.*
-		FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . &quot; f
-		WHERE p.post_id = $id
-			AND p.topic_id = t.topic_id
-			AND p.forum_id = f.forum_id&quot;;
-}
-else
-{
-	// Only the user itself is able to report his Private Messages
-	$sql = 'SELECT p.*, t.*
-		FROM ' . PRIVMSGS_TABLE . ' p, ' . PRIVMSGS_TO_TABLE . &quot; t
-		WHERE t.msg_id = $id
-			AND t.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . '
-			AND t.msg_id = p.msg_id';
-}
-
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-$report_data = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-if (!$report_data)
-{
-	$message = ($report_post) ? $_CLASS['core_user']-&gt;lang['POST_NOT_EXIST'] : $_CLASS['core_user']-&gt;lang['PM_NOT_EXIST'];
-	trigger_error($message);
-}
-
-if ($report_post)
-{
-	$forum_id = $report_data['forum_id'];
-	$topic_id = $report_data['topic_id'];
-
-	// Check required permissions
-	$acl_check_ary = array('f_list' =&gt; 'POST_NOT_EXIST', 'f_read' =&gt; 'USER_CANNOT_READ', 'f_report' =&gt; 'USER_CANNOT_REPORT');
-	
-	foreach ($acl_check_ary as $acl =&gt; $error)
-	{
-		if (!$_CLASS['auth']-&gt;acl_get($acl, $forum_id))
-		{
-			trigger_error($error);
-		}
-	}
-	unset($acl_check_ary);
-}
-else
-{
-	if (!$config['auth_report_pm'] || !$_CLASS['auth']-&gt;acl_get('u_pm_report'))
-	{
-		trigger_error('USER_CANNOT_REPORT');
-	}
-}
-
-// Check if the post has already been reported by this user
-$sql = 'SELECT *
-	FROM ' . REPORTS_TABLE . '
-	WHERE ' . (($report_post) ? &quot;post_id = $id&quot; : &quot;msg_id = $id&quot;) . '
-		AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-if ($row)
-{
-	if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS)
-	{
-		// A report exists, extract $row if we're going to display the form
-		if ($reason_id)
-		{
-			$report_id = (int) $row['report_id'];
-		}
-		else
-		{
-			// Overwrite set variables
-			extract($row);
-		}
-	}
-	else
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['ALREADY_REPORTED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang[(($report_post) ? 'RETURN_TOPIC' : 'RETURN_MESSAGE')], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;'));
-	}
-}
-else
-{
-	$report_id = 0;
-}
-
-// Has the report been confirmed?
-if (isset($_POST['submit']) &amp;&amp; $reason_id)
-{
-	$sql = 'SELECT reason_name, reason_description
-		FROM ' . REASONS_TABLE . &quot; 
-		WHERE reason_id = $reason_id&quot;;
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
-	$row = $_CLASS['core_db']-&gt;sql_fetchrow($result);
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-	if (!$row || (!$report_text &amp;&amp; $row['reason_name'] == 'other'))
-	{
-		trigger_error('EMPTY_REPORT');
-	}
-
-	$reason_desc = (!empty($_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_description'];
-	
-	$sql_ary = array(
-		'reason_id'		=&gt; (int) $reason_id,
-		'post_id'		=&gt; ($report_post) ? $id : 0,
-		'msg_id'		=&gt; ($report_post) ? 0 : $id,
-		'user_id'		=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-		'user_notify'	=&gt; (int) $user_notify,
-		'report_time'	=&gt; (int) time(),
-		'report_text'	=&gt; (string) $report_text
-	);
-
-	if ($report_id)
-	{
-		$sql = 'UPDATE ' . REPORTS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
-			WHERE report_id = ' . $report_id;
-		$_CLASS['core_db']-&gt;sql_query($sql);
-	}
-	else
-	{
-		$sql = 'INSERT INTO ' . REPORTS_TABLE . ' ' . 
-			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']-&gt;sql_query($sql);
-		$report_id = $_CLASS['core_db']-&gt;sql_nextid();
-	}
-
-	if ($report_post)
-	{
-		if (!$report_data['post_reported'])
-		{
-			$sql = 'UPDATE ' . POSTS_TABLE . ' 
-				SET post_reported = 1 
-				WHERE post_id = ' . $id;
-			$_CLASS['core_db']-&gt;sql_query($sql);
-		}
-
-		if (!$report_data['topic_reported'])
-		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . ' 
-				SET topic_reported = 1 
-				WHERE topic_id = ' . $report_data['topic_id'];
-			$_CLASS['core_db']-&gt;sql_query($sql);
-		}
-	}
-	else
-	{
-		if (!$report_data['message_reported'])
-		{
-			$sql = 'UPDATE ' . PRIVMSGS_TABLE . &quot; 
-				SET message_reported = 1 
-				WHERE msg_id = $id&quot;;
-			$_CLASS['core_db']-&gt;sql_query($sql);
-		}
-	}
-
-	// Send Notifications
-	// PM: Reported Post is put into all admin's boxes (not notifying about 'this' PM)
-	// All persons get notified about a new report, if notified by PM, send out email notifications too
-	
-	// Send notifications to moderators
-	$acl_list = ($report_post) ? $_CLASS['auth']-&gt;acl_get_list(false, array('m_', 'a_'), array(0, $report_data['forum_id'])) : $_CLASS['auth']-&gt;acl_get_list(false, 'a_', 0);
-	$notify_user = ($report_post) ? $acl_list[$report_data['forum_id']]['m_'] : array();
-	$notify_user = array_unique(array_merge($notify_user, $acl_list[0]['a_']));
-	unset($acl_list);
-
-	// Send reported PM to responsible persons (admins)
-	if (!$report_post)
-	{
-		foreach ($notify_user as $user_id)
-		{
-			$_CLASS['core_db']-&gt;sql_query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'msg_id'	=&gt; (int) $id,
-				'user_id'	=&gt; (int) $user_id,
-				'author_id'	=&gt; (int) $report_data['author_id'],
-				'folder_id'	=&gt; PRIVMSGS_NO_BOX,
-				'new'		=&gt; 1,
-				'unread'	=&gt; 1,
-				'forwarded'	=&gt; 0))
-			);
-		}
-
-		// Update Status
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
-			WHERE user_id IN (' . implode(', ', $notify_user) . ')';
-		$_CLASS['core_db']-&gt;sql_query($sql);
-	}
-
-	// How to notify them?
-	$sql = 'SELECT user_id, username, user_options, user_lang, user_email, user_notify_type, user_jabber 
-		FROM ' . USERS_TABLE . '
-		WHERE user_id IN (' . implode(', ', $notify_user) . ')';
-	$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-	$notify_user = array();
-	while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-	{
-		$notify_user[$row['user_id']] = array(
-			'name'	=&gt; $row['username'],
-			'email' =&gt; $row['user_email'],
-			'jabber'=&gt; $row['user_jabber'],
-			'lang'	=&gt; $row['user_lang'],
-			'notify_type'	=&gt; $row['user_notify_type'],
-			
-			'pm'	=&gt; $_CLASS['core_user']-&gt;optionget('report_pm_notify', $row['user_options'])
-		);
-	}
-	$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-	$report_data = array(
-		'id'		=&gt; $id,
-		'report_id'	=&gt; $report_id,
-		'reporter'	=&gt; $_CLASS['core_user']-&gt;data['username'],
-		'reason'	=&gt; $reason_desc,
-		'text'		=&gt; $report_text,
-		'subject'	=&gt; ($report_post) ? $report_data['post_subject'] : $report_data['message_subject'],
-		'view_post'	=&gt; ($report_post) ? generate_link(&quot;Forums&amp;file=viewtopic&amp;f={$report_data['forum_id']}&amp;t={$report_data['topic_id']}&amp;p=$id&amp;e=$id&quot;) : ''
-	);
-
-	report_notification($notify_user, $report_post, $report_data);
-
-	$_CLASS['core_display']-&gt;meta_refresh(3, $redirect_url);
-
-	$message = $_CLASS['core_user']-&gt;lang[(($report_post) ? 'POST' : 'MESSAGE') . '_REPORTED_SUCCESS'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang[(($report_post) ? 'RETURN_TOPIC' : 'RETURN_MESSAGE')], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;');
-	trigger_error($message);
-}
-
-// Generate the form
-$sql = 'SELECT * 
-	FROM ' . REASONS_TABLE . ' 
-	ORDER BY reason_priority ASC';
-$result = $_CLASS['core_db']-&gt;sql_query($sql);
-
-while ($row = $_CLASS['core_db']-&gt;sql_fetchrow($result))
-{
-	$row['reason_name'] = strtoupper($row['reason_name']);
-
-	$reason_title = (!empty($_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][$row['reason_name']])) ? $_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][$row['reason_name']] : ucwords(str_replace('_', ' ', $row['reason_name']));
-
-	$reason_desc = (!empty($_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_desc'];
-
-	$_CLASS['core_template']-&gt;assign_vars_array('reason', array(
-		'ID'			=&gt;	$row['reason_id'],
-		'NAME'			=&gt;	htmlspecialchars($reason_title),
-		'DESCRIPTION'	=&gt;	htmlspecialchars($reason_desc),
-		'S_SELECTED'    =&gt;	($row['reason_id'] == $reason_id) ? true : false)
-	);
-}
-$_CLASS['core_db']-&gt;sql_freeresult($result);
-
-$u_report = ($report_post) ? &quot;p=$id&quot; : &quot;pm=$id&quot;;
-
-$_CLASS['core_template']-&gt;assign(array(
-	'REPORT_TEXT'		=&gt;	$report_text,
-	'S_REPORT_ACTION'	=&gt;	generate_link(&quot;Forums&amp;file=report&amp;$u_report&quot; . (($report_id) ? &quot;&amp;report_id=$report_id&quot; : '')),
-	'S_NOTIFY'			=&gt; (!empty($user_notify)) ? true : false,
-	'S_CAN_NOTIFY'		=&gt; ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS) ? false : true,
-	'S_REPORT_POST'		=&gt; $report_post)
-);
-
-if ($report_post)
-{
-	generate_forum_nav($report_data);
-}
-
-page_header();
-
-$_CLASS['core_template']-&gt;display('modules/Forums/report_body.html');
-
-function report_notification($notify_user, $report_post, $report_data)
-{
-	global $config, $site_file_root;
-
-	require_once($site_file_root.'includes/forums/functions_messenger.php');
-	require_once($site_file_root.'includes/forums/functions_privmsgs.php');
-	$messenger = new messenger();
-
-	$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
-	$email_template = ($report_post) ? 'new_report_post' : 'new_report_pm';
-	$view_report_url = ($report_post) ? generate_link('Forums&amp;file=mcp&amp;i=queue&amp;r=' . $report_data['report_id'], array('full' =&gt; true, 'sid' =&gt; false)) : generate_link('Forums&amp;file=mcp&amp;i=pm&amp;p='. $report_data['id'] . '&amp;r=' . $report_data['report_id'], array('full' =&gt; true, 'sid' =&gt; false));
-
-	foreach ($notify_user as $user_id =&gt; $notify_row)
-	{
-		// Send notification by email
-		if (!$notify_row['pm'])
-		{
-			$messenger-&gt;to($notify_row['email'], $notify_row['name']);
-			$messenger-&gt;im($notify_row['jabber'], $notify_row['name']);
-			$messenger-&gt;replyto($config['board_email']);
-
-			$messenger-&gt;template($email_template, $notify_row['lang']);
-
-			$messenger-&gt;assign_vars(array(
-				'EMAIL_SIG'		=&gt; $email_sig,
-				'SITENAME'		=&gt; $config['sitename'],
-				'USERNAME'		=&gt; $notify_row['name'],
-				'SUBJECT'		=&gt; $report_data['subject'],
-				'REPORTER'		=&gt; $report_data['reporter'],
-
-				'REPORT_REASON'	=&gt; $report_data['reason'],
-				'REPORT_TEXT'	=&gt; $report_data['text'],
-
-				'U_VIEW_REPORT'	=&gt; $view_report_url,
-				'U_VIEW_POST'	=&gt; generate_board_url() . '/' . $report_data['view_post'])
-			);
-
-			$messenger-&gt;send($notify_row['notify_type']);
-			$messenger-&gt;reset();
-
-			$messenger-&gt;save_queue();
-		}
-		else
-		{
-			// Use messenger for getting the correct message, we use the email template
-			$messenger-&gt;template($email_template, $notify_row['lang']);
-			
-			$messenger-&gt;assign_vars(array(
-				'EMAIL_SIG'		=&gt; $email_sig,
-				'SITENAME'		=&gt; $config['sitename'],
-				'USERNAME'		=&gt; $notify_row['name'],
-				'SUBJECT'		=&gt; $report_data['subject'],
-				'REPORTER'		=&gt; $report_data['reporter'],
-
-				'REPORT_REASON'	=&gt; $report_data['reason'],
-				'REPORT_TEXT'	=&gt; $report_data['text'],
-
-				'U_VIEW_REPORT'	=&gt; generate_board_url() . '/' . $view_report_url)
-			);
-
-			// break the sending process...
-			$messenger-&gt;send(false, true);
-			$messenger-&gt;reset();
-			
-			// do not put in reporters outbox
-			submit_pm('post', $report_data['subject'], '', array(), array(), array(
-				'address_list'	=&gt; array('u' =&gt; array($user_id =&gt; 'to')),
-				'icon_id'		=&gt; 0,
-				'enable_bbcode' 	=&gt; 0,
-				'enable_html' 		=&gt; 0,
-				'enable_smilies' 	=&gt; 0,
-				'enable_magic_url' 	=&gt; 1,
-				'enable_sig' 		=&gt; 0,
-				'message_md5'		=&gt; md5($messenger-&gt;msg),
-				'bbcode_bitfield'	=&gt; 0,
-				'bbcode_uid'		=&gt; 0,
-				'attachment_data'	=&gt; array(),
-				'filename_data'		=&gt; array(),
-				'message'			=&gt; $messenger-&gt;msg				
-				), true, false);
-		}
-	}
-	unset($messenger);
-}
-
+&lt;?php
+/** 
+*
+* @package phpBB3
+* @version $Id: report.php,v 1.31 2006/06/14 18:59:11 naderman Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license <A HREF="http://opensource.org/licenses/gpl-license.php">http://opensource.org/licenses/gpl-license.php</A> GNU Public License 
+*
+*/
+
+/**
+* @ignore
+*/
+define('IN_PHPBB', true);
+$phpbb_root_path = './';
+$phpEx = substr(strrchr(__FILE__, '.'), 1);
+include($phpbb_root_path . 'common.' . $phpEx);
+include($phpbb_root_path . 'includes/functions_display.' . $phpEx);
+
+// Start session management
+$user-&gt;session_begin();
+$auth-&gt;acl($user-&gt;data);
+$user-&gt;setup('mcp');
+
+$forum_id = request_var('f', 0);
+$post_id = request_var('p', 0);
+$reason_id = request_var('reason_id', 0);
+$report_text = request_var('report_text', '', true);
+$user_notify = (isset($_POST['notify']) &amp;&amp; $user-&gt;data['is_registered']) ? true : false;
+$submit = (isset($_POST['submit'])) ? true : false;
+
+if (!$post_id)
+{
+	trigger_error('INVALID_MODE');
+}
+
+$redirect_url = append_sid(&quot;{$phpbb_root_path}viewtopic.$phpEx&quot;, &quot;f=$forum_id&amp;p=$post_id&quot;) . &quot;#p$post_id&quot;;
+
+// Has the report been cancelled?
+if (isset($_POST['cancel']))
+{
+	redirect($redirect_url);
+}
+
+// Grab all relevant data
+$sql = 'SELECT t.*, p.*
+	FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . &quot; t
+	WHERE p.post_id = $post_id
+		AND p.topic_id = t.topic_id&quot;;
+$result = $db-&gt;sql_query($sql);
+$report_data = $db-&gt;sql_fetchrow($result);
+$db-&gt;sql_freeresult($result);
+
+if (!$report_data)
+{
+	trigger_error('POST_NOT_EXIST');
+}
+
+$forum_id = (int) ($report_data['forum_id']) ? $report_data['forum_id'] : $forum_id;
+$topic_id = (int) $report_data['topic_id'];
+
+$sql = 'SELECT *
+	FROM ' . FORUMS_TABLE . '
+	WHERE forum_id = ' . $forum_id;
+$result = $db-&gt;sql_query($sql);
+$forum_data = $db-&gt;sql_fetchrow($result);
+
+if (!$forum_data)
+{
+	trigger_error('FORUM_NOT_EXIST');
+}
+
+// Check required permissions
+$acl_check_ary = array('f_list' =&gt; 'POST_NOT_EXIST', 'f_read' =&gt; 'USER_CANNOT_READ', 'f_report' =&gt; 'USER_CANNOT_REPORT');
+
+foreach ($acl_check_ary as $acl =&gt; $error)
+{
+	if (!$auth-&gt;acl_get($acl, $forum_id))
+	{
+		trigger_error($error);
+	}
+}
+unset($acl_check_ary);
+
+if ($report_data['post_reported'])
+{
+	$message = $user-&gt;lang['ALREADY_REPORTED'];
+	$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($user-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;');
+	trigger_error($message);
+}
+
+// Submit report?
+if ($submit &amp;&amp; $reason_id)
+{
+	$sql = 'SELECT *
+		FROM ' . REPORTS_REASONS_TABLE . &quot;
+		WHERE reason_id = $reason_id&quot;;
+	$result = $db-&gt;sql_query($sql);
+	$row = $db-&gt;sql_fetchrow($result);
+	$db-&gt;sql_freeresult($result);
+
+	if (!$row || (!$report_text &amp;&amp; $row['reason_title'] == 'other'))
+	{
+		trigger_error('EMPTY_REPORT');
+	}
+
+	$sql_ary = array(
+		'reason_id'		=&gt; (int) $reason_id,
+		'post_id'		=&gt; $post_id,
+		'user_id'		=&gt; (int) $user-&gt;data['user_id'],
+		'user_notify'	=&gt; (int) $user_notify,
+		'report_closed'	=&gt; 0,
+		'report_time'	=&gt; (int) time(),
+		'report_text'	=&gt; (string) $report_text
+	);
+
+	$sql = 'INSERT INTO ' . REPORTS_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $sql_ary);
+	$db-&gt;sql_query($sql);
+	$report_id = $db-&gt;sql_nextid();
+
+	if (!$report_data['post_reported'])
+	{
+		$sql = 'UPDATE ' . POSTS_TABLE . '
+			SET post_reported = 1
+			WHERE post_id = ' . $post_id;
+		$db-&gt;sql_query($sql);
+	}
+
+	if (!$report_data['topic_reported'])
+	{
+		$sql = 'UPDATE ' . TOPICS_TABLE . '
+			SET topic_reported = 1
+			WHERE topic_id = ' . $report_data['topic_id'];
+		$db-&gt;sql_query($sql);
+	}
+
+	meta_refresh(3, $redirect_url);
+
+	$message = $user-&gt;lang['POST_REPORTED_SUCCESS'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($user-&gt;lang['RETURN_TOPIC'], '&lt;a href=&quot;' . $redirect_url . '&quot;&gt;', '&lt;/a&gt;');
+	trigger_error($message);
+}
+
+// Generate the reasons
+display_reasons($reason_id);
+
+$template-&gt;assign_vars(array(
+	'REPORT_TEXT'		=&gt; $report_text,
+	'S_REPORT_ACTION'	=&gt; append_sid(&quot;{$phpbb_root_path}report.$phpEx&quot;, 'f=' . $forum_id . '&amp;p=' . $post_id),
+
+	'S_NOTIFY'			=&gt; $user_notify,
+	'S_CAN_NOTIFY'		=&gt; ($user-&gt;data['is_registered']) ? true : false)
+);
+
+generate_forum_nav($forum_data);
+
+// Start output of page
+page_header($user-&gt;lang['REPORT_POST']);
+
+$template-&gt;set_filenames(array(
+	'body' =&gt; 'report_body.html')
+);
+
+page_footer();
+
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/modules/forums/search.php
===================================================================
--- cms/trunk/modules/forums/search.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/search.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -1,1004 +0,0 @@
-&lt;?php
-/*
-||**************************************************************||
-||  Viperal CMS &#194;&#169; :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
-||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
-||																||
-||**************************************************************||
-||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-// -------------------------------------------------------------
-//
-// $Id: search.php,v 1.108 2004/10/19 19:20:30 acydburn Exp $
-//
-// FILENAME  : search.php 
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//TODO
-//Introduce phrase searching?
-//Stemmers?
-//Find similar?
-//Relevancy?
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-$_CLASS['core_user']-&gt;add_lang('search');
-$_CLASS['core_user']-&gt;add_img();
-
-// Is user able to search? Has search been disabled?
-//!$_CLASS['auth']-&gt;acl_get('u_search') 
-if ($_CLASS['core_user']-&gt;is_bot || !$config['load_search'])
-{
-	trigger_error('NO_SEARCH');
-}
-
-// Define initial vars
-$mode				= request_var('mode', '');
-$search_id			= request_var('search_id', '');
-$search_session_id 	= request_var('search_session_id', 0);
-$start				= request_var('start', 0);
-$post_id			= request_var('p', 0);
-$view				= request_var('view', '');
-
-$search_keywords	= request_var('search_keywords', '');
-$search_author		= request_var('search_author', '');
-$show_results		= request_var('show_results', 'posts');
-$search_terms		= request_var('search_terms', 'all');
-$search_fields		= request_var('search_fields', 'all');
-$search_child		= request_var('search_child', true);
-
-$return_chars	= request_var('return_chars', 200);
-$search_forum	= request_var('search_forum', array(0));
-
-$sort_days	= request_var('st', 0);
-$sort_key	= request_var('sk', 't');
-$sort_dir	= request_var('sd', 'd');
-
-// Define some vars
-$limit_days		= array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_RESULTS'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
-$sort_by_text	= array('a' =&gt; $_CLASS['core_user']-&gt;lang['SORT_AUTHOR'], 't' =&gt; $_CLASS['core_user']-&gt;lang['SORT_TIME'], 'f' =&gt; $_CLASS['core_user']-&gt;lang['SORT_FORUM'], 'i' =&gt; $_CLASS['core_user']-&gt;lang['SORT_TOPIC_TITLE'], 's' =&gt; $_CLASS['core_user']-&gt;lang['SORT_POST_SUBJECT']);
-
-$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
-gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
-
-$store_vars		= array('sort_key', 'sort_dir', 'sort_days', 'show_results', 'return_chars', 'total_match_count');
-$current_time	= $_CLASS['core_user']-&gt;time;
-$stopped_words	= array();
-
-// Check last search time ... if applicable
-if ($config['search_interval'])
-{
-	$sql = 'SELECT MAX(search_time) as last_time
-		FROM ' . FORUMS_SEARCH_TABLE.&quot;
-			WHERE session_id = '&quot; . $_CLASS['core_db']-&gt;escape($_CLASS['core_user']-&gt;data['session_id']) . &quot;'&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if ($row['last_time'] &gt; $_CLASS['core_user']-&gt;time - $config['search_interval'])
-		{
-			trigger_error('NO_SEARCH_TIME');
-		}
-	}
-}
-
-if ($search_keywords || $search_author || $search_id || $search_session_id)
-{
-	$post_id_ary = $split_words = $old_split_words = $common_words = array();
-
-	$permission_array = array_keys($_CLASS['auth']-&gt;acl_getf('f_read'));
-
-	if (!empty($search_forum))
-	{
-		$search_forum = array_unique($search_forum);
-		$difference = array_diff($search_forum, $permission_array);
-
-		// I'm sure theres a better way to do this, but it's close to midnight
-		if (!empty($difference))
-		{
-			$count = count($search_forum);
-			
-			for ($i = 0; $i &lt; $count; $i++)
-			{
-				if (!in_array($search_forum[$i], $difference))
-				{
-					$temp[] = $search_forum[$i];
-				}
-			}
-			$search_forum = $temp;
-
-			unset($temp);
-		}
-	}
-	else
-	{
-		$search_forum =&amp; $permission_array;
-	}
-
-	if (empty($search_forum))
-	{
-		trigger_error('NO_SEARCH_RESULTS');
-	}
-
-// This should be only intergers
-	$sql_forums = ' AND p.forum_id IN (' . implode(', ', $search_forum) . ')';
-
-	unset($search_forum, $permission_array);
-
-	if ($search_id === 'egosearch')
-	{
-		$search_author = $_CLASS['core_user']-&gt;data['username'];
-	}
-
-	// Are we looking for a user?
-	$sql_author = '';
-
-	if ($search_author)
-	{
-		$sql_where = (mb_strpos($search_author, '*') !== false) ? ' LIKE ' : ' = ';
-
-		$sql = 'SELECT user_id 
-			FROM ' . USERS_TABLE . &quot;
-			WHERE username $sql_where '&quot; . $_CLASS['core_db']-&gt;escape(preg_replace('#\*+#', '%', $search_author)) . &quot;'
-				AND user_type = &quot; . USER_NORMAL;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		
-		
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$sql_author[] = $row['user_id'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (empty($sql_author))
-		{
-			trigger_error('NO_SEARCH_RESULTS');
-		}
-
-		$sql_author = (count($sql_author) == 1) ?  ' p.poster_id = ' . $sql_author[0] : ' p.poster_id IN (' . implode(', ', $sql_author) . ')';
-	}
-
-	if ($search_id)
-	{
-		switch ($search_id)
-		{
-			// Oh holy Bob, bring us some activity...
-			case 'active_topics':
-				$show_results = 'topics';
-
-				if (!$sort_days)
-				{
-					$sort_days = 1;
-					gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
-				}
-
-				$last_post_time = ($_CLASS['core_user']-&gt;time - ($sort_days * 24 * 3600));
-
-				$sql = 'SELECT DISTINCT t.topic_id, t.topic_last_post_time
-					FROM ' . FORUMS_POSTS_TABLE . ' p
-					LEFT JOIN ' . FORUMS_TOPICS_TABLE . &quot; t ON (t.topic_approved = 1 AND p.topic_id = t.topic_id)
-					WHERE p.post_time &gt; $last_post_time
-						$sql_forums
-					ORDER BY t.topic_last_post_time DESC&quot;;
-				$result = $_CLASS['core_db']-&gt;query_limit($sql, 1000);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$post_id_ary[] = $row['topic_id'];
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-				
-				if (empty($post_id_ary))
-				{
-					trigger_error('NO_SEARCH_RESULTS');
-				}
-			break;
-				
-			case 'egosearch':
-			break;
-
-			case 'unanswered':
-				if ($show_results == 'posts')
-				{
-					$sql = 'SELECT p.post_id 
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . &quot; t 
-						WHERE t.topic_replies = 0
-							AND p.topic_id = t.topic_id
-							$sql_forums&quot;;
-					$field = 'post_id';
-				}
-				else
-				{
-					$sql = 'SELECT t.topic_id 
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . &quot; t 
-						WHERE t.topic_replies = 0 
-							AND p.topic_id = t.topic_id
-							$sql_forums
-						GROUP BY p.topic_id&quot;;
-					$field = 'topic_id';
-				}
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$post_id_ary[] = $row[$field];
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				if (empty($post_id_ary))
-				{
-					trigger_error('NO_SEARCH_RESULTS');
-				}
-			break;
-
-			case 'newposts':
-				if ($show_results == 'posts')
-				{
-					$sql = 'SELECT p.post_id 
-						FROM ' . FORUMS_POSTS_TABLE . ' p 
-						WHERE p.post_time &gt; ' . $_CLASS['core_user']-&gt;data['user_last_visit'] . &quot;
-							$sql_forums&quot;;
-					$field = 'post_id';
-				}
-				else
-				{
-					$sql = 'SELECT t.topic_id
-						FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . ' p 
-						WHERE p.post_time &gt; ' . $_CLASS['core_user']-&gt;data['user_last_visit'] . &quot; 
-							AND t.topic_id = p.topic_id 
-							$sql_forums 
-						GROUP by p.topic_id&quot;;
-					$field = 'topic_id';
-				}
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$post_id_ary[] = $row[$field];
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				if (empty($post_id_ary))
-				{
-					trigger_error('NO_SEARCH_RESULTS');
-				}
-			break;
-		}
-	}
-	
-	if ($search_session_id)
-	{
-		$sql = 'SELECT search_array
-			FROM ' . FORUMS_SEARCH_TABLE . &quot;
-			WHERE search_id = $search_session_id
-				AND session_id = '&quot; . $_CLASS['core_db']-&gt;escape($_CLASS['core_user']-&gt;data['session_id']) . &quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if ($row)
-		{
-			$data = explode('#', $row['search_array']);
-
-			$split_words = unserialize(array_shift($data));
-
-			if ($search_keywords)
-			{
-				// If we're wanting to search on these results we store the existing split word array
-				$old_split_words = $split_words;
-			}
-
-			$stopped_words = unserialize(array_shift($data));
-
-			foreach ($store_vars as $var)
-			{
-				$$var = array_shift($data);
-			}
-
-			$sql_where = (($show_results == 'posts') ? 'p.post_id' : 't.topic_id') . ' IN (' . implode(', ', $data) . ')';
-			unset($data);
-		}
-		else
-		{
-			$search_session_id = false;
-		}
-	}
-
-	// Are we looking for words
-	if ($search_keywords)
-	{
-		$sql_author = ($sql_author) ? ' AND ' . $sql_author : '';
-
-		$split_words = $stopped_words = $smllrg_words = array();
-		$drop_char_match =   array('-', '^', '$', ';', '#', '&amp;', '(', ')', '&lt;', '&gt;', '`', '\'', '&quot;', '|', ',', '@', '_', '?', '%', '~', '.', '[', ']', '{', '}', ':', '\\', '/', '=', '\'', '!', '*');
-		$drop_char_replace = array(' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '',  '',   ' ', ' ', ' ', ' ', '',  ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', '' ,  ' ', ' ', ' ',  ' ', ' ');
-
-		if ($fp = @fopen($_CLASS['core_user']-&gt;lang_path . '/search_stopwords.txt', 'rb'))
-		{
-			$stopwords = explode(&quot;\n&quot;, str_replace(&quot;\r\n&quot;, &quot;\n&quot;, fread($fp, filesize($_CLASS['core_user']-&gt;lang_path . '/search_stopwords.txt'))));
-		}
-		fclose($fp);
-
-		if ($fp = @fopen($_CLASS['core_user']-&gt;lang_path . '/search_synonyms.txt', 'rb'))
-		{
-			preg_match_all('#^(.*?) (.*?)$#ms', fread($fp, filesize($_CLASS['core_user']-&gt;lang_path . '/search_synonyms.txt')), $match);
-			
-			$replace_synonym = $match[1];
-			$match_synonym = $match[2];
-		}
-		fclose($fp);
-
-		$match		= array('#\sand\s#i', '#\sor\s#i', '#\snot\s#i', '#\+#', '#-#', '#\|#');
-		$replace	= array(' + ',        ' | ',       ' - ',        ' + ',  ' - ', ' | ');
-
-		$search_keywords = preg_replace($match, $replace, $search_keywords);
-
-		$match = array();
-		// Comments for hardcoded bbcode elements (urls, smilies, html)
-		$match[] = '#&lt;!\-\- .* \-\-&gt;(.*?)&lt;!\-\- .* \-\-&gt;#is';
-		// New lines, carriage returns
-		$match[] = &quot;#[\n\r]+#&quot;;
-		// NCRs like &nbsp; etc.
-		$match[] = '#(&amp;|&amp;)[\#a-z0-9]+?;#i';
-		// BBcode
-		$match[] = '#\[\/?[a-z\*\+\-]+(=.*)?(\:?[0-9a-z]{5,})\]#';
-
-		// Filter out as above
-		$search_keywords = preg_replace($match, ' ', strtolower(trim($search_keywords)));
-		$search_keywords = str_replace($drop_char_match, $drop_char_replace, $search_keywords);
-
-		// Split words
-		$split_words = explode(' ', preg_replace('#\s+#', ' ', $search_keywords));
-
-		if (sizeof($stopwords))
-		{
-			$stopped_words = array_intersect($split_words, $stopwords);
-			$split_words = array_diff($split_words, $stopwords);
-		}
-
-		if (sizeof($replace_synonym))
-		{
-			$split_words = str_replace($replace_synonym, $match_synonym, $split_words);
-		}
-	}
-
-	if (!empty($old_split_words))
-	{
-		$split_words = !empty($split_words) ? array_diff($split_words, $old_split_words) : $old_split_words;
-	}
-
-	if (!empty($split_words))
-	{
-		// This &quot;entire&quot; section may be switched out to allow for alternative search systems
-		// such as that built-in to MySQL, MSSQL, etc. or external solutions which provide
-		// an appropriate API
-
-		$bool = ($search_terms == 'all') ? 'AND' : 'OR';
-		$sql_words = '';
-
-		foreach ($split_words as $word)
-		{
-			switch ($word)
-			{
-				case '-':
-					$bool = 'NOT';
-				break;
-
-				case '+':
-					$bool = 'AND';
-				break;
-
-				case '|':
-					$bool = 'OR';
-				break;
-
-				default:
-					$bool = ($search_terms != 'all') ? 'OR' : $bool;
-					$sql_words[$bool][] = &quot;'&quot; . preg_replace('#\*+#', '%', trim($word)) . &quot;'&quot;;
-					$bool = ($search_terms == 'all') ? 'AND' : 'OR';
-				break;
-			}
-		}
-
-		switch ($search_fields)
-		{
-			case 'titleonly':
-				$sql_match = ' AND m.title_match = 1';
-				break;
-			case 'msgonly':
-				$sql_match = ' AND m.title_match = 0';
-				break;
-			default:
-				$sql_match = '';
-		}
-
-		// Build some display specific variable strings
-		$sql_select = ($show_results == 'posts') ? 'm.post_id' : 'DISTINCT t.topic_id';
-		$sql_from = ($show_results == 'posts') ? '' : FORUMS_TOPICS_TABLE . ' t, ';
-		$sql_topic = ($show_results == 'posts') ? '' : 'AND t.topic_id = p.topic_id';
-		$sql_time = ($sort_days) ? 'AND p.post_time &gt;= ' . ($current_time - ($sort_days * 86400)) : '';
-		$field = ($show_results == 'posts') ? 'm.post_id' : 't.topic_id';
-
-		// Are we searching within an existing search set? Yes, then include the old ids
-		//$sql_find_in = ($sql_where) ? &quot;AND $sql_where&quot; : '';
-		$sql_find_in = '';
-
-		$result_ary = array();
-		foreach (array('AND', 'OR', 'NOT') as $bool)
-		{
-			if (isset($sql_words[$bool]) &amp;&amp; is_array($sql_words[$bool]))
-			{
-				switch ($bool)
-				{
-					case 'AND':
-					case 'NOT':
-						foreach ($sql_words[$bool] as $word)
-						{
-							if (strlen($word) &lt; 4)
-							{
-								continue;
-							}
-
-							$sql_where = (strstr($word, '%')) ? &quot;LIKE $word&quot; : &quot;= $word&quot;;
-
-							$sql_and = (isset($result_ary['AND']) &amp;&amp; sizeof($result_ary['AND'])) ? &quot;AND $field IN (&quot; . implode(', ', $result_ary['AND']) . ')' : '';
-
-							$sql = &quot;SELECT $sql_select 
-								FROM $sql_from&quot; . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_SEARCH_MATCH_TABLE . ' m, ' . FORUMS_SEARCH_WORD_TABLE . &quot; w 
-								WHERE w.word_text $sql_where 
-									AND m.word_id = w.word_id 
-									AND w.word_common &lt;&gt; 1 
-									AND p.post_id = m.post_id
-									$sql_topic 
-									$sql_forums 
-									$sql_author 
-									$sql_and 
-									$sql_time 
-									$sql_match
-									$sql_find_in&quot;;
-							$result = $_CLASS['core_db']-&gt;query($sql);
-
-							if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) &amp;&amp; $bool == 'AND')
-							{
-								trigger_error('NO_SEARCH_RESULTS');
-							}
-
-							if ($bool == 'AND')
-							{
-								$result_ary['AND'] = array();
-							}
-
-							do
-							{
-								$result_ary[$bool][] = ($show_results == 'topics') ? $row['topic_id'] : $row['post_id'];
-							}
-							while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-							$_CLASS['core_db']-&gt;free_result($result);
-						}
-						break;
-
-					case 'OR':
-						$sql_where = $sql_in = '';
-						foreach ($sql_words[$bool] as $word)
-						{
-							if (strlen($word) &lt; 4)
-							{
-								continue;
-							}
-
-							if (strstr($word, '%'))
-							{
-								$sql_where .= (($sql_where) ? ' OR w.word_text ' : 'w.word_text ') . &quot;LIKE $word&quot;;
-							}
-							else
-							{
-								$sql_in .= (($sql_in) ? ', ' : '') . $word;
-							}
-						}
-						$sql_where = ($sql_in) ? (($sql_where) ? ' OR ' : '') . 'w.word_text IN (' . $sql_in . ')' : $sql_where;
-
-						$sql_and = (sizeof($result_ary['AND'])) ? &quot;AND $field IN (&quot; . implode(', ', $result_ary['AND']) . ')' : '';
-						$sql = &quot;SELECT $sql_select 
-							FROM $sql_from&quot; . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_SEARCH_MATCH_TABLE . ' m, ' . FORUMS_SEARCH_WORD_TABLE . &quot; w 
-							WHERE ($sql_where) 
-								AND m.word_id = w.word_id 
-								AND w.word_common &lt;&gt; 1 
-								AND p.post_id = m.post_id
-								$sql_topic 
-								$sql_forums 
-								$sql_author 
-								$sql_and 
-								$sql_time 
-								$sql_match 
-								$sql_find_in&quot;;
-						$result = $_CLASS['core_db']-&gt;query($sql);
-
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-						{
-							$result_ary[$bool][] = ($show_results == 'topics') ? $row['topic_id'] : $row['post_id'];
-						}
-						$_CLASS['core_db']-&gt;free_result($result);
-						break;
-				}
-			}
-			else
-			{
-				$sql_words[$bool] = array();
-			}
-		}
-
-		if (isset($result_ary['OR']) &amp;&amp; sizeof($result_ary['OR']))
-		{
-			$post_id_ary = (isset($result_ary['AND']) &amp;&amp; sizeof($result_ary['AND'])) ? array_diff($result_ary['AND'], $result_ary['OR']) : $result_ary['OR'];
-		}
-		else
-		{
-			$post_id_ary = (isset($result_ary['AND'])) ? $result_ary['AND'] : array();
-		}
-
-		if (isset($result_ary['NOT']) &amp;&amp; sizeof($result_ary['NOT']))
-		{
-			$post_id_ary = (sizeof($post_id_ary)) ? array_diff($post_id_ary, $result_ary['NOT']) : array();
-		}
-		unset($result_ary);
-
-		$post_id_ary = array_unique($post_id_ary);
-
-
-		if (!sizeof($post_id_ary))
-		{
-			trigger_error('NO_SEARCH_RESULTS');
-		}
-
-		$sql = 'SELECT word_text 
-			FROM ' . FORUMS_SEARCH_WORD_TABLE . ' 
-			WHERE word_text IN (' . implode(', ', array_unique(array_merge($sql_words['AND'], $sql_words['OR'], $sql_words['NOT']))) . ')
-				AND word_common = 1';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$common_words[] = $row['word_text'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-	elseif ($search_author)
-	{
-		if ($show_results === 'posts')
-		{
-			$sql = 'SELECT p.post_id 
-				FROM ' . FORUMS_POSTS_TABLE . &quot; p 
-				WHERE $sql_author 
-					$sql_forums&quot;;
-			$field = 'post_id';
-		}
-		else
-		{
-			$sql = 'SELECT t.topic_id 
-				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . &quot; p 
-				WHERE $sql_author
-					$sql_forums
-					AND t.topic_id = p.topic_id 
-				GROUP BY t.topic_id&quot;;
-			$field = 'topic_id';
-		}
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$post_id_ary[] = $row[$field];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	if (!empty($post_id_ary))
-	{
-/*
- Make uses of autoinsert for search_id
- also rethink the why this is done, storing things more then one shouldn't be needed
-*/
-		$sql = 'SELECT session_id
-			FROM ' . SESSIONS_TABLE .&quot;
-			WHERE session_id &lt;&gt; '&quot; . $_CLASS['core_user']-&gt;data['session_id'] . &quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$delete_search_ids = array();
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$delete_search_ids[] = &quot;'&quot; . $_CLASS['core_db']-&gt;escape($row['session_id']) . &quot;'&quot;;
-		}
-
-		if (empty($delete_search_ids))
-		{
-			$_CLASS['core_db']-&gt;query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
-		}
-		else
-		{
-			$sql = 'DELETE FROM ' . FORUMS_SEARCH_TABLE . '
-				WHERE session_id NOT IN (' . implode(', ', $delete_search_ids) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		unset($delete_search_ids);
-
-		$total_match_count = count($post_id_ary);
-
-		$sql_where = (($show_results === 'posts') ? 'p.post_id' : 't.topic_id') . ' IN (' . implode(', ', $post_id_ary) . ')';
-
-		if (!empty($old_split_words) &amp;&amp; array_diff($split_words, $old_split_words))
-		{
-			$split_words = array_merge($split_words, $old_split_words);
-		}
-
-		$data = serialize(array_diff($split_words, $common_words));
-		$data .= '#' . serialize(array_merge($stopped_words, $common_words));
-
-		foreach ($store_vars as $var)
-		{
-			$data .= '#' . $$var;
-		}
-
-		$data .= '#' . implode('#', $post_id_ary);
-		unset($post_id_ary);
-
-		$search_session_id = rand();
-
-		$sql_ary = array(
-			'search_id'		=&gt; $search_session_id,
-			'session_id'	=&gt; $_CLASS['core_user']-&gt;data['session_id'],
-			'search_time'	=&gt; $current_time,
-			'search_array'	=&gt; $data
-		);
-
-		$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_SEARCH_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
-		unset($data);
-	}
-
-	if ($show_results === 'posts')
-	{
-		require($site_file_root.'includes/forums/functions_posting.php');
-	}
-	else
-	{
-		require($site_file_root.'includes/forums/functions_display.php');
-	}
-
-	// Look up data ...
-	$per_page = ($show_results === 'posts') ? $config['posts_per_page'] : $config['topics_per_page'];
-
-	// Grab icons
-	$icons = obtain_icons();
-
-	// Output header
-	$l_search_matches = ($total_match_count == 1) ? sprintf($_CLASS['core_user']-&gt;lang['FOUND_SEARCH_MATCH'], $total_match_count) : sprintf($_CLASS['core_user']-&gt;lang['FOUND_SEARCH_MATCHES'], $total_match_count);
-
-	$hilit = htmlspecialchars(implode('|', str_replace(array('+', '-', '|'), '', $split_words)));
-
-	$split_words = htmlspecialchars(implode(' ', $split_words));
-	$ignored_words = htmlspecialchars(implode(' ', $stopped_words));
-
-	$pagination = generate_pagination(&quot;Forums&amp;file=search&amp;search_session_id=$search_session_id&amp;search_id=$search_id&amp;hilit=$hilit&amp;$u_sort_param&quot;, $total_match_count, $per_page, $start);
-
-	$_CLASS['core_template']-&gt;assign_array(array(
-		'SEARCH_MATCHES'	=&gt; $l_search_matches,
-		'SEARCH_WORDS'		=&gt; $split_words, 
-		'IGNORED_WORDS'		=&gt; ($ignored_words) ? $ignored_words : '', 
-		'PAGINATION'		=&gt; $pagination['formated'],
-		'PAGINATION_ARRAY'	=&gt; $pagination['array'],
-		'PAGE_NUMBER'		=&gt; on_page($total_match_count, $per_page, $start),
-		'TOTAL_MATCHES'		=&gt; $total_match_count,
-
-		'S_SELECT_SORT_DIR'		=&gt; $s_sort_dir,
-		'S_SELECT_SORT_KEY'		=&gt; $s_sort_key,
-		'S_SELECT_SORT_DAYS'	=&gt; $s_limit_days,
-
-		'S_SEARCH_ACTION'		=&gt; generate_link('Forums&amp;file=search&amp;search_id='.$search_id),
-		'S_SHOW_TOPICS'			=&gt; ($show_results == 'posts') ? false : true,
-
-		'REPORTED_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_reported', 'TOPIC_REPORTED'),
-		'UNAPPROVED_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_unapproved', 'TOPIC_UNAPPROVED'),
-		'GOTO_PAGE_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_post', 'GOTO_PAGE'),
-
-		'U_SEARCH_WORDS'	=&gt; generate_link(&quot;Forums&amp;file=&amp;show_results=$show_results&amp;search_keywords=&quot; . urlencode($split_words)))
-	);
-
-	$u_hilit = urlencode($split_words);
-
-	// Define ordering sql field, do it here because the order may be defined
-	// within an existing search result set
-	$sort_by_sql	= array('a' =&gt; (($show_results == 'posts') ? 'u.username' : 't.topic_poster'), 't' =&gt; (($show_results == 'posts') ? 'p.post_time' : 't.topic_last_post_time'), 'f' =&gt; 'f.forum_id', 'i' =&gt; 't.topic_title', 's' =&gt; (($show_results == 'posts') ? 'pt.post_subject' : 't.topic_title'));
-
-	if ($sql_where)
-	{
-		if ($show_results == 'posts')
-		{
-			// Not joining this query to the one below at present ... may do in future
-			$sql = 'SELECT zebra_id, friend, foe
-				FROM ' . ZEBRA_TABLE . ' 
-				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-			$result = $_CLASS['core_db']-&gt;query($sql);
-	
-			$zebra = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$zebra[($row['friend']) ? 'friend' : 'foe'][] = $row['zebra_id'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-	
-			$sql = 'SELECT p.*, f.forum_id, f.forum_name, t.*, u.username, u.user_sig, u.user_sig_bbcode_uid
-				FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u, ' . FORUMS_POSTS_TABLE . &quot; p 
-				WHERE $sql_where 
-					AND f.forum_id = p.forum_id
-					AND p.topic_id = t.topic_id
-					AND p.poster_id = u.user_id&quot;;
-		}
-		else
-		{
-			$sql = 'SELECT t.*, f.forum_id, f.forum_name
-				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . &quot; f 
-				WHERE $sql_where 
-					AND f.forum_id = t.forum_id&quot;;
-		}
-
-		$sql .= ' ORDER BY ' . $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, $per_page, $start);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$forum_id = $row['forum_id'];
-			$topic_id = $row['topic_id'];
-	
-			$view_topic_url = &quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;hilit=$u_hilit&quot;;
-	
-			if ($show_results === 'topics')
-			{
-				$replies = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
-	
-				$folder_img = $unread_topic = $folder_alt = $topic_type = '';
-				topic_status($row, $replies, $_CLASS['core_user']-&gt;time, $unread_topic, $folder_img, $folder_alt, $topic_type);
-
-				$pagination = generate_pagination($view_topic_url, $replies, $config['posts_per_page'], 0);
-
-				$tpl_ary = array(
-					'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
-					'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
-					'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
-					'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
-					'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
-					'PAGINATION'		=&gt; $pagination['formated'],
-					'PAGINATION_ARRAY'	=&gt; $pagination['array'],
-					'REPLIES' 			=&gt; $replies,
-					'VIEWS' 			=&gt; $row['topic_views'],
-					'TOPIC_TYPE' 		=&gt; $topic_type,
-	
-					'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
-					'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
-					'TOPIC_ICON_IMG'		=&gt; (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
-					'TOPIC_ICON_IMG_WIDTH'	=&gt; (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
-					'TOPIC_ICON_IMG_HEIGHT'	=&gt; (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
-					'ATTACH_ICON_IMG'       =&gt; ($_CLASS['auth']-&gt;acl_gets(array('f_download', 'u_download'), $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
-					'S_TOPIC_TYPE'			=&gt; $row['topic_type'],
-					'S_USER_POSTED'			=&gt; (!empty($row['mark_type'])) ? true : false,
-	
-					'S_TOPIC_REPORTED'		=&gt; (!empty($row['topic_reported']) &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_', $forum_id)) ? true : false,
-					'S_TOPIC_UNAPPROVED'	=&gt; (!$row['topic_approved'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? true : false,
-					'S_IGNORE_POST'			=&gt; false,
-
-					'U_LAST_POST'		=&gt; generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false),
-					'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] != ANONYMOUS &amp;&amp; $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-					'U_MCP_REPORT'		=&gt; generate_link('Forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
-					'U_MCP_QUEUE'		=&gt; generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id)
-				);
-			}
-			else
-			{
-				if ((isset($zebra['foe']) &amp;&amp; in_array($row['poster_id'], $zebra['foe'])) &amp;&amp; (!$view || $view != 'show' || $post_id != $row['post_id']))
-				{
-					$_CLASS['core_template']-&gt;assign_vars_array('searchresults', array(
-						'S_IGNORE_POST' =&gt; true, 
-						'L_IGNORE_POST' =&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_BY_FOE'], $row['username'], '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=search&amp;search_session_id=$search_session_id&amp;$u_sort_param&amp;p=&quot; . $row['post_id'] . '&amp;view=show#' . $row['post_id']) . '&quot;&gt;', '&lt;/a&gt;'))
-					);
-	
-					continue;
-				}
-
-				if ($row['enable_html'])
-				{
-					$row['post_text'] = preg_replace('#(&lt;!\-\- h \-\-&gt;&lt;)([\/]?.*?)(&gt;&lt;!\-\- h \-\-&gt;)#is', &quot;&lt;\\2&gt;&quot;, $row['post_text']);
-				}
-
-				$row['post_text'] = censor_text($row['post_text']);
-
-				decode_message($row['post_text'], $row['bbcode_uid']);
-
-				if ($return_chars)
-				{
-					$row['post_text'] = (strlen($row['post_text']) &lt; $return_chars + 3) ? $row['post_text'] : substr($row['post_text'], 0, $return_chars) . '...';
-				}
-
-				if ($hilit)
-				{
-					// This was shamelessly 'borrowed' from volker at multiartstudio dot de
-					// via php.net's annotated manual
-					$row['post_text'] = str_replace('\&quot;', '&quot;', substr(preg_replace('#(\&gt;(((?&gt;([^&gt;&lt;]+|(?R)))*)\&lt;))#se', &quot;preg_replace('#\b(&quot; . str_replace('\\', '\\\\', addslashes($hilit)) . &quot;)\b#i', '&lt;span class=\&quot;posthilit\&quot;&gt;\\\\1&lt;/span&gt;', '\\0')&quot;, '&gt;' .  $row['post_text'] . '&lt;'), 1, -1));
-				}
-
-				$row['post_text'] = smiley_text($row['post_text']);
-
-				// Replace naughty words such as farty pants
-				$row['post_subject'] = censor_text($row['post_subject']);
-				$row['post_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($row['post_text']));
-
-				$tpl_ary = array(
-					'POSTER_NAME'		=&gt; ($row['poster_id'] == ANONYMOUS) ? ((!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']-&gt;lang['GUEST']) : $row['username'], 
-					'POST_SUBJECT'		=&gt; censor_text($row['post_subject']), 
-					'POST_DATE'			=&gt; (!empty($row['post_time'])) ? $_CLASS['core_user']-&gt;format_date($row['post_time']) : '', 
-					'MESSAGE' 			=&gt; $row['post_text'],
-					'S_IGNORE_POST'		=&gt; false
-				);
-			}
-
-			$_CLASS['core_template']-&gt;assign_vars_array('searchresults', array_merge($tpl_ary, array(
-				'FORUM_ID' 			=&gt; $forum_id,
-				'TOPIC_ID' 			=&gt; $topic_id,
-				'POST_ID'			=&gt; ($show_results == 'posts') ? $row['post_id'] : false, 
-	
-				'FORUM_TITLE'		=&gt; $row['forum_name'], 
-				'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
-	
-				'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url),
-				'U_VIEW_FORUM'		=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id), 
-				'U_VIEW_POST'		=&gt; (!empty($row['post_id'])) ? generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=&quot; . $row['topic_id'] . '&amp;p=' . $row['post_id'] . '&amp;hilit=' . $u_hilit . '#' . $row['post_id'], false, false) : '')
-			));
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-	else
-	{
-		$_CLASS['core_template']-&gt;assign('S_NO_SEARCH_RESULTS', true);
-	}
-
-	page_header();
-	
-	make_jumpbox(generate_link('Forums&amp;file=viewforum'));
-	
-	$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;lang['SEARCH'], 'modules/Forums/search_results.html');
-}
-
-
-// Search forum
-$s_forums = '';
-
-if ($permission_array = $_CLASS['auth']-&gt;acl_getf('f_list'))
-{
-	$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id, forum_password
-		FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE forum_id IN (' . implode(', ', array_keys($permission_array)) . ')
-			ORDER BY left_id ASC';
-
-	$result = $_CLASS['core_db']-&gt;query($sql);
-	
-	$right = $cat_right = $padding_inc = 0;
-	$padding = $forum_list = $holding = '';
-	$pad_store = array('0' =&gt; '');
-	$search_forums = array();
-	
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if (($row['forum_type'] == FORUM_CAT &amp;&amp; ($row['left_id'] + 1 == $row['right_id'])) || $row['forum_type'] == FORUM_LINK || ($row['forum_password']))
-		{
-			continue;
-		}
-
-		if ($row['left_id'] &lt; $right)
-		{
-			$padding .= '&nbsp; &nbsp;';
-			$pad_store[$row['parent_id']] = $padding;
-		}
-		else if ($row['left_id'] &gt; $right + 1)
-		{
-			$padding = $pad_store[$row['parent_id']];
-		}
-
-		$right = $row['right_id'];
-
-		$selected = (empty($search_forums) || in_array($row['forum_id'], $search_forums)) ? ' selected=&quot;selected&quot;' : '';
-
-		if ($row['left_id'] &gt; $cat_right)
-		{
-			$holding = '';
-		}
-
-		if ($row['right_id'] - $row['left_id'] &gt; 1)
-		{
-			$cat_right = max($cat_right, $row['right_id']);
-	
-			$holding .= '&lt;option value=&quot;' . $row['forum_id'] . '&quot;' . $selected . '&gt;' . $padding . $row['forum_name'] . '&lt;/option&gt;';
-		}
-		else
-		{
-			$s_forums .= $holding . '&lt;option value=&quot;' . $row['forum_id'] . '&quot;' . $selected . '&gt;' . $padding . $row['forum_name'] . '&lt;/option&gt;';
-			$holding = '';
-		}
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-}
-unset($pad_store);
-
-// Number of chars returned
-$s_characters = '&lt;option value=&quot;-1&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_AVAILABLE'] . '&lt;/option&gt;';
-$s_characters .= '&lt;option value=&quot;0&quot;&gt;0&lt;/option&gt;';
-$s_characters .= '&lt;option value=&quot;25&quot;&gt;25&lt;/option&gt;';
-$s_characters .= '&lt;option value=&quot;50&quot;&gt;50&lt;/option&gt;';
-
-for($i = 100; $i &lt;= 1000 ; $i += 100)
-{
-	$selected = ($i == 200) ? ' selected=&quot;selected&quot;' : '';
-	$s_characters .= '&lt;option value=&quot;' . $i . '&quot;' . $selected . '&gt;' . $i . '&lt;/option&gt;';
-}
-
-$_CLASS['core_template']-&gt;assign_array(array(
-	'S_SEARCH_ACTION'		=&gt; generate_link('Forums&amp;file=search&amp;mode=results'),
-	'S_CHARACTER_OPTIONS'	=&gt; $s_characters,
-	'S_FORUM_OPTIONS'		=&gt; $s_forums,
-	'S_SELECT_SORT_DIR'		=&gt; $s_sort_dir,
-	'S_SELECT_SORT_KEY'		=&gt; $s_sort_key,
-	'S_SELECT_SORT_DAYS'	=&gt; $s_limit_days)
-);
-
-$sql = 'SELECT search_id, search_time, search_array 
-	FROM ' . FORUMS_SEARCH_TABLE . '
-	ORDER BY search_time DESC';
-$result = $_CLASS['core_db']-&gt;query_limit($sql, 5);
-
-while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-{
-	$data = explode('#', $row['search_array']);
-	$split_words = htmlspecialchars(implode(' ', unserialize(array_shift($data))));
-
-	if (!$split_words)
-	{
-		continue;
-	}
-
-	$stopped_words = htmlspecialchars(implode(' ', unserialize(array_shift($data))));
-
-	$_CLASS['core_template']-&gt;assign_vars_array('recentsearch', array(
-		'KEYWORDS'	=&gt; $split_words,
-		'TIME'		=&gt; $_CLASS['core_user']-&gt;format_date($row['search_time']), 
-
-		'U_KEYWORDS'	=&gt; generate_link('Forums&amp;file=search&amp;search_keywords=' . urlencode($split_words)))
-	);
-}
-$_CLASS['core_db']-&gt;free_result($result);
-
-unset($data, $split_words, $stopped_words);
-// Output the basic page
-
-page_header();
-
-make_jumpbox(generate_link('Forums&amp;file=viewforum'));
-
-$_CLASS['core_template']-&gt;display('modules/Forums/search_body.html');
- 
-?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-09-12 14:55:25 UTC (rev 187)
+++ cms/trunk/modules/forums/viewforum.php	2006-09-21 06:41:32 UTC (rev 188)
@@ -129,10 +129,10 @@
 }
 
 // Are we a forum link, then redirect
-if ($forum_data['forum_link'])
+if ($forum_data['forum_type'] == FORUM_LINK &amp;&amp; $forum_data['forum_link'])
 {
 	// Does it have click tracking enabled?
-	if ($forum_data['forum_flags'] &amp; 1)
+	if ($forum_data['forum_flags'] &amp; FORUM_FLAG_LINK_TRACK)
 	{
 		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 			SET forum_posts = forum_posts + 1 
@@ -167,6 +167,7 @@
 
 // Not postable forum or showing active topics?
 if (!($forum_data['forum_type'] == FORUM_POST || (($forum_data['forum_flags'] &amp; 16) &amp;&amp; $forum_data['forum_type'] == FORUM_CAT)))
+if (!($forum_data['forum_type'] == FORUM_POST || (($forum_data['forum_flags'] &amp; FORUM_FLAG_ACTIVE_TOPICS) &amp;&amp; $forum_data['forum_type'] == FORUM_CAT)))
 {
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'S_IS_POSTABLE'			=&gt; false,
@@ -282,7 +283,7 @@
 $post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']-&gt;lang['FORUM_LOCKED'] : $_CLASS['core_user']-&gt;lang['POST_NEW_TOPIC'];
 $pagination = generate_pagination(&quot;forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&quot;, $topics_count, $config['topics_per_page'], $start);
 
-$s_display_active = ($forum_data['forum_type'] == FORUM_CAT &amp;&amp; ($forum_data['forum_flags'] &amp; 16)) ? true : false;
+$s_display_active = ($forum_data['forum_type'] == FORUM_CAT &amp;&amp; ($forum_data['forum_flags'] &amp; FORUM_FLAG_ACTIVE_TOPICS)) ? true : false;
 
 $_CLASS['core_template']-&gt;assign_array(array(
 	'PAGINATION'		=&gt; $pagination['formated'],


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000106.html">[Viperals-svncheckins] r187 - in cms/trunk: . admin includes	includes/auth includes/forums includes/forums/admin	includes/forums/mcp includes/templates/admin/modules	includes/templates/modules/control_panel	includes/templates/modules/forums	includes/templates/modules/forums/admin install	javascript/forums modules/control_panel	modules/control_panel/modules modules/forums	modules/forums/admin modules/forums/images	modules/forums/images/admin modules/forums/images/en	modules/forums/language modules/members_list
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#107">[ date ]</a>
              <a href="thread.html#107">[ thread ]</a>
              <a href="subject.html#107">[ subject ]</a>
              <a href="author.html#107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
