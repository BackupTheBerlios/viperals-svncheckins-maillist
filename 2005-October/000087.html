<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r167%20-%20in%20cms/trunk/modules%3A%20articles%20contact%20control_panel%20forums%20members_list%20quick_message/quick_message2%20quick_message/quick_message2/language&In-Reply-To=%3C200510261933.j9QJX3vP006358%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000086.html">
   <LINK REL="Next"  HREF="000088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r167%20-%20in%20cms/trunk/modules%3A%20articles%20contact%20control_panel%20forums%20members_list%20quick_message/quick_message2%20quick_message/quick_message2/language&In-Reply-To=%3C200510261933.j9QJX3vP006358%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language">viperal at berlios.de
       </A><BR>
    <I>Wed Oct 26 21:33:03 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000086.html">[Viperals-svncheckins] r166 - in cms/trunk: includes/templates/modules modules modules/quick_message modules/quick_message/quick_message2
</A></li>
        <LI>Next message: <A HREF="000088.html">[Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87">[ date ]</a>
              <a href="thread.html#87">[ thread ]</a>
              <a href="subject.html#87">[ subject ]</a>
              <a href="author.html#87">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-10-26 21:32:51 +0200 (Wed, 26 Oct 2005)
New Revision: 167

Added:
   cms/trunk/modules/control_panel/modules/
   cms/trunk/modules/quick_message/quick_message2/language/
   cms/trunk/modules/quick_message/quick_message2/language/en/
Removed:
   cms/trunk/modules/control_panel/ucp/
Modified:
   cms/trunk/modules/articles/index.php
   cms/trunk/modules/contact/index.php
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/forums/main.php
   cms/trunk/modules/forums/viewtopic.php
   cms/trunk/modules/members_list/index.php
Log:
Yes, It's still broken.  Hopefully it will be moderately functional by tomorrow.......

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/articles/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -33,133 +33,181 @@
 	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
-global $_CLASS;
+$this-&gt;supported = array('page', 'feed');
 
-$_CLASS['core_user']-&gt;user_setup();
-
-if (isset($_GET['mode']))
+class module_articles
 {
-	Switch ($_GET['mode'])
+	function page_articles()
 	{
-		Case 'print':
-			$print = true;
-		Case 'view':
-			$print = isset($print);
-
-			$id = get_variable('id', 'GET', false, 'int');
+		global $_CLASS;
 		
-			if (!$id)
+		$_CLASS['core_user']-&gt;user_setup();
+		
+		if (isset($_GET['mode']))
+		{
+			Switch ($_GET['mode'])
 			{
-				trigger_error('ARTICLE_NOT_FOUND');
+				Case 'print':
+					$print = true;
+				Case 'view':
+					$print = isset($print);
+		
+					$id = get_variable('id', 'GET', false, 'int');
+				
+					if (!$id)
+					{
+						trigger_error('ARTICLE_NOT_FOUND');
+					}
+				
+					$result = $_CLASS['core_db']-&gt;query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
+					$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+					$_CLASS['core_db']-&gt;free_result($result);
+		
+					if (!$row || $row['articles_status'] != STATUS_ACTIVE)
+					{
+						trigger_error('ARTICLE_NOT_FOUND');
+					}
+		
+					$_CLASS['core_template']-&gt;assign_array(array(
+						'ARTICLES_POSTER' 		=&gt; ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']-&gt;get_lang('ANONYMOUS'),
+						'ARTICLES_POSTER_LINK'	=&gt; ($row['poster_name'] &amp;&amp; $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+						'ARTICLES_TEXT'			=&gt; $row['articles_text'],
+						'ARTICLES_CONTENT_LINK' =&gt; generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+						'ARTICLES_TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['articles_posted']),
+						'ARTICLES_TITLE'		=&gt; $row['articles_title'],
+						'ARTICLES_ID'       	=&gt; $id,
+						'ARTICLES_LINK_PRINT'	=&gt; generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+						'ARTICLES_LINK_SEND'	=&gt; generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+					));
+		
+					$_CLASS['core_display']-&gt;display(false, ($print) ? 'modules/articles/print.html' : 'modules/articles/view.html');	
+		
+					script_close();
+				break;
 			}
+		}
 		
-			$result = $_CLASS['core_db']-&gt;query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if (!$row || $row['articles_status'] != STATUS_ACTIVE)
+		$start = get_variable('start', 'GET', false, 'int');
+		$collapable_holding = array();
+		$expire_updated = false;
+		$limit = 10;
+		
+		$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, $limit, $start);
+		
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+		// this can cause problems, only thing to do is remove the limit query and do a loop until we get the needed articles
+			if ($row['articles_auth'] &amp;&amp; !$_CLASS['core_auth']-&gt;auth(@unserialize($row['articles_auth'])) &amp;&amp; !$_CLASS['core_auth']-&gt;admin_power('articles'))
 			{
-				trigger_error('ARTICLE_NOT_FOUND');
+				continue;
 			}
-
-			$_CLASS['core_template']-&gt;assign_array(array(
-				'ARTICLES_POSTER' 		=&gt; ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']-&gt;get_lang('ANONYMOUS'),
-				'ARTICLES_POSTER_LINK'	=&gt; ($row['poster_name'] &amp;&amp; $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
-				'ARTICLES_TEXT'			=&gt; $row['articles_text'],
-				'ARTICLES_CONTENT_LINK' =&gt; generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
-				'ARTICLES_TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['articles_posted']),
-				'ARTICLES_TITLE'		=&gt; $row['articles_title'],
-				'ARTICLES_ID'       	=&gt; $id,
-				'ARTICLES_LINK_PRINT'	=&gt; generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
-				'ARTICLES_LINK_SEND'	=&gt; generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+			
+			if ($row['articles_expires'] &amp;&amp; !$expire_updated &amp;&amp; ($_CLASS['core_user']-&gt;time &gt; $row['articles_expires']))
+			{
+				$_CLASS['core_db']-&gt;query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires &gt; 0 AND articles_expires &lt;= ' . $_CLASS['core_user']-&gt;time);
+				$expire_updated = true;
+		
+				continue;
+			}
+		
+			if ($row['articles_starts'] &amp;&amp; ($row['articles_starts'] &gt; $_CLASS['core_user']-&gt;time))
+			{
+				continue;
+			}
+		
+			$_CLASS['core_template']-&gt;assign_vars_array('articles', array(
+				'poster' 		=&gt; ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']-&gt;get_lang('ANONYMOUS'),
+				'content'		=&gt; ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'],
+				'time'			=&gt; $_CLASS['core_user']-&gt;format_date($row['articles_posted']),
+				'title'			=&gt; $row['articles_title'],
+				'id'      		=&gt; $row['articles_id'],
+		
+				'collapse'  	=&gt; check_collapsed_status('a_'.$row['articles_id']),
+				'full_story'	=&gt; ($row['articles_intro'] &amp;&amp; $row['articles_text']),
+		
+				'link_poster'	=&gt; ($row['poster_name'] &amp;&amp; $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+				'link_content'  =&gt; generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+				'link_print' 	=&gt; generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+				'link_send' 	=&gt; generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
 			));
-
-			$_CLASS['core_display']-&gt;display(false, ($print) ? 'modules/articles/print.html' : 'modules/articles/view.html');	
-
-			script_close();
-		break;
+		
+			$collapable_holding[] = 'a_'.$row['articles_id'];
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+		
+		// Garbage collection, would cause problems with guest/loggin articl views
+		if ($cookie_data = get_variable('collapsed_items', 'COOKIE'))
+		{
+			$collapsed_items = ($cookie_data) ? explode(':', $cookie_data) : array();
+			$count = count($collapsed_items);
+		
+			for($i = 0; $i &lt; $count; $i++)
+			{
+				if (mb_strpos($collapsed_items[$i], 'a_') === 0 &amp;&amp; !in_array($collapsed_items[$i], $collapable_holding))
+				{
+					unset($collapsed_items[$i]);
+				}
+			}
+		
+			$collapsed_items = implode(':', $collapsed_items);
+		
+			setcookie('collapsed_items', $collapsed_items, (int) $_CLASS['core_user']-&gt;time + 31536000000, '/');
+		}
+		
+		$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) AS total FROM ' . ARTICLES_TABLE . ' WHERE articles_status = '.STATUS_ACTIVE);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+		
+		$pagination = generate_pagination('articles', $row['total'], $limit, $start);
+		
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'articles_pagination' 		=&gt; $pagination['formated'],
+			'articles_pagination_array' =&gt; $pagination['array']
+		));
+		
+		$_CLASS['core_display']-&gt;display(false, 'modules/articles/index.html');
 	}
-}
-
-$start = get_variable('start', 'GET', false, 'int');
-$collapable_holding = array();
-$expire_updated = false;
-$limit = 10;
-
-$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
-$result = $_CLASS['core_db']-&gt;query_limit($sql, $limit, $start);
-
-while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-{
-// this can cause problems, only thing to do is remove the limit query and do a loop until we get the needed articles
-	if ($row['articles_auth'] &amp;&amp; !$_CLASS['core_auth']-&gt;auth(@unserialize($row['articles_auth'])) &amp;&amp; !$_CLASS['core_auth']-&gt;admin_power('articles'))
+	
+	function feed_articles()
 	{
-		continue;
-	}
-	
-	if ($row['articles_expires'] &amp;&amp; !$expire_updated &amp;&amp; ($_CLASS['core_user']-&gt;time &gt; $row['articles_expires']))
-	{
-		$_CLASS['core_db']-&gt;query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires &gt; 0 AND articles_expires &lt;= ' . $_CLASS['core_user']-&gt;time);
-		$expire_updated = true;
-
-		continue;
-	}
-
-	if ($row['articles_starts'] &amp;&amp; ($row['articles_starts'] &gt; $_CLASS['core_user']-&gt;time))
-	{
-		continue;
-	}
+		global $_CLASS;
 
-	$_CLASS['core_template']-&gt;assign_vars_array('articles', array(
-		'poster' 		=&gt; ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']-&gt;get_lang('ANONYMOUS'),
-		'content'		=&gt; ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'],
-		'time'			=&gt; $_CLASS['core_user']-&gt;format_date($row['articles_posted']),
-		'title'			=&gt; $row['articles_title'],
-		'id'      		=&gt; $row['articles_id'],
+		$result = $_CLASS['core_db']-&gt;query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+		
+		$last_post_time = 0;
+		
+		// Need to fix this, add auth and expires/start check ( will have to remove limit )
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$time = ($row['articles_starts']) ? $row['articles_starts'] : $row['articles_posted'];
+			$text = ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'];
+		
+			if ($time &gt; $last_post_time)
+			{
+				$last_post_time = $time;
+			}
+		
+			$_CLASS['core_template']-&gt;assign_vars_array('items', array(
+				'TITLE' 			=&gt; htmlspecialchars($row['articles_title'], ENT_QUOTES, 'UTF-8'),
+				'LINK' 				=&gt; generate_link('articles&amp;mode=view&amp;id='.$row['articles_id'], array('full' =&gt; true, 'sid' =&gt; false)),
+				'DESCRIPTION' 		=&gt; htmlspecialchars(strip_tags($text), ENT_QUOTES, 'UTF-8'),
+				'DESCRIPTION_HTML' 	=&gt; htmlspecialchars($text, ENT_QUOTES, 'UTF-8'),
+				'TIME'				=&gt; date('M d Y H:i:s', $time) .' GMT',
+				'AUTHOR'			=&gt; htmlspecialchars($row['poster_name'], ENT_QUOTES, 'UTF-8')
+			));
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-		'collapse'  	=&gt; check_collapsed_status('a_'.$row['articles_id']),
-		'full_story'	=&gt; ($row['articles_intro'] &amp;&amp; $row['articles_text']),
 
-		'link_poster'	=&gt; ($row['poster_name'] &amp;&amp; $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
-		'link_content'  =&gt; generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
-		'link_print' 	=&gt; generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
-		'link_send' 	=&gt; generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
-	));
+		if ($last_post_time)
+		{
+			define('DISPLAY_FEED', true);
 
-	$collapable_holding[] = 'a_'.$row['articles_id'];
-}
-$_CLASS['core_db']-&gt;free_result($result);
-
-// Garbage collection, would cause problems with guest/loggin articl views
-if ($cookie_data = get_variable('collapsed_items', 'COOKIE'))
-{
-	$collapsed_items = ($cookie_data) ? explode(':', $cookie_data) : array();
-	$count = count($collapsed_items);
-
-	for($i = 0; $i &lt; $count; $i++)
-	{
-		if (mb_strpos($collapsed_items[$i], 'a_') === 0 &amp;&amp; !in_array($collapsed_items[$i], $collapable_holding))
-		{
-			unset($collapsed_items[$i]);
+			$_CLASS['core_template']-&gt;assign('LAST_MODIFIED', date('M d Y H:i:s', $last_post_time) .' GMT');
+	
+			header('Last-Modified: '.$last_post_time);
 		}
 	}
-
-	$collapsed_items = implode(':', $collapsed_items);
-
-	setcookie('collapsed_items', $collapsed_items, (int) $_CLASS['core_user']-&gt;time + 31536000000, '/');
 }
-
-$result = $_CLASS['core_db']-&gt;query('SELECT COUNT(*) AS total FROM ' . ARTICLES_TABLE . ' WHERE articles_status = '.STATUS_ACTIVE);
-$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-$_CLASS['core_db']-&gt;free_result($result);
-
-$pagination = generate_pagination('articles', $row['total'], $limit, $start);
-
-$_CLASS['core_template']-&gt;assign_array(array(
-	'articles_pagination' 		=&gt; $pagination['formated'],
-	'articles_pagination_array' =&gt; $pagination['array']
-));
-
-$_CLASS['core_display']-&gt;display(false, 'modules/articles/index.html');
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/contact/index.php
===================================================================
--- cms/trunk/modules/contact/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/contact/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -21,21 +21,15 @@
 $Id$
 */
 
-/*$this-&gt;test = 'test';
-echo $this-&gt; 'test';*/
+$this-&gt;supported = array('page');
 
-class page_contact
+class module_contact
 {
 	function page_contact()
 	{
 		// Add departments
 		global $_CLASS;
 		
-		if (!defined('VIPERAL'))
-		{
-			die;
-		}
-
 		$_CLASS['core_user']-&gt;user_setup();
 		$_CLASS['core_user']-&gt;add_lang();
 		
@@ -81,7 +75,7 @@
 			'SENDER_NAME' 			=&gt; $this-&gt;data['NAME'],
 		));
 		
-		$_CLASS['core_template']-&gt;display('modules/Contact/index.html');
+		$_CLASS['core_template']-&gt;display('modules/contact/index.html');
 	}
 
 	// remove this function

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/control_panel/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -1,375 +1,252 @@
 &lt;?php 
-// -------------------------------------------------------------
-//
-// $Id: ucp.php,v 1.36 2004/07/11 15:20:34 acydburn Exp $
-//
-// FILENAME  : bbcode.php 
-// STARTED   : Thu Nov 21, 2002
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
-if (!defined('VIPERAL'))
-{
-    die;
-}
+$Id$
+*/
 
-global $_CLASS, $_CORE_CONFIG;
 
+/*
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
 load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 $_CLASS['auth'] =&amp; $_CLASS['forums_auth'];
 
-$_CLASS['core_user']-&gt;user_setup();
-$_CLASS['core_user']-&gt;add_lang();
+
 $_CLASS['core_user']-&gt;add_img(0, 'Forums');
 $_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
+*/
 
-$mode	= request_var('mode', '');
-$module = request_var('i', '');
+if (!defined('VIPERAL'))
+{
+    die;
+}
 
-$ucp = new module();
+//$this-&gt;supported = array('page', 'feed', 'ajax');
+$this-&gt;supported = array('page');
 
-//define the undefineds
-$_CLASS['core_template']-&gt;assign_array(array(
-	'S_DISPLAY_FORM'		=&gt; false,
-	'S_SHOW_PM_BOX'			=&gt; false,
-	'S_SHOW_COLOUR_LEGEND'	=&gt; false,
-	'USERNAME'				=&gt; '',
-	'friends_online'		=&gt; false,
-	'friends_offline' 		=&gt; false,
-));
-
-// ---------
-// FUNCTIONS
-//
-class module
+class module_control_panel
 {
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
+	function module_control_panel()
+	{
+		$this-&gt;module = get_variable('i', 'REQUEST');
+		$this-&gt;mode = get_variable('mode', 'REQUEST');
+	}
 
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $selected_mod = false, $selected_submod = false)
+	function process_module($type = 'page')
 	{
-		global $_CLASS, $config;
+		global $_CLASS;
 
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . FORUMS_MODULES_TABLE . &quot;
-			WHERE module_type = '{$module_type}'
-				AND module_enabled = 1
-			ORDER BY module_order ASC&quot;;
+		$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. &quot;
+					WHERE module_name = '&quot;.$_CLASS['core_db']-&gt;escape($this-&gt;module).&quot;'&quot;;
 		$result = $_CLASS['core_db']-&gt;query($sql);
+		
+		if (!$module_info = $_CLASS['core_db']-&gt;fetch_row_assoc($result) || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this-&gt;module . '.php'))
+		{
+			$this-&gt;module = 'main';
+			$this-&gt;mode = false;
+		}
+		
+		$this-&gt;link_standard = $this-&gt;link = 'control_panel&amp;i='.$this-&gt;module;
 
-		$i = 0;
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		if ($this-&gt;mode)
 		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-				//echo $row['module_acl'];
-				$row['module_acl'] = preg_replace(array('#acl_([a-z_]+)#', '#cfg_([a-z_]+)#'), array('$_CLASS[\'auth\']-&gt;acl_get(&quot;\\1&quot;)', '$config[&quot;\\1&quot;]'), trim($row['module_acl']));
-				//echo $row['module_acl'];
+			$this-&gt;link .= '&amp;mode='.$this-&gt;mode;
+		}
+	}
 
-				eval('$is_auth = ('.$row['module_acl'].');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod &amp;&amp; !$i)) ?  true : false;
-
-			// Get the localised lang string if available, or make up our own otherwise
-			$module_lang = strtoupper($module_type) . '_' . $row['module_title'];
-			$_CLASS['core_template']-&gt;assign_vars_array($module_type . '_section', array(
-				'L_TITLE'		=&gt; (isset($_CLASS['core_user']-&gt;lang[$module_lang])) ? $_CLASS['core_user']-&gt;lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
+	function generate_panel_block()
+	{
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$sql = 'SELECT *
+			FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. ' ORDER BY module_id';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+	
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$selected = ($row['module_name'] === $this-&gt;module);
+		
+			$module_lang = 'UCP_' . $row['module_title'];
+			$_CLASS['core_template']-&gt;assign_vars_array('ucp_section', array(
+				'L_TITLE'		=&gt; isset($_CLASS['core_user']-&gt;lang[$module_lang]) ? $_CLASS['core_user']-&gt;lang[$module_lang] : mb_convert_case(str_replace('_', ' ',  ($row['module_name'])), MB_CASE_TITLE),
 				'S_SELECTED'	=&gt; $selected, 
-				'U_TITLE'		=&gt; generate_link($module_url . '&amp;i=' . $row['module_id']))
+				'U_TITLE'		=&gt; generate_link('control_panel&amp;i=' . $row['module_name']))
 			);
-
+		
 			if ($selected)
 			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
+				if (!$row['module_subs'])
 				{
-					$j = 0;
-					$submodules_ary = explode(&quot;\n&quot;, $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
+					$_CLASS['core_template']-&gt;assign('ucp_subsection', false);
+		
+					continue;
+				}
+		
+				$sub_modules = explode(&quot;\n&quot;, trim($row['module_subs']));
+		
+				foreach ($sub_modules as $sub_module)
+				{
+					if (!trim($sub_module))
 					{
-						if (!trim($submodule))
-						{
-							continue;
-						}
-
-						$submodule = explode(',', trim($submodule));
-						$submodule_title = array_shift($submodule);
-
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']-&gt;acl_get(&quot;\\1&quot;)', '(int) $config[&quot;\\1&quot;]'), trim($auth_option)) . ');');
-
-							if (!$is_auth)
-							{
-								break;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod &amp;&amp; !$j)) ? true : false;
-
-						// Get the localised lang string if available, or make up our own otherwise
-						$module_lang = strtoupper($module_type . '_' . $module_name . '_' . $submodule_title);
-
-						$_CLASS['core_template']-&gt;assign_vars_array(&quot;{$module_type}_subsection&quot;, array(
-							'L_TITLE'		=&gt; (isset($_CLASS['core_user']-&gt;lang[$module_lang])) ? $_CLASS['core_user']-&gt;lang[$module_lang] : $module_lang,
-							'S_SELECTED'	=&gt; $selected, 
-							'U_TITLE'		=&gt; generate_link($module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title)
-						));
-
-						if ($selected)
-						{
-							$this-&gt;mode = $submodule_title;
-						}
-
-						$j++;
+						continue;
 					}
+		
+					$selected = ($this-&gt;mode &amp;&amp; $sub_module === $this-&gt;mode) ? true : false;
+		
+					$module_lang = strtoupper('UCP_' . $row['module_name'] . '_' . $sub_module);
+		
+					$_CLASS['core_template']-&gt;assign_vars_array(&quot;ucp_subsection&quot;, array(
+						'L_TITLE'		=&gt; (isset($_CLASS['core_user']-&gt;lang[$module_lang])) ? $_CLASS['core_user']-&gt;lang[$module_lang] : $module_lang,
+						'S_SELECTED'	=&gt; $selected, 
+						'U_TITLE'		=&gt; generate_link('control_panel&amp;i=' . $row['module_name'] . '&amp;mode=' . $sub_module)
+					));
 				}
-				else
-				{
-					$_CLASS['core_template']-&gt;assign('ucp_subsection', false);
-				}
 			}
-
-			$i++;
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (!isset($module_id) || !$module_id)
+	
+		// Output listing of friends online
+		$online_time = $_CLASS['core_user']-&gt;time = $_CORE_CONFIG['server']['session_length'];
+		
+		$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
+			FROM ' . CORE_USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
+			LEFT JOIN ' . CORE_SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
+			WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
+				AND z.friend = 1 
+				AND u.user_id = z.zebra_id';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			trigger_error('MODULE_NOT_EXIST');
+			$which = ($row['session_time'] &gt; $online_time) ? 'online' : 'offline';
+		
+			$_CLASS['core_template']-&gt;assign_vars_array(&quot;friends_{$which}&quot;, array(
+				'U_PROFILE'	=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+				'USER_ID'	=&gt; $row['user_id'],
+				'USERNAME'	=&gt; $row['username']
+			));
 		}
-
-		$this-&gt;type = $module_type;
-		$this-&gt;id = $module_id;
-		$this-&gt;name = $module_name;
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
-	function load($type = false, $name = false, $mode = false, $run = true)
+	function page_control_panel()
 	{
-		if ($type)
-		{
-			$this-&gt;type = $type;
-		}
+		global $_CLASS, $_CORE_CONFIG;
 
-		if ($name)
-		{
-			$this-&gt;name = $name;
-		}
+		$_CLASS['core_user']-&gt;user_setup();
+		
+		/* Assign some basic template varibles */
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_DISPLAY_FORM'		=&gt; false,
+			'S_SHOW_PM_BOX'			=&gt; false,
+			'S_SHOW_COLOUR_LEGEND'	=&gt; false,
+			'USERNAME'				=&gt; '',
+			'friends_online'		=&gt; false,
+			'friends_offline' 		=&gt; false,
+		));
+		
+		$mode = get_variable('mode', 'REQUEST');
+		$module = get_variable('i', 'REQUEST');
 
-		if (!class_exists($this-&gt;type . '_' . $this-&gt;name))
-		{
-			require_once(SITE_FILE_ROOT.&quot;modules/Control_Panel/{$this-&gt;type}/{$this-&gt;type}_{$this-&gt;name}.php&quot;);
+		$_CLASS['core_user']-&gt;add_lang();
 
-			if ($run)
+		if (!$module &amp;&amp; $mode)
+		{
+			switch ($mode)
 			{
-				if (!isset($this-&gt;mode))
-				{
-					$this-&gt;mode = $mode;
-				}
+				case 'register':
+					if ($_CLASS['core_user']-&gt;is_user || $_CLASS['core_user']-&gt;is_bot)
+					{
+						redirect();
+					}
 
-				eval(&quot;\$this-&gt;module = new {$this-&gt;type}_{$this-&gt;name}(\$this-&gt;id, \$this-&gt;mode);&quot;);
-				if (method_exists($this-&gt;module, 'init'))
-				{
-					$this-&gt;module-&gt;init();
-				}
-			}
-		}
-	}
+					require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_register.php';
 
-	// Displays the appropriate template with the given title
-	function display($page_title, $tpl_name)
-	{
-		global $_CLASS;
+				break;
+			
+				case 'login':
+					if ($_CLASS['core_user']-&gt;is_user || $_CLASS['core_user']-&gt;is_bot)
+					{
+						redirect();
+					}
+			
+					login_box();
+				break;
+			
+				case 'logout':
+					if ($_CLASS['core_user']-&gt;is_user)
+					{
+						$_CLASS['core_user']-&gt;logout();
+					}
+			
+					$_CLASS['core_display']-&gt;meta_refresh(3);
+			
+					$message = $_CLASS['core_user']-&gt;lang['LOGOUT_REDIRECT'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_PAGE'], '&lt;a href=&quot;' . generate_link() . '&quot;&gt;', '&lt;/a&gt; ');
+					trigger_error($message);
+				break;
+			
+				case 'delete_cookies':
+					if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DELETE_COOKIES')))
+					{
+						global $_CORE_CONFIG;
+						
+						$set_time = gmtime() - 31536000;
+			
+						foreach ($_COOKIE as $cookie_name =&gt; $cookie_data)
+						{
+							$cookie_name = str_replace($_CORE_CONFIG['server']['cookie_name'] . '_', '', $cookie_name);
+			
+							if (strpos($cookie_name, '_poll') === false)
+							{
+								$_CLASS['core_user']-&gt;set_cookie($cookie_name, '', $set_time);
+							}
+						}
 
-		page_header();
+						$_CLASS['core_user']-&gt;logout();
 
-        $_CLASS['core_template']-&gt;display('modules/Control_Panel/'.$tpl_name);
+						$_CLASS['core_display']-&gt;meta_refresh(3);
 
-		script_close();
-	}
-}
-//
-// FUNCTIONS
-// ---------
-
-// Basic &quot;global&quot; modes
-switch ($mode)
-{
-	case 'activate':
-		$ucp-&gt;load('ucp', 'activate');
-		$ucp-&gt;module-&gt;ucp_activate();
-		url_redirect();
-	break;
-
-	case 'resend_act':
-		$ucp-&gt;load('ucp', 'resend');
-		$ucp-&gt;module-&gt;ucp_resend();
-	break;
-
-	case 'sendpassword':
-		$ucp-&gt;load('ucp', 'remind');
-		$ucp-&gt;module-&gt;ucp_remind();
-	break;
-
-	case 'register':
-		if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS || isset($_REQUEST['not_agreed']))
-		{
-			redirect();
+						$message = $_CLASS['core_user']-&gt;lang['COOKIES_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'], '&lt;a href=&quot;'.generate_link().'&quot;&gt;', '&lt;/a&gt;');
+						trigger_error($message);
+					}
+			
+					redirect();
+				break;
+			}
 		}
-
-		$ucp-&gt;load('ucp', 'register');
-		$ucp-&gt;module-&gt;ucp_register();
-	break;
-
-	case 'confirm':
-		$ucp-&gt;load('ucp', 'confirm');
-		$ucp-&gt;module-&gt;ucp_confirm();
-	break;
-
-	case 'login':
-		if ($_CLASS['core_user']-&gt;is_user || $_CLASS['core_user']-&gt;is_bot)
-		{
-			redirect();
-		}
-
-		login_box();
-	break;
-
-	case 'logout':
-		if ($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS)
-		{
-			$_CLASS['core_user']-&gt;logout();
-		}
-
-		$_CLASS['core_display']-&gt;meta_refresh(3);
-
-		$message = $_CLASS['core_user']-&gt;lang['LOGOUT_REDIRECT'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_PAGE'], '&lt;a href=&quot;' . generate_link() . '&quot;&gt;', '&lt;/a&gt; ');
-		trigger_error($message);
-	break;
 		
-	case 'delete_cookies':
-		if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DELETE_COOKIES')))
+		/* Only registered users can go beyond this point*/
+		if (!$_CLASS['core_user']-&gt;is_user)
 		{
-			global $_CORE_CONFIG;
-			
-			$set_time = gmtime() - 31536000;
-
-			foreach ($_COOKIE as $cookie_name =&gt; $cookie_data)
+			if ($_CLASS['core_user']-&gt;is_bot)
 			{
-				$cookie_name = str_replace($_CORE_CONFIG['server']['cookie_name'] . '_', '', $cookie_name);
-
-				if (strpos($cookie_name, '_poll') === false)
-				{
-					$_CLASS['core_user']-&gt;set_cookie($cookie_name, '', $set_time);
-				}
+				redirect();
 			}
-
-			$_CLASS['core_user']-&gt;logout();
-
-			$_CLASS['core_display']-&gt;meta_refresh(3);
-
-			$message = $_CLASS['core_user']-&gt;lang['COOKIES_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'], '&lt;a href=&quot;'.generate_link().'&quot;&gt;', '&lt;/a&gt;');
-			trigger_error($message);
-
+		
+			login_box(array('explain' =&gt; $_CLASS['core_user']-&gt;get_lang('LOGIN_EXPLAIN_UCP')));
 		}
 		
-		redirect();
-		break;
-}
+		$this-&gt;process_module('page');
+		$this-&gt;generate_panel_block('page');
 
-
-// Only registered users can go beyond this point
-if (!$_CLASS['core_user']-&gt;is_user)
-{
-	if ($_CLASS['core_user']-&gt;is_bot)
-	{
-		url_redirect();
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $module . '.php';
 	}
-	
-	login_box(array('explain' =&gt; $_CLASS['core_user']-&gt;lang['LOGIN_EXPLAIN_UCP']));
 }
 
-// Output listing of friends online
-$update_time = $config['load_online_time'] * 60;
-
-$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
-	FROM ' . USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 
-	LEFT JOIN ' . SESSIONS_TABLE . ' s ON (s.session_user_id = z.zebra_id)
-	WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
-		AND z.friend = 1 
-		AND u.user_id = z.zebra_id';
-$result = $_CLASS['core_db']-&gt;query($sql);
-
-while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-{
-	$which = (time() - $update_time &lt; $row['session_time']) ? 'online' : 'offline';
-
-	$_CLASS['core_template']-&gt;assign_vars_array(&quot;friends_{$which}&quot;, array(
-		'U_PROFILE'	=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-		
-		'USER_ID'	=&gt; $row['user_id'],
-		'USERNAME'	=&gt; $row['username'])
-	);
-}
-$_CLASS['core_db']-&gt;free_result($result);
-
-/*
-// Output PM_TO box if message composing
-if ($mode == 'compose' &amp;&amp; request_var('action', '') != 'edit')
-{
-	if ($config['allow_mass_pm'])
-	{
-		$sql = 'SELECT group_id, group_name, group_type   
-			FROM ' . GROUPS_TABLE . ' 
-			WHERE group_type NOT IN (' . GROUP_HIDDEN . ', ' . GROUP_CLOSED . ')
-				AND group_receive_pm = 1
-			ORDER BY group_type DESC';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$group_options = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$group_options .= '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	$_CLASS['core_template']-&gt;assign(array(
-		'S_SHOW_PM_BOX'		=&gt; true,
-		'S_ALLOW_MASS_PM'	=&gt; ($config['allow_mass_pm']),
-		'S_GROUP_OPTIONS'	=&gt; ($config['allow_mass_pm']) ? $group_options : '',
-		'U_SEARCH_USER'		=&gt; generate_link('Members_List&amp;mode=searchuser&amp;form=post&amp;field=username_list'),
-	));
-}*/
-
-// Instantiate module system and generate list of available modules
-$ucp-&gt;create('ucp', 'Control_Panel', $module, $mode);
-
-// Load and execute the relevant module
-$ucp-&gt;load();
-
 ?&gt;
\ No newline at end of file

Copied: cms/trunk/modules/control_panel/modules (from rev 166, cms/trunk/modules/control_panel/ucp)

Modified: cms/trunk/modules/forums/main.php
===================================================================
--- cms/trunk/modules/forums/main.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/forums/main.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -47,7 +47,7 @@
 
 // Grab group details for legend display
 $sql = 'SELECT group_id, group_name, group_colour, group_type
-	FROM ' . GROUPS_TABLE . ' 
+	FROM ' . CORE_GROUPS_TABLE . ' 
 	WHERE group_legend = 1
 		AND group_type &lt;&gt; ' . GROUP_HIDDEN;
 $result = $_CLASS['core_db']-&gt;query($sql);
@@ -69,7 +69,7 @@
 	$now = explode(':', gmdate('j:m'));
 
 	$sql = 'SELECT user_id, username, user_colour, user_birthday 
-		FROM ' . USERS_TABLE . &quot; 
+		FROM ' . CORE_USERS_TABLE . &quot; 
 		WHERE user_birthday LIKE '&quot; . sprintf('%2d-%2d-', $now[0], $now[1]) . &quot;%'
 			AND user_type = &quot;.USER_NORMAL;
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -79,12 +79,14 @@
 		$user_colour = ($row['user_colour']) ? ' style=&quot;color:#' . $row['user_colour'] .'&quot;' : '';
 		$birthday_list .= (($birthday_list != '') ? ', ' : '') . '&lt;a' . $user_colour . ' href=&quot;' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
 		
-		if ($age = (int)substr($row['user_birthday'], -4))
+		if ($age = (int) substr($row['user_birthday'], -4))
 		{
 			$birthday_list .= ' (' . ($now['year'] - $age) . ')';
 		}
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
+	
+	unset($now);
 }
 
 $l_total_user_s = ($config['num_users'] == 0) ? 'TOTAL_USERS_ZERO' : 'TOTAL_USERS_OTHER';

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/forums/viewtopic.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -598,7 +598,7 @@
 
 $sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_reg_date, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p
-	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . USERS_TABLE . ' u
+	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . CORE_USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
 		AND u.user_id = p.poster_id';
 
@@ -665,7 +665,7 @@
 	$bbcode_bitfield |= $row['bbcode_bitfield'];
 
 	// Is a signature attached? Are we going to display it?
-	if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;optionget('viewsigs'))
+	if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewsigs'))
 	{
 		$bbcode_bitfield |= $row['user_sig_bbcode_bitfield'];
 	}
@@ -708,7 +708,7 @@
 		{
 			$user_sig = '';
 
-			if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;optionget('viewsigs'))
+			if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewsigs'))
 			{
 				$user_sig = $row['user_sig'];
 			}
@@ -736,7 +736,7 @@
 				'username'		=&gt; ($row['user_colour']) ? '&lt;span style=&quot;color:#' . $row['user_colour'] . '&quot;&gt;' . $poster . '&lt;/span&gt;' : $poster
 			);
 
-			if ($row['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;optionget('viewavatars'))
+			if ($row['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewavatars'))
 			{
 				$avatar_img = '';
 				switch ($row['user_avatar_type'])
@@ -810,17 +810,17 @@
 if ($config['load_onlinetrack'] &amp;&amp; !empty($id_cache))
 {
 	$sql = 'SELECT session_user_id, session_hidden, MAX(session_time) as online_time
-		FROM ' . SESSIONS_TABLE . ' 
+		FROM ' . CORE_SESSIONS_TABLE . ' 
 		WHERE session_user_id IN (' . implode(', ', $id_cache) . ')
 		GROUP BY session_user_id, session_hidden';
 
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
-	$min_online_time = $_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length'] * 60;
+	$online_time = $_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length'];
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] &amp;&amp; $row['online_time'] &gt; $min_online_time);
+		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] &amp;&amp; $row['online_time'] &gt; $online_time);
 	}
 }
 unset($id_cache);

Modified: cms/trunk/modules/members_list/index.php
===================================================================
--- cms/trunk/modules/members_list/index.php	2005-10-26 19:29:09 UTC (rev 166)
+++ cms/trunk/modules/members_list/index.php	2005-10-26 19:32:51 UTC (rev 167)
@@ -29,11 +29,6 @@
 
 global $_CLASS, $_CORE_CONFIG;
 
-require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
-
-$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
-
 $_CLASS['core_user']-&gt;user_setup();
 $_CLASS['core_user']-&gt;add_lang();
 $_CLASS['core_user']-&gt;add_img(false, 'Forums');
@@ -44,38 +39,37 @@
 ));
 
 // Grab data
-$mode		= request_var('mode', '');
-$action		= request_var('action', '');
-$user_id	= request_var('u', ANONYMOUS);
-$group_id	= request_var('g', 0);
+$mode		= get_variable('mode', 'REQUEST');
+$action		= get_variable('action', 'REQUEST');
 
-$start		= request_var('start', 0);
+$start		= get_variable('start', 'REQUEST', false, 'int');
 $submit		= isset($_POST['submit']);
 
-$sort_key	= request_var('sk', 'c');
-$sort_dir	= request_var('sd', 'a');
+$sort_key	= get_variable('sk', 'REQUEST', 'c');
+$sort_dir	= get_variable('sd', 'REQUEST', 'a');
 
 $window		= false;
 
 // Grab rank information for later
-$ranks = obtain_ranks();
+//$ranks = obtain_ranks();
 
-// What do you want to do today? ... oops, I think that line is taken ...
 switch ($mode)
 {
-	case 'leaders':
-		// Display a listing of board admins, moderators
-		//$_CLASS['core_user']-&gt;add_lang('groups', 'Forums');
-		
+	case 'forum_moderators':
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+
+		$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
+		
 		$page_title = $_CLASS['core_user']-&gt;lang['LEADER'];
-		$template_html = 'memberlist_leaders.html';
+		$template_html = 'memberlist_forum_moderators.html';
 
 		$user_ary = $_CLASS['forums_auth']-&gt;acl_get_list(false, 'm_', false);
-		$admin_id_ary = $mod_id_ary = $forum_id_ary = array();
+		$modorators = $forum_id_ary = array();
 
 		foreach ($user_ary as $forum_id =&gt; $forum_ary)
 		{
-			$mod_id_ary += $forum_ary['m_'];
+			$modorators += $forum_ary['m_'];
 
 			if ($forum_id)
 			{
@@ -91,37 +85,41 @@
 			WHERE forum_type = ' . FORUM_POST;
 		$result = $_CLASS['core_db']-&gt;query($sql);
 		
-		$forums = array();
+		$forums_array = array();
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$forums[$row['forum_id']] = $row['forum_name'];
+			$forums_array[$row['forum_id']] = $row['forum_name'];
+			$forum_array_ids[] = $row['forum_id'];
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
 		$sql = 'SELECT u.user_id, u.username, u.user_colour, u.user_rank, u.user_posts, g.group_id, g.group_name, g.group_colour, g.group_type, ug.user_id as ug_user_id
-			FROM ' . USERS_TABLE . ' u, ' . GROUPS_TABLE . ' g
-			LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')
-			WHERE u.user_id IN (' . implode(', ', $admin_id_ary + $mod_id_ary) . ')
+			FROM ' . CORE_USERS_TABLE . ' u, ' . CORE_GROUPS_TABLE . ' g
+			LEFT JOIN ' . CORE_GROUPS_MEMBERS_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')
+			WHERE u.user_id IN (' . implode(', ', $modorators) . ')
 				AND u.user_group = g.group_id
-			ORDER BY g.group_name ASC, u.username ASC';
-		$result = $_CLASS['core_db']-&gt;query($sql);
+			ORDER BY g.group_name ASC, u.username ASC';
 
+		$result = $_CLASS['core_db']-&gt;query($sql);
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$which_row = in_array($row['user_id'], $admin_id_ary) ? 'admin' : 'mod';
+			$forums = array_intersect($forum_id_ary[$row['user_id']], $forum_array_ids);
+
+			if (empty($forums))
+			{
+				continue;
+			}
 
-			$s_forum_select = '';
-			if ($which_row == 'mod' &amp;&amp; sizeof(array_diff(array_keys($forums), $forum_id_ary[$row['user_id']])))
+			$s_forum_select = '';
+
+			foreach ($forums as $forum_id)
 			{
-				foreach ($forum_id_ary[$row['user_id']] as $forum_id)
+				if ($_CLASS['forums_auth']-&gt;acl_get('f_list', $forum_id))
 				{
-					if (isset($forums[$forum_id]) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_list', $forum_id))
-					{
-						$s_forum_select .= '&lt;option value=&quot;&quot;&gt;' . $forums[$forum_id] . '&lt;/option&gt;';
-					}
+					$s_forum_select .= '&lt;option value=&quot;&quot;&gt;' . $forums[$forum_id] . '&lt;/option&gt;';
 				}
-			}
-			
+			}
+
 			if ($row['group_type'] == GROUP_HIDDEN &amp;&amp; $row['ug_user_id'] != $_CLASS['core_user']-&gt;data['user_id'])
 			{
 				$group_name = $_CLASS['core_user']-&gt;get_lang('UNDISCLOSED');
@@ -130,13 +128,13 @@
 			else
 			{
 				$group_name = isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'];
-				$u_group = generate_link('Members_List&amp;mode=group&amp;g='.$row['group_id']);
+				$u_group = generate_link('members_list&amp;mode=group&amp;g='.$row['group_id']);
 			}
 
 			$rank_title = $rank_img = '';
 			get_user_rank($row['user_rank'], $row['user_posts'], $rank_title, $rank_img);
 
-			$_CLASS['core_template']-&gt;assign_vars_array($which_row, array(
+			$_CLASS['core_template']-&gt;assign_vars_array('moderators', array(
 				'USER_ID'		=&gt; $row['user_id'],
 				'FORUMS'		=&gt; $s_forum_select,
 				'USERNAME'		=&gt; $row['username'],
@@ -148,9 +146,9 @@
 				'RANK_IMG'		=&gt; $rank_img,
 
 				'U_GROUP'		=&gt; $u_group,
-				'U_VIEWPROFILE'	=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']),
-				'U_PM'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']) : '')
-			);
+				'U_VIEWPROFILE'	=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']),
+				'U_PM'			=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id'])
+			));
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -200,7 +198,7 @@
 				$lang = 'JABBER';
 				$sql_field = 'user_jabber';
 				$s_select = (@extension_loaded('xml')) ? 'S_SEND_JABBER' : 'S_NO_SEND_JABBER';
-				$s_action = generate_link(&quot;Members_List&amp;mode=contact&amp;action=$action&amp;u=$user_id&quot;);
+				$s_action = generate_link(&quot;members_list&amp;mode=contact&amp;action=$action&amp;u=$user_id&quot;);
 				break;
 
 			default:
@@ -277,12 +275,14 @@
 			$s_select			=&gt; true,
 			'S_IM_ACTION'		=&gt; $s_action
 		));
+	break;
 
-		break;
-
 	case 'viewprofile':
+	
+		$user_id = get_variable('u', 'REQUEST', ANONYMOUS, 'int');
+
 		// Display a profile
-		if ($user_id == ANONYMOUS)
+		if ($user_id === ANONYMOUS)
 		{
 			trigger_error('NO_USER');
 		}
@@ -292,9 +292,10 @@
 			user_sig_bbcode_uid, user_sig_bbcode_bitfield, user_allow_viewemail, user_posts, user_reg_date, user_rank,
 			user_from, user_occ, user_interests, user_website, user_email, user_icq, user_aim, user_yim, user_msnm,
 			user_jabber, user_avatar, user_avatar_width, user_avatar_height, user_avatar_type, user_last_visit
-			FROM ' . USERS_TABLE . &quot;
+			FROM ' . CORE_USERS_TABLE . &quot;
 			WHERE user_id = $user_id
 				AND user_type = &quot; . USER_NORMAL;
+
 		$result = $_CLASS['core_db']-&gt;query($sql);
 		$member = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 		$_CLASS['core_db']-&gt;free_result($result);
@@ -307,7 +308,7 @@
 		}
 		
 		$sql = 'SELECT g.group_id, g.group_name, g.group_type
-			FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . &quot; g
+			FROM ' . CORE_USER_GROUP_TABLE . ' ug, ' . CORE_GROUPS_TABLE . &quot; g
 			WHERE ug.user_id = $user_id
 				AND g.group_id = ug.group_id AND group_type &lt;&gt; &quot; . GROUP_HIDDEN. '
 			ORDER BY group_type, group_name';
@@ -325,7 +326,7 @@
 		$template_html = 'memberlist_view.html';
 		
 		$sql = 'SELECT MAX(session_time) AS session_time
-			FROM ' . SESSIONS_TABLE . &quot;
+			FROM ' . CORE_SESSIONS_TABLE . &quot;
 			WHERE session_user_id = $user_id&quot;;
 		$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -337,70 +338,13 @@
 
 		$num_real_posts = $_CLASS['core_user']-&gt;data['user_posts'];
 
-		/*
-		// Obtain list of forums where this users post count is incremented
-		$auth2 = new auth();
-		$auth2-&gt;acl($member);
-		
-		if ($permission_array = $auth2-&gt;acl_getf('f_postcount'))
-		{
-			// Grab all the relevant data
-			$sql = 'SELECT COUNT(*) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . &quot;
-					WHERE poster_id = $user_id
-					AND forum_id IN (&quot; . implode(', ', array_keys($permission_array)) . ')';
-
-			$result = $_CLASS['core_db']-&gt;query($sql);
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-	
-			$num_real_posts = min($_CLASS['core_user']-&gt;data['user_posts'], $row['num_posts']);
-
-			unset($permission_array, $auth2);
-
-		}		
-		$active_f_row = $active_t_row = array();
-		*/
-
-		// Change post_count_sql to an forum_id array the user is able to see
-		if ($permission_array = $_CLASS['forums_auth']-&gt;acl_getf('f_read'))
-		{
-			$post_count_sql = 'AND f.forum_id IN (' . implode(', ', array_keys($permission_array)) . ')';
-	
-			$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . &quot; f
-				WHERE p.poster_id = $user_id
-					AND f.forum_id = p.forum_id
-					$post_count_sql
-				GROUP BY f.forum_id, f.forum_name
-				ORDER BY num_posts DESC&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-			$active_f_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . &quot; f
-				WHERE p.poster_id = $user_id
-					AND t.topic_id = p.topic_id
-					AND f.forum_id = t.forum_id
-					$post_count_sql
-				GROUP BY t.topic_id, t.topic_title
-				ORDER BY num_posts DESC&quot;;
-			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-			$active_t_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-	
-			unset($permission_array, $post_count_sql);
-		}
-
 		// Do the relevant calculations
 		$memberdays = max(1, round(($_CLASS['core_user']-&gt;time - $member['user_reg_date']) / 86400));
 		$posts_per_day = $member['user_posts'] / $memberdays;
 		$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
 		$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+
 		if (!empty($active_f_row['num_posts']))
 		{
 			$active_f_name = $active_f_row['forum_name'];
@@ -422,8 +366,8 @@
 
 		if ($member['user_sig_bbcode_bitfield'] &amp;&amp; $member['user_sig'])
 		{
-			// Add class loader
-			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
+
 			$bbcode = new bbcode();
 			$bbcode-&gt;bbcode_second_pass($member['user_sig'], $member['user_sig_bbcode_uid'], $member['user_sig_bbcode_bitfield']);
 		}
@@ -439,20 +383,63 @@
 			switch ($member['user_avatar_type'])
 			{
 				case AVATAR_UPLOAD:
-					$poster_avatar = $config['avatar_path'] . '/';
-					break;
+					$poster_avatar = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+				break;
+
 				case AVATAR_GALLERY:
-					$poster_avatar = $config['avatar_gallery_path'] . '/';
-					break;
+					$poster_avatar = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+				break;
 			}
 			$poster_avatar .= $member['user_avatar'];
 
 			$poster_avatar = '&lt;img src=&quot;' . $poster_avatar . '&quot; width=&quot;' . $member['user_avatar_width'] . '&quot; height=&quot;' . $member['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
 		}
 
-		$_CLASS['core_template']-&gt;assign_array(show_profile($member));
+		$rank_title = $rank_img = '';
+	
+		get_user_rank($member['user_rank'], $member['user_posts'], $rank_title, $rank_img);
 		
+		if (!empty($member['user_allow_viewemail']))
+		{
+			$email = ($_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$member['user_id']) : ((false) ? '' : 'mailto:' . $member['user_email']);
+		}
+		else
+		{
+			$email = '';
+		}
+	
+		$last_visit = ($member['session_time']) ? $member['session_time'] : $member['user_last_visit'];
+		$online = ($member['session_time'] &gt;= ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length']));
+	
 		$_CLASS['core_template']-&gt;assign_array(array(
+			'USERNAME'		=&gt; $member['username'],
+			'USER_COLOR'	=&gt; ($member['user_colour']) ? $member['user_colour'] : '',
+			'RANK_TITLE'	=&gt; $rank_title,
+	
+			'JOINED'		=&gt; $_CLASS['core_user']-&gt;format_date($member['user_reg_date']),
+			'VISITED'		=&gt; ($last_visit) ? ' - ' : $_CLASS['core_user']-&gt;format_date($last_visit),
+			'POSTS'			=&gt; ($member['user_posts']) ? $member['user_posts'] : 0,
+	
+			'ONLINE_IMG'	=&gt; ($online) ? $_CLASS['core_user']-&gt;img('btn_online', $_CLASS['core_user']-&gt;lang['USER_ONLINE']) : $_CLASS['core_user']-&gt;img('btn_offline', $_CLASS['core_user']-&gt;lang['USER_ONLINE']),
+			'RANK_IMG'		=&gt; $rank_img,
+			'ICQ_STATUS_IMG'=&gt; ($member['user_icq']) ? '&lt;img src=&quot;<A HREF="http://web.icq.com/whitepages/online?icq=">http://web.icq.com/whitepages/online?icq=</A>' . $member['user_icq'] . '&amp;img=5&quot; width=&quot;18&quot; height=&quot;18&quot; border=&quot;0&quot; /&gt;' : '',
+	
+			'U_PROFILE'		=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u='.$member['user_id']),
+			'U_SEARCH_USER'	=&gt; generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($member['username']) . '&amp;show_results=posts'),
+			'U_PM'			=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$member['user_id']),
+			'U_EMAIL'		=&gt; $email,
+			'U_WWW'			=&gt; ($member['user_website']) ? $member['user_website'] : '',
+			'U_ICQ'			=&gt; ($member['user_icq']) ? generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$member['user_id']) : '',
+			'U_AIM'			=&gt; ($member['user_aim']) ? generate_link('members_list&amp;mode=contact&amp;action=aim&amp;u='.$member['user_id']) : '',
+			'U_YIM'			=&gt; ($member['user_yim']) ? '<A HREF="http://edit.yahoo.com/config/send_webmesg?.target=">http://edit.yahoo.com/config/send_webmesg?.target=</A>' . $member['user_yim'] . '&amp;.src=pg' : '',
+			'U_MSN'			=&gt; ($member['user_msnm']) ? generate_link('members_list&amp;mode=contact&amp;action=msnm&amp;u='.$member['user_id']) : '',
+			'U_JABBER'		=&gt; ($member['user_jabber']) ? generate_link('members_list&amp;mode=contact&amp;action=jabber&amp;u='.$member['user_id']) : '',
+	
+			'S_ONLINE'		=&gt; $online,
+			'S_USER_LOGGED_IN' =&gt; $_CLASS['core_user']-&gt;is_user
+		));
+		
+		$_CLASS['core_template']-&gt;assign_array(array(
 			'POSTS_DAY'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_DAY'], $posts_per_day),
 			'POSTS_PCT'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_PCT'], $percentage),
 			'ACTIVE_FORUM'		=&gt; $active_f_name,
@@ -478,7 +465,7 @@
 			'JABBER_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_jabber', $_CLASS['core_user']-&gt;lang['JABBER']),
 			'SEARCH_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_search', $_CLASS['core_user']-&gt;lang['SEARCH']),
 
-			'S_PROFILE_ACTION'	=&gt; generate_link('Members_List&amp;mode=group'),
+			'S_PROFILE_ACTION'	=&gt; generate_link('members_list&amp;mode=group'),
 			'S_GROUP_OPTIONS'	=&gt; $group_options,
 			
 			'U_ADD_FRIEND'		=&gt; generate_link('Control_Panel&amp;i=zebra&amp;add=' . urlencode($member['username'])),
@@ -506,13 +493,10 @@
 			trigger_error('EMAIL_DISABLED');
 		}
 
-		// do soemthing better than this
-		if (($user_id === ANONYMOUS || !$config['board_email_form']) &amp;&amp; !$topic_id)
-		{
-			trigger_error('NO_EMAIL');
-		}
+		$user_id = get_variable('u', 'REQUEST', ANONYMOUS, 'int');
+		$topic_id = get_variable('t', 'REQUEST', false, 'int');
 
-		if (!$_CLASS['forums_auth']-&gt;acl_get('u_sendemail'))
+		if ($user_id === ANONYMOUS &amp;&amp; !$topic_id)
 		{
 			trigger_error('NO_EMAIL');
 		}
@@ -539,9 +523,10 @@
 		{
 			// Get the appropriate username, etc.
 			$sql = 'SELECT username, user_email, user_allow_viewemail, user_lang, user_jabber, user_notify_type
-				FROM ' . USERS_TABLE . &quot;
+				FROM ' . CORE_USERS_TABLE . &quot;
 				WHERE user_id = $user_id
 					AND user_type = &quot;. USER_NORMAL . ' AND user_status = ' . STATUS_ACTIVE;
+
 			$result = $_CLASS['core_db']-&gt;query($sql);
 			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 			$_CLASS['core_db']-&gt;free_result($result);
@@ -552,7 +537,7 @@
 			}
 			
 			// Can we send email to this user?
-			if (!$row['user_allow_viewemail'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('a_user'))
+			if (!$row['user_allow_viewemail'])
 			{
 				trigger_error('NO_EMAIL');
 			}
@@ -571,6 +556,11 @@
 				trigger_error('NO_TOPIC');
 			}
 
+			require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+			load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+	
+			$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
+
 			if (!$_CLASS['forums_auth']-&gt;acl_get('f_read', $row['forum_id']))
 			{
 				trigger_error('NO_FORUM_READ');
@@ -652,11 +642,10 @@
 
 				$_CLASS['core_template']-&gt;assign_array(array(
 					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
-					'BOARD_EMAIL'	=&gt; $config['board_contact'],
 					'FROM_USERNAME' =&gt; $_CLASS['core_user']-&gt;data['username'],
 					'TO_USERNAME'   =&gt; ($topic_id) ? $name : $row['username'],
 					'MESSAGE'		=&gt; $message,
-					'TOPIC_NAME'	=&gt; ($topic_id) ? strtr($row['topic_title'], array_flip(get_html_translation_table(HTML_ENTITIES))) : '',
+					'TOPIC_NAME'	=&gt; ($topic_id) ? html_entity_decode($row['topic_title'], HTML_ENTITIES) : '',
 					'U_TOPIC'		=&gt; ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . &quot;&amp;t=$topic_id&quot;, array('full' =&gt; true, 'sid' =&gt; false)) : '')
 				);
 
@@ -687,7 +676,7 @@
 
 			'L_EMAIL_BODY_EXPLAIN'	=&gt; $_CLASS['core_user']-&gt;get_lang((!$topic_id) ? 'EMAIL_BODY_EXPLAIN' : 'EMAIL_TOPIC_EXPLAIN'),
 
-			'S_POST_ACTION' =&gt; (!$topic_id) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id, array('full' =&gt; true)) : generate_link(&quot;Members_List&amp;mode=email&amp;f={$row['forum_id']}&amp;t=$topic_id&quot;, array('full' =&gt; true)),
+			'S_POST_ACTION' =&gt; (!$topic_id) ? generate_link('members_list&amp;mode=email&amp;u='.$user_id, array('full' =&gt; true)) : generate_link(&quot;members_list&amp;mode=email&amp;f={$row['forum_id']}&amp;t=$topic_id&quot;, array('full' =&gt; true)),
 			'S_SEND_USER'	=&gt; (!$topic_id),
 		));
 	break;
@@ -708,26 +697,25 @@
 		$s_sort_key = '';
 		foreach ($sort_key_text as $key =&gt; $value)
 		{
-			$selected = ($sort_key == $key) ? ' selected=&quot;selected&quot;' : '';
+			$selected = ($sort_key === $key) ? ' selected=&quot;selected&quot;' : '';
 			$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
 		}
 
 		$s_sort_dir = '';
 		foreach ($sort_dir_text as $key =&gt; $value)
 		{
-			$selected = ($sort_dir == $key) ? ' selected=&quot;selected&quot;' : '';
+			$selected = ($sort_dir === $key) ? ' selected=&quot;selected&quot;' : '';
 			$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
 		}
 
-		// Additional sorting options for user search ... if search is enabled, if not
-		// then only admins can make use of this (for ACP functionality)
 		$sql_select = $sql_from = $sql_where = $sql_fields =  '';
 
-		$form	= $window = request_var('form', '');
-		$field	= request_var('field', 'username');
+		$form = $window = get_variable('form', 'REQUEST');
 
-		if ($mode == 'searchuser' &amp;&amp; ($config['load_search'] || $_CLASS['forums_auth']-&gt;acl_get('a_')))
+		if ($mode === 'search_user')
 		{
+			$field	= get_variable('field', 'REQUEST', 'username');
+
 			$username	= request_var('username', '');
 			$email		= request_var('email', '');
 			$icq		= request_var('icq', '');
@@ -808,32 +796,30 @@
 			}
 		}
 
-		$first_char = request_var('first_char', '');
+		$first_char = get_variable('first_char', 'REQUEST');
 
-		if ($first_char == 'other')
+		if ($first_char === 'other')
 		{
-			$sql_where = '';
+			$sql_where = '';
+
 			for ($i = 65; $i &lt; 91; $i++)
 			{
 				$sql_where .= &quot; AND u.username NOT LIKE '&quot; . chr($i) . &quot;%'&quot;;
 			}
 		}
-		else if ($first_char)
+		elseif ($first_char)
 		{
 			$sql_where = &quot; AND u.username LIKE '&quot; . $_CLASS['core_db']-&gt;escape(substr($first_char, 0, 1)) . &quot;%'&quot;;
 		}
 
-		// Are we looking at a usergroup? If so, fetch additional info
-		// and further restrict the user info query
-		if ($mode == 'group')
+		if ($mode === 'group')
 		{
-			// We JOIN here to save a query for determining membership for hidden groups. ;)
-			
-			$sql = 'SELECT g.*, ug.user_id
-				FROM ' . GROUPS_TABLE . ' g
-				LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; AND ug.group_id = $group_id)
-				WHERE g.group_id = $group_id
-				AND group_status = &quot;.STATUS_ACTIVE;
+			$group_id = get_variable('g', 'REQUEST', false, 'int');
+
+			$sql = 'SELECT g.*, ug.member_status
+						FROM ' . CORE_GROUPS_TABLE . ' g
+							LEFT JOIN ' . CORE_USER_GROUP_TABLE . ' ug ON (ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot; AND ug.group_id = $group_id)
+							WHERE g.group_id = $group_id AND group_status = &quot; . STATUS_ACTIVE;
 	
 			$result = $_CLASS['core_db']-&gt;query($sql);
 			$group_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
@@ -859,7 +845,7 @@
 					$group_row['group_type'] = 'HIDDEN';
 					
 					// Check for membership or special permissions
-					if (!$_CLASS['forums_auth']-&gt;acl_gets('a_group', 'a_groupadd', 'a_groupdel') &amp;&amp; $group_row['user_id'] != $_CLASS['core_user']-&gt;data['user_id'])
+					if ((int) $group_row['member_status'] !== STATUS_ACTIVE)
 					{
 						trigger_error('NO_GROUP');
 					}
@@ -881,14 +867,15 @@
 				switch ($group_row['group_avatar_type'])
 				{
 					case AVATAR_UPLOAD:
-						$avatar_img = $config['avatar_path'] . '/';
-						break;
+						$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+					break;
+
 					case AVATAR_GALLERY:
-						$avatar_img = $config['avatar_gallery_path'] . '/';
-						break;
+						$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+					break;
 				}
+				
 				$avatar_img .= $group_row['group_avatar'];
-
 				$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $group_row['group_avatar_width'] . '&quot; height=&quot;' . $group_row['group_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
 			}
 
@@ -910,34 +897,36 @@
 				'AVATAR_IMG'	=&gt; $avatar_img,
 				'RANK_IMG'		=&gt; $rank_img,
 
-				'U_PM'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_sendpm') &amp;&amp; $group_row['group_receive_pm'] &amp;&amp; $config['allow_mass_pm']) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id) : '',)
-			);
+				'U_PM'			=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;g='.$group_id)
+			));
 
 			$sql_fields = ', ug.member_status';
-			$sql_from = ', ' . USER_GROUP_TABLE . ' ug ';
-			$sql_where .= &quot; AND u.user_id = ug.user_id AND ug.group_id = $group_id&quot;;
+			$sql_from = ', ' . CORE_USER_GROUP_TABLE . ' ug ';
+			$sql_where .= &quot; AND u.user_id = ug.user_id AND ug.group_id = $group_id AND member_status IN (&quot;.STATUS_ACTIVE.', '.STATUS_LEADER.')';
 		}
 
 		// Sorting and order
-		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
+		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir === 'a') ? 'ASC' : 'DESC');
 
 		// Count the users ...
 		if ($sql_where)
 		{
-			$sql = 'SELECT COUNT(u.user_id) AS total_users
-				FROM ' . USERS_TABLE . &quot; u$sql_from
+			$sql = 'SELECT COUNT(*) AS total_users
+				FROM ' . CORE_USERS_TABLE . &quot; u$sql_from
 				WHERE u.user_type = &quot; . USER_NORMAL .' AND u.user_status = ' . STATUS_ACTIVE .&quot;
 				$sql_where&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
 
-			$total_users = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['total_users'] : 0;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 			$_CLASS['core_db']-&gt;free_result($result);
+
+			$total_users = $row['total_users'];
 		}
 		else
 		{
-			$total_users = $config['num_users'];
+			$total_users = $_CORE_CONFIG['user']['total_users'];
 		}
-		
+
 		$s_char_options = '&lt;option value=&quot;&quot;' . ((!$first_char) ? ' selected=&quot;selected&quot;' : '') . '&gt;&nbsp; &nbsp;&lt;/option&gt;';
 
 		for ($i = 65; $i &lt; 91; $i++)
@@ -947,7 +936,7 @@
 		$s_char_options .= '&lt;option value=&quot;other&quot;' . (($first_char == 'other') ? ' selected=&quot;selected&quot;' : '') . '&gt;Other&lt;/option&gt;';
 		
 		// Pagination string
-		$pagination_url = $pagination_url2 = 'Members_List';
+		$pagination_url = $pagination_url2 = 'members_list';
 
 		// Build a relevant pagination_url
 		$global_var = ($submit) ? '_POST' : '_GET';
@@ -970,7 +959,7 @@
 		$pagination_url .= (($mode) ? '&amp;mode='.$mode : '') . (($first_char) ? '&amp;first_char='.$first_char : '');
 
 		// Some search user specific data
-		if ($mode == 'searchuser' &amp;&amp; ($config['load_search'] || $_CLASS['forums_auth']-&gt;acl_get('a_')))
+		if ($mode === 'search_user')
 		{
 			$_CLASS['core_template']-&gt;assign_array(array(
 				'USERNAME'	=&gt; $username,
@@ -992,12 +981,15 @@
 				'S_SORT_OPTIONS' 		=&gt; $s_sort_key,
 				'S_JOINED_TIME_OPTIONS' =&gt; $s_find_join_time,
 				'S_ACTIVE_TIME_OPTIONS' =&gt; $s_find_active_time,
-				'S_SEARCH_ACTION' 		=&gt; generate_link(&quot;Members_List&amp;mode=searchuser&amp;form=$form&amp;field=$field&quot;))
+				'S_SEARCH_ACTION' 		=&gt; generate_link(&quot;members_list&amp;mode=searchuser&amp;form=$form&amp;field=$field&quot;))
 			);
 		}
 
+		$online_time = $_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length'];
+
+// this can be big
 		$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
-			FROM ' . SESSIONS_TABLE . '
+			FROM ' . CORE_SESSIONS_TABLE . '
 			WHERE session_time &gt;= ' . ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length']) . '
 				AND session_user_id &lt;&gt; ' . ANONYMOUS . '
 			GROUP BY session_user_id';
@@ -1006,7 +998,7 @@
 		$session_times = array();
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$session_times[$row['session_user_id']] = $row['session_time'];
+			$session_times[$row['session_user_id']] = (int) $row['session_time'];
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
 		
@@ -1014,43 +1006,54 @@
 		$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_allow_viewemail, u.user_posts, u.user_reg_date,
 				u.user_rank, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, 
 				u.user_msnm, u.user_jabber, u.user_avatar, u.user_avatar_type, u.user_last_visit '. $sql_fields .'
-					FROM ' . USERS_TABLE . &quot; u$sql_from
+					FROM ' . CORE_USERS_TABLE . &quot; u$sql_from
 					WHERE u.user_type = &quot; . USER_NORMAL . ' AND u.user_status = ' . STATUS_ACTIVE .&quot;
 						$sql_where
 						ORDER BY $order_by&quot;;
 
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page'], $start);
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, 20, $start);
 
-		$id_cache = array();
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			if ($mode == 'group' &amp;&amp; $row['member_status'] == STATUS_PENDING)
+			$option_row = ($mode === 'group' &amp;&amp; $row['member_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
+
+			$row['session_time'] = empty($session_times[$row['user_id']]) ? 0 : $session_times[$row['user_id']];
+
+			if (!empty($row['user_allow_viewemail']))
 			{
-				 continue;
+				$email = ($_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$row['user_id']) : ((false) ? '' : 'mailto:' . $row['user_email']);
 			}
-
-			$row['session_time'] = (!empty($session_times[$row['user_id']])) ? $session_times[$row['user_id']] : '';
-			$id_cache[$row['user_id']] = $row;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+			else
+			{
+				$email = '';
+			}
 		
-		foreach ($id_cache as $user_id =&gt; $row)
-		{
-			$option_row = ($mode == 'group' &amp;&amp; $row['member_status'] == STATUS_LEADER) ? 'leader_row' : 'member_row';
+			$online = ($row['session_time'] &gt;= $online_time);
 
-			$$option_row = array_merge(show_profile($row), array(
-				'U_VIEWPROFILE'		=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']))
-			);
+			$_CLASS['core_template']-&gt;assign_vars_array($option_row, array(
+					'USERNAME'		=&gt; $row['username'],
+					'USER_COLOR'	=&gt; ($row['user_colour']) ? $row['user_colour'] : '',
 
-			$_CLASS['core_template']-&gt;assign_vars_array($option_row, $$option_row);
+					'JOINED'		=&gt; $_CLASS['core_user']-&gt;format_date($row['user_reg_date']),
+
+					'ONLINE_IMG'	=&gt; ($online) ? $_CLASS['core_user']-&gt;img('btn_online', $_CLASS['core_user']-&gt;lang['USER_ONLINE']) : $_CLASS['core_user']-&gt;img('btn_offline', $_CLASS['core_user']-&gt;lang['USER_ONLINE']),
 			
-			unset($id_cache[$user_id]);
-	}
+					'U_PROFILE'		=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']),
+					'U_PM'			=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$row['user_id']),
+					'U_EMAIL'		=&gt; $email,
+					'U_WWW'			=&gt; ($row['user_website']) ? $row['user_website'] : '',
+					'U_VIEWPROFILE' =&gt; generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 
+					'S_ONLINE'		=&gt; $online
+				)
+			);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
 	// Generate page
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'PAGINATION' 	=&gt; generate_pagination($pagination_url2, $total_users, $config['topics_per_page'], $start),
-		'PAGE_NUMBER' 	=&gt; on_page($total_users, $config['topics_per_page'], $start),
+		'PAGINATION' 	=&gt; generate_pagination($pagination_url2, $total_users, 20, $start),
+		'PAGE_NUMBER' 	=&gt; on_page($total_users, 20, $start),
 		'TOTAL_USERS'	=&gt; ($total_users == 1) ? $_CLASS['core_user']-&gt;lang['LIST_USER'] : sprintf($_CLASS['core_user']-&gt;lang['LIST_USERS'], $total_users),
 
 		'PROFILE_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_profile', $_CLASS['core_user']-&gt;lang['PROFILE']),
@@ -1064,23 +1067,22 @@
 		'JABBER_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_jabber', $_CLASS['core_user']-&gt;lang['JABBER']),
 		'SEARCH_IMG'	=&gt; $_CLASS['core_user']-&gt;img('btn_search', $_CLASS['core_user']-&gt;lang['SEARCH']),
 
-		'U_FIND_MEMBER'		=&gt; (!empty($config['load_search']) || $_CLASS['forums_auth']-&gt;acl_get('a_')) ? generate_link('Members_List&amp;mode=searchuser') : '',
-		'U_HIDE_FIND_MEMBER'=&gt; ($mode == 'searchuser') ? generate_link($u_hide_find_member) : '',
+		'U_FIND_MEMBER'		=&gt; generate_link('members_list&amp;mode=search_user'),
+		'U_HIDE_FIND_MEMBER'=&gt; ($mode === 'search_user') ? generate_link($u_hide_find_member) : '',
 		'U_SORT_USERNAME'	=&gt; generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'a' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_FROM'		=&gt; generate_link($pagination_url . '&amp;sk=b&amp;sd=' . (($sort_key == 'b' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_JOINED'		=&gt; generate_link($pagination_url . '&amp;sk=c&amp;sd=' . (($sort_key == 'c' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_POSTS'		=&gt; generate_link($pagination_url . '&amp;sk=d&amp;sd=' . (($sort_key == 'd' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
+		'U_SORT_ONLINE'		=&gt; generate_link($pagination_url . '&amp;sk=d&amp;sd=' . (($sort_key == 'd' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_EMAIL'		=&gt; generate_link($pagination_url . '&amp;sk=e&amp;sd=' . (($sort_key == 'e' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_WEBSITE'	=&gt; generate_link($pagination_url . '&amp;sk=f&amp;sd=' . (($sort_key == 'f' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_ICQ'		=&gt; generate_link($pagination_url . '&amp;sk=g&amp;sd=' . (($sort_key == 'g' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_AIM'		=&gt; generate_link($pagination_url . '&amp;sk=h&amp;sd=' . (($sort_key == 'h' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_MSN'		=&gt; generate_link($pagination_url . '&amp;sk=i&amp;sd=' . (($sort_key == 'i' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_YIM'		=&gt; generate_link($pagination_url . '&amp;sk=j&amp;sd=' . (($sort_key == 'j' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_ICQ'		=&gt; generate_link($pagination_url . '&amp;sk=g&amp;sd=' . (($sort_key == 'g' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_AIM'		=&gt; generate_link($pagination_url . '&amp;sk=h&amp;sd=' . (($sort_key == 'h' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_MSN'		=&gt; generate_link($pagination_url . '&amp;sk=i&amp;sd=' . (($sort_key == 'i' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
+		//'U_SORT_YIM'		=&gt; generate_link($pagination_url . '&amp;sk=j&amp;sd=' . (($sort_key == 'j' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_SORT_ACTIVE'		=&gt; generate_link($pagination_url . '&amp;sk=k&amp;sd=' . (($sort_key == 'k' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
-		'U_SORT_RANK'		=&gt; generate_link($pagination_url . '&amp;sk=l&amp;sd=' . (($sort_key == 'l' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 		'U_LIST_CHAR'		=&gt; generate_link($pagination_url . '&amp;sk=a&amp;sd=' . (($sort_key == 'l' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')),
 
-		'S_SEND_MESSAGE'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_sendpm')) ? true : false,
+		'S_SEND_MESSAGE'	=&gt; true,
 		'S_SHOW_GROUP'		=&gt; ($mode == 'group') ? true : false,
 		'S_MODE_SELECT'		=&gt; $s_sort_key,
 		'S_ORDER_SELECT'	=&gt; $s_sort_dir,
@@ -1090,12 +1092,9 @@
 }
 
 
-// Output the page
 $_CLASS['core_template']-&gt;assign('DISPLAY_STYLESHEET_LINK', $window);
-page_header();
+$_CLASS['core_display']-&gt;display($page_title, 'modules/members_list/'.$template_html);
 
-$_CLASS['core_display']-&gt;display($page_title, 'modules/Members_List/'.$template_html);
-
 script_close();
 // ---------
 // FUNCTIONS
@@ -1124,53 +1123,4 @@
 	}
 }
 
-function show_profile($data)
-{
-	global $config, $_CORE_CONFIG, $_CLASS;
-
-	$user_id = $data['user_id'];
-	$rank_title = $rank_img = '';
-
-	get_user_rank($data['user_rank'], $data['user_posts'], $rank_title, $rank_img);
-	
-	if (!empty($data['user_allow_viewemail']) || $_CLASS['forums_auth']-&gt;acl_get('a_email'))
-	{
-		$email = ($config['board_email_form'] &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('a_email')) ? '' : 'mailto:' . $data['user_email']);
-	}
-	else
-	{
-		$email = '';
-	}
-
-	$last_visit = ($data['session_time']) ? $data['session_time'] : $data['user_last_visit'];
-	$online = ($data['session_time'] &gt;= ($_CLASS['core_user']-&gt;time - ($config['load_online_time'] * 60)));
-
-	return array(
-		'USERNAME'		=&gt; $data['username'],
-		'USER_COLOR'	=&gt; ($data['user_colour']) ? $data['user_colour'] : '',
-		'RANK_TITLE'	=&gt; $rank_title,
-
-		'JOINED'		=&gt; $_CLASS['core_user']-&gt;format_date($data['user_reg_date']),
-		'VISITED'		=&gt; ($last_visit) ? ' - ' : $_CLASS['core_user']-&gt;format_date($last_visit),
-		'POSTS'			=&gt; ($data['user_posts']) ? $data['user_posts'] : 0,
-
-		'ONLINE_IMG'	=&gt; ($online) ? $_CLASS['core_user']-&gt;img('btn_online', $_CLASS['core_user']-&gt;lang['USER_ONLINE']) : $_CLASS['core_user']-&gt;img('btn_offline', $_CLASS['core_user']-&gt;lang['USER_ONLINE']),
-		'RANK_IMG'		=&gt; $rank_img,
-		'ICQ_STATUS_IMG'=&gt; ($data['user_icq']) ? '&lt;img src=&quot;<A HREF="http://web.icq.com/whitepages/online?icq=">http://web.icq.com/whitepages/online?icq=</A>' . $data['user_icq'] . '&amp;img=5&quot; width=&quot;18&quot; height=&quot;18&quot; border=&quot;0&quot; /&gt;' : '',
-
-		'U_PROFILE'		=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u='.$user_id),
-		'U_SEARCH_USER'	=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($data['username']) . '&amp;show_results=posts') : '',
-		'U_PM'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$user_id) : '',
-		'U_EMAIL'		=&gt; $email,
-		'U_WWW'			=&gt; ($data['user_website']) ? $data['user_website'] : '',
-		'U_ICQ'			=&gt; ($data['user_icq']) ? generate_link('Members_List&amp;mode=contact&amp;action=icq&amp;u='.$user_id) : '',
-		'U_AIM'			=&gt; ($data['user_aim']) ? generate_link('Members_List&amp;mode=contact&amp;action=aim&amp;u='.$user_id) : '',
-		'U_YIM'			=&gt; ($data['user_yim']) ? '<A HREF="http://edit.yahoo.com/config/send_webmesg?.target=">http://edit.yahoo.com/config/send_webmesg?.target=</A>' . $data['user_yim'] . '&amp;.src=pg' : '',
-		'U_MSN'			=&gt; ($data['user_msnm']) ? generate_link('Members_List&amp;mode=contact&amp;action=msnm&amp;u='.$user_id) : '',
-		'U_JABBER'		=&gt; ($data['user_jabber']) ? generate_link('Members_List&amp;mode=contact&amp;action=jabber&amp;u='.$user_id) : '',
-
-		'S_ONLINE'		=&gt; $online
-	);
-}
-
 ?&gt;
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000086.html">[Viperals-svncheckins] r166 - in cms/trunk: includes/templates/modules modules modules/quick_message modules/quick_message/quick_message2
</A></li>
	<LI>Next message: <A HREF="000088.html">[Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87">[ date ]</a>
              <a href="thread.html#87">[ thread ]</a>
              <a href="subject.html#87">[ subject ]</a>
              <a href="author.html#87">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
