<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r168%20-%20in%20cms/trunk%3A%20.%20includes%20includes/compatiblity%20includes/forums%20includes/templates/modules%20includes/templates/modules/control_panel%20includes/templates/modules/forums%20includes/templates/modules/members_list%20includes/templates/modules/quick_message%20install%20modules/control_panel%20modules/control_panel/modules%20modules/forums%20modules/quick_message&In-Reply-To=%3C200510271601.j9RG1nRS022321%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000087.html">
   <LINK REL="Next"  HREF="000089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r168%20-%20in%20cms/trunk%3A%20.%20includes%20includes/compatiblity%20includes/forums%20includes/templates/modules%20includes/templates/modules/control_panel%20includes/templates/modules/forums%20includes/templates/modules/members_list%20includes/templates/modules/quick_message%20install%20modules/control_panel%20modules/control_panel/modules%20modules/forums%20modules/quick_message&In-Reply-To=%3C200510271601.j9RG1nRS022321%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r168 - in cms/trunk: . includes includes/compatiblity includes/forums includes/templates/modules includes/templates/modules/control_panel includes/templates/modules/forums includes/templates/modules/members_list includes/templates/modules/quick_message install modules/control_panel modules/control_panel/modules modules/forums modules/quick_message">viperal at berlios.de
       </A><BR>
    <I>Thu Oct 27 18:01:49 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000087.html">[Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language
</A></li>
        <LI>Next message: <A HREF="000089.html">[Viperals-svncheckins] r169 - in cms/trunk: . admin admin/functions includes includes/display includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users install modules/forums themes_admin/viperal_admin themes_admin/viperal_admin/template
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#88">[ date ]</a>
              <a href="thread.html#88">[ thread ]</a>
              <a href="subject.html#88">[ subject ]</a>
              <a href="author.html#88">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-10-27 18:01:46 +0200 (Thu, 27 Oct 2005)
New Revision: 168

Added:
   cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html
Removed:
   cms/trunk/includes/templates/modules/Recommend_Us/
   cms/trunk/includes/templates/modules/control_panel/Control_Panel/
   cms/trunk/includes/templates/modules/google_search/
   cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html
   cms/trunk/includes/templates/modules/quick_message/Quick_Message/
   cms/trunk/modules/quick_message/quick_message2/
Modified:
   cms/trunk/includes/compatiblity/mbstring.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html
   cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html
   cms/trunk/includes/templates/modules/forums/posting_topic_review.html
   cms/trunk/includes/templates/modules/members_list/memberlist_body.html
   cms/trunk/includes/templates/modules/members_list/memberlist_footer.html
   cms/trunk/index.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/control_panel/modules/ucp_attachments.php
   cms/trunk/modules/control_panel/modules/ucp_groups.php
   cms/trunk/modules/control_panel/modules/ucp_main.php
   cms/trunk/modules/control_panel/modules/ucp_pm.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
   cms/trunk/modules/control_panel/modules/ucp_profile.php
   cms/trunk/modules/control_panel/modules/ucp_register.php
   cms/trunk/modules/control_panel/modules/ucp_zebra.php
   cms/trunk/modules/forums/download.php
Log:
Yes, It's still broken.  Hopefully it will be moderately functional by today.......

Modified: cms/trunk/includes/compatiblity/mbstring.php
===================================================================
--- cms/trunk/includes/compatiblity/mbstring.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/compatiblity/mbstring.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -26,7 +26,9 @@
 	next your going to say you can't use a database *
 */
 
-define('MB_CASE_TITLE', 0);
<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">+ at define</A>('MB_CASE_UPPER', 0);
<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">+ at define</A>('MB_CASE_LOWER', 1);
<A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">+ at define</A>('MB_CASE_TITLE', 2);
 
 if (!function_exists('mb_internal_encoding'))
 {
@@ -80,8 +82,21 @@
 {
 	function mb_convert_case($string, $mode = null, $encoding = null)
 	{
-		// maybe add modes
-		return ucfirst(strtolower($string));
+		switch ($mode)
+		{
+			case MB_CASE_TITLE:
+/* Make do some make this complete */
+				return ucfirst(strtolower($string));
+			break;
+
+			case MB_CASE_UPPER:
+				return strtoupper($string);
+			break;
+
+			case MB_CASE_LOWER:
+				return strtolower($string);
+			break;
+		}
 	}
 }
 
@@ -92,4 +107,13 @@
 		return strtolower($string);
 	}
 }
+
+if (!function_exists('mb_strtoupper'))
+{
+	function mb_strtoupper($string, $encoding = null)
+	{
+		return strtoupper($string);
+	}
+}
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/auth.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -37,7 +37,7 @@
 	var $option = array();
 	var $acl_options = array();
 
-	function acl(&amp;$userdata)
+	function acl($userdata)
 	{
 		global $_CLASS;
 

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/functions.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -1011,14 +1011,6 @@
 	return $bump_time;
 }
 
-// Smiley processing
-function smiley_text($text, $force_option = false)
-{
-	global $config, $_CLASS;
-
-	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']-&gt;user_data_get('viewsmilies')) ? preg_replace('#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#', '\1', $text) : str_replace('&lt;img src=&quot;{SMILIES_PATH}', '&lt;img src=&quot;' . $config['smilies_path'], $text);
-}
-
 // Inline Attachment processing
 function parse_inline_attachments(&amp;$text, $attachments, &amp;$update_count, $forum_id = 0, $preview = false)
 {

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/forums/message_parser.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -27,22 +27,8 @@
     die;
 }
 
-// case-insensitive strpos() - needed for some functions
-if (!function_exists('stripos'))
-{
-	function stripos($haystack, $needle)
-	{
-		if (preg_match('#' . preg_quote($needle, '#') . '#i', $haystack, $m))
-		{
-			return strpos($haystack, $m[0]);
-		}
+require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 
-		return false;
-	}
-}
-
-require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
-
 // BBCODE_FIRSTPASS
 //
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/functions.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -544,7 +544,7 @@
 	return $hidden_fields;
 }
 
-function generate_pagination($base_url, $total, $per_page = 10, $start = 0, $admin_link = false)
+function generate_pagination($base_url, $total, $per_page = 10, $start = 0, $admin_link = false, $wrapper = false)
 {
 	global $_CLASS;
 
@@ -553,10 +553,13 @@
 		return false;
 	}
 
-	$wrapper['normal'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
-	$wrapper['current'] = '&lt;span class=&quot;page_link_normal&quot;&gt;%2$d&lt;/span&gt;';
-	$wrapper['first'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
-	$wrapper['last'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
+	if (!$wrapper)
+	{
+		$wrapper['normal'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
+		$wrapper['current'] = '&lt;span class=&quot;page_link_normal&quot;&gt;%2$d&lt;/span&gt;';
+		$wrapper['first'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
+		$wrapper['last'] = '&lt;span class=&quot;page_link_normal&quot;&gt;&lt;a href=&quot;%1$s&quot;&gt;%2$d&lt;/a&gt;&lt;/span&gt;';
+	}
 
 	$total_pages = ceil($total / $per_page);
 	$current_page = ($start) ? floor($start / $per_page) + 1 : 1;
@@ -640,7 +643,8 @@
 			require_once $file;
 		}
 
-		$_CLASS[$name] =&amp; new $class;
+		//$_CLASS[$name] =&amp; new $class;
+		$_CLASS[$name] = new $class;
 	}
 }
 
@@ -1026,4 +1030,27 @@
 	}
 }
 
+
+// FROM PHPBB
+
+// Smiley processing
+function smiley_text($text, $force_option = false)
+{
+	global $config, $_CLASS;
+
+	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']-&gt;user_data_get('viewsmilies')) ? preg_replace('#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#', '\1', $text) : str_replace('&lt;img src=&quot;{SMILIES_PATH}', '&lt;img src=&quot;' . $config['smilies_path'], $text);
+}
+
+if (!function_exists('stripos'))
+{
+	function stripos($haystack, $needle)
+	{
+		if (preg_match('#' . preg_quote($needle, '#') . '#i', $haystack, $m))
+		{
+			return strpos($haystack, $m[0]);
+		}
+
+		return false;
+	}
+}
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/control_panel/ucp_attachments.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -50,7 +50,7 @@
 			&lt;td class=&quot;gensmall&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;{ $attachrow:POST_TIME }&nbsp;&lt;/td&gt;
 			&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;{ $attachrow:SIZE }&lt;/td&gt;
 			&lt;td class=&quot;genmed&quot; style=&quot;padding: 4px;&quot; align=&quot;center&quot;&gt;{ $attachrow:DOWNLOAD_COUNT }&lt;/td&gt;
-			&lt;td style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attachment[{ $attachrow:ATTACH_ID }]&quot; value=&quot;1&quot; /&gt;&lt;/td&gt;
+			&lt;td style=&quot;padding: 4px;&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;attachment[]&quot; value=&quot;{ $attachrow:ATTACH_ID }&quot; /&gt;&lt;/td&gt;
 		&lt;/tr&gt;
 		&lt;!-- ENDLOOP --&gt;
 		
@@ -62,7 +62,6 @@
 	&lt;div style=&quot;float:right&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('ucp', true);&quot;&gt;{ $L_MARK_ALL }&lt;/a&gt; :: &lt;a  href=&quot;javascript:marklist('ucp', false);&quot;&gt;{ $L_UNMARK_ALL }&lt;/a&gt;&lt;/b&gt;&lt;/div&gt;
 &lt;/form&gt;
 &lt;!-- ELSE --&gt;
-
 &lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
 	&lt;tr&gt;
 		&lt;th height=&quot;28&quot;&gt;{ $L_TITLE }&lt;/th&gt;

Modified: cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html
===================================================================
--- cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/control_panel/ucp_main_front.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -57,17 +57,9 @@
 				&lt;td width=&quot;100%&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $VISITED }&lt;/b&gt;&lt;/td&gt;
 			&lt;/tr&gt;
 			&lt;tr&gt; 
-				&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_TOTAL_POSTS }: &lt;/b&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;!-- IF { $POSTS_PCT } --&gt;&lt;b class=&quot;gen&quot;&gt;{ $POSTS }&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;genmed&quot;&gt;[{ $POSTS_PCT } / { $POSTS_DAY }]&lt;br /&gt;&lt;a href=&quot;{ $U_SEARCH_USER }&quot;&gt;{ $L_SEARCH_USER_POSTS }&lt;/a&gt;&lt;/span&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $POSTS }&lt;b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
+				&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_TOTAL_FORUM_POSTS }: &lt;/b&gt;&lt;/td&gt;
+				&lt;td&gt;&lt;!-- IF { $POSTS } --&gt;&lt;b class=&quot;gen&quot;&gt;{ $POSTS }&lt;/b&gt;&lt;br /&gt;&lt;a href=&quot;{ $U_SEARCH_MY_POSTS }&quot;&gt;{ $L_SEARCH_USER_POSTS }&lt;/a&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;gen&quot;&gt;{ $POSTS }&lt;b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ACTIVE_IN_FORUM }: &lt;/b&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;!-- IF { $ACTIVE_FORUM_PCT } --&gt;&lt;b&gt;&lt;a class=&quot;gen&quot; href=&quot;{ $U_ACTIVE_FORUM }&quot;&gt;{ $ACTIVE_FORUM }&lt;/a&gt;&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;genmed&quot;&gt;[ { $ACTIVE_FORUM_POSTS } / { $ACTIVE_FORUM_PCT } ]&lt;/span&gt;&lt;!-- ELSE --&gt;&lt;span class=&quot;gen&quot;&gt;-&lt;/span&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_ACTIVE_IN_TOPIC }: &lt;/b&gt;&lt;/td&gt;
-				&lt;td&gt;&lt;!-- IF { $ACTIVE_TOPIC_PCT } --&gt;&lt;b&gt;&lt;a class=&quot;gen&quot; href=&quot;{ $U_ACTIVE_TOPIC }&quot;&gt;{ $ACTIVE_TOPIC }&lt;/a&gt;&lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;[ { $ACTIVE_TOPIC_POSTS } / { $ACTIVE_TOPIC_PCT } ]&lt;/span&gt;&lt;!-- ELSE --&gt;&lt;span class=&quot;gen&quot;&gt;-&lt;/span&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
-			&lt;/tr&gt;
 			&lt;!-- IF { $WARNINGS } --&gt;
 			&lt;tr&gt;
 				&lt;td align=&quot;right&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{ $L_YOUR_WARNINGS }: &lt;/b&gt;&lt;/td&gt;

Modified: cms/trunk/includes/templates/modules/forums/posting_topic_review.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/posting_topic_review.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/forums/posting_topic_review.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -28,7 +28,7 @@
 						&lt;tr&gt;
 							&lt;td valign=&quot;top&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;2&quot;&gt;
 								&lt;tr&gt;
-									&lt;td&gt;&lt;div id=&quot;message_{ $topic_review_row:U_POST_ID }&quot;&gt;&lt;div class=&quot;postbody&quot;&gt;{ $topic_review_row:MESSAGE }&lt;/div&gt;&lt;/div&gt;&lt;/td&gt;
+									&lt;td&gt;&lt;div class=&quot;postbody&quot; id=&quot;message_{ $topic_review_row:U_POST_ID }&quot;&gt;{ $topic_review_row:MESSAGE }&lt;/div&gt;&lt;/td&gt;
 								&lt;/tr&gt;
 							&lt;/table&gt;&lt;/td&gt;
 						&lt;/tr&gt;

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -49,9 +49,8 @@
 		&lt;tr&gt;
 			&lt;th nowrap=&quot;nowrap&quot;&gt;#&lt;/th&gt;
 			&lt;th nowrap=&quot;nowrap&quot; width=&quot;&lt;!-- IF { $S_SEND_MESSAGE } --&gt;20&lt;!-- ELSE --&gt;34&lt;!-- ENDIF --&gt;%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_USERNAME }&quot;&gt;{ $L_USERNAME }&lt;/a&gt;&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_POSTS }&quot;&gt;{ $L_ONLINE }&lt;/a&gt;&lt;/th&gt;
 			&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_JOINED }&quot;&gt;{ $L_JOINED }&lt;/a&gt;&lt;/th&gt;
-			&lt;th nowrap=&quot;nowrap&quot; width=&quot;10%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_POSTS }&quot;&gt;{ $L_POSTS }&lt;/a&gt;&lt;/th&gt;
-			&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;&lt;a class=&quot;th&quot; href=&quot;{ $U_SORT_RANK }&quot;&gt;{ $L_RANK }&lt;/a&gt;&lt;/th&gt;
 		&lt;!-- IF { $S_SEND_MESSAGE } --&gt;
 			&lt;th nowrap=&quot;nowrap&quot; width=&quot;11%&quot;&gt;{ $L_SEND_MESSAGE }&lt;/th&gt;
 		&lt;!-- ENDIF --&gt;
@@ -77,9 +76,8 @@
 
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $leader_row:#LOOP_NUMBER }&lt;/td&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;strong&gt;&lt;a&lt;!-- IF { $leader_row:USER_COLOR } --&gt; style=&quot;color:#{ $leader_row:USER_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $leader_row:U_VIEWPROFILE }&quot;&gt;{ $leader_row:USERNAME }&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
-			&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;{$leader_row:JOINED}&lt;/td&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $leader_row:POSTS }&lt;/td&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $leader_row:RANK_IMG }&lt;/td&gt;
+			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $leader_row:ONLINE_IMG }&lt;/td&gt;
+			&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt; { $leader_row:JOINED } &lt;/td&gt;
 			&lt;!-- IF { $leader_row:U_PM } --&gt;&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;{ $leader_row:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $leader_row:U_EMAIL } --&gt;&lt;a href=&quot;{ $leader_row:U_EMAIL }&quot;&gt;{ $EMAIL_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $leader_row:U_WWW } --&gt;&lt;a href=&quot;{ $leader_row:U_WWW }&quot; target=&quot;_blank&quot;&gt;{ $WWW_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
@@ -102,9 +100,8 @@
 		&lt;!-- ENDIF --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $member_row:#LOOP_NUMBER }&lt;/td&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;strong&gt;&lt;a&lt;!-- IF { $member_row:USER_COLOR } --&gt; style=&quot;color:#{ $member_row:USER_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $member_row:U_VIEWPROFILE }&quot;&gt;{ $member_row:USERNAME }&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
+			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $member_row:ONLINE_IMG }&lt;/td&gt;
 			&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;{ $member_row:JOINED }&lt;/td&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $member_row:POSTS }&lt;/td&gt;
-			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $member_row:RANK_IMG }&lt;/td&gt;
 			&lt;!-- IF { $member_row:U_PM } --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;a href=&quot;{ $member_row:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;/td&gt;&lt;!-- ENDIF --&gt;
 			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;!-- IF { $member_row:U_EMAIL } --&gt;&lt;a href=&quot;{ $member_row:U_EMAIL }&quot;&gt;{ $EMAIL_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_footer.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_footer.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -1,16 +1 @@
-&lt;!--
-	We request you retain the full copyright notice below including the link to www.phpbb.com.
-	This not only gives respect to the large amount of time given freely by the developers
-	but also helps build interest, traffic and use of phpBB2. If you (honestly) cannot retain
-	the full copyright we ask you at least leave in place the &quot;Powered by phpBB&quot; line, with
-	&quot;phpBB&quot; linked to www.phpbb.com. If you refuse to include even this then support on our 
-	forums may be affected.
-
-	The phpBB Group : 2003
---&gt;
-
-&lt;br /&gt;
-&lt;div style=&quot;text-align: center;&quot; class=&quot;copyright&quot;&gt;
-Based on &lt;a href=&quot;<A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>&quot; target=&quot;phpbb&quot;&gt;phpBB&lt;/a&gt;&lt;/div&gt;
-
 { $THEME_TABLE_CLOSE }
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_forum_moderators.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -0,0 +1,45 @@
+&lt;!-- DISPLAY_HEADER --&gt;
+
+&lt;!-- INCLUDE modules/Members_List/memberlist_header.html --&gt;
+
+&lt;form method=&quot;post&quot; action=&quot;{ $S_MODE_ACTION }&quot;&gt;
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
+		&lt;tr&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;20%&quot;&gt;{ $L_USERNAME }&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;25%&quot;&gt;{ $L_FORUMS }&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;20%&quot;&gt;{ $L_PRIMARY_GROUP }&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;{ $L_RANK }&lt;/th&gt;
+			&lt;th nowrap=&quot;nowrap&quot; width=&quot;11%&quot;&gt;{ $L_SEND_MESSAGE }&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr class=&quot;row3&quot;&gt;
+			&lt;td colspan=&quot;9&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_MODERATORS }&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	
+		&lt;!-- LOOP $moderators --&gt;
+			&lt;!-- IF { $moderators:#LOOP_INDEX } % 2 --&gt;&lt;tr class=&quot;row2&quot;&gt;&lt;!-- ELSE --&gt;&lt;tr class=&quot;row1&quot;&gt;&lt;!-- ENDIF --&gt;
+		
+			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;strong&gt;&lt;a&lt;!-- IF { $moderators:USER_COLOR } --&gt; style=&quot;color:#{ $moderators:USER_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $moderators:U_VIEWPROFILE }&quot;&gt;{ $moderators:USERNAME }&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
+			&lt;td align=&quot;center&quot;&gt;&lt;!-- IF !{ $moderators:FORUMS } --&gt;{ $L_ALL_FORUMS }&lt;!-- ELSE --&gt;&lt;select style=&quot;width: 200px;&quot;&gt;{ $moderators:FORUMS }&lt;/select&gt;&lt;!-- ENDIF --&gt;&nbsp;&lt;/td&gt;
+			&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;
+				&lt;!-- IF { $moderators:U_GROUP } --&gt;
+					&lt;a&lt;!-- IF { $moderators:GROUP_COLOR } --&gt; style=&quot;color:#{ $moderators:GROUP_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $moderators:U_GROUP }&quot;&gt;{ $moderators:GROUP_NAME }&lt;/a&gt;
+				&lt;!-- ELSE --&gt;
+					{ $moderators:GROUP_NAME }
+				&lt;!-- ENDIF --&gt;
+			&nbsp;&lt;/td&gt;
+			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $moderators:RANK_IMG }&lt;/td&gt;
+			&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&nbsp;&lt;!-- IF { $moderators:U_PM } --&gt;&lt;a href=&quot;{ $moderators:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&nbsp;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOPELSE --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; colspan=&quot;9&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO_MEMBERS }&lt;/span&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP $moderators --&gt;
+	&lt;/table&gt;
+&lt;/form&gt;
+
+&lt;br clear=&quot;all&quot; /&gt;
+
+&lt;!-- INCLUDE modules/Members_List/memberlist_footer.html --&gt;
+
+&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_leaders.html	2005-10-27 16:01:46 UTC (rev 168)
@@ -1,69 +0,0 @@
-&lt;!-- DISPLAY_HEADER --&gt;
-
-&lt;!-- INCLUDE modules/Members_List/memberlist_header.html --&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;{$S_MODE_ACTION}&quot;&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
-&lt;tr&gt;
-	&lt;th nowrap=&quot;nowrap&quot; width=&quot;20%&quot;&gt;{ $L_USERNAME }&lt;/th&gt;
-	&lt;th nowrap=&quot;nowrap&quot; width=&quot;25%&quot;&gt;{ $L_FORUMS }&lt;/th&gt;
-	&lt;th nowrap=&quot;nowrap&quot; width=&quot;20%&quot;&gt;{ $L_PRIMARY_GROUP }&lt;/th&gt;
-	&lt;th nowrap=&quot;nowrap&quot; width=&quot;15%&quot;&gt;{ $L_RANK }&lt;/th&gt;
-	&lt;th nowrap=&quot;nowrap&quot; width=&quot;11%&quot;&gt;{ $L_SEND_MESSAGE }&lt;/th&gt;
-&lt;/tr&gt;
-&lt;tr class=&quot;row3&quot;&gt;
-	&lt;td colspan=&quot;5&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_ADMINISTRATORS }&lt;/b&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- LOOP $admin --&gt;
-	&lt;!-- IF { $admin:#LOOP_INDEX is even } --&gt;&lt;tr class=&quot;row2&quot;&gt;&lt;!-- ELSE --&gt;&lt;tr class=&quot;row1&quot;&gt;&lt;!-- ENDIF --&gt;
-
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;strong&gt;&lt;a&lt;!-- IF { $admin:USER_COLOR } --&gt; style=&quot;color:#{ $admin:USER_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $admin:U_VIEWPROFILE }&quot;&gt;{ $admin:USERNAME }&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
-	&lt;td class=&quot;gensmall&quot; align=&quot;center&quot;&gt;&nbsp;&lt;/td&gt;
-	&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;
-		&lt;!-- IF { $admin:U_GROUP } --&gt;
-			&lt;a&lt;!-- IF { $admin:GROUP_COLOR } --&gt; style=&quot;color:#{ $admin:GROUP_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $admin:U_GROUP }&quot;&gt;{ $admin:GROUP_NAME }&lt;/a&gt;
-		&lt;!-- ELSE --&gt;
-			{ $admin:GROUP_NAME }
-		&lt;!-- ENDIF --&gt;
-	&nbsp;&lt;/td&gt;
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $admin:RANK_IMG }&lt;/td&gt;
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&nbsp;&lt;!-- IF { $admin:U_PM } --&gt;&lt;a href=&quot;{ $admin:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&nbsp;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- LOOPELSE --&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row1&quot; colspan=&quot;9&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO_MEMBERS }&lt;/span&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- ENDLOOP --&gt;
-&lt;tr class=&quot;row3&quot;&gt;
-	&lt;td colspan=&quot;9&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;{ $L_MODERATORS }&lt;/b&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- LOOP $mod --&gt;
-	&lt;!-- IF { $mod:S_ROW_COUNT is even } --&gt;&lt;tr class=&quot;row2&quot;&gt;&lt;!-- ELSE --&gt;	&lt;tr class=&quot;row1&quot;&gt;&lt;!-- ENDIF --&gt;
-
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;strong&gt;&lt;a&lt;!-- IF { $mod:USER_COLOR } --&gt; style=&quot;color:#{ $mod:USER_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $mod:U_VIEWPROFILE }&quot;&gt;{ $mod:USERNAME }&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
-	&lt;td align=&quot;center&quot;&gt;&lt;!-- IF !{ $mod:FORUMS } --&gt;{ $L_ALL_FORUMS }&lt;!-- ELSE --&gt;&lt;select style=&quot;width: 200px;&quot;&gt;{ $mod:FORUMS }&lt;/select&gt;&lt;!-- ENDIF --&gt;&nbsp;&lt;/td&gt;
-	&lt;td class=&quot;gensmall&quot; align=&quot;center&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;
-		&lt;!-- IF { $mod:U_GROUP } --&gt;
-			&lt;a&lt;!-- IF { $mod:GROUP_COLOR } --&gt; style=&quot;color:#{ $mod:GROUP_COLOR }&quot;&lt;!-- ENDIF --&gt; href=&quot;{ $mod:U_GROUP }&quot;&gt;{ $mod:GROUP_NAME }&lt;/a&gt;
-		&lt;!-- ELSE --&gt;
-			{ $mod:GROUP_NAME }
-		&lt;!-- ENDIF --&gt;
-	&nbsp;&lt;/td&gt;
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;{ $mod:RANK_IMG }&lt;/td&gt;
-	&lt;td class=&quot;gen&quot; align=&quot;center&quot;&gt;&nbsp;&lt;!-- IF { $mod:U_PM } --&gt;&lt;a href=&quot;{ $mod:U_PM }&quot;&gt;{ $PM_IMG }&lt;/a&gt;&lt;!-- ENDIF --&gt;&nbsp;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- LOOPELSE --&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row1&quot; colspan=&quot;9&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO_MEMBERS }&lt;/span&gt;&lt;/td&gt;
-&lt;/tr&gt;
-&lt;!-- ENDLOOP --&gt;
-&lt;/table&gt;
-	
-&lt;/form&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;!-- INCLUDE modules/Members_List/memberlist_footer.html --&gt;
-
-&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/index.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -27,7 +27,8 @@
 /* require_once SITE_FILE_ROOT.'core.php'; */
 require_once 'core.php';
 
-$mod = get_variable('mod', 'REQUEST', false);
+/* mb_strtolower is a temp... */
+$mod = mb_strtolower(get_variable('mod', 'REQUEST', false));
 
 if (!$mod)
 {

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/install/build_data.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -139,12 +139,12 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;control_panel_modules (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 1, 1, 102)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('Contact', 1, 2, 102)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('contact', 1, 2, 102)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 1, 1, 98)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('Control_Panel', 1, 2, 98)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('Forums', 1, 2, 98)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('Members_List', 1, 2, 98)&quot;);
-$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('Quick_Message', 1, 1, 102)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 1, 2, 98)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('forums', 1, 2, 98)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('members_List', 1, 2, 98)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;pages (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 1, 1, 102)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)&quot;);

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/index.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -51,19 +51,23 @@
 	function process_module($type = 'page')
 	{
 		global $_CLASS;
-
-		$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. &quot;
-					WHERE module_name = '&quot;.$_CLASS['core_db']-&gt;escape($this-&gt;module).&quot;'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
 		
-		if (!$module_info = $_CLASS['core_db']-&gt;fetch_row_assoc($result) || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this-&gt;module . '.php'))
+		if ($this-&gt;module)
 		{
+			$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. &quot;
+					WHERE module_name = '&quot;.$_CLASS['core_db']-&gt;escape($this-&gt;module).&quot;'&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$module_info = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		}
+
+		if (!$this-&gt;module || !$module_info || !file_exists(SITE_FILE_ROOT.'modules/Control_Panel/modules/ucp_' . $this-&gt;module . '.php'))
+		{
 			$this-&gt;module = 'main';
-			$this-&gt;mode = false;
+			$this-&gt;mode = ($this-&gt;module) ? false : $this-&gt;mode;
 		}
-		
-		$this-&gt;link_standard = $this-&gt;link = 'control_panel&amp;i='.$this-&gt;module;
 
+		$this-&gt;link_parent = $this-&gt;link = 'control_panel&amp;i='.$this-&gt;module;
+
 		if ($this-&gt;mode)
 		{
 			$this-&gt;link .= '&amp;mode='.$this-&gt;mode;
@@ -161,14 +165,11 @@
 			'friends_offline' 		=&gt; false,
 		));
 		
-		$mode = get_variable('mode', 'REQUEST');
-		$module = get_variable('i', 'REQUEST');
-
 		$_CLASS['core_user']-&gt;add_lang();
 
-		if (!$module &amp;&amp; $mode)
+		if (!$this-&gt;module &amp;&amp; $this-&gt;mode)
 		{
-			switch ($mode)
+			switch ($this-&gt;mode)
 			{
 				case 'register':
 					if ($_CLASS['core_user']-&gt;is_user || $_CLASS['core_user']-&gt;is_bot)
@@ -245,7 +246,7 @@
 		$this-&gt;process_module('page');
 		$this-&gt;generate_panel_block('page');
 
-		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $module . '.php';
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_' . $this-&gt;module . '.php';
 	}
 }
 

Modified: cms/trunk/modules/control_panel/modules/ucp_attachments.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_attachments.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_attachments.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -15,148 +15,152 @@
 // * Use this for ACP integration - changeable user id
 //
 
-class ucp_attachments extends module
+
+global $_CLASS, $config, $site_file_root;
+
+$start	= get_variable('start', 'REQUEST', 0, 'int');
+$delete = isset($_POST['delete']);
+$confirm = isset($_POST['confirm']);
+
+// change this
+$delete_ids = array_unique(get_variable('attachment', 'POST', array(), 'array:int'));
+
+if (!empty($delete_ids))
 {
-	function ucp_attachments($id, $mode)
+	$hidden_fields['delete'] = 1;
+	$hidden_fields['attachment'] = $delete_ids;
+
+	if (display_confirmation($_CLASS['core_user']-&gt;get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), generate_hidden_fields($hidden_fields)))
 	{
-		global $_CLASS, $config, $site_file_root;
+		require_once $site_file_root.'includes/forums/functions_admin.php';
+		require_once $site_file_root.'includes/forums/functions.php';
 
-		$start	= request_var('start', 0);
-		$delete = (isset($_POST['delete'])) ? true : false;
-		$confirm = (isset($_POST['confirm'])) ? true : false;
-		$delete_ids = isset($_REQUEST['attachment']) ? array_keys(array_map('intval', $_REQUEST['attachment'])) : array();
-		
-		if (!empty($delete_ids))
-		{
-			$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;delete&quot; value=&quot;1&quot; /&gt;';
-			foreach ($delete_ids as $attachment_id)
-			{
-				$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;attachment[' . $attachment_id . ']&quot; value=&quot;1&quot; /&gt;';
-			}
+		$_CLASS['core_db']-&gt;transaction();
+		delete_attachments('attach', $delete_ids);
+		$_CLASS['core_db']-&gt;transaction('commit');
 
-			if (display_confirmation($_CLASS['core_user']-&gt;get_lang((count($delete_ids) == 1) ? 'DELETE_ATTACHMENT' : 'DELETE_ATTACHMENTS'), $s_hidden_fields))
-			{
-				require($site_file_root.'includes/forums/functions_admin.php');
-				delete_attachments('attach', $delete_ids);
+		$return_link = generate_link($this-&gt;link_parent);
 
-				$refresh_url = generate_link('Control_Panel&amp;i='.$id);
-				$_CLASS['core_display']-&gt;meta_refresh(3, $refresh_url);
-				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']-&gt;lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']-&gt;lang['ATTACHMENTS_DELETED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $refresh_url . '&quot;&gt;', '&lt;/a&gt;');
+		$_CLASS['core_display']-&gt;meta_refresh(3, $return_link);
+		$message = ((count($delete_ids) === 1) ? $_CLASS['core_user']-&gt;lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']-&gt;lang['ATTACHMENTS_DELETED']) . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $return_link . '&quot;&gt;', '&lt;/a&gt;');
 
-				trigger_error($message);
-			}
-		}
-		
-		$sort_key = request_var('sk', 'a');
-		$sort_dir = request_var('sd', 'a');
+		trigger_error($message);
+	}
+}
 
-		// Select box eventually
-		$sort_key_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['SORT_FILENAME'], 'b' =&gt; $_CLASS['core_user']-&gt;lang['SORT_COMMENT'], 'c' =&gt; $_CLASS['core_user']-&gt;lang['SORT_EXTENSION'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['SORT_SIZE'], 'e' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DOWNLOADS'], 'f' =&gt; $_CLASS['core_user']-&gt;lang['SORT_POST_TIME'], 'g' =&gt; $_CLASS['core_user']-&gt;lang['SORT_TOPIC_TITLE']);
-		$sort_key_sql = array('a' =&gt; 'a.real_filename', 'b' =&gt; 'a.comment', 'c' =&gt; 'a.extension', 'd' =&gt; 'a.filesize', 'e' =&gt; 'a.download_count', 'f' =&gt; 'a.filetime', 'g' =&gt; 't.topic_title');
+$sort_key = get_variable('sk', 'REQUEST', 'a');
+$sort_dir = get_variable('sd', 'REQUEST', 'a');
 
-		$sort_dir_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
-	
-		$s_sort_key = '';
-		foreach ($sort_key_text as $key =&gt; $value)
-		{
-			$selected = ($sort_key == $key) ? ' selected=&quot;selected&quot;' : '';
-			$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-		}
+// Select box eventually
+$sort_key_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['SORT_FILENAME'], 'b' =&gt; $_CLASS['core_user']-&gt;lang['SORT_COMMENT'], 'c' =&gt; $_CLASS['core_user']-&gt;lang['SORT_EXTENSION'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['SORT_SIZE'], 'e' =&gt; $_CLASS['core_user']-&gt;lang['SORT_DOWNLOADS'], 'f' =&gt; $_CLASS['core_user']-&gt;lang['SORT_POST_TIME'], 'g' =&gt; $_CLASS['core_user']-&gt;lang['SORT_TOPIC_TITLE']);
+$sort_key_sql = array('a' =&gt; 'a.real_filename', 'b' =&gt; 'a.comment', 'c' =&gt; 'a.extension', 'd' =&gt; 'a.filesize', 'e' =&gt; 'a.download_count', 'f' =&gt; 'a.filetime', 'g' =&gt; 't.topic_title');
 
-		$s_sort_dir = '';
-		foreach ($sort_dir_text as $key =&gt; $value)
-		{
-			$selected = ($sort_dir == $key) ? ' selected=&quot;selected&quot;' : '';
-			$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-		}
+$sort_dir_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
 
-		$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
-		
-		$sql = 'SELECT COUNT(*) as num_attachments
-			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
-			WHERE poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-		list($num_attachments) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-		
-		$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
-			FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
-				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
-					AND a.in_message = 0)
-				LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
-					AND a.in_message = 1)
-			WHERE a.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-			ORDER BY $order_by&quot;;
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['posts_per_page'], $start);
+$s_sort_key = '';
+foreach ($sort_key_text as $key =&gt; $value)
+{
+	$selected = ($sort_key == $key) ? ' selected=&quot;selected&quot;' : '';
+	$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
+}
 
-		$row_count = 0;
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', true);
+$s_sort_dir = '';
+foreach ($sort_dir_text as $key =&gt; $value)
+{
+	$selected = ($sort_dir == $key) ? ' selected=&quot;selected&quot;' : '';
+	$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
+}
 
-			do
-			{
-				if ($row['in_message'])
-				{
-					$view_topic = generate_link('Control_Panel&amp;i=pm&amp;p='.$row['post_msg_id']);
-				}
-				else
-				{
-					$view_topic = generate_link(&quot;Forums&amp;file=viewtopic&amp;t={$row['topic_id']}&amp;p={$row['post_msg_id']}#{$row['post_msg_id']}&quot;);
-				}
+$order_by = $sort_key_sql[$sort_key] . '  ' . (($sort_dir == 'a') ? 'ASC' : 'DESC');
 
-				$_CLASS['core_template']-&gt;assign_vars_array('attachrow', array(
-					'ROW_NUMBER'		=&gt; $row_count + ($start + 1),
-					'FILENAME'			=&gt; $row['real_filename'],
-					'COMMENT'			=&gt; str_replace(&quot;\n&quot;, '&lt;br /&gt;', $row['comment']),
-					'EXTENSION'			=&gt; $row['extension'],
-					'SIZE'				=&gt; ($row['filesize'] &gt;= 1048576) ? ($row['filesize'] &gt;&gt; 20) . ' ' . $_CLASS['core_user']-&gt;lang['MB'] : (($row['filesize'] &gt;= 1024) ? ($row['filesize'] &gt;&gt; 10) . ' ' . $_CLASS['core_user']-&gt;lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']-&gt;lang['BYTES']),
-					'DOWNLOAD_COUNT'	=&gt; $row['download_count'],
-					'POST_TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['filetime'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']),
-					'TOPIC_TITLE'		=&gt; ($row['in_message']) ? $row['message_title'] : $row['topic_title'],
+$sql = 'SELECT COUNT(*) as num_attachments
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+	WHERE poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+$result = $_CLASS['core_db']-&gt;query($sql);
+list($num_attachments) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+$_CLASS['core_db']-&gt;free_result($result);
 
-					'ATTACH_ID'			=&gt; $row['attach_id'],
-					'POST_ID'			=&gt; $row['post_msg_id'],
-					'TOPIC_ID'			=&gt; $row['topic_id'],
-				
-					'S_IN_MESSAGE'		=&gt; $row['in_message'],
+$sql = 'SELECT a.*, t.topic_title, p.message_subject as message_title
+	FROM ' . FORUMS_ATTACHMENTS_TABLE . ' a 
+		LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON (a.topic_id = t.topic_id
+			AND a.in_message = 0)
+		LEFT JOIN ' . FORUMS_PRIVMSGS_TABLE . ' p ON (a.post_msg_id = p.msg_id
+			AND a.in_message = 1)
+	WHERE a.poster_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+	ORDER BY $order_by&quot;;
+$result = $_CLASS['core_db']-&gt;query_limit($sql, 10, $start);
 
-					'U_VIEW_ATTACHMENT'	=&gt; generate_link('Forums&amp;file=download&amp;id=' . $row['attach_id']),
-					'U_VIEW_TOPIC'		=&gt; $view_topic)
-				);
+$row_count = 0;
 
-				$row_count++;
-			} 
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', true);
+
+	do
+	{
+		if ($row['in_message'])
+		{
+			$view_topic = generate_link('control_panel&amp;i=pm&amp;p='.$row['post_msg_id']);
 		}
 		else
 		{
-			$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', false);
+			$view_topic = generate_link(&quot;forums&amp;file=viewtopic&amp;t={$row['topic_id']}&amp;p={$row['post_msg_id']}#{$row['post_msg_id']}&quot;);
 		}
-		$_CLASS['core_db']-&gt;free_result($result);
 
-		$_CLASS['core_template']-&gt;assign_array(array( 
-			'PAGE_NUMBER'			=&gt; on_page($num_attachments, $config['posts_per_page'], $start),
-			'PAGINATION'			=&gt; generate_pagination(&quot;Control_Panel&amp;i=$id&amp;sk=$sort_key&amp;sd=$sort_dir&quot;, $num_attachments, $config['posts_per_page'], $start),
-			'TOTAL_ATTACHMENTS'		=&gt; $num_attachments,
-			
-			'U_SORT_FILENAME'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=a&amp;sd=&quot; . (($sort_key == 'a' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_FILE_COMMENT'	=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=b&amp;sd=&quot; . (($sort_key == 'b' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_EXTENSION'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=c&amp;sd=&quot; . (($sort_key == 'c' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_FILESIZE'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=d&amp;sd=&quot; . (($sort_key == 'd' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_DOWNLOADS'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=e&amp;sd=&quot; . (($sort_key == 'e' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_POST_TIME'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=f&amp;sd=&quot; . (($sort_key == 'f' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
-			'U_SORT_TOPIC_TITLE'	=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;sk=g&amp;sd=&quot; . (($sort_key == 'f' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+		$_CLASS['core_template']-&gt;assign_vars_array('attachrow', array(
+			'ROW_NUMBER'		=&gt; $row_count + ($start + 1),
+			'FILENAME'			=&gt; $row['real_filename'],
+			'COMMENT'			=&gt; str_replace(&quot;\n&quot;, '&lt;br /&gt;', $row['comment']),
+			'EXTENSION'			=&gt; $row['extension'],
+			'SIZE'				=&gt; ($row['filesize'] &gt;= 1048576) ? ($row['filesize'] &gt;&gt; 20) . ' ' . $_CLASS['core_user']-&gt;lang['MB'] : (($row['filesize'] &gt;= 1024) ? ($row['filesize'] &gt;&gt; 10) . ' ' . $_CLASS['core_user']-&gt;lang['KB'] : $row['filesize'] . ' ' . $_CLASS['core_user']-&gt;lang['BYTES']),
+			'DOWNLOAD_COUNT'	=&gt; $row['download_count'],
+			'POST_TIME'			=&gt; $_CLASS['core_user']-&gt;format_date($row['filetime'], $_CLASS['core_user']-&gt;lang['DATE_FORMAT']),
+			'TOPIC_TITLE'		=&gt; ($row['in_message']) ? $row['message_title'] : $row['topic_title'],
 
-			'S_DISPLAY_MARK_ALL'	=&gt; ($num_attachments) ? true : false,
-			'S_DISPLAY_PAGINATION'	=&gt; ($num_attachments) ? true : false,
-			'S_UCP_ACTION'			=&gt; generate_link('Control_Panel&amp;i='.$id),
-			'S_SORT_OPTIONS' 		=&gt; $s_sort_key,
-			'S_ORDER_SELECT'		=&gt; $s_sort_dir)
+			'ATTACH_ID'			=&gt; $row['attach_id'],
+			'POST_ID'			=&gt; $row['post_msg_id'],
+			'TOPIC_ID'			=&gt; $row['topic_id'],
+		
+			'S_IN_MESSAGE'		=&gt; $row['in_message'],
+
+			'U_VIEW_ATTACHMENT'	=&gt; generate_link('forums&amp;file=download&amp;id=' . $row['attach_id']),
+			'U_VIEW_TOPIC'		=&gt; $view_topic)
 		);
 
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_ATTACHMENTS'], 'ucp_attachments.html');
-	}
+		$row_count++;
+	} 
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 }
+else
+{
+	$_CLASS['core_template']-&gt;assign('S_ATTACHMENT_ROWS', false);
+}
+$_CLASS['core_db']-&gt;free_result($result);
 
+$pagination = generate_pagination($this-&gt;link.&quot;&amp;sk=$sort_key&amp;sd=$sort_dir&quot;, $num_attachments, 10, $start);
+
+$_CLASS['core_template']-&gt;assign_array(array( 
+	'PAGE_NUMBER'			=&gt; on_page($num_attachments, 10, $start),
+	'PAGINATION'			=&gt; $pagination['formated'],
+	'PAGINATION_ARRAY'		=&gt; $pagination['array'],
+	'TOTAL_ATTACHMENTS'		=&gt; $num_attachments,
+
+	'U_SORT_FILENAME'		=&gt; generate_link($this-&gt;link.'&amp;sk=a&amp;sd=' . (($sort_key == 'a' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_FILE_COMMENT'	=&gt; generate_link($this-&gt;link.'&amp;sk=b&amp;sd=' . (($sort_key == 'b' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_EXTENSION'		=&gt; generate_link($this-&gt;link.'&amp;sk=c&amp;sd=' . (($sort_key == 'c' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_FILESIZE'		=&gt; generate_link($this-&gt;link.'&amp;sk=d&amp;sd=' . (($sort_key == 'd' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_DOWNLOADS'		=&gt; generate_link($this-&gt;link.'&amp;sk=e&amp;sd=' . (($sort_key == 'e' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_POST_TIME'		=&gt; generate_link($this-&gt;link.'&amp;sk=f&amp;sd=' . (($sort_key == 'f' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+	'U_SORT_TOPIC_TITLE'	=&gt; generate_link($this-&gt;link.'&amp;sk=g&amp;sd=' . (($sort_key == 'f' &amp;&amp; $sort_dir == 'a') ? 'd' : 'a')), 
+
+	'S_DISPLAY_MARK_ALL'	=&gt; ($num_attachments) ? true : false,
+	'S_DISPLAY_PAGINATION'	=&gt; ($num_attachments) ? true : false,
+	'S_UCP_ACTION'			=&gt; generate_link($this-&gt;link),
+	'S_SORT_OPTIONS' 		=&gt; $s_sort_key,
+	'S_ORDER_SELECT'		=&gt; $s_sort_dir)
+);
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;lang['UCP_ATTACHMENTS'], 'modules/control_panel/ucp_attachments.html');
+
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_groups.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_groups.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_groups.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,170 +21,164 @@
 $Id$
 */
 
-class ucp_groups extends module
+
+global $_CLASS, $site_file_root;
+
+$_CLASS['core_user']-&gt;add_lang('groups');
+
+$submit	= isset($_POST['submit']);
+
+if ($submit &amp;&amp; !empty($_POST['group_id']))
 {
-	function ucp_groups($id, $mode)
+	if (is_array($_POST['group_id']))
 	{
-		global $_CLASS, $site_file_root;
+		$group_id = array_unique(get_variable('group_id', 'POST', array(), 'array:int'));
+	}
+	else
+	{
+		if ($group_id = get_variable('group_id', 'POST', false, 'interger'))
+		{
+			$group_id = array($group_id);
+		}
+		else
+		{
+			die;
+		}
+	}
+	
+	if (empty($group_id))
+	{
+		die; //temp
+	}
 
-		$_CLASS['core_user']-&gt;add_lang('groups');
+	require_once($site_file_root.'includes/functions_user.php');
 
-		$submit	= isset($_POST['submit']) ? $_POST['submit'] : false;
+	switch ($_POST['mode'])
+	{
+		case 'resign':
+			$sql = 'SELECT m.member_status, g.group_id, g.group_type
+						FROM ' . CORE_GROUPS_MEMBERS_TABLE . ' m, ' . CORE_GROUPS_TABLE . ' g 
+						WHERE m.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+						AND m.group_id IN ('. implode(', ', $group_id) .')';
 
-		if ($submit &amp;&amp; !empty($_POST['group_id']))
-		{
-			if (is_array($_POST['group_id']))
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$unset = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$group_id = array_unique(get_variable('group_id', 'REQUEST', array(), 'array:int'));
-			}
-			else
-			{
-				if ($group_id = get_variable('group_id', 'REQUEST', false, 'interger'))
+				if ($row['group_type'] == GROUP_SYSTEM &amp;&amp; $row['group_type'] == GROUP_SPECIAL &amp;&amp; $row['member_status'] != STATUS_PENDING)
 				{
-					$group_id = array($group_id);
+					$unset[] = $row['user_id'];
 				}
-				else
-				{
-					die;
-				}
 			}
-			
-			if (empty($group_id))
-			{
-				die; //temp
-			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
-			require_once($site_file_root.'includes/functions_user.php');
+			$group_id = array_diff($group_id, $unset);
+			unset($unset);
 
-			switch ($_POST['mode'])
+			if (!empty($group_id))
 			{
-				case 'resign':
-					$sql = 'SELECT m.member_status, g.group_id, g.group_type
-								FROM ' . USER_GROUP_TABLE . ' m, ' . GROUPS_TABLE . ' g 
-								WHERE m.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-								AND m.group_id IN ('. implode(', ', $group_id) .')';
+				groups_user_remove($group_id, $_CLASS['core_user']-&gt;data['user_id']);
+			}
+		break;
 
-					$result = $_CLASS['core_db']-&gt;query($sql);
+		case 'apply':
+			$sql = 'SELECT group_id FROM ' . CORE_GROUPS_MEMBERS_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+				AND group_id IN ('. implode(', ', $group_id) .')';
 
-					$unset = array();
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						if ($row['group_type'] == GROUP_SYSTEM &amp;&amp; $row['group_type'] == GROUP_SPECIAL &amp;&amp; $row['member_status'] != STATUS_PENDING)
-						{
-							$unset[] = $row['user_id'];
-						}
-					}
-					$_CLASS['core_db']-&gt;free_result($result);
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
-					$group_id = array_diff($group_id, $unset);
-					unset($unset);
+			$unset = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$unset[] = $row['group_id'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
-					if (!empty($group_id))
-					{
-						groups_user_remove($group_id, $_CLASS['core_user']-&gt;data['user_id']);
-					}
-				break;
+			$group_id = array_diff($group_id, $unset);
+			unset($unset);
 
-				case 'apply':
-					$sql = 'SELECT group_id FROM ' . USER_GROUP_TABLE . '
-						WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-						AND group_id IN ('. implode(', ', $group_id) .')';
+			if (!empty($group_id))
+			{
+				$sql = 'SELECT group_id, group_status, group_type FROM  ' . CORE_GROUPS_TABLE . '
+							WHERE group_id IN ('. implode(', ', $group_id) .')';
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-					$result = $_CLASS['core_db']-&gt;query($sql);
+				$group_id = array();
 
-					$unset = array();
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						$unset[] = $row['group_id'];
-					}
-					$_CLASS['core_db']-&gt;free_result($result);
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
 
-					$group_id = array_diff($group_id, $unset);
-					unset($unset);
-
-					if (!empty($group_id))
+					if ($row['group_status'] == STATUS_ACTIVE)
 					{
-						$sql = 'SELECT group_id, group_status, group_type FROM  ' . GROUPS_TABLE . '
-									WHERE group_id IN ('. implode(', ', $group_id) .')';
-						$result = $_CLASS['core_db']-&gt;query($sql);
-	
-						$group_id = array();
-	
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-						{
-							$status = ($row['group_type'] == GROUP_UNRESTRAINED) ? STATUS_ACTIVE : STATUS_PENDING;
-	
-							if ($row['group_status'] == STATUS_ACTIVE)
-							{
-								$group_id[$status][] = $row['group_id'];
-							}
-						}
-						$_CLASS['core_db']-&gt;free_result($result);
-	
-						foreach ($group_id as $status =&gt; $ids)
-						{
-							groups_user_add($ids, $_CLASS['core_user']-&gt;data['user_id'], $status);
-						}
+						$group_id[$status][] = $row['group_id'];
 					}
-				break;		
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				foreach ($group_id as $status =&gt; $ids)
+				{
+					groups_user_add($ids, $_CLASS['core_user']-&gt;data['user_id'], $status);
+				}
 			}
-		}
+		break;		
+	}
+}
 
-		$error = $data = array();
+$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
+	FROM ' . CORE_GROUPS_TABLE . ' g, ' . CORE_GROUPS_MEMBERS_TABLE . ' ug
+	WHERE ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+		AND g.group_id = ug.group_id
+	ORDER BY g.group_type DESC, g.group_name';
+$result = $_CLASS['core_db']-&gt;query($sql);
 
-		$sql = 'SELECT g.group_id, g.group_name, g.group_description, g.group_type, ug.member_status
-			FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
-			WHERE ug.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-				AND g.group_id = ug.group_id
-			ORDER BY g.group_type DESC, g.group_name';
-		$result = $_CLASS['core_db']-&gt;query($sql);
+$group_array = array();
 
-		$group_array = array();
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$row['group_status'] = STATUS_ACTIVE;
 
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$row['group_status'] = STATUS_ACTIVE;
+	$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
 
-			$block = ($row['member_status'] == STATUS_LEADER) ? 'leader' : (($row['member_status'] == STATUS_PENDING) ? 'pending' : 'member');
+	$_CLASS['core_template']-&gt;assign_vars_array($block, array(
+		'GROUP_ID'			=&gt; $row['group_id'],
+		'GROUP_NAME'		=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
+		'GROUP_DESC'		=&gt; $row['group_description'],
+		'GROUP_RESIGN'		=&gt; ($row['member_status'] == STATUS_PENDING || ($row['group_type'] != GROUP_SYSTEM &amp;&amp; $row['group_type'] != GROUP_SPECIAL)),
+		'U_VIEW_GROUP'		=&gt; generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id']),
+		'S_GROUP_DEFAULT'	=&gt; ($row['group_id'] == $_CLASS['core_user']-&gt;data['user_group']) ? true : false
+	));
 
-			$_CLASS['core_template']-&gt;assign_vars_array($block, array(
-				'GROUP_ID'			=&gt; $row['group_id'],
-				'GROUP_NAME'		=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'		=&gt; $row['group_description'],
-				'GROUP_RESIGN'		=&gt; ($row['member_status'] == STATUS_PENDING || ($row['group_type'] != GROUP_SYSTEM &amp;&amp; $row['group_type'] != GROUP_SPECIAL)),
-				'U_VIEW_GROUP'		=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']),
-				'S_GROUP_DEFAULT'	=&gt; ($row['group_id'] == $_CLASS['core_user']-&gt;data['user_group']) ? true : false
-			));
+	$group_array[] = $row['group_id'];
+}
+$_CLASS['core_db']-&gt;free_result($result);
 
-			$group_array[] = $row['group_id'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+$sql_and = 'AND group_type NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
 
-		$sql_and = 'AND group_type NOT IN (' . GROUP_SYSTEM . ', ' . GROUP_HIDDEN . ')';
+$sql = 'SELECT group_id, group_name, group_description, group_type
+	FROM ' . CORE_GROUPS_TABLE . '
+	WHERE group_id NOT IN (' . implode(', ', $group_array) . ')
+		AND group_status = '. STATUS_ACTIVE .&quot; $sql_and
+	ORDER BY group_type DESC, group_name&quot;;
+$result = $_CLASS['core_db']-&gt;query($sql);
 
-		$sql = 'SELECT group_id, group_name, group_description, group_type
-			FROM ' . GROUPS_TABLE . '
-			WHERE group_id NOT IN (' . implode(', ', $group_array) . ')
-				AND group_status = '. STATUS_ACTIVE .&quot; $sql_and
-			ORDER BY group_type DESC, group_name&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign_vars_array('nonmember', array(
+		'GROUP_ID'		=&gt; $row['group_id'],
+		'GROUP_NAME'	=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
+		'GROUP_DESC'	=&gt; $row['group_description'],
+		'GROUP_APPLY'	=&gt; true,
+		'U_VIEW_GROUP'	=&gt; generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id'])
+	));
+}
+$_CLASS['core_db']-&gt;free_result($result);
 
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$_CLASS['core_template']-&gt;assign_vars_array('nonmember', array(
-				'GROUP_ID'		=&gt; $row['group_id'],
-				'GROUP_NAME'	=&gt; isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name'],
-				'GROUP_DESC'	=&gt; $row['group_description'],
-				'GROUP_APPLY'	=&gt; true,
-				'U_VIEW_GROUP'	=&gt; generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id'])
-			));
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link($this-&gt;link));
 
-		$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang('UCP_GROUPS'), 'modules/control_panel/ucp_groups_membership.html');
 
-		$this-&gt;display($_CLASS['core_user']-&gt;get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
-	}
-}
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_main.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_main.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_main.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -11,763 +11,721 @@
 // 
 // -------------------------------------------------------------
 
-class ucp_main extends module  
-{
-	function ucp_main($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
+global $_CLASS, $_CORE_CONFIG;
 
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'ERROR' 		=&gt; false,
-			'topicrow'		=&gt; false,
-			'WARNINGS'		=&gt; false,
-			'draftrow'		=&gt; false
-		));
+$_CLASS['core_template']-&gt;assign_array(array(
+	'ERROR' 		=&gt; false,
+	'topicrow'		=&gt; false,
+	'WARNINGS'		=&gt; false,
+	'draftrow'		=&gt; false
+));
 
-		$_CLASS['core_user']-&gt;user_setup();
+$s_hidden_fields = '';
 
-		switch ($mode)
-		{
-			case 'front':
-				$_CLASS['core_user']-&gt;add_lang(false,'Members_List');
+$_CLASS['core_user']-&gt;user_setup();
 
-				if ($config['load_db_lastread'] || $config['load_db_track'])
-				{
-					if ($config['load_db_lastread'])
-					{
-						$sql = 'SELECT mark_time 
-							FROM ' . FORUMS_TRACK_TABLE . ' 
-							WHERE forum_id = 0
-								AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$result = $_CLASS['core_db']-&gt;query($sql);
+switch ($this-&gt;mode)
+{
+	case 'subscribed':
+		$_CLASS['core_user']-&gt;add_img(false, 'forums');
 
-						$track_data = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-						$_CLASS['core_db']-&gt;free_result($result);
-					}
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+		
+		$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
-					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
-					$sql_select = ', tt.mark_time';
+		$unwatch = isset($_POST['unwatch']);
+		
+		if ($unwatch)
+		{
+			$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
+			$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 
-				}
-				else
-				{
-					$sql_from = TOPICS_TABLE . ' t ';
-					$sql_select = '';
-				}
+			if (!empty($forums) || !empty($topics))
+			{
+				$l_unwatch = '';
 
-				// Has to be in while loop if we not only check forum id 0
-				if ($config['load_db_lastread'])
+				if (!empty($forums))
 				{
-					$forum_check = $track_data['mark_time'];
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+						WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
+							AND user_id = ' .$_CLASS['core_user']-&gt;data['user_id'];
+					$_CLASS['core_db']-&gt;query($sql);
+
+					$l_unwatch .= '_FORUMS';
 				}
-				else
-				{
-					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
-					$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
-				}
 
-				$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_ANNOUNCEMENT'];
-				$folder = 'folder_announce';
-				$folder_new = $folder . '_new';
-
-				$sql = &quot;SELECT t.* $sql_select 
-					FROM $sql_from
-					WHERE t.forum_id = 0
-						AND t.topic_type = &quot; . POST_GLOBAL . '
-					ORDER BY t.topic_last_post_time DESC';
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				if (!empty($topics))
 				{
-					$forum_id = $row['forum_id'];
-					$topic_id = $row['topic_id'];
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+						WHERE topic_id IN ('.implode(', ', $topics) .')
+							AND user_id = ' .$_CLASS['core_user']-&gt;data['user_id'];
+					$_CLASS['core_db']-&gt;query($sql);
 
-					if ($row['topic_status'] == ITEM_LOCKED)
-					{
-						$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOCKED'];
-						$folder = 'folder_locked';
-						$folder_new = 'folder_locked_new';
-					}
+					$l_unwatch .= '_TOPICS';
+				}
 
-					$unread_topic = true;
+				$message = $_CLASS['core_user']-&gt;lang['UNWATCHED' . $l_unwatch] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'. generate_link($this-&gt;link_parent.'&amp;mode=subscribed').'&quot;&gt;', '&lt;/a&gt;');
+				
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link_parent.'&amp;mode=subscribed'));
+				trigger_error($message);
+			}
+		}
 
-					if ($config['load_db_lastread'])
-					{
-						$topic_check = $row['mark_time'];
-					}
-					else
-					{
-						$topic_id36 = base_convert($topic_id, 10, 36);
-						$topic_check = (isset($tracking_topics[0][$topic_id36])) ? base_convert($tracking_topics[0][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
-					}
+		if ($config['load_db_lastread'])
+		{
+			$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
+							AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
+			$lastread_select = ', ft.mark_time ';
+		}
+		else
+		{
+			$sql_from = FORUMS_FORUMS_TABLE . ' f ';
+			$lastread_select = '';
 
-					if ($topic_check &gt;= $row['topic_last_post_time'] || $forum_check &gt;= $row['topic_last_post_time'])
-					{
-						$unread_topic = false;
-					}
+			$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 
-					$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
-					$folder_img = ($unread_topic) ? $folder_new : $folder;
-					$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+			if (!is_array($tracking))
+			{
+				$tracking = array();
+			}
+		}
 
-					// Posted image?
-					$view_topic_url = generate_link(&quot;Forums&amp;file=viewtopic&amp;&amp;t=$topic_id&quot;);
+		$sql = &quot;SELECT f.*$lastread_select 
+			FROM $sql_from, &quot; . FORUMS_WATCH_TABLE . ' fw
+			WHERE fw.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
+				 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
+			ORDER BY left_id';
 
-					$last_post_img = '&lt;a href=&quot;'. generate_link(&quot;Forums&amp;file=viewtopic&amp;t=$topic_id&amp;p=&quot; . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST') . '&lt;/a&gt;';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		//$topics_count = $_CLASS['core_db']-&gt;num_rows($result);
 
-					$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
-						'FORUM_ID'			=&gt; $forum_id,
-						'TOPIC_ID'			=&gt; $topic_id,
-						'GOTO_PAGE'			=&gt; '',
-						'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
-						'LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$forum_id = (int) $row['forum_id'];
 
-						'TOPIC_TITLE'		=&gt; censor_text($row['topic_title']),
-						'TOPIC_TYPE'		=&gt; $topic_type,
+			$unread_forum = false;
+			
+			if ($config['load_db_lastread'])
+			{
+				$mark_time_forum = $row['mark_time'];
+			}
+			else
+			{
+				$forum_id36 = base_convert($forum_id, 10, 36);
+				$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
+			}
 
-						'LAST_POST_IMG'		=&gt; $last_post_img,
-						'NEWEST_POST_IMG'	=&gt; $newest_post_img,
-						'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
-						'ATTACH_ICON_IMG'	=&gt; ($_CLASS['auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', '') : '',
+			if ($mark_time_forum &lt; $row['forum_last_post_time'])
+			{
+				$unread_forum = true;
+			}
 
-						'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
-						'U_VIEW_TOPIC'		=&gt; $view_topic_url)
-					);
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
+			// Which folder should we display?
+			if ($row['forum_status'] == ITEM_LOCKED)
+			{
+				$folder_image = ($unread_forum) ? 'folder_locked_new' : 'folder_locked';
+				$folder_alt = 'FORUM_LOCKED';
+			}
+			else
+			{
+				$folder_image = ($unread_forum) ? 'folder_new' : 'folder';
+				$folder_alt = ($unread_forum) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+			}
 
-				$num_real_posts = $_CLASS['core_user']-&gt;data['user_posts'];
-				$active_f_row = $active_t_row = array();
+			// Create last post link information, if appropriate
+			if ($row['forum_last_post_id'])
+			{
+				$last_post_time = $_CLASS['core_user']-&gt;format_date($row['forum_last_post_time']);
 
-				// Do the relevant calculations 
-				$memberdays = max(1, round(($_CLASS['core_user']-&gt;time - $_CLASS['core_user']-&gt;data['user_reg_date']) / 86400));
-				$posts_per_day = $_CLASS['core_user']-&gt;data['user_posts'] / $memberdays;
-				$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
+				$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'];
+				$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
 
-				$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+				$last_post_url = generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['forum_last_post_id'] . '#' . $row['forum_last_post_id']);
+			}
+			else
+			{
+				$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
+			}
 
-				if (!empty($active_f_row['num_posts']))
-				{
-					$active_f_name = $active_f_row['forum_name'];
-					$active_f_id = $active_f_row['forum_id'];
-					$active_f_count = $active_f_row['num_posts'];
-					$active_f_pct = ($_CLASS['core_user']-&gt;data['user_posts']) ? ($active_f_count / $_CLASS['core_user']-&gt;data['user_posts']) * 100 : 0;
-				}
-				unset($active_f_row);
+			$_CLASS['core_template']-&gt;assign_vars_array('forumrow', array(
+				'FORUM_ID'			=&gt; $forum_id, 
+				'FORUM_FOLDER_IMG'	=&gt; $_CLASS['core_user']-&gt;img($folder_image, $folder_alt),
+				'FORUM_NAME'		=&gt; $row['forum_name'],
+				'LAST_POST_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'), 
+				'LAST_POST_TIME'	=&gt; $last_post_time,
+				'LAST_POST_AUTHOR'	=&gt; $last_poster,
+				
+				'U_LAST_POST_AUTHOR'=&gt; $last_poster_url, 
+				'U_LAST_POST'		=&gt; $last_post_url, 
+				'U_VIEWFORUM'		=&gt; generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
+			);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-				$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+		// Subscribed Topics
+		$start = get_variable('start', 'REQUEST', 0, 'int');
 
-				if (!empty($active_t_row['num_posts']))
-				{
-					$active_t_name = $active_t_row['topic_title'];
-					$active_t_id = $active_t_row['topic_id'];
-					$active_t_count = $active_t_row['num_posts'];
-					$active_t_pct = ($_CLASS['core_user']-&gt;data['user_posts']) ? ($active_t_count / $_CLASS['core_user']-&gt;data['user_posts']) * 100 : 0;
-				}
-				unset($active_t_row);
+		if ($config['load_db_lastread'])
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
+			$sql_t_select = ', tt.mark_time';
+		}
+		else
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t';
+			$sql_t_select = '';
+		}
 
+		$sql = &quot;SELECT t.* $sql_t_select 
+			FROM &quot;. FORUMS_WATCH_TABLE . &quot; tw, $sql_from 
+			WHERE tw.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . '
+				AND t.topic_id = tw.topic_id 
+			ORDER BY t.topic_last_post_time DESC';
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'USER_COLOR'		=&gt; (!empty($_CLASS['core_user']-&gt;data['user_colour'])) ? $_CLASS['core_user']-&gt;data['user_colour'] : '', 
-					'JOINED'			=&gt; $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_reg_date']),
-					'VISITED'			=&gt; (empty($_CLASS['core_user']-&gt;data['user_lastvisit'])) ? ' - ' : $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_lastvisit']),
-					'POSTS'				=&gt; ($_CLASS['core_user']-&gt;data['user_posts']) ? $_CLASS['core_user']-&gt;data['user_posts'] : 0,
-					'POSTS_DAY'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_DAY'], $posts_per_day),
-					'POSTS_PCT'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_PCT'], $percentage),
-					'ACTIVE_FORUM'		=&gt; $active_f_name, 
-					'ACTIVE_FORUM_POSTS'=&gt; ($active_f_count == 1) ? sprintf($_CLASS['core_user']-&gt;lang['USER_POST'], 1) : sprintf($_CLASS['core_user']-&gt;lang['USER_POSTS'], $active_f_count), 
-					'ACTIVE_FORUM_PCT'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_PCT'], $active_f_pct), 
-					'ACTIVE_TOPIC'		=&gt; $active_t_name,
-					'ACTIVE_TOPIC_POSTS'=&gt; ($active_t_count == 1) ? sprintf($_CLASS['core_user']-&gt;lang['USER_POST'], 1) : sprintf($_CLASS['core_user']-&gt;lang['USER_POSTS'], $active_t_count), 
-					'ACTIVE_TOPIC_PCT'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['POST_PCT'], $active_t_pct), 
+		$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page'], $start);
+		$topics_count = $_CLASS['core_db']-&gt;num_rows($result);
 
-					'OCCUPATION'	=&gt; (!empty($row['user_occ'])) ? $row['user_occ'] : '',
-					'INTERESTS'		=&gt; (!empty($row['user_interests'])) ? $row['user_interests'] : '',
+		if ($topics_count)
+		{
+			$pagination = generate_pagination($this-&gt;link, $topics_count, $config['topics_per_page'], $start);
 
-					'U_SEARCH_USER'		=&gt; ($_CLASS['auth']-&gt;acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']-&gt;data['username']) . &quot;&amp;show_results=posts&quot;) : '',  
-					'U_ACTIVE_FORUM'	=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$active_f_id),
-					'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
-					'U_ACTIVE_TOPIC'	=&gt; generate_link('Forums&amp;file=viewtopic&amp;t='.$active_t_id))
-				);
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'PAGINATION'		=&gt; $pagination['formated'],
+				'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+				'PAGE_NUMBER'		=&gt; on_page($topics_count, $config['topics_per_page'], $start),
+				'TOTAL_TOPICS'		=&gt; ($topics_count === 1) ? $_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPICS'], $topics_count)
+			));
+		}
+		else
+		{
+			$_CLASS['core_template']-&gt;assign('TOTAL_TOPICS', false);
+		}
 
-				break;
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$topic_id = (int) $row['topic_id'];
+			$forum_id = (int) $row['forum_id'];
+			
+			if (!$config['load_db_lastread'])
+			{
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
 
-			case 'subscribed':
-				require($site_file_root.'includes/forums/functions_display.php');
+				$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+				$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 
-				$unwatch = isset($_POST['unwatch']);
-				
-				if ($unwatch)
-				{
-					$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
-					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
+				$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
+			}
 
-					if (!empty($forums) || !empty($topics))
-					{
-						$l_unwatch = '';
+			// Replies
+			$replies = $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
 
-						if (!empty($forums))
-						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-								WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
-									AND user_id = ' .$_CLASS['core_user']-&gt;data['user_id'];
-							$_CLASS['core_db']-&gt;query($sql);
+			if ($row['topic_status'] == ITEM_MOVED)
+			{
+				$topic_id = $row['topic_moved_id'];
+			}
 
-							$l_unwatch .= '_FORUMS';
-						}
+			// Get folder img, topic status/type related informations
+			$folder_img = $folder_alt = $topic_type = '';
 
-						if (!empty($topics))
-						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-								WHERE topic_id IN ('.implode(', ', $topics) .')
-									AND user_id = ' .$_CLASS['core_user']-&gt;data['user_id'];
-							$_CLASS['core_db']-&gt;query($sql);
+			topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
+			$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;'. generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
 
-							$l_unwatch .= '_TOPICS';
-						}
+			$view_topic_url = 'forums&amp;file=viewtopic&amp;t='.$topic_id;
+			$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
 
-						$message = $_CLASS['core_user']-&gt;lang['UNWATCHED' . $l_unwatch] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'. generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=subscribed&quot;).'&quot;&gt;', '&lt;/a&gt;');
-						
-						$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=subscribed&quot;));
-						trigger_error($message);
-					}
-				}
+			$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
+				'FORUM_ID' 			=&gt; $forum_id,
+				'TOPIC_ID' 			=&gt; $topic_id,
 
-				if ($config['load_db_lastread'])
-				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
-									AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
-					$lastread_select = ', ft.mark_time ';
-				}
-				else
-				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
-					$lastread_select = '';
+				'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
+				'LINK_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
 
-					$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+				'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
+				'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
+				'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
+				'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
 
-					if (!is_array($tracking))
-					{
-						$tracking = array();
-					}
-				}
+				'PAGINATION'		=&gt; $pagination['formated'],
+				'PAGINATION_ARRAY'	=&gt; $pagination['array'],
 
-				$sql = &quot;SELECT f.*$lastread_select 
-					FROM $sql_from, &quot; . FORUMS_WATCH_TABLE . ' fw
-					WHERE fw.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
-						 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
-					ORDER BY left_id';
+				'REPLIES' 			=&gt; $replies,
+				'VIEWS' 			=&gt; $row['topic_views'],
+				'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
+				'TOPIC_TYPE' 		=&gt; $topic_type,
 
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				//$topics_count = $_CLASS['core_db']-&gt;num_rows($result);
+				'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
+				'NEWEST_POST_IMG' 	=&gt; $newest_post_img,
+				'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
+				'TOPIC_ICON_IMG'	=&gt; empty($icons[$row['icon_id']]) ? '' : '&lt;img src=&quot;' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '&quot; width=&quot;' . $icons[$row['icon_id']]['width'] . '&quot; height=&quot;' . $icons[$row['icon_id']]['height'] . '&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;',
+				'ATTACH_ICON_IMG'	=&gt; ($_CLASS['forums_auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', sprintf($_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
 
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$forum_id = (int) $row['forum_id'];
+				'S_TOPIC_TYPE'		=&gt; $row['topic_type'],
+				'S_UNREAD_TOPIC'	=&gt; $unread_topic,
 
-					$unread_forum = false;
-					
-					if ($config['load_db_lastread'])
-					{
-						$mark_time_forum = $row['mark_time'];
-					}
-					else
-					{
-						$forum_id36 = base_convert($forum_id, 10, 36);
-						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
-					}
+				'U_LAST_POST'		=&gt; generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+				'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] &amp;&amp; $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+				'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url))
+			);
+			
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+	break;
 
-					if ($mark_time_forum &lt; $row['forum_last_post_time'])
-					{
-						$unread_forum = true;
-					}
+	case 'bookmarks':
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
-					// Which folder should we display?
-					if ($row['forum_status'] == ITEM_LOCKED)
-					{
-						$folder_image = ($unread_forum) ? 'folder_locked_new' : 'folder_locked';
-						$folder_alt = 'FORUM_LOCKED';
-					}
-					else
-					{
-						$folder_image = ($unread_forum) ? 'folder_new' : 'folder';
-						$folder_alt = ($unread_forum) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
-					}
+		$move_up = request_var('move_up', 0);
+		$move_down = request_var('move_down', 0);
 
-					// Create last post link information, if appropriate
-					if ($row['forum_last_post_id'])
-					{
-						$last_post_time = $_CLASS['core_user']-&gt;format_date($row['forum_last_post_time']);
+		$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
+			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		list($max_order_id) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 
-						$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'];
-						$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
+		if ($move_up || $move_down)
+		{
+			if (($move_up &amp;&amp; $move_up != 1) || ($move_down &amp;&amp; $move_down != $max_order_id))
+			{
+				$order = ($move_up) ? $move_up : $move_down;
+				$order_total = $order * 2 + (($move_up) ? -1 : 1);
 
-						$last_post_url = generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['forum_last_post_id'] . '#' . $row['forum_last_post_id']);
-					}
-					else
-					{
-						$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
-					}
+				$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
+					SET order_id = $order_total - order_id
+					WHERE order_id IN ($order, &quot; . (($move_up) ? $order - 1 : $order + 1) . ')
+						AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+		}
+		
+		if (isset($_POST['unbookmark']))
+		{
+			$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
+			
+			if (empty($topics))
+			{
+				trigger_error('NO_BOOKMARKS_SELECTED');
+			}
 
-					$_CLASS['core_template']-&gt;assign_vars_array('forumrow', array(
-						'FORUM_ID'			=&gt; $forum_id, 
-						'FORUM_FOLDER_IMG'	=&gt; $_CLASS['core_user']-&gt;img($folder_image, $folder_alt),
-						'FORUM_NAME'		=&gt; $row['forum_name'],
-						'LAST_POST_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'), 
-						'LAST_POST_TIME'	=&gt; $last_post_time,
-						'LAST_POST_AUTHOR'	=&gt; $last_poster,
-						
-						'U_LAST_POST_AUTHOR'=&gt; $last_poster_url, 
-						'U_LAST_POST'		=&gt; $last_post_url, 
-						'U_VIEWFORUM'		=&gt; generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
-					);
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
+			$hidden_fields = array(
+				'unbookmark' =&gt; 1,
+				't' =&gt; $topics
+			);
 
-				// Subscribed Topics
-				$start = get_variable('start', 'REQUEST', 0, 'int');
+			if (display_confirmation($_CLASS['core_user']-&gt;get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
+			{
+				$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+						AND topic_id IN (' . implode(', ', $topics) . ')';
+				$_CLASS['core_db']-&gt;query($sql);
 
-				if ($config['load_db_lastread'])
-				{
-					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
-					$sql_t_select = ', tt.mark_time';
-				}
-				else
-				{
-					$sql_from = FORUMS_TOPICS_TABLE . ' t';
-					$sql_t_select = '';
-				}
+				$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+					ORDER BY order_id ASC';
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-				$sql = &quot;SELECT t.* $sql_t_select 
-					FROM &quot;. FORUMS_WATCH_TABLE . &quot; tw, $sql_from 
-					WHERE tw.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . '
-						AND t.topic_id = tw.topic_id 
-					ORDER BY t.topic_last_post_time DESC';
-
-				$result = $_CLASS['core_db']-&gt;query_limit($sql, $config['topics_per_page'], $start);
-				$topics_count = $_CLASS['core_db']-&gt;num_rows($result);
-	
-				if ($topics_count)
+				$i = 1;
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
-					$pagination = generate_pagination(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;, $topics_count, $config['topics_per_page'], $start);
-
-					$_CLASS['core_template']-&gt;assign_array(array(
-						'PAGINATION'		=&gt; $pagination['formated'],
-						'PAGINATION_ARRAY'	=&gt; $pagination['array'],
-						'PAGE_NUMBER'		=&gt; on_page($topics_count, $config['topics_per_page'], $start),
-						'TOTAL_TOPICS'		=&gt; ($topics_count === 1) ? $_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_FORUM_TOPICS'], $topics_count))
-					);
+					$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
+						SET order_id = '$i'
+						WHERE topic_id = '{$row['topic_id']}'
+							AND user_id = '{$_CLASS['core_user']-&gt;data['user_id']}'&quot;);
+					$i++;
 				}
-				else
-				{
-					$_CLASS['core_template']-&gt;assign('TOTAL_TOPICS', false);
-				}
+				$_CLASS['core_db']-&gt;free_result($result);
 
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$topic_id = $row['topic_id'];
-					$forum_id = $row['forum_id'];
-					
-					if (!$config['load_db_lastread'])
-					{
-						$topic_id36 = base_convert($topic_id, 10, 36);
-						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
+				$url = generate_link('control_panel&amp;i=main&amp;mode=bookmarks');
 
-						$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
-						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
+				$_CLASS['core_display']-&gt;meta_refresh(3, $url);
+				$message = $_CLASS['core_user']-&gt;lang['BOOKMARKS_REMOVED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $url . '&quot;&gt;', '&lt;/a&gt;');
+				trigger_error($message);
+			}
+		}
 
-						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
-					}
+		// We grab deleted topics here too...
+		// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
+		// But since bookmarks are sensible to the user, they should not be deleted without notice.
+		$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
+			FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
+				LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
+				LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
+			WHERE b.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
+			ORDER BY b.order_id ASC';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		
+		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+		{
+			$_CLASS['core_db']-&gt;free_result($result);
+			
+			$_CLASS['core_template']-&gt;assign_array(array(
+					'S_BOOKMARKS'			=&gt; false,
+					'S_BOOKMARKS_DISABLED'	=&gt; false
+			));
+			break;
+		}
 
-					// Replies
-					$replies = $_CLASS['auth']-&gt;acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
+		$bookmarks = true;
+		
+		do
+		{
+			$forum_id = $row['forum_id'];
+			$topic_id = $row['b_topic_id'];
+			$bookmarks = true;
 
-					if ($row['topic_status'] == ITEM_MOVED)
-					{
-						$topic_id = $row['topic_moved_id'];
-					}
+			$replies = ($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
+			
+			// Get folder img, topic status/type related informations
+			$folder_img = $folder_alt = $topic_type = $unread_topic = '';
+			topic_status($row, $replies, $_CLASS['core_user']-&gt;time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
-					// Get folder img, topic status/type related informations
-					$folder_img = $folder_alt = $topic_type = '';
+			$view_topic_url = &quot;forums&amp;file=viewtopic&amp;t=$topic_id&quot;;
+//					$last_post_img = '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST') . '&lt;/a&gt;';
 
-					topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
-					$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;'. generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
+			$pagination = generate_pagination('forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
 
-					$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
-					$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
+			$_CLASS['core_template']-&gt;assign_vars_array('forummarks', array(
+				'FORUM_ID' 			=&gt; $forum_id,
+				'TOPIC_ID' 			=&gt; $topic_id,
+				'S_DELETED_TOPIC'	=&gt; (!$row['topic_id']) ? true : false,
+				'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
+				'FORUM_NAME'		=&gt; $row['forum_name'],
 
-					$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
-						'FORUM_ID' 			=&gt; $forum_id,
-						'TOPIC_ID' 			=&gt; $topic_id,
+				'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
+				'LINK_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
 
-						'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
-						'LINK_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+				'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
+				'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
+				'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
+				'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
+				'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
 
-						'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
-						'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
-						'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
+				'PAGINATION'		=&gt; $pagination['formated'],
+				'PAGINATION_ARRAY'	=&gt; $pagination['array'],
 
-						'PAGINATION'		=&gt; $pagination['formated'],
-						'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+				'POSTED_AT'			=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
+				'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
+				'ATTACH_ICON_IMG'	=&gt; ($_CLASS['forums_auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', '') : '',
 
-						'REPLIES' 			=&gt; $replies,
-						'VIEWS' 			=&gt; $row['topic_views'],
-						'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
-						'TOPIC_TYPE' 		=&gt; $topic_type,
+				'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url),
+				'U_VIEW_FORUM'		=&gt; generate_link('forums&amp;file=viewforum&amp;f='.$forum_id),
+				
+				'U_LAST_POST'		=&gt; generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
+				'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+				'U_MOVE_UP'			=&gt; ($row['order_id'] != 1) ? generate_link(&quot;control_panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}&quot;) : '',
+				'U_MOVE_DOWN'		=&gt; ($row['order_id'] != $max_order_id) ? generate_link(&quot;control_panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}&quot;) : '')
+			);
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
-						'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
-						'NEWEST_POST_IMG' 	=&gt; $newest_post_img,
-						'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
-						'TOPIC_ICON_IMG'	=&gt; empty($icons[$row['icon_id']]) ? '' : '&lt;img src=&quot;' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '&quot; width=&quot;' . $icons[$row['icon_id']]['width'] . '&quot; height=&quot;' . $icons[$row['icon_id']]['height'] . '&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;',
-						'ATTACH_ICON_IMG'	=&gt; ($_CLASS['auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', sprintf($_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
+		$_CLASS['core_db']-&gt;free_result($result);
 
-						'S_TOPIC_TYPE'		=&gt; $row['topic_type'],
-						'S_UNREAD_TOPIC'	=&gt; $unread_topic,
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_BOOKMARKS'			=&gt; $bookmarks,
+			'S_BOOKMARKS_DISABLED'	=&gt; false
+		));
+	break;
 
-						'U_LAST_POST'		=&gt; generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] &amp;&amp; $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-						'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url))
-					);
-					
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-			break;
-
-			case 'bookmarks':
-				require($site_file_root.'includes/forums/functions_display.php');
-
-				$move_up = request_var('move_up', 0);
-				$move_down = request_var('move_down', 0);
-
-				$sql = 'SELECT MAX(order_id) as max_order_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
-					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				list($max_order_id) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				if ($move_up || $move_down)
-				{
-					if (($move_up &amp;&amp; $move_up != 1) || ($move_down &amp;&amp; $move_down != $max_order_id))
-					{
-						$order = ($move_up) ? $move_up : $move_down;
-						$order_total = $order * 2 + (($move_up) ? -1 : 1);
+	case 'drafts':
+		global $ucp;
 		
-						$sql = 'UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
-							SET order_id = $order_total - order_id
-							WHERE order_id IN ($order, &quot; . (($move_up) ? $order - 1 : $order + 1) . ')
-								AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;query($sql);
-					}
-				}
-				
-				if (isset($_POST['unbookmark']))
-				{
-					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
-					
-					if (empty($topics))
-					{
-						trigger_error('NO_BOOKMARKS_SELECTED');
-					}
+		$pm_drafts = ($this-&gt;module === 'pm') ? true : false;
 
-					$hidden_fields = array(
-						'unbookmark' =&gt; 1,
-						't' =&gt; $topics
-					);
+		$_CLASS['core_user']-&gt;add_lang('posting','forums');
 
-					if (display_confirmation($_CLASS['core_user']-&gt;get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
-					{
-						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-								AND topic_id IN (' . implode(', ', $topics) . ')';
-						$_CLASS['core_db']-&gt;query($sql);
+		$edit = (isset($_REQUEST['edit'])) ? true : false;
+		$submit = (isset($_POST['submit'])) ? true : false;
+		$draft_id = ($edit) ? intval($_REQUEST['edit']) : 0;
+		$delete = (isset($_POST['delete'])) ? true : false;
 
-						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-							ORDER BY order_id ASC';
-						$result = $_CLASS['core_db']-&gt;query($sql);
+		$s_hidden_fields = ($edit) ? '&lt;input type=&quot;hidden&quot; name=&quot;edit&quot; value=&quot;' . $draft_id . '&quot; /&gt;' : '';
+		$draft_subject = $draft_message = '';
 
-						$i = 1;
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-						{
-							$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_BOOKMARKS_TABLE . &quot;
-								SET order_id = '$i'
-								WHERE topic_id = '{$row['topic_id']}'
-									AND user_id = '{$_CLASS['core_user']-&gt;data['user_id']}'&quot;);
-							$i++;
-						}
-						$_CLASS['core_db']-&gt;free_result($result);
+		if ($delete)
+		{
+			$drafts = (isset($_POST['d'])) ? implode(', ', array_map('intval', array_keys($_POST['d']))) : '';
 
-						$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+			if ($drafts)
+			{
+				$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . &quot;
+					WHERE draft_id IN ($drafts) 
+						AND user_id = &quot; .$_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;query($sql);
 
-						$_CLASS['core_display']-&gt;meta_refresh(3, $url);
-						$message = $_CLASS['core_user']-&gt;lang['BOOKMARKS_REMOVED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;' . $url . '&quot;&gt;', '&lt;/a&gt;');
-						trigger_error($message);
-					}
-				}
+				$message = $_CLASS['core_user']-&gt;lang['DRAFTS_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link($this-&gt;link).'&quot;&gt;', '&lt;/a&gt;');
 
-				// We grab deleted topics here too...
-				// NOTE: At the moment bookmarks are not removed with topics, might be useful later (not really sure how though. :D)
-				// But since bookmarks are sensible to the user, they should not be deleted without notice.
-				$sql = 'SELECT b.order_id, b.topic_id as b_topic_id, t.*, f.forum_name
-					FROM ' . FORUMS_BOOKMARKS_TABLE . ' b
-						LEFT JOIN ' . FORUMS_TOPICS_TABLE . ' t ON b.topic_id = t.topic_id
-						LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
-					WHERE b.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
-					ORDER BY b.order_id ASC';
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				
-				if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-				{
-					$_CLASS['core_db']-&gt;free_result($result);
-					
-					$_CLASS['core_template']-&gt;assign_array(array(
-							'S_BOOKMARKS'			=&gt; false,
-							'S_BOOKMARKS_DISABLED'	=&gt; false
-					));
-					break;
-				}
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link));
+				trigger_error($message);
+			}
+		}
 
-				$bookmarks = true;
-				
-				do
-				{
-					$forum_id = $row['forum_id'];
-					$topic_id = $row['b_topic_id'];
-					$bookmarks = true;
+		if ($submit &amp;&amp; $edit)
+		{
+			$draft_subject = preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', request_var('subject', ''));
+			$draft_message = (isset($_POST['message'])) ? htmlspecialchars(trim(str_replace(array('\\\'', '\\&quot;', '\\0', '\\\\'), array('\'', '&quot;', '\0', '\\'), $_POST['message']))) : '';
+			$draft_message = preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', $draft_message);
 
-					$replies = ($_CLASS['auth']-&gt;acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
-					
-					// Get folder img, topic status/type related informations
-					$folder_img = $folder_alt = $topic_type = $unread_topic = '';
-					topic_status($row, $replies, $_CLASS['core_user']-&gt;time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+			if ($draft_message &amp;&amp; $draft_subject)
+			{
+				$draft_row = array(
+					'draft_subject' =&gt; $draft_subject,
+					'draft_message' =&gt; $draft_message
+				);
 
-					$view_topic_url = &quot;Forums&amp;file=viewtopic&amp;t=$topic_id&quot;;
-//					$last_post_img = '&lt;a href=&quot;'.generate_link(&quot;Forums&amp;file=viewtopic&amp;f=$forum_id&amp;p=&quot; . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST') . '&lt;/a&gt;';
+				$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $draft_row) . &quot; 
+					WHERE draft_id = $draft_id
+						AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;query($sql);
 
-					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['posts_per_page'], 0);
+				$message = $_CLASS['core_user']-&gt;lang['DRAFT_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link($this-&gt;link).'&quot;&gt;', '&lt;/a&gt;');
 
-					$_CLASS['core_template']-&gt;assign_vars_array('forummarks', array(
-						'FORUM_ID' 			=&gt; $forum_id,
-						'TOPIC_ID' 			=&gt; $topic_id,
-						'S_DELETED_TOPIC'	=&gt; (!$row['topic_id']) ? true : false,
-						'TOPIC_TITLE' 		=&gt; censor_text($row['topic_title']),
-						'FORUM_NAME'		=&gt; $row['forum_name'],
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link));
+				trigger_error($message);
+			}
+			else
+			{
+				$_CLASS['core_template']-&gt;assign('ERROR', ($draft_message == '') ? $_CLASS['core_user']-&gt;lang['EMPTY_DRAFT'] : (($draft_subject == '') ? $_CLASS['core_user']-&gt;lang['EMPTY_DRAFT_TITLE'] : ''));
+			}
+		}
 
-						'TOPIC_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']-&gt;get_lang('GUEST')) : $row['topic_first_poster_name'],
-						'LINK_AUTHOR' 		=&gt; ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+		if (!$pm_drafts)
+		{
+			$sql = 'SELECT d.*, f.forum_name
+				FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
+				WHERE d.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
+					(($edit) ? &quot;AND d.draft_id = $draft_id&quot; : '') . '
+					AND f.forum_id = d.forum_id
+					ORDER BY d.save_time DESC';
+		}
+		else
+		{
+			$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
+					(($edit) ? &quot;AND draft_id = $draft_id&quot; : '') . '
+					AND forum_id = 0 
+					AND topic_id = 0
+					ORDER BY save_time DESC';
+		}
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		
+		$draftrows = $topic_ids = array();
 
-						'FIRST_POST_TIME' 	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
-						'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
-						'LAST_VIEW_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_view_time']),
-						'LAST_POST_AUTHOR' 	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
-						'LAST_POST_IMG' 	=&gt; $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST'),
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			if ($row['topic_id'])
+			{
+				$topic_ids[] = (int) $row['topic_id'];
+			}
+			$draftrows[] = $row;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+		
+		if (sizeof($topic_ids))
+		{
+			$sql = 'SELECT topic_id, forum_id, topic_title
+				FROM ' . FORUMS_TOPICS_TABLE . '
+				WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
-						'PAGINATION'		=&gt; $pagination['formated'],
-						'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$topic_rows[$row['topic_id']] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+		unset($topic_ids);
+		
+		$_CLASS['core_template']-&gt;assign('S_EDIT_DRAFT', $edit);
 
-						'POSTED_AT'			=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_time']),
-						'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
-						'ATTACH_ICON_IMG'	=&gt; ($_CLASS['auth']-&gt;acl_gets('f_download', 'u_download', $forum_id) &amp;&amp; $row['topic_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', '') : '',
+		foreach ($draftrows as $draft)
+		{
+			$link_topic = $link_forum = $link_pm = false;
+			$insert_url = $view_url = $title = '';
 
-						'U_VIEW_TOPIC'		=&gt; generate_link($view_topic_url),
-						'U_VIEW_FORUM'		=&gt; generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id),
-						
-						'U_LAST_POST'		=&gt; generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-						'U_MOVE_UP'			=&gt; ($row['order_id'] != 1) ? generate_link(&quot;Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_up={$row['order_id']}&quot;) : '',
-						'U_MOVE_DOWN'		=&gt; ($row['order_id'] != $max_order_id) ? generate_link(&quot;Control_Panel&amp;i=main&amp;mode=bookmarks&amp;move_down={$row['order_id']}&quot;) : '')
-					);
-				}
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+			if ($pm_drafts)
+			{
+				$link_pm = true;
+				$insert_url = generate_link($this-&gt;link_parent.'&amp;mode=compose&amp;d=' . $draft['draft_id']);
+			}
+			else if (isset($topic_rows[$draft['topic_id']]) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_read', $topic_rows[$draft['topic_id']]['forum_id']))
+			{
+				$link_topic = true;
+				$view_url = generate_link('forums&amp;file=viewtopic&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . &quot;&amp;t=&quot; . $draft['topic_id']);
+				$title = $topic_rows[$draft['topic_id']]['topic_title'];
 
-				$_CLASS['core_db']-&gt;free_result($result);
+				$insert_url = generate_link('forums&amp;file=posting&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . '&amp;t=' . $draft['topic_id'] . '&amp;mode=reply&amp;d=' . $draft['draft_id']);
+			}
+			else if ($_CLASS['forums_auth']-&gt;acl_get('f_read', $draft['forum_id']))
+			{
+				$link_forum = true;
+				$view_url = generate_link('forums&amp;file=viewforum&amp;f=' . $draft['forum_id']);
+				$title = $draft['forum_name'];
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'S_BOOKMARKS'			=&gt; $bookmarks,
-					'S_BOOKMARKS_DISABLED'	=&gt; false
-				));
+				$insert_url = generate_link('forums&amp;file=posting&amp;f=' . $draft['forum_id'] . '&amp;mode=post&amp;d=' . $draft['draft_id']);
+			}
+				
+			$template_row = array(
+				'DATE'			=&gt; $_CLASS['core_user']-&gt;format_date($draft['save_time']),
+				'DRAFT_MESSAGE'	=&gt; ($submit) ? $draft_message : $draft['draft_message'],
+				'DRAFT_SUBJECT'	=&gt; ($submit) ? $draft_subject : $draft['draft_subject'],
+				'TITLE'			=&gt; $title,
 
-				break;
+				'DRAFT_ID'			=&gt; $draft['draft_id'],
+				'FORUM_ID'			=&gt; $draft['forum_id'],
+				'TOPIC_ID'			=&gt; $draft['topic_id'],
 
-			case 'drafts':
-				global $ucp;
+				'U_VIEW'			=&gt; $view_url,
+				'U_VIEW_EDIT'		=&gt; generate_link($this-&gt;link.'&amp;edit=' . $draft['draft_id']),
+				'U_INSERT'			=&gt; $insert_url,
+
+				'S_LINK_TOPIC'		=&gt; $link_topic,
+				'S_LINK_FORUM'		=&gt; $link_forum,
+				'S_LINK_PM'			=&gt; $link_pm,
+				'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields
+			);
 				
-				$pm_drafts = ($ucp-&gt;name == 'pm') ? true : false;
+			($edit) ? $_CLASS['core_template']-&gt;assign_array($template_row) : $_CLASS['core_template']-&gt;assign_vars_array('draftrow', $template_row);
+		}
 
-				$_CLASS['core_user']-&gt;add_lang('posting','Forums');
+	break;
 
-				$edit = (isset($_REQUEST['edit'])) ? true : false;
-				$submit = (isset($_POST['submit'])) ? true : false;
-				$draft_id = ($edit) ? intval($_REQUEST['edit']) : 0;
-				$delete = (isset($_POST['delete'])) ? true : false;
+	default:
+	//case 'front':
+		$this-&gt;mode = 'front';
 
-				$s_hidden_fields = ($edit) ? '&lt;input type=&quot;hidden&quot; name=&quot;edit&quot; value=&quot;' . $draft_id . '&quot; /&gt;' : '';
-				$draft_subject = $draft_message = '';
+// remove
+		$_CLASS['core_user']-&gt;add_lang(false, 'members_list');
 
-				if ($delete)
-				{
-					$drafts = (isset($_POST['d'])) ? implode(', ', array_map('intval', array_keys($_POST['d']))) : '';
+/*
+		if ($config['load_db_lastread'])
+		{
+			if ($config['load_db_lastread'])
+			{
+				$sql = 'SELECT mark_time 
+					FROM ' . FORUMS_TRACK_TABLE . ' 
+					WHERE forum_id = 0
+						AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$result = $_CLASS['core_db']-&gt;query($sql);
 
-					if ($drafts)
-					{
-						$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . &quot;
-							WHERE draft_id IN ($drafts) 
-								AND user_id = &quot; .$_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;query($sql);
+				$track_data = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
 
-						$message = $_CLASS['core_user']-&gt;lang['DRAFTS_DELETED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
+			$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ')';
+			$sql_select = ', tt.mark_time';
 
-						$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
-						trigger_error($message);
-					}
-				}
+		}
+		else
+		{
+			$sql_from = FORUMS_TOPICS_TABLE . ' t ';
+			$sql_select = '';
+		}
 
-				if ($submit &amp;&amp; $edit)
-				{
-					$draft_subject = preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', request_var('subject', ''));
-					$draft_message = (isset($_POST['message'])) ? htmlspecialchars(trim(str_replace(array('\\\'', '\\&quot;', '\\0', '\\\\'), array('\'', '&quot;', '\0', '\\'), $_POST['message']))) : '';
-					$draft_message = preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', $draft_message);
+		// Has to be in while loop if we not only check forum id 0
+		if ($config['load_db_lastread'])
+		{
+			$forum_check = $track_data['mark_time'];
+		}
+		else
+		{
+			$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+			$forum_check = (isset($tracking_topics[0][0])) ? base_convert($tracking_topics[0][0], 36, 10) + $config['board_startdate'] : 0;
+		}
 
-					if ($draft_message &amp;&amp; $draft_subject)
-					{
-						$draft_row = array(
-							'draft_subject' =&gt; $draft_subject,
-							'draft_message' =&gt; $draft_message
-						);
+		$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_ANNOUNCEMENT'];
+		$folder = 'folder_announce';
+		$folder_new = $folder . '_new';
 
-						$sql = 'UPDATE ' . FORUMS_DRAFTS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $draft_row) . &quot; 
-							WHERE draft_id = $draft_id
-								AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;query($sql);
+		$sql = &quot;SELECT t.* $sql_select 
+			FROM $sql_from
+			WHERE t.forum_id = 0
+				AND t.topic_type = &quot; . POST_GLOBAL . '
+			ORDER BY t.topic_last_post_time DESC';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-						$message = $_CLASS['core_user']-&gt;lang['DRAFT_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$forum_id = $row['forum_id'];
+			$topic_id = $row['topic_id'];
 
-						$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
-						trigger_error($message);
-					}
-					else
-					{
-						$_CLASS['core_template']-&gt;assign('ERROR', ($draft_message == '') ? $_CLASS['core_user']-&gt;lang['EMPTY_DRAFT'] : (($draft_subject == '') ? $_CLASS['core_user']-&gt;lang['EMPTY_DRAFT_TITLE'] : ''));
-					}
-				}
+			if ($row['topic_status'] == ITEM_LOCKED)
+			{
+				$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOCKED'];
+				$folder = 'folder_locked';
+				$folder_new = 'folder_locked_new';
+			}
 
-				if (!$pm_drafts)
-				{
-					$sql = 'SELECT d.*, f.forum_name
-						FROM ' . FORUMS_DRAFTS_TABLE . ' d, ' . FORUMS_FORUMS_TABLE . ' f
-						WHERE d.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
-							(($edit) ? &quot;AND d.draft_id = $draft_id&quot; : '') . '
-							AND f.forum_id = d.forum_id
-							ORDER BY d.save_time DESC';
-				}
-				else
-				{
-					$sql = 'SELECT * FROM ' . FORUMS_DRAFTS_TABLE . '
-						WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' ' .
-							(($edit) ? &quot;AND draft_id = $draft_id&quot; : '') . '
-							AND forum_id = 0 
-							AND topic_id = 0
-							ORDER BY save_time DESC';
-				}
-				$result = $_CLASS['core_db']-&gt;query($sql);
-				
-				$draftrows = $topic_ids = array();
+			$unread_topic = true;
 
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					if ($row['topic_id'])
-					{
-						$topic_ids[] = (int) $row['topic_id'];
-					}
-					$draftrows[] = $row;
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-				
-				if (sizeof($topic_ids))
-				{
-					$sql = 'SELECT topic_id, forum_id, topic_title
-						FROM ' . FORUMS_TOPICS_TABLE . '
-						WHERE topic_id IN (' . implode(',', array_unique($topic_ids)) . ')';
-					$result = $_CLASS['core_db']-&gt;query($sql);
+			if ($config['load_db_lastread'])
+			{
+				$topic_check = $row['mark_time'];
+			}
+			else
+			{
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$topic_check = (isset($tracking_topics[0][$topic_id36])) ? base_convert($tracking_topics[0][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
+			}
 
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						$topic_rows[$row['topic_id']] = $row;
-					}
-					$_CLASS['core_db']-&gt;free_result($result);
-				}
-				unset($topic_ids);
-				
-				$_CLASS['core_template']-&gt;assign('S_EDIT_DRAFT', $edit);
+			if ($topic_check &gt;= $row['topic_last_post_time'] || $forum_check &gt;= $row['topic_last_post_time'])
+			{
+				$unread_topic = false;
+			}
 
-				foreach ($draftrows as $draft)
-				{
-					$link_topic = $link_forum = $link_pm = false;
-					$insert_url = $view_url = $title = '';
+			$newest_post_img = ($unread_topic) ? '&lt;a href=&quot;'.generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread&quot;).'&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_newest', 'VIEW_NEWEST_POST') . '&lt;/a&gt; ' : '';
+			$folder_img = ($unread_topic) ? $folder_new : $folder;
+			$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
 
-					if ($pm_drafts)
-					{
-						$link_pm = true;
-						$insert_url = generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=compose&amp;d=&quot; . $draft['draft_id']);
-					}
-					else if (isset($topic_rows[$draft['topic_id']]) &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_read', $topic_rows[$draft['topic_id']]['forum_id']))
-					{
-						$link_topic = true;
-						$view_url = generate_link('Forums&amp;file=viewtopic&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . &quot;&amp;t=&quot; . $draft['topic_id']);
-						$title = $topic_rows[$draft['topic_id']]['topic_title'];
+			// Posted image?
+			$view_topic_url = generate_link(&quot;forums&amp;file=viewtopic&amp;&amp;t=$topic_id&quot;);
 
-						$insert_url = generate_link('Forums&amp;file=posting&amp;f=' . $topic_rows[$draft['topic_id']]['forum_id'] . '&amp;t=' . $draft['topic_id'] . '&amp;mode=reply&amp;d=' . $draft['draft_id']);
-					}
-					else if ($_CLASS['auth']-&gt;acl_get('f_read', $draft['forum_id']))
-					{
-						$link_forum = true;
-						$view_url = generate_link('Forums&amp;file=viewforum&amp;f=' . $draft['forum_id']);
-						$title = $draft['forum_name'];
+			$last_post_img = '&lt;a href=&quot;'. generate_link(&quot;forums&amp;file=viewtopic&amp;t=$topic_id&amp;p=&quot; . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']) . '&quot;&gt;' . $_CLASS['core_user']-&gt;img('icon_post_latest', 'VIEW_LATEST_POST') . '&lt;/a&gt;';
 
-						$insert_url = generate_link('Forums&amp;file=posting&amp;f=' . $draft['forum_id'] . '&amp;mode=post&amp;d=' . $draft['draft_id']);
-					}
-						
-					$template_row = array(
-						'DATE'			=&gt; $_CLASS['core_user']-&gt;format_date($draft['save_time']),
-						'DRAFT_MESSAGE'	=&gt; ($submit) ? $draft_message : $draft['draft_message'],
-						'DRAFT_SUBJECT'	=&gt; ($submit) ? $draft_subject : $draft['draft_subject'],
-						'TITLE'			=&gt; $title,
+			$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
+				'FORUM_ID'			=&gt; $forum_id,
+				'TOPIC_ID'			=&gt; $topic_id,
+				'GOTO_PAGE'			=&gt; '',
+				'LAST_POST_TIME'	=&gt; $_CLASS['core_user']-&gt;format_date($row['topic_last_post_time']),
+				'LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'],
 
-						'DRAFT_ID'			=&gt; $draft['draft_id'],
-						'FORUM_ID'			=&gt; $draft['forum_id'],
-						'TOPIC_ID'			=&gt; $draft['topic_id'],
-	
-						'U_VIEW'			=&gt; $view_url,
-						'U_VIEW_EDIT'		=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&amp;edit=&quot; . $draft['draft_id']),
-						'U_INSERT'			=&gt; $insert_url,
+				'TOPIC_TITLE'		=&gt; censor_text($row['topic_title']),
+				'TOPIC_TYPE'		=&gt; $topic_type,
 
-						'S_LINK_TOPIC'		=&gt; $link_topic,
-						'S_LINK_FORUM'		=&gt; $link_forum,
-						'S_LINK_PM'			=&gt; $link_pm,
-						'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields
-					);
-						
-					($edit) ? $_CLASS['core_template']-&gt;assign_array($template_row) : $_CLASS['core_template']-&gt;assign_vars_array('draftrow', $template_row);
-				}
+				'LAST_POST_IMG'		=&gt; $last_post_img,
+				'NEWEST_POST_IMG'	=&gt; $newest_post_img,
+				'TOPIC_FOLDER_IMG' 	=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
+				'ATTACH_ICON_IMG'	=&gt; $row['topic_attachment'] ? $_CLASS['core_user']-&gt;img('icon_attach', '') : '',
 
-				break;
+				'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['topic_last_poster_id']) : false,
+				'U_VIEW_TOPIC'		=&gt; $view_topic_url)
+			);
 		}
+		$_CLASS['core_db']-&gt;free_result($result);
+*/
 
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'JOINED'			=&gt; $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_reg_date']),
+			'VISITED'			=&gt; empty($_CLASS['core_user']-&gt;data['user_lastvisit']) ? ' - ' : $_CLASS['core_user']-&gt;format_date($_CLASS['core_user']-&gt;data['user_lastvisit']),
+			'POSTS'				=&gt; (int) $_CLASS['core_user']-&gt;data['user_posts'],
 
-		$_CLASS['core_template']-&gt;assign_array(array( 
-			'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_MAIN_' . strtoupper($mode)],
-			'S_DISPLAY_MARK_ALL'		=&gt; ($mode == 'watched' || ($mode == 'drafts' &amp;&amp; !isset($_GET['edit']))) ? true : false, 
-			'S_HIDDEN_FIELDS'			=&gt; (isset($s_hidden_fields)) ? $s_hidden_fields : '',
-			'S_DISPLAY_FORM'			=&gt; true,
-			'S_UCP_ACTION'				=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;),
+			'U_SEARCH_USER'		=&gt; generate_link('forums&amp;file=search&amp;search_author=' . urlencode($_CLASS['core_user']-&gt;data['username']) . &quot;&amp;show_results=posts&quot;),  
 		));
-		
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_MAIN'], 'ucp_main_' . $mode . '.html');
+	break;
+}
 
-	}
 
-}
+$_CLASS['core_template']-&gt;assign_array(array( 
+	'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_MAIN_' . strtoupper($this-&gt;mode)],
+	'S_DISPLAY_MARK_ALL'		=&gt; ($this-&gt;mode === 'watched' || ($this-&gt;mode === 'drafts' &amp;&amp; !isset($_GET['edit']))) ? true : false, 
+	'S_HIDDEN_FIELDS'			=&gt; (isset($s_hidden_fields)) ? $s_hidden_fields : '',
+	'S_DISPLAY_FORM'			=&gt; true,
+	'S_UCP_ACTION'				=&gt; generate_link($this-&gt;link),
+));
 
+$_CLASS['core_display']-&gt;display(false, 'modules/control_panel/ucp_main_' . $this-&gt;mode . '.html');
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_pm.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -41,372 +41,419 @@
 *
 */
 
-class ucp_pm extends module
+global $_CLASS, $config;
+
+$action = '';
+$mode = false;
+
+if ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS)
 {
-	function ucp_pm($id, $mode)
+	trigger_error('NO_MESSAGE');
+}
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'S_UNREAD'				=&gt; false,
+	'TOTAL_MESSAGES'		=&gt; false,
+	'S_DISPLAY_HISTORY'		=&gt; false,
+	'S_BCC_RECIPIENT'		=&gt; false,
+));
+
+// This is loaded 2x with drafts
+$_CLASS['core_user']-&gt;add_lang();
+$_CLASS['core_user']-&gt;add_lang('posting', 'Forums');
+
+$_CLASS['core_template']-&gt;assign('S_PRIVMSGS', true);
+
+// Folder directly specified?
+$folder_specified = get_variable('folder', 'REQUEST');
+
+if ($folder_specified)
+{
+	if (is_numeric($folder_specified))
 	{
-		global $_CLASS, $config;
+		$folder_specified = (int) $folder_specified;
+	}
+	else
+	{
+		$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
+	}
 
-		$action = '';
-		
-		if ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS)
+	$mode = 'view_messages';
+}
+else
+{
+	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+}
+
+require(SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php');
+
+$_CLASS['core_template']-&gt;assign_array(array( 
+	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['UCP_PM_' . strtoupper($mode)],
+	'S_UCP_ACTION'      =&gt; generate_link($this-&gt;link . ((isset($action)) ? &quot;&amp;action=$action&quot; : '')))
+);
+
+switch ($mode)
+{
+	// New private messages popup
+	case 'popup':
+	
+		$indox_link = generate_link('control_panel&amp;i=pm&amp;folder=inbox');
+
+		if ($_CLASS['core_user']-&gt;data['user_new_privmsg'])
 		{
-			trigger_error('NO_MESSAGE');
+			$l_new_message = ($_CLASS['core_user']-&gt;data['user_new_privmsg'] == 1) ? $_CLASS['core_user']-&gt;lang['YOU_NEW_PM'] : $_CLASS['core_user']-&gt;lang['YOU_NEW_PMS'];
 		}
+		else
+		{
+			$l_new_message = $_CLASS['core_user']-&gt;lang['YOU_NO_NEW_PM'];
+		}
 
 		$_CLASS['core_template']-&gt;assign_array(array(
-			'S_UNREAD'				=&gt; false,
-			'TOTAL_MESSAGES'		=&gt; false,
-			'S_DISPLAY_HISTORY'		=&gt; false,
-			'S_BCC_RECIPIENT'		=&gt; false,
+			'MESSAGE'			=&gt; $l_new_message,
+			'U_JS_RETURN_INBOX'	=&gt; $indox_link,
+			'S_NOT_LOGGED_IN'	=&gt; ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS) ? true : false,
+			'CLICK_TO_VIEW'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['CLICK_VIEW_PRIVMSG'], '&lt;a href=&quot;' . $indox_link . '&quot; onclick=&quot;jump_to_inbox();return false;&quot; target=&quot;_new&quot;&gt;', '&lt;/a&gt;'),
+			'U_INBOX'			=&gt; $indox_link
 		));
 
-// This is loaded 2x with drafts
-		$_CLASS['core_user']-&gt;add_lang('posting','Forums');
+		$_CLASS['core_display']-&gt;display(false, 'modules/control_panel/ucp_pm_popup.html');
+	break;
+
+	// Compose message
+	case 'compose':
+		$action = get_variable('action', 'REQUEST', 'post');
+
+		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
 		
-		$_CLASS['core_template']-&gt;assign('S_PRIVMSGS', true);
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_compose.php';
+		compose_pm($id, $mode, $action);
+	
+		$_CLASS['core_display']-&gt;display(false, 'modules/control_panel/ucp_posting_body.html');
+	break;
+	
+	case 'options':
+		$sql = 'SELECT group_message_limit
+			FROM ' . GROUPS_TABLE . '
+			WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-		// Folder directly specified?
-		$folder_specified = get_variable('folder', 'REQUEST');
+		list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
 
+		$_CLASS['core_db']-&gt;free_result($result);
+		
+		(int) $_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+		
+		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_options.php';
+		message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
+
+		$_CLASS['core_display']-&gt;display(false, 'modules/control_panel/ucp_pm_options.html');
+	break;
+
+	case 'drafts':
+		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+	
+		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_main.php';
+		$module = new ucp_main($id, $mode);
+		unset($module);
+		exit;
+	break;
+
+	case 'unread':
+	case 'view_messages':
+		$sql = 'SELECT group_message_limit
+			FROM ' . CORE_GROUPS_TABLE . '
+			WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+
 		if ($folder_specified)
 		{
-			if (is_numeric($folder_specified))
-			{
-				$folder_specified = (int) $folder_specified;
-			}
-			else
-			{
-				$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
-			}
-
-			$mode = 'view_messages';
+			$folder_id = $folder_specified;
+			$action = 'view_folder';
 		}
 		else
 		{
-			$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
+			$action = get_variable('action', 'REQUEST', 'view_folder');
 		}
 
-		require(SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php');
+		if ($folder_id === PRIVMSGS_NO_BOX)
+		{
+			$folder_id = PRIVMSGS_INBOX;
+		}
+
+		$msg_id = get_variable('p', 'REQUEST', 0, 'int');
+		$view	= get_variable('view', 'REQUEST');
 		
-		$_CLASS['core_template']-&gt;assign_array(array( 
-			'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['UCP_PM_' . strtoupper($mode)],
-			'S_UCP_ACTION'      =&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot; . ((isset($action)) ? &quot;&amp;action=$action&quot; : '')))
-		);
-
-		switch ($mode)
+		if ($msg_id &amp;&amp; $action === 'view_folder')
 		{
-			// New private messages popup
-			case 'popup':
-			
-				$indox_link = generate_link('Control_Panel&amp;i=pm&amp;folder=inbox');
+			$action = 'view_message';
+		}
 
-				if ($_CLASS['core_user']-&gt;data['user_new_privmsg'])
-				{
-					$l_new_message = ($_CLASS['core_user']-&gt;data['user_new_privmsg'] == 1) ? $_CLASS['core_user']-&gt;lang['YOU_NEW_PM'] : $_CLASS['core_user']-&gt;lang['YOU_NEW_PMS'];
-				}
-				else
-				{
-					$l_new_message = $_CLASS['core_user']-&gt;lang['YOU_NO_NEW_PM'];
-				}
+// First Handle Mark actions and moving messages
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'MESSAGE'			=&gt; $l_new_message,
-					'U_JS_RETURN_INBOX'	=&gt; $indox_link,
-					'S_NOT_LOGGED_IN'	=&gt; ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS) ? true : false,
-					'CLICK_TO_VIEW'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['CLICK_VIEW_PRIVMSG'], '&lt;a href=&quot;' . $indox_link . '&quot; onclick=&quot;jump_to_inbox();return false;&quot; target=&quot;_new&quot;&gt;', '&lt;/a&gt;'),
-					'U_INBOX'			=&gt; $indox_link
-				));
+		// Move PM
+		if (isset($_REQUEST['move_pm']))
+		{
+			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
+			$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
 
-				$_CLASS['core_display']-&gt;display(false, 'modules/Control_Panel/ucp_pm_popup.html');
-			break;
-
-			// Compose message
-			case 'compose':
-				$action = request_var('action', 'post');
-	
-				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
-				
-				if (!$_CLASS['auth']-&gt;acl_get('u_sendpm'))
+			if (move_pm($_CLASS['core_user']-&gt;data['user_id'], $_CLASS['core_user']-&gt;data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
+			{
+				// Return to folder view if single message moved
+				if ($action == 'view_message')
 				{
-					trigger_error('NO_AUTH_SEND_MESSAGE');
+					$msg_id		= 0;
+					$folder_id	= $cur_folder_id;
+					$action		= 'view_folder';
 				}
+			}
+		}
 
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_compose.php');
-				compose_pm($id, $mode, $action);
-			
-				$_CLASS['core_display']-&gt;display(false, 'modules/Control_Panel/ucp_posting_body.html');
-			break;
-			
-			case 'options':
-				$sql = 'SELECT group_message_limit
-					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
-				$result = $_CLASS['core_db']-&gt;query($sql);
+		// Message Mark Options
+		if (isset($_REQUEST['submit_mark']))
+		{
+			$mark_option = get_variable('mark_option', 'POST');
+			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
 
-				list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
+			Switch ($mark_option)
+			{
+				case 'mark_read':
+				case 'mark_unread':
+						$read_status = ($mark_option === 'mark_read');
+						set_read_status($read_status, $msg_ids, $_CLASS['core_user']-&gt;data['user_id'], $cur_folder_id);
+				break;
 
-				$_CLASS['core_db']-&gt;free_result($result);
-				
-				(int) $_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
-				
-				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+				default:
+					// redo this
+					handle_mark_actions($_CLASS['core_user']-&gt;data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
+				break;
+			}
+		}
 
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_options.php');
-				message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
+		// If new messages arrived, place them into the appropiate folder
+		$num_not_moved = 0;
 
-				$_CLASS['core_display']-&gt;display(false, 'modules/Control_Panel/ucp_pm_options.html');
-			break;
+		if ($_CLASS['core_user']-&gt;data['user_new_privmsg'] &amp;&amp; $action == 'view_folder')
+		{
+			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
+			$num_not_moved = $_CLASS['core_user']-&gt;data['user_new_privmsg'];
+		}
 
-			case 'drafts':
-				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
-			
-				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_main.php');
-				$module = new ucp_main($id, $mode);
-				unset($module);
-				exit;
-			break;
+		$message_row = array();
 
-			case 'unread':
-			case 'view_messages':
-				/*
-				if (!$_CLASS['auth']-&gt;acl_get('u_readpm'))
+		if ($mode === 'view_messages' &amp;&amp; $action === 'view_message' &amp;&amp; $msg_id)
+		{
+			// Get Message user want to see
+			if ($view === 'next' || $view === 'previous')
+			{
+				if ($view === 'next')
 				{
-					trigger_error('NO_AUTH_READ_MESSAGE');
+					$sql_condition = '&gt;';
+					$sql_ordering = 'ASC';
 				}
-				*/
+				else
+				{
+					$sql_condition = '&lt;';
+					$sql_ordering = 'DESC';
+				}
 
-				$sql = 'SELECT group_message_limit
-					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
-				$result = $_CLASS['core_db']-&gt;query($sql);
+// Redo this for sqlite
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . &quot; p2
+					WHERE p2.msg_id = $msg_id
+						AND t.folder_id = $folder_id
+						AND t.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+						AND t.msg_id = p.msg_id
+						AND p.message_time $sql_condition p2.message_time
+					ORDER BY p.message_time $sql_ordering&quot;;
+				$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
 
-				list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				$_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
-
-				if ($folder_specified)
+				if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
 				{
-					$folder_id = $folder_specified;
-					$action = 'view_folder';
+					$message = ($view === 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
+					trigger_error($message);
 				}
 				else
 				{
-					$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
-					$action = get_variable('action', 'REQUEST', 'view_folder');
+					$msg_id = $row['msg_id'];
 				}
 
-				if ($folder_id === PRIVMSGS_NO_BOX)
-				{
-					$folder_id = PRIVMSGS_INBOX;
-				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
 
-				$msg_id = get_variable('p', 'REQUEST', 0, 'int');
-				$view	= get_variable('view', 'REQUEST');
-				
-				if ($msg_id &amp;&amp; $action === 'view_folder')
-				{
-					$action = 'view_message';
-				}
+			$sql = 'SELECT t.*, p.*, u.*
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
+				WHERE t.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+					AND p.author_id = u.user_id
+					AND t.folder_id = $folder_id
+					AND t.msg_id = p.msg_id
+					AND p.msg_id = $msg_id&quot;;
+			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$message_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
 
-// First Handle Mark actions and moving messages
+			if (!$message_row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
 
-				// Move PM
-				if (isset($_REQUEST['move_pm']))
-				{
-					$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
-					$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
+			// Update unread status
+			if ($message_row['unread'])
+			{
+				set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']-&gt;data['user_id'], $folder_id);
+			}
+		}
 
-					if (move_pm($_CLASS['core_user']-&gt;data['user_id'], $_CLASS['core_user']-&gt;data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
-					{
-						// Return to folder view if single message moved
-						if ($action == 'view_message')
-						{
-							$msg_id		= 0;
-							$folder_id	= $cur_folder_id;
-							$action		= 'view_folder';
-						}
-					}
-				}
+		$folder = array();
+		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder, $folder_id);
 
-				// Message Mark Options
-				if (isset($_REQUEST['submit_mark']))
-				{
-					$mark_option = get_variable('mark_option', 'POST');
-					$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
+		$s_folder_options = $s_to_folder_options = '';
+		foreach ($folder as $f_id =&gt; $folder_ary)
+		{
+			$option = '&lt;option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $f_id . '&quot;' . ((($f_id == $folder_id &amp;&amp; $mode != 'unread') || ($f_id === 'unread' &amp;&amp; $mode == 'unread')) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '&lt;/option&gt;';
 
-					Switch ($mark_option)
-					{
-						case 'mark_read':
-						case 'mark_unread':
-								$read_status = ($mark_option === 'mark_read');
-								set_read_status($read_status, $msg_ids, $_CLASS['core_user']-&gt;data['user_id'], $cur_folder_id);
-						break;
+			$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX &amp;&amp; $f_id != PRIVMSGS_SENTBOX) ? $option : '';
+			$s_folder_options .= $option;
+		}
 
-						default:
-							// redo this
-							handle_mark_actions($_CLASS['core_user']-&gt;data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
-						break;
-					}
-				}
+		clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
 
-				// If new messages arrived, place them into the appropiate folder
-				$num_not_moved = 0;
+		// Header for message view - folder and so on
+		$folder_status = get_folder_status($folder_id, $folder);
 
-				if ($_CLASS['core_user']-&gt;data['user_new_privmsg'] &amp;&amp; $action == 'view_folder')
-				{
-					place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
-					$num_not_moved = $_CLASS['core_user']-&gt;data['user_new_privmsg'];
-				}
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'CUR_FOLDER_ID'				=&gt; $folder_id,
+			'CUR_FOLDER_NAME'			=&gt; $folder_status['folder_name'],
+			'NUM_NOT_MOVED'				=&gt; $num_not_moved,
+			'RELEASE_MESSAGE_INFO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['RELEASE_MESSAGES'], '&lt;a href=&quot;' . generate_link($this-&gt;link_parent . '&amp;folder=' . $folder_id . '&amp;release=1').'&quot;&gt;', '&lt;/a&gt;'),
+			'NOT_MOVED_MESSAGES'		=&gt; ($num_not_moved == 1) ? $_CLASS['core_user']-&gt;lang['NOT_MOVED_MESSAGE'] : sprintf($_CLASS['core_user']-&gt;lang['NOT_MOVED_MESSAGES'], $num_not_moved),
+
+			'S_FOLDER_OPTIONS'			=&gt; $s_folder_options,
+			'S_TO_FOLDER_OPTIONS'		=&gt; $s_to_folder_options,
+			'S_FOLDER_ACTION'			=&gt; generate_link($this-&gt;link_parent.'&amp;mode=view_messages&amp;action=view_folder'),
+			'S_PM_ACTION'				=&gt; generate_link($this-&gt;link_parent.'&amp;mode=$mode&amp;action='.$action),
+			
+			'U_INBOX'					=&gt; generate_link($this-&gt;link_parent.'&amp;folder=inbox'),
+			'U_OUTBOX'					=&gt; generate_link($this-&gt;link_parent.'&amp;folder=outbox'),
+			'U_SENTBOX'					=&gt; generate_link($this-&gt;link_parent.'&amp;folder=sentbox'),
+			'U_CREATE_FOLDER'			=&gt; generate_link($this-&gt;link_parent.'&amp;mode=options'),
+			
+			'S_IN_INBOX'				=&gt; ($folder_id == PRIVMSGS_INBOX),
+			'S_IN_OUTBOX'				=&gt; ($folder_id == PRIVMSGS_OUTBOX),
+			'S_IN_SENTBOX'				=&gt; ($folder_id == PRIVMSGS_SENTBOX),
+
+			'FOLDER_STATUS'				=&gt; $folder_status['message'],
+			'FOLDER_MAX_MESSAGES'		=&gt; $folder_status['max'],
+			'FOLDER_CUR_MESSAGES'		=&gt; $folder_status['cur'],
+			'FOLDER_REMAINING_MESSAGES'	=&gt; $folder_status['remaining'],
+			'FOLDER_PERCENT'			=&gt; $folder_status['percent'])
+		);
 		
-				$message_row = array();
+		$_CLASS['core_template']-&gt;assign('S_VIEW_MESSAGE',  false);
 
-				if ($mode == 'view_messages' &amp;&amp; $action == 'view_message' &amp;&amp; $msg_id)
-				{
-					// Get Message user want to see
-					if ($view === 'next' || $view === 'previous')
-					{
-						if ($view === 'next')
-						{
-							$sql_condition = '&gt;';
-							$sql_ordering = 'ASC';
-						}
-						else
-						{
-							$sql_condition = '&lt;';
-							$sql_ordering = 'DESC';
-						}
+		if ($mode == 'unread' || $action == 'view_folder')
+		{
+			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewfolder.php';
+			view_folder($this, $folder_id, $folder, (($mode === 'unread') ? 'unread' : 'folder'));
 
-// Redo this for sqlite
-						$sql = 'SELECT t.msg_id
-							FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TABLE . &quot; p2
-							WHERE p2.msg_id = $msg_id
-								AND t.folder_id = $folder_id
-								AND t.user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-								AND t.msg_id = p.msg_id
-								AND p.message_time $sql_condition p2.message_time
-							ORDER BY p.message_time $sql_ordering&quot;;
-						$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$_CLASS['core_display']-&gt;display(false,  'modules/control_panel/ucp_pm_viewfolder.html');
 
-						if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-						{
-							$message = ($view == 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
-							trigger_error($message);
-						}
-						else
-						{
-							$msg_id = $row['msg_id'];
-						}
+		}
+		elseif ($action == 'view_message')
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'S_VIEW_MESSAGE'=&gt; true,
+				'MSG_ID'		=&gt; $msg_id)
+			);
+		
+			if (!$msg_id)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+			
+			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewmessage.php';
+			view_message($this, $folder_id, $msg_id, $folder, $message_row);
 
-						$_CLASS['core_db']-&gt;free_result($result);
-					}
-	
-					$sql = 'SELECT t.*, p.*, u.*
-						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
-						WHERE t.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-							AND p.author_id = u.user_id
-							AND t.folder_id = $folder_id
-							AND t.msg_id = p.msg_id
-							AND p.msg_id = $msg_id&quot;;
-					$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-					$message_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-					$_CLASS['core_db']-&gt;free_result($result);
+			$_CLASS['core_display']-&gt;display(false, 'modules/control_panel/'.(($view === 'print') ? 'ucp_pm_viewmessage_print.html' : 'ucp_pm_viewmessage.html'));
+		}	
+	break;
 
-					if (!$message_row)
-					{
-						trigger_error('NO_MESSAGE');
-					}
+	default:
+		trigger_error('NO_ACTION_MODE');
+	break;
+}
 
-					// Update unread status
-					if ($message_row['unread'])
-					{
-						set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']-&gt;data['user_id'], $folder_id);
-					}
-				}
+function obtain_icons()
+{
+	global $_CLASS;
 
-				$folder = array();
-				get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder, $folder_id);
-	
-				$s_folder_options = $s_to_folder_options = '';
-				foreach ($folder as $f_id =&gt; $folder_ary)
-				{
-					$option = '&lt;option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $f_id . '&quot;' . ((($f_id == $folder_id &amp;&amp; $mode != 'unread') || ($f_id === 'unread' &amp;&amp; $mode == 'unread')) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '&lt;/option&gt;';
+	if (is_null($icons = $_CLASS['core_cache']-&gt;get('icons')))
+	{
+		$sql = 'SELECT *
+			FROM ' . FORUMS_ICONS_TABLE . ' 
+			ORDER BY icons_order';
+		$result = $_CLASS['core_db']-&gt;query($sql);
 
-					$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX &amp;&amp; $f_id != PRIVMSGS_SENTBOX) ? $option : '';
-					$s_folder_options .= $option;
-				}
+		$icons = array();
 
-				clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$icons[$row['icons_id']]['img'] = $row['icons_url'];
+			$icons[$row['icons_id']]['width'] = (int) $row['icons_width'];
+			$icons[$row['icons_id']]['height'] = (int) $row['icons_height'];
+			$icons[$row['icons_id']]['display'] = (bool) $row['display_on_posting'];
+		}
 
-				// Header for message view - folder and so on
-				$folder_status = get_folder_status($folder_id, $folder);
-				$url = 'Control_Panel&amp;i='.$id;
+		$_CLASS['core_db']-&gt;free_result($result);
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'CUR_FOLDER_ID'				=&gt; $folder_id,
-					'CUR_FOLDER_NAME'			=&gt; $folder_status['folder_name'],
-					'NUM_NOT_MOVED'				=&gt; $num_not_moved,
-					'RELEASE_MESSAGE_INFO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['RELEASE_MESSAGES'], '&lt;a href=&quot;' . generate_link($url . '&amp;folder=' . $folder_id . '&amp;release=1').'&quot;&gt;', '&lt;/a&gt;'),
-					'NOT_MOVED_MESSAGES'		=&gt; ($num_not_moved == 1) ? $_CLASS['core_user']-&gt;lang['NOT_MOVED_MESSAGE'] : sprintf($_CLASS['core_user']-&gt;lang['NOT_MOVED_MESSAGES'], $num_not_moved),
+		$_CLASS['core_cache']-&gt;put('icons', $icons);
+	}
 
-					'S_FOLDER_OPTIONS'			=&gt; $s_folder_options,
-					'S_TO_FOLDER_OPTIONS'		=&gt; $s_to_folder_options,
-					'S_FOLDER_ACTION'			=&gt; generate_link($url.'&amp;mode=view_messages&amp;action=view_folder'),
-					'S_PM_ACTION'				=&gt; generate_link(&quot;$url&amp;mode=$mode&amp;action=$action&quot;),
-					
-					'U_INBOX'					=&gt; generate_link($url.'&amp;folder=inbox'),
-					'U_OUTBOX'					=&gt; generate_link($url.'&amp;folder=outbox'),
-					'U_SENTBOX'					=&gt; generate_link($url.'&amp;folder=sentbox'),
-					'U_CREATE_FOLDER'			=&gt; generate_link($url.'&amp;mode=options'),
-					
-					'S_IN_INBOX'				=&gt; ($folder_id == PRIVMSGS_INBOX) ? true : false,
-					'S_IN_OUTBOX'				=&gt; ($folder_id == PRIVMSGS_OUTBOX) ? true : false,
-					'S_IN_SENTBOX'				=&gt; ($folder_id == PRIVMSGS_SENTBOX) ? true : false,
+	return $icons;
+}
 
-					'FOLDER_STATUS'				=&gt; $folder_status['message'],
-					'FOLDER_MAX_MESSAGES'		=&gt; $folder_status['max'],
-					'FOLDER_CUR_MESSAGES'		=&gt; $folder_status['cur'],
-					'FOLDER_REMAINING_MESSAGES'	=&gt; $folder_status['remaining'],
-					'FOLDER_PERCENT'			=&gt; $folder_status['percent'])
-				);
-				
-				$_CLASS['core_template']-&gt;assign('S_VIEW_MESSAGE',  false);
+function gen_sort_selects(&amp;$limit_days, &amp;$sort_by_text, &amp;$sort_days, &amp;$sort_key, &amp;$sort_dir, &amp;$s_limit_days, &amp;$s_sort_key, &amp;$s_sort_dir, &amp;$u_sort_param)
+{
+	global $_CLASS;
 
-				if ($mode == 'unread' || $action == 'view_folder')
-				{
-					require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_viewfolder.php');
-					view_folder($id, $mode, $folder_id, $folder, (($mode == 'unread') ? 'unread' : 'folder'));
+	$sort_dir_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
 
-					$_CLASS['core_display']-&gt;display(false,  'modules/Control_Panel/ucp_pm_viewfolder.html');
+	$s_limit_days = '&lt;select name=&quot;st&quot;&gt;';
+	foreach ($limit_days as $day =&gt; $text)
+	{
+		$selected = ($sort_days == $day) ? ' selected=&quot;selected&quot;' : '';
+		$s_limit_days .= '&lt;option value=&quot;' . $day . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
+	}
+	$s_limit_days .= '&lt;/select&gt;';
 
-				}
-				elseif ($action == 'view_message')
-				{
-					$_CLASS['core_template']-&gt;assign_array(array(
-						'S_VIEW_MESSAGE'=&gt; true,
-						'MSG_ID'		=&gt; $msg_id)
-					);
-				
-					if (!$msg_id)
-					{
-						trigger_error('NO_MESSAGE');
-					}
-					
-					require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_viewmessage.php');
-					view_message($id, $mode, $folder_id, $msg_id, $folder, $message_row);
+	$s_sort_key = '&lt;select name=&quot;sk&quot;&gt;';
+	foreach ($sort_by_text as $key =&gt; $text)
+	{
+		$selected = ($sort_key == $key) ? ' selected=&quot;selected&quot;' : '';
+		$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
+	}
+	$s_sort_key .= '&lt;/select&gt;';
 
-					$_CLASS['core_display']-&gt;display(false, 'modules/Control_Panel/'.(($view == 'print') ? 'ucp_pm_viewmessage_print.html' : 'ucp_pm_viewmessage.html'));
-				}	
-			break;
+	$s_sort_dir = '&lt;select name=&quot;sd&quot;&gt;';
+	foreach ($sort_dir_text as $key =&gt; $value)
+	{
+		$selected = ($sort_dir == $key) ? ' selected=&quot;selected&quot;' : '';
+		$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
+	}
+	$s_sort_dir .= '&lt;/select&gt;';
 
-			default:
-				trigger_error('NO_ACTION_MODE');
-			break;
-		}
-	}
+	$u_sort_param = &quot;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir&quot;;
+
+	return;
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -18,10 +18,11 @@
 	'S_PM_ICONS'		=&gt; false
 ));
 
-function view_folder($id, $mode, $folder_id, $folder, $type)
+function view_folder($parent_class, $folder_id, $folder, $type)
 {
-	global $_CLASS, $config;
+	global $_CLASS;
 	
+	$limit = 10;
 	$icons = obtain_icons();
 
 	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
@@ -63,7 +64,7 @@
 		'S_MARK_OPTIONS'=&gt; $s_mark_options)
 	);
 
-	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']-&gt;data['user_id'], &quot;Control_Panel&amp;i=$id&quot;, $type);
+	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']-&gt;data['user_id'], $parent_class-&gt;link_parent, $type);
 
 	// Okay, lets dump out the page ...
 	if (!empty($folder_info['pm_list']))
@@ -92,7 +93,7 @@
 			{
 				if (isset($recipient_list[$ug_type]) &amp;&amp; sizeof($recipient_list[$ug_type]))
 				{
-					$sql = ($ug_type == 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . GROUPS_TABLE . ' WHERE group_id';
+					$sql = ($ug_type === 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . CORE_USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . CORE_GROUPS_TABLE . ' WHERE group_id';
 					$sql .= ' IN (' . implode(', ', array_keys($recipient_list[$ug_type])) . ')';
 	
 					$result = $_CLASS['core_db']-&gt;query($sql);
@@ -119,8 +120,6 @@
 			unset($recipient_list, $address);
 		}
 
-		$url = 'Control_Panel&amp;i='.$id;
-
 		foreach ($folder_info['pm_list'] as $message_id)
 		{
 			$row =&amp; $folder_info['rowset'][$message_id];
@@ -130,8 +129,8 @@
 
 			// Generate all URIs ...
 			$message_author = '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
-			$view_message_url = generate_link(&quot;$url&amp;f=$folder_id&amp;p=$message_id&quot;);
-			$remove_message_url = generate_link($url.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
+			$view_message_url = generate_link($parent_class-&gt;link_parent.&quot;&amp;f=$folder_id&amp;p=$message_id&quot;);
+			$remove_message_url = generate_link($parent_class-&gt;link_parent.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
 			
 			$row_indicator = '';
 			foreach ($color_rows as $var)
@@ -147,26 +146,27 @@
 			// Send vars to template
 			$_CLASS['core_template']-&gt;assign_vars_array('messagerow', array(
 				'PM_CLASS'			=&gt; ($row_indicator) ? 'pm_' . $row_indicator . '_colour' : '',
-	
+
 				'FOLDER_ID' 		=&gt; $folder_id,
 				'MESSAGE_ID'		=&gt; $message_id,
 				'MESSAGE_AUTHOR'	=&gt; $message_author,
 				'SENT_TIME'		 	=&gt; $_CLASS['core_user']-&gt;format_date($row['message_time']),
 				'SUBJECT'			=&gt; censor_text($row['message_subject']),
 				'FOLDER'			=&gt; (isset($folder[$row['folder_id']])) ? $folder[$row['folder_id']]['folder_name'] : '',
-				'U_FOLDER'			=&gt; (isset($folder[$row['folder_id']])) ? generate_link(&quot;$url&amp;folder=&quot; . $row['folder_id']) : '',
+				'U_FOLDER'			=&gt; (isset($folder[$row['folder_id']])) ? generate_link($parent_class-&gt;link_parent.'&amp;folder=' . $row['folder_id']) : '',
 				'PM_ICON_IMG'		=&gt; (!empty($icons[$row['icon_id']])) ? '&lt;img src=&quot;' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '&quot; width=&quot;' . $icons[$row['icon_id']]['width'] . '&quot; height=&quot;' . $icons[$row['icon_id']]['height'] . '&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;' : '',
 				'FOLDER_IMG'		=&gt; $_CLASS['core_user']-&gt;img($folder_img, $folder_alt),
 				'PM_IMG'			=&gt; ($row_indicator) ? $_CLASS['core_user']-&gt;img('pm_' . $row_indicator, '') : '',
-				'ATTACH_ICON_IMG'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_download') &amp;&amp; $row['message_attachment'] &amp;&amp; $config['allow_pm_attach'] &amp;&amp; $config['auth_download_pm']) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
-				'S_PM_REPORTED'		=&gt; (!empty($row['message_reported']) &amp;&amp; $_CLASS['auth']-&gt;acl_get('m_')) ? true : false,
+				'ATTACH_ICON_IMG'	=&gt; ($row['message_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
+				//'S_PM_REPORTED'		=&gt; (!empty($row['message_reported'])) ? true : false,
+				'S_PM_REPORTED'		=&gt; '',
 				'S_PM_DELETED'		=&gt; ($row['deleted']) ? true : false,
 				
 				'U_VIEW_PM'			=&gt; ($row['deleted']) ? '' : $view_message_url,
 				'U_REMOVE_PM'		=&gt; ($row['deleted']) ? $remove_message_url : '',
 				
 				'RECIPIENTS'		=&gt; ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? implode(', ', $address_list[$message_id]) : '',
-				'U_MCP_REPORT'		=&gt; generate_link('Forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
+				'U_MCP_REPORT'		=&gt; generate_link('forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
 //				'U_MCP_QUEUE'		=&gt; &quot;mcp.$phpEx?sid={$_CLASS['core_user']-&gt;session_id}&amp;mode=mod_queue&amp;t=$topic_id&quot;)
 			);
 		}
@@ -184,17 +184,18 @@
 // Get PM's in all folders from user x with type of x (unread, new)
 function get_pm_from($folder_id, $folder, $user_id, $url, $type = 'folder')
 {
-	global $config, $_CLASS, $_POST;
+	global $_CLASS, $_POST;
 
-	$start		= request_var('start', 0);
+	$limit = 10;
+	$start = get_variable('start', 'REQUEST', 0, 'int');
 
 	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']-&gt;data['user_post_show_days'])) ? $_CLASS['core_user']-&gt;data['user_post_show_days'] : 0));
 	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_type'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_type'] : 't'));
 	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_dir'] : 'd'));
 
-	$sort_days	= request_var('st', 0);
-	$sort_key	= request_var('sk', 't');
-	$sort_dir	= request_var('sd', 'd');
+	$sort_days	= get_variable('st', 'REQUEST', 0, 'int');
+	$sort_key	= get_variable('sk', 'REQUEST', 't');
+	$sort_dir	= get_variable('sd', 'REQUEST', 'd');
 	
 	// PM ordering options
 	$limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_MESSAGES'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
@@ -206,9 +207,9 @@
 	$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
 	gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
 
-	if ($type != 'folder')
+	if ($type !== 'folder')
 	{
-		$folder_sql = ($type == 'unread') ? 't.unread = 1' : 't.new = 1';
+		$folder_sql = ($type === 'unread') ? 't.msg_unread = 1' : 't.msg_new = 1';
 		$folder_id = PRIVMSGS_INBOX;
 	}
 	else
@@ -219,7 +220,7 @@
 	// Limit pms to certain time frame, obtain correct pm count
 	if ($sort_days)
 	{
-		$min_post_time = time() - ($sort_days * 86400);
+		$min_post_time = $_CLASS['core_user']-&gt;time - ($sort_days * 86400);
 
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
 			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
@@ -241,7 +242,7 @@
 	}
 	else
 	{
-		if ($type == 'folder')
+		if ($type === 'folder')
 		{
 			$pm_count = $folder[$folder_id]['num_messages'];
 		}
@@ -271,22 +272,26 @@
 	}
 
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'PAGINATION'		=&gt; generate_pagination(&quot;$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param&quot;, $pm_count, $config['topics_per_page'], $start),
-		'PAGE_NUMBER'		=&gt; on_page($pm_count, $config['topics_per_page'], $start),
+		'PAGINATION'		=&gt; generate_pagination(&quot;$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param&quot;, $pm_count, $limit, $start),
+		'PAGE_NUMBER'		=&gt; on_page($pm_count, $limit, $start),
 		'TOTAL_MESSAGES'	=&gt; (($pm_count == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_PM_MESSAGE'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_PM_MESSAGES'], $pm_count)),
 
-		'POST_IMG'			=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']-&gt;img('btn_post_pm', 'POST_PM'),
+		//'POST_IMG'			=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']-&gt;img('btn_post_pm', 'POST_PM'),
+		'POST_IMG'			=&gt; $_CLASS['core_user']-&gt;img('btn_post_pm', 'POST_PM'),
 
 		'REPORTED_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_reported', 'MESSAGE_REPORTED'),
 
-		'L_NO_MESSAGES'		=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;lang['POST_PM_LOCKED'] : $_CLASS['core_user']-&gt;lang['NO_MESSAGES'],
+		//'L_NO_MESSAGES'		=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;lang['POST_PM_LOCKED'] : $_CLASS['core_user']-&gt;lang['NO_MESSAGES'],
+		'L_NO_MESSAGES'		=&gt; $_CLASS['core_user']-&gt;lang['NO_MESSAGES'],
 
 		'S_SELECT_SORT_DIR'		=&gt; $s_sort_dir,
 		'S_SELECT_SORT_KEY'		=&gt; $s_sort_key,
 		'S_SELECT_SORT_DAYS'	=&gt; $s_limit_days,
-		'S_TOPIC_ICONS'			=&gt; ($config['enable_pm_icons']) ? true : false, 
+		'S_TOPIC_ICONS'			=&gt; true, 
 
-		'U_POST_NEW_TOPIC'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
+		//'U_POST_NEW_TOPIC'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
+		'U_POST_NEW_TOPIC'	=&gt; generate_link($url.'&amp;mode=compose&amp;action=post'), 
+
 		'S_PM_ACTION'		=&gt; generate_link(&quot;$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&quot;))
 	);
 
@@ -295,14 +300,15 @@
 
 	// If the user is trying to reach late pages, start searching from the end
 	$store_reverse = false;
-	$sql_limit = $config['topics_per_page'];
+	$sql_limit = $limit;
+
 	if ($start &gt; $pm_count / 2)
 	{
 		$store_reverse = true;
 
-		if ($start + $config['topics_per_page'] &gt; $pm_count)
+		if ($start + $limit &gt; $pm_count)
 		{
-			$sql_limit = min($config['topics_per_page'], max(1, $pm_count - $start));
+			$sql_limit = min($limit, max(1, $pm_count - $start));
 		}
 
 		// Select the sort order
@@ -317,7 +323,7 @@
 	}
 
 	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.message_reported, p.to_address, p.message_attachment, p.bcc_address, u.username 
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . &quot; u
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id
 			AND $folder_sql

Modified: cms/trunk/modules/control_panel/modules/ucp_profile.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_profile.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_profile.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,470 +21,466 @@
 $Id$
 */
 
-class ucp_profile extends module
-{
-	function ucp_profile($id, $mode)
-	{
-		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
-		
-		$preview	= isset($_POST['preview']);
-		$submit		= isset($_POST['submit']);
+global $config, $_CLASS, $_CORE_CONFIG;
 
-		$module_link = generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;);
+$submit		= isset($_POST['submit']);
 
-		$error = $data = array();
-		$s_hidden_fields = '';
-		
-		switch ($mode)
+$error = $data = array();
+$hidden_fields = array();
+
+switch ($this-&gt;mode)
+{
+	case 'reg_details':
+		if ($submit)
 		{
-			case 'reg_details':
-				if ($submit)
-				{
-					$password		= get_variable('new_password', 'POST', false);
-					$cur_password	= get_variable('cur_password', 'POST', false);
+			$password		= get_variable('new_password', 'POST', false);
+			$cur_password	= get_variable('cur_password', 'POST', false);
 
-					if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']-&gt;data['user_password_encoding']) !== $_CLASS['core_user']-&gt;data['user_password'])
-					{
-						$error[] = $_CLASS['core_user']-&gt;get_lang('CURRENT_PASSWORD_INVALID');
-					}
+			if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']-&gt;data['user_password_encoding']) !== $_CLASS['core_user']-&gt;data['user_password'])
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('CURRENT_PASSWORD_INVALID');
+			}
 
-					if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
-					{
-						$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_MISMATCH');
-					}
+			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_MISMATCH');
+			}
 
-					if (empty($error) &amp;&amp; $password === $cur_password)
-					{
-						$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_SAME');
-					}
+			if (empty($error) &amp;&amp; $password === $cur_password)
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_SAME');
+			}
 
-					if (empty($error))
-					{
-						$array = array(
-							'user_password' =&gt; encode_password($password, $_CLASS['core_user']-&gt;data['user_password_encoding']),
-						);
-						
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $array) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-
-						$_CLASS['core_db']-&gt;sql_query($sql);
-					}
-				}
-
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
-
-					'USERNAME'			=&gt; $_CLASS['core_user']-&gt;data['username'],
-					'EMAIL'				=&gt; $_CLASS['core_user']-&gt;data['user_email'],
-
-					'CONFIRM_EMAIL'		=&gt; '',
-					'PASSWORD_CONFIRM'	=&gt; (isset($password_confirm)) ? $password_confirm : '',
-					'NEW_PASSWORD'		=&gt; (isset($new_password)) ? $new_password : '',
-					
-					'CUR_PASSWORD'					=&gt; '', 
-					
-					'L_USERNAME_EXPLAIN'		=&gt; '', 
-					'L_CHANGE_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+			if (empty($error))
+			{
+				$array = array(
+					'user_password' =&gt; encode_password($password, $_CLASS['core_user']-&gt;data['user_password_encoding']),
+				);
 				
-					'S_FORCE_PASSWORD'	=&gt; false,
-					'S_CHANGE_USERNAME'	=&gt; false, 
-					'S_CHANGE_EMAIL'	=&gt; false,
-					'S_CHANGE_PASSWORD'	=&gt; true
-				));
-			break;
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $array) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
 
-			case 'profile_info':
+				$_CLASS['core_db']-&gt;sql_query($sql);
+			}
+		}
 
-				$error = array();
-				$this_year = gmdate('Y', time());
-				
-				if ($submit)
-				{
-					$icq	= get_variable('icq', 'POST', null);
-					$aim	= get_variable('aim', 'POST', null);
-					$msn	= get_variable('msn', 'POST', null);
-					$yim	= get_variable('yim', 'POST', null);
-					$jabber = get_variable('jabber', 'POST', null);
-					//$google = get_variable('google', 'POST', null);
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
 
-					$website	= get_variable('website', 'POST', null);
-					$location	= get_variable('location', 'POST', null);				
-					$occupation	= get_variable('occupation', 'POST', null);
-					$interests	= get_variable('interests', 'POST', null);
+			'USERNAME'			=&gt; $_CLASS['core_user']-&gt;data['username'],
+			'EMAIL'				=&gt; $_CLASS['core_user']-&gt;data['user_email'],
 
-					$bday_day	= get_variable('bday_day', 'POST', false);
-					$bday_month	= get_variable('bday_month', 'POST', false);
-					$bday_year	= get_variable('bday_year', 'POST', false);
+			'CONFIRM_EMAIL'		=&gt; '',
+			'PASSWORD_CONFIRM'	=&gt; (isset($password_confirm)) ? $password_confirm : '',
+			'NEW_PASSWORD'		=&gt; (isset($new_password)) ? $new_password : '',
+			
+			'CUR_PASSWORD'					=&gt; '', 
+			
+			'L_USERNAME_EXPLAIN'		=&gt; '', 
+			'L_CHANGE_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+		
+			'S_FORCE_PASSWORD'	=&gt; false,
+			'S_CHANGE_USERNAME'	=&gt; false, 
+			'S_CHANGE_EMAIL'	=&gt; false,
+			'S_CHANGE_PASSWORD'	=&gt; true
+		));
+	break;
 
-					if ($bday_day || $bday_month || $bday_year)
-					{
-						if ($bday_day &lt; 1 || $bday_day &gt; 31 || $bday_month &lt; 1 || $bday_month &gt; 12 || $bday_year &lt; ($this_year - 100) || $bday_month &gt; $this_year)
-						{
-							$error[] = $_CLASS['core_user']-&gt;get_lang('BIRTHDAY_ERROR');
-						}
-					}
+	case 'signature':
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+		
+		// Generate smiley listing
+		generate_smilies('inline', 0);
 
-					if (mb_strlen($interests) &gt; 255)
-					{
-						$error[] = $_CLASS['core_user']-&gt;get_lang('INTEREST_LONG_ERROR');
-					}
+		$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
+		$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
+		$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
+		$enable_urls	= !isset($_POST['disable_magic_url']);
 
-					if (mb_strlen($occupation) &gt; 255)
-					{
-						$error[] = $_CLASS['core_user']-&gt;get_lang('OCCUPATION_LONG_ERROR');
-					}
+		$signature	= get_variable('signature', 'POST', $_CLASS['core_user']-&gt;data['user_sig']);
+		$preview	= isset($_POST['preview']);
 
-					if (empty($error))
-					{
-						$sql_ary = array(
-							'user_icq'		=&gt; $icq,
-							'user_aim'		=&gt; $aim,
-							'user_msnm'		=&gt; $msn,
-							'user_yim'		=&gt; $yim,
-							'user_jabber'	=&gt; $jabber,
-							//'user_google'	=&gt; $google,
-							'user_website'	=&gt; $website,
-							'user_from'		=&gt; $location,
-							'user_occ'		=&gt; $occupation,
-							'user_interests'=&gt; $interests,
-							'user_birthday'	=&gt; ($bday_day) ? sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year) : null,
-						);
-	
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;sql_query($sql);
-	
-						$_CLASS['core_display']-&gt;meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'&quot;&gt;', '&lt;/a&gt;');
-						trigger_error($message);
-					}
-				}
+		if ($submit || $preview)
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
 
-				if (!isset($bday_day))
+			if (trim($signature))
+			{
+				$message_parser = new parse_message($signature);
+
+				// Allowing Quote BBCode
+				$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
+				
+				if (!empty($message_parser-&gt;warn_msg))
 				{
-					if ($_CLASS['core_user']-&gt;data['user_birthday'])
-					{
-						list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']-&gt;data['user_birthday']);
-					}
-					else
-					{
-						$bday_day = $bday_month = $bday_year = '';
-					}
+					$error[] = implode('&lt;br /&gt;', $message_parser-&gt;warn_msg);
 				}
+			}
 
-				$s_birthday_day_options = '&lt;option value=&quot;0&quot;' . ((!$bday_day) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-
-				for ($i = 1; $i &lt; 32; $i++)
+			if (empty($error) &amp;&amp; $submit)
+			{
+				if ($signature &amp;&amp; !empty($message_parser-&gt;message))
 				{
-					$selected = ($i == $bday_day) ? ' selected=&quot;selected&quot;' : '';
-					$s_birthday_day_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
+					$sql_array = array(
+						'user_sig'					=&gt; (string) $message_parser-&gt;message, 
+						'user_sig_bbcode_uid'		=&gt; (string) $message_parser-&gt;bbcode_uid, 
+						'user_sig_bbcode_bitfield'	=&gt; (int) $message_parser-&gt;bbcode_bitfield
+					);
 				}
-
-				$s_birthday_month_options = '&lt;option value=&quot;0&quot;' . ((!$bday_month) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
-				for ($i = 1; $i &lt; 13; $i++)
+				else
 				{
-					$selected = ($i == $bday_month) ? ' selected=&quot;selected&quot;' : '';
-					$s_birthday_month_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
+					$sql_array = array(
+						'user_sig'					=&gt; (string) '', 
+						'user_sig_bbcode_uid'		=&gt; (string) '', 
+						'user_sig_bbcode_bitfield'	=&gt; (int) 0
+					);
 				}
-				$s_birthday_year_options = '';
 
-				$s_birthday_year_options = '&lt;option value=&quot;0&quot;' . ((!$bday_year) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_array) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;sql_query($sql);
 
-				$i = $this_year - 100;
-				for ($i; $i &lt; $this_year; $i++)
-				{
-					$selected = ($i == $bday_year) ? ' selected=&quot;selected&quot;' : '';
-					$s_birthday_year_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
-				}
+				$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'. generate_link($this-&gt;link) .'&quot;&gt;', '&lt;/a&gt;');
+				trigger_error($message);
+			}
+		}
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'ERROR'		=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
+		$signature_preview = '';
 
-					'ICQ'		=&gt; isset($icq) ? $icq : $_CLASS['core_user']-&gt;data['user_icq'], 
-					'YIM'		=&gt; isset($yim) ? $yim : $_CLASS['core_user']-&gt;data['user_yim'], 
-					'AIM'		=&gt; isset($aim) ? $aim : $_CLASS['core_user']-&gt;data['user_aim'], 
-					'MSN'		=&gt; isset($msn) ? $msn : $_CLASS['core_user']-&gt;data['user_msnm'], 
-					//'GOOGLE'	=&gt; isset($google) ? $google : $_CLASS['core_user']-&gt;data['user_google'], 
-					'JABBER'	=&gt; isset($jabber) ? $jabber : $_CLASS['core_user']-&gt;data['user_jabber'], 
-					'WEBSITE'	=&gt; isset($website) ? $website : $_CLASS['core_user']-&gt;data['user_website'], 
-					'LOCATION'	=&gt; isset($location) ? $location : $_CLASS['core_user']-&gt;data['user_from'], 
-					'OCCUPATION'=&gt; isset($occupation) ? $occupation : $_CLASS['core_user']-&gt;data['user_occ'], 
-					'INTERESTS'	=&gt; isset($interests) ? $interests : $_CLASS['core_user']-&gt;data['user_interests'], 
+		if ($preview &amp;&amp; $signature)
+		{
+			// Now parse it for displaying
+			$signature_preview = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
+			unset($message_parser);
+		}
 
-					'S_BIRTHDAY_DAY_OPTIONS'	=&gt; $s_birthday_day_options, 
-					'S_BIRTHDAY_MONTH_OPTIONS'	=&gt; $s_birthday_month_options, 
-					'S_BIRTHDAY_YEAR_OPTIONS'	=&gt; $s_birthday_year_options,
-				));
-			break;
+		if ($signature)
+		{
+			decode_message($signature, $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid']);
+		}
 
-			case 'signature':
-				require($site_file_root.'includes/forums/functions_posting.php');
-				
-				// Generate smiley listing
-				generate_smilies('inline', 0);
-	
-				$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
-				$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
-				$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
-				$enable_urls	= !isset($_POST['disable_magic_url']);
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
+			'SIGNATURE'			=&gt; $signature,
+			'SIGNATURE_PREVIEW'	=&gt; $signature_preview, 
+			
+			'S_HTML_CHECKED' 		=&gt; ($enable_html) ? '' : 'checked=&quot;checked&quot;',
+			'S_BBCODE_CHECKED' 		=&gt; ($enable_bbcode) ? '' : 'checked=&quot;checked&quot;',
+			'S_SMILIES_CHECKED' 	=&gt; ($enable_smilies) ? '' : 'checked=&quot;checked&quot;',
+			'S_MAGIC_URL_CHECKED' 	=&gt; ($enable_urls) ? '' : 'checked=&quot;checked&quot;',
 
-				$signature		= get_variable('signature', 'POST', $_CLASS['core_user']-&gt;data['user_sig']);
-				$signature_preview = '';
-				$sql_array = false;
+			'HTML_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('HTML_IS_ON') : $_CLASS['core_user']-&gt;get_lang('HTML_IS_OFF'),
+			'BBCODE_STATUS'			=&gt; (true) ? sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_ON'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_OFF'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
+			'SMILIES_STATUS'		=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_OFF'),
+			'IMG_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_OFF'),
+			'FLASH_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('FLASH_IS_ON') : $_CLASS['core_user']-&gt;get_lang('FLASH_IS_OFF'),
 
-				if ($submit || $preview)
-				{
-					require_once($site_file_root.'includes/forums/message_parser.php');
+			'L_SIGNATURE_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
 
-					if ($signature)
-					{
-						$message_parser = new parse_message($signature);
-	
-						// Allowing Quote BBCode
-						$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
-						
-						if (!empty($message_parser-&gt;warn_msg))
-						{
-							$error[] = implode('&lt;br /&gt;', $message_parser-&gt;warn_msg);
-						}
-					}
+			'S_HTML_ALLOWED'		=&gt; true, 
+			'S_BBCODE_ALLOWED'		=&gt; true, 
+			'S_SMILIES_ALLOWED'		=&gt; true,
+		));
+	break;
 
-					if (empty($error) &amp;&amp; $submit)
-					{
-						if ($signature &amp;&amp; !empty($message_parser-&gt;message))
-						{
-							$sql_array = array(
-								'user_sig'					=&gt; (string) $message_parser-&gt;message, 
-								'user_sig_bbcode_uid'		=&gt; (string) $message_parser-&gt;bbcode_uid, 
-								'user_sig_bbcode_bitfield'	=&gt; (int) $message_parser-&gt;bbcode_bitfield
-							);
-						}
-						else
-						{
-							$sql_array = array(
-								'user_sig'					=&gt; (string) '', 
-								'user_sig_bbcode_uid'		=&gt; (string) '', 
-								'user_sig_bbcode_bitfield'	=&gt; (int) 0
-							);
-						}
+	case 'avatar':
+		$display_gallery = isset($_POST['display_gallery']);
+		$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_array) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;sql_query($sql);
+		$delete = isset($_POST['delete']);
 
-						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'&quot;&gt;', '&lt;/a&gt;');
-						trigger_error($message);
-					}
+		// Can we upload? 
+		$can_upload = (@ini_get('file_uploads') &amp;&amp; file_exists($_CORE_CONFIG['global']['path_avatar_upload']) &amp;&amp; is_writeable($_CORE_CONFIG['global']['path_avatar_upload']));
+
+		if ($submit)
+		{
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+			$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
+
+			if ($gallery_avatar)
+			{
+				if (!file_exists($config['avatar_gallery_path'] . '/' . $gallery_avatar))
+				{
+					$error[] = 'BAD_AVATAR';
 				}
+				else
+				{
+					$type = AVATAR_GALLERY;
+					$filename = $gallery_avatar;
 
-				if ($preview &amp;&amp; $signature)
+					list($width, $height) = getimagesize($_CORE_CONFIG['global']['path_avatar_gallery'] . '/' . $gallery_avatar);
+				}
+			}
+			else
+			{
+				$data['uploadurl']	= get_variable('uploadurl', 'POST', false);
+				$data['remotelink']	= get_variable('remotelink', 'POST', '');
+				$data['width']		= get_variable('width', 'POST', '');
+				$data['height']		= get_variable('height', 'POST', '');
+				$data['user_id']	= $_CLASS['core_user']-&gt;data['user_id'];
+
+				if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) &amp;&amp; $can_upload)
 				{
-					// Now parse it for displaying
-					$signature_preview = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
-					unset($message_parser);
+					list($type, $filename, $width, $height) = avatar_upload($data, $error);
 				}
+				elseif ($data['remotelink'] &amp;&amp; $config['allow_avatar_remote'])
+				{
+					list($type, $filename, $width, $height) = avatar_remote($data, $error);
+				}
+				elseif ($delete)
+				{
+					$filename = '';
+					$type = $width = $height = 0;
+				}
+				else
+				{
+					$error[] = 'IM_LOST';
+				}
+			}
 
-				if ($signature)
+			if (empty($error))
+			{
+				$sql_ary = array(
+					'user_avatar'			=&gt; (string) $filename, 
+					'user_avatar_type'		=&gt; (int) $type, 
+					'user_avatar_width'		=&gt; (int) $width, 
+					'user_avatar_height'	=&gt; (int) $height, 
+				);
+
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;sql_query($sql);
+
+				/* Delete old avatar if present */
+				if ($_CLASS['core_user']-&gt;data['user_avatar'] &amp;&amp; $filename !== $_CLASS['core_user']-&gt;data['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;data['user_avatar_type'] != AVATAR_GALLERY)
 				{
-					decode_message($signature, $_CLASS['core_user']-&gt;data['user_sig_bbcode_uid']);
+					avatar_delete($_CLASS['core_user']-&gt;data['user_avatar']);
 				}
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'ERROR'				=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
-					'SIGNATURE'			=&gt; $signature,
-					'SIGNATURE_PREVIEW'	=&gt; $signature_preview, 
-					
-					'S_HTML_CHECKED' 		=&gt; ($enable_html) ? '' : 'checked=&quot;checked&quot;',
-					'S_BBCODE_CHECKED' 		=&gt; ($enable_bbcode) ? '' : 'checked=&quot;checked&quot;',
-					'S_SMILIES_CHECKED' 	=&gt; ($enable_smilies) ? '' : 'checked=&quot;checked&quot;',
-					'S_MAGIC_URL_CHECKED' 	=&gt; ($enable_urls) ? '' : 'checked=&quot;checked&quot;',
+				$_CLASS['core_user']-&gt;data += $sql_ary;
+				unset($sql_ary);
 
-					'HTML_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('HTML_IS_ON') : $_CLASS['core_user']-&gt;get_lang('HTML_IS_OFF'),
-					'BBCODE_STATUS'			=&gt; (true) ? sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_ON'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;') : sprintf($_CLASS['core_user']-&gt;get_lang('BBCODE_IS_OFF'), '&lt;a href=&quot;' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '&quot; target=&quot;_phpbbcode&quot;&gt;', '&lt;/a&gt;'),
-					'SMILIES_STATUS'		=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('SMILIES_ARE_OFF'),
-					'IMG_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']-&gt;get_lang('IMAGES_ARE_OFF'),
-					'FLASH_STATUS'			=&gt; (true) ? $_CLASS['core_user']-&gt;get_lang('FLASH_IS_ON') : $_CLASS['core_user']-&gt;get_lang('FLASH_IS_OFF'),
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link));
+				$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'. generate_link($this-&gt;link) .'&quot;&gt;', '&lt;/a&gt;');
+				trigger_error($message);
+			}
 
-					'L_SIGNATURE_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
+			$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
+		}
 
-					'S_HTML_ALLOWED'		=&gt; true, 
-					'S_BBCODE_ALLOWED'		=&gt; true, 
-					'S_SMILIES_ALLOWED'		=&gt; true,
-				));
-			break;
+		// Generate users avatar
+		$avatar_img = '';
 
-			case 'avatar':
+		if ($_CLASS['core_user']-&gt;data['user_avatar'])
+		{
+			switch ($_CLASS['core_user']-&gt;data['user_avatar_type'])
+			{
+				case AVATAR_UPLOAD:
+					$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+				break;
 
-				$display_gallery = isset($_POST['display_gallery']);
-				$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
+				case AVATAR_GALLERY:
+					$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+				break;
+			}
 
-				$delete = isset($_POST['delete']);
+			$avatar_img .= $_CLASS['core_user']-&gt;data['user_avatar'];
+			$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_width'] . '&quot; height=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
+		}
 
-				// Can we upload? 
-				$can_upload = (file_exists($config['avatar_path']) &amp;&amp; is_writeable($config['avatar_path']) &amp;&amp; @ini_get('file_uploads')) ? true : false;
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'ERROR'			=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
+			'AVATAR'		=&gt; $avatar_img, 
+			'AVATAR_SIZE'	=&gt; $config['avatar_filesize'], 
 
-				if ($submit)
-				{
-					require_once($site_file_root.'includes/functions_user.php');
+			'S_FORM_ENCTYPE'	=&gt; ($can_upload) ? ' enctype=&quot;multipart/form-data&quot;' : '', 
 
-					$gallery_avatar = isset($_POST['avatarselect']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['avatarselect']) : false;
+			'L_AVATAR_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),)
+		);
 
-					if ($config['allow_avatar_local'] &amp;&amp; $gallery_avatar)
-					{
-						if (!file_exists($config['avatar_gallery_path'] . '/' . $gallery_avatar))
-						{
-							$error[] = 'BAD_AVATAR';
-						}
-						else
-						{
-							$type = AVATAR_GALLERY;
-							$filename = $gallery_avatar;
+		if ($display_gallery)
+		{
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
-							list($width, $height) = getimagesize($config['avatar_gallery_path'] . '/' . $gallery_avatar);
-						}
-					}
-					else
-					{
-						$data['uploadurl']	= get_variable('uploadurl', 'POST', false);
-						$data['remotelink']	= get_variable('remotelink', 'POST', '');
-						$data['width']		= get_variable('width', 'POST', '');
-						$data['height']		= get_variable('height', 'POST', '');
-						$data['user_id']	= $_CLASS['core_user']-&gt;data['user_id'];
+			$avatar_list = avatar_gallery($folder, $folders, $error);
 
-						if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) &amp;&amp; $can_upload)
-						{
-							list($type, $filename, $width, $height) = avatar_upload($data, $error);
-						}
-						elseif ($data['remotelink'] &amp;&amp; $config['allow_avatar_remote'])
-						{
-							list($type, $filename, $width, $height) = avatar_remote($data, $error);
-						}
-						elseif ($delete)
-						{
-							$filename =  '';
-							$type = $width = $height = 0;
-						}
-						else
-						{
-							$error[] = 'IM_LOST';
-						}
-					}
+			array_unshift($folders, '');
 
-					if (empty($error))
-					{
-						$sql_ary = array(
-							'user_avatar'			=&gt; (string) $filename, 
-							'user_avatar_type'		=&gt; (int) $type, 
-							'user_avatar_width'		=&gt; (int) $width, 
-							'user_avatar_height'	=&gt; (int) $height, 
-						);
+			$s_category_options = '';
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . ' 
-							WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
-						$_CLASS['core_db']-&gt;sql_query($sql);
+			foreach ($folders as $cat)
+			{
+				$s_category_options .= '&lt;option value=&quot;' . $cat . '&quot;' . (($cat == $folder) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . (($cat) ? $cat : '--') . '&lt;/option&gt;';
+			}
 
-						// Delete old avatar if present
-						if ($_CLASS['core_user']-&gt;data['user_avatar'] &amp;&amp; $filename != $_CLASS['core_user']-&gt;data['user_avatar'] &amp;&amp; $_CLASS['core_user']-&gt;data['user_avatar_type'] != AVATAR_GALLERY)
-						{
-							avatar_delete($_CLASS['core_user']-&gt;data['user_avatar']);
-						}
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'S_DISPLAY_GALLERY'	=&gt; true,
+				'S_CAT_OPTIONS'		=&gt; $s_category_options
+			));
 
-						$_CLASS['core_display']-&gt;meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.$module_link.'&quot;&gt;', '&lt;/a&gt;');
-						trigger_error($message);
-					}
+			foreach ($avatar_list as $avatar)
+			{
+				$_CLASS['core_template']-&gt;assign_vars_array('avatar',  array(
+					'AVATAR_IMAGE'		=&gt; $config['avatar_gallery_path'] . '/' . $avatar['file'],
+					'AVATAR_NAME'		=&gt; $avatar['name'],
+					'AVATAR_FILE'		=&gt; $avatar['file'],
+				));
+			}
+			unset($avatar_list);
+		}
+		else
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'AVATAR'		=&gt; $avatar_img,
+				'AVATAR_SIZE'	=&gt; $config['avatar_filesize'],
+				'WIDTH'			=&gt; $_CLASS['core_user']-&gt;data['user_avatar_width'],
+				'HEIGHT'		=&gt; $_CLASS['core_user']-&gt;data['user_avatar_height'],
 
-					$error = preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error);
-				}
+				'S_CAN_UPLOAD'		=&gt; $can_upload,
+				'S_LINK_AVATAR'		=&gt; ($config['allow_avatar_remote']),
+				'S_GALLERY_AVATAR'	=&gt; ($config['allow_avatar_local']),
+			));
+		}
 
-				// Generate users avatar
-				$avatar_img = '';
+	break;
+	
+	default:
+	//case 'profile_info':
+		$this-&gt;mode = 'profile_info';
 
-				if ($_CLASS['core_user']-&gt;data['user_avatar'])
-				{
-					switch ($_CLASS['core_user']-&gt;data['user_avatar_type'])
-					{
-						case AVATAR_UPLOAD:
-							$avatar_img = $config['avatar_path'] . '/';
-							break;
-						case AVATAR_GALLERY:
-							$avatar_img = $config['avatar_gallery_path'] . '/';
-							break;
-					}
-					$avatar_img .= $_CLASS['core_user']-&gt;data['user_avatar'];
+		$this_year = gmdate('Y', time());
+		
+		if ($submit)
+		{
+			$icq	= get_variable('icq', 'POST', null);
+			$aim	= get_variable('aim', 'POST', null);
+			$msn	= get_variable('msn', 'POST', null);
+			$yim	= get_variable('yim', 'POST', null);
+			$jabber = get_variable('jabber', 'POST', null);
+			//$google = get_variable('google', 'POST', null);
 
-					$avatar_img = '&lt;img src=&quot;' . $avatar_img . '&quot; width=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_width'] . '&quot; height=&quot;' . $_CLASS['core_user']-&gt;data['user_avatar_height'] . '&quot; border=&quot;0&quot; alt=&quot;&quot; /&gt;';
+			$website	= get_variable('website', 'POST', null);
+			$location	= get_variable('location', 'POST', null);				
+			$occupation	= get_variable('occupation', 'POST', null);
+			$interests	= get_variable('interests', 'POST', null);
+
+			$bday_day	= get_variable('bday_day', 'POST', false);
+			$bday_month	= get_variable('bday_month', 'POST', false);
+			$bday_year	= get_variable('bday_year', 'POST', false);
+
+			if ($bday_day || $bday_month || $bday_year)
+			{
+				if ($bday_day &lt; 1 || $bday_day &gt; 31 || $bday_month &lt; 1 || $bday_month &gt; 12 || $bday_year &lt; ($this_year - 100) || $bday_month &gt; $this_year)
+				{
+					$error[] = $_CLASS['core_user']-&gt;get_lang('BIRTHDAY_ERROR');
 				}
+			}
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'ERROR'			=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error), 
-					'AVATAR'		=&gt; $avatar_img, 
-					'AVATAR_SIZE'	=&gt; $config['avatar_filesize'], 
+			if (mb_strlen($interests) &gt; 255)
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('INTEREST_LONG_ERROR');
+			}
 
-					'S_FORM_ENCTYPE'	=&gt; ($can_upload) ? ' enctype=&quot;multipart/form-data&quot;' : '', 
+			if (mb_strlen($occupation) &gt; 255)
+			{
+				$error[] = $_CLASS['core_user']-&gt;get_lang('OCCUPATION_LONG_ERROR');
+			}
 
-					'L_AVATAR_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['AVATAR_EXPLAIN'], $config['avatar_max_width'], $config['avatar_max_height'], round($config['avatar_filesize'] / 1024)),)
+			if (empty($error))
+			{
+				$sql_ary = array(
+					'user_icq'		=&gt; $icq,
+					'user_aim'		=&gt; $aim,
+					'user_msnm'		=&gt; $msn,
+					'user_yim'		=&gt; $yim,
+					'user_jabber'	=&gt; $jabber,
+					//'user_google'	=&gt; $google,
+					'user_website'	=&gt; $website,
+					'user_from'		=&gt; $location,
+					'user_occ'		=&gt; $occupation,
+					'user_interests'=&gt; $interests,
+					'user_birthday'	=&gt; ($bday_day) ? sprintf('%2d-%2d-%4d', $bday_day, $bday_month, $bday_year) : null,
 				);
 
-				if ($display_gallery &amp;&amp; $config['allow_avatar_local'])
-				{
-					require_once($site_file_root.'includes/functions_user.php');
+				$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
+					SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql_ary) . '
+					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'];
+				$_CLASS['core_db']-&gt;sql_query($sql);
 
-					$avatar_list = avatar_gallery($folder, $folders, $error);
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link));
+				$message = $_CLASS['core_user']-&gt;lang['PROFILE_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'. generate_link($this-&gt;link) .'&quot;&gt;', '&lt;/a&gt;');
+				trigger_error($message);
+			}
+		}
 
-					array_unshift($folders, '');
+		if (!isset($bday_day))
+		{
+			if ($_CLASS['core_user']-&gt;data['user_birthday'])
+			{
+				list($bday_day, $bday_month, $bday_year) = explode('-', $_CLASS['core_user']-&gt;data['user_birthday']);
+			}
+			else
+			{
+				$bday_day = $bday_month = $bday_year = '';
+			}
+		}
 
-					$s_category_options = '';
+		$s_birthday_day_options = '&lt;option value=&quot;0&quot;' . ((!$bday_day) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
 
-					foreach ($folders as $cat)
-					{
-						$s_category_options .= '&lt;option value=&quot;' . $cat . '&quot;' . (($cat == $folder) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . (($cat) ? $cat : '--') . '&lt;/option&gt;';
-					}
+		for ($i = 1; $i &lt; 32; $i++)
+		{
+			$selected = ($i == $bday_day) ? ' selected=&quot;selected&quot;' : '';
+			$s_birthday_day_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
+		}
 
-					$_CLASS['core_template']-&gt;assign_array(array(
-						'S_DISPLAY_GALLERY'	=&gt; true,
-						'S_CAT_OPTIONS'		=&gt; $s_category_options)
-					);
+		$s_birthday_month_options = '&lt;option value=&quot;0&quot;' . ((!$bday_month) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
+		for ($i = 1; $i &lt; 13; $i++)
+		{
+			$selected = ($i == $bday_month) ? ' selected=&quot;selected&quot;' : '';
+			$s_birthday_month_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
+		}
+		$s_birthday_year_options = '';
 
-					foreach ($avatar_list as $avatar)
-					{
-						$_CLASS['core_template']-&gt;assign_vars_array('avatar',  array(
-							'AVATAR_IMAGE'		=&gt; $config['avatar_gallery_path'] . '/' . $avatar['file'],
-							'AVATAR_NAME'		=&gt; $avatar['name'],
-							'AVATAR_FILE'		=&gt; $avatar['file'],
-						));
-					}
-					unset($avatar_list);
-				}
-				else
-				{
-					$_CLASS['core_template']-&gt;assign_array(array(
-						'AVATAR'		=&gt; $avatar_img,
-						'AVATAR_SIZE'	=&gt; $config['avatar_filesize'],
-						'WIDTH'			=&gt; $_CLASS['core_user']-&gt;data['user_avatar_width'],
-						'HEIGHT'		=&gt; $_CLASS['core_user']-&gt;data['user_avatar_height'],
+		$s_birthday_year_options = '&lt;option value=&quot;0&quot;' . ((!$bday_year) ? ' selected=&quot;selected&quot;' : '') . '&gt;--&lt;/option&gt;';
 
-						'S_CAN_UPLOAD'		=&gt; $can_upload,
-						'S_LINK_AVATAR'		=&gt; ($config['allow_avatar_remote']),
-						'S_GALLERY_AVATAR'	=&gt; ($config['allow_avatar_local']),
-					));
-				}
-
-				break;
+		$i = $this_year - 100;
+		for ($i; $i &lt; $this_year; $i++)
+		{
+			$selected = ($i == $bday_year) ? ' selected=&quot;selected&quot;' : '';
+			$s_birthday_year_options .= &quot;&lt;option value=\&quot;$i\&quot;$selected&gt;$i&lt;/option&gt;&quot;;
 		}
 
 		$_CLASS['core_template']-&gt;assign_array(array(
-			'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_PROFILE_' . strtoupper($mode)],
-			'S_HIDDEN_FIELDS'			=&gt; $s_hidden_fields,
-			'S_UCP_ACTION'				=&gt; $module_link
-		));
+			'ERROR'		=&gt; empty($error) ? '' : implode('&lt;br /&gt;', $error),
 
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_PROFILE'], 'ucp_profile_' . $mode . '.html');
-	}
+			'ICQ'		=&gt; isset($icq) ? $icq : $_CLASS['core_user']-&gt;data['user_icq'], 
+			'YIM'		=&gt; isset($yim) ? $yim : $_CLASS['core_user']-&gt;data['user_yim'], 
+			'AIM'		=&gt; isset($aim) ? $aim : $_CLASS['core_user']-&gt;data['user_aim'], 
+			'MSN'		=&gt; isset($msn) ? $msn : $_CLASS['core_user']-&gt;data['user_msnm'], 
+			//'GOOGLE'	=&gt; isset($google) ? $google : $_CLASS['core_user']-&gt;data['user_google'], 
+			'JABBER'	=&gt; isset($jabber) ? $jabber : $_CLASS['core_user']-&gt;data['user_jabber'], 
+			'WEBSITE'	=&gt; isset($website) ? $website : $_CLASS['core_user']-&gt;data['user_website'], 
+			'LOCATION'	=&gt; isset($location) ? $location : $_CLASS['core_user']-&gt;data['user_from'], 
+			'OCCUPATION'=&gt; isset($occupation) ? $occupation : $_CLASS['core_user']-&gt;data['user_occ'], 
+			'INTERESTS'	=&gt; isset($interests) ? $interests : $_CLASS['core_user']-&gt;data['user_interests'], 
+
+			'S_BIRTHDAY_DAY_OPTIONS'	=&gt; $s_birthday_day_options, 
+			'S_BIRTHDAY_MONTH_OPTIONS'	=&gt; $s_birthday_month_options, 
+			'S_BIRTHDAY_YEAR_OPTIONS'	=&gt; $s_birthday_year_options,
+		));
+	break;
 }
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'L_TITLE'					=&gt; $_CLASS['core_user']-&gt;lang['UCP_PROFILE_' . strtoupper($this-&gt;mode)],
+	'S_HIDDEN_FIELDS'			=&gt; generate_hidden_fields($hidden_fields),
+	'S_UCP_ACTION'				=&gt; generate_link($this-&gt;link)
+));
+
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;lang['UCP_PROFILE'], 'modules/control_panel/ucp_profile_' . $this-&gt;mode . '.html');
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_register.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_register.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_register.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -21,294 +21,286 @@
 $Id$
 */
 
-class ucp_register extends module 
+
+global $_CLASS, $_CORE_CONFIG;
+
+$coppa  = isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
+$submit = isset($_POST['submit']);
+
+if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
+	|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
+	&amp;&amp; !$_CORE_CONFIG['email']['email_enable'])
 {
-	function ucp_register($id, $mode)
+	trigger_error('UCP_REGISTER_DISABLE');
+}
+
+$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
+
+$error = $data = array();
+$hidden_fields = '';
+
+if (!isset($_POST['agreed']))
+{
+	if ($_CORE_CONFIG['user']['coppa_enable'] &amp;&amp; is_null($coppa))
 	{
-		global $site_file_root, $config, $_CLASS, $_CORE_CONFIG;
-		
-		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
-		$submit		= isset($_POST['submit']);
+		$now = explode(':', gmdate('m:j:Y'));
 
-		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
-			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-			&amp;&amp; !$_CORE_CONFIG['email']['email_enable'])
-		{
-			trigger_error('UCP_REGISTER_DISABLE');
-		}
+		$coppa_birthday = $_CLASS['core_user']-&gt;format_date(mktime(12, 0, 0, $now[0], $now[1], $now[2] - 13), 'D M d, Y'); 
 
-		$_CLASS['core_template']-&gt;assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'L_COPPA_NO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_BEFORE'], $coppa_birthday),
+			'L_COPPA_YES'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
 
-		$error = $data = array();
-		$s_hidden_fields = '';
+			'U_COPPA_NO'		=&gt; generate_link('Control_Panel&amp;mode=register&amp;coppa=0'), 
+			'U_COPPA_YES'		=&gt; generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
 
+			'S_SHOW_COPPA'		=&gt; true, 
+			'S_HIDDEN_FIELDS'	=&gt; $hidden_fields,
+			'S_REGISTER_ACTION'	=&gt; generate_link('Control_Panel&amp;mode=register'))
+		);
+	}
+	else
+	{
+		$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;coppa&quot; value=&quot;' . $coppa . '&quot; /&gt;';
 
-		if (!isset($_POST['agreed']))
-		{
-			if ($_CORE_CONFIG['user']['coppa_enable'] &amp;&amp; is_null($coppa))
-			{
-				$now = explode(':', gmdate('m:j:Y'));
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_SHOW_COPPA'		=&gt; false,
+			'S_HIDDEN_FIELDS'	=&gt; $hidden_fields,
+			'S_REGISTER_ACTION'	=&gt; generate_link('Control_Panel&amp;mode=register')
+		));
+	}
 
-				$coppa_birthday = $_CLASS['core_user']-&gt;format_date(mktime(12, 0, 0, $now[0], $now[1], $now[2] - 13), 'D M d, Y'); 
+	$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;lang['REGISTER'], 'modules/Control_Panel/ucp_agreement.html');
+}
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'L_COPPA_NO'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_BEFORE'], $coppa_birthday),
-					'L_COPPA_YES'		=&gt; sprintf($_CLASS['core_user']-&gt;lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
+if ($submit)
+{
+	require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
-					'U_COPPA_NO'		=&gt; generate_link('Control_Panel&amp;mode=register&amp;coppa=0'), 
-					'U_COPPA_YES'		=&gt; generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
+	$error = array();
 
-					'S_SHOW_COPPA'		=&gt; true, 
-					'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields,
-					'S_REGISTER_ACTION'	=&gt; generate_link('Control_Panel&amp;mode=register'))
-				);
-			}
-			else
-			{
-				$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;coppa&quot; value=&quot;' . $coppa . '&quot; /&gt;';
+	$username	= get_variable('username', 'POST', false);
+	$password	= get_variable('password', 'POST', false);
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'S_SHOW_COPPA'		=&gt; false,
-					'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields,
-					'S_REGISTER_ACTION'	=&gt; generate_link('Control_Panel&amp;mode=register')
-				));
-			}
+	$email			= get_variable('email', 'POST', false);
+	$email_confirm	= get_variable('email_confirm', 'POST', '');
 
-			$this-&gt;display($_CLASS['core_user']-&gt;lang['REGISTER'], 'ucp_agreement.html');
+	//when we add this make sure to confirm that it's one of the installed langs
+	$lang		= $_CORE_CONFIG['global']['default_lang'];
+	$tz			= get_variable('tz', 'POST', false);
 
-			script_close();
-		}
+	if (strpos($username, &quot;\n&quot;))
+	{
+		die;
+	}
 
-		if ($submit)
-		{
-			require_once($site_file_root.'includes/functions_user.php');
+	$username_validate = validate_username($username);
 
-			$error = array();
+	if ($username_validate !== true)
+	{
+		$error[] = $_CLASS['core_user']-&gt;get_lang($username_validate);
+	}
 
-			$username	= get_variable('username', 'POST', false);
-			$password	= get_variable('password', 'POST', false);
+	if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
+	{
+		$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_ERROR');
+	}
 
-			$email			= get_variable('email', 'POST', false);
-			$email_confirm	= get_variable('email_confirm', 'POST', '');
+	if (!$email || $email !== $email_confirm)
+	{
+		$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_ERROR');
+	}
+	elseif (!check_email($email))
+	{
+		$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_INVALID');
+	}
 
-			//when we add this make sure to confirm that it's one of the installed langs
-			$lang		= $_CORE_CONFIG['global']['default_lang'];
-			$tz			= get_variable('tz', 'POST', false);
+	if (!$tz || !in_array($tz, tz_array()))
+	{
+		$tz = null;
+	}
 
-			if (strpos($username, &quot;\n&quot;))
-			{
-				die;
-			}
+	if ($_CORE_CONFIG['user']['enable_confirm'])
+	{
+		$confirmation_code = $_CLASS['core_user']-&gt;session_data_get('confirmation_code');
+		$confirm_code = trim(get_variable('confirm_code', 'POST', false));
 
-			$username_validate = validate_username($username);
+		if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
+		{
+			$error[] = $_CLASS['core_user']-&gt;get_lang('CONFIRM_CODE_WRONG');
+		}
 
-			if ($username_validate !== true)
-			{
-				$error[] = $_CLASS['core_user']-&gt;get_lang($username_validate);
-			}
+		// we don't need this any more
+		$_CLASS['core_user']-&gt;user_data_kill('confirmation_code');
+	}
 
-			if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
-			{
-				$error[] = $_CLASS['core_user']-&gt;get_lang('PASSWORD_ERROR');
-			}
+	if (empty($error))
+	{
+		$encode_password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
 
-			if (!$email || $email !== $email_confirm)
-			{
-				$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_ERROR');
-			}
-			elseif (!check_email($email))
-			{
-				$error[] = $_CLASS['core_user']-&gt;get_lang('EMAIL_INVALID');
-			}
+		if (!$encode_password)
+		{
+			//do some admin contact thing here
+			die('Activation disabled: Passwaord encoding problem');
+		}
 
-			if (!$tz || !in_array($tz, tz_array()))
+		if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
+		{
+			$user_status = STATUS_PENDING;
+			$user_act_key = generate_string(10);
+
+			if ($coppa)
 			{
-				$tz = null;
+				$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_COPPA');
+				$email_template = 'activation_coppa_inactive.txt';
 			}
-
-			if ($_CORE_CONFIG['user']['enable_confirm'])
+			elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
 			{
-				$confirmation_code = $_CLASS['core_user']-&gt;session_data_get('confirmation_code');
-				$confirm_code = trim(get_variable('confirm_code', 'POST', false));
-
-				if (!$confirm_code || !$confirmation_code || $confirm_code != $confirmation_code)
-				{
-					$error[] = $_CLASS['core_user']-&gt;get_lang('CONFIRM_CODE_WRONG');
-				}
-
-				// we don't need this any more
-				$_CLASS['core_user']-&gt;user_data_kill('confirmation_code');
+				$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_INACTIVE');
+				$email_template = 'activation_inactive.txt';
 			}
-
-			if (empty($error))
+			elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			{
-				$encode_password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
+				$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_INACTIVE_ADMIN');
+				$email_template = 'activation_admin_inactive.txt';
+			}
+		}
+		else
+		{
+			$user_status = STATUS_ACTIVE;
+			$user_act_key = null;
 	
-				if (!$encode_password)
-				{
-					//do some admin contact thing here
-					die('Activation disabled: Passwaord encoding problem');
-				}
+			$email_template = 'activation_active.txt';
+			$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_ADDED');
+		}
 
-				if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-				{
-					$user_status = STATUS_PENDING;
-					$user_act_key = generate_string(10);
+		$data = array(
+			'username'		=&gt; (string) $username,
+			'user_email'	=&gt; (string) $email,
+// add an option so admin can set with group they added to
+			'user_group'	=&gt; ($coppa) ? 3 : 2,
+			'user_reg_date'	=&gt; (int) $_CLASS['core_user']-&gt;time,
+			'user_timezone'	=&gt; (string) $tz,
 
-					if ($coppa)
-					{
-						$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_COPPA');
-						$email_template = 'activation_coppa_inactive.txt';
-					}
-					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
-					{
-						$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_INACTIVE');
-						$email_template = 'activation_inactive.txt';
-					}
-					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
-					{
-						$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_INACTIVE_ADMIN');
-						$email_template = 'activation_admin_inactive.txt';
-					}
-				}
-				else
-				{
-					$user_status = STATUS_ACTIVE;
-					$user_act_key = null;
-			
-					$email_template = 'activation_active.txt';
-					$message = $_CLASS['core_user']-&gt;get_lang('ACCOUNT_ADDED');
-				}
+			'user_password'			=&gt; (string) $encode_password,
+			'user_password_encoding'=&gt; (string) $_CORE_CONFIG['user']['password_encoding'],
 
-				$data = array(
-					'username'		=&gt; (string) $username,
-					'user_email'	=&gt; (string) $email,
-// add an option so admin can set with group they added to
-					'user_group'	=&gt; ($coppa) ? 3 : 2,
-					'user_reg_date'	=&gt; (int) $_CLASS['core_user']-&gt;time,
-					'user_timezone'	=&gt; (string) $tz,
+			'user_lang'			=&gt; ($lang) ? (string) $lang : null,
+			'user_type'			=&gt; USER_NORMAL,
+			'user_status'		=&gt; (int) $user_status,
+			'user_act_key'		=&gt; (string) $user_act_key,
+			'user_ip'			=&gt; (string) $_CLASS['core_user']-&gt;ip,
+		);
 
-					'user_password'			=&gt; (string) $encode_password,
-					'user_password_encoding'=&gt; (string) $_CORE_CONFIG['user']['password_encoding'],
+		user_add($data);
 
-					'user_lang'			=&gt; ($lang) ? (string) $lang : null,
-					'user_type'			=&gt; USER_NORMAL,
-					'user_status'		=&gt; (int) $user_status,
-					'user_act_key'		=&gt; (string) $user_act_key,
-					'user_ip'			=&gt; (string) $_CLASS['core_user']-&gt;ip,
-				);
+		if ($data['user_status'] === STATUS_ACTIVE)
+		{
+			set_core_config('user', 'newest_user_id', $data['user_id'], false);
+			set_core_config('user', 'newest_username', $data['username'], false);
+			set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
+		}
 
-				user_add($data);
+		require_once SITE_FILE_ROOT.'includes/mailer.php';
 
-				if ($data['user_status'] === STATUS_ACTIVE)
-				{
-					set_core_config('user', 'newest_user_id', $data['user_id'], false);
-					set_core_config('user', 'newest_username', $data['username'], false);
-					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
-				}
+		$mailer = new core_mailer();
 
-				require_once($site_file_root.'includes/mailer.php');
+		$mailer-&gt;to($email, $username);
+		$mailer-&gt;subject('Welcome to ');
 
-				$mailer = new core_mailer();
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
+			'WELCOME_MSG'   =&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
+			'USERNAME'		=&gt; $username,
+			'PASSWORD'		=&gt; $password,
+			'EMAIL_SIG'		=&gt; '', //I like this
+			'U_ACTIVATE'	=&gt; generate_link('system&amp;mode=activate&amp;user_id='.$data['user_id'].'&amp;key='.$user_act_key, array('sid' =&gt; false, 'full' =&gt; true))
+		));
 
-				$mailer-&gt;to($email, $username);
-				$mailer-&gt;subject('Welcome to ');
+		if ($coppa)
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'FAX_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_fax'],
+				'MAIL_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_mail'],
+				'EMAIL_ADDRESS' =&gt; $email,
+				'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name']
+			));
+		}
 
-				$_CLASS['core_template']-&gt;assign_array(array(
-					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
-					'WELCOME_MSG'   =&gt; sprintf($_CLASS['core_user']-&gt;lang['WELCOME_SUBJECT'], $_CORE_CONFIG['global']['site_name']),
-					'USERNAME'		=&gt; $username,
-					'PASSWORD'		=&gt; $password,
-					'EMAIL_SIG'		=&gt; '', //I like this
-					'U_ACTIVATE'	=&gt; generate_link('system&amp;mode=activate&amp;user_id='.$data['user_id'].'&amp;key='.$user_act_key, array('sid' =&gt; false, 'full' =&gt; true))
-				));
+		$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/core/'.$email_template, true));
 
-				if ($coppa)
-				{
-					$_CLASS['core_template']-&gt;assign_array(array(
-						'FAX_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_fax'],
-						'MAIL_INFO'		=&gt; $_CORE_CONFIG['user']['coppa_mail'],
-						'EMAIL_ADDRESS' =&gt; $email,
-						'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name']
-					));
-				}
+		$mailer-&gt;send();
 
-				$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/core/'.$email_template, true));
+		$message = $message . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;'. generate_link() .'&quot;&gt;', '&lt;/a&gt;');
+		trigger_error($message);
+	}
+}
 
-				$mailer-&gt;send();
+$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;coppa&quot; value=&quot;' . $coppa . '&quot; /&gt;';
+$hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;agreed&quot; value=&quot;true&quot; /&gt;';
 
-				$message = $message . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_INDEX'],  '&lt;a href=&quot;'. generate_link() .'&quot;&gt;', '&lt;/a&gt;');
-				trigger_error($message);
-			}
-		}
+if ($_CORE_CONFIG['user']['enable_confirm'])
+{
+	$_CLASS['core_user']-&gt;session_data_set('confirmation_code', generate_string(6));
+	$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';
+}
+else
+{
+	$confirm_image = false;
+}
 
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;coppa&quot; value=&quot;' . $coppa . '&quot; /&gt;';
-		$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;agreed&quot; value=&quot;true&quot; /&gt;';
-		
-		if ($_CORE_CONFIG['user']['enable_confirm'])
+if ($submit)
+{
+	if ($_CORE_CONFIG['user']['max_reg_attempts'])
+	{
+		$attempts = (int) $_CLASS['core_user']-&gt;session_data_get('reg_attempts', 0);
+
+		if ($attempts &gt; $_CORE_CONFIG['user']['max_reg_attempts'])
 		{
-			$_CLASS['core_user']-&gt;session_data_set('confirmation_code', generate_string(6));
-			$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';
+			trigger_error('TOO_MANY_ATTEMPTS');
 		}
-		else
-		{
-			$confirm_image = false;
-		}
 
-		if ($submit)
-		{
-			if ($_CORE_CONFIG['user']['max_reg_attempts'])
-			{
-				$attempts = (int) $_CLASS['core_user']-&gt;session_data_get('reg_attempts', 0);
+		$_CLASS['core_user']-&gt;session_data_get('reg_attempts', ($attempts + 1));
+	}
+}
 
-				if ($attempts &gt; $_CORE_CONFIG['user']['max_reg_attempts'])
-				{
-					trigger_error('TOO_MANY_ATTEMPTS');
-				}
+switch ($_CORE_CONFIG['user']['activation'])
+{
+	case USER_ACTIVATION_SELF:
+		$l_reg_cond = $_CLASS['core_user']-&gt;lang['UCP_EMAIL_ACTIVATE'];
+	break;
 
-				$_CLASS['core_user']-&gt;session_data_get('reg_attempts', ($attempts + 1));
-			}
-		}
+	case USER_ACTIVATION_ADMIN:
+		$l_reg_cond = $_CLASS['core_user']-&gt;lang['UCP_ADMIN_ACTIVATE'];
+	break;
+	
+	default:
+		$l_reg_cond = '';
+	break;
+}
 
-		switch ($_CORE_CONFIG['user']['activation'])
-		{
-			case USER_ACTIVATION_SELF:
-				$l_reg_cond = $_CLASS['core_user']-&gt;lang['UCP_EMAIL_ACTIVATE'];
-			break;
+$user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
 
-			case USER_ACTIVATION_ADMIN:
-				$l_reg_cond = $_CLASS['core_user']-&gt;lang['UCP_ADMIN_ACTIVATE'];
-			break;
-			
-			default:
-				$l_reg_cond = '';
-			break;
-		}
+$_CLASS['core_template']-&gt;assign_array(array(
+	'ERROR'			=&gt; empty($error) ? false : implode('&lt;br /&gt;', $error), 
+	'USERNAME'		=&gt; isset($username) ? $username : '',
+	'PASSWORD'		=&gt; isset($password) ? $password : '',
+	'EMAIL'			=&gt; isset($email) ? $email : '',
+	'EMAIL_CONFIRM'	=&gt; isset($email_confirm) ? $email_confirm : '',
+	'CONFIRM_IMG'	=&gt; $confirm_image,
+	'SELECT_TZ'		=&gt; select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
-		$user_char_ary = array('.*' =&gt; 'USERNAME_CHARS_ANY', '[\w]+' =&gt; 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' =&gt; 'USERNAME_ALPHA_SPACERS');
+	'L_CONFIRM_EXPLAIN'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['CONFIRM_EXPLAIN'], '&lt;a href=&quot;mailto:' . htmlentities('') . '&quot;&gt;', '&lt;/a&gt;'), 
+	'L_ITEMS_REQUIRED'			=&gt; $l_reg_cond, 
+	'L_USERNAME_EXPLAIN'		=&gt; sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
+	'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'ERROR'			=&gt; empty($error) ? false : implode('&lt;br /&gt;', $error), 
-			'USERNAME'		=&gt; isset($username) ? $username : '',
-			'PASSWORD'		=&gt; isset($password) ? $password : '',
-			'EMAIL'			=&gt; isset($email) ? $email : '',
-			'EMAIL_CONFIRM'	=&gt; isset($email_confirm) ? $email_confirm : '',
-			'CONFIRM_IMG'	=&gt; $confirm_image,
-			'SELECT_TZ'		=&gt; select_tz(isset($tz) ? $tz : $_CORE_CONFIG['global']['default_timezone']),
 
-			'L_CONFIRM_EXPLAIN'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['CONFIRM_EXPLAIN'], '&lt;a href=&quot;mailto:' . htmlentities($config['board_contact']) . '&quot;&gt;', '&lt;/a&gt;'), 
-			'L_ITEMS_REQUIRED'			=&gt; $l_reg_cond, 
-			'L_USERNAME_EXPLAIN'		=&gt; sprintf($_CLASS['core_user']-&gt;lang[$user_char_ary[$_CORE_CONFIG['user']['allow_name_chars']] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']),
-			'L_NEW_PASSWORD_EXPLAIN'	=&gt; sprintf($_CLASS['core_user']-&gt;lang['NEW_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
+	'S_COPPA'			=&gt; $coppa, 
+	'S_HIDDEN_FIELDS'	=&gt; $hidden_fields,
+	'S_UCP_ACTION'		=&gt; generate_link(&quot;Control_Panel&amp;mode=register&quot;))
+);
 
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;lang['REGISTER'], 'modules/Control_Panel/ucp_register.html');
 
-			'S_COPPA'			=&gt; $coppa, 
-			'S_HIDDEN_FIELDS'	=&gt; $s_hidden_fields,
-			'S_UCP_ACTION'		=&gt; generate_link(&quot;Control_Panel&amp;mode=register&quot;))
-		);
-		
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['REGISTER'], 'ucp_register.html');
-	}
-}
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_zebra.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_zebra.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/control_panel/modules/ucp_zebra.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -11,162 +11,168 @@
 // 
 // -------------------------------------------------------------
 
-class ucp_zebra extends module
+global $_CLASS;
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'ERROR'				=&gt; false,
+	'USERNAMES'			=&gt; false,
+	'S_USERNAME_OPTIONS'=&gt; false
+));
+
+$hidden_fields = array();
+$this-&gt;mode = ($this-&gt;mode === 'foes') ? 'foes' : 'friends';
+
+if (!empty($_POST['submit']) || !empty($_GET['add']))
 {
-	function ucp_zebra($id, $mode)
+	if ($add_users = get_variable('add', 'REQUEST', false))
 	{
-		global $_CLASS;
+		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
+		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 		
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'ERROR'				=&gt; false,
-			'USERNAMES'			=&gt; false,
-			'S_USERNAME_OPTIONS'=&gt; false
-		));
-		
-		$s_hidden_fields = '';
+		$_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
 
-		if (!empty($_POST['submit']) || !empty($_GET['add']))
+		$add_users = explode(&quot;\n&quot;, $add_users);
+
+		$sql = 'SELECT z.*, u.username 
+			FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
+			WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+				AND u.user_id = z.zebra_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$friends = $foes = array();
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$data['usernames'] = get_variable('usernames', 'POST', false, 'array');
-			$data['add'] = get_variable('add', 'POST', false);
-
-			if ($data['add'] &amp;&amp; empty($error))
+			if ($row['friend'])
 			{
-				$data['add'] = explode(&quot;\n&quot;, $data['add']);
+				$friends[] = $row['username'];
+			}
+			else
+			{
+				$foes[] = $row['username'];
+			}
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
 
-				$sql = 'SELECT z.*, u.username 
-					FROM ' . ZEBRA_TABLE . ' z, ' . USERS_TABLE . ' u 
-					WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-						AND u.user_id = z.zebra_id&quot;;
-				$result = $_CLASS['core_db']-&gt;query($sql);
+		$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']-&gt;data['username']));
+		unset($friends, $foes);
 
-				$friends = $foes = array();
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		if (!empty($add_users))
+		{
+			$sql = 'SELECT user_id, user_type, user_status
+				FROM ' . CORE_USERS_TABLE . &quot; 
+				WHERE username IN ('&quot; .implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array($add_users)).&quot;')&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$add_users = array();
+
+			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				do
 				{
-					if ($row['friend'])
+					if ($row['user_type'] == USER_NORMAL &amp;&amp; $row['user_status'] == STATUS_ACTIVE)
 					{
-						$friends[] = $row['username'];
+						$add_users[] = $row['user_id'];
 					}
-					else
-					{
-						$foes[] = $row['username'];
-					}
 				}
-				$_CLASS['core_db']-&gt;free_result($result);
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 
-				$data['add'] = array_diff($data['add'], $friends, $foes, array($_CLASS['core_user']-&gt;data['username']));
-				unset($friends, $foes);
-
-				$data['add'] = &quot;'&quot;.implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array($data['add'])).&quot;'&quot;;
-
-				if ($data['add'])
+				// Remove users from foe list if they are admins or moderators
+				if ($this-&gt;mode === 'foes')
 				{
-					$sql = 'SELECT user_id, user_type, user_status
-						FROM ' . USERS_TABLE . ' 
-						WHERE username IN (' . $data['add'] . ')';
-					$result = $_CLASS['core_db']-&gt;query($sql);
-
-					if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					$perms = array();
+					foreach ($_CLASS['forums_auth']-&gt;acl_get_list($add_users, array('a_', 'm_')) as $forum_id =&gt; $forum_ary)
 					{
-						$user_id_ary = array();
-						do
+						foreach ($forum_ary as $auth_option =&gt; $user_ary)
 						{
-							if ($row['user_type'] == USER_NORMAL &amp;&amp; $row['user_status'] == STATUS_ACTIVE)
-							{
-								$user_id_ary[] = $row['user_id'];
-							}
+							$perms += $user_ary;
 						}
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+					}
 
-						// Remove users from foe list if they are admins or moderators
-						if ($mode == 'foes')
-						{
-							$perms = array();
-							foreach ($_CLASS['auth']-&gt;acl_get_list($user_id_ary, array('a_', 'm_')) as $forum_id =&gt; $forum_ary)
-							{
-								foreach ($forum_ary as $auth_option =&gt; $user_ary)
-								{
-									$perms += $user_ary;
-								}
-							}
+					// This may not be right ... it may yield true when perms equate to deny
+					$add_users = array_diff($add_users, $perms);
+					unset($perms);
+				}
 
-							// This may not be right ... it may yield true when perms equate to deny
-							$user_id_ary = array_diff($user_id_ary, $perms);
-							unset($perms);
-						}
+				if (!empty($add_users))
+				{
+					$sql_mode = ($this-&gt;mode === 'friends') ? 'friend' : 'foe';
 
-						if (!empty($user_id_ary))
-						{
-							$sql_mode = ($mode == 'friends') ? 'friend' : 'foe';
-
-							$sql = 'INSERT INTO ' . ZEBRA_TABLE . &quot; (user_id, zebra_id, $sql_mode) 
-								VALUES &quot; . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, \\1, 1)&quot;,  $user_id_ary));
-							$_CLASS['core_db']-&gt;query($sql);
-						}
-						else
-						{
-							$error[] = 'NOT_ADDED_' . strtoupper($mode);
-						}
-						unset($user_id_ary);
-					}
-					else
-					{
-						$error[] = 'USER_NOT_FOUND';
-					}
-					
-					$_CLASS['core_db']-&gt;free_result($result);
+					$sql = 'INSERT INTO ' . ZEBRA_TABLE . &quot; (user_id, zebra_id, $sql_mode) 
+						VALUES &quot; . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, \\1, 1)&quot;,  $user_id_ary));
+					$_CLASS['core_db']-&gt;query($sql);
 				}
+				else
+				{
+					$error[] = 'NOT_ADDED_' . strtoupper($this-&gt;mode);
+				}
+				unset($add_users);
 			}
-			elseif ($data['usernames'] &amp;&amp; empty($error))
+			else
 			{
-				// Force integer values
-				$data['usernames'] = array_map('intval', $data['usernames']);
-
-				$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-					WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
-						AND zebra_id IN (' . implode(', ', $data['usernames']) . ')';
-				$_CLASS['core_db']-&gt;query($sql);
+				$error[] = 'USER_NOT_FOUND';
 			}
 			
-			if (empty($error))
-			{
-				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;));
-				$message = $_CLASS['core_user']-&gt;lang[strtoupper($mode) . '_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;).'&quot;&gt;', '&lt;/a&gt;');
-				trigger_error($message);
-			}
-			else
-			{
-				$_CLASS['core_template']-&gt;assign('ERROR', implode('&lt;br /&gt;', preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error)));
-			}
+			$_CLASS['core_db']-&gt;free_result($result);
 		}
+	}
+	elseif ($remove_users = get_variable('usernames', 'POST', false, 'array:int'))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . ' 
+				AND zebra_id IN (' . implode(', ', array_unique($remove_users)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
 
-		$sql_and = ($mode == 'friends') ? 'z.friend = 1' : 'z.foe = 1';
-		$sql = 'SELECT z.*, u.username 
-			FROM ' . ZEBRA_TABLE . ' z, ' . USERS_TABLE . ' u 
-			WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
-				AND $sql_and 
-				AND u.user_id = z.zebra_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+	if (empty($error))
+	{
+		$_CLASS['core_display']-&gt;meta_refresh(3, generate_link($this-&gt;link));
+		$message = $_CLASS['core_user']-&gt;lang[strtoupper($this-&gt;mode) . '_UPDATED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link($this-&gt;link).'&quot;&gt;', '&lt;/a&gt;');
+		trigger_error($message);
+	}
+	else
+	{
+		$_CLASS['core_template']-&gt;assign('ERROR', implode('&lt;br /&gt;', preg_replace('#^([A-Z_]+)$#e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\\1'])) ? \$_CLASS['core_user']-&gt;lang['\\1'] : '\\1'&quot;, $error)));
+	}
+}
 
-		$s_username_options = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$s_username_options .= '&lt;option value=&quot;' . $row['zebra_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
+$sql_and = ($this-&gt;mode === 'friends') ? 'z.friend = 1' : 'z.foe = 1';
 
-		$_CLASS['core_template']-&gt;assign_array(array( 
-			'L_TITLE'				=&gt; $_CLASS['core_user']-&gt;lang['UCP_ZEBRA_' . strtoupper($mode)],
+$sql = 'SELECT z.*, u.username 
+	FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
+	WHERE z.user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
+		AND $sql_and 
+		AND u.user_id = z.zebra_id&quot;;
+$result = $_CLASS['core_db']-&gt;query($sql);
 
-			'U_SEARCH_USER'			=&gt; generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 
+$username_options = '';
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$username_options .= '&lt;option value=&quot;' . $row['zebra_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
+}
+$_CLASS['core_db']-&gt;free_result($result);
 
-			'S_USERNAME_OPTIONS'	=&gt; $s_username_options,
-			'S_HIDDEN_FIELDS'		=&gt; $s_hidden_fields,
-			'S_UCP_ACTION'			=&gt; generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=$mode&quot;))
-		);
+$_CLASS['core_template']-&gt;assign_array(array( 
+	'L_TITLE'				=&gt; $_CLASS['core_user']-&gt;lang['UCP_ZEBRA_' . strtoupper($this-&gt;mode)],
 
-		$this-&gt;display($_CLASS['core_user']-&gt;lang['UCP_ZEBRA'], 'ucp_zebra_' . $mode . '.html');
-	}
+	'U_SEARCH_USER'			=&gt; generate_link('members_list&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 
+
+	'S_USERNAME_OPTIONS'	=&gt; $username_options,
+	'S_HIDDEN_FIELDS'		=&gt; generate_hidden_fields($hidden_fields),
+	'S_UCP_ACTION'			=&gt; generate_link($this-&gt;link)
+));
+
+unset($username_options);
+
+/*
+$result = $_CLASS['core_db']-&gt;query('SHOW COLLATION');
+$result = $_CLASS['core_db']-&gt;query('SHOW CHARACTER SET');
+
+while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	print_r($row );echo '&lt;br/&gt;'; die;
 }
+*/
 
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang('UCP_ZEBRA'), 'modules/control_panel/ucp_zebra_' . $this-&gt;mode . '.html');
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/download.php
===================================================================
--- cms/trunk/modules/forums/download.php	2005-10-26 19:32:51 UTC (rev 167)
+++ cms/trunk/modules/forums/download.php	2005-10-27 16:01:46 UTC (rev 168)
@@ -212,42 +212,41 @@
 		$browser_agent = 'other';
     }
 
-	// Correct the mime type - we force application/octetstream for all files, except images
-	// Please do not change this, it is a security precaution
+	/*
+		Correct the mime type - we force application/octetstream for all files, except images
+		Please do not change this, it is a security precaution
+	*/
+
 	if ($category == ATTACHMENT_CATEGORY_NONE &amp;&amp; strpos($attachment['mimetype'], 'image') === false)
 	{
-		$attachment['mimetype'] = ($browser_agent == 'ie' || $browser_agent == 'opera') ? 'application/octetstream' : 'application/octet-stream';
+		$attachment['mimetype'] = ($browser_agent === 'ie' || $browser_agent === 'opera') ? 'application/octetstream' : 'application/octet-stream';
 	}
 
+	/* Clean all output buffers */
 	while (@ob_end_clean());
+	header('Content-Encoding: ');
 
-	// Now the tricky part... let's dance
+	/* Send out required headers */
 	header('Pragma: public');
-
-	// Send out the Headers
 	header('Content-Type: ' . $attachment['mimetype'] . '; name=&quot;' . $attachment['real_filename'] . '&quot;');
 	header('Content-Disposition: inline; filename=&quot;' . $attachment['real_filename'] . '&quot;');
 
-	// Now send the File Contents to the Browser
+	/* Now send the File Contents to the Browser */
 	$size = @filesize($filename);
+
 	if ($size)
 	{
-		header(&quot;Content-length: $size&quot;);
+		header('Content-Length: '.$size);
 	}
+
 	$result = @readfile($filename);
 
 	if (!$result)
 	{
 		trigger_error('Unable to deliver file.&lt;br /&gt;Error was: ' . $php_errormsg, E_USER_WARNING);
 	}
-	if (!empty($_CLASS['core_cache']))
-	{
-		$_CLASS['core_cache']-&gt;unload();
-	}
-	
-	$_CLASS['core_db']-&gt;sql_close();
-	flush();
-	exit;
+
+	script_close(false);
 }
 
 function download_allowed()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000087.html">[Viperals-svncheckins] r167 - in cms/trunk/modules: articles contact control_panel forums members_list quick_message/quick_message2 quick_message/quick_message2/language
</A></li>
	<LI>Next message: <A HREF="000089.html">[Viperals-svncheckins] r169 - in cms/trunk: . admin admin/functions includes includes/display includes/templates/admin includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/modules includes/templates/admin/system includes/templates/admin/users install modules/forums themes_admin/viperal_admin themes_admin/viperal_admin/template
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#88">[ date ]</a>
              <a href="thread.html#88">[ thread ]</a>
              <a href="subject.html#88">[ subject ]</a>
              <a href="author.html#88">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
