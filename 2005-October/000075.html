<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r155 - in cms/branches/1.0alpha2: images images/icons images/icons/misc images/icons/smilies includes/display includes/forums includes/forums/admin install modules/Control_Panel/ucp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r155%20-%20in%20cms/branches/1.0alpha2%3A%20images%20images/icons%20images/icons/misc%20images/icons/smilies%20includes/display%20includes/forums%20includes/forums/admin%20install%20modules/Control_Panel/ucp&In-Reply-To=%3C200510010155.j911tNib029551%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000074.html">
   <LINK REL="Next"  HREF="000076.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r155 - in cms/branches/1.0alpha2: images images/icons images/icons/misc images/icons/smilies includes/display includes/forums includes/forums/admin install modules/Control_Panel/ucp</H1>
    <B>Ryan Marshall at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r155%20-%20in%20cms/branches/1.0alpha2%3A%20images%20images/icons%20images/icons/misc%20images/icons/smilies%20includes/display%20includes/forums%20includes/forums/admin%20install%20modules/Control_Panel/ucp&In-Reply-To=%3C200510010155.j911tNib029551%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r155 - in cms/branches/1.0alpha2: images images/icons images/icons/misc images/icons/smilies includes/display includes/forums includes/forums/admin install modules/Control_Panel/ucp">viperal at berlios.de
       </A><BR>
    <I>Sat Oct  1 03:55:23 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000074.html">[Viperals-svncheckins] r154 - cms/trunk/includes/display
</A></li>
        <LI>Next message: <A HREF="000076.html">[Viperals-svncheckins] r156 - in cms/trunk: blocks includes/display install
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#75">[ date ]</a>
              <a href="thread.html#75">[ thread ]</a>
              <a href="subject.html#75">[ subject ]</a>
              <a href="author.html#75">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2005-10-01 03:55:16 +0200 (Sat, 01 Oct 2005)
New Revision: 155

Added:
   cms/branches/1.0alpha2/images/icons/
   cms/branches/1.0alpha2/images/icons/index.htm
   cms/branches/1.0alpha2/images/icons/misc/
   cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
   cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
   cms/branches/1.0alpha2/images/icons/misc/asterix.gif
   cms/branches/1.0alpha2/images/icons/misc/index.htm
   cms/branches/1.0alpha2/images/icons/misc/musical.gif
   cms/branches/1.0alpha2/images/icons/misc/square.gif
   cms/branches/1.0alpha2/images/icons/smilies/
   cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
   cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
   cms/branches/1.0alpha2/images/icons/smilies/idea.gif
   cms/branches/1.0alpha2/images/icons/smilies/index.htm
   cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
   cms/branches/1.0alpha2/images/icons/smilies/question.gif
   cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
Removed:
   cms/branches/1.0alpha2/images/Thumbs.db
Modified:
   cms/branches/1.0alpha2/includes/display/display.php
   cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php
   cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php
   cms/branches/1.0alpha2/includes/forums/functions_admin.php
   cms/branches/1.0alpha2/includes/forums/functions_display.php
   cms/branches/1.0alpha2/install/build_data.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php
Log:


Deleted: cms/branches/1.0alpha2/images/Thumbs.db
===================================================================
(Binary files differ)

Added: cms/branches/1.0alpha2/images/icons/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+&lt;html&gt;
+&lt;head&gt;
+&lt;title&gt;&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
+&lt;/head&gt;
+
+&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot;&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;

Added: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_ltr.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/arrow_bold_rgt.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/asterix.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/asterix.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/misc/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/misc/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+&lt;html&gt;
+&lt;head&gt;
+&lt;title&gt;&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
+&lt;/head&gt;
+
+&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot;&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;

Added: cms/branches/1.0alpha2/images/icons/misc/musical.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/musical.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/misc/square.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/misc/square.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/alien_grn.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/exclaim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/idea.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/idea.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/index.htm
===================================================================
--- cms/branches/1.0alpha2/images/icons/smilies/index.htm	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/images/icons/smilies/index.htm	2005-10-01 01:55:16 UTC (rev 155)
@@ -0,0 +1,10 @@
+&lt;html&gt;
+&lt;head&gt;
+&lt;title&gt;&lt;/title&gt;
+&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;
+&lt;/head&gt;
+
+&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot;&gt;
+
+&lt;/body&gt;
+&lt;/html&gt;

Added: cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/mr_green.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/question.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/question.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/icons/smilies/redface_anim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/branches/1.0alpha2/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha2/includes/display/display.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/display/display.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -161,7 +161,7 @@
 		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['core_user']-&gt;data['user_new_privmsg'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('popuppm'))
 		{
 			$this-&gt;header['js'][] = '&lt;script type=&quot;text/javascript&quot;&gt;window.open(\''. preg_replace('/&amp;/', '&amp;', generate_link('Control_Panel&amp;i=pm&amp;mode=popup', array('full' =&gt; true))).&quot;', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');&lt;/script&gt;&quot;;
-			$_CLASS['core_db']-&gt;sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
+			//$_CLASS['core_db']-&gt;sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id']);
 		}
 
 		$this-&gt;header['regular'][] = '&lt;meta name=&quot;generator&quot; content=&quot;Viperal CMS ( www.viperal.com ) Copyright(c) '.date('Y').'&quot; /&gt;';

Modified: cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/admin/admin_forums.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -1363,7 +1363,7 @@
 
 	// Delete forum ids from extension groups table
 	$sql = 'SELECT group_id, allowed_forums 
-		FROM ' . EXTENSION_GROUPS_TABLE . &quot;
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
 		WHERE allowed_forums &lt;&gt; ''&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -1371,7 +1371,7 @@
 	{
 		$allowed_forums = unserialize(trim($row['allowed_forums']));
 		$allowed_forums = array_diff($allowed_forums, $forum_ids);
-		$sql = 'UPDATE ' . EXTENSION_GROUPS_TABLE . &quot; 
+		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot; 
 			SET allowed_forums = '&quot; . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . &quot;'
 			WHERE group_id = {$row['group_id']}&quot;;
 		$_CLASS['core_db']-&gt;query($sql);
@@ -1384,28 +1384,34 @@
 	{
 		case 'MOVE_POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_name);
-			break;
+		break;
+
 		case 'POSTS_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case '_MOVE_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_name);
-			break;
+		break;
+
 		case 'MOVE_POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_name);
 			break;
 		case 'POSTS_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_name);
-			break;
+		break;
+
 		case '_FORUMS':
 			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_name);
-			break;
+		break;
+
 		case 'POSTS_':
 			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_name);
-			break; 
+		break; 
 	}
 
 	return $errors;

Modified: cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/admin/admin_permissions.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -1,1304 +1,1303 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
-//
-// FILENAME  : admin_permissions.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : &#169; 2001, 2003 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// values need checks
-
-
-// Grab and set some basic parameters
-//
-// 'mode' determines what we're altering; administrators, users, deps, etc.
-// 'submit' is used to determine what we're doing ... special format
-$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
-
-// What mode are we running? So we can output the correct title, explanation
-// and set the sql_option_mode/acl check
-switch ($mode)
-{
-	case 'forum':
-		$l_title = $_CLASS['core_user']-&gt;lang['PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_auth';
-		$sql_option_mode = 'f';
-		break;
-
-	case 'mod':
-		$l_title = $_CLASS['core_user']-&gt;lang['MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'supermod':
-		$l_title = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'admin':
-		$l_title = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS_EXPLAIN'];
-		$which_acl = 'a_authadmins';
-		$sql_option_mode = 'a';
-		break;
-
-	case 'user':
-		$l_title = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authusers';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'group':
-		$l_title = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authgroups';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'deps':
-		$l_title = $_CLASS['core_user']-&gt;lang['DEPENDENCIES'];
-		$l_title_explain = $_CLASS['core_user']-&gt;lang['DEPENDENCIES_EXPLAIN'];
-		$which_acl = 'a_authdeps';
-		break;
-}
-
-// Permission check
-if (!$_CLASS['auth']-&gt;acl_get($which_acl))
-{
-	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-}
-
-$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
-$which_mode = (!empty($submode) &amp;&amp; $submode != $mode) ? $submode : $mode;
-$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
-$submit		= (sizeof($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
-
-// Submitted setting data
-//
-// 'auth_settings' contains the submitted option settings assigned to options, should be an 
-//   associative array with integer values
-$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
-
-
-// Forum, User or Group information
-//
-// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
-// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
-// 'forum_id' contains the list of forums, 0 is used for &quot;All forums&quot;, can be array or scalar
-$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
-$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
-
-if (isset($_REQUEST['f']))
-{
-	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
-}
-
-if (!isset($forum_id[$which_mode]))
-{
-	$forum_id[$which_mode][] = 0;
-}
-
-$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
-
-// Generate list of forum id's
-$s_forum_id = '';
-
-foreach ($forum_id as $forum_submode =&gt; $forum_submode_ids)
-{
-	foreach ($forum_submode_ids as $submode_forum_id)
-	{
-		$s_forum_id .= '&lt;input type=&quot;hidden&quot; name=&quot;f[' . $forum_submode . '][]&quot; value=&quot;' . $submode_forum_id . '&quot; /&gt;';
-	}
-}
-unset($forum_submode_ids);
-unset($forum_submode);
-unset($submode_forum_id);
-
-
-// Instantiate a new auth admin object in readiness
-$auth_admin = new auth_admin();
-
-// Are we setting deps? If we are we need to re-run the mode match above for the
-// relevant 'new' mode
-if (!empty($submode))
-{
-	switch ($submode)
-	{
-		case 'forum':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
-			$which_acl = 'a_auth';
-			$sql_option_mode = 'f';
-			break;
-
-		case 'mod':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-
-		case 'supermod':
-			$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-	}
-
-	// Permission check
-	if (!$_CLASS['auth']-&gt;acl_get($which_acl))
-	{
-		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
-	}
-}
-
-
-// Does user want to update anything? Check here to find out 
-// and act appropriately
-switch ($submit)
-{
-	case 'update':
-
-		if (sizeof($auth_settings))
-		{
-			// Admin wants subforums to inherit permissions ... so add these
-			// forums to the list ... since inheritance is only available for
-			// forum and moderator primary modes we deal with '$forum_id[$mode]'
-			if (!empty($_POST['inherit']))
-			{
-				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
-			}
-
-			// Update the permission set ... we loop through each auth setting array
-			foreach ($auth_settings as $auth_submode =&gt; $auth_setting)
-			{
-				// Are any entries * ? If so we need to remove them since they
-				// are options the user wishes to ignore
-
-				if (in_array('*', $auth_setting))
-				{
-					foreach ($auth_setting as $option =&gt; $setting)
-					{
-						if ($setting == '*')
-						{
-							unset($auth_setting[$option]);
-						}
-					}
-				}
-
-				if (!empty($auth_setting))
-				{
-					// Loop through all user/group ids
-					foreach ($ug_data as $id)
-					{
-						$auth_admin-&gt;acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
-					}
-				}
-			}
-
-			// Do we need to recache the moderator lists? We do if the mode
-			// was mod or auth_settings['mod'] is a non-zero size array
-			if ($mode == 'mod' || !empty($auth_settings['mod']))
-			{
-				cache_moderators();
-			}
-
-			// Remove users who are now moderators or admins from everyones foes
-			// list
-			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
-			{
-				update_foes();
-			}
-
-			// Logging ... first grab user or groupnames ...
-			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$l_ug_list = '';
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$auth_submode = array_keys($auth_settings);
-			foreach ($auth_submode as $sub_mode)
-			{
-				if (!in_array(0, $forum_id[$sub_mode]))
-				{
-					// Grab the forum details if non-zero forum_id
-					$sql = 'SELECT forum_name  
-						FROM ' . FORUMS_FORUMS_TABLE . &quot;
-						WHERE forum_id IN ($sql_forum_id)&quot;;
-					$result = $_CLASS['core_db']-&gt;query($sql);
-
-					$l_forum_list = '';
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-					{
-						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-					}
-					$_CLASS['core_db']-&gt;free_result($result);
-
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
-				}
-				else
-				{
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
-				}
-			}
-			unset($l_ug_list);
-		}
-		unset($auth_submode);
-		unset($auth_setting);
-
-		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
-		break;
-
-	case 'delete':
-
-		$sql = &quot;SELECT auth_option_id
-			FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
-			WHERE auth_option LIKE '{$sql_option_mode}_%'&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$option_id_ary = array();
-			do
-			{
-				$option_id_ary[] = $row['auth_option_id'];
-			}
-			while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-			foreach ($ug_data as $id)
-			{
-				$auth_admin-&gt;acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
-			}
-			unset($option_id_ary);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-
-		// Do we need to recache the moderator lists? We do if the mode
-		// was mod or auth_settings['mod'] is a non-zero size array
-		if ($mode == 'mod' || (isset($auth_settings['mod']) &amp;&amp; sizeof($auth_settings['mod'])))
-		{
-			cache_moderators();
-		}
-
-		// Logging ... first grab user or groupnames ...
-		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$l_ug_list = '';
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-
-		// Grab the forum details if non-zero forum_id
-		if (!in_array(0, $forum_id[$which_mode]))
-		{
-			$sql = 'SELECT forum_name  
-				FROM ' . FORUMS_FORUMS_TABLE . &quot;
-				WHERE forum_id IN ($sql_forum_id)&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$l_forum_list = '';
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
-		}
-		else
-		{
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
-		}
-
-		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
-		break;
-
-	case 'presetsave':
-
-		$holding_ary = array();
-	
-		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
-
-		foreach ($auth_setting as $option =&gt; $setting)
-		{
-			switch ($setting)
-			{
-				case ACL_YES:
-					$holding_ary['yes'][] = $option;
-					break;
-
-				case ACL_NO:
-					$holding_ary['no'][] = $option;
-					break;
-
-				case ACL_UNSET:
-					$holding_ary['unset'][] = $option;
-					break;
-			}
-		}
-
-		$sql = array(
-			'preset_user_id'=&gt; intval($_CLASS['core_user']-&gt;data['user_id']),
-			'preset_type'	=&gt; $sql_option_mode,
-			'preset_data'	=&gt; serialize($holding_ary)
-		);
-
-		if (!empty($_POST['presetname']))
-		{	
-			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
-		}
-		
-		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
-		{
-			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
-			$_CLASS['core_db']-&gt;query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
-		}
-		unset($sql, $option, $setting, $auth_setting);
-
-		break;
-
-	case 'presetdel':
-
-		if (!empty($_POST['presetoption']))
-		{
-			$sql = &quot;SELECT preset_name 
-				FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$sql = &quot;DELETE FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
-			unset($row);
-		}
-		break;
-}
-// End update
-
-
-// Output page header
-adm_page_header($l_title);
-
-
-// First potential form ... this is for selecting forums, users
-// or groups. 
-if (in_array($mode, array('user', 'group', 'forum', 'mod')) &amp;&amp; empty($submit))
-{
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;?php
-
-	// Mode specific markup
-	switch ($mode)
-	{
-		case 'forum':
-		case 'mod':
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;f[&lt;?php echo $mode; ?&gt;][]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
-	
-			echo make_forum_select(false, false, false);
-			
-?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_usergroups&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;forum&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;usergroups&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-		
-			break;
-
-		case 'user':
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_USER']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&nbsp;&lt;textarea cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			break;
-
-		case 'group':
-			// Generate list of groups
-
-?&gt;
-	&lt;tr&gt;
-		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
-
-			$sql = &quot;SELECT group_id, group_name, group_type   
-				FROM &quot; . GROUPS_TABLE . &quot; 
-				ORDER BY group_type DESC&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$group_options = '';
-			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				do
-				{
-					echo '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-				}
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-			
-?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		break;
-
-	}
-
-?&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-// End user, group or forum selection
-
-
-// Second possible form, this lists the currently enabled
-// users/groups for the given mode
-if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') &amp;&amp; empty($submode) &amp;&amp; in_array($mode, array('admin', 'supermod'))))
-{
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
-
-&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_USERS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php
-			
-	$sql = &quot;SELECT u.user_id, u.username
-		FROM &quot; . USERS_TABLE . &quot; u, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
-		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
-			AND a.auth_option_id = o.auth_option_id
-			AND a.forum_id IN ($sql_forum_id)
-			AND u.user_id = a.user_id
-		ORDER BY u.username, u.user_reg_date ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$users = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-		&lt;td align=&quot;center&quot;&gt;&lt;form method=&quot;post&quot; name=&quot;admingroups&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-		&lt;tr&gt;
-			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_GROUPS']; ?&gt;&lt;/th&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php 
-	
-	$sql = &quot;SELECT DISTINCT g.group_id, g.group_name, g.group_type 
-		FROM &quot; . GROUPS_TABLE . &quot; g, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
-		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
-			AND a.forum_id IN ($sql_forum_id)
-			AND a.auth_option_id = o.auth_option_id
-			AND g.group_id = a.group_id
-		ORDER BY g.group_type DESC, g.group_name ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$groups = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-?&gt;&lt;/select&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-		&lt;tr&gt;
-			&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-		&lt;/tr&gt;
-	&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-	&lt;/tr&gt;
-	&lt;tr&gt;
-
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;textarea style=&quot;height:60px&quot; cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-
-		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_GROUPS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; style=&quot;height: 100%&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot;  size=&quot;5&quot;&gt;&lt;?php 
-			
-	$sql = &quot;SELECT group_id, group_name, group_type 
-		FROM &quot; . GROUPS_TABLE . &quot;
-		ORDER BY group_type DESC, group_name&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$group_list = '';
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;?php
-
-}
-// End user and group acl selections
-
-
-
-
-
-
-// Third possible form, this is the major section of this script. It
-// handles the entry of permission options for all situations
-if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
-{
-
-	// Did the user specify any users or groups?
-	if (empty($ug_data))
-	{
-		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
-		trigger_error($_CLASS['core_user']-&gt;lang[$l_message]);
-	}
-
-
-	$forum_list = '';
-	// Grab the forum details if non-zero forum_id
-	if (!in_array(0, $forum_id[$which_mode]))
-	{
-		$sql = 'SELECT forum_id, forum_name, parent_id  
-			FROM ' . FORUMS_FORUMS_TABLE . &quot;
-			WHERE forum_id IN ($sql_forum_id)&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
-		}
-
-		// If we have more than one forum we want a list of all their names
-		// so loop through all results. We don't need all the data though 
-		// since cascading/inheritance is only applicable if a single forum
-		// was selected
-		$forum_data = $row;
-
-		do
-		{
-			$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-
-	// Grab relevant user or group information
-	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
-// need some work ( array_mapping()) blaa blaa
-	switch ($ug_type)
-	{
-		case 'user':
-			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_USER'];
-			$sql = 'SELECT user_id AS id, username AS name 
-				FROM ' . USERS_TABLE . ' 
-				WHERE ';
-			$sql .= ($submit == 'add_options') ? &quot; username IN ('&quot; . implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array(array_unique(explode(&quot;\n&quot;, modify_lines($ug_data[0], &quot;\n&quot;))))) . &quot;')&quot; : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
-		break;
-
-		case 'group':
-			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_GROUP'];
-			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
-				FROM ' . GROUPS_TABLE . '
-				WHERE group_id';
-			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
-		break;
-	}
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		trigger_error($l_no_error);
-	}
-	unset($l_no_error);
-
-	// Store the user_ids and names for later use
-	do 
-	{
-		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;b class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] : '&lt;b&gt;' . $row['name']) . '&lt;/b&gt;';
-		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
-		$ug_hidden .= '&lt;input type=&quot;hidden&quot; name=&quot;ug_data[]&quot; value=&quot;' . $row['id'] . '&quot; /&gt;';
-	}
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	$_CLASS['core_db']-&gt;free_result($result);
-
-
-	// Grab the list of options ... if we're in deps mode we want all options, 
-	// else we skip the master options
-	$sql_limit_option = ($mode == 'deps') ? '' : &quot;AND auth_option &lt;&gt; '&quot; . $sql_option_mode . &quot;_'&quot;;
-	$sql = &quot;SELECT auth_option_id, auth_option
-		FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
-		WHERE auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-			$sql_limit_option&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$auth_options = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$auth_presets_compare[] = $row['auth_option'];
-		$auth_options[] = $row;
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	unset($sql_limit_option);
-
-
-	// Now we'll build a list of preset options ...
-	$preset_options = $preset_js = $preset_update_options = '';
-
-	// Do we have a parent forum? If so offer option to inherit from that
-	if ($forum_data['parent_id'] != 0)
-	{
-		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-		 
-		$sql = &quot;SELECT o.auth_option, a.auth_setting
-					FROM &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
-					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-						AND a.auth_option_id = o.auth_option_id AND a.forum_id = &quot; . $forum_data['parent_id'] . '
-						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)&quot;;
-
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			do
-			{
-				switch ($row['auth_setting'])
-				{
-					case ACL_YES:
-						$holding['yes'][] = $row['auth_option'];
-					break;
-
-					case ACL_NO:
-						$holding['no'][] = $row['auth_option'];
-					break;
-				}
-			}
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_options .= '&lt;option value=&quot;preset_0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['INHERIT_PARENT'] . '&lt;/option&gt;';
-			$preset_js .= &quot;\tpresets['preset_0'] = new Array();&quot; . &quot;\n&quot;;
-			$preset_js .= &quot;\tpresets['preset_0'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
-
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-	// Look for custom presets
-	$sql = &quot;SELECT preset_id, preset_name, preset_data  
-		FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
-		WHERE preset_type = '&quot; . (($mode == 'deps') ? 'f' : $sql_option_mode) . &quot;' 
-		ORDER BY preset_id ASC&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		do
-		{
-			$preset_update_options .= '&lt;option value=&quot;' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
-			$preset_options .= '&lt;option value=&quot;preset_' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
-
-			$holding = unserialize($row['preset_data']);
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new Array();&quot; . &quot;\n&quot;;
-			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
-		}
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	unset($holding, $auth_presets_compare);
-
-
-	// If we aren't looking @ deps then we try and grab existing sessions for
-	// the given forum and user/group
-	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
-	{
-		if ($which_mode == $mode)
-		{
-			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
-					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
-					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
-						AND a.auth_option_id = o.auth_option_id 
-						AND a.forum_id IN ($sql_forum_id) 
-						AND a.&quot;.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)
-					GROUP BY o.auth_option&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$auth_settings[$which_mode] = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
-		else
-		{
-			// We're looking at a view ... so we'll set all options to unset
-			// We could be a little more clever here but the &quot;safe side&quot; looks
-			// better right now
-			$auth_settings[$which_mode] = array();
-			foreach ($auth_options as $option)
-			{
-				$auth_settings[$which_mode][$option['auth_option']] = '*';
-			}
-			unset($option);
-		}
-	}
-
-	$view_options = '';
-	// Should we display a dropdown for views?
-	if (in_array($mode, array('admin', 'supermod', 'mod')))
-	{
-		$view_options .= '&lt;option value=&quot;&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SELECT_VIEW'] . '&lt;/option&gt;';
-		$view_ary = array(
-			'admin'		=&gt; array('admin' =&gt; 'a_', 'forum' =&gt; 'a_auth', 'supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods'),
-			'supermod'	=&gt; array('supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth'), 
-			'mod'		=&gt; array('mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth')
-		);
-
-		foreach ($view_ary[$mode] as $which_submode =&gt; $which_acl)
-		{
-			if ($_CLASS['auth']-&gt;acl_get($which_acl))
-			{
-				$view_options .= '&lt;option value=&quot;' . $which_submode . '&quot;' . (($which_submode == $which_mode) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ACL_VIEW_' . strtoupper($which_submode)] . '&lt;/option&gt;';
-			}
-
-		}
-		unset($view_ary);
-	}
-
-	$settings_hidden = '';
-	// Output original settings ... needed when we jump views
-	foreach ($auth_settings as $auth_submode =&gt; $auth_submode_settings)
-	{
-		if ($auth_submode != $which_mode)
-		{
-			foreach ($auth_submode_settings as $submode_option =&gt; $submode_setting)
-			{
-				$settings_hidden .= ($submode_setting != '*') ? '&lt;input type=&quot;hidden&quot; name=&quot;settings[' . $auth_submode . '][' . $submode_option . ']&quot; value=&quot;' . $submode_setting . '&quot; /&gt;' : '';
-			}
-		}
-	}
-	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
-
-?&gt;
-
-&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
-&lt;!--
-
-	var presets = new Array();
-&lt;?php
-
-	echo $preset_js;
-
-?&gt;
-
-	function preset_obj(yes, no, unset)
-	{
-		this.yes = yes;
-		this.no = no;
-		this.unset = unset;
-	}
-
-	function use_preset(option)
-	{
-		if (option)
-		{
-			document.acl.set.selectedIndex = 0;
-			for (i = 0; i &lt; document.acl.length; i++)
-			{
-				var elem = document.acl.elements[i];
-				if (elem.name.indexOf('settings') == 0)
-				{
-					switch (option)
-					{
-						case 'all_yes':
-							if (elem.value == &lt;?php echo ACL_YES; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_no':
-							if (elem.value == &lt;?php echo ACL_NO; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_unset':
-							if (elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
-								elem.checked = true;
-							break;
-
-						case 'all_ignore':
-							if (elem.value == '*')
-								elem.checked = true;
-							break;
-
-						default:
-							option_start = elem.name.search(/\[(\w+?)\]$/);
-							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
-
-							if (presets[option].yes.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_YES; ?&gt;)
-								elem.checked = true;
-							else if (presets[option].no.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_NO; ?&gt;)
-								elem.checked = true;
-							else if (presets[option].unset.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
-								elem.checked = true;
-							break;
-					}
-				}
-			}
-		}
-	}
-
-	function marklist(match, status)
-	{
-		for (i = 0; i &lt; document.acl.length; i++)
-		{
-			if (document.acl.elements[i].name.indexOf(match) == 0)
-				document.acl.elements[i].checked = status;
-		}
-	}
-
-	function open_win(url, width, height)
-	{
-		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
-		if (window.focus)
-			aclwin.focus();
-	}
-//--&gt;
-&lt;/script&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
-
-&lt;?php
-
-	// Do we have a list of forums? If so, output them ... but only
-	// if we're looking at the primary view or mode ... submodes
-	// output their own list of forums as and where applicable so this
-	// is unnecessary
-	if ($forum_list != '' &amp;&amp; $which_mode == $mode)
-	{
-		$l_selected_forums = (sizeof($forum_id[$which_mode]) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
-
-		echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_forums] . ': ' . $forum_list . '&lt;/p&gt;';
-
-		unset($forum_list);
-		unset($l_selected_forums);
-	}
-
-	// Now output the list of users or groups ... these will always exist
-	$l_selected_users = ($ug_type == 'user') ? ((sizeof($ug_data) == 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((sizeof($ug_data) == 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
-
-	echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_users] . ': ' . $l_ug_list . '&lt;/p&gt;';
-
-	unset($l_selected_users);
-	unset($ug_data);
-
-?&gt;
-
-&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	if ($settings_hidden != '')
-	{
-
-?&gt;
-
-&lt;h2 style=&quot;color:red&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING']; ?&gt;&lt;/h2&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;?php
-
-	}
-
-?&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;acl&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-&lt;?php
-
-	// This is the main listing of options
-
-	// We output this for both deps and when update is requested where
-	// deps exist
-	if (($mode == 'admin' || $mode == 'supermod') &amp;&amp; in_array($submode, array('forum', 'mod')))
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WILL_SET_OPTIONS']; ?&gt;:&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row2&quot;&gt;&lt;select style=&quot;width:100%&quot; name=&quot;f[&lt;?php echo $which_mode; ?&gt;][]&quot; multiple=&quot;7&quot;&gt;&lt;?php 
-		
-		echo make_forum_select($forum_id[$which_mode], false, true); 
-		
-?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;br /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-	// End deps output
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;left&quot;&gt;&lt;?php
-	
-	if ($view_options != '')
-	{
-	
-?&gt;&lt;select name=&quot;submode&quot; onchange=&quot;if (this.options[this.selectedIndex].value != '') this.form.submit();&quot;&gt;&lt;?php echo $view_options; ?&gt;&lt;/select&gt;&lt;?php
-	
-	}
-	
-?&gt;&lt;/td&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;: &lt;select name=&quot;set&quot; onchange=&quot;use_preset(this.options[this.selectedIndex].value);&quot;&gt;&lt;option class=&quot;sep&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_yes&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_YES']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_no&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_NO']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_unset&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_UNSET']; ?&gt;&lt;/option&gt;&lt;?php 
-
-	$colspan = 4;
-	if ($which_mode != $mode)
-	{
-		$colspan = 5;
-		echo '&lt;option value=&quot;all_ignore&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_IGNORE'] . '&lt;/option&gt;';
-	}
-
-	// Output user preset options ... if any
-	echo ($preset_options) ? '&lt;option class=&quot;sep&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_PRESETS'] . ' -&gt;' . '&lt;/option&gt;' . $preset_options : ''; 
-
-?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTION']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNSET']; ?&gt;&nbsp;&lt;/th&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&nbsp;&lt;/th&gt;
-&lt;?php
-
-	if ($which_mode != $mode)
-	{
-
-?&gt;
-				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['IGNORE']; ?&gt;&nbsp;&lt;/th&gt;
-&lt;?php
-
-	}
-
-?&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-	$row_class = 'row2';
-	for ($i = 0; $i &lt; sizeof($auth_options); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-		// Try and output correct language strings, else output prettyfied auth_option
-		$l_auth_option = (!empty($_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
-		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
-
-		
-		// Which option should we select?
-		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked=&quot;checked&quot;' : '';
-		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked=&quot;checked&quot;' : '';
-		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked=&quot;checked&quot;' : '';
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $l_auth_option; ?&gt;&nbsp;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_YES; ?&gt;&quot;&lt;?php echo $selected_yes; ?&gt; /&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_UNSET; ?&gt;&quot;&lt;?php echo $selected_unset; ?&gt; /&gt;&lt;/td&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_NO; ?&gt;&quot;&lt;?php echo $selected_no; ?&gt; /&gt;&lt;/td&gt;
-&lt;?php
-
-		if ($which_mode != $mode)
-		{
-			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked=&quot;checked&quot;' : '';
-
-?&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;*&quot;&lt;?php echo $selected_ignore; ?&gt; /&gt;&lt;/td&gt;
-&lt;?php
-
-		}
-
-?&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-	}
-
-
-	// If we're setting forum or moderator options and a single forum has
-	// been selected then look to see if any subforums exist. If they do
-	// give user the option of cascading permissions to them
-	if (($mode == 'forum' || $mode == 'mod') &amp;&amp; empty($submode) &amp;&amp; sizeof($forum_id[$which_mode]) == 1)
-	{
-		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
-
-		if (!empty($children))
-		{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td class=&quot;gensmall&quot; colspan=&quot;4&quot; height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS_EXPLAIN']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			foreach ($children as $row)
-			{
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;inherit[]&quot; value=&quot;&lt;?php echo $row['forum_id']; ?&gt;&quot; /&gt; &lt;?php echo $row['forum_name']; ?&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-					&lt;tr&gt;
-						&lt;td height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;gensmall&quot; href=&quot;javascript:marklist('inherit', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('inherit', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-		}
-	}
-
-	// Display event/cron radio buttons
-	if ($_CLASS['auth']-&gt;acl_gets('a_events', 'a_cron') &amp;&amp; $mode != 'deps' &amp;&amp; $submit != 'update')
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?&gt;
-			&lt;!-- tr&gt;
-				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_HOW']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;now&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_AS_NOW']; ?&gt;&lt;?php 
-	
-			if ($_CLASS['auth']-&gt;acl_get('a_events'))
-			{ 
-
-?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;evt&quot; /&gt; &lt;?php 
-	
-				echo $_CLASS['core_user']-&gt;lang['RUN_AS_EVT'];  
-			}
-			
-			if ($_CLASS['auth']-&gt;acl_get('a_cron'))
-			{
-
-?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;crn&quot; /&gt; &lt;?php 
-	
-				echo $_CLASS['core_user']-&gt;lang['RUN_AS_CRN']; 
-				
-			}
-
-?&gt;&lt;/td&gt;
-			&lt;/tr --&gt;
-&lt;?php
-
-	}
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit_update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPDATE']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CANCEL']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;&lt;?php echo $ug_type; ?&gt;&quot; /&gt;&lt;?php echo $ug_hidden; ?&gt;&lt;?php 
-
-	// Output forum id data
-	echo $s_forum_id;
-
-	// Output settings generated from other views
-	echo $settings_hidden;
-	unset($settings_hidden);
-	
-?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;
-
-		&lt;br clear=&quot;all&quot; /&gt;
-
-		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-			&lt;tr&gt;
-				&lt;th colspan=&quot;4&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;&lt;/th&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;row1&quot; colspan=&quot;4&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-					&lt;tr&gt;
-						&lt;td colspan=&quot;2&quot; height=&quot;16&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_PRESET']; ?&gt;: &lt;/td&gt;
-						&lt;td&gt;&lt;select name=&quot;presetoption&quot;&gt;&lt;option class=&quot;sep&quot; value=&quot;-1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;?php 
-
-	echo $preset_update_options;
-			
-		?&gt;&lt;/select&gt;&lt;/td&gt;
-					&lt;/tr&gt;
-					&lt;tr&gt;
-						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESET_NAME']; ?&gt;: &lt;/td&gt;
-						&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;presetname&quot; maxlength=&quot;25&quot; /&gt; &lt;/td&gt;
-					&lt;/tr&gt;
-				&lt;/table&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td class=&quot;cat&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetsave&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SAVE']; ?&gt;&quot; /&gt; &nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetdel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;?php
-
-}
-
-// Output page footer
-adm_page_footer();
-
-// ---------
-// FUNCTIONS
-//
-function update_foes()
-{
-	global $_CLASS;
-
-	$perms = array();
-	foreach ($_CLASS['auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
-	{
-		foreach ($forum_ary as $auth_option =&gt; $user_ary)
-		{
-			$perms += $user_ary;
-		}
-	}
-
-	if (sizeof($perms))
-	{
-		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	unset($perms);
-}
-//
-// FUNCTIONS
-// ---------
-
+&lt;?php
+// -------------------------------------------------------------
+//
+// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
+//
+// FILENAME  : admin_permissions.php
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : &#169; 2001, 2003 phpBB Group
+// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// values need checks
+
+
+// Grab and set some basic parameters
+//
+// 'mode' determines what we're altering; administrators, users, deps, etc.
+// 'submit' is used to determine what we're doing ... special format
+$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
+
+// What mode are we running? So we can output the correct title, explanation
+// and set the sql_option_mode/acl check
+switch ($mode)
+{
+	case 'forum':
+		$l_title = $_CLASS['core_user']-&gt;lang['PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_auth';
+		$sql_option_mode = 'f';
+		break;
+
+	case 'mod':
+		$l_title = $_CLASS['core_user']-&gt;lang['MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'supermod':
+		$l_title = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'admin':
+		$l_title = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['ADMINISTRATORS_EXPLAIN'];
+		$which_acl = 'a_authadmins';
+		$sql_option_mode = 'a';
+		break;
+
+	case 'user':
+		$l_title = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['USER_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authusers';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'group':
+		$l_title = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['GROUP_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authgroups';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'deps':
+		$l_title = $_CLASS['core_user']-&gt;lang['DEPENDENCIES'];
+		$l_title_explain = $_CLASS['core_user']-&gt;lang['DEPENDENCIES_EXPLAIN'];
+		$which_acl = 'a_authdeps';
+		break;
+}
+
+// Permission check
+if (!$_CLASS['auth']-&gt;acl_get($which_acl))
+{
+	trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+}
+
+$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
+$which_mode = (!empty($submode) &amp;&amp; $submode != $mode) ? $submode : $mode;
+$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
+$submit		= (count($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
+
+// Submitted setting data
+//
+// 'auth_settings' contains the submitted option settings assigned to options, should be an 
+//   associative array with integer values
+$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
+
+
+// Forum, User or Group information
+//
+// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
+// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
+// 'forum_id' contains the list of forums, 0 is used for &quot;All forums&quot;, can be array or scalar
+$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
+$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
+
+if (isset($_REQUEST['f']))
+{
+	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
+}
+
+if (!isset($forum_id[$which_mode]))
+{
+	$forum_id[$which_mode][] = 0;
+}
+
+$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
+
+// Generate list of forum id's
+$s_forum_id = '';
+
+foreach ($forum_id as $forum_submode =&gt; $forum_submode_ids)
+{
+	foreach ($forum_submode_ids as $submode_forum_id)
+	{
+		$s_forum_id .= '&lt;input type=&quot;hidden&quot; name=&quot;f[' . $forum_submode . '][]&quot; value=&quot;' . $submode_forum_id . '&quot; /&gt;';
+	}
+}
+unset($forum_submode_ids);
+unset($forum_submode);
+unset($submode_forum_id);
+
+
+// Instantiate a new auth admin object in readiness
+$auth_admin = new auth_admin();
+
+// Are we setting deps? If we are we need to re-run the mode match above for the
+// relevant 'new' mode
+if (!empty($submode))
+{
+	switch ($submode)
+	{
+		case 'forum':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['PERMISSIONS_EXPLAIN'];
+			$which_acl = 'a_auth';
+			$sql_option_mode = 'f';
+			break;
+
+		case 'mod':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+
+		case 'supermod':
+			$l_title_explain = $_CLASS['core_user']-&gt;lang['SUPER_MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+	}
+
+	// Permission check
+	if (!$_CLASS['auth']-&gt;acl_get($which_acl))
+	{
+		trigger_error($_CLASS['core_user']-&gt;lang['NO_ADMIN']);
+	}
+}
+
+
+// Does user want to update anything? Check here to find out 
+// and act appropriately
+switch ($submit)
+{
+	case 'update':
+		if (!empty($auth_settings))
+		{
+			// Admin wants subforums to inherit permissions ... so add these
+			// forums to the list ... since inheritance is only available for
+			// forum and moderator primary modes we deal with '$forum_id[$mode]'
+			if (!empty($_POST['inherit']))
+			{
+				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
+			}
+
+			// Update the permission set ... we loop through each auth setting array
+			foreach ($auth_settings as $auth_submode =&gt; $auth_setting)
+			{
+				// Are any entries * ? If so we need to remove them since they
+				// are options the user wishes to ignore
+
+				if (in_array('*', $auth_setting))
+				{
+					foreach ($auth_setting as $option =&gt; $setting)
+					{
+						if ($setting == '*')
+						{
+							unset($auth_setting[$option]);
+						}
+					}
+				}
+
+				if (!empty($auth_setting))
+				{
+					// Loop through all user/group ids
+					foreach ($ug_data as $id)
+					{
+						$auth_admin-&gt;acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
+					}
+				}
+			}
+
+			// Do we need to recache the moderator lists? We do if the mode
+			// was mod or auth_settings['mod'] is a non-zero size array
+			if ($mode == 'mod' || !empty($auth_settings['mod']))
+			{
+				cache_moderators();
+			}
+
+			// Remove users who are now moderators or admins from everyones foes
+			// list
+			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
+			{
+				update_foes();
+			}
+
+			// Logging ... first grab user or groupnames ...
+			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$l_ug_list = '';
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$auth_submode = array_keys($auth_settings);
+			foreach ($auth_submode as $sub_mode)
+			{
+				if (!in_array(0, $forum_id[$sub_mode]))
+				{
+					// Grab the forum details if non-zero forum_id
+					$sql = 'SELECT forum_name  
+						FROM ' . FORUMS_FORUMS_TABLE . &quot;
+						WHERE forum_id IN ($sql_forum_id)&quot;;
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$l_forum_list = '';
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
+				}
+				else
+				{
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
+				}
+			}
+			unset($l_ug_list);
+		}
+		unset($auth_submode);
+		unset($auth_setting);
+
+		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
+	break;
+
+	case 'delete':
+		$sql = &quot;SELECT auth_option_id
+			FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
+			WHERE auth_option LIKE '{$sql_option_mode}_%'&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$option_id_ary = array();
+			do
+			{
+				$option_id_ary[] = $row['auth_option_id'];
+			}
+			while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+			foreach ($ug_data as $id)
+			{
+				$auth_admin-&gt;acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
+			}
+			unset($option_id_ary);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+
+		// Do we need to recache the moderator lists? We do if the mode
+		// was mod or auth_settings['mod'] is a non-zero size array
+		if ($mode == 'mod' || (isset($auth_settings['mod']) &amp;&amp; !empty($auth_settings['mod'])))
+		{
+			cache_moderators();
+		}
+
+		// Logging ... first grab user or groupnames ...
+		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$l_ug_list = '';
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;span class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] . '&lt;/span&gt;' : $row['name']);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+
+		// Grab the forum details if non-zero forum_id
+		if (!in_array(0, $forum_id[$which_mode]))
+		{
+			$sql = 'SELECT forum_name  
+				FROM ' . FORUMS_FORUMS_TABLE . &quot;
+				WHERE forum_id IN ($sql_forum_id)&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$l_forum_list = '';
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
+		}
+		else
+		{
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
+		}
+
+		trigger_error($_CLASS['core_user']-&gt;lang['AUTH_UPDATED']);
+	break;
+
+	case 'presetsave':
+		$holding_ary = array();
+	
+		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
+
+		foreach ($auth_setting as $option =&gt; $setting)
+		{
+			switch ($setting)
+			{
+				case ACL_YES:
+					$holding_ary['yes'][] = $option;
+				break;
+
+				case ACL_NO:
+					$holding_ary['no'][] = $option;
+				break;
+
+				case ACL_UNSET:
+					$holding_ary['unset'][] = $option;
+				break;
+			}
+		}
+
+		$sql = array(
+			'preset_user_id'=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+			'preset_type'	=&gt; $sql_option_mode,
+			'preset_data'	=&gt; serialize($holding_ary)
+		);
+
+		if (!empty($_POST['presetname']))
+		{	
+			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
+		}
+		
+		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
+		{
+			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . (int) $_POST['presetoption'];
+			$_CLASS['core_db']-&gt;query($sql);
+
+			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
+		}
+		unset($sql, $option, $setting, $auth_setting);
+	break;
+
+	case 'presetdel':
+		if (!empty($_POST['presetoption']))
+		{
+			$sql = &quot;SELECT preset_name 
+				FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+				WHERE preset_id = &quot; . (int) $_POST['presetoption'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($row)
+			{
+				$sql = &quot;DELETE FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+					WHERE preset_id = &quot; . (int) $_POST['presetoption'];
+				$_CLASS['core_db']-&gt;query($sql);
+	
+				add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
+			}
+			unset($row);
+		}
+	break;
+}
+// End update
+
+
+// Output page header
+adm_page_header($l_title);
+
+
+// First potential form ... this is for selecting forums, users
+// or groups. 
+if (in_array($mode, array('user', 'group', 'forum', 'mod')) &amp;&amp; empty($submit))
+{
+
+?&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain ?&gt;&lt;/p&gt;
+
+&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+&lt;?php
+
+	// Mode specific markup
+	switch ($mode)
+	{
+		case 'forum':
+		case 'mod':
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;f[&lt;?php echo $mode; ?&gt;][]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
+	
+			echo make_forum_select(false, false, false);
+			
+?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_usergroups&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_FORUM']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;forum&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;usergroups&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+		
+			break;
+
+		case 'user':
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_USER']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&nbsp;&lt;textarea cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+			break;
+
+		case 'group':
+			// Generate list of groups
+
+?&gt;
+	&lt;tr&gt;
+		&lt;th align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;row1&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&nbsp;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;true&quot; size=&quot;7&quot;&gt;&lt;?php 
+
+			$sql = &quot;SELECT group_id, group_name, group_type   
+				FROM &quot; . GROUPS_TABLE . &quot; 
+				ORDER BY group_type DESC&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$group_options = '';
+			if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				do
+				{
+					echo '&lt;option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+				}
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+			
+?&gt;&lt;/select&gt;&nbsp;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['LOOK_UP_GROUP']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+		break;
+
+	}
+
+?&gt;
+&lt;/table&gt;&lt;/form&gt;
+
+&lt;?php
+
+}
+// End user, group or forum selection
+
+
+// Second possible form, this lists the currently enabled
+// users/groups for the given mode
+if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') &amp;&amp; empty($submode) &amp;&amp; in_array($mode, array('admin', 'supermod'))))
+{
+
+?&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
+
+&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+	&lt;tr&gt;
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_USERS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php
+			
+	$sql = &quot;SELECT u.user_id, u.username
+		FROM &quot; . USERS_TABLE . &quot; u, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
+		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
+			AND a.auth_option_id = o.auth_option_id
+			AND a.forum_id IN ($sql_forum_id)
+			AND u.user_id = a.user_id
+		ORDER BY u.username, u.user_reg_date ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$users = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option value=&quot;' . $row['user_id'] . '&quot;&gt;' . $row['username'] . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+		&lt;td align=&quot;center&quot;&gt;&lt;form method=&quot;post&quot; name=&quot;admingroups&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+		&lt;tr&gt;
+			&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE_GROUPS']; ?&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot; size=&quot;5&quot;&gt;&lt;?php 
+	
+	$sql = &quot;SELECT DISTINCT g.group_id, g.group_name, g.group_type 
+		FROM &quot; . GROUPS_TABLE . &quot; g, &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o
+		WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%'
+			AND a.forum_id IN ($sql_forum_id)
+			AND a.auth_option_id = o.auth_option_id
+			AND g.group_id = a.group_id
+		ORDER BY g.group_type DESC, g.group_name ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$groups = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+?&gt;&lt;/select&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_delete&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt; &nbsp; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_edit_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SET_OPTIONS']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+	&lt;/tr&gt;
+	&lt;tr&gt;
+
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_USERS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;textarea style=&quot;height:60px&quot; cols=&quot;40&quot; rows=&quot;4&quot; name=&quot;ug_data[]&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&nbsp; &lt;input type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['FIND_USERNAME']; ?&gt;&quot; class=&quot;btnlite&quot; onclick=&quot;window.open('&lt;?php echo generate_link('Members_List&amp;mode=searchuser&amp;form=2&amp;field=entries'); ?&gt;', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;user&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+
+		&lt;td&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ADD_GROUPS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; style=&quot;height: 100%&quot; align=&quot;center&quot;&gt;&lt;select style=&quot;width:280px&quot; name=&quot;ug_data[]&quot; multiple=&quot;multiple&quot;  size=&quot;5&quot;&gt;&lt;?php 
+			
+	$sql = &quot;SELECT group_id, group_name, group_type 
+		FROM &quot; . GROUPS_TABLE . &quot;
+		ORDER BY group_type DESC, group_name&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$group_list = '';
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		echo '&lt;option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style=&quot;color: #006699;&quot;' : '') . ' value=&quot;' . $row['group_id'] . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/option&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; align=&quot;center&quot;&gt; &lt;input type=&quot;submit&quot; name=&quot;submit_add_options&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &lt;input type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; class=&quot;btnlite&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;group&quot; /&gt;&lt;?php echo $s_forum_id; ?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/form&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;?php
+
+}
+// End user and group acl selections
+
+
+
+
+
+
+// Third possible form, this is the major section of this script. It
+// handles the entry of permission options for all situations
+if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
+{
+
+	// Did the user specify any users or groups?
+	if (empty($ug_data))
+	{
+		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
+		trigger_error($_CLASS['core_user']-&gt;lang[$l_message]);
+	}
+
+
+	$forum_list = '';
+	// Grab the forum details if non-zero forum_id
+	if (!in_array(0, $forum_id[$which_mode]))
+	{
+		$sql = 'SELECT forum_id, forum_name, parent_id  
+			FROM ' . FORUMS_FORUMS_TABLE . &quot;
+			WHERE forum_id IN ($sql_forum_id)&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
+		}
+
+		// If we have more than one forum we want a list of all their names
+		// so loop through all results. We don't need all the data though 
+		// since cascading/inheritance is only applicable if a single forum
+		// was selected
+		$forum_data = $row;
+
+		do
+		{
+			$forum_list .= (($forum_list != '') ? ', ' : '') . '&lt;b&gt;' . $row['forum_name'] . '&lt;/b&gt;';
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+
+	// Grab relevant user or group information
+	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
+// need some work ( array_mapping()) blaa blaa
+	switch ($ug_type)
+	{
+		case 'user':
+			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_USER'];
+			$sql = 'SELECT user_id AS id, username AS name 
+				FROM ' . USERS_TABLE . ' 
+				WHERE ';
+			$sql .= ($submit == 'add_options') ? &quot; username IN ('&quot; . implode(&quot;', '&quot;, $_CLASS['core_db']-&gt;escape_array(array_unique(explode(&quot;\n&quot;, modify_lines($ug_data[0], &quot;\n&quot;))))) . &quot;')&quot; : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
+		break;
+
+		case 'group':
+			$l_no_error = $_CLASS['core_user']-&gt;lang['NO_GROUP'];
+			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
+				FROM ' . GROUPS_TABLE . '
+				WHERE group_id';
+			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
+		break;
+	}
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		trigger_error($l_no_error);
+	}
+	unset($l_no_error);
+
+	// Store the user_ids and names for later use
+	do 
+	{
+		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) &amp;&amp; $row['group_type'] == GROUP_SPECIAL) ? '&lt;b class=&quot;blue&quot;&gt;' . $_CLASS['core_user']-&gt;lang['G_' . $row['name']] : '&lt;b&gt;' . $row['name']) . '&lt;/b&gt;';
+		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
+		$ug_hidden .= '&lt;input type=&quot;hidden&quot; name=&quot;ug_data[]&quot; value=&quot;' . $row['id'] . '&quot; /&gt;';
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+	$_CLASS['core_db']-&gt;free_result($result);
+
+
+	// Grab the list of options ... if we're in deps mode we want all options, 
+	// else we skip the master options
+	$sql_limit_option = ($mode == 'deps') ? '' : &quot;AND auth_option &lt;&gt; '&quot; . $sql_option_mode . &quot;_'&quot;;
+	$sql = &quot;SELECT auth_option_id, auth_option
+		FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
+		WHERE auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+			$sql_limit_option&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$auth_options = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$auth_presets_compare[] = $row['auth_option'];
+		$auth_options[] = $row;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	unset($sql_limit_option);
+
+
+	// Now we'll build a list of preset options ...
+	$preset_options = $preset_js = $preset_update_options = '';
+
+	// Do we have a parent forum? If so offer option to inherit from that
+	if ($forum_data['parent_id'] != 0)
+	{
+		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+		 
+		$sql = &quot;SELECT o.auth_option, a.auth_setting
+					FROM &quot; . FORUMS_ACL_TABLE . &quot; a, &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
+					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+						AND a.auth_option_id = o.auth_option_id AND a.forum_id = &quot; . $forum_data['parent_id'] . '
+						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)&quot;;
+
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			do
+			{
+				switch ($row['auth_setting'])
+				{
+					case ACL_YES:
+						$holding['yes'][] = $row['auth_option'];
+					break;
+
+					case ACL_NO:
+						$holding['no'][] = $row['auth_option'];
+					break;
+				}
+			}
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_options .= '&lt;option value=&quot;preset_0&quot;&gt;' . $_CLASS['core_user']-&gt;lang['INHERIT_PARENT'] . '&lt;/option&gt;';
+			$preset_js .= &quot;\tpresets['preset_0'] = new Array();&quot; . &quot;\n&quot;;
+			$preset_js .= &quot;\tpresets['preset_0'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
+
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+	// Look for custom presets
+	$sql = &quot;SELECT preset_id, preset_name, preset_data  
+		FROM &quot; . FORUMS_ACL_PRESETS_TABLE . &quot; 
+		WHERE preset_type = '&quot; . (($mode == 'deps') ? 'f' : $sql_option_mode) . &quot;' 
+		ORDER BY preset_id ASC&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		do
+		{
+			$preset_update_options .= '&lt;option value=&quot;' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
+			$preset_options .= '&lt;option value=&quot;preset_' . $row['preset_id'] . '&quot;&gt;' . $row['preset_name'] . '&lt;/option&gt;';
+
+			$holding = unserialize($row['preset_data']);
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new Array();&quot; . &quot;\n&quot;;
+			$preset_js .= &quot;\tpresets['preset_&quot; . $row['preset_id'] . &quot;'] = new preset_obj('&quot; . implode(', ', $holding['yes']) . &quot;', '&quot; . implode(', ', $holding['no']) . &quot;', '&quot; . implode(', ', $holding['unset']) . &quot;');\n&quot;;
+		}
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	unset($holding, $auth_presets_compare);
+
+
+	// If we aren't looking @ deps then we try and grab existing sessions for
+	// the given forum and user/group
+	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
+	{
+		if ($which_mode == $mode)
+		{
+			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
+					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . &quot; o 
+					WHERE o.auth_option LIKE '&quot; . $sql_option_mode . &quot;_%' 
+						AND a.auth_option_id = o.auth_option_id 
+						AND a.forum_id IN ($sql_forum_id) 
+						AND a.&quot;.(($ug_type == 'group') ? 'group_id' : 'user_id').&quot; IN ($ug_ids)
+					GROUP BY o.auth_option&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$auth_settings[$which_mode] = array();
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+		else
+		{
+			// We're looking at a view ... so we'll set all options to unset
+			// We could be a little more clever here but the &quot;safe side&quot; looks
+			// better right now
+			$auth_settings[$which_mode] = array();
+			foreach ($auth_options as $option)
+			{
+				$auth_settings[$which_mode][$option['auth_option']] = '*';
+			}
+			unset($option);
+		}
+	}
+
+	$view_options = '';
+	// Should we display a dropdown for views?
+	if (in_array($mode, array('admin', 'supermod', 'mod')))
+	{
+		$view_options .= '&lt;option value=&quot;&quot;&gt;' . $_CLASS['core_user']-&gt;lang['SELECT_VIEW'] . '&lt;/option&gt;';
+		$view_ary = array(
+			'admin'		=&gt; array('admin' =&gt; 'a_', 'forum' =&gt; 'a_auth', 'supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods'),
+			'supermod'	=&gt; array('supermod' =&gt; 'a_authmods', 'mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth'), 
+			'mod'		=&gt; array('mod' =&gt; 'a_authmods', 'forum' =&gt; 'a_auth')
+		);
+
+		foreach ($view_ary[$mode] as $which_submode =&gt; $which_acl)
+		{
+			if ($_CLASS['auth']-&gt;acl_get($which_acl))
+			{
+				$view_options .= '&lt;option value=&quot;' . $which_submode . '&quot;' . (($which_submode == $which_mode) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['ACL_VIEW_' . strtoupper($which_submode)] . '&lt;/option&gt;';
+			}
+
+		}
+		unset($view_ary);
+	}
+
+	$settings_hidden = '';
+	// Output original settings ... needed when we jump views
+	foreach ($auth_settings as $auth_submode =&gt; $auth_submode_settings)
+	{
+		if ($auth_submode != $which_mode)
+		{
+			foreach ($auth_submode_settings as $submode_option =&gt; $submode_setting)
+			{
+				$settings_hidden .= ($submode_setting != '*') ? '&lt;input type=&quot;hidden&quot; name=&quot;settings[' . $auth_submode . '][' . $submode_option . ']&quot; value=&quot;' . $submode_setting . '&quot; /&gt;' : '';
+			}
+		}
+	}
+	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
+
+?&gt;
+
+&lt;script language=&quot;Javascript&quot; type=&quot;text/javascript&quot;&gt;
+&lt;!--
+
+	var presets = new Array();
+&lt;?php
+
+	echo $preset_js;
+
+?&gt;
+
+	function preset_obj(yes, no, unset)
+	{
+		this.yes = yes;
+		this.no = no;
+		this.unset = unset;
+	}
+
+	function use_preset(option)
+	{
+		if (option)
+		{
+			document.acl.set.selectedIndex = 0;
+			for (i = 0; i &lt; document.acl.length; i++)
+			{
+				var elem = document.acl.elements[i];
+				if (elem.name.indexOf('settings') == 0)
+				{
+					switch (option)
+					{
+						case 'all_yes':
+							if (elem.value == &lt;?php echo ACL_YES; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_no':
+							if (elem.value == &lt;?php echo ACL_NO; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_unset':
+							if (elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
+								elem.checked = true;
+							break;
+
+						case 'all_ignore':
+							if (elem.value == '*')
+								elem.checked = true;
+							break;
+
+						default:
+							option_start = elem.name.search(/\[(\w+?)\]$/);
+							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
+
+							if (presets[option].yes.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_YES; ?&gt;)
+								elem.checked = true;
+							else if (presets[option].no.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_NO; ?&gt;)
+								elem.checked = true;
+							else if (presets[option].unset.indexOf(option_name + ',') != -1 &amp;&amp; elem.value == &lt;?php echo ACL_UNSET; ?&gt;)
+								elem.checked = true;
+							break;
+					}
+				}
+			}
+		}
+	}
+
+	function marklist(match, status)
+	{
+		for (i = 0; i &lt; document.acl.length; i++)
+		{
+			if (document.acl.elements[i].name.indexOf(match) == 0)
+				document.acl.elements[i].checked = status;
+		}
+	}
+
+	function open_win(url, width, height)
+	{
+		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
+		if (window.focus)
+			aclwin.focus();
+	}
+//--&gt;
+&lt;/script&gt;
+
+&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_EXPLAIN']; ?&gt;&lt;/p&gt;
+
+&lt;h1&gt;&lt;?php echo $l_title; ?&gt;&lt;/h1&gt;
+
+&lt;?php
+
+	// Do we have a list of forums? If so, output them ... but only
+	// if we're looking at the primary view or mode ... submodes
+	// output their own list of forums as and where applicable so this
+	// is unnecessary
+	if ($forum_list != '' &amp;&amp; $which_mode == $mode)
+	{
+		$l_selected_forums = (count($forum_id[$which_mode]) === 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
+
+		echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_forums] . ': ' . $forum_list . '&lt;/p&gt;';
+
+		unset($forum_list);
+		unset($l_selected_forums);
+	}
+
+	// Now output the list of users or groups ... these will always exist
+	$l_selected_users = ($ug_type == 'user') ? ((count($ug_data) === 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((count($ug_data) === 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
+
+	echo '&lt;p&gt;' . $_CLASS['core_user']-&gt;lang[$l_selected_users] . ': ' . $l_ug_list . '&lt;/p&gt;';
+
+	unset($l_selected_users);
+	unset($ug_data);
+
+?&gt;
+
+&lt;p&gt;&lt;?php echo $l_title_explain; ?&gt;&lt;/p&gt;
+
+&lt;?php
+
+	if ($settings_hidden != '')
+	{
+
+?&gt;
+
+&lt;h2 style=&quot;color:red&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING']; ?&gt;&lt;/h2&gt;
+
+&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WARNING_EXPLAIN']; ?&gt;&lt;/p&gt;
+
+&lt;?php
+
+	}
+
+?&gt;
+
+&lt;form method=&quot;post&quot; name=&quot;acl&quot; action=&quot;&lt;?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+&lt;?php
+
+	// This is the main listing of options
+
+	// We output this for both deps and when update is requested where
+	// deps exist
+	if (($mode == 'admin' || $mode == 'supermod') &amp;&amp; in_array($submode, array('forum', 'mod')))
+	{
+
+?&gt;
+	&lt;tr&gt;
+		&lt;td colspan=&quot;2&quot; align=&quot;right&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['WILL_SET_OPTIONS']; ?&gt;:&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row2&quot;&gt;&lt;select style=&quot;width:100%&quot; name=&quot;f[&lt;?php echo $which_mode; ?&gt;][]&quot; multiple=&quot;7&quot;&gt;&lt;?php 
+		
+		echo make_forum_select($forum_id[$which_mode], false, true); 
+		
+?&gt;&lt;/select&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;br /&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;?php
+
+	}
+	// End deps output
+
+?&gt;
+	&lt;tr&gt;
+		&lt;td align=&quot;left&quot;&gt;&lt;?php
+	
+	if ($view_options != '')
+	{
+	
+?&gt;&lt;select name=&quot;submode&quot; onchange=&quot;if (this.options[this.selectedIndex].value != '') this.form.submit();&quot;&gt;&lt;?php echo $view_options; ?&gt;&lt;/select&gt;&lt;?php
+	
+	}
+	
+?&gt;&lt;/td&gt;
+		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;: &lt;select name=&quot;set&quot; onchange=&quot;use_preset(this.options[this.selectedIndex].value);&quot;&gt;&lt;option class=&quot;sep&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_yes&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_YES']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_no&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_NO']; ?&gt;&lt;/option&gt;&lt;option value=&quot;all_unset&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ALL_UNSET']; ?&gt;&lt;/option&gt;&lt;?php 
+
+	$colspan = 4;
+	if ($which_mode != $mode)
+	{
+		$colspan = 5;
+		echo '&lt;option value=&quot;all_ignore&quot;&gt;' . $_CLASS['core_user']-&gt;lang['ALL_IGNORE'] . '&lt;/option&gt;';
+	}
+
+	// Output user preset options ... if any
+	echo ($preset_options) ? '&lt;option class=&quot;sep&quot;&gt;' . $_CLASS['core_user']-&gt;lang['USER_PRESETS'] . ' -&gt;' . '&lt;/option&gt;' . $preset_options : ''; 
+
+?&gt;&lt;/select&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td colspan=&quot;2&quot;&gt;&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['OPTION']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNSET']; ?&gt;&nbsp;&lt;/th&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&nbsp;&lt;/th&gt;
+&lt;?php
+
+	if ($which_mode != $mode)
+	{
+
+?&gt;
+				&lt;th width=&quot;50&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['IGNORE']; ?&gt;&nbsp;&lt;/th&gt;
+&lt;?php
+
+	}
+
+?&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+	$row_class = 'row2';
+
+	$count = count($auth_options);
+	for ($i = 0; $i &lt; $count; $i++)
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+		// Try and output correct language strings, else output prettyfied auth_option
+		$l_auth_option = (!empty($_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']-&gt;lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
+		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
+		
+		// Which option should we select?
+		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked=&quot;checked&quot;' : '';
+		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked=&quot;checked&quot;' : '';
+		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked=&quot;checked&quot;' : '';
+
+?&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $l_auth_option; ?&gt;&nbsp;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_YES; ?&gt;&quot;&lt;?php echo $selected_yes; ?&gt; /&gt;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_UNSET; ?&gt;&quot;&lt;?php echo $selected_unset; ?&gt; /&gt;&lt;/td&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;&lt;?php echo ACL_NO; ?&gt;&quot;&lt;?php echo $selected_no; ?&gt; /&gt;&lt;/td&gt;
+&lt;?php
+
+		if ($which_mode != $mode)
+		{
+			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) &amp;&amp; $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked=&quot;checked&quot;' : '';
+
+?&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;settings&lt;?php echo $s_auth_option ;?&gt;&quot; value=&quot;*&quot;&lt;?php echo $selected_ignore; ?&gt; /&gt;&lt;/td&gt;
+&lt;?php
+
+		}
+
+?&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+	}
+
+
+	// If we're setting forum or moderator options and a single forum has
+	// been selected then look to see if any subforums exist. If they do
+	// give user the option of cascading permissions to them
+	if (($mode == 'forum' || $mode == 'mod') &amp;&amp; empty($submode) &amp;&amp; count($forum_id[$which_mode]) === 1)
+	{
+		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
+
+		if (!empty($children))
+		{
+
+?&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+					&lt;tr&gt;
+						&lt;td class=&quot;gensmall&quot; colspan=&quot;4&quot; height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACL_SUBFORUMS_EXPLAIN']; ?&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+&lt;?php
+
+			foreach ($children as $row)
+			{
+
+?&gt;
+					&lt;tr&gt;
+						&lt;td&gt;&lt;input type=&quot;checkbox&quot; name=&quot;inherit[]&quot; value=&quot;&lt;?php echo $row['forum_id']; ?&gt;&quot; /&gt; &lt;?php echo $row['forum_name']; ?&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+&lt;?php
+
+			}
+
+?&gt;
+					&lt;tr&gt;
+						&lt;td height=&quot;16&quot; align=&quot;center&quot;&gt;&lt;a class=&quot;gensmall&quot; href=&quot;javascript:marklist('inherit', true);&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MARK_ALL']; ?&gt;&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('inherit', false);&quot; class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['UNMARK_ALL']; ?&gt;&lt;/a&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+				&lt;/table&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+&lt;?php
+
+		}
+	}
+
+	// Display event/cron radio buttons
+	if ($_CLASS['auth']-&gt;acl_gets('a_events', 'a_cron') &amp;&amp; $mode != 'deps' &amp;&amp; $submit != 'update')
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+?&gt;
+			&lt;!-- tr&gt;
+				&lt;th colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_HOW']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;&lt;?php echo $row_class; ?&gt;&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;now&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['RUN_AS_NOW']; ?&gt;&lt;?php 
+	
+			if ($_CLASS['auth']-&gt;acl_get('a_events'))
+			{ 
+
+?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;evt&quot; /&gt; &lt;?php 
+	
+				echo $_CLASS['core_user']-&gt;lang['RUN_AS_EVT'];  
+			}
+			
+			if ($_CLASS['auth']-&gt;acl_get('a_cron'))
+			{
+
+?&gt; &nbsp;&lt;input type=&quot;radio&quot; name=&quot;runas&quot; value=&quot;crn&quot; /&gt; &lt;?php 
+	
+				echo $_CLASS['core_user']-&gt;lang['RUN_AS_CRN']; 
+				
+			}
+
+?&gt;&lt;/td&gt;
+			&lt;/tr --&gt;
+&lt;?php
+
+	}
+
+?&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; colspan=&quot;&lt;?php echo $colspan; ?&gt;&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;submit_update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['UPDATE']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CANCEL']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;ug_type&quot; value=&quot;&lt;?php echo $ug_type; ?&gt;&quot; /&gt;&lt;?php echo $ug_hidden; ?&gt;&lt;?php 
+
+	// Output forum id data
+	echo $s_forum_id;
+
+	// Output settings generated from other views
+	echo $settings_hidden;
+	unset($settings_hidden);
+	
+?&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;
+
+		&lt;br clear=&quot;all&quot; /&gt;
+
+		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;tr&gt;
+				&lt;th colspan=&quot;4&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS']; ?&gt;&lt;/th&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;row1&quot; colspan=&quot;4&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
+					&lt;tr&gt;
+						&lt;td colspan=&quot;2&quot; height=&quot;16&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESETS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+					&lt;tr&gt;
+						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_PRESET']; ?&gt;: &lt;/td&gt;
+						&lt;td&gt;&lt;select name=&quot;presetoption&quot;&gt;&lt;option class=&quot;sep&quot; value=&quot;-1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT'] . ' -&gt;'; ?&gt;&lt;/option&gt;&lt;?php 
+
+	echo $preset_update_options;
+			
+		?&gt;&lt;/select&gt;&lt;/td&gt;
+					&lt;/tr&gt;
+					&lt;tr&gt;
+						&lt;td nowrap=&quot;nowrap&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRESET_NAME']; ?&gt;: &lt;/td&gt;
+						&lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;presetname&quot; maxlength=&quot;25&quot; /&gt; &lt;/td&gt;
+					&lt;/tr&gt;
+				&lt;/table&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+			&lt;tr&gt;
+				&lt;td class=&quot;cat&quot; colspan=&quot;4&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetsave&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SAVE']; ?&gt;&quot; /&gt; &nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;submit_presetdel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE']; ?&gt;&quot; /&gt;&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;/table&gt;&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;&lt;/form&gt;
+
+&lt;?php
+
+}
+
+// Output page footer
+adm_page_footer();
+
+// ---------
+// FUNCTIONS
+//
+function update_foes()
+{
+	global $_CLASS;
+
+	$perms = array();
+	foreach ($_CLASS['auth']-&gt;acl_get_list(false, array('a_', 'm_'), false) as $forum_id =&gt; $forum_ary)
+	{
+		foreach ($forum_ary as $auth_option =&gt; $user_ary)
+		{
+			$perms += $user_ary;
+		}
+	}
+
+	if (!empty($perms))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	unset($perms);
+}
+//
+// FUNCTIONS
+// ---------
+
 ?&gt;
\ No newline at end of file

Modified: cms/branches/1.0alpha2/includes/forums/functions_admin.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_admin.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/functions_admin.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -2053,7 +2053,7 @@
 
 			foreach ($forum_id as $forum)
 			{
-				$sql = 'DELETE FROM '.ACL_TABLE.&quot;
+				$sql = 'DELETE FROM '. FORUMS_ACL_TABLE . &quot;
 					WHERE $id_field = $ug_id
 						AND forum_id = $forum
 						$auth_sql&quot;;
@@ -2081,7 +2081,7 @@
 			$cur_options = array();
 
 			$sql = &quot;SELECT auth_option, is_global, is_local
-				FROM &quot; . ACL_OPTIONS_TABLE . &quot;
+				FROM &quot; . FORUMS_ACL_OPTIONS_TABLE . &quot;
 				ORDER BY auth_option_id&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -2148,7 +2148,7 @@
 							break;
 							
 						default:
-							$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . &quot; (auth_option, is_global, is_local)
+							$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . &quot; (auth_option, is_global, is_local)
 								VALUES ($option, &quot; . $type_sql[$type] . &quot;)&quot;;
 							$_CLASS['core_db']-&gt;query($sql);
 							$sql = '';
@@ -2158,7 +2158,7 @@
 
 			if ($sql != '')
 			{
-				$sql = 'INSERT INTO ' . ACL_OPTIONS_TABLE . &quot; (auth_option, is_global, is_local)
+				$sql = 'INSERT INTO ' . FORUMS_ACL_OPTIONS_TABLE . &quot; (auth_option, is_global, is_local)
 					VALUES $sql&quot;;
 				$_CLASS['core_db']-&gt;query($sql);
 			}
@@ -2182,7 +2182,7 @@
 	$update_sql = $empty_forums = array();
 
 	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . POSTS_TABLE . &quot;
+		FROM ' . FORUMS_POSTS_TABLE . &quot;
 		WHERE post_approved = 1
 			AND {$type}_id IN (&quot; . implode(', ', $ids) . &quot;)
 		GROUP BY {$type}_id&quot;;
@@ -2216,7 +2216,7 @@
 	if (!empty($last_post_ids))
 	{
 		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
-			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
 				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
 		$result = $_CLASS['core_db']-&gt;query($sql);
@@ -2237,7 +2237,7 @@
 		return;
 	}
 
-	$table = ($type == 'forum') ? FORUMS_TABLE : TOPICS_TABLE;
+	$table = ($type == 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
 
 	foreach ($update_sql as $update_id =&gt; $update_sql_ary)
 	{
@@ -2255,17 +2255,13 @@
 function tidy_database()
 {
 	global $_CLASS;
-
+return;
 	$remove_date = time() - (3 * 62 * 24 * 3600);
 
 	$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 		WHERE mark_time &lt; ' . $remove_date;
 	$_CLASS['core_db']-&gt;query($sql);
 
-	$sql = 'DELETE FROM ' . TOPICS_TRACK_TABLE . '
-		WHERE mark_time &lt; ' . $remove_date;
-	$_CLASS['core_db']-&gt;query($sql);
-
 	set_config('database_last_gc', time(), true);
 }
 

Modified: cms/branches/1.0alpha2/includes/forums/functions_display.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_display.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/includes/forums/functions_display.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -166,11 +166,10 @@
 		{
 			$forum_id36 = base_convert($forum_id, 10, 36);
 			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
-		//echo $forum_id36.' - '.$row['mark_time'].'&lt;br/&gt;';
 		}
 
 		if ($row['mark_time'] &lt; $row['forum_last_post_time'])
-		{//echo $parent_id.' - '.$row['mark_time'] .' - '. $row['forum_last_post_time'].'&lt;br/&gt;';
+		{
 			$forum_unread[$parent_id] = true;
 		}
 	}
@@ -273,12 +272,13 @@
 		// Which folder should we display?
 		if ($row['forum_status'] == ITEM_LOCKED)
 		{
-			$folder_image = 'forum_locked';
+// forum_locked_new , need an image for this one
+			$folder_image = empty($forum_unread[$forum_id]) ? 'forum_locked' : 'folder_locked_new';
 			$folder_alt = 'FORUM_LOCKED';
 		}
 		else
 		{
-			$folder_alt = (!empty($forum_unread[$forum_id])) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+			$folder_alt = empty($forum_unread[$forum_id]) ? 'NO_NEW_POSTS' : 'NEW_POSTS';
 		}
 
 		// Create last post link information, if appropriate

Modified: cms/branches/1.0alpha2/install/build_data.php
===================================================================
--- cms/branches/1.0alpha2/install/build_data.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/install/build_data.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -510,4 +510,17 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_extensions (group_id, extension) VALUES (5, 'rm')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_extensions (group_id, extension) VALUES (6, 'wma')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_extensions (group_id, extension) VALUES (6, 'wmv')&quot;);
+
+
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/arrow_bold_rgt.gif', 19, 19, 1, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/redface_anim.gif', 19, 19, 9, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/mr_green.gif', 19, 19, 10, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/musical.gif', 19, 19, 4, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/asterix.gif', 19, 19, 2, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/square.gif', 19, 19, 3, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/alien_grn.gif', 19, 19, 5, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/idea.gif', 19, 19, 8, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/question.gif', 19, 19, 6, 1)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '.$table_prefix.&quot;forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/exclaim.gif', 19, 19, 7, 1)&quot;);
+
 ?&gt;
\ No newline at end of file

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php	2005-10-01 01:51:05 UTC (rev 154)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm.php	2005-10-01 01:55:16 UTC (rev 155)
@@ -99,7 +99,7 @@
 			// New private messages popup
 			case 'popup':
 			
-				$indox_link = generate_link('Control_Panel&amp;i=pm&amp;folder=inbox');
+				$indox_link = generate_link('Control_Panel&amp;i=pm&amp;folder=inbox');
 
 				if ($_CLASS['core_user']-&gt;data['user_new_privmsg'])
 				{


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000074.html">[Viperals-svncheckins] r154 - cms/trunk/includes/display
</A></li>
	<LI>Next message: <A HREF="000076.html">[Viperals-svncheckins] r156 - in cms/trunk: blocks includes/display install
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#75">[ date ]</a>
              <a href="thread.html#75">[ thread ]</a>
              <a href="subject.html#75">[ subject ]</a>
              <a href="author.html#75">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
