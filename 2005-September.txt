From viperal at berlios.de  Sat Sep  3 03:42:21 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 3 Sep 2005 03:42:21 +0200
Subject: [Viperals-svncheckins] r96 - in trunk: . admin admin/functions blocks images includes includes/auth includes/cache includes/db includes/forums includes/forums/admin includes/forums/mcp includes/templates includes/templates/admin/blocks includes/templates/admin/messages includes/templates/admin/system includes/templates/admin/users includes/templates/modules/Contact includes/templates/modules/Contact/email includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Forums/images includes/templates/modules/Forums/images/en includes/templates/modules/Forums/images/karma includes/templates/modules/Members_List includes/templates/rss install javascript language/en modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Members_List themes themes/viperal themes_admin/viperal_admin themes_admin/viperal_admin/style themes_admin/viperal_admin/style/images themes_admin/viperal_admin/template
Message-ID: <200509030142.j831gLDR016085@sheep.berlios.de>

Author: viperal
Date: 2005-09-03 03:42:07 +0200 (Sat, 03 Sep 2005)
New Revision: 96

Added:
   trunk/blocks/block-Modules.php
   trunk/includes/forums/admin/admin_ban.php
   trunk/includes/templates/admin/users/setting.html
   trunk/includes/templates/rss/atom.html
   trunk/themes_admin/viperal_admin/style/
   trunk/themes_admin/viperal_admin/style/images/
   trunk/themes_admin/viperal_admin/style/images/Thumbs.db
   trunk/themes_admin/viperal_admin/style/images/background.gif
   trunk/themes_admin/viperal_admin/style/images/bg.gif
   trunk/themes_admin/viperal_admin/style/images/cellpic.gif
   trunk/themes_admin/viperal_admin/style/images/cellpic1.gif
   trunk/themes_admin/viperal_admin/style/images/cellpic2.jpg
   trunk/themes_admin/viperal_admin/style/images/cellpic3.gif
   trunk/themes_admin/viperal_admin/style/images/created_by.jpg
   trunk/themes_admin/viperal_admin/style/images/curve.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_faq.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_groups.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_login.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_members.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_message.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_profile.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_register.gif
   trunk/themes_admin/viperal_admin/style/images/icon_mini_search.gif
   trunk/themes_admin/viperal_admin/style/images/index.htm
   trunk/themes_admin/viperal_admin/style/images/logo-christmas.jpg
   trunk/themes_admin/viperal_admin/style/images/no_avatar.gif
   trunk/themes_admin/viperal_admin/style/images/sitelogo.jpg
   trunk/themes_admin/viperal_admin/style/images/spacer.gif
   trunk/themes_admin/viperal_admin/style/images/whosonline.gif
   trunk/themes_admin/viperal_admin/style/style.css
Removed:
   trunk/blocks/block-Moderator_Panel.php
   trunk/blocks/block-latest-forums.php
   trunk/includes/templates/modules/Forums/images/icons/
   trunk/includes/templates/modules/Forums/images/karma/icons/
   trunk/themes/login_body_full.css
Modified:
   trunk/admin.php
   trunk/admin/blocks.php
   trunk/admin/functions/block_functions.php
   trunk/admin/menu.php
   trunk/admin/system.php
   trunk/admin/users.php
   trunk/blocks/block-User.php
   trunk/config.php
   trunk/core.php
   trunk/debug.php
   trunk/feed.php
   trunk/images/Thumbs.db
   trunk/includes/auth/auth.php
   trunk/includes/cache/cache_file.php
   trunk/includes/core_rss.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysqli.php
   trunk/includes/db/postgres.php
   trunk/includes/db/sqlite.php
   trunk/includes/forums/admin/admin_board.php
   trunk/includes/forums/admin/admin_permissions.php
   trunk/includes/forums/bbcode.php
   trunk/includes/forums/functions.php
   trunk/includes/forums/functions_display.php
   trunk/includes/forums/functions_posting.php
   trunk/includes/forums/functions_privmsgs.php
   trunk/includes/forums/mcp/mcp_topic.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/tables.php
   trunk/includes/templates/admin/blocks/edit.html
   trunk/includes/templates/admin/messages/edit.html
   trunk/includes/templates/admin/system/index.html
   trunk/includes/templates/admin/users/header.html
   trunk/includes/templates/confirmation.html
   trunk/includes/templates/modules/Contact/email/index.html
   trunk/includes/templates/modules/Contact/index.html
   trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
   trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
   trunk/includes/templates/modules/Control_Panel/ucp_register.html
   trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html
   trunk/includes/templates/modules/Forums/images/Thumbs.db
   trunk/includes/templates/modules/Forums/images/en/Thumbs.db
   trunk/includes/templates/modules/Forums/images/karma/Thumbs.db
   trunk/includes/templates/modules/Forums/overall_footer.html
   trunk/includes/templates/modules/Forums/overall_header.html
   trunk/includes/templates/modules/Members_List/memberlist_footer.html
   trunk/includes/templates/rss/rdf.html
   trunk/includes/templates/rss/rss2.html
   trunk/includes/templates/rss/rss91.html
   trunk/includes/user.php
   trunk/index.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/javascript/menu.js
   trunk/language/en/common.php
   trunk/language/en/error.php
   trunk/modules/Control_Panel/index.php
   trunk/modules/Control_Panel/ucp/ucp_main.php
   trunk/modules/Control_Panel/ucp/ucp_pm.php
   trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
   trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
   trunk/modules/Control_Panel/ucp/ucp_prefs.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Members_List/index.php
   trunk/themes/viperal/index.php
   trunk/themes_admin/viperal_admin/template/header.html
Log:


Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin/blocks.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -504,17 +504,13 @@
 {
 	global $site_file_root, $_CLASS;
 
-	$block_list = array();
-	$default = ($default) ? $default : $_CLASS['core_display']->theme;
-
-	$block_list = '';
 	$block_list_array = array();
 
 	$handle = opendir($site_file_root.'blocks');
 
 	while ($file = readdir($handle))
 	{
-		if(substr($file, 0, 6) == 'block-')
+		if (substr($file, 0, 6) == 'block-')
 		{
 			$block_list_array[$file] = ereg_replace('_',' ',substr($file,6,-4));
 		} 
@@ -522,6 +518,8 @@
 
 	closedir($handle);
 
+	$block_list = '';
+
 	foreach ($block_list_array as $value => $name)
 	{
 		if ($value == $default)

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin/functions/block_functions.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -46,15 +46,16 @@
 	{
 		if (is_null($auth))
 		{
-			$block['block_auth'] = $auth = '';
+			$block['block_auth'] = '';
+			$auth = 'null';
 		}
 		else
 		{
 			$block['block_auth'] = $auth;
-			$auth = $_CLASS['core_db']->escape(serialize($auth));
+			$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
 		}
 
-		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET block_auth = '$auth' WHERE block_id = $id");
+		$_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . " SET block_auth = $auth WHERE block_id = $id");
 		$_CLASS['core_cache']->destroy('blocks');
 	}
 	

Modified: trunk/admin/menu.php
===================================================================
--- trunk/admin/menu.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin/menu.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -58,6 +58,7 @@
 
 $menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('USERS'), 'link' => generate_link('users', array('admin' => true)));
 $menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('users', array('admin' => true)));
+$menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('SETTING'), 'link' => generate_link('users&mode=setting', array('admin' => true)));
 $menu['users'][] = '';
 $menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('VIEW_DISABLED'), 'link' => generate_link('users&mode=disabled', array('admin' => true)));
 $menu['users'][] = array('lang' => $_CLASS['core_user']->get_lang('VIEW_UNACTIVATED'), 'link' => generate_link('users&mode=unactivated', array('admin' => true)));

Modified: trunk/admin/system.php
===================================================================
--- trunk/admin/system.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin/system.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -21,6 +21,9 @@
 $Id$
 */
 
+
+// Need to redo this, do all check before the saving
+
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -89,9 +92,10 @@
 			'link_optimization' => array('post_name' => 'link_optimization'),
 			'site_name'			=> array('post_name' => 'site_name'),
 			'site_url'			=> array('post_name' => 'site_url'),
-			'start_date'		=> array('post_name' => 'start_date')
-			)
-		);
+			'start_date'		=> array('post_name' => 'start_date'),
+			'foot1'				=> array('post_name' => 'foot1'),
+			'foot2'				=> array('post_name' => 'foot2'),
+		));
 		admin_save($data);
 	}
 
@@ -101,8 +105,9 @@
 		'A_OPTION'		=> 'site',
 		'ACTION'		=> generate_link('system', array('admin' => true)),
 		
-		'DEFAULT_THEME' 	=> $_CORE_CONFIG['global']['default_theme'],
 		'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
+
+		'SELECT_THEME' 		=> select_theme($_CORE_CONFIG['global']['default_theme']),
 		'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
 		'SITE_URL'			=> $_CORE_CONFIG['global']['site_url'],
 		'START_DATE'		=> $_CORE_CONFIG['global']['start_date'],
@@ -110,25 +115,7 @@
 		'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
 		'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
 		
-		));
-	
-	$handle = opendir('themes');
-	
-	while ($file = readdir($handle))
-	{
-		if ($file{0} !== '.')
-		{
-			if (file_exists("themes/$file/index.php"))
-			{
-				$_CLASS['core_template']->assign_vars_array('site_theme', array(
-					'FILE'	=> $file,
-					'NAME'  => $file,
-				));
-			}
-		} 
-	}
-	
-	closedir($handle);
+	));
 
 	$_CLASS['core_template']->display('admin/system/index.html');
 }
@@ -153,11 +140,11 @@
 				'cookie_domain' => array('post_name' => 'cookie_domain'),
 				'cookie_name' 	=> array('post_name' => 'cookie_name'),
 				'cookie_path' 	=> array('post_name' => 'cookie_path'),
-				'cookie_secure'	=> array('post_name' => 'cookie_secure'),
 				'error_options'	=> array('post_name' => 'error_options'),
 				'site_domain'	=> array('post_name' => 'site_domain'),
 				'site_port' 	=> array('post_name' => 'site_port'),
 				'site_path' 	=> array('post_name' => 'site_path'),
+				'site_secure'	=> array('post_name' => 'site_secure'),
 				'ip_check' 		=> array('post_name' => 'ip_check'),
 				'limit_load' 	=> array('post_name' => 'limit_load'),
 				'limit_sessions'	=> array('post_name' => 'limit_sessions'),
@@ -176,7 +163,6 @@
 		'COOKIE_DOMAIN' => $_CORE_CONFIG['server']['cookie_domain'],
 		'COOKIE_NAME' 	=> $_CORE_CONFIG['server']['cookie_name'],
 		'COOKIE_PATH' 	=> $_CORE_CONFIG['server']['cookie_path'],
-		'COOKIE_SECURE' => $_CORE_CONFIG['server']['cookie_secure'],
 		'ERROR'			=> $_CORE_CONFIG['server']['error_options'],
 		'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
 		'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
@@ -185,84 +171,14 @@
 		'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
 		'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],
 		'SITE_PORT'			=> $_CORE_CONFIG['server']['site_port'],
+		'SITE_SECURE'		=> $_CORE_CONFIG['server']['site_secure'],
 		'LIMIT_LOAD'		=> $_CORE_CONFIG['server']['limit_load'],
 		'LIMIT_SESSIONS'	=> $_CORE_CONFIG['server']['limit_sessions'],
 		'SESSION_LENGTH'	=> $_CORE_CONFIG['server']['session_length'],
 		
-		));
+	));
 
 	$_CLASS['core_template']->display('admin/system/index.html');
 }
 
-function admin_users($save)
-{
-	if ($save)
-	{
-		$data = array('user' => array(
-			'require_activation'=> array('post_name' => 'require_activation'),
-			'coppa_enable'		=> array('post_name' => 'coppa_enable'),
-			'coppa_fax'			=> array('post_name' => 'coppa_fax'),
-			'coppa_mail'		=> array('post_name' => 'coppa_mail'),
-			'enable_confirm'	=> array('post_name' => 'enable_confirm'),
-			'max_reg_attempts'	=> array('post_name' => 'max_reg_attempts'),
-			'min_name_chars'	=> array('post_name' => 'min_name_chars'),
-			'max_name_chars'	=> array('post_name' => 'max_name_chars'),
-			'min_pass_chars'	=> array('post_name' => 'min_pass_chars'),
-			'max_pass_chars'	=> array('post_name' => 'max_pass_chars'),
-			'chg_passforce'		=> array('post_name' => 'chg_passforce'),
-			'allow_namechange'	=> array('post_name' => 'allow_namechange'),
-			'max_reg_attempts'	=> array('post_name' => 'max_reg_attempts'),
-			'allow_name_chars'	=> array('post_name' => 'allow_name_chars'),
-			'allow_emailreuse'	=> array('post_name' => 'allow_emailreuse'),
-			)
-		);
-		admin_save($data);
-	}
-
-	global $_CLASS, $_CORE_CONFIG;
-
-    $_CLASS['core_template']->assign_array(array(
-		'A_OPTION' => 'users',
-		'ACTION' => generate_link('system&amp;mode=users', array('admin' => true)),
-		'L_EDITOR_OPTION' => $_CLASS['core_user']->lang['EDITOR_OPTION'],
-		
-		'ACTIVATION_OPTION' => $_CORE_CONFIG['user']['require_activation'],
-		'COPPA_ENABLE'		=> $_CORE_CONFIG['user']['coppa_enable'],
-		'COPPA_FAX'			=> $_CORE_CONFIG['user']['coppa_fax'],
-		'COPPA_MAIL'		=> $_CORE_CONFIG['user']['coppa_mail'],
-		'CONFIRM_ENABLE'	=> $_CORE_CONFIG['user']['enable_confirm'],
-		'MAX_REG_ATTEMPTS'	=> $_CORE_CONFIG['user']['max_reg_attempts'],
-		'MIN_NAME_CHARS'	=> $_CORE_CONFIG['user']['min_name_chars'],
-		'MAX_NAME_CHARS'	=> $_CORE_CONFIG['user']['max_name_chars'],
-		'MIN_PASS_CHARS'	=> $_CORE_CONFIG['user']['min_pass_chars'],
-		'MAX_PASS_CHARS'	=> $_CORE_CONFIG['user']['max_pass_chars'],
-		'CHG_PASSFORCE'		=> $_CORE_CONFIG['user']['chg_passforce'],
-		'ALLOW_NAMECHANGE'	=> $_CORE_CONFIG['user']['allow_namechange'],
-		'ALLOW_NAME_CHARS'	=> $_CORE_CONFIG['user']['allow_name_chars'],
-		//'PASS_COMPLEX'  => $_CORE_CONFIG['user']['pass_complex'],
-		//'ALLOW_NAMECHANGE'  => $_CORE_CONFIG['user']['pass_complex'],
-		'ALLOW_EMAILREUSE'	=> $_CORE_CONFIG['user']['allow_emailreuse'],
-
-		'A_ACC_OPTION'	=> array(
-			array(
-				'LANG' => $_CLASS['core_user']->lang['ACC_NONE'],
-				'OPTION' => USER_ACTIVATION_NONE,
-			),
-			array(
-				'LANG' => $_CLASS['core_user']->lang['ACC_USER'],
-				'OPTION' => USER_ACTIVATION_SELF,
-			),
-			array(
-				'LANG' => $_CLASS['core_user']->lang['ACC_ADMIN'],
-				'OPTION' => USER_ACTIVATION_ADMIN,
-			),
-			array(
-				'LANG' => $_CLASS['core_user']->lang['ACC_DISABLE'],
-				'OPTION' => USER_ACTIVATION_DISABLE,
-			))
-		));
-
-		$_CLASS['core_template']->display('admin/system/index.html');
-}
-
 ?>
\ No newline at end of file

Modified: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin/users.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -41,7 +41,8 @@
 	'COUNT_USERS'	=> $count_users,
 	'LINK_ADD_USER'	=> generate_link('users&amp;mode=add_user', array('admin' => true)),
 	'LINK_EDIT_USER'=> generate_link('users&amp;mode=edit_user', array('admin' => true)),
-	
+	'LINK_SETTINGS'	=> generate_link('users&amp;mode=setting', array('admin' => true)),
+
 	'LINK_USER_INDEX'		=> generate_link('users', array('admin' => true)),
 	'LINK_VIEW_BOTS'		=> generate_link('users&amp;mode=bots', array('admin' => true)),
 	'LINK_VIEW_DISABLED'	=> generate_link('users&amp;mode=disabled', array('admin' => true)),
@@ -54,6 +55,76 @@
 {
 	switch ($_REQUEST['mode'])
 	{
+		case 'setting':
+			if (isset($_POST['submit']))
+			{
+				$activation_array = array(USER_ACTIVATION_NONE, USER_ACTIVATION_SELF, USER_ACTIVATION_ADMIN, USER_ACTIVATION_DISABLE);
+				$activation = get_variable('activation', 'POST', USER_ACTIVATION_NONE, 'int');
+
+				$data['activation'] = in_array($activation, $activation_array) ? $activation : USER_ACTIVATION_NONE;
+		 		$data['coppa_enable'] = get_variable('coppa_enable', 'POST') ? 1 : 0;
+		 		$data['coppa_fax'] = get_variable('coppa_fax', 'POST');
+		 		$data['coppa_mail'] = get_variable('coppa_mail', 'POST');
+		 		$data['enable_confirm'] = get_variable('enable_confirm', 'POST') ? 1 : 0;
+		 		$data['max_reg_attempts'] = get_variable('coppa_fax', 'POST', 0, 'INT');
+		 		$data['min_name_chars'] = get_variable('min_name_chars', 'POST', 0, 'INT');
+		 		$data['max_name_chars'] = get_variable('max_name_chars', 'POST', 0, 'INT');
+		 		$data['min_pass_chars'] = get_variable('min_pass_chars', 'POST', 0, 'INT');
+		 		$data['max_pass_chars'] = get_variable('max_pass_chars', 'POST', 0, 'INT');
+
+				foreach ($data as $name => $setting)
+				{
+					if ($setting != $_CORE_CONFIG['user'][$name])
+					{
+						set_core_config('user', $name, $setting, false);
+					}
+				}
+			}
+
+			$_CLASS['core_template']->assign_array(array(
+				'S_ACTION' => generate_link('users&amp;mode=setting', array('admin' => true)),
+		
+				'ACTIVATION_OPTION' => $_CORE_CONFIG['user']['activation'],
+				'COPPA_ENABLE'		=> $_CORE_CONFIG['user']['coppa_enable'],
+				'COPPA_FAX'			=> $_CORE_CONFIG['user']['coppa_fax'],
+				'COPPA_MAIL'		=> $_CORE_CONFIG['user']['coppa_mail'],
+				'CONFIRM_ENABLE'	=> $_CORE_CONFIG['user']['enable_confirm'],
+				'MAX_REG_ATTEMPTS'	=> $_CORE_CONFIG['user']['max_reg_attempts'],
+				'MIN_NAME_CHARS'	=> $_CORE_CONFIG['user']['min_name_chars'],
+				'MAX_NAME_CHARS'	=> $_CORE_CONFIG['user']['max_name_chars'],
+				'MIN_PASS_CHARS'	=> $_CORE_CONFIG['user']['min_pass_chars'],
+				'MAX_PASS_CHARS'	=> $_CORE_CONFIG['user']['max_pass_chars'],
+				//'CHG_PASSFORCE'		=> $_CORE_CONFIG['user']['chg_passforce'],
+				//'ALLOW_NAMECHANGE'	=> $_CORE_CONFIG['user']['allow_namechange'],
+				'ALLOW_NAME_CHARS'	=> $_CORE_CONFIG['user']['allow_name_chars'],
+				
+				//'PASS_COMPLEX'  => $_CORE_CONFIG['user']['pass_complex'],
+				//'ALLOW_NAMECHANGE'  => $_CORE_CONFIG['user']['pass_complex'],
+				//'ALLOW_EMAILREUSE'	=> $_CORE_CONFIG['user']['allow_emailreuse'],
+
+				'A_ACC_OPTION'	=> array(
+					array(
+						'LANG' => $_CLASS['core_user']->lang['ACC_NONE'],
+						'OPTION' => USER_ACTIVATION_NONE,
+					),
+					array(
+						'LANG' => $_CLASS['core_user']->lang['ACC_USER'],
+						'OPTION' => USER_ACTIVATION_SELF,
+					),
+					array(
+						'LANG' => $_CLASS['core_user']->lang['ACC_ADMIN'],
+						'OPTION' => USER_ACTIVATION_ADMIN,
+					),
+					array(
+						'LANG' => $_CLASS['core_user']->lang['ACC_DISABLE'],
+						'OPTION' => USER_ACTIVATION_DISABLE,
+					)
+				)
+			));
+	
+			$_CLASS['core_display']->display(false, 'admin/users/setting.html');
+		break;
+
 		case 'add_user':
 			if (isset($_POST['submit']))
 			{
@@ -61,12 +132,13 @@
 	
 				$error = array();
 	
-				$username	= get_variable('username', 'POST', false);
-				$password	= get_variable('password', 'POST', false);
-				$email		= get_variable('email', 'POST', false);
-				$tz			= get_variable('tz', 'POST', false);
+				$username	= get_variable('username', 'POST');
+				$password	= get_variable('password', 'POST');
+				$email		= get_variable('email', 'POST');
+				$tz			= get_variable('tz', 'POST');
+				$coppa		= get_variable('coppa', 'POST');
+
 				$error		= array();
-
 				//when we add this make sure to confirm that it's one of the installed langs
 				$lang		= $_CORE_CONFIG['global']['default_lang'];
 	
@@ -132,7 +204,7 @@
 					
 					set_core_config('user', 'newest_user_id', $row['user_id'], false);
 					set_core_config('user', 'newest_username', $row['username'], false);
-					set_core_config('user', 'num_users', $_CORE_CONFIG['user']['num_users'] + 1, false);
+					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
 				}
 			}
 

Modified: trunk/admin.php
===================================================================
--- trunk/admin.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/admin.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -25,8 +25,8 @@
 
 $_CLASS['core_user']->add_lang('admin/common.php');
 
-$_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'];
-$_CORE_MODULE['sides'] = BLOCK_ALL;
+$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'];
+$_CORE_MODULE['module_sides'] = BLOCK_ALL;
 $_CLASS['core_blocks']->blocks_loaded = true;
 
 if (!$_CLASS['core_user']->is_user)
@@ -54,25 +54,29 @@
 
 if ($mod)
 {
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE name='".$_CLASS['core_db']->escape($mod)."'");
+	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name='".$_CLASS['core_db']->escape($mod)."'");
 	$_CORE_MODULE = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
+	
+// remove this -- just for testing
+	$_CORE_MODULE['module_name'] = $mod;
+	$_CORE_MODULE['module_title'] = $mod;
 }
 
 if (!$mod || !$_CORE_MODULE)
 {
-	$_CORE_MODULE = array('title' => '', 'name' => '');
+	$_CORE_MODULE = array('module_title' => '', 'module_name' => '');
 	$file_path = $site_file_root.'admin/index.php';
 }
 else
 {
-	if (file_exists($site_file_root.'admin/'.$_CORE_MODULE['name'].'.php'))
+	if (file_exists($site_file_root.'admin/'.$_CORE_MODULE['module_name'].'.php'))
 	{
-		$file_path = $site_file_root.'admin/'.$_CORE_MODULE['name'].'.php';
+		$file_path = $site_file_root.'admin/'.$_CORE_MODULE['module_name'].'.php';
 	}
 	else
 	{
-		$file_path = (file_exists($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/index.php')) ? $site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/index.php' : false;
+		$file_path = (file_exists($site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php')) ? $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php' : false;
 	}
 }
 
@@ -81,16 +85,16 @@
 	trigger_error('NO_ADMIN_MODULE', E_USER_ERROR);
 }
 
-if ($_CORE_MODULE['name'])
+if ($_CORE_MODULE['module_name'])
 {
-	if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['name']))
+	if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['module_name']))
 	{
 		trigger_error('NOT_AUTH', E_USER_ERROR);
 	}
 }
 
-$_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['title'];
-$_CORE_MODULE['sides'] = BLOCK_ALL;
+$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['module_title'];
+$_CORE_MODULE['module_sides'] = BLOCK_ALL;
 	
 require($site_file_root.'admin/menu.php');
 

Deleted: trunk/blocks/block-Moderator_Panel.php
===================================================================
--- trunk/blocks/block-Moderator_Panel.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/blocks/block-Moderator_Panel.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,123 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-if (!defined('VIPERAL')) {
-    Header('Location: ../');
-    die();
-}
-
-global $_CLASS;
-
-if (!isset($_CLASS['core_template']->_tpl_vars['mcp_section']))
-{
-	return;
-}
-
-$this->content .= '<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th>'.$_CLASS['core_template']->_tpl_vars['L_OPTIONS'].'
-</th>
-				</tr>';
-unset($_CLASS['core_template']->_sections['mcp_sectionloop']);
-$_CLASS['core_template']->_sections['mcp_sectionloop']['name'] = 'mcp_sectionloop';
-$_CLASS['core_template']->_sections['mcp_sectionloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_tpl_vars['mcp_section']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['mcp_sectionloop']['show'] = true;
-$_CLASS['core_template']->_sections['mcp_sectionloop']['max'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['loop'];
-$_CLASS['core_template']->_sections['mcp_sectionloop']['step'] = 1;
-$_CLASS['core_template']->_sections['mcp_sectionloop']['start'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['mcp_sectionloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['mcp_sectionloop']['show']) {
-    $_CLASS['core_template']->_sections['mcp_sectionloop']['total'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['loop'];
-    if ($_CLASS['core_template']->_sections['mcp_sectionloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['mcp_sectionloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['mcp_sectionloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['mcp_sectionloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['mcp_sectionloop']['index'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['start'], $_CLASS['core_template']->_sections['mcp_sectionloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['mcp_sectionloop']['iteration'] <= $_CLASS['core_template']->_sections['mcp_sectionloop']['total'];
-                 $_CLASS['core_template']->_sections['mcp_sectionloop']['index'] += $_CLASS['core_template']->_sections['mcp_sectionloop']['step'], $_CLASS['core_template']->_sections['mcp_sectionloop']['iteration']++):
-$_CLASS['core_template']->_sections['mcp_sectionloop']['rownum'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['iteration'];
-$_CLASS['core_template']->_sections['mcp_sectionloop']['index_prev'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['index'] - $_CLASS['core_template']->_sections['mcp_sectionloop']['step'];
-$_CLASS['core_template']->_sections['mcp_sectionloop']['index_next'] = $_CLASS['core_template']->_sections['mcp_sectionloop']['index'] + $_CLASS['core_template']->_sections['mcp_sectionloop']['step'];
-$_CLASS['core_template']->_sections['mcp_sectionloop']['first']      = ($_CLASS['core_template']->_sections['mcp_sectionloop']['iteration'] == 1);
-$_CLASS['core_template']->_sections['mcp_sectionloop']['last']       = ($_CLASS['core_template']->_sections['mcp_sectionloop']['iteration'] == $_CLASS['core_template']->_sections['mcp_sectionloop']['total']);
-
-$this->content .= '<tr>';
-					if ($_CLASS['core_template']->_tpl_vars['mcp_section'][$_CLASS['core_template']->_sections['mcp_sectionloop']['index']]['S_SELECTED']):
-					$this->content .= '<td class="row1"><b class="nav">'.$_CLASS['core_template']->_tpl_vars['mcp_section'][$_CLASS['core_template']->_sections['mcp_sectionloop']['index']]['L_TITLE'].'
-</b>
-
-						<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">';
-
-						unset($_CLASS['core_template']->_sections['mcp_subsectionloop']);
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['name'] = 'mcp_subsectionloop';
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['loop'] = is_array($_loop=$_CLASS['core_template']->_tpl_vars['mcp_subsection']) ? count($_loop) : max(0, (int)$_loop); unset($_loop);
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['show'] = true;
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['max'] = $_CLASS['core_template']->_sections['mcp_subsectionloop']['loop'];
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['step'] = 1;
-$_CLASS['core_template']->_sections['mcp_subsectionloop']['start'] = $_CLASS['core_template']->_sections['mcp_subsectionloop']['step'] > 0 ? 0 : $_CLASS['core_template']->_sections['mcp_subsectionloop']['loop']-1;
-if ($_CLASS['core_template']->_sections['mcp_subsectionloop']['show']) {
-    $_CLASS['core_template']->_sections['mcp_subsectionloop']['total'] = $_CLASS['core_template']->_sections['mcp_subsectionloop']['loop'];
-    if ($_CLASS['core_template']->_sections['mcp_subsectionloop']['total'] == 0)
-        $_CLASS['core_template']->_sections['mcp_subsectionloop']['show'] = false;
-} else
-    $_CLASS['core_template']->_sections['mcp_subsectionloop']['total'] = 0;
-if ($_CLASS['core_template']->_sections['mcp_subsectionloop']['show']):
-
-            for ($_CLASS['core_template']->_sections['mcp_subsectionloop']['index'] = $_CLASS['core_template']->_sections['mcp_subsectionloop']['start'], $_CLASS['core_template']->_sections['mcp_subsectionloop']['iteration'] = 1;
-                 $_CLASS['core_template']->_sections['mcp_subsectionloop']['iteration'] <= $_CLASS['core_template']->_sections['mcp_subsectionloop']['total'];
-                 $_CLASS['core_template']->_sections['mcp_subsectionloop']['index'] += $_CLASS['core_template']->_sections['mcp_subsectionloop']['step'], $_CLASS['core_template']->_sections['mcp_subsectionloop']['iteration']++):
-
-$this->content .= '<li>&#187;';
-	
-if ($_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['S_SELECTED'])
-{
-	 $this->content .= '<b>'.$_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['L_TITLE'];
-	 
-	 if ($_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['ADD_ITEM'])
-	 {
-		$this->content .= ' ('. $_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['ADD_ITEM'].')';
-	}
-
-	$this->content .= '</b>';
-}
-else
-{
-	$this->content .= '<a href="'.$_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['U_TITLE'].'">'.$_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['L_TITLE'];
-
-	if ($_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['ADD_ITEM'])
-	{
-		$this->content .= ' ('. $_CLASS['core_template']->_tpl_vars['mcp_subsection'][$_CLASS['core_template']->_sections['mcp_subsectionloop']['index']]['ADD_ITEM'].')'; 
-	}
-
-	$this->content .= '</a>';
-}
-
-
-$this->content .= '</li>';
-							
-						endfor; endif;
-						$this->content .= '</ul>';
-
-					else:
-					$this->content .= '<td class="row2" nowrap="nowrap" onmouseover="this.className=\'row1\'" onmouseout="this.className=\'row2\'" onclick="location.href=\''.$_CLASS['core_template']->_tpl_vars['mcp_section'][$_CLASS['core_template']->_sections['mcp_sectionloop']['index']]['U_TITLE'].'
-\'"><a class="nav" href="'.$_CLASS['core_template']->_tpl_vars['mcp_section'][$_CLASS['core_template']->_sections['mcp_sectionloop']['index']]['U_TITLE'].'
-">'. $_CLASS['core_template']->_tpl_vars['mcp_section'][$_CLASS['core_template']->_sections['mcp_sectionloop']['index']]['L_TITLE'].'
-</a>';
-					endif;
-					$this->content .= '</td>
-				</tr>';
-				endfor; endif;
-			$this->content .= '</table>';
-
-?>
\ No newline at end of file

Added: trunk/blocks/block-Modules.php
===================================================================
--- trunk/blocks/block-Modules.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/blocks/block-Modules.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,55 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+// This is temp
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $_CLASS, $_CORE_MODULE;
+
+$this->content .= '<div id="nav"><ul style="margin: 0px; padding: 0px; list-style-type: none; line-height: 150%;">';
+$this->content .= '<li><a href="'.generate_link().'">Home</a></li>';
+
+$result = $_CLASS['core_db']->query('SELECT module_name, module_title, module_auth FROM '.CORE_MODULES_TABLE.' WHERE module_type = '.MODULE_NORMAL.' AND module_status = ' . STATUS_ACTIVE . ' ORDER BY module_name ASC');
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+// Add Auth here
+	$row['module_title'] = ($row['module_title']) ? $_CLASS['core_user']->get_lang($row['module_title']) : $_CLASS['core_user']->get_lang($row['module_name']);
+	
+	if ($row['module_name'] == $_CORE_MODULE['module_name'] && !$_CLASS['core_display']->homepage)
+	{
+		$this->content .= '<li><b class="active">'.$row['module_title'].'</b></li>';
+	}
+	else
+	{
+		$this->content .= '<li><a href="'.generate_link($row['module_name']).'"> '.$row['module_title'].'</a></li>';
+	}
+}
+
+$this->content .= '</ul></div>';
+$_CLASS['core_db']->free_result($result);
+
+?>
\ No newline at end of file

Modified: trunk/blocks/block-User.php
===================================================================
--- trunk/blocks/block-User.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/blocks/block-User.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,15 +1,25 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 if (!defined('VIPERAL'))
 {

Deleted: trunk/blocks/block-latest-forums.php
===================================================================
--- trunk/blocks/block-latest-forums.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/blocks/block-latest-forums.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,65 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-if (!defined('VIPERAL')) {
-    Header('Location: ../');
-    die();
-}
-
-global $_CLASS, $phpEx;
-
-$Latest_Active_Topics = 12;
-
-$result = $_CLASS['core_db']->sql_query('SELECT 
-forum_id, topic_last_post_id ,topic_title, 
-topic_last_poster_name, topic_last_poster_id, topic_last_post_time
-FROM '.TOPICS_TABLE.' WHERE topic_moved_id=0 AND topic_approved=1 ORDER BY topic_last_post_time DESC 
-LIMIT 0, '.$Latest_Active_Topics);
-
-if (!$row = $_CLASS['core_db']->sql_fetchrow($result))
-{
-	$_CLASS['core_db']->sql_freeresult($result);
-	return;
-}
-
-$counter = 0;
-$num = 1;
-$this->content = '<table width="100%" border="0" cellpadding="4"><tr>';
-
-do {
-	
-    if ($counter == 3)
-    {
-        $this->content .= '</tr><tr>';
-        $counter = 0;
-	}
-	
-	$row['topic_title'] = (strlen($row['topic_title']) <  25) ? $row['topic_title'] : substr($row['topic_title'], 0, 25) . '...';
-
-    $this->content .= '<td width="33%">'
-    .'<span style="font-size: 140%; font-weight: bold;" >'.$num.'</span>&nbsp;'
-    .'<a style="font-weight: bold;" href="'.getlink('Forums&amp;file=viewtopic&amp;f='.$row['forum_id'].'&amp;p='.$row['topic_last_post_id'].'#'.$row['topic_last_post_id'])
-    .'" >'.$row['topic_title'].'</a><br />'
-    .'<i>Last post by <a href="'.getlink('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']).'">'. $row['topic_last_poster_name'] .'</a>'
-    .'<br/> on '.$_CLASS['core_user']->format_date($row['topic_last_post_time']).'</i><br /><br /></td>';
-	
-    $counter ++;
-    $num ++;
-}
-while($row = $_CLASS['core_db']->sql_fetchrow($result));
-
-$_CLASS['core_db']->sql_freeresult($result);
-
-$this->content .= '</tr></table>';
-
-?>
\ No newline at end of file

Modified: trunk/config.php
===================================================================
--- trunk/config.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/config.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,101 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+// TEMP
+
+// do not modify!
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+//echo getenv('DOCUMENT_ROOT'); die;
+/*
+If (getenv('DOCUMENT_ROOT') != 'C:/Program Files/Apache Group/Apache2/htdocs')
+{
+    die('Your site shouldn\'t access this file');
+}
+*/
+
+$prefix = 'test_';
+$user_prefix = 'test_';
+
+/*
+$site_db['type']		= 'mysql';
+$site_db['server']		= '';
+$site_db['port']		= '';
+$site_db['database']	= 'cms';
+$site_db['username']	= 'root';
+$site_db['password']	= '';
+$site_db['persistent']	= false;
+*/
+
+
+$site_db['type']		= 'postgres';
+$site_db['server']		= '';
+$site_db['port']		= '';
+$site_db['database']	= 'cms';
+$site_db['username']	= 'postgres';
+$site_db['password']	= 'viper83';
+$site_db['persistent']	= false;
+
+
+/*
+$site_db['type']	= 'sqlite';
+$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester';
+$site_db['persistent']	= false;
+*/
+
+/*
+$site_db['type']	= 'sqlite_pdo';
+$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester_pdo';
+$site_db['persistent']	= false;
+
+*/
+
+/*
+NOT WORKING
+
+$site_db['type']		= 'mssql';
+$site_db['server']		= '';
+$site_db['port']		= '';
+$site_db['database']	= 'tester';
+$site_db['username']	= '';
+$site_db['password']	= '';
+$site_db['persistent']	= false;
+*/
+
+//$acm_type = 'eaccelerator';
+$acm_type = 'file';
+
+if (!defined('INDEX_PAGE'))
+{
+	define('INDEX_PAGE', 'index.php');
+}
+
+if (!defined('ADMIN_PAGE'))
+{
+	define('ADMIN_PAGE', 'admin.php');
+}
+
+?>
\ No newline at end of file

Modified: trunk/core.php
===================================================================
--- trunk/core.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/core.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,25 +1,40 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;
 }
 
+error_reporting(E_ALL);
+//error_reporting(0);
+
+if (!extension_loaded('mbstring'))
+{
+	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+}
+
 set_magic_quotes_runtime(0);
-error_reporting(E_ALL);
 mb_internal_encoding('UTF-8');
 //mb_http_output('UTF-8');
 
@@ -36,20 +51,17 @@
 
 $starttime = explode(' ', microtime());
 $starttime = $starttime[1] + $starttime[0];
+$base_memory_usage = get_memory_usage();
 
-// Move to index files
-$base_memory_usage = function_exists('memory_get_usage') ? memory_get_usage() : 0;
+require_once($site_file_root.'includes/functions.php');
+require_once($site_file_root.'config.php');
+require_once($site_file_root.'includes/tables.php');
+require_once($site_file_root.'includes/handler.php');
+require_once($site_file_root.'includes/db/'.$site_db['type'].'.php');
+require_once($site_file_root.'includes/display/template.php');
+require_once($site_file_root.'includes/cache/cache.php');
+require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
 
-require($site_file_root.'includes/functions.php');
-require($site_file_root.'config.php');
-require($site_file_root.'includes/tables.php');
-require($site_file_root.'includes/handler.php');
-require($site_file_root.'includes/mailer.php');
-require($site_file_root.'includes/db/'.$site_db['type'].'.php');
-require($site_file_root.'includes/display/template.php');
-require($site_file_root.'includes/cache/cache.php');
-require($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
-
 // Load basic classes
 load_class(false, 'core_error_handler');
 load_class(false, 'core_cache', 'cache_'.$acm_type);
@@ -69,6 +81,21 @@
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 
+/*
+$_CLASS['core_db']->transaction();
+require($site_file_root.'install/build_tables.php');
+$_CLASS['core_db']->transaction('commit');
+die;
+*/
+
+
+/*
+$_CLASS['core_db']->transaction();
+require($site_file_root.'install/build_data.php');
+$_CLASS['core_db']->transaction('commit');
+die;
+*/
+
 $_CLASS['core_db']->return_on_error = true;
 
 // Error messages just incase we can't get our configs
@@ -77,7 +104,7 @@
 
 if (is_null($_CORE_CONFIG = $_CLASS['core_cache']->get('core_config')))
 {
-	$_CORE_CONFIG = array();
+	$_CORE_CONFIG = $cache = array();
 
 	$sql = 'SELECT * FROM '.CORE_CONFIG_TABLE;
 		
@@ -88,12 +115,30 @@
 	
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$_CORE_CONFIG[$row['section']][$row['name']] = $row['value'];
+		if ($row['config_cache'])
+		{
+			$cache[$row['config_section']][$row['config_name']] = $row['config_value'];
+		}
+		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$_CLASS['core_cache']->put('core_config', $_CORE_CONFIG);
+	$_CLASS['core_cache']->put('core_config', $cache);
+	unset($cache);
 }
+else
+{
+	$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE . ' WHERE config_cache = 0';
+		
+	if ($result = $_CLASS['core_db']->query($sql))
+	{
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+}
 
 unset($config_error);
 
@@ -137,13 +182,58 @@
 }
 else
 {
-	$_CORE_CONFIG['global']['error'] = ERROR_NONE;
+	$_CORE_CONFIG['server']['error_options'] = ERROR_NONE;
 	$_CLASS['core_error_handler']->report = ERROR_NONE;
 }
 
+/*
+$_CORE_CONFIG['server']['error_options'] = ERROR_DEBUGGER;	
+//$_CORE_CONFIG['server']['error_options'] = ERROR_ONPAGE;	
+$_CLASS['core_error_handler']->report = $_CORE_CONFIG['server']['error_options'];
+*/
+
 if ($_SERVER['REQUEST_METHOD'] == 'POST' && $_CLASS['core_user']->new_session)
 {
 	// error here
 }
 
+$install_prefix = 'test_';
+$time = gmtime();
+
+if (!function_exists('field_unix_time'))
+{
+	function field_unix_time($name, $null = false)
+	{
+		global $_CLASS;
+	
+		$_CLASS['core_db']->add_table_field_int($name, array('max' => 200000000, 'null' => $null));
+	}
+}
+
+function get_memory_usage()
+{
+	if (function_exists('memory_get_usage'))
+	{
+		return memory_get_usage();
+	}
+
+/*
+	This pisses me off, seeing that screen pop up all the time :-(
+	Enable it if you want, Will be disabled by default
+
+	if (PHP_OS == 'WINNT')
+	{
+		exec('tasklist /fi "PID eq ' . getmypid() . '" /fo LIST', $output); 
+		//Mem Usage: 24,064 K
+		if (!empty($output[5]))
+		{
+			$usage = (int) str_replace(',', '', substr($output[5], strpos($output[5], ':' ) + 1));
+			// hopefully it always returns the value in KBs
+			return $usage * 1000;
+		}
+	}
+*/
+	return 0;
+}
+
 ?>
\ No newline at end of file

Modified: trunk/debug.php
===================================================================
--- trunk/debug.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/debug.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -22,7 +22,7 @@
 
 if (!$_CLASS['core_user']->is_admin)
 {
-	//die('this is admin only :-) need better language :-(');
+	die('this is admin only :-) need better language :-(');
 }
 
 $_CLASS['core_error_handler']->stop();

Modified: trunk/feed.php
===================================================================
--- trunk/feed.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/feed.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -15,44 +15,46 @@
 define('VIPERAL', 'FEED');
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = 'C:/apachefriends/xampp/cms/';
+$site_file_root = '';
 
 require($site_file_root.'core.php');
 
-error_reporting(0);
+//error_reporting(0);
 header('Content-Type: text/xml');
 
-$result = $_CLASS['core_db']->sql_query('SELECT id, title, time, intro, poster_name FROM '.$prefix.'_news ORDER BY id DESC LIMIT 10');
+$result = $_CLASS['core_db']->query('SELECT news_id, news_title, news_time, news_intro, poster_name FROM '.$prefix.'news ORDER BY news_id DESC LIMIT 10');
 
 $last_post_time = 0;
 	
-while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	if ($row['time'] > $last_post_time)
+	if ($row['news_time'] > $last_post_time)
 	{
-		$last_post_time = $row['time'];
+		$last_post_time = $row['news_time'];
 	}
 	
 	$_CLASS['core_template']->assign_vars_array('items', array(
-		'TITLE' 		=> htmlspecialchars($row['title'], ENT_QUOTES),
-		'LINK' 			=> generate_link('News&amp;mode=view&amp;id='.$row['id'], array('full' => true)),
-		'DESCRIPTION' 	=> htmlspecialchars(strip_tags($row['intro']), ENT_QUOTES),
-		'TIME'			=> gmdate('M d Y H:i:s', $row['time']) .' GMT',
-		'AUTHOR'		=> $row['poster_name']
+		'TITLE' 			=> htmlspecialchars($row['news_title'], ENT_QUOTES),
+		'LINK' 				=> generate_link('News&amp;mode=view&amp;id='.$row['news_id'], array('full' => true, 'sid' => false)),
+		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($row['news_intro']), ENT_QUOTES),
+		'DESCRIPTION_HTML' 	=> htmlspecialchars($row['news_intro'], ENT_QUOTES),
+		'TIME'				=> date('M d Y H:i:s', $row['news_time']) .' GMT',
+		'AUTHOR'			=> $row['poster_name']
 	));
 }
+$_CLASS['core_db']->free_result($result);
 
-$_CLASS['core_db']->sql_freeresult($result);
+$last_modified = date('M d Y H:i:s', $last_post_time) .' GMT';
 
-$_CLASS['core_template']->assign(array(
-		'SITE_NAME' 	=> $_CORE_CONFIG['global']['site_name'],
-		'SITE_URL' 		=> $_CORE_CONFIG['global']['site_url'],
-		'SLOGAN' 		=> $_CORE_CONFIG['global']['slogan'],
-		'LANG'			=> 'en-us',
-		'LAST_MODIFIED'	=> gmdate('M d Y H:i:s', $last_post_time) .' GMT',
-		'TIME'			=> gmdate('M d Y H:i:s', time()) .' GMT'
-	));
+$_CLASS['core_template']->assign_array(array(
+	'SITE_NAME' 	=> $_CORE_CONFIG['global']['site_name'],
+	'SITE_URL' 		=> $_CORE_CONFIG['global']['site_url'],
+	'LANG'			=> 'en-us',
+	'LAST_MODIFIED'	=> $last_modified ,
+	'TIME'			=> gmdate('M d Y H:i:s') .' GMT'
+));
 
+//header('Last-Modified: '.$last_modified);
 
 $feed = get_variable('feed', 'GET', false);
 
@@ -60,23 +62,26 @@
 {
 	case 'rdf':
 	case 'rss1':
+		$_CLASS['core_template']->display('rss/rdf.html');
+	break;
 
-	$_CLASS['core_template']->display('rss/rdf.html');
-	break;
-	
 	case 'rss2':
-	$_CLASS['core_template']->display('rss/rss2.html');
+		$_CLASS['core_template']->display('rss/rss2.html');
 	break;
-	
+
 	case 'rss':
-	$_CLASS['core_template']->display('rss/rss91.html');
+		$_CLASS['core_template']->display('rss/rss91.html');
 	break;
-		
+
+	case 'atom':
+		$_CLASS['core_template']->display('rss/atom.html');
+	break;
+
 	default:
-	$_CLASS['core_template']->display('rss/rss91.html');
+		$_CLASS['core_template']->display('rss/rss91.html');
+	break;
 }
 
 script_close();
-die;
 
 ?>
\ No newline at end of file

Modified: trunk/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/auth/auth.php
===================================================================
--- trunk/includes/auth/auth.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/auth/auth.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -23,17 +23,17 @@
 {
 	var $_user_id;
 	var $_group_ids = array();
-	var $_group_default_id;
+	var $_user_group;
 
 	var $_got_data = false;
 	var $_admin_permission = array();
 
-	function core_auth($user_id = false, $group_id = false)
+	function core_auth($user_id = false, $user_group = false)
 	{
 		global $_CLASS;
 
 		$this->_user_id = ($user_id) ? $user_id : $_CLASS['core_user']->data['user_id'];
-		$this->_group_default_id = ($group_id) ? $group_id : $_CLASS['core_user']->data['group_id'];
+		$this->_user_group = ($user_group) ? $user_group : $_CLASS['core_user']->data['user_group'];
 	}
 
 	function user_auth($user_name, $user_password)
@@ -80,8 +80,8 @@
 
 // should this be extended for defualt groups only, and all in group ?
 		$sql = 'SELECT * FROM ' . ADMIN_AUTH_TABLE ." 
-					WHERE member_user_id = {$this->_user_id}
-					OR member_group_id = {$this->_group_default_id} ORDER BY member_user_id";
+					WHERE user_id = {$this->_user_id}
+					OR group_id = {$this->_user_group} ORDER BY user_id";
 
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -98,7 +98,7 @@
 
 				if (trim($row['admin_options']) && is_array($row['admin_options'] = @unserialize($row['admin_options'])))
 				{
-					$this->_admin_permission[$row['section']] = $row['options'];
+					$this->_admin_permission[$row['admin_section']] += $row['options'];
 				}
 			}
 		}
@@ -118,7 +118,7 @@
 
 		if (!isset($this->_admin_permission[$section]))
 		{
-			return isset($this->_admin_permission['/all/']) ?  true : false;
+			return isset($this->_admin_permission['_all_']) ?  true : false;
 		}
 
 		if ($option)
@@ -162,7 +162,7 @@
 			if (!$error && $_CORE_CONFIG['user']['enable_confirm'])
 			{
 				$code = $_CLASS['core_user']->session_data_get('confirmation_code');
-				$confirm_code = get_variable('confirm_code', 'POST');
+				$confirm_code = get_variable('confirm_code', 'POST', false);
 	
 				if (!$code || !$confirm_code || $code !== $confirm_code)
 				{
@@ -200,7 +200,7 @@
 		if ($_CORE_CONFIG['user']['enable_confirm'])
 		{
 			$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
-			$_CLASS['core_user']->session_data_set('confirmation_code', strtoupper(generate_string(6)));
+			$_CLASS['core_user']->session_data_set('confirmation_code', generate_string(6));
 		}
 		else
 		{
@@ -212,7 +212,7 @@
 			'LOGIN_EXPLAIN'			=> $_CLASS['core_user']->get_lang($login_array['explain']), 
 
 			'U_SEND_PASSWORD'	 	=> ($_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=sendpassword') : '',
-			'U_RESEND_ACTIVATION'   => ($_CORE_CONFIG['user']['require_activation'] != USER_ACTIVATION_NONE && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=resend_act') : '',
+			'U_RESEND_ACTIVATION'   => ($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_NONE && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=resend_act') : '',
 			'U_TERMS_USE'			=> generate_link('Control_Panel&amp;mode=terms'), 
 			'U_PRIVACY'				=> generate_link('Control_Panel&amp;mode=privacy'),
 			'U_REGISTER'			=> generate_link('Control_Panel&amp;mode=register'),
@@ -260,7 +260,7 @@
 			// need to sort/seperate this so that Only Default goups are first
 			foreach ($options_array['groups'][1] as $id => $group_options)
 			{
-				if ($id == $this->_group_default_id)
+				if ($id == $this->_user_group)
 				{
 					return (isset($group_options[$option]) ? $group_options[$option] : false);
 				}
@@ -385,8 +385,7 @@
 							unset($auth_options['users'][$key]);
 						}
 					}
-
-					//print_r($auth_options);
+					
 				break;
 			
 				case 'set':
@@ -396,13 +395,9 @@
 
 			$return = null;
 
-			foreach ($auth_options as $test)
+			if (!empty($auth_options['users'])|| !empty($auth_options['groups'][0])	|| !empty($auth_options['groups'][1]))
 			{
-				if (!empty($test))
-				{
-					$return =& $auth_options;
-					break;
-				}
+				$return =& $auth_options;
 			}
 		}
 

Modified: trunk/includes/cache/cache_file.php
===================================================================
--- trunk/includes/cache/cache_file.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/cache/cache_file.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -70,8 +70,13 @@
 		$this->expires[$name] = $expires;
 	}
 	
-	function gc()
+	function gc($time = false)
 	{
+		if (!$time)
+		{
+			$time = gmtime();
+		}
+
 		$dir = opendir($this->cache_dir);
 
 		while ($file = readdir($dir))
@@ -87,13 +92,16 @@
 					$unset = true;
 				}
 				
-				if (time() > $this->expires[$name])
+				if ($time > $this->expires[$name])
 				{
 					unlink($this->cache_dir . $file);
 					$this->remove($name);
 				}
 
-				($unset) ? $this->remove($name) : '';
+				if ($unset)
+				{
+					$this->remove($name);
+				}
 			}
 		}
 

Modified: trunk/includes/core_rss.php
===================================================================
--- trunk/includes/core_rss.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/core_rss.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -17,7 +17,10 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
+
 // Add channel support, rss_data[channel][item][item_branch]
 // nested items
 // maybe make this more xml specfic with another rss function?
@@ -30,6 +33,7 @@
 	var $item_tags = array('title', 'link', 'description', 'author');
 	var $channel_tags = array('title', 'link', 'description', 'author');
 	var $send_cookie = false;
+	var $channel_open = false;
 
 	var $error = '';
 	var $item = 0;
@@ -134,7 +138,6 @@
 		if (mb_strpos($data, '200') === false)
 		{
 			//echo $data;
-
 			if (mb_strpos($data, '301') === true || mb_strpos($data, '301') === true)
 			{
 				while (!empty($data))
@@ -239,31 +242,32 @@
 			return;
 		}
 
-		$element = strtolower($element);
-
 		if (mb_strpos($element, ':'))
 		{
 			list($element) = explode(':', $element, 2);
 		}
 
+		$element = strtolower($element);
+
 		if (!$this->feed_type)
 		{
 			switch($element)
 			{
 				Case 'rdf':
 					$this->feed_type = 'rss';
-					break;
+				break;
 				
 				Case 'rss':
 					$this->feed_type = 'rss';
-					break;
+				break;
 				
 				Case 'feed':
 					$this->feed_type = 'atom';
-					break;
+				break;
 
 				default:
 					$this->feed_type = 'generic';
+				break;
 			}
 
 			$attrs = array_change_key_case($attrs, CASE_LOWER);
@@ -274,16 +278,22 @@
 			return;
 		}
 
-		if ($element == 'item' || $element == 'entry')
+		if ($element === 'item' || $element === 'entry')
 		{
 			$this->item_open = true;
 			return;
 		}
-		elseif ($element == 'channel' || $element == 'feed')
+		elseif ($element === 'channel' || $element === 'feed')
 		{
 			$this->channel_open = true;
 			return;
 		}
+		
+		if ($element == 'link' && $this->feed_type == 'atom' && in_array($element, $this->item_tags))
+		{
+			$this->rss_data[$this->item][$element] = $attrs['HREF'];
+			return;
+		}
 
 		if ($this->item_open)
 		{
@@ -291,7 +301,6 @@
 			{
 				$this->title_type = $element;
 			}
-			return;
 		}
 		else
 		{

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/db/mysql.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -62,14 +62,6 @@
 
 				//mysql_query('SET character_set_results = NULL', $this->link_identifier);
 
-				/*
-				$result = mysql_query("show variables like 'col%'",$this->link_identifier);
-				while ($value = mysql_fetch_assoc($result))
-				{
-					print_r($value);
-					echo '<br>';
-				}
-				*/
 				return $this->link_identifier;
 			}
 
@@ -201,11 +193,6 @@
 		return $this->last_result;
 	}
 
-	function sql_query($query = false)
-	{
-		return mysql_query($query, $this->link_identifier);
-	}
-
 	function query_limit($query = false, $total = false, $offset = 0, $backtrace = false) 
 	{
 		if (!$query || !$total || !$this->link_identifier) 
@@ -232,6 +219,11 @@
 		return $this->query($query, $backtrace);
 	}
 
+	function sql_query($query = false)
+	{
+		return mysql_query($query, $this->link_identifier);
+	}
+
 	/*
 		Boy do I like this but it phpBB's, may have to do something similar
 	*/
@@ -364,18 +356,21 @@
 
 	function escape($text)
 	{
-		if (function_exists('mysql_real_escape_string') && $this->link_identifier)
-		{
-			return mysql_real_escape_string($text, $this->link_identifier);
+		if (!$this->link_identifier)
+		{ 
+			return false; 
 		}
-		else
-		{
-			return mysql_escape_string($text);
-		}
+
+		return mysql_real_escape_string($text, $this->link_identifier);
 	}
 
 	function escape_array($value)
 	{
+		if (!$this->link_identifier)
+		{ 
+			return false; 
+		}
+
 		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
 	}
 		
@@ -660,4 +655,12 @@
 	}
 }
 
+if (!function_exists('mysql_real_escape_string'))
+{
+	function mysql_real_escape_string($text, $null)
+	{
+		return mysql_escape_string($text);
+	}
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/db/mysqli.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -23,7 +23,7 @@
 
 class db_mysqli
 {
-	var $link_identifier;
+	var $link_identifier = false;
 	var $db_layer = 'mysqli';
 
 	var $last_result;
@@ -37,9 +37,9 @@
 	var $query_details = array();
 	var $open_queries = array();
 
-	var $indexs = array();
-	var $fields = array();
-	var $table_name = false;
+	var $_indexs = array();
+	var $_fields = array();
+	var $_table_name = false;
 
 	function connect($db)
 	{		
@@ -183,7 +183,7 @@
 		{
 			$this->_error($query, $backtrace);
 		}
-		elseif (strpos($query, 'SELECT') !== false)
+		elseif (strpos($query, 'SELECT') === false)
 		{
 			$this->open_queries[(string) $this->last_result] = $this->last_result;
 		}
@@ -232,13 +232,13 @@
 			return false;
 		}
 
-		$fields = $values = array();
+		$_fields = $values = array();
 
 		if ($query == 'INSERT')
 		{
 			foreach ($array as $key => $value)
 			{
-				$fields[] = $key;
+				$_fields[] = $key;
 
 				if (is_numeric($value))
 				{
@@ -258,7 +258,7 @@
 				}
 			}
 
-			return ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
 		}
 		elseif ($query == 'UPDATE' || $query == 'SELECT')
 		{
@@ -371,6 +371,11 @@
 
 	function escape_array($value)
 	{
+		if (!$this->link_identifier)
+		{ 
+			return false; 
+		}
+
 		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
 	}
 
@@ -516,13 +521,13 @@
 					return;
 				}
 
-				$fields = implode(", \n", $this->_fields);
-				if ($indexs = implode(", \n", $this->_indexs))
+				$_fields = implode(", \n", $this->_fields);
+				if ($_indexs = implode(", \n", $this->_indexs))
 				{
-					$fields .= ", \n";
+					$_fields .= ", \n";
 				}
 
-				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
+				$table = 'CREATE TABLE '.$this->_table_name." ( \n" .$_fields. $_indexs ." \n ) ENGINE=InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;";
 				// Let users choose transaction safe InnoDB or MyISAM
 				// ENGINE=MyISAM
 				if ($option == 'return')
@@ -598,7 +603,7 @@
 		}
 	}
 
-	function add_table_field_text($name, $characters = 60000, $null = false)
+	function add_table_field_text($name, $characters, $null = false)
 	{
 		if ($characters <= 255)
 		{
@@ -627,18 +632,14 @@
 	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
 		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
 		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		$index_name = ($index_name) ? $index_name : $field;
+		$index_name = $index_name ? $index_name : $field;
 		
-		/*if (empty($this->_fields[$field]))
-		{
-			return;
-		}*/
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: trunk/includes/db/postgres.php
===================================================================
--- trunk/includes/db/postgres.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/db/postgres.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -552,7 +552,7 @@
 
 				if (!$this->sql_query($table))
 				{
-				echo $table.'<br/>';
+					echo $table.'<br/>';
 				}
 
 			case 'cancel':
@@ -579,9 +579,9 @@
 			// INTEGER -- INT4 ( +auto_increment => SERIAL4 ) ( -2,147,483,648 to 2,147,483,647 )
 			$this->_fields[$name] =   ($setting['auto_increment']) ? "$name SERIAL" : "$name INTEGER";
 		}
-		elseif ($setting['min'] >= 9223372036854775808 && $setting['max'] <= 9223372036854775807)
+		elseif ($setting['min'] >= -9223372036854775808 && $setting['max'] <= 9223372036854775807)
 		{
-			// BIGINT -- INT8 ( +auto_increment => SERIAL8 ) ( 9,223,372,036,854,775,808 to 9,223,372,036,854,775,807 )
+			// BIGINT -- INT8 ( +auto_increment => SERIAL8 ) ( -9,223,372,036,854,775,808 to 9,223,372,036,854,775,807 )
 			$this->_fields[$name] =  ($setting['auto_increment']) ? "$name BIGSERIAL" : "$name BIGINT";
 		}
 
@@ -610,7 +610,11 @@
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		$index_name = $this->_table_name.'_'.(($index_name) ? $index_name : $field) ;
+		$index_name = ($index_name) ? $index_name : $field;
+
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+		$index_name = $this->_table_name . '_' . $index_name;
+
 		$field = is_array($field) ? implode(', ', $field) : $field;
 
 		switch ($type)

Modified: trunk/includes/db/sqlite.php
===================================================================
--- trunk/includes/db/sqlite.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/db/sqlite.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -523,13 +523,20 @@
 
 				// Have to create the table first then do the indexs
 				// I guess it's ....
-				$this->sql_query($table);
-
+				if (!$this->sql_query($table))
+				{
+					echo $table.'<br/>';
+				}
+				
 				foreach ($this->_indexs as $query)
 				{
-					$this->sql_query($query);
+					if (!$this->sql_query($query))
+					{
+						echo $query.'<br/>';
+					}
 				}
 
+
 			case 'cancel':
 				$this->_table_name = false;
 				$this->_fields = $this->_indexs = array();
@@ -537,59 +544,68 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = null, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => null, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
 		$this->_fields[$name] =  $name .' INTEGER';
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
 			$this->_fields[$name] .= ' AUTOINCREMENT';
 		}
 		else
 		{
-			$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
 		}
 	}
 
-	function add_table_field_text($name, $characters = 60000, $null = true)
+	function add_table_field_text($name, $characters, $null = true)
 	{
-		$this->_fields[$name] =  $name.' TEXT';
-		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] =  "$name TEXT".(($null) ? " NULL" : " NOT NULL");
 	}
 
-	function add_table_field_char($name, $characters, $default = null, $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-
 		$this->_fields[$name] =  $name.' TEXT';
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		if (empty($this->_fields[$field]))
-		{
-			return;
-		}
+		$index_name = ($index_name) ? $index_name : $field;
 
-		$index_name = $this->_table_name.'_'.(($index_name) ? $index_name : $field) ;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+		$index_name = $this->_table_name . '_' . $index_name;
 
 		switch ($type)
 		{
 			case 'index':
-			case 'unique'://CREATE INDEX group_id ON test_admins ( group_id ) ; 
-				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'CREATE UNIQUE' : 'CREATE') . " INDEX $index_name ON {$this->_table_name} ( $field );";
+			case 'unique':
+				$field = is_array($field) ? implode(', ', $field) : $field;
+				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'CREATE UNIQUE' : 'CREATE') . " INDEX $index_name ON {$this->_table_name} ($field);";
 			break;
 
 			case 'primary':
-				if ($pos = stripos($this->_fields[$field], ' AUTOINCREMENT'))
+// need to check if sqlite even supports 2 pkeys
+				if (is_array($field))
 				{
+					// maybe make this regular indexes
+					return;
+				}
+
+				/*
+				if ($pos = strpos($this->_fields[$field], ' AUTOINCREMENT'))
+				{
 					$this->_fields[$field] = substr($this->_fields[$field], 0, $pos);
 					$this->_fields[$field] .= ' PRIMARY KEY AUTOINCREMENT'; // AUTOINCREMENT isn't needed
 
 					break;
 				}
+				*/
 
 				$this->_fields[$field] .= ' PRIMARY KEY';
 			break;

Added: trunk/includes/forums/admin/admin_ban.php
===================================================================
--- trunk/includes/forums/admin/admin_ban.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/admin/admin_ban.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,289 @@
+<?php
+// -------------------------------------------------------------
+//
+// $Id: admin_ban.php,v 1.11 2004/08/01 21:01:23 psotfx Exp $
+//
+// FILENAME  : admin_ban.php
+// STARTED   : Tue Jul 31, 2001
+// COPYRIGHT : ? 2001,2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
+//
+// -------------------------------------------------------------
+
+// Do we have ban permissions?
+if (!$auth->acl_get('a_ban'))
+{
+	trigger_error($user->lang['NO_ADMIN']);
+}
+
+include('includes/forums/functions_user.'.$phpEx);
+
+// Mode setting
+$mode		= request_var('mode', '');
+$bansubmit	= (isset($_POST['bansubmit'])) ? true : false;
+$unbansubmit= (isset($_POST['unbansubmit'])) ? true : false;
+
+// Set some vars
+$current_time = time();
+
+// Start program
+if ($bansubmit)
+{
+	// Grab the list of entries
+	$ban			= request_var('ban', '');
+	$ban_len		= request_var('banlength', 0);
+	$ban_len_other	= request_var('banlengthother', '');
+	$ban_exclude	= request_var('banexclude', 0);
+	$ban_reason		= request_var('banreason', '');
+
+	user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason);
+
+	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
+}
+else if ($unbansubmit)
+{
+	$ban = request_var('unban', '');
+
+	user_unban($mode, $ban);
+
+	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
+}
+
+//
+// Output relevant entry page
+//
+
+
+//
+// Ban length options
+//
+$ban_end_text = array(0 => $user->lang['PERMANENT'], 30 => $user->lang['30_MINS'], 60 => $user->lang['1_HOUR'], 360 => $user->lang['6_HOURS'], 1440 => $user->lang['1_DAY'], 10080 => $user->lang['7_DAYS'], 20160 => $user->lang['2_WEEKS'], 40320 => $user->lang['1_MONTH'], -1 => $user->lang['OTHER'] . ' -&gt; ');
+
+$ban_end_options = '';
+foreach ($ban_end_text as $length => $text)
+{
+	$ban_end_options .= '<option value="' . $length . '">' . $text . '</option>';
+}
+
+// Title
+switch ($mode)
+{
+	case 'user':
+		$l_title = $user->lang['BAN_USERS'];
+		break;
+	case 'email':
+		$l_title = $user->lang['BAN_EMAILS'];
+		break;
+	case 'ip':
+		$l_title = $user->lang['BAN_IPS'];
+		break;
+}
+
+// Output page
+adm_page_header($l_title);
+
+?>
+
+<p><?php echo $user->lang['BAN_EXPLAIN']; ?></p>
+
+<?php
+
+switch ($mode)
+{
+	case 'user':
+
+		$field = 'username';
+		$l_ban_title = $user->lang['BAN_USERS'];
+		$l_ban_explain = $user->lang['BAN_USERNAME_EXPLAIN'];
+		$l_ban_exclude_explain = $user->lang['BAN_USER_EXCLUDE_EXPLAIN'];
+		$l_unban_title = $user->lang['UNBAN_USERNAME'];
+		$l_unban_explain = $user->lang['UNBAN_USERNAME_EXPLAIN'];
+		$l_ban_cell = $user->lang['USERNAME'] . ': <br /><span class="gensmall">[ <a href="' . getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban').'" onclick="window.open(\''.getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban')."', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;\">" . $user->lang['FIND_USERNAME'] .'</a> ]</span>';
+		$l_no_ban_cell = $user->lang['NO_BANNED_USERS'];
+
+		$sql = 'SELECT b.*, u.user_id, u.username
+			FROM ' . BANLIST_TABLE . ' b, ' . USERS_TABLE . ' u
+			WHERE (b.ban_end >= ' . time() . '
+					OR b.ban_end = 0)
+				AND u.user_id = b.ban_userid
+				AND b.ban_userid <> 0
+				AND u.user_id <> ' . ANONYMOUS . '
+			ORDER BY u.user_id ASC';
+		break;
+
+	case 'ip':
+
+		$field = 'ban_ip';
+		$l_ban_title = $user->lang['BAN_IPS'];
+		$l_ban_explain = $user->lang['BAN_IP_EXPLAIN'];
+		$l_ban_exclude_explain = $user->lang['BAN_IP_EXCLUDE_EXPLAIN'];
+		$l_unban_title = $user->lang['UNBAN_IP'];
+		$l_unban_explain = $user->lang['UNBAN_IP_EXPLAIN'];
+		$l_ban_cell = $user->lang['IP_HOSTNAME'] . ':';
+		$l_no_ban_cell = $user->lang['NO_BANNED_IP'];
+
+		$sql = 'SELECT *
+			FROM ' . BANLIST_TABLE . '
+			WHERE (ban_end >= ' . time() . "
+					OR ban_end = 0)
+				AND ban_ip <> ''";
+		break;
+
+	case 'email':
+
+		$field = 'ban_email';
+		$l_ban_title = $user->lang['BAN_EMAILS'];
+		$l_ban_explain = $user->lang['BAN_EMAIL_EXPLAIN'];
+		$l_ban_exclude_explain = $user->lang['BAN_EMAIL_EXCLUDE_EXPLAIN'];
+		$l_unban_title = $user->lang['UNBAN_EMAIL'];
+		$l_unban_explain = $user->lang['UNBAN_EMAIL_EXPLAIN'];
+		$l_ban_cell = $user->lang['EMAIL_ADDRESS'] . ':';
+		$l_no_ban_cell = $user->lang['NO_BANNED_EMAIL'];
+
+		$sql = 'SELECT *
+			FROM ' . BANLIST_TABLE . '
+			WHERE (ban_end >= ' . time() . "
+					OR ban_end = 0)
+				AND ban_email <> ''";
+		break;
+}
+$result = $db->sql_query($sql);
+
+$banned_options = '';
+$ban_length = $ban_reasons = array();
+if ($row = $db->sql_fetchrow($result))
+{
+	do
+	{
+
+		$banned_options .=  '<option' . (($row['ban_exclude']) ? ' class="sep"' : '') . ' value="' . $row['ban_id'] . '">' . $row[$field] . '</option>';
+
+		$time_length = (!empty($row['ban_end'])) ? ($row['ban_end'] - $row['ban_start']) / 60 : 0;
+		$ban_length[$row['ban_id']] = (!empty($ban_end_text[$time_length])) ? $ban_end_text[$time_length] : $user->lang['OTHER'] . ' -> ' . gmdate('Y-m-d', $row['ban_end']);
+
+		$ban_reasons[$row['ban_id']] = addslashes($row['ban_reason']);
+	}
+	while ($row = $db->sql_fetchrow($result));
+}
+$db->sql_freeresult($result);
+
+?>
+
+<h1><?php echo $l_ban_title; ?></h1>
+
+<p><?php echo $l_ban_explain; ?></p>
+
+<script language="Javascript" type="text/javascript">
+<!--
+
+var ban_length = new Array();
+<?php
+
+	if (sizeof($ban_length))
+	{
+		foreach ($ban_length as $ban_id => $length)
+		{
+			echo "ban_length['$ban_id'] = \"$length\";\n";
+		}
+	}
+
+?>
+
+var ban_reason = new Array();
+<?php
+
+	if (sizeof($ban_reasons))
+	{
+		foreach ($ban_reasons as $ban_id => $reason)
+		{
+			echo "ban_reason['$ban_id'] = \"$reason\";\n";
+		}
+	}
+?>
+
+function display_details(option)
+{
+	document.forms[0].unbanreason.value = ban_reason[option];
+	document.forms[0].unbanlength.value = ban_length[option];
+}
+
+//-->
+</script>
+
+<form name="banning" method="post" action="<?php echo "admin_ban.$phpEx$SID&amp;mode=$mode"; ?>"><table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2"><?php echo $l_ban_title; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $l_ban_cell; ?></td>
+		<td class="row2"><textarea cols="40" rows="3" name="ban"></textarea></td>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
+		<td class="row2"><select name="banlength"><?php echo $ban_end_options; ?></select>&nbsp; <input class="post" type="text" name="banlengthother" maxlength="10" size="10" /></td>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $user->lang['BAN_EXCLUDE']; ?>: <br /><span class="gensmall"><?php echo $l_ban_exclude_explain;;?></span></td>
+		<td class="row2"><input type="radio" name="banexclude" value="1" /> <?php echo $user->lang['YES']; ?> &nbsp; <input type="radio" name="banexclude" value="0" checked="checked" /> <?php echo $user->lang['NO']; ?></td>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
+		<td class="row2"><input class="post" type="text" name="banreason" maxlength="255" size="40" /></td>
+	</tr>
+	<tr>
+		<td class="cat" colspan="2" align="center"> <input type="submit" name="bansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" />&nbsp;</td>
+	</tr>
+</table>
+
+<h1><?php echo $l_unban_title; ?></h1>
+
+<p><?php echo $l_unban_explain; ?></p>
+
+<table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2"><?php echo $l_unban_title; ?></th>
+	</tr>
+<?php
+
+	if ($banned_options)
+	{
+
+?>
+	<tr>
+		<td class="row1" width="45%"><?php echo $l_ban_cell; ?>: <br /></td>
+		<td class="row2"> <select name="unban[]" multiple="multiple" size="5" onchange="display_details(this.options[this.selectedIndex].value)"><?php echo $banned_options; ?></select></td>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
+		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanreason" size="40" /></td>
+	</tr>
+	<tr>
+		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
+		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanlength" size="40" /></td>
+	</tr>
+	<tr>
+		<td class="cat" colspan="2" align="center"><input type="submit" name="unbansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" /></td>
+	</tr>
+<?php
+
+	}
+	else
+	{
+
+?>
+	<tr>
+		<td class="row2" colspan="2" align="center"><?php echo $l_no_ban_cell;  ?></td>
+	</tr>
+<?php
+
+	}
+
+?>
+</table></form>
+
+<?php
+
+adm_page_footer();
+
+?>
\ No newline at end of file

Modified: trunk/includes/forums/admin/admin_board.php
===================================================================
--- trunk/includes/forums/admin/admin_board.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/admin/admin_board.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -74,7 +74,6 @@
 			'max_search_chars'	=> array('lang' => 'MAX_SEARCH_CHARS',	'type' => 'text:3:3', 'explain' => true),
 			'load_search_upd'	=> array('lang' => 'YES_SEARCH_UPDATE',	'type' => 'radio:yes_no', 'explain' => true),
 //			'load_search_phr'	=> array('lang' => 'YES_SEARCH_PHRASE',	'type' => 'radio:yes_no', 'explain' => true),
-			'load_tplcompile'	=> array('lang' => 'RECOMPILE_TEMPLATES', 'type' => 'radio:yes_no', 'explain' => true)
 		)
 	),
 	'default' => array(

Modified: trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- trunk/includes/forums/admin/admin_permissions.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/admin/admin_permissions.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -538,7 +538,7 @@
 			AND a.auth_option_id = o.auth_option_id
 			AND a.forum_id IN ($sql_forum_id)
 			AND u.user_id = a.user_id
-		ORDER BY u.username, u.user_regdate ASC";
+		ORDER BY u.username, u.user_reg_date ASC";
 	$result = $_CLASS['core_db']->query($sql);
 
 	$users = '';

Modified: trunk/includes/forums/bbcode.php
===================================================================
--- trunk/includes/forums/bbcode.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/bbcode.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -127,13 +127,11 @@
 	
 	function decode_php($text)
 	{
-		global $phpversion;
-
 		$text = trim($text);
 
 		$remove_tags = false;
 
-		$text = strtr($text, array_flip(get_html_translation_table(HTML_ENTITIES)));
+		//$text = strtr($text, array_flip(get_html_translation_table(HTML_ENTITIES)));
 
 		$str_from = array('&lt;', '&gt;', '&#39;');
 		$str_to = array('<', '>', '\'');
@@ -147,7 +145,7 @@
 		}
 
 
-		if ($phpversion < 420)
+		if (version_compare(PHP_VERSION, '4.2.0', '<'))
 		{
 			ob_start();
 			highlight_string($text);

Modified: trunk/includes/forums/functions.php
===================================================================
--- trunk/includes/forums/functions.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/functions.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -500,7 +500,8 @@
 }
 
 // Topic and forum watching common code
-function watch_topic_forum($mode, $user_id, $match_id, $notify_status = 'unset', $start = 0)
+//do we need user_id ?
+function watch_topic_forum($mode, $user_id, $forum_id, $topic_id, $notify_status = 'unset', $start = 0)
 {
 	global $_CLASS, $config, $_CORE_CONFIG;
 
@@ -509,8 +510,16 @@
 		return array('link' => '', 'title' => '', 'watching' => false);
 	}
 
-	$where_sql = ($mode == 'forum') ? 'forum_id' : 'topic_id';
-	$u_url = ($mode == 'forum') ? 'f' : 't';
+	if ($mode == 'forum')
+	{
+		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id = 0";
+		$url = 'f='.$forum_id;
+	}
+	else
+	{
+		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id IN ($topic_id, 0)";
+		$url = 't='.$topic_id;
+	}
 
 	$is_watching = false;
 
@@ -519,8 +528,8 @@
 		// Is user watching this thread?
 		$sql = 'SELECT notify_status
 			FROM '.FORUMS_WATCH_TABLE."
-			WHERE $where_sql = $match_id
-				AND user_id = $user_id";
+			 WHERE $where";
+
 		$result = $_CLASS['core_db']->query($sql);
 
 		$notify_status = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['notify_status'] : null;
@@ -535,28 +544,29 @@
 			{
 				$is_watching = true;
 
-				/*
+				// Remove all topics that are being watched, we watching the whole forum dude
 				if ($mode == 'forum')
 				{
 					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-						WHERE topic_id = $match_id
+						WHERE forum_id = $forum_id
 							AND user_id = $user_id";
 				
 					$_CLASS['core_db']->query($sql);
 				}
-				*/
 
 				$sql_array = array(
 					'user_id' => (int) $user_id,
-					$where_sql => (int) $match_id,
-					'notify_status' => 0
+					'forum_id' => $forum_id,
+					'topic_id' => $topic_id,
+					'notify_status' => 0,
+					'notify_type' => 0
 				);
 
 				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' '.$_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
 			}
 
-			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
-			//$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
+			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			//$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
 			//trigger_error($message);
 		}
 	}
@@ -568,15 +578,23 @@
 			{
 				$is_watching = false;
 
+				if ($mode == 'forum')
+				{
+					$where_delete = "forum_id = $forum_id AND topic_id = 0";
+				}
+				else
+				{
+					$where_delete = "forum_id = $forum_id AND topic_id = $topic_id";
+				}
+
 				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-					WHERE $where_sql = $match_id
-						AND user_id = $user_id";
+							WHERE user_id = $user_id AND $where_delete";
 
 				$_CLASS['core_db']->query($sql);
 			}
 
-			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;start=$start"));
-			//$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;" . $u_url . "=$match_id&amp;start=$start") . '">', '</a>');
+			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			//$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
 			//trigger_error($message);
 		}
 		else
@@ -587,8 +605,7 @@
 			{
 				$sql = 'UPDATE ' . FORUMS_WATCH_TABLE . "
 					SET notify_status = 0
-					WHERE $where_sql = $match_id
-						AND user_id = $user_id";
+					WHERE $where";
 				$_CLASS['core_db']->query($sql);
 			}
 		}
@@ -596,7 +613,7 @@
 
 	return array(
 			'watching' => true,
-			'link' => generate_link("Forums&amp;file=view$mode&amp;$u_url=$match_id&amp;" . (($is_watching) ? 'unwatch' : 'watch') . "=$mode&amp;start=$start"),
+			'link' => generate_link("Forums&amp;file=view$mode&amp;$url&amp;" . (($is_watching) ? 'unwatch' : 'watch') . "=$mode&amp;start=$start"),
 			'title' => $_CLASS['core_user']->lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
 	);
 }
@@ -664,10 +681,14 @@
 				{
 					foreach ($sql_insert as $forum_id)
 					{
-						$sql = 'INSERT INTO ' . FORUMS_TRACK_TABLE . ' (user_id, forum_id, mark_time)
-							VALUES (' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $time)";
+						$sql_ary = array(
+							'user_id'		=> $_CLASS['core_user']->data['user_id'],
+							'topic_id'		=> 0,
+							'forum_id'		=> $forum_id,
+							'mark_time'		=> $time
+						);
 
-						$_CLASS['core_db']->query($sql);
+						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 					}
 				}
 			}

Modified: trunk/includes/forums/functions_display.php
===================================================================
--- trunk/includes/forums/functions_display.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/functions_display.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -154,14 +154,12 @@
 			}
 		}
 
-		if (!isset($row['mark_time']))
+		if (!$config['load_db_lastread'] || !$_CLASS['core_user']->is_user)
 		{
-			$row['mark_time'] = 0;
+			$row['mark_time'] = isset($tracking_topics[$forum_id][0]) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
 		}
 
-		$mark_time_forum = ($config['load_db_lastread']) ? $row['mark_time'] : ((isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0);
-
-		if ($mark_time_forum < $row['forum_last_post_time'] && $_CLASS['core_user']->is_user)
+		if ($row['mark_time'] < $row['forum_last_post_time'])
 		{
 			$forum_unread[$parent_id] = true;
 		}

Modified: trunk/includes/forums/functions_posting.php
===================================================================
--- trunk/includes/forums/functions_posting.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/functions_posting.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -878,26 +878,42 @@
 		unset($ignore_array[$user_id]);
 	}
 
-	$processed = $update = array();
+	$processed = $delete_array = $update_array = array();
 
 	foreach ($holding as $user)
 	{
 		if (!in_array($user['user_id'], $ignore_array))
 		{
 			$processed[$user['template']][] = $user;
-			$update[$user['update']][] = $user['user_id'];
+			$update_array[$user['update']][] = $user['user_id'];
 		}
+		else
+		{
+			$delete_array[$user['update']] = $user['user_id'];
+		}
 	}
 	unset($holding, $ignore_array);
 
+	// Now delete the user_ids not authorized to receive notifications on this topic/forum
+	if (!empty($delete_array['topic']))
+	{
+		$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_WATCH_TABLE . "
+			WHERE topic_id = $topic_id
+				AND user_id IN (" . implode(', ', $delete_array['topic']) . ")");
+	}
+
+	if (!empty($delete_array['forum']))
+	{
+		$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_WATCH_TABLE . "
+			WHERE forum_id = $forum_id
+				AND user_id IN (" . implode(', ', $delete_array['forum']) . ")");
+	}
+
 	if (empty($processed))
 	{
 		return;
 	}
 
-	require_once($site_file_root.'includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
 	require_once($site_file_root.'includes/mailer.php');
@@ -916,7 +932,7 @@
 		$mailer->subject($_CLASS['core_user']->get_lang('FORUM_NOTIFICATION'));
 
 		$_CLASS['core_template']->assign_array(array(
-			'EMAIL_SIG'		=> '',
+			'EMAIL_SIG'		=> $email_sig,
 			'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 			'TOPIC_TITLE'	=> $topic_title,  
 			'FORUM_NAME'	=> $forum_name,
@@ -936,39 +952,22 @@
 
 	$_CLASS['core_db']->transaction();
 
-	if (!empty($update['topic']))
+	if (!empty($update_array['topic']))
 	{
 		$_CLASS['core_db']->query('UPDATE ' . FORUMS_WATCH_TABLE . "
 			SET notify_status = 1
 			WHERE topic_id = $topic_id
-				AND user_id IN (" . implode(', ', $update['topic']) . ")");
+				AND user_id IN (" . implode(', ', $update_array['topic']) . ")");
 	}
 
-	if (!empty($update['forum']))
+	if (!empty($update_array['forum']))
 	{
 		$_CLASS['core_db']->query('UPDATE ' . FORUMS_WATCH_TABLE . "
 			SET notify_status = 1
 			WHERE forum_id = $forum_id
-				AND user_id IN (" . implode(', ', $update['forum']) . ")");
+				AND user_id IN (" . implode(', ', $update_array['forum']) . ")");
 	}
 
-	// Now delete the user_ids not authorized to receive notifications on this topic/forum
-	/*
-	if (isset($delete_ids['topic']) && sizeof($delete_ids['topic']))
-	{
-		$_CLASS['core_db']->query('DELETE FROM ' . TOPICS_WATCH_TABLE . "
-			WHERE topic_id = $topic_id
-				AND user_id IN (" . implode(', ', $delete_ids['topic']) . ")");
-	}
-
-	if (isset($delete_ids['forum']) && sizeof($delete_ids['forum']))
-	{
-		$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_WATCH_TABLE . "
-			WHERE forum_id = $forum_id
-				AND user_id IN (" . implode(', ', $delete_ids['forum']) . ")");
-	}
-	*/
-
 	$_CLASS['core_db']->sql_transaction('commit');
 }
 

Modified: trunk/includes/forums/functions_privmsgs.php
===================================================================
--- trunk/includes/forums/functions_privmsgs.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/functions_privmsgs.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -113,7 +113,7 @@
 );
 
 // Get all folder
- function get_folder($user_id, &$folder, $folder_id = false)
+function get_folder($user_id, &$folder, $folder_id = false)
 {
 	global $_CLASS;
 
@@ -139,7 +139,8 @@
 	$_CLASS['core_db']->free_result($result);
 
 	// Make sure the default boxes are defined
-	foreach (array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX) as $default_folder)
+	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
+	foreach ($folder_array as $default_folder)
 	{
 		if (!isset($num_messages[$default_folder]))
 		{
@@ -194,8 +195,9 @@
 function clean_sentbox($num_sentbox_messages)
 {
 	global $_CLASS, $config;
-
-	$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
+// TEMP
+$_CLASS['core_user']->data['user_message_limit'] = isset($_CLASS['core_user']->data['user_message_limit']) ? $_CLASS['core_user']->data['user_message_limit'] : false;
+	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
 	
 	// Check Message Limit - 
 	if ($message_limit && $num_sentbox_messages > $message_limit)
@@ -289,7 +291,7 @@
 		$user_rules = $_CLASS['core_db']->fetch_row_assocset($result);
 		$_CLASS['core_db']->free_result($result);
 
-		if (sizeof($user_rules))
+		if (!empty($user_rules))
 		{
 			$sql = 'SELECT zebra_id, friend, foe
 				FROM ' . ZEBRA_TABLE . "
@@ -1091,8 +1093,6 @@
 		return;
 	}
 
-	$current_time = time();
-
 	// Collect some basic informations about which tables and which rows to update/insert
 	$sql_data = array();
 	$root_level = 0;
@@ -1163,7 +1163,7 @@
 				'author_id'			=> (int) $_CLASS['core_user']->data['user_id'],
 				'icon_id'			=> $data['icon_id'], 
 				'author_ip' 		=> $_CLASS['core_user']->ip,
-				'message_time'		=> $current_time,
+				'message_time'		=> $_CLASS['core_user']->time,
 				'enable_bbcode' 	=> $data['enable_bbcode'],
 				'enable_html' 		=> $data['enable_html'],
 				'enable_smilies' 	=> $data['enable_smilies'],
@@ -1183,7 +1183,7 @@
 		case 'edit':
 			$sql_data = array(
 				'icon_id'			=> $data['icon_id'],
-				'message_edit_time'	=> $current_time,
+				'message_edit_time'	=> $_CLASS['core_user']->time,
 				'enable_bbcode' 	=> $data['enable_bbcode'],
 				'enable_html' 		=> $data['enable_html'],
 				'enable_smilies' 	=> $data['enable_smilies'],
@@ -1196,12 +1196,12 @@
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid']
 			);
-			break;
+		break;
 	}
 
 	$_CLASS['core_db']->transaction();
 
-	if (sizeof($sql_data))
+	if (!empty($sql_data))
 	{
 		if ($mode == 'post' || $mode == 'reply' || $mode == 'quote' || $mode == 'forward')
 		{
@@ -1231,15 +1231,15 @@
 				'msg_id'	=> $data['msg_id'],
 				'user_id'	=> $user_id,
 				'author_id'	=> $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> PRIVMSGS_NO_BOX,
-				'new'		=> 1,
+				'folder_id'	=> PRIVMSGS_INBOX,
+				'msg_new'	=> 1,
 				'unread'	=> 1,
 				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
 			);
 		}
 
 		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1, user_last_privmsg = ' . time() . '
+			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
 			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
 		$_CLASS['core_db']->query($sql);
 
@@ -1251,7 +1251,7 @@
 				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
 				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
 				'folder_id'	=> PRIVMSGS_OUTBOX,
-				'new'		=> 0,
+				'msg_new'	=> 0,
 				'unread'	=> 0,
 				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
 			);
@@ -1262,13 +1262,13 @@
 	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
 	{
 		$sql = 'UPDATE ' . USERS_TABLE . "
-			SET user_lastpost_time = $current_time
+			SET user_last_post_time = {$_CLASS['core_user']->time}
 			WHERE user_id = " . $_CLASS['core_user']->data['user_id'];
 		$_CLASS['core_db']->query($sql);
 	}
 
 	// Submit Attachments
-	if (sizeof($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
+	if (!empty($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
 	{
 		$space_taken = $files_added = 0;
 
@@ -1309,7 +1309,7 @@
 			}
 		}
 		
-		if (sizeof($data['attachment_data']))
+		if (!empty($data['attachment_data']))
 		{
 			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
 				SET message_attachment = 1
@@ -1328,6 +1328,7 @@
 
 	// Delete draft if post was loaded...
 	$draft_id = request_var('draft_loaded', 0);
+
 	if ($draft_id)
 	{
 		$sql = 'DELETE FROM ' . DRAFTS_TABLE . " 
@@ -1349,7 +1350,7 @@
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
 	global $_CLASS, $config;
-
+return;
 	$subject = censor_text($subject);
 	
 	// Get banned User ID's

Modified: trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- trunk/includes/forums/mcp/mcp_topic.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/forums/mcp/mcp_topic.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -87,16 +87,16 @@
 	$posts_per_page = max(0, request_var('posts_per_page', intval($config['posts_per_page'])));
 
 	$sql = 'SELECT u.username, u.user_colour, p.*
-		FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 		WHERE ' . (($action == 'reports') ? 'p.post_reported = 1 AND ' : '') . "
 			p.topic_id = {$topic_id}
 			AND p.poster_id = u.user_id
 		ORDER BY $sort_order_sql";
-	$result = $_CLASS['core_db']->sql_query_limit($sql, $posts_per_page, $start);
+	$result = $_CLASS['core_db']->query_limit($sql, $posts_per_page, $start);
 
 	$rowset = array();
 	$bbcode_bitfield = 0;
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$rowset[] = $row;
 		$bbcode_bitfield |= $row['bbcode_bitfield'];
@@ -147,7 +147,7 @@
 			'MESSAGE'		=> $message,
 			'POST_ID'		=> $row['post_id'],
 
-			'MINI_POST_IMG' => ($row['post_time'] > $_CLASS['core_user']->data['user_lastvisit'] && $_CLASS['core_user']->data['is_registered']) ? $_CLASS['core_user']->img('icon_post_new', $_CLASS['core_user']->lang['NEW_POST']) : $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
+			'MINI_POST_IMG' => ($row['post_time'] > $_CLASS['core_user']->data['user_last_visit'] && $_CLASS['core_user']->is_user) ? $_CLASS['core_user']->img('icon_post_new', $_CLASS['core_user']->lang['NEW_POST']) : $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
 			
 			'S_CHECKBOX'		=> $s_checkbox,
 			'S_POST_REPORTED'	=> ($row['post_reported']) ? true : false,
@@ -323,11 +323,11 @@
 						$limit_time_sql
 					ORDER BY $sort_order_sql";
 			}
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 0, $start);
+			$result = $_CLASS['core_db']->query_limit($sql, 0, $start);
 
 			$store = false;
 			$post_id_list = array();
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				// If splitted from selected post (split_beyond), we split the unapproved items too.
 				if (!$row['post_approved'] && !$_CLASS['auth']->acl_get('m_approve', $row['forum_id']))

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/functions.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -707,7 +707,7 @@
 	
 	while ($file = readdir($handle))
 	{
-		if ($file{0} !== '.')
+		if (!mb_strpos($file, '.'))
 		{
 			if (file_exists($site_file_root."themes/$file/index.php"))
 			{
@@ -807,6 +807,21 @@
 	}
 }
 
+//this doesn't work, maybe we should just translate those that can affect the html layout ?
+function core_html_entity_decode($string, $quote_style = ENT_COMPAT)
+{
+	$holding = get_html_translation_table(HTML_ENTITIES, $quote_style);
+
+	foreach ($holding as $from => $to)
+	{
+		$translations[utf8_encode($to)] = utf8_encode($from);
+	}
+
+	unset($translations['&amp;Epsilon;']);
+	//????????????????, Magyarul
+	return strtr($string, $translations);
+}
+
 if (!function_exists('html_entity_decode'))
 {
 	//string html_entity_decode ( string string [, int quote_style [, string charset]] )

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/functions_user.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -146,11 +146,11 @@
 
 	$default_data = array(
 		'user_allow_viewonline' => 1,
-		'user_allow_viewemail' => 1,
-		'user_allow_massemail' => 1,
-		'user_new_privmsg' => 0,
-		'user_allow_pm' => 1,
-		'user_allow_email' => 1,
+		'user_allow_viewemail'	=> 1,
+		'user_allow_massemail'	=> 1,
+		'user_new_privmsg'		=> 0,
+		'user_allow_pm'			=> 1,
+		'user_allow_email'		=> 1,
 	);
 
 	$data = array_merge($default_data, $data);

Modified: trunk/includes/tables.php
===================================================================
--- trunk/includes/tables.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/tables.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,15 +1,25 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 // Well this needs some works
 if (!defined('VIPERAL'))
 {
@@ -20,6 +30,15 @@
 // User related
 define('ANONYMOUS', 1);
 
+// status settings
+define('STATUS_DISABLED', 0);
+define('STATUS_PENDING', 1);
+define('STATUS_ACTIVE', 2);
+define('STATUS_DELETING', 3);
+
+define('STATUS_NORMAL', 9);
+define('STATUS_LEADER', 10);
+
 define('USER_ACTIVATION_NONE', 0);
 define('USER_ACTIVATION_SELF', 1);
 define('USER_ACTIVATION_ADMIN', 2);
@@ -29,14 +48,13 @@
 define('AVATAR_REMOTE', 2);
 define('AVATAR_GALLERY', 3);
 
-define('USER_GUEST', 2);
-define('USER_NORMAL', 4);
-define('USER_BOT', 8);
+define('USER_GUEST', 0);
+define('USER_NORMAL', 1);
+define('USER_BOT', 2);
 
-define('USER_ACTIVE', 16);
-define('USER_INACTIVE', 32);
-define('USER_UNACTIVATED', 64);
-define('USER_FOUNDER', 128);
+define('USER_UNACTIVATED', 0);
+define('USER_ACTIVE', 1);
+define('USER_DISABLE', 2);
 
 define('ADMIN_NOT_LOGGED', 0);
 define('ADMIN_NOT_ADMIN', 1);
@@ -71,19 +89,14 @@
 define('ACL_YES', 1);
 define('ACL_UNSET', -1);
 
-// Group settings
-define('GROUP_OPEN', 0);
-define('GROUP_CLOSED', 1);
-define('GROUP_HIDDEN', 2);
-define('GROUP_SPECIAL', 3);
-define('GROUP_FREE', 4);
+define('GROUP_HIDDEN', 0);
+define('GROUP_SYSTEM', 1);
+define('GROUP_SPECIAL', 2);
+define('GROUP_REQUEST', 3);
+define('GROUP_CLOSED', 4);
+define('GROUP_UNRESTRAINED', 5);
 
-// status settings
-define('STATUS_PENDING', 0);
-define('STATUS_NORMAL', 1);
-define('STATUS_LEADER', 2);
 
-
 // Forum/Topic states
 define('FORUM_CAT', 0);
 define('FORUM_POST', 1);
@@ -158,76 +171,73 @@
 define('FIELD_DATE', 6);
 
 
-define('AUTH_ADMIN_TABLE', $prefix.'admins');
-define('BLOCKS_TABLE', $prefix.'blocks');
-define('USER_GROUP_TABLE', $prefix.'groups_users');
-define('CORE_CONFIG_TABLE', $prefix.'config');
+// Table names
+
+define('FORUMS_ACL_TABLE', $prefix.'forums_auth');
+define('FORUMS_ACL_OPTIONS_TABLE', $prefix.'forums_auth_options');
+//define('ACL_DEPS_TABLE', $prefix.'forums_auth_deps');
+define('FORUMS_ACL_PRESETS_TABLE', $prefix.'forums_auth_presets');
+
+define('FORUMS_ATTACHMENTS_TABLE', $prefix.'forums_attachments');
+define('FORUMS_BOOKMARKS_TABLE', $prefix.'forums_bookmarks');
+define('FORUMS_BBCODES_TABLE', $prefix.'forums_bbcodes');
+define('FORUMS_CONFIG_TABLE', $prefix.'forums_config');
+define('FORUMS_DRAFTS_TABLE', $prefix.'forums_drafts');
+define('FORUMS_FORUMS_TABLE', $prefix.'forums_forums');
+define('FORUMS_ACCESS_TABLE', $prefix.'forums_access');
+define('FORUMS_ICONS_TABLE', $prefix.'forums_icons');
+define('FORUMS_LOG_TABLE', $prefix.'forums_log');
+define('FORUMS_MODERATOR_TABLE', $prefix.'forums_moderator_cache');
+define('FORUMS_MODULES_TABLE', $prefix . 'forums_modules');
+define('FORUMS_POSTS_TABLE', $prefix.'forums_posts');
+define('FORUMS_PRIVMSGS_TABLE', $prefix.'forums_privmsgs');
+define('FORUMS_PRIVMSGS_TO_TABLE', $prefix.'forums_privmsgs_to');
+define('FORUMS_PRIVMSGS_FOLDER_TABLE', $prefix.'forums_privmsgs_folder');
+define('FORUMS_PRIVMSGS_RULES_TABLE', $prefix.'forums_privmsgs_rules');
+define('FORUMS_REPORTS_TABLE', $prefix.'forums_reports');
+define('FORUMS_REASONS_TABLE', $prefix.'forums_reports_reasons');
+define('FORUMS_SEARCH_TABLE', $prefix.'forums_search_results');
+define('FORUMS_SEARCH_WORD_TABLE', $prefix.'forums_search_wordlist');
+define('FORUMS_SEARCH_MATCH_TABLE', $prefix.'forums_search_wordmatch');
+define('FORUMS_TOPICS_TABLE', $prefix.'forums_topics');
+define('FORUMS_POLL_OPTIONS_TABLE', $prefix.'forums_poll_results');
+define('FORUMS_POLL_VOTES_TABLE', $prefix.'forums_poll_voters');
+define('FORUMS_WORDS_TABLE', $prefix.'forums_words');
+define('FORUMS_WATCH_TABLE', $prefix.'forums_watch');
+define('FORUMS_TRACK_TABLE', $prefix.'forums_tracking');
+define('FORUMS_RANKS_TABLE', $prefix.'forums_ranks');
+
+
+define('ADMIN_AUTH_TABLE', 'test_admins');
+
+define('BLOCKS_TABLE', 'test_blocks');
+
+define('CORE_CONFIG_TABLE', 'test_config');
 define('CORE_MODULES_TABLE', $prefix.'modules');
 
+define('SMILIES_TABLE', 'test_smilies');
 
-// Table names
-//define('ACL_GROUPS_TABLE', $prefix.'forums_auth_groups');
-define('ACL_TABLE', $prefix.'forums_auth');
+define('USER_GROUP_TABLE', 'test_groups_members');
+define('GROUPS_TABLE', 'test_groups');
 
-define('ACL_OPTIONS_TABLE', $prefix.'forums_auth_options');
-define('ACL_DEPS_TABLE', $prefix.'forums_auth_deps');
-define('ACL_PRESETS_TABLE', $prefix.'forums_auth_presets');
-//define('ACL_USERS_TABLE', $prefix.'forums_auth_users');
-define('ATTACHMENTS_TABLE', $prefix.'forums_attachments');
-define('BANLIST_TABLE', $prefix.'forums_banlist');
-define('BBCODES_TABLE', $prefix.'forums_bbcodes');
-define('BOOKMARKS_TABLE', $prefix.'forums_bookmarks');
-define('BOTS_TABLE', $prefix.'forums_bots');
-define('CACHE_TABLE', $prefix.'forums_cache');
-define('CONFIG_TABLE', $prefix.'forums_config');
-define('CONFIRM_TABLE', $prefix.'forums_confirm');
-define('PROFILE_FIELDS_TABLE', $prefix.'forums_profile_fields');
-define('PROFILE_LANG_TABLE', $prefix.'forums_profile_lang');
-define('PROFILE_DATA_TABLE', $prefix.'forums_profile_fields_data');
-define('PROFILE_FIELDS_LANG_TABLE', $prefix.'forums_profile_fields_lang');
-define('DISALLOW_TABLE', $prefix.'forums_disallow');
-define('DRAFTS_TABLE', $prefix.'forums_drafts');
+define('SESSIONS_AUTOLOGIN_TABLE', 'test_sessions_auto_login');
+define('SESSIONS_TABLE', $prefix.'sessions');
+
+
 define('EXTENSIONS_TABLE', $prefix.'forums_extensions');
 define('EXTENSION_GROUPS_TABLE', $prefix.'forums_extension_groups');
-define('FORUMS_TABLE', $prefix.'forums_forums');
-define('FORUMS_ACCESS_TABLE', $prefix.'forums_access');
-define('GROUPS_TABLE', $prefix.'groups');
-define('ICONS_TABLE', $prefix.'forums_icons');
-define('LANG_TABLE', $prefix.'forums_lang');
-define('LOG_TABLE', $prefix.'forums_log');
-define('MODERATOR_TABLE', $prefix.'forums_moderator_cache');
-define('MODULES_TABLE', $prefix . 'forums_modules');
-define('POSTS_TABLE', $prefix.'forums_posts');
-define('PRIVMSGS_TABLE', $prefix.'forums_privmsgs');
-define('PRIVMSGS_TO_TABLE', $prefix.'forums_privmsgs_to');
-define('PRIVMSGS_FOLDER_TABLE', $prefix.'forums_privmsgs_folder');
-define('PRIVMSGS_RULES_TABLE', $prefix.'forums_privmsgs_rules');
-define('RANKS_TABLE', $prefix.'forums_ranks');
-define('RATINGS_TABLE', $prefix.'forums_ratings');
-define('REPORTS_TABLE', $prefix.'forums_reports');
-define('REASONS_TABLE', $prefix.'forums_reports_reasons');
-define('SEARCH_TABLE', $prefix.'forums_search_results');
-define('SEARCH_WORD_TABLE', $prefix.'forums_search_wordlist');
-define('SEARCH_MATCH_TABLE', $prefix.'forums_search_wordmatch');
-define('SESSIONS_TABLE', $prefix.'sessions');
-define('SITELIST_TABLE', $prefix.'forums_sitelist');
-define('SMILIES_TABLE', $prefix.'smilies');
-define('STYLES_TABLE', $prefix.'forums_styles');
-define('STYLES_TPL_TABLE', $prefix.'forums_styles_template');
-define('STYLES_TPLDATA_TABLE', $prefix.'forums_styles_template_data');
-define('STYLES_CSS_TABLE', $prefix.'forums_styles_theme');
-define('STYLES_IMAGE_TABLE', $prefix.'forums_styles_imageset');
-define('TOPICS_TABLE', $prefix.'forums_topics');
+
 define('USERS_TABLE', $prefix.'users');
 define('USERS_NOTES_TABLE', $prefix.'forums_users_notes');
-define('WORDS_TABLE', $prefix.'forums_words');
-define('POLL_OPTIONS_TABLE', $prefix.'forums_poll_results');
-define('POLL_VOTES_TABLE', $prefix.'forums_poll_voters');
 define('ZEBRA_TABLE', $prefix.'forums_zebra');
+//define('LOG_TABLE', $prefix.'log');
 
-//define('TOPICS_WATCH_TABLE', $prefix.'forums_topics_watch');
 
-define('FORUMS_WATCH_TABLE', $prefix.'forums_watch');
-define('FORUMS_TRACK_TABLE', $prefix.'forums_tracking');
+// can be removed
+define('PROFILE_FIELDS_TABLE', $prefix.'forums_profile_fields');
+define('PROFILE_LANG_TABLE', $prefix.'forums_profile_lang');
+define('PROFILE_DATA_TABLE', $prefix.'forums_profile_fields_data');
+define('PROFILE_FIELDS_LANG_TABLE', $prefix.'forums_profile_fields_lang');
+define('DISALLOW_TABLE', $prefix.'forums_disallow');
 
 ?>
\ No newline at end of file

Modified: trunk/includes/templates/admin/blocks/edit.html
===================================================================
--- trunk/includes/templates/admin/blocks/edit.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/admin/blocks/edit.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -27,7 +27,7 @@
 			</tr>
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
-				<td class="row2" colspan="2"><input type="radio" name="b_active" value="1"<!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF -->/><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="b_active" value="0"<!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF -->/><span class="genmed">{ $L_NO }</span></td>
+				<td class="row2" colspan="2"><input type="radio" name="b_active" value="2"<!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF -->/><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="b_active" value="0"<!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF -->/><span class="genmed">{ $L_NO }</span></td>
 			</tr>
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>

Modified: trunk/includes/templates/admin/messages/edit.html
===================================================================
--- trunk/includes/templates/admin/messages/edit.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/admin/messages/edit.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -29,7 +29,7 @@
 			</tr>
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
-				<td class="row2" colspan="2"><input name="active" value="1" <!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="active" value="0" <!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+				<td class="row2" colspan="2"><input name="active" value="2" <!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="active" value="0" <!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
 			</tr>
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_POSITION }: </b></td>

Modified: trunk/includes/templates/admin/system/index.html
===================================================================
--- trunk/includes/templates/admin/system/index.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/admin/system/index.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -53,9 +53,7 @@
 			<td class="row1" width="50%"><b>{ $L_DEFAULT_THEME }: </b></td>
 			<td class="row2">
 				<select name="default_theme">
-				<!-- LOOP $site_theme -->
-					<option value="{ $site_theme:FILE }" <!-- IF { $site_theme:FILE } == { $DEFAULT_THEME } --> selected="selected" <!-- ENDIF -->> { $site_theme:NAME }</option>
-				<!-- ENDLOOP -->
+					{ $SELECT_THEME }
 				</select>
 			</td>
 		</tr>
@@ -92,29 +90,27 @@
 		<tr>
 			<th colspan="2">Server Settings</th>
 		</tr>
-	
 		<tr>
 			<td class="row1" width="50%"><b>Domain Name: </b><br><span class="gensmall">The domain name this board runs from</span></td>
 			<td class="row2"><input class="post" size="40" maxlength="255" name="site_domain" value="{ $SITE_DOMAIN }" type="text"></td>
 		</tr>
-	
-	
 		<tr>
 			<td class="row1" width="50%"><b>Server Port: </b><br><span class="gensmall">The port your server is running on, usually 80, only change if different</span></td>
 			<td class="row2"><input class="post" size="5" maxlength="5" name="site_port" value="{ $SITE_PORT }" type="text"></td>
 		</tr>
-	
-	
 		<tr>
 			<td class="row1" width="50%"><b>Script path: </b><br><span class="gensmall">Site located relative to the domain name</span></td>
 	
 			<td class="row2"><input class="post" maxlength="255" name="site_path" value="{ $SITE_PATH }" type="text"></td>
 		</tr>
-	
-	
 		<tr>
+			<td class="row1" width="50%"><b>{ $L_SITE_SECURE }: </b><br><span class="gensmall">{ $L_COOKIE_SECURE_EXPLAIN }</span></td>
+			<td class="row2"><input name="site_secure" value="0" <!-- IF !{ $SITE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Disabled&nbsp;&nbsp;<input name="site_secure" value="1" <!-- IF { $SITE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Enabled</td>
+		</tr>
+
+		<tr>
 			<td class="row1" width="50%"><b>Session IP validation: </b><br><span class="gensmall">Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.</span></td>
-			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } == 0 --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
+			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
 	
 		</tr>
 		<tr>
@@ -157,12 +153,7 @@
 	
 			<td class="row2"><input class="post" maxlength="255" name="cookie_path" value="{ $COOKIE_PATH }" type="text"></td>
 		</tr>
-	
-	
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_COOKIE_SECURE }: </b><br><span class="gensmall">{ $L_COOKIE_SECURE_EXPLAIN }</span></td>
-			<td class="row2"><input name="cookie_secure" value="0" <!-- IF !{ $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Disabled&nbsp;&nbsp;<input name="cookie_secure" value="1" <!-- IF { $COOKIE_SECURE } --> checked="checked" <!-- ENDIF --> type="radio">Enabled</td>
-		</tr>
+
 		<script type="text/javascript">
 			  Calendar.setup(
 				{
@@ -171,75 +162,9 @@
 				}
 			  );
 		</script>
-	<!-- ELSEIF { $SYSTEM_MODE } == 'users' -->
-		<tr>
-			<th colspan="2">{ $L_USER_OPTIONS }</th>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_ACC_ACTIVATION }: </b><br><span class="gensmall">{ $L_ACC_ACTIVATION_EXPLAIN }</span></td>
-	
-			<td class="row2">
-			<!-- LOOP $A_ACC_OPTION -->
-				<input name="require_activation" value="{$A_ACC_OPTION:OPTION}" <!-- IF { $A_ACC_OPTION:OPTION } == { $ACTIVATION_OPTION } --> checked="checked" <!-- ENDIF --> type="radio"> {$A_ACC_OPTION:LANG}&nbsp;&nbsp;
-			<!-- ENDLOOP -->
-			</td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_ENABLE_COPPA }: </b><br><span class="gensmall">{ $L_ENABLE_COPPA_EXPLAIN }</span></td>
-	
-			<td class="row2"><input name="coppa_enable" value="1" <!-- IF { $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="coppa_enable" value="0" <!-- IF !{ $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_COPPA_FAX }: </b></td>
-			<td class="row2"><input class="post" size="25" maxlength="100" name="coppa_fax" value="{ $COPPA_FAX }" type="text"></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_COPPA_MAIL }: </b><br><span class="gensmall">{ $L_COPPA_MAIL_EXPLAIN }</span></td>
-			<td class="row2"><textarea name="coppa_mail" rows="5" cols="40">{ $COPPA_MAIL }</textarea></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_VISUAL_CONFIRM }: </b><br><span class="gensmall">{ $L_VISUAL_CONFIRM_EXPLAIN }</span></td>
-	
-			<td class="row2"><input name="enable_confirm" value="1" <!-- IF { $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="enable_confirm" value="0" <!-- IF !{ $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_REG_LIMIT }: </b><br><span class="gensmall">{ $L_REG_LIMIT_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" size="4" maxlength="4" name="max_reg_attempts" value="{ $MAX_REG_ATTEMPTS }" type="text"></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_USERNAME_LENGTH }: </b><br><span class="gensmall">{ $L_USERNAME_LENGTH_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" size="3" maxlength="3" name="min_name_chars" value="{ $MIN_NAME_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_name_chars" value="{ $MAX_NAME_CHARS }" type="text"> Max</td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_USERNAME_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
-			<td class="row2"><select name="allow_name_chars"><option value=".*" <!-- IF { $ALLOW_NAME_CHARS } == '.*' --> selected="selected" <!-- ENDIF -->>Any character</option><option value="[\w]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric only</option><option value="[\w_\+\. \-\[\]]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w_\+\. \-\[\]]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric and spacers</option></select></td>
-		</tr>
-		<tr>
-	
-			<td class="row1" width="50%"><b>{ $L_PASSWORD_LENGTH }: </b><br><span class="gensmall">{ $L_PASSWORD_LENGTH_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" size="3" maxlength="3" name="min_pass_chars" value="{ $MIN_PASS_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_pass_chars" value="{ $MAX_PASS_CHARS }" type="text"> Max</td>
-		</tr>
-	
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_PASSWORD_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
-			<td class="row2"><select name="pass_complex"><option value=".*">No requirements</option><option value="[a-zA-Z]">Must be mixed case</option><option value="[a-zA-Z0-9]">Must contain alphanumerics</option><option value="[a-zA-Z\W]">Must contain symbols</option></select></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_FORCE_PASS_CHANGE }: </b><br><span class="gensmall">{ $L_FORCE_PASS_CHANGE_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" size="3" maxlength="3" name="chg_passforce" value="{ $CHG_PASSFORCE }" type="text"></td>
-	
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_ALLOW_EMAIL_REUSE }: </b><br><span class="gensmall">{ $L_ALLOW_EMAIL_REUSE_EXPLAIN }</span></td>
-			<td class="row2"><input name="allow_emailreuse" value="1" <!-- IF { $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_emailreuse" value="0" <!-- IF !{ $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_ALLOW_NAME_CHANGE }: </b></td>
-			<td class="row2"><input name="allow_namechange" value="1" <!-- IF { $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_namechange" value="0" <!-- IF !{ $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
-		</tr>
 	<!-- ENDIF -->
 		<tr>
-			<td class="cat" colspan="2" align="center"><input name="submit" value="Submit" class="btnmain" type="submit">&nbsp;&nbsp;<input value="Reset" class="button" type="reset"></td>
+			<td class="cat" colspan="2" align="center"><input name="submit" value="Submit" class="button" type="submit">&nbsp;&nbsp;<input value="Reset" class="button" type="reset"></td>
 		</tr>
 	</tbody>
 	</table>

Modified: trunk/includes/templates/admin/users/header.html
===================================================================
--- trunk/includes/templates/admin/users/header.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/admin/users/header.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -78,6 +78,11 @@
 								<a href="{ $LINK_ADD_USER }" title="{ $L_VIEW_BOTS }">{ $L_ADD_USER }</a>
 							</td>
 						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $LINK_SETTINGS }'; return false;">
+								<a href="{ $LINK_SETTINGS }" title="{ $L_SETTINGS }">{ $L_SETTINGS }</a>
+							</td>
+						</tr>
 					</tbody>
 				</table>
 			</td>

Added: trunk/includes/templates/admin/users/setting.html
===================================================================
--- trunk/includes/templates/admin/users/setting.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/admin/users/setting.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,84 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<!-- INCLUDE admin/users/header.html -->
+<form method="post" action="{ $S_ACTION }">
+	<table class="tablebg" cellspacing="1" cellpadding="4" width="100%">
+		<tr>
+			<th colspan="2">{ $L_USER_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ACC_ACTIVATION }: </b><br><span class="gensmall">{ $L_ACC_ACTIVATION_EXPLAIN }</span></td>
+	
+			<td class="row2">
+			<!-- LOOP $A_ACC_OPTION -->
+				<input name="activation" value="{$A_ACC_OPTION:OPTION}" <!-- IF { $A_ACC_OPTION:OPTION } == { $ACTIVATION_OPTION } --> checked="checked" <!-- ENDIF --> type="radio"> {$A_ACC_OPTION:LANG}&nbsp;&nbsp;
+			<!-- ENDLOOP -->
+			</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ENABLE_COPPA }: </b><br><span class="gensmall">{ $L_ENABLE_COPPA_EXPLAIN }</span></td>
+	
+			<td class="row2"><input name="coppa_enable" value="1" <!-- IF { $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="coppa_enable" value="0" <!-- IF !{ $COPPA_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COPPA_FAX }: </b></td>
+			<td class="row2"><input class="post" size="25" maxlength="100" name="coppa_fax" value="{ $COPPA_FAX }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_COPPA_MAIL }: </b><br><span class="gensmall">{ $L_COPPA_MAIL_EXPLAIN }</span></td>
+			<td class="row2"><textarea name="coppa_mail" rows="5" cols="40">{ $COPPA_MAIL }</textarea></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_VISUAL_CONFIRM }: </b><br><span class="gensmall">{ $L_VISUAL_CONFIRM_EXPLAIN }</span></td>
+	
+			<td class="row2"><input name="enable_confirm" value="1" <!-- IF { $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="enable_confirm" value="0" <!-- IF !{ $CONFIRM_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_REG_LIMIT }: </b><br><span class="gensmall">{ $L_REG_LIMIT_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="4" maxlength="4" name="max_reg_attempts" value="{ $MAX_REG_ATTEMPTS }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_USERNAME_LENGTH }: </b><br><span class="gensmall">{ $L_USERNAME_LENGTH_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="min_name_chars" value="{ $MIN_NAME_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_name_chars" value="{ $MAX_NAME_CHARS }" type="text"> Max</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_USERNAME_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
+			<td class="row2"><select name="allow_name_chars"><option value=".*" <!-- IF { $ALLOW_NAME_CHARS } == '.*' --> selected="selected" <!-- ENDIF -->>Any character</option><option value="[\w]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric only</option><option value="[\w_\+\. \-\[\]]+" <!-- IF { $ALLOW_NAME_CHARS } == '[\w_\+\. \-\[\]]+' --> selected="selected" <!-- ENDIF -->>Alphanumeric and spacers</option></select></td>
+		</tr>
+		<tr>
+	
+			<td class="row1" width="50%"><b>{ $L_PASSWORD_LENGTH }: </b><br><span class="gensmall">{ $L_PASSWORD_LENGTH_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="min_pass_chars" value="{ $MIN_PASS_CHARS }" type="text"> Min&nbsp;&nbsp;<input class="post" size="3" maxlength="3" name="max_pass_chars" value="{ $MAX_PASS_CHARS }" type="text"> Max</td>
+		</tr>
+	
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_PASSWORD_CHARS }: </b><br><span class="gensmall">{ $L_USERNAME_CHARS_EXPLAIN }</span></td>
+			<td class="row2"><select name="pass_complex"><option value=".*">No requirements</option><option value="[a-zA-Z]">Must be mixed case</option><option value="[a-zA-Z0-9]">Must contain alphanumerics</option><option value="[a-zA-Z\W]">Must contain symbols</option></select></td>
+		</tr>
+<!--
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_FORCE_PASS_CHANGE }: </b><br><span class="gensmall">{ $L_FORCE_PASS_CHANGE_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" size="3" maxlength="3" name="chg_passforce" value="{ $CHG_PASSFORCE }" type="text"></td>
+	
+		</tr>
+
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ALLOW_EMAIL_REUSE }: </b><br><span class="gensmall">{ $L_ALLOW_EMAIL_REUSE_EXPLAIN }</span></td>
+			<td class="row2"><input name="allow_emailreuse" value="1" <!-- IF { $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_emailreuse" value="0" <!-- IF !{ $ALLOW_EMAILREUSE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_ALLOW_NAME_CHANGE }: </b></td>
+			<td class="row2"><input name="allow_namechange" value="1" <!-- IF { $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF -->  type="radio">{ $L_YES }&nbsp;&nbsp;<input name="allow_namechange" value="0" <!-- IF !{ $ALLOW_NAMECHANGE } --> checked="checked" <!-- ENDIF --> type="radio">No</td>
+		</tr>
+--!>
+		<tr>
+			<td class="cat" colspan="2" align="center"><input name="submit" value="Submit" class="button" type="submit">&nbsp;&nbsp;<input value="Reset" class="button" type="reset"></td>
+		</tr>
+	</table>
+</form>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/confirmation.html
===================================================================
--- trunk/includes/templates/confirmation.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/confirmation.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -2,7 +2,7 @@
 
 { $A_TABLE_OPEN }
 
-<form action="" method="post">
+<form action="{ $CONFIRM_ACTION }" method="post">
 	<table class="tablebg" border="0" cellpadding="0" cellspacing="1" width="100%">
 		<tbody>
 			<tr>

Modified: trunk/includes/templates/modules/Contact/email/index.html
===================================================================
--- trunk/includes/templates/modules/Contact/email/index.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Contact/email/index.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -2,8 +2,8 @@
 <br/>
 <br/>
 <center>
-	{ $L_SENT_FROM }{ $SENT_FROM }<br>
-	{ $L_SENDER_NAME }{ $SENDER_NAME }<br>
-	{ $L_SENDER_EMAIL }{ $SENDER_EMAIL }<br>
-	{ $L_SENDER_IP }{ $SENDER_IP }<br>
+	{ $L_SENT_FROM }: { $SENT_FROM }<br>
+	{ $L_SENDER_NAME }: { $SENDER_NAME }<br>
+	{ $L_SENDER_EMAIL }: { $SENDER_EMAIL }<br>
+	{ $L_SENDER_IP }: { $SENDER_IP }<br>
 </center>
\ No newline at end of file

Modified: trunk/includes/templates/modules/Contact/index.html
===================================================================
--- trunk/includes/templates/modules/Contact/index.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Contact/index.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,5 +1,5 @@
+<!-- DISPLAY_HEADER -->
 
-
 { $A_TABLE_OPEN }
 
 <form method="post" action="{ $ACTION }" >
@@ -27,7 +27,7 @@
     </table>
 </form>
 
-<!-- IF { $PREVIEW } -->
+<!-- IF isset({ $PREVIEW }) -->
 <table width="100%">
 	<tr>
 		<td style="padding: 10px;" width="30%" valign="top">
@@ -41,4 +41,6 @@
 </table>
 <!-- ENDIF -->
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -21,7 +21,7 @@
 	<!-- LOOP $leader -->
 	<tr>
 		<td class="row1"><b class="genmed"><a href="{ $leader:U_VIEW_GROUP }">{ $leader:GROUP_NAME }</a></b><!-- IF { $leader:GROUP_DESC } --><p class="forumdesc">{ $leader:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $leader:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
 
@@ -45,7 +45,7 @@
 	<!-- LOOP $pending -->
 	<tr>
 		<td class="row1"><b class="genmed"><a href="{ $pending:U_VIEW_GROUP }">{ $pending:GROUP_NAME }</a></b><!-- IF { $pending:GROUP_DESC } --><p class="forumdesc">{ $pending:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $pending:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
 	
@@ -57,11 +57,11 @@
 	<!-- LOOP $nonmember -->
 	<tr>
 		<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
+		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $nonmember:GROUP_ID }" /><!-- ENDIF --></td>
 	</tr>
 	<!-- ENDLOOP -->
 	<tr>
-		<td class="cat" colspan="3"></div><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="join">Join marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="btnmain" type="submit" name="submit" value="{$L_SUBMIT}" />&nbsp;</div></td>
+		<td class="cat" colspan="3"></div><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="apply">Apply marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="btnmain" type="submit" name="submit" value="{$L_SUBMIT}" />&nbsp;</div></td>
 	</tr>
 </table>
 

Modified: trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -13,12 +13,12 @@
 		<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_IMAGE }: </b><br /><span class="gensmall">{ $L_AVATAR_EXPLAIN }</span></td>
 		<td class="row2" align="center"><br /><!-- IF { $AVATAR } -->{$AVATAR}<!-- ELSE --><img src="{ $T_THEME_PATH }/images/no_avatar.gif" alt="" /><!-- ENDIF --><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall">{ $L_DELETE_AVATAR }</span></td>
 	</tr>
-	<!-- IF { $S_UPLOAD_AVATAR_FILE } -->
+<!-- IF !isset({ $S_DISPLAY_GALLERY }) -->
+	<!-- IF { $S_CAN_UPLOAD } -->
 	<tr> 
 		<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_FILE }: </b></td>
 		<td class="row2"><input type="hidden" name="MAX_FILE_SIZE" value="{ $AVATAR_SIZE }" /><input class="post" type="file" name="uploadfile" /></td>
 	</tr>
-	<!-- ENDIF --><!-- IF { $S_UPLOAD_AVATAR_URL } -->
 	<tr> 
 		<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_URL }: </b><br /><span class="gensmall">{ $L_UPLOAD_AVATAR_URL_EXPLAIN }</span></td>
 		<td class="row2"><input class="post" type="text" name="uploadurl" size="40" value="" /></td>
@@ -37,7 +37,8 @@
 		<td class="row1" width="35%"><b class="genmed">{ $L_AVATAR_GALLERY }: </b></td>
 		<td class="row2"><input class="btnlite" type="submit" name="display_gallery" value="{ $L_DISPLAY_GALLERY }" /></td>
 	</tr>
-	<!-- ENDIF --><!-- IF isset({ $S_DISPLAY_GALLERY }) -->
+	<!-- ENDIF -->
+<!-- ELSE -->
 	<tr> 
 		<th colspan="2">{ $L_AVATAR_GALLERY }</th>
 	</tr>
@@ -49,7 +50,7 @@
 		<table cellspacing="1" cellpadding="4" border="0" width="100%">
 			<!-- LOOP $avatar --><!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --></tr><tr><!-- ENDIF -->
 				<td align="center"><img src="{ $avatar:AVATAR_IMAGE }" alt="{ $avatar:AVATAR_NAME }" title="{ $avatar:AVATAR_NAME }" /><br/>
-				<input type="radio" name="avatarselect" value="{ $avatar:S_OPTIONS_AVATAR }" /></td>
+				<input type="radio" name="avatarselect" value="{ $avatar:AVATAR_FILE }" /></td>
 			<!-- LOOPELSE -->
 			<tr>
 				<td align="center"><b class="gen">{ $L_NO_GALLERY_AVATAR }</b></td>

Modified: trunk/includes/templates/modules/Control_Panel/ucp_register.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_register.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Control_Panel/ucp_register.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -39,8 +39,8 @@
 			<td class="row2"><input class="post" type="text"  name="email_confirm" size="25" maxlength="255" value="{ $EMAIL_CONFIRM }" /></td>
 		</tr>
 		<tr> 
-			<td class="row1"><b class="genmed">{ $L_NEW_PASSWORD }: </b><br /><span class="gensmall">{ $L_NEW_PASSWORD_EXPLAIN }</span></td>
-			<td class="row2"><input class="post" type="password" name="new_password" size="25" maxlength="100" value="{ $PASSWORD }" /></td>
+			<td class="row1"><b class="genmed">{ $L_PASSWORD }: </b><br /><span class="gensmall">{ $L_PASSWORD_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" type="password" name="password" size="25" maxlength="100" value="{ $PASSWORD }" /></td>
 		</tr>
 		<tr> 
 			<td class="row1"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b></td>
@@ -54,7 +54,7 @@
 		-->
 		<tr> 
 			<td class="row1"><b class="genmed">{ $L_TIMEZONE }: </b></td>
-			<td class="row2"><select name="tz">{ $S_TZ_OPTIONS }</select></td>
+			<td class="row2"><select name="tz">{ $SELECT_TZ }</select></td>
 		</tr>
 		<!-- IF { $CONFIRM_IMG } -->
 		<tr> 

Modified: trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html
===================================================================
--- trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,125 +1,74 @@
-???{if $S_SHOW_PM_BOX && $S_POST_ACTION }
-	<form action="{$S_POST_ACTION}" method="post" name="post"{$S_FORM_ENCTYPE}>
-	<table class="tablebg" width="100%" cellspacing="1">
-		<tr>
-			<th>{$L_PM_TO}</th>
-		</tr>
-		<tr>
-			<td class="row1"><b class="genmed">{$L_USERNAME}:</b></td>
-		</tr>
-		<tr>
-			<td class="row2"><input class="post" type="text" name="username" size="20" maxlength="40" value="" />&nbsp;<input class="post" type="submit" name="add_to" value="{$L_ADD}" /></td>
-		</tr>
-	{if $S_ALLOW_MASS_PM }
-		<tr>
-			<td class="row1"><b class="genmed">{$L_USERNAMES}:</b></td>
-		</tr>
-		<tr>
-			<td class="row2"><textarea name="username_list" rows="5" cols="22"></textarea><br />
-				<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-					<li>&#187; <a href="{$U_SEARCH_USER}" onclick="window.open('{$U_SEARCH_USER}', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false">{$L_FIND_USERNAME}</a></li>
-				</ul>
-			</td>
-		</tr>
-	{ /if }
-	{if $S_GROUP_OPTIONS }
-		<tr>
-			<td class="row1"><b class="genmed">{$L_USERGROUPS}:</b></td>
-		</tr>
-		<tr>
-			<td class="row2"><select name="group_list[]" multiple="true" size="5" style="width:150px">{$S_GROUP_OPTIONS}</select></td>
-		</tr>
-	{ /if }
-	{if $S_ALLOW_MASS_PM }
-		<tr>
-			<td class="row1"><div style="float:left">&nbsp;<input class="post" type="submit" name="add_bcc" value="{$L_ADD_BCC}" />&nbsp;</div><div style="float:right">&nbsp;<input class="post" type="submit" name="add_to" value="{$L_ADD_TO}" />&nbsp;</div></td>
-		</tr>
-	{ /if }
-	</table>
-	<div style="padding: 2px;"></div>
-{ /if }
-
-<table class="tablebg" width="100%" cellspacing="1">
+???<table class="tablebg" width="100%" cellspacing="1">
 	<tr>
-		<th>{$L_OPTIONS}</th>
+		<th>{ $L_OPTIONS }</th>
 	</tr>
-	{section name=ucp_sectionloop loop=$ucp_section}
+	<!-- LOOP $ucp_section -->
 	<tr>
-		{ if $ucp_section[ucp_sectionloop].S_SELECTED }
-		<td class="row1"><b class="nav">{$ucp_section[ucp_sectionloop].L_TITLE}</b>
-
+		<!-- IF { $ucp_section:S_SELECTED } -->
+		<td class="row1"><b class="nav">{ $ucp_section:L_TITLE }</b>
 			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			{section name=ucp_subsectionloop loop=$ucp_subsection}
-			<li>&#187; { if $ucp_subsection[ucp_subsectionloop].S_SELECTED }<b>{$ucp_subsection[ucp_subsectionloop].L_TITLE}</b>{ else }<a href="{$ucp_subsection[ucp_subsectionloop].U_TITLE}">{$ucp_subsection[ucp_subsectionloop].L_TITLE}</a>{ /if }</li>
-			{ /section }
+			<!-- LOOP $ucp_subsection -->
+			<li>&#187; <!-- IF { $ucp_subsection:S_SELECTED } --><b>{ $ucp_subsection:L_TITLE }</b><!-- ELSE --><a href="{$ucp_subsection:U_TITLE}">{ $ucp_subsection:L_TITLE }</a><!-- ENDIF --></li>
+			<!-- ENDLOOP $ucp_subsection -->
 			</ul>
-
-		{ else }
-		<td class="row2" nowrap="nowrap" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{$ucp_section[ucp_sectionloop].U_TITLE}'"><a class="nav" href="{$ucp_section[ucp_sectionloop].U_TITLE}">{$ucp_section[ucp_sectionloop].L_TITLE}</a>
-		{ /if }
+		<!-- ELSE -->
+		<td class="row2" nowrap="nowrap" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $ucp_section:U_TITLE }'"><a class="nav" href="{ $ucp_section:U_TITLE }">{ $ucp_section:L_TITLE }</a>
+		<!-- ENDIF -->
 		</td>
 	</tr>
-	{ /section }
+	<!-- ENDLOOP $ucp_section -->
 </table>
 
 <div style="padding: 2px;"></div>
 
-{ if $S_SHOW_COLOUR_LEGEND }
+<!-- IF { $S_SHOW_COLOUR_LEGEND } -->
 <table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
 	<tr>
-		<th colspan="2">{$L_MESSAGE_COLOURS}</th>
+		<th colspan="2">{ $L_MESSAGE_COLOURS }</th>
 	</tr>
-	{section name=pm_colour_infoloop loop=$pm_colour_info}
+	<!-- LOOP $pm_colour_info -->
 	<tr>
-		{ if !$pm_colour_info[pm_colour_infoloop].IMG }
-			<td class="row1 {$pm_colour_info[pm_colour_infoloop].CLASS}" width="5"><img src="images/spacer.gif" width="5" alt="{$pm_colour_info[pm_colour_infoloop].LANG}" border="0" /></td>
-		{ else }
-			<td class="row1" width="25" align="center">{$pm_colour_info[pm_colour_infoloop].IMG}</td>
-		{ /if }
-		<td class="row1"><span class="genmed">{$pm_colour_info[pm_colour_infoloop].LANG}</span></td>
+		<!-- IF { $pm_colour_info:IMG } -->
+			<td class="row1 { $pm_colour_info:CLASS }" width="5"><img src="images/spacer.gif" width="5" alt="{ $pm_colour_info:LANG }" border="0" /></td>
+		<!-- ELSE -->
+			<td class="row1" width="25" align="center">{ $pm_colour_info:IMG }</td>
+		<!-- ENDIF -->
+		<td class="row1"><span class="genmed">{ $pm_colour_info:LANG }</span></td>
 	</tr>
-	{ /section }
+	<!-- ENDLOOP $pm_colour_info -->
 </table>
-
+ 
 <div style="padding: 2px;"></div>
-{ /if }
+<!-- ENDIF -->
 
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
-		<th>{$L_FRIENDS}</th>
+		<th>{ $L_FRIENDS }</th>
 	</tr>
 	<tr>
 		<td class="row1" align="center">
 		
-			<b class="genmed" style="color:green">{$L_FRIENDS_ONLINE}</b>
+			<b class="genmed" style="color:green">{ $L_FRIENDS_ONLINE }</b>
 
 			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			{section name=friends_onlineloop loop=$friends_online}
-				<li><a href="{$friends_online[friends_onlineloop].U_PROFILE}">{$friends_online[friends_onlineloop].USERNAME}</a>
-				{ if $S_SHOW_PM_BOX }
-					&nbsp;[ <input class="post" type="submit" name="add_to[{$friends_online[friends_onlineloop].USER_ID}]" value="{$L_ADD}" /> ]
-				{ /if }
-				</li>
-			{sectionelse}
-			<li>{$L_NO_FRIENDS_ONLINE}</li>
-			{ /section }
+			<!-- LOOP $friends_online -->
+				<li><a href="{ $friends_online:U_PROFILE }">{ $friends_online:USERNAME }</a></li>
+			<!-- LOOPELSE -->
+			<li>{ $L_NO_FRIENDS_ONLINE }</li>
+			<!-- ENDLOOP $friends_online -->
 			</ul>
 
 			<hr />
 
-			<b class="genmed" style="color:red">{$L_FRIENDS_OFFLINE}</b>
+			<b class="genmed" style="color:red">{ $L_FRIENDS_OFFLINE }</b>
 
 			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-			{section name=friends_offlineloop loop=$friends_offline}
-			<li><a href="{$friends_offline[friends_offlineloop].U_PROFILE}">{$friends_offline[friends_offlineloop].USERNAME}</a>
-				{ if $S_SHOW_PM_BOX }
-					&nbsp;[ <input class="post" type="submit" name="add_to[{$friends_offline[friends_offlineloop].USER_ID}]" value="{$L_ADD}" /> ]
-				{ /if }
-			{sectionelse}
+			<!-- LOOP $friends_offline -->
+			<li><a href="{ $friends_offline:U_PROFILE }">{ $friends_offline:USERNAME }</a></li>
+			<!-- LOOPELSE -->
 			<li>{$L_NO_FRIENDS_OFFLINE}</li>
-			{ /section }
+			<!-- ENDLOOP $friends_online -->
 			</ul>
-
 		</td>
 	</tr>
-</table>
\ No newline at end of file
+</table>

Modified: trunk/includes/templates/modules/Forums/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/templates/modules/Forums/images/en/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/templates/modules/Forums/images/karma/Thumbs.db
===================================================================
(Binary files differ)

Modified: trunk/includes/templates/modules/Forums/overall_footer.html
===================================================================
--- trunk/includes/templates/modules/Forums/overall_footer.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Forums/overall_footer.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -12,7 +12,6 @@
 <br />
 <div style="text-align: center;" class="copyright">
 <!-- IF { $U_ACP } --><span class="gensmall">[ <a href="{ $U_ACP }">{ $L_ACP }</a> ]</span><br /><br /><!-- ENDIF -->
-Powered by <a href="http://www.phpbb.com/" target="phpbb">phpBB</a> &copy; 2002, 2005 phpBB Group
-<br />{ $TRANSLATION_INFO }</div>
+Based on <a href="http://www.phpbb.com/" target="phpbb">phpBB</a></div>
 
 { $A_TABLE_CLOSE }
\ No newline at end of file

Modified: trunk/includes/templates/modules/Forums/overall_header.html
===================================================================
--- trunk/includes/templates/modules/Forums/overall_header.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Forums/overall_header.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,28 +1,3 @@
-<script language="Javascript" type="text/javascript">
-<!--
-
-function popup(url, width, height)
-{
-	window.open(url, '_popup', 'HEIGHT=' + height + ',resizable=yes,scrollbars=yes, WIDTH=' + width);
-	return false;
-}
-
-<!-- IF isset({ $ON_PAGE }) -->
-function jumpto()
-{
-	var page = prompt('{ $L_JUMP_PAGE }:', '{ $ON_PAGE }');
-	var perpage = '{ $PER_PAGE }';
-	var base_url = '{ $BASE_URL }';
-
-	if (page !== null && !isNaN(page) && page > 0)
-	{
-		document.location.href = base_url.replace('&amp;', '&') + '&start=' + ((page - 1) * perpage);
-	}
-}
-<!-- ENDIF -->
-//-->
-</script>
-
 { $A_TABLE_OPEN }
 
 <table width="100%" cellspacing="0">

Modified: trunk/includes/templates/modules/Members_List/memberlist_footer.html
===================================================================
--- trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,15 +1,16 @@
-<!--
-	We request you retain the full copyright notice below including the link to www.phpbb.com.
-	This not only gives respect to the large amount of time given freely by the developers
-	but also helps build interest, traffic and use of phpBB2. If you (honestly) cannot retain
-	the full copyright we ask you at least leave in place the "Powered by phpBB" line, with
-	"phpBB" linked to www.phpbb.com. If you refuse to include even this then support on our 
-	forums may be affected.
-
-	The phpBB Group : 2003
--->
-
-<br /><div style="text-align: center;" class="copyright">Powered by <a href="http://www.phpbb.com/" target="phpbb">phpBB</a> &copy; 2002, 2003 phpBB Group
-<br />{ $TRANSLATION_INFO }</div>
-
+<!--
+	We request you retain the full copyright notice below including the link to www.phpbb.com.
+	This not only gives respect to the large amount of time given freely by the developers
+	but also helps build interest, traffic and use of phpBB2. If you (honestly) cannot retain
+	the full copyright we ask you at least leave in place the "Powered by phpBB" line, with
+	"phpBB" linked to www.phpbb.com. If you refuse to include even this then support on our 
+	forums may be affected.
+
+	The phpBB Group : 2003
+-->
+
+<br />
+<div style="text-align: center;" class="copyright">
+Based on <a href="http://www.phpbb.com/" target="phpbb">phpBB</a></div>
+
 { $A_TABLE_CLOSE }
\ No newline at end of file

Added: trunk/includes/templates/rss/atom.html
===================================================================
--- trunk/includes/templates/rss/atom.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/rss/atom.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,14 @@
+<feed xml:lang="en-us" xmlns="http://www.w3.org/2005/Atom">
+	<title>{ $SITE_NAME }</title>
+	<link href="{ $SITE_URL }" />
+
+<!-- LOOP $items -->
+<entry>
+	<title>{ $items:TITLE }</title>
+	<link href="{ $items:LINK }" />
+	<summary type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml">{ $items:DESCRIPTION_HTML }</summary>
+	<updated>{ $items:TIME }</updated>
+</entry>
+<!-- ENDLOOP -->
+
+</feed>
\ No newline at end of file

Modified: trunk/includes/templates/rss/rdf.html
===================================================================
--- trunk/includes/templates/rss/rdf.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/rss/rdf.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -6,7 +6,7 @@
 <channel rdf:about="{ $SITE_URL }">
 	<title>{ $SITE_NAME }</title>
 	<link>{ $SITE_URL }</link>
-	<description>{ $SLOGAN }</description>
+	<description></description>
 	<items>
 		<rdf:Seq>
 <!-- LOOP $items -->

Modified: trunk/includes/templates/rss/rss2.html
===================================================================
--- trunk/includes/templates/rss/rss2.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/rss/rss2.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -3,26 +3,20 @@
   xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#">
 
-<channel>
-<title>{ $SITE_NAME }</title>
-<link>{ $SITE_URL }</link>
-<dc:language>en-us</dc:language>
-<dc:creator>Viperal CMS</dc:creator>
-<dc:date>{ $TIME }</dc:date>
-
-<!-- LOOP $items -->
-<item>
-<title>{ $items:TITLE }</title>
-<link>{ $items:LINK }</link>
-<description>
-
-{ $items:DESCRIPTION }
-
-</description>
-<dc:subject></dc:subject>
-<dc:date>{ $items:TIME }</dc:date>
-</item>
-<!-- ENDLOOP -->
-
-</channel>
+	<channel>
+		<title>{ $SITE_NAME }</title>
+		<link>{ $SITE_URL }</link>
+		<dc:language>en-us</dc:language>
+		<dc:creator>Viperal CMS</dc:creator>
+		<dc:date>{ $TIME }</dc:date>
+		<!-- LOOP $items -->
+		<item>
+			<title>{ $items:TITLE }</title>
+			<link>{ $items:LINK }</link>
+			<description>{ $items:DESCRIPTION }</description>
+			<dc:subject></dc:subject>
+			<dc:date>{ $items:TIME }</dc:date>
+		</item>
+		<!-- ENDLOOP -->
+	</channel>
 </rss>
\ No newline at end of file

Modified: trunk/includes/templates/rss/rss91.html
===================================================================
--- trunk/includes/templates/rss/rss91.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/templates/rss/rss91.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,20 +1,18 @@
 <!DOCTYPE rss PUBLIC "-//Netscape Communications//DTD RSS 0.91//EN"
  "http://my.netscape.com/publish/formats/rss-0.91.dtd">
 <rss version="0.91">
-<channel>
-<title>{ $SITE_NAME }</title>
-<link>{ $SITE_URL }</link>
-<description>{ $SLOGAN }</description>
-<language>{ $LANG }</language>
-
-<!-- LOOP $items -->
-	<item>
-	<title>{ $items:TITLE }</title>
-	<link>{ $items:LINK }</link>
-	<description>{ $items:DESCRIPTION }</description>
-	<pubDate>{ $items:TIME }</pubDate>
-	</item>
-<!-- ENDLOOP -->
-
-</channel>
+	<channel>
+		<title>{ $SITE_NAME }</title>
+		<link>{ $SITE_URL }</link>
+		<description></description>
+		<language>{ $LANG }</language>
+		<!-- LOOP $items -->
+		<item>
+			<title>{ $items:TITLE }</title>
+			<link>{ $items:LINK }</link>
+			<description>{ $items:DESCRIPTION }</description>
+			<pubDate>{ $items:TIME }</pubDate>
+		</item>
+		<!-- ENDLOOP -->
+	</channel>
 </rss>
\ No newline at end of file

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/includes/user.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -63,7 +63,9 @@
 				$this->url = mb_substr($this->url, 0, $pos - 1);
 			}
 
-			$this->url = htmlspecialchars(html_entity_decode($this->url, ENT_QUOTES));
+			//$this->url = htmlspecialchars(html_entity_decode($this->url, ENT_QUOTES));
+			$this->url = htmlspecialchars($this->url, ENT_QUOTES);
+
 			$this->url = mb_substr($this->url, 0, 255);
 		}
 		else

Modified: trunk/index.php
===================================================================
--- trunk/index.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/index.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -13,9 +13,11 @@
 //																//
 //**************************************************************//
 define('VIPERAL', 'CMS');
+//print_r($_GET);
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
 $site_file_root = '';
+
 require($site_file_root.'core.php');
 
 $mod = get_variable('mod', 'REQUEST', false);
@@ -24,10 +26,9 @@
 {
 	// Set as homepage 
 	$_CLASS['core_display']->homepage = true;
+	//$_CORE_CONFIG['index_page'];
+	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name IN ( 'Contact' )");
 
-	// Get homepage modules
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' WHERE homepage > 0 ORDER BY homepage ASC');
-
 	While ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$_CLASS['core_display']->add_module($row);
@@ -37,10 +38,11 @@
 
 	if (!($_CORE_MODULE = $_CLASS['core_display']->get_module()))
 	{
-		$_CORE_MODULE['sides'] = BLOCK_ALL;
-		$_CORE_MODULE += array('name' => '', 'title' => ''); // temp
+		$_CORE_MODULE['module_sides'] = BLOCK_ALL;
+		$_CORE_MODULE += array('module_name' => '', 'module_title' => ''); // temp
 
-		$_CLASS['core_display']->display_head();
+		$_CLASS['core_user']->user_setup();
+		$_CLASS['core_display']->display_header();
 		// Hey admin we don't have a modules set
 		if ($_CLASS['core_auth']->admin_auth('modules'))
 		{
@@ -66,8 +68,12 @@
 		script_close(false);
 	}
 
+	$sql = 'SELECT * FROM '.CORE_MODULES_TABLE.'
+				WHERE module_type = ' . MODULE_NORMAL . "
+				AND module_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+
 	//Grab module data if it exsits
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' WHERE type='.MODULE_NORMAL." AND name='".$_CLASS['core_db']->escape($mod)."'");
+	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
@@ -81,8 +87,8 @@
 	$_CORE_MODULE = $_CLASS['core_display']->get_module();
 }
 
-$path = $site_file_root.'modules/'.$_CORE_MODULE['name'].'/index.php';
-$_CLASS['core_user']->page = $_CORE_MODULE['name'];
+$path = $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/index.php';
+$_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
 
 require_once($path);
 

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/install/build_data.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -87,13 +87,13 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (1, 'GUESTS', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (2, 'REGISTERED', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (3, 'REGISTERED_COPPA', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (4, 'ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (5, 'BOTS', 1, 2, '9E8DA7', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_id, group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES (6, 'SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
 
 
 //Admin
@@ -121,7 +121,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Articles', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
@@ -152,24 +152,28 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (1, 0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (2, 1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (3, 2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (4, 2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (5, 2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (6, 2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (7, 2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email) VALUES (8, 2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0)");
+$admin_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
+$guest_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
+$bot_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (3, 2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (4, 2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (5, 2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (6, 2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (7, 2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (8, 2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");f_bbcode
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/install/build_tables.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -260,6 +260,7 @@
 $_CLASS['core_db']->add_table_field_int('user_allow_massemail', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_unread_privmsg', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_text('user_sig', 60000, true);
 $_CLASS['core_db']->add_table_field_char('user_from', 100, true);
@@ -550,7 +551,7 @@
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000));
-$_CLASS['core_db']->add_table_field_int('right_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('right_id', array('max' => 16000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
 field_unix_time('post_time');
 $_CLASS['core_db']->add_table_field_char('poster_ip', 20);
@@ -601,14 +602,14 @@
 
 // we should set this on topic creation
 $_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000, 'null' => true));
 
-$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 
 $_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1)); 
+$_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1, 'null' => true)); 
 field_unix_time('topic_time_limit');
 $_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
@@ -773,6 +774,46 @@
 $_CLASS['core_db']->table_create('commit');
 
 /*
+	Forums Words Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordlist');
+
+$_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('word_text', 100);
+$_CLASS['core_db']->add_table_field_int('word_common', array('max' => 1));
+
+$_CLASS['core_db']->add_table_index('word_id', 'primary');
+$_CLASS['core_db']->add_table_index('word_text');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums search_wordmatch Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordmatch');
+
+$_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000));
+$_CLASS['core_db']->add_table_field_int('title_match', array('max' => 1));
+
+$_CLASS['core_db']->add_table_index('word_id', 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums Words Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_words');
+
+$_CLASS['core_db']->add_table_field_int('word_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('word', 100);
+$_CLASS['core_db']->add_table_field_char('replacement', 100);
+
+$_CLASS['core_db']->add_table_index('word_id', 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
 	Forums Zebra Table
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_zebra');
@@ -789,4 +830,122 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+/*
+	Forums Log Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_log');
+
+$_CLASS['core_db']->add_table_field_int('log_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('log_type', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('reportee_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('log_ip', 40);
+field_unix_time('log_time');
+$_CLASS['core_db']->add_table_field_text('log_operation', 60000);
+$_CLASS['core_db']->add_table_field_text('log_data', 60000);
+
+$_CLASS['core_db']->add_table_index('log_id', 'primary');
+$_CLASS['core_db']->add_table_index('log_type');
+$_CLASS['core_db']->add_table_index('forum_id');
+$_CLASS['core_db']->add_table_index('topic_id');
+$_CLASS['core_db']->add_table_index('reportee_id');
+$_CLASS['core_db']->add_table_index('user_id');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs');
+
+$_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('root_level', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('author_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('author_ip', 40);
+field_unix_time('message_time');
+$_CLASS['core_db']->add_table_field_int('message_reported', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_bbcode', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1));
+
+$_CLASS['core_db']->add_table_field_char('message_subject', 60);
+$_CLASS['core_db']->add_table_field_text('message_text', 10000000);
+$_CLASS['core_db']->add_table_field_char('message_edit_reason', 100, true);
+$_CLASS['core_db']->add_table_field_int('message_edit_user', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('message_checksum', 11);
+$_CLASS['core_db']->add_table_field_int('message_attachment', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', 1000000000);
+$_CLASS['core_db']->add_table_field_char('bbcode_uid', 5);
+field_unix_time('message_edit_time', true);
+$_CLASS['core_db']->add_table_field_text('message_edit_count', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_text('to_address', 1000000);
+$_CLASS['core_db']->add_table_field_text('bcc_address', 1000000);
+
+$_CLASS['core_db']->add_table_index('msg_id', 'primary');
+$_CLASS['core_db']->add_table_index('author_ip');
+$_CLASS['core_db']->add_table_index('message_time');
+$_CLASS['core_db']->add_table_index('author_id');
+$_CLASS['core_db']->add_table_index('root_level');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums Log Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_folder');
+
+$_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_char('folder_name', 40);
+$_CLASS['core_db']->add_table_field_int('pm_count', array('max' => 16000000, 'null' => true));
+
+$_CLASS['core_db']->add_table_index('folder_id', 'primary');
+$_CLASS['core_db']->add_table_index('user_id');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums Log Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_rules');
+
+$_CLASS['core_db']->add_table_field_int('rule_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('rule_check', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('rule_connection', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_char('rule_string', 255);
+$_CLASS['core_db']->add_table_field_int('rule_user_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('rule_group_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('rule_action', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_text('rule_folder_id', 16000000);
+
+$_CLASS['core_db']->add_table_index('rule_id', 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums Log Table
+*/
+$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_to');
+
+$_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('author_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('deleted', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('msg_new', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('unread', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('replied', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('marked', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forwarded', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000));
+
+$_CLASS['core_db']->add_table_index('msg_id');
+$_CLASS['core_db']->add_table_index(array('user_id', 'folder_id'));
+
+$_CLASS['core_db']->table_create('commit');
+
 ?>
\ No newline at end of file

Modified: trunk/javascript/menu.js
===================================================================
--- trunk/javascript/menu.js	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/javascript/menu.js	2005-09-03 01:42:07 UTC (rev 96)
@@ -16,8 +16,9 @@
 function get_offsets(element)
 {
 	var offsets = new Array();
+	var window_offset = (window.pageYOffset) ? window.pageYOffset : (document.body.scrollTop) ? document.body.scrollTop : document.documentElement.scrollTop;
 
-	offsets['top']	= element.offsetTop;
+	offsets['top']	= Number(window_offset) + element.offsetTop;
 	offsets['left']	= element.offsetLeft;
 
 	while ((element = element.offsetParent) != null)

Modified: trunk/language/en/common.php
===================================================================
--- trunk/language/en/common.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/language/en/common.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -22,7 +22,6 @@
 // in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
 
 $this->lang += array(
-	'ENCODING'		=> 'utf-8',
 	'LANG'			=> 'en',
 	'DIRECTION'		=> 'ltr',
 	'LEFT'			=> 'left',
@@ -48,7 +47,7 @@
 	'ALL_FORUMS'			=> 'All Forums',
 	'ALL_MESSAGES'			=> 'All Messages',
 	'ALL_POSTS'				=> 'All Posts',
-	'ALL_TIMES'             => 'All times are GMT%1$s %2$s',
+	'ALL_TIMES'             => 'All times are %1$s %2$s',
 	'ALL_TOPICS'			=> 'All Topics',
 	'AND'					=> 'And',
 	'ARE_WATCHING_FORUM'	=> 'You have subscribed to receive updates on this forum',
@@ -214,9 +213,10 @@
 	'LOGOUT' 			=> 'Logout',
 	'LOG_ADMIN_AUTH_FAIL'   => '<b>Failed administration login attempt</b>',
 	'LOG_ADMIN_AUTH_SUCCESS'=> '<b>Sucessful administration login</b>',
+	'LOG_DELETE_POST'	=> '<b>Deleted post</b><br />&#187; %s',
 	'LOG_DELETE_TOPIC'	=> '<b>Deleted topic</b><br />&#187; %s',
-	'LOG_EMAIL_ERROR'       => '<b>Email error<br />&#187; %s',
-	'LOG_JABBER_ERROR'      => '<b>Jabber error<br />&#187; %s',
+	'LOG_EMAIL_ERROR'	=> '<b>Email error<br />&#187; %s',
+	'LOG_JABBER_ERROR'	=> '<b>Jabber error<br />&#187; %s',
 	'LOG_ME_IN'			=> 'Log me on automatically each visit',
 	'LOG_USER_FEEDBACK'     => '<b>Added user feedback</b><br />&#187; %s',
 	'LOG_USER_GENERAL'	=> '%s',

Modified: trunk/language/en/error.php
===================================================================
--- trunk/language/en/error.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/language/en/error.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,10 +1,28 @@
 <?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright 2004 - 2005										//
+//  By Ryan Marshall ( Viperal?	)								//
+//																//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+$homepage = 'http://www.viperal.com';
 
 $error = array(
-	'403'	=> '<div style="text-align: center"<b>Sorry, you don\'t have currect authorization to view this page.</b><br /><br /> Please check the URL for proper spelling and capitalization<br />'
-					.'<br /><a href="http://www.wowbeyond.com">Click here to homepage</a><br />[ <a href="javascript:history.go(-1)">Go Back</a> ]</div>',
-	'404'	=> '<div style="text-align: center"<b>Sorry, the page you requested was not found.</b><br /><br /> Please check the URL for proper spelling and capitalization<br /> If you believe this is a broken like please contact the stie admin.<br />'
-		.'<br /><a href="http://www.wowbeyond.com">Click here to homepage</a><br />[ <a href="javascript:history.go(-1)">Go Back</a> ]</div>',	
+	'403' => array(
+		'header'	=> 'HTTP/1.0 403 Forbidden',
+		'lang'		=> '<div style="text-align: center"<b>Sorry, you don\'t have currect authorization to view this page.</b><br /><br /> Please check the URL for proper spelling and capitalization<br />'
+					.'<br /><a href="'. $homepage .'">Click here to homepage</a><br />[ <a href="javascript:history.go(-1)">Go Back</a> ]</div>'),
+	'404' => array(
+		'header'	=> 'HTTP/1.0 404 Not Found',
+		'lang'		=> '<div style="text-align: center"<b>Sorry, the page you requested was not found.</b><br /><br /> Please check the URL for proper spelling and capitalization<br /> If you believe this is a broken like please contact the stie admin.<br />'
+		.'<br /><a href="'. $homepage .'">Click here to homepage</a><br />[ <a href="javascript:history.go(-1)">Go Back</a> ]</div>'),	
 );
 
 ?>
\ No newline at end of file

Modified: trunk/modules/Control_Panel/index.php
===================================================================
--- trunk/modules/Control_Panel/index.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/index.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -70,7 +70,7 @@
 			if ($row['module_acl'])
 			{
 				$is_auth = false;
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']'.'->acl_get("\\1")', '(int) $config["\\1"]'), trim($row['module_acl'])) . ');');
+				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('$_CLASS[\'auth\']->acl_get("\\1")', '$config["\\1"]'), trim($row['module_acl'])) . ');');
 
 				// The user is not authorised to use this module, skip it
 				if (!$is_auth)

Modified: trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_main.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/ucp/ucp_main.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -201,7 +201,7 @@
 				}
 
 				// Do the relevant calculations 
-				$memberdays = max(1, round((time() - $_CLASS['core_user']->data['user_regdate']) / 86400));
+				$memberdays = max(1, round((time() - $_CLASS['core_user']->data['user_reg_date']) / 86400));
 				$posts_per_day = $_CLASS['core_user']->data['user_posts'] / $memberdays;
 				$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
@@ -228,7 +228,7 @@
 
 				$_CLASS['core_template']->assign_array(array(
 					'USER_COLOR'		=> (!empty($_CLASS['core_user']->data['user_colour'])) ? $_CLASS['core_user']->data['user_colour'] : '', 
-					'JOINED'			=> $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_regdate']),
+					'JOINED'			=> $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_reg_date']),
 					'VISITED'			=> (empty($_CLASS['core_user']->data['user_lastvisit'])) ? ' - ' : $_CLASS['core_user']->format_date($_CLASS['core_user']->data['user_lastvisit']),
 					'POSTS'				=> ($_CLASS['core_user']->data['user_posts']) ? $_CLASS['core_user']->data['user_posts'] : 0,
 					'POSTS_DAY'			=> sprintf($_CLASS['core_user']->lang['POST_DAY'], $posts_per_day),

Modified: trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -140,7 +140,7 @@
 			case 'options':
 				$sql = 'SELECT group_message_limit
 					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']->data['group_id'];
+					WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
 				$result = $_CLASS['core_db']->query($sql);
 
 				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
@@ -169,7 +169,7 @@
 			
 				$sql = 'SELECT group_message_limit
 					FROM ' . GROUPS_TABLE . '
-					WHERE group_id = ' . $_CLASS['core_user']->data['group_id'];
+					WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
 				$result = $_CLASS['core_db']->query($sql);
 				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
 				$_CLASS['core_db']->free_result($result);
@@ -286,7 +286,7 @@
 					}
 	
 					$sql = 'SELECT t.*, p.*, u.*
-						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_USERS_TABLE . ' u
+						FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
 						WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 							AND p.author_id = u.user_id
 							AND t.folder_id = $folder_id
@@ -379,6 +379,7 @@
 
 			default:
 				trigger_error('NO_ACTION_MODE');
+			break;
 		}
 
 		$_CLASS['core_template']->assign(array( 

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -17,10 +17,6 @@
 {
 	global $_CLASS, $site_file_root, $config;
 	
-	require($site_file_root.'includes/forums/functions_admin.php');
-	require($site_file_root.'includes/forums/functions_posting.php');
-	require($site_file_root.'includes/forums/message_parser.php');
-
 	if (!$action)
 	{
 		$action = 'post';
@@ -52,18 +48,18 @@
 	// Do NOT use request_var or specialchars here
 	$address_list	= isset($_REQUEST['address_list']) ? $_REQUEST['address_list'] : array();
 
-	$submit		= (isset($_POST['post']));
-	$preview	= (isset($_POST['preview']));
-	$save		= (isset($_POST['save']));
-	$load		= (isset($_POST['load']));
-	$cancel		= (isset($_POST['cancel']));
-	$confirm	= (isset($_POST['confirm']));
-	$delete		= (isset($_POST['delete']));
+	$submit		= isset($_POST['post']);
+	$preview	= isset($_POST['preview']);
+	$save		= isset($_POST['save']);
+	$load		= isset($_POST['load']);
+	$cancel		= isset($_POST['cancel']);
+	$confirm	= isset($_POST['confirm']);
+	$delete		= isset($_POST['delete']);
 
-	$remove_u	= (isset($_REQUEST['remove_u']));
-	$remove_g	= (isset($_REQUEST['remove_g']));
-	$add_to		= (isset($_REQUEST['add_to']));
-	$add_bcc	= (isset($_REQUEST['add_bcc']));
+	$remove_u	= isset($_REQUEST['remove_u']);
+	$remove_g	= isset($_REQUEST['remove_g']);
+	$add_to		= isset($_REQUEST['add_to']);
+	$add_bcc	= isset($_REQUEST['add_bcc']);
 
 	$refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || $save || $load
 		|| $remove_u || $remove_g || $add_to || $add_bcc;
@@ -71,7 +67,7 @@
 	$action		= ($delete && !$preview && !$refresh && $submit) ? 'delete' : $action;
 
 	$error = array();
-	$current_time = time();
+	$current_time = gmtime();
 
 	// Was cancel pressed? If so then redirect to the appropriate page
 	if ($cancel || ($current_time - $lastclick < 2 && $submit))
@@ -80,6 +76,16 @@
 		redirect($redirect);
 	}
 
+	if ($action == 'forward' && (!$config['forward_pm'] || !$_CLASS['auth']->acl_get('u_pm_forward')))
+	{
+		trigger_error('NO_AUTH_FORWARD_MESSAGE');
+	}
+
+	if ($action == 'edit' && !$_CLASS['auth']->acl_get('u_pm_edit'))
+	{
+		trigger_error('NO_AUTH_EDIT_MESSAGE');
+	}
+
 	$sql = '';
 
 	// What is all this following SQL for? Well, we need to know
@@ -92,13 +98,11 @@
 			{
 				trigger_error('NO_AUTH_SEND_MESSAGE');
 			}
-		
-			break;
+		break;
 			
 		case 'reply':
 		case 'quote':
 		case 'forward':
-		
 			if (!$msg_id)
 			{
 				trigger_error('NO_MESSAGE');
@@ -108,11 +112,11 @@
 			{
 				trigger_error('NO_AUTH_SEND_MESSAGE');
 			}
-			
+
 			if ($quote_post)
 			{
 				$sql = 'SELECT p.post_text as message_text, p.poster_id as author_id, p.post_time as message_time, p.bbcode_bitfield, p.bbcode_uid, p.enable_sig, p.enable_html, p.enable_smilies, p.enable_magic_url, t.topic_title as message_subject, u.username as quote_username
-					FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . USERS_TABLE . " u
+					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . " u
 					WHERE p.post_id = $msg_id
 						AND t.topic_id = p.topic_id
 						AND u.user_id = p.poster_id";
@@ -120,13 +124,13 @@
 			else
 			{
 				$sql = 'SELECT t.*, p.*, u.username as quote_username
-					FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . ' u
 					WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 						AND p.author_id = u.user_id
 						AND t.msg_id = p.msg_id
 						AND p.msg_id = $msg_id";
 			}
-			break;
+		break;
 
 		case 'edit':
 			if (!$msg_id)
@@ -136,12 +140,12 @@
 
 			// check for outbox (not read) status, we do not allow editing if one user already having the message
 			$sql = 'SELECT p.*, t.*
-				FROM ' . PRIVMSGS_TO_TABLE . ' t, ' . PRIVMSGS_TABLE . ' p
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
 				WHERE t.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 					AND t.folder_id = ' . PRIVMSGS_OUTBOX . "
 					AND t.msg_id = $msg_id
 					AND t.msg_id = p.msg_id";
-			break;
+		break;
 
 		case 'delete':
 			if (!$_CLASS['auth']->acl_get('u_pm_delete'))
@@ -155,29 +159,24 @@
 			}
 
 			$sql = 'SELECT msg_id, unread, new, author_id, folder_id
-				FROM ' . PRIVMSGS_TO_TABLE . '
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND msg_id = $msg_id";
 			break;
 
 		case 'smilies':
+			require_once($site_file_root.'includes/forums/functions_posting.php');
+	
 			generate_smilies('window', 0);
-			break;
+	
+			script_close(false);
+		break;
 
 		default:
 			trigger_error('NO_ACTION_MODE');
+		break;
 	}
 
-	if ($action == 'forward' && (!$config['forward_pm'] || !$_CLASS['auth']->acl_get('u_pm_forward')))
-	{
-		trigger_error('NO_AUTH_FORWARD_MESSAGE');
-	}
-
-	if ($action == 'edit' && !$_CLASS['auth']->acl_get('u_pm_edit'))
-	{
-		trigger_error('NO_AUTH_EDIT_MESSAGE');
-	}
-
 	if ($sql)
 	{
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -198,11 +197,11 @@
 			trigger_error('NO_AUTHOR');
 		}
 
-		if (($action == 'reply' || $action == 'quote') && !sizeof($address_list) && !$refresh && !$submit && !$preview)
+		if (($action == 'reply' || $action == 'quote') && empty($address_list) && !$refresh && !$submit && !$preview)
 		{
 			$address_list = array('u' => array($author_id => 'to'));
 		}
-		else if ($action == 'edit' && !sizeof($address_list) && !$refresh && !$submit && !$preview)
+		elseif ($action == 'edit' && empty($address_list) && !$refresh && !$submit && !$preview)
 		{
 			// Rebuild TO and BCC Header
 			$address_list = rebuild_header(array('to' => $to_address, 'bcc' => $bcc_address));
@@ -229,7 +228,6 @@
 		trigger_error('NO_AUTH_GROUP_MESSAGE');
 	}
 
-
 	if ($action == 'edit' && !$refresh && !$preview && !$submit)
 	{
 		if (!($message_time > time() - $config['pm_edit_time'] || !$config['pm_edit_time']))
@@ -237,16 +235,20 @@
 			trigger_error('CANNOT_EDIT_MESSAGE_TIME');
 		}
 	}
+
 	if (!isset($icon_id))
 	{
 		$icon_id = 0;
 	}
 
+	require_once($site_file_root.'includes/forums/functions_admin.php');
+	require_once($site_file_root.'includes/forums/functions_posting.php');
+	require_once($site_file_root.'includes/forums/message_parser.php');
 
 	$message_parser = new parse_message();
 
-	$message_subject = (isset($message_subject)) ? $message_subject : '';
-	$message_parser->message = ($action == 'reply') ? '' : ((isset($message_text)) ? $message_text : '');
+	$message_subject = isset($message_subject) ? $message_subject : '';
+	$message_parser->message = ($action == 'reply') ? '' : (isset($message_text) ? $message_text : '');
 	unset($message_text);
 
 	$s_action = "Control_Panel&amp;i=$id&amp;mode=$mode&amp;action=$action";
@@ -295,7 +297,7 @@
 	if ($message_attachment && !$submit && !$refresh && !$preview && $action == 'edit')
 	{
 		$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
-			FROM ' . ATTACHMENTS_TABLE . "
+			FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 			WHERE post_msg_id = $msg_id
 				AND in_message = 1
 				ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC');
@@ -320,7 +322,7 @@
 	if ($_CLASS['auth']->acl_get('u_savedrafts') && $action != 'delete')
 	{
 		$sql = 'SELECT draft_id
-			FROM ' . DRAFTS_TABLE . '
+			FROM ' . FORUMS_DRAFTS_TABLE . '
 			WHERE (forum_id = 0 AND topic_id = 0)
 				AND user_id = ' . $_CLASS['core_user']->data['user_id'] . 
 				(($draft_id) ? " AND draft_id <> $draft_id" : '');
@@ -338,6 +340,7 @@
 		$message_parser->bbcode_uid = $bbcode_uid;
 	}
 
+$config['auth_bbcode_pm'] = true;
 	$html_status	= ($config['allow_html'] && $config['auth_html_pm'] && $_CLASS['auth']->acl_get('u_pm_html'));
 	$bbcode_status	= ($config['allow_bbcode'] && $config['auth_bbcode_pm'] && $_CLASS['auth']->acl_get('u_pm_bbcode'));
 	$smilies_status	= ($config['allow_smilies'] && $config['auth_smilies_pm'] && $_CLASS['auth']->acl_get('u_pm_smilies'));
@@ -353,7 +356,7 @@
 
 		if ($subject && $message)
 		{
-			$sql = 'INSERT INTO ' . DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 				'user_id'	=> $_CLASS['core_user']->data['user_id'],
 				'topic_id'	=> 0,
 				'forum_id'	=> 0,
@@ -377,7 +380,7 @@
 	if ($draft_id && $_CLASS['auth']->acl_get('u_savedrafts'))
 	{
 		$sql = 'SELECT draft_subject, draft_message 
-			FROM ' . DRAFTS_TABLE . " 
+			FROM ' . FORUMS_DRAFTS_TABLE . " 
 			WHERE draft_id = $draft_id
 				AND topic_id = 0
 				AND forum_id = 0
@@ -387,7 +390,7 @@
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$_REQUEST['subject'] = $row['draft_subject'];
-			$_POST['message'] = $row['draft_message'];
+			$_REQUEST['message'] = $row['draft_message'];
 			$refresh = true;
 			$_CLASS['core_template']->assign('S_DRAFT_LOADED', true);
 		}
@@ -405,18 +408,10 @@
 
 	if ($submit || $preview || $refresh)
 	{
-		$subject = request_var('subject', '');
+		$subject = mb_strtolower(get_variable('subject', 'POST', ''));
 
-		if (strcmp($subject, strtoupper($subject)) == 0 && $subject)
-		{
-			$subject = strtolower($subject);
-		}
-		$subject = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', $subject);
+		$message_parser->message = request_var('message', '', true);
 
-	
-		$message_parser->message = (isset($_POST['message'])) ? htmlspecialchars(str_replace(array('\\\'', '\\"', '\\0', '\\\\'), array('\'', '"', '\0', '\\'), $_POST['message'])) : '';
-		$message_parser->message = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', $message_parser->message);
-
 		$icon_id			= request_var('icon', 0);
 
 		$enable_html 		= (!$html_status || isset($_POST['disable_html'])) ? false : true;
@@ -443,6 +438,7 @@
 
 		// Check checksum ... don't re-parse message if the same
 		$update_message = ($action != 'edit' || $message_md5 != $post_checksum || $status_switch || $preview) ? true : false;
+
 		if ($update_message)
 		{
 			$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
@@ -455,7 +451,7 @@
 		if ($action != 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['auth']->acl_get('u_ignoreflood'))
 		{
 			// Flood check
-			$last_post_time = $_CLASS['core_user']->data['user_lastpost_time'];
+			$last_post_time = $_CLASS['core_user']->data['user_last_post_time'];
 
 			if ($last_post_time)
 			{
@@ -472,18 +468,18 @@
 			$error[] = $_CLASS['core_user']->lang['EMPTY_SUBJECT'];
 		}
 
-		if (!sizeof($address_list))
+		if (empty($address_list))
 		{
 			$error[] = $_CLASS['core_user']->lang['NO_RECIPIENT'];
 		}
 
-		if (sizeof($message_parser->warn_msg) && !($remove_u || $remove_g || $add_to || $add_bcc))
+		if (!empty($message_parser->warn_msg) && !($remove_u || $remove_g || $add_to || $add_bcc))
 		{
 			$error[] = implode('<br />', $message_parser->warn_msg);
 		}
 
 		// Store message, sync counters
-		if (!sizeof($error) && $submit)
+		if (empty($error) && $submit)
 		{
 			$pm_data = array(
 				'msg_id'				=> (int) $msg_id,
@@ -519,7 +515,7 @@
 		$message_subject = stripslashes($subject);
 	}
 
-	if (!sizeof($error) && $preview)
+	if (empty($error) && $preview)
 	{
 		$post_time = ($action == 'edit') ? $post_time : $current_time;
 
@@ -546,7 +542,7 @@
 		}
 
 		// Attachment Preview
-		if (sizeof($message_parser->attachment_data))
+		if (!empty($message_parser->attachment_data))
 		{
 			require($site_file_root.'includes/forums/functions_display.php');
 			$extensions = $update_count = array();
@@ -557,7 +553,7 @@
 
 		$preview_subject = censor_text($subject);
 
-		if (!sizeof($error))
+		if (empty($error))
 		{
 			$_CLASS['core_template']->assign(array(
 				'POST_DATE'					=> $_CLASS['core_user']->format_date($post_time),
@@ -572,7 +568,7 @@
 	}
 
 	// Decode text for message display
-	$bbcode_uid = (($action == 'quote' || $action == 'forward')&& !$preview && !$refresh && !sizeof($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
+	$bbcode_uid = (($action == 'quote' || $action == 'forward')&& !$preview && !$refresh && empty($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
 
 	$message_parser->decode_message($bbcode_uid);
 
@@ -623,18 +619,18 @@
 
 	// Build address list for display
 	// array('u' => array($author_id => 'to'));
-	if (sizeof($address_list))
+	if (!empty($address_list))
 	{
 		// Get Usernames and Group Names
 		$result = array();
-		if (isset($address_list['u']) && sizeof($address_list['u']))
+		if (isset($address_list['u']) && !empty($address_list['u']))
 		{
 			$result['u'] = $_CLASS['core_db']->query('SELECT user_id as id, username as name, user_colour as colour 
 				FROM ' . USERS_TABLE . ' 
 				WHERE user_id IN (' . implode(', ', array_map('intval', array_keys($address_list['u']))) . ')');
 		}
 		
-		if (isset($address_list['g']) && sizeof($address_list['g']))
+		if (isset($address_list['g']) && !empty($address_list['g']))
 		{
 			$result['g'] = $_CLASS['core_db']->query('SELECT group_id as id, group_name as name, group_colour as colour 
 				FROM ' . GROUPS_TABLE . ' 
@@ -745,7 +741,7 @@
 		'FLASH_STATUS'			=> ($flash_status) ? $_CLASS['core_user']->lang['FLASH_IS_ON'] : $_CLASS['core_user']->lang['FLASH_IS_OFF'],
 		'SMILIES_STATUS'		=> ($smilies_status) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF'],
 		'MINI_POST_IMG'			=> $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['PM']),
-		'ERROR'					=> (sizeof($error)) ? implode('<br />', $error) : '', 
+		'ERROR'					=> empty($error) ? '' : implode('<br />', $error), 
 
 		'S_EDIT_POST'			=> ($action == 'edit'),
 		'S_SHOW_PM_ICONS'		=> $s_pm_icons,
@@ -777,7 +773,7 @@
 // For composing messages, handle list actions
 function handle_message_list_actions(&$address_list, $remove_u, $remove_g, $add_to, $add_bcc)
 {
-	global $_REQUEST;
+	global $_REQUEST, $site_file_root;
 
 	// Delete User [TO/BCC]
 	if ($remove_u)
@@ -801,7 +797,7 @@
 		// Add Selected Groups
 		$group_list = isset($_REQUEST['group_list']) ? array_map('intval', $_REQUEST['group_list']) : array();
 
-		if (sizeof($group_list))
+		if (!empty($group_list))
 		{
 			foreach ($group_list as $group_id)
 			{
@@ -818,12 +814,13 @@
 		}
 
 		// Reveal the correct user_ids
-		if (sizeof($usernames))
+		if (!empty($usernames))
 		{
-			$user_id_ary = array();
-			user_get_id_name($user_id_ary, $usernames);
+			require_once($site_file_root.'includes/functions_user.php');
+
+			$user_id_ary = user_get_id($usernames, $difference);
 			
-			if (sizeof($user_id_ary))
+			if (!empty($user_id_ary))
 			{
 				foreach ($user_id_ary as $user_id)
 				{

Modified: trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -46,12 +46,9 @@
 	$message = $message_row['message_text'];
 
 	// If the board has HTML off but the message has HTML on then we process it, else leave it alone
-	if (!$config['auth_html_pm'] || !$_CLASS['auth']->acl_get('u_pm_html'))
+	if ($message_row['enable_html'] && (!$config['auth_html_pm'] || !$_CLASS['auth']->acl_get('u_pm_html')))
 	{
-		if ($message_row['enable_html'] && $config['auth_bbcode_pm'] && $_CLASS['auth']->acl_get('u_pm_bbcode'))
-		{
-			$message = preg_replace('#(<)([\/]?.*?)(>)#is', "&lt;\\2&gt;", $message);
-		}
+		$message = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $message);
 	}
 
 	// Second parse bbcode here
@@ -89,7 +86,7 @@
 			require($site_file_root.'includes/forums/functions_display.php');
 
 			$sql = 'SELECT * 
-				FROM ' . ATTACHMENTS_TABLE . "
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 				WHERE post_msg_id = $msg_id
 					AND in_message = 1
 				ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC') . ', post_msg_id ASC';
@@ -102,9 +99,9 @@
 			$_CLASS['core_db']->free_result($result);
 	
 			// No attachments exist, but message table thinks they do so go ahead and reset attach flags
-			if (!sizeof($attachments))
+			if (empty($attachments))
 			{
-				$sql = 'UPDATE ' . PRIVMSGS_TABLE . " 
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . " 
 					SET message_attachment = 0 
 					WHERE msg_id = $msg_id";
 				$_CLASS['core_db']->query($sql);
@@ -117,7 +114,7 @@
 	}
 
 	// Assign inline attachments
-	if (isset($attachments) && sizeof($attachments))
+	if (!empty($attachments))
 	{
 		$unset_attachments = parse_inline_attachments($message, $attachments, $update_count, 0);
 	
@@ -157,7 +154,7 @@
 		'AUTHOR_RANK' 		=> $user_info['rank_title'],
 		'RANK_IMAGE' 		=> $user_info['rank_image'],
 		'AUTHOR_AVATAR'		=> (isset($user_info['avatar'])) ? $user_info['avatar'] : '',
-		'AUTHOR_JOINED'		=> $_CLASS['core_user']->format_date($user_info['user_regdate'], $_CLASS['core_user']->lang['DATE_FORMAT']),
+		'AUTHOR_JOINED'		=> $_CLASS['core_user']->format_date($user_info['user_reg_date']),
 		'AUTHOR_POSTS' 		=> (!empty($user_info['user_posts'])) ? $user_info['user_posts'] : '',
 		'AUTHOR_FROM' 		=> (!empty($user_info['user_from'])) ? $user_info['user_from'] : '',
 
@@ -195,10 +192,10 @@
 		'S_HAS_ATTACHMENTS' => (sizeof($attachments)) ? true : false,
 		'S_DISPLAY_NOTICE'	=> $display_notice && $message_row['message_attachment'],
 
-		'U_PRINT_PM'		=> ($config['print_pm'] && $_CLASS['auth']->acl_get('u_pm_printpm')) ? generate_link("$url&amp;f=$folder_id&amp;p=" . $message_row['msg_id'] . "&amp;view=print") : '',
-		'U_EMAIL_PM'		=> ($config['email_pm'] && $_CORE_CONFIG['email']['email_enable'] && $_CLASS['auth']->acl_get('u_pm_emailpm')) ? 'Email' : '',
-		'U_FORWARD_PM'		=> ($config['forward_pm'] && $_CLASS['auth']->acl_get('u_pm_forward')) ? generate_link("$url&amp;mode=compose&amp;action=forward&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '')
-	);
+		'U_PRINT_PM'		=> generate_link("$url&amp;f=$folder_id&amp;p=" . $message_row['msg_id'] . "&amp;view=print"),
+		'U_EMAIL_PM'		=> ($_CORE_CONFIG['email']['email_enable']) ? 'Email' : '',
+		'U_FORWARD_PM'		=> generate_link("$url&amp;mode=compose&amp;action=forward&amp;f=$folder_id&amp;p=" . $message_row['msg_id'])
+	));
 
 	// Display not already displayed Attachments for this post, we already parsed them. ;)
 	if (isset($attachments) && sizeof($attachments))
@@ -229,7 +226,7 @@
 
 	// Get History Messages (could be newer)
 	$sql = 'SELECT t.*, p.*, u.*
-		FROM ' . PRIVMSGS_TABLE . ' p, ' . PRIVMSGS_TO_TABLE . ' t, ' . USERS_TABLE . ' u
+		FROM ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . USERS_TABLE . ' u
 		WHERE t.msg_id = p.msg_id 
 			AND p.author_id = u.user_id
 			AND t.folder_id <> ' . PRIVMSGS_NO_BOX . "
@@ -243,6 +240,7 @@
 	{
 		$sql .= " AND (p.root_level = " . $message_row['root_level'] . ' OR p.msg_id = ' . $message_row['root_level'] . ')';
 	}
+
 	$sql .= ' ORDER BY p.message_time ';
 	$sort_dir = (!empty($_CLASS['core_user']->data['user_sortby_dir'])) ? $_CLASS['core_user']->data['user_sortby_dir'] : 'd';
 	$sql .= ($sort_dir == 'd') ? 'ASC' : 'DESC';
@@ -372,30 +370,30 @@
 	}
 
 	// Grab ranks
-	$ranks = array();
-	obtain_ranks($ranks);
+	$ranks = obtain_ranks();
 
 	// Generate online information for user
+	
+	$user_row['online'] = false;
+
 	if ($config['load_onlinetrack'])
 	{
-		$sql = 'SELECT session_user_id, MAX(session_time) as online_time, MIN(session_viewonline) AS viewonline
+		$sql = 'SELECT session_user_id, MAX(session_hidden) AS session_hidden
 			FROM ' . SESSIONS_TABLE . " 
 			WHERE session_user_id = $user_id
-			GROUP BY session_user_id";
+			AND session_time < " . ($_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length']) . '
+				GROUP BY session_user_id';
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
 
 		$update_time = $config['load_online_time'] * 60;
+
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$user_row['online'] = (time() - $update_time < $row['online_time'] && ($row['viewonline'] && $user_row['user_allow_viewonline'])) ? true : false;
-		} else {
-			$user_row['online'] = false;
+			$user_row['online'] = (!$row['session_hidden'] && $user_row['user_allow_viewonline']) ? true : false;
 		}
+
+		$_CLASS['core_db']->free_result($result);
 	}
-	else
-	{
-		$user_row['online'] = false;
-	}
 
 	if ($user_row['user_avatar'] && $_CLASS['core_user']->optionget('viewavatars'))
 	{
@@ -419,7 +417,7 @@
 		$user_row['rank_title'] = (!empty($ranks['special'][$user_row['user_rank']]['rank_title'])) ? $ranks['special'][$user_row['user_rank']]['rank_title'] : '';
 		$user_row['rank_image'] = (!empty($ranks['special'][$user_row['user_rank']]['rank_image'])) ? '<img src="' . $config['ranks_path'] . '/' . $ranks['special'][$user_row['user_rank']]['rank_image'] . '" border="0" alt="' . $ranks['special'][$user_row['user_rank']]['rank_title'] . '" title="' . $ranks['special'][$user_row['user_rank']]['rank_title'] . '" /><br />' : '';
 	}
-	elseif(isset($ranks['normal']))
+	elseif (isset($ranks['normal']))
 	{
 		foreach ($ranks['normal'] as $rank)
 		{
@@ -431,6 +429,10 @@
 			}
 		}
 	}
+	else
+	{
+		$user_row['rank_title'] = $user_row['rank_image'] = '';
+	}
 
 	if (!empty($user_row['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
 	{

Modified: trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -15,12 +15,14 @@
 {
 	function ucp_prefs($id, $mode)
 	{
-		global $config, $_CLASS, $SID, $_CORE_CONFIG;
+		global $config, $_CLASS, $site_file_root, $_CORE_CONFIG;
 
 		$submit = (isset($_POST['submit'])) ? true : false;
 		$error = $data = array();
 		$s_hidden_fields = '';
 
+		require_once($site_file_root.'includes/forums/functions_user.php');
+
 		switch($mode)
 		{
 			case 'personal':
@@ -49,7 +51,6 @@
 					}
 
 					$var_ary = array(
-						//'dateformat'	=> array('string', false, 3, 15), 
 						'lang'			=> array('match', false, '#^[a-z_]{2,}$#i'),
 						'tz'			=> array('num', false, -13, 13),
 					);
@@ -69,11 +70,11 @@
 							'user_allow_massemail'	=> $massemail, 
 							'user_allow_viewonline'	=> ($_CLASS['auth']->acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']->data['user_allow_viewonline'], 
 							'user_notify_type'		=> $notifymethod, 
-							'user_notify_pm'		=> $notifypm,
+							//'user_notify_pm'		=> $notifypm,
 							'user_data'				=> serialize($_CLASS['core_user']->data['user_data']), 
 
 							'user_dst'				=> $dst,
-							'user_dateformat'		=> $dateformat,
+							'user_time_format'		=> $dateformat,
 							'user_lang'				=> $lang,
 							'user_timezone'			=> $tz * 3600,
 							'user_theme'			=> $theme,
@@ -109,7 +110,7 @@
 				$hideonline = (isset($hideonline)) ? $hideonline : !$_CLASS['core_user']->data['user_allow_viewonline'];
 				$hide_online_yes = ($hideonline) ? ' checked="checked"' : '';
 				$hide_online_no = (!$hideonline) ? ' checked="checked"' : '';
-				$notifypm = (isset($notifypm)) ? $notifypm : $_CLASS['core_user']->data['user_notify_pm'];
+				$notifypm = (isset($notifypm)) ? $notifypm : '';
 				$notify_pm_yes = ($notifypm) ? ' checked="checked"' : '';
 				$notify_pm_no = (!$notifypm) ? ' checked="checked"' : '';
 				$popuppm = (isset($popuppm)) ? $popuppm : $_CLASS['core_user']->optionget('popuppm');
@@ -123,7 +124,7 @@
 				$dst_no = (!$dst) ? ' checked="checked"' : '';
 
 				$notifymethod = (isset($notifymethod)) ? $notifymethod : $_CLASS['core_user']->data['user_notify_type'];
-				$dateformat = (isset($dateformat)) ? $dateformat : $_CLASS['core_user']->data['user_dateformat'];
+				$dateformat = (isset($dateformat)) ? $dateformat : $_CLASS['core_user']->data['user_time_format'];
 				$lang = (isset($lang)) ? $lang : $_CLASS['core_user']->data['user_lang'];
 				$theme = (isset($theme)) ? $theme : $_CLASS['core_user']->data['user_theme'];
 				$tz = (isset($tz)) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
@@ -227,7 +228,7 @@
 						$_CLASS['core_db']->sql_query($sql);
 
 						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
-						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel$SID&amp;i=$id&amp;mode=$mode").'">', '</a>');
+						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
 						trigger_error($message);
 					}
 					// Replace "error" strings with their real, localised form

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Forums/posting.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -206,7 +206,7 @@
 $message_parser->get_submitted_attachment_data();
 
 // Set uninitialized variables
-$uninit = array('post_attachment' => 0, 'poster_id' => 0, 'enable_magic_url' => 0, 'topic_status' => 0, 'topic_type' => POST_NORMAL, 'subject' => '', 'topic_title' => '', 'post_time' => 0, 'post_edit_reason' => '');
+$uninit = array('post_attachment' => 0, 'poster_id' => 0, 'enable_magic_url' => 0, 'topic_status' => ITEM_UNLOCKED, 'topic_type' => POST_NORMAL, 'subject' => '', 'topic_title' => '', 'post_time' => 0, 'post_edit_reason' => '');
 
 foreach ($uninit as $var_name => $default_value)
 {
@@ -510,8 +510,8 @@
 	
 	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$_REQUEST['subject'] = html_entity_decode($row['draft_subject'], HTML_ENTITIES);
-		$_REQUEST['message'] = html_entity_decode($row['draft_message'], HTML_ENTITIES);
+		$_REQUEST['subject'] = $row['draft_subject'];
+		$_REQUEST['message'] = $row['draft_message'];
 
 		$refresh = true;
 		$_CLASS['core_template']->assign('S_DRAFT_LOADED', true);
@@ -536,7 +536,7 @@
 	$topic_cur_post_id	= get_variable('topic_cur_post_id', 'POST', 0, 'int');
 
 	$subject = mb_strtolower(get_variable('subject', 'POST', ''));
-	$message_parser->message = get_variable('message', 'POST', '');
+	$message_parser->message = request_var('message', '', true);
 
 
 	$topic_time_limit	= (isset($_POST['topic_time_limit'])) ? (int) $_POST['topic_time_limit'] : (($mode != 'post') ? $topic_time_limit : 0);
@@ -841,6 +841,7 @@
 				'topic_first_post_id'	=> (isset($topic_first_post_id)) ? (int) $topic_first_post_id : 0,
 				'topic_last_post_id'	=> (isset($topic_last_post_id)) ? (int) $topic_last_post_id : 0,
 				'topic_time_limit'		=> (int) $topic_time_limit,
+				'topic_status'			=> (int) $posting_data['topic_status'],
 				'post_id'				=> (int) $post_id,
 				'topic_id'				=> (int) $topic_id,
 				'forum_id'				=> (int) $forum_id,
@@ -1482,6 +1483,7 @@
 				'topic_first_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? stripslashes($username) : $_CLASS['core_user']->data['username'],
 				'topic_type'		=> $topic_type,
 				'topic_time_limit'	=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'topic_status'		=> $data['topic_status'],
 				'topic_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0
 			);
 

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Forums/viewforum.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -66,21 +66,21 @@
 }
 else
 {
-		if ($config['load_db_lastread'])
-		{
-			$sql_lastread = 'LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-				AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
-			$lastread_select = ', ft.mark_time ';
-		}
-		else
-		{
-			$sql_lastread = $lastread_select = '';
-			$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
-		}
+	if ($config['load_db_lastread'])
+	{
+		$sql_lastread = 'LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+			AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
+		$lastread_select = ', ft.mark_time ';
+	}
+	else
+	{
+		$sql_lastread = $lastread_select = '';
+		$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+	}
 
-		$sql = "SELECT f.*, fw.notify_status $lastread_select 
-			FROM " . FORUMS_FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ") $sql_lastread
-			WHERE f.forum_id = $forum_id";
+	$sql = "SELECT f.*, fw.notify_status $lastread_select 
+		FROM " . FORUMS_FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ") $sql_lastread
+		WHERE f.forum_id = $forum_id";
 }
 
 $result = $_CLASS['core_db']->query($sql);
@@ -187,7 +187,7 @@
 	if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
 	{
 		$notify_status = (isset($forum_data['notify_status'])) ? $forum_data['notify_status'] : NULL;
-		$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, $notify_status);
+		$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, 0, $notify_status);
 	}
 	else
 	{
@@ -224,6 +224,7 @@
 		{
 			$start = 0;
 		}
+
 		$topics_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_topics'] : 0;
 		$sql_limit_time = "AND t.topic_last_post_time >= $min_post_time";
 	}
@@ -295,11 +296,16 @@
 	$rowset = $announcement_list = $topic_list = array();
 
 	$sql_from = FORUMS_TOPICS_TABLE.' t ';
-	$sql_from .= ($_CLASS['core_user']->is_user && $config['load_db_lastread']) ? ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : '';
+	$sql_select = '';
 
-	$sql_approved = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1';
-	$sql_select = (($config['load_db_lastread'] || $config['load_db_track']) && $_CLASS['core_user']->is_user) ? ', tt.mark_time' : '';
+	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
+	{
+		$sql_from .= ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+		$sql_select .= ', tt.mark_time';
+	}
 
+	$sql_approved = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
+
 	if ($forum_data['forum_type'] == FORUM_POST)
 	{
 		// Obtain announcements ... removed sort ordering, sort by time in all cases
@@ -322,6 +328,7 @@
 	$store_reverse = false;
 	$sql_limit = $config['topics_per_page'];
 
+// what's this store_reverse all about ?
 	if ($start > $topics_count / 2)
 	{
 		$store_reverse = true;
@@ -343,7 +350,7 @@
 	}
 
 	// Obtain other topics
-	$sql_where = ($forum_data['forum_type'] == FORUM_POST || !sizeof($active_forum_ary)) ? "= $forum_id" : 'IN (' . implode(', ', $active_forum_ary['forum_id']) . ')';
+	$sql_where = ($forum_data['forum_type'] == FORUM_POST || empty($active_forum_ary)) ? "= $forum_id" : 'IN (' . implode(', ', $active_forum_ary['forum_id']) . ')';
 	$sql = "SELECT t.* $sql_select
 		FROM $sql_from
 		WHERE t.forum_id $sql_where
@@ -364,10 +371,10 @@
 
 	// we only update the mark if this is made into an (int) time
 	// We don't check when $start is used
-	$mark_forum_read = ($start) ? false : true;
+	$mark_forum_read = ($sql_start || $sql_limit != $config['topics_per_page'] || $sql_limit_time) ? false : true;
 
 	// Okay, lets dump out the page ...
-	if (sizeof($topic_list))
+	if (!empty($topic_list))
 	{
 		if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
 		{
@@ -419,7 +426,7 @@
 			$s_type_switch_test = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
 
 			// Replies
-			$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
+			$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
 
 			if ($row['topic_status'] == ITEM_MOVED)
 			{

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Forums/viewtopic.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -150,9 +150,9 @@
 
 if ($_CLASS['core_user']->is_user)
 {
-	$extra_fields .= ', tw.notify_status';
+	$extra_fields .= ', tw.notify_status, tw.topic_id AS watch_topic';
 	$join_sql_table .= ' LEFT JOIN ' . FORUMS_WATCH_TABLE . ' tw ON (tw.user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-		AND (tw.forum_id = $forum_id OR tw.topic_id = $topic_id))";
+		AND tw.forum_id = $forum_id AND tw.topic_id IN ($topic_id, 0))";
 
 	if ($config['allow_bookmarks'])
 	{
@@ -193,9 +193,14 @@
 }
 
 // Are we watching this topic?
-$topic_data['notify_status'] = isset($topic_data['notify_status']) ? $topic_data['notify_status'] : null;
-$s_watching_topic = watch_topic_forum('topic', $_CLASS['core_user']->data['user_id'], $topic_id, $topic_data['notify_status'], $start);
+if (!isset($topic_data['notify_status']))
+{
+	$topic_data['notify_status'] = null;
+	$topic_data['watch_topic'] = false;
+}
 
+$s_watching_topic = watch_topic_forum('topic', $_CLASS['core_user']->data['user_id'], $forum_id, $topic_id, $topic_data['notify_status'], $start);
+
 // Bookmarks
 if ($config['allow_bookmarks'] && $_CLASS['core_user']->is_user && request_var('bookmark', 0))
 {
@@ -394,21 +399,21 @@
 		}
 	}
 
-	$s_can_vote = (((!sizeof($cur_voted_id) && $_CLASS['auth']->acl_get('f_vote', $forum_id)) || 
+	$s_can_vote = (((empty($cur_voted_id) && $_CLASS['auth']->acl_get('f_vote', $forum_id)) || 
 		($_CLASS['auth']->acl_get('f_votechg', $forum_id) && $poll_vote_change)) &&
 		(($poll_length != 0 && $poll_start + $poll_length > time()) || $poll_length == 0) &&
 		$topic_data['topic_status'] != ITEM_LOCKED && 
 		$topic_data['forum_status'] != ITEM_LOCKED) ? true : false;
 		
-		$s_display_results = (!$s_can_vote || ($s_can_vote && sizeof($cur_voted_id)) || $view == 'viewpoll') ? true : false;
+		$s_display_results = (!$s_can_vote || ($s_can_vote && !empty($cur_voted_id)) || $view == 'viewpoll') ? true : false;
 		
 	if ($update && $s_can_vote)
 	{
-		if (!sizeof($voted_id) || sizeof($voted_id) > $poll_max_options)
+		if (empty($voted_id) || !empty($voted_id) > $poll_max_options)
 		{
 			$_CLASS['core_display']->meta_refresh(5, generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id"));
 
-			$message = (!sizeof($voted_id)) ? 'NO_VOTE_OPTION' : 'TOO_MANY_VOTE_OPTIONS';
+			$message = empty($voted_id) ? 'NO_VOTE_OPTION' : 'TOO_MANY_VOTE_OPTIONS';
 			$message = $_CLASS['core_user']->lang[$message] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id").'">', '</a>');
 			trigger_error($message);
 		}
@@ -483,7 +488,7 @@
 		require_once($site_file_root.'includes/forums/bbcode.php');
 		$poll_bbcode = new bbcode();
 		
-		$size = sizeof($poll_info);
+		$size = !empty($poll_info);
 		for ($i = 0, $size; $i < $size; $i++)
 		{
 			$poll_bbcode->bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
@@ -757,7 +762,7 @@
 			}
 			else
 			{
-				if (isset($ranks['normal']) && sizeof($ranks['normal']))
+				if (isset($ranks['normal']) && !empty($ranks['normal']))
 				{
 					foreach ($ranks['normal'] as $rank)
 					{
@@ -801,7 +806,7 @@
 $_CLASS['core_db']->free_result($result);
 
 // Generate online information for user
-if ($config['load_onlinetrack'] && sizeof($id_cache))
+if ($config['load_onlinetrack'] && !empty($id_cache))
 {
 	$sql = 'SELECT session_user_id, session_hidden, MAX(session_time) as online_time
 		FROM ' . SESSIONS_TABLE . ' 
@@ -820,7 +825,7 @@
 unset($id_cache);
 
 // Pull attachment data
-if (sizeof($attach_list))
+if (!empty($attach_list))
 {
 	if ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id))
 	{
@@ -840,7 +845,7 @@
 		$_CLASS['core_db']->free_result($result);
 
 		// No attachments exist, but post table thinks they do so go ahead and reset post_attach flags
-		if (!sizeof($attachments))
+		if (empty($attachments))
 		{
 			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0 
@@ -848,7 +853,7 @@
 			$_CLASS['core_db']->query($sql);
 
 			// We need to update the topic indicator too if the complete topic is now without an attachment
-			if (sizeof($rowset) != $total_posts)
+			if (!empty($rowset) != $total_posts)
 			{
 				// Not all posts are displayed so we query the db to find if there's any attachment for this topic
 				$sql = 'SELECT a.post_msg_id as post_id
@@ -942,7 +947,7 @@
 	$message = $row['post_text'];
 
 	// If the board has HTML off but the post has HTML on then we process it, else leave it alone
-	if ((!$config['allow_html'] || !$_CLASS['auth']->acl_get('f_html', $forum_id)) && $row['enable_html'])
+	if ($row['enable_html'] && (!$config['allow_html'] || !$_CLASS['auth']->acl_get('f_html', $forum_id)))
 	{
 		$message = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $message);
 	}
@@ -956,7 +961,7 @@
 	// Always process smilies after parsing bbcodes
 	$message = smiley_text($message);
 
-	if (isset($attachments[$row['post_id']]) && sizeof($attachments[$row['post_id']]))
+	if (isset($attachments[$row['post_id']]) && !empty($attachments[$row['post_id']]))
 	{
 		$unset_attachments = parse_inline_attachments($message, $attachments[$row['post_id']], $update_count, $forum_id);
 
@@ -989,7 +994,7 @@
 	if (($row['post_edit_count'] && $config['display_last_edited']) || $row['post_edit_reason'])
 	{
 		// Get usernames for all following posts if not already stored
-		if (!sizeof($post_edit_list) && $row['post_edit_reason'])
+		if (empty($post_edit_list) && $row['post_edit_reason'])
 		{
 			// Remove all post_ids already parsed (we do not have to check them)
 			$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);
@@ -1041,7 +1046,7 @@
 	$post_attachments = array();
 
 	// Remove this foreach.
-	if (isset($attachments[$row['post_id']]) && sizeof($attachments[$row['post_id']]))
+	if (isset($attachments[$row['post_id']]) && !empty($attachments[$row['post_id']]))
 	{
 		foreach ($attachments[$row['post_id']] as $attachment)
 		{
@@ -1146,6 +1151,7 @@
 $topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
 
 $pagination = generate_pagination("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
+$topic_data['topic_title'] = censor_text($topic_data['topic_title']);
 
 // Send vars to template
 $_CLASS['core_template']->assign_array(array(
@@ -1153,14 +1159,14 @@
 	'FORUM_NAME' 		=> $topic_data['forum_name'],
 	'FORUM_DESC'		=> $topic_data['forum_desc'],
 	'TOPIC_ID' 			=> $topic_id,
-	'TOPIC_TITLE' 		=> censor_text($topic_data['topic_title']),
+	'TOPIC_TITLE' 		=> $topic_data['topic_title'],
 	'PAGINATION'		=> $pagination['formated'],
 	'PAGINATION_ARRAY'	=> $pagination['array'],
 	'PAGE_NUMBER' 		=> on_page($total_posts, $config['posts_per_page'], $start),
 	'TOTAL_POSTS'		=> ($total_posts == 1) ? $_CLASS['core_user']->lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']->lang['VIEW_TOPIC_POSTS'], $total_posts), 
 	'U_MCP' 			=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
 
-	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && sizeof($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
+	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && !empty($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
 
 	'POST_IMG' 		=> ($topic_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', 'FORUM_LOCKED') : $_CLASS['core_user']->img('btn_post', 'POST_NEW_TOPIC'),
 	'QUOTE_IMG' 	=> $_CLASS['core_user']->img('btn_quote', 'REPLY_WITH_QUOTE'),
@@ -1201,6 +1207,7 @@
 	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
 	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
 
+	'S_WATCH_FORUMS'		=> $topic_data['watch_topic'] ? false : true,
 	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'], 
 	'L_WATCH_TOPIC' 		=> $s_watching_topic['title'], 
 
@@ -1209,7 +1216,7 @@
 	
 	'U_POST_NEW_TOPIC' 		=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
 	'U_POST_REPLY_TOPIC' 	=> generate_link("Forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id"),
-	'U_BUMP_TOPIC'			=> (bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
+	'U_BUMP_TOPIC'			=> bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id']) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
 );
 
 // Update topic view and if necessary attachment view counters ... but only
@@ -1224,7 +1231,7 @@
 	$_CLASS['core_db']->query($sql);
 
 	// Update the attachment download counts
-	if (sizeof($update_count))
+	if (!empty($update_count))
 	{
 		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
 			SET download_count = download_count + 1 
@@ -1238,7 +1245,6 @@
 {
 	// Now lets get the all topics that are in the markable range,
 	// with is the max topics displayed on the forum's viewforum page
-// Need forum_topic_per_page along with whatever users have to after listing
 
 	// Get the user's last mark time for this forums
 	$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
@@ -1250,7 +1256,7 @@
 	$_CLASS['core_db']->free_result($result);
 		
 	$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . FORUMS_TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON ( tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
+			LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON (tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
 				WHERE t.forum_id = $forum_id
 					ORDER BY topic_last_post_time DESC";
 
@@ -1265,11 +1271,13 @@
 		do
 		{
 			$last_mark_time = max($row['mark_time'], $forum_marktime);
+
 			if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
 			{
 				// We have a winner/loser
 				// Set so the forum isn't marked
 				$update_forum_mark = false;
+
 				break;
 			}
 		}
@@ -1297,7 +1305,7 @@
 
 make_jumpbox(generate_link('Forums&amp;file=viewforum'), $forum_id);
 
-$_CLASS['core_display']->display(array($_CLASS['core_user']->lang['VIEW_TOPIC'], $topic_data['topic_title']), 'modules/Forums/viewtopic_body.html');
+$_CLASS['core_display']->display(array($_CLASS['core_user']->get_lang('VIEWING_TOPIC'), $topic_data['topic_title']), 'modules/Forums/viewtopic_body.html');
 
 //Move if we can
 function topic_last_read($topic_id, $forum_id)

Modified: trunk/modules/Members_List/index.php
===================================================================
--- trunk/modules/Members_List/index.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/modules/Members_List/index.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -127,12 +127,12 @@
 			
 			if ($row['group_type'] == GROUP_HIDDEN && !$_CLASS['auth']->acl_gets('a_group', 'a_groupadd', 'a_groupdel') && $row['ug_user_id'] != $_CLASS['core_user']->data['user_id'])
 			{
-				$group_name = $_CLASS['core_user']->lang['UNDISCLOSED'];
+				$group_name = $_CLASS['core_user']->get_lang('UNDISCLOSED');
 				$u_group = '';
 			}
 			else
 			{
-				$group_name = ($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'];
+				$group_name = isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name'];
 				$u_group = generate_link('Members_List&amp;mode=group&amp;g='.$row['group_id']);
 			}
 
@@ -319,7 +319,7 @@
 		
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$group_options .= '<option value="' . $row['group_id'] . '"'.(($member['user_group'] == $row['group_id'])? ' selected="selected"' : '').'>' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+			$group_options .= '<option value="' . $row['group_id'] . '"'.(($member['user_group'] == $row['group_id'])? ' selected="selected"' : '').'>' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
 		}
 		$_CLASS['core_db']->free_result($result);
 		
@@ -498,7 +498,6 @@
 
 			'S_PROFILE_ACTION'	=> generate_link('Members_List&amp;mode=group'),
 			'S_GROUP_OPTIONS'	=> $group_options,
-			'S_CUSTOM_FIELDS'	=> (isset($profile_fields['row']) && sizeof($profile_fields['row'])) ? true : false,
 			
 			'U_ADD_FRIEND'		=> generate_link('Control_Panel&amp;i=zebra&amp;add=' . urlencode($member['username'])),
 			'U_ADD_FOE'			=> generate_link('Control_Panel&amp;i=zebra&amp;mode=foes&amp;add=' . urlencode($member['username'])),
@@ -508,19 +507,7 @@
 			'L_VIEWING_PROFILE' 	=> sprintf($_CLASS['core_user']->lang['VIEWING_PROFILE'], $member['username']),
 		));
 		
-		if (isset($profile_fields['row']) && sizeof($profile_fields['row']))
-		{
-			$_CLASS['core_template']->assign($profile_fields['row']);
-		}
-		
-		if (isset($profile_fields['blockrow']) && sizeof($profile_fields['blockrow']))
-		{
-			foreach ($profile_fields['blockrow'] as $field_data)
-			{
-				$_CLASS['core_template']->assign_vars_array('custom_fields', $field_data);
-			}
-		}
-		break;
+	break;
 
 	case 'email':
 		// Send an email
@@ -897,7 +884,7 @@
 
 				case GROUP_UNRESTRAINED:
 					$group_row['group_type'] = 'FREE';
-					break;
+				break;
 			}
 
 			$avatar_img = '';
@@ -927,7 +914,7 @@
 
 			$_CLASS['core_template']->assign_array(array(
 				'GROUP_DESC'    => $group_row['group_description'],
-				'GROUP_NAME'    => $group_row['group_name'],
+				'GROUP_NAME'    => isset($_CLASS['core_user']->lang['G_' . $group_row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $group_row['group_name']] : $group_row['group_name'],
 				'GROUP_COLOR'   => $group_row['group_colour'],
 				'GROUP_TYPE'	=> $_CLASS['core_user']->lang['GROUP_IS_'. $group_row['group_type']],
 				'GROUP_RANK'	=> $rank_title,

Deleted: trunk/themes/login_body_full.css
===================================================================
--- trunk/themes/login_body_full.css	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/themes/login_body_full.css	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,42 +0,0 @@
-body {
-    font-family: Verdana, Helvetica, sans-serif;
-    font-size: 10px;
-    margin-top: 10%;
-    padding: 0px;
-    background-color: white;
-    background: url(/images/bg.gif);
-}
-
-.error { color: red; }
-
-/* 
-	TABLE
-*/
-th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699; background-image: url('./images/cellpic3.gif'); white-space: nowrap; padding-left: 5px; padding-right: 5px; }
-.tablebg { background-color: #A9B8C2; }
-.catdiv { height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: white; background-image: url('./images/cellpic2.jpg'); background-repeat: repeat-y; }
-.cat { height: 28px; margin: 0px; padding: 0px; border: 0px; background-color: #C7D0D7; background-image: url('../images/cellpic1.gif'); text-indent: 4px; }
-.row1 { background-color: #ECECEC; padding: 4px; }
-.row2 { background-color: #DCE1E5; padding: 4px; }
-.row3 { background-color: #C0C8D0; padding: 4px; }
-.rowgood { background-color: #C2D6CD; padding: 4px; }
-.rowneutral { background-color: #CAC1D7; padding: 4px; }
-.rowbad { background-color: #D7C1C3; padding: 4px; }
-.spacer { background-color: #D1D7DC; }
-hr { height: 1px; border-width: 0px; background-color: #D1D7DC; color: #D1D7DC }
-
-
-/* 
-	ANCHOR
-*/
-a:link { color: #005784; text-decoration: none; }
-a:active { color: #005784; text-decoration: none; }
-a:visited { color: #005784; text-decoration: none; }
-a:hover { color: #000000; text-decoration: none; }
-
-form { margin: 0px; padding: 0px; border: 0px; }
-input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
-textarea { background-color: white; color: black; font-family: Verdana, serif; font-size: 110%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
-.btnmain { font-weight: bold; background-color: #FAFAFA; border-style: solid; border-width: 1px; }
\ No newline at end of file

Modified: trunk/themes/viperal/index.php
===================================================================
--- trunk/themes/viperal/index.php	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/themes/viperal/index.php	2005-09-03 01:42:07 UTC (rev 96)
@@ -1,17 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 if (!defined('VIPERAL'))
 {
     die;
@@ -51,7 +60,7 @@
 		}
 		else
 		{
-			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME'].' &gt; '.(is_array($_CORE_MODULE['title']) ? implode(' &gt; ', $_CORE_MODULE['title']) : $_CORE_MODULE['title']));
+			$_CLASS['core_template']->assign('PAGE_TITLE', $_CLASS['core_user']->lang['HOME'].' &gt; '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']));
 		}
 		
 		$_CLASS['core_blocks']->display(BLOCK_LEFT);

Added: trunk/themes_admin/viperal_admin/style/images/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/background.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/background.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/bg.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/bg.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/cellpic.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/cellpic.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/created_by.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/created_by.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/curve.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/curve.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_faq.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_faq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_groups.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_groups.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_login.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_login.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_members.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_members.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_message.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_message.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_profile.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_register.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_register.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/icon_mini_search.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/icon_mini_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/index.htm
===================================================================
--- trunk/themes_admin/viperal_admin/style/images/index.htm	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/themes_admin/viperal_admin/style/images/index.htm	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,16 @@
+<html>
+<head>
+<title>subSilver created by subBlue Design</title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">
+	<tr>
+		<td align="center" valign="middle"><a href="http://www.subblue.com/" target="_new"><img src="created_by.jpg" width="400" height="300" border="0" alt="Created by subBlue Design" /></a></td>
+	</tr>
+</table>
+
+</body>
+</html>
\ No newline at end of file

Added: trunk/themes_admin/viperal_admin/style/images/logo-christmas.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/logo-christmas.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/sitelogo.jpg
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/sitelogo.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/spacer.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/images/whosonline.gif
===================================================================
(Binary files differ)


Property changes on: trunk/themes_admin/viperal_admin/style/images/whosonline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/themes_admin/viperal_admin/style/style.css
===================================================================
--- trunk/themes_admin/viperal_admin/style/style.css	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/themes_admin/viperal_admin/style/style.css	2005-09-03 01:42:07 UTC (rev 96)
@@ -0,0 +1,444 @@
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+
+    /* Needed for opera */
+    margin: 0px; 
+
+    padding: 0px;
+    background: url(/images/bg.gif);
+}
+
+.logo
+{
+	position:fixed;
+	top: -1px;
+	left: -1px;
+	z-index: 1;
+}
+
+#nav li a
+{
+	display: block;
+	padding: 5px 10px 5px 5px; 
+	border-bottom: 1px solid black;
+	color: black;
+}
+
+#nav li a:hover
+{
+	background-color: #FFFFFF;
+	color: black;
+	font-weight: bold; 
+	letter-spacing: .6px; 
+}
+
+/* 
+	LAYOUT CONTAINERS
+*/
+#page
+{
+	position: relative;
+	height: 15px;
+	background: url(images/curve.gif) top left no-repeat;
+	background-color: #eee;
+	color: #999;
+	padding: 2px;
+	padding-left: 20px;
+}
+
+#blocksleft
+{
+	position:absolute;
+	top: 20px;
+	left:0px;
+	width: 180px;
+	height:100%;
+	margin: 0px 0px 10px 0px;
+}
+	
+#blocksright
+{
+	position:absolute;
+	top: 0px;
+	right: 0px;
+	width: 180px;
+	margin: 0px 0px 10px 0px;
+}
+
+/* 
+	MAIN SECTION
+*/
+.mainbody
+{
+	position: relative;
+	height: 100%;
+	border-left:1px solid #ccc;
+	border-top:1px solid #ccc;
+	background-color:white;
+}
+	
+.bodymain
+{
+	position: relative;
+	border-top: 1px solid #ccc;
+	height: 100%;
+	min-height: 1500px;
+	border-right:1px dashed #ccc;
+}
+
+.main
+{
+    width: 100%;
+    background-color: #eee;
+}
+
+/* 
+	FOOTER
+*/	
+.footer
+{
+	position:relative;
+	border-top:1px dashed black;
+	padding:5px;
+	background-color:white;
+}
+
+/* 
+	SIDE BLOCKS
+*/
+.blocks
+{
+	position: relative;
+	margin: 0px 0px 10px 0px;
+	min-height: 12px;
+	padding: 5px;
+}
+
+.blocks .top
+{
+  position: relative;
+  border-bottom: 1px dashed;
+  padding: 2px;
+  background-color:#C7D0D7;
+}
+
+.blocks .content
+{
+	width : 100%;
+}
+
+/* 
+	GENERAL CONTANER
+*/
+.OpenTable
+{
+	padding: 5px;
+	position:relative;
+}
+
+.OpenTable .outer
+{
+	border-top: 1px solid #ccc;
+	border-bottom: 1px solid #ccc;
+	background: #C7D0D7;
+	padding:1px;
+}	
+
+.OpenTable .inner
+{
+	border: 1px dashed #ccc;
+	background: #F2F1ED;
+	padding:5px;
+}
+
+img
+{
+	border: 0px;
+}
+
+
+.forumrules
+{
+	border: 1px solid #A9B8C2;
+	background-color: #ECECEC; padding: 4px;
+}
+
+.page_link_normal
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
+.page_link_current
+{
+	background: #F2F1ED;
+	border: 1px solid #A9B8C2;
+	padding: 1px 3px 1px 3px;
+	margin: 2px
+}
+
+/* 
+	TEXT
+*/
+
+h1 { margin: 0px; color: black; font-family: 'Trebuchet MS', Verdana, sans-serif; font-weight: bold; font-size: 140%; text-decoration: none; }
+h2 { margin: 0px; font-family: Arial, Helvetica, sans-serif; font-weight: bold; font-size: 130%; text-decoration: none; line-height: 120%; }
+h3 { margin: 0px; font-size: 120%; font-weight: bold; font-family: Verdana, serif; line-height: 120%; }
+h4 { margin: 0px; font-size: 130%; font-weight: bold; }
+
+p.moderators { margin: 0px; float: left; color: black; font-size: 100%; font-weight: bold; }
+p.linkmcp { margin: 0px; float: right; font-size: 100%; white-space: nowrap; }
+p.breadcrumbs { margin: 0px; float: left; color: black; font-size: 100%; font-weight: bold; white-space: normal; }
+p.datetime { margin: 0px; float: right; font-size: 100%; white-space: nowrap; }
+p.searchbar { margin: 0px; font-size: 100%; white-space: nowrap; } 
+p.searchbarreg { margin: 0px; float: right; font-size: 100%; white-space: nowrap; }
+
+p.forumdesc { margin: 0px 4px 0px 0px; padding: 4px; font-size: 100%; }
+a.forumlink { color: #069; font-size: 120%; font-weight: bold; }
+
+p.topictitle { margin: 1px 0px; display: inline; font-size: 100%; font-weight: bold; }
+p.topicauthor { margin: 1px 0px; font-size: 100%; }
+p.topicdetails { margin: 1px 0px; font-size: 95%; }
+
+p.postreported { margin: 1px 0px; color: red; }
+p.postapprove { margin: 1px 0px; color: green; }
+
+.postauthor { color: #000000; font-size: 100%; }
+.postdetails { color: #000000; font-size: 100%; }
+.postbody { font-size: 110%; line-height: 140%; }
+.posthilit { background-color: yellow; }
+
+
+.nav { margin: 0px; color: black; font-size: 100%; font-weight: bold; }
+.pagination { padding: 4px; color: black; font-size: 100%; font-weight: bold; }
+
+
+.cattitle {  }
+
+.gen { margin: 1px 1px; font-size: 120%; }
+.genmed { margin: 1px 1px; font-size: 110%; }
+.gensmall { margin: 1px 1px; font-size: 100%; }
+
+.copyright { color: #444; font-weight: normal; font-size: 100%; font-family: Verdana, Arial, Helvetica, sans-serif;}
+.titles { color: black; font-family: Arial, Helvetica, sans-serif; font-weight: bold; font-size: 130%; text-decoration: none;  }
+.error { color: red; }
+
+/* 
+	TABLE
+*/
+th
+{
+	height: 28px;
+	color: #FFA34F;
+	font-size: 110%;
+	font-weight: bold;
+	background-color: #006699;
+	background-image: url('./images/cellpic3.gif');
+	white-space: nowrap;
+	padding-left: 5px;
+	padding-right: 5px;
+}
+
+.tablebg
+{
+	background-color: #A9B8C2;
+}
+
+.catdiv
+{
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color:white;
+	background-image: url('./images/cellpic2.jpg');
+	background-repeat: repeat-y;
+}
+
+.cat
+{
+	height: 28px;
+	margin: 0px;
+	padding: 0px;
+	border: 0px;
+	background-color: #C7D0D7;
+	background-image: url('../images/cellpic1.gif');
+	text-indent: 4px;
+}
+
+.row1
+{
+	background-color: #ECECEC;
+	padding: 4px;
+}
+.row2
+{
+	background-color: #DCE1E5;
+	padding: 4px;
+}
+
+.row3
+{
+	background-color: #C0C8D0;
+	padding: 4px;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+hr
+{
+	height: 1px; border-width: 0px; background-color: #D1D7DC; color: #D1D7DC
+}
+
+
+/* 
+	ANCHOR
+*/
+a:link
+{
+	color: #005784; text-decoration: none;
+}
+
+a:active, a:visited
+{
+	color: #005784; text-decoration: none;
+}
+
+a:hover
+{
+	color: #000000; text-decoration: none;
+}
+
+a.topictitle:visited
+{
+	color: #5493B4; text-decoration: none;
+}
+
+a.th:link, a.th:active, a.th:visited
+{
+	color: #FFA34F; text-decoration: none;
+}
+
+a.th:hover
+{
+	color: #FFA34F; text-decoration: underline;
+}
+
+
+/*
+	FORM
+*/
+form
+{
+	margin: 0px; padding: 0px;
+}
+
+input
+{
+	font-size: 100%; color: black; font-family: Verdana, serif; font-weight: normal;
+}
+
+textarea
+{
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 110%; font-weight: normal;
+	border:1px solid #999;
+	padding: 3px;
+}
+
+select
+{
+	background-color: white;
+	font-family: Verdana, serif;
+	font-size: 100%;
+	font-weight: normal;;
+}
+
+.button, .btnbbcode, .button_main
+{
+	background-color: #FAFAFA;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+.button_main
+{
+	font-weight: bold;
+}
+
+/* Rename this */
+.post
+{
+	background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;
+}
+
+.helpline
+{
+	background-color: #DEE3E7; border-style: none;
+}
+
+/* Rename this */
+
+
+/* 
+	BBCODE 
+*/
+.quotetitle { margin: 10px 5px 0px 5px; padding: 4px; border-width: 1px 1px 0px 1px; border-style: solid; border-color: #A9B8C2; color: black; background-color: #A9B8C2; font-size: 8pt; }
+.quotecontent { margin: 0px 5px 10px 5px; padding: 5px; border-color: #A9B8C2; border-width: 0px 1px 1px 1px; border-style: solid; color: black; font-weight: normal; font-size: 8pt; font-family: Verdana, sans-serif; background-color: #FAFAFA; }
+
+.codetitle { margin: 10px 5px 0px 5px; padding: 4px; border-width: 1px 1px 0px 1px; border-style: solid; border-color: #A9B8C2; color: black; background-color: #A9B8C2; font-size: 8pt; }
+.codecontent { margin: 0px 5px 10px 5px; padding: 5px; border-color: #A9B8C2; border-width: 0px 1px 1px 1px; border-style: solid; color: black; font-weight: normal; color: #006600; font-weight: normal; font-size: 8pt; font-family: 'Courier New', monospace; background-color: #FAFAFA; }
+
+.syntaxbg { color: #FFFFFF; }
+.syntaxcomment { color: #FF8000; }
+.syntaxdefault { color: #0000BB; }
+.syntaxhtml { color: #000000; }
+.syntaxkeyword { color: #007700; }
+.syntaxstring { color: #DD0000; }
+
+.poster_details
+{
+	padding: 3px;
+	width: 85%;
+	border: 1px solid #C7D0D7;
+	border-right: 2px solid #C7D0D7;
+	border-left: 1px solid #C7D0D7;
+	border-bottom: 2px solid #C7D0D7;
+	margin-bottom: 3px;
+}
+
+/*
+	PM
+*/
+
+.pm_message_reported_colour
+{
+	background-color: #FFFFFF;
+}
+
+.pm_marked_colour
+{
+	background-color: #000000;
+}
+.pm_replied_colour
+{
+	background-color: #A9B8C2;
+}
+
+.pm_friend_colour
+{
+	background-color: #007700;
+}
+
+.pm_foe_colour
+{
+	background-color: #DD0000;
+}
\ No newline at end of file

Modified: trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- trunk/themes_admin/viperal_admin/template/header.html	2005-08-31 14:26:25 UTC (rev 95)
+++ trunk/themes_admin/viperal_admin/template/header.html	2005-09-03 01:42:07 UTC (rev 96)
@@ -31,7 +31,7 @@
 { $HEADER_BODY }
 
 <a name="Top"></a>
-
+<div style="position:fixed;top: -1px;left: -1px;z-index: 1;">
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
 	<tr>
 		<td nowrap="nowrap" class="row2"><a href="{ $LINK_HOME }">{ $L_SITE_INDEX }</a></td>
@@ -40,7 +40,13 @@
 		<td width="100%" class="row2"></td>
 	</tr>
 </table>
+</div>
 
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tr>
+		<td height="20" class="row2"></td>
+	</tr>
+</table>
 { $MENU_MAIN }
 
 <!-- include blockleft.html -->



From viperal at berlios.de  Sat Sep  3 05:13:41 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 3 Sep 2005 05:13:41 +0200
Subject: [Viperals-svncheckins] r97 - in trunk: admin admin/functions includes includes/templates/admin/modules modules/Quick_Message
Message-ID: <200509030313.j833DfiF001099@sheep.berlios.de>

Author: viperal
Date: 2005-09-03 05:13:23 +0200 (Sat, 03 Sep 2005)
New Revision: 97

Removed:
   trunk/includes/templates/admin/modules/edit.html
Modified:
   trunk/admin/blocks.php
   trunk/admin/functions/block_functions.php
   trunk/admin/modules.php
   trunk/includes/functions.php
   trunk/includes/templates/admin/modules/index.html
   trunk/modules/Quick_Message/install.php
Log:


Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/admin/blocks.php	2005-09-03 03:13:23 UTC (rev 97)
@@ -99,8 +99,8 @@
 blocks_block('main');
 
 $result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
-	FROM '.BLOCKS_TABLE.'
-	WHERE block_position IN ('.BLOCK_RIGHT.', '.BLOCK_TOP.', '.BLOCK_BOTTOM.', '.BLOCK_LEFT.') ORDER BY block_position, block_order ASC');
+	FROM ' . BLOCKS_TABLE . '
+	WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ') ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
 $in_position = false;

Modified: trunk/admin/functions/block_functions.php
===================================================================
--- trunk/admin/functions/block_functions.php	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/admin/functions/block_functions.php	2005-09-03 03:13:23 UTC (rev 97)
@@ -162,7 +162,7 @@
 
 function block_delete($id, $return_link = false)
 {
-    global $_CLASS;
+	global $_CLASS;
 
 	$result = $_CLASS['core_db']->query('SELECT block_order, block_type, block_position FROM ' . BLOCKS_TABLE . ' WHERE block_id='.$id);
 	$block = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -175,15 +175,15 @@
 
 	check_position($block['block_position']);
 
-    if (display_confirmation())
-    {
-		$_CLASS['core_db']->query('DELETE from ' . BLOCKS_TABLE . ' where block_id='.$id);
-        $result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
+	if (display_confirmation())
+	{
+		$_CLASS['core_db']->query('DELETE from ' . BLOCKS_TABLE . ' where block_id = '.$id);
+		$result = $_CLASS['core_db']->query('UPDATE ' . BLOCKS_TABLE . ' SET block_order = block_order-1 WHERE block_position='.$block['block_position'].' AND block_order > '.$block['block_order']);
 
-        $_CLASS['core_cache']->destroy('blocks');
+		$_CLASS['core_cache']->destroy('blocks');
         
-        if ($return_link)
-        {
+		if ($return_link)
+		{
 			trigger_error('Block deleted<br/><a href="'.$return_link.'">Click here to return</a>');	        
 		}
 	}

Modified: trunk/admin/modules.php
===================================================================
--- trunk/admin/modules.php	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/admin/modules.php	2005-09-03 03:13:23 UTC (rev 97)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 if (VIPERAL != 'Admin') 
 {
 	die;
@@ -22,19 +30,6 @@
 
 $mode = get_variable('mode', 'GET', false);
 
-function get_id($rediret = true)
-{
-	$id = get_variable('id', 'GET', false, 'integer');
-
-	if (!$id && $rediret)
-	{
-		url_redirect(generate_link('modules', array('admin' => true)));
-		die;
-	}
-	
-	return $id;
-}
-
 function check_type($type, $redirect = true)
 {
 	$appoved_type = array(MODULE_NORMAL);
@@ -44,8 +39,7 @@
 	{
 		if ($redirect)
 		{
-			url_redirect(generate_link('modules', array('admin' => true)));
-			die;
+			redirect(generate_link('modules', array('admin' => true, 'full' => true)));
 		}
 		return false;
 	}
@@ -53,121 +47,191 @@
 	return true;
 }
 
-switch ($mode)
+if (isset($_REQUEST['mode']))
 {
-	case 'change':
-		modules_change(get_id());
-		url_redirect(generate_link('modules', array('admin' => true)));
-    break;
-    
- 	
-    case 'uninstall':
-		modules_uninstall();	
-    break;
-    
-	case 'auth':
-		$id = get_id();
+	if ($id = get_variable('id', 'GET', false, 'integer'))
+	{
+		switch ($_REQUEST['mode'])
+		{
+			
+			case 'change':
+				$result = $_CLASS['core_db']->query('SELECT module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$module = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$module)
+				{
+					trigger_error('MODULE_NOT_FOUND');
+				}
+			
+				check_type($module['module_type']);
+			
+				$status = ($module['module_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+				$result = $_CLASS['core_db']->query('UPDATE '. CORE_MODULES_TABLE . " SET module_status = $status WHERE module_id = $id");
+			break;
 		
-		$result = $_CLASS['core_db']->sql_query('SELECT type, auth FROM ' . CORE_MODULES_TABLE . ' WHERE id='.$id);
-		$module = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+			case 'uninstall':
+				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$module = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$module)
+				{
+					trigger_error('MODULE_NOT_FOUND');
+				}
+			
+				check_type($module['module_type']);
+				
+				if (display_confirmation())
+				{
+					if ($module['module_status'] !== STATUS_PENDING)
+					{
+						if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+						{
+							require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+							
+							$name = $module['module_name'].'_install';
+							$install = new $name;
+							
+							$install->uninstall();
+						}
+					}
+
+					$_CLASS['core_db']->query('DELETE from ' . CORE_MODULES_TABLE . ' where module_id = '.$id);
+				}
+			break;
+
+			case 'install':
+				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$module = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$module || $module['module_status'] !== STATUS_PENDING)
+				{
+					trigger_error($module ? 'MODULE_ALREADY_INSTALLED' : 'MODULE_NOT_FOUND');
+				}
+
+				check_type($module['module_type']);
+
+				if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+				{
+					require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+					
+					$name = $module['module_name'].'_install';
+					$install = new $name;
+					$error = $install->install();
+
+					if ($error == true)
+					{
+						$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE.' set module_status = '.STATUS_DISABLED.' WHERE module_id = '.$id);
+					}
+					else
+					{
+						// do something better than this
+						trigger_error($error);
+					}
+				}
+			break;
+
+			case 'auth':
+				$result = $_CLASS['core_db']->query('SELECT module_type, module_auth FROM ' . CORE_MODULES_TABLE . ' WHERE module_id = '.$id);
+				$module = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
 		
-		if (!$module)
-		{
-			trigger_error('MODULE_NOT_FOUND');
-		}
-	
-		$module['auth'] = ($module['auth']) ? unserialize($module['auth']) : '';
+				if (!$module)
+				{
+					trigger_error('MODULE_NOT_FOUND');
+				}
 		
-		check_type($module['type']);
+				$module['module_auth'] = ($module['module_auth']) ? unserialize($module['module_auth']) : '';
 		
-		if ($auth = $_CLASS['core_auth']->generate_auth_options($module['auth']))
-		{
-			$module['auth'] = ($auth === true) ? '' : $auth;
-			$auth = ($auth === true) ? '' : $_CLASS['core_db']->sql_escape(serialize($auth));
+				check_type($module['module_type']);
 		
-			$_CLASS['core_db']->sql_query('UPDATE '.CORE_MODULES_TABLE." set auth = '$auth' WHERE id = $id");
-			$_CLASS['core_cache']->destroy('blocks');
-		}
+				$_CLASS['core_display']->display_header();
 		
-		$_CLASS['core_display']->display_head();
-		$_CLASS['core_auth']->generate_auth_options($module['auth'], true);
-		$_CLASS['core_display']->display_footer();
-	
+				$auth = $_CLASS['core_auth']->generate_auth_options($module['module_auth']);
+		
+				if ($auth !== false)
+				{
+					if (is_null($auth))
+					{
+						$module['module_auth'] = '';
+						$auth = 'null';
+					}
+					else
+					{
+						$module['module_auth'] = $auth;
+						$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
+					}
+		
+					$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE." set module_status = $auth WHERE module_id = $id");
+					$_CLASS['core_cache']->destroy('blocks');
+				}
 
-    default:
-		modules_admin();
-	break;
+				$_CLASS['core_display']->display_footer();
+			break;
+		}
+	}
 }
 
-function modules_admin()
+
+$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' ORDER BY module_name');
+
+$modules = array();
+
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-    global $_CLASS, $site_file_root;
-	
-    $result = $_CLASS['core_db']->sql_query('SELECT * FROM '.CORE_MODULES_TABLE.' ORDER BY homepage DESC');
+	$modules[$row['module_type']][] = $row;
+}
+$_CLASS['core_db']->free_result($result);
 
-    $modules = array();
-    
-    while($row = $_CLASS['core_db']->sql_fetchrow($result))
-    {
-        $modules[(int) $row['type']][] = $row;
-    }
-	$_CLASS['core_db']->sql_freeresult($result);
+$admin_auth = false;
+$_CLASS['core_template']->assign('S_ADMIN_AUTH_LINK', $admin_auth);
 
-	$admin_auth = false;
-	$_CLASS['core_template']->assign('S_ADMIN_AUTH_LINK', $admin_auth);
+$module_type = array(MODULE_SYSTEM => 'system', MODULE_NORMAL => 'normal');
 
-    $module_type = array(MODULE_SYSTEM => 'system', MODULE_NORMAL => 'normal');
-    
-    foreach ($module_type as $type => $name)
-    {
-    	if (empty($modules[$type]))
-    	{
-			continue;
-    	}
+foreach ($module_type as $type => $name)
+{
+	if (empty($modules[$type]))
+	{
+		continue;
+	}
 
-    	foreach ($modules[$type] as $module)
+	foreach ($modules[$type] as $module)
+	{
+		$active = $module['module_status'] == STATUS_ACTIVE;
+
+		if ($module['module_status'] == STATUS_PENDING)
 		{
-			$_CLASS['core_template']->assign_vars_array($name.'_modules', array(
-					'ACTIVE'		=> ($module['active']) ? true : false,
-					'ACTIVE_LINK'	=> generate_link('modules&amp;mode=change&amp;id='.$module['id'], array('admin' => true)),
-					'CHANGE'		=> ($module['active']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
-					'ERROR'			=> '',
-					'EDIT_LINK'		=> generate_link('modules&amp;mode=edit&amp;id='.$module['id'], array('admin' => true)),
-					'AUTH_LINK'		=> generate_link('modules&amp;mode=auth&amp;id='.$module['id'], array('admin' => true)),
-					'ADMIN_AUTH_LINK'=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['id'], array('admin' => true)) : '' ,
-					'UNINSTALL_LINK'=> ($module['type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['id'], array('admin' => true)) : '',
-					'TITLE'			=> $module['title'],
-			));
+			$installed = false;
+			$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['module_id'], array('admin' => true));
 		}
-		unset($modules[$type], $module);
-    }
-       
-    $_CLASS['core_display']->display_head();
+		else
+		{
+			$installed = true;
+			$installer_link = ($module['module_type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['module_id'], array('admin' => true)) : '';
+		}
 
-	$_CLASS['core_template']->display('admin/modules/index.html');
-    
-    $_CLASS['core_display']->display_footer();
-}
+		$_CLASS['core_template']->assign_vars_array($name.'_modules', array(
+				'INSTALLED'		=> $installed,
+				'ACTIVE'		=> ($active),
+				'ACTIVE_LINK'	=> generate_link('modules&amp;mode=change&amp;id='.$module['module_id'], array('admin' => true)),
+				'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+				'ERROR'			=> '',
+				'EDIT_LINK'		=> generate_link('modules&amp;mode=edit&amp;id='.$module['module_id'], array('admin' => true)),
+				'AUTH_LINK'		=> generate_link('modules&amp;mode=auth&amp;id='.$module['module_id'], array('admin' => true)),
+				'ADMIN_AUTH_LINK'=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['module_id'], array('admin' => true)) : '' ,
+				'INSTALLER_LINK'=> $installer_link,
+				'TITLE'			=> ($module['module_title']) ? $module['module_title'] : $module['module_name'],
 
-function modules_change($id)
-{	
-	global $_CLASS;
-	
-	$result = $_CLASS['core_db']->sql_query('SELECT active, type FROM '.CORE_MODULES_TABLE.' WHERE id='.$id);
-	$module = $_CLASS['core_db']->sql_fetchrow($result);
-	$_CLASS['core_db']->sql_freeresult($result);
-
-	if (!$module)
-	{
-		trigger_error('MODULE_NOT_FOUND');
+		));
 	}
+	unset($modules[$type], $module);
+}
 
-	check_type($module['type']);
+$_CLASS['core_display']->display(false, 'admin/modules/index.html');
 
-	$result = $_CLASS['core_db']->sql_query('UPDATE '.CORE_MODULES_TABLE.' SET active='.intval(!$module['active']).' WHERE id='.$id);
-}
-
+/*
 function modules_homepage($id, $option)
 {
 	global $_CLASS;
@@ -177,59 +241,60 @@
 		return;
 	}
 
-	$result = $_CLASS['core_db']->sql_query('SELECT type, homepage FROM '.CORE_MODULES_TABLE.' WHERE id ='. $id);
-	$module = $_CLASS['core_db']->sql_fetchrow($result);
-	$_CLASS['core_db']->sql_freeresult($result);
+	$result = $_CLASS['core_db']->query('SELECT type, homepage FROM '.CORE_MODULES_TABLE.' WHERE id ='. $id);
+	$module = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
-	if (!$module || !$module['homepage'])
+	if (!$module || !$module['module_homepage'])
 	{
 		trigger_error('MODULE_NOT_FOUND');
 	}
 
-	check_type($module['position']);
-	$module['homepage'] = (int) $module['homepage'];
+	check_type($module['module_position']);
+	$module['module_homepage'] = (int) $module['module_homepage'];
 
 	switch ($option)
 	{
 		case 'down':
-			$result = $_CLASS['core_db']->sql_query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
-			$max_homepage = $_CLASS['core_db']->sql_fetchrow($result);
-			$_CLASS['core_db']->sql_freeresult($result);
+			$result = $_CLASS['core_db']->query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
+			$max_homepage = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-			if ($module['homepage'] < $max_homepage['homepage'])
+			if ($module['module_homepage'] < $max_homepage['homepage'])
 			{
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['position'].' AND homepage='.($module['homepage'] + 1));
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['homepage'] + 1).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['module_position'].' AND homepage='.($module['module_homepage'] + 1));
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['module_homepage'] + 1).' WHERE id ='. $id);
 			}
 		break;
 
 		case 'up':
-			if ($module['homepage'] && $module['homepage'] != 1)
+			if ($module['module_homepage'] && $module['module_homepage'] != 1)
 			{
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['position'].' AND homepage='.($module['homepage'] - 1));
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['homepage'] -1 ).' WHERE id ='. $id);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['module_position'].' AND homepage='.($module['module_homepage'] - 1));
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['module_homepage'] -1 ).' WHERE id ='. $id);
 			}
 		break;
 
 		case 'bottom':
-			$result = $_CLASS['core_db']->sql_query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
-			$max_homepage = $_CLASS['core_db']->sql_fetchrow($result);
-			$_CLASS['core_db']->sql_freeresult($result);
+			$result = $_CLASS['core_db']->query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
+			$max_homepage = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-			if ($module['homepage'] < $max_homepage['homepage'])
+			if ($module['module_homepage'] < $max_homepage['homepage'])
 			{
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['position'].' AND homepage > '.$module['homepage']);
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage='.$max_homepage['homepage'].' WHERE id='.$id);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['module_position'].' AND homepage > '.$module['module_homepage']);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.$max_homepage['homepage'].' WHERE id='.$id);
 			}
 		break;
 
 		case 'top':
-			if ($module['homepage'] != 1)
+			if ($module['module_homepage'] != 1)
 			{
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['position'].' AND homepage < '.$module['homepage']);
-				$result = $_CLASS['core_db']->sql_query('UPDATE '.BLOCKS_TABLE.' SET homepage=1 WHERE id='.$id);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['module_position'].' AND homepage < '.$module['module_homepage']);
+				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=1 WHERE id='.$id);
 			}
 		break;
 	}
 }
+*/
 ?>
\ No newline at end of file

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/includes/functions.php	2005-09-03 03:13:23 UTC (rev 97)
@@ -219,7 +219,7 @@
 
 	$_CLASS['core_template']->assign_array(array(
 		'MESSAGE'		=> ($message) ? $message : 'Are you sure you want to perform this action ?',
-		'CONFIRM_ACTION'=> generate_link($_CLASS['core_user']->url),
+		'CONFIRM_ACTION'=> ($_CLASS['core_user']->url) ? generate_link($_CLASS['core_user']->url) : '',
 		'CONFIRM_IMAGE'	=> $confirm_image,
 		'HIDDEN_FIELDS'	=> $hidden
 	));

Deleted: trunk/includes/templates/admin/modules/edit.html
===================================================================
--- trunk/includes/templates/admin/modules/edit.html	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/includes/templates/admin/modules/edit.html	2005-09-03 03:13:23 UTC (rev 97)
@@ -1,100 +0,0 @@
-<style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
-<script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
-<script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
-<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
-{ $A_TABLE_OPEN }
-<form action="{ $B_ACTION }" method="post">
-	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
-		<tbody>
-		{ if $B_ERROR }
-			<tr> 
-				<td class="row2" align="center" colspan="3">
-					<font color="#990000">{ $B_ERROR }</font>
-				</td>
-			</tr>
-		{ /if }
-			<tr> 
-				<th colspan="3" height="28" valign="middle">{ $B_HEADER }</th>
-			</tr>
-		
-			<tr> 
-				<td class="row1" width="20%"><b class="genmed">{ $L_TITLE }: </b></td>
-		
-				<td class="row2" colspan="2"><input class="post" name="b_title" size="40" maxlength="100" value="{ $B_TITLE }" type="text"></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
-				<td class="row2" colspan="2"><input type="radio" name="b_active" value="1"{ if $B_ACTIVE } checked="checked" { /if }/><span class="genmed">{$L_YES}</span>&nbsp;&nbsp;<input type="radio" name="b_active" value="0"{ if !$B_ACTIVE } checked="checked" { /if }/><span class="genmed">{$L_NO}</span></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
-				<td class="row2" >
-					<input class="post" id="b_time" name="b_time" size="35" maxlength="100" value="{ $B_STARTS }" type="text" />
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
-					{ if $B_STARTS }   Currently Set:  { $B_STARTS }{ /if }
-				</td>
-				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:</b><br/>{ $B_CURRENT_TIME } </td>
-			</tr>
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
-				<td class="row2">
-					<input class="post" id="b_expires" name="b_expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
-					<img src="java/jscalendar/calendar.png" style="cursor: pointer;"  id="expires_trigger" />
-					{ if $B_EXPIRES }    Currently Set:  { $B_EXPIRES }{ /if }
-				</td>
-			</tr>
-			{ if $B_POSITION }
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_POSITION }: </b></td>
-				<td class="row2" colspan="2"><select name="b_position">{ $B_POSITION }</select></td>
-			</tr>
-			{ /if }
-			{ if $B_RSS_SHOW }
-				<tr> 
-				<td class="row1"><b class="genmed">{ $L_RSS_URL }: </b></td>
-				<td class="row2" colspan="2"><input class="post" name="b_url" size="35" maxlength="100" value="{ $B_RSS_URL }" type="text"></td>
-			</tr>
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_RSS_REFRESH }: </b></td>
-				<td class="row2" colspan="2"><input class="post" name="b_refresh" size="35" maxlength="100" value="{ $B_RSS_REFRESH }" type="text">{ if $B_EXPIRES }    Currently Set:  { $B_EXPIRES }{ /if }</td>
-			</tr>
-			{ /if }
-			{ if $B_FILE }
-			<tr> 
-				<td class="row1"><b class="genmed">{ $L_FILE }: </b></td>
-				<td class="row2" colspan="2"><select name="b_file">{ $B_FILE }</select> </td>
-		
-			</tr>
-			{ /if }
-			{ if $B_SHOW_CONTENT }
-			<tr> 
-				<td class="row1" valign="top"><b class="genmed">{ $L_HTML_CONTENT }: </b></td>
-				<td class="row2" colspan="2"><textarea name="b_content" id="b_content" editor_enabled="true" style="width:300px; height:200px" cols="63" rows="15">{ $B_CONTENT }</textarea><br /></td>
-			</tr>
-			{ /if }
-			<tr>
-				<td class="cat" colspan="3" align="center" height="28">
-				<input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;&nbsp;<input class="btnlite" value="Reset" name="reset" type="reset"></td>
-			</tr>
-		</tbody>
-	</table>
-</form>
-{literal}
-<script type="text/javascript">
-  Calendar.setup(
-    {
-      inputField  : "b_time",
-      button      : "time_trigger"
-    }
-  );
-</script>
-<script type="text/javascript">
-  Calendar.setup(
-    {
-      inputField  : "b_expires",
-      button      : "expires_trigger"
-    }
-  );
-</script>
-{/literal}
-{ $A_TABLE_CLOSE }
\ No newline at end of file

Modified: trunk/includes/templates/admin/modules/index.html
===================================================================
--- trunk/includes/templates/admin/modules/index.html	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/includes/templates/admin/modules/index.html	2005-09-03 03:13:23 UTC (rev 97)
@@ -26,31 +26,41 @@
 				<a href="{ $normal_modules:EDIT_LINK }">{ $normal_modules:TITLE }</a>
 				<!-- IF { $normal_modules:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $normal_modules:ERROR }</span><!-- ENDIF -->
 			</td>
-			<!-- IF { $normal_modules:ACTIVE } -->
-			<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
-				<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
-			</td>
+			<!-- IF { $normal_modules:INSTALLED } -->
+				<!-- IF { $normal_modules:ACTIVE } -->
+				<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
+					<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
+				</td>
+				<!-- ELSE -->
+				<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
+					<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
+				</td>
+				<!-- ENDIF -->
+				<td nowrap="nowrap" class="row1" align="center">
+					<!-- IF { $normal_modules:EDIT_LINK } -->
+						<a href="{ $normal_modules:EDIT_LINK }">{ $L_EDIT }</a> |
+					<!-- ENDIF -->
+					<!-- IF { $normal_modules:AUTH_LINK } -->
+						<a href="{ $normal_modules:AUTH_LINK }">{ $L_PERMISSIONS }</a>
+					<!-- ENDIF -->
+					<!-- IF { $normal_modules:INSTALLER_LINK } -->
+						 | <a href="{ $normal_modules:INSTALLER_LINK }">{ $L_UNINSTALL }</a>
+					<!-- ENDIF -->
+				</td>
+				<!-- IF { $S_ADMIN_AUTH_LINK } -->
+				<td nowrap="nowrap" class="row1" align="center">
+					<a href="{ $normal_modules:ADMIN_AUTH_LINK }">{ $L_ADMIN_PERMISSIONS }</a>
+				</td>
+				<!-- ENDIF -->
 			<!-- ELSE -->
-			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
-				<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
+			<td align="center" class="row1">
+				{ $L_NOT_INSTALLED }
 			</td>
-			<!-- ENDIF -->
 			<td nowrap="nowrap" class="row1" align="center">
-			<!-- IF { $normal_modules:EDIT_LINK } -->
-				<a href="{ $normal_modules:EDIT_LINK }">{ $L_EDIT }</a> |
-			<!-- ENDIF -->
-			<!-- IF { $normal_modules:AUTH_LINK } -->
-			<a href="{ $normal_modules:AUTH_LINK }">{ $L_PERMISSIONS }</a>
-			<!-- ENDIF -->
-			<!-- IF { $normal_modules:UNINSTALL_LINK } -->
-				 | <a href="{ $normal_modules:UNINSTALL_LINK }">{ $L_UNINSTALL }</a>
-			<!-- ENDIF -->
+				<a href="{ $normal_modules:INSTALLER_LINK }">{ $L_INSTALL }</a>
 			</td>
-			<!-- IF { $S_ADMIN_AUTH_LINK } -->
-			<td nowrap="nowrap" class="row1" align="center">
-				<a href="{ $normal_modules:ADMIN_AUTH_LINK }">{ $L_ADMIN_PERMISSIONS }</a>
-			</td>
 			<!-- ENDIF -->
+
 		</tr>
 		<tr>
 			<td class="spacer" colspan="4" height="7"></td>

Modified: trunk/modules/Quick_Message/install.php
===================================================================
--- trunk/modules/Quick_Message/install.php	2005-09-03 01:42:07 UTC (rev 96)
+++ trunk/modules/Quick_Message/install.php	2005-09-03 03:13:23 UTC (rev 97)
@@ -19,29 +19,44 @@
 ||**************************************************************||
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'quick_message');
+class Quick_Message_install
+{
+	function install()
+	{
+		global $_CLASS, $prefix;
 
-$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
-$_CLASS['core_db']->add_table_field_text('message_text', 200);
-field_unix_time('message_time');
-$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('poster_name', 80);
-$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
+		$_CLASS['core_db']->table_create('start', $prefix.'quick_message');
+		
+		$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
+		$_CLASS['core_db']->add_table_field_text('message_text', 200);
+		$_CLASS['core_db']->add_table_field_int('message_time', array('max' => 200000000));
+		$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
+		$_CLASS['core_db']->add_table_field_char('poster_name', 80);
+		$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
+		
+		$_CLASS['core_db']->add_table_index('message_id', 'primary');
+		$_CLASS['core_db']->add_table_index('message_time');
+		
+		$_CLASS['core_db']->table_create('commit');
+		
+		// use set config ?
+		set_core_config('quick_message', 'anonymous_posting', 2, false, true);
+		set_core_config('quick_message', 'delete_time', 300, false, true);
+		set_core_config('quick_message', 'height', 200, false, true);
+		set_core_config('quick_message', 'last_post_check', 150, false, true);
+		set_core_config('quick_message', 'length_max', 150, false, true);
 
-$_CLASS['core_db']->add_table_index('message_id', 'primary');
-$_CLASS['core_db']->add_table_index('message_time');
+		$_CLASS['core_cache']->destroy('core_config');
 
-$_CLASS['core_db']->table_create('commit');
+		$_CLASS['core_db']->query('INSERT INTO '.$prefix."quick_message (poster_id, poster_name, poster_ip, message_text, message_time) VALUES (0, 'Site', '', 'Lets do this !', ".gmtime().")");
 
-// use set config ?
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'anonymous_posting', '2', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'delete_time', '300', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'height', '200', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'last_post_check', '150', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('quick_message', 'length_max', '150', 1)");
+		return true;
+	}
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."quick_message (poster_id, poster_name, poster_ip, message_text, message_time) VALUES (0, 'Site', '', 'Lets do this !', ".gmtime().")");
+	function uninstall()
+	{
 
-$installed = true;
+	}
+}
 
 ?>
\ No newline at end of file



From viperal at berlios.de  Sat Sep  3 18:26:46 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 3 Sep 2005 18:26:46 +0200
Subject: [Viperals-svncheckins] r98 - in trunk: admin includes/templates/admin/modules install
Message-ID: <200509031626.j83GQk4w015488@sheep.berlios.de>

Author: viperal
Date: 2005-09-03 18:26:45 +0200 (Sat, 03 Sep 2005)
New Revision: 98

Added:
   trunk/admin/index.html
Modified:
   trunk/admin/blocks.php
   trunk/admin/messages.php
   trunk/admin/modules.php
   trunk/includes/templates/admin/modules/index.html
   trunk/install/build_tables.php
Log:


Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-09-03 03:13:23 UTC (rev 97)
+++ trunk/admin/blocks.php	2005-09-03 16:26:45 UTC (rev 98)
@@ -343,7 +343,7 @@
 		$data['block_position'] = BLOCK_RIGHT;
 	}
 
-	$data['block_status']	= get_variable('b_active', 'POST', 0, 'integer');
+	$data['block_status']	= (get_variable('b_active', 'POST', STATUS_DISABLED, 'integer') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
 	$data['block_expires']	= get_variable('b_expires', 'POST', '');
 	$data['block_starts']	= get_variable('b_time', 'POST', '');
 


Property changes on: trunk/admin/blocks.php
___________________________________________________________________
Name: svn:keywords
   + Id

Added: trunk/admin/index.html
===================================================================

Modified: trunk/admin/messages.php
===================================================================
--- trunk/admin/messages.php	2005-09-03 03:13:23 UTC (rev 97)
+++ trunk/admin/messages.php	2005-09-03 16:26:45 UTC (rev 98)
@@ -210,7 +210,7 @@
 		}
 	}
 	
-	$data['block_status']	= get_variable('active', 'POST', 0);
+	$data['block_status']	= (get_variable('active', 'POST', STATUS_DISABLED, 'integer') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
 	$data['block_expires']	= get_variable('expires', 'POST', 0);
 	$data['block_starts']	= get_variable('time', 'POST', '');
 	$data['block_position']	= get_variable('b_position', 'POST', BLOCK_MESSAGE_TOP, 'integer');


Property changes on: trunk/admin/messages.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/admin/modules.php
===================================================================
--- trunk/admin/modules.php	2005-09-03 03:13:23 UTC (rev 97)
+++ trunk/admin/modules.php	2005-09-03 16:26:45 UTC (rev 98)
@@ -43,7 +43,7 @@
 		}
 		return false;
 	}
-	
+
 	return true;
 }
 
@@ -53,7 +53,6 @@
 	{
 		switch ($_REQUEST['mode'])
 		{
-			
 			case 'change':
 				$result = $_CLASS['core_db']->query('SELECT module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -69,67 +68,85 @@
 				$status = ($module['module_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
 				$result = $_CLASS['core_db']->query('UPDATE '. CORE_MODULES_TABLE . " SET module_status = $status WHERE module_id = $id");
 			break;
-		
+
+			case 'install':
+				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$module = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$module || $module['module_status'] != STATUS_PENDING)
+				{
+					trigger_error($module ? 'MODULE_ALREADY_INSTALLED' : 'MODULE_NOT_FOUND');
+				}
+
+				check_type($module['module_type']);
+
+				if (display_confirmation())
+				{
+					$error = true;
+
+					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+					{
+						require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+	
+						$name = $module['module_name'].'_install';
+						$install = new $name;
+						$error = $install->install();
+	
+						if ($error !== true)
+						{
+							// do something better than this
+							trigger_error($error);
+						}
+					}
+
+					$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE.' set module_status = '.STATUS_DISABLED.' WHERE module_id = '.$id);
+				}
+			break;
+
 			case 'uninstall':
 				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
-				if (!$module)
+				if (!$module || $module['module_status'] == STATUS_PENDING)
 				{
-					trigger_error('MODULE_NOT_FOUND');
+					trigger_error($module ? 'MODULE_NOT_UNINSTALLABLE' : 'MODULE_NOT_FOUND');
 				}
 			
 				check_type($module['module_type']);
 				
 				if (display_confirmation())
 				{
-					if ($module['module_status'] !== STATUS_PENDING)
+					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
 					{
-						if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
-						{
-							require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
-							
-							$name = $module['module_name'].'_install';
-							$install = new $name;
-							
-							$install->uninstall();
-						}
+						require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+						
+						$name = $module['module_name'].'_install';
+						$install = new $name;
+						
+						$install->uninstall();
 					}
 
-					$_CLASS['core_db']->query('DELETE from ' . CORE_MODULES_TABLE . ' where module_id = '.$id);
+					$_CLASS['core_db']->query('UPDATE ' . CORE_MODULES_TABLE . ' set module_status = ' . STATUS_PENDING . ' WHERE module_id = '.$id);
 				}
 			break;
 
-			case 'install':
+			case 'remove':
 				$result = $_CLASS['core_db']->query('SELECT module_status, module_name, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
-				if (!$module || $module['module_status'] !== STATUS_PENDING)
+				if (!$module || $module['module_status'] != STATUS_PENDING)
 				{
-					trigger_error($module ? 'MODULE_ALREADY_INSTALLED' : 'MODULE_NOT_FOUND');
+					trigger_error($module ? 'MODULE_NOT_REMOVABLE' : 'MODULE_NOT_FOUND');
 				}
 
 				check_type($module['module_type']);
 
-				if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+				if (display_confirmation())
 				{
-					require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
-					
-					$name = $module['module_name'].'_install';
-					$install = new $name;
-					$error = $install->install();
-
-					if ($error == true)
-					{
-						$_CLASS['core_db']->query('UPDATE '.CORE_MODULES_TABLE.' set module_status = '.STATUS_DISABLED.' WHERE module_id = '.$id);
-					}
-					else
-					{
-						// do something better than this
-						trigger_error($error);
-					}
+					$_CLASS['core_db']->query('DELETE from ' . CORE_MODULES_TABLE . ' WHERE module_id = '.$id);
 				}
 			break;
 
@@ -186,7 +203,7 @@
 $_CLASS['core_db']->free_result($result);
 
 $admin_auth = false;
-$_CLASS['core_template']->assign('S_ADMIN_AUTH_LINK', $admin_auth);
+$_CLASS['core_template']->assign('S_LINK_ADMIN_AUTH', $admin_auth);
 
 $module_type = array(MODULE_SYSTEM => 'system', MODULE_NORMAL => 'normal');
 
@@ -205,25 +222,28 @@
 		{
 			$installed = false;
 			$installer_link = generate_link('modules&amp;mode=install&amp;id='.$module['module_id'], array('admin' => true));
+			$remove_link = generate_link('modules&amp;mode=remove&amp;id='.$module['module_id'], array('admin' => true));
 		}
 		else
 		{
 			$installed = true;
 			$installer_link = ($module['module_type'] != BLOCKTYPE_SYSTEM) ? generate_link('modules&amp;mode=uninstall&amp;id='.$module['module_id'], array('admin' => true)) : '';
+			$remove_link = '';
 		}
 
 		$_CLASS['core_template']->assign_vars_array($name.'_modules', array(
-				'INSTALLED'		=> $installed,
 				'ACTIVE'		=> ($active),
-				'ACTIVE_LINK'	=> generate_link('modules&amp;mode=change&amp;id='.$module['module_id'], array('admin' => true)),
 				'CHANGE'		=> ($active) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 				'ERROR'			=> '',
-				'EDIT_LINK'		=> generate_link('modules&amp;mode=edit&amp;id='.$module['module_id'], array('admin' => true)),
-				'AUTH_LINK'		=> generate_link('modules&amp;mode=auth&amp;id='.$module['module_id'], array('admin' => true)),
-				'ADMIN_AUTH_LINK'=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['module_id'], array('admin' => true)) : '' ,
-				'INSTALLER_LINK'=> $installer_link,
+				'INSTALLED'		=> $installed,
 				'TITLE'			=> ($module['module_title']) ? $module['module_title'] : $module['module_name'],
 
+				'LINK_ACTIVE'		=> generate_link('modules&amp;mode=change&amp;id='.$module['module_id'], array('admin' => true)),
+				'LINK_EDIT'			=> generate_link('modules&amp;mode=edit&amp;id='.$module['module_id'], array('admin' => true)),
+				'LINK_AUTH'			=> generate_link('modules&amp;mode=auth&amp;id='.$module['module_id'], array('admin' => true)),
+				'LINK_ADMIN_AUTH'	=> ($admin_auth) ? generate_link('modules&amp;mode=admin_auth&amp;id='.$module['module_id'], array('admin' => true)) : '' ,
+				'LINK_INSTALLER'	=> $installer_link,
+				'LINK_REMOVE'		=> $remove_link,
 		));
 	}
 	unset($modules[$type], $module);
@@ -231,70 +251,4 @@
 
 $_CLASS['core_display']->display(false, 'admin/modules/index.html');
 
-/*
-function modules_homepage($id, $option)
-{
-	global $_CLASS;
-
-	if (!in_array($option, array('down', 'up', 'bottom', 'top')))
-	{
-		return;
-	}
-
-	$result = $_CLASS['core_db']->query('SELECT type, homepage FROM '.CORE_MODULES_TABLE.' WHERE id ='. $id);
-	$module = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
-
-	if (!$module || !$module['module_homepage'])
-	{
-		trigger_error('MODULE_NOT_FOUND');
-	}
-
-	check_type($module['module_position']);
-	$module['module_homepage'] = (int) $module['module_homepage'];
-
-	switch ($option)
-	{
-		case 'down':
-			$result = $_CLASS['core_db']->query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
-			$max_homepage = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if ($module['module_homepage'] < $max_homepage['homepage'])
-			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['module_position'].' AND homepage='.($module['module_homepage'] + 1));
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['module_homepage'] + 1).' WHERE id ='. $id);
-			}
-		break;
-
-		case 'up':
-			if ($module['module_homepage'] && $module['module_homepage'] != 1)
-			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['module_position'].' AND homepage='.($module['module_homepage'] - 1));
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.($module['module_homepage'] -1 ).' WHERE id ='. $id);
-			}
-		break;
-
-		case 'bottom':
-			$result = $_CLASS['core_db']->query('SELECT MAX(homepage) as homepage FROM '.CORE_MODULES_TABLE);
-			$max_homepage = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if ($module['module_homepage'] < $max_homepage['homepage'])
-			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage-1 WHERE position='.$module['module_position'].' AND homepage > '.$module['module_homepage']);
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage='.$max_homepage['homepage'].' WHERE id='.$id);
-			}
-		break;
-
-		case 'top':
-			if ($module['module_homepage'] != 1)
-			{
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=homepage+1 WHERE position='.$module['module_position'].' AND homepage < '.$module['module_homepage']);
-				$result = $_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET homepage=1 WHERE id='.$id);
-			}
-		break;
-	}
-}
-*/
 ?>
\ No newline at end of file


Property changes on: trunk/admin/modules.php
___________________________________________________________________
Name: svn:keywords
   + Id

Modified: trunk/includes/templates/admin/modules/index.html
===================================================================
--- trunk/includes/templates/admin/modules/index.html	2005-09-03 03:13:23 UTC (rev 97)
+++ trunk/includes/templates/admin/modules/index.html	2005-09-03 16:26:45 UTC (rev 98)
@@ -5,10 +5,10 @@
 <table class="tablebg" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
 		<tr>
-			<th width="<!-- IF { $S_ADMIN_AUTH_LINK } -->30<!-- ELSE -->50<!-- ENDIF -->%" align="center"><b>{ $L_TITLE }</b></th>
+			<th width="<!-- IF { $S_LINK_ADMIN_AUTH } -->30<!-- ELSE -->50<!-- ENDIF -->%" align="center"><b>{ $L_TITLE }</b></th>
 			<th align="center"><b>{ $L_STATUS }</b></td>
 			<th align="center"><b>{ $L_FUNCTIONS }</b></th>
-			<!-- IF { $S_ADMIN_AUTH_LINK } -->
+			<!-- IF { $S_LINK_ADMIN_AUTH } -->
 			<th align="center"></th>
 			<!-- ENDIF -->
 		</tr>
@@ -22,45 +22,45 @@
 		</tr>
 		<!-- LOOP $normal_modules -->
 		<tr>
-			<td height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:EDIT_LINK }'">
-				<a href="{ $normal_modules:EDIT_LINK }">{ $normal_modules:TITLE }</a>
+			<td height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:LINK_EDIT }'">
+				<a href="{ $normal_modules:LINK_EDIT }">{ $normal_modules:TITLE }</a>
 				<!-- IF { $normal_modules:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $normal_modules:ERROR }</span><!-- ENDIF -->
 			</td>
-			<!-- IF { $normal_modules:INSTALLED } -->
-				<!-- IF { $normal_modules:ACTIVE } -->
-				<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
-					<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
-				</td>
-				<!-- ELSE -->
-				<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:ACTIVE_LINK }'; return false;">
-					<a href="{ $normal_modules:ACTIVE_LINK }">{ $normal_modules:CHANGE }</a>
-				</td>
+		<!-- IF { $normal_modules:INSTALLED } -->
+			<!-- IF { $normal_modules:ACTIVE } -->
+			<td align="center" class="row2" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $normal_modules:LINK_ACTIVE }'; return false;">
+				<a href="{ $normal_modules:LINK_ACTIVE }">{ $normal_modules:CHANGE }</a>
+			</td>
+			<!-- ELSE -->
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $normal_modules:LINK_ACTIVE }'; return false;">
+				<a href="{ $normal_modules:LINK_ACTIVE }">{ $normal_modules:CHANGE }</a>
+			</td>
+			<!-- ENDIF -->
+			<td nowrap="nowrap" class="row1" align="center">
+				<!-- IF { $normal_modules:LINK_EDIT } -->
+					<a href="{ $normal_modules:LINK_EDIT }">{ $L_EDIT }</a> |
 				<!-- ENDIF -->
-				<td nowrap="nowrap" class="row1" align="center">
-					<!-- IF { $normal_modules:EDIT_LINK } -->
-						<a href="{ $normal_modules:EDIT_LINK }">{ $L_EDIT }</a> |
-					<!-- ENDIF -->
-					<!-- IF { $normal_modules:AUTH_LINK } -->
-						<a href="{ $normal_modules:AUTH_LINK }">{ $L_PERMISSIONS }</a>
-					<!-- ENDIF -->
-					<!-- IF { $normal_modules:INSTALLER_LINK } -->
-						 | <a href="{ $normal_modules:INSTALLER_LINK }">{ $L_UNINSTALL }</a>
-					<!-- ENDIF -->
-				</td>
-				<!-- IF { $S_ADMIN_AUTH_LINK } -->
-				<td nowrap="nowrap" class="row1" align="center">
-					<a href="{ $normal_modules:ADMIN_AUTH_LINK }">{ $L_ADMIN_PERMISSIONS }</a>
-				</td>
+				<!-- IF { $normal_modules:LINK_AUTH } -->
+					<a href="{ $normal_modules:LINK_AUTH }">{ $L_PERMISSIONS }</a>
 				<!-- ENDIF -->
-			<!-- ELSE -->
+				<!-- IF { $normal_modules:LINK_INSTALLER } -->
+					 | <a href="{ $normal_modules:LINK_INSTALLER }">{ $L_UNINSTALL }</a>
+				<!-- ENDIF -->
+			</td>
+			<!-- IF { $S_LINK_ADMIN_AUTH } -->
+			<td nowrap="nowrap" class="row1" align="center">
+				<a href="{ $normal_modules:LINK_ADMIN_AUTH }">{ $L_ADMIN_PERMISSIONS }</a>
+			</td>
+			<!-- ENDIF -->
+		<!-- ELSE -->
 			<td align="center" class="row1">
 				{ $L_NOT_INSTALLED }
 			</td>
 			<td nowrap="nowrap" class="row1" align="center">
-				<a href="{ $normal_modules:INSTALLER_LINK }">{ $L_INSTALL }</a>
+				<a href="{ $normal_modules:LINK_INSTALLER }">{ $L_INSTALL }</a> |
+				<a href="{ $normal_modules:LINK_REMOVE }">{ $L_REMOVE }</a>
 			</td>
-			<!-- ENDIF -->
-
+		<!-- ENDIF -->
 		</tr>
 		<tr>
 			<td class="spacer" colspan="4" height="7"></td>
@@ -76,12 +76,12 @@
 		</tr>
 		<!-- LOOP $system_modules -->
 		<tr>
-			<td colspan="3" height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $system_modules:EDIT_LINK }'; return false;">
-				<a href="{ $system_modules:EDIT_LINK }">{ $system_modules:TITLE }</a>
+			<td colspan="3" height="24" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $system_modules:LINK_EDIT }'; return false;">
+				<a href="{ $system_modules:LINK_EDIT }">{ $system_modules:TITLE }</a>
 			</td>
-			<!-- IF { $S_ADMIN_AUTH_LINK } -->
+			<!-- IF { $S_LINK_ADMIN_AUTH } -->
 			<td nowrap="nowrap" class="row1" align="center">
-				<a href="{ $system_modules:ADMIN_AUTH_LINK }">{ $L_ADMIN_PERMISSIONS }</a>
+				<a href="{ $system_modules:LINK_ADMIN_AUTH }">{ $L_ADMIN_PERMISSIONS }</a>
 			</td>
 			<!-- ENDIF -->
 		</tr>

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-09-03 03:13:23 UTC (rev 97)
+++ trunk/install/build_tables.php	2005-09-03 16:26:45 UTC (rev 98)
@@ -881,7 +881,7 @@
 $_CLASS['core_db']->add_table_field_int('bbcode_bitfield', 1000000000);
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 5);
 field_unix_time('message_edit_time', true);
-$_CLASS['core_db']->add_table_field_text('message_edit_count', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('message_edit_count', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_text('to_address', 1000000);
 $_CLASS['core_db']->add_table_field_text('bcc_address', 1000000);
 


Property changes on: trunk/install/build_tables.php
___________________________________________________________________
Name: svn:keywords
   + Id



From viperal at berlios.de  Thu Sep  8 06:05:33 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 8 Sep 2005 06:05:33 +0200
Subject: [Viperals-svncheckins] r99 - in trunk: . admin includes includes/compatiblity includes/db includes/display includes/forums/admin includes/templates includes/templates/modules/Forums includes/templates/rss install language/en modules modules/Contact modules/Forums modules/Quick_Message modules/articles themes/viperal/images themes/viperal/images/modules themes/viperal/images/modules/Forums themes/viperal/style
Message-ID: <200509080405.j8845Xb9006874@sheep.berlios.de>

Author: viperal
Date: 2005-09-08 06:05:29 +0200 (Thu, 08 Sep 2005)
New Revision: 99

Added:
   trunk/modules/articles/
   trunk/modules/articles/index.php
   trunk/modules/articles/install.php
   trunk/themes/viperal/images/modules/
   trunk/themes/viperal/images/modules/Forums/
   trunk/themes/viperal/images/modules/Forums/index.html
   trunk/themes/viperal/images/modules/Forums/index.php
   trunk/themes/viperal/images/modules/index.html
Modified:
   trunk/admin.php
   trunk/admin/blocks.php
   trunk/admin/index.php
   trunk/admin/users.php
   trunk/core.php
   trunk/includes/compatiblity/mbstring.php
   trunk/includes/db/mssql.php
   trunk/includes/db/mysql.php
   trunk/includes/db/mysql3.php
   trunk/includes/db/mysqli.php
   trunk/includes/db/postgres.php
   trunk/includes/db/sqlite.php
   trunk/includes/db/sqlite_pdo.php
   trunk/includes/display/blocks.php
   trunk/includes/display/display.php
   trunk/includes/display/template.php
   trunk/includes/forums/admin/admin_forums.php
   trunk/includes/forums/admin/admin_ranks.php
   trunk/includes/functions.php
   trunk/includes/functions_user.php
   trunk/includes/session.php
   trunk/includes/templates/message.html
   trunk/includes/templates/modules/Forums/viewforum_body.html
   trunk/includes/templates/rss/atom.html
   trunk/includes/user.php
   trunk/install/build_data.php
   trunk/install/build_tables.php
   trunk/language/en/common.php
   trunk/language/en/error.php
   trunk/modules/Contact/index.php
   trunk/modules/Forums/faq.php
   trunk/modules/Forums/main.php
   trunk/modules/Forums/posting.php
   trunk/modules/Forums/viewforum.php
   trunk/modules/Forums/viewtopic.php
   trunk/modules/Quick_Message/index.php
   trunk/modules/Quick_Message/install.php
   trunk/themes/viperal/style/style.css
Log:
Bug fixes ( thanks xfsunoles )
Added articles
Other stuff

Modified: trunk/admin/blocks.php
===================================================================
--- trunk/admin/blocks.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/admin/blocks.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -96,8 +96,6 @@
 	}
 }
 
-blocks_block('main');
-
 $result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
 	FROM ' . BLOCKS_TABLE . '
 	WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ') ORDER BY block_position, block_order ASC');
@@ -222,7 +220,6 @@
 		}
 
 		unset($block_post);
-		blocks_block();
 	}
 	else
 	{
@@ -231,7 +228,6 @@
 			block_get_data($block, $error, get_variable('type', 'GET', BLOCKTYPE_FILE));
 			$error = '';
 		}
-		blocks_block('add');
 	}
 
 	$b_show_content = $b_file = $b_rss_show = $b_rss_rate = $b_rss_url = false;
@@ -275,49 +271,6 @@
 	$_CLASS['core_template']->display('admin/blocks/edit.html');
 }
 
-function blocks_block($mode = false)
-{
-    global $_CLASS;
-
-	$content = '<table class="tablebg" cellspacing="1" width="100%"><tbody><tr><th>Options</th>	</tr>';
-
-	if ($mode == 'main')
-	{
-		$content .= '<tr><td class="row1"><b class="phpbbnav">Main</b>
-		<ul class="phpbbnav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-		<li>&#187; <b>Main</li></ul></td><tr>';
-	}
-	else
-	{
-		$content .= '<tr><td class="row2" onmouseover="this.className=\'row1\'" onmouseout="this.className=\'row2\'" onclick="location.href=\''.generate_link('blocks', array('admin' => true)).'\'" nowrap="nowrap"><a class="phpbbnav" href="'.generate_link('blocks', array('admin' => true)).'">Main</a>
-		</td></tr>';
-	}
-
-	if ($mode == 'add')
-	{
-		$content .= '<tr><td class="row1"><b class="phpbbnav">Add</b><ul class="phpbbnav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">';
-		$content .= '<li>&#187;<a href="'.generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FILE, array('admin' => true)).'"> New Regular Block</a></li>';
-		$content .= '<li>&#187;<a href="'.generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_FEED, array('admin' => true)).'"> New Feed Block</a></li>';
-		$content .= '<li>&#187;<a href="'.generate_link('blocks&amp;mode=add&amp;type='.BLOCKTYPE_HTML, array('admin' => true)).'"> New HTML Block</a></li></ul></td></tr>';
-	}
-	else
-	{
-		$content .= '<td class="row2" onmouseover="this.className=\'row1\'" onmouseout="this.className=\'row2\'" onclick="location.href=\''.generate_link('blocks&amp;mode=add', array('admin' => true)).'\'" nowrap="nowrap"><a class="phpbbnav" href="'.generate_link('blocks&amp;mode=add', array('admin' => true)).'">Add New Block</a>
-		</td></tr>';
-	}
-
-	$content .= '</tbody></table>';
-
-	$data = array(
-		'title' 	=> 'Block Administration',
-		'position'	=> BLOCK_LEFT,
-		'type' 		=> BLOCKTYPE_HTML,
-		'content'	=> $content,
-	);
-
-	$_CLASS['core_blocks']->add_block($data);
-}
-
 function block_get_data(&$data, &$error, $type = false)
 {
 	global $_CLASS;

Modified: trunk/admin/index.php
===================================================================
--- trunk/admin/index.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/admin/index.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -52,7 +52,7 @@
 	
 	load_class($site_file_root.'includes/core_rss.php', 'core_rss');
 	
-	if ($_CLASS['core_rss']->get_rss('http://viperal.byethost33.com/feed.php?mode=cms&feed=rss2', 3))
+	if ($_CLASS['core_rss']->get_rss('http://www.php.net/news.rss', 3))
 	{
 		while ($data = $_CLASS['core_rss']->get_rss_data())
 		{

Modified: trunk/admin/users.php
===================================================================
--- trunk/admin/users.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/admin/users.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -61,16 +61,16 @@
 				$activation_array = array(USER_ACTIVATION_NONE, USER_ACTIVATION_SELF, USER_ACTIVATION_ADMIN, USER_ACTIVATION_DISABLE);
 				$activation = get_variable('activation', 'POST', USER_ACTIVATION_NONE, 'int');
 
-				$data['activation'] = in_array($activation, $activation_array) ? $activation : USER_ACTIVATION_NONE;
-		 		$data['coppa_enable'] = get_variable('coppa_enable', 'POST') ? 1 : 0;
-		 		$data['coppa_fax'] = get_variable('coppa_fax', 'POST');
-		 		$data['coppa_mail'] = get_variable('coppa_mail', 'POST');
-		 		$data['enable_confirm'] = get_variable('enable_confirm', 'POST') ? 1 : 0;
+				$data['activation']		= in_array($activation, $activation_array) ? $activation : USER_ACTIVATION_NONE;
+		 		$data['coppa_enable']	= get_variable('coppa_enable', 'POST') ? 1 : 0;
+		 		$data['coppa_fax']		= get_variable('coppa_fax', 'POST');
+		 		$data['coppa_mail']		= get_variable('coppa_mail', 'POST');
+		 		$data['enable_confirm']	= get_variable('enable_confirm', 'POST') ? 1 : 0;
+		 		$data['min_name_chars']	= get_variable('min_name_chars', 'POST', 0, 'INT');
+		 		$data['max_name_chars']	= get_variable('max_name_chars', 'POST', 0, 'INT');
+		 		$data['min_pass_chars']	= get_variable('min_pass_chars', 'POST', 0, 'INT');
+		 		$data['max_pass_chars']	= get_variable('max_pass_chars', 'POST', 0, 'INT');
 		 		$data['max_reg_attempts'] = get_variable('coppa_fax', 'POST', 0, 'INT');
-		 		$data['min_name_chars'] = get_variable('min_name_chars', 'POST', 0, 'INT');
-		 		$data['max_name_chars'] = get_variable('max_name_chars', 'POST', 0, 'INT');
-		 		$data['min_pass_chars'] = get_variable('min_pass_chars', 'POST', 0, 'INT');
-		 		$data['max_pass_chars'] = get_variable('max_pass_chars', 'POST', 0, 'INT');
 
 				foreach ($data as $name => $setting)
 				{
@@ -187,7 +187,7 @@
 						'username'		=> (string) $username,
 						'user_email'	=> (string) $email,
 						'user_group'	=> (int) ($coppa) ? 3 : 2,
-						'user_reg_date'	=> (int) gmtime(),
+						'user_reg_date'	=> (int) $_CLASS['core_user']->time,
 						'user_timezone'	=> $tz,
 	
 						'user_password'			=> (string) $password,
@@ -202,9 +202,11 @@
 	
 					user_add($data);
 					
-					set_core_config('user', 'newest_user_id', $row['user_id'], false);
-					set_core_config('user', 'newest_username', $row['username'], false);
-					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
+					set_core_config('user', 'newest_user_id', $data['user_id'], false);
+					set_core_config('user', 'newest_username', $data['username'], false);
+					set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1);
+					
+					trigger_error('USER_ADDED');
 				}
 			}
 
@@ -262,18 +264,17 @@
 						{
 							user_delete($id);
 				
-							trigger_error($_CLASS['core_user']->lang['BOT_DELETED']);
+							trigger_error('BOT_DELETED');
 						}
 					break;
 				}
 			}
-			
+
 			$sql = 'SELECT user_id, username, user_status, user_last_visit 
 				FROM ' . USERS_TABLE . '
 				WHERE user_type = ' . USER_BOT . ' ORDER BY user_last_visit DESC';
-			
 			$result = $_CLASS['core_db']->query($sql);
-			
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$_CLASS['core_template']->assign_vars_array('admin_bots', array(
@@ -286,9 +287,8 @@
 					'L_STATUS'		=> ($row['user_status'] == STATUS_ACTIVE) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
 				));
 			}
-			
 			$_CLASS['core_db']->free_result($result);
-			
+
 			$_CLASS['core_display']->display(false, 'admin/users/bots.html');
 		break;
 
@@ -301,7 +301,7 @@
 				$sql = 'SELECT user_id, user_type, user_status
 					FROM ' . USERS_TABLE . ' 
 					WHERE user_id = '.$id;
-				
+
 				$result = $_CLASS['core_db']->query($sql);
 				$row = $_CLASS['core_db']>fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
@@ -310,7 +310,7 @@
 				{
 					break;
 				}
-							
+
 				switch ($_REQUEST['option'])
 				{
 					case 'activate':
@@ -319,7 +319,7 @@
 							user_activate($id);
 						}
 					break;
-			
+
 					case 'delete':
 						if (display_confirmation())
 						{
@@ -384,11 +384,11 @@
 			$sql = 'SELECT count(*) as count FROM ' . USERS_TABLE . '
 				WHERE user_type = '.USER_NORMAL.'
 				AND user_status = '.$status;
-		
+
 			$result = $_CLASS['core_db']->query($sql);
 			list($count) = $_CLASS['core_db']->fetch_row_num($result);
 			$_CLASS['core_db']->free_result($result);
-			
+
 			$pagination = generate_pagination($link, $count, 20, $start, true);
 			$_CLASS['core_template']->assign('USERS_PAGINATION', $pagination['formated']);
 
@@ -438,7 +438,7 @@
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$type = ($status == STATUS_DISABLED) ? 'users_disabled' : 'users_unactivated';
-	
+
 		$_CLASS['core_template']->assign_vars_array($type, array(
 				'user_id'		=> $row['user_id'],
 				'user_name'		=> $row['username'],

Modified: trunk/admin.php
===================================================================
--- trunk/admin.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/admin.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -57,10 +57,6 @@
 	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name='".$_CLASS['core_db']->escape($mod)."'");
 	$_CORE_MODULE = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
-	
-// remove this -- just for testing
-	$_CORE_MODULE['module_name'] = $mod;
-	$_CORE_MODULE['module_title'] = $mod;
 }
 
 if (!$mod || !$_CORE_MODULE)

Modified: trunk/core.php
===================================================================
--- trunk/core.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/core.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -38,6 +38,7 @@
 mb_internal_encoding('UTF-8');
 //mb_http_output('UTF-8');
 
+
 // Remove registered globals
 if ((bool) ini_get('register_globals'))
 {
@@ -53,6 +54,17 @@
 $starttime = $starttime[1] + $starttime[0];
 $base_memory_usage = get_memory_usage();
 
+//REQUEST_URI not set in IIS
+if (empty($_SERVER['REQUEST_URI']))
+{
+	$_SERVER['REQUEST_URI'] = $_SERVER['SCRIPT_NAME'];
+
+	if ($_SERVER['QUERY_STRING'])
+	{
+		$_SERVER['REQUEST_URI'] .= '?'.$_SERVER['QUERY_STRING'];
+	}
+}
+
 require_once($site_file_root.'includes/functions.php');
 require_once($site_file_root.'config.php');
 require_once($site_file_root.'includes/tables.php');
@@ -70,7 +82,7 @@
 
 // Set error handler
 $_CLASS['core_error_handler']->start();
-//$_CLASS['core_error_handler']->stop();
+$_CLASS['core_error_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
 if (function_exists('register_shutdown_function'))
@@ -96,11 +108,15 @@
 die;
 */
 
+/*
+	Progres need to be optimized after install :-(
+	$_CLASS['core_db']->optimize_tables();
+*/
+
 $_CLASS['core_db']->return_on_error = true;
 
 // Error messages just incase we can't get our configs
-$config_error = '<center>There is currently a problem with the site<br/>';
-$config_error .= 'Please try again later<br /><br />Error Code: DB3</center>';
+$config_error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
 
 if (is_null($_CORE_CONFIG = $_CLASS['core_cache']->get('core_config')))
 {
@@ -221,7 +237,7 @@
 	This pisses me off, seeing that screen pop up all the time :-(
 	Enable it if you want, Will be disabled by default
 
-	if (PHP_OS == 'WINNT')
+	if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN')
 	{
 		exec('tasklist /fi "PID eq ' . getmypid() . '" /fo LIST', $output); 
 		//Mem Usage: 24,064 K

Modified: trunk/includes/compatiblity/mbstring.php
===================================================================
--- trunk/includes/compatiblity/mbstring.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/compatiblity/mbstring.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -26,6 +26,8 @@
 	next your going to say you can't use a database *
 */
 
+define('MB_CASE_TITLE', 0);
+
 if (!function_exists('mb_internal_encoding'))
 {
 	function mb_internal_encoding()
@@ -83,5 +85,11 @@
 	}
 }
 
-
+if (!function_exists('mb_strtolower'))
+{
+	function mb_strtolower($string, $encoding = null)
+	{
+		return strtolower($string);
+	}
+}
 ?>
\ No newline at end of file

Modified: trunk/includes/db/mssql.php
===================================================================
--- trunk/includes/db/mssql.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/mssql.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,18 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class db_mssql
 {
 	var $link_identifier = false;
@@ -566,46 +574,50 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = 0, $auto_increment = false)
+//$name, $number_min, $number_max = false, $default = 0, $auto_increment = false
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => 0, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
-		if ($number_min >= -0 && $number_max <= 255)
+		$length = max(strlen($setting['min']), strlen($setting['max']));
+
+		if ($setting['min'] >= -0 && $setting['max'] <= 255)
 		{
 			// TINYINT UNSIGNED ( 0 to 255 )
 			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -128 && $number_max <= 128)
+		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
 		{
 			// TINYINT ( -128 to 127 )
 			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
 		}
-		elseif ($number_min >= 0 && $number_max <= 65535)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
 		{
 			// SMALLINT UNSIGNED ( 0 to 65,535 )
 			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -32768 && $number_max <= 32767)
+		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
 		{
 			// SMALLINT ( -32,768 to 32,767 )
 			$this->_fields[$name] =  "`$name` SMALLINT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 16777215)
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
 		{
 			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
 			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
 		}
-		elseif ($number_min >= -8388608 && $number_max <= 8388607)
+		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
 		{
 			// MEDIUMINT ( -8,388,608 to 8,388,607 )
 			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
 		}
-		elseif ($number_min >= -2147483647 && $number_max <= 2147483647)
+		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
 		{
 			// INT ( -2,147,483,647 to 2,147,483,647 )
 			$this->_fields[$name] =  "`$name` INT($length)";
 		}
-		elseif ($number_min >= 0 && $number_max <= 4294967295) // we'll do this last
+		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
 		{
 			// INT UNSIGNED ( 0 to 4,294,967,295 )
 			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
@@ -617,7 +629,8 @@
 		}
 		else
 		{
-			$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= " DEFAULT '".(int) $default."'";
 		}
 	}
 

Modified: trunk/includes/db/mysql.php
===================================================================
--- trunk/includes/db/mysql.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/mysql.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -27,7 +27,7 @@
 	var $db_layer = 'mysql';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction;
 
 	var $queries_time = 0;
@@ -54,6 +54,7 @@
 		}
 
 		$this->link_identifier = ($db['persistent']) ? @mysql_pconnect($db['server'], $db['username'], $db['password']) : @mysql_connect($db['server'], $db['username'], $db['password']);
+
 		if ($this->link_identifier)
 		{
 			if (@mysql_select_db($db['database']))
@@ -89,16 +90,11 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
-	function return_on_error($fail = false)
-	{
-		$this->return_on_error = $fail;
-	}
-
 	function transaction($option = 'start', $auto_rollback = true)
 	{
 		if (!$this->link_identifier)
@@ -302,7 +298,7 @@
 
 		$num = mysql_affected_rows($this->link_identifier);
 
-		return (!$num || $num == -1) ? 0 : $num;
+		return (!$num || $num === -1) ? 0 : $num;
 	}
 
 	function fetch_row_assoc($result = false)
@@ -418,7 +414,7 @@
 
 	function _error($sql = '', $backtrace)
 	{
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}

Modified: trunk/includes/db/mysql3.php
===================================================================
--- trunk/includes/db/mysql3.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/mysql3.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -21,13 +21,13 @@
 $Id$
 */
 
-class db_mysql
+class db_mysql3
 {
 	var $link_identifier = false;
 	var $db_layer = 'mysql3';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction = false;
 
 	var $queries_time = 0;
@@ -53,7 +53,7 @@
 			$this->disconnect();
 		}
 
-		$this->link_identifier = ($db['persistent']) ? @mysql_pconnect($db['server'], $db['username'], $db['password']) : @mysql_connect($db['server'], $db['username'], $db['password']);
+		$this->link_identifier = ($db['persistent']) ? mysql_pconnect($db['server'], $db['username'], $db['password']) : mysql_connect($db['server'], $db['username'], $db['password']);
 
 		if ($this->link_identifier)
 		{
@@ -65,7 +65,7 @@
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
 		
-		if (!$error)
+		if (!isset($error))
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 		}
@@ -86,16 +86,11 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
-	function return_on_error($fail = false)
-	{
-		$this->return_on_error = $fail;
-	}
-
 	function transaction($option = 'start', $auto_rollback = true)
 	{
 		return true;
@@ -249,7 +244,7 @@
 
 		$num = mysql_affected_rows($this->link_identifier);
 
-		return (!$num || $num == -1) ? 0 : $num;
+		return (!$num || $num === -1) ? 0 : $num;
 	}
 
 	function fetch_row_assoc($result = false)
@@ -355,7 +350,7 @@
 
 	function _error($sql = '', $backtrace)
 	{
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}
@@ -470,7 +465,10 @@
 					return $table;
 				}
 
-				$this->sql_query($table);
+				if (!$this->sql_query($table))
+				{
+					echo $table;
+				}
 
 			case 'cancel':
 				$this->_table_name = false;
@@ -481,20 +479,6 @@
 
 	function add_table_field_int($name, $setting_sent)
 	{
-		if (!$setting_sent || !is_array($setting_sent))
-		{
-			global $site_file_root;
-			
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-			print_r($backtrace);echo '<br/>';
-		}
-		
 		$setting = array('default' => null, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
 		$setting = array_merge($setting, $setting_sent);
 
@@ -552,7 +536,7 @@
 		}
 	}
 
-	function add_table_field_text($name, $characters = 60000, $null = false)
+	function add_table_field_text($name, $characters, $null = false)
 	{
 		if ($characters <= 255)
 		{
@@ -581,7 +565,7 @@
 	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
 		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= $null ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
 		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
@@ -589,10 +573,6 @@
 	{
 		$index_name = ($index_name) ? $index_name : $field;
 		
-		/*if (empty($this->_fields[$field]))
-		{
-			return;
-		}*/
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: trunk/includes/db/mysqli.php
===================================================================
--- trunk/includes/db/mysqli.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/mysqli.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -307,7 +307,7 @@
 
 		$num = mysqli_affected_rows($this->link_identifier);
 
-		return (!$num || $num == -1) ? 0 : $num;
+		return (!$num || $num === -1) ? 0 : $num;
 	}
 
 	function fetch_row_assoc($result = false)

Modified: trunk/includes/db/postgres.php
===================================================================
--- trunk/includes/db/postgres.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/postgres.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -27,7 +27,7 @@
 	var $db_layer = 'postgre';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction = false;
 
 	var $queries_time = 0;
@@ -106,11 +106,10 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
-
 	function transaction($option = 'start', $auto_rollback = true)
 	{
 		$result = false;
@@ -424,7 +423,7 @@
 
 	function _error($sql = '', $backtrace)
 	{
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}
@@ -439,15 +438,39 @@
 		trigger_error($message, E_USER_ERROR);
 	}
 
-	function version()
+	function version($return_dbname = false)
 	{
 		if (!$this->link_identifier)
 		{
 			return false;
 		}
 
-		//$version = pg_version($this->link_identifier);
-		//return $version['client'];
+		if (function_exists('pg_version'))
+		{
+			$version = pg_version($this->link_identifier);
+			return $version['server'];	
+		}
+		else
+		{
+			$result = $this->query('SELECT VERSION() AS version');
+			$row = $this->fetch_row_assoc($result);
+			$this->free_result($result);
+
+			if (!$row)
+			{
+				return;
+			}
+
+			if ($return_dbname)
+			{	// should we return the full info ?
+				return $row['version'];
+			}
+			else
+			{
+				$version = explode(' ', $row['version']);
+				return $version[1];
+			}
+		}
 	}
 
 	function _debug($mode, $backtrace)

Modified: trunk/includes/db/sqlite.php
===================================================================
--- trunk/includes/db/sqlite.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/sqlite.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -33,7 +33,7 @@
 	var $db_layer = 'sqlite';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction;
 
 	var $queries_time = 0;
@@ -86,9 +86,9 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
 	function transaction($option = 'start')
@@ -409,7 +409,7 @@
 
 	function _error($sql = '', $backtrace)
 	{
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}

Modified: trunk/includes/db/sqlite_pdo.php
===================================================================
--- trunk/includes/db/sqlite_pdo.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/db/sqlite_pdo.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -29,7 +29,7 @@
 	var $db_layer = 'sqlite';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction;
 
 	var $queries_time = 0;
@@ -73,9 +73,9 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
 	function transaction($option = 'start')
@@ -352,7 +352,7 @@
 
 	function _error($sql = '', $backtrace)
 	{
-		if ($this->return_on_error)
+		if (!$this->report_error)
 		{
 			return;
 		}
@@ -453,13 +453,20 @@
 
 				// Have to create the table first then do the indexs
 				// I guess it's ....
-				$this->sql_query($table);
-
+				if (!$this->sql_query($table))
+				{
+					echo $table.'<br/>';
+				}
+				
 				foreach ($this->_indexs as $query)
 				{
-					$this->sql_query($query);
+					if (!$this->sql_query($query))
+					{
+						echo $query.'<br/>';
+					}
 				}
 
+
 			case 'cancel':
 				$this->_table_name = false;
 				$this->_fields = $this->_indexs = array();
@@ -467,60 +474,68 @@
 		}
 	}
 
-	function add_table_field_int($name, $number_min, $number_max = false, $default = null, $auto_increment = false)
+	function add_table_field_int($name, $setting_sent)
 	{
-		$length = max(strlen($number_min), strlen($number_max));
+		$setting = array('default' => null, 'auto_increment' => false, 'null' => false);
+		$setting = array_merge($setting, $setting_sent);
 
 		$this->_fields[$name] =  $name .' INTEGER';
 
-		if ($auto_increment)
+		if ($setting['auto_increment'])
 		{
 			$this->_fields[$name] .= ' AUTOINCREMENT';
 		}
 		else
 		{
-			$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '".(int) $default."'";
+			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
+			$this->_fields[$name] .= is_null($setting['default']) ? '' : " DEFAULT '".(int) $setting['default']."'";
 		}
 	}
 
-	function add_table_field_text($name, $characters = 60000, $null = true)
+	function add_table_field_text($name, $characters, $null = true)
 	{
-		$this->_fields[$name] =  $name.' TEXT';
-		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] =  "$name TEXT".(($null) ? " NULL" : " NOT NULL");
 	}
 
-	function add_table_field_char($name, $characters, $default = null, $padded = false)
+	function add_table_field_char($name, $characters, $null = false, $default = null, $padded = false)
 	{
-
 		$this->_fields[$name] =  $name.' TEXT';
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
+		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
+		$this->_fields[$name] .= is_null($default) ? '' : "DEFAULT '$default'";
 	}
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		if (empty($this->_fields[$field]))
-		{
-			return;
-		}
+		$index_name = ($index_name) ? $index_name : $field;
 
-		$index_name = $this->_table_name.'_'.(($index_name) ? $index_name : $field) ;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+		$index_name = $this->_table_name . '_' . $index_name;
 
 		switch ($type)
 		{
 			case 'index':
-			case 'unique'://CREATE INDEX group_id ON test_admins ( group_id ) ; 
-				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'CREATE UNIQUE' : 'CREATE') . " INDEX $index_name ON {$this->_table_name} ( $field );";
+			case 'unique':
+				$field = is_array($field) ? implode(', ', $field) : $field;
+				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'CREATE UNIQUE' : 'CREATE') . " INDEX $index_name ON {$this->_table_name} ($field);";
 			break;
 
-			case 'primary'://13
-			
-				if ($pos = stripos($this->_fields[$field], ' AUTOINCREMENT'))
+			case 'primary':
+// need to check if sqlite even supports 2 pkeys
+				if (is_array($field))
 				{
+					// maybe make this regular indexes
+					return;
+				}
+
+				/*
+				if ($pos = strpos($this->_fields[$field], ' AUTOINCREMENT'))
+				{
 					$this->_fields[$field] = substr($this->_fields[$field], 0, $pos);
 					$this->_fields[$field] .= ' PRIMARY KEY AUTOINCREMENT'; // AUTOINCREMENT isn't needed
 
 					break;
 				}
+				*/
 
 				$this->_fields[$field] .= ' PRIMARY KEY';
 			break;

Modified: trunk/includes/display/blocks.php
===================================================================
--- trunk/includes/display/blocks.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/display/blocks.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,4 +1,4 @@
-<?php
+<?php
 /*
 ||**************************************************************||
 ||  Viperal CMS ?? :												||
@@ -17,409 +17,410 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
-*/
 
-/* to do
-move Auth, lang, and expire/begin checks to load_blocks
-*/
-
-class core_blocks
-{
-	var $blocks_array = array();
-	var $blocks_loaded;
-	var $info;
-	var $content;
-	var $template;
-
+$Id$
+*/
+/* to do
+move Auth, lang, and expire/begin checks to load_blocks
+*/
+
+class core_blocks
+{
+	var $blocks_array = array();
+	var $blocks_loaded;
+	var $info;
+	var $content;
+	var $template;
+
 	/*
-		Check to see there's any blocks for the specified side
+		Check to see there's any blocks for the specified side
 		should be used to stop themes from displaying blank sides
-	*/
-	function check_side($side)
-	{
-// expand this for center blocks
-		static $side_check = array();
-		
-		if (isset($side_check[$side]))
-		{
-			return $side_check[$side];
-		}
-
-		global $_CORE_MODULE, $_CLASS;
-
-		$trueside = $side;
-
-		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
-		{
-			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
-		}
-			
-		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
-		{
-			$this->load_blocks();
-
-			if (!empty($this->blocks_array[$side]))
-			{
-				return $side_check[$trueside] = $side;
-			}
-		}
-		
-		return $side_check[$trueside] = false;
-	}
-
+	*/
+	function check_side($side)
+	{
+// expand this for center blocks
+		static $side_check = array();
+		
+		if (isset($side_check[$side]))
+		{
+			return $side_check[$side];
+		}
+
+		global $_CORE_MODULE, $_CLASS;
+
+		$trueside = $side;
+
+		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
+		{
+			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
+		}
+			
+		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
+		{
+			$this->load_blocks();
+
+			if (!empty($this->blocks_array[$side]))
+			{
+				return $side_check[$trueside] = $side;
+			}
+		}
+		
+		return $side_check[$trueside] = false;
+	}
+
 	/*
-		Load Blocks from cache or databases, also run needed checks
-	*/
-// Add auth check here
-	function load_blocks($force = false)
-	{
-		if ($this->blocks_loaded && !$force)
-		{
-			return;
-		}
-
-		global $_CLASS;
-
-		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
-		{
-			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
-
-			$this->blocks_array = array();
-
-			while($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
-				$this->blocks_array[$row['block_position']][] = $row;
-			}
-
-			$_CLASS['core_db']->free_result($result);
-			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
-
-			$_CLASS['core_cache']->save();
-		}
-
-		$_CLASS['core_cache']->remove('blocks');
-		$this->blocks_loaded = true;
-	}
-
+		Load Blocks from cache or databases, also run needed checks
+	*/
+// Add auth check here
+	function load_blocks($force = false)
+	{
+		if ($this->blocks_loaded && !$force)
+		{
+			return;
+		}
+
+		global $_CLASS;
+
+		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
+		{
+			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
+
+			$this->blocks_array = array();
+
+			while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
+				$this->blocks_array[$row['block_position']][] = $row;
+			}
+
+			$_CLASS['core_db']->free_result($result);
+			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
+
+			$_CLASS['core_cache']->save();
+		}
+
+		$_CLASS['core_cache']->remove('blocks');
+		$this->blocks_loaded = true;
+	}
+
 	/*
-	*/
-	function add_block($data, $position = false)
-	{
-		$option_array = array('block_title','block_position', 'block_content', 'block_file' , 'block_starts' ,'block_expires', 'block_id',	'block_auth',	'block_type');
-
-		foreach($option_array as $option)
-		{
-			$data_perpared[$option] = (empty($data[$option])) ? '' : $data[$option];
-		}
-
-		$this->blocks_array[$data_perpared['block_position']][] = $data_perpared;
-	}
-
+	*/
+	function add_block($data, $position = false)
+	{
+		$option_array = array('block_status' => STATUS_ACTIVE, 'block_title' => '','block_position' => BLOCK_LEFT, 'block_content' => '', 'block_file' => '', 'block_starts' => 0,'block_expires' => 0, 'block_id' => 0,	'block_auth' => '',	'block_type' => '');
+
+		foreach ($option_array as $option => $value)
+		{
+			$data_perpared[$option] = isset($data[$option]) ? $data[$option] : $value ;
+		}
+
+		$this->blocks_array[$data_perpared['block_position']][] = $data_perpared;
+	}
+
 	/*
-	*/
-	function display($position)
-	{
-		$this->display_position = $position;
-
-		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
-		{
-			$position = $this->check_side($position);
-			
-			if ($position == false)
-			{
-				return false;
-			}
-		}
-
-		$this->load_blocks();
-
-		if (empty($this->blocks_array[$position]))
-		{
-			return false;
-		}
-
-		static $expire_updated = false;
-		global $_CLASS;
-
-		$this->content = '';
-
-		foreach($this->blocks_array[$position] as $this->block)
-		{
-			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
-			{
-				continue;
-			}
-//language check here.
-			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
-			{
-				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET active=0 WHERE expires > 0 AND expires <='.$_CLASS['core_user']->time);
-										
-				$_CLASS['core_cache']->destroy('blocks');
-				$expire_updated = true;
-
-				continue;
-			}
-
-			if ($this->block['block_starts'] && ($this->block['block_starts'] > $_CLASS['core_user']->time))
-			{
-				continue;
-			}
-
-			/*
-			if ($this->block['block_modules'])
-			{
-				$this->block['block_modules'] = unserialize($this->block['block_modules']);
-// Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
-				{
-					continue;
-				}
-			}
-			*/
-
-			$this->display_blocks();
-			$this->content = '';
-		}
-
-		unset($this->blocks_array[$position]);
-	}
-
+	*/
+	function display($position)
+	{
+		$this->display_position = $position;
+
+		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
+		{
+			$position = $this->check_side($position);
+			
+			if ($position == false)
+			{
+				return false;
+			}
+		}
+
+		$this->load_blocks();
+
+		if (empty($this->blocks_array[$position]))
+		{
+			return false;
+		}
+
+		static $expire_updated = false;
+		global $_CLASS;
+
+		$this->content = '';
+
+		foreach($this->blocks_array[$position] as $this->block)
+		{
+			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
+			{
+				continue;
+			}
+//language check here.
+			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
+			{
+				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);
+										
+				$_CLASS['core_cache']->destroy('blocks');
+				$expire_updated = true;
+
+				continue;
+			}
+
+			if ($this->block['block_starts'] && ($this->block['block_starts'] > $_CLASS['core_user']->time))
+			{
+				continue;
+			}
+
+			/*
+			if ($this->block['block_modules'])
+			{
+				$this->block['block_modules'] = unserialize($this->block['block_modules']);
+// Homepage needs it's own value
+				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
+				{
+					continue;
+				}
+			}
+			*/
+
+			$this->display_blocks();
+			$this->content = '';
+		}
+
+		unset($this->blocks_array[$position]);
+	}
+
 	/*
-	*/
-	function display_blocks()
-	{
-		Switch ($this->block['block_type'])
-		{
-			case BLOCKTYPE_FILE:
-			case BLOCKTYPE_SYSTEM:
-				$this->block_file();
-			break;
-				
-			case BLOCKTYPE_MESSAGE:
-			case BLOCKTYPE_MESSAGE_GLOBAL:
-				$this->block_message();
-			break;
-					
-			case BLOCKTYPE_HTML:
-				$this->block_html();
-			break;
-				
-			case BLOCKTYPE_FEED;
-				$this->block_feed();
-			break;
-		}
-		return;
-	}
-
+	*/
+	function display_blocks()
+	{
+		Switch ($this->block['block_type'])
+		{
+			case BLOCKTYPE_FILE:
+			case BLOCKTYPE_SYSTEM:
+				$this->block_file();
+			break;
+				
+			case BLOCKTYPE_MESSAGE:
+			case BLOCKTYPE_MESSAGE_GLOBAL:
+				$this->block_message();
+			break;
+					
+			case BLOCKTYPE_HTML:
+				$this->block_html();
+			break;
+				
+			case BLOCKTYPE_FEED;
+				$this->block_feed();
+			break;
+		}
+		return;
+	}
+
 	/*
-	*/
-	function block_file()
-	{
-		global $_CLASS, $site_file_root;
-
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
-		{
-			$this->info = false;
-
-			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
-
-			include($site_file_root.'blocks/'.$this->block['block_file']);
-
-			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
-
-			if (!$this->content && !$this->template)
-			{
-				if ($_CLASS['core_auth']->admin_power('blocks'))
-				{
-					$this->content = '<center><strong>'.(($this->info) ? $this->info : $_CLASS['core_user']->lang['BLOCK_ERROR2']).'</strong></center>';
-				}
-				else
-				{
-					return;
-				}
-			}
-		}
-		else
-		{
-			if ($_CLASS['core_auth']->admin_power('blocks'))
-			{
-				$this->content = '<center><strong>'.$_CLASS['core_user']->lang['BLOCK_ERROR1'].'</strong></center>';
-			}
-			else
-			{
-				return;
-			}		
-		}
-
-		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
-		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_message()
-	{
-		global $_CLASS;
-
-		if (($this->block['block_type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
-		{
-			return;
-		}
-
-		if ($_CLASS['core_auth']->admin_power('messages'))
-		{
-			$expires = ($this->block['block_expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['block_expires']) : false;
-			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['block_id'], array('admin' => true));
-		}
-		else
-		{
-		
-			$edit_link = $expires = false;
-		}
-
-		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
-
-		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
-				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-				'title'		=> $this->block['block_title'],
-				'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
-				'content'	=> $this->block['block_content'],
-				'expires'	=> $expires,
-				'edit_link'	=> $edit_link,
-				'id'		=> $this->block['block_id'],
-		));
-	}
-
-	function block_side()
-	{
-		global $_CLASS;
-		
-		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
-		
-		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
-			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-			'title'		=> $this->block['block_title'],
-			'content'	=> $this->content,
-			'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
-			'id'		=> $this->block['block_id'],
-		));
-	}
-
-	function block_html()
-	{
-		$this->content = $this->block['block_content'];
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_feed()
-	{
-		global $site_file_root, $_CLASS;
-// think about disabling the block automatically if there's url problems
-// update core_rss file
-		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > time()))
-		{
-			$this->content = $this->block['block_content'];
-
-			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-			{
-				$this->block_side();
-			}
-			else
-			{
-				$this->block_center();
-			}
-
-			return;
-		}
-
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
-		{
-			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
-			
-			if (!$this->content)
-			{
-				return;
-			}
-		}
-		else
-		{
-			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
-			$_CLASS['core_rss']->setup(false, array('title', 'link'));
-				
-			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))
-			{
-	//admin only message here
-				return;
-			}
-
-			$this->content = '<center><br />';
-
-			while ($data = $_CLASS['core_rss']->get_rss_data())
-			{
-				$this->content .= '<a href="'.$data['link'].'" target="new">'.$data['title'].'</a><hr width="30%"/>';
-			}
-			
-			if (!empty($_CLASS['core_rss']->rss_info['link']))
-			{
-				$this->content .= '<br /><a href="'.$_CLASS['core_rss']->rss_info['link'].'" target="_blank"><b>Read More</b></a>';
-			}
-			
-			$this->content .= '</center>';
-		}
-
-		settype($this->block['block_rss_rate'], 'integer');
-
-		if ($this->block['block_rss_rate'] !== -1)
-		{
-			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? gmtime() + (int) $this->block['block_rss_rate'] : 0;
-			
-			$sql = 'UPDATE '.BLOCKS_TABLE."
-				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
-					WHERE block_id = ".$this->block['block_id'];
-				
-			$_CLASS['core_db']->query($sql);
-
-			$_CLASS['core_cache']->destroy('blocks');
-		}
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_center()
-	{
-		global $_CLASS;
-		
-		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
-		
-		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
-			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-			'CONTENT'	=> $this->content,
-			'TEMPLATE'	=> $this->template
-		));
-	}
-}
-
+	*/
+	function block_file()
+	{
+		global $_CLASS, $site_file_root;
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
+		{
+			$this->info = false;
+
+			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
+
+			include($site_file_root.'blocks/'.$this->block['block_file']);
+
+			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
+
+			if (!$this->content && !$this->template)
+			{
+				if ($_CLASS['core_auth']->admin_power('blocks'))
+				{
+					$this->content = '<center><strong>'.(($this->info) ? $this->info : $_CLASS['core_user']->lang['BLOCK_ERROR2']).'</strong></center>';
+				}
+				else
+				{
+					return;
+				}
+			}
+		}
+		else
+		{
+			if ($_CLASS['core_auth']->admin_power('blocks'))
+			{
+				$this->content = '<center><strong>'.$_CLASS['core_user']->lang['BLOCK_ERROR1'].'</strong></center>';
+			}
+			else
+			{
+				return;
+			}		
+		}
+
+		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
+		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_message()
+	{
+		global $_CLASS;
+
+		if (($this->block['block_type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
+		{
+			return;
+		}
+
+		if ($_CLASS['core_auth']->admin_power('messages'))
+		{
+			$expires = ($this->block['block_expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['block_expires']) : false;
+			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['block_id'], array('admin' => true));
+		}
+		else
+		{
+		
+			$edit_link = $expires = false;
+		}
+
+		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
+
+		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
+				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+				'title'		=> $this->block['block_title'],
+				'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+				'content'	=> $this->block['block_content'],
+				'expires'	=> $expires,
+				'edit_link'	=> $edit_link,
+				'id'		=> $this->block['block_id'],
+		));
+	}
+
+	function block_side()
+	{
+		global $_CLASS;
+		
+		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
+		
+		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
+			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+			'title'		=> $this->block['block_title'],
+			'content'	=> $this->content,
+			'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+			'id'		=> $this->block['block_id'],
+		));
+	}
+
+	function block_html()
+	{
+		$this->content = $this->block['block_content'];
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_feed()
+	{
+		global $site_file_root, $_CLASS;
+// think about disabling the block automatically if there's url problems
+// update core_rss file
+		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > time()))
+		{
+			$this->content = $this->block['block_content'];
+
+			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+			{
+				$this->block_side();
+			}
+			else
+			{
+				$this->block_center();
+			}
+
+			return;
+		}
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
+		{
+			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
+			
+			if (!$this->content)
+			{
+				return;
+			}
+		}
+		else
+		{
+			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
+			$_CLASS['core_rss']->setup(false, array('title', 'link'));
+				
+			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))
+			{
+	//admin only message here
+				return;
+			}
+
+			$this->content = '<center><br />';
+
+			while ($data = $_CLASS['core_rss']->get_rss_data())
+			{
+				$this->content .= '<a href="'.$data['link'].'" target="new">'.$data['title'].'</a><hr width="30%"/>';
+			}
+			
+			if (!empty($_CLASS['core_rss']->rss_info['link']))
+			{
+				$this->content .= '<br /><a href="'.$_CLASS['core_rss']->rss_info['link'].'" target="_blank"><b>Read More</b></a>';
+			}
+			
+			$this->content .= '</center>';
+		}
+
+		settype($this->block['block_rss_rate'], 'integer');
+
+		if ($this->block['block_rss_rate'] !== -1)
+		{
+			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? gmtime() + (int) $this->block['block_rss_rate'] : 0;
+			
+			$sql = 'UPDATE '.BLOCKS_TABLE."
+				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
+					WHERE block_id = ".$this->block['block_id'];
+				
+			$_CLASS['core_db']->query($sql);
+
+			$_CLASS['core_cache']->destroy('blocks');
+		}
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_center()
+	{
+		global $_CLASS;
+		
+		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
+		
+		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
+			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+			'CONTENT'	=> $this->content,
+			'TEMPLATE'	=> $this->template
+		));
+	}
+}
+
 ?>
\ No newline at end of file

Modified: trunk/includes/display/display.php
===================================================================
--- trunk/includes/display/display.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/display/display.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 class core_display
@@ -144,6 +146,11 @@
 		{
 			$_CORE_MODULE['module_title'] = $title;
 		}
+		elseif (!$_CORE_MODULE['module_title'])
+		{
+// should move this somewhere else
+			$_CORE_MODULE['module_title'] = $_CORE_MODULE['module_name'];
+		}
 
 		$this->headers();
 
@@ -167,6 +174,7 @@
 			$this->message = '<b>System is in maintenance mode</b><br />';
 		}
 
+
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']),

Modified: trunk/includes/display/template.php
===================================================================
--- trunk/includes/display/template.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/display/template.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -17,6 +17,8 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
 /*
@@ -364,7 +366,7 @@
 				case 'DISPLAY_FOOTER':
 					$tag_blocks[0][$loop] = "<?php echo \$_CLASS['core_display']->display_footer(); ?>";
 				break;
-	
+
 				case 'IGNORE':
 					$compile = false;
 				break;

Modified: trunk/includes/forums/admin/admin_forums.php
===================================================================
--- trunk/includes/forums/admin/admin_forums.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/forums/admin/admin_forums.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -106,7 +106,10 @@
 				'prune_announce'		=> request_var('prune_announce', FALSE),
 				'prune_sticky'			=> request_var('prune_sticky', FALSE),
 				'forum_password'		=> request_var('forum_password', ''),
-				'forum_password_confirm'=> request_var('forum_password_confirm', '')
+				'forum_password_confirm'=> request_var('forum_password_confirm', ''),
+				'forum_posts'			=> 0,
+				'forum_topics'			=> 0,
+				'forum_topics_real'		=> 0,
 			);
 
 			if ($forum_data['forum_rules'])

Modified: trunk/includes/forums/admin/admin_ranks.php
===================================================================
--- trunk/includes/forums/admin/admin_ranks.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/forums/admin/admin_ranks.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -19,11 +19,12 @@
  *
  ***************************************************************************/
 
+// needs work
 
 // Do we have permission?
 if (!$_CLASS['auth']->acl_get('a_ranks'))
 {
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+	trigger_error('NO_ADMIN');
 }
 
 // Check mode
@@ -38,7 +39,7 @@
 	{
 		$mode = 'add';
 	}
-	else if (isset($_POST['save']))
+	elseif (isset($_POST['save']))
 	{
 		$mode = 'save';
 	}
@@ -58,22 +59,26 @@
 	case 'add':
 
 		$data = $ranks = $existing_imgs = array();
-		$result = $_CLASS['core_db']->sql_query('SELECT * 
-			FROM ' . RANKS_TABLE . ' 
+
+		$result = $_CLASS['core_db']->query('SELECT * 
+			FROM ' . FORUMS_RANKS_TABLE . ' 
 			ORDER BY rank_special DESC, rank_min DESC');
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			do
+			$existing_imgs[] = $row['rank_image'];
+
+			if ($mode == 'edit' && $rank_id == $row['rank_id'])
 			{
-				$existing_imgs[] = $row['rank_image'];
-				if ($mode == 'edit' && $rank_id == $row['rank_id'])
-				{
-					$ranks = $row;
-				}
+				$ranks = $row;
 			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+// temp stuff
+if (empty($ranks))
+{
+$ranks['rank_title'] = $ranks['rank_image'] = $ranks['rank_special'] = $ranks['rank_min'] = '';
+}
+		$_CLASS['core_db']->free_result($result);
 
 		$imglist = filelist($config['ranks_path'], '');
 
@@ -197,20 +202,20 @@
 
 		if ($rank_id)
 		{
-			$sql = "UPDATE " . RANKS_TABLE . "
-				SET rank_title = '" . $_CLASS['core_db']->sql_escape($rank_title) . "', rank_special = $special_rank, rank_min = $min_posts, rank_image = '" . $_CLASS['core_db']->sql_escape($rank_image) . "'
+			$sql = "UPDATE " . FORUMS_RANKS_TABLE . "
+				SET rank_title = '" . $_CLASS['core_db']->escape($rank_title) . "', rank_special = $special_rank, rank_min = $min_posts, rank_image = '" . $_CLASS['core_db']->escape($rank_image) . "'
 				WHERE rank_id = $rank_id";
 
 			$message = $_CLASS['core_user']->lang['RANK_UPDATED'];
 		}
 		else
 		{
-			$sql = "INSERT INTO " . RANKS_TABLE . " (rank_title, rank_special, rank_min, rank_image)
-				VALUES ('" . $_CLASS['core_db']->sql_escape($rank_title) . "', $special_rank, $min_posts, '" . $_CLASS['core_db']->sql_escape($rank_image) . "')";
+			$sql = "INSERT INTO " . FORUMS_RANKS_TABLE . " (rank_title, rank_special, rank_min, rank_image)
+				VALUES ('" . $_CLASS['core_db']->escape($rank_title) . "', $special_rank, $min_posts, '" . $_CLASS['core_db']->escape($rank_image) . "')";
 
 			$message = $_CLASS['core_user']->lang['RANK_ADDED'];
 		}
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$_CLASS['core_cache']->destroy('ranks');
 
@@ -225,14 +230,14 @@
 
 		if ($rank_id)
 		{
-			$sql = "DELETE FROM " . RANKS_TABLE . "
+			$sql = "DELETE FROM " . FORUMS_RANKS_TABLE . "
 				WHERE rank_id = $rank_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$sql = "UPDATE " . USERS_TABLE . "
 				SET user_rank = 0
 				WHERE user_rank = $rank_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			$_CLASS['core_cache']->destroy('ranks');
 
@@ -265,11 +270,11 @@
 <?php
 
 		// Show the default page
-		$sql = "SELECT * FROM " . RANKS_TABLE . "
+		$sql = "SELECT * FROM " . FORUMS_RANKS_TABLE . "
 			ORDER BY rank_min ASC, rank_special ASC";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$row_class = 'row2';
 			
@@ -300,7 +305,7 @@
 <?php
 
 			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
 
 ?>

Modified: trunk/includes/functions.php
===================================================================
--- trunk/includes/functions.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/functions.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -537,9 +537,9 @@
 			'config_cache'	=> (int) $cache,
 		);
 
-		$_CLASS['core_db']->return_on_error(true);
+		$_CLASS['core_db']->report_error(false);
 		$_CLASS['core_db']->query('INSERT INTO ' . CORE_CONFIG_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
-		$_CLASS['core_db']->return_on_error(false);
+		$_CLASS['core_db']->report_error(true);
 	}
 
 	$_CORE_CONFIG[$section][$name] = $value;
@@ -831,7 +831,6 @@
 	}
 }
 
-
 // Should 4.3 be the min, or 4.2 ?
 // Move seperate file, if someone has a pre 4.3 they'll have to include that file
 if (!function_exists('debug_backtrace'))

Modified: trunk/includes/functions_user.php
===================================================================
--- trunk/includes/functions_user.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/functions_user.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -162,7 +162,7 @@
 	$_CLASS['core_db']->query($sql);
 
 	$data['user_id'] = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
-				
+
 	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
 		'group_id'		=> (int) $data['user_group'],
 		'user_id'		=> (int) $data['user_id'],

Modified: trunk/includes/session.php
===================================================================
--- trunk/includes/session.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/session.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -118,7 +118,7 @@
 		$ali = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_ali', 'COOKIE', false, 'int');
 		$alc = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_alc', 'COOKIE');
 
-		if ($ali && $ali)
+		if ($ali && $alc)
 		{
 			if ($id = $this->autologin_retrieve($ali, $alc))
 			{
@@ -305,6 +305,8 @@
 					$this->autologin_destroy($this->data['user_id'], $this->autologin_code);
 				}
 			}
+
+			$this->save_session = false;
 		}
 
 		$sql = 'DELETE FROM ' . SESSIONS_TABLE . "

Modified: trunk/includes/templates/message.html
===================================================================
--- trunk/includes/templates/message.html	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/templates/message.html	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,22 +1,11 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
-<title>Error</title>
-</head>
-<body style="background: url(/bg.gif);">
+<!-- DISPLAY_HEADER -->
 
-<table style="position: absolute; left: 25%; top: 25%;">
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
 	<tr>
-		<td>
-			<img src="/paladin.png" />
-		</td>
-		<td valign="top">
+		<td align="center"  class="row1">
 			{ $MESSAGE_TEXT }
 		</td>
 	</tr>
 </table>
-
-
-</body>
-</html>
\ No newline at end of file
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-08 04:05:29 UTC (rev 99)
@@ -34,9 +34,9 @@
 
 	<!-- LOOP $topicrow -->
 	<tr>
-		<td class="row1" width="25" align="center">{ $topicrow:TOPIC_FOLDER_IMG }</td>
+		<td class="row1" align="center" width="25">{ $topicrow:TOPIC_FOLDER_IMG }</td>
 		<!-- IF { $S_TOPIC_ICONS } -->
-		<td class="row1" width="25" align="center"><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /></td>
+		<td class="row1" align="center" width="25"><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /></td>
 		<!-- ENDIF -->
 		<td class="row1">
 			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
@@ -45,15 +45,15 @@
 			<!-- IF { $topicrow:S_TOPIC_REPORTED } -->
 				<a href="{$topicrow:U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
-			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{$topicrow:U_VIEW_TOPIC}">{$topicrow:TOPIC_TITLE}</a></p>
+			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{$topicrow:U_VIEW_TOPIC}">{$topicrow:TOPIC_TITLE}</a> </p>
 		<!-- IF { $topicrow:PAGINATION } -->
 		<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 		<!-- ENDIF -->
 		</td>
-		<td class="row2" width="100" align="center"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
-		<td class="row1" width="50" align="center"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
-		<td class="row2" width="50" align="center"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
-		<td class="row1" width="120" align="center">
+		<td class="row2" align="center" width="100"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row1" align="center" width="50"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
+		<td class="row2" align="center" width="50"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
+		<td class="row1" align="center" width="120">
 			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
 			<p class="topicdetails">
 			<!-- IF { $topicrow:U_LAST_POST_AUTHOR } -->
@@ -150,9 +150,9 @@
 	</tr>
 	<!-- ENDIF -->
 	<tr>
-		<td class="row1" width="25" align="center">{ $topicrow:TOPIC_FOLDER_IMG }</td>
+		<td class="row1" align="center" width="25">{ $topicrow:TOPIC_FOLDER_IMG }</td>
 		<!-- IF { $S_TOPIC_ICONS } -->
-		<td class="row1" width="25" nowrap="nowrap" align="center"><!-- IF { $topicrow:TOPIC_ICON_IMG } --><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /><!-- ENDIF --></td>
+		<td class="row1" align="center" width="25"><!-- IF { $topicrow:TOPIC_ICON_IMG } --><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /><!-- ENDIF --></td>
 		<!-- ENDIF -->
 		<td class="row1">
 			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
@@ -161,15 +161,15 @@
 			<!-- IF { $topicrow:S_TOPIC_REPORTED } -->
 				<a href="{$topicrow:U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
-			<p class="topictitle">&nbsp;{ $topicrow:NEWEST_POST_IMG }&nbsp;{ $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a>&nbsp;</p>
+			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a> </p>
 			<!-- IF { $topicrow:PAGINATION } -->
 			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 			<!-- ENDIF -->
 		</td>
-		<td class="row2" width="80" align="center"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
-		<td class="row1" width="50" align="center"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
-		<td class="row2" width="50" align="center"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
-		<td class="row1" width="150" nowrap="nowrap" align="center">
+		<td class="row2" align="center" width="100"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row1" align="center" width="50"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
+		<td class="row2" align="center" width="50"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
+		<td class="row1" align="center" width="120">
 			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
 			<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
 			<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>
@@ -185,12 +185,17 @@
 		<!-- ENDIF -->
 	</tr>
 	<!-- ENDLOOP $topicrow -->
-
+</table>
+<table class="tablebg" width="100%" cellspacing="1">
 	<tr align="center">
-		<!-- IF { $S_TOPIC_ICONS } --><td class="cat" colspan="7"><!-- ELSE --><td class="cat" colspan="6" ><!-- ENDIF -->
-		<form method="post" action="{ $S_FORUM_ACTION }">
-			<span class="gensmall">{ $L_DISPLAY_TOPICS }:</span>&nbsp;{ $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" />
-		</form>
+	<!-- IF { $S_TOPIC_ICONS } -->
+		<td class="cat" colspan="7">
+	<!-- ELSE -->
+		<td class="cat" colspan="6" >
+	<!-- ENDIF -->
+			<form method="post" action="{ $S_FORUM_ACTION }">
+				<span class="gensmall">{ $L_DISPLAY_TOPICS }:</span>&nbsp;{ $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" />
+			</form>
 		</td>
 	</tr>
 </table>

Modified: trunk/includes/templates/rss/atom.html
===================================================================
--- trunk/includes/templates/rss/atom.html	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/templates/rss/atom.html	2005-09-08 04:05:29 UTC (rev 99)
@@ -6,7 +6,7 @@
 <entry>
 	<title>{ $items:TITLE }</title>
 	<link href="{ $items:LINK }" />
-	<summary type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml">{ $items:DESCRIPTION_HTML }</summary>
+	<summary type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml">{ $items:DESCRIPTION_HTML }</div></summary>
 	<updated>{ $items:TIME }</updated>
 </entry>
 <!-- ENDLOOP -->

Modified: trunk/includes/user.php
===================================================================
--- trunk/includes/user.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/includes/user.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -49,7 +49,8 @@
 	function core_user()
 	{
 		$this->browser = mb_substr((empty($_SERVER['HTTP_USER_AGENT']) ? getenv('HTTP_USER_AGENT') : $_SERVER['HTTP_USER_AGENT']), 0, 255);
-		$this->url	= empty($_SERVER['REQUEST_URI']) ? getenv('REQUEST_URI') : $_SERVER['REQUEST_URI'];
+
+		$this->url	= $_SERVER['REQUEST_URI'];
 		$this->ip	= empty($_SERVER['REMOTE_ADDR']) ? getenv('REMOTE_ADDR') : $_SERVER['REMOTE_ADDR'];
 		$this->time	= (int) gmtime();
 
@@ -85,7 +86,7 @@
 
 		if (!$gmtime)
 		{
-			return false;;
+			return false;
 		}
 
 		$format = (!$format) ? $this->time_format : $format;
@@ -414,7 +415,7 @@
 			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['site_secure']);
 		}
 	}
-	
+
 ///////////////////
 // TO BE REMOVED //
 ///////////////////

Modified: trunk/install/build_data.php
===================================================================
--- trunk/install/build_data.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/install/build_data.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -120,8 +120,8 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Articles', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
@@ -158,14 +158,14 @@
 $guest_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 $bot_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (3, 2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (4, 2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (5, 2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (6, 2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (7, 2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_id, user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (8, 2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");

Modified: trunk/install/build_tables.php
===================================================================
--- trunk/install/build_tables.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/install/build_tables.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -763,13 +763,13 @@
 */
 $_CLASS['core_db']->table_create('start', $install_prefix.'forums_ranks');
 
-$_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('rank_title', 50);
 $_CLASS['core_db']->add_table_field_int('rank_min', array('min' => -1, 'max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('rank_special', array('max' => 1));
 $_CLASS['core_db']->add_table_field_char('rank_image', 100);
 
-$_CLASS['core_db']->add_table_index('rank_id');
+$_CLASS['core_db']->add_table_index('rank_id', 'primary');
 
 $_CLASS['core_db']->table_create('commit');
 

Modified: trunk/language/en/common.php
===================================================================
--- trunk/language/en/common.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/language/en/common.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,11 +1,33 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: common.php,v 1.12 2004/07/19 20:13:16 acydburn Exp $
 //
 // FILENAME  : common.php [ English ]
 // STARTED   : Sat Dec 16, 2000
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 

Modified: trunk/language/en/error.php
===================================================================
--- trunk/language/en/error.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/language/en/error.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,17 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 $homepage = 'http://www.viperal.com';
 
 $error = array(

Modified: trunk/modules/Contact/index.php
===================================================================
--- trunk/modules/Contact/index.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Contact/index.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -75,7 +75,7 @@
 $_CLASS['core_template']->assign_array(array( 
 	'ERROR' 				=> $error,
 	'MESSAGE' 				=> $message,
-	'ACTION' 				=> generate_link($_CORE_MODULE['name']),
+	'ACTION' 				=> generate_link($_CORE_MODULE['module_name']),
 	'SENDER_EMAIL' 			=> $sender_email,
 	'SENDER_NAME' 			=> $sender_name,
 ));

Modified: trunk/modules/Forums/faq.php
===================================================================
--- trunk/modules/Forums/faq.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Forums/faq.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -1,7 +1,7 @@
 <?php
 /*
 ||**************************************************************||
-||  Viperal CMS ? :												||
+||  Viperal CMS ?? :												||
 ||**************************************************************||
 ||																||
 ||	Copyright (C) 2004, 2005									||

Modified: trunk/modules/Forums/main.php
===================================================================
--- trunk/modules/Forums/main.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Forums/main.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -27,7 +27,7 @@
 //
 // FILENAME  : index.php 
 // STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -52,13 +52,14 @@
 		AND group_type <> ' . GROUP_HIDDEN;
 $result = $_CLASS['core_db']->query($sql);
 
-$legend = '';
+$legend = array();
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	$legend .= (($legend != '') ? ', ' : '') . '<a style="color:#' . $row['group_colour'] . '" href="'.generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>';
+	$legend[] .= '<a style="color:#' . $row['group_colour'] . '" href="'.generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>';
 }
 $_CLASS['core_db']->free_result($result);
 
+$legend = implode(', ', $legend);
 
 // Generate birthday list if required ...
 $birthday_list = '';
@@ -107,8 +108,7 @@
 	'S_DISPLAY_BIRTHDAY_LIST'	=> ($config['load_birthdays']), 
 
 	'U_MARK_FORUMS'	=> generate_link('Forums&amp;mark=forums')
-	)
-);
+));
 
 page_header();
 

Modified: trunk/modules/Forums/posting.php
===================================================================
--- trunk/modules/Forums/posting.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Forums/posting.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -27,7 +27,7 @@
 //
 // FILENAME  : posting.php
 // STARTED   : Sat Feb 17, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -658,10 +658,11 @@
 		else
 		{
 			$sql = 'SELECT post_time AS last_post_time
-				FROM ' . POSTS_TABLE . "
+				FROM ' . FORUMS_POSTS_TABLE . "
 				WHERE poster_ip = '" . $_CLASS['core_user']->ip . "'
 					AND post_time > " . ($current_time - $config['flood_interval']);
 			$result = $_CLASS['core_db']->query_limit($sql, 1);
+
 			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$last_post_time = $row['last_post_time'];
@@ -1474,17 +1475,20 @@
 	{
 		case 'post':
 			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_poster'		=> (int) $_CLASS['core_user']->data['user_id'],
-				'topic_time'		=> $current_time,
-				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'icon_id'			=> $data['icon_id'],
-				'topic_approved'	=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
-				'topic_title' 		=> $subject,
+				'topic_poster'			=> (int) $_CLASS['core_user']->data['user_id'],
+				'topic_time'			=> $current_time,
+				'forum_id' 				=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'icon_id'				=> $data['icon_id'],
+				'topic_approved'		=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
+				'topic_title' 			=> $subject,
 				'topic_first_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? stripslashes($username) : $_CLASS['core_user']->data['username'],
-				'topic_type'		=> $topic_type,
-				'topic_time_limit'	=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'topic_status'		=> $data['topic_status'],
-				'topic_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0
+				'topic_type'			=> $topic_type,
+				'topic_time_limit'		=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'topic_status'			=> $data['topic_status'],
+				'topic_attachment'		=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'topic_replies_real'	=> 0,
+				'topic_replies'			=> 0,
+				'topic_views'			=> 0,
 			);
 
 			if (isset($poll['poll_options']) && !empty($poll['poll_options']))
@@ -1508,8 +1512,7 @@
 				}
 				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
 			}
-			
-			break;
+		break;
 
 		case 'reply':
 			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
@@ -1519,7 +1522,7 @@
 			{
 				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
 			}
-			break;
+		break;
 
 		case 'edit_topic':
 		case 'edit_first_post':
@@ -1577,11 +1580,11 @@
 		if ($post_mode == 'post')
 		{
 			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_first_post_id' => $data['post_id'],
-				'topic_last_post_id' => $data['post_id'],
-				'topic_last_post_time' => $current_time,
-				'topic_last_poster_id' => (int) $_CLASS['core_user']->data['user_id'],
-				'topic_last_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? stripslashes($username) : $_CLASS['core_user']->data['username']
+				'topic_first_post_id'	=> $data['post_id'],
+				'topic_last_post_id'	=> $data['post_id'],
+				'topic_last_post_time'	=> $current_time,
+				'topic_last_poster_id'	=> (int) $_CLASS['core_user']->data['user_id'],
+				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : $_CLASS['core_user']->data['username']
 			);
 		}
 

Modified: trunk/modules/Forums/viewforum.php
===================================================================
--- trunk/modules/Forums/viewforum.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Forums/viewforum.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -27,7 +27,7 @@
 //
 // FILENAME  : viewforum.php 
 // STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -456,7 +456,7 @@
 				'PAGINATION'		=> $pagination['formated'],
 				'PAGINATION_ARRAY'	=> $pagination['array'],
 				'REPLIES' 			=> $replies,
-				'VIEWS' 			=> $row['topic_views'],
+				'VIEWS' 			=> (int) $row['topic_views'],
 				'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
 				'TOPIC_TYPE' 		=> $topic_type,
 

Modified: trunk/modules/Forums/viewtopic.php
===================================================================
--- trunk/modules/Forums/viewtopic.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Forums/viewtopic.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -242,7 +242,7 @@
 }
 
 // We make this check here because the correct forum_id is determined
-$topic_replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $topic_data['topic_replies_real'] : $topic_data['topic_replies'];
+$topic_replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $topic_data['topic_replies_real'] : (int) $topic_data['topic_replies'];
 
 if (!isset($topic_last_read))
 {
@@ -762,6 +762,12 @@
 			}
 			else
 			{
+				$user_cache[$poster_id]['rank_title'] = '';
+				$user_cache[$poster_id]['rank_image'] = '';
+				
+				/*
+				We do this on posting no need to un-needed stuff
+
 				if (isset($ranks['normal']) && !empty($ranks['normal']))
 				{
 					foreach ($ranks['normal'] as $rank)
@@ -770,15 +776,12 @@
 						{
 							$user_cache[$poster_id]['rank_title'] = $rank['rank_title'];
 							$user_cache[$poster_id]['rank_image'] = (!empty($rank['rank_image'])) ? '<img src="' . $config['ranks_path'] . '/' . $rank['rank_image'] . '" border="0" alt="' . $rank['rank_title'] . '" title="' . $rank['rank_title'] . '" /><br />' : '';
+
 							break;
 						}
 					}
 				}
-				else
-				{
-					$user_cache[$poster_id]['rank_title'] = '';
-					$user_cache[$poster_id]['rank_image'] = '';
-				}
+				*/
 			}
 
 			if (!empty($row['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
@@ -815,11 +818,11 @@
 
 	$result = $_CLASS['core_db']->query($sql);
 
-	$update_time = $config['load_online_time'] * 60;
+	$min_online_time = $_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length'] * 60;
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$user_cache[$row['session_user_id']]['online'] = (time() - $update_time < $row['online_time'] && (!$row['session_hidden']));
+		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] && $row['online_time'] > $min_online_time);
 	}
 }
 unset($id_cache);

Modified: trunk/modules/Quick_Message/index.php
===================================================================
--- trunk/modules/Quick_Message/index.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Quick_Message/index.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -26,9 +26,11 @@
     die;
 }
 
+global $prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
 }
 
 $_CLASS['core_user']->user_setup();
@@ -46,7 +48,7 @@
 
 		if (!$message)
 		{
-			trigger_error('NO_MESSAGE'); 
+			trigger_error('NO_MESSAGE');
 		}
 
 		$length = mb_strlen($message);
@@ -132,7 +134,7 @@
 			die;
 		}
 
-		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time', 1);
+		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
@@ -143,7 +145,7 @@
 
 		$return = true;
 
-		if ($row['message_id'] != $id)
+		if ($row['message_id'] == $id)
 		{
 			if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
 			{
@@ -163,7 +165,7 @@
 		$_CLASS['core_db']->query($sql);
 
 		//trigger_error('MESSAGE_DELETED');
-		redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
+		redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
 	break;
 }
 

Modified: trunk/modules/Quick_Message/install.php
===================================================================
--- trunk/modules/Quick_Message/install.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/Quick_Message/install.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -17,15 +17,29 @@
 ||  of the GNU General Public License version 2					||
 ||																||
 ||**************************************************************||
+
+$Id$
 */
 
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $prefix;
+
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
+}
+
 class Quick_Message_install
 {
 	function install()
 	{
-		global $_CLASS, $prefix;
+		global $_CLASS;
 
-		$_CLASS['core_db']->table_create('start', $prefix.'quick_message');
+		$_CLASS['core_db']->table_create('start', QUICK_MESSAGE_TABLE);
 		
 		$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
 		$_CLASS['core_db']->add_table_field_text('message_text', 200);
@@ -48,14 +62,29 @@
 
 		$_CLASS['core_cache']->destroy('core_config');
 
-		$_CLASS['core_db']->query('INSERT INTO '.$prefix."quick_message (poster_id, poster_name, poster_ip, message_text, message_time) VALUES (0, 'Site', '', 'Lets do this !', ".gmtime().")");
+		$array = array(
+			'message_text'	=> 'Lets do this !',
+			'message_time'	=> (int) $_CLASS['core_user']->time,
+			'poster_id'		=> 0,
+			'poster_name'	=> (string) '',
+			'poster_ip'		=> (string) ''
+		);
 
+		$_CLASS['core_db']->query('INSERT INTO ' . QUICK_MESSAGE_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
+
 		return true;
 	}
 
 	function uninstall()
 	{
+		global $_CLASS;
 
+		$_CLASS['core_db']->report_error(false);
+
+		$_CLASS['core_db']->query('DROP TABLE ' . QUICK_MESSAGE_TABLE);
+		$_CLASS['core_db']->query('DELETE FROM ' . CORE_CONFIG_TABLE . " WHERE config_section = 'quick_message'");
+
+		$_CLASS['core_db']->report_error(true);
 	}
 }
 

Added: trunk/modules/articles/index.php
===================================================================
--- trunk/modules/articles/index.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/articles/index.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -0,0 +1,148 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
+
+$_CLASS['core_user']->user_setup();
+
+if (isset($_GET['mode']))
+{
+	Switch ($_GET['mode'])
+	{
+		Case 'print':
+			$print = true;
+		Case 'view':
+			$print = isset($print);
+
+			$id = get_variable('id', 'GET', false, 'int');
+		
+			if (!$id)
+			{
+				trigger_error('ARTICLE_NOT_FOUND');
+			}
+		
+			$result = $_CLASS['core_db']->query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if (!$row || $row['articles_status'] != STATUS_ACTIVE)
+			{
+				trigger_error('ARTICLE_NOT_FOUND');
+			}
+
+			$_CLASS['core_template']->assign(array(
+				'ARTICLES_POSTER' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
+				'ARTICLES_POSTER_LINK'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+				'ARTICLES_TEXT'			=> $row['articles_text'],
+				'ARTICLES_CONTENT_LINK' => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+				'ARTICLES_TIME'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
+				'ARTICLES_TITLE'		=> $row['articles_title'],
+				'ARTICLES_ID'       	=> $id,
+				'ARTICLES_LINK_PRINT'	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+				'ARTICLES_LINK_SEND'	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+			));
+
+			$_CLASS['core_display']->display(false, ($print) ? 'modules/articles/print.html' : 'modules/articles/view.html');	
+
+			script_close();
+		break;
+	}
+}
+
+$start = get_variable('start', 'GET', false, 'int');
+$limit = 10;
+$collapable_holding = array();
+
+$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order DESC';
+$result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+// this can cause problems, only thing to do is remove the limit query and do a loop until we get the needed articles
+	if ($row['articles_auth'] && !$_CLASS['core_auth']->auth(@unserialize($row['articles_auth'])) && !$_CLASS['core_auth']->admin_power('articles'))
+	{
+		continue;
+	}
+
+	$_CLASS['core_template']->assign_vars_array('articles', array(
+		'poster' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
+		'content'		=> ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'],
+		'time'			=> $_CLASS['core_user']->format_date($row['articles_posted']),
+		'title'			=> $row['articles_title'],
+		'id'      		=> $row['articles_id'],
+
+		'collapse'  	=> check_collapsed_status('a_'.$row['articles_id']),
+		'full_story'	=> ($row['articles_intro'] && $row['articles_text']),
+
+		'link_poster'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
+		'link_content'  => generate_link('articles&amp;mode=view&amp;id='.$row['articles_id']),
+		'link_print' 	=> generate_link('articles&amp;mode=print&amp;id='.$row['articles_id']),
+		'link_send' 	=> generate_link('articles&amp;mode=send&amp;id='.$row['articles_id']),
+	));
+
+	$collapable_holding[] = 'a_'.$row['articles_id'];
+}
+$_CLASS['core_db']->free_result($result);
+
+// Garbage collection, would cause problems with guest/loggin articl views
+if ($cookie_data = get_variable('collapsed_items', 'COOKIE'))
+{
+	$collapsed_items = ($cookie_data) ? explode(':', $cookie_data) : array();
+	$count = count($collapsed_items);
+
+	for($i = 0; $i < $count; $i++)
+	{
+		if (mb_strpos($collapsed_items[$i], 'a_') === 0 && !in_array($collapsed_items[$i], $collapable_holding))
+		{
+			unset($collapsed_items[$i]);
+		}
+	}
+
+	$collapsed_items = implode(':', $collapsed_items);
+
+	setcookie('collapsed_items', $collapsed_items, (int) $_CLASS['core_user']->time + 31536000000, '/');
+}
+
+$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total FROM ' . ARTICLES_TABLE . ' WHERE articles_status = '.STATUS_ACTIVE);
+$row = $_CLASS['core_db']->fetch_row_assoc($result);
+$_CLASS['core_db']->free_result($result);
+
+$pagination = generate_pagination('articles', $row['total'], $limit, $start);
+
+$_CLASS['core_template']->assign_array(array(
+	'articles_pagination' 		=> $pagination['formated'],
+	'articles_pagination_array' => $pagination['array']
+
+));
+
+$_CLASS['core_template']->display('modules/articles/index.html');
+
+?>
\ No newline at end of file

Added: trunk/modules/articles/install.php
===================================================================
--- trunk/modules/articles/install.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/modules/articles/install.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -0,0 +1,102 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $prefix;
+
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
+
+class articles_install
+{
+	var $error = array();
+	
+	function install()
+	{
+		global $_CLASS;
+
+		$_CLASS['core_db']->table_create('start', ARTICLES_TABLE);
+		
+		$_CLASS['core_db']->add_table_field_int('articles_id', array('max' => 16000000, 'auto_increment' => true));
+		$_CLASS['core_db']->add_table_field_char('articles_title', 80);
+		$_CLASS['core_db']->add_table_field_int('articles_posted', array('max' => 200000000));
+		$_CLASS['core_db']->add_table_field_int('articles_start', array('max' => 200000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_expires', array('max' => 200000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_text('articles_intro', 60000, true);
+		$_CLASS['core_db']->add_table_field_text('articles_text', 10000000);
+		$_CLASS['core_db']->add_table_field_text('articles_notes', 60000, true);
+
+		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_type', array('max' => 10));
+		$_CLASS['core_db']->add_table_field_int('articles_status', array('max' => 10));
+		$_CLASS['core_db']->add_table_field_text('articles_auth', 60000, true);
+
+		$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
+		$_CLASS['core_db']->add_table_field_char('poster_name', 80, true);
+		$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
+		$_CLASS['core_db']->add_table_field_char('approver_id', 18, true);
+		$_CLASS['core_db']->add_table_field_char('approver_name', 80, true);
+
+		$_CLASS['core_db']->add_table_index('articles_id', 'primary');
+		$_CLASS['core_db']->add_table_index('articles_start');
+		//$_CLASS['core_db']->add_table_index('articles_type');
+		//$_CLASS['core_db']->add_table_index('articles_expires');
+		$_CLASS['core_db']->add_table_index('articles_order');
+		$_CLASS['core_db']->add_table_index('articles_status');
+
+		$_CLASS['core_db']->table_create('commit');
+
+		$array = array(
+			'articles_title'	=> 'Welcome Post',
+			'articles_posted'	=> (int) $_CLASS['core_user']->time,
+			'articles_text'		=> '<p align="center">I need something snappy here</p>',
+			'articles_type'		=> 1,
+			'articles_status'	=> STATUS_ACTIVE,
+			'poster_id'			=> 0,
+			'poster_ip'			=> (string) ''
+		);
+
+		$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
+
+		return true;
+	}
+
+	function uninstall()
+	{
+		global $_CLASS;
+
+		$_CLASS['core_db']->report_error(false);
+
+		$_CLASS['core_db']->query('DROP TABLE ' . ARTICLES_TABLE);
+
+		$_CLASS['core_db']->report_error(true);
+	}
+}
+
+?>
\ No newline at end of file

Added: trunk/themes/viperal/images/modules/Forums/index.html
===================================================================

Added: trunk/themes/viperal/images/modules/Forums/index.php
===================================================================
--- trunk/themes/viperal/images/modules/Forums/index.php	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/themes/viperal/images/modules/Forums/index.php	2005-09-08 04:05:29 UTC (rev 99)
@@ -0,0 +1,87 @@
+<?php
+$this->img = array(
+	'bbcode_bitfield' => '6913',
+    'btn_post' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post.gif*27*97',
+    'btn_post_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post_pm.gif*27*97',
+    'btn_reply' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply.gif*27*97',
+    'btn_reply_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply_pm.gif*20*90',
+    'btn_locked' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_locked.gif*27*97',
+    'btn_profile' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_profile.gif*20*72',
+    'btn_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_pm.gif*20*72',
+    'btn_delete' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_delete.gif*20*20',
+    'btn_info' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_info.gif*20*20',
+    'btn_quote' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_quote.gif*20*90',
+    'btn_search' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_search.gif*20*72',
+    'btn_edit' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_edit.gif*20*90',
+    'btn_report' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_report.gif*20*20',
+    'btn_email' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_email.gif*20*72',
+    'btn_www' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_www.gif*20*72',
+    'btn_icq' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_icq.gif*20*72',
+    'btn_aim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_aim.gif*20*72',
+    'btn_yim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_yim.gif*20*72',
+    'btn_msnm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_msnm.gif*20*72',
+    'btn_jabber' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_jabber.gif*20*72',
+    'btn_online' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_online.gif*20*72',
+    'btn_offline' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+    'icon_unapproved' => 'themes/viperal/template/modules/Forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' => 'themes/viperal/template/modules/Forums/images/icon_reported.gif*18*19',
+    'icon_attach' => 'themes/viperal/template/modules/Forums/images/icon_attach.gif*18*14',
+    'icon_post' => 'themes/viperal/template/modules/Forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' => 'themes/viperal/template/modules/Forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' => 'themes/viperal/template/modules/Forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' => 'themes/viperal/template/modules/Forums/images/icon_newest_reply.gif*9*18',
+    'forum' => 'themes/viperal/template/modules/Forums/images/folder_big.gif*25*46',
+    'forum_new' => 'themes/viperal/template/modules/Forums/images/folder_new_big.gif*25*46',
+    'forum_locked' => 'themes/viperal/template/modules/Forums/images/folder_locked_big.gif*25*46',
+    'forum_link' => 'themes/viperal/template/modules/Forums/images/folder_link_big.gif*25*46',
+    'sub_forum' => 'themes/viperal/template/modules/Forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' => 'themes/viperal/template/modules/Forums/images/subfolder_new_big.gif*25*46',
+    'folder' => 'themes/viperal/template/modules/Forums/images/folder.gif*18*19',
+    'folder_moved' => 'themes/viperal/template/modules/Forums/images/folder_moved.gif*18*19',
+    'folder_posted' => 'themes/viperal/template/modules/Forums/images/folder_posted.gif*18*19',
+    'folder_new' => 'themes/viperal/template/modules/Forums/images/folder_new.gif*18*19',
+    'folder_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' => 'themes/viperal/template/modules/Forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' => 'themes/viperal/template/modules/Forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' => 'themes/viperal/template/modules/Forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' => 'themes/viperal/template/modules/Forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' => 'themes/viperal/template/modules/Forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' => 'themes/viperal/template/modules/Forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' => 'themes/viperal/template/modules/Forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' => 'themes/viperal/template/modules/Forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' => '',
+    'folder_global_posted' => '',
+    'folder_global_new' => '',
+    'folder_global_new_posted' => '',
+    'poll_left'		=> 'themes/viperal/template/modules/Forums/images/vote_lcap.gif*12*4',
+    'poll_center'	=> 'themes/viperal/template/modules/Forums/images/voting_bar.gif*12*4',
+    'poll_right'	=> 'themes/viperal/template/modules/Forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' => 'themes/viperal/template/modules/Forums/images/progress_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'themes/viperal/template/modules/Forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'image_register' => 'themes/viperal/template/modules/Forums/images/icon_mini_register.gif',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+);
+
+?>
\ No newline at end of file

Added: trunk/themes/viperal/images/modules/index.html
===================================================================

Modified: trunk/themes/viperal/style/style.css
===================================================================
--- trunk/themes/viperal/style/style.css	2005-09-03 16:26:45 UTC (rev 98)
+++ trunk/themes/viperal/style/style.css	2005-09-08 04:05:29 UTC (rev 99)
@@ -195,7 +195,7 @@
 /* 
 	NEWS BLOCKS
 */
-.newsblock
+.articles_block
 {
     background-color: #eee;
     background: url(images/bg.gif);
@@ -204,7 +204,7 @@
     font-size: 110%;
 }
 	
-.newsblock .title
+.articles_block .title
 {
 	position: relative;
 	background: #C7D0D7;
@@ -213,14 +213,14 @@
 	padding: 2px;
 }
 
-.newsblock .content
+.articles_block .content
 {
 	padding: 10px;
 	min-height: 13px;
 	color: black;
 }
 
-.newsblock .numbering
+.articles_block .numbering
 {
 	text-align: center;
 }



From viperal at berlios.de  Thu Sep  8 06:10:46 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 8 Sep 2005 06:10:46 +0200
Subject: [Viperals-svncheckins] r100 - /
Message-ID: <200509080410.j884AkMI008764@sheep.berlios.de>

Author: viperal
Date: 2005-09-08 06:10:42 +0200 (Thu, 08 Sep 2005)
New Revision: 100

Added:
   cms/
   modules/
Log:
Made modules and cms folders for seperation



From viperal at berlios.de  Thu Sep  8 06:20:31 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 8 Sep 2005 06:20:31 +0200
Subject: [Viperals-svncheckins] r101 - / cms cms/trunk
Message-ID: <200509080420.j884KVZG010423@sheep.berlios.de>

Author: viperal
Date: 2005-09-08 06:20:17 +0200 (Thu, 08 Sep 2005)
New Revision: 101

Added:
   cms/trunk/
   cms/trunk/admin.php
   cms/trunk/admin/
   cms/trunk/blocks/
   cms/trunk/config.php
   cms/trunk/core.php
   cms/trunk/debug.php
   cms/trunk/feed.php
   cms/trunk/images/
   cms/trunk/includes/
   cms/trunk/index.php
   cms/trunk/install/
   cms/trunk/javascript/
   cms/trunk/language/
   cms/trunk/modules/
   cms/trunk/themes/
   cms/trunk/themes_admin/
Removed:
   cms/trunk/admin.php
   cms/trunk/admin/
   cms/trunk/blocks/
   cms/trunk/config.php
   cms/trunk/core.php
   cms/trunk/debug.php
   cms/trunk/feed.php
   cms/trunk/images/
   cms/trunk/includes/
   cms/trunk/index.php
   cms/trunk/install/
   cms/trunk/javascript/
   cms/trunk/language/
   cms/trunk/modules/
   cms/trunk/themes/
   cms/trunk/themes_admin/
   trunk/
Log:
Move file to cms/trunk

Copied: cms/trunk (from rev 95, trunk)

Copied: cms/trunk/admin (from rev 100, trunk/admin)

Deleted: cms/trunk/admin.php
===================================================================
--- trunk/admin.php	2005-08-31 14:26:25 UTC (rev 95)
+++ cms/trunk/admin.php	2005-09-08 04:20:17 UTC (rev 101)
@@ -1,112 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-define('VIPERAL', 'Admin');
-//define('NEED_SID', true);
-
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
-
-require($site_file_root.'core.php');
-
-$_CLASS['core_user']->user_setup(null);
-$_CLASS['core_display']->load_theme('viperal_admin', $site_file_root.'themes_admin/viperal_admin');
-
-$_CLASS['core_user']->add_lang('admin/common.php');
-
-$_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'];
-$_CORE_MODULE['sides'] = BLOCK_ALL;
-$_CLASS['core_blocks']->blocks_loaded = true;
-
-if (!$_CLASS['core_user']->is_user)
-{
-	if ($_CLASS['core_user']->is_bot)
-	{
-		url_redirect();
-	}
-
-	login_box(array('admin_login' => true, 'full_screen' => true,  'full_login' => false, 'explain' => 'LOGIN_ADMIN', 'success' => 'LOGIN_ADMIN_SUCCESS'), 'login_admin.html');
-}
-
-if ($_CLASS['core_user']->data['session_admin'] == ADMIN_NOT_LOGGED)
-{
-	login_box(array('admin_login' => true, 'full_screen' => true, 'full_login' => false, 'explain' => 'LOGIN_ADMIN_CONFIRM', 'success' => 'LOGIN_ADMIN_SUCCESS'), 'login_admin.html');
-}
-
-if (!$_CLASS['core_user']->is_admin)
-{
-	trigger_error('NOT_ADMIN');
-}
-
-$mod = get_variable('mod', 'REQUEST', false);
-$file_path = false;
-
-if ($mod)
-{
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE name='".$_CLASS['core_db']->escape($mod)."'");
-	$_CORE_MODULE = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
-}
-
-if (!$mod || !$_CORE_MODULE)
-{
-	$_CORE_MODULE = array('title' => '', 'name' => '');
-	$file_path = $site_file_root.'admin/index.php';
-}
-else
-{
-	if (file_exists($site_file_root.'admin/'.$_CORE_MODULE['name'].'.php'))
-	{
-		$file_path = $site_file_root.'admin/'.$_CORE_MODULE['name'].'.php';
-	}
-	else
-	{
-		$file_path = (file_exists($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/index.php')) ? $site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/index.php' : false;
-	}
-}
-
-if (!$file_path)
-{
-	trigger_error('NO_ADMIN_MODULE', E_USER_ERROR);
-}
-
-if ($_CORE_MODULE['name'])
-{
-	if (!$_CLASS['core_auth']->admin_power($_CORE_MODULE['name']))
-	{
-		trigger_error('NOT_AUTH', E_USER_ERROR);
-	}
-}
-
-$_CORE_MODULE['title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['title'];
-$_CORE_MODULE['sides'] = BLOCK_ALL;
-	
-require($site_file_root.'admin/menu.php');
-
-$main_menu = build_menu($menu);
-
-$_CLASS['core_template']->assign_array(array(
-		'LINK_HOME'		=> generate_link(),
-		'LINK_ADMIN'	=> generate_link(false, array('admin' => true)),
-
-		'MENU_MAIN'			=> $main_menu['content'],
-		'MENU_MAIN_ITEMS'	=> $main_menu['menu'],
-));
-
-
-//load_class($site_file_root.'includes/core_editor.php', 'core_editor');
-//$_CLASS['core_editor']->setup();
-require($file_path);
-    
-?>
\ No newline at end of file

Copied: cms/trunk/admin.php (from rev 100, trunk/admin.php)

Copied: cms/trunk/blocks (from rev 100, trunk/blocks)

Deleted: cms/trunk/config.php
===================================================================

Copied: cms/trunk/config.php (from rev 100, trunk/config.php)

Deleted: cms/trunk/core.php
===================================================================
--- trunk/core.php	2005-08-31 14:26:25 UTC (rev 95)
+++ cms/trunk/core.php	2005-09-08 04:20:17 UTC (rev 101)
@@ -1,149 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-set_magic_quotes_runtime(0);
-error_reporting(E_ALL);
-mb_internal_encoding('UTF-8');
-//mb_http_output('UTF-8');
-
-// Remove registered globals
-if ((bool) ini_get('register_globals'))
-{
-	foreach ($_REQUEST as $var_name => $value)
-	{
-		unset($$var_name);
-	}
-}
-
-define('STRIP_SLASHES', get_magic_quotes_gpc());
-
-$starttime = explode(' ', microtime());
-$starttime = $starttime[1] + $starttime[0];
-
-// Move to index files
-$base_memory_usage = function_exists('memory_get_usage') ? memory_get_usage() : 0;
-
-require($site_file_root.'includes/functions.php');
-require($site_file_root.'config.php');
-require($site_file_root.'includes/tables.php');
-require($site_file_root.'includes/handler.php');
-require($site_file_root.'includes/mailer.php');
-require($site_file_root.'includes/db/'.$site_db['type'].'.php');
-require($site_file_root.'includes/display/template.php');
-require($site_file_root.'includes/cache/cache.php');
-require($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
-
-// Load basic classes
-load_class(false, 'core_error_handler');
-load_class(false, 'core_cache', 'cache_'.$acm_type);
-load_class(false, 'core_template');
-load_class(false, 'core_db', 'db_'.$site_db['type']);
-
-// Set error handler
-$_CLASS['core_error_handler']->start();
-//$_CLASS['core_error_handler']->stop();
-//error_reporting(E_ERROR | E_WARNING | E_PARSE);
-
-if (function_exists('register_shutdown_function'))
-{
-	register_shutdown_function('script_close');
-}
-
-$_CLASS['core_db']->connect($site_db);
-unset($sitedb);
-
-$_CLASS['core_db']->return_on_error = true;
-
-// Error messages just incase we can't get our configs
-$config_error = '<center>There is currently a problem with the site<br/>';
-$config_error .= 'Please try again later<br /><br />Error Code: DB3</center>';
-
-if (is_null($_CORE_CONFIG = $_CLASS['core_cache']->get('core_config')))
-{
-	$_CORE_CONFIG = array();
-
-	$sql = 'SELECT * FROM '.CORE_CONFIG_TABLE;
-		
-	if (!$result = $_CLASS['core_db']->query($sql))
-	{
-		trigger_error($config_error, E_USER_ERROR);
-	}
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$_CORE_CONFIG[$row['section']][$row['name']] = $row['value'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$_CLASS['core_cache']->put('core_config', $_CORE_CONFIG);
-}
-
-unset($config_error);
-
-$_CLASS['core_db']->return_on_error = false;
-$_CLASS['core_cache']->remove('core_config');
-$_CLASS['core_cache']->remove('config');
-
-if (VIPERAL == 'FEED')
-{
-	if (check_maintance_status(true) === true || check_load_status(true) === true)
-	{
-		header("HTTP/1.0 503 Service Unavailable");
-		die;
-	}
-	return;
-}
-
-// Load user based classes, and display options
-require($site_file_root.'includes/session.php');
-require($site_file_root.'includes/user.php');
-require($site_file_root.'includes/auth/auth.php');
-require($site_file_root.'includes/auth/auth_db.php');
-require($site_file_root.'includes/display/blocks.php');
-require($site_file_root.'includes/display/display.php');
-
-load_class(false, 'core_display');
-load_class(false, 'core_blocks');
-load_class(false, 'core_user');
-
-$_CLASS['core_user']->start();
-
-if (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['global']['only_registered'])
-{
-	// conformation image 
-	login_box(array('full_screen'	=> true));
-}
-		
-if ($_CLASS['core_user']->is_admin)
-{
-	$_CLASS['core_error_handler']->report = $_CORE_CONFIG['server']['error_options'];	
-}
-else
-{
-	$_CORE_CONFIG['global']['error'] = ERROR_NONE;
-	$_CLASS['core_error_handler']->report = ERROR_NONE;
-}
-
-if ($_SERVER['REQUEST_METHOD'] == 'POST' && $_CLASS['core_user']->new_session)
-{
-	// error here
-}
-
-?>
\ No newline at end of file

Copied: cms/trunk/core.php (from rev 100, trunk/core.php)

Deleted: cms/trunk/debug.php
===================================================================
--- trunk/debug.php	2005-08-31 14:26:25 UTC (rev 95)
+++ cms/trunk/debug.php	2005-09-08 04:20:17 UTC (rev 101)
@@ -1,142 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-define('VIPERAL', 'Admin');
-
-//echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
-$site_file_root = '';
-
-require($site_file_root.'core.php');
-
-if (!$_CLASS['core_user']->is_admin)
-{
-	//die('this is admin only :-) need better language :-(');
-}
-
-$_CLASS['core_error_handler']->stop();
-$_CLASS['core_user']->user_setup();
-error_reporting(E_ALL);
-
-$mode = get_variable('mode', 'GET', false);
-
-$_CLASS['core_template']->assign(array(
-	'MODE'				=>	$mode,
-	'L_NOTICES'			=>	'NOTICE ERRORS',
-	'L_WARNINGS'		=>	'WARNING ERRORS',
-	'L_QUERIES'			=>	'DB QUERY DETAILS',
-	'bottomblock'		=>	false,
-	'MAIN_CONTENT'		=>	false,
-));
-
-switch ($mode)
-{
-	case 'warning':
-		global $_CLASS;
-		
-		$debug_data = $_CLASS['core_user']->session_data_get('debug');
-		
-		if (empty($debug_data['E_WARNING']))
-		{
-			 break;
-		}
-
-		$size = count($debug_data['E_WARNING']);
-	
-		for ($i=0; $i<$size; $i++)
-		{
-			$_CLASS['core_template']->assign_vars_array('error_warnings', array(
-				'errfile'	=> $debug_data['E_WARNING'][$i]['file'],
-				'errline'	=> $debug_data['E_WARNING'][$i]['line'], 
-				'msg_text' => $debug_data['E_WARNING'][$i]['error']
-			));
-		}
-		
-	break;
-
-	case 'queries':
-		$query_details = $_CLASS['core_user']->session_data_get('query_details', array());
-		$query_list = $_CLASS['core_user']->session_data_get('query_list', array());
-
-		foreach ($query_list as $key => $value)
-		{
-			$tempid = $first = false;
-			$header = array();
-		
-			foreach ($query_details[$key] as $value2)
-			{
-				$queries = array();
-		
-				if (!is_array($value2))
-				{
-					continue;
-				}
-				
-				if ($tempid !== $key)
-				{
-					foreach (array_keys($value2) as $key2)
-					{
-						$header[] = array('value' => (($key2) ? ucwords(str_replace('_', ' ', $key2)) : '&nbsp;'));
-					}
-					$tempid = $key;
-				}
-				
-				foreach ($value2 as $key3 => $value3)
-				{
-					if (!$first || $first != $key3)
-					{
-						if (!$first)
-						{
-							$first = $key3;
-						}
-						
-						$queries[] = array('row' => $key, 'value' => $value3, 'new' => false);
-					}
-					else
-					{
-						$queries[] = array('row' => $key, 'value' => $value3, 'new' => true);
-					}
-				}
-			}
-		
-			$value['query'] = preg_replace('/\t(AND|OR)(\W)/', "\$1\$2", htmlspecialchars(preg_replace('/[\s]*[\n\r\t]+[\n\r\s\t]*/', "\n", $value['query'])));
-
-			$_CLASS['core_template']->assign_vars_array('query', array('row' => $key, 'query' => $value['query'], 'header' => $header, 'queries' => $queries, 'file' => $value['file'], 'line' => $value['line'], 'affected' => $value['affected'], 'time' => round($value['time'], 4)));
-		}
-	break;
-	
-	default:
-	case 'notice':
-		$debug_data = $_CLASS['core_user']->session_data_get('debug');
-		
-		if (empty($debug_data['E_NOTICE']))
-		{
-			break;
-		}
-		$size = count($debug_data['E_NOTICE']);
-		
-		for ($i = 0; $i < $size; $i++)
-		{
-			$_CLASS['core_template']->assign_vars_array('error_notice', array(
-				'errfile'	=> $debug_data['E_NOTICE'][$i]['file'],
-				'errline'	=> $debug_data['E_NOTICE'][$i]['line'], 
-				'msg_text' => $debug_data['E_NOTICE'][$i]['error']
-			));
-		}
-	break;
-}
-
-$_CLASS['core_template']->display('debug.html');
-script_close(false);
-?>
\ No newline at end of file

Copied: cms/trunk/debug.php (from rev 100, trunk/debug.php)

Deleted: cms/trunk/feed.php
===================================================================
--- trunk/feed.php	2005-08-31 14:26:25 UTC (rev 95)
+++ cms/trunk/feed.php	2005-09-08 04:20:17 UTC (rev 101)
@@ -1,82 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-define('VIPERAL', 'FEED');
-
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = 'C:/apachefriends/xampp/cms/';
-
-require($site_file_root.'core.php');
-
-error_reporting(0);
-header('Content-Type: text/xml');
-
-$result = $_CLASS['core_db']->sql_query('SELECT id, title, time, intro, poster_name FROM '.$prefix.'_news ORDER BY id DESC LIMIT 10');
-
-$last_post_time = 0;
-	
-while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-{
-	if ($row['time'] > $last_post_time)
-	{
-		$last_post_time = $row['time'];
-	}
-	
-	$_CLASS['core_template']->assign_vars_array('items', array(
-		'TITLE' 		=> htmlspecialchars($row['title'], ENT_QUOTES),
-		'LINK' 			=> generate_link('News&amp;mode=view&amp;id='.$row['id'], array('full' => true)),
-		'DESCRIPTION' 	=> htmlspecialchars(strip_tags($row['intro']), ENT_QUOTES),
-		'TIME'			=> gmdate('M d Y H:i:s', $row['time']) .' GMT',
-		'AUTHOR'		=> $row['poster_name']
-	));
-}
-
-$_CLASS['core_db']->sql_freeresult($result);
-
-$_CLASS['core_template']->assign(array(
-		'SITE_NAME' 	=> $_CORE_CONFIG['global']['site_name'],
-		'SITE_URL' 		=> $_CORE_CONFIG['global']['site_url'],
-		'SLOGAN' 		=> $_CORE_CONFIG['global']['slogan'],
-		'LANG'			=> 'en-us',
-		'LAST_MODIFIED'	=> gmdate('M d Y H:i:s', $last_post_time) .' GMT',
-		'TIME'			=> gmdate('M d Y H:i:s', time()) .' GMT'
-	));
-
-
-$feed = get_variable('feed', 'GET', false);
-
-Switch ($feed)
-{
-	case 'rdf':
-	case 'rss1':
-
-	$_CLASS['core_template']->display('rss/rdf.html');
-	break;
-	
-	case 'rss2':
-	$_CLASS['core_template']->display('rss/rss2.html');
-	break;
-	
-	case 'rss':
-	$_CLASS['core_template']->display('rss/rss91.html');
-	break;
-		
-	default:
-	$_CLASS['core_template']->display('rss/rss91.html');
-}
-
-script_close();
-die;
-
-?>
\ No newline at end of file

Copied: cms/trunk/feed.php (from rev 100, trunk/feed.php)

Copied: cms/trunk/images (from rev 100, trunk/images)

Copied: cms/trunk/includes (from rev 100, trunk/includes)

Deleted: cms/trunk/index.php
===================================================================
--- trunk/index.php	2005-08-31 14:26:25 UTC (rev 95)
+++ cms/trunk/index.php	2005-09-08 04:20:17 UTC (rev 101)
@@ -1,91 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-define('VIPERAL', 'CMS');
-
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
-require($site_file_root.'core.php');
-
-$mod = get_variable('mod', 'REQUEST', false);
-
-if (!$mod)
-{
-	// Set as homepage 
-	$_CLASS['core_display']->homepage = true;
-
-	// Get homepage modules
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' WHERE homepage > 0 ORDER BY homepage ASC');
-
-	While ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$_CLASS['core_display']->add_module($row);
-	}
-
-	$_CLASS['core_db']->free_result($result);
-
-	if (!($_CORE_MODULE = $_CLASS['core_display']->get_module()))
-	{
-		$_CORE_MODULE['sides'] = BLOCK_ALL;
-		$_CORE_MODULE += array('name' => '', 'title' => ''); // temp
-
-		$_CLASS['core_display']->display_head();
-		// Hey admin we don't have a modules set
-		if ($_CLASS['core_auth']->admin_auth('modules'))
-		{
-			$_CLASS['core_display']->message = '_NO_HOMEPAGE_ADMIN';
-		}
-	
-		$_CLASS['core_display']->display_footer();
-	}
-}
-else
-{
-	if ($mod == 'system')
-	{
-		include_once($site_file_root.'includes/system.php');
-
-		$mode = get_variable('mode', 'REQUEST', false);
-		if (!$mode || !function_exists($mode))
-		{
-			script_close(false);
-		}
-
-		$mode();
-		script_close(false);
-	}
-
-	//Grab module data if it exsits
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE.' WHERE type='.MODULE_NORMAL." AND name='".$_CLASS['core_db']->escape($mod)."'");
-	$row = $_CLASS['core_db']->fetch_row_assoc($result);
-	$_CLASS['core_db']->free_result($result);
-
-	$status = $_CLASS['core_display']->add_module($row);
-	
-	if ($status !== true)
-	{
-		trigger_error($status, E_USER_ERROR);
-	}
-
-	$_CORE_MODULE = $_CLASS['core_display']->get_module();
-}
-
-$path = $site_file_root.'modules/'.$_CORE_MODULE['name'].'/index.php';
-$_CLASS['core_user']->page = $_CORE_MODULE['name'];
-
-require_once($path);
-
-script_close();
-
-?>
\ No newline at end of file

Copied: cms/trunk/index.php (from rev 100, trunk/index.php)

Copied: cms/trunk/install (from rev 100, trunk/install)

Copied: cms/trunk/javascript (from rev 100, trunk/javascript)

Copied: cms/trunk/language (from rev 100, trunk/language)

Copied: cms/trunk/modules (from rev 100, trunk/modules)

Copied: cms/trunk/themes (from rev 100, trunk/themes)

Copied: cms/trunk/themes_admin (from rev 100, trunk/themes_admin)



From viperal at berlios.de  Fri Sep  9 03:19:49 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 9 Sep 2005 03:19:49 +0200
Subject: [Viperals-svncheckins] r104 - in cms: branches/1.0alpha1 branches/1.0alpha1/admin branches/1.0alpha1/admin/functions branches/1.0alpha1/includes branches/1.0alpha1/includes/display branches/1.0alpha1/includes/templates/admin/blocks branches/1.0alpha1/includes/templates/admin/messages branches/1.0alpha1/install branches/1.0alpha1/modules/articles trunk trunk/admin trunk/admin/functions trunk/includes trunk/includes/display trunk/includes/templates/admin trunk/includes/templates/admin/articles trunk/includes/templates/admin/blocks trunk/includes/templates/admin/messages trunk/includes/templates/admin/modules trunk/install trunk/modules/articles trunk/modules/articles/admin
Message-ID: <200509090119.j891Jnff017881@sheep.berlios.de>

Author: viperal
Date: 2005-09-09 03:19:33 +0200 (Fri, 09 Sep 2005)
New Revision: 104

Added:
   cms/trunk/includes/templates/admin/articles/
   cms/trunk/includes/templates/admin/articles/edit.html
   cms/trunk/includes/templates/admin/articles/index.html
   cms/trunk/includes/templates/admin/modules/edit.html
   cms/trunk/modules/articles/admin/
   cms/trunk/modules/articles/admin/index.php
Modified:
   cms/branches/1.0alpha1/admin/blocks.php
   cms/branches/1.0alpha1/admin/functions/block_functions.php
   cms/branches/1.0alpha1/admin/messages.php
   cms/branches/1.0alpha1/feed.php
   cms/branches/1.0alpha1/includes/display/blocks.php
   cms/branches/1.0alpha1/includes/templates/admin/blocks/index.html
   cms/branches/1.0alpha1/includes/templates/admin/messages/edit.html
   cms/branches/1.0alpha1/includes/user.php
   cms/branches/1.0alpha1/install/build_data.php
   cms/branches/1.0alpha1/modules/articles/index.php
   cms/branches/1.0alpha1/modules/articles/install.php
   cms/trunk/admin/blocks.php
   cms/trunk/admin/functions/block_functions.php
   cms/trunk/admin/messages.php
   cms/trunk/feed.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/templates/admin/blocks/index.html
   cms/trunk/includes/templates/admin/messages/edit.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/articles/index.php
   cms/trunk/modules/articles/install.php
Log:


Modified: cms/branches/1.0alpha1/admin/blocks.php
===================================================================
--- cms/branches/1.0alpha1/admin/blocks.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/admin/blocks.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -38,7 +38,7 @@
 	{
 		if ($redirect)
 		{
-			url_redirect(generate_link('blocks', array('admin' => true)));
+			redirect(generate_link('blocks', array('admin' => true)));
 			die;
 		}
 		return false;
@@ -96,9 +96,9 @@
 	}
 }
 
-$result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
-	FROM ' . BLOCKS_TABLE . '
-	WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ') ORDER BY block_position, block_order ASC');
+$result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_starts, block_expires, block_file, block_auth
+	FROM ' . BLOCKS_TABLE . ' WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ')
+	ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
 $in_position = false;
@@ -143,6 +143,9 @@
 			'TITLE'			=> $block['block_title'],
 			'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['block_type']),
 
+			'EXPIRES'		=> ($block['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
+			'STARTS'		=> ($block['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_starts']) : false,
+
 			'ORDER_DOWN' 	=> ($block['block_order'] < $weigth[$block['block_position']]),
 			'ORDER_UP'		=> ($block['block_order'] > 1),
 

Modified: cms/branches/1.0alpha1/admin/functions/block_functions.php
===================================================================
--- cms/branches/1.0alpha1/admin/functions/block_functions.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/admin/functions/block_functions.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -187,10 +187,10 @@
 			trigger_error('Block deleted<br/><a href="'.$return_link.'">Click here to return</a>');	        
 		}
 	}
-	
+
 	if ($return_link)
 	{
-		url_redirect($return_link);
+		redirect($return_link);
 	}
 }
 

Modified: cms/branches/1.0alpha1/admin/messages.php
===================================================================
--- cms/branches/1.0alpha1/admin/messages.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/admin/messages.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -118,7 +118,7 @@
 		'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['block_id'], array('admin' => true)),
 		'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['block_id'], array('admin' => true)),
 
-		'EXPIRES'		=> ($row['block_expires'] && $row['block_expires'] < $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
+		'EXPIRES'		=> ($row['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
 		'STARTS'		=> ($row['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_starts']) : false,
 		'TITLE'			=> $row['block_title'],
 
@@ -155,7 +155,7 @@
 		
 		if (!$block)
 		{
-			url_redirect(generate_link('messages', array('admin' => true)));
+			redirect(generate_link('messages', array('admin' => true)));
 		}
 		
 		check_position($block['block_position']);
@@ -200,7 +200,7 @@
 	}
 
 	$data['block_title'] = get_variable('title', 'POST', '');
-	$data['block_content'] = trim(get_variable('content', 'POST', ''));
+	$data['block_content'] = get_variable('content', 'POST', '');
 	
 	foreach ($data as $field => $value)
 	{
@@ -212,7 +212,7 @@
 	
 	$data['block_status']	= (get_variable('active', 'POST', STATUS_DISABLED, 'integer') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
 	$data['block_expires']	= get_variable('expires', 'POST', 0);
-	$data['block_starts']	= get_variable('time', 'POST', '');
+	$data['block_starts']	= get_variable('starts', 'POST', '');
 	$data['block_position']	= get_variable('b_position', 'POST', BLOCK_MESSAGE_TOP, 'integer');
 	$data['block_type'] 	= get_variable('b_type', 'REQUEST', BLOCKTYPE_MESSAGE, 'integer');
 
@@ -232,7 +232,7 @@
 
 	if ($data['block_starts'])
 	{
-		$start = strtotime($data['block_start']);
+		$start = strtotime($data['block_starts']);
 
 		if (!$start || $start == -1)
 		{
@@ -269,7 +269,7 @@
 
 		if (!$block)
 		{
-			url_redirect(generate_link('messages', array('admin' => true)));
+			redirect(generate_link('messages', array('admin' => true)));
 		}
 
 		check_position($block['block_position']);

Modified: cms/branches/1.0alpha1/feed.php
===================================================================
--- cms/branches/1.0alpha1/feed.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/feed.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -1,17 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 define('VIPERAL', 'FEED');
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
@@ -22,24 +31,33 @@
 //error_reporting(0);
 header('Content-Type: text/xml');
 
-$result = $_CLASS['core_db']->query('SELECT news_id, news_title, news_time, news_intro, poster_name FROM '.$prefix.'news ORDER BY news_id DESC LIMIT 10');
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
 
+$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+
 $last_post_time = 0;
-	
+
+// Need to fix this, add auth and expires/start check ( will have to remove limit )
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	if ($row['news_time'] > $last_post_time)
+	$time = ($row['articles_starts']) ? $row['articles_starts'] : $row['articles_posted'];
+	$text = ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'];
+
+	if ($time > $last_post_time)
 	{
-		$last_post_time = $row['news_time'];
+		$last_post_time = $time;
 	}
-	
+
 	$_CLASS['core_template']->assign_vars_array('items', array(
-		'TITLE' 			=> htmlspecialchars($row['news_title'], ENT_QUOTES),
-		'LINK' 				=> generate_link('News&amp;mode=view&amp;id='.$row['news_id'], array('full' => true, 'sid' => false)),
-		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($row['news_intro']), ENT_QUOTES),
-		'DESCRIPTION_HTML' 	=> htmlspecialchars($row['news_intro'], ENT_QUOTES),
-		'TIME'				=> date('M d Y H:i:s', $row['news_time']) .' GMT',
-		'AUTHOR'			=> $row['poster_name']
+		'TITLE' 			=> htmlspecialchars($row['articles_title'], ENT_QUOTES, 'UTF-8'),
+		'LINK' 				=> generate_link('articles&amp;mode=view&amp;id='.$row['articles_id'], array('full' => true, 'sid' => false)),
+		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($text), ENT_QUOTES, 'UTF-8'),
+		'DESCRIPTION_HTML' 	=> htmlspecialchars($text, ENT_QUOTES, 'UTF-8'),
+		'TIME'				=> date('M d Y H:i:s', $time) .' GMT',
+		'AUTHOR'			=> htmlspecialchars($row['poster_name'], ENT_QUOTES, 'UTF-8')
 	));
 }
 $_CLASS['core_db']->free_result($result);
@@ -54,11 +72,9 @@
 	'TIME'			=> gmdate('M d Y H:i:s') .' GMT'
 ));
 
-//header('Last-Modified: '.$last_modified);
+header('Last-Modified: '.$last_post_time);
 
-$feed = get_variable('feed', 'GET', false);
-
-Switch ($feed)
+Switch ($_GET['feed'])
 {
 	case 'rdf':
 	case 'rss1':

Modified: cms/branches/1.0alpha1/includes/display/blocks.php
===================================================================
--- cms/branches/1.0alpha1/includes/display/blocks.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/includes/display/blocks.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -151,7 +151,7 @@
 			{
 				continue;
 			}
-//language check here.
+
 			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
 			{
 				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);
@@ -167,18 +167,6 @@
 				continue;
 			}
 
-			/*
-			if ($this->block['block_modules'])
-			{
-				$this->block['block_modules'] = unserialize($this->block['block_modules']);
-// Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
-				{
-					continue;
-				}
-			}
-			*/
-
 			$this->display_blocks();
 			$this->content = '';
 		}

Modified: cms/branches/1.0alpha1/includes/templates/admin/blocks/index.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/admin/blocks/index.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/includes/templates/admin/blocks/index.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -33,6 +33,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $left_admin_blocks:EDIT_LINK }">{ $left_admin_blocks:TITLE }</a>
+				<!-- IF { $left_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $left_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $left_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $left_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $left_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $left_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -76,6 +78,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centertop_admin_blocks:EDIT_LINK }">{ $centertop_admin_blocks:TITLE }</a>
+				<!-- IF { $centertop_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $centertop_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $centertop_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $centertop_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $centertop_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centertop_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -120,6 +124,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centerbottom_admin_blocks:EDIT_LINK }">{ $centerbottom_admin_blocks:TITLE }</a>
+				<!-- IF { $centerbottom_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $centerbottom_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $centerbottom_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $centerbottom_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $centerbottom_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centerbottom_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -162,6 +168,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $right_admin_blocks:EDIT_LINK }">{ $right_admin_blocks:TITLE }</a>
+				<!-- IF { $right_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $right_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $right_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $right_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $right_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $right_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >

Modified: cms/branches/1.0alpha1/includes/templates/admin/messages/edit.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/admin/messages/edit.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/includes/templates/admin/messages/edit.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -42,8 +42,8 @@
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
 				<td class="row2" >
-					<input class="post" id="time" name="time" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
-					<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger"/>
+					<input class="post" id="starts" name="starts" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
+					<img src="images/calender_small.png" style="cursor: pointer;" id="starts_trigger"/>
 				</td>
 				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:<br/>{ $B_CURRENT_TIME }: </b></td>
 			</tr>
@@ -95,8 +95,8 @@
 
   Calendar.setup(
     {
-      inputField  : "time",         // ID of the input field
-      button      : "time_trigger"       // ID of the button
+      inputField  : "starts",         // ID of the input field
+      button      : "starts_trigger"       // ID of the button
     }
   );
 </script>

Modified: cms/branches/1.0alpha1/includes/user.php
===================================================================
--- cms/branches/1.0alpha1/includes/user.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/includes/user.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -131,10 +131,10 @@
 		$result = $_CLASS['core_db']->query('SELECT * FROM ' . USERS_TABLE . ' WHERE user_id = '. $id);
 		$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
-		
+
 		if (!$this->data)
 		{
-			die;
+			die('Installlation problem');
 // Error here, however this happen
 		}
 

Modified: cms/branches/1.0alpha1/install/build_data.php
===================================================================
--- cms/branches/1.0alpha1/install/build_data.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/install/build_data.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -120,15 +120,15 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");

Modified: cms/branches/1.0alpha1/modules/articles/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/index.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/modules/articles/index.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -78,10 +78,11 @@
 }
 
 $start = get_variable('start', 'GET', false, 'int');
+$collapable_holding = array();
+$expire_updated = false;
 $limit = 10;
-$collapable_holding = array();
 
-$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order DESC';
+$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
 $result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -91,6 +92,19 @@
 	{
 		continue;
 	}
+	
+	if ($row['articles_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $row['articles_expires']))
+	{
+		$_CLASS['core_db']->query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires > 0 AND articles_expires <= ' . $_CLASS['core_user']->time);
+		$expire_updated = true;
+
+		continue;
+	}
+
+	if ($row['articles_starts'] && ($row['articles_starts'] > $_CLASS['core_user']->time))
+	{
+		continue;
+	}
 
 	$_CLASS['core_template']->assign_vars_array('articles', array(
 		'poster' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),

Modified: cms/branches/1.0alpha1/modules/articles/install.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/install.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/branches/1.0alpha1/modules/articles/install.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -46,13 +46,13 @@
 		$_CLASS['core_db']->add_table_field_int('articles_id', array('max' => 16000000, 'auto_increment' => true));
 		$_CLASS['core_db']->add_table_field_char('articles_title', 80);
 		$_CLASS['core_db']->add_table_field_int('articles_posted', array('max' => 200000000));
-		$_CLASS['core_db']->add_table_field_int('articles_start', array('max' => 200000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_starts', array('max' => 200000000, 'null' => true));
 		$_CLASS['core_db']->add_table_field_int('articles_expires', array('max' => 200000000, 'null' => true));
 		$_CLASS['core_db']->add_table_field_text('articles_intro', 60000, true);
 		$_CLASS['core_db']->add_table_field_text('articles_text', 10000000);
 		$_CLASS['core_db']->add_table_field_text('articles_notes', 60000, true);
 
-		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000));
 		$_CLASS['core_db']->add_table_field_int('articles_type', array('max' => 10));
 		$_CLASS['core_db']->add_table_field_int('articles_status', array('max' => 10));
 		$_CLASS['core_db']->add_table_field_text('articles_auth', 60000, true);
@@ -76,6 +76,7 @@
 			'articles_title'	=> 'Welcome Post',
 			'articles_posted'	=> (int) $_CLASS['core_user']->time,
 			'articles_text'		=> '<p align="center">I need something snappy here</p>',
+			'articles_order'	=> 1,
 			'articles_type'		=> 1,
 			'articles_status'	=> STATUS_ACTIVE,
 			'poster_id'			=> 0,

Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/admin/blocks.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -38,7 +38,7 @@
 	{
 		if ($redirect)
 		{
-			url_redirect(generate_link('blocks', array('admin' => true)));
+			redirect(generate_link('blocks', array('admin' => true)));
 			die;
 		}
 		return false;
@@ -96,9 +96,9 @@
 	}
 }
 
-$result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_file, block_auth
-	FROM ' . BLOCKS_TABLE . '
-	WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ') ORDER BY block_position, block_order ASC');
+$result = $_CLASS['core_db']->query('SELECT block_id, block_title, block_type,  block_position, block_order, block_status, block_starts, block_expires, block_file, block_auth
+	FROM ' . BLOCKS_TABLE . ' WHERE block_position IN (' . BLOCK_RIGHT . ', ' . BLOCK_TOP . ', ' . BLOCK_BOTTOM . ', ' . BLOCK_LEFT . ')
+	ORDER BY block_position, block_order ASC');
 
 $block_position = array(BLOCK_RIGHT => 'right', BLOCK_TOP => 'centertop', BLOCK_BOTTOM => 'centerbottom', BLOCK_LEFT => 'left');
 $in_position = false;
@@ -143,6 +143,9 @@
 			'TITLE'			=> $block['block_title'],
 			'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['block_type']),
 
+			'EXPIRES'		=> ($block['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
+			'STARTS'		=> ($block['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_starts']) : false,
+
 			'ORDER_DOWN' 	=> ($block['block_order'] < $weigth[$block['block_position']]),
 			'ORDER_UP'		=> ($block['block_order'] > 1),
 

Modified: cms/trunk/admin/functions/block_functions.php
===================================================================
--- cms/trunk/admin/functions/block_functions.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/admin/functions/block_functions.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -187,10 +187,10 @@
 			trigger_error('Block deleted<br/><a href="'.$return_link.'">Click here to return</a>');	        
 		}
 	}
-	
+
 	if ($return_link)
 	{
-		url_redirect($return_link);
+		redirect($return_link);
 	}
 }
 

Modified: cms/trunk/admin/messages.php
===================================================================
--- cms/trunk/admin/messages.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/admin/messages.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -118,7 +118,7 @@
 		'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['block_id'], array('admin' => true)),
 		'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['block_id'], array('admin' => true)),
 
-		'EXPIRES'		=> ($row['block_expires'] && $row['block_expires'] < $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
+		'EXPIRES'		=> ($row['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
 		'STARTS'		=> ($row['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_starts']) : false,
 		'TITLE'			=> $row['block_title'],
 
@@ -155,7 +155,7 @@
 		
 		if (!$block)
 		{
-			url_redirect(generate_link('messages', array('admin' => true)));
+			redirect(generate_link('messages', array('admin' => true)));
 		}
 		
 		check_position($block['block_position']);
@@ -200,7 +200,7 @@
 	}
 
 	$data['block_title'] = get_variable('title', 'POST', '');
-	$data['block_content'] = trim(get_variable('content', 'POST', ''));
+	$data['block_content'] = get_variable('content', 'POST', '');
 	
 	foreach ($data as $field => $value)
 	{
@@ -212,7 +212,7 @@
 	
 	$data['block_status']	= (get_variable('active', 'POST', STATUS_DISABLED, 'integer') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
 	$data['block_expires']	= get_variable('expires', 'POST', 0);
-	$data['block_starts']	= get_variable('time', 'POST', '');
+	$data['block_starts']	= get_variable('starts', 'POST', '');
 	$data['block_position']	= get_variable('b_position', 'POST', BLOCK_MESSAGE_TOP, 'integer');
 	$data['block_type'] 	= get_variable('b_type', 'REQUEST', BLOCKTYPE_MESSAGE, 'integer');
 
@@ -232,7 +232,7 @@
 
 	if ($data['block_starts'])
 	{
-		$start = strtotime($data['block_start']);
+		$start = strtotime($data['block_starts']);
 
 		if (!$start || $start == -1)
 		{
@@ -269,7 +269,7 @@
 
 		if (!$block)
 		{
-			url_redirect(generate_link('messages', array('admin' => true)));
+			redirect(generate_link('messages', array('admin' => true)));
 		}
 
 		check_position($block['block_position']);

Modified: cms/trunk/feed.php
===================================================================
--- cms/trunk/feed.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/feed.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -1,17 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 define('VIPERAL', 'FEED');
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
@@ -22,24 +31,33 @@
 //error_reporting(0);
 header('Content-Type: text/xml');
 
-$result = $_CLASS['core_db']->query('SELECT news_id, news_title, news_time, news_intro, poster_name FROM '.$prefix.'news ORDER BY news_id DESC LIMIT 10');
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
 
+$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+
 $last_post_time = 0;
-	
+
+// Need to fix this, add auth and expires/start check ( will have to remove limit )
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	if ($row['news_time'] > $last_post_time)
+	$time = ($row['articles_starts']) ? $row['articles_starts'] : $row['articles_posted'];
+	$text = ($row['articles_intro']) ? $row['articles_intro'] : $row['articles_text'];
+
+	if ($time > $last_post_time)
 	{
-		$last_post_time = $row['news_time'];
+		$last_post_time = $time;
 	}
-	
+
 	$_CLASS['core_template']->assign_vars_array('items', array(
-		'TITLE' 			=> htmlspecialchars($row['news_title'], ENT_QUOTES),
-		'LINK' 				=> generate_link('News&amp;mode=view&amp;id='.$row['news_id'], array('full' => true, 'sid' => false)),
-		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($row['news_intro']), ENT_QUOTES),
-		'DESCRIPTION_HTML' 	=> htmlspecialchars($row['news_intro'], ENT_QUOTES),
-		'TIME'				=> date('M d Y H:i:s', $row['news_time']) .' GMT',
-		'AUTHOR'			=> $row['poster_name']
+		'TITLE' 			=> htmlspecialchars($row['articles_title'], ENT_QUOTES, 'UTF-8'),
+		'LINK' 				=> generate_link('articles&amp;mode=view&amp;id='.$row['articles_id'], array('full' => true, 'sid' => false)),
+		'DESCRIPTION' 		=> htmlspecialchars(strip_tags($text), ENT_QUOTES, 'UTF-8'),
+		'DESCRIPTION_HTML' 	=> htmlspecialchars($text, ENT_QUOTES, 'UTF-8'),
+		'TIME'				=> date('M d Y H:i:s', $time) .' GMT',
+		'AUTHOR'			=> htmlspecialchars($row['poster_name'], ENT_QUOTES, 'UTF-8')
 	));
 }
 $_CLASS['core_db']->free_result($result);
@@ -54,11 +72,9 @@
 	'TIME'			=> gmdate('M d Y H:i:s') .' GMT'
 ));
 
-//header('Last-Modified: '.$last_modified);
+header('Last-Modified: '.$last_post_time);
 
-$feed = get_variable('feed', 'GET', false);
-
-Switch ($feed)
+Switch ($_GET['feed'])
 {
 	case 'rdf':
 	case 'rss1':

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/display/blocks.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -151,7 +151,7 @@
 			{
 				continue;
 			}
-//language check here.
+
 			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
 			{
 				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);

Added: cms/trunk/includes/templates/admin/articles/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/articles/edit.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/templates/admin/articles/edit.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -0,0 +1,114 @@
+<!-- DISPLAY_HEADER -->
+
+<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
+
+{ $A_TABLE_OPEN }
+
+<form action="{ $B_ACTION }" name="message" method="post">
+	<table class="tablebg" align="center" cellpadding="4" cellspacing="1" width="100%">
+		<tbody>
+			<!-- IF { $B_ERROR } -->
+			<tr> 
+				<td class="row2" align="center" colspan="3">
+					<font class="error">{ $B_ERROR }</font>
+				</td>
+			</tr>
+			<!-- ENDIF -->
+
+			<tr> 
+				<th colspan="3" height="28" valign="middle">{ $B_TITLE }</th>
+			</tr>
+		
+			<tr> 
+				<td class="row1" width="20%"><b class="genmed">{ $L_TITLE }: </b></td>
+		
+				<td class="row2" colspan="2"><input class="post" name="title" size="50" maxlength="100" value="{ $B_TITLE }" type="text"><!-- IF { $B_DELETE_LINK } --> <br/> <a href="{ $B_DELETE_LINK }">{ $L_DELETE_THIS }</a> <!-- ENDIF --></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
+				<td class="row2" colspan="2"><input name="active" value="2" <!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="active" value="0" <!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
+				<td class="row2" >
+					<input class="post" id="starts" name="starts" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
+					<img src="images/calender_small.png" style="cursor: pointer;" id="starts_trigger"/>
+				</td>
+				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:<br/>{ $B_CURRENT_TIME }: </b></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
+				<td class="row2">
+					<input class="post" id="expires" name="expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
+					<img src="images/calender_small.png" style="cursor: pointer;"  id="expires_trigger" />
+				</td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_MESSAGE }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="text" id="text" editor_enabled="true" style="width:90%; height:400px;" cols="63" rows="15">{ $B_TEXT }</textarea><br /><br /></td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_INTRO_MESSAGE }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="intro" id="intro" editor_enabled="true" style="width:90%; height:200px;" cols="63" rows="15">{ $B_INTRO }</textarea><br /><br /></td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_ADMIN_NOTES }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="notes" id="notes" editor_enabled="false" style="width:90%; height:150px;" cols="63" rows="15">{ $B_NOTES }</textarea><br /><br /></td>
+			</tr>
+			<tr>
+				<td class="cat" colspan="3" align="center" height="28">
+					<input type="hidden" name="update" value="{ $B_BID }">
+					<!-- <input class="btnmain" id="preview_fast" value="{ $L_PREVIEW }" type="button" onclick="fast_preview(); return false;"> -->
+					<input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;&nbsp;<input class="btnlite" value="Reset" name="reset" type="reset">
+				</td>
+			</tr>
+		</tbody>
+	</table>
+</form>
+
+{ $A_TABLE_CLOSE }
+
+<script type="text/javascript">
+
+function fast_preview()
+{
+	if(document.getElementById('preview_fast').value == '{ $L_PREVIEW }')
+	{
+		document.getElementById('preview_fast').value = 'Edit';
+		document.getElementById('message_preview').innerHTML = document.getElementById('content').value;
+		document.getElementById('message_preview').style.display = '';
+		document.getElementById('content').style.display = 'none';
+
+	}
+	else
+	{
+		document.getElementById('preview_fast').value = '{ $L_PREVIEW }';
+		document.getElementById('message_preview').innerHTML = '';
+		document.getElementById('message_preview').style.display = 'none';
+		document.getElementById('content').style.display = '';
+	}
+}
+
+  Calendar.setup(
+    {
+      inputField  : "starts",         // ID of the input field
+      button      : "starts_trigger"       // ID of the button
+    }
+  );
+</script>
+<script type="text/javascript">
+  Calendar.setup(
+    {
+      inputField  : "expires",         // ID of the input field
+      button      : "expires_trigger"       // ID of the button
+    }
+  );
+</script>
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/includes/templates/admin/articles/index.html
===================================================================
--- cms/trunk/includes/templates/admin/articles/index.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/templates/admin/articles/index.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -0,0 +1,110 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+    <tbody>
+		<tr>
+			<th align="center" width="25%">{$L_TITLE}</th>
+			<th align="center" colspan="2">{ $L_ORDER }</th>
+			<th align="center">{ $L_STATUS }</th>
+			<th align="center">{ $L_FUNCTIONS }</th>
+		</tr>
+    <!-- IF isset({ $top_admin_messages }) -->
+    	<tr>
+			<td class="cat" colspan="8"><b class="gensmall">{ $L_TOP_MESSAGES }</b></td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- LOOP $top_admin_messages -->
+		<tr>
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:EDIT_LINK }'; return false;">
+				<a href="{ $top_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $top_admin_messages:TITLE }</a><br />
+				<!-- IF { $top_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $top_admin_messages:STARTS }<!-- ENDIF -->
+				<!-- IF { $top_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $top_admin_messages:EXPIRES }<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center" >
+				<!-- IF { $top_admin_messages:ORDER_UP } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center">
+				<!-- IF { $top_admin_messages:ORDER_DOWN } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:ACTIVE_LINK }'; return false;">
+				<a href="{ $top_admin_messages:ACTIVE_LINK }">{ $top_admin_messages:CHANGE }</a>
+			</td>
+			<td class="row1" align="center">
+			<!-- IF { $top_admin_messages:EDIT_LINK } -->
+				<a href="{ $top_admin_messages:EDIT_LINK }">{ $L_EDIT }</a> |
+			<!-- ENDIF -->
+			<a href="{ $top_admin_messages:AUTH_LINK }">{ $L_PERMISSIONS }</a>
+			<!-- IF { $top_admin_messages:DELETE_LINK } -->
+				 | <a href="{ $top_admin_messages:DELETE_LINK }">{ $L_DELETE }</a>
+			<!-- ENDIF --> </td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- ENDLOOP $top_admin_messages -->
+	<!-- ENDIF -->
+
+	<!-- IF isset({ $bottom_admin_messages }) -->
+    	<tr>
+			<td class="cat" colspan="8"><b class="gensmall">{ $L_BOTTOM_MESSAGES }</b></td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- LOOP $bottom_admin_messages -->
+		<tr>
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:EDIT_LINK }'; return false;">
+				<a href="{ $bottom_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $bottom_admin_messages:TITLE }</a><br />
+				<!-- IF { $bottom_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $bottom_admin_messages:STARTS }<!-- ENDIF -->
+				<!-- IF { $bottom_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $bottom_admin_messages:EXPIRES }<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center" >
+				<!-- IF { $bottom_admin_messages:ORDER_UP } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center">
+				<!-- IF { $bottom_admin_messages:ORDER_DOWN } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:ACTIVE_LINK }'; return false;">
+				<a href="{ $bottom_admin_messages:ACTIVE_LINK }">{ $bottom_admin_messages:CHANGE }</a>
+			</td>
+			<td class="row1" align="center">
+			<!-- IF { $bottom_admin_messages:EDIT_LINK } -->
+			<a href="{ $bottom_admin_messages:EDIT_LINK }">{ $L_EDIT }</a> |
+			<!-- ENDIF -->
+			<a href="{ $bottom_admin_messages:AUTH_LINK }">{ $L_PERMISSIONS }</a>
+			<!-- IF { $bottom_admin_messages:DELETE_LINK } -->
+				| <a href="{ $bottom_admin_messages:DELETE_LINK }">{ $L_DELETE }</a>
+			<!-- ENDIF --> </td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- ENDLOOP $bottom_admin_messages -->
+	<!-- ENDIF -->
+	 		  <tr>
+			<td class="cat" colspan="8">
+				<form action="{ $LINK_ADD }" method="post"><input class="button" value="{ $L_ADD_NEW }" name="regular" type="submit" /></form>
+			</td>
+		  </tr>
+  </tbody>
+</table>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/admin/blocks/index.html
===================================================================
--- cms/trunk/includes/templates/admin/blocks/index.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/templates/admin/blocks/index.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -33,6 +33,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $left_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $left_admin_blocks:EDIT_LINK }">{ $left_admin_blocks:TITLE }</a>
+				<!-- IF { $left_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $left_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $left_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $left_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $left_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $left_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -76,6 +78,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centertop_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centertop_admin_blocks:EDIT_LINK }">{ $centertop_admin_blocks:TITLE }</a>
+				<!-- IF { $centertop_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $centertop_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $centertop_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $centertop_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $centertop_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centertop_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -120,6 +124,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $centerbottom_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $centerbottom_admin_blocks:EDIT_LINK }">{ $centerbottom_admin_blocks:TITLE }</a>
+				<!-- IF { $centerbottom_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $centerbottom_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $centerbottom_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $centerbottom_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $centerbottom_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $centerbottom_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >
@@ -162,6 +168,8 @@
 		<tr>
 			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $right_admin_blocks:EDIT_LINK }'; return false;">
 				<a href="{ $right_admin_blocks:EDIT_LINK }">{ $right_admin_blocks:TITLE }</a>
+				<!-- IF { $right_admin_blocks:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $right_admin_blocks:STARTS }<!-- ENDIF -->
+				<!-- IF { $right_admin_blocks:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $right_admin_blocks:EXPIRES }<!-- ENDIF -->
 				<!-- IF { $right_admin_blocks:ERROR } --><br/><span style="font-size: 90%; color: red;">{ $right_admin_blocks:ERROR }</span><!-- ENDIF -->
 			</td>
 			<td class="row1" align="center" >

Modified: cms/trunk/includes/templates/admin/messages/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/messages/edit.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/templates/admin/messages/edit.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -42,8 +42,8 @@
 			<tr> 
 				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
 				<td class="row2" >
-					<input class="post" id="time" name="time" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
-					<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger"/>
+					<input class="post" id="starts" name="starts" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
+					<img src="images/calender_small.png" style="cursor: pointer;" id="starts_trigger"/>
 				</td>
 				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:<br/>{ $B_CURRENT_TIME }: </b></td>
 			</tr>
@@ -95,8 +95,8 @@
 
   Calendar.setup(
     {
-      inputField  : "time",         // ID of the input field
-      button      : "time_trigger"       // ID of the button
+      inputField  : "starts",         // ID of the input field
+      button      : "starts_trigger"       // ID of the button
     }
   );
 </script>

Added: cms/trunk/includes/templates/admin/modules/edit.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/edit.html	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/templates/admin/modules/edit.html	2005-09-09 01:19:33 UTC (rev 104)
@@ -0,0 +1,100 @@
+<style type="text/css">@import url(java/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="java/jscalendar/calendar_stripped.js"></script>
+<script type="text/javascript" src="java/jscalendar/lang/calendar-en.js"></script>
+<script type="text/javascript" src="java/jscalendar/calendar-setup.js"></script>
+{ $A_TABLE_OPEN }
+<form action="{ $B_ACTION }" method="post">
+	<table class="tablebg" align="center" border="0" cellpadding="4" cellspacing="1" width="100%">
+		<tbody>
+		{ if $B_ERROR }
+			<tr> 
+				<td class="row2" align="center" colspan="3">
+					<font color="#990000">{ $B_ERROR }</font>
+				</td>
+			</tr>
+		{ /if }
+			<tr> 
+				<th colspan="3" height="28" valign="middle">{ $B_HEADER }</th>
+			</tr>
+		
+			<tr> 
+				<td class="row1" width="20%"><b class="genmed">{ $L_TITLE }: </b></td>
+		
+				<td class="row2" colspan="2"><input class="post" name="b_title" size="40" maxlength="100" value="{ $B_TITLE }" type="text"></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
+				<td class="row2" colspan="2"><input type="radio" name="b_active" value="1"{ if $B_ACTIVE } checked="checked" { /if }/><span class="genmed">{$L_YES}</span>&nbsp;&nbsp;<input type="radio" name="b_active" value="0"{ if !$B_ACTIVE } checked="checked" { /if }/><span class="genmed">{$L_NO}</span></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
+				<td class="row2" >
+					<input class="post" id="b_time" name="b_time" size="35" maxlength="100" value="{ $B_STARTS }" type="text" />
+					<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
+					{ if $B_STARTS }   Currently Set:  { $B_STARTS }{ /if }
+				</td>
+				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:</b><br/>{ $B_CURRENT_TIME } </td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
+				<td class="row2">
+					<input class="post" id="b_expires" name="b_expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
+					<img src="java/jscalendar/calendar.png" style="cursor: pointer;"  id="expires_trigger" />
+					{ if $B_EXPIRES }    Currently Set:  { $B_EXPIRES }{ /if }
+				</td>
+			</tr>
+			{ if $B_POSITION }
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_POSITION }: </b></td>
+				<td class="row2" colspan="2"><select name="b_position">{ $B_POSITION }</select></td>
+			</tr>
+			{ /if }
+			{ if $B_RSS_SHOW }
+				<tr> 
+				<td class="row1"><b class="genmed">{ $L_RSS_URL }: </b></td>
+				<td class="row2" colspan="2"><input class="post" name="b_url" size="35" maxlength="100" value="{ $B_RSS_URL }" type="text"></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_RSS_REFRESH }: </b></td>
+				<td class="row2" colspan="2"><input class="post" name="b_refresh" size="35" maxlength="100" value="{ $B_RSS_REFRESH }" type="text">{ if $B_EXPIRES }    Currently Set:  { $B_EXPIRES }{ /if }</td>
+			</tr>
+			{ /if }
+			{ if $B_FILE }
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_FILE }: </b></td>
+				<td class="row2" colspan="2"><select name="b_file">{ $B_FILE }</select> </td>
+		
+			</tr>
+			{ /if }
+			{ if $B_SHOW_CONTENT }
+			<tr> 
+				<td class="row1" valign="top"><b class="genmed">{ $L_HTML_CONTENT }: </b></td>
+				<td class="row2" colspan="2"><textarea name="b_content" id="b_content" editor_enabled="true" style="width:300px; height:200px" cols="63" rows="15">{ $B_CONTENT }</textarea><br /></td>
+			</tr>
+			{ /if }
+			<tr>
+				<td class="cat" colspan="3" align="center" height="28">
+				<input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;&nbsp;<input class="btnlite" value="Reset" name="reset" type="reset"></td>
+			</tr>
+		</tbody>
+	</table>
+</form>
+{literal}
+<script type="text/javascript">
+  Calendar.setup(
+    {
+      inputField  : "b_time",
+      button      : "time_trigger"
+    }
+  );
+</script>
+<script type="text/javascript">
+  Calendar.setup(
+    {
+      inputField  : "b_expires",
+      button      : "expires_trigger"
+    }
+  );
+</script>
+{/literal}
+{ $A_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/includes/user.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -131,10 +131,10 @@
 		$result = $_CLASS['core_db']->query('SELECT * FROM ' . USERS_TABLE . ' WHERE user_id = '. $id);
 		$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
-		
+
 		if (!$this->data)
 		{
-			die;
+			die('Installlation problem');
 // Error here, however this happen
 		}
 

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/install/build_data.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -120,15 +120,15 @@
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");

Added: cms/trunk/modules/articles/admin/index.php
===================================================================
--- cms/trunk/modules/articles/admin/index.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/modules/articles/admin/index.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -0,0 +1,396 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
+
+if (isset($_REQUEST['mode']))
+{
+	if ($id = get_variable('id', 'GET', false, 'int'))
+	{
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				$result = $_CLASS['core_db']->query('SELECT articles_status FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+				
+				$status = ($article['articles_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+				$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . " SET articles_status = $status WHERE articles_id = $id");
+			break;
+			
+			case 'delete':
+				$result = $_CLASS['core_db']->query('SELECT articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_id='.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+			
+				if (display_confirmation())
+				{
+					$_CLASS['core_db']->query('DELETE from ' . ARTICLES_TABLE . ' where articles_id = '.$id);
+					$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_order > ' . $article['articles_order']);
+				}
+			break;
+
+			case 'auth':
+				$result = $_CLASS['core_db']->query('SELECT articles_auth FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+				
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+				
+				$article['articles_auth'] = ($article['articles_auth']) ? unserialize($article['articles_auth']) : '';
+				
+				$_CLASS['core_display']->display_header();
+
+				$auth = $_CLASS['core_auth']->generate_auth_options($article['articles_auth']);
+
+				if ($auth !== false)
+				{
+					if (is_null($auth))
+					{
+						$article['articles_auth'] = '';
+						$auth = 'null';
+					}
+					else
+					{
+						$article['articles_auth'] = $auth;
+						$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
+					}
+			
+					$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . " SET articles_auth = $auth WHERE articles_id = $id");
+				}
+
+				$_CLASS['core_display']->display_footer();
+			break;
+
+			case 'order':
+				$option = get_variable('option', 'GET', false);
+			
+				if (!$option || !in_array($option, array('down', 'up', 'bottom', 'top')))
+				{
+					break;
+				}
+
+				$result = $_CLASS['core_db']->query('SELECT articles_type, articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_id= ' . $id);
+				$articles = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$articles)
+				{
+					trigger_error('ARTICLE_NOT_FOUND');
+				}
+
+				settype($articles['articles_order'], 'integer');
+
+				switch ($option)
+				{
+					case 'down':
+						$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_type='.$articles['articles_type']);
+						list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+						$_CLASS['core_db']->free_result($result);
+			
+						if ($articles['articles_order'] < $max_order)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type = '.$articles['articles_type'].' AND articles_order='.($articles['articles_order'] + 1));
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.($articles['articles_order'] + 1).' WHERE articles_id ='. $id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'bottom':
+						$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_type='.$articles['articles_type']);
+						list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+						$_CLASS['core_db']->free_result($result);
+			
+						if ($articles['articles_order'] < $max_order)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type='.$articles['articles_type'].' AND articles_order > '.$articles['articles_order']);
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.$max_order.' WHERE articles_id = '.$id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'up':
+						if ($articles['articles_order'] && $articles['articles_order'] != 1)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order = '.($articles['articles_order'] - 1));
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order='.($articles['articles_order'] -1 ).' WHERE articles_id ='. $id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'top':
+
+						if ($articles['articles_order'] != 1)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order < '.$articles['articles_order']);
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = 1 WHERE articles_id = '.$id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+				}
+			break;
+
+			case 'edit':
+				articles_edit($id);
+			break;
+		}
+	}
+
+	switch ($_REQUEST['mode'])
+	{
+		case 'add':
+			articles_edit(false);
+		break;
+		   
+		case 'save':
+			articles_save($id);
+		break;
+	}
+}
+
+// temp
+$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE);
+list($count) = $_CLASS['core_db']->fetch_row_num($result);
+$_CLASS['core_db']->free_result($result);
+
+$result = $_CLASS['core_db']->query('SELECT articles_id, articles_title, articles_starts, articles_order, articles_expires, articles_status
+										FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC');
+
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$_CLASS['core_template']->assign_vars_array('top_admin_messages', array(
+		'ACTIVE'		=> ($row['articles_status']) ? true : false,
+		'CHANGE'		=> ($row['articles_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+
+		'AUTH_LINK'		=> generate_link('articles&amp;mode=auth&amp;id='.$row['articles_id'], array('admin' => true)),
+		'ACTIVE_LINK'	=> generate_link('articles&amp;mode=change&amp;id='.$row['articles_id'], array('admin' => true)),
+		'VIEW_LINK' 	=> generate_link('articles&amp;mode=show&amp;id='.$row['articles_id'], array('admin' => true)),
+		'EDIT_LINK'		=> generate_link('articles&amp;mode=edit&amp;id='.$row['articles_id'], array('admin' => true)),
+		'DELETE_LINK' 	=> generate_link('articles&amp;mode=delete&amp;id='.$row['articles_id'], array('admin' => true)),
+
+		'EXPIRES'		=> ($row['articles_expires']) ? $_CLASS['core_user']->format_date($row['articles_expires']) : false,
+		'STARTS'		=> ($row['articles_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['articles_starts']) : false,
+		'TITLE'			=> $row['articles_title'],
+
+		'ORDER_DOWN' 		=> ($row['articles_order'] < $count),
+		'ORDER_UP'			=> ($row['articles_order'] > 1),
+
+		'LINK_ORDER_UP' 	=> generate_link('articles&amp;mode=order&amp;option=up&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_TOP' 	=> generate_link('articles&amp;mode=order&amp;option=top&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_DOWN'	=> generate_link('articles&amp;mode=order&amp;option=down&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_BOTTOM'	=> generate_link('articles&amp;mode=order&amp;option=bottom&amp;id='.$row['articles_id'], array('admin' => true)),
+	));
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'LINK_ADD'			=> generate_link('articles&amp;mode=add', array('admin' => true))
+));
+
+$_CLASS['core_db']->free_result($result);
+
+$_CLASS['core_display']->display(false, 'admin/articles/index.html');
+
+script_close();
+
+function articles_edit($id = false, $article = false, $error = false)
+{
+    global $_CLASS;
+
+	if ($id)
+	{
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
+		$article = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		
+		if (!$article)
+		{
+			redirect(generate_link('articles', array('admin' => true)));
+		}
+		
+		if (isset($_POST['submit']))
+		{
+			// need to re-validate data with the db type
+			articles_get_data($articles_post, $error);
+			$article = array_merge($article, $articles_post);
+		}
+
+		unset($articles_post);
+	}
+	
+	$_CLASS['core_template']->assign_array(array(
+		'B_TITLE'			=> $article['articles_title'],
+		'B_TEXT'			=> $article['articles_text'],
+		'B_INTRO'			=> $article['articles_intro'],
+		'B_NOTES'			=> $article['articles_notes'],
+
+		'B_ACTIVE'			=> $article['articles_status'],
+		'B_EXPIRES'			=> is_numeric($article['articles_expires']) ? $_CLASS['core_user']->format_date($article['articles_expires'], 'M d, Y h:i a') : $article['articles_expires'],
+		'B_ERROR'			=> $error,
+		'B_STARTS'			=> is_numeric($article['articles_starts']) ? $_CLASS['core_user']->format_date($article['articles_starts'], 'M d, Y h:i a') : $article['articles_starts'],
+		'B_DELETE_LINK'		=> ($id) ? generate_link('articles&amp;mode=delete&amp;id='.$id, array('admin' => true)) : false,
+		'B_ACTION'			=> generate_link('articles&amp;mode=save'.(($id) ? '&amp;id='.$id : ''), array('admin' => true)),
+		'B_CURRENT_TIME'=> $_CLASS['core_user']->format_date($_CLASS['core_user']->time)
+	));
+	
+	$_CLASS['core_template']->display('admin/articles/edit.html');
+}
+
+function articles_get_data(&$data, &$error)
+{
+	global $_CLASS;
+	
+	$error = '';
+	$data = array();
+
+	if (!isset($_POST['submit']))
+	{
+		return;
+	}
+
+	$data['articles_title'] = get_variable('title', 'POST', '');
+	$data['articles_text'] = get_variable('text', 'POST', '');
+
+	foreach ($data as $field => $value)
+	{
+		if (!$value)
+		{
+			$error .= $_CLASS['core_user']->get_lang('ERROR_'.$field).'<br />';
+		}
+	}
+
+	$data['articles_intro'] = get_variable('intro', 'POST', '');
+	$data['articles_notes'] = get_variable('notes', 'POST', '');
+
+	$data['articles_status']	= (get_variable('active', 'POST', STATUS_DISABLED, 'int') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
+	$data['articles_expires']	= get_variable('expires', 'POST', 0);
+	$data['articles_starts']	= get_variable('starts', 'POST', '');
+
+	$start = $expires = '';
+
+	if ($data['articles_starts'])
+	{
+		$start = strtotime($data['articles_starts']);
+
+		if (!$start || $start == -1)
+		{
+			$error .= $_CLASS['core_user']->lang['ERROR_START_TIME'].'<br />';
+		}
+	}
+
+	if ($data['articles_expires'])
+	{
+		$expires = strtotime($data['articles_expires']);
+
+		if (!$expires || $expires == -1)
+		{
+			$error .= $_CLASS['core_user']->lang['ERROR_END_TIME'].'<br />';
+		}
+	}
+	
+	if (!$error)
+	{
+		$data['articles_starts'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
+		$data['articles_expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
+	}
+}
+
+function articles_save($id = false)
+{
+    global $_CLASS;
+    
+	if ($id)
+	{
+		$result = $_CLASS['core_db']->query('SELECT articles_id FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '. $id);
+		$articles = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$articles)
+		{
+			redirect(generate_link('articles', array('admin' => true)));
+		}
+
+		// need to validate data with the db type
+		articles_get_data($data, $error);
+
+		if ($error)
+		{
+			return articles_edit($id, $data, $error);
+		}
+
+		$sql = 'UPDATE ' . ARTICLES_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE articles_id = '.$id;
+
+		$_CLASS['core_db']->query($sql);
+	}
+	else
+	{
+		articles_get_data($data, $error);
+
+		if ($error)
+		{
+			return articles_edit(false, $data, $error);
+		}
+
+		$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE);
+		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$data['articles_order'] = (int) $max_order + 1;
+		$data['articles_posted'] = (int) $_CLASS['core_user']->time;
+		$data['articles_type'] = 1;
+
+		$data['poster_id'] = $_CLASS['core_user']->data['user_id'];
+		$data['poster_ip'] = $_CLASS['core_user']->ip;
+		$data['poster_name'] = $_CLASS['core_user']->data['username'];
+
+		$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
+	}
+
+	$_CLASS['core_display']->meta_refresh('3', generate_link('articles', array('admin' => true)));
+	trigger_error(sprintf($_CLASS['core_user']->lang['SAVED'], generate_link('articles', array('admin' => true))));	
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/modules/articles/index.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -78,10 +78,11 @@
 }
 
 $start = get_variable('start', 'GET', false, 'int');
+$collapable_holding = array();
+$expire_updated = false;
 $limit = 10;
-$collapable_holding = array();
 
-$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order DESC';
+$sql = 'SELECT * FROM '.  ARTICLES_TABLE .' WHERE articles_status = ' . STATUS_ACTIVE . ' ORDER BY articles_order ASC';
 $result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -91,6 +92,19 @@
 	{
 		continue;
 	}
+	
+	if ($row['articles_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $row['articles_expires']))
+	{
+		$_CLASS['core_db']->query('UPDATE '.ARTICLES_TABLE.' SET articles_status = ' . STATUS_DISABLED . ' WHERE articles_expires > 0 AND articles_expires <= ' . $_CLASS['core_user']->time);
+		$expire_updated = true;
+
+		continue;
+	}
+
+	if ($row['articles_starts'] && ($row['articles_starts'] > $_CLASS['core_user']->time))
+	{
+		continue;
+	}
 
 	$_CLASS['core_template']->assign_vars_array('articles', array(
 		'poster' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),

Modified: cms/trunk/modules/articles/install.php
===================================================================
--- cms/trunk/modules/articles/install.php	2005-09-08 04:34:17 UTC (rev 103)
+++ cms/trunk/modules/articles/install.php	2005-09-09 01:19:33 UTC (rev 104)
@@ -46,13 +46,13 @@
 		$_CLASS['core_db']->add_table_field_int('articles_id', array('max' => 16000000, 'auto_increment' => true));
 		$_CLASS['core_db']->add_table_field_char('articles_title', 80);
 		$_CLASS['core_db']->add_table_field_int('articles_posted', array('max' => 200000000));
-		$_CLASS['core_db']->add_table_field_int('articles_start', array('max' => 200000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_starts', array('max' => 200000000, 'null' => true));
 		$_CLASS['core_db']->add_table_field_int('articles_expires', array('max' => 200000000, 'null' => true));
 		$_CLASS['core_db']->add_table_field_text('articles_intro', 60000, true);
 		$_CLASS['core_db']->add_table_field_text('articles_text', 10000000);
 		$_CLASS['core_db']->add_table_field_text('articles_notes', 60000, true);
 
-		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000, 'null' => true));
+		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000));
 		$_CLASS['core_db']->add_table_field_int('articles_type', array('max' => 10));
 		$_CLASS['core_db']->add_table_field_int('articles_status', array('max' => 10));
 		$_CLASS['core_db']->add_table_field_text('articles_auth', 60000, true);
@@ -76,6 +76,7 @@
 			'articles_title'	=> 'Welcome Post',
 			'articles_posted'	=> (int) $_CLASS['core_user']->time,
 			'articles_text'		=> '<p align="center">I need something snappy here</p>',
+			'articles_order'	=> 1,
 			'articles_type'		=> 1,
 			'articles_status'	=> STATUS_ACTIVE,
 			'poster_id'			=> 0,



From viperal at berlios.de  Fri Sep  9 03:32:22 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 9 Sep 2005 03:32:22 +0200
Subject: [Viperals-svncheckins] r105 - in cms/branches/1.0alpha1: includes/templates/admin includes/templates/admin/articles modules/articles modules/articles/admin
Message-ID: <200509090132.j891WMOb020123@sheep.berlios.de>

Author: viperal
Date: 2005-09-09 03:31:49 +0200 (Fri, 09 Sep 2005)
New Revision: 105

Added:
   cms/branches/1.0alpha1/includes/templates/admin/articles/
   cms/branches/1.0alpha1/includes/templates/admin/articles/edit.html
   cms/branches/1.0alpha1/includes/templates/admin/articles/index.html
   cms/branches/1.0alpha1/modules/articles/admin/
   cms/branches/1.0alpha1/modules/articles/admin/index.php
Log:


Added: cms/branches/1.0alpha1/includes/templates/admin/articles/edit.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/admin/articles/edit.html	2005-09-09 01:19:33 UTC (rev 104)
+++ cms/branches/1.0alpha1/includes/templates/admin/articles/edit.html	2005-09-09 01:31:49 UTC (rev 105)
@@ -0,0 +1,114 @@
+<!-- DISPLAY_HEADER -->
+
+<style type="text/css">@import url(javascript/jscalendar/skins/aqua/theme.css);</style>
+<script type="text/javascript" src="javascript/jscalendar/calendar.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/calendar-setup.js"></script>
+<script type="text/javascript" src="javascript/jscalendar/lang/calendar-en.js"></script>
+
+{ $A_TABLE_OPEN }
+
+<form action="{ $B_ACTION }" name="message" method="post">
+	<table class="tablebg" align="center" cellpadding="4" cellspacing="1" width="100%">
+		<tbody>
+			<!-- IF { $B_ERROR } -->
+			<tr> 
+				<td class="row2" align="center" colspan="3">
+					<font class="error">{ $B_ERROR }</font>
+				</td>
+			</tr>
+			<!-- ENDIF -->
+
+			<tr> 
+				<th colspan="3" height="28" valign="middle">{ $B_TITLE }</th>
+			</tr>
+		
+			<tr> 
+				<td class="row1" width="20%"><b class="genmed">{ $L_TITLE }: </b></td>
+		
+				<td class="row2" colspan="2"><input class="post" name="title" size="50" maxlength="100" value="{ $B_TITLE }" type="text"><!-- IF { $B_DELETE_LINK } --> <br/> <a href="{ $B_DELETE_LINK }">{ $L_DELETE_THIS }</a> <!-- ENDIF --></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_ACTIVE }: </b></td>
+				<td class="row2" colspan="2"><input name="active" value="2" <!-- IF { $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_YES }&nbsp;&nbsp;<input name="active" value="0" <!-- IF !{ $B_ACTIVE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_STARTS }: </b></td>
+				<td class="row2" >
+					<input class="post" id="starts" name="starts" size="35" maxlength="100" value="{ $B_STARTS }" type="text">
+					<img src="images/calender_small.png" style="cursor: pointer;" id="starts_trigger"/>
+				</td>
+				<td class="row1" align="center" rowspan="2"><b class="genmed">Current Server Time:<br/>{ $B_CURRENT_TIME }: </b></td>
+			</tr>
+			<tr> 
+				<td class="row1"><b class="genmed">{ $L_EXPIRES }: </b></td>
+				<td class="row2">
+					<input class="post" id="expires" name="expires" size="35" maxlength="100" value="{ $B_EXPIRES }" type="text" />
+					<img src="images/calender_small.png" style="cursor: pointer;"  id="expires_trigger" />
+				</td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_MESSAGE }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="text" id="text" editor_enabled="true" style="width:90%; height:400px;" cols="63" rows="15">{ $B_TEXT }</textarea><br /><br /></td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_INTRO_MESSAGE }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="intro" id="intro" editor_enabled="true" style="width:90%; height:200px;" cols="63" rows="15">{ $B_INTRO }</textarea><br /><br /></td>
+			</tr>
+			<tr> 
+				<td class="row1" valign="top" ><b class="genmed">{ $L_ADMIN_NOTES }: </b></td>
+				<td class="row2" colspan="2"><div id="message_preview" style="display: none; padding:5px"></div>
+				<textarea name="notes" id="notes" editor_enabled="false" style="width:90%; height:150px;" cols="63" rows="15">{ $B_NOTES }</textarea><br /><br /></td>
+			</tr>
+			<tr>
+				<td class="cat" colspan="3" align="center" height="28">
+					<input type="hidden" name="update" value="{ $B_BID }">
+					<!-- <input class="btnmain" id="preview_fast" value="{ $L_PREVIEW }" type="button" onclick="fast_preview(); return false;"> -->
+					<input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;&nbsp;<input class="btnlite" value="Reset" name="reset" type="reset">
+				</td>
+			</tr>
+		</tbody>
+	</table>
+</form>
+
+{ $A_TABLE_CLOSE }
+
+<script type="text/javascript">
+
+function fast_preview()
+{
+	if(document.getElementById('preview_fast').value == '{ $L_PREVIEW }')
+	{
+		document.getElementById('preview_fast').value = 'Edit';
+		document.getElementById('message_preview').innerHTML = document.getElementById('content').value;
+		document.getElementById('message_preview').style.display = '';
+		document.getElementById('content').style.display = 'none';
+
+	}
+	else
+	{
+		document.getElementById('preview_fast').value = '{ $L_PREVIEW }';
+		document.getElementById('message_preview').innerHTML = '';
+		document.getElementById('message_preview').style.display = 'none';
+		document.getElementById('content').style.display = '';
+	}
+}
+
+  Calendar.setup(
+    {
+      inputField  : "starts",         // ID of the input field
+      button      : "starts_trigger"       // ID of the button
+    }
+  );
+</script>
+<script type="text/javascript">
+  Calendar.setup(
+    {
+      inputField  : "expires",         // ID of the input field
+      button      : "expires_trigger"       // ID of the button
+    }
+  );
+</script>
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/branches/1.0alpha1/includes/templates/admin/articles/index.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/admin/articles/index.html	2005-09-09 01:19:33 UTC (rev 104)
+++ cms/branches/1.0alpha1/includes/templates/admin/articles/index.html	2005-09-09 01:31:49 UTC (rev 105)
@@ -0,0 +1,110 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+    <tbody>
+		<tr>
+			<th align="center" width="25%">{$L_TITLE}</th>
+			<th align="center" colspan="2">{ $L_ORDER }</th>
+			<th align="center">{ $L_STATUS }</th>
+			<th align="center">{ $L_FUNCTIONS }</th>
+		</tr>
+    <!-- IF isset({ $top_admin_messages }) -->
+    	<tr>
+			<td class="cat" colspan="8"><b class="gensmall">{ $L_TOP_MESSAGES }</b></td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- LOOP $top_admin_messages -->
+		<tr>
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:EDIT_LINK }'; return false;">
+				<a href="{ $top_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $top_admin_messages:TITLE }</a><br />
+				<!-- IF { $top_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $top_admin_messages:STARTS }<!-- ENDIF -->
+				<!-- IF { $top_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $top_admin_messages:EXPIRES }<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center" >
+				<!-- IF { $top_admin_messages:ORDER_UP } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center">
+				<!-- IF { $top_admin_messages:ORDER_DOWN } -->
+				<a href="{ $top_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $top_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $top_admin_messages:ACTIVE_LINK }'; return false;">
+				<a href="{ $top_admin_messages:ACTIVE_LINK }">{ $top_admin_messages:CHANGE }</a>
+			</td>
+			<td class="row1" align="center">
+			<!-- IF { $top_admin_messages:EDIT_LINK } -->
+				<a href="{ $top_admin_messages:EDIT_LINK }">{ $L_EDIT }</a> |
+			<!-- ENDIF -->
+			<a href="{ $top_admin_messages:AUTH_LINK }">{ $L_PERMISSIONS }</a>
+			<!-- IF { $top_admin_messages:DELETE_LINK } -->
+				 | <a href="{ $top_admin_messages:DELETE_LINK }">{ $L_DELETE }</a>
+			<!-- ENDIF --> </td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- ENDLOOP $top_admin_messages -->
+	<!-- ENDIF -->
+
+	<!-- IF isset({ $bottom_admin_messages }) -->
+    	<tr>
+			<td class="cat" colspan="8"><b class="gensmall">{ $L_BOTTOM_MESSAGES }</b></td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- LOOP $bottom_admin_messages -->
+		<tr>
+			<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:EDIT_LINK }'; return false;">
+				<a href="{ $bottom_admin_messages:EDIT_LINK }" title="{ $L_EDIT }">{ $bottom_admin_messages:TITLE }</a><br />
+				<!-- IF { $bottom_admin_messages:STARTS } --><br /><b>{ $L_STARTS }: </b>{ $bottom_admin_messages:STARTS }<!-- ENDIF -->
+				<!-- IF { $bottom_admin_messages:EXPIRES } --><br /><b>{ $L_EXPIRES }: </b>{ $bottom_admin_messages:EXPIRES }<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center" >
+				<!-- IF { $bottom_admin_messages:ORDER_UP } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_UP }"><img src="images/1uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_TOP }"><img src="images/2uparrow.png" alt="{ $L_MOVE_UP }" title="{ $L_MOVE_UP }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center">
+				<!-- IF { $bottom_admin_messages:ORDER_DOWN } -->
+				<a href="{ $bottom_admin_messages:LINK_ORDER_DOWN }"><img src="images/1downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>&nbsp;
+				<a href="{ $bottom_admin_messages:LINK_ORDER_BOTTOM }"><img src="images/2downarrow.png" alt="{ $L_MOVE_DOWN }" title="{ $L_MOVE_DOWN }" border="0"></a>
+				<!-- ENDIF -->
+			</td>
+			<td class="row1" align="center"  onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $bottom_admin_messages:ACTIVE_LINK }'; return false;">
+				<a href="{ $bottom_admin_messages:ACTIVE_LINK }">{ $bottom_admin_messages:CHANGE }</a>
+			</td>
+			<td class="row1" align="center">
+			<!-- IF { $bottom_admin_messages:EDIT_LINK } -->
+			<a href="{ $bottom_admin_messages:EDIT_LINK }">{ $L_EDIT }</a> |
+			<!-- ENDIF -->
+			<a href="{ $bottom_admin_messages:AUTH_LINK }">{ $L_PERMISSIONS }</a>
+			<!-- IF { $bottom_admin_messages:DELETE_LINK } -->
+				| <a href="{ $bottom_admin_messages:DELETE_LINK }">{ $L_DELETE }</a>
+			<!-- ENDIF --> </td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="8" height="7"></td>
+		</tr>
+	<!-- ENDLOOP $bottom_admin_messages -->
+	<!-- ENDIF -->
+	 		  <tr>
+			<td class="cat" colspan="8">
+				<form action="{ $LINK_ADD }" method="post"><input class="button" value="{ $L_ADD_NEW }" name="regular" type="submit" /></form>
+			</td>
+		  </tr>
+  </tbody>
+</table>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/branches/1.0alpha1/modules/articles/admin/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/admin/index.php	2005-09-09 01:19:33 UTC (rev 104)
+++ cms/branches/1.0alpha1/modules/articles/admin/index.php	2005-09-09 01:31:49 UTC (rev 105)
@@ -0,0 +1,396 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+if (!defined('ARTICLES_TABLE'))
+{
+	define('ARTICLES_TABLE', $prefix.'articles');
+}
+
+if (isset($_REQUEST['mode']))
+{
+	if ($id = get_variable('id', 'GET', false, 'int'))
+	{
+		switch ($_REQUEST['mode'])
+		{
+			case 'change':
+				$result = $_CLASS['core_db']->query('SELECT articles_status FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+				
+				$status = ($article['articles_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+				$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . " SET articles_status = $status WHERE articles_id = $id");
+			break;
+			
+			case 'delete':
+				$result = $_CLASS['core_db']->query('SELECT articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_id='.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+			
+				if (display_confirmation())
+				{
+					$_CLASS['core_db']->query('DELETE from ' . ARTICLES_TABLE . ' where articles_id = '.$id);
+					$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_order > ' . $article['articles_order']);
+				}
+			break;
+
+			case 'auth':
+				$result = $_CLASS['core_db']->query('SELECT articles_auth FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '.$id);
+				$article = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+				
+				if (!$article)
+				{
+					trigger_error('articles_NOT_FOUND');
+				}
+				
+				$article['articles_auth'] = ($article['articles_auth']) ? unserialize($article['articles_auth']) : '';
+				
+				$_CLASS['core_display']->display_header();
+
+				$auth = $_CLASS['core_auth']->generate_auth_options($article['articles_auth']);
+
+				if ($auth !== false)
+				{
+					if (is_null($auth))
+					{
+						$article['articles_auth'] = '';
+						$auth = 'null';
+					}
+					else
+					{
+						$article['articles_auth'] = $auth;
+						$auth = "'".$_CLASS['core_db']->escape(serialize($auth))."'";
+					}
+			
+					$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . " SET articles_auth = $auth WHERE articles_id = $id");
+				}
+
+				$_CLASS['core_display']->display_footer();
+			break;
+
+			case 'order':
+				$option = get_variable('option', 'GET', false);
+			
+				if (!$option || !in_array($option, array('down', 'up', 'bottom', 'top')))
+				{
+					break;
+				}
+
+				$result = $_CLASS['core_db']->query('SELECT articles_type, articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_id= ' . $id);
+				$articles = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+			
+				if (!$articles)
+				{
+					trigger_error('ARTICLE_NOT_FOUND');
+				}
+
+				settype($articles['articles_order'], 'integer');
+
+				switch ($option)
+				{
+					case 'down':
+						$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_type='.$articles['articles_type']);
+						list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+						$_CLASS['core_db']->free_result($result);
+			
+						if ($articles['articles_order'] < $max_order)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type = '.$articles['articles_type'].' AND articles_order='.($articles['articles_order'] + 1));
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.($articles['articles_order'] + 1).' WHERE articles_id ='. $id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'bottom':
+						$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE . ' WHERE articles_type='.$articles['articles_type']);
+						list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+						$_CLASS['core_db']->free_result($result);
+			
+						if ($articles['articles_order'] < $max_order)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type='.$articles['articles_type'].' AND articles_order > '.$articles['articles_order']);
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.$max_order.' WHERE articles_id = '.$id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'up':
+						if ($articles['articles_order'] && $articles['articles_order'] != 1)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order = '.($articles['articles_order'] - 1));
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order='.($articles['articles_order'] -1 ).' WHERE articles_id ='. $id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+			
+					case 'top':
+
+						if ($articles['articles_order'] != 1)
+						{
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order < '.$articles['articles_order']);
+							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = 1 WHERE articles_id = '.$id);
+			
+							$_CLASS['core_cache']->destroy('articless');
+						}
+					break;
+				}
+			break;
+
+			case 'edit':
+				articles_edit($id);
+			break;
+		}
+	}
+
+	switch ($_REQUEST['mode'])
+	{
+		case 'add':
+			articles_edit(false);
+		break;
+		   
+		case 'save':
+			articles_save($id);
+		break;
+	}
+}
+
+// temp
+$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE);
+list($count) = $_CLASS['core_db']->fetch_row_num($result);
+$_CLASS['core_db']->free_result($result);
+
+$result = $_CLASS['core_db']->query('SELECT articles_id, articles_title, articles_starts, articles_order, articles_expires, articles_status
+										FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC');
+
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$_CLASS['core_template']->assign_vars_array('top_admin_messages', array(
+		'ACTIVE'		=> ($row['articles_status']) ? true : false,
+		'CHANGE'		=> ($row['articles_status']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE'],
+
+		'AUTH_LINK'		=> generate_link('articles&amp;mode=auth&amp;id='.$row['articles_id'], array('admin' => true)),
+		'ACTIVE_LINK'	=> generate_link('articles&amp;mode=change&amp;id='.$row['articles_id'], array('admin' => true)),
+		'VIEW_LINK' 	=> generate_link('articles&amp;mode=show&amp;id='.$row['articles_id'], array('admin' => true)),
+		'EDIT_LINK'		=> generate_link('articles&amp;mode=edit&amp;id='.$row['articles_id'], array('admin' => true)),
+		'DELETE_LINK' 	=> generate_link('articles&amp;mode=delete&amp;id='.$row['articles_id'], array('admin' => true)),
+
+		'EXPIRES'		=> ($row['articles_expires']) ? $_CLASS['core_user']->format_date($row['articles_expires']) : false,
+		'STARTS'		=> ($row['articles_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['articles_starts']) : false,
+		'TITLE'			=> $row['articles_title'],
+
+		'ORDER_DOWN' 		=> ($row['articles_order'] < $count),
+		'ORDER_UP'			=> ($row['articles_order'] > 1),
+
+		'LINK_ORDER_UP' 	=> generate_link('articles&amp;mode=order&amp;option=up&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_TOP' 	=> generate_link('articles&amp;mode=order&amp;option=top&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_DOWN'	=> generate_link('articles&amp;mode=order&amp;option=down&amp;id='.$row['articles_id'], array('admin' => true)),
+		'LINK_ORDER_BOTTOM'	=> generate_link('articles&amp;mode=order&amp;option=bottom&amp;id='.$row['articles_id'], array('admin' => true)),
+	));
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'LINK_ADD'			=> generate_link('articles&amp;mode=add', array('admin' => true))
+));
+
+$_CLASS['core_db']->free_result($result);
+
+$_CLASS['core_display']->display(false, 'admin/articles/index.html');
+
+script_close();
+
+function articles_edit($id = false, $article = false, $error = false)
+{
+    global $_CLASS;
+
+	if ($id)
+	{
+		$result = $_CLASS['core_db']->query('SELECT * FROM ' . ARTICLES_TABLE . ' WHERE articles_id = ' . $id);
+		$article = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		
+		if (!$article)
+		{
+			redirect(generate_link('articles', array('admin' => true)));
+		}
+		
+		if (isset($_POST['submit']))
+		{
+			// need to re-validate data with the db type
+			articles_get_data($articles_post, $error);
+			$article = array_merge($article, $articles_post);
+		}
+
+		unset($articles_post);
+	}
+	
+	$_CLASS['core_template']->assign_array(array(
+		'B_TITLE'			=> $article['articles_title'],
+		'B_TEXT'			=> $article['articles_text'],
+		'B_INTRO'			=> $article['articles_intro'],
+		'B_NOTES'			=> $article['articles_notes'],
+
+		'B_ACTIVE'			=> $article['articles_status'],
+		'B_EXPIRES'			=> is_numeric($article['articles_expires']) ? $_CLASS['core_user']->format_date($article['articles_expires'], 'M d, Y h:i a') : $article['articles_expires'],
+		'B_ERROR'			=> $error,
+		'B_STARTS'			=> is_numeric($article['articles_starts']) ? $_CLASS['core_user']->format_date($article['articles_starts'], 'M d, Y h:i a') : $article['articles_starts'],
+		'B_DELETE_LINK'		=> ($id) ? generate_link('articles&amp;mode=delete&amp;id='.$id, array('admin' => true)) : false,
+		'B_ACTION'			=> generate_link('articles&amp;mode=save'.(($id) ? '&amp;id='.$id : ''), array('admin' => true)),
+		'B_CURRENT_TIME'=> $_CLASS['core_user']->format_date($_CLASS['core_user']->time)
+	));
+	
+	$_CLASS['core_template']->display('admin/articles/edit.html');
+}
+
+function articles_get_data(&$data, &$error)
+{
+	global $_CLASS;
+	
+	$error = '';
+	$data = array();
+
+	if (!isset($_POST['submit']))
+	{
+		return;
+	}
+
+	$data['articles_title'] = get_variable('title', 'POST', '');
+	$data['articles_text'] = get_variable('text', 'POST', '');
+
+	foreach ($data as $field => $value)
+	{
+		if (!$value)
+		{
+			$error .= $_CLASS['core_user']->get_lang('ERROR_'.$field).'<br />';
+		}
+	}
+
+	$data['articles_intro'] = get_variable('intro', 'POST', '');
+	$data['articles_notes'] = get_variable('notes', 'POST', '');
+
+	$data['articles_status']	= (get_variable('active', 'POST', STATUS_DISABLED, 'int') === STATUS_DISABLED) ? STATUS_DISABLED : STATUS_ACTIVE;
+	$data['articles_expires']	= get_variable('expires', 'POST', 0);
+	$data['articles_starts']	= get_variable('starts', 'POST', '');
+
+	$start = $expires = '';
+
+	if ($data['articles_starts'])
+	{
+		$start = strtotime($data['articles_starts']);
+
+		if (!$start || $start == -1)
+		{
+			$error .= $_CLASS['core_user']->lang['ERROR_START_TIME'].'<br />';
+		}
+	}
+
+	if ($data['articles_expires'])
+	{
+		$expires = strtotime($data['articles_expires']);
+
+		if (!$expires || $expires == -1)
+		{
+			$error .= $_CLASS['core_user']->lang['ERROR_END_TIME'].'<br />';
+		}
+	}
+	
+	if (!$error)
+	{
+		$data['articles_starts'] = ($start) ? $_CLASS['core_user']->time_convert($start, 'gmt') : 0;
+		$data['articles_expires'] = ($expires) ? $_CLASS['core_user']->time_convert($expires, 'gmt') : 0;
+	}
+}
+
+function articles_save($id = false)
+{
+    global $_CLASS;
+    
+	if ($id)
+	{
+		$result = $_CLASS['core_db']->query('SELECT articles_id FROM ' . ARTICLES_TABLE . ' WHERE articles_id = '. $id);
+		$articles = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$articles)
+		{
+			redirect(generate_link('articles', array('admin' => true)));
+		}
+
+		// need to validate data with the db type
+		articles_get_data($data, $error);
+
+		if ($error)
+		{
+			return articles_edit($id, $data, $error);
+		}
+
+		$sql = 'UPDATE ' . ARTICLES_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $data) .'  WHERE articles_id = '.$id;
+
+		$_CLASS['core_db']->query($sql);
+	}
+	else
+	{
+		articles_get_data($data, $error);
+
+		if ($error)
+		{
+			return articles_edit(false, $data, $error);
+		}
+
+		$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE);
+		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$data['articles_order'] = (int) $max_order + 1;
+		$data['articles_posted'] = (int) $_CLASS['core_user']->time;
+		$data['articles_type'] = 1;
+
+		$data['poster_id'] = $_CLASS['core_user']->data['user_id'];
+		$data['poster_ip'] = $_CLASS['core_user']->ip;
+		$data['poster_name'] = $_CLASS['core_user']->data['username'];
+
+		$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
+	}
+
+	$_CLASS['core_display']->meta_refresh('3', generate_link('articles', array('admin' => true)));
+	trigger_error(sprintf($_CLASS['core_user']->lang['SAVED'], generate_link('articles', array('admin' => true))));	
+}
+
+?>
\ No newline at end of file



From viperal at berlios.de  Fri Sep  9 18:05:51 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 9 Sep 2005 18:05:51 +0200
Subject: [Viperals-svncheckins] r106 - in cms/trunk: includes/templates includes/templates/installer install
Message-ID: <200509091605.j89G5pBk027067@sheep.berlios.de>

Author: viperal
Date: 2005-09-09 18:05:50 +0200 (Fri, 09 Sep 2005)
New Revision: 106

Added:
   cms/trunk/includes/templates/installer/
   cms/trunk/includes/templates/installer/agreement.html
   cms/trunk/includes/templates/installer/stage1.html
Modified:
   cms/trunk/install/installer.php
Log:


Added: cms/trunk/includes/templates/installer/agreement.html
===================================================================
--- cms/trunk/includes/templates/installer/agreement.html	2005-09-09 01:31:49 UTC (rev 105)
+++ cms/trunk/includes/templates/installer/agreement.html	2005-09-09 16:05:50 UTC (rev 106)
@@ -0,0 +1,113 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th style="text-align: center;">Agreement</th>
+						</tr>
+						<tr>
+							<td class="row1">
+								<p>
+									Because the program is licensed free of charge, there is <b>NO WARRANTY
+								FOR THE PROGRAM</b>, to the extent permitted by applicable law.  except when
+								otherwise stated in writing the copyright holders and/or other parties
+								provide the program "as is" without warranty of any kind, either expressed
+								or implied, including, but not limited to, the implied warranties of
+								merchantability and fitness for a particular purpose.  the entire risk as
+								to the quality and performance of the program is with you.  should the
+								program prove defective, you assume the cost of all necessary servicing,
+								repair or correction.</p>
+								<p>
+									<b>Please note</b>, that while most of this program is mostly licensed under <a href="http://www.gnu.org/licenses/gpl.txt">GNU GPL</a> . It <b>does</b> include a few non GNU GPL licenses, your take responsibly  for looking at each file and/or folder for the it license and following it to it extent. 
+									<br/><br/>None of these license hinders free redistribution, nor use of this software for individual or business related site</p>
+								<p>
+									<b>If you agree to these terms and those of all the distrubuted licenses, Please hit agree.</b></p>
+								<p>				
+							</td>
+						</tr>
+						<tr>
+							<th style="text-align: center;">
+								<input type="hidden" name="stage" value="1" />
+								<input type="submit" name="agreement_signed" value="I Agree" class="formfield" />
+							</th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Added: cms/trunk/includes/templates/installer/stage1.html
===================================================================
--- cms/trunk/includes/templates/installer/stage1.html	2005-09-09 01:31:49 UTC (rev 105)
+++ cms/trunk/includes/templates/installer/stage1.html	2005-09-09 16:05:50 UTC (rev 106)
@@ -0,0 +1,193 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+<script language="Javascript" type="text/javascript">
+<!--
+var old_value = 'all';
+
+function change_option(name)
+{
+	var area = document.getElementById(name);
+
+	if (!area)
+	{
+		if (old_value == 'all')
+		{
+			return;
+		}
+		else
+		{
+			name = 'all'
+			area = document.getElementById(name);
+		}
+	}
+
+	area.style.display = '';
+
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(name + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = '';
+		i += 1;
+	}
+
+	area = document.getElementById(old_value);
+	area.style.display = 'none';
+	
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(old_value + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = 'none';
+		i += 1;
+	}
+
+	old_value = name;
+}
+
+//-->
+</script>
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">Database Configuration</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Database type: </b></td>
+							<td class="row2"><select name="dbms" onchange="change_option(this.value);">{ $database_options }</select></td>
+						</tr>
+						<tr id="sqlite" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file" value="" type="text"></td>
+						</tr>
+						<tr id="sqlite_pdo" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file" value="" type="text"></td>
+						</tr>
+						<tr id="all">
+							<td class="row1" width="50%"><b>Database server hostname: </b></td>
+							<td class="row2"><input class="post" name="server" value="" type="text"></td>
+						</tr>
+						<tr id="all_1">
+							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="port" value="" type="text"></td>
+						</tr>
+						<tr id="all_2">
+							<td class="row1" width="50%"><b>Database name: </b></td>
+							<td class="row2"><input class="post" name="database" value="" type="text"></td>
+						</tr>
+						<tr id="all_3">
+							<td class="row1" width="50%"><b>Database username: </b></td>
+					
+							<td class="row2"><input class="post" name="username" value="" type="text"></td>
+						</tr>
+						<tr id="all_4">
+							<td class="row1" width="50%"><b>Database password: </b></td>
+							<td class="row2"><input class="post" name="password" value="" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
+							<td class="row2"><input class="post" name="table_prefix" value="cms_" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
+							<td class="row2"><input class="post" name="user_prefix" value="cms_" type="text"></td>
+						</tr>
+						<tr>
+							<input type="hidden" name="stage" value="1" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Continue" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/trunk/install/installer.php
===================================================================
--- cms/trunk/install/installer.php	2005-09-09 01:31:49 UTC (rev 105)
+++ cms/trunk/install/installer.php	2005-09-09 16:05:50 UTC (rev 106)
@@ -21,5 +21,131 @@
 $Id$
 */
 
-// LOL, MADE YOU LOOK
+error_reporting(E_ALL);
+
+//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
+$site_file_root = 'C:/Program Files/Apache Group/Apache2/cms/';
+
+if (!extension_loaded('mbstring'))
+{
+	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+}
+
+set_magic_quotes_runtime(0);
+mb_internal_encoding('UTF-8');
+
+define('STRIP_SLASHES', get_magic_quotes_gpc());
+
+// Remove registered globals
+if ((bool) ini_get('register_globals'))
+{
+	foreach ($_REQUEST as $var_name => $value)
+	{
+		unset($$var_name);
+	}
+}
+
+require_once($site_file_root.'includes/functions.php');
+require_once($site_file_root.'includes/display/template.php');
+
+load_class(false, 'core_template');
+
+$_REQUEST['stage'] = isset($_REQUEST['stage']) ? (int) $_REQUEST['stage'] : 0;
+
+if ($_REQUEST['stage'] && !$_POST['agreement_signed'])
+{
+	$_REQUEST['stage'] = 0;
+}
+
+Switch ($_REQUEST['stage'])
+{
+	case 1:
+		$holding_array = array(
+			'mysql'		=> array(
+				'lang'			=> 'MySQL',
+				'extension'		=> 'mysql', 
+			),
+			'mysql3'			=> array(
+				'lang'			=> 'MySQL3',
+				'extension'		=> 'mysql',
+			),
+			'mysqli'	=> array(
+				'lang'			=> 'MySQL 4.1.x',
+				'extension'		=> 'mysqli', 
+			),
+			'mssql'		=> array(
+				'lang'			=> 'MS SQL Server 7/2000',
+				'extension'		=> 'mssql', 
+			),
+			'postgres' => array(
+				'lang'			=> 'PostgreSQL',
+				'extension'		=> 'pgsql', 
+			),
+			'sqlite'		=> array(
+				'lang'			=> 'SQLite',
+				'extension'		=> 'sqlite', 
+			),
+			'sqlite_pdo'		=> array(
+				'lang'			=> 'SQLite 3 (PDO)',
+				'extension'		=> 'pdo_sqlite', 
+			)
+		);
+		
+		$database_array = array();
+		$database_options = '';
+
+		foreach ($holding_array as $name => $setting)
+		{
+			if (extension_loaded($setting['extension']))
+			{
+				$database_options .= '<option value="' . $name . '">' . $setting['lang'] . '</option>';
+				$database_array[$name] = $setting;
+			}
+		}
+
+		$php_config = array(
+			/*array(
+				'lang'	=> 'PHP version',
+				'recommended'	=> '4.2.3 +',
+				'current'		=> PHP_VERSION
+			),*/
+			array(
+				'lang'	=> 'Safe Mode',
+				'ini'	=> 'safe_mode',
+				'recommended'	=> false,
+				'current'		=> (bool) ini_get('safe_mode')
+			),
+			array(
+				'lang'	=> 'Magic Quotes GPC',
+				'ini'	=> 'magic_quotes_gpc',
+				'recommended'	=> false,
+				'current'		=> (bool) ini_get('magic_quotes_gpc')
+			),
+			array(
+				'lang'	=> 'Register Globals',
+				'ini'	=> 'register_globals',
+				'recommended'	=> false,
+				'current'		=> (bool) ini_get('register_globals')
+			),
+			array(
+				'lang'	=> 'Output Buffering',
+				'ini'	=> 'output_buffering',
+				'recommended'	=> false,
+				'current'		=> (bool) ini_get('output_buffering')
+			),
+		);
+
+		$_CLASS['core_template']->assign_array(array(
+			'database_options'	=> $database_options,
+			'php_config'		=> $php_config,
+		));
+		
+		$_CLASS['core_template']->display('installer/stage1.html');
+	break;
+
+	default:
+	case 0:
+		$_CLASS['core_template']->display('installer/agreement.html');
+	break;
+}
 ?>
\ No newline at end of file



From viperal at berlios.de  Sat Sep 10 16:40:34 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 10 Sep 2005 16:40:34 +0200
Subject: [Viperals-svncheckins] r107 - in cms: branches/1.0alpha1 branches/1.0alpha1/admin branches/1.0alpha1/blocks branches/1.0alpha1/includes branches/1.0alpha1/includes/db branches/1.0alpha1/includes/display branches/1.0alpha1/includes/templates branches/1.0alpha1/includes/templates/installer branches/1.0alpha1/install branches/1.0alpha1/modules/Quick_Message branches/1.0alpha1/modules/articles branches/1.0alpha1/modules/articles/admin trunk trunk/admin trunk/blocks trunk/includes trunk/includes/db trunk/includes/display trunk/includes/templates trunk/install trunk/modules/Quick_Message trunk/modules/articles trunk/modules/articles/admin
Message-ID: <200509101440.j8AEeYWn000905@sheep.berlios.de>

Author: viperal
Date: 2005-09-10 16:40:33 +0200 (Sat, 10 Sep 2005)
New Revision: 107

Added:
   cms/branches/1.0alpha1/includes/templates/installer/
   cms/branches/1.0alpha1/includes/templates/installer/agreement.html
   cms/branches/1.0alpha1/includes/templates/installer/complete.html
   cms/branches/1.0alpha1/includes/templates/installer/stage1.html
   cms/branches/1.0alpha1/includes/templates/installer/stage2.html
Removed:
   cms/branches/1.0alpha1/includes/db/mssql.php
Modified:
   cms/branches/1.0alpha1/admin/blocks.php
   cms/branches/1.0alpha1/admin/menu.php
   cms/branches/1.0alpha1/admin/messages.php
   cms/branches/1.0alpha1/blocks/block-Quick_Message.php
   cms/branches/1.0alpha1/config.php
   cms/branches/1.0alpha1/core.php
   cms/branches/1.0alpha1/error.php
   cms/branches/1.0alpha1/includes/db/mysql.php
   cms/branches/1.0alpha1/includes/db/mysql3.php
   cms/branches/1.0alpha1/includes/db/mysqli.php
   cms/branches/1.0alpha1/includes/db/postgres.php
   cms/branches/1.0alpha1/includes/db/sqlite.php
   cms/branches/1.0alpha1/includes/display/display.php
   cms/branches/1.0alpha1/includes/functions.php
   cms/branches/1.0alpha1/includes/tables.php
   cms/branches/1.0alpha1/includes/templates/login_admin.html
   cms/branches/1.0alpha1/install/build_data.php
   cms/branches/1.0alpha1/install/build_tables.php
   cms/branches/1.0alpha1/install/installer.php
   cms/branches/1.0alpha1/modules/Quick_Message/index.php
   cms/branches/1.0alpha1/modules/Quick_Message/install.php
   cms/branches/1.0alpha1/modules/articles/admin/index.php
   cms/branches/1.0alpha1/modules/articles/index.php
   cms/branches/1.0alpha1/modules/articles/install.php
   cms/trunk/admin/blocks.php
   cms/trunk/admin/menu.php
   cms/trunk/admin/messages.php
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/config.php
   cms/trunk/core.php
   cms/trunk/error.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysql3.php
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/db/sqlite.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/templates/login_admin.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/install/installer.php
   cms/trunk/modules/Quick_Message/index.php
   cms/trunk/modules/Quick_Message/install.php
   cms/trunk/modules/articles/admin/index.php
   cms/trunk/modules/articles/index.php
   cms/trunk/modules/articles/install.php
Log:
Completed installer
Updated everything else.


Modified: cms/branches/1.0alpha1/admin/blocks.php
===================================================================
--- cms/branches/1.0alpha1/admin/blocks.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/admin/blocks.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -143,7 +143,7 @@
 			'TITLE'			=> $block['block_title'],
 			'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['block_type']),
 
-			'EXPIRES'		=> ($block['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
+			'EXPIRES'		=> ($block['block_expires']) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
 			'STARTS'		=> ($block['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_starts']) : false,
 
 			'ORDER_DOWN' 	=> ($block['block_order'] < $weigth[$block['block_position']]),

Modified: cms/branches/1.0alpha1/admin/menu.php
===================================================================
--- cms/branches/1.0alpha1/admin/menu.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/admin/menu.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -42,6 +42,7 @@
 $menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MODULES'), 'link' => generate_link('modules', array('admin' => true)));
 $menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('modules', array('admin' => true)));
 $menu['modules'][] = '';
+$menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('ARTICLES'), 'link' => generate_link('articles', array('admin' => true)));
 
 $menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('FORUMS'), 'link' => generate_link('Forums', array('admin' => true)));
 $menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMIN_INDEX'), 'link' => generate_link('Forums', array('admin' => true)));

Modified: cms/branches/1.0alpha1/admin/messages.php
===================================================================
--- cms/branches/1.0alpha1/admin/messages.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/admin/messages.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -118,7 +118,7 @@
 		'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['block_id'], array('admin' => true)),
 		'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['block_id'], array('admin' => true)),
 
-		'EXPIRES'		=> ($row['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
+		'EXPIRES'		=> ($row['block_expires']) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
 		'STARTS'		=> ($row['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_starts']) : false,
 		'TITLE'			=> $row['block_title'],
 

Modified: cms/branches/1.0alpha1/blocks/block-Quick_Message.php
===================================================================
--- cms/branches/1.0alpha1/blocks/block-Quick_Message.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/blocks/block-Quick_Message.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,9 +26,11 @@
     die;
 }
 
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 global $prefix, $_CLASS, $_CORE_CONFIG;

Modified: cms/branches/1.0alpha1/config.php
===================================================================
--- cms/branches/1.0alpha1/config.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/config.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -1,101 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-// TEMP
-
-// do not modify!
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-//echo getenv('DOCUMENT_ROOT'); die;
-/*
-If (getenv('DOCUMENT_ROOT') != 'C:/Program Files/Apache Group/Apache2/htdocs')
-{
-    die('Your site shouldn\'t access this file');
-}
-*/
-
-$prefix = 'test_';
-$user_prefix = 'test_';
-
-/*
-$site_db['type']		= 'mysql';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'cms';
-$site_db['username']	= 'root';
-$site_db['password']	= '';
-$site_db['persistent']	= false;
-*/
-
-
-$site_db['type']		= 'postgres';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'cms';
-$site_db['username']	= 'postgres';
-$site_db['password']	= 'viper83';
-$site_db['persistent']	= false;
-
-
-/*
-$site_db['type']	= 'sqlite';
-$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester';
-$site_db['persistent']	= false;
-*/
-
-/*
-$site_db['type']	= 'sqlite_pdo';
-$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester_pdo';
-$site_db['persistent']	= false;
-
-*/
-
-/*
-NOT WORKING
-
-$site_db['type']		= 'mssql';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'tester';
-$site_db['username']	= '';
-$site_db['password']	= '';
-$site_db['persistent']	= false;
-*/
-
-//$acm_type = 'eaccelerator';
-$acm_type = 'file';
-
-if (!defined('INDEX_PAGE'))
-{
-	define('INDEX_PAGE', 'index.php');
-}
-
-if (!defined('ADMIN_PAGE'))
-{
-	define('ADMIN_PAGE', 'admin.php');
-}
-
-?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/core.php
===================================================================
--- cms/branches/1.0alpha1/core.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/core.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,7 +26,7 @@
     die;
 }
 
-error_reporting(E_ALL);
+error_reporting(0);
 //error_reporting(0);
 
 if (!extension_loaded('mbstring'))
@@ -38,7 +38,6 @@
 mb_internal_encoding('UTF-8');
 //mb_http_output('UTF-8');
 
-
 // Remove registered globals
 if ((bool) ini_get('register_globals'))
 {
@@ -82,7 +81,7 @@
 
 // Set error handler
 $_CLASS['core_error_handler']->start();
-$_CLASS['core_error_handler']->stop();
+//$_CLASS['core_error_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
 if (function_exists('register_shutdown_function'))
@@ -93,26 +92,6 @@
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 
-/*
-$_CLASS['core_db']->transaction();
-require($site_file_root.'install/build_tables.php');
-$_CLASS['core_db']->transaction('commit');
-die;
-*/
-
-
-/*
-$_CLASS['core_db']->transaction();
-require($site_file_root.'install/build_data.php');
-$_CLASS['core_db']->transaction('commit');
-die;
-*/
-
-/*
-	Progres need to be optimized after install :-(
-	$_CLASS['core_db']->optimize_tables();
-*/
-
 $_CLASS['core_db']->return_on_error = true;
 
 // Error messages just incase we can't get our configs

Modified: cms/branches/1.0alpha1/error.php
===================================================================
--- cms/branches/1.0alpha1/error.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/error.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -22,7 +22,7 @@
 }
 
 //echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
-$site_file_root = 'C:/apachefriends/xampp/cms/';
+$site_file_root = '';
 $lang = 'en';
 
 if (isset($_SERVER['HTTP_ACCEPT_LANGUAGE']))

Deleted: cms/branches/1.0alpha1/includes/db/mssql.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/mssql.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/mssql.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -1,693 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-class db_mssql
-{
-	var $link_identifier = false;
-	var $db_layer = 'mssql';
-
-	var $last_result;
-	var $return_on_error;
-	var $in_transaction;
-
-	var $queries_time = 0;
-	var $num_queries = 0;
-
-	var	$query_list = array();
-	var $query_details = array();
-	var $open_queries = array();
-
-	var $_indexs = array();
-	var $_fields = array();
-	var $_table_name = false;
-	
-	var $_limit_last_key = 0;
-	var $_limit_result = array();
-
-	function connect($db)
-	{		
-		if ($db['port'])
-		{
-			$db['server'] .= ':' . $port;
-		}
-
-		if ($this->link_identifier)
-		{
-			$this->disconnect();
-		}
-
-		$this->link_identifier = ($db['persistent']) ? mssql_pconnect($db['server'], $db['username'], $db['password']) : mssql_connect($db['server'], $db['username'], $db['password']);
-
-		if ($this->link_identifier)
-		{
-			if (mssql_select_db($db['database']))
-			{
-				return $this->link_identifier;
-			}
-
-			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
-		}
-
-		if (!$error)
-		{
-			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
-		}
-
-		$this->disconnect();
-
-		trigger_error($error, E_USER_ERROR);
-	}
-
-	function disconnect()
-	{
-		if (!$this->link_identifier)
-		{
-			return;
-		}
-
-		@mssql_close($this->link_identifier);
-		$this->link_identifier = false;
-	}
-
-	function sql_return_on_error($fail = false)
-	{
-		$this->return_on_error = $fail;
-	}
-
-	function transaction($option = 'start')
-	{
-		if (!$this->link_identifier)
-		{
-			return;
-		}
-
-		$result = false;
-
-		switch ($option)
-		{
-			case 'start':
-				if ($this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('BEGIN  TRANSACTION', $this->link_identifier);
-				$this->in_transaction = true;
-			break;
-
-			case 'commit':
-			
-				if (!$this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('COMMIT', $this->link_identifier);
-				
-				if (!$result)
-				{
-					mysql_query('ROLLBACK', $this->link_identifier);
-				}
-				
-				$this->in_transaction = false;
-			break;
-
-			case 'rollback':
-				if (!$this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('ROLLBACK', $this->link_identifier);
-				$this->in_transaction = false;
-			break;
-		}
-
-		return $result;
-	}
-
-	function query($query = false,  $backtrace = false)
-	{
-		if (!$query || !$this->link_identifier) 
-		{ 
-			return false; 
-		}
-
-		global $_CLASS, $site_file_root;
-			
-		$this->num_queries++;
-		$this->last_query = $query;
-
-		if (!$backtrace)
-		{
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-		}
-
-		$this->_debug('start', $backtrace);
-		$this->last_result = $this->sql_query($query);
-		$this->_debug('stop', $backtrace);
-
-		if ($this->last_result === false)
-		{
-			$this->_error($query, $backtrace);
-		}
-		elseif (strpos($query, 'SELECT') !== false)
-		{
-			$this->open_queries[(int) $this->last_result] = $this->last_result;
-		}
-
-		return $this->last_result;
-	}
-
-	function sql_query($query = false)
-	{
-		return mssql_query($query, $this->link_identifier);
-	}
-
-	function query_limit($query = false, $total = false, $offset = 0, $backtrace = false) 
-	{
-		if (!$query || !$total || !$this->link_identifier) 
-		{
-			// no need to check for query or link_id, it's checked in db::query()
-			return $this->query($query);; 
-		}
-
-		global $site_file_root;
-
-		if (!$backtrace)
-		{
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-		}
-
-		$query = substr(trim($query));
-		
-		if (!$offset)
-		{
-			return $this->query("SELECT TOP($total) $query");
-		}
-		
-		/*
-			Welcome to hell
-
-			We'll do two query and get the diffence in php to make sure things work right
-			Other why needs us to know the a unique feild/key or primary key
-		*/
-		
-		// here we go, get the all data up to the offset row. offset row = total need + offset
-		$result = $this->query('SELECT TOP('.$total + $offset.") $query");
-
-		// need to test dataseek, if it resets after the a fetch do mssql_next_result loop
-		if (!$result || !mssql_data_seek($offset))
-		{
-			$this->free_result($result);
-
-			return false;
-		}
-
-		/*
-			change mssql_data_seek to mssql_num_rows < $offset above if this is used
-			for ($i = 1; $i <= $offset; $i++)
-			{
-				mssql_next_result($result);
-			}
-		*/
-
-		// we fetch array so both assoc and num can be used, May change later on
-
-		$this->_limit_last_key ++;
-		$result_id = 'LIMIT_'.$this->_limit_last_key;
-		
-		while ($row = mssql_fetch_array($result))
-		{
-			$this->_limit_result[$result_id][] = $row;
-		}
-
-		return $result_id;
-	}
-
-	/*
-		Boy do I like this but it phpBB's, may have to do something similar
-	*/
-	function sql_build_array($query, $assoc_ary = false)
-	{
-		if (!is_array($assoc_ary))
-		{
-			return false;
-		}
-
-		$fields = array();
-		$values = array();
-
-		if ($query == 'INSERT')
-		{
-			foreach ($assoc_ary as $key => $var)
-			{
-				$fields[] = $key;
-
-				if (is_null($var))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_string($var))
-				{
-					$values[] = "'" . $this->escape($var) . "'";
-				}
-				else
-				{
-					$values[] = (is_bool($var)) ? intval($var) : $var;
-				}
-			}
-
-			$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		else if ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($assoc_ary as $key => $var)
-			{
-				if (is_null($var))
-				{
-					$values[] = "$key = NULL";
-				}
-				elseif (is_string($var))
-				{
-					$values[] = "$key = '" . $this->escape($var) . "'";
-				}
-				else
-				{
-					$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
-				}
-			}
-			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
-		}
-
-		return $query;
-	}
-
-	function num_rows($result = false)
-	{
-		if (!$result || !$this->link_identifier) 
-		{ 
-			return 0; 
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			return (empty($this->_limit_result[$result]) ? 0 : count($this->_limit_result[$result]));
-		}
-
-		return mssql_num_rows($result);
-	}
-
-	function affected_rows()
-	{
-		if (!$this->link_identifier)
-		{ 
-			return 0; 
-		}
-
-		$num = mssql_rows_affected($this->link_identifier);
-
-		// not sure what it returns one fail, test maybe ?
-		return (!$num || $num == -1) ? 0 : $num;
-	}
-
-	function fetch_row_assoc($result = false)
-	{
-		global $_CLASS;
-
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_assoc($result);
-	}
-
-	function fetch_row_num($result = false)
-	{
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_row($result);
-	}
-
-	function fetch_row_both($result = false)
-	{
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_array($result);
-	}
-	
-	function insert_id()
-	{
-		if (!$this->link_identifier)
-		{
-			return false;
-		}
-		
-		//@@IDENTITY
-		if ($result = mssql_query('SELECT SCOPE_IDENTITY() AS Identity', $this->db_connect_id))
-		{
-			$row = mssql_fetch_assoc($result);
-			mssql_free_result($result);
-		}
-
-		return (isset($row['Identity']) && !is_null($row['Identity'])) ? $row['Identity'] : false;
-	}
-
-	function free_result($result = false)
-	{
-		if ($result && strpos($result, 'LIMIT_') === 0)
-		{
-			if (isset($this->_limit_result[$result]))
-			{
-				unset($this->_limit_result[$result]);
-			}
-			return;
-		}
-
-		if (!$result || !isset($this->open_queries[(int) $result]) || !$this->link_identifier) 
-		{ 
-			return; 
-		}
-
-		unset($this->open_queries[(int) $result]);
-
-		@mssql_free_result($result);
-	}
-
-	function escape($text)
-	{
-		return str_replace("'", "''", str_replace('\\', '\\\\', $text));
-	}
-
-	function escape_array($value)
-	{
-		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
-	}
-		
-	function optimize_tables()
-	{
-
-	}
-
-	function version()
-	{
-		//add later, more important things to do
-		//@@VERSION
-	}
-
-	function _error($sql = '', $backtrace)
-	{
-		if ($this->return_on_error)
-		{
-			return;
-		}
-
-		// should we use the long error getting why ?
-		$message = '<u>SQL ERROR</u><br /><br />' . @mssql_get_last_message() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br />';
-
-		if ($this->in_transaction)
-		{
-			$this->transaction('rollback');
-		}
-		
-		trigger_error($message, E_USER_ERROR);
-	}
-
-	function _debug($mode, $backtrace)
-	{
-		global $_CLASS, $_CORE_CONFIG;
-		static $start_time;
-
-		if (!$this->link_identifier) 
-		{ 
-			return false; 
-		}
-
-		switch ($mode)
-		{
-			case 'start':
-				$this->query_details[$this->num_queries][] = '';
-
-				$start_time = explode(' ', microtime());
-				$start_time = $start_time[0] + $start_time[1];
-			break;
-
-			case 'stop':
-				global $site_file_root;
-
-				$end_time = explode(' ', microtime());
-				$end_time = $end_time[0] + $end_time[1];
-				$this->queries_time += $end_time - $start_time;
-
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
-				{
-					if ($this->last_result !== false)
-					{
-						$affected = false;
-
-						if (preg_match('/^(UPDATE|DELETE|REPLACE)/', $this->last_query))
-						{
-							$affected = $this->affected_rows($this->last_result);
-						}
-						
-						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'affected' => $affected, 'time' => ($end_time - $start_time));
-					}
-					else
-					{
-						// should we use the long error getting why ?
-						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'error'=> 1, 'errorcode' => mssql_get_last_message());
-					}
-				}
-			break;
-		}
-	}
-
-	/*
-		Table creation
-	*/
-	function table_create($option, $name = false)
-	{
-		switch ($option)
-		{
-			case 'start':
-				$this->_table_name = $name;
-				$this->_fields = $this->_indexs = array();
-			break;
-
-			case 'commit':
-			case 'return':
-				if (!$this->_table_name)
-				{
-					return;
-				}
-
-				$fields = implode(", \n", $this->_fields);
-				if ($indexs = implode(", \n", $this->_indexs))
-				{
-					$fields .= ", \n";
-				}
-				
-				//#MyTempTable -- local temp tables
-				//##MyTempTable -- Global temp tables
-
-				$table = 'CREATE TABLE ['.$this->_table_name."] ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
-				// Let users choose transaction safe InnoDB or MyISAM
-				// ENGINE=MyISAM
-				if ($option == 'return')
-				{
-					return $table;
-				}
-
-				$this->sql_query($table);
-
-			case 'cancel':
-				$this->_table_name = false;
-				$this->_fields = $this->_indexs = array();
-			break;
-		}
-	}
-
-//$name, $number_min, $number_max = false, $default = 0, $auto_increment = false
-	function add_table_field_int($name, $setting_sent)
-	{
-		$setting = array('default' => 0, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
-		$setting = array_merge($setting, $setting_sent);
-
-		$length = max(strlen($setting['min']), strlen($setting['max']));
-
-		if ($setting['min'] >= -0 && $setting['max'] <= 255)
-		{
-			// TINYINT UNSIGNED ( 0 to 255 )
-			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
-		{
-			// TINYINT ( -128 to 127 )
-			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
-		{
-			// SMALLINT UNSIGNED ( 0 to 65,535 )
-			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
-		{
-			// SMALLINT ( -32,768 to 32,767 )
-			$this->_fields[$name] =  "`$name` SMALLINT($length)";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
-		{
-			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
-			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
-		{
-			// MEDIUMINT ( -8,388,608 to 8,388,607 )
-			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
-		}
-		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
-		{
-			// INT ( -2,147,483,647 to 2,147,483,647 )
-			$this->_fields[$name] =  "`$name` INT($length)";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
-		{
-			// INT UNSIGNED ( 0 to 4,294,967,295 )
-			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
-		}
-
-		if ($auto_increment)
-		{
-			$this->_fields[$name] .= ' auto_increment';
-		}
-		else
-		{
-			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
-			$this->_fields[$name] .= " DEFAULT '".(int) $default."'";
-		}
-	}
-
-	function add_table_field_text($name, $characters = 60000, $null = false)
-	{
-		if ($characters <= 255)
-		{
-			// TINYTEXT 1 to 255 Characters
-			$this->_fields[$name] =  "`$name` TINYTEXT";
-		}
-		elseif ($characters <= 65535)
-		{
-			// TEXT 1 to 65535 Characters
-			$this->_fields[$name] =  "`$name` TEXT";
-		}
-		elseif ($characters <= 16777215)
-		{
-			// MEDIUMTEXT 1 to 16,777,215 Characters
-			$this->_fields[$name] =  "`$name` MEDIUMTEXT";
-		}
-		elseif ($characters <= 4294967295)
-		{
-			// LONGTEXT 1 to 4,294,967,295 Characters
-			$this->_fields[$name] =  "`$name` LONGTEXT";
-		}
-
-		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
-	}
-
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
-	{
-
-		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
-	}
-
-	function add_table_index($field, $type  = 'index', $index_name = false)
-	{
-		$index_name = ($index_name) ? $index_name : $field;
-
-		if (empty($this->_fields[$field]))
-		{
-			return;
-		}
-
-		switch ($type)
-		{
-			case 'index':
-			case 'unique':
-				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . "KEY `$index_name` (`$field`)";
-			break;
-
-			case 'primary':
-				$this->_indexs['primary'] = "PRIMARY KEY (`$field`)";
-			break;
-		}
-	}
-}
-
-?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/includes/db/mysql.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/mysql.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/mysql.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -41,11 +41,11 @@
 	var $_fields = array();
 	var $_table_name = false;
 
-	function connect($db)
+	function connect($db, $return = false)
 	{		
 		if ($db['port'])
 		{
-			$db['server'] .= ':' . $port;
+			$db['server'] .= ':' . $db['port'];
 		}
 
 		if ($this->link_identifier)
@@ -68,9 +68,14 @@
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
-		
-		if (!$error)
+
+		if (!$this->report_error)
 		{
+			return false;
+		}
+
+		if (!isset($error))
+		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 		}
 
@@ -179,7 +184,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -223,60 +228,67 @@
 	/*
 		Boy do I like this but it phpBB's, may have to do something similar
 	*/
-	function sql_build_array($query, $assoc_ary = false)
+	function sql_build_array($query, $array = false)
 	{
-		if (!is_array($assoc_ary))
+		if (!is_array($array))
 		{
 			return false;
 		}
 
-		$fields = array();
-		$values = array();
+		$_fields = $values = array();
 
 		if ($query == 'INSERT')
 		{
-			foreach ($assoc_ary as $key => $var)
+			foreach ($array as $key => $value)
 			{
-				$fields[] = $key;
+				$_fields[] = $key;
 
-				if (is_null($var))
+				if (is_numeric($value))
 				{
-					$values[] = 'NULL';
+					$values[] = $value;
 				}
-				elseif (is_string($var))
+				elseif (is_string($value))
 				{
-					$values[] = "'" . $this->escape($var) . "'";
+					$values[] = "'" . $this->escape($value) . "'";
 				}
-				else
+				elseif (is_null($value))
 				{
-					$values[] = (is_bool($var)) ? intval($var) : $var;
+					$values[] = 'NULL';
 				}
+				elseif (is_bool($value))
+				{
+					$values[] = ($value) ? 1 : 0;
+				}
 			}
 
-			$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
 		}
-		else if ($query == 'UPDATE' || $query == 'SELECT')
+		elseif ($query == 'UPDATE' || $query == 'SELECT')
 		{
 			$values = array();
-			foreach ($assoc_ary as $key => $var)
+			foreach ($array as $key => $value)
 			{
-				if (is_null($var))
+				if (is_numeric($value))
 				{
-					$values[] = "$key = NULL";
+					$values[] = $key.' = '.$value;
 				}
-				elseif (is_string($var))
+				elseif (is_string($value))
 				{
-					$values[] = "$key = '" . $this->escape($var) . "'";
+					$values[] = "$key = '" . $this->escape($value) . "'";
 				}
-				else
+				elseif (is_null($value))
 				{
-					$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
+					$values[] = "$key = NULL";
 				}
+				elseif (is_bool($value))
+				{
+					$values[] = $key.' = '.(($value) ? 1 : 0);
+				}
+
 			}
-			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+
+			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
 		}
-
-		return $query;
 	}
 
 	function num_rows($result = false)
@@ -393,7 +405,7 @@
 				}
 			}
 
-			$this->sql_freeresult($result);
+			$this->free_result($result);
 		}
 
 		if ($table)
@@ -412,14 +424,22 @@
 		return (($return_dbname) ? 'MySQL ' : '').mysql_get_server_info($this->link_identifier);
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysql_error(),
+				'code'		=> @mysql_errno()
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($this->last_query) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br /></td></tr></table>';
 
 		if ($this->in_transaction)
 		{
@@ -427,8 +447,6 @@
 		}
 
 		trigger_error($message, E_USER_ERROR);
-		
-		script_close(false);
 	}
 
 	function _debug($mode, $backtrace)
@@ -634,6 +652,7 @@
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
 
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 

Modified: cms/branches/1.0alpha1/includes/db/mysql3.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/mysql3.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/mysql3.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -64,7 +64,12 @@
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
-		
+
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		if (!isset($error))
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
@@ -125,7 +130,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -348,14 +353,22 @@
 		return (($return_dbname) ? 'MySQL ' : '').mysql_get_server_info($this->link_identifier);
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysql_error(),
+				'code'		=> @mysql_errno()
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br /></td></tr></table>';
 
 		if ($this->in_transaction)
 		{
@@ -572,7 +585,8 @@
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-		
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: cms/branches/1.0alpha1/includes/db/mysqli.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/mysqli.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/mysqli.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -27,7 +27,7 @@
 	var $db_layer = 'mysqli';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction;
 
 	var $queries_time = 0;
@@ -62,15 +62,19 @@
 				mysqli_query($this->link_identifier, 'SET NAMES utf8');
 
 				//mysqli_query($this->link_identifier, 'SET character_set_results = NULL');
-				//mysqli_set_charset($this->link_identifier, "utf8");
 
 				return $this->link_identifier;
 			}
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
+
+		if (!$this->report_error)
+		{
+			return false;
+		}
 		
-		if (!$error)
+		if (!isset($error))
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 		}
@@ -92,9 +96,9 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
 	function transaction($option = 'start', $auto_rollback = true)
@@ -181,9 +185,9 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
-		elseif (strpos($query, 'SELECT') === false)
+		elseif (strpos($query, 'SELECT') === 0)
 		{
 			$this->open_queries[(string) $this->last_result] = $this->last_result;
 		}
@@ -421,14 +425,22 @@
 		return mysqli_get_server_info($this->link_identifier);
 	}
 	
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysqli_error($this->link_identifier),
+				'code'		=> @mysqli_errno($this->link_identifier)
+			);
+		}
+
 		if ($this->return_on_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @mysqli_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $sql .'<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @mysqli_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $this->last_query .'<br />';
 
 		if ($this->in_transaction)
 		{
@@ -638,8 +650,9 @@
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		$index_name = $index_name ? $index_name : $field;
-		
+		$index_name = ($index_name) ? $index_name : $field;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: cms/branches/1.0alpha1/includes/db/postgres.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/postgres.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/postgres.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -75,24 +75,30 @@
 
 		$connection_string = implode(' ', $connection_string);
 
-
 		$this->link_identifier = ($db['persistent']) ? @pg_pconnect($connection_string) : @pg_connect($connection_string);
 
 		if ($this->link_identifier)
 		{
-			//pg_set_client_encoding($this->link_identifier, 'UNICODE');
-			//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
+			if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
+			{
+				pg_set_client_encoding($this->link_identifier, 'UNICODE');
+				//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
+				//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'UNICODE'"); SET NAMES 'UNICODE'
+			}
 
-			//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'value'"); SET NAMES 'value'
 			return $this->link_identifier;
 		}
 
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 
 		$this->disconnect();
+
 		trigger_error($error, E_USER_ERROR);
-
-		die;
 	}
 
 	function disconnect()
@@ -102,7 +108,7 @@
 			return;
 		}
 
-		@pg_close($this->link_identifier);
+		pg_close($this->link_identifier);
 		$this->link_identifier = false;
 	}
 
@@ -110,6 +116,7 @@
 	{
 		$this->report_error = ($report);
 	}
+
 	function transaction($option = 'start', $auto_rollback = true)
 	{
 		$result = false;
@@ -186,7 +193,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -329,7 +336,7 @@
 			return false;
 		}
 
-		return @pg_fetch_assoc($result);
+		return pg_fetch_assoc($result);
 	}
 
 	function fetch_row_num($result = false)
@@ -339,7 +346,7 @@
 			return false;
 		}
 
-		return @pg_fetch_row($result);
+		return pg_fetch_row($result);
 	}
 
 	function fetch_row_both($result = false)
@@ -349,12 +356,12 @@
 			return false;
 		}
 
-		return @pg_fetch_array($result);
+		return pg_fetch_array($result);
 	}
 
 	function insert_id($table, $column)
 	{
-		$oid = @pg_last_oid($this->last_result);
+		$oid = pg_last_oid($this->last_result);
 
 		/* 
 		Shouldn't be need, but incase they don't have oid support ( not sure why they wouldn't )
@@ -389,7 +396,7 @@
 
 		unset($this->open_queries[(int) $result]);
 
-		return @pg_free_result($result);
+		return pg_free_result($result);
 	}
 
 	function escape($text)
@@ -421,14 +428,22 @@
 		}
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @pg_last_error($this->link_identifier),
+				'code'		=> ''
+			);
+		}
+		
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @pg_last_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $sql .'<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @pg_last_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $this->last_query .'<br />';
 
 		if ($this->in_transaction)
 		{
@@ -490,14 +505,14 @@
 				{
 					if (strpos('SELECT', $this->last_query) === 0)
 					{
-						if ($result = @pg_query($this->link_identifier, 'EXPLAIN '.$this->last_query))
+						if ($result = pg_query($this->link_identifier, 'EXPLAIN '.$this->last_query))
 						{
-							while ($row = @pg_fetch_assoc($result))
+							while ($row = pg_fetch_assoc($result))
 							{
 								$this->query_details[$this->num_queries][] = $row;
 							}
 
-							@pg_free_result($result);
+							pg_free_result($result);
 						}
 					}
 					else

Modified: cms/branches/1.0alpha1/includes/db/sqlite.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/sqlite.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/db/sqlite.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -172,7 +172,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -407,14 +407,24 @@
 		return (($return_dbname) ? 'SQLITE ' : '').sqlite_libversion();
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			$code = @sqlite_last_error($this->link_identifier);
+
+			return array(
+				'message'	=> @sqlite_error_string($code),
+				'code'		=> $code
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @sqlite_error_string(@sqlite_last_error($this->link_identifier)) . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @sqlite_error_string(@sqlite_last_error($this->link_identifier)) . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($this->last_query) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br />';
 
 		if ($this->in_transaction)
 		{

Modified: cms/branches/1.0alpha1/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha1/includes/display/display.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/display/display.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -181,7 +181,6 @@
 			'SITE_BASE'			=>	generate_base_url(),
 			'SITE_CHARSET'		=>	'UTF-8',
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
-			'SITE_URL'			=>	$_CORE_CONFIG['global']['site_url'],
 			'HEADER_MESSAGE'	=>	$this->message,
 			'HEADER_REGULAR'	=>	$this->header['meta'].$this->header['regular'],
 			'HEADER_JS' 		=>	$this->header['js'],

Modified: cms/branches/1.0alpha1/includes/functions.php
===================================================================
--- cms/branches/1.0alpha1/includes/functions.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/functions.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -803,6 +803,7 @@
 			@flock($fp, LOCK_UN);
 			fclose($fp);
 		}
+
 		return $bytes;
 	}
 }

Modified: cms/branches/1.0alpha1/includes/tables.php
===================================================================
--- cms/branches/1.0alpha1/includes/tables.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/tables.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -173,71 +173,71 @@
 
 // Table names
 
-define('FORUMS_ACL_TABLE', $prefix.'forums_auth');
-define('FORUMS_ACL_OPTIONS_TABLE', $prefix.'forums_auth_options');
-//define('ACL_DEPS_TABLE', $prefix.'forums_auth_deps');
-define('FORUMS_ACL_PRESETS_TABLE', $prefix.'forums_auth_presets');
+define('FORUMS_ACL_TABLE', $table_prefix.'forums_auth');
+define('FORUMS_ACL_OPTIONS_TABLE', $table_prefix.'forums_auth_options');
+//define('ACL_DEPS_TABLE', $table_prefix.'forums_auth_deps');
+define('FORUMS_ACL_PRESETS_TABLE', $table_prefix.'forums_auth_presets');
 
-define('FORUMS_ATTACHMENTS_TABLE', $prefix.'forums_attachments');
-define('FORUMS_BOOKMARKS_TABLE', $prefix.'forums_bookmarks');
-define('FORUMS_BBCODES_TABLE', $prefix.'forums_bbcodes');
-define('FORUMS_CONFIG_TABLE', $prefix.'forums_config');
-define('FORUMS_DRAFTS_TABLE', $prefix.'forums_drafts');
-define('FORUMS_FORUMS_TABLE', $prefix.'forums_forums');
-define('FORUMS_ACCESS_TABLE', $prefix.'forums_access');
-define('FORUMS_ICONS_TABLE', $prefix.'forums_icons');
-define('FORUMS_LOG_TABLE', $prefix.'forums_log');
-define('FORUMS_MODERATOR_TABLE', $prefix.'forums_moderator_cache');
-define('FORUMS_MODULES_TABLE', $prefix . 'forums_modules');
-define('FORUMS_POSTS_TABLE', $prefix.'forums_posts');
-define('FORUMS_PRIVMSGS_TABLE', $prefix.'forums_privmsgs');
-define('FORUMS_PRIVMSGS_TO_TABLE', $prefix.'forums_privmsgs_to');
-define('FORUMS_PRIVMSGS_FOLDER_TABLE', $prefix.'forums_privmsgs_folder');
-define('FORUMS_PRIVMSGS_RULES_TABLE', $prefix.'forums_privmsgs_rules');
-define('FORUMS_REPORTS_TABLE', $prefix.'forums_reports');
-define('FORUMS_REASONS_TABLE', $prefix.'forums_reports_reasons');
-define('FORUMS_SEARCH_TABLE', $prefix.'forums_search_results');
-define('FORUMS_SEARCH_WORD_TABLE', $prefix.'forums_search_wordlist');
-define('FORUMS_SEARCH_MATCH_TABLE', $prefix.'forums_search_wordmatch');
-define('FORUMS_TOPICS_TABLE', $prefix.'forums_topics');
-define('FORUMS_POLL_OPTIONS_TABLE', $prefix.'forums_poll_results');
-define('FORUMS_POLL_VOTES_TABLE', $prefix.'forums_poll_voters');
-define('FORUMS_WORDS_TABLE', $prefix.'forums_words');
-define('FORUMS_WATCH_TABLE', $prefix.'forums_watch');
-define('FORUMS_TRACK_TABLE', $prefix.'forums_tracking');
-define('FORUMS_RANKS_TABLE', $prefix.'forums_ranks');
+define('FORUMS_ATTACHMENTS_TABLE', $table_prefix.'forums_attachments');
+define('FORUMS_BOOKMARKS_TABLE', $table_prefix.'forums_bookmarks');
+define('FORUMS_BBCODES_TABLE', $table_prefix.'forums_bbcodes');
+define('FORUMS_CONFIG_TABLE', $table_prefix.'forums_config');
+define('FORUMS_DRAFTS_TABLE', $table_prefix.'forums_drafts');
+define('FORUMS_FORUMS_TABLE', $table_prefix.'forums_forums');
+define('FORUMS_ACCESS_TABLE', $table_prefix.'forums_access');
+define('FORUMS_ICONS_TABLE', $table_prefix.'forums_icons');
+define('FORUMS_LOG_TABLE', $table_prefix.'forums_log');
+define('FORUMS_MODERATOR_TABLE', $table_prefix.'forums_moderator_cache');
+define('FORUMS_MODULES_TABLE', $table_prefix . 'forums_modules');
+define('FORUMS_POSTS_TABLE', $table_prefix.'forums_posts');
+define('FORUMS_PRIVMSGS_TABLE', $table_prefix.'forums_privmsgs');
+define('FORUMS_PRIVMSGS_TO_TABLE', $table_prefix.'forums_privmsgs_to');
+define('FORUMS_PRIVMSGS_FOLDER_TABLE', $table_prefix.'forums_privmsgs_folder');
+define('FORUMS_PRIVMSGS_RULES_TABLE', $table_prefix.'forums_privmsgs_rules');
+define('FORUMS_REPORTS_TABLE', $table_prefix.'forums_reports');
+define('FORUMS_REASONS_TABLE', $table_prefix.'forums_reports_reasons');
+define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
+define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
+define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');
+define('FORUMS_TOPICS_TABLE', $table_prefix.'forums_topics');
+define('FORUMS_POLL_OPTIONS_TABLE', $table_prefix.'forums_poll_results');
+define('FORUMS_POLL_VOTES_TABLE', $table_prefix.'forums_poll_voters');
+define('FORUMS_WORDS_TABLE', $table_prefix.'forums_words');
+define('FORUMS_WATCH_TABLE', $table_prefix.'forums_watch');
+define('FORUMS_TRACK_TABLE', $table_prefix.'forums_tracking');
+define('FORUMS_RANKS_TABLE', $table_prefix.'forums_ranks');
 
 
-define('ADMIN_AUTH_TABLE', 'test_admins');
+define('ADMIN_AUTH_TABLE', $table_prefix.'admins');
 
-define('BLOCKS_TABLE', 'test_blocks');
+define('BLOCKS_TABLE', $table_prefix.'blocks');
 
-define('CORE_CONFIG_TABLE', 'test_config');
-define('CORE_MODULES_TABLE', $prefix.'modules');
+define('CORE_CONFIG_TABLE', $table_prefix.'config');
+define('CORE_MODULES_TABLE', $table_prefix.'modules');
 
-define('SMILIES_TABLE', 'test_smilies');
+define('SMILIES_TABLE', $table_prefix.'smilies');
 
-define('USER_GROUP_TABLE', 'test_groups_members');
-define('GROUPS_TABLE', 'test_groups');
+define('USER_GROUP_TABLE', $table_prefix.'groups_members');
+define('GROUPS_TABLE', $table_prefix.'groups');
 
-define('SESSIONS_AUTOLOGIN_TABLE', 'test_sessions_auto_login');
-define('SESSIONS_TABLE', $prefix.'sessions');
+define('SESSIONS_AUTOLOGIN_TABLE', $table_prefix.'sessions_auto_login');
+define('SESSIONS_TABLE', $table_prefix.'sessions');
 
 
-define('EXTENSIONS_TABLE', $prefix.'forums_extensions');
-define('EXTENSION_GROUPS_TABLE', $prefix.'forums_extension_groups');
+define('EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
+define('EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
-define('USERS_TABLE', $prefix.'users');
-define('USERS_NOTES_TABLE', $prefix.'forums_users_notes');
-define('ZEBRA_TABLE', $prefix.'forums_zebra');
-//define('LOG_TABLE', $prefix.'log');
+define('USERS_TABLE', $user_prefix.'users');
+define('USERS_NOTES_TABLE', $table_prefix.'forums_users_notes');
+define('ZEBRA_TABLE', $table_prefix.'forums_zebra');
+//define('LOG_TABLE', $table_prefix.'log');
 
 
 // can be removed
-define('PROFILE_FIELDS_TABLE', $prefix.'forums_profile_fields');
-define('PROFILE_LANG_TABLE', $prefix.'forums_profile_lang');
-define('PROFILE_DATA_TABLE', $prefix.'forums_profile_fields_data');
-define('PROFILE_FIELDS_LANG_TABLE', $prefix.'forums_profile_fields_lang');
-define('DISALLOW_TABLE', $prefix.'forums_disallow');
+define('PROFILE_FIELDS_TABLE', $table_prefix.'forums_profile_fields');
+define('PROFILE_LANG_TABLE', $table_prefix.'forums_profile_lang');
+define('PROFILE_DATA_TABLE', $table_prefix.'forums_profile_fields_data');
+define('PROFILE_FIELDS_LANG_TABLE', $table_prefix.'forums_profile_fields_lang');
+define('DISALLOW_TABLE', $table_prefix.'forums_disallow');
 
 ?>
\ No newline at end of file

Added: cms/branches/1.0alpha1/includes/templates/installer/agreement.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/installer/agreement.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/templates/installer/agreement.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -0,0 +1,113 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th style="text-align: center;">Agreement</th>
+						</tr>
+						<tr>
+							<td class="row1">
+								<p>
+									Because the program is licensed free of charge, there is <b>NO WARRANTY
+								FOR THE PROGRAM</b>, to the extent permitted by applicable law.  except when
+								otherwise stated in writing the copyright holders and/or other parties
+								provide the program "as is" without warranty of any kind, either expressed
+								or implied, including, but not limited to, the implied warranties of
+								merchantability and fitness for a particular purpose.  the entire risk as
+								to the quality and performance of the program is with you.  should the
+								program prove defective, you assume the cost of all necessary servicing,
+								repair or correction.</p>
+								<p>
+									<b>Please note</b>, that while most of this program is mostly licensed under <a href="http://www.gnu.org/licenses/gpl.txt">GNU GPL</a> . It <b>does</b> include a few non GNU GPL licenses, your take responsibly  for looking at each file and/or folder for the it license and following it to it extent. 
+									<br/><br/>None of these license hinders free redistribution, nor use of this software for individual or business related site</p>
+								<p>
+									<b>If you agree to these terms and those of all the distrubuted licenses, Please hit agree.</b></p>
+								<p>				
+							</td>
+						</tr>
+						<tr>
+							<th style="text-align: center;">
+								<input type="hidden" name="stage" value="1" />
+								<input type="submit" name="agreement_signed" value="I Agree" class="formfield" />
+							</th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Added: cms/branches/1.0alpha1/includes/templates/installer/complete.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/installer/complete.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/templates/installer/complete.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -0,0 +1,95 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+				<tbody>
+					<tr>
+						<th style="text-align: center;">Agreement</th>
+					</tr>
+					<tr>
+						<td class="row1">
+							<p style="text-align: center">
+								Congrates { $username }, Your Site is now installed.
+								<br/>
+								<br/>
+								<a href="{ $admin_link }">Go to Site Admin</a>
+							<p>
+						</td>
+					</tr>
+				</tbody>
+			</table>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Added: cms/branches/1.0alpha1/includes/templates/installer/stage1.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/installer/stage1.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/templates/installer/stage1.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -0,0 +1,205 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+<script language="Javascript" type="text/javascript">
+<!--
+var old_value = 'all';
+
+function change_option(name)
+{
+	var area = document.getElementById(name);
+
+	if (!area)
+	{
+		if (old_value == 'all')
+		{
+			return;
+		}
+		else
+		{
+			name = 'all'
+			area = document.getElementById(name);
+		}
+	}
+
+	area.style.display = '';
+
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(name + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = '';
+		i += 1;
+	}
+
+	area = document.getElementById(old_value);
+	area.style.display = 'none';
+	
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(old_value + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = 'none';
+		i += 1;
+	}
+
+	old_value = name;
+}
+
+//-->
+</script>
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">Database Configuration</th>
+						</tr>
+						<!-- IF { $error } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<td class="row1" width="50%"><b>Database type: </b></td>
+							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
+						</tr>
+						<tr id="sqlite" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="sqlite_pdo" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="all">
+							<td class="row1" width="50%"><b>Database server hostname: </b></td>
+							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
+						</tr>
+						<tr id="all_1">
+							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
+						</tr>
+						<tr id="all_2">
+							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
+							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
+						</tr>
+						<tr id="all_3">
+							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr id="all_4">
+							<td class="row1" width="50%"><b>Database password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
+							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
+							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<input type="hidden" name="stage" value="2" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+
+<script language="Javascript" type="text/javascript">
+<!--
+	change_option(document.getElementById('layer').value);
+//-->
+</script>
+
+</body>
+
+</html>
\ No newline at end of file

Added: cms/branches/1.0alpha1/includes/templates/installer/stage2.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/installer/stage2.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/templates/installer/stage2.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -0,0 +1,169 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: relative;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: 0px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<!-- IF { $error } -->
+						<tr>
+							<th align="center" colspan="2">Error</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<th align="center" colspan="2">Administrator Configuration</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Username: </b></td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address: </b></td>
+							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
+						</tr>
+						<tr>
+							<th align="center" colspan="2">Site Configuration</th>
+						</tr>
+						<tr>
+							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Name: </b></td>
+							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Domain: </b></td>
+							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site path: </b></td>
+							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
+							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Path: </b></td>
+					
+							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Name: </b></td>
+							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
+						</tr>
+						<!-- IF { $config_content } -->
+						<tr>
+							<th align="center" colspan="2">Config.php Content</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">
+							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
+							</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="3" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/includes/templates/login_admin.html
===================================================================
--- cms/branches/1.0alpha1/includes/templates/login_admin.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/includes/templates/login_admin.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -14,7 +14,7 @@
     margin: 0%;
     padding: 0px;
     background-color: white;
-    background: url(/images/bg.gif);
+    background: url(images/bg.gif);
 }
 
 .error { color: red; }

Modified: cms/branches/1.0alpha1/install/build_data.php
===================================================================
--- cms/branches/1.0alpha1/install/build_data.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/install/build_data.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -21,440 +21,438 @@
 $Id$
 */
 
-$install_prefix = 'test_';
 $time = gmtime();
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_url', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
 
 
 //Admin
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
 $admin_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 $guest_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 $bot_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
 
 // Forums
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
 
 // START: This should be replaced by beta
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
 // ADMINISTRATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
 // SUPER MODERATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
 
 // to be removed
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)");
 ////
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/install/build_tables.php
===================================================================
--- cms/branches/1.0alpha1/install/build_tables.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/install/build_tables.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -21,8 +21,6 @@
 $Id$
 */
 
-$install_prefix = 'test_';
-
 function field_unix_time($name, $null = false)
 {
 	global $_CLASS;
@@ -34,7 +32,7 @@
 	Admin Auth Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'admins');
+$_CLASS['core_db']->table_create('start', $table_prefix.'admins');
 
 $_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
@@ -52,7 +50,7 @@
 /*
 	Blocks Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'blocks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'blocks');
 
 $_CLASS['core_db']->add_table_field_int('block_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('block_title', 100);
@@ -78,7 +76,7 @@
 /*
 	Config Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'config');
+$_CLASS['core_db']->table_create('start', $table_prefix.'config');
 
 $_CLASS['core_db']->add_table_field_char('config_section', 20);
 $_CLASS['core_db']->add_table_field_char('config_name', 20);
@@ -95,7 +93,7 @@
 	Groups Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'groups');
+$_CLASS['core_db']->table_create('start', $table_prefix.'groups');
 
 // this section needs updating, with null fields
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
@@ -127,7 +125,7 @@
 /*
 	Groups Members Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'groups_members');
+$_CLASS['core_db']->table_create('start', $table_prefix.'groups_members');
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -142,7 +140,7 @@
 /*
 	Modules Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'modules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'modules');
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
@@ -162,7 +160,7 @@
 /*
 	Sessions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'sessions');
+$_CLASS['core_db']->table_create('start', $table_prefix.'sessions');
 
 $_CLASS['core_db']->add_table_field_char('session_id', 40);
 $_CLASS['core_db']->add_table_field_int('session_user_id', array('max' => 16000000));
@@ -189,7 +187,7 @@
 /*
 	Sessions Auto login Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'sessions_auto_login');
+$_CLASS['core_db']->table_create('start', $table_prefix.'sessions_auto_login');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('auto_login_browser', 255);
@@ -203,7 +201,7 @@
 /*
 	Smiles Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'smilies');
+$_CLASS['core_db']->table_create('start', $table_prefix.'smilies');
 
 $_CLASS['core_db']->add_table_field_int('smiley_id', array('max' => 16000000, 'auto_increment' => true));
 
@@ -226,7 +224,7 @@
 `user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'users');
+$_CLASS['core_db']->table_create('start', $user_prefix.'users');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('username', 80);
@@ -324,7 +322,7 @@
 /*
 	Attachments Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_attachments');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_attachments');
 
 $_CLASS['core_db']->add_table_field_int('attach_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('post_msg_id', array('max' => 16000000));
@@ -352,7 +350,7 @@
 /*
 	Forums Auth Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
@@ -369,7 +367,7 @@
 /*
 	Forums Auth Options Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_options');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_options');
 
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('auth_option', 20);
@@ -385,7 +383,7 @@
 /*
 	Forums Auth Presets Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_presets');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_presets');
 
 $_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000));
 $_CLASS['core_db']->add_table_field_int('preset_user_id', array('max' => 16000000));
@@ -402,7 +400,7 @@
 /*
 	Forums Bookmarks Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_bookmarks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_bookmarks');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -416,7 +414,7 @@
 /*
 	Forums Config Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_config');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_config');
 
 $_CLASS['core_db']->add_table_field_char('config_name', 100);
 $_CLASS['core_db']->add_table_field_char('config_value', 255);
@@ -431,7 +429,7 @@
 	Forums Disallow Table
 */
 /*
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_disallow');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_disallow');
 
 $_CLASS['core_db']->add_table_field_int('disallow_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('disallow_username', 30);
@@ -444,7 +442,7 @@
 /*
 	Forums Drafts Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_drafts');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_drafts');
 
 $_CLASS['core_db']->add_table_field_int('draft_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -463,7 +461,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_extensions');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extensions');
 
 $_CLASS['core_db']->add_table_field_int('extension_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
@@ -476,7 +474,7 @@
 /*
 	Forums Extension Groups Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_extension_groups');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extension_groups');
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 20);
@@ -495,7 +493,7 @@
 /*
 	Forums Forums Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_forums');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_forums');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('parent_id', array('max' => 16000));
@@ -546,7 +544,7 @@
 /*
 	Forums POsts Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_posts');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_posts');
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -588,7 +586,7 @@
 /*
 	Forums Topics Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_topics');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_topics');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
@@ -639,7 +637,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_tracking');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_tracking');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
@@ -655,7 +653,7 @@
 /*
 	Forums Icons Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_icons');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_icons');
 
 $_CLASS['core_db']->add_table_field_int('icons_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('icons_url', 50);
@@ -672,7 +670,7 @@
 	Forums Forums Watch Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_watch');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_watch');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -689,7 +687,7 @@
 /*
 	Forums Modules Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_modules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_modules');
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_type', 3);
@@ -709,7 +707,7 @@
 /*
 	Forums Moderator Cache Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_moderator_cache');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_moderator_cache');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -728,7 +726,7 @@
 /*
 	Forums Poll Results Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_results');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_results');
 
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -743,7 +741,7 @@
 /*
 	Forums Poll Voters Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_voters');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_voters');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
@@ -761,7 +759,7 @@
 /*
 	Forums Poll Voters Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_ranks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_ranks');
 
 $_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('rank_title', 50);
@@ -776,7 +774,7 @@
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordlist');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordlist');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('word_text', 100);
@@ -790,7 +788,7 @@
 /*
 	Forums search_wordmatch Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordmatch');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordmatch');
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000));
@@ -803,7 +801,7 @@
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_words');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_words');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('word', 100);
@@ -816,7 +814,7 @@
 /*
 	Forums Zebra Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_zebra');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_zebra');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('zebra_id', array('max' => 16000000));
@@ -833,7 +831,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_log');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_log');
 
 $_CLASS['core_db']->add_table_field_int('log_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('log_type', array('max' => 200));
@@ -857,7 +855,7 @@
 
 /*
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs');
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('root_level', array('max' => 16000000));
@@ -896,7 +894,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_folder');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_folder');
 
 $_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -911,7 +909,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_rules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_rules');
 
 $_CLASS['core_db']->add_table_field_int('rule_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -930,7 +928,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_to');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_to');
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));

Modified: cms/branches/1.0alpha1/install/installer.php
===================================================================
--- cms/branches/1.0alpha1/install/installer.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/install/installer.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -20,6 +20,424 @@
 
 $Id$
 */
+define('VIPERAL', 'INSTALLER');
 
-// LOL, MADE YOU LOOK
+error_reporting(0);
+
+//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
+$site_file_root = '../';
+
+if (!extension_loaded('mbstring'))
+{
+	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+}
+
+set_magic_quotes_runtime(0);
+mb_internal_encoding('UTF-8');
+
+define('STRIP_SLASHES', get_magic_quotes_gpc());
+
+// Remove registered globals
+if ((bool) ini_get('register_globals'))
+{
+	foreach ($_REQUEST as $var_name => $value)
+	{
+		unset($$var_name);
+	}
+}
+
+require_once($site_file_root.'includes/functions.php');
+require_once($site_file_root.'includes/display/template.php');
+
+load_class(false, 'core_template');
+
+$holding_array = array(
+	'mysql'		=> array(
+		'lang'			=> 'MySQL',
+		'extension'		=> 'mysql', 
+	),
+	'mysql3'			=> array(
+		'lang'			=> 'MySQL3',
+		'extension'		=> 'mysql',
+	),
+	'mysqli'	=> array(
+		'lang'			=> 'MySQL 4.1.x',
+		'extension'		=> 'mysqli', 
+	),
+	'mssql'		=> array(
+		'lang'			=> 'MS SQL Server 7/2000',
+		'extension'		=> 'mssql', 
+	),
+	'postgres' => array(
+		'lang'			=> 'PostgreSQL',
+		'extension'		=> 'pgsql', 
+	),
+	'sqlite'		=> array(
+		'lang'			=> 'SQLite',
+		'extension'		=> 'sqlite', 
+	),
+	'sqlite_pdo'		=> array(
+		'lang'			=> 'SQLite 3 (PDO)',
+		'extension'		=> 'pdo_sqlite', 
+	)
+);
+
+$database_array = array();
+$database_options = '';
+$db_layer = isset($_POST['layer']) ? $_POST['layer'] : false;
+
+foreach ($holding_array as $name => $setting)
+{
+	if (extension_loaded($setting['extension']))
+	{
+		$database_options .= '<option value="' . $name . '"'.(($db_layer == $name) ? ' selected="selected"' : '').'>' . $setting['lang'] . '</option>';
+		$database_array[$name] = $setting;
+	}
+}
+
+$error = array();
+$stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
+
+if ($stage && !$_POST['agreement_signed'])
+{
+	$stage = 0;
+}
+
+if ($stage === 3)
+{
+	if (file_exists($site_file_root.'config.php'))
+	{
+		require_once($site_file_root.'config.php');
+	}
+
+	$site_name		= get_variable('site_name', 'POST');
+	$site_domain	= get_variable('site_domain', 'POST');
+	$site_path		= get_variable('site_path', 'POST');
+	$site_port		= get_variable('site_port', 'POST');
+
+	$cookie_domain	= get_variable('cookie_domain', 'POST');
+	$cookie_path	= get_variable('cookie_path', 'POST');
+	$cookie_name	= get_variable('cookie_name', 'POST');
+
+	$username		= get_variable('username', 'POST');
+	$password		= get_variable('password', 'POST');
+	$password_confirm= get_variable('password_confirm', 'POST');
+	$email			= get_variable('email', 'POST');
+	$email_confirm	= get_variable('email_confirm', 'POST');
+
+	if (!$username)
+	{
+		$error[] = 'Invalid Username';
+	}
+
+	if (!$password || ($password !== $password_confirm))
+	{
+		$error[] = 'Passwords do not match.';
+	}
+
+	if (!$email || ($email !== $email_confirm))
+	{
+		$error[] = 'Emails Address do not match.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (isset($site_db))
+	{
+		load_class($site_file_root.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
+
+		$_CLASS['core_db']->connect($site_db);
+		$config_content = '';
+	}
+	else
+	{
+		$error[] = '<b>Please upload the content listed in the "Config.php Content" Section</b>';
+		$config_content = get_variable('config_content', 'POST');
+	}
+
+	if (empty($error))
+	{
+		require_once($site_file_root.'includes/tables.php');
+		require_once($site_file_root.'includes/cache/cache.php');
+		require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+
+		load_class(false, 'core_cache', 'cache_'.$acm_type);
+
+		set_core_config('global', 'site_name', $site_name, false);
+		set_core_config('server', 'site_domain', $site_domain, false);
+		set_core_config('server', 'site_path', $site_path, false);
+		set_core_config('server', 'site_port', $site_port, false);
+		set_core_config('server', 'cookie_domain', $cookie_domain, false);
+		set_core_config('server', 'cookie_path', $cookie_path, false);
+		set_core_config('server', 'cookie_name', $cookie_name, false);
+		set_core_config('server', 'site_secure', 0, false);
+
+		set_core_config('user', 'newest_username', $username, true);
+		
+		$user_update = array(
+			'username'				=> $username,
+			'user_password'			=> encode_password($password, 'md5'),
+			'user_password_encoding'=> 'md5',
+			'user_email'			=> $email
+		);
+
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
+
+		$_CLASS['core_template']->assign_array(array(
+			'admin_link'		=> generate_link(false, array('full' => true, 'sid' => false, 'admin' => true)),
+			'username'			=> $username,
+		));
+
+		$_CLASS['core_template']->display('installer/complete.html');
+		
+		script_close();
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'site_name'			=> $site_name,
+		'site_domain'		=> $site_domain,
+		'site_path'			=> $site_path,
+		'site_port'			=> $site_port,
+		'cookie_domain'		=> $cookie_domain,
+		'cookie_path'		=> $cookie_path,
+		'cookie_name'		=> $cookie_name,
+		'username'			=> $username,
+		'password'			=> $password,
+		'password_confirm'	=> $password_confirm,
+		'email'				=> $email,
+		'email_confirm'		=> $email_confirm,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+		'config_content'	=> $config_content
+	));
+
+	$_CLASS['core_template']->display('installer/stage2.html');
+
+	script_close();
+}
+
+if ($stage === 2)
+{
+	if ($db_layer && in_array($db_layer, array_keys($database_array)))
+	{
+		load_class($site_file_root.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
+
+		$site_db = array();
+		$site_db['type']		= $db_layer;
+		$site_db['persistent']	= false;
+
+		$_CLASS['core_db']->report_error(false);
+
+		if (strpos($db_layer, 'sqlite') === false)
+		{
+			$site_db['server']		= get_variable('server', 'POST');
+			$site_db['port']		= get_variable('port', 'POST');
+			$site_db['database']	= get_variable('database', 'POST');
+			$site_db['username']	= get_variable('username', 'POST');
+			$site_db['password']	= get_variable('password', 'POST');
+			
+			if (!$site_db['username'] || !$site_db['database'])
+			{
+				$error[] = 'Required Information missing';
+			}
+		}
+		else
+		{
+			$site_db['file'] = get_variable('file_'.$db_layer, 'POST');
+
+			if (!$site_db['file'])
+			{
+				$error[] = 'Required Information missing';
+			}
+		}
+	}
+	else
+	{
+		$error[] = 'Database not supported on your system';
+	}
+
+	if (empty($error) && !$_CLASS['core_db']->connect($site_db))
+	{
+		if (!$_CLASS['core_db']->link_identifier)
+		{
+			$db_error = $_CLASS['core_db']->sql_error(false, true);
+			$error[] = 'Could not connect to the database'.(($db_error['message']) ? '<br/>'.$db_error['message'] : '');
+		}
+		else
+		{
+			if (isset($_POST['test']))
+			{
+				$error[] = 'Database Selection fail, will attempt to create in next step';
+			}
+			else
+			{
+				switch ($db_layer)
+				{
+					case 'mysql':
+					case 'mysqli':
+						$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'].' DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci');
+					break;
+
+					case 'mysql3':
+						$_CLASS['core_db']->query('CREATE DATABASE  '.$site_db['database']);
+					break;
+
+					case 'postgres':
+						if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'] .' WITH ENCODING UNICODE');
+						}
+						else
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database']);
+						}
+					break;
+				}
+
+				$_CLASS['core_db']->disconnect();
+				$_CLASS['core_db']->connect($site_db);
+
+				if (!$_CLASS['core_db']->connect($site_db))
+				{
+					$error[] = 'Database Creation Failed';
+				}
+			}
+		}
+	}
+	
+	if (empty($error))
+	{
+		$user_prefix	= get_variable('user_prefix', 'POST');
+		$table_prefix	= get_variable('table_prefix', 'POST');
+		
+		require_once($site_file_root.'includes/tables.php');
+	
+		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->free_result($result);
+	
+		if ($result)
+		{
+			$error[] = 'Creation Failed: Current installation found';
+		}
+	}
+
+	if (isset($_POST['test']) || !empty($error))
+	{
+		$stage = 1;
+	}
+	else
+	{
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_tables.php');
+		$_CLASS['core_db']->transaction('commit');
+	
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_data.php');
+		$_CLASS['core_db']->transaction('commit');
+		
+		$_CLASS['core_db']->optimize_tables();
+		
+		$_CLASS['core_db']->report_error(true);
+	
+		$config_data = "<?php\n\n";
+
+		foreach ($site_db as $name => $value)
+		{
+			if (is_bool($value))
+			{
+				$value = ($value) ? 'true' : 'false';
+			}
+			elseif (!is_int($value))
+			{
+				$value = "'$value'";
+			}
+
+			$config_data .= "\$site_db['$name'] = $value;\n";
+		}
+
+		$config_data .= "\n";
+		$config_data .= "\$table_prefix\t= '$table_prefix';\n";
+		$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
+		$config_data .= "\$acm_type\t\t= 'file';\n\n";
+		$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
+		$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
+		$config_data .= '?>';
+
+		if (file_put_contents($site_file_root.'config.php', $config_data))
+		{
+			$config_data = false;
+		}
+		else
+		{
+			$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
+		}
+		
+		$path = dirname(getenv('SCRIPT_NAME'));
+
+		if (substr($path, -1) != '/')
+		{
+			$path .= '/';
+		}
+
+		$path = str_replace('install/', '', $path);
+		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
+
+		$_CLASS['core_template']->assign_array(array(
+			'site_name'			=> 'New CMS Site',
+			'site_domain'		=> $domain,
+			'site_path'			=> $path,
+			'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
+			'cookie_domain'		=> $domain,
+			'cookie_path'		=> $path,
+			'cookie_name'		=> 'cms',
+			'username'			=> '',
+			'password'			=> '',
+			'password_confirm'	=> '',
+			'email'				=> '',
+			'email_confirm'		=> '',
+			'error'				=> empty($error) ? false : implode('<br/>', $error),
+			'config_content'	=> $config_data
+		));
+
+		$_CLASS['core_template']->display('installer/stage2.html');
+
+		script_close();
+	}
+}
+
+if ($stage === 1)
+{
+	$_CLASS['core_template']->assign_array(array(
+		'database_options'	=> $database_options,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+
+		'server'		=> isset($site_db['server']) ? $site_db['server'] : '',
+		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
+		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
+		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',
+		'password'		=> isset($site_db['password']) ? $site_db['password'] : '',
+		'file'			=> isset($site_db['file']) ? $site_db['file'] : '',
+		'table_prefix'	=> get_variable('table_prefix', 'POST', 'cms_'),
+		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
+	));
+
+	$_CLASS['core_template']->display('installer/stage1.html');
+
+	script_close();
+}
+
+if (!$stage)
+{
+	$_CLASS['core_template']->display('installer/agreement.html');
+	script_close();
+}
+
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/modules/Quick_Message/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/Quick_Message/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/modules/Quick_Message/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,11 +26,11 @@
     die;
 }
 
-global $prefix;
-
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 $_CLASS['core_user']->user_setup();

Modified: cms/branches/1.0alpha1/modules/Quick_Message/install.php
===================================================================
--- cms/branches/1.0alpha1/modules/Quick_Message/install.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/modules/Quick_Message/install.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,11 +26,11 @@
     die;
 }
 
-global $prefix;
-
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 class Quick_Message_install

Modified: cms/branches/1.0alpha1/modules/articles/admin/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/admin/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/modules/articles/admin/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -27,7 +27,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 if (isset($_REQUEST['mode']))

Modified: cms/branches/1.0alpha1/modules/articles/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/modules/articles/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -28,7 +28,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 $_CLASS['core_user']->user_setup();
@@ -58,7 +58,7 @@
 				trigger_error('ARTICLE_NOT_FOUND');
 			}
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'ARTICLES_POSTER' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
 				'ARTICLES_POSTER_LINK'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
 				'ARTICLES_TEXT'			=> $row['articles_text'],

Modified: cms/branches/1.0alpha1/modules/articles/install.php
===================================================================
--- cms/branches/1.0alpha1/modules/articles/install.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/branches/1.0alpha1/modules/articles/install.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -30,7 +30,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 class articles_install
@@ -64,9 +64,9 @@
 		$_CLASS['core_db']->add_table_field_char('approver_name', 80, true);
 
 		$_CLASS['core_db']->add_table_index('articles_id', 'primary');
-		$_CLASS['core_db']->add_table_index('articles_start');
+		$_CLASS['core_db']->add_table_index('articles_starts');
+		$_CLASS['core_db']->add_table_index('articles_expires');
 		//$_CLASS['core_db']->add_table_index('articles_type');
-		//$_CLASS['core_db']->add_table_index('articles_expires');
 		$_CLASS['core_db']->add_table_index('articles_order');
 		$_CLASS['core_db']->add_table_index('articles_status');
 

Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/admin/blocks.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -143,7 +143,7 @@
 			'TITLE'			=> $block['block_title'],
 			'TYPE'			=> $_CLASS['core_user']->get_lang('TYPE_'.$block['block_type']),
 
-			'EXPIRES'		=> ($block['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
+			'EXPIRES'		=> ($block['block_expires']) ? $_CLASS['core_user']->format_date($block['block_expires']) : false,
 			'STARTS'		=> ($block['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($block['block_starts']) : false,
 
 			'ORDER_DOWN' 	=> ($block['block_order'] < $weigth[$block['block_position']]),

Modified: cms/trunk/admin/menu.php
===================================================================
--- cms/trunk/admin/menu.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/admin/menu.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -42,6 +42,7 @@
 $menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MODULES'), 'link' => generate_link('modules', array('admin' => true)));
 $menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE'), 'link' => generate_link('modules', array('admin' => true)));
 $menu['modules'][] = '';
+$menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('ARTICLES'), 'link' => generate_link('articles', array('admin' => true)));
 
 $menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('FORUMS'), 'link' => generate_link('Forums', array('admin' => true)));
 $menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMIN_INDEX'), 'link' => generate_link('Forums', array('admin' => true)));

Modified: cms/trunk/admin/messages.php
===================================================================
--- cms/trunk/admin/messages.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/admin/messages.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -118,7 +118,7 @@
 		'EDIT_LINK'		=> generate_link('messages&amp;mode=edit&amp;id='.$row['block_id'], array('admin' => true)),
 		'DELETE_LINK' 	=> generate_link('messages&amp;mode=delete&amp;id='.$row['block_id'], array('admin' => true)),
 
-		'EXPIRES'		=> ($row['block_expires'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
+		'EXPIRES'		=> ($row['block_expires']) ? $_CLASS['core_user']->format_date($row['block_expires']) : false,
 		'STARTS'		=> ($row['block_starts'] > $_CLASS['core_user']->time) ? $_CLASS['core_user']->format_date($row['block_starts']) : false,
 		'TITLE'			=> $row['block_title'],
 

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,9 +26,11 @@
     die;
 }
 
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', 'test_quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 global $prefix, $_CLASS, $_CORE_CONFIG;

Modified: cms/trunk/config.php
===================================================================
--- cms/trunk/config.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/config.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -1,101 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-// TEMP
-
-// do not modify!
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-//echo getenv('DOCUMENT_ROOT'); die;
-/*
-If (getenv('DOCUMENT_ROOT') != 'C:/Program Files/Apache Group/Apache2/htdocs')
-{
-    die('Your site shouldn\'t access this file');
-}
-*/
-
-$prefix = 'test_';
-$user_prefix = 'test_';
-
-/*
-$site_db['type']		= 'mysql';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'cms';
-$site_db['username']	= 'root';
-$site_db['password']	= '';
-$site_db['persistent']	= false;
-*/
-
-
-$site_db['type']		= 'postgres';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'cms';
-$site_db['username']	= 'postgres';
-$site_db['password']	= 'viper83';
-$site_db['persistent']	= false;
-
-
-/*
-$site_db['type']	= 'sqlite';
-$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester';
-$site_db['persistent']	= false;
-*/
-
-/*
-$site_db['type']	= 'sqlite_pdo';
-$site_db['file']	= 'C:\Program Files\Apache Group\Apache2\tester_pdo';
-$site_db['persistent']	= false;
-
-*/
-
-/*
-NOT WORKING
-
-$site_db['type']		= 'mssql';
-$site_db['server']		= '';
-$site_db['port']		= '';
-$site_db['database']	= 'tester';
-$site_db['username']	= '';
-$site_db['password']	= '';
-$site_db['persistent']	= false;
-*/
-
-//$acm_type = 'eaccelerator';
-$acm_type = 'file';
-
-if (!defined('INDEX_PAGE'))
-{
-	define('INDEX_PAGE', 'index.php');
-}
-
-if (!defined('ADMIN_PAGE'))
-{
-	define('ADMIN_PAGE', 'admin.php');
-}
-
-?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/core.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -38,7 +38,6 @@
 mb_internal_encoding('UTF-8');
 //mb_http_output('UTF-8');
 
-
 // Remove registered globals
 if ((bool) ini_get('register_globals'))
 {
@@ -93,26 +92,6 @@
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 
-/*
-$_CLASS['core_db']->transaction();
-require($site_file_root.'install/build_tables.php');
-$_CLASS['core_db']->transaction('commit');
-die;
-*/
-
-
-/*
-$_CLASS['core_db']->transaction();
-require($site_file_root.'install/build_data.php');
-$_CLASS['core_db']->transaction('commit');
-die;
-*/
-
-/*
-	Progres need to be optimized after install :-(
-	$_CLASS['core_db']->optimize_tables();
-*/
-
 $_CLASS['core_db']->return_on_error = true;
 
 // Error messages just incase we can't get our configs

Modified: cms/trunk/error.php
===================================================================
--- cms/trunk/error.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/error.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -22,7 +22,7 @@
 }
 
 //echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
-$site_file_root = 'C:/apachefriends/xampp/cms/';
+$site_file_root = '';
 $lang = 'en';
 
 if (isset($_SERVER['HTTP_ACCEPT_LANGUAGE']))

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/db/mysql.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -41,11 +41,11 @@
 	var $_fields = array();
 	var $_table_name = false;
 
-	function connect($db)
+	function connect($db, $return = false)
 	{		
 		if ($db['port'])
 		{
-			$db['server'] .= ':' . $port;
+			$db['server'] .= ':' . $db['port'];
 		}
 
 		if ($this->link_identifier)
@@ -68,9 +68,14 @@
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
-		
-		if (!$error)
+
+		if (!$this->report_error)
 		{
+			return false;
+		}
+
+		if (!isset($error))
+		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 		}
 
@@ -179,7 +184,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -223,60 +228,67 @@
 	/*
 		Boy do I like this but it phpBB's, may have to do something similar
 	*/
-	function sql_build_array($query, $assoc_ary = false)
+	function sql_build_array($query, $array = false)
 	{
-		if (!is_array($assoc_ary))
+		if (!is_array($array))
 		{
 			return false;
 		}
 
-		$fields = array();
-		$values = array();
+		$_fields = $values = array();
 
 		if ($query == 'INSERT')
 		{
-			foreach ($assoc_ary as $key => $var)
+			foreach ($array as $key => $value)
 			{
-				$fields[] = $key;
+				$_fields[] = $key;
 
-				if (is_null($var))
+				if (is_numeric($value))
 				{
-					$values[] = 'NULL';
+					$values[] = $value;
 				}
-				elseif (is_string($var))
+				elseif (is_string($value))
 				{
-					$values[] = "'" . $this->escape($var) . "'";
+					$values[] = "'" . $this->escape($value) . "'";
 				}
-				else
+				elseif (is_null($value))
 				{
-					$values[] = (is_bool($var)) ? intval($var) : $var;
+					$values[] = 'NULL';
 				}
+				elseif (is_bool($value))
+				{
+					$values[] = ($value) ? 1 : 0;
+				}
 			}
 
-			$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
 		}
-		else if ($query == 'UPDATE' || $query == 'SELECT')
+		elseif ($query == 'UPDATE' || $query == 'SELECT')
 		{
 			$values = array();
-			foreach ($assoc_ary as $key => $var)
+			foreach ($array as $key => $value)
 			{
-				if (is_null($var))
+				if (is_numeric($value))
 				{
-					$values[] = "$key = NULL";
+					$values[] = $key.' = '.$value;
 				}
-				elseif (is_string($var))
+				elseif (is_string($value))
 				{
-					$values[] = "$key = '" . $this->escape($var) . "'";
+					$values[] = "$key = '" . $this->escape($value) . "'";
 				}
-				else
+				elseif (is_null($value))
 				{
-					$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
+					$values[] = "$key = NULL";
 				}
+				elseif (is_bool($value))
+				{
+					$values[] = $key.' = '.(($value) ? 1 : 0);
+				}
+
 			}
-			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+
+			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
 		}
-
-		return $query;
 	}
 
 	function num_rows($result = false)
@@ -393,7 +405,7 @@
 				}
 			}
 
-			$this->sql_freeresult($result);
+			$this->free_result($result);
 		}
 
 		if ($table)
@@ -412,14 +424,22 @@
 		return (($return_dbname) ? 'MySQL ' : '').mysql_get_server_info($this->link_identifier);
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysql_error(),
+				'code'		=> @mysql_errno()
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($this->last_query) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br /></td></tr></table>';
 
 		if ($this->in_transaction)
 		{
@@ -427,8 +447,6 @@
 		}
 
 		trigger_error($message, E_USER_ERROR);
-		
-		script_close(false);
 	}
 
 	function _debug($mode, $backtrace)
@@ -634,6 +652,7 @@
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
 
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 

Modified: cms/trunk/includes/db/mysql3.php
===================================================================
--- cms/trunk/includes/db/mysql3.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/db/mysql3.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -64,7 +64,12 @@
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
-		
+
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		if (!isset($error))
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
@@ -125,7 +130,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -348,14 +353,22 @@
 		return (($return_dbname) ? 'MySQL ' : '').mysql_get_server_info($this->link_identifier);
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysql_error(),
+				'code'		=> @mysql_errno()
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br /></td></tr></table>';
+		$message = '<br clear="all"/><table><tr><td><u>SQL ERROR</u><br /><br />' . @mysql_error() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br /></td></tr></table>';
 
 		if ($this->in_transaction)
 		{
@@ -572,7 +585,8 @@
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
 		$index_name = ($index_name) ? $index_name : $field;
-		
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/db/mysqli.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -27,7 +27,7 @@
 	var $db_layer = 'mysqli';
 
 	var $last_result;
-	var $return_on_error;
+	var $report_error = true;
 	var $in_transaction;
 
 	var $queries_time = 0;
@@ -62,15 +62,19 @@
 				mysqli_query($this->link_identifier, 'SET NAMES utf8');
 
 				//mysqli_query($this->link_identifier, 'SET character_set_results = NULL');
-				//mysqli_set_charset($this->link_identifier, "utf8");
 
 				return $this->link_identifier;
 			}
 
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
 		}
+
+		if (!$this->report_error)
+		{
+			return false;
+		}
 		
-		if (!$error)
+		if (!isset($error))
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 		}
@@ -92,9 +96,9 @@
 		$this->link_identifier = false;
 	}
 
-	function sql_return_on_error($fail = false)
+	function report_error($report)
 	{
-		$this->return_on_error = $fail;
+		$this->report_error = ($report);
 	}
 
 	function transaction($option = 'start', $auto_rollback = true)
@@ -181,9 +185,9 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
-		elseif (strpos($query, 'SELECT') === false)
+		elseif (strpos($query, 'SELECT') === 0)
 		{
 			$this->open_queries[(string) $this->last_result] = $this->last_result;
 		}
@@ -421,14 +425,22 @@
 		return mysqli_get_server_info($this->link_identifier);
 	}
 	
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @mysqli_error($this->link_identifier),
+				'code'		=> @mysqli_errno($this->link_identifier)
+			);
+		}
+
 		if ($this->return_on_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @mysqli_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $sql .'<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @mysqli_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $this->last_query .'<br />';
 
 		if ($this->in_transaction)
 		{
@@ -638,8 +650,9 @@
 
 	function add_table_index($field, $type  = 'index', $index_name = false)
 	{
-		$index_name = $index_name ? $index_name : $field;
-		
+		$index_name = ($index_name) ? $index_name : $field;
+		$index_name = is_array($index_name) ? implode('_', $index_name) : $index_name;
+
 		$field = is_array($field) ? implode('` , `', $field) : $field;
 
 		switch ($type)

Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/db/postgres.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -75,24 +75,30 @@
 
 		$connection_string = implode(' ', $connection_string);
 
-
 		$this->link_identifier = ($db['persistent']) ? @pg_pconnect($connection_string) : @pg_connect($connection_string);
 
 		if ($this->link_identifier)
 		{
-			//pg_set_client_encoding($this->link_identifier, 'UNICODE');
-			//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
+			if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
+			{
+				pg_set_client_encoding($this->link_identifier, 'UNICODE');
+				//pg_set_client_encoding($this->link_identifier, 'UTF8');  pg8.1 unicode still works tho
+				//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'UNICODE'"); SET NAMES 'UNICODE'
+			}
 
-			//pg_query($this->link_identifier, "SET CLIENT_ENCODING TO 'value'"); SET NAMES 'value'
 			return $this->link_identifier;
 		}
 
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
 
 		$this->disconnect();
+
 		trigger_error($error, E_USER_ERROR);
-
-		die;
 	}
 
 	function disconnect()
@@ -102,7 +108,7 @@
 			return;
 		}
 
-		@pg_close($this->link_identifier);
+		pg_close($this->link_identifier);
 		$this->link_identifier = false;
 	}
 
@@ -110,6 +116,7 @@
 	{
 		$this->report_error = ($report);
 	}
+
 	function transaction($option = 'start', $auto_rollback = true)
 	{
 		$result = false;
@@ -186,7 +193,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -329,7 +336,7 @@
 			return false;
 		}
 
-		return @pg_fetch_assoc($result);
+		return pg_fetch_assoc($result);
 	}
 
 	function fetch_row_num($result = false)
@@ -339,7 +346,7 @@
 			return false;
 		}
 
-		return @pg_fetch_row($result);
+		return pg_fetch_row($result);
 	}
 
 	function fetch_row_both($result = false)
@@ -349,12 +356,12 @@
 			return false;
 		}
 
-		return @pg_fetch_array($result);
+		return pg_fetch_array($result);
 	}
 
 	function insert_id($table, $column)
 	{
-		$oid = @pg_last_oid($this->last_result);
+		$oid = pg_last_oid($this->last_result);
 
 		/* 
 		Shouldn't be need, but incase they don't have oid support ( not sure why they wouldn't )
@@ -389,7 +396,7 @@
 
 		unset($this->open_queries[(int) $result]);
 
-		return @pg_free_result($result);
+		return pg_free_result($result);
 	}
 
 	function escape($text)
@@ -421,14 +428,22 @@
 		}
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			return array(
+				'message'	=> @pg_last_error($this->link_identifier),
+				'code'		=> ''
+			);
+		}
+		
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @pg_last_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $sql .'<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @pg_last_error($this->link_identifier) . '<br /><br />File: <br/>'.$backtrace['file'].'<br/><br />Line:<br/>'.$backtrace['line'].'<br /><br /><u>SQL</u><br /><br />' . $this->last_query .'<br />';
 
 		if ($this->in_transaction)
 		{
@@ -490,14 +505,14 @@
 				{
 					if (strpos('SELECT', $this->last_query) === 0)
 					{
-						if ($result = @pg_query($this->link_identifier, 'EXPLAIN '.$this->last_query))
+						if ($result = pg_query($this->link_identifier, 'EXPLAIN '.$this->last_query))
 						{
-							while ($row = @pg_fetch_assoc($result))
+							while ($row = pg_fetch_assoc($result))
 							{
 								$this->query_details[$this->num_queries][] = $row;
 							}
 
-							@pg_free_result($result);
+							pg_free_result($result);
 						}
 					}
 					else

Modified: cms/trunk/includes/db/sqlite.php
===================================================================
--- cms/trunk/includes/db/sqlite.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/db/sqlite.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -172,7 +172,7 @@
 
 		if ($this->last_result === false)
 		{
-			$this->_error($query, $backtrace);
+			$this->sql_error($backtrace);
 		}
 		elseif (strpos($query, 'SELECT') === 0)
 		{
@@ -407,14 +407,24 @@
 		return (($return_dbname) ? 'SQLITE ' : '').sqlite_libversion();
 	}
 
-	function _error($sql = '', $backtrace)
+	function sql_error($backtrace, $return = false)
 	{
+		if ($return)
+		{
+			$code = @sqlite_last_error($this->link_identifier);
+
+			return array(
+				'message'	=> @sqlite_error_string($code),
+				'code'		=> $code
+			);
+		}
+
 		if (!$this->report_error)
 		{
 			return;
 		}
 
-		$message = '<u>SQL ERROR</u><br /><br />' . @sqlite_error_string(@sqlite_last_error($this->link_identifier)) . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br />';
+		$message = '<u>SQL ERROR</u><br /><br />' . @sqlite_error_string(@sqlite_last_error($this->link_identifier)) . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($this->last_query) ? '<br /><br /><u>SQL</u><br /><br />' . $this->last_query : '') . '<br />';
 
 		if ($this->in_transaction)
 		{

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/display/display.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -181,7 +181,6 @@
 			'SITE_BASE'			=>	generate_base_url(),
 			'SITE_CHARSET'		=>	'UTF-8',
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
-			'SITE_URL'			=>	$_CORE_CONFIG['global']['site_url'],
 			'HEADER_MESSAGE'	=>	$this->message,
 			'HEADER_REGULAR'	=>	$this->header['meta'].$this->header['regular'],
 			'HEADER_JS' 		=>	$this->header['js'],

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/display/template.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -48,20 +48,10 @@
     /*
 		Assign variable to be used in template
     */
-// rewmove array from here
+
 	function assign($var, $value = false)
     {
-		if (is_array($var))
-		{
-			foreach ($var as $name => $value)
-			{
-				$this->_vars[$name] = $value;
-			}
-		}
-		else
-		{
-			$this->_vars[$var] = $value;
-		}
+		$this->_vars[$var] = $value;
 	}
 
     function assign_array($var, $value = false)

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/functions.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -803,6 +803,7 @@
 			@flock($fp, LOCK_UN);
 			fclose($fp);
 		}
+
 		return $bytes;
 	}
 }

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/tables.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -173,71 +173,71 @@
 
 // Table names
 
-define('FORUMS_ACL_TABLE', $prefix.'forums_auth');
-define('FORUMS_ACL_OPTIONS_TABLE', $prefix.'forums_auth_options');
-//define('ACL_DEPS_TABLE', $prefix.'forums_auth_deps');
-define('FORUMS_ACL_PRESETS_TABLE', $prefix.'forums_auth_presets');
+define('FORUMS_ACL_TABLE', $table_prefix.'forums_auth');
+define('FORUMS_ACL_OPTIONS_TABLE', $table_prefix.'forums_auth_options');
+//define('ACL_DEPS_TABLE', $table_prefix.'forums_auth_deps');
+define('FORUMS_ACL_PRESETS_TABLE', $table_prefix.'forums_auth_presets');
 
-define('FORUMS_ATTACHMENTS_TABLE', $prefix.'forums_attachments');
-define('FORUMS_BOOKMARKS_TABLE', $prefix.'forums_bookmarks');
-define('FORUMS_BBCODES_TABLE', $prefix.'forums_bbcodes');
-define('FORUMS_CONFIG_TABLE', $prefix.'forums_config');
-define('FORUMS_DRAFTS_TABLE', $prefix.'forums_drafts');
-define('FORUMS_FORUMS_TABLE', $prefix.'forums_forums');
-define('FORUMS_ACCESS_TABLE', $prefix.'forums_access');
-define('FORUMS_ICONS_TABLE', $prefix.'forums_icons');
-define('FORUMS_LOG_TABLE', $prefix.'forums_log');
-define('FORUMS_MODERATOR_TABLE', $prefix.'forums_moderator_cache');
-define('FORUMS_MODULES_TABLE', $prefix . 'forums_modules');
-define('FORUMS_POSTS_TABLE', $prefix.'forums_posts');
-define('FORUMS_PRIVMSGS_TABLE', $prefix.'forums_privmsgs');
-define('FORUMS_PRIVMSGS_TO_TABLE', $prefix.'forums_privmsgs_to');
-define('FORUMS_PRIVMSGS_FOLDER_TABLE', $prefix.'forums_privmsgs_folder');
-define('FORUMS_PRIVMSGS_RULES_TABLE', $prefix.'forums_privmsgs_rules');
-define('FORUMS_REPORTS_TABLE', $prefix.'forums_reports');
-define('FORUMS_REASONS_TABLE', $prefix.'forums_reports_reasons');
-define('FORUMS_SEARCH_TABLE', $prefix.'forums_search_results');
-define('FORUMS_SEARCH_WORD_TABLE', $prefix.'forums_search_wordlist');
-define('FORUMS_SEARCH_MATCH_TABLE', $prefix.'forums_search_wordmatch');
-define('FORUMS_TOPICS_TABLE', $prefix.'forums_topics');
-define('FORUMS_POLL_OPTIONS_TABLE', $prefix.'forums_poll_results');
-define('FORUMS_POLL_VOTES_TABLE', $prefix.'forums_poll_voters');
-define('FORUMS_WORDS_TABLE', $prefix.'forums_words');
-define('FORUMS_WATCH_TABLE', $prefix.'forums_watch');
-define('FORUMS_TRACK_TABLE', $prefix.'forums_tracking');
-define('FORUMS_RANKS_TABLE', $prefix.'forums_ranks');
+define('FORUMS_ATTACHMENTS_TABLE', $table_prefix.'forums_attachments');
+define('FORUMS_BOOKMARKS_TABLE', $table_prefix.'forums_bookmarks');
+define('FORUMS_BBCODES_TABLE', $table_prefix.'forums_bbcodes');
+define('FORUMS_CONFIG_TABLE', $table_prefix.'forums_config');
+define('FORUMS_DRAFTS_TABLE', $table_prefix.'forums_drafts');
+define('FORUMS_FORUMS_TABLE', $table_prefix.'forums_forums');
+define('FORUMS_ACCESS_TABLE', $table_prefix.'forums_access');
+define('FORUMS_ICONS_TABLE', $table_prefix.'forums_icons');
+define('FORUMS_LOG_TABLE', $table_prefix.'forums_log');
+define('FORUMS_MODERATOR_TABLE', $table_prefix.'forums_moderator_cache');
+define('FORUMS_MODULES_TABLE', $table_prefix . 'forums_modules');
+define('FORUMS_POSTS_TABLE', $table_prefix.'forums_posts');
+define('FORUMS_PRIVMSGS_TABLE', $table_prefix.'forums_privmsgs');
+define('FORUMS_PRIVMSGS_TO_TABLE', $table_prefix.'forums_privmsgs_to');
+define('FORUMS_PRIVMSGS_FOLDER_TABLE', $table_prefix.'forums_privmsgs_folder');
+define('FORUMS_PRIVMSGS_RULES_TABLE', $table_prefix.'forums_privmsgs_rules');
+define('FORUMS_REPORTS_TABLE', $table_prefix.'forums_reports');
+define('FORUMS_REASONS_TABLE', $table_prefix.'forums_reports_reasons');
+define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
+define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
+define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');
+define('FORUMS_TOPICS_TABLE', $table_prefix.'forums_topics');
+define('FORUMS_POLL_OPTIONS_TABLE', $table_prefix.'forums_poll_results');
+define('FORUMS_POLL_VOTES_TABLE', $table_prefix.'forums_poll_voters');
+define('FORUMS_WORDS_TABLE', $table_prefix.'forums_words');
+define('FORUMS_WATCH_TABLE', $table_prefix.'forums_watch');
+define('FORUMS_TRACK_TABLE', $table_prefix.'forums_tracking');
+define('FORUMS_RANKS_TABLE', $table_prefix.'forums_ranks');
 
 
-define('ADMIN_AUTH_TABLE', 'test_admins');
+define('ADMIN_AUTH_TABLE', $table_prefix.'admins');
 
-define('BLOCKS_TABLE', 'test_blocks');
+define('BLOCKS_TABLE', $table_prefix.'blocks');
 
-define('CORE_CONFIG_TABLE', 'test_config');
-define('CORE_MODULES_TABLE', $prefix.'modules');
+define('CORE_CONFIG_TABLE', $table_prefix.'config');
+define('CORE_MODULES_TABLE', $table_prefix.'modules');
 
-define('SMILIES_TABLE', 'test_smilies');
+define('SMILIES_TABLE', $table_prefix.'smilies');
 
-define('USER_GROUP_TABLE', 'test_groups_members');
-define('GROUPS_TABLE', 'test_groups');
+define('USER_GROUP_TABLE', $table_prefix.'groups_members');
+define('GROUPS_TABLE', $table_prefix.'groups');
 
-define('SESSIONS_AUTOLOGIN_TABLE', 'test_sessions_auto_login');
-define('SESSIONS_TABLE', $prefix.'sessions');
+define('SESSIONS_AUTOLOGIN_TABLE', $table_prefix.'sessions_auto_login');
+define('SESSIONS_TABLE', $table_prefix.'sessions');
 
 
-define('EXTENSIONS_TABLE', $prefix.'forums_extensions');
-define('EXTENSION_GROUPS_TABLE', $prefix.'forums_extension_groups');
+define('EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
+define('EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
-define('USERS_TABLE', $prefix.'users');
-define('USERS_NOTES_TABLE', $prefix.'forums_users_notes');
-define('ZEBRA_TABLE', $prefix.'forums_zebra');
-//define('LOG_TABLE', $prefix.'log');
+define('USERS_TABLE', $user_prefix.'users');
+define('USERS_NOTES_TABLE', $table_prefix.'forums_users_notes');
+define('ZEBRA_TABLE', $table_prefix.'forums_zebra');
+//define('LOG_TABLE', $table_prefix.'log');
 
 
 // can be removed
-define('PROFILE_FIELDS_TABLE', $prefix.'forums_profile_fields');
-define('PROFILE_LANG_TABLE', $prefix.'forums_profile_lang');
-define('PROFILE_DATA_TABLE', $prefix.'forums_profile_fields_data');
-define('PROFILE_FIELDS_LANG_TABLE', $prefix.'forums_profile_fields_lang');
-define('DISALLOW_TABLE', $prefix.'forums_disallow');
+define('PROFILE_FIELDS_TABLE', $table_prefix.'forums_profile_fields');
+define('PROFILE_LANG_TABLE', $table_prefix.'forums_profile_lang');
+define('PROFILE_DATA_TABLE', $table_prefix.'forums_profile_fields_data');
+define('PROFILE_FIELDS_LANG_TABLE', $table_prefix.'forums_profile_fields_lang');
+define('DISALLOW_TABLE', $table_prefix.'forums_disallow');
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/templates/login_admin.html
===================================================================
--- cms/trunk/includes/templates/login_admin.html	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/includes/templates/login_admin.html	2005-09-10 14:40:33 UTC (rev 107)
@@ -14,7 +14,7 @@
     margin: 0%;
     padding: 0px;
     background-color: white;
-    background: url(/images/bg.gif);
+    background: url(images/bg.gif);
 }
 
 .error { color: red; }

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/install/build_data.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -21,440 +21,438 @@
 $Id$
 */
 
-$install_prefix = 'test_';
 $time = gmtime();
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admins (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_url', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
 
 
 //Admin
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
 $admin_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 $guest_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 $bot_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
 
 // Forums
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
 
 // START: This should be replaced by beta
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
 // ADMINISTRATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
 // SUPER MODERATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$install_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
 
 // to be removed
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)");
 ////
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
-$_CLASS['core_db']->query('INSERT INTO '.$install_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PROFILE', 'profile', 3, 1, 'profile_info\r\nreg_details\r\nsignature\r\navatar', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PREFS', 'prefs', 4, 1, 'personal\r\nview\r\npost', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ZEBRA', 'zebra', 5, 1, 'friends\r\nfoes', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
 ?>
\ No newline at end of file

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/install/build_tables.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -21,8 +21,6 @@
 $Id$
 */
 
-$install_prefix = 'test_';
-
 function field_unix_time($name, $null = false)
 {
 	global $_CLASS;
@@ -34,7 +32,7 @@
 	Admin Auth Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'admins');
+$_CLASS['core_db']->table_create('start', $table_prefix.'admins');
 
 $_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
@@ -52,7 +50,7 @@
 /*
 	Blocks Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'blocks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'blocks');
 
 $_CLASS['core_db']->add_table_field_int('block_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('block_title', 100);
@@ -78,7 +76,7 @@
 /*
 	Config Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'config');
+$_CLASS['core_db']->table_create('start', $table_prefix.'config');
 
 $_CLASS['core_db']->add_table_field_char('config_section', 20);
 $_CLASS['core_db']->add_table_field_char('config_name', 20);
@@ -95,7 +93,7 @@
 	Groups Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'groups');
+$_CLASS['core_db']->table_create('start', $table_prefix.'groups');
 
 // this section needs updating, with null fields
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
@@ -127,7 +125,7 @@
 /*
 	Groups Members Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'groups_members');
+$_CLASS['core_db']->table_create('start', $table_prefix.'groups_members');
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -142,7 +140,7 @@
 /*
 	Modules Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'modules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'modules');
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
@@ -162,7 +160,7 @@
 /*
 	Sessions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'sessions');
+$_CLASS['core_db']->table_create('start', $table_prefix.'sessions');
 
 $_CLASS['core_db']->add_table_field_char('session_id', 40);
 $_CLASS['core_db']->add_table_field_int('session_user_id', array('max' => 16000000));
@@ -189,7 +187,7 @@
 /*
 	Sessions Auto login Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'sessions_auto_login');
+$_CLASS['core_db']->table_create('start', $table_prefix.'sessions_auto_login');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('auto_login_browser', 255);
@@ -203,7 +201,7 @@
 /*
 	Smiles Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'smilies');
+$_CLASS['core_db']->table_create('start', $table_prefix.'smilies');
 
 $_CLASS['core_db']->add_table_field_int('smiley_id', array('max' => 16000000, 'auto_increment' => true));
 
@@ -226,7 +224,7 @@
 `user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'users');
+$_CLASS['core_db']->table_create('start', $user_prefix.'users');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('username', 80);
@@ -324,7 +322,7 @@
 /*
 	Attachments Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_attachments');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_attachments');
 
 $_CLASS['core_db']->add_table_field_int('attach_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('post_msg_id', array('max' => 16000000));
@@ -352,7 +350,7 @@
 /*
 	Forums Auth Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
@@ -369,7 +367,7 @@
 /*
 	Forums Auth Options Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_options');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_options');
 
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('auth_option', 20);
@@ -385,7 +383,7 @@
 /*
 	Forums Auth Presets Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_auth_presets');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_presets');
 
 $_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000));
 $_CLASS['core_db']->add_table_field_int('preset_user_id', array('max' => 16000000));
@@ -402,7 +400,7 @@
 /*
 	Forums Bookmarks Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_bookmarks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_bookmarks');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -416,7 +414,7 @@
 /*
 	Forums Config Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_config');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_config');
 
 $_CLASS['core_db']->add_table_field_char('config_name', 100);
 $_CLASS['core_db']->add_table_field_char('config_value', 255);
@@ -431,7 +429,7 @@
 	Forums Disallow Table
 */
 /*
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_disallow');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_disallow');
 
 $_CLASS['core_db']->add_table_field_int('disallow_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('disallow_username', 30);
@@ -444,7 +442,7 @@
 /*
 	Forums Drafts Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_drafts');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_drafts');
 
 $_CLASS['core_db']->add_table_field_int('draft_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -463,7 +461,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_extensions');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extensions');
 
 $_CLASS['core_db']->add_table_field_int('extension_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
@@ -476,7 +474,7 @@
 /*
 	Forums Extension Groups Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_extension_groups');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extension_groups');
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 20);
@@ -495,7 +493,7 @@
 /*
 	Forums Forums Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_forums');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_forums');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('parent_id', array('max' => 16000));
@@ -546,7 +544,7 @@
 /*
 	Forums POsts Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_posts');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_posts');
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -588,7 +586,7 @@
 /*
 	Forums Topics Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_topics');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_topics');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
@@ -639,7 +637,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_tracking');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_tracking');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
@@ -655,7 +653,7 @@
 /*
 	Forums Icons Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_icons');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_icons');
 
 $_CLASS['core_db']->add_table_field_int('icons_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('icons_url', 50);
@@ -672,7 +670,7 @@
 	Forums Forums Watch Table
 */
 
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_watch');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_watch');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -689,7 +687,7 @@
 /*
 	Forums Modules Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_modules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_modules');
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_type', 3);
@@ -709,7 +707,7 @@
 /*
 	Forums Moderator Cache Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_moderator_cache');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_moderator_cache');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -728,7 +726,7 @@
 /*
 	Forums Poll Results Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_results');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_results');
 
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -743,7 +741,7 @@
 /*
 	Forums Poll Voters Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_poll_voters');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_voters');
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
@@ -761,7 +759,7 @@
 /*
 	Forums Poll Voters Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_ranks');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_ranks');
 
 $_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('rank_title', 50);
@@ -776,7 +774,7 @@
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordlist');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordlist');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('word_text', 100);
@@ -790,7 +788,7 @@
 /*
 	Forums search_wordmatch Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_search_wordmatch');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordmatch');
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000));
@@ -803,7 +801,7 @@
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_words');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_words');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('word', 100);
@@ -816,7 +814,7 @@
 /*
 	Forums Zebra Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_zebra');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_zebra');
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('zebra_id', array('max' => 16000000));
@@ -833,7 +831,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_log');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_log');
 
 $_CLASS['core_db']->add_table_field_int('log_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('log_type', array('max' => 200));
@@ -857,7 +855,7 @@
 
 /*
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs');
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('root_level', array('max' => 16000000));
@@ -896,7 +894,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_folder');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_folder');
 
 $_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -911,7 +909,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_rules');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_rules');
 
 $_CLASS['core_db']->add_table_field_int('rule_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -930,7 +928,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $install_prefix.'forums_privmsgs_to');
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_to');
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));

Modified: cms/trunk/install/installer.php
===================================================================
--- cms/trunk/install/installer.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/install/installer.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -20,11 +20,12 @@
 
 $Id$
 */
+define('VIPERAL', 'INSTALLER');
 
 error_reporting(E_ALL);
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = 'C:/Program Files/Apache Group/Apache2/cms/';
+$site_file_root = '../';
 
 if (!extension_loaded('mbstring'))
 {
@@ -50,102 +51,426 @@
 
 load_class(false, 'core_template');
 
-$_REQUEST['stage'] = isset($_REQUEST['stage']) ? (int) $_REQUEST['stage'] : 0;
+$holding_array = array(
+	'mysql'		=> array(
+		'lang'			=> 'MySQL',
+		'extension'		=> 'mysql', 
+	),
+	'mysql3'			=> array(
+		'lang'			=> 'MySQL3',
+		'extension'		=> 'mysql',
+	),
+	'mysqli'	=> array(
+		'lang'			=> 'MySQL 4.1.x',
+		'extension'		=> 'mysqli', 
+	),
+	'mssql'		=> array(
+		'lang'			=> 'MS SQL Server 7/2000',
+		'extension'		=> 'mssql', 
+	),
+	'postgres' => array(
+		'lang'			=> 'PostgreSQL',
+		'extension'		=> 'pgsql', 
+	),
+	'sqlite'		=> array(
+		'lang'			=> 'SQLite',
+		'extension'		=> 'sqlite', 
+	),
+	'sqlite_pdo'		=> array(
+		'lang'			=> 'SQLite 3 (PDO)',
+		'extension'		=> 'pdo_sqlite', 
+	)
+);
 
-if ($_REQUEST['stage'] && !$_POST['agreement_signed'])
+$database_array = array();
+$database_options = '';
+$db_layer = isset($_POST['layer']) ? $_POST['layer'] : false;
+
+foreach ($holding_array as $name => $setting)
+{
+	if (extension_loaded($setting['extension']))
+	{
+		$database_options .= '<option value="' . $name . '"'.(($db_layer == $name) ? ' selected="selected"' : '').'>' . $setting['lang'] . '</option>';
+		$database_array[$name] = $setting;
+	}
+}
+
+$error = array();
+$stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
+
+if ($stage && !$_POST['agreement_signed'])
 {
-	$_REQUEST['stage'] = 0;
+	$stage = 0;
 }
 
-Switch ($_REQUEST['stage'])
+if ($stage === 3)
 {
-	case 1:
-		$holding_array = array(
-			'mysql'		=> array(
-				'lang'			=> 'MySQL',
-				'extension'		=> 'mysql', 
-			),
-			'mysql3'			=> array(
-				'lang'			=> 'MySQL3',
-				'extension'		=> 'mysql',
-			),
-			'mysqli'	=> array(
-				'lang'			=> 'MySQL 4.1.x',
-				'extension'		=> 'mysqli', 
-			),
-			'mssql'		=> array(
-				'lang'			=> 'MS SQL Server 7/2000',
-				'extension'		=> 'mssql', 
-			),
-			'postgres' => array(
-				'lang'			=> 'PostgreSQL',
-				'extension'		=> 'pgsql', 
-			),
-			'sqlite'		=> array(
-				'lang'			=> 'SQLite',
-				'extension'		=> 'sqlite', 
-			),
-			'sqlite_pdo'		=> array(
-				'lang'			=> 'SQLite 3 (PDO)',
-				'extension'		=> 'pdo_sqlite', 
-			)
+	if (file_exists($site_file_root.'config.php'))
+	{
+		require_once($site_file_root.'config.php');
+	}
+
+	$site_name		= get_variable('site_name', 'POST');
+	$site_domain	= get_variable('site_domain', 'POST');
+	$site_path		= get_variable('site_path', 'POST');
+	$site_port		= get_variable('site_port', 'POST');
+
+	$cookie_domain	= get_variable('cookie_domain', 'POST');
+	$cookie_path	= get_variable('cookie_path', 'POST');
+	$cookie_name	= get_variable('cookie_name', 'POST');
+
+	$username		= get_variable('username', 'POST');
+	$password		= get_variable('password', 'POST');
+	$password_confirm= get_variable('password_confirm', 'POST');
+	$email			= get_variable('email', 'POST');
+	$email_confirm	= get_variable('email_confirm', 'POST');
+
+	if (!$username)
+	{
+		$error[] = 'Invalid Username';
+	}
+
+	if (!$password || ($password !== $password_confirm))
+	{
+		$error[] = 'Passwords do not match.';
+	}
+
+	if (!$email || ($email !== $email_confirm))
+	{
+		$error[] = 'Emails Address do not match.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (isset($site_db))
+	{
+		load_class($site_file_root.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
+
+		$_CLASS['core_db']->connect($site_db);
+		$config_content = '';
+	}
+	else
+	{
+		$error[] = '<b>Please upload the content listed in the "Config.php Content" Section</b>';
+		$config_content = get_variable('config_content', 'POST');
+	}
+
+	if (empty($error))
+	{
+		require_once($site_file_root.'includes/tables.php');
+		require_once($site_file_root.'includes/cache/cache.php');
+		require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+
+		load_class(false, 'core_cache', 'cache_'.$acm_type);
+
+		set_core_config('global', 'site_name', $site_name, false);
+		set_core_config('server', 'site_domain', $site_domain, false);
+		set_core_config('server', 'site_path', $site_path, false);
+		set_core_config('server', 'site_port', $site_port, false);
+		set_core_config('server', 'cookie_domain', $cookie_domain, false);
+		set_core_config('server', 'cookie_path', $cookie_path, false);
+		set_core_config('server', 'cookie_name', $cookie_name, false);
+		set_core_config('server', 'site_secure', 0, false);
+
+		set_core_config('user', 'newest_username', $username, true);
+		
+		$user_update = array(
+			'username'				=> $username,
+			'user_password'			=> encode_password($password, 'md5'),
+			'user_password_encoding'=> 'md5',
+			'user_email'			=> $email
 		);
+
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
+
+		$_CLASS['core_template']->assign_array(array(
+			'admin_link'		=> generate_link(false, array('full' => true, 'sid' => false, 'admin' => true)),
+			'username'			=> $username,
+		));
+
+		$_CLASS['core_template']->display('installer/complete.html');
 		
-		$database_array = array();
-		$database_options = '';
+		script_close();
+	}
 
-		foreach ($holding_array as $name => $setting)
-		{
-			if (extension_loaded($setting['extension']))
-			{
-				$database_options .= '<option value="' . $name . '">' . $setting['lang'] . '</option>';
-				$database_array[$name] = $setting;
-			}
+	$_CLASS['core_template']->assign_array(array(
+		'site_name'			=> $site_name,
+		'site_domain'		=> $site_domain,
+		'site_path'			=> $site_path,
+		'site_port'			=> $site_port,
+		'cookie_domain'		=> $cookie_domain,
+		'cookie_path'		=> $cookie_path,
+		'cookie_name'		=> $cookie_name,
+		'username'			=> $username,
+		'password'			=> $password,
+		'password_confirm'	=> $password_confirm,
+		'email'				=> $email,
+		'email_confirm'		=> $email_confirm,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+		'config_content'	=> $config_content
+	));
+
+	$_CLASS['core_template']->display('installer/stage2.html');
+
+	script_close();
+}
+
+if ($stage === 2)
+{
+	if ($db_layer && in_array($db_layer, array_keys($database_array)))
+	{
+		load_class($site_file_root.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
+
+		$site_db = array();
+		$site_db['type']		= $db_layer;
+		$site_db['persistent']	= false;
+
+		$_CLASS['core_db']->report_error(false);
+
+		if (strpos($db_layer, 'sqlite') === false)
+		{
+			$site_db['server']		= get_variable('server', 'POST');
+			$site_db['port']		= get_variable('port', 'POST');
+			$site_db['database']	= get_variable('database', 'POST');
+			$site_db['username']	= get_variable('username', 'POST');
+			$site_db['password']	= get_variable('password', 'POST');
+			
+			if (!$site_db['username'] || !$site_db['database'])
+			{
+				$error[] = 'Required Information missing';
+			}
 		}
+		else
+		{
+			$site_db['file'] = get_variable('file_'.$db_layer, 'POST');
 
-		$php_config = array(
-			/*array(
-				'lang'	=> 'PHP version',
-				'recommended'	=> '4.2.3 +',
-				'current'		=> PHP_VERSION
-			),*/
-			array(
-				'lang'	=> 'Safe Mode',
-				'ini'	=> 'safe_mode',
-				'recommended'	=> false,
-				'current'		=> (bool) ini_get('safe_mode')
-			),
-			array(
-				'lang'	=> 'Magic Quotes GPC',
-				'ini'	=> 'magic_quotes_gpc',
-				'recommended'	=> false,
-				'current'		=> (bool) ini_get('magic_quotes_gpc')
-			),
-			array(
-				'lang'	=> 'Register Globals',
-				'ini'	=> 'register_globals',
-				'recommended'	=> false,
-				'current'		=> (bool) ini_get('register_globals')
-			),
-			array(
-				'lang'	=> 'Output Buffering',
-				'ini'	=> 'output_buffering',
-				'recommended'	=> false,
-				'current'		=> (bool) ini_get('output_buffering')
-			),
-		);
+			if (!$site_db['file'])
+			{
+				$error[] = 'Required Information missing';
+			}
+		}
+	}
+	else
+	{
+		$error[] = 'Database not supported on your system';
+	}
 
+	if (empty($error) && !$_CLASS['core_db']->connect($site_db))
+	{
+		if (!$_CLASS['core_db']->link_identifier)
+		{
+			$db_error = $_CLASS['core_db']->sql_error(false, true);
+			$error[] = 'Could not connect to the database'.(($db_error['message']) ? '<br/>'.$db_error['message'] : '');
+		}
+		else
+		{
+			if (isset($_POST['test']))
+			{
+				$error[] = 'Database Selection fail, will attempt to create in next step';
+			}
+			else
+			{
+				switch ($db_layer)
+				{
+					case 'mysql':
+					case 'mysqli':
+						$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'].' DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci');
+					break;
+
+					case 'mysql3':
+						$_CLASS['core_db']->query('CREATE DATABASE  '.$site_db['database']);
+					break;
+
+					case 'postgres':
+						if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'] .' WITH ENCODING UNICODE');
+						}
+						else
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database']);
+						}
+					break;
+				}
+
+				$_CLASS['core_db']->disconnect();
+				$_CLASS['core_db']->connect($site_db);
+
+				if (!$_CLASS['core_db']->connect($site_db))
+				{
+					$error[] = 'Database Creation Failed';
+				}
+			}
+		}
+	}
+	
+	if (empty($error))
+	{
+		$user_prefix	= get_variable('user_prefix', 'POST');
+		$table_prefix	= get_variable('table_prefix', 'POST');
+		
+		require_once($site_file_root.'includes/tables.php');
+	
+		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->free_result($result);
+	
+		if ($result)
+		{
+			$error[] = 'Creation Failed: Current installation found';
+		}
+	}
+
+	if (isset($_POST['test']) || !empty($error))
+	{
+		$stage = 1;
+	}
+	else
+	{
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_tables.php');
+		$_CLASS['core_db']->transaction('commit');
+	
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_data.php');
+		$_CLASS['core_db']->transaction('commit');
+		
+		$_CLASS['core_db']->optimize_tables();
+		
+		$_CLASS['core_db']->report_error(true);
+	
+		$config_data = "<?php\n\n";
+
+		foreach ($site_db as $name => $value)
+		{
+			if (is_bool($value))
+			{
+				$value = ($value) ? 'true' : 'false';
+			}
+			elseif (!is_int($value))
+			{
+				$value = "'$value'";
+			}
+
+			$config_data .= "\$site_db['$name'] = $value;\n";
+		}
+
+		$config_data .= "\n";
+		$config_data .= "\$table_prefix\t= '$table_prefix';\n";
+		$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
+		$config_data .= "\$acm_type\t\t= 'file';\n\n";
+		$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
+		$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
+		$config_data .= '?>';
+
+		if (file_put_contents($site_file_root.'config.php', $config_data))
+		{
+			$config_data = false;
+		}
+		else
+		{
+			$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
+		}
+		
+		$path = dirname(getenv('SCRIPT_NAME'));
+
+		if (substr($path, -1) != '/')
+		{
+			$path .= '/';
+		}
+
+		$path = str_replace('install/', '', $path);
+		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
+
 		$_CLASS['core_template']->assign_array(array(
-			'database_options'	=> $database_options,
-			'php_config'		=> $php_config,
+			'site_name'			=> 'New CMS Site',
+			'site_domain'		=> $domain,
+			'site_path'			=> $path,
+			'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
+			'cookie_domain'		=> $domain,
+			'cookie_path'		=> $path,
+			'cookie_name'		=> 'cms',
+			'username'			=> '',
+			'password'			=> '',
+			'password_confirm'	=> '',
+			'email'				=> '',
+			'email_confirm'		=> '',
+			'error'				=> empty($error) ? false : implode('<br/>', $error),
+			'config_content'	=> $config_data
 		));
-		
-		$_CLASS['core_template']->display('installer/stage1.html');
-	break;
 
-	default:
-	case 0:
-		$_CLASS['core_template']->display('installer/agreement.html');
-	break;
+		$_CLASS['core_template']->display('installer/stage2.html');
+
+		script_close();
+	}
 }
+
+if ($stage === 1)
+{
+	$php_config = array(
+		/*array(
+			'lang'	=> 'PHP version',
+			'recommended'	=> '4.2.3 +',
+			'current'		=> PHP_VERSION
+		),*/
+		array(
+			'lang'	=> 'Safe Mode',
+			'ini'	=> 'safe_mode',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('safe_mode')
+		),
+		array(
+			'lang'	=> 'Magic Quotes GPC',
+			'ini'	=> 'magic_quotes_gpc',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('magic_quotes_gpc')
+		),
+		array(
+			'lang'	=> 'Register Globals',
+			'ini'	=> 'register_globals',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('register_globals')
+		),
+		array(
+			'lang'	=> 'Output Buffering',
+			'ini'	=> 'output_buffering',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('output_buffering')
+		),
+	);
+
+	$_CLASS['core_template']->assign_array(array(
+		'database_options'	=> $database_options,
+		'php_config'		=> $php_config,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+
+		'server'		=> isset($site_db['server']) ? $site_db['server'] : '',
+		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
+		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
+		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',
+		'password'		=> isset($site_db['password']) ? $site_db['password'] : '',
+		'file'			=> isset($site_db['file']) ? $site_db['file'] : '',
+		'table_prefix'	=> get_variable('table_prefix', 'POST', 'cms_'),
+		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
+	));
+
+	$_CLASS['core_template']->display('installer/stage1.html');
+
+	script_close();
+}
+
+if (!$stage)
+{
+	$_CLASS['core_template']->display('installer/agreement.html');
+	script_close();
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,11 +26,11 @@
     die;
 }
 
-global $prefix;
-
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 $_CLASS['core_user']->user_setup();

Modified: cms/trunk/modules/Quick_Message/install.php
===================================================================
--- cms/trunk/modules/Quick_Message/install.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/modules/Quick_Message/install.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -26,11 +26,11 @@
     die;
 }
 
-global $prefix;
-
+global $table_prefix;
+
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
-	define('QUICK_MESSAGE_TABLE', $prefix.'quick_message');
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
 class Quick_Message_install

Modified: cms/trunk/modules/articles/admin/index.php
===================================================================
--- cms/trunk/modules/articles/admin/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/modules/articles/admin/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -27,7 +27,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 if (isset($_REQUEST['mode']))

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/modules/articles/index.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -28,7 +28,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 $_CLASS['core_user']->user_setup();
@@ -58,7 +58,7 @@
 				trigger_error('ARTICLE_NOT_FOUND');
 			}
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'ARTICLES_POSTER' 		=> ($row['poster_name']) ? $row['poster_name'] : $_CLASS['core_user']->get_lang('ANONYMOUS'),
 				'ARTICLES_POSTER_LINK'	=> ($row['poster_name'] && $row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : '',
 				'ARTICLES_TEXT'			=> $row['articles_text'],

Modified: cms/trunk/modules/articles/install.php
===================================================================
--- cms/trunk/modules/articles/install.php	2005-09-09 16:05:50 UTC (rev 106)
+++ cms/trunk/modules/articles/install.php	2005-09-10 14:40:33 UTC (rev 107)
@@ -30,7 +30,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 class articles_install
@@ -64,9 +64,9 @@
 		$_CLASS['core_db']->add_table_field_char('approver_name', 80, true);
 
 		$_CLASS['core_db']->add_table_index('articles_id', 'primary');
-		$_CLASS['core_db']->add_table_index('articles_start');
+		$_CLASS['core_db']->add_table_index('articles_starts');
+		$_CLASS['core_db']->add_table_index('articles_expires');
 		//$_CLASS['core_db']->add_table_index('articles_type');
-		//$_CLASS['core_db']->add_table_index('articles_expires');
 		$_CLASS['core_db']->add_table_index('articles_order');
 		$_CLASS['core_db']->add_table_index('articles_status');
 



From viperal at berlios.de  Sun Sep 11 19:27:06 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 19:27:06 +0200
Subject: [Viperals-svncheckins] r108 - in cms/branches/1.0alpha1: . images images/avatars images/avatars/gallery images/avatars/gallery/gallery1 images/avatars/gallery/gallery2 includes includes/db includes/display includes/forums install javascript modules/Forums modules/Forums/admin themes/viperal/style themes/viperal/template/modules themes/viperal/template/modules/Forums themes/viperal/template/modules/Forums/images themes/viperal/template/modules/Forums/images/en themes/viperal/template/modules/Forums/images/karma
Message-ID: <200509111727.j8BHR65r004299@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 19:27:00 +0200 (Sun, 11 Sep 2005)
New Revision: 108

Added:
   cms/branches/1.0alpha1/images/avatars/
   cms/branches/1.0alpha1/images/avatars/gallery/
   cms/branches/1.0alpha1/images/avatars/gallery/067.gif
   cms/branches/1.0alpha1/images/avatars/gallery/068.gif
   cms/branches/1.0alpha1/images/avatars/gallery/069.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/001.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/002.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/003.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/004.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/005.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/006.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/007.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/008.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/009.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/010.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/011.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/012.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/013.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/014.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/015.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/016.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/017.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/018.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/019.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/020.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/021.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/022.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/023.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/024.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/025.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/026.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/027.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/028.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/029.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/030.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/031.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/032.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/033.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/034.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/035.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/036.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/037.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/038.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/039.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/040.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/041.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/042.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/043.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/044.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/045.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/046.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/047.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/048.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/049.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/050.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/051.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/052.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/053.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/054.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/055.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/056.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/057.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/058.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/059.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/060.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/061.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/062.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/063.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/064.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/065.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/066.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/067.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/068.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/069.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/070.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/071.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/072.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/073.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/074.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/075.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/076.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/077.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/078.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/079.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/080.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/081.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/082.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/083.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/084.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/085.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/086.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/087.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/088.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/089.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/090.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/091.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/092.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/093.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/094.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/095.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/096.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/097.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/098.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/099.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/100.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/101.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/102.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/103.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/104.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/105.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/106.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/107.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/108.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/109.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/110.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/111.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/112.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/113.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/114.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/115.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/116.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/117.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/118.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/119.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/120.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/121.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/Thumbs.db
   cms/branches/1.0alpha1/images/avatars/gallery/gallery1/blank.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/013.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/014.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/015.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/016.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/121.gif
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/Thumbs.db
   cms/branches/1.0alpha1/images/avatars/gallery/gallery2/blank.gif
   cms/branches/1.0alpha1/images/avatars/upload/
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/Thumbs.db
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/background.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic1.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic2.jpg
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic3.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/created_by.jpg
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/Thumbs.db
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_email.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_info.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_online.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_report.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_search.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_www.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_link_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_attach.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_reported.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.htm
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.php
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma0.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma1.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma2.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma3.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma4.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma5.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/no_avatar.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/progress_bar.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/sitelogo.jpg
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/spacer.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_delete.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_lock.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_move.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_split.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_unlock.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_lcap.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_rcap.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/voting_bar.gif
   cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/whosonline.gif
Removed:
   cms/branches/1.0alpha1/includes/forums/mcp/
   cms/branches/1.0alpha1/javascript/ajax.js
Modified:
   cms/branches/1.0alpha1/admin.php
   cms/branches/1.0alpha1/core.php
   cms/branches/1.0alpha1/includes/db/postgres.php
   cms/branches/1.0alpha1/includes/display/display.php
   cms/branches/1.0alpha1/includes/functions.php
   cms/branches/1.0alpha1/includes/handler.php
   cms/branches/1.0alpha1/install/build_data.php
   cms/branches/1.0alpha1/install/installer.php
   cms/branches/1.0alpha1/modules/Forums/admin/index.php
   cms/branches/1.0alpha1/modules/Forums/mcp.php
   cms/branches/1.0alpha1/modules/Forums/report.php
   cms/branches/1.0alpha1/themes/viperal/style/style.css
Log:
Fixed a few thing in alpha1 and finallzed it

Modified: cms/branches/1.0alpha1/admin.php
===================================================================
--- cms/branches/1.0alpha1/admin.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/admin.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -104,9 +104,6 @@
 		'MENU_MAIN_ITEMS'	=> $main_menu['menu'],
 ));
 
-
-//load_class($site_file_root.'includes/core_editor.php', 'core_editor');
-//$_CLASS['core_editor']->setup();
 require($file_path);
     
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/core.php
===================================================================
--- cms/branches/1.0alpha1/core.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/core.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -64,26 +64,33 @@
 	}
 }
 
+require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/functions.php');
-require_once($site_file_root.'config.php');
-require_once($site_file_root.'includes/tables.php');
 require_once($site_file_root.'includes/handler.php');
-require_once($site_file_root.'includes/db/'.$site_db['type'].'.php');
-require_once($site_file_root.'includes/display/template.php');
-require_once($site_file_root.'includes/cache/cache.php');
-require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+require_once($site_file_root.'config.php');
 
 // Load basic classes
-load_class(false, 'core_error_handler');
-load_class(false, 'core_cache', 'cache_'.$acm_type);
 load_class(false, 'core_template');
-load_class(false, 'core_db', 'db_'.$site_db['type']);
+load_class(false, 'core_error_handler');
 
 // Set error handler
 $_CLASS['core_error_handler']->start();
 //$_CLASS['core_error_handler']->stop();
 //error_reporting(E_ERROR | E_WARNING | E_PARSE);
 
+if (empty($site_db))
+{
+	trigger_error('<p style="text-align:center">Site isn\'t Installed<br/><a href="install/installer.php">Click here to install</a></p>', E_USER_ERROR);
+}
+
+require_once($site_file_root.'includes/tables.php');
+require_once($site_file_root.'includes/db/'.$site_db['type'].'.php');
+require_once($site_file_root.'includes/cache/cache.php');
+require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+
+load_class(false, 'core_cache', 'cache_'.$acm_type);
+load_class(false, 'core_db', 'db_'.$site_db['type']);
+
 if (function_exists('register_shutdown_function'))
 {
 	register_shutdown_function('script_close');
@@ -92,7 +99,7 @@
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 
-$_CLASS['core_db']->return_on_error = true;
+$_CLASS['core_db']->report_error(false);
 
 // Error messages just incase we can't get our configs
 $config_error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
@@ -137,7 +144,8 @@
 
 unset($config_error);
 
-$_CLASS['core_db']->return_on_error = false;
+$_CLASS['core_db']->report_error(true);
+
 $_CLASS['core_cache']->remove('core_config');
 $_CLASS['core_cache']->remove('config');
 
@@ -192,19 +200,6 @@
 	// error here
 }
 
-$install_prefix = 'test_';
-$time = gmtime();
-
-if (!function_exists('field_unix_time'))
-{
-	function field_unix_time($name, $null = false)
-	{
-		global $_CLASS;
-	
-		$_CLASS['core_db']->add_table_field_int($name, array('max' => 200000000, 'null' => $null));
-	}
-}
-
 function get_memory_usage()
 {
 	if (function_exists('memory_get_usage'))

Added: cms/branches/1.0alpha1/images/avatars/gallery/067.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/067.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/068.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/068.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/069.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/069.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/001.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/001.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/002.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/002.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/003.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/003.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/004.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/004.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/005.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/005.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/006.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/006.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/007.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/007.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/008.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/008.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/009.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/009.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/010.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/010.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/011.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/011.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/012.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/012.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/013.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/013.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/014.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/014.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/015.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/015.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/016.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/016.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/017.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/017.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/018.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/018.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/019.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/019.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/020.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/020.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/021.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/021.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/022.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/022.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/023.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/023.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/024.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/024.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/025.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/025.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/026.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/026.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/027.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/027.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/028.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/028.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/029.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/029.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/030.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/030.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/031.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/031.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/032.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/032.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/033.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/033.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/034.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/034.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/035.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/035.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/036.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/036.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/037.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/037.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/038.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/038.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/039.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/039.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/040.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/040.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/041.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/041.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/042.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/042.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/043.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/043.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/044.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/044.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/045.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/045.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/046.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/046.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/047.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/047.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/048.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/048.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/049.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/049.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/050.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/050.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/051.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/051.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/052.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/052.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/053.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/053.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/054.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/054.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/055.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/055.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/056.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/056.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/057.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/057.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/058.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/058.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/059.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/059.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/060.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/060.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/061.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/061.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/062.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/062.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/063.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/063.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/064.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/064.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/065.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/065.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/066.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/066.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/067.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/067.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/068.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/068.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/069.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/069.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/070.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/070.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/071.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/071.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/072.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/072.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/073.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/073.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/074.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/074.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/075.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/075.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/076.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/076.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/077.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/077.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/078.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/078.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/079.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/079.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/080.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/080.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/081.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/081.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/082.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/082.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/083.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/083.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/084.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/084.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/085.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/085.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/086.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/086.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/087.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/087.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/088.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/088.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/089.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/089.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/090.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/090.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/091.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/091.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/092.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/092.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/093.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/093.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/094.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/094.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/095.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/095.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/096.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/096.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/097.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/097.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/098.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/098.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/099.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/099.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/100.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/100.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/101.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/101.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/102.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/102.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/103.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/103.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/104.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/104.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/105.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/105.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/106.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/106.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/107.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/107.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/108.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/108.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/109.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/109.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/110.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/110.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/111.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/111.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/112.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/112.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/113.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/113.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/114.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/114.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/115.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/115.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/116.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/116.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/117.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/117.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/118.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/118.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/119.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/119.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/120.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/120.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/121.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/121.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/blank.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery1/blank.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/013.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/013.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/014.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/014.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/015.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/015.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/016.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/016.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/121.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/121.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/blank.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/images/avatars/gallery/gallery2/blank.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/branches/1.0alpha1/includes/db/postgres.php
===================================================================
--- cms/branches/1.0alpha1/includes/db/postgres.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/includes/db/postgres.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -66,7 +66,10 @@
 			$connection_string[] = 'password='.$db['password'];
 		}
 
-		$connection_string[] = 'dbname='.$db['database'];
+		if ($db['database'])
+		{
+			$connection_string[] = 'dbname='.$db['database'];
+		}
 
 		if ($this->link_identifier)
 		{

Modified: cms/branches/1.0alpha1/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha1/includes/display/display.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/includes/display/display.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -31,7 +31,7 @@
 	var $homepage = false;
 	var $modules = array();
 
-	var $copyright = 'Powered by <a href="http://www.viperal.com">CMS alpha-dev</a> (c) 2004 - 2005 Ryan Marshall ( Viperal )';
+	var $copyright = 'Powered by <a href="http://www.viperal.com">CMS alpha 1</a> (c) 2004 - 2005 Ryan Marshall ( Viperal )';
 
 	/*
 		Handles sorting and auth'ing of modules

Modified: cms/branches/1.0alpha1/includes/functions.php
===================================================================
--- cms/branches/1.0alpha1/includes/functions.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/includes/functions.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -808,21 +808,6 @@
 	}
 }
 
-//this doesn't work, maybe we should just translate those that can affect the html layout ?
-function core_html_entity_decode($string, $quote_style = ENT_COMPAT)
-{
-	$holding = get_html_translation_table(HTML_ENTITIES, $quote_style);
-
-	foreach ($holding as $from => $to)
-	{
-		$translations[utf8_encode($to)] = utf8_encode($from);
-	}
-
-	unset($translations['&amp;Epsilon;']);
-	//????????????????, Magyarul
-	return strtr($string, $translations);
-}
-
 if (!function_exists('html_entity_decode'))
 {
 	//string html_entity_decode ( string string [, int quote_style [, string charset]] )

Modified: cms/branches/1.0alpha1/includes/handler.php
===================================================================
--- cms/branches/1.0alpha1/includes/handler.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/includes/handler.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -182,7 +182,7 @@
 					
 					if (!is_numeric($code))
 					{
-						$error = $code.$error;
+						$error = $code.':'.$error;
 					}
 					else
 					{

Modified: cms/branches/1.0alpha1/install/build_data.php
===================================================================
--- cms/branches/1.0alpha1/install/build_data.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/install/build_data.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -108,24 +108,31 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 2, 1, 'block-Control_Panel.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 2, 2, 'block-Modules.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 2, 3, 'block-User.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 3, 1, 'http://www.php.net/news.rss', 7200)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 3, 2, 'block-theme_select.php')");
 
+$content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('blocks', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('system', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('messages', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('modules', 0, 2)");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('smiles', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('users', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
@@ -287,18 +294,18 @@
 // ADMINISTRATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
 // SUPER MODERATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname')");
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname')");
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 

Modified: cms/branches/1.0alpha1/install/installer.php
===================================================================
--- cms/branches/1.0alpha1/install/installer.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/install/installer.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -415,11 +415,16 @@
 
 if ($stage === 1)
 {
+	if (isset($_POST['test']) && empty($error))
+	{
+		$error[] = 'Database Setting Perfect :-)';
+	}
+
 	$_CLASS['core_template']->assign_array(array(
 		'database_options'	=> $database_options,
 		'error'				=> empty($error) ? false : implode('<br/>', $error),
 
-		'server'		=> isset($site_db['server']) ? $site_db['server'] : '',
+		'server'		=> isset($site_db['server']) ? $site_db['server'] : 'localhost',
 		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
 		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
 		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',

Deleted: cms/branches/1.0alpha1/javascript/ajax.js
===================================================================
--- cms/branches/1.0alpha1/javascript/ajax.js	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/javascript/ajax.js	2005-09-11 17:27:00 UTC (rev 108)
@@ -1,40 +0,0 @@
-// By Ryan Marshall ( viperal1 at gmail.com )
-
-function core_ajax()
-{
-	this.request = false;
-	this.async = true;
-}
-
-core_ajax.prototype.init = function()
-{
-	try
-	{
-		this.request = new XMLHttpRequest();
-	}
-	catch(e)
-	{
-		try
-		{
-			this.request = new ActiveXObject('Microsoft.XMLHTTP');
-			return true;
-		}
-		catch(e)
-		{
-			return false;
-		}
-	}
-}
-
-core_ajax.prototype.send = function(url, data)
-{
-	if (!this.request)
-	{
-		this.init();
-	}
-	
-	this.request.open('POST', url, this.async);
-	this.request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
-	
-	this.request.send(data);
-}
\ No newline at end of file

Modified: cms/branches/1.0alpha1/modules/Forums/admin/index.php
===================================================================
--- cms/branches/1.0alpha1/modules/Forums/admin/index.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/modules/Forums/admin/index.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -1,11 +1,33 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: pagestart.php,v 1.18 2004/08/02 14:31:45 psotfx Exp $
 //
 // FILENAME  : pagestart.php
 // STARTED   : Thu Aug 2, 2001
-// COPYRIGHT : ? 2001, 2004 phpBB Group
+// COPYRIGHT : 2001, 2004 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
 //
@@ -20,9 +42,9 @@
 $file_uploads = (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on') ? true : false;
 
 $data = array(
-	'title' => 'Forum Administration',
-	'position' => BLOCK_LEFT,
-	'file' => 'block-Admin_Forums.php',
+	'block_title'		=> 'Forum Administration',
+	'block_position'	=> BLOCK_LEFT,
+	'block_file'		=> 'block-Admin_Forums.php',
 );
 
 $_CLASS['core_blocks']->add_block($data);

Modified: cms/branches/1.0alpha1/modules/Forums/mcp.php
===================================================================
--- cms/branches/1.0alpha1/modules/Forums/mcp.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/modules/Forums/mcp.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -27,755 +27,6 @@
     die;
 }
 
-require_once($site_file_root.'includes/forums/functions_admin.php');
+trigger_error(' Sorry disabled this feature is disabled in this version ', E_USER_ERROR);
 
-// ---------
-// FUNCTIONS
-//
-class module
-{
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
-	var $url;
-
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $post_id, $topic_id, $forum_id, $selected_mod = false, $selected_submod = false)
-	{
-		global $_CLASS, $config;
-		
-		$_CLASS['core_template']->assign(array(
-			'L_OPTIONS'				=> $_CLASS['core_user']->lang['OPTIONS'],
-			'L_MESSAGE'				=> $_CLASS['core_user']->lang['MESSAGE'],
-			'L_YES'					=> $_CLASS['core_user']->lang['YES'],
-			'L_NO'					=> $_CLASS['core_user']->lang['NO'],
-			'L_RESET'				=> $_CLASS['core_user']->lang['RESET'],
-			)
-		);
-		
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . FORUMS_MODULES_TABLE . "
-			WHERE module_type = '{$module_type}'
-				AND module_enabled = 1
-			ORDER BY module_order ASC";
-		$result = $_CLASS['core_db']->query($sql);
-
-		$i = 0;
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']->acl_get("\\1", ' . $forum_id . ')', '(int) $config["\\1"]'), trim($row['module_acl'])) . ');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod && !$i)) ?  true : false;
-
-			// Get the localised lang string if available, or make up our own otherwise
-			$module_lang = strtoupper($module_type) . '_' . $row['module_title'];
-
-			$_CLASS['core_template']->assign_vars_array($module_type . '_section', array(
-				'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
-				'S_SELECTED'	=> $selected, 
-				'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $row['module_id']))
-			);
-
-			if ($selected)
-			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
-				{
-					$j = 0;
-					$submodules_ary = explode("\n", $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
-					{
-						$submodule = trim($submodule);
-						if (!$submodule)
-						{
-							continue;
-						}
-
-						$submodule = explode(',', $submodule);
-						$submodule_title = array_shift($submodule);
-						//print_r( $submodule);
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']->acl_get("\\1", ' . $forum_id . ')', '(int) $config["\\1"]'), trim($auth_option)) . ');');
-
-							if (!$is_auth)
-							{
-								break;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						// Only show those rows we are able to access
-						if (($submodule_title == 'post_details' && !$post_id) || 
-							($submodule_title == 'topic_view' && !$topic_id) ||
-							($submodule_title == 'forum_view' && !$forum_id))
-						{
-							continue;
-						}
-			
-						$suffix = ($post_id) ? "&amp;p=$post_id" : '';
-						$suffix .= ($topic_id) ? "&amp;t=$topic_id" : '';
-						$suffix .= ($forum_id) ? "&amp;f=$forum_id" : '';
-											
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod && !$j)) ? true : false;
-
-						// Get the localised lang string if available, or make up our own otherwise
-						$module_lang = strtoupper($module_type . '_' . $module_name . '_' . $submodule_title);
-
-						$_CLASS['core_template']->assign_vars_array("{$module_type}_subsection", array(
-							'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($module_lang))),
-							'S_SELECTED'	=> $selected,
-							'ADD_ITEM'		=> $this->add_menu_item($row['module_filename'], $submodule_title),
-							'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title . $suffix))
-						);
-
-						if ($selected)
-						{
-							$this->mode = $submodule_title;
-						}
-
-						$j++;
-					}
-				}
-			}
-
-			$i++;
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		if (!$module_id)
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-
-		$this->type = $module_type;
-		$this->id	= $module_id;
-		$this->name = $module_name;
-		$this->url = 'Forums&amp;file=mcp';
-		$this->url .= ($post_id) ? "&amp;p=$post_id" : '';
-		$this->url .= ($topic_id) ? "&amp;t=$topic_id" : '';
-		$this->url .= ($forum_id) ? "&amp;f=$forum_id" : '';
-	}
-
-	function load($type = false, $name = false, $mode = false, $run = true)
-	{
-		global $site_file_root;
-
-		if ($type)
-		{
-			$this->type = $type;
-		}
-
-		if ($name)
-		{
-			$this->name = $name;
-		}
-
-		if (!class_exists($this->type . '_' . $this->name))
-		{
-			require($site_file_root."includes/forums/{$this->type}/{$this->type}_{$this->name}.php");
-
-			if ($run)
-			{
-				if (!isset($this->mode))
-				{
-					$this->mode = $mode;
-				}
-
-				eval("\$this->module = new {$this->type}_{$this->name}(\$this->id, \$this->mode, \$this->url);");
-				if (method_exists($this->module, 'init'))
-				{
-					$this->module->init();
-				}
-			}
-		}
-	}
-
-	// Displays the appropriate template with the given title
-	function display($page_title, $tpl_name)
-	{
-		global $_CLASS;
-
-		$_CLASS['core_display']->display_header($page_title);
-		
-		page_header();
-
-		$_CLASS['core_template']->display('modules/Forums/'.$tpl_name);
-
-		$_CLASS['core_display']->display_footer();
-	}
-
-	// Add Item to Submodule Title
-	function add_menu_item($module_name, $mode)
-	{
-		global $_CLASS;
-
-		if ($module_name != 'queue')
-		{
-			return '';
-		}
-
-		$forum_id = request_var('f', 0);
-		if ($forum_id && $_CLASS['auth']->acl_get('m_approve', $forum_id))
-		{
-			$forum_list = array($forum_id);
-		}
-		else
-		{
-			$forum_list = get_forum_list('m_approve');
-		}
-
-		switch ($mode)
-		{
-			case 'unapproved_topics':
-
-				$sql = 'SELECT COUNT(*) AS total
-					FROM ' . FORUMS_TOPICS_TABLE . '
-					WHERE forum_id IN (' . implode(', ', $forum_list) . ')
-						AND topic_approved = 0';
-				$result = $_CLASS['core_db']->query($sql);
-				$total_topics = $_CLASS['core_db']->sql_fetchfield('total', 0, $result);
-
-				return ($total_topics) ? $total_topics : $_CLASS['core_user']->lang['NONE'];
-				break;
-
-			case 'unapproved_posts':
-
-				$sql = 'SELECT COUNT(*) AS total
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t 
-						WHERE p.forum_id IN (' . implode(', ', $forum_list) . ')
-							AND p.post_approved = 0
-							AND t.topic_id = p.topic_id
-							AND t.topic_first_post_id <> p.post_id';
-				$result = $_CLASS['core_db']->query($sql);
-				$total_posts = $_CLASS['core_db']->sql_fetchfield('total', 0, $result);
-
-				return ($total_posts) ? $total_posts : $_CLASS['core_user']->lang['NONE'];
-				break;
-		}
-	}
-
-	// Public methods to be overwritten by modules
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-
-	function install()
-	{
-		return false;
-	}
-
-	function uninstall()
-	{
-		return false;
-	}
-}
-//
-// FUNCTIONS
-// ---------
-
-$_CLASS['core_user']->add_img();
-$_CLASS['core_user']->add_lang('mcp');
-
-// Only Moderators can go beyond this point
-if (!$_CLASS['core_user']->is_user)
-{
-	if ($_CLASS['core_user']->is_bot)
-	{
-		redirect(generate_link('Forums'));
-	}
-	
-	login_box(array('admin_login' => true, 'full_login' => false, 'explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_MCP']));
-}
-
-$mcp = new module();
-
-// Basic parameter data
-$mode	= request_var('mode', '');
-$mode2	= (isset($_REQUEST['quick'])) ? request_var('mode2', '') : '';
-$module = request_var('i', '');
-
-if (is_array($mode))
-{
-	list($mode, ) = each($mode);
-}
-
-if ($mode2)
-{
-	$mode = $mode2;
-	$action = '';
-	unset($mode2);
-}
-
-// Make sure we are using the correct module
-if ($mode == 'approve' || $mode == 'disapprove')
-{
-	$module = 'queue';
-}
-
-$quickmod = (isset($_REQUEST['quickmod'])) ? true : false;
-$action = request_var('action', '');
-$action_ary = request_var('action', array('' => 0));
-
-if (sizeof($action_ary))
-{
-	list($action, ) = each($action);
-}
-unset($action_ary);
-
-if ($action == 'merge_select')
-{
-	$mode = 'forum_view';
-}
-
-// Topic view modes
-if (in_array($mode, array('split', 'split_all', 'split_beyond', 'merge', 'merge_posts')))
-{
-	$_REQUEST['action'] = $action = $mode;
-	$mode = 'topic_view';
-	$quickmod = false;
-}
-
-// Forum view modes
-if (in_array($mode, array('resync')))
-{
-	$_REQUEST['action'] = $action = $mode;
-	$mode = 'forum_view';
-	$quickmod = false;
-}
-
-if (!$quickmod)
-{
-	$post_id = request_var('p', 0);
-	$topic_id = request_var('t', 0);
-	$forum_id = request_var('f', 0);
-	
-	if ($post_id)
-	{
-		// We determine the topic and forum id here, to make sure the moderator really has moderative rights on this post
-		$sql = 'SELECT topic_id, forum_id
-			FROM ' . FORUMS_POSTS_TABLE . "
-			WHERE post_id = $post_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$topic_id = (int) $row['topic_id'];
-		$forum_id = (int) $row['forum_id'];
-	}
-
-	if ($topic_id && !$forum_id)
-	{
-		$sql = 'SELECT forum_id
-			FROM ' . FORUMS_TOPICS_TABLE . "
-			WHERE topic_id = $topic_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$forum_id = (int) $row['forum_id'];
-	}
-
-	// If we do not have a forum id and the user is not a super moderator (global options are set to false, even if the user is able to moderator at least one forum
-	if (!$forum_id && !$_CLASS['auth']->acl_get('m_'))
-	{
-		$forum_list = get_forum_list('m_');
-
-		if (!sizeof($forum_list))
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-
-		// We do not check all forums, only the first one should be sufficiant.
-		$forum_id = $forum_list[0];
-	}
-	
-	// Instantiate module system and generate list of available modules
-	$mcp->create('mcp', 'Forums&amp;file=mcp', $post_id, $topic_id, $forum_id, $module, $mode);
-
-	// Load and execute the relevant module
-	$mcp->load('mcp', false, $mode);
-	exit;
-}
-
-switch ($mode)
-{
-	case 'lock':
-	case 'unlock':
-	case 'lock_post':
-	case 'unlock_post':
-		$mcp->load('mcp', 'main', $mode);
-		break;
-	case 'make_sticky':
-	case 'make_announce':
-	case 'make_global':
-	case 'make_normal':
-		$mcp->load('mcp', 'main', $mode);
-		break;
-	case 'fork':
-	case 'move':
-		$mcp->load('mcp', 'main', $mode);
-		break;
-	case 'delete_post':
-	case 'delete_topic':
-		$mcp->load('mcp', 'main', $mode);
-		break;
-	default:
-		trigger_error("$mode not allowed as quickmod");
-}
-
-// Build simple hidden fields from array
-function build_hidden_fields($field_ary)
-{
-	$s_hidden_fields = '';
-
-	foreach ($field_ary as $name => $vars)
-	{
-		if (is_array($vars))
-		{
-			foreach ($vars as $key => $value)
-			{
-				$s_hidden_fields .= '<input type="hidden" name="' . $name . '[' . $key . ']" value="' . $value . '" />';
-			}
-		}
-		else
-		{
-			$s_hidden_fields .= '<input type="hidden" name="' . $name . '" value="' . $vars . '" />';
-		}
-	}
-
-	return $s_hidden_fields;
-}
-
-// Get simple topic data
-function get_topic_data($topic_ids, $acl_list = false)
-{
-	global $_CLASS;
-	$rowset = array();
-
-	if (implode(', ', $topic_ids) == '')
-	{
-		return array();
-	}
-
-	$sql = 'SELECT f.*, t.*
-		FROM ' . FORUMS_TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
-		WHERE t.topic_id IN (' . implode(', ', $topic_ids) . ')';
-	$result = $_CLASS['core_db']->query($sql);
-		
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
-		{
-			continue;
-		}
-
-		$rowset[$row['topic_id']] = $row;
-	}
-
-	return $rowset;
-}
-
-// Get simple post data
-function get_post_data($post_ids, $acl_list = false)
-{
-	global $_CLASS;
-	$rowset = array();
-
-	$sql = 'SELECT p.*, u.*, t.*, f.*
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
-		WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
-			AND u.user_id = p.poster_id
-			AND t.topic_id = p.topic_id';
-	$result = $_CLASS['core_db']->query($sql);
-		
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
-		{
-			continue;
-		}
-
-		if (!$row['post_approved'] && !$_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
-		{
-			// Moderators without the permission to approve post should at least not see them. ;)
-			continue;
-		}
-
-		$rowset[$row['post_id']] = $row;
-	}
-
-	return $rowset;
-}
-
-function get_forum_data($forum_id, $acl_list = 'f_list')
-{
-	global $_CLASS;
-	$rowset = array();
-
-	$sql = 'SELECT *
-		FROM ' . FORUMS_FORUMS_TABLE . '
-		WHERE forum_id ' . ((is_array($forum_id)) ? 'IN (' . implode(', ', $forum_id) . ')' : "= $forum_id");
-	$result = $_CLASS['core_db']->query($sql);
-		
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
-		{
-			continue;
-		}
-		if ($_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
-		{
-			$row['forum_topics'] = $row['forum_topics_real'];
-		}
-
-		$rowset[$row['forum_id']] = $row;
-	}
-
-	return $rowset;
-}
-
-function mcp_sorting($mode, &$sort_days, &$sort_key, &$sort_dir, &$sort_by_sql, &$sort_order_sql, &$total, $forum_id = 0, $topic_id = 0, $where_sql = 'WHERE')
-{
-	global $_CLASS;
-
-	$sort_days = request_var('sort_days', 0);
-	$min_time = ($sort_days) ? time() - ($sort_days * 86400) : 0;
-
-	switch ($mode)
-	{
-		case 'viewforum':
-			$type = 'topics';
-			$default_key = 't';
-			$default_dir = 'd';
-			$sql = 'SELECT COUNT(topic_id) AS total
-				FROM ' . FORUMS_TOPICS_TABLE . "
-				$where_sql forum_id = $forum_id
-					AND topic_type NOT IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ")
-					AND topic_last_post_time >= $min_time";
-
-			if (!$_CLASS['auth']->acl_get('m_approve', $forum_id))
-			{
-				$sql .= 'AND topic_approved = 1';
-			}
-			break;
-
-		case 'viewtopic':
-			$type = 'posts';
-			$default_key = 't';
-			$default_dir = 'a';
-			$sql = 'SELECT COUNT(post_id) AS total
-				FROM ' . FORUMS_POSTS_TABLE . "
-				$where_sql topic_id = $topic_id
-					AND post_time >= $min_time";
-			if (!$_CLASS['auth']->acl_get('m_approve', $forum_id))
-			{
-				$sql .= 'AND post_approved = 1';
-			}
-			break;
-
-		case 'unapproved_posts':
-			$type = 'posts';
-			$default_key = 't';
-			$default_dir = 'd';
-			$sql = 'SELECT COUNT(post_id) AS total
-				FROM ' . FORUMS_POSTS_TABLE . "
-				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
-					AND post_approved = 0
-					AND post_time >= ' . $min_time;
-			break;
-
-		case 'unapproved_topics':
-			$type = 'topics';
-			$default_key = 't';
-			$default_dir = 'd';
-			$sql = 'SELECT COUNT(topic_id) AS total
-				FROM ' . FORUMS_TOPICS_TABLE . "
-				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_approve'))) . ')
-					AND topic_approved = 0
-					AND topic_time >= ' . $min_time;
-			break;
-
-		case 'reports':
-			$type = 'reports';
-			$default_key = 'p';
-			$default_dir = 'd';
-			$limit_time_sql = ($min_time) ? "AND r.report_time >= $min_time" : '';
-
-			if ($topic_id)
-			{
-				$where_sql .= ' p.topic_id = ' . $topic_id;
-			}
-			else if ($forum_id)
-			{
-				$where_sql .= ' p.forum_id = ' . $forum_id;
-			}
-			else
-			{
-				$where_sql .= ' p.forum_id IN (' . implode(', ', get_forum_list('m_')) . ')';
-			}
-			$sql = 'SELECT COUNT(r.report_id) AS total
-				FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_POSTS_TABLE . " p
-				$where_sql
-					AND p.post_id = r.post_id
-					$limit_time_sql";
-			break;
-
-		case 'viewlogs':
-			$type = 'logs';
-			$default_key = 't';
-			$default_dir = 'd';
-			$sql = 'SELECT COUNT(log_id) AS total
-				FROM ' . FORUMS_LOG_TABLE . "
-				$where_sql forum_id IN (" . (($forum_id) ? $forum_id : implode(', ', get_forum_list('m_'))) . ')
-					AND log_time >= ' . $min_time . ' 
-					AND log_type = ' . LOG_MOD;
-			break;
-	}
-
-	$sort_key = request_var('sk', $default_key);
-	$sort_dir = request_var('sd', $default_dir);
-	$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
-
-	switch ($type)
-	{
-		case 'topics':
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-			$sort_by_text = array('a' => $_CLASS['core_user']->lang['AUTHOR'], 't' => $_CLASS['core_user']->lang['POST_TIME'], 'tt' => $_CLASS['core_user']->lang['TOPIC_TIME'], 'r' => $_CLASS['core_user']->lang['REPLIES'], 's' => $_CLASS['core_user']->lang['SUBJECT'], 'v' => $_CLASS['core_user']->lang['VIEWS']);
-
-			$sort_by_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'tt' => 't.topic_time', 'r' => (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? 't.topic_replies_real' : 't.topic_replies'), 's' => 't.topic_title', 'v' => 't.topic_views');
-			$limit_time_sql = ($min_time) ? "AND t.topic_last_post_time >= $min_time" : '';
-			break;
-
-		case 'posts':
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_POSTS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-			$sort_by_text = array('a' => $_CLASS['core_user']->lang['AUTHOR'], 't' => $_CLASS['core_user']->lang['POST_TIME'], 's' => $_CLASS['core_user']->lang['SUBJECT']);
-			$sort_by_sql = array('a' => 'u.username', 't' => 'p.post_id', 's' => 'p.post_subject');
-			$limit_time_sql = ($min_time) ? "AND p.post_time >= $min_time" : '';
-			break;
-
-		case 'reports':
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_REPORTS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-			$sort_by_text = array('p' => $_CLASS['core_user']->lang['REPORT_PRIORITY'], 'r' => $_CLASS['core_user']->lang['REPORTER'], 't' => $_CLASS['core_user']->lang['REPORT_TIME']);
-			$sort_by_sql = array('p' => 'rr.reason_priority', 'r' => 'u.username', 't' => 'r.report_time');
-			break;
-
-		case 'logs':
-			$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_ENTRIES'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
-			$sort_by_text = array('u' => $_CLASS['core_user']->lang['SORT_USERNAME'], 't' => $_CLASS['core_user']->lang['SORT_DATE'], 'i' => $_CLASS['core_user']->lang['SORT_IP'], 'o' => $_CLASS['core_user']->lang['SORT_ACTION']);
-
-			$sort_by_sql = array('u' => 'l.user_id', 't' => 'l.log_time', 'i' => 'l.log_ip', 'o' => 'l.log_operation');
-			$limit_time_sql = ($min_time) ? "AND l.log_time >= $min_time" : '';
-			break;
-	}
-
-	$sort_order_sql = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
-
-	$s_limit_days = $s_sort_key = $s_sort_dir = $sort_url = '';
-	gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $sort_url);
-
-	$_CLASS['core_template']->assign(array(
-		'S_SELECT_SORT_DIR'	=>	$s_sort_dir,
-		'S_SELECT_SORT_KEY' =>	$s_sort_key,
-		'S_SELECT_SORT_DAYS'=>	$s_limit_days)
-	);
-
-	if (($sort_days && $mode != 'viewlogs') || $mode == 'reports' || $where_sql != 'WHERE')
-	{
-		$result = $_CLASS['core_db']->query($sql);
-		$total = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['total'] : 0;
-	}
-	else
-	{
-		$total = -1;
-	}
-}
-
-//
-function check_ids(&$ids, $table, $sql_id, $acl_list = false)
-{
-	global $_CLASS;
-
-	if (!is_array($ids) || !$ids)
-	{
-		return 0;
-	}
-
-	// a small logical error, since global announcement are assigned to forum_id == 0
-	// If the first topic id is a global announcement, we can force the forum. Though only global announcements can be
-	// tricked... i really do not know how to prevent this atm.
-
-	// With those two queries we make sure all ids are within one forum...
-	$sql = "SELECT forum_id FROM $table
-		WHERE $sql_id = {$ids[0]}";
-	$result = $_CLASS['core_db']->query($sql);
-	$forum_id = (int) $_CLASS['core_db']->sql_fetchfield('forum_id', 0, $result);
-	$_CLASS['core_db']->free_result($result);
-
-	if (!$forum_id)
-	{
-		// Global Announcement?
-		$forum_id = request_var('f', 0);
-	}
-
-	if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $forum_id))
-	{
-		trigger_error('NOT_AUTHORIZED');
-	}
-
-	if (!$forum_id)
-	{
-		trigger_error('Missing forum_id, has to be in url if global announcement...');
-	}
-
-	$sql = "SELECT $sql_id FROM $table
-		WHERE $sql_id IN (" . implode(', ', $ids) . ")
-			AND (forum_id = $forum_id OR forum_id = 0)";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$ids = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$ids[] = $row[$sql_id];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	return $forum_id;
-}
-
-// LITTLE HELPER
-//
-
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/modules/Forums/report.php
===================================================================
--- cms/branches/1.0alpha1/modules/Forums/report.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/modules/Forums/report.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -27,387 +27,6 @@
     die;
 }
 
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
-$_CLASS['auth']->acl($_CLASS['core_user']->data);
+trigger_error(' Sorry disabled this feature is disabled in this version ', E_USER_ERROR);
 
-$_CLASS['core_user']->add_lang('mcp');
-
-// Report PM or Post?
-$id = request_var('p', request_var('pm', 0));
-$report_post = (request_var('p', 0)) ? true : false;
-$reason_id	= request_var('reason_id', 0);
-$user_notify= (!empty($_REQUEST['notify']) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? true : false;
-$report_text= request_var('report_text', '');
-
-if (!$id)
-{
-	trigger_error('INVALID_MODE');
-}
-
-$redirect_url = ($report_post) ? generate_link("Forums&amp;file=viewtopic&p=$id#$id") : generate_link('Control_Panel&i=pm&p='.$id);
-// Has the report been cancelled?
-if (isset($_POST['cancel']))
-{
-	redirect($redirect_url);
-}
-
-// Grab all relevant data
-if ($report_post)
-{
-	$sql = 'SELECT f.*, t.*, p.*
-		FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . " f
-		WHERE p.post_id = $id
-			AND p.topic_id = t.topic_id
-			AND p.forum_id = f.forum_id";
-}
-else
-{
-	// Only the user itself is able to report his Private Messages
-	$sql = 'SELECT p.*, t.*
-		FROM ' . PRIVMSGS_TABLE . ' p, ' . PRIVMSGS_TO_TABLE . " t
-		WHERE t.msg_id = $id
-			AND t.user_id = " . $_CLASS['core_user']->data['user_id'] . '
-			AND t.msg_id = p.msg_id';
-}
-
-$result = $_CLASS['core_db']->sql_query($sql);
-$report_data = $_CLASS['core_db']->sql_fetchrow($result);
-$_CLASS['core_db']->sql_freeresult($result);
-
-if (!$report_data)
-{
-	$message = ($report_post) ? $_CLASS['core_user']->lang['POST_NOT_EXIST'] : $_CLASS['core_user']->lang['PM_NOT_EXIST'];
-	trigger_error($message);
-}
-
-if ($report_post)
-{
-	$forum_id = $report_data['forum_id'];
-	$topic_id = $report_data['topic_id'];
-
-	// Check required permissions
-	$acl_check_ary = array('f_list' => 'POST_NOT_EXIST', 'f_read' => 'USER_CANNOT_READ', 'f_report' => 'USER_CANNOT_REPORT');
-	
-	foreach ($acl_check_ary as $acl => $error)
-	{
-		if (!$_CLASS['auth']->acl_get($acl, $forum_id))
-		{
-			trigger_error($error);
-		}
-	}
-	unset($acl_check_ary);
-}
-else
-{
-	if (!$config['auth_report_pm'] || !$_CLASS['auth']->acl_get('u_pm_report'))
-	{
-		trigger_error('USER_CANNOT_REPORT');
-	}
-}
-
-// Check if the post has already been reported by this user
-$sql = 'SELECT *
-	FROM ' . REPORTS_TABLE . '
-	WHERE ' . (($report_post) ? "post_id = $id" : "msg_id = $id") . '
-		AND user_id = ' . $_CLASS['core_user']->data['user_id'];
-$result = $_CLASS['core_db']->sql_query($sql);
-$row = $_CLASS['core_db']->sql_fetchrow($result);
-$_CLASS['core_db']->sql_freeresult($result);
-
-if ($row)
-{
-	if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
-	{
-		// A report exists, extract $row if we're going to display the form
-		if ($reason_id)
-		{
-			$report_id = (int) $row['report_id'];
-		}
-		else
-		{
-			// Overwrite set variables
-			extract($row);
-		}
-	}
-	else
-	{
-		trigger_error($_CLASS['core_user']->lang['ALREADY_REPORTED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang[(($report_post) ? 'RETURN_TOPIC' : 'RETURN_MESSAGE')], '<a href="' . $redirect_url . '">', '</a>'));
-	}
-}
-else
-{
-	$report_id = 0;
-}
-
-// Has the report been confirmed?
-if (isset($_POST['submit']) && $reason_id)
-{
-	$sql = 'SELECT reason_name, reason_description
-		FROM ' . REASONS_TABLE . " 
-		WHERE reason_id = $reason_id";
-	$result = $_CLASS['core_db']->sql_query($sql);
-	$row = $_CLASS['core_db']->sql_fetchrow($result);
-	$_CLASS['core_db']->sql_freeresult($result);
-
-	if (!$row || (!$report_text && $row['reason_name'] == 'other'))
-	{
-		trigger_error('EMPTY_REPORT');
-	}
-
-	$reason_desc = (!empty($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_description'];
-	
-	$sql_ary = array(
-		'reason_id'		=> (int) $reason_id,
-		'post_id'		=> ($report_post) ? $id : 0,
-		'msg_id'		=> ($report_post) ? 0 : $id,
-		'user_id'		=> (int) $_CLASS['core_user']->data['user_id'],
-		'user_notify'	=> (int) $user_notify,
-		'report_time'	=> (int) time(),
-		'report_text'	=> (string) $report_text
-	);
-
-	if ($report_id)
-	{
-		$sql = 'UPDATE ' . REPORTS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
-			WHERE report_id = ' . $report_id;
-		$_CLASS['core_db']->sql_query($sql);
-	}
-	else
-	{
-		$sql = 'INSERT INTO ' . REPORTS_TABLE . ' ' . 
-			$_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']->sql_query($sql);
-		$report_id = $_CLASS['core_db']->sql_nextid();
-	}
-
-	if ($report_post)
-	{
-		if (!$report_data['post_reported'])
-		{
-			$sql = 'UPDATE ' . POSTS_TABLE . ' 
-				SET post_reported = 1 
-				WHERE post_id = ' . $id;
-			$_CLASS['core_db']->sql_query($sql);
-		}
-
-		if (!$report_data['topic_reported'])
-		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . ' 
-				SET topic_reported = 1 
-				WHERE topic_id = ' . $report_data['topic_id'];
-			$_CLASS['core_db']->sql_query($sql);
-		}
-	}
-	else
-	{
-		if (!$report_data['message_reported'])
-		{
-			$sql = 'UPDATE ' . PRIVMSGS_TABLE . " 
-				SET message_reported = 1 
-				WHERE msg_id = $id";
-			$_CLASS['core_db']->sql_query($sql);
-		}
-	}
-
-	// Send Notifications
-	// PM: Reported Post is put into all admin's boxes (not notifying about 'this' PM)
-	// All persons get notified about a new report, if notified by PM, send out email notifications too
-	
-	// Send notifications to moderators
-	$acl_list = ($report_post) ? $_CLASS['auth']->acl_get_list(false, array('m_', 'a_'), array(0, $report_data['forum_id'])) : $_CLASS['auth']->acl_get_list(false, 'a_', 0);
-	$notify_user = ($report_post) ? $acl_list[$report_data['forum_id']]['m_'] : array();
-	$notify_user = array_unique(array_merge($notify_user, $acl_list[0]['a_']));
-	unset($acl_list);
-
-	// Send reported PM to responsible persons (admins)
-	if (!$report_post)
-	{
-		foreach ($notify_user as $user_id)
-		{
-			$_CLASS['core_db']->sql_query('INSERT INTO ' . PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'msg_id'	=> (int) $id,
-				'user_id'	=> (int) $user_id,
-				'author_id'	=> (int) $report_data['author_id'],
-				'folder_id'	=> PRIVMSGS_NO_BOX,
-				'new'		=> 1,
-				'unread'	=> 1,
-				'forwarded'	=> 0))
-			);
-		}
-
-		// Update Status
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
-			WHERE user_id IN (' . implode(', ', $notify_user) . ')';
-		$_CLASS['core_db']->sql_query($sql);
-	}
-
-	// How to notify them?
-	$sql = 'SELECT user_id, username, user_options, user_lang, user_email, user_notify_type, user_jabber 
-		FROM ' . USERS_TABLE . '
-		WHERE user_id IN (' . implode(', ', $notify_user) . ')';
-	$result = $_CLASS['core_db']->sql_query($sql);
-
-	$notify_user = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-	{
-		$notify_user[$row['user_id']] = array(
-			'name'	=> $row['username'],
-			'email' => $row['user_email'],
-			'jabber'=> $row['user_jabber'],
-			'lang'	=> $row['user_lang'],
-			'notify_type'	=> $row['user_notify_type'],
-			
-			'pm'	=> $_CLASS['core_user']->optionget('report_pm_notify', $row['user_options'])
-		);
-	}
-	$_CLASS['core_db']->sql_freeresult($result);
-
-	$report_data = array(
-		'id'		=> $id,
-		'report_id'	=> $report_id,
-		'reporter'	=> $_CLASS['core_user']->data['username'],
-		'reason'	=> $reason_desc,
-		'text'		=> $report_text,
-		'subject'	=> ($report_post) ? $report_data['post_subject'] : $report_data['message_subject'],
-		'view_post'	=> ($report_post) ? generate_link("Forums&amp;file=viewtopic&amp;f={$report_data['forum_id']}&t={$report_data['topic_id']}&p=$id&e=$id") : ''
-	);
-
-	report_notification($notify_user, $report_post, $report_data);
-
-	$_CLASS['core_display']->meta_refresh(3, $redirect_url);
-
-	$message = $_CLASS['core_user']->lang[(($report_post) ? 'POST' : 'MESSAGE') . '_REPORTED_SUCCESS'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang[(($report_post) ? 'RETURN_TOPIC' : 'RETURN_MESSAGE')], '<a href="' . $redirect_url . '">', '</a>');
-	trigger_error($message);
-}
-
-// Generate the form
-$sql = 'SELECT * 
-	FROM ' . REASONS_TABLE . ' 
-	ORDER BY reason_priority ASC';
-$result = $_CLASS['core_db']->sql_query($sql);
-
-while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-{
-	$row['reason_name'] = strtoupper($row['reason_name']);
-
-	$reason_title = (!empty($_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']] : ucwords(str_replace('_', ' ', $row['reason_name']));
-
-	$reason_desc = (!empty($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_desc'];
-
-	$_CLASS['core_template']->assign_vars_array('reason', array(
-		'ID'			=>	$row['reason_id'],
-		'NAME'			=>	htmlspecialchars($reason_title),
-		'DESCRIPTION'	=>	htmlspecialchars($reason_desc),
-		'S_SELECTED'    =>	($row['reason_id'] == $reason_id) ? true : false)
-	);
-}
-$_CLASS['core_db']->sql_freeresult($result);
-
-$u_report = ($report_post) ? "p=$id" : "pm=$id";
-
-$_CLASS['core_template']->assign(array(
-	'REPORT_TEXT'		=>	$report_text,
-	'S_REPORT_ACTION'	=>	generate_link("Forums&amp;file=report&amp;$u_report" . (($report_id) ? "&amp;report_id=$report_id" : '')),
-	'S_NOTIFY'			=> (!empty($user_notify)) ? true : false,
-	'S_CAN_NOTIFY'		=> ($_CLASS['core_user']->data['user_id'] == ANONYMOUS) ? false : true,
-	'S_REPORT_POST'		=> $report_post)
-);
-
-if ($report_post)
-{
-	generate_forum_nav($report_data);
-}
-
-page_header();
-
-$_CLASS['core_template']->display('modules/Forums/report_body.html');
-
-function report_notification($notify_user, $report_post, $report_data)
-{
-	global $config, $site_file_root;
-
-	require_once($site_file_root.'includes/forums/functions_messenger.php');
-	require_once($site_file_root.'includes/forums/functions_privmsgs.php');
-	$messenger = new messenger();
-
-	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-	$email_template = ($report_post) ? 'new_report_post' : 'new_report_pm';
-	$view_report_url = ($report_post) ? generate_link('Forums&amp;file=mcp&amp;i=queue&r=' . $report_data['report_id'], array('full' => true, 'sid' => false)) : generate_link('Forums&amp;file=mcp&amp;i=pm&p='. $report_data['id'] . '&r=' . $report_data['report_id'], array('full' => true, 'sid' => false));
-
-	foreach ($notify_user as $user_id => $notify_row)
-	{
-		// Send notification by email
-		if (!$notify_row['pm'])
-		{
-			$messenger->to($notify_row['email'], $notify_row['name']);
-			$messenger->im($notify_row['jabber'], $notify_row['name']);
-			$messenger->replyto($config['board_email']);
-
-			$messenger->template($email_template, $notify_row['lang']);
-
-			$messenger->assign_vars(array(
-				'EMAIL_SIG'		=> $email_sig,
-				'SITENAME'		=> $config['sitename'],
-				'USERNAME'		=> $notify_row['name'],
-				'SUBJECT'		=> $report_data['subject'],
-				'REPORTER'		=> $report_data['reporter'],
-
-				'REPORT_REASON'	=> $report_data['reason'],
-				'REPORT_TEXT'	=> $report_data['text'],
-
-				'U_VIEW_REPORT'	=> $view_report_url,
-				'U_VIEW_POST'	=> generate_board_url() . '/' . $report_data['view_post'])
-			);
-
-			$messenger->send($notify_row['notify_type']);
-			$messenger->reset();
-
-			$messenger->save_queue();
-		}
-		else
-		{
-			// Use messenger for getting the correct message, we use the email template
-			$messenger->template($email_template, $notify_row['lang']);
-			
-			$messenger->assign_vars(array(
-				'EMAIL_SIG'		=> $email_sig,
-				'SITENAME'		=> $config['sitename'],
-				'USERNAME'		=> $notify_row['name'],
-				'SUBJECT'		=> $report_data['subject'],
-				'REPORTER'		=> $report_data['reporter'],
-
-				'REPORT_REASON'	=> $report_data['reason'],
-				'REPORT_TEXT'	=> $report_data['text'],
-
-				'U_VIEW_REPORT'	=> generate_board_url() . '/' . $view_report_url)
-			);
-
-			// break the sending process...
-			$messenger->send(false, true);
-			$messenger->reset();
-			
-			// do not put in reporters outbox
-			submit_pm('post', $report_data['subject'], '', array(), array(), array(
-				'address_list'	=> array('u' => array($user_id => 'to')),
-				'icon_id'		=> 0,
-				'enable_bbcode' 	=> 0,
-				'enable_html' 		=> 0,
-				'enable_smilies' 	=> 0,
-				'enable_magic_url' 	=> 1,
-				'enable_sig' 		=> 0,
-				'message_md5'		=> md5($messenger->msg),
-				'bbcode_bitfield'	=> 0,
-				'bbcode_uid'		=> 0,
-				'attachment_data'	=> array(),
-				'filename_data'		=> array(),
-				'message'			=> $messenger->msg				
-				), true, false);
-		}
-	}
-	unset($messenger);
-}
-
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/themes/viperal/style/style.css
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/style/style.css	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/themes/viperal/style/style.css	2005-09-11 17:27:00 UTC (rev 108)
@@ -18,7 +18,7 @@
 	z-index: 1;
 }
 
-#nav li a
+#nav li a, .active
 {
 	display: block;
 	padding: 5px 10px 5px 5px; 

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/background.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/background.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/created_by.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/created_by.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_email.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_email.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_info.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_info.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_online.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_online.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_report.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_report.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_www.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_www.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_link_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_link_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_attach.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_attach.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_reported.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_reported.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.htm
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.htm	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.htm	2005-09-11 17:27:00 UTC (rev 108)
@@ -0,0 +1,16 @@
+<html>
+<head>
+<title>subSilver created by subBlue Design</title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">
+	<tr>
+		<td align="center" valign="middle"><a href="http://www.subblue.com/" target="_new"><img src="created_by.jpg" width="400" height="300" border="0" alt="Created by subBlue Design" /></a></td>
+	</tr>
+</table>
+
+</body>
+</html>
\ No newline at end of file

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.php
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.php	2005-09-10 14:40:33 UTC (rev 107)
+++ cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/index.php	2005-09-11 17:27:00 UTC (rev 108)
@@ -0,0 +1,105 @@
+<?php
+$this->img = array
+(
+    'style_id' => '1',
+    'template_id' => '1',
+    'template_name' => 'subSilver',
+    'template_copyright' => '&copy; phpBB Group',
+    'template_path' => 'subSilver',
+    'bbcode_bitfield' => '6913',
+    'template_storedb' => '0',
+    'theme_id' => '1',
+    'theme_name' => 'subSilver',
+    'theme_copyright' => '&copy; phpBB Group',
+    'theme_path' => 'subSilver',
+    'theme_storedb' => '0',
+    'theme_mtime' => '0',
+    'theme_data' => '',
+    'imageset_id' => '1',
+    'imageset_name' => 'subSilver',
+    'imageset_copyright' => '&#65533; phpBB Group',
+    'imageset_path' => 'subSilver',
+    'site_logo' => '',
+    'btn_post' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post.gif*27*97',
+    'btn_post_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post_pm.gif*27*97',
+    'btn_reply' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply.gif*27*97',
+    'btn_reply_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply_pm.gif*20*90',
+    'btn_locked' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_locked.gif*27*97',
+    'btn_profile' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_profile.gif*20*72',
+    'btn_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_pm.gif*20*72',
+    'btn_delete' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_delete.gif*20*20',
+    'btn_info' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_info.gif*20*20',
+    'btn_quote' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_quote.gif*20*90',
+    'btn_search' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_search.gif*20*72',
+    'btn_edit' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_edit.gif*20*90',
+    'btn_report' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_report.gif*20*20',
+    'btn_email' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_email.gif*20*72',
+    'btn_www' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_www.gif*20*72',
+    'btn_icq' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_icq.gif*20*72',
+    'btn_aim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_aim.gif*20*72',
+    'btn_yim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_yim.gif*20*72',
+    'btn_msnm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_msnm.gif*20*72',
+    'btn_jabber' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_jabber.gif*20*72',
+    'btn_online' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_online.gif*20*72',
+    'btn_offline' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+    'icon_unapproved' => 'themes/viperal/template/modules/Forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' => 'themes/viperal/template/modules/Forums/images/icon_reported.gif*18*19',
+    'icon_attach' => 'themes/viperal/template/modules/Forums/images/icon_attach.gif*18*14',
+    'icon_post' => 'themes/viperal/template/modules/Forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' => 'themes/viperal/template/modules/Forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' => 'themes/viperal/template/modules/Forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' => 'themes/viperal/template/modules/Forums/images/icon_newest_reply.gif*9*18',
+    'forum' => 'themes/viperal/template/modules/Forums/images/folder_big.gif*25*46',
+    'forum_new' => 'themes/viperal/template/modules/Forums/images/folder_new_big.gif*25*46',
+    'forum_locked' => 'themes/viperal/template/modules/Forums/images/folder_locked_big.gif*25*46',
+    'forum_link' => 'themes/viperal/template/modules/Forums/images/folder_link_big.gif*25*46',
+    'sub_forum' => 'themes/viperal/template/modules/Forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' => 'themes/viperal/template/modules/Forums/images/subfolder_new_big.gif*25*46',
+    'folder' => 'themes/viperal/template/modules/Forums/images/folder.gif*18*19',
+    'folder_moved' => 'themes/viperal/template/modules/Forums/images/folder_moved.gif*18*19',
+    'folder_posted' => 'themes/viperal/template/modules/Forums/images/folder_posted.gif*18*19',
+    'folder_new' => 'themes/viperal/template/modules/Forums/images/folder_new.gif*18*19',
+    'folder_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' => 'themes/viperal/template/modules/Forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' => 'themes/viperal/template/modules/Forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' => 'themes/viperal/template/modules/Forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' => 'themes/viperal/template/modules/Forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' => 'themes/viperal/template/modules/Forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' => 'themes/viperal/template/modules/Forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' => 'themes/viperal/template/modules/Forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' => 'themes/viperal/template/modules/Forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' => '',
+    'folder_global_posted' => '',
+    'folder_global_new' => '',
+    'folder_global_new_posted' => '',
+    'poll_left' => 'themes/viperal/template/modules/Forums/images/vote_lcap.gif*12*4',
+    'poll_center' => 'themes/viperal/template/modules/Forums/images/voting_bar.gif*12',
+    'poll_right' => 'themes/viperal/template/modules/Forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' => 'themes/viperal/template/modules/Forums/images/progress_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'themes/viperal/template/modules/Forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'image_register' => 'themes/viperal/template/modules/Forums/images/icon_mini_register.gif',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+);
+?>
\ No newline at end of file

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma0.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma0.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma1.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma2.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma3.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma4.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma5.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/karma/karma5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/sitelogo.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/sitelogo.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_move.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_move.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_split.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_split.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_unlock.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/topic_unlock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_lcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_lcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_rcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/vote_rcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/voting_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/voting_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/whosonline.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes/viperal/template/modules/Forums/images/whosonline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From viperal at berlios.de  Sun Sep 11 21:12:46 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 21:12:46 +0200
Subject: [Viperals-svncheckins] r109 - in cms/trunk: . images images/avatars images/avatars/gallery images/avatars/gallery/gallery1 images/avatars/gallery/gallery2 includes install themes/viperal/style themes/viperal/template/modules themes/viperal/template/modules/Forums themes/viperal/template/modules/Forums/images themes/viperal/template/modules/Forums/images/en themes/viperal/template/modules/Forums/images/karma
Message-ID: <200509111912.j8BJCkAg013738@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 21:12:44 +0200 (Sun, 11 Sep 2005)
New Revision: 109

Added:
   cms/trunk/images/avatars/
   cms/trunk/images/avatars/gallery/
   cms/trunk/images/avatars/gallery/067.gif
   cms/trunk/images/avatars/gallery/068.gif
   cms/trunk/images/avatars/gallery/069.gif
   cms/trunk/images/avatars/gallery/gallery1/
   cms/trunk/images/avatars/gallery/gallery1/001.gif
   cms/trunk/images/avatars/gallery/gallery1/002.gif
   cms/trunk/images/avatars/gallery/gallery1/003.gif
   cms/trunk/images/avatars/gallery/gallery1/004.gif
   cms/trunk/images/avatars/gallery/gallery1/005.gif
   cms/trunk/images/avatars/gallery/gallery1/006.gif
   cms/trunk/images/avatars/gallery/gallery1/007.gif
   cms/trunk/images/avatars/gallery/gallery1/008.gif
   cms/trunk/images/avatars/gallery/gallery1/009.gif
   cms/trunk/images/avatars/gallery/gallery1/010.gif
   cms/trunk/images/avatars/gallery/gallery1/011.gif
   cms/trunk/images/avatars/gallery/gallery1/012.gif
   cms/trunk/images/avatars/gallery/gallery1/013.gif
   cms/trunk/images/avatars/gallery/gallery1/014.gif
   cms/trunk/images/avatars/gallery/gallery1/015.gif
   cms/trunk/images/avatars/gallery/gallery1/016.gif
   cms/trunk/images/avatars/gallery/gallery1/017.gif
   cms/trunk/images/avatars/gallery/gallery1/018.gif
   cms/trunk/images/avatars/gallery/gallery1/019.gif
   cms/trunk/images/avatars/gallery/gallery1/020.gif
   cms/trunk/images/avatars/gallery/gallery1/021.gif
   cms/trunk/images/avatars/gallery/gallery1/022.gif
   cms/trunk/images/avatars/gallery/gallery1/023.gif
   cms/trunk/images/avatars/gallery/gallery1/024.gif
   cms/trunk/images/avatars/gallery/gallery1/025.gif
   cms/trunk/images/avatars/gallery/gallery1/026.gif
   cms/trunk/images/avatars/gallery/gallery1/027.gif
   cms/trunk/images/avatars/gallery/gallery1/028.gif
   cms/trunk/images/avatars/gallery/gallery1/029.gif
   cms/trunk/images/avatars/gallery/gallery1/030.gif
   cms/trunk/images/avatars/gallery/gallery1/031.gif
   cms/trunk/images/avatars/gallery/gallery1/032.gif
   cms/trunk/images/avatars/gallery/gallery1/033.gif
   cms/trunk/images/avatars/gallery/gallery1/034.gif
   cms/trunk/images/avatars/gallery/gallery1/035.gif
   cms/trunk/images/avatars/gallery/gallery1/036.gif
   cms/trunk/images/avatars/gallery/gallery1/037.gif
   cms/trunk/images/avatars/gallery/gallery1/038.gif
   cms/trunk/images/avatars/gallery/gallery1/039.gif
   cms/trunk/images/avatars/gallery/gallery1/040.gif
   cms/trunk/images/avatars/gallery/gallery1/041.gif
   cms/trunk/images/avatars/gallery/gallery1/042.gif
   cms/trunk/images/avatars/gallery/gallery1/043.gif
   cms/trunk/images/avatars/gallery/gallery1/044.gif
   cms/trunk/images/avatars/gallery/gallery1/045.gif
   cms/trunk/images/avatars/gallery/gallery1/046.gif
   cms/trunk/images/avatars/gallery/gallery1/047.gif
   cms/trunk/images/avatars/gallery/gallery1/048.gif
   cms/trunk/images/avatars/gallery/gallery1/049.gif
   cms/trunk/images/avatars/gallery/gallery1/050.gif
   cms/trunk/images/avatars/gallery/gallery1/051.gif
   cms/trunk/images/avatars/gallery/gallery1/052.gif
   cms/trunk/images/avatars/gallery/gallery1/053.gif
   cms/trunk/images/avatars/gallery/gallery1/054.gif
   cms/trunk/images/avatars/gallery/gallery1/055.gif
   cms/trunk/images/avatars/gallery/gallery1/056.gif
   cms/trunk/images/avatars/gallery/gallery1/057.gif
   cms/trunk/images/avatars/gallery/gallery1/058.gif
   cms/trunk/images/avatars/gallery/gallery1/059.gif
   cms/trunk/images/avatars/gallery/gallery1/060.gif
   cms/trunk/images/avatars/gallery/gallery1/061.gif
   cms/trunk/images/avatars/gallery/gallery1/062.gif
   cms/trunk/images/avatars/gallery/gallery1/063.gif
   cms/trunk/images/avatars/gallery/gallery1/064.gif
   cms/trunk/images/avatars/gallery/gallery1/065.gif
   cms/trunk/images/avatars/gallery/gallery1/066.gif
   cms/trunk/images/avatars/gallery/gallery1/067.gif
   cms/trunk/images/avatars/gallery/gallery1/068.gif
   cms/trunk/images/avatars/gallery/gallery1/069.gif
   cms/trunk/images/avatars/gallery/gallery1/070.gif
   cms/trunk/images/avatars/gallery/gallery1/071.gif
   cms/trunk/images/avatars/gallery/gallery1/072.gif
   cms/trunk/images/avatars/gallery/gallery1/073.gif
   cms/trunk/images/avatars/gallery/gallery1/074.gif
   cms/trunk/images/avatars/gallery/gallery1/075.gif
   cms/trunk/images/avatars/gallery/gallery1/076.gif
   cms/trunk/images/avatars/gallery/gallery1/077.gif
   cms/trunk/images/avatars/gallery/gallery1/078.gif
   cms/trunk/images/avatars/gallery/gallery1/079.gif
   cms/trunk/images/avatars/gallery/gallery1/080.gif
   cms/trunk/images/avatars/gallery/gallery1/081.gif
   cms/trunk/images/avatars/gallery/gallery1/082.gif
   cms/trunk/images/avatars/gallery/gallery1/083.gif
   cms/trunk/images/avatars/gallery/gallery1/084.gif
   cms/trunk/images/avatars/gallery/gallery1/085.gif
   cms/trunk/images/avatars/gallery/gallery1/086.gif
   cms/trunk/images/avatars/gallery/gallery1/087.gif
   cms/trunk/images/avatars/gallery/gallery1/088.gif
   cms/trunk/images/avatars/gallery/gallery1/089.gif
   cms/trunk/images/avatars/gallery/gallery1/090.gif
   cms/trunk/images/avatars/gallery/gallery1/091.gif
   cms/trunk/images/avatars/gallery/gallery1/092.gif
   cms/trunk/images/avatars/gallery/gallery1/093.gif
   cms/trunk/images/avatars/gallery/gallery1/094.gif
   cms/trunk/images/avatars/gallery/gallery1/095.gif
   cms/trunk/images/avatars/gallery/gallery1/096.gif
   cms/trunk/images/avatars/gallery/gallery1/097.gif
   cms/trunk/images/avatars/gallery/gallery1/098.gif
   cms/trunk/images/avatars/gallery/gallery1/099.gif
   cms/trunk/images/avatars/gallery/gallery1/100.gif
   cms/trunk/images/avatars/gallery/gallery1/101.gif
   cms/trunk/images/avatars/gallery/gallery1/102.gif
   cms/trunk/images/avatars/gallery/gallery1/103.gif
   cms/trunk/images/avatars/gallery/gallery1/104.gif
   cms/trunk/images/avatars/gallery/gallery1/105.gif
   cms/trunk/images/avatars/gallery/gallery1/106.gif
   cms/trunk/images/avatars/gallery/gallery1/107.gif
   cms/trunk/images/avatars/gallery/gallery1/108.gif
   cms/trunk/images/avatars/gallery/gallery1/109.gif
   cms/trunk/images/avatars/gallery/gallery1/110.gif
   cms/trunk/images/avatars/gallery/gallery1/111.gif
   cms/trunk/images/avatars/gallery/gallery1/112.gif
   cms/trunk/images/avatars/gallery/gallery1/113.gif
   cms/trunk/images/avatars/gallery/gallery1/114.gif
   cms/trunk/images/avatars/gallery/gallery1/115.gif
   cms/trunk/images/avatars/gallery/gallery1/116.gif
   cms/trunk/images/avatars/gallery/gallery1/117.gif
   cms/trunk/images/avatars/gallery/gallery1/118.gif
   cms/trunk/images/avatars/gallery/gallery1/119.gif
   cms/trunk/images/avatars/gallery/gallery1/120.gif
   cms/trunk/images/avatars/gallery/gallery1/121.gif
   cms/trunk/images/avatars/gallery/gallery1/Thumbs.db
   cms/trunk/images/avatars/gallery/gallery1/blank.gif
   cms/trunk/images/avatars/gallery/gallery2/
   cms/trunk/images/avatars/gallery/gallery2/013.gif
   cms/trunk/images/avatars/gallery/gallery2/014.gif
   cms/trunk/images/avatars/gallery/gallery2/015.gif
   cms/trunk/images/avatars/gallery/gallery2/016.gif
   cms/trunk/images/avatars/gallery/gallery2/121.gif
   cms/trunk/images/avatars/gallery/gallery2/Thumbs.db
   cms/trunk/images/avatars/gallery/gallery2/blank.gif
   cms/trunk/images/avatars/upload/
   cms/trunk/themes/viperal/template/modules/Forums/
   cms/trunk/themes/viperal/template/modules/Forums/images/
   cms/trunk/themes/viperal/template/modules/Forums/images/Thumbs.db
   cms/trunk/themes/viperal/template/modules/Forums/images/background.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/cellpic.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/cellpic1.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/cellpic2.jpg
   cms/trunk/themes/viperal/template/modules/Forums/images/cellpic3.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/created_by.jpg
   cms/trunk/themes/viperal/template/modules/Forums/images/en/
   cms/trunk/themes/viperal/template/modules/Forums/images/en/Thumbs.db
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_email.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_info.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_online.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_report.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_search.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_www.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_link_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_new.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_attach.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_reported.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/index.htm
   cms/trunk/themes/viperal/template/modules/Forums/images/index.php
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma0.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma1.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma2.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma3.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma4.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma5.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/no_avatar.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/progress_bar.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/sitelogo.jpg
   cms/trunk/themes/viperal/template/modules/Forums/images/spacer.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/topic_delete.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/topic_lock.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/topic_move.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/topic_split.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/topic_unlock.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/vote_lcap.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/vote_rcap.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/voting_bar.gif
   cms/trunk/themes/viperal/template/modules/Forums/images/whosonline.gif
Modified:
   cms/trunk/core.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/handler.php
   cms/trunk/install/build_data.php
   cms/trunk/install/installer.php
   cms/trunk/themes/viperal/style/style.css
Log:


Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/core.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -64,26 +64,33 @@
 	}
 }
 
+require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/functions.php');
+require_once($site_file_root.'includes/handler.php');
 require_once($site_file_root.'config.php');
+
+// Load basic classes
+load_class(false, 'core_template');
+load_class(false, 'core_error_handler');
+
+// Set error handler
+$_CLASS['core_error_handler']->start();
+//$_CLASS['core_error_handler']->stop();
+//error_reporting(E_ERROR | E_WARNING | E_PARSE);
+
+if (empty($site_db))
+{
+	trigger_error('<p style="text-align:center">Site isn\'t Installed<br/><a href="install/installer.php">Click here to install</a></p>', E_USER_ERROR);
+}
+
 require_once($site_file_root.'includes/tables.php');
-require_once($site_file_root.'includes/handler.php');
 require_once($site_file_root.'includes/db/'.$site_db['type'].'.php');
-require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/cache/cache.php');
 require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
 
-// Load basic classes
-load_class(false, 'core_error_handler');
 load_class(false, 'core_cache', 'cache_'.$acm_type);
-load_class(false, 'core_template');
 load_class(false, 'core_db', 'db_'.$site_db['type']);
 
-// Set error handler
-$_CLASS['core_error_handler']->start();
-$_CLASS['core_error_handler']->stop();
-//error_reporting(E_ERROR | E_WARNING | E_PARSE);
-
 if (function_exists('register_shutdown_function'))
 {
 	register_shutdown_function('script_close');
@@ -92,7 +99,7 @@
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 
-$_CLASS['core_db']->return_on_error = true;
+$_CLASS['core_db']->report_error(false);
 
 // Error messages just incase we can't get our configs
 $config_error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
@@ -135,9 +142,9 @@
 	}
 }
 
+$_CLASS['core_db']->report_error(false);
 unset($config_error);
 
-$_CLASS['core_db']->return_on_error = false;
 $_CLASS['core_cache']->remove('core_config');
 $_CLASS['core_cache']->remove('config');
 

Added: cms/trunk/images/avatars/gallery/067.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/067.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/068.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/068.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/069.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/069.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/001.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/001.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/002.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/002.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/003.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/003.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/004.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/004.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/005.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/005.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/006.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/006.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/007.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/007.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/008.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/008.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/009.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/009.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/010.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/010.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/011.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/011.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/012.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/012.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/013.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/013.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/014.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/014.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/015.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/015.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/016.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/016.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/017.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/017.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/018.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/018.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/019.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/019.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/020.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/020.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/021.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/021.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/022.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/022.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/023.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/023.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/024.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/024.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/025.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/025.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/026.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/026.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/027.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/027.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/028.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/028.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/029.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/029.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/030.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/030.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/031.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/031.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/032.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/032.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/033.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/033.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/034.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/034.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/035.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/035.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/036.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/036.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/037.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/037.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/038.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/038.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/039.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/039.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/040.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/040.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/041.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/041.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/042.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/042.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/043.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/043.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/044.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/044.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/045.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/045.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/046.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/046.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/047.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/047.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/048.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/048.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/049.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/049.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/050.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/050.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/051.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/051.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/052.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/052.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/053.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/053.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/054.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/054.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/055.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/055.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/056.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/056.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/057.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/057.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/058.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/058.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/059.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/059.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/060.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/060.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/061.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/061.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/062.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/062.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/063.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/063.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/064.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/064.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/065.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/065.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/066.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/066.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/067.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/067.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/068.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/068.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/069.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/069.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/070.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/070.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/071.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/071.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/072.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/072.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/073.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/073.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/074.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/074.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/075.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/075.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/076.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/076.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/077.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/077.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/078.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/078.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/079.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/079.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/080.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/080.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/081.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/081.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/082.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/082.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/083.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/083.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/084.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/084.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/085.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/085.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/086.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/086.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/087.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/087.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/088.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/088.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/089.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/089.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/090.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/090.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/091.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/091.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/092.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/092.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/093.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/093.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/094.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/094.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/095.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/095.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/096.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/096.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/097.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/097.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/098.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/098.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/099.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/099.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/100.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/100.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/101.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/101.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/102.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/102.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/103.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/103.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/104.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/104.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/105.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/105.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/106.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/106.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/107.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/107.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/108.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/108.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/109.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/109.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/110.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/110.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/111.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/111.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/112.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/112.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/113.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/113.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/114.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/114.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/115.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/115.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/116.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/116.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/117.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/117.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/118.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/118.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/119.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/119.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/120.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/120.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/121.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/121.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery1/blank.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery1/blank.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/013.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/013.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/014.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/014.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/015.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/015.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/016.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/016.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/121.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/121.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/avatars/gallery/gallery2/blank.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/avatars/gallery/gallery2/blank.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/includes/functions.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -808,21 +808,6 @@
 	}
 }
 
-//this doesn't work, maybe we should just translate those that can affect the html layout ?
-function core_html_entity_decode($string, $quote_style = ENT_COMPAT)
-{
-	$holding = get_html_translation_table(HTML_ENTITIES, $quote_style);
-
-	foreach ($holding as $from => $to)
-	{
-		$translations[utf8_encode($to)] = utf8_encode($from);
-	}
-
-	unset($translations['&amp;Epsilon;']);
-	//????????, Magyarul
-	return strtr($string, $translations);
-}
-
 if (!function_exists('html_entity_decode'))
 {
 	//string html_entity_decode ( string string [, int quote_style [, string charset]] )

Modified: cms/trunk/includes/handler.php
===================================================================
--- cms/trunk/includes/handler.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/includes/handler.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -182,7 +182,7 @@
 					
 					if (!is_numeric($code))
 					{
-						$error = $code.$error;
+						$error = $code.':'.$error;
 					}
 					else
 					{

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/install/build_data.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -108,24 +108,31 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('blocks', 0, 2,'')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('system', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('messages', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('modules', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('smiles', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('users', 0, 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('groups', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 2, 1, 'block-Control_Panel.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 2, 2, 'block-Modules.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 2, 3, 'block-User.php')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 3, 1, 'http://www.php.net/news.rss', 7200)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 3, 2, 'block-theme_select.php')");
 
+$content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('blocks', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('system', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('messages', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('modules', 0, 2)");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_admin_options) VALUES ('services', 0, 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('smiles', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('users', 0, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status) VALUES ('groups', 0, 2)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Recommend_Us', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Submit_News', 1, 2, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Quick_Message', 1, 1, 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
@@ -287,18 +294,18 @@
 // ADMINISTRATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
 // SUPER MODERATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname')");
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 0, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname');
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname')");
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 

Modified: cms/trunk/install/installer.php
===================================================================
--- cms/trunk/install/installer.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/install/installer.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -447,12 +447,17 @@
 		),
 	);
 
+	if (isset($_POST['test']) && empty($error))
+	{
+		$error[] = 'Database Setting Perfect :-)';
+	}
+
 	$_CLASS['core_template']->assign_array(array(
 		'database_options'	=> $database_options,
 		'php_config'		=> $php_config,
 		'error'				=> empty($error) ? false : implode('<br/>', $error),
 
-		'server'		=> isset($site_db['server']) ? $site_db['server'] : '',
+		'server'		=> isset($site_db['server']) ? $site_db['server'] : 'localhost',
 		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
 		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
 		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',

Modified: cms/trunk/themes/viperal/style/style.css
===================================================================
--- cms/trunk/themes/viperal/style/style.css	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/themes/viperal/style/style.css	2005-09-11 19:12:44 UTC (rev 109)
@@ -18,7 +18,7 @@
 	z-index: 1;
 }
 
-#nav li a
+#nav li a, .active
 {
 	display: block;
 	padding: 5px 10px 5px 5px; 

Added: cms/trunk/themes/viperal/template/modules/Forums/images/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/background.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/background.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/created_by.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/created_by.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_aim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_approve.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_email.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_email.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_icq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_info.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_info.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_ip.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_jabber.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_msnm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_offline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_online.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_online.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_post_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_quote.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_reply_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_report.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_report.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_www.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_www.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/en/btn_yim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_announce_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_link_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_link_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_lock_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_locked_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_attach.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_attach.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_latest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_faq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_groups.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_login.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_members.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_message.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_register.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_mini_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_minipost_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_newest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_reported.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_reported.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/icon_unapproved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/index.htm
===================================================================
--- cms/trunk/themes/viperal/template/modules/Forums/images/index.htm	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/themes/viperal/template/modules/Forums/images/index.htm	2005-09-11 19:12:44 UTC (rev 109)
@@ -0,0 +1,16 @@
+<html>
+<head>
+<title>subSilver created by subBlue Design</title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+<table width="100%" height="100%" cellspacing="0" cellpadding="0" border="0">
+	<tr>
+		<td align="center" valign="middle"><a href="http://www.subblue.com/" target="_new"><img src="created_by.jpg" width="400" height="300" border="0" alt="Created by subBlue Design" /></a></td>
+	</tr>
+</table>
+
+</body>
+</html>
\ No newline at end of file

Added: cms/trunk/themes/viperal/template/modules/Forums/images/index.php
===================================================================
--- cms/trunk/themes/viperal/template/modules/Forums/images/index.php	2005-09-11 17:27:00 UTC (rev 108)
+++ cms/trunk/themes/viperal/template/modules/Forums/images/index.php	2005-09-11 19:12:44 UTC (rev 109)
@@ -0,0 +1,105 @@
+<?php
+$this->img = array
+(
+    'style_id' => '1',
+    'template_id' => '1',
+    'template_name' => 'subSilver',
+    'template_copyright' => '&copy; phpBB Group',
+    'template_path' => 'subSilver',
+    'bbcode_bitfield' => '6913',
+    'template_storedb' => '0',
+    'theme_id' => '1',
+    'theme_name' => 'subSilver',
+    'theme_copyright' => '&copy; phpBB Group',
+    'theme_path' => 'subSilver',
+    'theme_storedb' => '0',
+    'theme_mtime' => '0',
+    'theme_data' => '',
+    'imageset_id' => '1',
+    'imageset_name' => 'subSilver',
+    'imageset_copyright' => '&#65533; phpBB Group',
+    'imageset_path' => 'subSilver',
+    'site_logo' => '',
+    'btn_post' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post.gif*27*97',
+    'btn_post_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_post_pm.gif*27*97',
+    'btn_reply' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply.gif*27*97',
+    'btn_reply_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_reply_pm.gif*20*90',
+    'btn_locked' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_locked.gif*27*97',
+    'btn_profile' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_profile.gif*20*72',
+    'btn_pm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_pm.gif*20*72',
+    'btn_delete' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_delete.gif*20*20',
+    'btn_info' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_info.gif*20*20',
+    'btn_quote' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_quote.gif*20*90',
+    'btn_search' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_search.gif*20*72',
+    'btn_edit' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_edit.gif*20*90',
+    'btn_report' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_report.gif*20*20',
+    'btn_email' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_email.gif*20*72',
+    'btn_www' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_www.gif*20*72',
+    'btn_icq' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_icq.gif*20*72',
+    'btn_aim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_aim.gif*20*72',
+    'btn_yim' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_yim.gif*20*72',
+    'btn_msnm' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_msnm.gif*20*72',
+    'btn_jabber' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_jabber.gif*20*72',
+    'btn_online' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_online.gif*20*72',
+    'btn_offline' => 'themes/viperal/template/modules/Forums/images/{LANG}/btn_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+    'icon_unapproved' => 'themes/viperal/template/modules/Forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' => 'themes/viperal/template/modules/Forums/images/icon_reported.gif*18*19',
+    'icon_attach' => 'themes/viperal/template/modules/Forums/images/icon_attach.gif*18*14',
+    'icon_post' => 'themes/viperal/template/modules/Forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' => 'themes/viperal/template/modules/Forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' => 'themes/viperal/template/modules/Forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' => 'themes/viperal/template/modules/Forums/images/icon_newest_reply.gif*9*18',
+    'forum' => 'themes/viperal/template/modules/Forums/images/folder_big.gif*25*46',
+    'forum_new' => 'themes/viperal/template/modules/Forums/images/folder_new_big.gif*25*46',
+    'forum_locked' => 'themes/viperal/template/modules/Forums/images/folder_locked_big.gif*25*46',
+    'forum_link' => 'themes/viperal/template/modules/Forums/images/folder_link_big.gif*25*46',
+    'sub_forum' => 'themes/viperal/template/modules/Forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' => 'themes/viperal/template/modules/Forums/images/subfolder_new_big.gif*25*46',
+    'folder' => 'themes/viperal/template/modules/Forums/images/folder.gif*18*19',
+    'folder_moved' => 'themes/viperal/template/modules/Forums/images/folder_moved.gif*18*19',
+    'folder_posted' => 'themes/viperal/template/modules/Forums/images/folder_posted.gif*18*19',
+    'folder_new' => 'themes/viperal/template/modules/Forums/images/folder_new.gif*18*19',
+    'folder_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' => 'themes/viperal/template/modules/Forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' => 'themes/viperal/template/modules/Forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' => 'themes/viperal/template/modules/Forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' => 'themes/viperal/template/modules/Forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' => 'themes/viperal/template/modules/Forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' => 'themes/viperal/template/modules/Forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' => 'themes/viperal/template/modules/Forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' => 'themes/viperal/template/modules/Forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' => 'themes/viperal/template/modules/Forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' => '',
+    'folder_global_posted' => '',
+    'folder_global_new' => '',
+    'folder_global_new_posted' => '',
+    'poll_left' => 'themes/viperal/template/modules/Forums/images/vote_lcap.gif*12*4',
+    'poll_center' => 'themes/viperal/template/modules/Forums/images/voting_bar.gif*12',
+    'poll_right' => 'themes/viperal/template/modules/Forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' => 'themes/viperal/template/modules/Forums/images/progress_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'themes/viperal/template/modules/Forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'image_register' => 'themes/viperal/template/modules/Forums/images/icon_mini_register.gif',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+);
+?>
\ No newline at end of file

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/Thumbs.db
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma-5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma0.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma0.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/karma/karma5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/sitelogo.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/sitelogo.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/subfolder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/topic_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/topic_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/topic_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/topic_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/topic_move.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/topic_move.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/topic_split.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/topic_split.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/topic_unlock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/topic_unlock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/vote_lcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/vote_lcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/vote_rcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/vote_rcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/voting_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/voting_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes/viperal/template/modules/Forums/images/whosonline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes/viperal/template/modules/Forums/images/whosonline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From viperal at berlios.de  Sun Sep 11 21:15:53 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 21:15:53 +0200
Subject: [Viperals-svncheckins] r110 - cms/trunk/includes/templates/installer
Message-ID: <200509111915.j8BJFr6K014128@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 21:15:48 +0200 (Sun, 11 Sep 2005)
New Revision: 110

Added:
   cms/trunk/includes/templates/installer/complete.html
   cms/trunk/includes/templates/installer/stage2.html
Modified:
   cms/trunk/includes/templates/installer/stage1.html
Log:
opps, here are the installer templates

Added: cms/trunk/includes/templates/installer/complete.html
===================================================================
--- cms/trunk/includes/templates/installer/complete.html	2005-09-11 19:12:44 UTC (rev 109)
+++ cms/trunk/includes/templates/installer/complete.html	2005-09-11 19:15:48 UTC (rev 110)
@@ -0,0 +1,95 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+				<tbody>
+					<tr>
+						<th style="text-align: center;">Agreement</th>
+					</tr>
+					<tr>
+						<td class="row1">
+							<p style="text-align: center">
+								Congrates { $username }, Your Site is now installed.
+								<br/>
+								<br/>
+								<a href="{ $admin_link }">Go to Site Admin</a>
+							<p>
+						</td>
+					</tr>
+				</tbody>
+			</table>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/trunk/includes/templates/installer/stage1.html
===================================================================
--- cms/trunk/includes/templates/installer/stage1.html	2005-09-11 19:12:44 UTC (rev 109)
+++ cms/trunk/includes/templates/installer/stage1.html	2005-09-11 19:15:48 UTC (rev 110)
@@ -137,57 +137,69 @@
 						<tr>
 							<th colspan="2">Database Configuration</th>
 						</tr>
+						<!-- IF { $error } -->
 						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
 							<td class="row1" width="50%"><b>Database type: </b></td>
-							<td class="row2"><select name="dbms" onchange="change_option(this.value);">{ $database_options }</select></td>
+							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
 						</tr>
 						<tr id="sqlite" style="display: none;">
 							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file" value="" type="text"></td>
+							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
 						</tr>
 						<tr id="sqlite_pdo" style="display: none;">
 							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file" value="" type="text"></td>
+							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
 						</tr>
 						<tr id="all">
 							<td class="row1" width="50%"><b>Database server hostname: </b></td>
-							<td class="row2"><input class="post" name="server" value="" type="text"></td>
+							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
 						</tr>
 						<tr id="all_1">
 							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
-							<td class="row2"><input class="post" name="port" value="" type="text"></td>
+							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
 						</tr>
 						<tr id="all_2">
-							<td class="row1" width="50%"><b>Database name: </b></td>
-							<td class="row2"><input class="post" name="database" value="" type="text"></td>
+							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
+							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
 						</tr>
 						<tr id="all_3">
-							<td class="row1" width="50%"><b>Database username: </b></td>
+							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
 					
-							<td class="row2"><input class="post" name="username" value="" type="text"></td>
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
 						</tr>
 						<tr id="all_4">
 							<td class="row1" width="50%"><b>Database password: </b></td>
-							<td class="row2"><input class="post" name="password" value="" type="password"></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
 						</tr>
 						<tr>
 							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
-							<td class="row2"><input class="post" name="table_prefix" value="cms_" type="text"></td>
+							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
 						</tr>
 						<tr>
 							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
-							<td class="row2"><input class="post" name="user_prefix" value="cms_" type="text"></td>
+							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
 						</tr>
 						<tr>
-							<input type="hidden" name="stage" value="1" />
+							<input type="hidden" name="stage" value="2" />
 							<input type="hidden" name="agreement_signed" value="1" />
-							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Continue" type="submit"></th>
+							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
 						</tr>
 					</tbody>
 				</table>
 			</form>
 		</div>
 	</div>
+
+<script language="Javascript" type="text/javascript">
+<!--
+	change_option(document.getElementById('layer').value);
+//-->
+</script>
+
 </body>
 
 </html>
\ No newline at end of file

Added: cms/trunk/includes/templates/installer/stage2.html
===================================================================
--- cms/trunk/includes/templates/installer/stage2.html	2005-09-11 19:12:44 UTC (rev 109)
+++ cms/trunk/includes/templates/installer/stage2.html	2005-09-11 19:15:48 UTC (rev 110)
@@ -0,0 +1,169 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: relative;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: 0px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<!-- IF { $error } -->
+						<tr>
+							<th align="center" colspan="2">Error</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<th align="center" colspan="2">Administrator Configuration</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Username: </b></td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address: </b></td>
+							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
+						</tr>
+						<tr>
+							<th align="center" colspan="2">Site Configuration</th>
+						</tr>
+						<tr>
+							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Name: </b></td>
+							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Domain: </b></td>
+							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site path: </b></td>
+							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
+							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Path: </b></td>
+					
+							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Name: </b></td>
+							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
+						</tr>
+						<!-- IF { $config_content } -->
+						<tr>
+							<th align="center" colspan="2">Config.php Content</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">
+							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
+							</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="3" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file



From viperal at berlios.de  Sun Sep 11 21:20:59 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 21:20:59 +0200
Subject: [Viperals-svncheckins] r111 - in cms/trunk: . includes
Message-ID: <200509111920.j8BJKxq0014330@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 21:20:57 +0200 (Sun, 11 Sep 2005)
New Revision: 111

Modified:
   cms/trunk/core.php
   cms/trunk/includes/tables.php
Log:
fixed error message

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-11 19:15:48 UTC (rev 110)
+++ cms/trunk/core.php	2005-09-11 19:20:57 UTC (rev 111)
@@ -64,6 +64,11 @@
 	}
 }
 
+//Error reporting tyoe
+define('ERROR_NONE', 0);
+define('ERROR_ONPAGE', 1);
+define('ERROR_DEBUGGER', 2);
+
 require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/functions.php');
 require_once($site_file_root.'includes/handler.php');

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-09-11 19:15:48 UTC (rev 110)
+++ cms/trunk/includes/tables.php	2005-09-11 19:20:57 UTC (rev 111)
@@ -60,11 +60,6 @@
 define('ADMIN_NOT_ADMIN', 1);
 define('ADMIN_IS_ADMIN', 2);
 
-//Error reporting tyoe
-define('ERROR_NONE', 0);
-define('ERROR_ONPAGE', 1);
-define('ERROR_DEBUGGER', 2);
-
 // Block side defines
 define('BLOCK_NONE', 0);
 define('BLOCK_ALL', 1);



From viperal at berlios.de  Sun Sep 11 21:22:31 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 21:22:31 +0200
Subject: [Viperals-svncheckins] r112 - cms/trunk/modules/Forums/admin
Message-ID: <200509111922.j8BJMVae014442@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 21:22:27 +0200 (Sun, 11 Sep 2005)
New Revision: 112

Modified:
   cms/trunk/modules/Forums/admin/index.php
Log:


Modified: cms/trunk/modules/Forums/admin/index.php
===================================================================
--- cms/trunk/modules/Forums/admin/index.php	2005-09-11 19:20:57 UTC (rev 111)
+++ cms/trunk/modules/Forums/admin/index.php	2005-09-11 19:22:27 UTC (rev 112)
@@ -1,11 +1,33 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: pagestart.php,v 1.18 2004/08/02 14:31:45 psotfx Exp $
 //
 // FILENAME  : pagestart.php
 // STARTED   : Thu Aug 2, 2001
-// COPYRIGHT : ? 2001, 2004 phpBB Group
+// COPYRIGHT : 2001, 2004 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
 //
@@ -20,9 +42,9 @@
 $file_uploads = (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on') ? true : false;
 
 $data = array(
-	'title' => 'Forum Administration',
-	'position' => BLOCK_LEFT,
-	'file' => 'block-Admin_Forums.php',
+	'block_title'		=> 'Forum Administration',
+	'block_position'	=> BLOCK_LEFT,
+	'block_file'		=> 'block-Admin_Forums.php',
 );
 
 $_CLASS['core_blocks']->add_block($data);



From viperal at berlios.de  Sun Sep 11 21:31:41 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 21:31:41 +0200
Subject: [Viperals-svncheckins] r113 - in cms/trunk: . images includes/templates
Message-ID: <200509111931.j8BJVfYu015016@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 21:31:33 +0200 (Sun, 11 Sep 2005)
New Revision: 113

Added:
   cms/trunk/images/paladin.png
Modified:
   cms/trunk/.htaccess
   cms/trunk/includes/templates/error.html
Log:


Modified: cms/trunk/.htaccess
===================================================================
--- cms/trunk/.htaccess	2005-09-11 19:22:27 UTC (rev 112)
+++ cms/trunk/.htaccess	2005-09-11 19:31:33 UTC (rev 113)
@@ -1,13 +1,13 @@
-php_flag register_globals 0
-php_flag register_argc_argv 0
-php_flag magic_quotes_gpc 0
+#php_flag register_globals 0
+#php_flag register_argc_argv 0
+#php_flag magic_quotes_gpc 0
 
 <LimitExcept GET PUT POST>
 order allow,deny
 allow from all
 </LimitExcept>
 
-ErrorDocument 403 /error.php?error=403
-ErrorDocument 404 /error.php?error=404
+ErrorDocument 403 error.php?error=403
+ErrorDocument 404 error.php?error=404
 
 Options -Indexes
\ No newline at end of file

Added: cms/trunk/images/paladin.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/paladin.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/includes/templates/error.html
===================================================================
--- cms/trunk/includes/templates/error.html	2005-09-11 19:22:27 UTC (rev 112)
+++ cms/trunk/includes/templates/error.html	2005-09-11 19:31:33 UTC (rev 113)
@@ -4,12 +4,12 @@
 <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
 <title>Error</title>
 </head>
-<body style="background: url(/bg.gif);">
+<body style="background: url(images/bg.gif);">
 
 <table style="position: absolute; left: 25%; top: 25%;">
 	<tr>
 		<td>
-			<img src="/paladin.png" />
+			<img src="images/paladin.png" />
 		</td>
 		<td valign="top">
 			{ $MESSAGE_TEXT }



From viperal at berlios.de  Sun Sep 11 22:13:01 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 22:13:01 +0200
Subject: [Viperals-svncheckins] r114 - in cms/trunk: . includes/display themes/viperal themes/viperal/images themes/viperal/template themes_admin/viperal_admin themes_admin/viperal_admin/images themes_admin/viperal_admin/template
Message-ID: <200509112013.j8BKD1Se018061@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 22:12:59 +0200 (Sun, 11 Sep 2005)
New Revision: 114

Added:
   cms/trunk/themes_admin/viperal_admin/images/Viperal_Logo.gif
   cms/trunk/themes_admin/viperal_admin/images/cellpic1.gif
   cms/trunk/themes_admin/viperal_admin/images/cellpic2.jpg
   cms/trunk/themes_admin/viperal_admin/images/mail.png
   cms/trunk/themes_admin/viperal_admin/images/print.png
Removed:
   cms/trunk/themes/viperal/images/Thumbs.db
   cms/trunk/themes_admin/viperal_admin/images/Thumbs.db
Modified:
   cms/trunk/feed.php
   cms/trunk/includes/display/display.php
   cms/trunk/themes/viperal/index.php
   cms/trunk/themes/viperal/template/header.html
   cms/trunk/themes_admin/viperal_admin/index.php
   cms/trunk/themes_admin/viperal_admin/template/header.html
Log:
domain path for trunk, stupid me forgot to fix it again :-(

Modified: cms/trunk/feed.php
===================================================================
--- cms/trunk/feed.php	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/feed.php	2005-09-11 20:12:59 UTC (rev 114)
@@ -33,7 +33,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 $result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/includes/display/display.php	2005-09-11 20:12:59 UTC (rev 114)
@@ -167,7 +167,7 @@
 			$this->header['regular'] .= '<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />';
 		}
 
-		$this->header['regular'] .= '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'backend.php?feed=rdf" />';
+		$this->header['regular'] .= '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'feed.php?feed=rdf" />';
 
 		if ($_CORE_CONFIG['maintenance']['active'] && $_CORE_CONFIG['maintenance']['start'] < time())
 		{

Deleted: cms/trunk/themes/viperal/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: cms/trunk/themes/viperal/index.php
===================================================================
--- cms/trunk/themes/viperal/index.php	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/themes/viperal/index.php	2005-09-11 20:12:59 UTC (rev 114)
@@ -39,7 +39,7 @@
 		$_CLASS['core_template']->assign_array(array(
 			'A_TABLE_OPEN'	=> $this->table_open,
 			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> '/themes/viperal/style/style.css',
+			'A_STYLESHEET'	=> 'themes/viperal/style/style.css',
 		));
 	}
 

Modified: cms/trunk/themes/viperal/template/header.html
===================================================================
--- cms/trunk/themes/viperal/template/header.html	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/themes/viperal/template/header.html	2005-09-11 20:12:59 UTC (rev 114)
@@ -11,7 +11,7 @@
 { $HEADER_REGULAR }
 
 { $HEADER_JS }
-<script type="text/javascript" src="/javascript/collapse.js"></script>
+<script type="text/javascript" src="javascript/collapse.js"></script>
 
 <!--[if IE]>
 <style>

Deleted: cms/trunk/themes_admin/viperal_admin/images/Thumbs.db
===================================================================
(Binary files differ)

Added: cms/trunk/themes_admin/viperal_admin/images/Viperal_Logo.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes_admin/viperal_admin/images/Viperal_Logo.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes_admin/viperal_admin/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes_admin/viperal_admin/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes_admin/viperal_admin/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes_admin/viperal_admin/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes_admin/viperal_admin/images/mail.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes_admin/viperal_admin/images/mail.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/themes_admin/viperal_admin/images/print.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/themes_admin/viperal_admin/images/print.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/themes_admin/viperal_admin/index.php
===================================================================
--- cms/trunk/themes_admin/viperal_admin/index.php	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/themes_admin/viperal_admin/index.php	2005-09-11 20:12:59 UTC (rev 114)
@@ -30,7 +30,7 @@
 		$_CLASS['core_template']->assign_array(array(
 			'A_TABLE_OPEN'	=> $this->table_open,
 			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> '/themes_admin/viperal_admin/style/style.css',
+			'A_STYLESHEET'	=> 'themes_admin/viperal_admin/style/style.css',
 		));
 	}
 

Modified: cms/trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-11 19:31:33 UTC (rev 113)
+++ cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-11 20:12:59 UTC (rev 114)
@@ -12,8 +12,8 @@
 { $HEADER_REGULAR }
 { $HEADER_JS }
 
-<script type="text/javascript" src="/javascript/collapse.js"></script>
-<script type="text/javascript" src="/javascript/menu.js"></script>
+<script type="text/javascript" src="javascript/collapse.js"></script>
+<script type="text/javascript" src="javascript/menu.js"></script>
 
 <!--[if IE]>
 <style>



From viperal at berlios.de  Sun Sep 11 22:15:54 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 22:15:54 +0200
Subject: [Viperals-svncheckins] r115 - cms/trunk/themes/viperal/style
Message-ID: <200509112015.j8BKFs7p018559@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 22:15:53 +0200 (Sun, 11 Sep 2005)
New Revision: 115

Modified:
   cms/trunk/themes/viperal/style/style.css
Log:
opps

Modified: cms/trunk/themes/viperal/style/style.css
===================================================================
--- cms/trunk/themes/viperal/style/style.css	2005-09-11 20:12:59 UTC (rev 114)
+++ cms/trunk/themes/viperal/style/style.css	2005-09-11 20:15:53 UTC (rev 115)
@@ -7,7 +7,7 @@
     margin: 0px; 
 
     padding: 0px;
-    background: url(/images/bg.gif);
+    background: url(images/bg.gif);
 }
 
 .logo



From viperal at berlios.de  Sun Sep 11 22:20:18 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 22:20:18 +0200
Subject: [Viperals-svncheckins] r116 - in cms/branches/1.0alpha1: . includes includes/display themes/viperal themes/viperal/images themes/viperal/style themes/viperal/template themes_admin/viperal_admin themes_admin/viperal_admin/images themes_admin/viperal_admin/template
Message-ID: <200509112020.j8BKKIWn019073@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 22:20:11 +0200 (Sun, 11 Sep 2005)
New Revision: 116

Added:
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/Viperal_Logo.gif
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic1.gif
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic2.jpg
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/mail.png
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/print.png
Removed:
   cms/branches/1.0alpha1/themes/viperal/images/Thumbs.db
   cms/branches/1.0alpha1/themes_admin/viperal_admin/images/Thumbs.db
Modified:
   cms/branches/1.0alpha1/config.php
   cms/branches/1.0alpha1/core.php
   cms/branches/1.0alpha1/feed.php
   cms/branches/1.0alpha1/includes/display/display.php
   cms/branches/1.0alpha1/includes/tables.php
   cms/branches/1.0alpha1/themes/viperal/index.php
   cms/branches/1.0alpha1/themes/viperal/style/style.css
   cms/branches/1.0alpha1/themes/viperal/template/header.html
   cms/branches/1.0alpha1/themes_admin/viperal_admin/index.php
   cms/branches/1.0alpha1/themes_admin/viperal_admin/template/header.html
Log:
ok now domain path for alpha 1, stupid me forgot to fix it again :-(

Modified: cms/branches/1.0alpha1/config.php
===================================================================
--- cms/branches/1.0alpha1/config.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/config.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -0,0 +1,26 @@
+<?php
+
+$site_db['type'] = 'mysql';
+$site_db['persistent'] = false;
+$site_db['server'] = 'localhost';
+$site_db['port'] = '';
+$site_db['database'] = 'bracnh';
+$site_db['username'] = 'root';
+$site_db['password'] = '';
+
+$table_prefix	= 'cms_';
+$user_prefix	= 'cms_';
+
+$acm_type		= 'file';
+
+if (!defined('INDEX_PAGE'))
+{
+	define('INDEX_PAGE', 'index.php');
+}
+
+if (!defined('ADMIN_PAGE'))
+{
+	define('ADMIN_PAGE', 'admin.php');
+}
+
+?>
\ No newline at end of file

Modified: cms/branches/1.0alpha1/core.php
===================================================================
--- cms/branches/1.0alpha1/core.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/core.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -64,6 +64,11 @@
 	}
 }
 
+//Error reporting tyoe
+define('ERROR_NONE', 0);
+define('ERROR_ONPAGE', 1);
+define('ERROR_DEBUGGER', 2);
+
 require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/functions.php');
 require_once($site_file_root.'includes/handler.php');

Modified: cms/branches/1.0alpha1/feed.php
===================================================================
--- cms/branches/1.0alpha1/feed.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/feed.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -33,7 +33,7 @@
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $prefix.'articles');
+	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
 $result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);

Modified: cms/branches/1.0alpha1/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha1/includes/display/display.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/includes/display/display.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -167,7 +167,7 @@
 			$this->header['regular'] .= '<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />';
 		}
 
-		$this->header['regular'] .= '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'backend.php?feed=rdf" />';
+		$this->header['regular'] .= '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'feed.php?feed=rdf" />';
 
 		if ($_CORE_CONFIG['maintenance']['active'] && $_CORE_CONFIG['maintenance']['start'] < time())
 		{

Modified: cms/branches/1.0alpha1/includes/tables.php
===================================================================
--- cms/branches/1.0alpha1/includes/tables.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/includes/tables.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -60,11 +60,6 @@
 define('ADMIN_NOT_ADMIN', 1);
 define('ADMIN_IS_ADMIN', 2);
 
-//Error reporting tyoe
-define('ERROR_NONE', 0);
-define('ERROR_ONPAGE', 1);
-define('ERROR_DEBUGGER', 2);
-
 // Block side defines
 define('BLOCK_NONE', 0);
 define('BLOCK_ALL', 1);

Deleted: cms/branches/1.0alpha1/themes/viperal/images/Thumbs.db
===================================================================
(Binary files differ)

Modified: cms/branches/1.0alpha1/themes/viperal/index.php
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/index.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/themes/viperal/index.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -39,7 +39,7 @@
 		$_CLASS['core_template']->assign_array(array(
 			'A_TABLE_OPEN'	=> $this->table_open,
 			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> '/themes/viperal/style/style.css',
+			'A_STYLESHEET'	=> 'themes/viperal/style/style.css',
 		));
 	}
 

Modified: cms/branches/1.0alpha1/themes/viperal/style/style.css
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/style/style.css	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/themes/viperal/style/style.css	2005-09-11 20:20:11 UTC (rev 116)
@@ -7,7 +7,7 @@
     margin: 0px; 
 
     padding: 0px;
-    background: url(/images/bg.gif);
+    background: url(images/bg.gif);
 }
 
 .logo

Modified: cms/branches/1.0alpha1/themes/viperal/template/header.html
===================================================================
--- cms/branches/1.0alpha1/themes/viperal/template/header.html	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/themes/viperal/template/header.html	2005-09-11 20:20:11 UTC (rev 116)
@@ -11,7 +11,7 @@
 { $HEADER_REGULAR }
 
 { $HEADER_JS }
-<script type="text/javascript" src="/javascript/collapse.js"></script>
+<script type="text/javascript" src="javascript/collapse.js"></script>
 
 <!--[if IE]>
 <style>

Deleted: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/Thumbs.db
===================================================================
(Binary files differ)

Added: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/Viperal_Logo.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/Viperal_Logo.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/mail.png
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/mail.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/print.png
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha1/themes_admin/viperal_admin/images/print.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/branches/1.0alpha1/themes_admin/viperal_admin/index.php
===================================================================
--- cms/branches/1.0alpha1/themes_admin/viperal_admin/index.php	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/themes_admin/viperal_admin/index.php	2005-09-11 20:20:11 UTC (rev 116)
@@ -30,7 +30,7 @@
 		$_CLASS['core_template']->assign_array(array(
 			'A_TABLE_OPEN'	=> $this->table_open,
 			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> '/themes_admin/viperal_admin/style/style.css',
+			'A_STYLESHEET'	=> 'themes_admin/viperal_admin/style/style.css',
 		));
 	}
 

Modified: cms/branches/1.0alpha1/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/branches/1.0alpha1/themes_admin/viperal_admin/template/header.html	2005-09-11 20:15:53 UTC (rev 115)
+++ cms/branches/1.0alpha1/themes_admin/viperal_admin/template/header.html	2005-09-11 20:20:11 UTC (rev 116)
@@ -12,8 +12,8 @@
 { $HEADER_REGULAR }
 { $HEADER_JS }
 
-<script type="text/javascript" src="/javascript/collapse.js"></script>
-<script type="text/javascript" src="/javascript/menu.js"></script>
+<script type="text/javascript" src="javascript/collapse.js"></script>
+<script type="text/javascript" src="javascript/menu.js"></script>
 
 <!--[if IE]>
 <style>



From viperal at berlios.de  Sun Sep 11 22:23:59 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 11 Sep 2005 22:23:59 +0200
Subject: [Viperals-svncheckins] r117 - cms/branches/1.0alpha1
Message-ID: <200509112023.j8BKNxsm019358@sheep.berlios.de>

Author: viperal
Date: 2005-09-11 22:23:58 +0200 (Sun, 11 Sep 2005)
New Revision: 117

Modified:
   cms/branches/1.0alpha1/config.php
Log:
here we have a big, opps

Modified: cms/branches/1.0alpha1/config.php
===================================================================
--- cms/branches/1.0alpha1/config.php	2005-09-11 20:20:11 UTC (rev 116)
+++ cms/branches/1.0alpha1/config.php	2005-09-11 20:23:58 UTC (rev 117)
@@ -1,26 +0,0 @@
-<?php
-
-$site_db['type'] = 'mysql';
-$site_db['persistent'] = false;
-$site_db['server'] = 'localhost';
-$site_db['port'] = '';
-$site_db['database'] = 'bracnh';
-$site_db['username'] = 'root';
-$site_db['password'] = '';
-
-$table_prefix	= 'cms_';
-$user_prefix	= 'cms_';
-
-$acm_type		= 'file';
-
-if (!defined('INDEX_PAGE'))
-{
-	define('INDEX_PAGE', 'index.php');
-}
-
-if (!defined('ADMIN_PAGE'))
-{
-	define('ADMIN_PAGE', 'admin.php');
-}
-
-?>
\ No newline at end of file



From viperal at berlios.de  Tue Sep 13 05:42:32 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 13 Sep 2005 05:42:32 +0200
Subject: [Viperals-svncheckins] r118 - in cms/trunk: . install
Message-ID: <200509130342.j8D3gWex029130@sheep.berlios.de>

Author: viperal
Date: 2005-09-13 05:42:19 +0200 (Tue, 13 Sep 2005)
New Revision: 118

Added:
   cms/trunk/installer.php
Removed:
   cms/trunk/install/installer.php
Log:


Deleted: cms/trunk/install/installer.php
===================================================================
--- cms/trunk/install/installer.php	2005-09-11 20:23:58 UTC (rev 117)
+++ cms/trunk/install/installer.php	2005-09-13 03:42:19 UTC (rev 118)
@@ -1,481 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-define('VIPERAL', 'INSTALLER');
-
-error_reporting(E_ALL);
-
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '../';
-
-if (!extension_loaded('mbstring'))
-{
-	require_once($site_file_root.'includes/compatiblity/mbstring.php');
-}
-
-set_magic_quotes_runtime(0);
-mb_internal_encoding('UTF-8');
-
-define('STRIP_SLASHES', get_magic_quotes_gpc());
-
-// Remove registered globals
-if ((bool) ini_get('register_globals'))
-{
-	foreach ($_REQUEST as $var_name => $value)
-	{
-		unset($$var_name);
-	}
-}
-
-require_once($site_file_root.'includes/functions.php');
-require_once($site_file_root.'includes/display/template.php');
-
-load_class(false, 'core_template');
-
-$holding_array = array(
-	'mysql'		=> array(
-		'lang'			=> 'MySQL',
-		'extension'		=> 'mysql', 
-	),
-	'mysql3'			=> array(
-		'lang'			=> 'MySQL3',
-		'extension'		=> 'mysql',
-	),
-	'mysqli'	=> array(
-		'lang'			=> 'MySQL 4.1.x',
-		'extension'		=> 'mysqli', 
-	),
-	'mssql'		=> array(
-		'lang'			=> 'MS SQL Server 7/2000',
-		'extension'		=> 'mssql', 
-	),
-	'postgres' => array(
-		'lang'			=> 'PostgreSQL',
-		'extension'		=> 'pgsql', 
-	),
-	'sqlite'		=> array(
-		'lang'			=> 'SQLite',
-		'extension'		=> 'sqlite', 
-	),
-	'sqlite_pdo'		=> array(
-		'lang'			=> 'SQLite 3 (PDO)',
-		'extension'		=> 'pdo_sqlite', 
-	)
-);
-
-$database_array = array();
-$database_options = '';
-$db_layer = isset($_POST['layer']) ? $_POST['layer'] : false;
-
-foreach ($holding_array as $name => $setting)
-{
-	if (extension_loaded($setting['extension']))
-	{
-		$database_options .= '<option value="' . $name . '"'.(($db_layer == $name) ? ' selected="selected"' : '').'>' . $setting['lang'] . '</option>';
-		$database_array[$name] = $setting;
-	}
-}
-
-$error = array();
-$stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
-
-if ($stage && !$_POST['agreement_signed'])
-{
-	$stage = 0;
-}
-
-if ($stage === 3)
-{
-	if (file_exists($site_file_root.'config.php'))
-	{
-		require_once($site_file_root.'config.php');
-	}
-
-	$site_name		= get_variable('site_name', 'POST');
-	$site_domain	= get_variable('site_domain', 'POST');
-	$site_path		= get_variable('site_path', 'POST');
-	$site_port		= get_variable('site_port', 'POST');
-
-	$cookie_domain	= get_variable('cookie_domain', 'POST');
-	$cookie_path	= get_variable('cookie_path', 'POST');
-	$cookie_name	= get_variable('cookie_name', 'POST');
-
-	$username		= get_variable('username', 'POST');
-	$password		= get_variable('password', 'POST');
-	$password_confirm= get_variable('password_confirm', 'POST');
-	$email			= get_variable('email', 'POST');
-	$email_confirm	= get_variable('email_confirm', 'POST');
-
-	if (!$username)
-	{
-		$error[] = 'Invalid Username';
-	}
-
-	if (!$password || ($password !== $password_confirm))
-	{
-		$error[] = 'Passwords do not match.';
-	}
-
-	if (!$email || ($email !== $email_confirm))
-	{
-		$error[] = 'Emails Address do not match.';
-	}
-
-	if (!$site_domain)
-	{
-		$error[] = 'Site Domain is empty.';
-	}
-
-	if (!$site_domain)
-	{
-		$error[] = 'Site Domain is empty.';
-	}
-
-	if (isset($site_db))
-	{
-		load_class($site_file_root.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
-
-		$_CLASS['core_db']->connect($site_db);
-		$config_content = '';
-	}
-	else
-	{
-		$error[] = '<b>Please upload the content listed in the "Config.php Content" Section</b>';
-		$config_content = get_variable('config_content', 'POST');
-	}
-
-	if (empty($error))
-	{
-		require_once($site_file_root.'includes/tables.php');
-		require_once($site_file_root.'includes/cache/cache.php');
-		require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
-
-		load_class(false, 'core_cache', 'cache_'.$acm_type);
-
-		set_core_config('global', 'site_name', $site_name, false);
-		set_core_config('server', 'site_domain', $site_domain, false);
-		set_core_config('server', 'site_path', $site_path, false);
-		set_core_config('server', 'site_port', $site_port, false);
-		set_core_config('server', 'cookie_domain', $cookie_domain, false);
-		set_core_config('server', 'cookie_path', $cookie_path, false);
-		set_core_config('server', 'cookie_name', $cookie_name, false);
-		set_core_config('server', 'site_secure', 0, false);
-
-		set_core_config('user', 'newest_username', $username, true);
-		
-		$user_update = array(
-			'username'				=> $username,
-			'user_password'			=> encode_password($password, 'md5'),
-			'user_password_encoding'=> 'md5',
-			'user_email'			=> $email
-		);
-
-		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
-
-		$_CLASS['core_template']->assign_array(array(
-			'admin_link'		=> generate_link(false, array('full' => true, 'sid' => false, 'admin' => true)),
-			'username'			=> $username,
-		));
-
-		$_CLASS['core_template']->display('installer/complete.html');
-		
-		script_close();
-	}
-
-	$_CLASS['core_template']->assign_array(array(
-		'site_name'			=> $site_name,
-		'site_domain'		=> $site_domain,
-		'site_path'			=> $site_path,
-		'site_port'			=> $site_port,
-		'cookie_domain'		=> $cookie_domain,
-		'cookie_path'		=> $cookie_path,
-		'cookie_name'		=> $cookie_name,
-		'username'			=> $username,
-		'password'			=> $password,
-		'password_confirm'	=> $password_confirm,
-		'email'				=> $email,
-		'email_confirm'		=> $email_confirm,
-		'error'				=> empty($error) ? false : implode('<br/>', $error),
-		'config_content'	=> $config_content
-	));
-
-	$_CLASS['core_template']->display('installer/stage2.html');
-
-	script_close();
-}
-
-if ($stage === 2)
-{
-	if ($db_layer && in_array($db_layer, array_keys($database_array)))
-	{
-		load_class($site_file_root.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
-
-		$site_db = array();
-		$site_db['type']		= $db_layer;
-		$site_db['persistent']	= false;
-
-		$_CLASS['core_db']->report_error(false);
-
-		if (strpos($db_layer, 'sqlite') === false)
-		{
-			$site_db['server']		= get_variable('server', 'POST');
-			$site_db['port']		= get_variable('port', 'POST');
-			$site_db['database']	= get_variable('database', 'POST');
-			$site_db['username']	= get_variable('username', 'POST');
-			$site_db['password']	= get_variable('password', 'POST');
-			
-			if (!$site_db['username'] || !$site_db['database'])
-			{
-				$error[] = 'Required Information missing';
-			}
-		}
-		else
-		{
-			$site_db['file'] = get_variable('file_'.$db_layer, 'POST');
-
-			if (!$site_db['file'])
-			{
-				$error[] = 'Required Information missing';
-			}
-		}
-	}
-	else
-	{
-		$error[] = 'Database not supported on your system';
-	}
-
-	if (empty($error) && !$_CLASS['core_db']->connect($site_db))
-	{
-		if (!$_CLASS['core_db']->link_identifier)
-		{
-			$db_error = $_CLASS['core_db']->sql_error(false, true);
-			$error[] = 'Could not connect to the database'.(($db_error['message']) ? '<br/>'.$db_error['message'] : '');
-		}
-		else
-		{
-			if (isset($_POST['test']))
-			{
-				$error[] = 'Database Selection fail, will attempt to create in next step';
-			}
-			else
-			{
-				switch ($db_layer)
-				{
-					case 'mysql':
-					case 'mysqli':
-						$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'].' DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci');
-					break;
-
-					case 'mysql3':
-						$_CLASS['core_db']->query('CREATE DATABASE  '.$site_db['database']);
-					break;
-
-					case 'postgres':
-						if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
-						{
-							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'] .' WITH ENCODING UNICODE');
-						}
-						else
-						{
-							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database']);
-						}
-					break;
-				}
-
-				$_CLASS['core_db']->disconnect();
-				$_CLASS['core_db']->connect($site_db);
-
-				if (!$_CLASS['core_db']->connect($site_db))
-				{
-					$error[] = 'Database Creation Failed';
-				}
-			}
-		}
-	}
-	
-	if (empty($error))
-	{
-		$user_prefix	= get_variable('user_prefix', 'POST');
-		$table_prefix	= get_variable('table_prefix', 'POST');
-		
-		require_once($site_file_root.'includes/tables.php');
-	
-		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
-		$result = $_CLASS['core_db']->query($sql);
-		$_CLASS['core_db']->free_result($result);
-	
-		if ($result)
-		{
-			$error[] = 'Creation Failed: Current installation found';
-		}
-	}
-
-	if (isset($_POST['test']) || !empty($error))
-	{
-		$stage = 1;
-	}
-	else
-	{
-		$_CLASS['core_db']->transaction();
-		require($site_file_root.'install/build_tables.php');
-		$_CLASS['core_db']->transaction('commit');
-	
-		$_CLASS['core_db']->transaction();
-		require($site_file_root.'install/build_data.php');
-		$_CLASS['core_db']->transaction('commit');
-		
-		$_CLASS['core_db']->optimize_tables();
-		
-		$_CLASS['core_db']->report_error(true);
-	
-		$config_data = "<?php\n\n";
-
-		foreach ($site_db as $name => $value)
-		{
-			if (is_bool($value))
-			{
-				$value = ($value) ? 'true' : 'false';
-			}
-			elseif (!is_int($value))
-			{
-				$value = "'$value'";
-			}
-
-			$config_data .= "\$site_db['$name'] = $value;\n";
-		}
-
-		$config_data .= "\n";
-		$config_data .= "\$table_prefix\t= '$table_prefix';\n";
-		$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
-		$config_data .= "\$acm_type\t\t= 'file';\n\n";
-		$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
-		$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
-		$config_data .= '?>';
-
-		if (file_put_contents($site_file_root.'config.php', $config_data))
-		{
-			$config_data = false;
-		}
-		else
-		{
-			$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
-		}
-		
-		$path = dirname(getenv('SCRIPT_NAME'));
-
-		if (substr($path, -1) != '/')
-		{
-			$path .= '/';
-		}
-
-		$path = str_replace('install/', '', $path);
-		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
-
-		$_CLASS['core_template']->assign_array(array(
-			'site_name'			=> 'New CMS Site',
-			'site_domain'		=> $domain,
-			'site_path'			=> $path,
-			'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
-			'cookie_domain'		=> $domain,
-			'cookie_path'		=> $path,
-			'cookie_name'		=> 'cms',
-			'username'			=> '',
-			'password'			=> '',
-			'password_confirm'	=> '',
-			'email'				=> '',
-			'email_confirm'		=> '',
-			'error'				=> empty($error) ? false : implode('<br/>', $error),
-			'config_content'	=> $config_data
-		));
-
-		$_CLASS['core_template']->display('installer/stage2.html');
-
-		script_close();
-	}
-}
-
-if ($stage === 1)
-{
-	$php_config = array(
-		/*array(
-			'lang'	=> 'PHP version',
-			'recommended'	=> '4.2.3 +',
-			'current'		=> PHP_VERSION
-		),*/
-		array(
-			'lang'	=> 'Safe Mode',
-			'ini'	=> 'safe_mode',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('safe_mode')
-		),
-		array(
-			'lang'	=> 'Magic Quotes GPC',
-			'ini'	=> 'magic_quotes_gpc',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('magic_quotes_gpc')
-		),
-		array(
-			'lang'	=> 'Register Globals',
-			'ini'	=> 'register_globals',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('register_globals')
-		),
-		array(
-			'lang'	=> 'Output Buffering',
-			'ini'	=> 'output_buffering',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('output_buffering')
-		),
-	);
-
-	if (isset($_POST['test']) && empty($error))
-	{
-		$error[] = 'Database Setting Perfect :-)';
-	}
-
-	$_CLASS['core_template']->assign_array(array(
-		'database_options'	=> $database_options,
-		'php_config'		=> $php_config,
-		'error'				=> empty($error) ? false : implode('<br/>', $error),
-
-		'server'		=> isset($site_db['server']) ? $site_db['server'] : 'localhost',
-		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
-		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
-		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',
-		'password'		=> isset($site_db['password']) ? $site_db['password'] : '',
-		'file'			=> isset($site_db['file']) ? $site_db['file'] : '',
-		'table_prefix'	=> get_variable('table_prefix', 'POST', 'cms_'),
-		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
-	));
-
-	$_CLASS['core_template']->display('installer/stage1.html');
-
-	script_close();
-}
-
-if (!$stage)
-{
-	$_CLASS['core_template']->display('installer/agreement.html');
-	script_close();
-}
-
-?>
\ No newline at end of file

Added: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-11 20:23:58 UTC (rev 117)
+++ cms/trunk/installer.php	2005-09-13 03:42:19 UTC (rev 118)
@@ -0,0 +1,481 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+define('VIPERAL', 'INSTALLER');
+
+error_reporting(E_ALL);
+
+//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
+$site_file_root = '../';
+
+if (!extension_loaded('mbstring'))
+{
+	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+}
+
+set_magic_quotes_runtime(0);
+mb_internal_encoding('UTF-8');
+
+define('STRIP_SLASHES', get_magic_quotes_gpc());
+
+// Remove registered globals
+if ((bool) ini_get('register_globals'))
+{
+	foreach ($_REQUEST as $var_name => $value)
+	{
+		unset($$var_name);
+	}
+}
+
+require_once($site_file_root.'includes/functions.php');
+require_once($site_file_root.'includes/display/template.php');
+
+load_class(false, 'core_template');
+
+$holding_array = array(
+	'mysql'		=> array(
+		'lang'			=> 'MySQL',
+		'extension'		=> 'mysql', 
+	),
+	'mysql3'			=> array(
+		'lang'			=> 'MySQL3',
+		'extension'		=> 'mysql',
+	),
+	'mysqli'	=> array(
+		'lang'			=> 'MySQL 4.1.x',
+		'extension'		=> 'mysqli', 
+	),
+	'mssql'		=> array(
+		'lang'			=> 'MS SQL Server 7/2000',
+		'extension'		=> 'mssql', 
+	),
+	'postgres' => array(
+		'lang'			=> 'PostgreSQL',
+		'extension'		=> 'pgsql', 
+	),
+	'sqlite'		=> array(
+		'lang'			=> 'SQLite',
+		'extension'		=> 'sqlite', 
+	),
+	'sqlite_pdo'		=> array(
+		'lang'			=> 'SQLite 3 (PDO)',
+		'extension'		=> 'pdo_sqlite', 
+	)
+);
+
+$database_array = array();
+$database_options = '';
+$db_layer = isset($_POST['layer']) ? $_POST['layer'] : false;
+
+foreach ($holding_array as $name => $setting)
+{
+	if (extension_loaded($setting['extension']))
+	{
+		$database_options .= '<option value="' . $name . '"'.(($db_layer == $name) ? ' selected="selected"' : '').'>' . $setting['lang'] . '</option>';
+		$database_array[$name] = $setting;
+	}
+}
+
+$error = array();
+$stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
+
+if ($stage && !$_POST['agreement_signed'])
+{
+	$stage = 0;
+}
+
+if ($stage === 3)
+{
+	if (file_exists($site_file_root.'config.php'))
+	{
+		require_once($site_file_root.'config.php');
+	}
+
+	$site_name		= get_variable('site_name', 'POST');
+	$site_domain	= get_variable('site_domain', 'POST');
+	$site_path		= get_variable('site_path', 'POST');
+	$site_port		= get_variable('site_port', 'POST');
+
+	$cookie_domain	= get_variable('cookie_domain', 'POST');
+	$cookie_path	= get_variable('cookie_path', 'POST');
+	$cookie_name	= get_variable('cookie_name', 'POST');
+
+	$username		= get_variable('username', 'POST');
+	$password		= get_variable('password', 'POST');
+	$password_confirm= get_variable('password_confirm', 'POST');
+	$email			= get_variable('email', 'POST');
+	$email_confirm	= get_variable('email_confirm', 'POST');
+
+	if (!$username)
+	{
+		$error[] = 'Invalid Username';
+	}
+
+	if (!$password || ($password !== $password_confirm))
+	{
+		$error[] = 'Passwords do not match.';
+	}
+
+	if (!$email || ($email !== $email_confirm))
+	{
+		$error[] = 'Emails Address do not match.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (!$site_domain)
+	{
+		$error[] = 'Site Domain is empty.';
+	}
+
+	if (isset($site_db))
+	{
+		load_class($site_file_root.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
+
+		$_CLASS['core_db']->connect($site_db);
+		$config_content = '';
+	}
+	else
+	{
+		$error[] = '<b>Please upload the content listed in the "Config.php Content" Section</b>';
+		$config_content = get_variable('config_content', 'POST');
+	}
+
+	if (empty($error))
+	{
+		require_once($site_file_root.'includes/tables.php');
+		require_once($site_file_root.'includes/cache/cache.php');
+		require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+
+		load_class(false, 'core_cache', 'cache_'.$acm_type);
+
+		set_core_config('global', 'site_name', $site_name, false);
+		set_core_config('server', 'site_domain', $site_domain, false);
+		set_core_config('server', 'site_path', $site_path, false);
+		set_core_config('server', 'site_port', $site_port, false);
+		set_core_config('server', 'cookie_domain', $cookie_domain, false);
+		set_core_config('server', 'cookie_path', $cookie_path, false);
+		set_core_config('server', 'cookie_name', $cookie_name, false);
+		set_core_config('server', 'site_secure', 0, false);
+
+		set_core_config('user', 'newest_username', $username, true);
+		
+		$user_update = array(
+			'username'				=> $username,
+			'user_password'			=> encode_password($password, 'md5'),
+			'user_password_encoding'=> 'md5',
+			'user_email'			=> $email
+		);
+
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $user_update). ' WHERE user_id = 2');
+
+		$_CLASS['core_template']->assign_array(array(
+			'admin_link'		=> generate_link(false, array('full' => true, 'sid' => false, 'admin' => true)),
+			'username'			=> $username,
+		));
+
+		$_CLASS['core_template']->display('installer/complete.html');
+		
+		script_close();
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'site_name'			=> $site_name,
+		'site_domain'		=> $site_domain,
+		'site_path'			=> $site_path,
+		'site_port'			=> $site_port,
+		'cookie_domain'		=> $cookie_domain,
+		'cookie_path'		=> $cookie_path,
+		'cookie_name'		=> $cookie_name,
+		'username'			=> $username,
+		'password'			=> $password,
+		'password_confirm'	=> $password_confirm,
+		'email'				=> $email,
+		'email_confirm'		=> $email_confirm,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+		'config_content'	=> $config_content
+	));
+
+	$_CLASS['core_template']->display('installer/stage2.html');
+
+	script_close();
+}
+
+if ($stage === 2)
+{
+	if ($db_layer && in_array($db_layer, array_keys($database_array)))
+	{
+		load_class($site_file_root.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
+
+		$site_db = array();
+		$site_db['type']		= $db_layer;
+		$site_db['persistent']	= false;
+
+		$_CLASS['core_db']->report_error(false);
+
+		if (strpos($db_layer, 'sqlite') === false)
+		{
+			$site_db['server']		= get_variable('server', 'POST');
+			$site_db['port']		= get_variable('port', 'POST');
+			$site_db['database']	= get_variable('database', 'POST');
+			$site_db['username']	= get_variable('username', 'POST');
+			$site_db['password']	= get_variable('password', 'POST');
+			
+			if (!$site_db['username'] || !$site_db['database'])
+			{
+				$error[] = 'Required Information missing';
+			}
+		}
+		else
+		{
+			$site_db['file'] = get_variable('file_'.$db_layer, 'POST');
+
+			if (!$site_db['file'])
+			{
+				$error[] = 'Required Information missing';
+			}
+		}
+	}
+	else
+	{
+		$error[] = 'Database not supported on your system';
+	}
+
+	if (empty($error) && !$_CLASS['core_db']->connect($site_db))
+	{
+		if (!$_CLASS['core_db']->link_identifier)
+		{
+			$db_error = $_CLASS['core_db']->sql_error(false, true);
+			$error[] = 'Could not connect to the database'.(($db_error['message']) ? '<br/>'.$db_error['message'] : '');
+		}
+		else
+		{
+			if (isset($_POST['test']))
+			{
+				$error[] = 'Database Selection fail, will attempt to create in next step';
+			}
+			else
+			{
+				switch ($db_layer)
+				{
+					case 'mysql':
+					case 'mysqli':
+						$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'].' DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci');
+					break;
+
+					case 'mysql3':
+						$_CLASS['core_db']->query('CREATE DATABASE  '.$site_db['database']);
+					break;
+
+					case 'postgres':
+						if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN')
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database'] .' WITH ENCODING UNICODE');
+						}
+						else
+						{
+							$_CLASS['core_db']->query('CREATE DATABASE '.$site_db['database']);
+						}
+					break;
+				}
+
+				$_CLASS['core_db']->disconnect();
+				$_CLASS['core_db']->connect($site_db);
+
+				if (!$_CLASS['core_db']->connect($site_db))
+				{
+					$error[] = 'Database Creation Failed';
+				}
+			}
+		}
+	}
+	
+	if (empty($error))
+	{
+		$user_prefix	= get_variable('user_prefix', 'POST');
+		$table_prefix	= get_variable('table_prefix', 'POST');
+		
+		require_once($site_file_root.'includes/tables.php');
+	
+		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->free_result($result);
+	
+		if ($result)
+		{
+			$error[] = 'Creation Failed: Current installation found';
+		}
+	}
+
+	if (isset($_POST['test']) || !empty($error))
+	{
+		$stage = 1;
+	}
+	else
+	{
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_tables.php');
+		$_CLASS['core_db']->transaction('commit');
+	
+		$_CLASS['core_db']->transaction();
+		require($site_file_root.'install/build_data.php');
+		$_CLASS['core_db']->transaction('commit');
+		
+		$_CLASS['core_db']->optimize_tables();
+		
+		$_CLASS['core_db']->report_error(true);
+	
+		$config_data = "<?php\n\n";
+
+		foreach ($site_db as $name => $value)
+		{
+			if (is_bool($value))
+			{
+				$value = ($value) ? 'true' : 'false';
+			}
+			elseif (!is_int($value))
+			{
+				$value = "'$value'";
+			}
+
+			$config_data .= "\$site_db['$name'] = $value;\n";
+		}
+
+		$config_data .= "\n";
+		$config_data .= "\$table_prefix\t= '$table_prefix';\n";
+		$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
+		$config_data .= "\$acm_type\t\t= 'file';\n\n";
+		$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
+		$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
+		$config_data .= '?>';
+
+		if (file_put_contents($site_file_root.'config.php', $config_data))
+		{
+			$config_data = false;
+		}
+		else
+		{
+			$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
+		}
+		
+		$path = dirname(getenv('SCRIPT_NAME'));
+
+		if (substr($path, -1) != '/')
+		{
+			$path .= '/';
+		}
+
+		$path = str_replace('install/', '', $path);
+		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
+
+		$_CLASS['core_template']->assign_array(array(
+			'site_name'			=> 'New CMS Site',
+			'site_domain'		=> $domain,
+			'site_path'			=> $path,
+			'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
+			'cookie_domain'		=> $domain,
+			'cookie_path'		=> $path,
+			'cookie_name'		=> 'cms',
+			'username'			=> '',
+			'password'			=> '',
+			'password_confirm'	=> '',
+			'email'				=> '',
+			'email_confirm'		=> '',
+			'error'				=> empty($error) ? false : implode('<br/>', $error),
+			'config_content'	=> $config_data
+		));
+
+		$_CLASS['core_template']->display('installer/stage2.html');
+
+		script_close();
+	}
+}
+
+if ($stage === 1)
+{
+	$php_config = array(
+		/*array(
+			'lang'	=> 'PHP version',
+			'recommended'	=> '4.2.3 +',
+			'current'		=> PHP_VERSION
+		),*/
+		array(
+			'lang'	=> 'Safe Mode',
+			'ini'	=> 'safe_mode',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('safe_mode')
+		),
+		array(
+			'lang'	=> 'Magic Quotes GPC',
+			'ini'	=> 'magic_quotes_gpc',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('magic_quotes_gpc')
+		),
+		array(
+			'lang'	=> 'Register Globals',
+			'ini'	=> 'register_globals',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('register_globals')
+		),
+		array(
+			'lang'	=> 'Output Buffering',
+			'ini'	=> 'output_buffering',
+			'recommended'	=> false,
+			'current'		=> (bool) ini_get('output_buffering')
+		),
+	);
+
+	if (isset($_POST['test']) && empty($error))
+	{
+		$error[] = 'Database Setting Perfect :-)';
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'database_options'	=> $database_options,
+		'php_config'		=> $php_config,
+		'error'				=> empty($error) ? false : implode('<br/>', $error),
+
+		'server'		=> isset($site_db['server']) ? $site_db['server'] : 'localhost',
+		'port'			=> isset($site_db['port']) ? $site_db['port'] : '',
+		'database'		=> isset($site_db['database']) ? $site_db['database'] : '',
+		'username'		=> isset($site_db['username']) ? $site_db['username'] : '',
+		'password'		=> isset($site_db['password']) ? $site_db['password'] : '',
+		'file'			=> isset($site_db['file']) ? $site_db['file'] : '',
+		'table_prefix'	=> get_variable('table_prefix', 'POST', 'cms_'),
+		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
+	));
+
+	$_CLASS['core_template']->display('installer/stage1.html');
+
+	script_close();
+}
+
+if (!$stage)
+{
+	$_CLASS['core_template']->display('installer/agreement.html');
+	script_close();
+}
+
+?>
\ No newline at end of file



From viperal at berlios.de  Tue Sep 13 05:44:37 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 13 Sep 2005 05:44:37 +0200
Subject: [Viperals-svncheckins] r119 - in cms/trunk: . includes/templates/installer
Message-ID: <200509130344.j8D3ibIZ029563@sheep.berlios.de>

Author: viperal
Date: 2005-09-13 05:44:11 +0200 (Tue, 13 Sep 2005)
New Revision: 119

Added:
   cms/trunk/includes/templates/installer/stage3.html
Modified:
   cms/trunk/includes/templates/installer/stage1.html
   cms/trunk/includes/templates/installer/stage2.html
   cms/trunk/installer.php
Log:


Modified: cms/trunk/includes/templates/installer/stage1.html
===================================================================
--- cms/trunk/includes/templates/installer/stage1.html	2005-09-13 03:42:19 UTC (rev 118)
+++ cms/trunk/includes/templates/installer/stage1.html	2005-09-13 03:44:11 UTC (rev 119)
@@ -1,13 +1,13 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<title>Viperal: Agreement</title>
-<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-<meta http-equiv="expires" content="0" />
-
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
 <style type="text/css">
-<!--
-body
+<!--
+body
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
@@ -19,38 +19,38 @@
 
 .error { color: red; }
 
-#container
-{
-	position: absolute;
-	top: 50%;
-	left: 0px;
-	width: 100%;
-	margin-top: -130px;
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -200px;
 }
-
-#wrapper
-{
-	position: relative;
-	text-align: left;
-	width: 500px;
-	margin: 0px auto;
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
 }
 
 .spacer
 {
 	background-color: #ECECEC;
-}
-
+}
+
 .button
 {
 	background-color: #DCE1E5;
 	border: 1px solid #ccc;
 	color: black;
-}
+}
 
 th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
 .tablebg { background-color: #A9B8C2; }
-
+
 .row1 { background-color: #ECECEC; padding: 4px; }
 .row2 { background-color: #DCE1E5; padding: 4px; }
 .row3 { background-color: #C0C8D0; padding: 4px; }
@@ -63,143 +63,85 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
 
--->
-</style>
-<script language="Javascript" type="text/javascript">
-<!--
-var old_value = 'all';
-
-function change_option(name)
-{
-	var area = document.getElementById(name);
-
-	if (!area)
-	{
-		if (old_value == 'all')
-		{
-			return;
-		}
-		else
-		{
-			name = 'all'
-			area = document.getElementById(name);
-		}
-	}
-
-	area.style.display = '';
-
-	var i = 1;
-
-	while (true)
-	{
-		area = document.getElementById(name + '_' + i);
-
-		if (!area)
-		{
-			break;
-		}
-
-		area.style.display = '';
-		i += 1;
-	}
-
-	area = document.getElementById(old_value);
-	area.style.display = 'none';
-	
-	var i = 1;
-
-	while (true)
-	{
-		area = document.getElementById(old_value + '_' + i);
-
-		if (!area)
-		{
-			break;
-		}
-
-		area.style.display = 'none';
-		i += 1;
-	}
-
-	old_value = name;
-}
-
-//-->
-</script>
+-->
+</style>
+
 <body>
-	<div id="container">
-		<div id="wrapper">
+	<div id="container">
+		<div id="wrapper">
 			<form action="" method="post">
-				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
-					<tbody>
-						<tr>
-							<th colspan="2">Database Configuration</th>
-						</tr>
-						<!-- IF { $error } -->
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<td class="row1" width="50%"><b>Database type: </b></td>
-							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
-						</tr>
-						<tr id="sqlite" style="display: none;">
-							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
-						</tr>
-						<tr id="sqlite_pdo" style="display: none;">
-							<td class="row1" width="50%"><b>Database File: </b></td>
-							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
-						</tr>
-						<tr id="all">
-							<td class="row1" width="50%"><b>Database server hostname: </b></td>
-							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
-						</tr>
-						<tr id="all_1">
-							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
-							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
-						</tr>
-						<tr id="all_2">
-							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
-							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
-						</tr>
-						<tr id="all_3">
-							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
-					
-							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
-						</tr>
-						<tr id="all_4">
-							<td class="row1" width="50%"><b>Database password: </b></td>
-							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
-							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
-							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
-						</tr>
-						<tr>
-							<input type="hidden" name="stage" value="2" />
-							<input type="hidden" name="agreement_signed" value="1" />
-							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
-						</tr>
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">PHP Version</th>
+						</tr>
+						<tr>
+							<td class="row2" colspan="2"><b>PHP Version: { $php_version }</b></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Version Supported: </b><br/>Required</td>
+							<td class="row2"><!-- IF { $workable_Version } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_red.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Version higher than recommended: </b></td>
+							<td class="row2"><!-- IF { $recommended_Version } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<th colspan="2">PHP Configuration</th>
+						</tr>
+						<!-- IF { $error } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+							<tr>
+							<td class="row1" width="50%"><b>Safe Mode - OFF: </b></td>
+							<td class="row2"><!-- IF { $safe_mode } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Magic Quotes GPC - OFF: </b></td>
+							<td class="row2"><!-- IF { $magic_quotes_gpc } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Output Buffering - OFF: </b></td>
+							<td class="row2"><!-- IF { $output_buffering } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Register Globals - OFF: </b></td>
+							<td class="row2"><!-- IF { $register_globals } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<th colspan="2">PHP Extensions</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>mbstring: </b></td>
+							<td class="row2"><!-- IF { $mbstring } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>zlib: </b></td>
+							<td class="row2"><!-- IF { $zlib } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>GD:<br />{ $gd_version }</b></td>
+							<td class="row2"><!-- IF { $gd } --><img src="images/led_green.png" /><!-- ELSE --><img src="images/led_yellow.png" /><!-- ENDIF --></td>
+						</tr>
+						<!-- IF !{ $continue } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">You may not continue, please fix all problems listed in RED</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="2" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" <!-- IF !{ $continue } -->disabled="disabled"<!-- ENDIF --> name="continue" value="Continue" type="submit"></th>
+						</tr>
 					</tbody>
-				</table>
+				</table>
 			</form>
-		</div>
-	</div>
-
-<script language="Javascript" type="text/javascript">
-<!--
-	change_option(document.getElementById('layer').value);
-//-->
-</script>
-
-</body>
-
+		</div>
+	</div>
+</body>
+
 </html>
\ No newline at end of file

Modified: cms/trunk/includes/templates/installer/stage2.html
===================================================================
--- cms/trunk/includes/templates/installer/stage2.html	2005-09-13 03:42:19 UTC (rev 118)
+++ cms/trunk/includes/templates/installer/stage2.html	2005-09-13 03:44:11 UTC (rev 119)
@@ -1,13 +1,13 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<title>Viperal: Agreement</title>
-<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-<meta http-equiv="expires" content="0" />
-
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
 <style type="text/css">
-<!--
-body
+<!--
+body
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
@@ -19,38 +19,38 @@
 
 .error { color: red; }
 
-#container
-{
-	position: relative;
-	top: 50%;
-	left: 0px;
-	width: 100%;
-	margin-top: 0px;
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: -130px;
 }
-
-#wrapper
-{
-	position: relative;
-	text-align: left;
-	width: 500px;
-	margin: 0px auto;
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
 }
 
 .spacer
 {
 	background-color: #ECECEC;
-}
-
+}
+
 .button
 {
 	background-color: #DCE1E5;
 	border: 1px solid #ccc;
 	color: black;
-}
+}
 
 th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
 .tablebg { background-color: #A9B8C2; }
-
+
 .row1 { background-color: #ECECEC; padding: 4px; }
 .row2 { background-color: #DCE1E5; padding: 4px; }
 .row3 { background-color: #C0C8D0; padding: 4px; }
@@ -63,107 +63,143 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
 
--->
-</style>
-
+-->
+</style>
+<script language="Javascript" type="text/javascript">
+<!--
+var old_value = 'all';
+
+function change_option(name)
+{
+	var area = document.getElementById(name);
+
+	if (!area)
+	{
+		if (old_value == 'all')
+		{
+			return;
+		}
+		else
+		{
+			name = 'all'
+			area = document.getElementById(name);
+		}
+	}
+
+	area.style.display = '';
+
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(name + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = '';
+		i += 1;
+	}
+
+	area = document.getElementById(old_value);
+	area.style.display = 'none';
+	
+	var i = 1;
+
+	while (true)
+	{
+		area = document.getElementById(old_value + '_' + i);
+
+		if (!area)
+		{
+			break;
+		}
+
+		area.style.display = 'none';
+		i += 1;
+	}
+
+	old_value = name;
+}
+
+//-->
+</script>
 <body>
-	<div id="container">
-		<div id="wrapper">
+	<div id="container">
+		<div id="wrapper">
 			<form action="" method="post">
-				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
-					<tbody>
-						<!-- IF { $error } -->
-						<tr>
-							<th align="center" colspan="2">Error</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<th align="center" colspan="2">Administrator Configuration</th>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Username: </b></td>
-					
-							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Password: </b></td>
-							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
-							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Email address: </b></td>
-							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
-							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
-						</tr>
-						<tr>
-							<th align="center" colspan="2">Site Configuration</th>
-						</tr>
-						<tr>
-							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Name: </b></td>
-							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Domain: </b></td>
-							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site path: </b></td>
-							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
-							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
-							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Path: </b></td>
-					
-							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
-						</tr>
-						<tr>
-							<td class="row1" width="50%"><b>Cookie Name: </b></td>
-							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
-						</tr>
-						<!-- IF { $config_content } -->
-						<tr>
-							<th align="center" colspan="2">Config.php Content</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
-						</tr>
-						<tr>
-							<td colspan="2" class="row2" style="color: red; text-align:center;">
-							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
-							</th>
-						</tr>
-						<!-- ENDIF -->
-						<tr>
-							<input type="hidden" name="stage" value="3" />
-							<input type="hidden" name="agreement_signed" value="1" />
-							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
-						</tr>
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<tr>
+							<th colspan="2">Database Configuration</th>
+						</tr>
+						<!-- IF { $error } -->
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<td class="row1" width="50%"><b>Database type: </b></td>
+							<td class="row2"><select id="layer" name="layer" onchange="change_option(this.value);">{ $database_options }</select></td>
+						</tr>
+						<tr id="sqlite" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="sqlite_pdo" style="display: none;">
+							<td class="row1" width="50%"><b>Database File: </b></td>
+							<td class="row2"><input class="post" name="file_sqlite_pdo" value="{ $file }" type="text"></td>
+						</tr>
+						<tr id="all">
+							<td class="row1" width="50%"><b>Database server hostname: </b></td>
+							<td class="row2"><input class="post" name="server" value="{ $server }" type="text"></td>
+						</tr>
+						<tr id="all_1">
+							<td class="row1" width="50%"><b>Database server port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="port" value="{ $port }" type="text"></td>
+						</tr>
+						<tr id="all_2">
+							<td class="row1" width="50%"><b>Database name: </b><br/>Required</td>
+							<td class="row2"><input class="post" name="database" value="{ $database }" type="text"></td>
+						</tr>
+						<tr id="all_3">
+							<td class="row1" width="50%"><b>Database username: </b><br/>Required</td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr id="all_4">
+							<td class="row1" width="50%"><b>Database password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for tables: </b></td>
+							<td class="row2"><input class="post" name="table_prefix" value="{ $table_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Prefix for user table: </b></td>
+							<td class="row2"><input class="post" name="user_prefix" value="{ $user_prefix }" type="text"></td>
+						</tr>
+						<tr>
+							<input type="hidden" name="stage" value="3" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="test" value="Test Connection" type="submit"> <input class="button" name="submit" value="Start Installation" type="submit"></th>
+						</tr>
 					</tbody>
-				</table>
+				</table>
 			</form>
-		</div>
-	</div>
-</body>
-
+		</div>
+	</div>
+
+<script language="Javascript" type="text/javascript">
+<!--
+	change_option(document.getElementById('layer').value);
+//-->
+</script>
+
+</body>
+
 </html>
\ No newline at end of file

Added: cms/trunk/includes/templates/installer/stage3.html
===================================================================
--- cms/trunk/includes/templates/installer/stage3.html	2005-09-13 03:42:19 UTC (rev 118)
+++ cms/trunk/includes/templates/installer/stage3.html	2005-09-13 03:44:11 UTC (rev 119)
@@ -0,0 +1,169 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Agreement</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
+{
+    font-family: Verdana, Helvetica, sans-serif;
+    font-size: 10px;
+    margin: 0%;
+    padding: 0px;
+    background-color: white;
+    background: url(../images/bg.gif);
+}
+
+.error { color: red; }
+
+#container
+{
+	position: relative;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: 0px;
+}
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 500px;
+	margin: 0px auto;
+}
+
+.spacer
+{
+	background-color: #ECECEC;
+}
+
+.button
+{
+	background-color: #DCE1E5;
+	border: 1px solid #ccc;
+	color: black;
+}
+
+th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
+.tablebg { background-color: #A9B8C2; }
+
+.row1 { background-color: #ECECEC; padding: 4px; }
+.row2 { background-color: #DCE1E5; padding: 4px; }
+.row3 { background-color: #C0C8D0; padding: 4px; }
+
+a:link { color: #005784; text-decoration: none; }
+a:active { color: #005784; text-decoration: none; }
+a:visited { color: #005784; text-decoration: none; }
+a:hover { color: #000000; text-decoration: none; }
+
+form { margin: 0px; padding: 0px; border: 0px; }
+input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
+select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+
+-->
+</style>
+
+<body>
+	<div id="container">
+		<div id="wrapper">
+			<form action="" method="post">
+				<table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
+					<tbody>
+						<!-- IF { $error } -->
+						<tr>
+							<th align="center" colspan="2">Error</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">{ $error }</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<th align="center" colspan="2">Administrator Configuration</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Username: </b></td>
+					
+							<td class="row2"><input class="post" name="username" value="{ $username }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password: </b></td>
+							<td class="row2"><input class="post" name="password" value="{ $password }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Password ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="password_confirm" value="{ $password_confirm }" type="password"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address: </b></td>
+							<td class="row2"><input class="post" name="email" value="{ $email }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Email address  ( Confirm ): </b></td>
+							<td class="row2"><input class="post" name="email_confirm" value="{ $email_confirm }" type="text"></td>
+						</tr>
+						<tr>
+							<th align="center" colspan="2">Site Configuration</th>
+						</tr>
+						<tr>
+							<td align="center" colspan="2" class="row2">Default Value are usually correct, please review</th>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Name: </b></td>
+							<td class="row2"><input class="post" name="site_name" value="{ $site_name }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Domain: </b></td>
+							<td class="row2"><input class="post" name="site_domain" value="{ $site_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site path: </b></td>
+							<td class="row2"><input class="post" name="site_path" value="{ $site_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Site Port: </b><br><span class="gensmall">Leave this blank unless you know the server operates on a non-standard port.</span></td>
+							<td class="row2"><input class="post" name="site_port" value="{ $site_port }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Domain: </b></td>
+							<td class="row2"><input class="post" name="cookie_domain" value="{ $cookie_domain }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Path: </b></td>
+					
+							<td class="row2"><input class="post" name="cookie_path" value="{ $cookie_path }" type="text"></td>
+						</tr>
+						<tr>
+							<td class="row1" width="50%"><b>Cookie Name: </b></td>
+							<td class="row2"><input class="post" name="cookie_name" value="{ $cookie_name }" type="text"></td>
+						</tr>
+						<!-- IF { $config_content } -->
+						<tr>
+							<th align="center" colspan="2">Config.php Content</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">Copy the content below to your config.php file and upload to you site root</th>
+						</tr>
+						<tr>
+							<td colspan="2" class="row2" style="color: red; text-align:center;">
+							<textarea name="config_content" style="width: 100%" rows="15">{ $config_content }</textarea>
+							</th>
+						</tr>
+						<!-- ENDIF -->
+						<tr>
+							<input type="hidden" name="stage" value="4" />
+							<input type="hidden" name="agreement_signed" value="1" />
+							<th colspan="2" align="center"><input class="button" name="submit" value="Finalize Installation" type="submit"></th>
+						</tr>
+					</tbody>
+				</table>
+			</form>
+		</div>
+	</div>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-13 03:42:19 UTC (rev 118)
+++ cms/trunk/installer.php	2005-09-13 03:44:11 UTC (rev 119)
@@ -25,7 +25,7 @@
 error_reporting(E_ALL);
 
 //echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '../';
+$site_file_root = '';
 
 if (!extension_loaded('mbstring'))
 {
@@ -103,7 +103,7 @@
 	$stage = 0;
 }
 
-if ($stage === 3)
+if ($stage === 4)
 {
 	if (file_exists($site_file_root.'config.php'))
 	{
@@ -218,12 +218,12 @@
 		'config_content'	=> $config_content
 	));
 
-	$_CLASS['core_template']->display('installer/stage2.html');
+	$_CLASS['core_template']->display('installer/stage3.html');
 
 	script_close();
 }
 
-if ($stage === 2)
+if ($stage === 3)
 {
 	if ($db_layer && in_array($db_layer, array_keys($database_array)))
 	{
@@ -331,7 +331,7 @@
 
 	if (isset($_POST['test']) || !empty($error))
 	{
-		$stage = 1;
+		$stage = 2;
 	}
 	else
 	{
@@ -407,46 +407,14 @@
 			'config_content'	=> $config_data
 		));
 
-		$_CLASS['core_template']->display('installer/stage2.html');
+		$_CLASS['core_template']->display('installer/stage3.html');
 
 		script_close();
 	}
 }
 
-if ($stage === 1)
+if ($stage === 2)
 {
-	$php_config = array(
-		/*array(
-			'lang'	=> 'PHP version',
-			'recommended'	=> '4.2.3 +',
-			'current'		=> PHP_VERSION
-		),*/
-		array(
-			'lang'	=> 'Safe Mode',
-			'ini'	=> 'safe_mode',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('safe_mode')
-		),
-		array(
-			'lang'	=> 'Magic Quotes GPC',
-			'ini'	=> 'magic_quotes_gpc',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('magic_quotes_gpc')
-		),
-		array(
-			'lang'	=> 'Register Globals',
-			'ini'	=> 'register_globals',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('register_globals')
-		),
-		array(
-			'lang'	=> 'Output Buffering',
-			'ini'	=> 'output_buffering',
-			'recommended'	=> false,
-			'current'		=> (bool) ini_get('output_buffering')
-		),
-	);
-
 	if (isset($_POST['test']) && empty($error))
 	{
 		$error[] = 'Database Setting Perfect :-)';
@@ -454,7 +422,6 @@
 
 	$_CLASS['core_template']->assign_array(array(
 		'database_options'	=> $database_options,
-		'php_config'		=> $php_config,
 		'error'				=> empty($error) ? false : implode('<br/>', $error),
 
 		'server'		=> isset($site_db['server']) ? $site_db['server'] : 'localhost',
@@ -467,11 +434,44 @@
 		'user_prefix'	=> get_variable('user_prefix', 'POST', 'cms_'),
 	));
 
-	$_CLASS['core_template']->display('installer/stage1.html');
+	$_CLASS['core_template']->display('installer/stage2.html');
 
 	script_close();
 }
 
+if ($stage === 1)
+{
+	$gd_info = gd_info();
+	$continue = true;
+
+	if (!$compatible = version_compare(PHP_VERSION, '4.2.0', '>='))
+	{
+		$continue = false;
+	}
+	
+	$_CLASS['core_template']->assign_array(array(
+		'error'				=> false,
+		'magic_quotes_gpc'	=> ((bool) ini_get('magic_quotes_gpc') === false),
+		'output_buffering'	=> ((bool) ini_get('output_buffering') === false),
+		'register_globals'	=> ((bool) ini_get('register_globals') === false),
+		'safe_mode'			=> ((bool) ini_get('safe_mode') === false),
+
+		'php_version'			=> PHP_VERSION,
+		'workable_Version'		=> $compatible,
+		'recommended_Version'	=> version_compare(PHP_VERSION, '4.3.0', '>='),
+		
+		'mbstring'	=> extension_loaded('mbstring'),
+		'zlib'		=> extension_loaded('zlib'),
+		'gd'		=> extension_loaded('gd'),
+		'gd_version'=> $gd_info['GD Version'],
+
+		'continue'	=> $continue,
+	));
+	
+	$_CLASS['core_template']->display('installer/stage1.html');
+	script_close();
+}
+
 if (!$stage)
 {
 	$_CLASS['core_template']->display('installer/agreement.html');



From viperal at berlios.de  Wed Sep 14 00:02:39 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 14 Sep 2005 00:02:39 +0200
Subject: [Viperals-svncheckins] r120 - in cms/trunk: includes/display includes/forums includes/templates/modules/Forums javascript javascript/forums modules/Forums
Message-ID: <200509132202.j8DM2dU6008870@sheep.berlios.de>

Author: viperal
Date: 2005-09-14 00:02:35 +0200 (Wed, 14 Sep 2005)
New Revision: 120

Added:
   cms/trunk/javascript/common.js
   cms/trunk/javascript/forums/
   cms/trunk/javascript/forums/forum_view.js
   cms/trunk/modules/Forums/ajax.php
Removed:
   cms/trunk/includes/forums/functions_profile_fields.php
   cms/trunk/javascript/ajax.js
   cms/trunk/javascript/tiny_mce/
Modified:
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/templates/modules/Forums/index_body.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
   cms/trunk/modules/Forums/posting.php
Log:
Added some ajax to forum, just topic title editing for now
Move ajax.js to common.js
Removed tiny_mce, will be added back soon

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/display/display.php	2005-09-13 22:02:35 UTC (rev 120)
@@ -174,6 +174,7 @@
 			$this->message = '<b>System is in maintenance mode</b><br />';
 		}
 
+		$this->header['js'] = '<script type="text/javascript" src="javascript/common.js"></script>';
 
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-13 22:02:35 UTC (rev 120)
@@ -327,6 +327,7 @@
 	}
 
 	$_CLASS['core_template']->assign_array(array(
+		'MODIFY_FORUM'		=> $_CLASS['auth']->acl_get('a_forum'),
 		'U_MARK_FORUMS'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
 		'S_HAS_SUBFORUM'	=>	($visible_forums) ? true : false,
 		'L_SUBFORUM'		=>	($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']

Deleted: cms/trunk/includes/forums/functions_profile_fields.php
===================================================================
--- cms/trunk/includes/forums/functions_profile_fields.php	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/forums/functions_profile_fields.php	2005-09-13 22:02:35 UTC (rev 120)
@@ -1,894 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_profile_fields.php,v 1.10 2004/09/19 20:40:20 acydburn Exp $
-//
-// FILENAME  : functions_profile_fields.php
-// STARTED   : Tue Oct 21, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-class custom_profile
-{
-	var $profile_types = array(1 => 'int', 2 => 'string', 3 => 'text', 4 => 'bool', 5 => 'dropdown', 6 => 'date');
-	var $profile_cache = array();
-	var $options_lang = array();
-
-	// Build language options cache, useful for viewtopic display
-	function build_cache()
-	{
-		global $_CLASS;
-
-		$this->profile_cache = array();
-
-		// Display hidden/no_view fields for admin/moderator
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
-			WHERE l.lang_id = ' . $_CLASS['core_user']->get_iso_lang_id() . '
-				AND f.field_active = 1 ' .
-				((!$_CLASS['auth']->acl_gets('a_', 'm_')) ? '     AND f.field_hide = 0 AND f.field_no_view = 0 ' : '') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$this->profile_cache[$row['field_ident']] = $row;
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-	}
-
-	// Get language entries for options and store them here for later use
-	function get_option_lang($field_id, $lang_id, $field_type, $preview)
-	{
-		global $_CLASS;
-
-		if ($preview)
-		{
-			$lang_options = (!is_array($this->vars['lang_options'])) ? explode("\n", $this->vars['lang_options']) : $this->vars['lang_options'];
-			
-			foreach ($lang_options as $num => $var)
-			{
-				$this->options_lang[$field_id][$lang_id][($num+1)] = $var;
-			}
-		}
-		else
-		{
-			$sql = 'SELECT option_id, value
-				FROM ' . PROFILE_FIELDS_LANG_TABLE . "
-					WHERE field_id = $field_id
-					AND lang_id = $lang_id
-					AND field_type = $field_type
-				ORDER BY option_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
-
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-			{
-				$this->options_lang[$field_id][$lang_id][$row['option_id']] = $row['value'];
-			}
-			$_CLASS['core_db']->sql_freeresult($result);
-		}
-	}
-
-	// Functions performing operations on register/profile/profile admin
-	function submit_cp_field($mode, $lang_id, &$cp_data, &$cp_error)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . " f 
-			WHERE l.lang_id = $lang_id
-				AND f.field_active = 1
-				" . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
-				(($_CLASS['auth']->acl_gets('a_', 'm_') && $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']->sql_query($sql);
-					
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$cp_data[$row['field_ident']] = $this->get_profile_field($row);
-
-			// get_profile_field returns an array with values for TEXT fields.
-			if(is_array($cp_data[$row['field_ident']]))
-			{
-				// Contains the original text without bbcode processing etc
-				$check_value = $cp_data[$row['field_ident']]['submitted'];
-				
-				foreach($cp_data[$row['field_ident']] as $key => $value)
-				{
-					if($key != 'submitted')
-					{
-						$cp_data[$key] = $value;
-					}
-				}
-			}
-			else
-			{
-				$check_value = $cp_data[$row['field_ident']];
-			}
-			
-			if (($cp_result = $this->validate_profile_field($row['field_type'], $check_value, $row)) !== false)
-			{
-				// If not and only showing common error messages, use this one
-				$error = false;
-
-				switch ($cp_result)
-				{
-					case 'FIELD_INVALID_DATE':
-					case 'FIELD_REQUIRED':
-						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name']);
-						break;
-					case 'FIELD_TOO_SHORT':
-					case 'FIELD_TOO_SMALL':
-						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name'], $row['field_minlen']);
-						break;
-					case 'FIELD_TOO_LONG':
-					case 'FIELD_TOO_LARGE':
-						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name'], $row['field_maxlen']);
-						break;
-					case 'FIELD_INVALID_CHARS':
-						switch ($row['field_validation'])
-						{
-							case '[0-9]+':
-								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_NUMBERS_ONLY'], $row['lang_name']);
-								break;
-							case '[\w]+':
-								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_ALPHA_ONLY'], $row['lang_name']);
-								break;
-							case '[\w_\+\. \-\[\]]+':
-								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_SPACERS_ONLY'], $row['lang_name']);
-								break;
-						}
-						break;
-				}
-
-				if ($error)
-				{
-					$cp_error[] = $error;
-				}
-			}
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-	}
-	
-	// Assign fields to template, mode can be profile (for profile change) or register (for registration)
-//	function generate_profile_fields($mode, $lang_id, $cp_error)
-	function generate_profile_fields($mode, $lang_id)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT l.*, f.*
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . " f 
-			WHERE l.lang_id = $lang_id
-				AND f.field_active = 1
-				" . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
-				(($_CLASS['auth']->acl_gets('a_', 'm_') && $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id
-			ORDER BY f.field_order';
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$_CLASS['core_template']->assign_vars_array('profile_fields', array(
-				'LANG_NAME' => $row['lang_name'],
-				'LANG_EXPLAIN' => $row['lang_explain'],
-				'FIELD' => $this->process_field_row('change', $row))
-//				'ERROR' => $error)
-			);
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-	}
-
-	// Assign fields to template, used for viewprofile, viewtopic and memberlist (if load setting is enabled)
-	// This is directly connected to the user -> mode == grab is to grab the user specific fields, mode == show is for assigning the row to the template
-	function generate_profile_fields_template($mode, $user_id = 0, $profile_row = false)
-	{
-		global $_CLASS;
-
-		if ($mode == 'grab')
-		{
-			if (!is_array($user_id))
-			{
-				$user_id = array($user_id);
-			}
-			
-			if (!sizeof($this->profile_cache))
-			{
-				$this->build_cache();
-			}
-
-			if (!implode(', ', $user_id))
-			{
-				return array();
-			}
-
-			$sql = 'SELECT *
-				FROM ' . PROFILE_DATA_TABLE . '
-				WHERE user_id IN (' . implode(', ', array_map('intval', $user_id)) . ')';
-			$result = $_CLASS['core_db']->sql_query($sql);
-
-			if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
-			{
-				return array();
-			}
-			
-			$user_fields = array();
-			do
-			{
-				foreach ($row as $ident => $value)
-				{
-					if (isset($this->profile_cache[$ident]))
-					{
-						$user_fields[$row['user_id']][$ident]['value'] = $value;
-						$user_fields[$row['user_id']][$ident]['data'] = $this->profile_cache[$ident];
-					}
-					else if($i = strpos($ident, '_bbcode'))
-					{
-						// Add extra data (bbcode_uid and bbcode_bitfield) to the data for this profile field.
-						// TODO: Maybe we should try to make this a bit more generic (not limited to bbcode)?
-						$field = substr($ident, 0, $i);
-						$subfield = substr($ident, $i+1);
-						$user_fields[$row['user_id']][$field]['data'][$subfield] = $value;
-					}
-				}
-			} 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
-			
-			$_CLASS['core_db']->sql_freeresult($result);
-
-			return $user_fields;
-
-		}
-		elseif ($mode == 'show')
-		{
-			// $profile_row == $user_fields[$row['user_id']];
-			$tpl_fields = array();
-			$tpl_fields['row'] = $tpl_fields['blockrow'] = array();
-
-			foreach ($profile_row as $ident => $ident_ary)
-			{
-				$tpl_fields['row'] += array(
-					'PROFILE_' . strtoupper($ident) . '_VALUE'	=> $this->get_profile_value($ident_ary),
-					'PROFILE_' . strtoupper($ident) . '_TYPE'	=> $ident_ary['data']['field_type'],
-					'PROFILE_' . strtoupper($ident) . '_NAME'	=> $ident_ary['data']['lang_name'],
-					'PROFILE_' . strtoupper($ident) . '_EXPLAIN'=> $ident_ary['data']['lang_explain'],
-
-					'S_PROFILE_' . strtoupper($ident)			=> true
-				);
-				
-				$tpl_fields['blockrow'][] = array(
-					'PROFILE_FIELD_VALUE'   => $this->get_profile_value($ident_ary),
-					'PROFILE_FIELD_TYPE'    => $ident_ary['data']['field_type'],
-					'PROFILE_FIELD_NAME'    => $ident_ary['data']['lang_name'],
-					'PROFILE_FIELD_EXPLAIN' => $ident_ary['data']['lang_explain'],
-					'S_PROFILE_' . strtoupper($ident)               => true
-				);
-			}
-		
-			return $tpl_fields;
-		}
-	}
-	
-	// VALIDATE Function - validate entered data
-	function validate_profile_field($field_type, &$field_value, $field_data)
-	{
-		switch ($field_type)
-		{
-			case FIELD_INT:
-			case FIELD_DROPDOWN:
-				$field_value = (int) $field_value;
-				break;
-
-			case FIELD_BOOL:
-				$field_value = (bool) $field_value;
-				break;
-		}
-
-		switch ($field_type)
-		{
-			case FIELD_DATE:
-				$field_validate = explode('-', $field_value);
-				
-				$day = (int) $field_validate[0];
-				$month = (int) $field_validate[1];
-				$year = (int) $field_validate[2];
-
-				if ((!$day || !$month || !$year) && !$field_data['field_required'])
-				{
-					return false;
-				}
-
-				if ((!$day || !$month || !$year) && $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-
-				if ($day < 0 || $day > 31 || $month < 0 || $month > 12 || ($year < 1901 && $year > 0) || $year > gmdate('Y', time()))
-				{
-					return 'FIELD_INVALID_DATE';
-				}
-				break;
-
-			case FIELD_INT:
-				if (empty($field_value) && !$field_data['field_required'])
-				{
-					return false;
-				}
-
-				if ($field_value < $field_data['field_minlen'])
-				{
-					return 'FIELD_TOO_SMALL';
-				}
-				else if ($field_value > $field_data['field_maxlen']) 
-				{
-					return 'FIELD_TOO_LARGE';
-				}
-				break;
-		
-			case FIELD_DROPDOWN:
-				if ($field_value == $field_data['field_novalue'] && $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-				break;
-			
-			case FIELD_STRING:
-			case FIELD_TEXT:
-				if (empty($field_value) && !$field_data['field_required'])
-				{
-					return false;
-				}
-				else if (empty($field_value) && $field_data['field_required'])
-				{
-					return 'FIELD_REQUIRED';
-				}
-
-				if ($field_data['field_minlen'] && strlen($field_value) < $field_data['field_minlen'])
-				{
-					return 'FIELD_TOO_SHORT';
-				}
-				else if ($field_data['field_maxlen'] && strlen($field_value) > $field_data['field_maxlen'])
-				{
-					return 'FIELD_TOO_LONG';
-				}
-
-				if (!empty($field_data['field_validation']) && $field_data['field_validation'] != '.*')
-				{
-					$field_validate = ($field_type == FIELD_STRING) ? $field_value : str_replace("\n", ' ', $field_value);
-					if (!preg_match('#^' . str_replace('\\\\', '\\', $field_data['field_validation']) . '$#i', $field_validate))
-					{
-						return 'FIELD_INVALID_CHARS';
-					}
-				}
-				break;
-		}
-
-		return false;
-	}
-
-	// Get Profile Value for display
-	function get_profile_value($ident_ary)
-	{
-		$value = $ident_ary['value'];
-		$field_type = $ident_ary['data']['field_type'];
-		
-		switch ($this->profile_types[$field_type])
-		{
-			case 'int':
-				return (int) $value;
-				break;
-			case 'string':
-				return str_replace("\n", '<br />', $value);
-				break;
-			case 'text':
-				// Prepare further, censor_text, smilies, bbcode, html, whatever
-				if ($ident_ary['data']['bbcode_bitfield'])
-				{
-					$bbcode = new bbcode($ident_ary['data']['bbcode_bitfield']);
-					$bbcode->bbcode_second_pass($value, $ident_ary['data']['bbcode_uid'], $ident_ary['data']['bbcode_bitfield']);
-					$value = smiley_text($value);
-					$value = censor_text($value);
-				}
-				
-				return str_replace("\n", '<br />', $value);
-				break;
-			case 'date':
-				break;
-			case 'dropdown':
-				$field_id = $ident_ary['data']['field_id'];
-				$lang_id = $ident_ary['data']['lang_id'];
-				if (!isset($this->options_lang[$field_id][$lang_id]))
-				{
-					$this->get_option_lang($field_id, $lang_id, FIELD_DROPDOWN, false);
-				}
-
-				return $this->options_lang[$field_id][$lang_id][(int) $value];
-				break;
-			case 'bool':
-				break;
-			default:
-				trigger_error('Unknown profile type');
-				break;
-		}
-	}
-
-	// Get field value for registration/profile
-	function get_var($field_validation, &$profile_row, $default_value, $preview)
-	{
-		global $_CLASS;
-
-		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
-		
-		// checkbox - only testing for isset
-		if ($profile_row['field_type'] == FIELD_BOOL && $profile_row['field_length'] == 2)
-		{
-			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? true : ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $default_value : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]);
-		}
-		else
-		{
-			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? request_var($profile_row['field_ident'], $default_value) : ((!isset($_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]) || $preview) ? $default_value : $_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]);
-		}
-
-		switch ($field_validation)
-		{
-			case 'int':
-				return (int) $value;
-				break;
-		}
-
-		return $value;
-	}
-	
-	// GENERATE_* Functions - return templated, storable profile fields
-	function generate_int($profile_row, $preview = false)
-	{
-		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-		$this->set_tpl_vars($profile_row, $value);
-
-		return $this->get_cp_html();
-	}
-
-	function generate_date($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
-		$now = getdate();
-
-		if (!isset($_REQUEST[$profile_row['field_ident'] . '_day']))
-		{
-			if ($profile_row['field_default_value'] == 'now')
-			{
-				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-			}
-			list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]));
-		}
-		else
-		{
-			if ($preview && $profile_row['field_default_value'] == 'now')
-			{
-				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-				list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]));
-			}
-			else
-			{
-				$day = request_var($profile_row['field_ident'] . '_day', 0);
-				$month = request_var($profile_row['field_ident'] . '_month', 0);
-				$year = request_var($profile_row['field_ident'] . '_year', 0);
-			}
-		}
-
-		$profile_row['s_day_options'] = '<option value="0"' . ((!$day) ? ' selected="selected"' : '') . '>--</option>';
-		for ($i = 1; $i < 32; $i++)
-		{
-			$profile_row['s_day_options'] .= '<option value="' . $i . '"' . (($i == $day) ? ' selected="selected"' : '') . ">$i</option>";
-		}
-
-		$profile_row['s_month_options'] = '<option value="0"' . ((!$month) ? ' selected="selected"' : '') . '>--</option>';
-		for ($i = 1; $i < 13; $i++)
-		{
-			$profile_row['s_month_options'] .= '<option value="' . $i . '"' . (($i == $month) ? ' selected="selected"' : '') . ">$i</option>";
-		}
-
-		$profile_row['s_year_options'] = '<option value="0"' . ((!$year) ? ' selected="selected"' : '') . '>--</option>';
-		for ($i = $now['year'] - 100; $i <= $now['year']; $i++)
-		{
-			$profile_row['s_year_options'] .= '<option value="' . $i . '"' . (($i == $year) ? ' selected="selected"' : '') . ">$i</option>";
-		}
-		unset($now);
-		
-		$this->set_tpl_vars($profile_row, 0);
-		return $this->get_cp_html();
-	}
-
-	function generate_bool($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-
-		$this->set_tpl_vars($profile_row, $value);
-
-		if ($profile_row['field_length'] == 1)
-		{
-			if (!isset($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]) || !sizeof($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
-			{
-				$this->get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_BOOL, $preview);
-			}
-
-			foreach ($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id => $option_value)
-			{
-				$_CLASS['core_template']->assign_vars_array('bool.options', array(
-					'OPTION_ID' => $option_id,
-					'CHECKED' => ($value == $option_id) ? ' checked="checked"' : '',
-					'VALUE' => $option_value)
-				);
-			}
-		}
-
-		return $this->get_cp_html();
-	}
-
-	// Get the data associated with this field for this user
-	function generate_string($profile_row, $preview = false)
-	{
-		$value = $this->get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
-		$this->set_tpl_vars($profile_row, $value);
-
-		return $this->get_cp_html();
-	}
-
-	function generate_text($profile_row, $preview = false)
-	{
-		global $_CLASS, $site_file_root;
-		
-		$value = $this->get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
-		
-		if($preview == false)
-		{
-			include_once($site_file_root.'includes/forums/message_parser.php');
-			include_once($site_file_root.'includes/forums/functions_posting.php');
-			
-			$message_parser = new parse_message();
-			$message_parser->message = $value;
-			$message_parser->decode_message($_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident']) . '_bbcode_uid']);
-			$value = $message_parser->message;
-		}
-		
-		$field_length = explode('|', $profile_row['field_length']);
-		$profile_row['field_rows'] = $field_length[0];
-		$profile_row['field_cols'] = $field_length[1];
-
-		$this->set_tpl_vars($profile_row, $value);
-
-		return $this->get_cp_html();
-	}
-
-	function generate_dropdown($profile_row, $preview = false)
-	{
-		global $_CLASS;
-
-		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
-
-		if (!isset($this->options_lang[$profile_row['field_id']]) || !sizeof($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
-		{
-			$this->get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_DROPDOWN, $preview);
-		}
-
-		$this->set_tpl_vars($profile_row, $value);
-
-		foreach ($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id => $option_value)
-		{
-			$_CLASS['core_template']->assign_vars_array('dropdown.options', array(
-				'OPTION_ID' => $option_id,
-				'SELECTED' => ($value == $option_id) ? ' selected="selected"' : '',
-				'VALUE' => $option_value)
-			);
-		}
-
-		return $this->get_cp_html();
-	}
-
-
-	// Return Templated value (change == user is able to set/enter profile values; show == just show the value)
-	function process_field_row($mode, $profile_row)
-	{
-		$preview = false;
-
-		switch ($mode)
-		{
-			case 'preview':
-				$preview = true;
-			case 'change':
-				$type_func = 'generate_' . $this->profile_types[$profile_row['field_type']];
-				break;
-			default:
-				return;
-		}
-
-		return $this->$type_func($profile_row, $preview);
-	}
-
-	// Build Array for user insertion into custom profile fields table
-	function build_insert_sql_array($cp_data)
-	{
-		global $_CLASS;
-
-		$sql = 'SELECT f.field_type, f.field_ident, f.field_default_value, l.lang_default_value
-			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
-			WHERE l.lang_id = ' . $_CLASS['core_user']->get_iso_lang_id() . ' 
-				AND f.field_active = 1
-				AND f.field_show_on_reg = 0
-				' . (($_CLASS['auth']->acl_gets('a_', 'm_')) ? '' : ' AND f.field_hide = 0') . '
-				AND l.field_id = f.field_id 
-			GROUP BY f.field_id';
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			if ($row['field_default_value'] == 'now' && $row['field_type'] == FIELD_DATE)
-			{
-				$now = getdate();
-				$row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-			}
-			$cp_data[$row['field_ident']] = (in_array($row['field_type'], array(FIELD_TEXT, FIELD_STRING))) ? $row['lang_default_value'] : $row['field_default_value'];
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-		
-		return $cp_data;
-	}
-
-	function get_profile_field($profile_row)
-	{
-		global $site_file_root;
-		
-		switch ($profile_row['field_type'])
-		{
-			case FIELD_DATE:
-
-				if (!isset($_REQUEST[$var_name . '_day']))
-				{
-					if ($profile_row['field_default_value'] == 'now')
-					{
-						$now = getdate();
-						$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
-					}
-					list($day, $month, $year) = explode('-', $profile_row['field_default_value']);
-				}
-				else
-				{
-					$day = request_var($var_name . '_day', 0);
-					$month = request_var($var_name . '_month', 0);
-					$year = request_var($var_name . '_year', 0);
-				}
-				
-				$var = sprintf('%2d-%2d-%4d', $day, $month, $year);
-				break;
-
-			case FIELD_TEXT:
-				include_once($site_file_root.'includes/forums/message_parser.php');
-				$message_parser = new parse_message(request_var($var_name, ''));
-				
-				// Get the allowed settings from the global settings. Magic URLs are always set to true.
-				// TODO: It might be nice to make this a per field setting.
-				$message_parser->parse($config['allow_html'], $config['allow_bbcode'], true, $config['allow_smilies']);
-				
-				$var = array(
-					$profile_row['field_ident'] => $message_parser->message,
-					$profile_row['field_ident'] . '_bbcode_uid' => $message_parser->bbcode_uid,
-					$profile_row['field_ident'] . '_bbcode_bitfield' => $message_parser->bbcode_bitfield,
-					 'submitted' => request_var($var_name, '')
-				);
-				break;
-
-			default:
-				$var = request_var($var_name, $profile_row['field_default_value']);
-				break;
-		}
-
-		return $var;
-	}
-
-	function set_tpl_vars($profile_row, $field_value)
-	{
-		global $_CLASS;
-		
-		foreach ($this->profile_types as $field_case => $field_type)
-		{
-			unset($_CLASS['core_template']->_tpl_vars[$field_type]);
-		}
-
-		foreach ($profile_row as $key => $value)
-		{
-			unset($profile_row[$key]);
-			$profile_row[strtoupper($key)] = $value;
-		}
-
-		$profile_row['FIELD_VALUE'] = $field_value;
-
-		$_CLASS['core_template']->assign_vars_array($this->profile_types[$profile_row['FIELD_TYPE']], $profile_row);
-	}
-
-	function get_cp_html()
-	{
-		global $_CLASS;
-
-		ob_start();
-
-		$_CLASS['core_template']->display('forums/custom_profile_fields.html');
-
-		$data = ob_get_contents();
-		ob_end_clean();
-
-		return $data;
-	}
-}
-
-class custom_profile_admin extends custom_profile
-{
-	var $vars = array();
-	
-
-	function validate_options()
-	{
-		global $_CLASS;
-
-		$validate_ary = array('CHARS_ANY' => '.*', 'NUMBERS_ONLY' => '[0-9]+', 'ALPHA_ONLY' => '[\w]+', 'ALPHA_SPACERS' => '[\w_\+\. \-\[\]]+');
-
-		$validate_options = '';
-		foreach ($validate_ary as $lang => $value)
-		{
-			$selected = ($this->vars['field_validation'] == $value) ? ' selected="selected"' : '';
-			$validate_options .= '<option value="' . $value . '"' . $selected . '>' . $_CLASS['core_user']->lang[$lang] . '</option>';
-		}
-
-		return $validate_options;
-	}
-	
-	// GET_* get admin options for second step
-	function get_string_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<input class="post" type="text" name="field_length" size="5" value="' . $this->vars['field_length'] . '" />'),
-			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="5" value="' . $this->vars['field_minlen'] . '" />'),
-			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="5" value="' . $this->vars['field_maxlen'] . '" />'),
-			3 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_VALIDATION'], 'FIELD' => '<select name="field_validation">' . $this->validate_options() . '</select>')
-		);
-
-		return $options;
-	}
-
-	function get_text_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<table border=0><tr><td><input name="rows" size="5" value="' . $this->vars['rows'] . '" class="post" /></td><td>[ ' . $_CLASS['core_user']->lang['ROWS'] . ' ]</td></tr><tr><td><input name="columns" size="5" value="' . $this->vars['columns'] . '" class="post" /></td><td>[ ' . $_CLASS['core_user']->lang['COLUMNS'] . ' ] <input type="hidden" name="field_length" value="' . $this->vars['field_length'] . '" /></td></tr></table>'),
-			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="10" value="' . $this->vars['field_minlen'] . '" />'),
-			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="10" value="' . $this->vars['field_maxlen'] . '" />'),
-			3 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_VALIDATION'], 'FIELD' => '<select name="field_validation">' . $this->validate_options() . '</select>')
-		);
-
-		return $options;
-	}
-
-	function get_int_options()
-	{
-		global $_CLASS;
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<input class="post" type="text" name="field_length" size="5" value="' . $this->vars['field_length'] . '" />'),
-			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_NUMBER'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="5" value="' . $this->vars['field_minlen'] . '" />'),
-			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_NUMBER'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="5" value="' . $this->vars['field_maxlen'] . '" />'),
-			3 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => '<input class="post" type="post" name="field_default_value" value="' . $this->vars['field_default_value'] . '" />')
-		);
-
-		return $options;
-	}
-
-	function get_bool_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row = array(
-			'var_name'				=> 'field_default_value',
-			'field_id'				=> 1,
-			'lang_name'				=> $this->vars['lang_name'],
-			'lang_explain'			=> $this->vars['lang_explain'],
-			'lang_id'				=> $default_lang_id,
-			'field_default_value'	=> $this->vars['field_default_value'],
-			'field_ident'			=> 'field_default_value',
-			'field_type'			=> FIELD_BOOL,
-			'field_length'			=> $this->vars['field_length'],
-			'lang_options'			=> $this->vars['lang_options']
-		);
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_TYPE'], 'EXPLAIN' => $_CLASS['core_user']->lang['BOOL_TYPE_EXPLAIN'], 'FIELD' => '<input type="radio" name="field_length" value="1"' . (($this->vars['field_length'] == 1) ? ' checked="checked"' : '') . ' />' . $_CLASS['core_user']->lang['RADIO_BUTTONS'] . '&nbsp; &nbsp;<input type="radio" name="field_length" value="2"' . (($this->vars['field_length'] == 2) ? ' checked="checked"' : '') . ' />' . $_CLASS['core_user']->lang['CHECKBOX'] . '&nbsp; &nbsp;'),
-			1 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_bool($profile_row, true))
-		);
-
-		return $options;
-	}
-
-	function get_dropdown_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row[0] = array(
-			'var_name'				=> 'field_default_value',
-			'field_id'				=> 1,
-			'lang_name'				=> $this->vars['lang_name'],
-			'lang_explain'			=> $this->vars['lang_explain'],
-			'lang_id'				=> $default_lang_id,
-			'field_default_value'	=> $this->vars['field_default_value'],
-			'field_ident'			=> 'field_default_value',
-			'field_type'			=> FIELD_DROPDOWN,
-			'lang_options'			=> $this->vars['lang_options']
-		);
-
-		$profile_row[1] = $profile_row[0];
-		$profile_row[1]['var_name'] = 'field_novalue';
-		$profile_row[1]['field_ident'] = 'field_novalue';
-		$profile_row[1]['field_default_value']	= $this->vars['field_novalue'];
-
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_dropdown($profile_row[0], true)),
-			1 => array('TITLE' => $_CLASS['core_user']->lang['NO_VALUE_OPTION'], 'EXPLAIN' => $_CLASS['core_user']->lang['NO_VALUE_OPTION_EXPLAIN'], 'FIELD' => $this->generate_dropdown($profile_row[1], true))
-		);
-
-		return $options;
-	}
-
-	function get_date_options()
-	{
-		global $_CLASS, $config, $lang_defs;
-
-		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
-
-		$profile_row = array(
-			'var_name'				=> 'field_default_value',
-			'lang_name'				=> $this->vars['lang_name'],
-			'lang_explain'			=> $this->vars['lang_explain'],
-			'lang_id'				=> $default_lang_id,
-			'field_default_value'	=> $this->vars['field_default_value'],
-			'field_ident'			=> 'field_default_value',
-			'field_type'			=> FIELD_DATE,
-			'field_length'			=> $this->vars['field_length']
-		);
-
-		$options = array(
-			0 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_date($profile_row, true) . '<br /><input type="checkbox" name="always_now"' . ((isset($_REQUEST['always_now']) || $this->vars['field_default_value'] == 'now') ? ' checked="checked"' : '') . ' />&nbsp; ' . $_CLASS['core_user']->lang['ALWAYS_TODAY'])
-		);
-
-		return $options;
-	}
-}
-
-?>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/index_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-13 22:02:35 UTC (rev 120)
@@ -1,4 +1,5 @@
 <!-- DISPLAY_HEADER -->
+<script type="text/javascript" src="javascript/forums/forum_view.js"></script>
 
 <!-- INCLUDE modules/Forums/overall_header.html -->
 
@@ -12,8 +13,7 @@
 		<th width="50">&nbsp;{ $L_POSTS }&nbsp;</th>
 		<th>&nbsp;{ $L_LAST_POST }&nbsp;</th>
 	</tr>
-	
-	<!-- LOOP $forumrow -->
+<!-- LOOP $forumrow -->
 	<!-- IF { $forumrow:S_IS_CAT } -->
 	<tr>
 		<td class="cat" colspan="2"><h4><a href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></h4></td>
@@ -23,11 +23,11 @@
 	<tr>
 		<td class="row1" width="50" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<!-- IF { $forumrow:CLICKS } -->
-		<td class="row1">
+		<td class="row1" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 		<!-- ELSE -->
-		<td class="row1" colspan="4">
+		<td class="row1" colspan="4" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF -->  width="100%">
 		<!-- ENDIF -->
-			<a class="forumlink" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
+			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
 			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p></td>
 		<!-- IF { $forumrow:CLICKS } -->
 		<td class="row2" colspan="3" align="center"><span class="gensmall">{ $L_REDIRECTS }: { $forumrow:CLICKS }</span></td>
@@ -36,8 +36,8 @@
 	<!-- ELSE -->
 	<tr>
 		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
-		<td class="row1" height="40" width="100%">
-			<a class="forumlink" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
+		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
+			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
 			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p>
 			<!-- IF { $forumrow:MODERATORS } -->
 				<p class="forumdesc"><strong>{ $forumrow:L_MODERATOR_STR }:</strong> { $forumrow:MODERATORS }</p>

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-13 22:02:35 UTC (rev 120)
@@ -1,4 +1,5 @@
 <!-- DISPLAY_HEADER -->
+<script type="text/javascript" src="javascript/forums/forum_view.js"></script>
 
 <!-- INCLUDE modules/Forums/overall_header.html -->
 
@@ -154,14 +155,14 @@
 		<!-- IF { $S_TOPIC_ICONS } -->
 		<td class="row1" align="center" width="25"><!-- IF { $topicrow:TOPIC_ICON_IMG } --><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /><!-- ENDIF --></td>
 		<!-- ENDIF -->
-		<td class="row1">
+		<td class="row1" id="topic_{ $topicrow:TOPIC_ID }" onmouseover="tite_edit_init('{ $topicrow:TOPIC_ID }', 'topic');">
 			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
 				<a href="{ $topicrow:U_MCP_QUEUE }">{ $UNAPPROVED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
 			<!-- IF { $topicrow:S_TOPIC_REPORTED } -->
 				<a href="{$topicrow:U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
-			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a> </p>
+			{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a class="topictitle" id="topic_name_{ $topicrow:TOPIC_ID }" href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a>
 			<!-- IF { $topicrow:PAGINATION } -->
 			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 			<!-- ENDIF -->

Modified: cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-13 22:02:35 UTC (rev 120)
@@ -157,16 +157,6 @@
 				<!-- IF { $postrow:POSTER_FROM } --><div class="poster_details"><b>{ $L_LOCATION }:</b> { $postrow:POSTER_FROM }</div><!-- ENDIF -->
 				<!-- IF { $postrow:POSTER_POSTS } --><div class="poster_details"><b>{ $L_POSTS }:</b> { $postrow:POSTER_POSTS }</div><!-- ENDIF -->
 				<br />
-				<!-- IF isset({ $postrow:S_PROFILE_FIELD_1 }) -->
-				<!-- Use a construct like this to include admin defined profile fields. Replace FIELD1 with the name of your field. -->
-				<br /><b>{ $postrow:PROFILE_FIELD1_NAME }:</b> { $postrow:PROFILE_FIELD1_VALUE }
-				<!-- ENDIF -->
-				<!---
-				need to think of a way of doing it
-				 BEGIN custom_fields 
-				<br /><b>{postrow.custom_fields.PROFILE_FIELD_NAME}:</b> {postrow.custom_fields.PROFILE_FIELD_VALUE}
-				END custom_fields
-				-->
 				</div>
 			</td>
 			<td valign="top"><table width="100%" cellspacing="5">

Deleted: cms/trunk/javascript/ajax.js
===================================================================
--- cms/trunk/javascript/ajax.js	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/javascript/ajax.js	2005-09-13 22:02:35 UTC (rev 120)
@@ -1,40 +0,0 @@
-// By Ryan Marshall ( viperal1 at gmail.com )
-
-function core_ajax()
-{
-	this.request = false;
-	this.async = true;
-}
-
-core_ajax.prototype.init = function()
-{
-	try
-	{
-		this.request = new XMLHttpRequest();
-	}
-	catch(e)
-	{
-		try
-		{
-			this.request = new ActiveXObject('Microsoft.XMLHTTP');
-			return true;
-		}
-		catch(e)
-		{
-			return false;
-		}
-	}
-}
-
-core_ajax.prototype.send = function(url, data)
-{
-	if (!this.request)
-	{
-		this.init();
-	}
-	
-	this.request.open('POST', url, this.async);
-	this.request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
-	
-	this.request.send(data);
-}
\ No newline at end of file

Added: cms/trunk/javascript/common.js
===================================================================
--- cms/trunk/javascript/common.js	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/javascript/common.js	2005-09-13 22:02:35 UTC (rev 120)
@@ -0,0 +1,79 @@
+// By Ryan Marshall ( viperal1 at gmail.com )
+
+function array_search(needle, haystack, strict)
+{
+	for (var i in haystack)
+	{
+		if (haystack[i] == needle)
+		{
+			return i;
+		}
+	}
+
+	return null;
+}
+
+function core_ajax()
+{
+	this.request = null;
+	this.async = true;
+}
+
+core_ajax.prototype.init = function()
+{
+	try
+	{
+		this.request = new XMLHttpRequest();
+
+		return true;
+	}
+	catch(e)
+	{
+		try
+		{
+			this.request = new ActiveXObject('Microsoft.XMLHTTP');
+
+			return true;
+		}
+		catch(e)
+		{
+			return false;
+		}
+	}
+}
+
+core_ajax.prototype.send = function(url, data)
+{
+	if (!this.request)
+	{
+		this.init();
+	}
+
+	this.request.open('POST', url, this.async);
+	this.request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
+
+	this.request.send(data);
+}
+
+core_ajax.prototype.onreadystatechange = function(event)
+{
+	if (!this.request)
+	{
+		this.init();
+	}
+
+	if (typeof(event) == 'function')
+	{
+		this.request.onreadystatechange = event;
+	}
+}
+
+core_ajax.prototype.responseText = function()
+{
+	return this.request.responseText;
+}
+
+core_ajax.prototype.state_ready = function()
+{
+	return (this.request.readyState == 4 && this.request.status == 200);
+}
\ No newline at end of file

Added: cms/trunk/javascript/forums/forum_view.js
===================================================================
--- cms/trunk/javascript/forums/forum_view.js	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/javascript/forums/forum_view.js	2005-09-13 22:02:35 UTC (rev 120)
@@ -0,0 +1,133 @@
+// By Ryan Marshall ( viperal1 at gmail.com )
+
+function tite_edit_init(id, mode)
+{
+	var area = document.getElementById(mode + '_' + id)
+
+	if (!area)
+	{
+		return
+	}
+
+	area.onmouseover = '';
+	area.ondblclick = function()
+	{
+		tite_edit_add(id, mode);
+	}
+}
+
+function tite_edit_add(id, mode)
+{
+	if (document.getElementById(mode + '_input_' + id))
+	{
+		return;
+	}
+
+	var area = document.getElementById(mode + '_' + id);
+	var title = document.getElementById(mode + '_name_' + id);
+	var input = document.createElement('input');
+
+	title.style.display ='none';
+
+	input.type = 'text';
+	input.size = 50;
+	input.className = 'post';
+	input.value = title.innerHTML;
+	//input.title = title.innerHTML;
+	input.id = mode + '_input_' + id;
+	input.onblur =	function()
+	{
+		tite_edit_onblur(id, mode);
+	}
+
+	input.onkeypress = function(e)
+	{
+		switch (e.keyCode)
+		{
+			case 13:
+			{
+				ajax = new core_ajax();
+
+				var onreadystatechange = function()
+				{
+					if (ajax.state_ready() && ajax.responseText())
+					{
+						title.innerHTML = ajax.responseText();
+					}
+				}
+				
+				ajax.onreadystatechange(onreadystatechange);
+
+				var input = document.getElementById(mode + '_input_' + id);
+
+				ajax.send('index.php?mod=Forums&file=ajax', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
+
+				tite_edit_remove(id, mode);
+			}
+	
+			case 27:
+			{
+				tite_edit_remove(id, mode);
+			}
+		}
+	}
+
+	if (input = area.insertBefore(input, title))
+	{
+		input.focus();
+	}
+
+	return false;
+}
+
+function tite_edit_remove(id, mode)
+{
+	var area = document.getElementById(mode + '_' + id);
+	var title = document.getElementById(mode + '_name_' + id);
+	var input = document.getElementById(mode + '_input_' + id);
+
+	if (!input)
+	{
+		return;
+	}
+
+	title.style.display = '';
+
+	area.removeChild(input);
+}
+
+function tite_edit_onblur(id, mode)
+{
+	var input = document.getElementById(mode + '_input_' + id);
+	var title = document.getElementById(mode + '_name_' + id);
+
+	if (!input)
+	{
+		return;
+	}
+
+	if (input.value == title.innerHTML)
+	{
+		tite_edit_remove(id, mode);
+
+		return;
+	}
+
+	ajax = new core_ajax();
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() && ajax.responseText())
+		{
+			title.innerHTML = ajax.responseText();
+		}
+	}
+	
+	ajax.onreadystatechange(onreadystatechange);
+
+	var input = document.getElementById(mode + '_input_' + id);
+
+	ajax.send('index.php?mod=Forums&file=ajax', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
+
+	tite_edit_remove(id, mode);
+}
\ No newline at end of file

Added: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-13 22:02:35 UTC (rev 120)
@@ -0,0 +1,79 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+header('Content-Type: text/html');
+
+Switch (get_variable('mode', 'POST', false))
+{
+	case 'forum_edit_title':
+		$forum_id = get_variable('id', 'POST', false, 'int');
+		$title = get_variable('title', 'POST', false);
+		
+		if (!$forum_id || !$title || !$_CLASS['auth']->acl_get('a_forum'))
+		{
+			die;
+		}
+
+		$title = mb_strtolower(htmlentities($title, ENT_QUOTES, 'UTF-8'));
+		$array = array('forum_name' => $title);
+		
+		$_CLASS['core_db']->report_error(false);
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_FORUMS_TABLE . ' SET '. $_CLASS['core_db']->sql_build_array('UPDATE', $array).' WHERE forum_id = '.$forum_id);
+
+		echo $title;
+	break;
+
+	case 'topic_edit_title':
+		$topic_id = get_variable('id', 'POST', false, 'int');
+		$title = get_variable('title', 'POST', false);
+
+		if (!$topic_id || !$title )
+		{
+			die;
+		}
+
+		$result = $_CLASS['core_db']->query('SELECT forum_id FROM ' . FORUMS_TOPICS_TABLE . ' WHERE topic_id = '.$topic_id);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$row || !$_CLASS['auth']->acl_get('m_edit', $row['forum_id']))
+		{
+			die;
+		}
+
+		$title = mb_strtolower(htmlentities($title, ENT_QUOTES, 'UTF-8'));
+		$array = array('topic_title' => $title);
+
+		$_CLASS['core_db']->report_error(false);
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . ' SET '. $_CLASS['core_db']->sql_build_array('UPDATE', $array).' WHERE topic_id = '.$topic_id);
+
+		echo $title;
+	break;
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-13 03:44:11 UTC (rev 119)
+++ cms/trunk/modules/Forums/posting.php	2005-09-13 22:02:35 UTC (rev 120)
@@ -535,7 +535,7 @@
 
 	$topic_cur_post_id	= get_variable('topic_cur_post_id', 'POST', 0, 'int');
 
-	$subject = mb_strtolower(get_variable('subject', 'POST', ''));
+	$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
 	$message_parser->message = request_var('message', '', true);
 
 
@@ -1615,7 +1615,7 @@
 			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
 
 			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . POSTS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET forum_id = 0
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);



From viperal at berlios.de  Wed Sep 14 02:09:57 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 14 Sep 2005 02:09:57 +0200
Subject: [Viperals-svncheckins] r121 - in cms/trunk: . includes includes/display
Message-ID: <200509140009.j8E09vWb013383@sheep.berlios.de>

Author: viperal
Date: 2005-09-14 02:09:46 +0200 (Wed, 14 Sep 2005)
New Revision: 121

Modified:
   cms/trunk/core.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/session.php
Log:


Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-13 22:02:35 UTC (rev 120)
+++ cms/trunk/core.php	2005-09-14 00:09:46 UTC (rev 121)
@@ -85,7 +85,7 @@
 
 if (empty($site_db))
 {
-	trigger_error('<p style="text-align:center">Site isn\'t Installed<br/><a href="install/installer.php">Click here to install</a></p>', E_USER_ERROR);
+	trigger_error('<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
 }
 
 require_once($site_file_root.'includes/tables.php');

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-09-13 22:02:35 UTC (rev 120)
+++ cms/trunk/includes/display/blocks.php	2005-09-14 00:09:46 UTC (rev 121)
@@ -1,4 +1,4 @@
-<?php
+<?php
 /*
 ||**************************************************************||
 ||  Viperal CMS ? :												||
@@ -19,408 +19,408 @@
 ||**************************************************************||
 
 $Id$
-*/
-/* to do
-move Auth, lang, and expire/begin checks to load_blocks
-*/
-
-class core_blocks
-{
-	var $blocks_array = array();
-	var $blocks_loaded;
-	var $info;
-	var $content;
-	var $template;
-
-	/*
-		Check to see there's any blocks for the specified side
-		should be used to stop themes from displaying blank sides
-	*/
-	function check_side($side)
-	{
-// expand this for center blocks
-		static $side_check = array();
-		
-		if (isset($side_check[$side]))
-		{
-			return $side_check[$side];
-		}
-
-		global $_CORE_MODULE, $_CLASS;
-
-		$trueside = $side;
-
-		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
-		{
-			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
-		}
-			
-		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
-		{
-			$this->load_blocks();
-
-			if (!empty($this->blocks_array[$side]))
-			{
-				return $side_check[$trueside] = $side;
-			}
-		}
-		
-		return $side_check[$trueside] = false;
-	}
-
-	/*
-		Load Blocks from cache or databases, also run needed checks
-	*/
-// Add auth check here
-	function load_blocks($force = false)
-	{
-		if ($this->blocks_loaded && !$force)
-		{
-			return;
-		}
-
-		global $_CLASS;
-
-		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
-		{
-			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
-
-			$this->blocks_array = array();
-
-			while($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
-				$this->blocks_array[$row['block_position']][] = $row;
-			}
-
-			$_CLASS['core_db']->free_result($result);
-			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
-
-			$_CLASS['core_cache']->save();
-		}
-
-		$_CLASS['core_cache']->remove('blocks');
-		$this->blocks_loaded = true;
-	}
-
-	/*
-	*/
-	function add_block($data, $position = false)
-	{
-		$option_array = array('block_status' => STATUS_ACTIVE, 'block_title' => '','block_position' => BLOCK_LEFT, 'block_content' => '', 'block_file' => '', 'block_starts' => 0,'block_expires' => 0, 'block_id' => 0,	'block_auth' => '',	'block_type' => '');
-
-		foreach ($option_array as $option => $value)
-		{
-			$data_perpared[$option] = isset($data[$option]) ? $data[$option] : $value ;
-		}
-
-		$this->blocks_array[$data_perpared['block_position']][] = $data_perpared;
-	}
-
-	/*
-	*/
-	function display($position)
-	{
-		$this->display_position = $position;
-
-		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
-		{
-			$position = $this->check_side($position);
-			
-			if ($position == false)
-			{
-				return false;
-			}
-		}
-
-		$this->load_blocks();
-
-		if (empty($this->blocks_array[$position]))
-		{
-			return false;
-		}
-
-		static $expire_updated = false;
-		global $_CLASS;
-
-		$this->content = '';
-
-		foreach($this->blocks_array[$position] as $this->block)
-		{
-			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
-			{
-				continue;
-			}
-
-			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
-			{
-				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);
-										
-				$_CLASS['core_cache']->destroy('blocks');
-				$expire_updated = true;
-
-				continue;
-			}
-
-			if ($this->block['block_starts'] && ($this->block['block_starts'] > $_CLASS['core_user']->time))
-			{
-				continue;
-			}
-
-			/*
-			if ($this->block['block_modules'])
-			{
-				$this->block['block_modules'] = unserialize($this->block['block_modules']);
-// Homepage needs it's own value
-				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
-				{
-					continue;
-				}
-			}
-			*/
-
-			$this->display_blocks();
-			$this->content = '';
-		}
-
-		unset($this->blocks_array[$position]);
-	}
-
-	/*
-	*/
-	function display_blocks()
-	{
-		Switch ($this->block['block_type'])
-		{
-			case BLOCKTYPE_FILE:
-			case BLOCKTYPE_SYSTEM:
-				$this->block_file();
-			break;
-				
-			case BLOCKTYPE_MESSAGE:
-			case BLOCKTYPE_MESSAGE_GLOBAL:
-				$this->block_message();
-			break;
-					
-			case BLOCKTYPE_HTML:
-				$this->block_html();
-			break;
-				
-			case BLOCKTYPE_FEED;
-				$this->block_feed();
-			break;
-		}
-		return;
-	}
-
-	/*
-	*/
-	function block_file()
-	{
-		global $_CLASS, $site_file_root;
-
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
-		{
-			$this->info = false;
-
-			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
-
-			include($site_file_root.'blocks/'.$this->block['block_file']);
-
-			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
-
-			if (!$this->content && !$this->template)
-			{
-				if ($_CLASS['core_auth']->admin_power('blocks'))
-				{
-					$this->content = '<center><strong>'.(($this->info) ? $this->info : $_CLASS['core_user']->lang['BLOCK_ERROR2']).'</strong></center>';
-				}
-				else
-				{
-					return;
-				}
-			}
-		}
-		else
-		{
-			if ($_CLASS['core_auth']->admin_power('blocks'))
-			{
-				$this->content = '<center><strong>'.$_CLASS['core_user']->lang['BLOCK_ERROR1'].'</strong></center>';
-			}
-			else
-			{
-				return;
-			}		
-		}
-
-		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
-		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_message()
-	{
-		global $_CLASS;
-
-		if (($this->block['block_type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
-		{
-			return;
-		}
-
-		if ($_CLASS['core_auth']->admin_power('messages'))
-		{
-			$expires = ($this->block['block_expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['block_expires']) : false;
-			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['block_id'], array('admin' => true));
-		}
-		else
-		{
-		
-			$edit_link = $expires = false;
-		}
-
-		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
-
-		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
-				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-				'title'		=> $this->block['block_title'],
-				'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
-				'content'	=> $this->block['block_content'],
-				'expires'	=> $expires,
-				'edit_link'	=> $edit_link,
-				'id'		=> $this->block['block_id'],
-		));
-	}
-
-	function block_side()
-	{
-		global $_CLASS;
-		
-		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
-		
-		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
-			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-			'title'		=> $this->block['block_title'],
-			'content'	=> $this->content,
-			'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
-			'id'		=> $this->block['block_id'],
-		));
-	}
-
-	function block_html()
-	{
-		$this->content = $this->block['block_content'];
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_feed()
-	{
-		global $site_file_root, $_CLASS;
-// think about disabling the block automatically if there's url problems
-// update core_rss file
-		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > time()))
-		{
-			$this->content = $this->block['block_content'];
-
-			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-			{
-				$this->block_side();
-			}
-			else
-			{
-				$this->block_center();
-			}
-
-			return;
-		}
-
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
-		{
-			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
-			
-			if (!$this->content)
-			{
-				return;
-			}
-		}
-		else
-		{
-			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
-			$_CLASS['core_rss']->setup(false, array('title', 'link'));
-				
-			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))
-			{
-	//admin only message here
-				return;
-			}
-
-			$this->content = '<center><br />';
-
-			while ($data = $_CLASS['core_rss']->get_rss_data())
-			{
-				$this->content .= '<a href="'.$data['link'].'" target="new">'.$data['title'].'</a><hr width="30%"/>';
-			}
-			
-			if (!empty($_CLASS['core_rss']->rss_info['link']))
-			{
-				$this->content .= '<br /><a href="'.$_CLASS['core_rss']->rss_info['link'].'" target="_blank"><b>Read More</b></a>';
-			}
-			
-			$this->content .= '</center>';
-		}
-
-		settype($this->block['block_rss_rate'], 'integer');
-
-		if ($this->block['block_rss_rate'] !== -1)
-		{
-			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? gmtime() + (int) $this->block['block_rss_rate'] : 0;
-			
-			$sql = 'UPDATE '.BLOCKS_TABLE."
-				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
-					WHERE block_id = ".$this->block['block_id'];
-				
-			$_CLASS['core_db']->query($sql);
-
-			$_CLASS['core_cache']->destroy('blocks');
-		}
-
-		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
-		{
-			$this->block_side();
-		}
-		else
-		{
-			$this->block_center();
-		}
-	}
-
-	function block_center()
-	{
-		global $_CLASS;
-		
-		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
-		
-		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
-			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
-			'CONTENT'	=> $this->content,
-			'TEMPLATE'	=> $this->template
-		));
-	}
-}
-
+*/
+/* to do
+move Auth, lang, and expire/begin checks to load_blocks
+*/
+
+class core_blocks
+{
+	var $blocks_array = array();
+	var $blocks_loaded;
+	var $info;
+	var $content;
+	var $template;
+
+	/*
+		Check to see there's any blocks for the specified side
+		should be used to stop themes from displaying blank sides
+	*/
+	function check_side($side)
+	{
+// expand this for center blocks
+		static $side_check = array();
+		
+		if (isset($side_check[$side]))
+		{
+			return $side_check[$side];
+		}
+
+		global $_CORE_MODULE, $_CLASS;
+
+		$trueside = $side;
+
+		if ($_CLASS['core_user']->lang['DIRECTION'] == 'rtl')
+		{
+			$side = ($side == BLOCK_LEFT) ? BLOCK_RIGHT : BLOCK_LEFT;
+		}
+			
+		if ($_CORE_MODULE['module_sides'] == BLOCK_ALL || ($side == BLOCK_LEFT && $_CORE_MODULE['module_sides'] == BLOCK_LEFT) || ($side == BLOCK_RIGHT && $_CORE_MODULE['module_sides'] == BLOCK_RIGHT))
+		{
+			$this->load_blocks();
+
+			if (!empty($this->blocks_array[$side]))
+			{
+				return $side_check[$trueside] = $side;
+			}
+		}
+		
+		return $side_check[$trueside] = false;
+	}
+
+	/*
+		Load Blocks from cache or databases, also run needed checks
+	*/
+// Add auth check here
+	function load_blocks($force = false)
+	{
+		if ($this->blocks_loaded && !$force)
+		{
+			return;
+		}
+
+		global $_CLASS;
+
+		if (is_null($this->blocks_array = $_CLASS['core_cache']->get('blocks')))
+		{
+			$result = $_CLASS['core_db']->query('SELECT * FROM '.BLOCKS_TABLE.' WHERE block_status = '.STATUS_ACTIVE.' ORDER BY block_order ASC');
+
+			$this->blocks_array = array();
+
+			while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$row['block_auth'] = ($row['block_auth']) ? unserialize($row['block_auth']) : '';
+				$this->blocks_array[$row['block_position']][] = $row;
+			}
+
+			$_CLASS['core_db']->free_result($result);
+			$_CLASS['core_cache']->put('blocks', $this->blocks_array);
+
+			$_CLASS['core_cache']->save();
+		}
+
+		$_CLASS['core_cache']->remove('blocks');
+		$this->blocks_loaded = true;
+	}
+
+	/*
+	*/
+	function add_block($data, $position = false)
+	{
+		$option_array = array('block_status' => STATUS_ACTIVE, 'block_title' => '','block_position' => BLOCK_LEFT, 'block_content' => '', 'block_file' => '', 'block_starts' => 0,'block_expires' => 0, 'block_id' => 0,	'block_auth' => '',	'block_type' => '');
+
+		foreach ($option_array as $option => $value)
+		{
+			$data_perpared[$option] = isset($data[$option]) ? $data[$option] : $value ;
+		}
+
+		$this->blocks_array[$data_perpared['block_position']][] = $data_perpared;
+	}
+
+	/*
+	*/
+	function display($position)
+	{
+		$this->display_position = $position;
+
+		if ($position == BLOCK_LEFT || $position == BLOCK_RIGHT)
+		{
+			$position = $this->check_side($position);
+			
+			if ($position == false)
+			{
+				return false;
+			}
+		}
+
+		$this->load_blocks();
+
+		if (empty($this->blocks_array[$position]))
+		{
+			return false;
+		}
+
+		static $expire_updated = false;
+		global $_CLASS;
+
+		$this->content = '';
+
+		foreach($this->blocks_array[$position] as $this->block)
+		{
+			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
+			{
+				continue;
+			}
+
+			if ($this->block['block_expires'] && !$expire_updated && ($_CLASS['core_user']->time > $this->block['block_expires']))
+			{
+				$_CLASS['core_db']->query('UPDATE '.BLOCKS_TABLE.' SET block_status = ' . STATUS_DISABLED . ' WHERE block_expires > 0 AND block_expires <= ' . $_CLASS['core_user']->time);
+										
+				$_CLASS['core_cache']->destroy('blocks');
+				$expire_updated = true;
+
+				continue;
+			}
+
+			if ($this->block['block_starts'] && ($this->block['block_starts'] > $_CLASS['core_user']->time))
+			{
+				continue;
+			}
+
+			/*
+			if ($this->block['block_modules'])
+			{
+				$this->block['block_modules'] = unserialize($this->block['block_modules']);
+// Homepage needs it's own value
+				if (!in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['show'] || in_array($_CORE_MODULE['module_title'], $this->block['block_modules']['hide'])))
+				{
+					continue;
+				}
+			}
+			*/
+
+			$this->display_blocks();
+			$this->content = '';
+		}
+
+		unset($this->blocks_array[$position]);
+	}
+
+	/*
+	*/
+	function display_blocks()
+	{
+		Switch ($this->block['block_type'])
+		{
+			case BLOCKTYPE_FILE:
+			case BLOCKTYPE_SYSTEM:
+				$this->block_file();
+			break;
+				
+			case BLOCKTYPE_MESSAGE:
+			case BLOCKTYPE_MESSAGE_GLOBAL:
+				$this->block_message();
+			break;
+					
+			case BLOCKTYPE_HTML:
+				$this->block_html();
+			break;
+				
+			case BLOCKTYPE_FEED;
+				$this->block_feed();
+			break;
+		}
+		return;
+	}
+
+	/*
+	*/
+	function block_file()
+	{
+		global $_CLASS, $site_file_root;
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
+		{
+			$this->info = false;
+
+			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
+
+			include($site_file_root.'blocks/'.$this->block['block_file']);
+
+			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
+
+			if (!$this->content && !$this->template)
+			{
+				if ($_CLASS['core_auth']->admin_power('blocks'))
+				{
+					$this->content = '<center><strong>'.(($this->info) ? $this->info : $_CLASS['core_user']->lang['BLOCK_ERROR2']).'</strong></center>';
+				}
+				else
+				{
+					return;
+				}
+			}
+		}
+		else
+		{
+			if ($_CLASS['core_auth']->admin_power('blocks'))
+			{
+				$this->content = '<center><strong>'.$_CLASS['core_user']->lang['BLOCK_ERROR1'].'</strong></center>';
+			}
+			else
+			{
+				return;
+			}		
+		}
+
+		//$this->content .= '<div style="text-align: center;"><br />'.$_CLASS['core_error_handler']->debug_get($this->block['block_title'], 'formated').'</div>';
+		//$_CLASS['core_error_handler']->debug_remove($this->block['block_title']);
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_message()
+	{
+		global $_CLASS;
+
+		if (($this->block['block_type'] == BLOCKTYPE_MESSAGE) && (!$_CLASS['core_display']->homepage))
+		{
+			return;
+		}
+
+		if ($_CLASS['core_auth']->admin_power('messages'))
+		{
+			$expires = ($this->block['block_expires']) ? $_CLASS['core_user']->lang['EXPIRES'].' '.$_CLASS['core_user']->format_date($this->block['block_expires']) : false;
+			$edit_link = generate_link('messages&amp;mode=edit&amp;id='.$this->block['block_id'], array('admin' => true));
+		}
+		else
+		{
+		
+			$edit_link = $expires = false;
+		}
+
+		$postion = ($this->display_position == BLOCK_MESSAGE_TOP) ? 'top' : 'bottom';
+
+		$_CLASS['core_template']->assign_vars_array('message_block_'.$postion, array(
+				//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+				'title'		=> $this->block['block_title'],
+				'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+				'content'	=> $this->block['block_content'],
+				'expires'	=> $expires,
+				'edit_link'	=> $edit_link,
+				'id'		=> $this->block['block_id'],
+		));
+	}
+
+	function block_side()
+	{
+		global $_CLASS;
+		
+		$position = ($this->display_position == BLOCK_RIGHT) ? 'right' : 'left';
+		
+		$_CLASS['core_template']->assign_vars_array('block_'.$position, array(
+			//'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+			'title'		=> $this->block['block_title'],
+			'content'	=> $this->content,
+			'collapsed'	=> check_collapsed_status('block_'.$this->block['block_id']),
+			'id'		=> $this->block['block_id'],
+		));
+	}
+
+	function block_html()
+	{
+		$this->content = $this->block['block_content'];
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_feed()
+	{
+		global $site_file_root, $_CLASS;
+// think about disabling the block automatically if there's url problems
+// update core_rss file
+		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > (int) $_CLASS['core_user']->time))
+		{
+			$this->content = $this->block['block_content'];
+
+			if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+			{
+				$this->block_side();
+			}
+			else
+			{
+				$this->block_center();
+			}
+
+			return;
+		}
+
+		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
+		{
+			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
+			
+			if (!$this->content)
+			{
+				return;
+			}
+		}
+		else
+		{
+			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
+			$_CLASS['core_rss']->setup(false, array('title', 'link'));
+				
+			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))
+			{
+	//admin only message here
+				return;
+			}
+
+			$this->content = '<center><br />';
+
+			while ($data = $_CLASS['core_rss']->get_rss_data())
+			{
+				$this->content .= '<a href="'.$data['link'].'" target="new">'.$data['title'].'</a><hr width="30%"/>';
+			}
+			
+			if (!empty($_CLASS['core_rss']->rss_info['link']))
+			{
+				$this->content .= '<br /><a href="'.$_CLASS['core_rss']->rss_info['link'].'" target="_blank"><b>Read More</b></a>';
+			}
+			
+			$this->content .= '</center>';
+		}
+
+		settype($this->block['block_rss_rate'], 'integer');
+
+		if ($this->block['block_rss_rate'] !== -1)
+		{
+			$this->block['block_rss_expires'] = ($this->block['block_rss_rate']) ? (int) $_CLASS['core_user']->time + $this->block['block_rss_rate'] : 0;
+			
+			$sql = 'UPDATE '.BLOCKS_TABLE."
+				SET block_content = '".$_CLASS['core_db']->escape($this->content)."', block_rss_expires = ".$this->block['block_rss_expires']." 
+					WHERE block_id = ".$this->block['block_id'];
+				
+			$_CLASS['core_db']->query($sql);
+
+			$_CLASS['core_cache']->destroy('blocks');
+		}
+
+		if ($this->display_position == BLOCK_LEFT || $this->display_position == BLOCK_RIGHT)
+		{
+			$this->block_side();
+		}
+		else
+		{
+			$this->block_center();
+		}
+	}
+
+	function block_center()
+	{
+		global $_CLASS;
+		
+		$position = ($this->display_position == BLOCK_TOP) ? 'center' : 'bottom';
+		
+		$_CLASS['core_template']->assign_vars_array('block_'.$position , array(
+			'TITLE'		=> $_CLASS['core_user']->get_lang($this->block['block_title']),
+			'CONTENT'	=> $this->content,
+			'TEMPLATE'	=> $this->template
+		));
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2005-09-13 22:02:35 UTC (rev 120)
+++ cms/trunk/includes/display/template.php	2005-09-14 00:09:46 UTC (rev 121)
@@ -529,19 +529,12 @@
     */
 	function _compile_tag_define($options)
 	{
-		$options = explode('=', $options);
-		$size = count($options);
-		$output = '';
+		list($name, $value) = explode('=', $options, 2);
 
-		for ($loop = 0; $loop < $size; $loop++)
-		{
-			//need to addslashed, check for variable type
-			$value = trim($options[($loop + 1)]);
-			$output .= "\$this->_vars['defines']['".trim($options[$loop])."'] = ".(is_integer($value) ? $value : "'".str_replace("'", "\'", $value)."'");
-			$loop++;
-		}
+		$value = trim($value);
+		$output = "\$this->_vars['defines']['".trim($name)."'] = ".(is_integer($value) ? $value : "'".str_replace("'", "\'", $value)."'");
 
-		return "<?php $output ?>";
+		return "<?php $output; ?>";
 	}
 	
     /*

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-09-13 22:02:35 UTC (rev 120)
+++ cms/trunk/includes/session.php	2005-09-14 00:09:46 UTC (rev 121)
@@ -421,7 +421,7 @@
 		}
 
 		$sql_array = array(
-			'session_data'			=> ($this->data['session_data']) ? serialize($this->data['session_data']) : '',
+			'session_data'			=> !empty($this->data['session_data']) ? serialize($this->data['session_data']) : '',
 			'session_page'			=> (string) $this->page,
 			'session_time'			=> (int) $this->time,
 			'session_url'			=> (string) $this->url,



From viperal at berlios.de  Wed Sep 14 02:12:56 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 14 Sep 2005 02:12:56 +0200
Subject: [Viperals-svncheckins] r122 - cms/trunk/images
Message-ID: <200509140012.j8E0CuBA015905@sheep.berlios.de>

Author: viperal
Date: 2005-09-14 02:12:31 +0200 (Wed, 14 Sep 2005)
New Revision: 122

Added:
   cms/trunk/images/led_green.png
   cms/trunk/images/led_red.png
   cms/trunk/images/led_yellow.png
Log:


Added: cms/trunk/images/led_green.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/led_green.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/led_red.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/led_red.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/images/led_yellow.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/images/led_yellow.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From viperal at berlios.de  Thu Sep 15 05:14:09 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 15 Sep 2005 05:14:09 +0200
Subject: [Viperals-svncheckins] r123 - in cms/trunk: . admin includes/db includes/forums includes/forums/admin includes/templates/modules includes/templates/modules/Forums install javascript modules/Forums modules/Forums/admin modules/Quick_Message modules/articles
Message-ID: <200509150314.j8F3E9cG027069@sheep.berlios.de>

Author: viperal
Date: 2005-09-15 05:13:58 +0200 (Thu, 15 Sep 2005)
New Revision: 123

Added:
   cms/trunk/modules/Quick_Message/configurator.php
   cms/trunk/modules/articles/configurator.php
Removed:
   cms/trunk/includes/templates/modules/Server_Status/
   cms/trunk/modules/Quick_Message/install.php
   cms/trunk/modules/articles/install.php
Modified:
   cms/trunk/admin/modules.php
   cms/trunk/core.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysql3.php
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/forums/admin/admin_permissions.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/templates/modules/Forums/index_body.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/collapse.js
   cms/trunk/javascript/common.js
   cms/trunk/javascript/menu.js
   cms/trunk/modules/Forums/admin/index.php
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Forums/viewtopic.php
Log:
Just a few, maybe a bit of changes and fixes

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/admin/modules.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -66,6 +66,29 @@
 				check_type($module['module_type']);
 			
 				$status = ($module['module_status'] == STATUS_ACTIVE) ? STATUS_DISABLED : STATUS_ACTIVE;
+				
+				if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
+				{
+					require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
+					
+					$name = $module['module_name'].'_configurator';
+
+					if (class_exists($name))
+					{
+						$module_configurer = new $name;
+
+						if (method_exists('status_change'))
+						{
+							$report = $module_configurer->status_change($status, $module['module_status']);
+		
+							if ($report !== true)
+							{
+								trigger_error(is_string($report) ? $report : 'STATUS_CHANGE_FAILED');
+							}
+						}
+					}
+				}
+
 				$result = $_CLASS['core_db']->query('UPDATE '. CORE_MODULES_TABLE . " SET module_status = $status WHERE module_id = $id");
 			break;
 
@@ -83,20 +106,27 @@
 
 				if (display_confirmation())
 				{
-					$error = true;
+					$status = true;
 
-					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
 					{
-						require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+						require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
+						
+						$name = $module['module_name'].'_configurator';
+
+						if (class_exists($name))
+						{
+							$module_configurer = new $name;
 	
-						$name = $module['module_name'].'_install';
-						$install = new $name;
-						$error = $install->install();
-	
-						if ($error !== true)
-						{
-							// do something better than this
-							trigger_error($error);
+							if (method_exists('install'))
+							{
+								$status = $module_configurer->install();
+			
+								if ($status !== true)
+								{
+									trigger_error(is_string($status) ? $status : 'INSTALLATION_FAILED');
+								}
+							}
 						}
 					}
 
@@ -118,14 +148,26 @@
 				
 				if (display_confirmation())
 				{
-					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/install.php'))
+					if (file_exists($site_file_root.'modules/'.$module['module_name'].'/configurator.php'))
 					{
-						require_once($site_file_root.'modules/'.$module['module_name'].'/install.php');
+						require_once($site_file_root.'modules/'.$module['module_name'].'/configurator.php');
 						
-						$name = $module['module_name'].'_install';
-						$install = new $name;
-						
-						$install->uninstall();
+						$name = $module['module_name'].'_configurator';
+
+						if (class_exists($name))
+						{
+							$module_configurer = new $name;
+	
+							if (method_exists('uninstall'))
+							{
+								$status = $module_configurer->uninstall();
+			
+								if ($status !== true)
+								{
+									trigger_error(is_string($status) ? $status : 'UNISTALLATION_FAILED');
+								}
+							}
+						}
 					}
 
 					$_CLASS['core_db']->query('UPDATE ' . CORE_MODULES_TABLE . ' set module_status = ' . STATUS_PENDING . ' WHERE module_id = '.$id);

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/core.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -147,7 +147,7 @@
 	}
 }
 
-$_CLASS['core_db']->report_error(false);
+$_CLASS['core_db']->report_error(true);
 unset($config_error);
 
 $_CLASS['core_cache']->remove('core_config');

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/db/mysql.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -382,7 +382,7 @@
 		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
 	}
 		
-	function optimize_tables($table = '')
+	function optimize_tables($table = false)
 	{
 		global $_CORE_CONFIG;
 	
@@ -403,6 +403,10 @@
 				{
 					$table .= ', ' . $row[0];
 				}
+				else
+				{
+					$table = $row[0];
+				}
 			}
 
 			$this->free_result($result);

Modified: cms/trunk/includes/db/mysql3.php
===================================================================
--- cms/trunk/includes/db/mysql3.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/db/mysql3.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -311,7 +311,7 @@
 		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
 	}
 	
-	function optimize_tables($table = '')
+	function optimize_tables($table = false)
 	{
 		global $_CORE_CONFIG;
 	
@@ -332,9 +332,13 @@
 				{
 					$table .= ', ' . $row[0];
 				}
+				else
+				{
+					$table = $row[0];
+				}
 			}
 
-			$this->sql_freeresult($result);
+			$this->free_result($result);
 		}
 
 		if ($table)

Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/db/postgres.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -66,7 +66,10 @@
 			$connection_string[] = 'password='.$db['password'];
 		}
 
-		$connection_string[] = 'dbname='.$db['database'];
+		if ($db['database'])
+		{
+			$connection_string[] = 'dbname='.$db['database'];
+		}
 
 		if ($this->link_identifier)
 		{

Modified: cms/trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -199,7 +199,7 @@
 					}
 				}
 
-				if (sizeof($auth_setting))
+				if (!empty($auth_setting))
 				{
 					// Loop through all user/group ids
 					foreach ($ug_data as $id)
@@ -211,14 +211,14 @@
 
 			// Do we need to recache the moderator lists? We do if the mode
 			// was mod or auth_settings['mod'] is a non-zero size array
-			if ($mode == 'mod' || (isset($auth_settings['mod']) && sizeof($auth_settings['mod'])))
+			if ($mode == 'mod' || !empty($auth_settings['mod']))
 			{
 				cache_moderators();
 			}
 
 			// Remove users who are now moderators or admins from everyones foes
 			// list
-			if ($mode == 'mod' || (isset($auth_settings['mod']) && sizeof($auth_settings['mod'])) || $mode == 'admin' || (isset($auth_settings['admin']) && sizeof($auth_settings['admin'])))
+			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
 			{
 				update_foes();
 			}

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/forums/functions.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -280,9 +280,9 @@
 
 	$forum_parents = array();
 	
-	if ($forum_data['parent_id'] > 0)
+	if ($forum_data['parent_id'])
 	{
-		if ($forum_data['forum_parents'] == '')
+		if (!$forum_data['forum_parents'])
 		{
 			$sql = 'SELECT forum_id, forum_name, forum_type
 				FROM ' . FORUMS_FORUMS_TABLE . '
@@ -318,9 +318,7 @@
 {
 	global $config, $_CLASS;
 
-	// Have we disabled the display of moderators? If so, then return
-	// from whence we came ... 
-	if (empty($config['load_moderators']))
+	if (!$config['load_moderators'])
 	{
 		return array();
 	}
@@ -342,7 +340,7 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$forum_moderators[$row['forum_id']][] = (!empty($row['user_id'])) ? '<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>' : '<a href="' . generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '">' . $row['groupname'] . '</a>';
+		$forum_moderators[$row['forum_id']][] = empty($row['user_id']) ? '<a href="' . generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>' : '<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>';
 	}
 	$_CLASS['core_db']->free_result($result);
 
@@ -618,7 +616,7 @@
 	);
 }
 
-// Marks a topic or form as read
+// Marks a topic or forum as read
 function markread($mode, $forum_id = 0, $topic_id = 0, $marktime = false)
 {
 	global $config, $_CLASS, $_CORE_CONFIG;
@@ -694,12 +692,19 @@
 			}
 			else
 			{
-				$tracking = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+				$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+				
+				if (!is_array($tracking))
+				{
+					$tracking = array();
+				}
 
 				foreach ($forum_id as $f_id)
 				{
-					unset($tracking[$f_id]);
-					$tracking[$f_id][0] = base_convert($time - $config['board_startdate'], 10, 36);
+					$forum_id36 = base_convert($f_id, 10, 36);
+
+					unset($tracking[$forum_id36]);
+					$tracking[$forum_id36][0] = base_convert($time, 10, 36);
 				}
 
 				$_CLASS['core_user']->set_cookie('track', serialize($tracking), time() + 31536000);
@@ -732,11 +737,13 @@
 			}
 			else
 			{
-				$tracking = array();
-				if (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']))
+				$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+
+				if (!is_array($tracking))
 				{
-					$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
-
+					$tracking = array();
+				}
+					/*
 					// If the cookie grows larger than 2000 characters we will remove
 					// the smallest value
 					if (strlen($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']) > 2000)
@@ -751,18 +758,21 @@
 							}
 						}
 						unset($tracking[$m_fkey][$m_tkey]);
-					}
-				}
+					}*/
 
-				if (isset($tracking[$forum_id]) && base_convert($tracking[$forum_id][0], 36, 10) < $time)
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$forum_id36 = base_convert($forum_id, 10, 36);
+
+				if (isset($tracking[$forum_id36][$topic_id36]) && base_convert($tracking[$forum_id36][$topic_id36], 36, 10) < $time)
 				{
-					$tracking[$forum_id][base_convert($topic_id, 10, 36)] = base_convert($time - $config['board_startdate'], 10, 36);
+					$tracking[$forum_id36][$topic_id36] = base_convert($time, 10, 36);
 
 					$_CLASS['core_user']->set_cookie('track', serialize($tracking), time() + 31536000);
 				}
-				else if (!isset($tracking[$forum_id]))
+				elseif (!isset($tracking[$forum_id36][$topic_id36]))
 				{
-					$tracking[$forum_id][0] = base_convert($time - $config['board_startdate'], 10, 36);
+					$tracking[$forum_id36][$topic_id36] = base_convert($time, 10, 36);
+
 					$_CLASS['core_user']->set_cookie('track', serialize($tracking), time() + 31536000);
 				}
 				unset($tracking);
@@ -1376,7 +1386,6 @@
 		'S_USER_LANG'			=> $_CLASS['core_user']->data['user_lang'], 
 		'S_USER_BROWSER' 		=> ($_CLASS['core_user']->data['session_browser']) ? $_CLASS['core_user']->data['session_browser'] : $_CLASS['core_user']->lang['UNKNOWN_BROWSER'],
 		'S_CONTENT_DIRECTION' 	=> $_CLASS['core_user']->lang['DIRECTION'],
-		'S_CONTENT_ENCODING' 	=> 'UTF-8',
 		'S_CONTENT_DIR_LEFT' 	=> $_CLASS['core_user']->lang['LEFT'],
 		'S_CONTENT_DIR_RIGHT' 	=> $_CLASS['core_user']->lang['RIGHT'],
 		'S_TIMEZONE'			=> ($_CLASS['core_user']->data['user_dst'] || (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['global']['default_dst'])) ? sprintf($_CLASS['core_user']->lang['ALL_TIMES'], $_CLASS['core_user']->lang['tz'][$tz/3600], $_CLASS['core_user']->lang['tz']['dst']) : sprintf($_CLASS['core_user']->lang['ALL_TIMES'], $_CLASS['core_user']->lang['tz'][$tz/3600], ''),

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -657,7 +657,7 @@
 
 	switch ($_CLASS['core_db']->db_layer)
 	{
-		case 'mysql4':
+		case 'mysql':
 		case 'mysqli':
 			$sql = 'DELETE t.*
 				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
@@ -777,7 +777,7 @@
 		case 'topic_moved':
 			switch ($_CLASS['core_db']->db_layer)
 			{
-				case 'mysql4':
+				case 'mysql':
 				case 'mysqli':
 					$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 						USING ' . FORUMS_TOPICS_TABLE . ' t1, ' . FORUMS_TOPICS_TABLE . " t2
@@ -814,7 +814,7 @@
 		case 'topic_approved':
 			switch ($_CLASS['core_db']->db_layer)
 			{
-				case 'mysql4':
+				case 'mysql':
 				case 'mysqli':
 					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 						SET t.topic_approved = p.post_approved
@@ -1596,59 +1596,40 @@
 	global $_CLASS;
 
 	// Clear table
-	$sql = ($_CLASS['core_db']->db_layer != 'sqlite') ? 'TRUNCATE ' . MODERATOR_TABLE : 'DELETE FROM ' . MODERATOR_TABLE;
-	$_CLASS['core_db']->query($sql);
+	//$sql = (strpos($_CLASS['core_db']->db_layer, 'sqlite') === false) ? 'TRUNCATE ' . MODERATOR_TABLE : 'DELETE FROM ' . MODERATOR_TABLE;
+	$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_MODERATOR_TABLE);
 
 	// Holding array
 	$m_sql = array();
 	$user_id_sql = '';
 
 	$sql = 'SELECT a.forum_id, u.user_id, u.username
-		FROM  ' . ACL_OPTIONS_TABLE . '  o, ' . ACL_USERS_TABLE . ' a,  ' . USERS_TABLE . "  u
+		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . USERS_TABLE . "  u
 		WHERE o.auth_option = 'm_'
 			AND a.auth_option_id = o.auth_option_id
-			AND a.auth_setting = " . ACL_YES . ' 
+			AND a.auth_setting = " . ACL_YES . '
 			AND u.user_id = a.user_id';
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_u_' . $row['user_id']] = $row['forum_id'] . ', ' . $row['user_id'] . ", '" . $row['username'] . "', NULL, NULL";
+		$m_sql['f_' . $row['forum_id'] . '_u_' . $row['user_id']] = $row['forum_id'] . ', ' . $row['user_id'] . ", '" . $row['username'] . "', NULL, NULL, 1";
 		$user_id_sql .= (($user_id_sql) ? ', ' : '') . $row['user_id'];
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	// Remove users who have group memberships with DENY moderator permissions
-	if ($user_id_sql)
-	{
-		$sql = 'SELECT a.forum_id, ug.user_id
-			FROM  ' . ACL_OPTIONS_TABLE . '  o, ' . ACL_GROUPS_TABLE . ' a,  ' . USER_GROUP_TABLE . "  ug
-			WHERE o.auth_option = 'm_'
-				AND a.auth_option_id = o.auth_option_id
-				AND a.auth_setting = " . ACL_NO . " 
-				AND a.group_id = ug.group_id
-				AND ug.user_id IN ($user_id_sql)";
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			unset($m_sql['f_' . $row['forum_id'] . '_u_' . $row['user_id']]);
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
 	$sql = 'SELECT a.forum_id, g.group_name, g.group_id
-		FROM  ' . ACL_OPTIONS_TABLE . '  o, ' . ACL_GROUPS_TABLE . ' a,  ' . GROUPS_TABLE . "  g
+		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . GROUPS_TABLE . "  g
 		WHERE o.auth_option = 'm_'
 			AND a.auth_option_id = o.auth_option_id
 			AND a.auth_setting = " . ACL_YES . '
 			AND g.group_id = a.group_id
-			AND g.group_type NOT IN (' . GROUP_HIDDEN . ', ' . GROUP_SPECIAL . ')';
+			AND g.group_type <> ' . GROUP_HIDDEN;
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_g_' . $row['group_id']] = $row['forum_id'] . ', NULL, NULL, ' . $row['group_id'] . ", '" . $row['group_name'] . "'";
+		$m_sql['f_' . $row['forum_id'] . '_g_' . $row['group_id']] = $row['forum_id'] . ', NULL, NULL, ' . $row['group_id'] . ", '" . $row['group_name'] . "', 1";
 	}
 	$_CLASS['core_db']->free_result($result);
 
@@ -1656,29 +1637,30 @@
 	{
 		switch ($_CLASS['core_db']->db_layer)
 		{
-			case 'mysql':
-			
-				$sql = 'INSERT INTO ' . MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, groupname) 
+			case 'mysql3':
+				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index) 
 					VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\1)',  $m_sql));
 				$_CLASS['core_db']->query($sql);
-				break;
+			break;
 
-			case 'mysql4':
+			case 'mysql':
 			case 'mysqli':
 			case 'mssql':
 			case 'sqlite':
-				$sql = 'INSERT INTO ' . MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, groupname)
+			case 'sqlite_pdo':
+				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index)
 					 ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', 'SELECT \1',  $m_sql));
 				$_CLASS['core_db']->query($sql);
-				break;
+			break;
 
 			default:
 				foreach ($m_sql as $k => $sql)
 				{
-					$sql = 'INSERT INTO ' . MODERATOR_TABLE . " (forum_id, user_id, username, group_id, groupname) 
+					$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . " (forum_id, user_id, username, group_id, group_name, display_on_index) 
 						VALUES ($sql)";
 					$_CLASS['core_db']->query($sql);
 				}
+			break;
 		}
 	}
 }
@@ -1889,10 +1871,19 @@
 				$forum_id = array($forum_id);
 			}
 
+			$holding_auth = array();
+
 			// Set any flags as required
 			foreach ($auth as $auth_option => $setting)
 			{
+				if ($setting == ACL_NO)
+				{
+					unset($auth[$auth_option]);
+					continue;
+				}
+
 				$postion = strpos($auth_option, '_');
+
 				if ($postion == false)
 				{
 					continue;
@@ -1900,9 +1891,9 @@
 
 				$flag = substr($auth_option, 0, $postion + 1);
 
-				if (empty($auth[$flag]) && (empty($holding_auth[$flag]) || ($holding_auth[$flag] == ACL_NO && $setting == ACL_YES)))
+				if (empty($auth[$flag]))
 				{
-					$holding_auth[$flag] =  $setting;
+					$auth[$flag] = $setting;
 				}
 			}
 
@@ -1936,12 +1927,17 @@
 			$sql_ary = array();
 			foreach ($forum_id as $forum)
 			{
-				$delete_option_ids = $update_option_ids =array();
+				$delete_option_ids = $update_option_ids = array();
 
 				foreach ($auth as $auth_option => $setting)
 				{
-					$auth_option_id = $option_ids[$auth_option];
+					if (!isset($option_ids[$auth_option]))
+					{
+						continue;
+					}
 
+					$auth_option_id = $option_ids[$auth_option];
+					
 					switch ($setting)
 					{
 						case ACL_UNSET:
@@ -1984,7 +1980,6 @@
 				}
 			}
 			unset($cur_auth);
-
 			
 			foreach ($sql_ary as $sql_type => $sql_subary)
 			{
@@ -1995,11 +1990,11 @@
 					case 'insert':
 						switch ($_CLASS['core_db']->db_layer)
 						{
-							case 'mysql':
+							case 'mysql3':
 								$sql = 'VALUES ' . implode(', ', preg_replace('#^(.*?)$#', '(\1)', $sql_subary));
 							break;
 
-							case 'mysql4':
+							case 'mysql':
 							case 'mysqli':
 							case 'mssql':
 							case 'sqlite':

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -55,8 +55,7 @@
 	else
 	{
 		$sql_from = $lastread_select = $sql_lastread = '';
-
-		$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+		$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 	}
 
 	$sql = "SELECT f.* $lastread_select 
@@ -154,9 +153,10 @@
 			}
 		}
 
-		if (!$config['load_db_lastread'] || !$_CLASS['core_user']->is_user)
+		if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
 		{
-			$row['mark_time'] = isset($tracking_topics[$forum_id][0]) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+			$forum_id36 = base_convert($forum_id, 10, 36);
+			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
 		}
 
 		if ($row['mark_time'] < $row['forum_last_post_time'])
@@ -182,7 +182,7 @@
 	// Grab moderators ... if necessary
 	if ($display_moderators)
 	{
-		get_moderators($forum_moderators, $forum_ids);
+		$forum_moderators = get_moderators($forum_ids);
 	}
 
 	// Loop through the forums
@@ -400,38 +400,16 @@
 					break;
 			}
 		}
-		
-		if ($_CLASS['core_user']->is_user)
-		{
-			$unread_topic = $new_votes = true;
 
-			if ($mark_time >= $topic_row['topic_last_post_time'])
-			{
-				$unread_topic = false;
-			}
-/*
-			if ($mark_time >= $topic_row['poll_last_vote'])
-			{
-				$new_votes = false;
-			}
-*/
-		}
-		/*else
+		$unread_topic = true;
+
+		if ($mark_time >= $topic_row['topic_last_post_time'])
 		{
 			$unread_topic = false;
-			//$unread_topic = $new_votes = false;
-		}*/
-	
-//		$folder_new .= ($new_votes) ? '_vote' : '';
+		}
 
 		$folder_img = ($unread_topic) ? $folder_new : $folder;
 		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
-
-		// Posted image?
-		if (!empty($topic_row['mark_type']))
-		{
-			$folder_img .= '_posted';
-		}
 	}
 
 	if ($topic_row['poll_start'])

Modified: cms/trunk/includes/templates/modules/Forums/index_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-15 03:13:58 UTC (rev 123)
@@ -23,9 +23,9 @@
 	<tr>
 		<td class="row1" width="50" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<!-- IF { $forumrow:CLICKS } -->
-		<td class="row1" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
+		<td class="row1" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 		<!-- ELSE -->
-		<td class="row1" colspan="4" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF -->  width="100%">
+		<td class="row1" colspan="4" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 		<!-- ENDIF -->
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
 			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p></td>
@@ -36,7 +36,7 @@
 	<!-- ELSE -->
 	<tr>
 		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
-		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } -->onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
+		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
 			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p>
 			<!-- IF { $forumrow:MODERATORS } -->

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-15 03:13:58 UTC (rev 123)
@@ -167,10 +167,10 @@
 			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 			<!-- ENDIF -->
 		</td>
-		<td class="row2" align="center" width="100"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row2" align="center" width="100" nowrap="nowrap"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
 		<td class="row1" align="center" width="50"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
 		<td class="row2" align="center" width="50"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
-		<td class="row1" align="center" width="120">
+		<td class="row1" align="center" width="150" nowrap="nowrap">
 			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
 			<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
 			<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html	2005-09-15 03:13:58 UTC (rev 123)
@@ -1,3 +1,5 @@
+<script type="text/javascript" src="javascript/forums/forum_view.js"></script>
+
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
 		<td class="cat" colspan="5" align="right"><a class="nav" href="{ $U_MARK_FORUMS }">{ $L_MARK_FORUMS_READ }</a>&nbsp;</td>
@@ -18,7 +20,8 @@
 	<!-- ELSEIF { $forumrow:S_IS_LINK } -->
 	<tr>
 		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
-		<td class="row1" height="40"><a class="forumlink" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
+		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
+			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
 			<!-- IF { $forumrow:FORUM_DESC } -->
 			<table cellspacing="5" cellpadding="0" border="0">
 				<tr>
@@ -32,7 +35,8 @@
 	<!-- ELSE -->
 	<tr>
 		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
-		<td class="row1" width="100%" height="40" ><a class="forumlink"  href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
+		<td class="row1" width="100%" height="40"  id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF -->>
+			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
 			<!-- IF { $forumrow:FORUM_DESC } -->
 			<table cellspacing="5" cellpadding="0" border="0">
 				<tr>

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/install/build_tables.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -710,10 +710,10 @@
 $_CLASS['core_db']->table_create('start', $table_prefix.'forums_moderator_cache');
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('username', 50);
-$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('groupname', 50);
+$_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('username', 50, true);
+$_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('group_name', 50, true);
 $_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('forum_id');

Modified: cms/trunk/javascript/collapse.js
===================================================================
--- cms/trunk/javascript/collapse.js	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/javascript/collapse.js	2005-09-15 03:13:58 UTC (rev 123)
@@ -48,19 +48,6 @@
 	document.cookie = cookie_name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
 }
 
-function array_search(needle, haystack, strict)
-{
-	for (var i in haystack)
-	{
-		if (haystack[i] == needle)
-		{
-			return i;
-		}
-	}
-
-	return null;
-}
-
 function switch_collapse(identifier, no_slide, cookie)
 {
 	var area = document.getElementById(identifier);

Modified: cms/trunk/javascript/common.js
===================================================================
--- cms/trunk/javascript/common.js	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/javascript/common.js	2005-09-15 03:13:58 UTC (rev 123)
@@ -72,7 +72,12 @@
 {
 	return this.request.responseText;
 }
-
+
+core_ajax.prototype.state_not_ready = function()
+{
+	return (this.request.readyState < 4);
+}
+
 core_ajax.prototype.state_ready = function()
 {
 	return (this.request.readyState == 4 && this.request.status == 200);

Modified: cms/trunk/javascript/menu.js
===================================================================
--- cms/trunk/javascript/menu.js	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/javascript/menu.js	2005-09-15 03:13:58 UTC (rev 123)
@@ -9,6 +9,10 @@
 *	
 */
 
+// Move this to like a global javascript file
+var is_ie		= (navigator.appName == "Microsoft Internet Explorer");
+var is_gecko	= (navigator.userAgent.indexOf('Gecko') != -1)
+
 var slider_id = new Array();
 var slider_height = new Array();
 var active_menu = false;
@@ -16,9 +20,8 @@
 function get_offsets(element)
 {
 	var offsets = new Array();
-	var window_offset = (window.pageYOffset) ? window.pageYOffset : (document.body.scrollTop) ? document.body.scrollTop : document.documentElement.scrollTop;
 
-	offsets['top']	= Number(window_offset) + element.offsetTop;
+	offsets['top']	= element.offsetTop;
 	offsets['left']	= element.offsetLeft;
 
 	while ((element = element.offsetParent) != null)
@@ -35,7 +38,7 @@
 	var menu		= document.getElementById(object_name + '_menu');
 	var object		= document.getElementById(object_name);
 
-	if (menu == null|| object == null)
+	if (menu == null || object == null)
 	{
 		return;
 	}
@@ -91,8 +94,8 @@
 */
 
 	menu.style.display	= 'none';
-	menu.style.position	= 'absolute';
-	menu.style.zIndex = 1000;
+	menu.style.position	= is_gecko ? 'fixed' : 'absolute';
+	menu.style.zIndex = 1;
 	object.style.cursor = 'pointer';
 }
 
@@ -119,7 +122,13 @@
 
 	menu.style.clip = 'rect(auto, auto, 0px, auto)';
 	menu.style.display	= '';
-	
+
+	if (!is_gecko)
+	{
+		var window_offset = (window.pageYOffset) ? window.pageYOffset : (document.body.scrollTop) ? document.body.scrollTop : document.documentElement.scrollTop;
+		object_offsets['top']	= Number(window_offset) + object_offsets['top'];
+	}
+
 	if ((object_offsets['left'] + menu.offsetWidth) > document.body.clientWidth)
 	{
 		// It to wide to show on the right so we have to put it on the left

Modified: cms/trunk/modules/Forums/admin/index.php
===================================================================
--- cms/trunk/modules/Forums/admin/index.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Forums/admin/index.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -1,7 +1,7 @@
 <?php
 /*
 ||**************************************************************||
-||  Viperal CMS ? :												||
+||  Viperal CMS ?? :												||
 ||**************************************************************||
 ||																||
 ||	Copyright (C) 2004, 2005									||

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -39,7 +39,7 @@
 			die;
 		}
 
-		$title = mb_strtolower(htmlentities($title, ENT_QUOTES, 'UTF-8'));
+		$title = htmlentities($title, ENT_QUOTES, 'UTF-8');
 		$array = array('forum_name' => $title);
 		
 		$_CLASS['core_db']->report_error(false);

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Forums/index.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -23,7 +23,7 @@
 
 $file = get_variable('file', 'REQUEST', false);
 
-$approved_files = array('viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');
+$approved_files = array('ajax', 'viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');
 
 if (!$file || !in_array($file, $approved_files))
 {

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -56,6 +56,10 @@
 	trigger_error('NO_FORUM');
 }
 
+// Configure style, language, etc.
+$_CLASS['core_user']->user_setup();
+$_CLASS['core_user']->add_lang('viewforum');
+
 // Grab appropriate forum data
 if (!$_CLASS['core_user']->is_user)
 {
@@ -63,6 +67,13 @@
 		FROM ' . FORUMS_FORUMS_TABLE . '
 		WHERE forum_id = ' . $forum_id .'
 		AND forum_status <> '.ITEM_DELETING;
+		
+	$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+	
+	if (!is_array($tracking_topics))
+	{
+		$tracking_topics = array();
+	}
 }
 else
 {
@@ -75,12 +86,19 @@
 	else
 	{
 		$sql_lastread = $lastread_select = '';
-		$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+		$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+	
+		if (!is_array($tracking_topics))
+		{
+			$tracking_topics = array();
+		}
 	}
 
 	$sql = "SELECT f.*, fw.notify_status $lastread_select 
 		FROM " . FORUMS_FORUMS_TABLE . ' f LEFT JOIN ' . FORUMS_WATCH_TABLE . ' fw ON (fw.forum_id = f.forum_id AND fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ") $sql_lastread
 		WHERE f.forum_id = $forum_id";
+		
+	unset($sql_lastread, $lastread_select);
 }
 
 $result = $_CLASS['core_db']->query($sql);
@@ -118,10 +136,8 @@
 	redirect(str_replace('&amp;', '&', $forum_data['forum_link']));
 }
 
-// Configure style, language, etc.
-$_CLASS['core_user']->user_setup();
+// Add Images
 $_CLASS['core_user']->add_img();
-$_CLASS['core_user']->add_lang('viewforum');
 
 // Forum is passworded ... check whether access has been granted to this
 // user this session, if not show login box
@@ -137,7 +153,7 @@
 generate_forum_rules($forum_data);
 
 // Do we have subforums?
-$active_forum_ary = $moderators = array();
+$active_forum_ary = array();
 
 if ($forum_data['left_id'] != $forum_data['right_id'] - 1)
 {
@@ -147,361 +163,367 @@
 {
 	$_CLASS['core_template']->assign('S_HAS_SUBFORUM', false);
 }
-get_moderators($moderators, $forum_id);
 
-// Output forum listing if it is postable
-if ($forum_data['forum_type'] == FORUM_POST || ($forum_data['forum_flags'] & 16))
+if ($forum_data['forum_type'] != FORUM_POST && !($forum_data['forum_flags'] & 16))
 {
-	// Handle marking posts
-	if ($mark_read == 'topics')
-	{
-		markread('forum', $forum_id);
-		
-		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id));
+	$_CLASS['core_template']->assign_array(array(
+		'S_IS_POSTABLE'			=> false,
+		'S_DISPLAY_ACTIVE'		=> false,
+		'S_DISPLAY_SEARCHBOX'	=> false,
+		'TOTAL_TOPICS'			=> false
+	));
 
-		$message = $_CLASS['core_user']->lang['TOPICS_MARKED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="' . generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id) . '">', '</a> ');
-		trigger_error($message);
-	}
+	page_header();
+	
+	make_jumpbox(generate_link('Forums&amp;file=viewforum'), $forum_id);
+	
+	$_CLASS['core_template']->display('modules/Forums/viewforum_body.html');
+}
 
-	// Is a forum specific topic count required?
-	if ($forum_data['forum_topics_per_page'])
-	{
-		$config['topics_per_page'] = $forum_data['forum_topics_per_page'];
-	}
+$moderators = get_moderators($forum_id);
 
-	// Do the forum Prune thang - cron type job ...
-	if ($forum_data['prune_next'] < time() && $forum_data['enable_prune'])
-	{
-		require_once($site_file_root.'includes/forums/functions_admin.php');
+// Handle marking posts
+if ($mark_read == 'topics')
+{
+	markread('forum', $forum_id);
+	
+	$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id));
 
-		if ($forum_data['prune_days'])
-		{
-			auto_prune($forum_id, 'posted', $forum_data['forum_flags'], $forum_data['prune_days'], $forum_data['prune_freq']);
-		}
-		if ($forum_data['prune_viewed'])
-		{
-			auto_prune($forum_id, 'viewed', $forum_data['forum_flags'], $forum_data['prune_viewed'], $forum_data['prune_freq']);
-		}
-	}
+	$message = $_CLASS['core_user']->lang['TOPICS_MARKED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="' . generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id) . '">', '</a> ');
+	trigger_error($message);
+}
 
-	if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
+// Is a forum specific topic count required?
+if ($forum_data['forum_topics_per_page'])
+{
+	$config['topics_per_page'] = $forum_data['forum_topics_per_page'];
+}
+
+/*
+Need test this first
+// Do the forum Prune thang - cron type job ...
+if ($forum_data['prune_next'] < time() && $forum_data['enable_prune'])
+{
+	require_once($site_file_root.'includes/forums/functions_admin.php');
+
+	if ($forum_data['prune_days'])
 	{
-		$notify_status = (isset($forum_data['notify_status'])) ? $forum_data['notify_status'] : NULL;
-		$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, 0, $notify_status);
+		auto_prune($forum_id, 'posted', $forum_data['forum_flags'], $forum_data['prune_days'], $forum_data['prune_freq']);
 	}
-	else
+	if ($forum_data['prune_viewed'])
 	{
-		$s_watching_forum['link'] = $s_watching_forum['title'] = '';
+		auto_prune($forum_id, 'viewed', $forum_data['forum_flags'], $forum_data['prune_viewed'], $forum_data['prune_freq']);
 	}
+}
 
-	gen_forum_auth_level('forum', $forum_id);
+*/
 
-	// Topic ordering options
-	$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
+if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
+{
+	$notify_status = (isset($forum_data['notify_status'])) ? $forum_data['notify_status'] : NULL;
+	$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, 0, $notify_status);
+}
+else
+{
+	$s_watching_forum['link'] = $s_watching_forum['title'] = '';
+}
 
-	$sort_by_text = array('a' => $_CLASS['core_user']->lang['AUTHOR'], 't' => $_CLASS['core_user']->lang['POST_TIME'], 'r' => $_CLASS['core_user']->lang['REPLIES'], 's' => $_CLASS['core_user']->lang['SUBJECT'], 'v' => $_CLASS['core_user']->lang['VIEWS']);
-	$sort_by_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'r' => 't.topic_replies', 's' => 't.topic_title', 'v' => 't.topic_views');
+gen_forum_auth_level('forum', $forum_id);
 
-	$sort_key = (!in_array($sort_key, array('a', 't', 'r', 's', 'v'))) ? 't' : $sort_key;
-	
-	$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
-	gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
+// Topic ordering options
+$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
 
-	// Limit topics to certain time frame, obtain correct topic count
-	if ($sort_days)
-	{
-		$min_post_time = time() - ($sort_days * 86400);
+$sort_by_text = array('a' => $_CLASS['core_user']->lang['AUTHOR'], 't' => $_CLASS['core_user']->lang['POST_TIME'], 'r' => $_CLASS['core_user']->lang['REPLIES'], 's' => $_CLASS['core_user']->lang['SUBJECT'], 'v' => $_CLASS['core_user']->lang['VIEWS']);
+$sort_by_sql = array('a' => 't.topic_first_poster_name', 't' => 't.topic_last_post_time', 'r' => 't.topic_replies', 's' => 't.topic_title', 'v' => 't.topic_views');
 
-		$sql = 'SELECT COUNT(topic_id) AS num_topics
-			FROM ' . FORUMS_TOPICS_TABLE . "
-			WHERE forum_id = $forum_id
-				AND topic_type <> " . POST_ANNOUNCE . " 
-				AND topic_last_post_time >= $min_post_time
-			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
-		$result = $_CLASS['core_db']->query($sql);
+$sort_key = (!in_array($sort_key, array('a', 't', 'r', 's', 'v'))) ? 't' : $sort_key;
 
-		if (isset($_POST['sort']))
-		{
-			$start = 0;
-		}
+$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
+gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
 
-		$topics_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_topics'] : 0;
-		$sql_limit_time = "AND t.topic_last_post_time >= $min_post_time";
+// Limit topics to certain time frame, obtain correct topic count
+if ($sort_days)
+{
+	$min_post_time = time() - ($sort_days * 86400);
+
+	$sql = 'SELECT COUNT(topic_id) AS num_topics
+		FROM ' . FORUMS_TOPICS_TABLE . "
+		WHERE forum_id = $forum_id
+			AND topic_type <> " . POST_ANNOUNCE . " 
+			AND topic_last_post_time >= $min_post_time
+		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
+	$result = $_CLASS['core_db']->query($sql);
+
+	if (isset($_POST['sort']))
+	{
+		$start = 0;
 	}
+
+	$topics_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_topics'] : 0;
+	$sql_limit_time = "AND t.topic_last_post_time >= $min_post_time";
+}
+else
+{
+	if ($_CLASS['auth']->acl_get('m_approve', $forum_id))
+	{
+		$topics_count = ($forum_data['forum_topics_real']) ? $forum_data['forum_topics_real'] : 1;
+	}
 	else
 	{
-		if ($_CLASS['auth']->acl_get('m_approve', $forum_id))
-		{
-			$topics_count = ($forum_data['forum_topics_real']) ? $forum_data['forum_topics_real'] : 1;
-		}
-		else
-		{
-			$topics_count = ($forum_data['forum_topics']) ? $forum_data['forum_topics'] : 1;
-		}
-
-		$sql_limit_time = '';
+		$topics_count = ($forum_data['forum_topics']) ? $forum_data['forum_topics'] : 1;
 	}
 
-	// Basic pagewide vars
-	$post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->lang['FORUM_LOCKED'] : $_CLASS['core_user']->lang['POST_NEW_TOPIC'];
-	$pagination = generate_pagination("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param", $topics_count, $config['topics_per_page'], $start);
+	$sql_limit_time = '';
+}
 
-	$_CLASS['core_template']->assign_array(array(
-		'PAGINATION'		=> $pagination['formated'],
-		'PAGINATION_ARRAY'	=> $pagination['array'],
-		'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
-		'TOTAL_TOPICS'		=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
-		'MODERATORS'		=> (!empty($moderators[$forum_id])) ? implode(', ', $moderators[$forum_id]) : '',
+// Basic pagewide vars
+$post_alt = ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->lang['FORUM_LOCKED'] : $_CLASS['core_user']->lang['POST_NEW_TOPIC'];
+$pagination = generate_pagination("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param", $topics_count, $config['topics_per_page'], $start);
 
-		'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
-		'FOLDER_IMG' 			=> $_CLASS['core_user']->img('folder', 'NO_NEW_POSTS'),
-		'FOLDER_NEW_IMG' 		=> $_CLASS['core_user']->img('folder_new', 'NEW_POSTS'),
-		'FOLDER_HOT_IMG' 		=> $_CLASS['core_user']->img('folder_hot', 'NO_NEW_POSTS_HOT'),
-		'FOLDER_HOT_NEW_IMG'	=> $_CLASS['core_user']->img('folder_hot_new', 'NEW_POSTS_HOT'),
-		'FOLDER_LOCKED_IMG' 	=> $_CLASS['core_user']->img('folder_locked', 'NO_NEW_POSTS_LOCKED'),
-		'FOLDER_LOCKED_NEW_IMG' => $_CLASS['core_user']->img('folder_locked_new', 'NEW_POSTS_LOCKED'),
-		'FOLDER_STICKY_IMG' 	=> $_CLASS['core_user']->img('folder_sticky', 'POST_STICKY'),
-		'FOLDER_STICKY_NEW_IMG' => $_CLASS['core_user']->img('folder_sticky_new', 'POST_STICKY'),
-		'FOLDER_ANNOUNCE_IMG' 	=> $_CLASS['core_user']->img('folder_announce', 'POST_ANNOUNCEMENT'),
-		'FOLDER_ANNOUNCE_NEW_IMG'=> $_CLASS['core_user']->img('folder_announce_new', 'POST_ANNOUNCEMENT'),
-		'FOLDER_MOVED_IMG'		=> $_CLASS['core_user']->img('folder_moved', 'TOPIC_MOVED'),
+$_CLASS['core_template']->assign_array(array(
+	'PAGINATION'		=> $pagination['formated'],
+	'PAGINATION_ARRAY'	=> $pagination['array'],
+	'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
+	'TOTAL_TOPICS'		=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
+	'MODERATORS'		=> empty($moderators[$forum_id]) ? '' : implode(', ', $moderators[$forum_id]),
 
-		'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
-		'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', 'TOPIC_UNAPPROVED'),
-		'GOTO_PAGE_IMG'			=> $_CLASS['core_user']->img('icon_post', 'GOTO_PAGE'),
-		'L_NO_TOPICS' 			=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->lang['POST_FORUM_LOCKED'] : $_CLASS['core_user']->lang['NO_TOPICS'],
+	'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
+	'FOLDER_IMG' 			=> $_CLASS['core_user']->img('folder', 'NO_NEW_POSTS'),
+	'FOLDER_NEW_IMG' 		=> $_CLASS['core_user']->img('folder_new', 'NEW_POSTS'),
+	'FOLDER_HOT_IMG' 		=> $_CLASS['core_user']->img('folder_hot', 'NO_NEW_POSTS_HOT'),
+	'FOLDER_HOT_NEW_IMG'	=> $_CLASS['core_user']->img('folder_hot_new', 'NEW_POSTS_HOT'),
+	'FOLDER_LOCKED_IMG' 	=> $_CLASS['core_user']->img('folder_locked', 'NO_NEW_POSTS_LOCKED'),
+	'FOLDER_LOCKED_NEW_IMG' => $_CLASS['core_user']->img('folder_locked_new', 'NEW_POSTS_LOCKED'),
+	'FOLDER_STICKY_IMG' 	=> $_CLASS['core_user']->img('folder_sticky', 'POST_STICKY'),
+	'FOLDER_STICKY_NEW_IMG' => $_CLASS['core_user']->img('folder_sticky_new', 'POST_STICKY'),
+	'FOLDER_ANNOUNCE_IMG' 	=> $_CLASS['core_user']->img('folder_announce', 'POST_ANNOUNCEMENT'),
+	'FOLDER_ANNOUNCE_NEW_IMG'=> $_CLASS['core_user']->img('folder_announce_new', 'POST_ANNOUNCEMENT'),
+	'FOLDER_MOVED_IMG'		=> $_CLASS['core_user']->img('folder_moved', 'TOPIC_MOVED'),
 
-		'S_IS_POSTABLE'			=> ($forum_data['forum_type'] == FORUM_POST) ? true : false,
-		'S_DISPLAY_ACTIVE'		=> ($forum_data['forum_type'] == FORUM_CAT && $forum_data['forum_flags'] & 16) ? true : false, 
-		'S_SELECT_SORT_DIR'		=> $s_sort_dir,
-		'S_SELECT_SORT_KEY'		=> $s_sort_key,
-		'S_SELECT_SORT_DAYS'	=> $s_limit_days,
-		'S_TOPIC_ICONS'			=> ($forum_data['forum_type'] == FORUM_CAT && $forum_data['forum_flags'] & 16) ? max($active_forum_ary['enable_icons']) : (($forum_data['enable_icons']) ? true : false), 
-		'S_WATCH_FORUM_LINK'	=> $s_watching_forum['link'],
-		'S_WATCH_FORUM_TITLE'	=> $s_watching_forum['title'],
-		'S_FORUM_ACTION' 		=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;start=$start"),
-		'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
-		'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
+	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
+	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', 'TOPIC_UNAPPROVED'),
+	'GOTO_PAGE_IMG'			=> $_CLASS['core_user']->img('icon_post', 'GOTO_PAGE'),
+	'L_NO_TOPICS' 			=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->lang['POST_FORUM_LOCKED'] : $_CLASS['core_user']->lang['NO_TOPICS'],
 
- 		'U_MCP' 			=> ($_CLASS['auth']->acl_gets('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
-		'U_POST_NEW_TOPIC'	=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id), 
-		'U_VIEW_FORUM'		=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&amp;start=$start"), 
-		'U_MARK_TOPICS' 	=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;mark=topics"))
-	);
+	'S_IS_POSTABLE'			=> ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+	'S_DISPLAY_ACTIVE'		=> ($forum_data['forum_type'] == FORUM_CAT && $forum_data['forum_flags'] & 16) ? true : false, 
+	'S_SELECT_SORT_DIR'		=> $s_sort_dir,
+	'S_SELECT_SORT_KEY'		=> $s_sort_key,
+	'S_SELECT_SORT_DAYS'	=> $s_limit_days,
+	'S_TOPIC_ICONS'			=> ($forum_data['forum_type'] == FORUM_CAT && $forum_data['forum_flags'] & 16) ? max($active_forum_ary['enable_icons']) : (($forum_data['enable_icons']) ? true : false), 
+	'S_WATCH_FORUM_LINK'	=> $s_watching_forum['link'],
+	'S_WATCH_FORUM_TITLE'	=> $s_watching_forum['title'],
+	'S_FORUM_ACTION' 		=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;start=$start"),
+	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
+	'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	// Grab icons
-	$icons = obtain_icons();
+	'U_MCP' 			=> ($_CLASS['auth']->acl_gets('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
+	'U_POST_NEW_TOPIC'	=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id), 
+	'U_VIEW_FORUM'		=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&amp;start=$start"), 
+	'U_MARK_TOPICS' 	=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;mark=topics"))
+);
 
-	// Grab all topic data
-	$rowset = $announcement_list = $topic_list = array();
+// Grab icons
+$icons = obtain_icons();
 
-	$sql_from = FORUMS_TOPICS_TABLE.' t ';
-	$sql_select = '';
+// Grab all topic data
+$rowset = $announcement_list = $topic_list = array();
 
-	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
-	{
-		$sql_from .= ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
-		$sql_select .= ', tt.mark_time';
-	}
+$sql_from = FORUMS_TOPICS_TABLE.' t ';
+$sql_select = '';
 
-	$sql_approved = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
+if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
+{
+	$sql_from .= ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+	$sql_select .= ', tt.mark_time';
+}
 
-	if ($forum_data['forum_type'] == FORUM_POST)
+$sql_approved = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
+
+if ($forum_data['forum_type'] == FORUM_POST)
+{
+	// Obtain announcements ... removed sort ordering, sort by time in all cases
+	$sql = "SELECT DISTINCT t.* $sql_select 
+		FROM $sql_from 
+		WHERE t.forum_id IN ($forum_id, 0)
+			AND t.topic_type IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ')
+		ORDER BY t.topic_time DESC';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		// Obtain announcements ... removed sort ordering, sort by time in all cases
-		$sql = "SELECT DISTINCT t.* $sql_select 
-			FROM $sql_from 
-			WHERE t.forum_id IN ($forum_id, 0)
-				AND t.topic_type IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ')
-			ORDER BY t.topic_time DESC';
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$rowset[$row['topic_id']] = $row;
-			$announcement_list[] = $row['topic_id'];
-		}
-		$_CLASS['core_db']->free_result($result);
+		$rowset[$row['topic_id']] = $row;
+		$announcement_list[] = $row['topic_id'];
 	}
+	$_CLASS['core_db']->free_result($result);
+}
 
-	// If the user is trying to reach late pages, start searching from the end
-	$store_reverse = false;
-	$sql_limit = $config['topics_per_page'];
+// If the user is trying to reach late pages, start searching from the end
+$store_reverse = false;
+$sql_limit = $config['topics_per_page'];
 
 // what's this store_reverse all about ?
-	if ($start > $topics_count / 2)
+if ($start > $topics_count / 2)
+{
+	$store_reverse = true;
+
+	if ($start + $config['topics_per_page'] > $topics_count)
 	{
-		$store_reverse = true;
+		$sql_limit = min($config['topics_per_page'], max(1, $topics_count - $start));
+	}
 
-		if ($start + $config['topics_per_page'] > $topics_count)
-		{
-			$sql_limit = min($config['topics_per_page'], max(1, $topics_count - $start));
-		}
+	// Select the sort order
+	$sql_sort_order = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'ASC' : 'DESC');
+	$sql_start = max(0, $topics_count - $sql_limit - $start);
+}
+else
+{
+	// Select the sort order
+	$sql_sort_order = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
+	$sql_start = $start;
+}
 
-		// Select the sort order
-		$sql_sort_order = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'ASC' : 'DESC');
-		$sql_start = max(0, $topics_count - $sql_limit - $start);
+// Obtain other topics
+$sql_where = ($forum_data['forum_type'] == FORUM_POST || empty($active_forum_ary)) ? "= $forum_id" : 'IN (' . implode(', ', $active_forum_ary['forum_id']) . ')';
+$sql = "SELECT t.* $sql_select
+	FROM $sql_from
+	WHERE t.forum_id $sql_where
+		AND t.topic_type NOT IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ") 
+		$sql_approved 
+		$sql_limit_time
+	ORDER BY t.topic_type " . ((!$store_reverse) ? 'DESC' : 'ASC') . ', ' . $sql_sort_order;
+$result = $_CLASS['core_db']->query_limit($sql, $sql_limit, $sql_start);
+
+while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$rowset[$row['topic_id']] = $row;
+	$topic_list[] = $row['topic_id'];
+}
+$_CLASS['core_db']->free_result($result);
+
+$topic_list = ($store_reverse) ? array_merge($announcement_list, array_reverse($topic_list)) : array_merge($announcement_list, $topic_list);
+
+// we only update the mark if this is made into an (int) time
+// We don't check when $start is used
+$mark_forum_read = ($sql_start || $sql_limit != $config['topics_per_page'] || $sql_limit_time) ? false : true;
+
+// Okay, lets dump out the page ...
+if (!empty($topic_list))
+{
+	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
+	{
+		$mark_time_forum = $forum_data['mark_time'];
 	}
 	else
 	{
-		// Select the sort order
-		$sql_sort_order = $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
-		$sql_start = $start;
+		$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
+		$mark_time_forum = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
 	}
 
-	// Obtain other topics
-	$sql_where = ($forum_data['forum_type'] == FORUM_POST || empty($active_forum_ary)) ? "= $forum_id" : 'IN (' . implode(', ', $active_forum_ary['forum_id']) . ')';
-	$sql = "SELECT t.* $sql_select
-		FROM $sql_from
-		WHERE t.forum_id $sql_where
-			AND t.topic_type NOT IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ") 
-			$sql_approved 
-			$sql_limit_time
-		ORDER BY t.topic_type " . ((!$store_reverse) ? 'DESC' : 'ASC') . ', ' . $sql_sort_order;
-	$result = $_CLASS['core_db']->query_limit($sql, $sql_limit, $sql_start);
-
-	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	$s_type_switch = 0;
+	foreach ($topic_list as $topic_id)
 	{
-		$rowset[$row['topic_id']] = $row;
-		$topic_list[] = $row['topic_id'];
-	}
-	$_CLASS['core_db']->free_result($result);
+		$row =& $rowset[$topic_id];
 
-	$topic_list = ($store_reverse) ? array_merge($announcement_list, array_reverse($topic_list)) : array_merge($announcement_list, $topic_list);
-
-	// we only update the mark if this is made into an (int) time
-	// We don't check when $start is used
-	$mark_forum_read = ($sql_start || $sql_limit != $config['topics_per_page'] || $sql_limit_time) ? false : true;
-
-	// Okay, lets dump out the page ...
-	if (!empty($topic_list))
-	{
-		if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
+		if ($config['load_db_lastread'] && $_CLASS['core_user']->is_user)
 		{
-			$mark_time_forum = $forum_data['mark_time'];
+			$mark_time_topic = $row['mark_time'];
 		}
 		else
 		{
-			$mark_time_forum = (isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+			$topic_id36 = base_convert($topic_id, 10, 36);
+			$mark_time_topic = isset($tracking_topics[$forum_id36][$topic_id36]) ? (int) base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) : 0;
 		}
 
-		$s_type_switch = 0;
-		foreach ($topic_list as $topic_id)
+		/*
+			Is the topic mark time that greater than the forums mark time ? 
+				If so, check to see if the topic has any new post/or another topic had a new post.
+					Set $mark_forum_read to the highest topic_last_post_time if there's no new posts
+		*/
+		if (!$mark_time_forum || ($mark_time_forum < $mark_time_topic))
 		{
-			$row =& $rowset[$topic_id];
-
-			if ($config['load_db_lastread'] && $_CLASS['core_user']->is_user)
+			if ($mark_forum_read)
 			{
-				$mark_time_topic = $row['mark_time'];
+				$mark_forum_read = ($row['topic_last_post_time'] < $mark_time_topic) ? (int) $mark_time_topic : false;
 			}
-			else
-			{
-				$topic_id36 = base_convert($topic_id, 10, 36);
-				$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : $forum_id;
-				$mark_time_topic = (isset($tracking_topics[$forum_id36][$topic_id36])) ? base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
-			
-			}
+			$mark_time = $mark_time_topic;
+		}
+		else
+		{
+			$mark_time = $mark_time_forum;
+		}
 
-			/*
-				Is the topic mark time that greater than the forums mark time ? 
-					If so, check to see if the topic has any new post/or another topic had a new post.
-						Set $mark_forum_read to the highest topic_last_post_time if there's no new posts
-			*/
-			if (!$mark_time_forum || ($mark_time_forum < $mark_time_topic))
-			{
-				if ($mark_forum_read)
-				{
-					$mark_forum_read = ($row['topic_last_post_time'] <= $mark_time_topic) ? (int) $mark_time_topic : false;
-				}
-				$mark_time = $mark_time_topic;
-			}
-			else
-			{
-				$mark_time = $mark_time_forum;
-			}
+		// This will allow the style designer to output a different header
+		// or even seperate the list of announcements from sticky and normal
+		// topics
+		$s_type_switch_test = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
 
-			// This will allow the style designer to output a different header
-			// or even seperate the list of announcements from sticky and normal
-			// topics
-			$s_type_switch_test = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
+		// Replies
+		$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
 
-			// Replies
-			$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
+		if ($row['topic_status'] == ITEM_MOVED)
+		{
+			$topic_id = $row['topic_moved_id'];
+		}
 
-			if ($row['topic_status'] == ITEM_MOVED)
-			{
-				$topic_id = $row['topic_moved_id'];
-			}
- 
-			// Get folder img, topic status/type related informations
-			$folder_img = $folder_alt = $topic_type = '';
-			$unread_topic = topic_status($row, $replies, $mark_time, $folder_img, $folder_alt, $topic_type);
-			
-			$newest_post_img = ($unread_topic) ? '<a href="' . generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread") . '">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
+		// Get folder img, topic status/type related informations
+		$folder_img = $folder_alt = $topic_type = '';
+		$unread_topic = topic_status($row, $replies, $mark_time, $folder_img, $folder_alt, $topic_type);
+		
+		$newest_post_img = ($unread_topic) ? '<a href="' . generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread") . '">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-			// Generate all the URIs ...
-			$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
+		// Generate all the URIs ...
+		$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
 
-			$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
+		$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
 
-			// Send vars to template
-			$_CLASS['core_template']->assign_vars_array('topicrow', array(
-				'FORUM_ID' 			=> $forum_id,
-				'TOPIC_ID' 			=> $topic_id,
-				'TOPIC_AUTHOR' 		=> topic_topic_author($row),
-				'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
-				'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
-				'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-				'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-				'PAGINATION'		=> $pagination['formated'],
-				'PAGINATION_ARRAY'	=> $pagination['array'],
-				'REPLIES' 			=> $replies,
-				'VIEWS' 			=> (int) $row['topic_views'],
-				'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
-				'TOPIC_TYPE' 		=> $topic_type,
+		// Send vars to template
+		$_CLASS['core_template']->assign_vars_array('topicrow', array(
+			'FORUM_ID' 			=> $forum_id,
+			'TOPIC_ID' 			=> $topic_id,
+			'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+			'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
+			'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
+			'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
+			'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+			'PAGINATION'		=> $pagination['formated'],
+			'PAGINATION_ARRAY'	=> $pagination['array'],
+			'REPLIES' 			=> $replies,
+			'VIEWS' 			=> (int) $row['topic_views'],
+			'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
+			'TOPIC_TYPE' 		=> $topic_type,
 
-				'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
-				'NEWEST_POST_IMG' 	=> $newest_post_img,
-				'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-				//'TOPIC_FOLDER_IMG_SRC'	=> $_CLASS['core_user']->img($folder_img, $folder_alt, false, '', 'src'),
-				'TOPIC_ICON_IMG'        => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
-				'TOPIC_ICON_IMG_WIDTH'  => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
-				'TOPIC_ICON_IMG_HEIGHT' => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
-				'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+			'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
+			'NEWEST_POST_IMG' 	=> $newest_post_img,
+			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
+			//'TOPIC_FOLDER_IMG_SRC'	=> $_CLASS['core_user']->img($folder_img, $folder_alt, false, '', 'src'),
+			'TOPIC_ICON_IMG'        => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
+			'TOPIC_ICON_IMG_WIDTH'  => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
+			'TOPIC_ICON_IMG_HEIGHT' => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
+			'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 
-				'S_TOPIC_TYPE'			=> $row['topic_type'], 
-				'S_UNREAD_TOPIC'		=> $unread_topic,
+			'S_TOPIC_TYPE'			=> $row['topic_type'], 
+			'S_UNREAD_TOPIC'		=> $unread_topic,
 
-				'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_gets('m_', $forum_id)) ? true : false,
-				'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_gets('m_approve', $forum_id)) ? true : false,
+			'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_gets('m_', $forum_id)) ? true : false,
+			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_gets('m_approve', $forum_id)) ? true : false,
 
-				'U_LAST_POST'       => generate_link($view_topic_url . $SID . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false, false, false),	
-				'U_LAST_POST_AUTHOR'=> ($_CLASS['core_user']->is_user && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-				'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
-				'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;mode=reports&amp;t=$topic_id"),
-				'U_MCP_QUEUE'       => generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
-				'S_TOPIC_TYPE_SWITCH'   => ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
-			);
+			'U_LAST_POST'       => generate_link($view_topic_url . $SID . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false, false, false),	
+			'U_LAST_POST_AUTHOR'=> ($_CLASS['core_user']->is_user && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+			'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
+			'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;mode=reports&amp;t=$topic_id"),
+			'U_MCP_QUEUE'       => generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
+			'S_TOPIC_TYPE_SWITCH'   => ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
+		);
 
-			$s_type_switch = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
-		}
+		$s_type_switch = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
 	}
+}
 
-	// Update the marktime only if $mark_forum_read is set to a time
-	if ($forum_data['forum_type'] == FORUM_POST && is_int($mark_forum_read))
-	{
-		markread('forum', $forum_id, false, $mark_forum_read);
-	}
-}
-else
+// Update the marktime only if $mark_forum_read is set to a time
+if ($forum_data['forum_type'] == FORUM_POST && is_int($mark_forum_read))
 {
-	$_CLASS['core_template']->assign_array(array(
-		'S_IS_POSTABLE'			=> false,
-		'S_DISPLAY_ACTIVE'		=> false,
-		'S_DISPLAY_SEARCHBOX'	=> false,
-		'TOTAL_TOPICS'			=> false
-	));
-
+	markread('forum', $forum_id, false, $mark_forum_read);
 }
 
 page_header();

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -170,7 +170,8 @@
 	f.forum_id, f.forum_password, f.forum_rules, f.forum_rules_link, f.forum_rules_flags, f.forum_rules_bbcode_uid,
 	f.forum_rules_bbcode_bitfield' . $extra_fields . '
 		FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . " t  $join_sql_table 
-		WHERE t.topic_id = $topic_id";
+		WHERE t.topic_id = $topic_id
+		AND f.forum_id = $forum_id";
 
 $result = $_CLASS['core_db']->query($sql);
 $topic_data = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -1246,22 +1247,43 @@
 // Mark topics read
 if ($update_mark)
 {
-	// Now lets get the all topics that are in the markable range,
-	// with is the max topics displayed on the forum's viewforum page
+	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
+	{
+		// Now lets get the all topics that are in the markable range,
+		// with is the max topics displayed on the forum's viewforum page
 
-	// Get the user's last mark time for this forums
-	$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
-		WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-			AND forum_id = $forum_id AND topic_id = 0";
+		// Get the user's last mark time for this forums
+// add user view options
+		$sql = 'SELECT mark_time FROM '.FORUMS_TRACK_TABLE . ' 
+			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . " 
+				AND forum_id = $forum_id AND topic_id = 0";
+	
+		$result = $_CLASS['core_db']->query($sql);
+		$mark_time_forum = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['mark_time'] : 0;
+		$_CLASS['core_db']->free_result($result);
+			
+		$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . FORUMS_TOPICS_TABLE . ' t
+				LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON (tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
+					WHERE t.forum_id = $forum_id
+						ORDER BY t.topic_last_post_time DESC";
+	}
+	else
+	{
+		$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 
-	$result = $_CLASS['core_db']->query($sql);
-	$forum_marktime = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['mark_time'] : 0;
-	$_CLASS['core_db']->free_result($result);
+		if (!is_array($tracking))
+		{
+			$tracking = array();
+		}
 		
-	$sql = 'SELECT t.topic_id, t.topic_last_post_time, tr.mark_time FROM ' . FORUMS_TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tr ON (tr.topic_id = t.topic_id AND tr.user_id = '.$_CLASS['core_user']->data['user_id'].")
-				WHERE t.forum_id = $forum_id
+		$forum_id36 = base_convert($forum_id, 10, 36);
+		$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
+
+// add user view options
+		$sql = 'SELECT topic_id, topic_last_post_time FROM ' . FORUMS_TOPICS_TABLE . "
+					WHERE forum_id = $forum_id
 					ORDER BY topic_last_post_time DESC";
+	}
 
 	$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page']);
 	$update_forum_mark = true;
@@ -1271,16 +1293,23 @@
 		// DESC order so the first post is the last post
 		$last_forum_post = $row['topic_last_post_time'];
 
+// add user view options
 		do
 		{
-			$last_mark_time = max($row['mark_time'], $forum_marktime);
+			if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
+			{
+				$topic_id36 = base_convert($topic_id, 10, 36);
+				$row['mark_time'] = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+			}
 
+			$last_mark_time = max($row['mark_time'], $mark_time_forum);
+
 			if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
 			{
 				// We have a winner/loser
 				// Set so the forum isn't marked
 				$update_forum_mark = false;
-
+echo 'test';
 				break;
 			}
 		}
@@ -1336,23 +1365,30 @@
 	}
 	else
 	{
-		$topic_last_read = 0;
+		$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 
-		if (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']))
+		if (!is_array($tracking))
 		{
-			$tracking_topics = unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']));
+			return 0;
+		}
 
-			if (isset($tracking_topics[$forum_id]))
-			{
-				$topic_last_read = base_convert(max($tracking_topics[$forum_id]), 36, 10);
-				$topic_last_read = max($topic_last_read, $_CLASS['core_user']->data['session_last_visit']);
-			}
+		$forum_id36 = base_convert($forum_id, 10, 36);
+		$topic_id36 = base_convert($topic_id, 10, 36);
 
-			unset($tracking_topics);
+		$topic_last_read = $forum_last_read = 0;
+
+		if (isset($tracking[$forum_id36][0]))
+		{
+			$forum_last_read = (int) base_convert($tracking[$forum_id36][0], 36, 10);
 		}
+
+		if (isset($tracking[$forum_id36][$topic_id36]))
+		{
+			$topic_last_read = (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10);
+		}
+
+		return (int) max($forum_last_read, $topic_last_read);
 	}
-
-	return $topic_last_read;
 }
 
 ?>
\ No newline at end of file

Copied: cms/trunk/modules/Quick_Message/configurator.php (from rev 108, cms/trunk/modules/Quick_Message/install.php)

Deleted: cms/trunk/modules/Quick_Message/install.php
===================================================================
--- cms/trunk/modules/Quick_Message/install.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/Quick_Message/install.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -1,91 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ?? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $table_prefix;
-
-if (!defined('QUICK_MESSAGE_TABLE'))
-{
-	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
-}
-
-class Quick_Message_install
-{
-	function install()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->table_create('start', QUICK_MESSAGE_TABLE);
-		
-		$_CLASS['core_db']->add_table_field_int('message_id', array('max' => 16000000, 'auto_increment' => true));
-		$_CLASS['core_db']->add_table_field_text('message_text', 200);
-		$_CLASS['core_db']->add_table_field_int('message_time', array('max' => 200000000));
-		$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
-		$_CLASS['core_db']->add_table_field_char('poster_name', 80);
-		$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
-		
-		$_CLASS['core_db']->add_table_index('message_id', 'primary');
-		$_CLASS['core_db']->add_table_index('message_time');
-		
-		$_CLASS['core_db']->table_create('commit');
-		
-		// use set config ?
-		set_core_config('quick_message', 'anonymous_posting', 2, false, true);
-		set_core_config('quick_message', 'delete_time', 300, false, true);
-		set_core_config('quick_message', 'height', 200, false, true);
-		set_core_config('quick_message', 'last_post_check', 150, false, true);
-		set_core_config('quick_message', 'length_max', 150, false, true);
-
-		$_CLASS['core_cache']->destroy('core_config');
-
-		$array = array(
-			'message_text'	=> 'Lets do this !',
-			'message_time'	=> (int) $_CLASS['core_user']->time,
-			'poster_id'		=> 0,
-			'poster_name'	=> (string) '',
-			'poster_ip'		=> (string) ''
-		);
-
-		$_CLASS['core_db']->query('INSERT INTO ' . QUICK_MESSAGE_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
-
-		return true;
-	}
-
-	function uninstall()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->report_error(false);
-
-		$_CLASS['core_db']->query('DROP TABLE ' . QUICK_MESSAGE_TABLE);
-		$_CLASS['core_db']->query('DELETE FROM ' . CORE_CONFIG_TABLE . " WHERE config_section = 'quick_message'");
-
-		$_CLASS['core_db']->report_error(true);
-	}
-}
-
-?>
\ No newline at end of file

Copied: cms/trunk/modules/articles/configurator.php (from rev 108, cms/trunk/modules/articles/install.php)

Deleted: cms/trunk/modules/articles/install.php
===================================================================
--- cms/trunk/modules/articles/install.php	2005-09-14 00:12:31 UTC (rev 122)
+++ cms/trunk/modules/articles/install.php	2005-09-15 03:13:58 UTC (rev 123)
@@ -1,103 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ?? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-if (!defined('VIPERAL'))
-{
-    die;
-}
-
-global $prefix;
-
-if (!defined('ARTICLES_TABLE'))
-{
-	define('ARTICLES_TABLE', $table_prefix.'articles');
-}
-
-class articles_install
-{
-	var $error = array();
-	
-	function install()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->table_create('start', ARTICLES_TABLE);
-		
-		$_CLASS['core_db']->add_table_field_int('articles_id', array('max' => 16000000, 'auto_increment' => true));
-		$_CLASS['core_db']->add_table_field_char('articles_title', 80);
-		$_CLASS['core_db']->add_table_field_int('articles_posted', array('max' => 200000000));
-		$_CLASS['core_db']->add_table_field_int('articles_starts', array('max' => 200000000, 'null' => true));
-		$_CLASS['core_db']->add_table_field_int('articles_expires', array('max' => 200000000, 'null' => true));
-		$_CLASS['core_db']->add_table_field_text('articles_intro', 60000, true);
-		$_CLASS['core_db']->add_table_field_text('articles_text', 10000000);
-		$_CLASS['core_db']->add_table_field_text('articles_notes', 60000, true);
-
-		$_CLASS['core_db']->add_table_field_int('articles_order', array('max' => 16000000));
-		$_CLASS['core_db']->add_table_field_int('articles_type', array('max' => 10));
-		$_CLASS['core_db']->add_table_field_int('articles_status', array('max' => 10));
-		$_CLASS['core_db']->add_table_field_text('articles_auth', 60000, true);
-
-		$_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
-		$_CLASS['core_db']->add_table_field_char('poster_name', 80, true);
-		$_CLASS['core_db']->add_table_field_char('poster_ip', 18);
-		$_CLASS['core_db']->add_table_field_char('approver_id', 18, true);
-		$_CLASS['core_db']->add_table_field_char('approver_name', 80, true);
-
-		$_CLASS['core_db']->add_table_index('articles_id', 'primary');
-		$_CLASS['core_db']->add_table_index('articles_starts');
-		$_CLASS['core_db']->add_table_index('articles_expires');
-		//$_CLASS['core_db']->add_table_index('articles_type');
-		$_CLASS['core_db']->add_table_index('articles_order');
-		$_CLASS['core_db']->add_table_index('articles_status');
-
-		$_CLASS['core_db']->table_create('commit');
-
-		$array = array(
-			'articles_title'	=> 'Welcome Post',
-			'articles_posted'	=> (int) $_CLASS['core_user']->time,
-			'articles_text'		=> '<p align="center">I need something snappy here</p>',
-			'articles_order'	=> 1,
-			'articles_type'		=> 1,
-			'articles_status'	=> STATUS_ACTIVE,
-			'poster_id'			=> 0,
-			'poster_ip'			=> (string) ''
-		);
-
-		$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
-
-		return true;
-	}
-
-	function uninstall()
-	{
-		global $_CLASS;
-
-		$_CLASS['core_db']->report_error(false);
-
-		$_CLASS['core_db']->query('DROP TABLE ' . ARTICLES_TABLE);
-
-		$_CLASS['core_db']->report_error(true);
-	}
-}
-
-?>
\ No newline at end of file



From viperal at berlios.de  Thu Sep 15 05:20:42 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 15 Sep 2005 05:20:42 +0200
Subject: [Viperals-svncheckins] r124 - in cms/trunk/modules: Quick_Message articles
Message-ID: <200509150320.j8F3Kgmj030387@sheep.berlios.de>

Author: viperal
Date: 2005-09-15 05:20:21 +0200 (Thu, 15 Sep 2005)
New Revision: 124

Modified:
   cms/trunk/modules/Quick_Message/configurator.php
   cms/trunk/modules/articles/configurator.php
Log:


Modified: cms/trunk/modules/Quick_Message/configurator.php
===================================================================
--- cms/trunk/modules/Quick_Message/configurator.php	2005-09-15 03:13:58 UTC (rev 123)
+++ cms/trunk/modules/Quick_Message/configurator.php	2005-09-15 03:20:21 UTC (rev 124)
@@ -33,7 +33,7 @@
 	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
 
-class Quick_Message_install
+class Quick_Message_configurator
 {
 	function install()
 	{

Modified: cms/trunk/modules/articles/configurator.php
===================================================================
--- cms/trunk/modules/articles/configurator.php	2005-09-15 03:13:58 UTC (rev 123)
+++ cms/trunk/modules/articles/configurator.php	2005-09-15 03:20:21 UTC (rev 124)
@@ -33,7 +33,7 @@
 	define('ARTICLES_TABLE', $table_prefix.'articles');
 }
 
-class articles_install
+class articles_configurator
 {
 	var $error = array();
 	



From viperal at berlios.de  Thu Sep 15 21:09:51 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 15 Sep 2005 21:09:51 +0200
Subject: [Viperals-svncheckins] r125 - in cms/trunk: . blocks includes includes/auth includes/forums includes/forums/admin install javascript javascript/forums modules/Control_Panel/ucp modules/Forums modules/Quick_Message themes/viperal/template
Message-ID: <200509151909.j8FJ9plV025104@sheep.berlios.de>

Author: viperal
Date: 2005-09-15 21:09:49 +0200 (Thu, 15 Sep 2005)
New Revision: 125

Added:
   cms/trunk/includes/forums/functions_profile_fields.php
   cms/trunk/javascript/quick_messages.js
   cms/trunk/modules/Quick_Message/functions.php
Removed:
   cms/trunk/includes/forums/admin/admin_ban.php
   cms/trunk/themes/viperal/template/message.html
Modified:
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/forums/admin/admin_attachments.php
   cms/trunk/includes/forums/admin/admin_board.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/tables.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/javascript/forums/forum_view.js
   cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
   cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
   cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
   cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
   cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php
   cms/trunk/modules/Forums/download.php
   cms/trunk/modules/Quick_Message/index.php
Log:
Just something to test ajax on quick message module ( will change when a ajax frontend is done )
Some other fixes

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -21,83 +21,27 @@
 $Id$
 */
 
+// Convert to template
 if (!defined('VIPERAL'))
 {
     die;
 }
 
-global $table_prefix;
+global $table_prefix, $site_file_root, $_CORE_CONFIG;
 
+/*
 if (!defined('QUICK_MESSAGE_TABLE'))
 {
 	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
 }
+*/
 
-global $prefix, $_CLASS, $_CORE_CONFIG;
+require_once($site_file_root.'modules/Quick_Message/functions.php');
 
-$this->content = '<div style="width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;">';
+$this->content = '<div id="qm_block">'.qm_block_content().'</div>';
 
-$result = $_CLASS['core_db']->query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
+$this->content .= '<script type="text/javascript" src="javascript/quick_messages.js"></script><div align="center"><a href="'.generate_link('Quick_Message').'">Message History</a><br />';
 
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-	/*
-		php 4 doesn't support mb html_entity_decode :-(
-		Make a core function for this
-	*/
-	//$words_array = explode(' ',html_entity_decode($row['message_text'], ENT_QUOTES, 'UTF-8'));
-	$words_array = explode(' ', $row['message_text']);
-
-	$row['message_text'] = '';
-
-    foreach($words_array as $words)
-    {
-		if (substr($words, 0, 4) != '[url')
-		{
-			$row['message_text'] .= ' '.wordwrap($words, 18, "\n", 1);
-		}
-		else
-		{
-			$row['message_text'] .= $words;
-		}
-    }
-
-	$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
-
-	unset($words_array, $words);
-	
-	$this->content .= '<div style="padding: 4px;">';
-	
-	if ($row['poster_name'])
-	{
-		$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
-
-		if ($row['poster_id']) 
-		{
-			$this->content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'"><b>' . $row['poster_name'] . ': </b></a>';
-		}
-		else
-		{
-			$this->content .= '<b>' . $row['poster_name'] . ': </b>'; 
-		}
-	}
-	else
-	{
-		$this->content .= '<b>' . $_CLASS['core_user']->lang['ANONYMOUS'] . ': </b>';
-	}
-
-	if ($row['poster_id'])
-	{
-		$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
-	}
-
-	$this->content .= $row['message_text'].'<br />'. $_CLASS['core_user']->format_date($row['message_time']) .'</div><hr/>';
-}
-
-$_CLASS['core_db']->free_result($result);
-
-$this->content .= '</div><div align="center"><a href="'.generate_link('Quick_Message').'">Message History</a><br />';
-
 if (!$_CLASS['core_user']->is_user && !$_CORE_CONFIG['quick_message']['anonymous_posting'])
 {
 	$this->content .= '<br/>Only registered users can post<br />[ <a href="'.generate_link('Control_Panel&amp;mode=register').'">Register</a>&nbsp;|&nbsp;<a href="'.generate_link('Control_Panel').'">Login</a> ]<br /></div>';
@@ -109,11 +53,12 @@
 
 if (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
 {
-	$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" name="poster_name" size="10" maxlength="10" /><br />';
+	$this->content .= 'Name: <br /><input class="post" type="text" style="width:90%;" id="poster_name" name="poster_name" size="10" maxlength="10" /><br />';
 }
 
-$this->content .= 'Message <br/> <textarea name="message" style="width:90%;" rows="3"></textarea><br /><br />
-			<input class="button" type="submit" name="submit" value="Post" />
+$this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="3"></textarea><br /><br />
+			<input class="button" type="button" name="submit" onclick="quick_message_submit()" value="Post" />
+			<input class="button" type="button" name="submit" onclick="quick_message_refresh()" value="Refresh" />
 		</div></form>';
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/auth/auth.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -166,7 +166,7 @@
 	
 				if (!$code || !$confirm_code || $code !== $confirm_code)
 				{
-				//	$error = 'CONFIRM_CODE_WRONG';
+					$error = 'CONFIRM_CODE_WRONG';
 				}
 			}
 

Modified: cms/trunk/includes/forums/admin/admin_attachments.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_attachments.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_attachments.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -61,10 +61,10 @@
 
 	// Pull all config data
 	$sql = 'SELECT *
-		FROM ' . CONFIG_TABLE;
-	$result = $_CLASS['core_db']->sql_query($sql);
+		FROM ' . FORUMS_CONFIG_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$config_name = $row['config_name'];
 		$config_value = $row['config_value'];
@@ -101,6 +101,7 @@
 			}
 		}
 	}
+	$_CLASS['core_db']->free_result($result);
 
 	perform_site_list();
 
@@ -138,20 +139,20 @@
 	$sql = 'SELECT *
 		FROM ' . EXTENSIONS_TABLE . '
 		ORDER BY extension_id';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		if ($row['group_id'] != $extensions[$row['extension_id']]['group_id'])
 		{
 			$sql = 'UPDATE ' . EXTENSIONS_TABLE . ' 
 				SET group_id = ' . (int) $extensions[$row['extension_id']]['group_id'] . '
 				WHERE extension_id = ' . $row['extension_id'];
-			$_CLASS['core_db']->sql_query($sql);	
+			$_CLASS['core_db']->query($sql);	
 			add_log('admin', 'LOG_ATTACH_EXT_UPDATE', $row['extension']);
 		}
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	// Delete Extension ?
 	$extension_id_list = (isset($_POST['extension_id_list'])) ? array_map('intval', $_POST['extension_id_list']) : array();
@@ -161,19 +162,19 @@
 		$sql = 'SELECT extension 
 			FROM ' . EXTENSIONS_TABLE . '
 			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 		
 		$extension_list = '';
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$extension_list .= ($extension_list == '') ? $row['extension'] : ', ' . $row['extension'];
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		$sql = 'DELETE 
 			FROM ' . EXTENSIONS_TABLE . '
 			WHERE extension_id IN (' . implode(', ', $extension_id_list) . ')';
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		add_log('admin', 'LOG_ATTACH_EXT_DEL', $extension_list);
 	}
@@ -190,13 +191,13 @@
 			$sql = 'SELECT extension_id
 				FROM ' . EXTENSIONS_TABLE . "
 				WHERE extension = '" . $_CLASS['core_db']->sql_escape($add_extension) . "'";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 			
-			if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$error[] = sprintf($_CLASS['core_user']->lang['EXTENSION_EXIST'], $add_extension);
 			}
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 
 			if (!sizeof($error))
 			{
@@ -205,7 +206,7 @@
 					'extension'	=>	$add_extension
 				);
 				
-				$_CLASS['core_db']->sql_query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+				$_CLASS['core_db']->query('INSERT INTO ' . EXTENSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 				add_log('admin', 'LOG_ATTACH_EXT_ADD', $add_extension);
 			}
 		}
@@ -238,9 +239,9 @@
 	{
 		$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . "
 			WHERE group_id = $group_id";
-		$result = $_CLASS['core_db']->sql_query($sql);
-		$ext_row = $_CLASS['core_db']->sql_fetchrow($result);
-		$_CLASS['core_db']->sql_freeresult($result);
+		$result = $_CLASS['core_db']->query($sql);
+		$ext_row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 	else
 	{
@@ -261,12 +262,12 @@
 		$sql = 'SELECT group_id 
 			FROM ' . EXTENSION_GROUPS_TABLE . "
 			WHERE LOWER(group_name) = '" . $_CLASS['core_db']->sql_escape(strtolower($new_group_name)) . "'";
-		$result = $_CLASS['core_db']->sql_query($sql);
-		if ($_CLASS['core_db']->sql_fetchrow($result))
+		$result = $_CLASS['core_db']->query($sql);
+		if ($_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$error[] = sprintf($_CLASS['core_user']->lang['EXTENSION_GROUP_EXIST'], $new_group_name);
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 
 	if (!sizeof($error))
@@ -305,7 +306,7 @@
 		$sql .= $_CLASS['core_db']->sql_build_array((($action == 'add') ? 'INSERT' : 'UPDATE'), $group_ary);
 		$sql .= ($action == 'edit') ? " WHERE group_id = $group_id" : '';
 
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 		
 		if ($action == 'add')
 		{
@@ -322,7 +323,7 @@
 		$sql = 'UPDATE ' . EXTENSIONS_TABLE . "
 			SET group_id = 0
 			WHERE group_id = $group_id";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	if (sizeof($extension_list))
@@ -330,7 +331,7 @@
 		$sql = 'UPDATE ' . EXTENSIONS_TABLE . " 
 			SET group_id = $group_id
 			WHERE extension_id IN (" . implode(', ', $extension_list) . ")";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 	}
 
 	rewrite_extensions();
@@ -387,21 +388,21 @@
 
 		$sql = 'SELECT forum_id, forum_name
 			FROM ' . FORUMS_TABLE;
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 		
 		$forum_names = array();
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$forum_names[$row['forum_id']] = $row['forum_name'];
 		}
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
 		$sql = 'SELECT forum_id, topic_id, post_id 
 			FROM ' . POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', array_keys($upload_list)) . ')';
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			echo sprintf($_CLASS['core_user']->lang['UPLOADING_FILE_TO'], $upload_list[$row['post_id']], $row['post_id']) . '<br />';
 			if (!$_CLASS['auth']->acl_gets('f_attach', 'u_attach', $row['forum_id']))
@@ -486,14 +487,14 @@
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		WHERE cat_id > 0
 		ORDER BY cat_id';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$s_assigned_groups = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$s_assigned_groups[$row['cat_id']][] = $row['group_name'];
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$display_inlined_yes = ($new['img_display_inlined']) ? 'checked="checked"' : '';
 	$display_inlined_no = (!$new['img_display_inlined']) ? 'checked="checked"' : '';
@@ -560,7 +561,7 @@
 	  <th align="center" colspan="2"><?php echo $_CLASS['core_user']->lang['SETTINGS_CAT_IMAGES']; ?></th>
 	</tr>
 	<tr>
-		<td class="row3" colspan="2" align="center"><?php echo $_CLASS['core_user']->lang['ASSIGNED_GROUP']; ?>: <?php echo ((sizeof($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])) ? implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) : $_CLASS['core_user']->lang['NONE']); ?></td>
+		<td class="row3" colspan="2" align="center"><?php echo $_CLASS['core_user']->lang['ASSIGNED_GROUP']; ?>: <?php echo (empty($s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE]) ? $_CLASS['core_user']->lang['NONE'] : implode(', ', $s_assigned_groups[ATTACHMENT_CATEGORY_IMAGE])); ?></td>
 	</tr>
 	<tr>
 		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['DISPLAY_INLINED']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['DISPLAY_INLINED_EXPLAIN']; ?></span></td>
@@ -612,13 +613,13 @@
 	$allow_deny = ($new['secure_allow_deny']) ? 'ALLOWED' : 'DISALLOWED';
 		
 	$sql = 'SELECT *
-		FROM ' . SITELIST_TABLE;
-	$result = $_CLASS['core_db']->sql_query($sql);
+		FROM ' . FORUMS_SITELIST_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
 
 	$defined_ips = '';
 	$ips = array();
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$value = ($row['site_ip']) ? $row['site_ip'] : $row['site_hostname'];
 		if ($value)
@@ -627,7 +628,7 @@
 			$ips[$row['site_id']] = $value;
 		}
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	if (!$new['secure_downloads'])
 	{
@@ -732,20 +733,20 @@
 			$sql = 'SELECT group_name 
 				FROM ' . EXTENSION_GROUPS_TABLE . "
 				WHERE group_id = $group_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 			$group_name = $_CLASS['core_db']->sql_fetchfield('group_name', 0, $result);
-			$_CLASS['core_db']->sql_freeresult($result);
+			$_CLASS['core_db']->free_result($result);
 			
 			$sql = 'DELETE 
 				FROM ' . EXTENSION_GROUPS_TABLE . " 
 				WHERE group_id = $group_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			// Set corresponding Extensions to a pending Group
 			$sql = 'UPDATE ' . EXTENSIONS_TABLE . "
 				SET group_id = 0
 				WHERE group_id = $group_id";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 	
 			add_log('admin', 'LOG_ATTACH_EXTGROUP_DEL', $group_name);
 
@@ -770,9 +771,9 @@
 
 			$sql = 'SELECT * FROM ' . EXTENSION_GROUPS_TABLE . "
 				WHERE group_id = $group_id";
-			$result = $_CLASS['core_db']->sql_query($sql);
-			extract($_CLASS['core_db']->sql_fetchrow($result));
-			$_CLASS['core_db']->sql_freeresult($result);
+			$result = $_CLASS['core_db']->query($sql);
+			extract($_CLASS['core_db']->fetch_row_assoc($result));
+			$_CLASS['core_db']->free_result($result);
 
 			$forum_ids = (!$allowed_forums) ? array() : unserialize(trim($allowed_forums));
 
@@ -795,9 +796,9 @@
 			$sql = 'SELECT * FROM ' . EXTENSIONS_TABLE . "
 				WHERE group_id = $group_id OR group_id = 0
 				ORDER BY extension";
-			$result = $_CLASS['core_db']->sql_query($sql);
-			$extensions = $_CLASS['core_db']->sql_fetchrowset($result);
-			$_CLASS['core_db']->sql_freeresult($result);
+			$result = $_CLASS['core_db']->query($sql);
+			$extensions = $_CLASS['core_db']->fetch_row_assocset($result);
+			$_CLASS['core_db']->free_result($result);
 
 			$img_path = $config['upload_icons_path'];
 
@@ -968,12 +969,12 @@
 				$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id
 					FROM ' . FORUMS_TABLE . '
 					ORDER BY left_id ASC';
-				$result = $_CLASS['core_db']->sql_query($sql);
+				$result = $_CLASS['core_db']->query($sql);
 
 				$right = $cat_right = $padding_inc = 0;
 				$padding = $forum_list = $holding = '';
 				$padding_store = array('0' => '');
-				while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
 					{
@@ -1018,7 +1019,7 @@
 						$holding = '';
 					}
 				}
-				$_CLASS['core_db']->sql_freeresult($result);
+				$_CLASS['core_db']->free_result($result);
 				unset($padding_store);
 ?>
 				</select></td>
@@ -1043,7 +1044,7 @@
 				SET allow_group = ' . (($action == 'activate') ? '1' : '0') . "
 				WHERE group_id = $group_id";
 
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			rewrite_extensions();
 
@@ -1052,7 +1053,7 @@
 	$sql = 'SELECT *
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		ORDER BY allow_group DESC, group_name';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 ?>
 
@@ -1067,7 +1068,7 @@
 
 	$row_class = 'row2';
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
 		
@@ -1096,7 +1097,7 @@
 
 <?php
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 ?>
 	<td class="cat" colspan="5" align="right"><?php echo $_CLASS['core_user']->lang['CREATE_GROUP']; ?>: <input class="post" type="text" name="group_name" maxlength="30" /> <input class="btnmain" type="submit" name="add" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /></td>
@@ -1137,9 +1138,9 @@
 	$sql = 'SELECT * 
 		FROM ' . EXTENSIONS_TABLE . ' 
 		ORDER BY group_id, extension';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$old_group_id = $row['group_id'];
 		do
@@ -1163,7 +1164,7 @@
 	</tr>
 <?
 		}
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 	}
 ?>
 	<tr>
@@ -1209,13 +1210,13 @@
 <?php
 	$sql = 'SELECT physical_filename 
 		FROM ' . ATTACHMENTS_TABLE;
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		unset($attach_filelist[$row['physical_filename']]);
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 ?>
 
@@ -1284,10 +1285,10 @@
 		$sql = 'SELECT cat_id
 			FROM ' . EXTENSION_GROUPS_TABLE . '
 			WHERE group_id = ' . (int) $group_id;
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 		
-		$cat_type = (!($row = $_CLASS['core_db']->sql_fetchrow($result))) ? ATTACHMENT_CATEGORY_NONE : $row['cat_id'];
-		$_CLASS['core_db']->sql_freeresult($result);
+		$cat_type = (!($row = $_CLASS['core_db']->fetch_row_assoc($result))) ? ATTACHMENT_CATEGORY_NONE : $row['cat_id'];
+		$_CLASS['core_db']->free_result($result);
 	}
 	else
 	{
@@ -1317,14 +1318,14 @@
 	$sql = 'SELECT group_id, group_name
 		FROM ' . EXTENSION_GROUPS_TABLE . '
 		ORDER BY group_name';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$group_name = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$group_name[] = $row;
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$row['group_id'] = 0;
 	$row['group_name'] = $_CLASS['core_user']->lang['NOT_ASSIGNED'];
@@ -1364,11 +1365,11 @@
 		$sql = "SELECT download_mode
 			FROM " . EXTENSION_GROUPS_TABLE . "
 			WHERE group_id = " . (int) $group_id;
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 		
-		$download_mode = (!($row = $_CLASS['core_db']->sql_fetchrow($result))) ? INLINE_LINK : $row['download_mode'];
+		$download_mode = (!($row = $_CLASS['core_db']->fetch_row_assoc($result))) ? INLINE_LINK : $row['download_mode'];
 
-		$_CLASS['core_db']->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 	else
 	{
@@ -1426,17 +1427,17 @@
 		$_CLASS['core_db']->sql_transaction();
 
 		$sql = 'INSERT INTO ' . ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$sql = 'UPDATE ' . POSTS_TABLE . "
 			SET post_attachment = 1
 			WHERE post_id = $post_id";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$sql = 'UPDATE ' . TOPICS_TABLE . "
 			SET topic_attachment = 1
 			WHERE topic_id = $topic_id";
-		$_CLASS['core_db']->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
 		$_CLASS['core_db']->sql_transaction('commit');
 
@@ -1601,11 +1602,11 @@
 		}
 
 		$sql = 'SELECT site_ip, site_hostname
-			FROM ' . SITELIST_TABLE . "
+			FROM ' . FORUMS_SITELIST_TABLE . "
 			WHERE ip_exclude = $ip_exclude";
-		$result = $_CLASS['core_db']->sql_query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
-		if ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$iplist_tmp = array();
 			$hostlist_tmp = array();
@@ -1621,7 +1622,7 @@
 				}
 				break;
 			}
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 
 			$iplist = array_unique(array_diff($iplist, $iplist_tmp));
 			$hostlist = array_unique(array_diff($hostlist, $hostlist_tmp));
@@ -1633,9 +1634,9 @@
 		{
 			foreach ($iplist as $ip_entry)
 			{
-				$sql = 'INSERT INTO ' . SITELIST_TABLE . " (site_ip, ip_exclude)
+				$sql = 'INSERT INTO ' . FORUMS_SITELIST_TABLE . " (site_ip, ip_exclude)
 					VALUES ($ip_entry, $ip_exclude)";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 		}
 
@@ -1643,9 +1644,9 @@
 		{
 			foreach ($hostlist as $host_entry)
 			{
-				$sql = 'INSERT INTO ' . SITELIST_TABLE . " (site_hostname, ip_exclude)
+				$sql = 'INSERT INTO ' . FORUMS_SITELIST_TABLE . " (site_hostname, ip_exclude)
 					VALUES ($host_entry, $ip_exclude)";
-				$_CLASS['core_db']->sql_query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
 		}
 		
@@ -1668,18 +1669,18 @@
 		
 			// Grab details of ips for logging information later
 			$sql = 'SELECT site_ip, site_hostname
-				FROM ' . SITELIST_TABLE . "
+				FROM ' . FORUMS_SITELIST_TABLE . "
 				WHERE site_id IN ($unip_sql)";
-			$result = $_CLASS['core_db']->sql_query($sql);
+			$result = $_CLASS['core_db']->query($sql);
 
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$l_unip_list .= (($l_unip_list != '') ? ', ' : '') . (($row['site_ip']) ? $row['site_ip'] : $row['site_hostname']);
 			}
 
-			$sql = 'DELETE FROM ' . SITELIST_TABLE . "
+			$sql = 'DELETE FROM ' . FORUMS_SITELIST_TABLE . "
 				WHERE site_id IN ($unip_sql)";
-			$_CLASS['core_db']->sql_query($sql);
+			$_CLASS['core_db']->query($sql);
 
 			add_log('admin', 'LOG_DOWNLOAD_REMOVE_IP', $l_unip_list);
 		}
@@ -1697,10 +1698,10 @@
 		FROM ' . EXTENSIONS_TABLE . ' e, ' . EXTENSION_GROUPS_TABLE . ' g
 		WHERE e.group_id = g.group_id
 			AND g.allow_group = 1';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	$extensions = array();
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$extension = $row['extension'];
 
@@ -1719,7 +1720,7 @@
 		// Store allowed extensions forum wise
 		$extensions['_allowed_'][$extension] = (!sizeof($allowed_forums)) ? 0 : $allowed_forums;
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$_CLASS['core_cache']->destroy('extensions');
 	$_CLASS['core_cache']->put('extensions', $extensions);

Deleted: cms/trunk/includes/forums/admin/admin_ban.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_ban.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_ban.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,289 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_ban.php,v 1.11 2004/08/01 21:01:23 psotfx Exp $
-//
-// FILENAME  : admin_ban.php
-// STARTED   : Tue Jul 31, 2001
-// COPYRIGHT : ? 2001,2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
-
-// Do we have ban permissions?
-if (!$auth->acl_get('a_ban'))
-{
-	trigger_error($user->lang['NO_ADMIN']);
-}
-
-include('includes/forums/functions_user.'.$phpEx);
-
-// Mode setting
-$mode		= request_var('mode', '');
-$bansubmit	= (isset($_POST['bansubmit'])) ? true : false;
-$unbansubmit= (isset($_POST['unbansubmit'])) ? true : false;
-
-// Set some vars
-$current_time = time();
-
-// Start program
-if ($bansubmit)
-{
-	// Grab the list of entries
-	$ban			= request_var('ban', '');
-	$ban_len		= request_var('banlength', 0);
-	$ban_len_other	= request_var('banlengthother', '');
-	$ban_exclude	= request_var('banexclude', 0);
-	$ban_reason		= request_var('banreason', '');
-
-	user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason);
-
-	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
-}
-else if ($unbansubmit)
-{
-	$ban = request_var('unban', '');
-
-	user_unban($mode, $ban);
-
-	trigger_error($user->lang['BAN_UPDATE_SUCESSFUL']);
-}
-
-//
-// Output relevant entry page
-//
-
-
-//
-// Ban length options
-//
-$ban_end_text = array(0 => $user->lang['PERMANENT'], 30 => $user->lang['30_MINS'], 60 => $user->lang['1_HOUR'], 360 => $user->lang['6_HOURS'], 1440 => $user->lang['1_DAY'], 10080 => $user->lang['7_DAYS'], 20160 => $user->lang['2_WEEKS'], 40320 => $user->lang['1_MONTH'], -1 => $user->lang['OTHER'] . ' -&gt; ');
-
-$ban_end_options = '';
-foreach ($ban_end_text as $length => $text)
-{
-	$ban_end_options .= '<option value="' . $length . '">' . $text . '</option>';
-}
-
-// Title
-switch ($mode)
-{
-	case 'user':
-		$l_title = $user->lang['BAN_USERS'];
-		break;
-	case 'email':
-		$l_title = $user->lang['BAN_EMAILS'];
-		break;
-	case 'ip':
-		$l_title = $user->lang['BAN_IPS'];
-		break;
-}
-
-// Output page
-adm_page_header($l_title);
-
-?>
-
-<p><?php echo $user->lang['BAN_EXPLAIN']; ?></p>
-
-<?php
-
-switch ($mode)
-{
-	case 'user':
-
-		$field = 'username';
-		$l_ban_title = $user->lang['BAN_USERS'];
-		$l_ban_explain = $user->lang['BAN_USERNAME_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_USER_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_USERNAME'];
-		$l_unban_explain = $user->lang['UNBAN_USERNAME_EXPLAIN'];
-		$l_ban_cell = $user->lang['USERNAME'] . ': <br /><span class="gensmall">[ <a href="' . getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban').'" onclick="window.open(\''.getlink('Members_List'.$SID.'&amp;mode=searchuser&amp;form=banning&amp;field=ban')."', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;\">" . $user->lang['FIND_USERNAME'] .'</a> ]</span>';
-		$l_no_ban_cell = $user->lang['NO_BANNED_USERS'];
-
-		$sql = 'SELECT b.*, u.user_id, u.username
-			FROM ' . BANLIST_TABLE . ' b, ' . USERS_TABLE . ' u
-			WHERE (b.ban_end >= ' . time() . '
-					OR b.ban_end = 0)
-				AND u.user_id = b.ban_userid
-				AND b.ban_userid <> 0
-				AND u.user_id <> ' . ANONYMOUS . '
-			ORDER BY u.user_id ASC';
-		break;
-
-	case 'ip':
-
-		$field = 'ban_ip';
-		$l_ban_title = $user->lang['BAN_IPS'];
-		$l_ban_explain = $user->lang['BAN_IP_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_IP_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_IP'];
-		$l_unban_explain = $user->lang['UNBAN_IP_EXPLAIN'];
-		$l_ban_cell = $user->lang['IP_HOSTNAME'] . ':';
-		$l_no_ban_cell = $user->lang['NO_BANNED_IP'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end >= ' . time() . "
-					OR ban_end = 0)
-				AND ban_ip <> ''";
-		break;
-
-	case 'email':
-
-		$field = 'ban_email';
-		$l_ban_title = $user->lang['BAN_EMAILS'];
-		$l_ban_explain = $user->lang['BAN_EMAIL_EXPLAIN'];
-		$l_ban_exclude_explain = $user->lang['BAN_EMAIL_EXCLUDE_EXPLAIN'];
-		$l_unban_title = $user->lang['UNBAN_EMAIL'];
-		$l_unban_explain = $user->lang['UNBAN_EMAIL_EXPLAIN'];
-		$l_ban_cell = $user->lang['EMAIL_ADDRESS'] . ':';
-		$l_no_ban_cell = $user->lang['NO_BANNED_EMAIL'];
-
-		$sql = 'SELECT *
-			FROM ' . BANLIST_TABLE . '
-			WHERE (ban_end >= ' . time() . "
-					OR ban_end = 0)
-				AND ban_email <> ''";
-		break;
-}
-$result = $db->sql_query($sql);
-
-$banned_options = '';
-$ban_length = $ban_reasons = array();
-if ($row = $db->sql_fetchrow($result))
-{
-	do
-	{
-
-		$banned_options .=  '<option' . (($row['ban_exclude']) ? ' class="sep"' : '') . ' value="' . $row['ban_id'] . '">' . $row[$field] . '</option>';
-
-		$time_length = (!empty($row['ban_end'])) ? ($row['ban_end'] - $row['ban_start']) / 60 : 0;
-		$ban_length[$row['ban_id']] = (!empty($ban_end_text[$time_length])) ? $ban_end_text[$time_length] : $user->lang['OTHER'] . ' -> ' . gmdate('Y-m-d', $row['ban_end']);
-
-		$ban_reasons[$row['ban_id']] = addslashes($row['ban_reason']);
-	}
-	while ($row = $db->sql_fetchrow($result));
-}
-$db->sql_freeresult($result);
-
-?>
-
-<h1><?php echo $l_ban_title; ?></h1>
-
-<p><?php echo $l_ban_explain; ?></p>
-
-<script language="Javascript" type="text/javascript">
-<!--
-
-var ban_length = new Array();
-<?php
-
-	if (sizeof($ban_length))
-	{
-		foreach ($ban_length as $ban_id => $length)
-		{
-			echo "ban_length['$ban_id'] = \"$length\";\n";
-		}
-	}
-
-?>
-
-var ban_reason = new Array();
-<?php
-
-	if (sizeof($ban_reasons))
-	{
-		foreach ($ban_reasons as $ban_id => $reason)
-		{
-			echo "ban_reason['$ban_id'] = \"$reason\";\n";
-		}
-	}
-?>
-
-function display_details(option)
-{
-	document.forms[0].unbanreason.value = ban_reason[option];
-	document.forms[0].unbanlength.value = ban_length[option];
-}
-
-//-->
-</script>
-
-<form name="banning" method="post" action="<?php echo "admin_ban.$phpEx$SID&amp;mode=$mode"; ?>"><table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $l_ban_title; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $l_ban_cell; ?></td>
-		<td class="row2"><textarea cols="40" rows="3" name="ban"></textarea></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
-		<td class="row2"><select name="banlength"><?php echo $ban_end_options; ?></select>&nbsp; <input class="post" type="text" name="banlengthother" maxlength="10" size="10" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_EXCLUDE']; ?>: <br /><span class="gensmall"><?php echo $l_ban_exclude_explain;;?></span></td>
-		<td class="row2"><input type="radio" name="banexclude" value="1" /> <?php echo $user->lang['YES']; ?> &nbsp; <input type="radio" name="banexclude" value="0" checked="checked" /> <?php echo $user->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
-		<td class="row2"><input class="post" type="text" name="banreason" maxlength="255" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"> <input type="submit" name="bansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" />&nbsp;</td>
-	</tr>
-</table>
-
-<h1><?php echo $l_unban_title; ?></h1>
-
-<p><?php echo $l_unban_explain; ?></p>
-
-<table class="bg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $l_unban_title; ?></th>
-	</tr>
-<?php
-
-	if ($banned_options)
-	{
-
-?>
-	<tr>
-		<td class="row1" width="45%"><?php echo $l_ban_cell; ?>: <br /></td>
-		<td class="row2"> <select name="unban[]" multiple="multiple" size="5" onchange="display_details(this.options[this.selectedIndex].value)"><?php echo $banned_options; ?></select></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_REASON']; ?>:</td>
-		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanreason" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="row1" width="45%"><?php echo $user->lang['BAN_LENGTH']; ?>:</td>
-		<td class="row2"><input class="row1" style="border:0px" type="text" name="unbanlength" size="40" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input type="submit" name="unbansubmit" value="<?php echo $user->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $user->lang['RESET']; ?>" class="btnlite" /></td>
-	</tr>
-<?php
-
-	}
-	else
-	{
-
-?>
-	<tr>
-		<td class="row2" colspan="2" align="center"><?php echo $l_no_ban_cell;  ?></td>
-	</tr>
-<?php
-
-	}
-
-?>
-</table></form>
-
-<?php
-
-adm_page_footer();
-
-?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/admin_board.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_board.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_board.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -18,7 +18,7 @@
 // Get mode
 $mode	= request_var('mode', '');
 $action	= request_var('action', '');
-$submit = (isset($_POST['submit'])) ? true : false;
+$submit = isset($_POST['submit']);
 
 // Set config vars
 $display_vars = array(

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -16,7 +16,7 @@
 }
 
 // Get general vars
-$update		= (isset($_POST['update'])) ? true : false;
+$update		= isset($_POST['update']);
 $mode		= request_var('mode', '');
 $action		= request_var('action', '');
 $forum_id	= request_var('f', 0);
@@ -42,7 +42,7 @@
 
 if (!$_CLASS['auth']->acl_get($acl))
 {
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+	trigger_error('NO_ADMIN');
 }
 
 
@@ -80,8 +80,6 @@
 				'forum_id'		=>	$forum_id
 			);
 
-			// No break here
-
 		case 'add':
 			$forum_data += array(
 				'parent_id'				=> $parent_id,
@@ -107,10 +105,16 @@
 				'prune_sticky'			=> request_var('prune_sticky', FALSE),
 				'forum_password'		=> request_var('forum_password', ''),
 				'forum_password_confirm'=> request_var('forum_password_confirm', ''),
-				'forum_posts'			=> 0,
-				'forum_topics'			=> 0,
-				'forum_topics_real'		=> 0,
 			);
+	
+			if ($mode === 'add')
+			{
+				$forum_data += array(
+					'forum_posts'			=> 0,
+					'forum_topics'			=> 0,
+					'forum_topics_real'		=> 0,
+				);
+			}
 
 			if ($forum_data['forum_rules'])
 			{
@@ -130,7 +134,7 @@
 				$forum_data['forum_rules_bbcode_bitfield'] = $message_parser->bbcode_bitfield;
 				unset($message_parser);
 			}
-					
+
 			$errors = update_forum_data($forum_data);
 
 			if ($errors)
@@ -138,16 +142,15 @@
 				break;
 			}
 
-			// 
 			$_CLASS['auth']->acl_clear_prefetch();
 
 			// Redirect to permissions
-			$message = ($mode == 'add') ? $_CLASS['core_user']->lang['FORUM_CREATED'] : $_CLASS['core_user']->lang['FORUM_UPDATED'];
+			$message = ($mode === 'add') ? $_CLASS['core_user']->lang['FORUM_CREATED'] : $_CLASS['core_user']->lang['FORUM_UPDATED'];
 			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['REDIRECT_ACL'], '<a href="'.generate_link('Forums&amp;file=admin_permissions&amp;mode=forum&amp;submit_usergroups=true&amp;ug_type=forum&amp;action=usergroups&amp;f[forum][]=' . $forum_data['forum_id'], array('admin' => true)) . '">', '</a>');
 			$show_prev_info = ($mode == 'edit') ? true : false;
 
 			trigger_error($message);
-			break;
+		break;
 	}
 }
 
@@ -155,7 +158,7 @@
 {
 	case 'add':
 	case 'edit':
-		if (isset($_POST['update']))
+		if ($update)
 		{
 			extract($forum_data);
 		}
@@ -254,26 +257,26 @@
 		}
 
 		$statuslist = '<option value="' . ITEM_UNLOCKED . '"' . (($forum_status == ITEM_UNLOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['UNLOCKED'] . '</option><option value="' . ITEM_LOCKED . '"' . (($forum_status == ITEM_LOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['LOCKED'] . '</option>';
-$enable_icons = isset($enable_icons) ? $enable_icons : 0;
-$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
-$enable_prune = isset($enable_prune) ? $enable_prune : 0;
-$display_on_index = isset($display_on_index) ? $display_on_index : 0;
-$forum_flags = isset($forum_flags) ? $forum_flags : 0;
 
-$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
-$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
-$urls_checked = isset($urls_checked) ? $urls_checked : false;
+		$enable_icons = isset($enable_icons) ? $enable_icons : 0;
+		$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
+		$enable_prune = isset($enable_prune) ? $enable_prune : 0;
+		$display_on_index = isset($display_on_index) ? $display_on_index : 0;
+		$forum_flags = isset($forum_flags) ? $forum_flags : 0;
+		
+		$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
+		$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
+		$urls_checked = isset($urls_checked) ? $urls_checked : false;
+		
+		$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
+		$forum_image = isset($forum_image) ? $forum_image : '';
+		$prune_freq = isset($prune_freq) ? $prune_freq : '';
+		$prune_days = isset($prune_days) ? $prune_days : '';
+		$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
+		$forum_link = isset($forum_link) ? $forum_link : '';
+		
+		$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
 
-$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
-$forum_image = isset($forum_image) ? $forum_image : '';
-$prune_freq = isset($prune_freq) ? $prune_freq : '';
-$prune_days = isset($prune_days) ? $prune_days : '';
-$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
-$forum_link = isset($forum_link) ? $forum_link : '';
-
-$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
-
-
 		$indexing_yes = ($enable_indexing) ? ' checked="checked"' : '';
 		$indexing_no = (!$enable_indexing) ? ' checked="checked"' : '';
 		$topic_icons_yes = ($enable_icons) ? ' checked="checked"' : '';
@@ -345,18 +348,8 @@
 			// deleting all posts or moving them to another forum (if applicable)
 
 ?><br /><input type="radio" name="action" value="delete" checked="checked" /> <?php echo $_CLASS['core_user']->lang['DELETE_ALL_POSTS'];
-
-			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_type = ' . FORUM_POST . "
-					AND forum_id <> $forum_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			if ($_CLASS['core_db']->fetch_row_assoc($result))
-			{
 ?>&nbsp;<input type="radio" name="action" value="move" /> <?php echo $_CLASS['core_user']->lang['MOVE_POSTS_TO'] ?> <select name="to_forum_id"><?php echo $forums_list ?></select><?php
 
-			}
 		}
 
 ?></td>
@@ -365,14 +358,12 @@
 
 		if ($forum_type == FORUM_POST)
 		{
-
 ?>
 	<tr>
 		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_STATUS'] ?>: </b></td>
 		<td class="row2"><select name="forum_status"><?php echo $statuslist ?></select></td>
 	</tr>
 <?php
-
 		}
 
 ?>
@@ -384,7 +375,6 @@
 
 		if ($forum_type == FORUM_LINK)
 		{
-
 ?>
 	<tr>
 		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_LINK'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_LINK_EXPLAIN']; ?></span></td>
@@ -395,7 +385,6 @@
 		<td class="row2"><input type="radio" name="forum_link_track" value="1"<?php echo $forum_link_track_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="forum_link_track" value="0"<?php echo $forum_link_track_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
 	</tr>
 <?php
-
 		}
 
 ?>
@@ -655,7 +644,7 @@
 
 		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
 		{
-			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
+			trigger_error('NO_FORUM');
 		}
 		$_CLASS['core_db']->free_result($result);
 
@@ -1431,7 +1420,7 @@
 	switch ($_CLASS['core_db']->db_layer)
 	{
 // Needs updating and testing
-/*		case 'mysql4':
+/*		case 'mysql':
 		case 'mysqli':
 			// Select then delete all attachments
 			$sql = 'SELECT a.topic_id

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/auth.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,19 +1,29 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 // -------------------------------------------------------------
 //
-// COPYRIGHT : ? 2001, 2004 phpBB Group
+// COPYRIGHT : 2001, 2004 phpBB Group
 // WWW       : http://www.phpbb.com/
 //
 // -------------------------------------------------------------
@@ -182,14 +192,6 @@
 		$hold_ary = $this->acl_raw_data($userdata['user_id'], false, false);
 		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
 
-		foreach ($this->acl_options['global'] as $opt => $id)
-		{
-			if (strstr($opt, 'a_'))
-			{
-				$hold_ary[0][$opt] = 1;
-			}
-		}
-
 		$hold_str = '';
 		if (is_array($hold_ary))
 		{

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -168,24 +168,6 @@
 	return $var;
 }
 
-// Generates an alphanumeric random string of given length
-function gen_rand_string($num_chars)
-{
-	$chars = array('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J',  'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',  'U', 'V', 'W', 'X', 'Y', 'Z', '1', '2', '3', '4', '5', '6', '7', '8', '9');
-
-	list($sec, $usec) = explode(' ', microtime());
-	mt_srand((float) $sec + ((float) $usec * 100000));
-
-	$max_chars = sizeof($chars) - 1;
-	$rand_str = '';
-	for ($i = 0; $i < $num_chars; $i++)
-	{
-		$rand_str .= $chars[mt_rand(0, $max_chars)];
-	}
-
-	return $rand_str;
-}
-
 function get_userdata($user)
 {
 	global $_CLASS;
@@ -916,7 +898,7 @@
 			}
 			
 			// Store allowed extensions forum wise
-			$extensions['_allowed_'][$extension] = (!sizeof($allowed_forums)) ? 0 : $allowed_forums;
+			$extensions['_allowed_'][$extension] = empty($allowed_forums) ? 0 : $allowed_forums;
 		}
 		$_CLASS['core_db']->free_result($result);
 
@@ -934,7 +916,7 @@
 			if (is_array($check))
 			{
 				// Check for private messaging
-				if (sizeof($check) == 1 && $check[0] == 0)
+				if (count($check) == 1 && $check[0] == 0)
 				{
 					$allowed = true;
 				}
@@ -1096,7 +1078,7 @@
 	global $config, $_CLASS;
 
 	$unset_array = array();
-	$tpl_size = sizeof($attachments);
+	$tpl_size = count($attachments);
 
 	preg_match_all('#<!\-\- ia([0-9]+) \-\->(.*?)<!\-\- ia\1 \-\->#', $text, $matches, PREG_PATTERN_ORDER);
 	//print_r($matches);
@@ -1142,7 +1124,7 @@
 // Check if extension is allowed to be posted within forum X (forum_id 0 == private messaging)
 function extension_allowed($forum_id, $extension, &$extensions)
 {
-	if (!sizeof($extensions))
+	if (empty($extensions))
 	{
 		$extensions = obtain_attach_extensions();
 	}
@@ -1157,11 +1139,11 @@
 	if (is_array($check))
 	{
 		// Check for private messaging
-		if (sizeof($check) == 1 && $check[0] == 0)
+		if (count($check) == 1 && $check[0] == 0)
 		{
 			return true;
 		}
-		
+
 		return (!in_array($forum_id, $check)) ? false : true;
 	}
 	else

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -100,7 +100,7 @@
 
 	$select_field = '<select name="' . $select_name . '">';
 
-	$size = sizeof($size_types_text);
+	$size = count($size_types_text);
 	for ($i = 0, $size; $i < $size; $i++)
 	{
 		$selected = ($size_compare == $size_types[$i]) ? ' selected="selected"' : '';
@@ -339,7 +339,7 @@
 		$where_ids = array_unique($where_ids);
 	}
 
-	if (!sizeof($where_ids))
+	if (empty($where_ids))
 	{
 		return array('topics' => 0, 'posts' => 0);
 	}
@@ -360,9 +360,9 @@
 	}
 	$_CLASS['core_db']->free_result();
 
-	$return['topics'] = sizeof($topic_ids);
+	$return['topics'] = count($topic_ids);
 
-	if (!sizeof($topic_ids))
+	if (!$return['topics'])
 	{
 		return $return;
 	}
@@ -455,7 +455,7 @@
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
 
-	return sizeof($post_ids);
+	return count($post_ids);
 }
 
 // Delete Attachments
@@ -471,7 +471,7 @@
 		$ids = array_unique($ids);
 	}
 	
-	if (!sizeof($ids))
+	if (empty($ids))
 	{
 		return false;
 	}
@@ -556,7 +556,7 @@
 	$topic_ids = array_unique($topic_ids);
 
 	// Update post indicators
-	if (sizeof($post_ids))
+	if (!empty($post_ids))
 	{
 		if ($mode == 'post' || $mode == 'topic')
 		{
@@ -582,7 +582,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 					SET post_attachment = 0
@@ -604,7 +604,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']->query('UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
 					SET message_attachment = 0
@@ -613,7 +613,7 @@
 		}
 	}
 
-	if (sizeof($topic_ids))
+	if (!empty($topic_ids))
 	{
 		// Update topic indicator
 		if ($mode == 'topic')
@@ -639,7 +639,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$unset_ids = array_diff($topic_ids, $remaining);
-			if (sizeof($unset_ids))
+			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 					SET topic_attachment = 0
@@ -681,7 +681,7 @@
 				$topic_ids[] = $row['topic_id'];
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
 					WHERE topic_id IN (' . implode(',', $topic_ids) . ')';
@@ -750,7 +750,7 @@
 		}
 		else
 		{
-			if (!sizeof($where_ids))
+			if (empty($where_ids))
 			{
 				// Empty array with IDs. This means that we don't have any work to do. Just return.
 				return;
@@ -763,7 +763,7 @@
 	}
 	else
 	{
-		if (!sizeof($where_ids))
+		if (empty($where_ids))
 		{
 			return;
 		}
@@ -836,7 +836,7 @@
 					}
 					$_CLASS['core_db']->free_result();
 
-					if (!sizeof($topic_ids))
+					if (empty($topic_ids))
 					{
 						return;
 					}
@@ -890,7 +890,7 @@
 				$post_ids[] = $post_id;
 			}
 
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_reported = 1 - post_reported
@@ -928,7 +928,7 @@
 				}
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_reported = 1 - topic_reported
@@ -980,7 +980,7 @@
 				$post_ids[] = $post_id;
 			}
 
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 					SET post_attachment = 1 - post_attachment
@@ -1018,7 +1018,7 @@
 				}
 			}
 
-			if (sizeof($topic_ids))
+			if (!empty($topic_ids))
 			{
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_attachment = 1 - topic_attachment
@@ -1090,7 +1090,7 @@
 			}
 
 			// 4: Retrieve last_post infos
-			if (sizeof($post_ids))
+			if (!empty($post_ids))
 			{
 				$sql = 'SELECT p.post_id, p.poster_id, p.post_time, p.post_username, u.username
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
@@ -1148,7 +1148,7 @@
 					}
 				}
 
-				if (sizeof($sql))
+				if (!empty($sql))
 				{
 					$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
 						SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . '
@@ -1234,18 +1234,18 @@
 			}
 
 			// Now we delete empty topics and orphan posts
-			if (sizeof($delete_posts))
+			if (!empty($delete_posts))
 			{
 				delete_posts('topic_id', array_keys($delete_posts), FALSE);
 				unset($delete_posts);
 			}
-			if (!sizeof($topic_data))
+			if (empty($topic_data))
 			{
 				// If we get there, topic ids were invalid or topics did not contain any posts
 				delete_topics($where_type, $where_ids, TRUE);
 				return;
 			}
-			if (sizeof($delete_topics))
+			if (!empty($delete_topics))
 			{
 				$delete_topic_ids = array();
 				foreach ($delete_topics as $topic_id => $void)
@@ -1289,7 +1289,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			// approved becomes unapproved, and vice-versa
-			if (sizeof($approved_unapproved_ids))
+			if (!empty($approved_unapproved_ids))
 			{
 				$sql = 'UPDATE ' . TOPICS_TABLE . '
 					SET topic_approved = 1 - topic_approved
@@ -1348,7 +1348,7 @@
 					}
 				}
 
-				if (sizeof($sql))
+				if (!empty($sql))
 				{
 					$sql = 'UPDATE ' . TOPICS_TABLE . '
 						SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . '
@@ -1363,7 +1363,7 @@
 			// if some topics have been resync'ed then resync parent forums
 			// except when we're only syncing a range, we don't want to sync forums during
 			// batch processing.
-			if ($resync_parents && sizeof($resync_forums) && $where_type != 'range')
+			if ($resync_parents && !empty($resync_forums) && $where_type != 'range')
 			{
 				sync('forum', 'forum_id', $resync_forums, TRUE);
 			}
@@ -1469,7 +1469,7 @@
 	$output = '';
 
 	// try to keep mem. use down
-	$linecount = sizeof($lines);
+	$linecount = count($lines);
 
 	$in_comment = false;
 	for($i = 0; $i < $linecount; $i++)
@@ -1515,7 +1515,7 @@
 	$matches = array();
 
 	// this is faster than calling count($oktens) every time thru the loop.
-	$token_count = sizeof($tokens);
+	$token_count = count($tokens);
 	for ($i = 0; $i < $token_count; $i++)
 	{
 		// Don't wanna add an empty string as the last thing in the array.
@@ -1633,7 +1633,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	if (sizeof($m_sql))
+	if (!empty($m_sql))
 	{
 		switch ($_CLASS['core_db']->db_layer)
 		{
@@ -1807,7 +1807,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	if (sizeof($topic_id_list))
+	if (!empty($topic_id_list))
 	{
 		$topic_id_list = array_unique($topic_id_list);
 
@@ -2208,7 +2208,7 @@
 		}
 	}
 
-	if (sizeof($last_post_ids))
+	if (!empty($last_post_ids))
 	{
 		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
 			FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
@@ -2227,7 +2227,7 @@
 	}
 	unset($empty_forums, $ids, $last_post_ids);
 
-	if (!sizeof($update_sql))
+	if (empty($update_sql))
 	{
 		return;
 	}

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -234,10 +234,10 @@
 					}
 				}
 
-				if (sizeof($links))
+				if (!empty($links))
 				{
 					$subforums_list = implode(', ', $links);
-					$l_subforums = (sizeof($subforums[$forum_id]) == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
+					$l_subforums = (count($subforums[$forum_id]) == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
 				}
 
 				unset($links);
@@ -291,7 +291,7 @@
 		$l_moderator = $moderators_list = '';
 		if ($display_moderators && !empty($forum_moderators[$forum_id]))
 		{
-			$l_moderator = (sizeof($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']->lang['MODERATOR'] : $_CLASS['core_user']->lang['MODERATORS'];
+			$l_moderator = (count($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']->lang['MODERATOR'] : $_CLASS['core_user']->lang['MODERATORS'];
 			$moderators_list = implode(', ', $forum_moderators[$forum_id]);
 		}
 
@@ -329,8 +329,8 @@
 	$_CLASS['core_template']->assign_array(array(
 		'MODIFY_FORUM'		=> $_CLASS['auth']->acl_get('a_forum'),
 		'U_MARK_FORUMS'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
-		'S_HAS_SUBFORUM'	=>	($visible_forums) ? true : false,
-		'L_SUBFORUM'		=>	($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
+		'S_HAS_SUBFORUM'	=> ($visible_forums) ? true : false,
+		'L_SUBFORUM'		=> ($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
 	));
 
 	return $active_forum_ary;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -199,7 +199,7 @@
 	$file->clean_filename('unique', $_CLASS['core_user']->data['user_id'] . '_');
 	$file->move_file($config['upload_path']);
 		
-	if (sizeof($file->error))
+	if (!empty($file->error))
 	{
 		$file->remove();
 		$filedata['error'] = array_merge($filedata['error'], $file->error);
@@ -502,21 +502,21 @@
 {
 	global $_CLASS;
 
-	if (sizeof($attachment_data))
+	if (empty($attachment_data))
 	{
-		$s_inline_attachment_options = '';
-		
-		foreach ($attachment_data as $i => $attachment)
-		{
-			$s_inline_attachment_options .= '<option value="' . $i . '">' . $attachment['real_filename'] . '</option>';
-		}
+		return false;
+	}
 
-		$_CLASS['core_template']->assign('S_INLINE_ATTACHMENT_OPTIONS', $s_inline_attachment_options);
-
-		return true;
+	$s_inline_attachment_options = '';
+	
+	foreach ($attachment_data as $i => $attachment)
+	{
+		$s_inline_attachment_options .= '<option value="' . $i . '">' . $attachment['real_filename'] . '</option>';
 	}
 
-	return false;
+	$_CLASS['core_template']->assign('S_INLINE_ATTACHMENT_OPTIONS', $s_inline_attachment_options);
+
+	return true;
 }
 
 // Build topic types able to be selected
@@ -581,7 +581,7 @@
 		
 	$_CLASS['core_template']->assign('S_SHOW_ATTACH_BOX', true);
 
-	if (sizeof($attachment_data))
+	if (!empty($attachment_data))
 	{
 		$_CLASS['core_template']->assign('S_HAS_ATTACHMENTS', true);
 		
@@ -618,7 +618,7 @@
 		'FILESIZE'		=> $config['max_filesize'])
 	);
 
-	return sizeof($attachment_data);
+	return count($attachment_data);
 }
 
 // Load Drafts
@@ -659,7 +659,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 				
-	if (sizeof($topic_ids))
+	if (!empty($topic_ids))
 	{
 		$sql = 'SELECT topic_id, forum_id, topic_title
 			FROM ' . FORUMS_TOPICS_TABLE . '
@@ -674,7 +674,7 @@
 	}
 	unset($topic_ids);
 	
-	if (sizeof($draftrows))
+	if (!empty($draftrows))
 	{
 		$_CLASS['core_template']->assign_array('S_SHOW_DRAFTS', true);
 

Added: cms/trunk/includes/forums/functions_profile_fields.php
===================================================================
--- cms/trunk/includes/forums/functions_profile_fields.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/functions_profile_fields.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,894 @@
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: functions_profile_fields.php,v 1.10 2004/09/19 20:40:20 acydburn Exp $
+//
+// FILENAME  : functions_profile_fields.php
+// STARTED   : Tue Oct 21, 2003
+// COPYRIGHT : ? 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+class custom_profile
+{
+	var $profile_types = array(1 => 'int', 2 => 'string', 3 => 'text', 4 => 'bool', 5 => 'dropdown', 6 => 'date');
+	var $profile_cache = array();
+	var $options_lang = array();
+
+	// Build language options cache, useful for viewtopic display
+	function build_cache()
+	{
+		global $_CLASS;
+
+		$this->profile_cache = array();
+
+		// Display hidden/no_view fields for admin/moderator
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
+			WHERE l.lang_id = ' . $_CLASS['core_user']->get_iso_lang_id() . '
+				AND f.field_active = 1 ' .
+				((!$_CLASS['auth']->acl_gets('a_', 'm_')) ? '     AND f.field_hide = 0 AND f.field_no_view = 0 ' : '') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']->sql_query($sql);
+
+		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		{
+			$this->profile_cache[$row['field_ident']] = $row;
+		}
+		$_CLASS['core_db']->sql_freeresult($result);
+	}
+
+	// Get language entries for options and store them here for later use
+	function get_option_lang($field_id, $lang_id, $field_type, $preview)
+	{
+		global $_CLASS;
+
+		if ($preview)
+		{
+			$lang_options = (!is_array($this->vars['lang_options'])) ? explode("\n", $this->vars['lang_options']) : $this->vars['lang_options'];
+			
+			foreach ($lang_options as $num => $var)
+			{
+				$this->options_lang[$field_id][$lang_id][($num+1)] = $var;
+			}
+		}
+		else
+		{
+			$sql = 'SELECT option_id, value
+				FROM ' . PROFILE_FIELDS_LANG_TABLE . "
+					WHERE field_id = $field_id
+					AND lang_id = $lang_id
+					AND field_type = $field_type
+				ORDER BY option_id";
+			$result = $_CLASS['core_db']->sql_query($sql);
+
+			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+			{
+				$this->options_lang[$field_id][$lang_id][$row['option_id']] = $row['value'];
+			}
+			$_CLASS['core_db']->sql_freeresult($result);
+		}
+	}
+
+	// Functions performing operations on register/profile/profile admin
+	function submit_cp_field($mode, $lang_id, &$cp_data, &$cp_error)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . " f 
+			WHERE l.lang_id = $lang_id
+				AND f.field_active = 1
+				" . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
+				(($_CLASS['auth']->acl_gets('a_', 'm_') && $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']->sql_query($sql);
+					
+		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		{
+			$cp_data[$row['field_ident']] = $this->get_profile_field($row);
+
+			// get_profile_field returns an array with values for TEXT fields.
+			if(is_array($cp_data[$row['field_ident']]))
+			{
+				// Contains the original text without bbcode processing etc
+				$check_value = $cp_data[$row['field_ident']]['submitted'];
+				
+				foreach($cp_data[$row['field_ident']] as $key => $value)
+				{
+					if($key != 'submitted')
+					{
+						$cp_data[$key] = $value;
+					}
+				}
+			}
+			else
+			{
+				$check_value = $cp_data[$row['field_ident']];
+			}
+			
+			if (($cp_result = $this->validate_profile_field($row['field_type'], $check_value, $row)) !== false)
+			{
+				// If not and only showing common error messages, use this one
+				$error = false;
+
+				switch ($cp_result)
+				{
+					case 'FIELD_INVALID_DATE':
+					case 'FIELD_REQUIRED':
+						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name']);
+						break;
+					case 'FIELD_TOO_SHORT':
+					case 'FIELD_TOO_SMALL':
+						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name'], $row['field_minlen']);
+						break;
+					case 'FIELD_TOO_LONG':
+					case 'FIELD_TOO_LARGE':
+						$error = sprintf($_CLASS['core_user']->lang[$cp_result], $row['lang_name'], $row['field_maxlen']);
+						break;
+					case 'FIELD_INVALID_CHARS':
+						switch ($row['field_validation'])
+						{
+							case '[0-9]+':
+								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_NUMBERS_ONLY'], $row['lang_name']);
+								break;
+							case '[\w]+':
+								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_ALPHA_ONLY'], $row['lang_name']);
+								break;
+							case '[\w_\+\. \-\[\]]+':
+								$error = sprintf($_CLASS['core_user']->lang[$cp_result . '_SPACERS_ONLY'], $row['lang_name']);
+								break;
+						}
+						break;
+				}
+
+				if ($error)
+				{
+					$cp_error[] = $error;
+				}
+			}
+		}
+		$_CLASS['core_db']->sql_freeresult($result);
+	}
+	
+	// Assign fields to template, mode can be profile (for profile change) or register (for registration)
+//	function generate_profile_fields($mode, $lang_id, $cp_error)
+	function generate_profile_fields($mode, $lang_id)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT l.*, f.*
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . " f 
+			WHERE l.lang_id = $lang_id
+				AND f.field_active = 1
+				" . (($mode == 'register') ? ' AND f.field_show_on_reg = 1' : '') .
+				(($_CLASS['auth']->acl_gets('a_', 'm_') && $mode == 'profile') ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id
+			ORDER BY f.field_order';
+		$result = $_CLASS['core_db']->sql_query($sql);
+
+		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		{
+			$_CLASS['core_template']->assign_vars_array('profile_fields', array(
+				'LANG_NAME' => $row['lang_name'],
+				'LANG_EXPLAIN' => $row['lang_explain'],
+				'FIELD' => $this->process_field_row('change', $row))
+//				'ERROR' => $error)
+			);
+		}
+		$_CLASS['core_db']->sql_freeresult($result);
+	}
+
+	// Assign fields to template, used for viewprofile, viewtopic and memberlist (if load setting is enabled)
+	// This is directly connected to the user -> mode == grab is to grab the user specific fields, mode == show is for assigning the row to the template
+	function generate_profile_fields_template($mode, $user_id = 0, $profile_row = false)
+	{
+		global $_CLASS;
+
+		if ($mode == 'grab')
+		{
+			if (!is_array($user_id))
+			{
+				$user_id = array($user_id);
+			}
+			
+			if (!sizeof($this->profile_cache))
+			{
+				$this->build_cache();
+			}
+
+			if (!implode(', ', $user_id))
+			{
+				return array();
+			}
+
+			$sql = 'SELECT *
+				FROM ' . PROFILE_DATA_TABLE . '
+				WHERE user_id IN (' . implode(', ', array_map('intval', $user_id)) . ')';
+			$result = $_CLASS['core_db']->sql_query($sql);
+
+			if (!($row = $_CLASS['core_db']->sql_fetchrow($result)))
+			{
+				return array();
+			}
+			
+			$user_fields = array();
+			do
+			{
+				foreach ($row as $ident => $value)
+				{
+					if (isset($this->profile_cache[$ident]))
+					{
+						$user_fields[$row['user_id']][$ident]['value'] = $value;
+						$user_fields[$row['user_id']][$ident]['data'] = $this->profile_cache[$ident];
+					}
+					else if($i = strpos($ident, '_bbcode'))
+					{
+						// Add extra data (bbcode_uid and bbcode_bitfield) to the data for this profile field.
+						// TODO: Maybe we should try to make this a bit more generic (not limited to bbcode)?
+						$field = substr($ident, 0, $i);
+						$subfield = substr($ident, $i+1);
+						$user_fields[$row['user_id']][$field]['data'][$subfield] = $value;
+					}
+				}
+			} 
+			while ($row = $_CLASS['core_db']->sql_fetchrow($result));
+			
+			$_CLASS['core_db']->sql_freeresult($result);
+
+			return $user_fields;
+
+		}
+		elseif ($mode == 'show')
+		{
+			// $profile_row == $user_fields[$row['user_id']];
+			$tpl_fields = array();
+			$tpl_fields['row'] = $tpl_fields['blockrow'] = array();
+
+			foreach ($profile_row as $ident => $ident_ary)
+			{
+				$tpl_fields['row'] += array(
+					'PROFILE_' . strtoupper($ident) . '_VALUE'	=> $this->get_profile_value($ident_ary),
+					'PROFILE_' . strtoupper($ident) . '_TYPE'	=> $ident_ary['data']['field_type'],
+					'PROFILE_' . strtoupper($ident) . '_NAME'	=> $ident_ary['data']['lang_name'],
+					'PROFILE_' . strtoupper($ident) . '_EXPLAIN'=> $ident_ary['data']['lang_explain'],
+
+					'S_PROFILE_' . strtoupper($ident)			=> true
+				);
+				
+				$tpl_fields['blockrow'][] = array(
+					'PROFILE_FIELD_VALUE'   => $this->get_profile_value($ident_ary),
+					'PROFILE_FIELD_TYPE'    => $ident_ary['data']['field_type'],
+					'PROFILE_FIELD_NAME'    => $ident_ary['data']['lang_name'],
+					'PROFILE_FIELD_EXPLAIN' => $ident_ary['data']['lang_explain'],
+					'S_PROFILE_' . strtoupper($ident)               => true
+				);
+			}
+		
+			return $tpl_fields;
+		}
+	}
+	
+	// VALIDATE Function - validate entered data
+	function validate_profile_field($field_type, &$field_value, $field_data)
+	{
+		switch ($field_type)
+		{
+			case FIELD_INT:
+			case FIELD_DROPDOWN:
+				$field_value = (int) $field_value;
+				break;
+
+			case FIELD_BOOL:
+				$field_value = (bool) $field_value;
+				break;
+		}
+
+		switch ($field_type)
+		{
+			case FIELD_DATE:
+				$field_validate = explode('-', $field_value);
+				
+				$day = (int) $field_validate[0];
+				$month = (int) $field_validate[1];
+				$year = (int) $field_validate[2];
+
+				if ((!$day || !$month || !$year) && !$field_data['field_required'])
+				{
+					return false;
+				}
+
+				if ((!$day || !$month || !$year) && $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+
+				if ($day < 0 || $day > 31 || $month < 0 || $month > 12 || ($year < 1901 && $year > 0) || $year > gmdate('Y', time()))
+				{
+					return 'FIELD_INVALID_DATE';
+				}
+				break;
+
+			case FIELD_INT:
+				if (empty($field_value) && !$field_data['field_required'])
+				{
+					return false;
+				}
+
+				if ($field_value < $field_data['field_minlen'])
+				{
+					return 'FIELD_TOO_SMALL';
+				}
+				else if ($field_value > $field_data['field_maxlen']) 
+				{
+					return 'FIELD_TOO_LARGE';
+				}
+				break;
+		
+			case FIELD_DROPDOWN:
+				if ($field_value == $field_data['field_novalue'] && $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+				break;
+			
+			case FIELD_STRING:
+			case FIELD_TEXT:
+				if (empty($field_value) && !$field_data['field_required'])
+				{
+					return false;
+				}
+				else if (empty($field_value) && $field_data['field_required'])
+				{
+					return 'FIELD_REQUIRED';
+				}
+
+				if ($field_data['field_minlen'] && strlen($field_value) < $field_data['field_minlen'])
+				{
+					return 'FIELD_TOO_SHORT';
+				}
+				else if ($field_data['field_maxlen'] && strlen($field_value) > $field_data['field_maxlen'])
+				{
+					return 'FIELD_TOO_LONG';
+				}
+
+				if (!empty($field_data['field_validation']) && $field_data['field_validation'] != '.*')
+				{
+					$field_validate = ($field_type == FIELD_STRING) ? $field_value : str_replace("\n", ' ', $field_value);
+					if (!preg_match('#^' . str_replace('\\\\', '\\', $field_data['field_validation']) . '$#i', $field_validate))
+					{
+						return 'FIELD_INVALID_CHARS';
+					}
+				}
+				break;
+		}
+
+		return false;
+	}
+
+	// Get Profile Value for display
+	function get_profile_value($ident_ary)
+	{
+		$value = $ident_ary['value'];
+		$field_type = $ident_ary['data']['field_type'];
+		
+		switch ($this->profile_types[$field_type])
+		{
+			case 'int':
+				return (int) $value;
+				break;
+			case 'string':
+				return str_replace("\n", '<br />', $value);
+				break;
+			case 'text':
+				// Prepare further, censor_text, smilies, bbcode, html, whatever
+				if ($ident_ary['data']['bbcode_bitfield'])
+				{
+					$bbcode = new bbcode($ident_ary['data']['bbcode_bitfield']);
+					$bbcode->bbcode_second_pass($value, $ident_ary['data']['bbcode_uid'], $ident_ary['data']['bbcode_bitfield']);
+					$value = smiley_text($value);
+					$value = censor_text($value);
+				}
+				
+				return str_replace("\n", '<br />', $value);
+				break;
+			case 'date':
+				break;
+			case 'dropdown':
+				$field_id = $ident_ary['data']['field_id'];
+				$lang_id = $ident_ary['data']['lang_id'];
+				if (!isset($this->options_lang[$field_id][$lang_id]))
+				{
+					$this->get_option_lang($field_id, $lang_id, FIELD_DROPDOWN, false);
+				}
+
+				return $this->options_lang[$field_id][$lang_id][(int) $value];
+				break;
+			case 'bool':
+				break;
+			default:
+				trigger_error('Unknown profile type');
+				break;
+		}
+	}
+
+	// Get field value for registration/profile
+	function get_var($field_validation, &$profile_row, $default_value, $preview)
+	{
+		global $_CLASS;
+
+		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
+		
+		// checkbox - only testing for isset
+		if ($profile_row['field_type'] == FIELD_BOOL && $profile_row['field_length'] == 2)
+		{
+			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? true : ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $default_value : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]);
+		}
+		else
+		{
+			$value = (isset($_REQUEST[$profile_row['field_ident']])) ? request_var($profile_row['field_ident'], $default_value) : ((!isset($_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]) || $preview) ? $default_value : $_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident'])]);
+		}
+
+		switch ($field_validation)
+		{
+			case 'int':
+				return (int) $value;
+				break;
+		}
+
+		return $value;
+	}
+	
+	// GENERATE_* Functions - return templated, storable profile fields
+	function generate_int($profile_row, $preview = false)
+	{
+		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+		$this->set_tpl_vars($profile_row, $value);
+
+		return $this->get_cp_html();
+	}
+
+	function generate_date($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$profile_row['field_ident'] = (isset($profile_row['var_name'])) ? $profile_row['var_name'] : 'pf_' . $profile_row['field_ident'];
+		$now = getdate();
+
+		if (!isset($_REQUEST[$profile_row['field_ident'] . '_day']))
+		{
+			if ($profile_row['field_default_value'] == 'now')
+			{
+				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+			}
+			list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]));
+		}
+		else
+		{
+			if ($preview && $profile_row['field_default_value'] == 'now')
+			{
+				$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+				list($day, $month, $year) = explode('-', ((!isset($_CLASS['core_user']->profile_fields[$profile_row['field_ident']]) || $preview) ? $profile_row['field_default_value'] : $_CLASS['core_user']->profile_fields[$profile_row['field_ident']]));
+			}
+			else
+			{
+				$day = request_var($profile_row['field_ident'] . '_day', 0);
+				$month = request_var($profile_row['field_ident'] . '_month', 0);
+				$year = request_var($profile_row['field_ident'] . '_year', 0);
+			}
+		}
+
+		$profile_row['s_day_options'] = '<option value="0"' . ((!$day) ? ' selected="selected"' : '') . '>--</option>';
+		for ($i = 1; $i < 32; $i++)
+		{
+			$profile_row['s_day_options'] .= '<option value="' . $i . '"' . (($i == $day) ? ' selected="selected"' : '') . ">$i</option>";
+		}
+
+		$profile_row['s_month_options'] = '<option value="0"' . ((!$month) ? ' selected="selected"' : '') . '>--</option>';
+		for ($i = 1; $i < 13; $i++)
+		{
+			$profile_row['s_month_options'] .= '<option value="' . $i . '"' . (($i == $month) ? ' selected="selected"' : '') . ">$i</option>";
+		}
+
+		$profile_row['s_year_options'] = '<option value="0"' . ((!$year) ? ' selected="selected"' : '') . '>--</option>';
+		for ($i = $now['year'] - 100; $i <= $now['year']; $i++)
+		{
+			$profile_row['s_year_options'] .= '<option value="' . $i . '"' . (($i == $year) ? ' selected="selected"' : '') . ">$i</option>";
+		}
+		unset($now);
+		
+		$this->set_tpl_vars($profile_row, 0);
+		return $this->get_cp_html();
+	}
+
+	function generate_bool($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+
+		$this->set_tpl_vars($profile_row, $value);
+
+		if ($profile_row['field_length'] == 1)
+		{
+			if (!isset($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]) || !sizeof($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
+			{
+				$this->get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_BOOL, $preview);
+			}
+
+			foreach ($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id => $option_value)
+			{
+				$_CLASS['core_template']->assign_vars_array('bool.options', array(
+					'OPTION_ID' => $option_id,
+					'CHECKED' => ($value == $option_id) ? ' checked="checked"' : '',
+					'VALUE' => $option_value)
+				);
+			}
+		}
+
+		return $this->get_cp_html();
+	}
+
+	// Get the data associated with this field for this user
+	function generate_string($profile_row, $preview = false)
+	{
+		$value = $this->get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
+		$this->set_tpl_vars($profile_row, $value);
+
+		return $this->get_cp_html();
+	}
+
+	function generate_text($profile_row, $preview = false)
+	{
+		global $_CLASS, $site_file_root;
+		
+		$value = $this->get_var('', $profile_row, $profile_row['lang_default_value'], $preview);
+		
+		if($preview == false)
+		{
+			include_once($site_file_root.'includes/forums/message_parser.php');
+			include_once($site_file_root.'includes/forums/functions_posting.php');
+			
+			$message_parser = new parse_message();
+			$message_parser->message = $value;
+			$message_parser->decode_message($_CLASS['core_user']->profile_fields[str_replace('pf_', '', $profile_row['field_ident']) . '_bbcode_uid']);
+			$value = $message_parser->message;
+		}
+		
+		$field_length = explode('|', $profile_row['field_length']);
+		$profile_row['field_rows'] = $field_length[0];
+		$profile_row['field_cols'] = $field_length[1];
+
+		$this->set_tpl_vars($profile_row, $value);
+
+		return $this->get_cp_html();
+	}
+
+	function generate_dropdown($profile_row, $preview = false)
+	{
+		global $_CLASS;
+
+		$value = $this->get_var('int', $profile_row, $profile_row['field_default_value'], $preview);
+
+		if (!isset($this->options_lang[$profile_row['field_id']]) || !sizeof($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']]))
+		{
+			$this->get_option_lang($profile_row['field_id'], $profile_row['lang_id'], FIELD_DROPDOWN, $preview);
+		}
+
+		$this->set_tpl_vars($profile_row, $value);
+
+		foreach ($this->options_lang[$profile_row['field_id']][$profile_row['lang_id']] as $option_id => $option_value)
+		{
+			$_CLASS['core_template']->assign_vars_array('dropdown.options', array(
+				'OPTION_ID' => $option_id,
+				'SELECTED' => ($value == $option_id) ? ' selected="selected"' : '',
+				'VALUE' => $option_value)
+			);
+		}
+
+		return $this->get_cp_html();
+	}
+
+
+	// Return Templated value (change == user is able to set/enter profile values; show == just show the value)
+	function process_field_row($mode, $profile_row)
+	{
+		$preview = false;
+
+		switch ($mode)
+		{
+			case 'preview':
+				$preview = true;
+			case 'change':
+				$type_func = 'generate_' . $this->profile_types[$profile_row['field_type']];
+				break;
+			default:
+				return;
+		}
+
+		return $this->$type_func($profile_row, $preview);
+	}
+
+	// Build Array for user insertion into custom profile fields table
+	function build_insert_sql_array($cp_data)
+	{
+		global $_CLASS;
+
+		$sql = 'SELECT f.field_type, f.field_ident, f.field_default_value, l.lang_default_value
+			FROM ' . PROFILE_LANG_TABLE . ' l, ' . PROFILE_FIELDS_TABLE . ' f 
+			WHERE l.lang_id = ' . $_CLASS['core_user']->get_iso_lang_id() . ' 
+				AND f.field_active = 1
+				AND f.field_show_on_reg = 0
+				' . (($_CLASS['auth']->acl_gets('a_', 'm_')) ? '' : ' AND f.field_hide = 0') . '
+				AND l.field_id = f.field_id 
+			GROUP BY f.field_id';
+		$result = $_CLASS['core_db']->sql_query($sql);
+
+		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+		{
+			if ($row['field_default_value'] == 'now' && $row['field_type'] == FIELD_DATE)
+			{
+				$now = getdate();
+				$row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+			}
+			$cp_data[$row['field_ident']] = (in_array($row['field_type'], array(FIELD_TEXT, FIELD_STRING))) ? $row['lang_default_value'] : $row['field_default_value'];
+		}
+		$_CLASS['core_db']->sql_freeresult($result);
+		
+		return $cp_data;
+	}
+
+	function get_profile_field($profile_row)
+	{
+		global $site_file_root;
+		
+		switch ($profile_row['field_type'])
+		{
+			case FIELD_DATE:
+
+				if (!isset($_REQUEST[$var_name . '_day']))
+				{
+					if ($profile_row['field_default_value'] == 'now')
+					{
+						$now = getdate();
+						$profile_row['field_default_value'] = sprintf('%2d-%2d-%4d', $now['mday'], $now['mon'], $now['year']);
+					}
+					list($day, $month, $year) = explode('-', $profile_row['field_default_value']);
+				}
+				else
+				{
+					$day = request_var($var_name . '_day', 0);
+					$month = request_var($var_name . '_month', 0);
+					$year = request_var($var_name . '_year', 0);
+				}
+				
+				$var = sprintf('%2d-%2d-%4d', $day, $month, $year);
+				break;
+
+			case FIELD_TEXT:
+				include_once($site_file_root.'includes/forums/message_parser.php');
+				$message_parser = new parse_message(request_var($var_name, ''));
+				
+				// Get the allowed settings from the global settings. Magic URLs are always set to true.
+				// TODO: It might be nice to make this a per field setting.
+				$message_parser->parse($config['allow_html'], $config['allow_bbcode'], true, $config['allow_smilies']);
+				
+				$var = array(
+					$profile_row['field_ident'] => $message_parser->message,
+					$profile_row['field_ident'] . '_bbcode_uid' => $message_parser->bbcode_uid,
+					$profile_row['field_ident'] . '_bbcode_bitfield' => $message_parser->bbcode_bitfield,
+					 'submitted' => request_var($var_name, '')
+				);
+				break;
+
+			default:
+				$var = request_var($var_name, $profile_row['field_default_value']);
+				break;
+		}
+
+		return $var;
+	}
+
+	function set_tpl_vars($profile_row, $field_value)
+	{
+		global $_CLASS;
+		
+		foreach ($this->profile_types as $field_case => $field_type)
+		{
+			unset($_CLASS['core_template']->_tpl_vars[$field_type]);
+		}
+
+		foreach ($profile_row as $key => $value)
+		{
+			unset($profile_row[$key]);
+			$profile_row[strtoupper($key)] = $value;
+		}
+
+		$profile_row['FIELD_VALUE'] = $field_value;
+
+		$_CLASS['core_template']->assign_vars_array($this->profile_types[$profile_row['FIELD_TYPE']], $profile_row);
+	}
+
+	function get_cp_html()
+	{
+		global $_CLASS;
+
+		ob_start();
+
+		$_CLASS['core_template']->display('forums/custom_profile_fields.html');
+
+		$data = ob_get_contents();
+		ob_end_clean();
+
+		return $data;
+	}
+}
+
+class custom_profile_admin extends custom_profile
+{
+	var $vars = array();
+	
+
+	function validate_options()
+	{
+		global $_CLASS;
+
+		$validate_ary = array('CHARS_ANY' => '.*', 'NUMBERS_ONLY' => '[0-9]+', 'ALPHA_ONLY' => '[\w]+', 'ALPHA_SPACERS' => '[\w_\+\. \-\[\]]+');
+
+		$validate_options = '';
+		foreach ($validate_ary as $lang => $value)
+		{
+			$selected = ($this->vars['field_validation'] == $value) ? ' selected="selected"' : '';
+			$validate_options .= '<option value="' . $value . '"' . $selected . '>' . $_CLASS['core_user']->lang[$lang] . '</option>';
+		}
+
+		return $validate_options;
+	}
+	
+	// GET_* get admin options for second step
+	function get_string_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<input class="post" type="text" name="field_length" size="5" value="' . $this->vars['field_length'] . '" />'),
+			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="5" value="' . $this->vars['field_minlen'] . '" />'),
+			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="5" value="' . $this->vars['field_maxlen'] . '" />'),
+			3 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_VALIDATION'], 'FIELD' => '<select name="field_validation">' . $this->validate_options() . '</select>')
+		);
+
+		return $options;
+	}
+
+	function get_text_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<table border=0><tr><td><input name="rows" size="5" value="' . $this->vars['rows'] . '" class="post" /></td><td>[ ' . $_CLASS['core_user']->lang['ROWS'] . ' ]</td></tr><tr><td><input name="columns" size="5" value="' . $this->vars['columns'] . '" class="post" /></td><td>[ ' . $_CLASS['core_user']->lang['COLUMNS'] . ' ] <input type="hidden" name="field_length" value="' . $this->vars['field_length'] . '" /></td></tr></table>'),
+			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="10" value="' . $this->vars['field_minlen'] . '" />'),
+			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_CHARS'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="10" value="' . $this->vars['field_maxlen'] . '" />'),
+			3 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_VALIDATION'], 'FIELD' => '<select name="field_validation">' . $this->validate_options() . '</select>')
+		);
+
+		return $options;
+	}
+
+	function get_int_options()
+	{
+		global $_CLASS;
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_LENGTH'], 'FIELD' => '<input class="post" type="text" name="field_length" size="5" value="' . $this->vars['field_length'] . '" />'),
+			1 => array('TITLE' => $_CLASS['core_user']->lang['MIN_FIELD_NUMBER'], 'FIELD' => '<input class="post" type="text" name="field_minlen" size="5" value="' . $this->vars['field_minlen'] . '" />'),
+			2 => array('TITLE' => $_CLASS['core_user']->lang['MAX_FIELD_NUMBER'], 'FIELD' => '<input class="post" type="text" name="field_maxlen" size="5" value="' . $this->vars['field_maxlen'] . '" />'),
+			3 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => '<input class="post" type="post" name="field_default_value" value="' . $this->vars['field_default_value'] . '" />')
+		);
+
+		return $options;
+	}
+
+	function get_bool_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row = array(
+			'var_name'				=> 'field_default_value',
+			'field_id'				=> 1,
+			'lang_name'				=> $this->vars['lang_name'],
+			'lang_explain'			=> $this->vars['lang_explain'],
+			'lang_id'				=> $default_lang_id,
+			'field_default_value'	=> $this->vars['field_default_value'],
+			'field_ident'			=> 'field_default_value',
+			'field_type'			=> FIELD_BOOL,
+			'field_length'			=> $this->vars['field_length'],
+			'lang_options'			=> $this->vars['lang_options']
+		);
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['FIELD_TYPE'], 'EXPLAIN' => $_CLASS['core_user']->lang['BOOL_TYPE_EXPLAIN'], 'FIELD' => '<input type="radio" name="field_length" value="1"' . (($this->vars['field_length'] == 1) ? ' checked="checked"' : '') . ' />' . $_CLASS['core_user']->lang['RADIO_BUTTONS'] . '&nbsp; &nbsp;<input type="radio" name="field_length" value="2"' . (($this->vars['field_length'] == 2) ? ' checked="checked"' : '') . ' />' . $_CLASS['core_user']->lang['CHECKBOX'] . '&nbsp; &nbsp;'),
+			1 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_bool($profile_row, true))
+		);
+
+		return $options;
+	}
+
+	function get_dropdown_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row[0] = array(
+			'var_name'				=> 'field_default_value',
+			'field_id'				=> 1,
+			'lang_name'				=> $this->vars['lang_name'],
+			'lang_explain'			=> $this->vars['lang_explain'],
+			'lang_id'				=> $default_lang_id,
+			'field_default_value'	=> $this->vars['field_default_value'],
+			'field_ident'			=> 'field_default_value',
+			'field_type'			=> FIELD_DROPDOWN,
+			'lang_options'			=> $this->vars['lang_options']
+		);
+
+		$profile_row[1] = $profile_row[0];
+		$profile_row[1]['var_name'] = 'field_novalue';
+		$profile_row[1]['field_ident'] = 'field_novalue';
+		$profile_row[1]['field_default_value']	= $this->vars['field_novalue'];
+
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_dropdown($profile_row[0], true)),
+			1 => array('TITLE' => $_CLASS['core_user']->lang['NO_VALUE_OPTION'], 'EXPLAIN' => $_CLASS['core_user']->lang['NO_VALUE_OPTION_EXPLAIN'], 'FIELD' => $this->generate_dropdown($profile_row[1], true))
+		);
+
+		return $options;
+	}
+
+	function get_date_options()
+	{
+		global $_CLASS, $config, $lang_defs;
+
+		$default_lang_id = $lang_defs['iso'][$config['default_lang']];
+
+		$profile_row = array(
+			'var_name'				=> 'field_default_value',
+			'lang_name'				=> $this->vars['lang_name'],
+			'lang_explain'			=> $this->vars['lang_explain'],
+			'lang_id'				=> $default_lang_id,
+			'field_default_value'	=> $this->vars['field_default_value'],
+			'field_ident'			=> 'field_default_value',
+			'field_type'			=> FIELD_DATE,
+			'field_length'			=> $this->vars['field_length']
+		);
+
+		$options = array(
+			0 => array('TITLE' => $_CLASS['core_user']->lang['DEFAULT_VALUE'], 'FIELD' => $this->generate_date($profile_row, true) . '<br /><input type="checkbox" name="always_now"' . ((isset($_REQUEST['always_now']) || $this->vars['field_default_value'] == 'now') ? ' checked="checked"' : '') . ' />&nbsp; ' . $_CLASS['core_user']->lang['ALWAYS_TODAY'])
+		);
+
+		return $options;
+	}
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -755,7 +755,8 @@
 
 		// Parse smilies
 		if ($allow_smilies)
-		{
+		{	
+$config['max_' . $mode . '_smilies'] = 0;
 			$this->smilies($config['max_' . $mode . '_smilies']);
 		}
 		$num_urls = 0;
@@ -781,7 +782,7 @@
 		if ($allow_magic_url)
 		{
 			$this->magic_url();
-	
+$config['max_' . $mode . '_urls'] = 0;
 			if ($config['max_' . $mode . '_urls'])
 			{
 				$num_urls += preg_match_all('#\<!-- (l|m|w|e) --\>.*?\<!-- \1 --\>#', $this->message, $matches);
@@ -789,7 +790,8 @@
 		}
 		
 		// Check number of links
-		if ($config['max_' . $mode . '_urls'] && $num_urls > $config['max_' . $mode . '_urls'])
+//max_sig_urls
+		if (isset($config['max_' . $mode . '_urls']) && $config['max_' . $mode . '_urls'] && $num_urls > $config['max_' . $mode . '_urls'])
 		{
 			$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['TOO_MANY_URLS'], $config['max_' . $mode . '_urls']);
 			return $this->warn_msg;

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -149,8 +149,14 @@
 
 	if ($_CORE_CONFIG['maintenance']['active'])
 	{
-		if ($_CORE_CONFIG['maintenance']['start'] < time())
+		if ($_CORE_CONFIG['maintenance']['start'] < gmtime())
 		{
+// TEMP fix maybe
+			if (get_variable('mod', 'REQUEST', false) === 'system' && get_variable('mode', 'REQUEST', false) === 'confirmation_image')
+			{
+				return $maintance_status = false;
+			}
+
 			if (VIPERAL == 'Admin' || (isset($_CLASS['core_user']) && $_CLASS['core_user']->is_admin))
 			{
 				return $maintance_status = false;

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/functions_user.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -541,4 +541,195 @@
 	return true;
 }
 
+
+
+/***
+Temp copy from phpBB function_user.php
+***/
+function validate_string($string, $optional = false, $min = 0, $max = 0)
+{
+	if (empty($string) && $optional)
+	{
+		return false;
+	}
+
+	if ($min && strlen($string) < $min)
+	{
+		return 'TOO_SHORT';
+	}
+	else if ($max && strlen($string) > $max)
+	{
+		return 'TOO_LONG';
+	}
+
+	return false;
+}
+
+function validate_num($num, $optional = false, $min = 0, $max = 1E99)
+{
+	if (empty($num) && $optional)
+	{
+		return false;
+	}
+
+	if ($num < $min)
+	{
+		return 'TOO_SMALL';
+	}
+	else if ($num > $max) 
+	{
+		return 'TOO_LARGE';
+	}
+
+	return false;
+}
+
+function validate_match($string, $optional = false, $match)
+{
+	if (empty($string) && $optional)
+	{
+		return false;
+	}
+
+	if (!preg_match($match, $string))
+	{
+		return 'WRONG_DATA';
+	}
+	return false;
+}
+
+// TODO?
+// Ability to limit types of email address ... not by banning, seperate table
+// capability to require (or deny) use of certain addresses when user is
+// registering from certain IP's/hosts
+
+// Check to see if email address is banned or already present in the DB
+function validate_email($email)
+{
+	global $_CORE_CONFIG, $_CLASS;
+
+	if (strtolower($_CLASS['core_user']->data['user_email']) == strtolower($email))
+	{
+		return false;
+	}
+
+	if (!preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email))
+	{
+		return 'EMAIL_INVALID';
+	}
+
+	$sql = 'SELECT ban_email
+		FROM ' . BANLIST_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		if (preg_match('#^' . str_replace('*', '.*?', $row['ban_email']) . '$#i', $email))
+		{
+			return 'EMAIL_BANNED';
+		}
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$_CORE_CONFIG['user']['allow_emailreuse'])
+	{
+		$sql = 'SELECT user_email_hash
+			FROM ' . USERS_TABLE . "
+			WHERE user_email_hash = " . crc32(strtolower($email)) . strlen($email);
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			return 'EMAIL_TAKEN';
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	return false;
+}
+
+//
+// Avatar functions
+//
+
+function avatar_delete($id)
+{
+	global $config, $_CORE_CONFIG;
+
+	if (file_exists($config['avatar_path'] . '/' . $id))
+	{
+		@unlink($config['avatar_path'] . '/' . $id);
+	}
+
+	return false;
+ }
+
+function avatar_remote($data, &$error)
+{
+	global $config, $_CLASS;
+
+	if (!preg_match('#^(http|https|ftp)://#i', $data['remotelink']))
+	{
+		$data['remotelink'] = 'http://' . $data['remotelink'];
+	}
+
+	if (!preg_match('#^(http|https|ftp)://(.*?\.)*?[a-z0-9\-]+?\.[a-z]{2,4}:?([0-9]*?).*?\.(gif|jpg|jpeg|png)$#i', $data['remotelink']))
+	{
+		$error[] = $_CLASS['core_user']->lang['AVATAR_URL_INVALID'];
+		return false;
+	}
+
+	if ((!($data['width'] || $data['height']) || $data['remotelink'] != $_CLASS['core_user']->data['user_avatar']) && ($config['avatar_max_width'] || $config['avatar_max_height']))
+	{
+		list($width, $height) = @getimagesize($data['remotelink']);
+
+		if (!$width || !$height)
+		{
+			$error[] = $_CLASS['core_user']->lang['AVATAR_NO_SIZE'];
+			return false;
+		}
+		else if ($width > $config['avatar_max_width'] || $height > $config['avatar_max_height'])
+		{
+			$error[] = sprintf($_CLASS['core_user']->lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
+			return false;
+		}
+	}
+	else if ($data['width'] > $config['avatar_max_width'] || $data['height'] > $config['avatar_max_height'])
+	{
+		$error[] = sprintf($_CLASS['core_user']->lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
+		return false;
+	}
+
+	return array(AVATAR_REMOTE, $data['remotelink'], $width, $height);
+}
+
+function avatar_upload($data, &$error)
+{
+	global $site_file_root, $config, $_CLASS;
+
+	// Init upload class
+	include_once($site_file_root.'includes/forums/functions_upload.php');
+	
+	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
+							
+	if (!empty($_FILES['uploadfile']['name']))
+	{
+		$file = $upload->form_upload('uploadfile');
+	}
+	else
+	{
+		$file = $upload->remote_upload($data['uploadurl']);
+	}
+
+	$file->clean_filename('real', $_CLASS['core_user']->data['user_id'] . '_');
+	$file->move_file($config['avatar_path']);
+
+	if (sizeof($file->error))
+	{
+		$file->remove();
+		$error = array_merge($error, $file->error);
+	}
+	
+	return array(AVATAR_UPLOAD, $file->get('realname'), $file->get('width'), $file->get('height'));
+}
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/includes/tables.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -191,6 +191,7 @@
 define('FORUMS_PRIVMSGS_RULES_TABLE', $table_prefix.'forums_privmsgs_rules');
 define('FORUMS_REPORTS_TABLE', $table_prefix.'forums_reports');
 define('FORUMS_REASONS_TABLE', $table_prefix.'forums_reports_reasons');
+define('FORUMS_SITELIST_TABLE', $table_prefix.'forums_sitelist');
 define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
 define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
 define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/install/build_tables.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -946,4 +946,17 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+
+
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_sitelist');
+
+$_CLASS['core_db']->add_table_field_int('site_id', array('max' => 16000000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('site_ip', 40);
+$_CLASS['core_db']->add_table_field_char('site_hostname', 255);
+$_CLASS['core_db']->add_table_field_int('ip_exclude', array('max' => 1));
+
+$_CLASS['core_db']->add_table_index('site_id', 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/installer.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -95,6 +95,8 @@
 	}
 }
 
+unset($holding_array);
+
 $error = array();
 $stage = isset($_POST['stage']) ? (int) $_POST['stage'] : 0;
 
@@ -320,7 +322,7 @@
 		require_once($site_file_root.'includes/tables.php');
 	
 		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
-		$result = $_CLASS['core_db']->query($sql);
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
 		$_CLASS['core_db']->free_result($result);
 	
 		if ($result)
@@ -349,67 +351,79 @@
 	
 		$config_data = "<?php\n\n";
 
-		foreach ($site_db as $name => $value)
+		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$_CLASS['core_db']->free_result($result);
+	
+		if (!$result)
 		{
-			if (is_bool($value))
+			$stage = 2;
+			$error[] = 'Installation failed<br/> Please confirm that your using the currect database layer';
+		}
+		else
+		{
+			foreach ($site_db as $name => $value)
 			{
-				$value = ($value) ? 'true' : 'false';
+				if (is_bool($value))
+				{
+					$value = ($value) ? 'true' : 'false';
+				}
+				elseif (!is_int($value))
+				{
+					$value = "'$value'";
+				}
+	
+				$config_data .= "\$site_db['$name'] = $value;\n";
 			}
-			elseif (!is_int($value))
+	
+			$config_data .= "\n";
+			$config_data .= "\$table_prefix\t= '$table_prefix';\n";
+			$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
+			$config_data .= "\$acm_type\t\t= 'file';\n\n";
+			$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
+			$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
+			$config_data .= '?>';
+	
+			if (file_put_contents($site_file_root.'config.php', $config_data))
 			{
-				$value = "'$value'";
+				$config_data = false;
 			}
-
-			$config_data .= "\$site_db['$name'] = $value;\n";
+			else
+			{
+				$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
+			}
+			
+			$path = dirname(getenv('SCRIPT_NAME'));
+	
+			if (substr($path, -1) != '/')
+			{
+				$path .= '/';
+			}
+	
+			$path = str_replace('install/', '', $path);
+			$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
+	
+			$_CLASS['core_template']->assign_array(array(
+				'site_name'			=> 'New CMS Site',
+				'site_domain'		=> $domain,
+				'site_path'			=> $path,
+				'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
+				'cookie_domain'		=> $domain,
+				'cookie_path'		=> $path,
+				'cookie_name'		=> 'cms',
+				'username'			=> '',
+				'password'			=> '',
+				'password_confirm'	=> '',
+				'email'				=> '',
+				'email_confirm'		=> '',
+				'error'				=> empty($error) ? false : implode('<br/>', $error),
+				'config_content'	=> $config_data
+			));
+	
+			$_CLASS['core_template']->display('installer/stage3.html');
+	
+			script_close();
 		}
-
-		$config_data .= "\n";
-		$config_data .= "\$table_prefix\t= '$table_prefix';\n";
-		$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
-		$config_data .= "\$acm_type\t\t= 'file';\n\n";
-		$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
-		$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
-		$config_data .= '?>';
-
-		if (file_put_contents($site_file_root.'config.php', $config_data))
-		{
-			$config_data = false;
-		}
-		else
-		{
-			$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
-		}
-		
-		$path = dirname(getenv('SCRIPT_NAME'));
-
-		if (substr($path, -1) != '/')
-		{
-			$path .= '/';
-		}
-
-		$path = str_replace('install/', '', $path);
-		$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
-
-		$_CLASS['core_template']->assign_array(array(
-			'site_name'			=> 'New CMS Site',
-			'site_domain'		=> $domain,
-			'site_path'			=> $path,
-			'site_port'			=> ($_SERVER['SERVER_PORT'] == 80) ? '' : $_SERVER['SERVER_PORT'],
-			'cookie_domain'		=> $domain,
-			'cookie_path'		=> $path,
-			'cookie_name'		=> 'cms',
-			'username'			=> '',
-			'password'			=> '',
-			'password_confirm'	=> '',
-			'email'				=> '',
-			'email_confirm'		=> '',
-			'error'				=> empty($error) ? false : implode('<br/>', $error),
-			'config_content'	=> $config_data
-		));
-
-		$_CLASS['core_template']->display('installer/stage3.html');
-
-		script_close();
 	}
 }
 

Modified: cms/trunk/javascript/forums/forum_view.js
===================================================================
--- cms/trunk/javascript/forums/forum_view.js	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/javascript/forums/forum_view.js	2005-09-15 19:09:49 UTC (rev 125)
@@ -33,7 +33,6 @@
 	input.size = 50;
 	input.className = 'post';
 	input.value = title.innerHTML;
-	//input.title = title.innerHTML;
 	input.id = mode + '_input_' + id;
 	input.onblur =	function()
 	{

Added: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/javascript/quick_messages.js	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,45 @@
+// By Ryan Marshall ( viperal1 at gmail.com )
+
+function quick_message_submit()
+{
+	var message = document.getElementById('message');
+	var poster_name = document.getElementById('poster_name');
+
+	if (!poster_name)
+	{
+		poster_name = '';
+	}
+
+	ajax = new core_ajax();
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() && ajax.responseText())
+		{
+			var area = document.getElementById('qm_block');
+			area.innerHTML = ajax.responseText();
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	ajax.send('index.php?mod=Quick_Message&mode=ajax_add', '&poster_name=' + poster_name.value + '&message=' + message.value);
+}
+
+function quick_message_refresh()
+{
+	ajax = new core_ajax();
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() && ajax.responseText())
+		{
+			var area = document.getElementById('qm_block');
+			area.innerHTML = ajax.responseText();
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	ajax.send('index.php?mod=Quick_Message&mode=ajax_refresh', null);
+}
\ No newline at end of file

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -26,7 +26,7 @@
 		$confirm = (isset($_POST['confirm'])) ? true : false;
 		$delete_ids = isset($_REQUEST['attachment']) ? array_keys(array_map('intval', $_REQUEST['attachment'])) : array();
 		
-		if ($delete && sizeof($delete_ids))
+		if (!empty($delete_ids))
 		{
 			$s_hidden_fields = '<input type="hidden" name="delete" value="1" />';
 			foreach ($delete_ids as $attachment_id)
@@ -128,9 +128,13 @@
 			} 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 		}
+		else
+		{
+			$_CLASS['core_template']->assign('S_ATTACHMENT_ROWS', false);
+		}
 		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign(array( 
+		$_CLASS['core_template']->assign_array(array( 
 			'PAGE_NUMBER'			=> on_page($num_attachments, $config['posts_per_page'], $start),
 			'PAGINATION'			=> generate_pagination("Control_Panel&amp;i=$id&amp;sk=$sort_key&amp;sd=$sort_dir", $num_attachments, $config['posts_per_page'], $start),
 			'TOTAL_ATTACHMENTS'		=> $num_attachments,

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -185,7 +185,7 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_DISPLAY_FORM', true,
 			'S_UCP_ACTION' => ''
 		));

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -21,8 +21,6 @@
 		$error = $data = array();
 		$s_hidden_fields = '';
 
-		require_once($site_file_root.'includes/forums/functions_user.php');
-
 		switch($mode)
 		{
 			case 'personal':
@@ -129,7 +127,7 @@
 				$theme = (isset($theme)) ? $theme : $_CLASS['core_user']->data['user_theme'];
 				$tz = (isset($tz)) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
 
-				$_CLASS['core_template']->assign(array( 
+				$_CLASS['core_template']->assign_array(array( 
 					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
 
 					'VIEW_EMAIL_YES'	=> $view_email_yes, 
@@ -304,7 +302,7 @@
 				$wordcensor_yes = ($wordcensor) ? ' checked="checked"' : '';
 				$wordcensor_no = (!$wordcensor) ? ' checked="checked"' : '';
 
-				$_CLASS['core_template']->assign(array( 
+				$_CLASS['core_template']->assign_array(array( 
 					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
 					
 					'VIEW_IMAGES_YES'		=> $images_yes, 
@@ -390,7 +388,7 @@
 				$notify_yes = ($notify) ? ' checked="checked"' : '';
 				$notify_no = (!$notify) ? ' checked="checked"' : '';
 
-				$_CLASS['core_template']->assign(array( 
+				$_CLASS['core_template']->assign_array(array( 
 					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
 
 					'DEFAULT_BBCODE_YES'	=> $bbcode_yes, 
@@ -407,7 +405,7 @@
 				break;
 		}
 
-		$_CLASS['core_template']->assign(array( 
+		$_CLASS['core_template']->assign_array(array( 
 			'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PREFS_' . strtoupper($mode)],
 			'S_PRIVMSGS'		=> false,
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,16 +1,26 @@
 <?php
-// -------------------------------------------------------------
-//
-// $Id: ucp_profile.php,v 1.38 2004/09/16 18:33:21 acydburn Exp $
-//
-// FILENAME  : ucp_profile.php
-// STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_profile extends module
 {
 	function ucp_profile($id, $mode)
@@ -28,167 +38,61 @@
 		switch ($mode)
 		{
 			case 'reg_details':
-
 				if ($submit)
 				{
-					$var_ary = array(
-						'username'			=> $_CLASS['core_user']->data['username'], 
-						'email'				=> $_CLASS['core_user']->data['user_email'], 
-						'email_confirm'		=> (string) '',
-						'new_password'		=> (string) '', 
-						'cur_password'		=> (string) '', 
-						'password_confirm'	=> (string) '', 
-					);
+					$password		= get_variable('new_password', 'POST', false);
+					$cur_password	= get_variable('cur_password', 'POST', false);
 
-					foreach ($var_ary as $var => $default)
+					if (!$cur_password || encode_password($cur_password, $_CLASS['core_user']->data['user_password_encoding']) !== $_CLASS['core_user']->data['user_password'])
 					{
-						$data[$var] = request_var($var, $default);
+						$error[] = $_CLASS['core_user']->get_lang('CURRENT_PASSWORD_INVALID');
 					}
 
-					$var_ary = array(
-						'username'			=> array(
-							array('string', false, $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']), 
-							array('username', $data['username'])),
-						'password_confirm'	=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						'new_password'		=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						//'cur_password'		=> array('string', true, $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
-						'email'				=> array(
-							array('string', false, 6, 60), 
-							array('email', $data['email'])),
-						'email_confirm'		=> array('string', true, 6, 60), 
-					);
-
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if ($new_password && $password_confirm != $new_password)
+					if (!$password || $password !== get_variable('password_confirm', 'POST', ''))
 					{
-						$error[] = 'NEW_PASSWORD_ERROR';
+						$error[] = $_CLASS['core_user']->get_lang('PASSWORD_MISMATCH');
 					}
 
-					if (($new_password || ($_CLASS['auth']->acl_get('u_chgemail') && $email != $_CLASS['core_user']->data['user_email']) || ($username != $_CLASS['core_user']->data['username'] && $_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange'])) && encode_password($cur_password, $_CLASS['core_user']->data['user_password_encoding']) != $_CLASS['core_user']->data['user_password'])
+					if (empty($error) && $password === $cur_password)
 					{
-						$error[] = 'CUR_PASSWORD_ERROR';
+						$error[] = $_CLASS['core_user']->get_lang('PASSWORD_SAME');
 					}
 
-					if ($_CLASS['auth']->acl_get('u_chgemail') && $email != $_CLASS['core_user']->data['user_email'] && $email_confirm != $email)
+					if (empty($error))
 					{
-						$error[] = 'NEW_EMAIL_ERROR';
-					}
-
-					if (!sizeof($error))
-					{
-						$sql_ary = array(
-							//'username'			=> ($_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange']) ? $username : $_CLASS['core_user']->data['username'], 
-							'user_email'		=> ($_CLASS['auth']->acl_get('u_chgemail')) ? $email : $_CLASS['core_user']->data['user_email'], 
-							//'user_password'		=> ($new_password) ? md5($new_password) : $_CLASS['core_user']->data['user_password'], 
-							//'user_passchg'		=> time(), 
+						$array = array(
+							'user_password' => encode_password($password, $_CLASS['core_user']->data['user_password_encoding']),
 						);
-
-						if ($_CORE_CONFIG['email']['email_enable'] && $email != $_CLASS['core_user']->data['user_email'] && ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN))
-						{
-							$template_file = ($config['require_activation'] == USER_ACTIVATION_ADMIN) ? 'user_activate_inactive.html' : 'user_activate.html';
-							$mailer = new core_mailer;
-
-							$messenger->template($template_file, $_CLASS['core_user']->data['user_lang']);
-							$mailer->subject($subject);
-
-							$messenger->to($email, $username);
-							$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-							$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-							$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-							$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
-
-							$messenger->assign_vars(array(
-								'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
-								'USERNAME'		=> $username,
-								'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-								'U_ACTIVATE'    => generate_link("Control_Panel&amp;mode=activate&u={$_CLASS['core_user']->data['user_id']}&k=$user_actkey", array('full' => true)))
-							);
-
-							$body = trim($_CLASS['core_template']->display('modules/Contact/email/index.html', true));
-
-							$messenger->send(NOTIFY_EMAIL);
-
-							if ($_CORE_CONFIG['user']['require_activation'] == USER_ACTIVATION_ADMIN)
-							{
-								// Grab an array of user_id's with a_user permissions
-								$admin_ary = $_CLASS['auth']->acl_get_list(false, 'a_user', false);
-
-								$sql = 'SELECT user_id, username, user_email, user_lang, user_jabber, user_notify_type
-									FROM ' . USERS_TABLE . ' 
-									WHERE user_id IN (' . implode(', ', $admin_ary[0]['a_user']) .')';
-								$result = $_CLASS['core_db']->sql_query($sql);
-
-								while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-								{
-									$messenger->template('admin_activate', $row['user_lang']);
-									$messenger->replyto($config['board_contact']);
-									$messenger->to($row['user_email'], $row['username']);
-									$messenger->im($row['user_jabber'], $row['username']);
-
-									$messenger->assign_vars(array(
-										'USERNAME'		=> $username,
-										'EMAIL_SIG'		=> str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']),
-										'U_ACTIVATE'    => generate_link("Control_Panel&amp;mode=activate&u={$_CLASS['core_user']->data['user_id']}&k=$user_actkey", array('full' => true)))
-									);
-
-									$messenger->send($row['user_notify_type']);
-								}
-								$_CLASS['core_db']->sql_freeresult($result);
-							}
-
-							$messenger->save_queue();
-
-							$sql_ary += array(
-								'user_type'		=> USER_INACTIVE,
-								'user_actkey'	=> $user_actkey
-							);
-						}
-
+						
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
+							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $array) . ' 
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->sql_query($sql);
 
-						// Need to update config, forum, topic, posting, messages, etc.
-						if ($username != $_CLASS['core_user']->data['username'] && $_CLASS['auth']->acl_get('u_chgname') && $_CORE_CONFIG['user']['allow_namechange'])
-						{
-							user_update_name($_CLASS['core_user']->data['username'], $username);
-						}
-
-						$_CLASS['core_display']->meta_refresh(3, $module_link);
-						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
-						
-						trigger_error($message);
+						$_CLASS['core_db']->sql_query($sql);
 					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				$user_char_ary = array('.*' => 'USERNAME_CHARS_ANY', '[\w]+' => 'USERNAME_ALPHA_ONLY', '[\w_\+\. \-\[\]]+' => 'USERNAME_ALPHA_SPACERS');
+				$_CLASS['core_template']->assign_array(array(
+					'ERROR'				=> empty($error) ? '' : implode('<br />', $error),
 
-				$_CLASS['core_template']->assign(array(
-					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
+					'USERNAME'			=> $_CLASS['core_user']->data['username'],
+					'EMAIL'				=> $_CLASS['core_user']->data['user_email'],
 
-					'USERNAME'			=> (isset($username)) ? $username : $_CLASS['core_user']->data['username'],
-					'EMAIL'				=> (isset($email)) ? $email : $_CLASS['core_user']->data['user_email'],
 					'CONFIRM_EMAIL'		=> '',
 					'PASSWORD_CONFIRM'	=> (isset($password_confirm)) ? $password_confirm : '',
 					'NEW_PASSWORD'		=> (isset($new_password)) ? $new_password : '',
 					
 					'CUR_PASSWORD'					=> '', 
 					
-					'L_USERNAME_EXPLAIN'		=> sprintf($_CLASS['core_user']->lang[$user_char_ary[str_replace('\\\\', '\\', $_CORE_CONFIG['user']['allow_name_chars'])] . '_EXPLAIN'], $_CORE_CONFIG['user']['min_name_chars'], $_CORE_CONFIG['user']['max_name_chars']), 
+					'L_USERNAME_EXPLAIN'		=> '', 
 					'L_CHANGE_PASSWORD_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['CHANGE_PASSWORD_EXPLAIN'], $_CORE_CONFIG['user']['min_pass_chars'], $_CORE_CONFIG['user']['max_pass_chars']), 
 				
-					'S_FORCE_PASSWORD'	=> ($_CORE_CONFIG['user']['chg_passforce'] && $this->data['user_passchg'] < time() - $_CORE_CONFIG['user']['chg_passforce']) ? true : false, 
-					'S_CHANGE_USERNAME'	=> ($_CORE_CONFIG['user']['allow_namechange'] && $_CLASS['auth']->acl_get('u_chgname')) ? true : false, 
-					'S_CHANGE_EMAIL'	=> ($_CLASS['auth']->acl_get('u_chgemail')) ? true : false,
+					'S_FORCE_PASSWORD'	=> false,
+					'S_CHANGE_USERNAME'	=> false, 
+					'S_CHANGE_EMAIL'	=> false,
 					'S_CHANGE_PASSWORD'	=> true
 				));
-				break;
+			break;
 
 			case 'profile_info':
 
@@ -321,16 +225,19 @@
 				// Generate smiley listing
 				generate_smilies('inline', 0);
 	
-				$enable_html	= ($config['allow_sig_html']) ? isset($_POST['disable_html']) : false;
-				$enable_bbcode	= ($config['allow_sig_bbcode']) ? (isset($_POST['disable_bbcode']) ? false : $_CLASS['core_user']->optionget('bbcode')) : false;
-				$enable_smilies = ($config['allow_sig_smilies']) ? (isset($_POST['disable_smilies']) ? false : $_CLASS['core_user']->optionget('smilies')) : false;
-				$enable_urls	= (isset($_POST['disable_magic_url'])) ? false : true;
-				$signature		= request_var('signature', $_CLASS['core_user']->data['user_sig']);
-				
+				$enable_html	= (true) ? !isset($_POST['disable_html']) : false;
+				$enable_bbcode	= (true) ? !isset($_POST['disable_bbcode']) : false;
+				$enable_smilies = (true) ? !isset($_POST['disable_smilies']) : false;
+				$enable_urls	= !isset($_POST['disable_magic_url']);
+
+				$signature		= get_variable('signature', 'POST', $_CLASS['core_user']->data['user_sig']);
+				$signature_preview = '';
+				$sql_array = false;
+
 				if ($submit || $preview)
 				{
 					require_once($site_file_root.'includes/forums/message_parser.php');
-					
+
 					if ($signature)
 					{
 						$message_parser = new parse_message($signature);
@@ -338,82 +245,81 @@
 						// Allowing Quote BBCode
 						$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $config['allow_sig_img'], $config['allow_sig_flash'], true, true, 'sig');
 						
-						if (sizeof($message_parser->warn_msg))
+						if (!empty($message_parser->warn_msg))
 						{
 							$error[] = implode('<br />', $message_parser->warn_msg);
 						}
-						
-						if (!sizeof($error) && $submit)
+					}
+
+					if (empty($error) && $submit)
+					{
+						if ($signature && !empty($message_parser->message))
 						{
-							$sql_ary = array(
+							$sql_array = array(
 								'user_sig'					=> (string) $message_parser->message, 
 								'user_sig_bbcode_uid'		=> (string) $message_parser->bbcode_uid, 
 								'user_sig_bbcode_bitfield'	=> (int) $message_parser->bbcode_bitfield
 							);
 						}
-					}
-					else
-					{
-						$sql_ary = array(
-							'user_sig'					=> '', 
-							'user_sig_bbcode_uid'		=> '', 
-							'user_sig_bbcode_bitfield'	=> (int) ''
-						);
-					}
-					
-					if (!sizeof($error) && $submit)
-					{
+						else
+						{
+							$sql_array = array(
+								'user_sig'					=> (string) '', 
+								'user_sig_bbcode_uid'		=> (string) '', 
+								'user_sig_bbcode_bitfield'	=> (int) 0
+							);
+						}
+
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . ' 
+							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . ' 
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 						$_CLASS['core_db']->sql_query($sql);
-	
-						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'\>', '</a>');
+
+						$message = $_CLASS['core_user']->lang['PROFILE_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.$module_link.'">', '</a>');
 						trigger_error($message);
 					}
-					
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				$signature_preview = '';
 				if ($preview && $signature)
 				{
 					// Now parse it for displaying
 					$signature_preview = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
 					unset($message_parser);
 				}
-				
-				decode_message($signature, $_CLASS['core_user']->data['user_sig_bbcode_uid']);
 
-				$_CLASS['core_template']->assign(array(
-					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '', 
+				if ($signature)
+				{
+					decode_message($signature, $_CLASS['core_user']->data['user_sig_bbcode_uid']);
+				}
+
+				$_CLASS['core_template']->assign_array(array(
+					'ERROR'				=> empty($error) ? '' : implode('<br />', $error), 
 					'SIGNATURE'			=> $signature,
 					'SIGNATURE_PREVIEW'	=> $signature_preview, 
 					
-					'S_HTML_CHECKED' 		=> (!$enable_html) ? 'checked="checked"' : '',
-					'S_BBCODE_CHECKED' 		=> (!$enable_bbcode) ? 'checked="checked"' : '',
-					'S_SMILIES_CHECKED' 	=> (!$enable_smilies) ? 'checked="checked"' : '',
-					'S_MAGIC_URL_CHECKED' 	=> (!$enable_urls) ? 'checked="checked"' : '',
+					'S_HTML_CHECKED' 		=> ($enable_html) ? '' : 'checked="checked"',
+					'S_BBCODE_CHECKED' 		=> ($enable_bbcode) ? '' : 'checked="checked"',
+					'S_SMILIES_CHECKED' 	=> ($enable_smilies) ? '' : 'checked="checked"',
+					'S_MAGIC_URL_CHECKED' 	=> ($enable_urls) ? '' : 'checked="checked"',
 
-					'HTML_STATUS'			=> ($config['allow_sig_html']) ? $_CLASS['core_user']->lang['HTML_IS_ON'] : $_CLASS['core_user']->lang['HTML_IS_OFF'],
-					'BBCODE_STATUS'			=> ($config['allow_sig_bbcode']) ? sprintf($_CLASS['core_user']->lang['BBCODE_IS_ON'], '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>') : sprintf($_CLASS['core_user']->lang['BBCODE_IS_OFF'], '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
-					'SMILIES_STATUS'		=> ($config['allow_sig_smilies']) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF'],
-					'IMG_STATUS'			=> ($config['allow_sig_img']) ? $_CLASS['core_user']->lang['IMAGES_ARE_ON'] : $_CLASS['core_user']->lang['IMAGES_ARE_OFF'],
-					'FLASH_STATUS'			=> ($config['allow_sig_flash']) ? $_CLASS['core_user']->lang['FLASH_IS_ON'] : $_CLASS['core_user']->lang['FLASH_IS_OFF'],
+					'HTML_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('HTML_IS_ON') : $_CLASS['core_user']->get_lang('HTML_IS_OFF'),
+					'BBCODE_STATUS'			=> (true) ? sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_ON'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>') : sprintf($_CLASS['core_user']->get_lang('BBCODE_IS_OFF'), '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
+					'SMILIES_STATUS'		=> (true) ? $_CLASS['core_user']->get_lang('SMILIES_ARE_ON') : $_CLASS['core_user']->get_lang('SMILIES_ARE_OFF'),
+					'IMG_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('IMAGES_ARE_ON') : $_CLASS['core_user']->get_lang('IMAGES_ARE_OFF'),
+					'FLASH_STATUS'			=> (true) ? $_CLASS['core_user']->get_lang('FLASH_IS_ON') : $_CLASS['core_user']->get_lang('FLASH_IS_OFF'),
 
 					'L_SIGNATURE_EXPLAIN'	=> sprintf($_CLASS['core_user']->lang['SIGNATURE_EXPLAIN'], $config['max_sig_chars']),
 
-					'S_HTML_ALLOWED'		=> $config['allow_sig_html'], 
-					'S_BBCODE_ALLOWED'		=> $config['allow_sig_bbcode'], 
-					'S_SMILIES_ALLOWED'		=> $config['allow_sig_smilies'],)
-				);
-				break;
+					'S_HTML_ALLOWED'		=> true, 
+					'S_BBCODE_ALLOWED'		=> true, 
+					'S_SMILIES_ALLOWED'		=> true,
+				));
+			break;
 
 			case 'avatar':
 
 				$display_gallery = isset($_POST['display_gallery']);
-				$folder = isset($_REQUEST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_REQUEST['category']) : false;
+				$folder = isset($_POST['category']) ? str_replace(array('../', '..\\', './', '.\\'), '', $_POST['category']) : false;
 
 				$delete = isset($_POST['delete']);
 
@@ -446,8 +352,6 @@
 						$data['height']		= get_variable('height', 'POST', '');
 						$data['user_id']	= $_CLASS['core_user']->data['user_id'];
 
-						require_once($site_file_root.'includes/forums/functions_user.php');
-
 						if ((!empty($_FILES['uploadfile']['name']) || $data['uploadurl']) && $can_upload)
 						{
 							list($type, $filename, $width, $height) = avatar_upload($data, $error);
@@ -458,7 +362,8 @@
 						}
 						elseif ($delete)
 						{
-							$type = $filename = $width = $height = '';
+							$filename =  '';
+							$type = $width = $height = 0;
 						}
 						else
 						{
@@ -469,10 +374,10 @@
 					if (empty($error))
 					{
 						$sql_ary = array(
-							'user_avatar'			=> $filename, 
-							'user_avatar_type'		=> $type, 
-							'user_avatar_width'		=> $width, 
-							'user_avatar_height'	=> $height, 
+							'user_avatar'			=> (string) $filename, 
+							'user_avatar_type'		=> (int) $type, 
+							'user_avatar_width'		=> (int) $width, 
+							'user_avatar_height'	=> (int) $height, 
 						);
 
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
@@ -513,7 +418,7 @@
 					$avatar_img = '<img src="' . $avatar_img . '" width="' . $_CLASS['core_user']->data['user_avatar_width'] . '" height="' . $_CLASS['core_user']->data['user_avatar_height'] . '" border="0" alt="" />';
 				}
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'ERROR'			=> empty($error) ? '' : implode('<br />', $error), 
 					'AVATAR'		=> $avatar_img, 
 					'AVATAR_SIZE'	=> $config['avatar_filesize'], 
@@ -538,7 +443,7 @@
 						$s_category_options .= '<option value="' . $cat . '"' . (($cat == $folder) ? ' selected="selected"' : '') . '>' . (($cat) ? $cat : '--') . '</option>';
 					}
 
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 						'S_DISPLAY_GALLERY'	=> true,
 						'S_CAT_OPTIONS'		=> $s_category_options)
 					);
@@ -555,7 +460,7 @@
 				}
 				else
 				{
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 						'AVATAR'		=> $avatar_img,
 						'AVATAR_SIZE'	=> $config['avatar_filesize'],
 						'WIDTH'			=> $_CLASS['core_user']->data['user_avatar_width'],

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_zebra.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -17,22 +17,20 @@
 	{
 		global $_CLASS;
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'ERROR'				=> false,
 			'USERNAMES'			=> false,
-			'S_USERNAME_OPTIONS'=> false)
-		);
+			'S_USERNAME_OPTIONS'=> false
+		));
 		
 		$s_hidden_fields = '';
 
 		if (!empty($_POST['submit']) || !empty($_GET['add']))
 		{
-			$data['usernames'] = request_var('usernames', array(0));
-			$data['add'] = request_var('add', '');
+			$data['usernames'] = get_variable('usernames', 'POST', false, 'array');
+			$data['add'] = get_variable('add', 'POST', false);
 
-			$error = validate_data($data, array('add'	=> array('string', false)));
-			
-			if ($data['add'] && !sizeof($error))
+			if ($data['add'] && empty($error))
 			{
 				$data['add'] = explode("\n", $data['add']);
 
@@ -97,7 +95,7 @@
 							unset($perms);
 						}
 
-						if (sizeof($user_id_ary))
+						if (!empty($user_id_ary))
 						{
 							$sql_mode = ($mode == 'friends') ? 'friend' : 'foe';
 
@@ -119,7 +117,7 @@
 					$_CLASS['core_db']->free_result($result);
 				}
 			}
-			else if ($data['usernames'] && !sizeof($error))
+			elseif ($data['usernames'] && empty($error))
 			{
 				// Force integer values
 				$data['usernames'] = array_map('intval', $data['usernames']);
@@ -130,7 +128,7 @@
 				$_CLASS['core_db']->query($sql);
 			}
 			
-			if (!sizeof($error))
+			if (empty($error))
 			{
 				$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 				$message = $_CLASS['core_user']->lang[strtoupper($mode) . '_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
@@ -157,7 +155,7 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign(array( 
+		$_CLASS['core_template']->assign_array(array( 
 			'L_TITLE'				=> $_CLASS['core_user']->lang['UCP_ZEBRA_' . strtoupper($mode)],
 
 			'U_SEARCH_USER'			=> generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=add'), 

Modified: cms/trunk/modules/Forums/download.php
===================================================================
--- cms/trunk/modules/Forums/download.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Forums/download.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -88,6 +88,7 @@
 else
 {
 	$row['forum_id'] = 0;
+
 	if (!$_CLASS['auth']->acl_get('u_pm_download') || !$config['auth_download_pm'])
 	{
 		trigger_error('SORRY_AUTH_VIEW_ATTACH');
@@ -103,7 +104,7 @@
 
 if (!download_allowed())
 {
-	trigger_error($_CLASS['core_user']->lang['LINKAGE_FORBIDDEN']);
+	trigger_error('LINKAGE_FORBIDDEN');
 }
 
 $download_mode = (int) $extensions[$attachment['extension']]['download_mode'];
@@ -293,7 +294,7 @@
 	if (!$allowed)
 	{
 		$sql = 'SELECT site_ip, site_hostname, ip_exclude
-			FROM ' . SITELIST_TABLE;
+			FROM ' . FORUMS_SITELIST_TABLE;
 		$result = $_CLASS['core_db']->sql_query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))

Added: cms/trunk/modules/Quick_Message/functions.php
===================================================================
--- cms/trunk/modules/Quick_Message/functions.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Quick_Message/functions.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -0,0 +1,101 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $table_prefix;
+
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
+}
+
+function qm_block_content()
+{
+	global $prefix, $_CLASS, $_CORE_CONFIG;
+	
+	$content = '<div style="width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;">';
+	
+	$result = $_CLASS['core_db']->query_limit('SELECT * from '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 10);
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$words_array = explode(' ', $row['message_text']);
+	
+		$row['message_text'] = '';
+	
+		foreach($words_array as $words)
+		{
+			if (substr($words, 0, 4) != '[url')
+			{
+				$row['message_text'] .= ' '.wordwrap($words, 18, "\n", 1);
+			}
+			else
+			{
+				$row['message_text'] .= $words;
+			}
+		}
+	
+		$row['message_text'] = htmlentities($row['message_text'], ENT_QUOTES, 'UTF-8');
+	
+		unset($words_array, $words);
+		
+		$content .= '<div style="padding: 4px;">';
+		
+		if ($row['poster_name'])
+		{
+			$row['poster_name'] = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
+	
+			if ($row['poster_id']) 
+			{
+				$content .= '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']).'"><b>' . $row['poster_name'] . ': </b></a>';
+			}
+			else
+			{
+				$content .= '<b>' . $row['poster_name'] . ': </b>'; 
+			}
+		}
+		else
+		{
+			$content .= '<b>' . $_CLASS['core_user']->lang['ANONYMOUS'] . ': </b>';
+		}
+	
+		if ($row['poster_id'])
+		{
+			$row['message_text'] = preg_replace('#\[url=([^\[]+?)\](.*?)\[/url\]#s', '<a href="$1" target="_blank">$2</a>', $row['message_text']);
+		}
+	
+		$content .= $row['message_text'].'<br />'. $_CLASS['core_user']->format_date($row['message_time']) .'</div><hr/>';
+	}
+	
+	$_CLASS['core_db']->free_result($result);
+	
+	$content .= '</div>';
+
+	return $content;
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-15 19:09:49 UTC (rev 125)
@@ -35,138 +35,193 @@
 
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang();
-
-switch (get_variable('mode', 'GET', false))
+if ($mode = get_variable('mode', 'REQUEST', false))
 {
-	case 'add':
-		if (empty($_POST['submit']) || $_CLASS['core_user']->is_bot)
-		{
-			redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
-		}
-
-		$message = trim(get_variable('message', 'POST', false));
-
-		if (!$message)
-		{
-			trigger_error('NO_MESSAGE');
-		}
-
-		$length = mb_strlen($message);
-
-		if ($length > $_CORE_CONFIG['quick_message']['length_max'])
-		{ 
-			trigger_error('LONG_MESSAGE');
-		}
-
-	// use limit
-		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
-		$count = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-	// add a count check here so it admin ajustable
-		if ($count['count'] > 0)
-		{
-			trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
-		}
-
-		$_CLASS['core_db']->free_result($result);
-
-		if ($_CLASS['core_user']->is_user)
-		{
-			$user_id =  $_CLASS['core_user']->data['user_id'];
-			$user_name = $_CLASS['core_user']->data['username'];
-		}
-		else
-		{
-			$user_id = 0;
-			$user_name = get_variable('poster_name', 'POST', false);
-
-			if (!$user_name)
+	switch ($mode)
+	{
+		case 'ajax_refresh':
+			require_once($site_file_root.'modules/Quick_Message/functions.php');
+	
+			echo qm_block_content();
+	
+			script_close();
+		break;
+	
+		case 'add':
+		case 'ajax_add':
+			if ($_CLASS['core_user']->is_bot)
 			{
-				if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+				redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
+			}
+	
+			$message = trim(get_variable('message', 'POST', false));
+	
+			if (!$message)
+			{
+				if ($mode === 'ajax_add')
 				{
-					trigger_error('NO_NAME');
+					die;
 				}
+	
+				trigger_error('NO_MESSAGE');
 			}
-			else
+	
+			$length = mb_strlen($message);
+	
+			if ($length > $_CORE_CONFIG['quick_message']['length_max'])
+			{ 
+				if ($mode === 'ajax_add')
+				{
+					die;
+				}
+	
+				trigger_error('LONG_MESSAGE');
+			}
+	
+		// use limit
+			$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
+			$count = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+	
+		// add a count check here so it admin ajustable
+			if ($count['count'] > 0)
 			{
-				$length = mb_strlen($user_name);
-
-				if ($length < 2)
+				if ($mode === 'ajax_add')
 				{
-					trigger_error('SHORT_NAME');
+					die;
 				}
-
-				if ($length > 10)
+	
+				trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
+			}
+	
+			$_CLASS['core_db']->free_result($result);
+	
+			if ($_CLASS['core_user']->is_user)
+			{
+				$user_id =  $_CLASS['core_user']->data['user_id'];
+				$user_name = $_CLASS['core_user']->data['username'];
+			}
+			else
+			{
+				$user_id = 0;
+				$user_name = get_variable('poster_name', 'POST', false);
+	
+				if (!$user_name)
 				{
-					trigger_error('LONG_NAME');
+					if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('NO_NAME');
+					}
 				}
-
-				require($site_file_root.'includes/functions_user.php');
-			
-				if ($error = validate_username($user_name))
+				else
 				{
-					trigger_error($error);
+					$length = mb_strlen($user_name);
+	
+					if ($length < 2)
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('SHORT_NAME');
+					}
+	
+					if ($length > 10)
+					{
+						if ($mode = 'ajax_add')
+						{
+							die;
+						}
+						trigger_error('LONG_NAME');
+					}
+	
+					require($site_file_root.'includes/functions_user.php');
+				
+					if ($error = validate_username($user_name))
+					{
+						if ($mode === 'ajax_add')
+						{
+							die;
+						}
+						trigger_error($error);
+					}
 				}
 			}
-		}
-
-		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-			'poster_name'	=> (string) $user_name,
-			'poster_id'		=> (int) $user_id,
-			'poster_ip'		=> (string) $_CLASS['core_user']->ip,
-			'message_text'	=> (string) $message,
-			'message_time'	=> (int) $_CLASS['core_user']->time,
-		));
-
-		$_CLASS['core_db']->query($sql);
-
-		redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
-	break;
-
-	case 'delete':
-		global $_CORE_CONFIG, $_CLASS;
-
-		$id = get_variable('id', 'GET', false, 'integer');
-
-		if (!$id)
-		{
-			die;
-		}
-
-		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-		
-		if (!$row)
-		{
-			trigger_error('NO_MESSAGE');
-		}
-
-		$return = true;
-
-		if ($row['message_id'] == $id)
-		{
-			if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
+	
+			$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+				'poster_name'	=> (string) $user_name,
+				'poster_id'		=> (int) $user_id,
+				'poster_ip'		=> (string) $_CLASS['core_user']->ip,
+				'message_text'	=> (string) $message,
+				'message_time'	=> (int) $_CLASS['core_user']->time,
+			));
+	
+			$_CLASS['core_db']->query($sql);
+	
+			if ($mode === 'ajax_add')
 			{
-				if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
+				require_once($site_file_root.'modules/Quick_Message/functions.php');
+	
+				echo qm_block_content();
+	
+				script_close();
+			}
+	
+			redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
+		break;
+	
+		case 'delete':
+			global $_CORE_CONFIG, $_CLASS;
+	
+			$id = get_variable('id', 'GET', false, 'integer');
+	
+			if (!$id)
+			{
+				die;
+			}
+	
+			$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+			
+			if (!$row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+	
+			$return = true;
+	
+			if ($row['message_id'] == $id)
+			{
+				if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
 				{
-					$return = false;
+					if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
+					{
+						$return = false;
+					}
 				}
 			}
-		}
-
-		if ($return)
-		{
-			trigger_error('MESSAGE_NOT_DELETABLE');
-		}
-
-		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
-		$_CLASS['core_db']->query($sql);
-
-		//trigger_error('MESSAGE_DELETED');
-		redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
-	break;
+	
+			if ($return)
+			{
+				trigger_error('MESSAGE_NOT_DELETABLE');
+			}
+	
+			$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
+			$_CLASS['core_db']->query($sql);
+	
+			//trigger_error('MESSAGE_DELETED');
+			redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
+		break;
+		
+		default:
+			script_close();
+		break;
+	}
 }
 
 $start = get_variable('start', 'GET', 0, 'integer');
@@ -202,7 +257,7 @@
 {
 	if ($row['poster_name'])
 	{
-		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');;
+		$user_name = htmlentities($row['poster_name'], ENT_QUOTES, 'UTF-8');
 		$userlink = ($row['poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']) : false;
 	}
 	else

Deleted: cms/trunk/themes/viperal/template/message.html
===================================================================
--- cms/trunk/themes/viperal/template/message.html	2005-09-15 03:20:21 UTC (rev 124)
+++ cms/trunk/themes/viperal/template/message.html	2005-09-15 19:09:49 UTC (rev 125)
@@ -1,14 +0,0 @@
-<div class="OpenTable">
-	<div class="outer">
-		<div class="inner">
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th>{ $MESSAGE_TITLE }</th>
-				</tr>
-				<tr> 
-					<td class="row1" align="center"><br /><p class="gen">{ $MESSAGE_TEXT }</p><br /></td>
-				</tr>
-			</table>
-		</div>
-	</div>
-</div>
\ No newline at end of file



From viperal at berlios.de  Thu Sep 15 21:17:35 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 15 Sep 2005 21:17:35 +0200
Subject: [Viperals-svncheckins] r126 - in cms/trunk: blocks javascript
Message-ID: <200509151917.j8FJHZ9b025708@sheep.berlios.de>

Author: viperal
Date: 2005-09-15 21:17:34 +0200 (Thu, 15 Sep 2005)
New Revision: 126

Modified:
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/javascript/quick_messages.js
Log:
Opps, Forgot to add non - ajax / javascript support

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:09:49 UTC (rev 125)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:17:34 UTC (rev 126)
@@ -21,7 +21,6 @@
 $Id$
 */
 
-// Convert to template
 if (!defined('VIPERAL'))
 {
     die;
@@ -49,7 +48,7 @@
 	return;
 }
 
-$this->content .= '<form name="post" method="post" action="'.generate_link('Quick_Message&amp;mode=add').'">';
+$this->content .= '<form onsubmit="return quick_message_submit();" method="post" action="'.generate_link('Quick_Message&amp;mode=add').'">';
 
 if (!$_CLASS['core_user']->is_user && $_CORE_CONFIG['quick_message']['anonymous_posting'] == '2')
 {
@@ -57,8 +56,8 @@
 }
 
 $this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="3"></textarea><br /><br />
-			<input class="button" type="button" name="submit" onclick="quick_message_submit()" value="Post" />
-			<input class="button" type="button" name="submit" onclick="quick_message_refresh()" value="Refresh" />
+			<input class="button" type="submit" name="submit" value="Post" />
+			<input class="button" type="button" name="submit" onsubmit="quick_message_refresh()" value="Refresh" />
 		</div></form>';
 
 ?>
\ No newline at end of file

Modified: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-09-15 19:09:49 UTC (rev 125)
+++ cms/trunk/javascript/quick_messages.js	2005-09-15 19:17:34 UTC (rev 126)
@@ -12,18 +12,27 @@
 
 	ajax = new core_ajax();
 
+	if (!ajax)
+	{
+		return true;
+	}
+
 	var onreadystatechange = function()
 	{
 		if (ajax.state_ready() && ajax.responseText())
 		{
 			var area = document.getElementById('qm_block');
 			area.innerHTML = ajax.responseText();
+
+			message.value = '';
 		}
 	}
 
 	ajax.onreadystatechange(onreadystatechange);
 
 	ajax.send('index.php?mod=Quick_Message&mode=ajax_add', '&poster_name=' + poster_name.value + '&message=' + message.value);
+
+	return false;
 }
 
 function quick_message_refresh()



From viperal at berlios.de  Thu Sep 15 21:32:24 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 15 Sep 2005 21:32:24 +0200
Subject: [Viperals-svncheckins] r127 - in cms/trunk: blocks javascript modules/Quick_Message
Message-ID: <200509151932.j8FJWOS0027015@sheep.berlios.de>

Author: viperal
Date: 2005-09-15 21:32:21 +0200 (Thu, 15 Sep 2005)
New Revision: 127

Modified:
   cms/trunk/blocks/block-Quick_Message.php
   cms/trunk/javascript/quick_messages.js
   cms/trunk/modules/Quick_Message/index.php
Log:
Dope :-(

Modified: cms/trunk/blocks/block-Quick_Message.php
===================================================================
--- cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:17:34 UTC (rev 126)
+++ cms/trunk/blocks/block-Quick_Message.php	2005-09-15 19:32:21 UTC (rev 127)
@@ -57,7 +57,7 @@
 
 $this->content .= 'Message <br/> <textarea id="message" name="message" style="width:90%;" rows="3"></textarea><br /><br />
 			<input class="button" type="submit" name="submit" value="Post" />
-			<input class="button" type="button" name="submit" onsubmit="quick_message_refresh()" value="Refresh" />
+			<input class="button" type="button" name="submit" onclick="quick_message_refresh()" value="Refresh" />
 		</div></form>';
 
 ?>
\ No newline at end of file

Modified: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-09-15 19:17:34 UTC (rev 126)
+++ cms/trunk/javascript/quick_messages.js	2005-09-15 19:32:21 UTC (rev 127)
@@ -5,11 +5,6 @@
 	var message = document.getElementById('message');
 	var poster_name = document.getElementById('poster_name');
 
-	if (!poster_name)
-	{
-		poster_name = '';
-	}
-
 	ajax = new core_ajax();
 
 	if (!ajax)
@@ -30,8 +25,10 @@
 
 	ajax.onreadystatechange(onreadystatechange);
 
-	ajax.send('index.php?mod=Quick_Message&mode=ajax_add', '&poster_name=' + poster_name.value + '&message=' + message.value);
+	poster_name = (poster_name) ? 'poster_name=' + poster_name.value : '';
 
+	ajax.send('index.php?mod=Quick_Message&mode=ajax_add', poster_name + '&message=' + message.value);
+
 	return false;
 }
 

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-15 19:17:34 UTC (rev 126)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-15 19:32:21 UTC (rev 127)
@@ -140,8 +140,9 @@
 					}
 	
 					require($site_file_root.'includes/functions_user.php');
-				
-					if ($error = validate_username($user_name))
+					$status = validate_username($user_name);
+
+					if ($status !== true)
 					{
 						if ($mode === 'ajax_add')
 						{



From viperal at berlios.de  Fri Sep 16 21:22:38 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 16 Sep 2005 21:22:38 +0200
Subject: [Viperals-svncheckins] r128 - in cms/trunk: . includes includes/display includes/forums includes/templates/modules/Forums javascript javascript/forums modules/Forums modules/Quick_Message themes/viperal/style themes/viperal/template themes_admin/viperal_admin/template
Message-ID: <200509161922.j8GJMc1l001729@sheep.berlios.de>

Author: viperal
Date: 2005-09-16 21:22:36 +0200 (Fri, 16 Sep 2005)
New Revision: 128

Added:
   cms/trunk/ajax.php
   cms/trunk/modules/Quick_Message/ajax.php
Removed:
   cms/trunk/includes/templates/modules/Forums/images/
   cms/trunk/includes/templates/modules/Forums/theme/
   cms/trunk/includes/templates/modules/Forums/viewtopic_attach_body.html
Modified:
   cms/trunk/core.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/session.php
   cms/trunk/includes/user.php
   cms/trunk/installer.php
   cms/trunk/javascript/collapse.js
   cms/trunk/javascript/common.js
   cms/trunk/javascript/forums/forum_view.js
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Forums/viewtopic.php
   cms/trunk/modules/Quick_Message/index.php
   cms/trunk/themes/viperal/style/style.css
   cms/trunk/themes/viperal/template/header.html
   cms/trunk/themes_admin/viperal_admin/template/header.html
Log:


Added: cms/trunk/ajax.php
===================================================================
--- cms/trunk/ajax.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/ajax.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -0,0 +1,78 @@
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright 2004 - 2005										//
+//  By Ryan Marshall ( Viperal?	)								//
+//																//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+define('VIPERAL', 'AJAX');
+
+if (empty($_GET['sid']))
+{
+	die;
+}
+
+//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
+$site_file_root = '';
+
+require($site_file_root.'core.php');
+
+$mod = get_variable('mod', 'REQUEST', false);
+
+if (!$mod)
+{
+	die;
+}
+else
+{
+	/*
+	if ($mod === 'system')
+	{
+		include_once($site_file_root.'includes/system.php');
+
+		$mode = get_variable('mode', 'REQUEST', false);
+		if (!$mode || !function_exists($mode))
+		{
+			script_close(false);
+		}
+
+		$mode();
+		script_close(false);
+	}
+	*/
+
+	$sql = 'SELECT * FROM '.CORE_MODULES_TABLE.'
+				WHERE module_type = ' . MODULE_NORMAL . "
+				AND module_name = '" . $_CLASS['core_db']->escape($mod) . "'";
+
+	//Grab module data if it exsits
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	$status = $_CLASS['core_display']->add_module($row);
+
+	if ($status !== true)
+	{
+		header("HTTP/1.0 503 Service Unavailable");
+		script_close(false);
+	}
+
+	$_CORE_MODULE = $_CLASS['core_display']->get_module();
+}
+
+$path = $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/ajax.php';
+$_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
+
+require_once($path);
+
+script_close(false);
+
+?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/core.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -26,18 +26,15 @@
     die;
 }
 
-error_reporting(E_ALL);
-//error_reporting(0);
+set_magic_quotes_runtime(0);
 
-if (!extension_loaded('mbstring'))
-{
-	require_once($site_file_root.'includes/compatiblity/mbstring.php');
-}
+//Error reporting tyoe
+define('ERROR_NONE', 0);
+define('ERROR_ONPAGE', 1);
+define('ERROR_DEBUGGER', 2);
+define('SERVER_LOCAL', (strpos($_SERVER['HTTP_HOST'], 'localhost') === 0 || strpos($_SERVER['HTTP_HOST'], '127.0.0.1') === 0));
+define('STRIP_SLASHES', get_magic_quotes_gpc());
 
-set_magic_quotes_runtime(0);
-mb_internal_encoding('UTF-8');
-//mb_http_output('UTF-8');
-
 // Remove registered globals
 if ((bool) ini_get('register_globals'))
 {
@@ -47,8 +44,20 @@
 	}
 }
 
-define('STRIP_SLASHES', get_magic_quotes_gpc());
+//change $site_file_root to a defined
+if (!$site_file_root)
+{
+	$site_file_root = str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/';
+}
 
+if (!extension_loaded('mbstring'))
+{
+	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+}
+
+mb_internal_encoding('UTF-8');
+//mb_http_output('UTF-8');
+
 $starttime = explode(' ', microtime());
 $starttime = $starttime[1] + $starttime[0];
 $base_memory_usage = get_memory_usage();
@@ -64,11 +73,6 @@
 	}
 }
 
-//Error reporting tyoe
-define('ERROR_NONE', 0);
-define('ERROR_ONPAGE', 1);
-define('ERROR_DEBUGGER', 2);
-
 require_once($site_file_root.'includes/display/template.php');
 require_once($site_file_root.'includes/functions.php');
 require_once($site_file_root.'includes/handler.php');
@@ -85,7 +89,13 @@
 
 if (empty($site_db))
 {
-	trigger_error('<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
+	if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
+	{
+		header('HTTP/1.0 503 Service Unavailable');
+		die;
+	}
+
+	trigger_error('503:<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
 }
 
 require_once($site_file_root.'includes/tables.php');
@@ -107,7 +117,7 @@
 $_CLASS['core_db']->report_error(false);
 
 // Error messages just incase we can't get our configs
-$config_error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
+$config_error = '503:<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB3</center>';
 
 if (is_null($_CORE_CONFIG = $_CLASS['core_cache']->get('core_config')))
 {
@@ -117,6 +127,12 @@
 		
 	if (!$result = $_CLASS['core_db']->query($sql))
 	{
+		if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
+		{
+			header('HTTP/1.0 503 Service Unavailable');
+			die;
+		}
+
 		trigger_error($config_error, E_USER_ERROR);
 	}
 	
@@ -136,15 +152,23 @@
 else
 {
 	$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE . ' WHERE config_cache = 0';
-		
-	if ($result = $_CLASS['core_db']->query($sql))
+	
+	if (!$result = $_CLASS['core_db']->query($sql))
 	{
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
 		{
-			$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
+			header('HTTP/1.0 503 Service Unavailable');
+			die;
 		}
-		$_CLASS['core_db']->free_result($result);
+
+		trigger_error($config_error, E_USER_ERROR);
 	}
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
+	}
+	$_CLASS['core_db']->free_result($result);
 }
 
 $_CLASS['core_db']->report_error(true);
@@ -153,13 +177,17 @@
 $_CLASS['core_cache']->remove('core_config');
 $_CLASS['core_cache']->remove('config');
 
-if (VIPERAL == 'FEED')
+if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
 {
 	if (check_maintance_status(true) === true || check_load_status(true) === true)
 	{
-		header("HTTP/1.0 503 Service Unavailable");
+		header('HTTP/1.0 503 Service Unavailable');
 		die;
 	}
+}
+
+if (VIPERAL === 'FEED')
+{
 	return;
 }
 
@@ -182,7 +210,7 @@
 	// conformation image 
 	login_box(array('full_screen'	=> true));
 }
-		
+
 if ($_CLASS['core_user']->is_admin)
 {
 	$_CLASS['core_error_handler']->report = $_CORE_CONFIG['server']['error_options'];	
@@ -204,19 +232,6 @@
 	// error here
 }
 
-$install_prefix = 'test_';
-$time = gmtime();
-
-if (!function_exists('field_unix_time'))
-{
-	function field_unix_time($name, $null = false)
-	{
-		global $_CLASS;
-	
-		$_CLASS['core_db']->add_table_field_int($name, array('max' => 200000000, 'null' => $null));
-	}
-}
-
 function get_memory_usage()
 {
 	if (function_exists('memory_get_usage'))

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/display/display.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -23,7 +23,7 @@
 
 class core_display
 {
-	var $header = array('js'=>'', 'regular'=>'', 'meta'=>'', 'body'=>'');
+	var $header = array('js' => array(), 'regular' => array(), 'meta' => array());
 	var $displayed = array('header'=> false, 'footer'=> false);
 	var $message = '';
 
@@ -156,36 +156,37 @@
 
 		if ($_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_new_privmsg'] && $_CLASS['core_user']->user_data_get('popuppm'))
 		{
-			$this->header['js'] .= '<script type="text/javascript">window.open(\''. preg_replace('/&amp;/', '&', generate_link('Control_Panel&i=pm&mode=popup', array('full' => true)))."', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');</script>";
+			$this->header['js'][] = '<script type="text/javascript">window.open(\''. preg_replace('/&amp;/', '&', generate_link('Control_Panel&i=pm&mode=popup', array('full' => true)))."', '_phpbbprivmsg','height=135,resizable=yes,status=no,width=400');</script>";
 			$_CLASS['core_db']->sql_query('UPDATE ' . USERS_TABLE . ' SET user_new_privmsg = 0 WHERE user_id = ' . $_CLASS['core_user']->data['user_id']);
 		}
 
-		$this->header['regular'] .= '<meta name="generator" content="Viperal CMS ( www.viperal.com ) Copyright(c) '.date('Y').'" />';
+		$this->header['regular'][] = '<meta name="generator" content="Viperal CMS ( www.viperal.com ) Copyright(c) '.date('Y').'" />';
 
 		if (file_exists('favicon.ico'))
 		{
-			$this->header['regular'] .= '<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />';
+			$this->header['regular'][] = '<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />';
 		}
 
-		$this->header['regular'] .= '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'feed.php?feed=rdf" />';
+		$this->header['regular'][] = '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'feed.php?feed=rdf" />';
 
 		if ($_CORE_CONFIG['maintenance']['active'] && $_CORE_CONFIG['maintenance']['start'] < time())
 		{
 			$this->message = '<b>System is in maintenance mode</b><br />';
 		}
 
-		$this->header['js'] = '<script type="text/javascript" src="javascript/common.js"></script>';
+		$this->header['js'][] = '<script type="text/javascript" src="javascript/common.js"></script>';
+		$this->header['js'][] = "<script type=\"text/javascript\">\nvar cms_session_id = '{$_CLASS['core_user']->data['session_id']}';\nvar cms_cookie_path = '{$_CORE_CONFIG['server']['cookie_path']}';\nvar cms_cookie_domain = '{$_CORE_CONFIG['server']['cookie_domain']}';\n</script>";
 
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']),
 			'SITE_BASE'			=>	generate_base_url(),
-			'SITE_CHARSET'		=>	'UTF-8',
+			'SID'				=>	empty($_CLASS['core_user']->data['session_id']) ? '' : $_CLASS['core_user']->data['session_id'],
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
 			'HEADER_MESSAGE'	=>	$this->message,
-			'HEADER_REGULAR'	=>	$this->header['meta'].$this->header['regular'],
-			'HEADER_JS' 		=>	$this->header['js'],
-			'HEADER_BODY' 		=>	$this->header['body']				
+			'HEADER_META'		=>	empty($this->header['meta']) ? '' : implode("\n", $this->header['meta']),
+			'HEADER_REGULAR'	=>	empty($this->header['regular']) ? '' : implode("\n", $this->header['regular']),
+			'HEADER_JS' 		=>	empty($this->header['js']) ? '' : implode("\n", $this->header['js']),
 		));
 
 		$_CLASS['core_blocks']->display(BLOCK_MESSAGE_TOP);
@@ -299,7 +300,7 @@
 	{
 		global $_CLASS;
 
-		$this->header['meta'] .= '<meta http-equiv="refresh" content="' . $time . ';url=' . (($url) ? $url : generate_link(false, array('full' => true))) . '">';
+		$this->header['meta'][] = '<meta http-equiv="refresh" content="' . $time . ';url=' . (($url) ? $url : generate_link(false, array('full' => true))) . '">';
 	}
 }
 

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/display/template.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -164,7 +164,7 @@
 
 		$set = false;
 
-		if (!empty($_CLASS['core_display']) && file_exists($_CLASS['core_display']->theme_path.'/template/'.$name))
+		if (!empty($_CLASS['core_display']->theme_path) && file_exists($_CLASS['core_display']->theme_path.'/template/'.$name))
 		{
 			$this->template_dir = $_CLASS['core_display']->theme_path.'/template/';
 			$this->theme_themplate = true;

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/forums/functions.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -609,7 +609,7 @@
 	}
 
 	// Default tracking type
-	$time = ($marktime) ? $marktime : gmtime();
+	$time = ($marktime) ? $marktime : $_CLASS['core_user']->time;
 
 	switch ($mode)
 	{
@@ -725,22 +725,23 @@
 				{
 					$tracking = array();
 				}
-					/*
-					// If the cookie grows larger than 2000 characters we will remove
-					// the smallest value
-					if (strlen($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']) > 2000)
+
+				/*
+				// If the cookie grows larger than 2000 characters we will remove
+				// the smallest value
+				if (strlen($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track']) > 2000)
+				{
+					foreach ($tracking as $f => $t_ary)
 					{
-						foreach ($tracking as $f => $t_ary)
+						if (!isset($m_value) || min($t_ary) < $m_value)
 						{
-							if (!isset($m_value) || min($t_ary) < $m_value)
-							{
-								$m_value = min($t_ary);
-								$m_tkey = array_search($m_value, $t_ary);
-								$m_fkey = $f;
-							}
+							$m_value = min($t_ary);
+							$m_tkey = array_search($m_value, $t_ary);
+							$m_fkey = $f;
 						}
-						unset($tracking[$m_fkey][$m_tkey]);
-					}*/
+					}
+					unset($tracking[$m_fkey][$m_tkey]);
+				}*/
 
 				$topic_id36 = base_convert($topic_id, 10, 36);
 				$forum_id36 = base_convert($forum_id, 10, 36);
@@ -754,7 +755,6 @@
 				elseif (!isset($tracking[$forum_id36][$topic_id36]))
 				{
 					$tracking[$forum_id36][$topic_id36] = base_convert($time, 10, 36);
-
 					$_CLASS['core_user']->set_cookie('track', serialize($tracking), time() + 31536000);
 				}
 				unset($tracking);

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -1,540 +1,550 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_display.php,v 1.59 2004/09/17 09:11:47 acydburn Exp $
-//
-// FILENAME  : functions_display.php
-// STARTED   : Thu Nov 07, 2002
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW		 : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-function display_forums($root_data = '', $display_moderators = true)
-{
-	global $config, $_CLASS, $_CORE_CONFIG;
-
-	// Get posted/get info
-	$mark_read = request_var('mark', '');
-
-	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $mark_forums = array();
-	$visible_forums = 0;
-
-	if (!$root_data)
-	{
-		$root_data = array('forum_id' => 0);
-		$sql_where = '';
-	}
-	else
-	{
-		$sql_where = 'AND left_id > ' . $root_data['left_id'] . ' AND left_id < ' . $root_data['right_id'];
-	}
-
-	// Display list of active topics for this category?
-	$show_active = (isset($root_data['forum_flags']) && $root_data['forum_flags'] & 16) ? true : false;
-
-	if ($_CLASS['core_user']->is_user &&  $config['load_db_lastread'])
-	{
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+// -------------------------------------------------------------
+//
+// $Id: functions_display.php,v 1.59 2004/09/17 09:11:47 acydburn Exp $
+//
+// FILENAME  : functions_display.php
+// STARTED   : Thu Nov 07, 2002
+// COPYRIGHT : 2001, 2003 phpBB Group
+// WWW		 : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+function display_forums($root_data = '', $display_moderators = true)
+{
+	global $config, $_CLASS, $_CORE_CONFIG;
+
+	// Get posted/get info
+	$mark_read = request_var('mark', '');
+
+	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $mark_forums = array();
+	$visible_forums = 0;
+
+	if (!$root_data)
+	{
+		$root_data = array('forum_id' => 0);
+		$sql_where = '';
+	}
+	else
+	{
+		$sql_where = 'AND left_id > ' . $root_data['left_id'] . ' AND left_id < ' . $root_data['right_id'];
+	}
+
+	// Display list of active topics for this category?
+	$show_active = (isset($root_data['forum_flags']) && $root_data['forum_flags'] & 16) ? true : false;
+
+	if ($_CLASS['core_user']->is_user &&  $config['load_db_lastread'])
+	{
 		$sql_from = ' LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-				AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
-		$lastread_select = ', ft.mark_time ';
-	}
-	else
-	{
-		$sql_from = $lastread_select = $sql_lastread = '';
-		$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
-	}
-
-	$sql = "SELECT f.* $lastread_select 
-		FROM ". FORUMS_FORUMS_TABLE . " f $sql_from
-		WHERE forum_status <> ".ITEM_DELETING."
-		$sql_where
-		ORDER BY f.left_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$branch_root_id = $root_data['forum_id'];
-	$forum_ids		= array($root_data['forum_id']);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($mark_read == 'forums' && $_CLASS['core_user']->is_user)
-		{
-			if ($_CLASS['auth']->acl_get('f_list', $row['forum_id']))
-			{
-				$forum_id_ary[] = $row['forum_id'];
-			}
-
-			continue;
-		}
-
-		if (isset($right_id))
-		{
-			if ($row['left_id'] < $right_id)
-			{
-				continue;
-			}
-			unset($right_id);
-		}
-
-		if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
-		{
-			// Non-postable forum with no subforums: don't display
-			continue;
-		}
-
-		$forum_id = $row['forum_id'];
-
-		if (!$_CLASS['auth']->acl_get('f_list', $forum_id))
-		{
-			// if the user does not have permissions to list this forum, skip everything until next branch
-			$right_id = $row['right_id'];
-			continue;
-		}
-
-		// Display active topics from this forum?
-		if ($show_active && $row['forum_type'] == FORUM_POST && $_CLASS['auth']->acl_get('f_read', $forum_id) && ($row['forum_flags'] & 16))
-		{
-			$active_forum_ary['forum_id'][]		= $forum_id;
-			$active_forum_ary['enable_icons'][] = $row['enable_icons'];
-			$active_forum_ary['forum_topics']	+= ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
-			$active_forum_ary['forum_posts']	+= $row['forum_posts'];
-		}
-
-		if ($row['parent_id'] == $root_data['forum_id'] || $row['parent_id'] == $branch_root_id)
-		{
-			// Direct child
-			$parent_id = $forum_id;
-			$forum_rows[$forum_id] = $row;
-			$forum_ids[] = $forum_id;
-
-			if (!$row['parent_id'] && $row['forum_type'] == FORUM_CAT && $row['parent_id'] == $root_data['forum_id'])
-			{
-				$branch_root_id = $forum_id;
-			}
-			$forum_rows[$parent_id]['forum_id_last_post'] = $row['forum_id'];
-		}
-		elseif ($row['forum_type'] != FORUM_CAT)
-		{
-			$subforums[$parent_id]['display'] = ($row['display_on_index']) ? true : false;;
-			$subforums[$parent_id]['name'][$forum_id] = $row['forum_name'];
-
-			$forum_rows[$parent_id]['forum_topics'] += ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
-			
-			// Do not list redirects in LINK Forums as Posts.
-			if ($row['forum_type'] != FORUM_LINK)
-			{
-				$forum_rows[$parent_id]['forum_posts'] += $row['forum_posts'];
-			}
-
-			if (isset($forum_rows[$parent_id]) && $row['forum_last_post_time'] > $forum_rows[$parent_id]['forum_last_post_time'])
-			{
-				$forum_rows[$parent_id]['forum_last_post_id'] = $row['forum_last_post_id'];
-				$forum_rows[$parent_id]['forum_last_post_time'] = $row['forum_last_post_time'];
-				$forum_rows[$parent_id]['forum_last_poster_id'] = $row['forum_last_poster_id'];
-				$forum_rows[$parent_id]['forum_last_poster_name'] = $row['forum_last_poster_name'];
-				$forum_rows[$parent_id]['forum_id_last_post'] = $forum_id;
-			}
-			else
-			{
-				$forum_rows[$parent_id]['forum_id_last_post'] = $forum_id;
-			}
-		}
-
-		if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
-		{
-			$forum_id36 = base_convert($forum_id, 10, 36);
-			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
-		}
-
-		if ($row['mark_time'] < $row['forum_last_post_time'])
-		{
-			$forum_unread[$parent_id] = true;
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// Handle marking posts
-	if ($mark_read == 'forums')
-	{
-		markread('mark', $forum_id_ary);
-
-		$redirect = generate_link('Forums');
-		$_CLASS['core_display']->meta_refresh(3, $redirect);
-
-		$message = (strpos($redirect, 'viewforum') !== false) ? 'RETURN_FORUM' : 'RETURN_INDEX';
-		$message = $_CLASS['core_user']->lang['FORUMS_MARKED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang[$message], '<a href="' . $redirect . '">', '</a> ');
-		trigger_error($message);
-	}
-
-	// Grab moderators ... if necessary
-	if ($display_moderators)
-	{
-		$forum_moderators = get_moderators($forum_ids);
-	}
-
-	// Loop through the forums
-	$root_id = $root_data['forum_id'];
-
-	foreach ($forum_rows as $row)
-	{
-		if ($row['parent_id'] == $root_id && !$row['parent_id'])
-		{
-			if ($row['forum_type'] == FORUM_CAT)
-			{
-				$hold = $row;
-				continue;
-			}
-			else
-			{
-				unset($hold);
-			}
-		}
-		else if (!empty($hold))
-		{
-			$_CLASS['core_template']->assign_vars_array('forumrow', array(
-				'S_IS_CAT'			=>	TRUE,
-				'FORUM_ID'			=>	$hold['forum_id'],
-				'FORUM_NAME'		=>	$hold['forum_name'],
-				'FORUM_DESC'		=>	$hold['forum_desc'],
-				'U_VIEWFORUM'		=>	generate_link('Forums&amp;file=viewforum&amp;f=' . $hold['forum_id']))
-			);
-			unset($hold);
-		}
-
-		$visible_forums++;
-		$forum_id = $row['forum_id'];
-
-		$subforums_list = $l_subforums = '';
-		
-		// Generate list of subforums if we need to
-		if (isset($subforums[$forum_id]))
-		{
-			if ($subforums[$forum_id]['display'])
-			{
-				$links = array();
-
-				foreach ($subforums[$forum_id]['name'] as $subforum_id => $subforum_name)
-				{
-					if (!empty($subforum_name))
-					{
-						$links[] = '<a href="' .generate_link('Forums&amp;file=viewforum&amp;f='.$subforum_id).'">' . $subforum_name . '</a>';
-					}
-				}
-
-				if (!empty($links))
-				{
-					$subforums_list = implode(', ', $links);
-					$l_subforums = (count($subforums[$forum_id]) == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
-				}
-
-				unset($links);
-			}
-
-			$folder_image = (!empty($forum_unread[$forum_id])) ? 'sub_forum_new' : 'sub_forum';
-		}
-		else
-		{
-			switch ($row['forum_type'])
-			{
-				case FORUM_POST:
-					$folder_image = (!empty($forum_unread[$forum_id])) ? 'forum_new' : 'forum';
-					break;
-
-				case FORUM_LINK:
-					$folder_image = 'forum_link';
-					break;
-			}
-		}
-
-
-		// Which folder should we display?
-		if ($row['forum_status'] == ITEM_LOCKED)
-		{
-			$folder_image = 'forum_locked';
-			$folder_alt = 'FORUM_LOCKED';
-		}
-		else
-		{
-			$folder_alt = (!empty($forum_unread[$forum_id])) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
-		}
-
-		// Create last post link information, if appropriate
-		if ($row['forum_last_post_id'])
-		{
-			$last_post_time = $_CLASS['core_user']->format_date($row['forum_last_post_time']);
-
-			$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'];
-			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
-			
-			$last_post_url = generate_link('Forums&amp;file=viewtopic&amp;f='.$row['forum_id_last_post'].'&amp;p='.$row['forum_last_post_id'].'#'.$row['forum_last_post_id'], false, false, false);
-		}
-		else
-		{
-			$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
-		}
-
-
-		// Output moderator listing ... if applicable
-		$l_moderator = $moderators_list = '';
-		if ($display_moderators && !empty($forum_moderators[$forum_id]))
-		{
-			$l_moderator = (count($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']->lang['MODERATOR'] : $_CLASS['core_user']->lang['MODERATORS'];
-			$moderators_list = implode(', ', $forum_moderators[$forum_id]);
-		}
-
-		$l_post_click_count = ($row['forum_type'] == FORUM_LINK) ? 'CLICKS' : 'POSTS';
-		$post_click_count = ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] & 1) ? $row['forum_posts'] : '';
-
-		$_CLASS['core_template']->assign_vars_array('forumrow', array(
-			'S_IS_CAT'			=> false, 
-			'S_IS_LINK'			=> ($row['forum_type'] == FORUM_LINK), 
-
-			'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
-
-			'FORUM_ID'			=> $row['forum_id'], 
-			'FORUM_FOLDER_IMG'	=> ($row['forum_image']) ? '<img src="' . $row['forum_image'] . '" alt="' . $folder_alt . '" />' : $_CLASS['core_user']->img($folder_image, $folder_alt),
-			//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $row['forum_image'] : $_CLASS['core_user']->img($folder_image, $folder_alt, false, '', 'src'),
-			'FORUM_NAME'		=> $row['forum_name'],
-			'FORUM_DESC'		=> $row['forum_desc'], 
-			$l_post_click_count	=> $post_click_count,
-			'TOPICS'			=> $row['forum_topics'],
-			'LAST_POST_TIME'	=> $last_post_time,
-			'LAST_POSTER'		=> $last_poster,
-			'MODERATORS'		=> $moderators_list,
-			'SUBFORUMS'			=> $subforums_list,
-
-			'L_SUBFORUM_STR'	=> $l_subforums,
-			'L_MODERATOR_STR'	=> $l_moderator,
-			'L_FORUM_FOLDER_ALT'=> $folder_alt,
-			
-			'U_LAST_POSTER'		=> $last_poster_url, 
-			'U_LAST_POST'		=> $last_post_url, 
-			'U_VIEWFORUM'		=> ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] & 1) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : $row['forum_link'])
-		);
-	}
-
-	$_CLASS['core_template']->assign_array(array(
-		'MODIFY_FORUM'		=> $_CLASS['auth']->acl_get('a_forum'),
-		'U_MARK_FORUMS'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
-		'S_HAS_SUBFORUM'	=> ($visible_forums) ? true : false,
-		'L_SUBFORUM'		=> ($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
-	));
-
-	return $active_forum_ary;
-}
-
-function topic_topic_author(&$topic_row)
-{
-	global $_CLASS;
-
-	$topic_author = ($topic_row['topic_poster'] != ANONYMOUS) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $topic_row['topic_poster']) . '">' : '';
-	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? $topic_row['topic_first_poster_name'] : (($topic_row['topic_first_poster_name'] != '') ? $topic_row['topic_first_poster_name'] : $_CLASS['core_user']->lang['GUEST']);
-	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? '</a>' : '';
-
-	return $topic_author;
-}
-
-function topic_status(&$topic_row, $replies, $mark_time, &$folder_img, &$folder_alt, &$topic_type)
-{
-	global $_CLASS, $config;
-	
-	$folder = $folder_new = '';
-	$unread_topic = false;
-
-	if ($topic_row['topic_status'] == ITEM_MOVED)
-	{
-		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
-		$folder_img = 'folder_moved';
-		$folder_alt = 'VIEW_TOPIC_MOVED';
-	}
-	else
-	{
-		if ($topic_row['topic_status'] == ITEM_LOCKED)
-		{
-			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
-			$folder = 'folder_locked';
-			$folder_new = 'folder_locked_new';
-			
-		}
-		else
-		{
-			switch ($topic_row['topic_type'])
-			{
-				case POST_GLOBAL:
-				case POST_ANNOUNCE:
-					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
-					$folder = 'folder_announce';
-					$folder_new = 'folder_announce_new';
-					break;
-	
-				case POST_STICKY:
-					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
-					$folder = 'folder_sticky';
-					$folder_new = 'folder_sticky_new';
-					break;
-	
-				default:
-					if ($replies >= $config['hot_threshold'])
-					{
-						$folder = 'folder_hot';
-						$folder_new = 'folder_hot_new';
-					}
-					else
-					{
-						$folder = 'folder';
-						$folder_new = 'folder_new';
-					}
-					break;
-			}
-		}
-
-		$unread_topic = true;
-
-		if ($mark_time >= $topic_row['topic_last_post_time'])
-		{
-			$unread_topic = false;
-		}
-
-		$folder_img = ($unread_topic) ? $folder_new : $folder;
-		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
-	}
-
-	if ($topic_row['poll_start'])
-	{
-		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
-	}
-
-	return $unread_topic;
-}
-
-// Display Attachments
-function display_attachments($forum_id, $attachment_data, &$update_count, $force_physical = false, $parse = false)
-{
-	global $config, $_CLASS;
-
-	$return_tpl = array();
-
-	$extensions = obtain_attach_extensions();
-
-	foreach ($attachment_data as $attachment)
-	{
-		$attachment['extension'] = strtolower(trim($attachment['extension']));
-		$filename = $config['upload_path'] . '/' . basename($attachment['physical_filename']);
-		// to easy isn't it ?
-		$thumbnail_filename = $config['upload_path'] . '/thumb_' . basename($attachment['physical_filename']);
-
-		$data['lang_size'] = ($attachment['filesize'] >= 1048576) ? round((round($attachment['filesize'] / 1048576 * 100) / 100), 2) .$_CLASS['core_user']->lang['MB'] : (($attachment['filesize'] >= 1024) ? round((round($attachment['filesize'] / 1024 * 100) / 100), 2)  . $_CLASS['core_user']->lang['KB']: $attachment['filesize'] . $_CLASS['core_user']->lang['BYTES']);
-		$data['lang_views'] = (!$attachment['download_count']) ? $_CLASS['core_user']->lang['DOWNLOAD_NONE'] : (($attachment['download_count'] == 1) ? sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNT'], $attachment['download_count']) : sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNTS'], $attachment['download_count']));
-
-		$data['icon'] = ($extensions[$attachment['extension']]['upload_icon']) ? $config['upload_icons_path'] . '/' . trim($extensions[$attachment['extension']]['upload_icon']) : false;
-		$data['name'] = basename($attachment['real_filename']);
-		$data['comment'] = str_replace("\n", '<br />', censor_text($attachment['comment']));
-
-		$denied = false;
-			
-		if (!extension_allowed($forum_id, $attachment['extension'], $extensions))
-		{
-			$data['category'] = 'DENIED';
-			$data['lang'] = sprintf($_CLASS['core_user']->get_lang('EXTENSION_DISABLED_AFTER_POSTING'), $attachment['extension']);
-
-			continue;
-		}
-		else
-		{
-			$display_cat = $extensions[$attachment['extension']]['display_cat'];
-	
-			if ($display_cat == ATTACHMENT_CATEGORY_IMAGE)
-			{
-				if ($attachment['thumbnail'])
-				{
-					$display_cat = ATTACHMENT_CATEGORY_THUMB;
-				}
-				else
-				{
-					if ($config['img_display_inlined'])
-					{
-						if ($config['img_link_width'] || $config['img_link_height'])
-						{
-							list($width, $height) = getimagesize($filename);
-	
-							$display_cat = (!$width && !$height) ? ATTACHMENT_CATEGORY_IMAGE : (($width <= $config['img_link_width'] && $height <= $config['img_link_height']) ? ATTACHMENT_CATEGORY_IMAGE : ATTACHMENT_CATEGORY_NONE);
-						}
-					}
-					else
-					{
-						$display_cat = ATTACHMENT_CATEGORY_NONE;
-					}
-				}
-			}
-	
-			switch ($display_cat)
-			{
-				// Images
-				case ATTACHMENT_CATEGORY_IMAGE:
-					$data['category'] = 'IMAGE';
-					$data['image_src'] = $filename;
-	
-					$update_count[] = $attachment['attach_id'];
-				break;
-					
-				// Images, but display Thumbnail
-				case ATTACHMENT_CATEGORY_THUMB:
-					$data['category'] = 'THUMBNAIL';
-	
-					$data['image_src'] = $thumbnail_filename;
-					$data['link'] = (!$force_physical) ? generate_link('Forums&amp;file=download&amp;id=' . $attachment['attach_id']) : $filename;
-				break;
-	
-				// Windows Media Streams
-				case ATTACHMENT_CATEGORY_WM:
-					$data['category'] = 'WM_STREAM';
-					$data['link'] = $filename;
-	
-					// Viewed/Heared File ... update the download count (download.php is not called here)
-					$update_count[] = $attachment['attach_id'];
-				break;
-	
-				// Real Media Streams
-				case ATTACHMENT_CATEGORY_RM:
-					$data['category'] = 'RM_STREAM';
-					$data['link'] = $filename;
-	
-					// Viewed/Heared File ... update the download count (download.php is not called here)
-					$update_count[] = $attachment['attach_id'];
-				break;
-	
-				default:
-					$data['category'] = 'FILE';
-					$data['link'] = (!$force_physical) ? generate_link('Forums&amp;file=download&amp;id=' . $attachment['attach_id']) : $filename;
-				break;
-			}
-		}
-
-		if ($parse)
-		{
-			$_CLASS['core_template']->assign_vars_array('attachments', $data);
-			$datas[] = $_CLASS['core_template']->display('modules/Forums/attachments.html', true);
-		}
-		else
-		{
-			$datas[] = $data;
-		}
-	}
-
-	return $datas;
-}
-
+				AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
+		$lastread_select = ', ft.mark_time ';
+	}
+	else
+	{
+		$sql_from = $lastread_select = $sql_lastread = '';
+		$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+	}
+
+	$sql = "SELECT f.* $lastread_select 
+		FROM ". FORUMS_FORUMS_TABLE . " f $sql_from
+		WHERE forum_status <> ".ITEM_DELETING."
+		$sql_where
+		ORDER BY f.left_id";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$branch_root_id = $root_data['forum_id'];
+	$forum_ids		= array($root_data['forum_id']);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		if ($mark_read == 'forums' && $_CLASS['core_user']->is_user)
+		{
+			if ($_CLASS['auth']->acl_get('f_list', $row['forum_id']))
+			{
+				$forum_id_ary[] = $row['forum_id'];
+			}
+
+			continue;
+		}
+
+		if (isset($right_id))
+		{
+			if ($row['left_id'] < $right_id)
+			{
+				continue;
+			}
+			unset($right_id);
+		}
+
+		if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
+		{
+			// Non-postable forum with no subforums: don't display
+			continue;
+		}
+
+		$forum_id = $row['forum_id'];
+
+		if (!$_CLASS['auth']->acl_get('f_list', $forum_id))
+		{
+			// if the user does not have permissions to list this forum, skip everything until next branch
+			$right_id = $row['right_id'];
+			continue;
+		}
+
+		// Display active topics from this forum?
+		if ($show_active && $row['forum_type'] == FORUM_POST && $_CLASS['auth']->acl_get('f_read', $forum_id) && ($row['forum_flags'] & 16))
+		{
+			$active_forum_ary['forum_id'][]		= $forum_id;
+			$active_forum_ary['enable_icons'][] = $row['enable_icons'];
+			$active_forum_ary['forum_topics']	+= ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
+			$active_forum_ary['forum_posts']	+= $row['forum_posts'];
+		}
+
+		if ($row['parent_id'] == $root_data['forum_id'] || $row['parent_id'] == $branch_root_id)
+		{
+			// Direct child
+			$parent_id = $forum_id;
+			$forum_rows[$forum_id] = $row;
+			$forum_ids[] = $forum_id;
+
+			if (!$row['parent_id'] && $row['forum_type'] == FORUM_CAT && $row['parent_id'] == $root_data['forum_id'])
+			{
+				$branch_root_id = $forum_id;
+			}
+			$forum_rows[$parent_id]['forum_id_last_post'] = $row['forum_id'];
+		}
+		elseif ($row['forum_type'] != FORUM_CAT)
+		{
+			$subforums[$parent_id]['display'] = ($row['display_on_index']) ? true : false;;
+			$subforums[$parent_id]['name'][$forum_id] = $row['forum_name'];
+
+			$forum_rows[$parent_id]['forum_topics'] += ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['forum_topics_real'] : $row['forum_topics'];
+			
+			// Do not list redirects in LINK Forums as Posts.
+			if ($row['forum_type'] != FORUM_LINK)
+			{
+				$forum_rows[$parent_id]['forum_posts'] += $row['forum_posts'];
+			}
+
+			if (isset($forum_rows[$parent_id]) && $row['forum_last_post_time'] > $forum_rows[$parent_id]['forum_last_post_time'])
+			{
+				$forum_rows[$parent_id]['forum_last_post_id'] = $row['forum_last_post_id'];
+				$forum_rows[$parent_id]['forum_last_post_time'] = $row['forum_last_post_time'];
+				$forum_rows[$parent_id]['forum_last_poster_id'] = $row['forum_last_poster_id'];
+				$forum_rows[$parent_id]['forum_last_poster_name'] = $row['forum_last_poster_name'];
+				$forum_rows[$parent_id]['forum_id_last_post'] = $forum_id;
+			}
+			else
+			{
+				$forum_rows[$parent_id]['forum_id_last_post'] = $forum_id;
+			}
+		}
+
+		if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
+		{
+			$forum_id36 = base_convert($forum_id, 10, 36);
+			$row['mark_time'] = isset($tracking_topics[$forum_id36][0]) ? (int) base_convert($tracking_topics[$forum_id36][0], 36, 10) : 0;
+		//echo $forum_id36.' - '.$row['mark_time'].'<br/>';
+		}
+
+		if ($row['mark_time'] < $row['forum_last_post_time'])
+		{//echo $parent_id.' - '.$row['mark_time'] .' - '. $row['forum_last_post_time'].'<br/>';
+			$forum_unread[$parent_id] = true;
+		}
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	// Handle marking posts
+	if ($mark_read == 'forums')
+	{
+		markread('mark', $forum_id_ary);
+
+		$redirect = generate_link('Forums');
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+
+		$message = (strpos($redirect, 'viewforum') !== false) ? 'RETURN_FORUM' : 'RETURN_INDEX';
+		$message = $_CLASS['core_user']->lang['FORUMS_MARKED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang[$message], '<a href="' . $redirect . '">', '</a> ');
+		trigger_error($message);
+	}
+
+	// Grab moderators ... if necessary
+	if ($display_moderators)
+	{
+		$forum_moderators = get_moderators($forum_ids);
+	}
+
+	// Loop through the forums
+	$root_id = $root_data['forum_id'];
+
+	foreach ($forum_rows as $row)
+	{
+		if ($row['parent_id'] == $root_id && !$row['parent_id'])
+		{
+			if ($row['forum_type'] == FORUM_CAT)
+			{
+				$hold = $row;
+				continue;
+			}
+			else
+			{
+				unset($hold);
+			}
+		}
+		else if (!empty($hold))
+		{
+			$_CLASS['core_template']->assign_vars_array('forumrow', array(
+				'S_IS_CAT'			=>	TRUE,
+				'FORUM_ID'			=>	$hold['forum_id'],
+				'FORUM_NAME'		=>	$hold['forum_name'],
+				'FORUM_DESC'		=>	$hold['forum_desc'],
+				'U_VIEWFORUM'		=>	generate_link('Forums&amp;file=viewforum&amp;f=' . $hold['forum_id']))
+			);
+			unset($hold);
+		}
+
+		$visible_forums++;
+		$forum_id = $row['forum_id'];
+
+		$subforums_list = $l_subforums = '';
+		
+		// Generate list of subforums if we need to
+		if (isset($subforums[$forum_id]))
+		{
+			if ($subforums[$forum_id]['display'])
+			{
+				$links = array();
+
+				foreach ($subforums[$forum_id]['name'] as $subforum_id => $subforum_name)
+				{
+					if (!empty($subforum_name))
+					{
+						$links[] = '<a href="' .generate_link('Forums&amp;file=viewforum&amp;f='.$subforum_id).'">' . $subforum_name . '</a>';
+					}
+				}
+
+				if (!empty($links))
+				{
+					$subforums_list = implode(', ', $links);
+					$l_subforums = (count($subforums[$forum_id]) == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
+				}
+
+				unset($links);
+			}
+
+			$folder_image = (!empty($forum_unread[$forum_id])) ? 'sub_forum_new' : 'sub_forum';
+		}
+		else
+		{
+			switch ($row['forum_type'])
+			{
+				case FORUM_POST:
+					$folder_image = (!empty($forum_unread[$forum_id])) ? 'forum_new' : 'forum';
+					break;
+
+				case FORUM_LINK:
+					$folder_image = 'forum_link';
+					break;
+			}
+		}
+
+
+		// Which folder should we display?
+		if ($row['forum_status'] == ITEM_LOCKED)
+		{
+			$folder_image = 'forum_locked';
+			$folder_alt = 'FORUM_LOCKED';
+		}
+		else
+		{
+			$folder_alt = (!empty($forum_unread[$forum_id])) ? 'NEW_POSTS' : 'NO_NEW_POSTS';
+		}
+
+		// Create last post link information, if appropriate
+		if ($row['forum_last_post_id'])
+		{
+			$last_post_time = $_CLASS['core_user']->format_date($row['forum_last_post_time']);
+
+			$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'];
+			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
+			
+			$last_post_url = generate_link('Forums&amp;file=viewtopic&amp;f='.$row['forum_id_last_post'].'&amp;p='.$row['forum_last_post_id'].'#'.$row['forum_last_post_id'], false, false, false);
+		}
+		else
+		{
+			$last_post_time = $last_poster = $last_poster_url = $last_post_url = '';
+		}
+
+
+		// Output moderator listing ... if applicable
+		$l_moderator = $moderators_list = '';
+		if ($display_moderators && !empty($forum_moderators[$forum_id]))
+		{
+			$l_moderator = (count($forum_moderators[$forum_id]) == 1) ? $_CLASS['core_user']->lang['MODERATOR'] : $_CLASS['core_user']->lang['MODERATORS'];
+			$moderators_list = implode(', ', $forum_moderators[$forum_id]);
+		}
+
+		$l_post_click_count = ($row['forum_type'] == FORUM_LINK) ? 'CLICKS' : 'POSTS';
+		$post_click_count = ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] & 1) ? $row['forum_posts'] : '';
+
+		$_CLASS['core_template']->assign_vars_array('forumrow', array(
+			'S_IS_CAT'			=> false, 
+			'S_IS_LINK'			=> ($row['forum_type'] == FORUM_LINK), 
+
+			'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
+
+			'FORUM_ID'			=> $row['forum_id'], 
+			'FORUM_FOLDER_IMG'	=> ($row['forum_image']) ? '<img src="' . $row['forum_image'] . '" alt="' . $folder_alt . '" />' : $_CLASS['core_user']->img($folder_image, $folder_alt),
+			//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $row['forum_image'] : $_CLASS['core_user']->img($folder_image, $folder_alt, false, '', 'src'),
+			'FORUM_NAME'		=> $row['forum_name'],
+			'FORUM_DESC'		=> $row['forum_desc'], 
+			$l_post_click_count	=> $post_click_count,
+			'TOPICS'			=> $row['forum_topics'],
+			'LAST_POST_TIME'	=> $last_post_time,
+			'LAST_POSTER'		=> $last_poster,
+			'MODERATORS'		=> $moderators_list,
+			'SUBFORUMS'			=> $subforums_list,
+
+			'L_SUBFORUM_STR'	=> $l_subforums,
+			'L_MODERATOR_STR'	=> $l_moderator,
+			'L_FORUM_FOLDER_ALT'=> $folder_alt,
+			
+			'U_LAST_POSTER'		=> $last_poster_url, 
+			'U_LAST_POST'		=> $last_post_url, 
+			'U_VIEWFORUM'		=> ($row['forum_type'] != FORUM_LINK || $row['forum_flags'] & 1) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : $row['forum_link'])
+		);
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'MODIFY_FORUM'		=> $_CLASS['auth']->acl_get('a_forum'),
+		'U_MARK_FORUMS'		=> generate_link('Forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
+		'S_HAS_SUBFORUM'	=> ($visible_forums) ? true : false,
+		'L_SUBFORUM'		=> ($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
+	));
+
+	return $active_forum_ary;
+}
+
+function topic_topic_author(&$topic_row)
+{
+	global $_CLASS;
+
+	$topic_author = ($topic_row['topic_poster'] != ANONYMOUS) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $topic_row['topic_poster']) . '">' : '';
+	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? $topic_row['topic_first_poster_name'] : (($topic_row['topic_first_poster_name'] != '') ? $topic_row['topic_first_poster_name'] : $_CLASS['core_user']->lang['GUEST']);
+	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? '</a>' : '';
+
+	return $topic_author;
+}
+
+function topic_status(&$topic_row, $replies, $mark_time, &$folder_img, &$folder_alt, &$topic_type)
+{
+	global $_CLASS, $config;
+	
+	$folder = $folder_new = '';
+	$unread_topic = false;
+
+	if ($topic_row['topic_status'] == ITEM_MOVED)
+	{
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
+		$folder_img = 'folder_moved';
+		$folder_alt = 'VIEW_TOPIC_MOVED';
+	}
+	else
+	{
+		if ($topic_row['topic_status'] == ITEM_LOCKED)
+		{
+			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
+			$folder = 'folder_locked';
+			$folder_new = 'folder_locked_new';
+			
+		}
+		else
+		{
+			switch ($topic_row['topic_type'])
+			{
+				case POST_GLOBAL:
+				case POST_ANNOUNCE:
+					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
+					$folder = 'folder_announce';
+					$folder_new = 'folder_announce_new';
+					break;
+	
+				case POST_STICKY:
+					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
+					$folder = 'folder_sticky';
+					$folder_new = 'folder_sticky_new';
+					break;
+	
+				default:
+					if ($replies >= $config['hot_threshold'])
+					{
+						$folder = 'folder_hot';
+						$folder_new = 'folder_hot_new';
+					}
+					else
+					{
+						$folder = 'folder';
+						$folder_new = 'folder_new';
+					}
+					break;
+			}
+		}
+
+		$unread_topic = true;
+
+		if ($mark_time >= $topic_row['topic_last_post_time'])
+		{
+			$unread_topic = false;
+		}
+
+		$folder_img = ($unread_topic) ? $folder_new : $folder;
+		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+	}
+
+	if ($topic_row['poll_start'])
+	{
+		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
+	}
+
+	return $unread_topic;
+}
+
+// Display Attachments
+function display_attachments($forum_id, $attachment_data, &$update_count, $force_physical = false, $parse = false)
+{
+	global $config, $_CLASS;
+
+	$return_tpl = array();
+
+	$extensions = obtain_attach_extensions();
+
+	foreach ($attachment_data as $attachment)
+	{
+		$attachment['extension'] = strtolower(trim($attachment['extension']));
+		$filename = $config['upload_path'] . '/' . basename($attachment['physical_filename']);
+		// to easy isn't it ?
+		$thumbnail_filename = $config['upload_path'] . '/thumb_' . basename($attachment['physical_filename']);
+
+		$data['lang_size'] = ($attachment['filesize'] >= 1048576) ? round((round($attachment['filesize'] / 1048576 * 100) / 100), 2) .$_CLASS['core_user']->lang['MB'] : (($attachment['filesize'] >= 1024) ? round((round($attachment['filesize'] / 1024 * 100) / 100), 2)  . $_CLASS['core_user']->lang['KB']: $attachment['filesize'] . $_CLASS['core_user']->lang['BYTES']);
+		$data['lang_views'] = (!$attachment['download_count']) ? $_CLASS['core_user']->lang['DOWNLOAD_NONE'] : (($attachment['download_count'] == 1) ? sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNT'], $attachment['download_count']) : sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNTS'], $attachment['download_count']));
+
+		$data['icon'] = ($extensions[$attachment['extension']]['upload_icon']) ? $config['upload_icons_path'] . '/' . trim($extensions[$attachment['extension']]['upload_icon']) : false;
+		$data['name'] = basename($attachment['real_filename']);
+		$data['comment'] = str_replace("\n", '<br />', censor_text($attachment['comment']));
+
+		$denied = false;
+			
+		if (!extension_allowed($forum_id, $attachment['extension'], $extensions))
+		{
+			$data['category'] = 'DENIED';
+			$data['lang'] = sprintf($_CLASS['core_user']->get_lang('EXTENSION_DISABLED_AFTER_POSTING'), $attachment['extension']);
+
+			continue;
+		}
+		else
+		{
+			$display_cat = $extensions[$attachment['extension']]['display_cat'];
+	
+			if ($display_cat == ATTACHMENT_CATEGORY_IMAGE)
+			{
+				if ($attachment['thumbnail'])
+				{
+					$display_cat = ATTACHMENT_CATEGORY_THUMB;
+				}
+				else
+				{
+					if ($config['img_display_inlined'])
+					{
+						if ($config['img_link_width'] || $config['img_link_height'])
+						{
+							list($width, $height) = getimagesize($filename);
+	
+							$display_cat = (!$width && !$height) ? ATTACHMENT_CATEGORY_IMAGE : (($width <= $config['img_link_width'] && $height <= $config['img_link_height']) ? ATTACHMENT_CATEGORY_IMAGE : ATTACHMENT_CATEGORY_NONE);
+						}
+					}
+					else
+					{
+						$display_cat = ATTACHMENT_CATEGORY_NONE;
+					}
+				}
+			}
+	
+			switch ($display_cat)
+			{
+				// Images
+				case ATTACHMENT_CATEGORY_IMAGE:
+					$data['category'] = 'IMAGE';
+					$data['image_src'] = $filename;
+	
+					$update_count[] = $attachment['attach_id'];
+				break;
+					
+				// Images, but display Thumbnail
+				case ATTACHMENT_CATEGORY_THUMB:
+					$data['category'] = 'THUMBNAIL';
+	
+					$data['image_src'] = $thumbnail_filename;
+					$data['link'] = (!$force_physical) ? generate_link('Forums&amp;file=download&amp;id=' . $attachment['attach_id']) : $filename;
+				break;
+	
+				// Windows Media Streams
+				case ATTACHMENT_CATEGORY_WM:
+					$data['category'] = 'WM_STREAM';
+					$data['link'] = $filename;
+	
+					// Viewed/Heared File ... update the download count (download.php is not called here)
+					$update_count[] = $attachment['attach_id'];
+				break;
+	
+				// Real Media Streams
+				case ATTACHMENT_CATEGORY_RM:
+					$data['category'] = 'RM_STREAM';
+					$data['link'] = $filename;
+	
+					// Viewed/Heared File ... update the download count (download.php is not called here)
+					$update_count[] = $attachment['attach_id'];
+				break;
+	
+				default:
+					$data['category'] = 'FILE';
+					$data['link'] = (!$force_physical) ? generate_link('Forums&amp;file=download&amp;id=' . $attachment['attach_id']) : $filename;
+				break;
+			}
+		}
+
+		if ($parse)
+		{
+			$_CLASS['core_template']->assign_vars_array('attachments', $data);
+			$datas[] = $_CLASS['core_template']->display('modules/Forums/attachments.html', true);
+		}
+		else
+		{
+			$datas[] = $data;
+		}
+	}
+
+	return $datas;
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/functions.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -116,8 +116,10 @@
 	return $load_status;
 }
 
-function get_server_load()
+function get_server_load($return = true)
 {
+	global $_CORE_CONFIG, $_CLASS;
+
 	$load = 0;
 
 	if (file_exists('/proc/loadavg'))
@@ -134,7 +136,17 @@
 		list($load) = explode(',', $load);
 	}*/
 
+	if (!$return && $load)
+	{
+		if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
+		{
+			header('HTTP/1.0 503 Service Unavailable');
+			trigger_error('503:'.$_CORE_CONFIG['maintenance']['text'], E_USER_ERROR);
+		}
+	}
+
 	return $load;
+
 }
 
 function check_maintance_status($return = false)
@@ -167,6 +179,11 @@
 				return $maintance_status = true;
 			}
 
+			if (VIPERAL === 'FEED' || VIPERAL === 'AJAX')
+			{	
+				header('HTTP/1.0 503 Service Unavailable');
+			}
+
 			trigger_error('503:'.$_CORE_CONFIG['maintenance']['text'], E_USER_ERROR);
 		}
 
@@ -189,7 +206,7 @@
 
 function display_confirmation($message = '', $hidden = '', $image = false)
 {
-	global $_CLASS, $SID;
+	global $_CLASS;
 // Add user entered confirmation code as a choose, maybe ...
 	if (isset($_POST['cancel']))
 	{
@@ -391,7 +408,7 @@
 	{
 		$link = $file;
 
-		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->sid_link))
+		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
 		{
 			$link .= '?'.$_CLASS['core_user']->sid_link;
 		}
@@ -405,7 +422,7 @@
 
 		$link = $file.'?mod='.$link;
 
-		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->sid_link))
+		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
 		{
 			$link .= '&amp;'.$_CLASS['core_user']->sid_link;
 		}

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/session.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -29,6 +29,7 @@
 
 	var $sid_link_prefex = 'sid';
 	var $sid_link = false;
+	var $need_sid = true;
 
 	var $autologin_code = false;
 
@@ -36,8 +37,6 @@
 	{
 		global $_CLASS, $_CORE_CONFIG, $SID, $mod;
 
-		$this->server_local = ($_SERVER['HTTP_HOST'] == 'localhost' || $_SERVER['HTTP_HOST'] == '127.0.0.1') ? true : false;
-
 		$session_id = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE');
 		$session_id_url = get_variable('sid', 'GET');
 
@@ -47,12 +46,11 @@
 			if (!$session_id || $session_id !== $session_id_url)
 			{
 				$session_id = $session_id_url;
-				$this->sid_link = 'sid='.$session_id;
 			}
 		}
-		else
+		elseif (!defined('NEED_SID'))
 		{
-			$this->sid_link = defined('NEED_SID') ? 'sid='.$session_id : false;
+			$this->need_sid = false;
 		}
 
 		if ($session_id)
@@ -104,7 +102,14 @@
 					$this->is_admin = ($this->data['session_admin'] == ADMIN_IS_ADMIN);
 
 					check_maintance_status();
+					
+					if ($this->is_bot)
+					{
+						$this->need_sid = false;
+					}
+
 					$this->load = check_load_status();
+					$this->sid_link = 'sid='.$this->data['session_id'];
 
 					return true;
 				}
@@ -209,7 +214,8 @@
 			$this->set_cookie('sid', $session_id, 0);
 		}
 
-		$this->sid_link = ($this->is_bot) ? false : 'sid='.$this->data['session_id'];
+		$this->need_sid = ($this->is_bot) ? false : true;
+		$this->sid_link = 'sid='.$this->data['session_id'];
 
 		$this->data['sessions'] = array();
 

Deleted: cms/trunk/includes/templates/modules/Forums/viewtopic_attach_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewtopic_attach_body.html	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/templates/modules/Forums/viewtopic_attach_body.html	2005-09-16 19:22:36 UTC (rev 128)
@@ -1,70 +0,0 @@
-<br /><br />
-<!-- BEGIN attachment -->
-<hr />
-	<!-- IF postrow.attachment.IS_DENIED -->
-		<span class="postbody">[{postrow.attachment.L_DENIED}]</span><br /><br />
-	<!-- ENDIF -->
-	<!-- IF postrow.attachment.IS_WM_STREAM -->
-		<span class="postbody">{postrow.attachment.COMMENT}</span><br />
-		<object id="wmp" classid="CLSID:22d6f312-b0f6-11d0-94ab-0080c74c7e95" codebase="http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=6,0,0,0" standby="Loading Microsoft Windows Media Player components..." type="application/x-oleobject"> 
-		<param name="FileName" value="{postrow.attachment.U_DOWNLOAD_LINK}"> 
-		<param name="ShowControls" value="1"> 
-		<param name="ShowDisplay" value="0"> 
-		<param name="ShowStatusBar" value="1"> 
-		<param name="AutoSize" value="1"> 
-		<param name="AutoStart" value="0"> 
-		<param name="Visible" value="1"> 
-		<param name="AnimationStart" value="0"> 
-		<param name="Loop" value="0"> 
-		<embed type="application/x-mplayer2" pluginspage="http://www.microsoft.com/windows95/downloads/contents/wurecommended/s_wufeatured/mediaplayer/default.asp" src="{postrow.attachment.U_DOWNLOAD_LINK}" name=MediaPlayer2 showcontrols=1 showdisplay=0 showstatusbar=1 autosize=1 autostart=0 visible=1 animationatstart=0 loop=0></embed> 
-		</object>
-		<br /><span class="gensmall">{postrow.attachment.DOWNLOAD_NAME} - {postrow.attachment.L_DOWNLOADED_VIEWED} {postrow.attachment.L_DOWNLOAD_COUNT}</span><br /><br />
-	<!-- ELSEIF postrow.attachment.IS_RM_STREAM -->
-		<span class="postbody">{postrow.attachment.COMMENT}</span><br />
-
-		<object id=rmstream_{postrow.attachment.ATTACH_ID} classid="clsid:CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA" width="0" height="0">
-		<param name="src" value="{postrow.attachment.U_FORUM}/{postrow.attachment.U_DOWNLOAD_LINK}">
-		<param name="autostart" value="false">
-		<param name="controls" value="ImageWindow">
-		<param name="console" value="{postrow.attachment.U_DOWNLOAD_LINK}">
-		<param name="prefetch" value="true">
-		<embed name=rmstream_{postrow.attachment.ATTACH_ID} type="audio/x-pn-realaudio-plugin" src="{postrow.attachment.U_FORUM}/{postrow.attachment.U_DOWNLOAD_LINK}" width="0" height="0" autostart="false" controls="ImageWindow" console="video" prefetch="true"></embed>
-		</object>
-		<br />
-		<object id=ctrls_{postrow.attachment.ATTACH_ID} classid="clsid:CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA" width="0" height="36">
-		<param name="controls" value="ControlPanel">
-		<param name="console" value="{postrow.attachment.U_DOWNLOAD_LINK}">
-		<embed name=ctrls_{postrow.attachment.ATTACH_ID} type="audio/x-pn-realaudio-plugin" width="0" height="36" controls="ControlPanel" console="video"></embed>
-		</object>
-
-		<script language="Javascript">
-		<!--
-
- 	    while (!document.rmstream_{postrow.attachment.ATTACH_ID}.GetClipWidth())
-		{
-		}
-
-		var width = document.rmstream_{postrow.attachment.ATTACH_ID}.GetClipWidth();
-		var height = document.rmstream_{postrow.attachment.ATTACH_ID}.GetClipHeight();
-
-		document.rmstream_{postrow.attachment.ATTACH_ID}.width = width;
-		document.rmstream_{postrow.attachment.ATTACH_ID}.height = height;
-		document.ctrls_{postrow.attachment.ATTACH_ID}.width = width;
-		//-->
-		</script>
-		<br /><span class="gensmall">{postrow.attachment.DOWNLOAD_NAME} - {postrow.attachment.L_DOWNLOADED_VIEWED} {postrow.attachment.L_DOWNLOAD_COUNT}</span><br /><br />
-	<!-- ELSEIF postrow.attachment.IS_IMAGE -->
-		<span class="postbody">{postrow.attachment.COMMENT}<br />
-		<img src="{postrow.attachment.U_DOWNLOAD_LINK}" alt="{postrow.attachment.DOWNLOAD_NAME}" /></span>
-		<br /><span class="gensmall">{postrow.attachment.DOWNLOAD_NAME} - {postrow.attachment.L_DOWNLOADED_VIEWED} {postrow.attachment.L_DOWNLOAD_COUNT}</span><br /><br />
-	<!-- ELSEIF postrow.attachment.IS_THUMBNAIL -->
-		<span class="postbody">{postrow.attachment.COMMENT}<br />
-		<a href="{postrow.attachment.U_DOWNLOAD_LINK}" target="_blank"><img src="{postrow.attachment.THUMB_IMG}" alt="{postrow.attachment.DOWNLOAD_NAME}" border="0" /></a></span>
-		<br /><span class="gensmall">{postrow.attachment.DOWNLOAD_NAME} - {postrow.attachment.L_DOWNLOADED_VIEWED} {postrow.attachment.L_DOWNLOAD_COUNT}</span><br /><br />
-	<!-- ELSE -->
-		<span class="postbody">{postrow.attachment.COMMENT}</span><br />
-		<span class="postbody">{postrow.attachment.UPLOAD_IMG}
-		<a href="{postrow.attachment.U_DOWNLOAD_LINK}" target="_blank">{postrow.attachment.DOWNLOAD_NAME}</a> - {postrow.attachment.FILESIZE} {postrow.attachment.SIZE_VAR}<br /></span>
-		<span class="gensmall">{postrow.attachment.L_DOWNLOADED_VIEWED} {postrow.attachment.L_DOWNLOAD_COUNT}</span><br /><br />
-	<!-- ENDIF -->
-<!-- END attachment -->

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/includes/user.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -406,14 +406,14 @@
 			$name = $_CORE_CONFIG['server']['cookie_name'] . '_' . $name;
 		}
 
-		if ($this->server_local)
-		{
-			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path']);
+		if (SERVER_LOCAL)
+		{
+			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path']);
+		}
+		else
+		{
+			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['site_secure']);
 		}
-		else
-		{
-			setcookie($name, $cookie_data, $cookie_time, $_CORE_CONFIG['server']['cookie_path'], $_CORE_CONFIG['server']['cookie_domain'], $_CORE_CONFIG['server']['site_secure']);
-		}
 	}
 
 ///////////////////

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/installer.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -354,7 +354,7 @@
 		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
 		$_CLASS['core_db']->free_result($result);
-	
+
 		if (!$result)
 		{
 			$stage = 2;
@@ -375,7 +375,7 @@
 	
 				$config_data .= "\$site_db['$name'] = $value;\n";
 			}
-	
+
 			$config_data .= "\n";
 			$config_data .= "\$table_prefix\t= '$table_prefix';\n";
 			$config_data .= "\$user_prefix\t= '$user_prefix';\n\n";
@@ -383,7 +383,7 @@
 			$config_data .= "if (!defined('INDEX_PAGE'))\n{\n\tdefine('INDEX_PAGE', 'index.php');\n}\n\n";
 			$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
 			$config_data .= '?>';
-	
+
 			if (file_put_contents($site_file_root.'config.php', $config_data))
 			{
 				$config_data = false;
@@ -392,17 +392,17 @@
 			{
 				$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
 			}
-			
+
 			$path = dirname(getenv('SCRIPT_NAME'));
-	
+
 			if (substr($path, -1) != '/')
 			{
 				$path .= '/';
 			}
-	
+
 			$path = str_replace('install/', '', $path);
-			$domain = !empty($_SERVER['SERVER_NAME']) ? $_SERVER['SERVER_NAME'] : $_SERVER['HTTP_HOST'];
-	
+			$domain = empty($_SERVER['SERVER_NAME']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME'];
+
 			$_CLASS['core_template']->assign_array(array(
 				'site_name'			=> 'New CMS Site',
 				'site_domain'		=> $domain,
@@ -419,7 +419,7 @@
 				'error'				=> empty($error) ? false : implode('<br/>', $error),
 				'config_content'	=> $config_data
 			));
-	
+
 			$_CLASS['core_template']->display('installer/stage3.html');
 	
 			script_close();

Modified: cms/trunk/javascript/collapse.js
===================================================================
--- cms/trunk/javascript/collapse.js	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/javascript/collapse.js	2005-09-16 19:22:36 UTC (rev 128)
@@ -12,42 +12,6 @@
 	var slider_height = new Array();
 }
 
-function get_cookie(cookie_name)
-{
-	var cookie_prefix = cookie_name + "=";
-	var cookie_length = document.cookie.length;
-
-	if (cookie_length > 0)
-	{
-		var start = document.cookie.indexOf(cookie_prefix);
-
-		if (start != -1)
-		{
-			start += cookie_prefix.length;
-			var end = document.cookie.indexOf(';', start);
-
-			if (end == -1)
-			{
-				end = cookie_length;
-			}
-
-			return unescape(document.cookie.substring(start, end));
-		}
-	}
-
-	return null;
-}
-
-function set_cookie(cookie_name, value, expires)
-{
-	document.cookie = cookie_name + '=' + escape(value) + '; path=/; expires=' + expires.toGMTString();
-}
-
-function delete_cookie(cookie_name)
-{
-	document.cookie = cookie_name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path=/';
-}
-
 function switch_collapse(identifier, no_slide, cookie)
 {
 	var area = document.getElementById(identifier);

Modified: cms/trunk/javascript/common.js
===================================================================
--- cms/trunk/javascript/common.js	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/javascript/common.js	2005-09-16 19:22:36 UTC (rev 128)
@@ -1,5 +1,41 @@
 // By Ryan Marshall ( viperal1 at gmail.com )
 
+function get_cookie(cookie_name)
+{
+	var cookie_prefix = cookie_name + "=";
+	var cookie_length = document.cookie.length;
+
+	if (cookie_length > 0)
+	{
+		var start = document.cookie.indexOf(cookie_prefix);
+
+		if (start != -1)
+		{
+			start += cookie_prefix.length;
+			var end = document.cookie.indexOf(';', start);
+
+			if (end == -1)
+			{
+				end = cookie_length;
+			}
+
+			return unescape(document.cookie.substring(start, end));
+		}
+	}
+
+	return null;
+}
+
+function set_cookie(cookie_name, value, expires)
+{
+	document.cookie = cookie_name + '=' + escape(value) + '; path='+cms_cookie_path+'; expires=' + expires.toGMTString();
+}
+
+function delete_cookie(cookie_name)
+{
+	document.cookie = cookie_name + '=' + '; expires=Thu, 01-Jan-70 00:00:01 GMT' +  '; path='+cms_cookie_path+'';
+}
+
 function array_search(needle, haystack, strict)
 {
 	for (var i in haystack)
@@ -49,6 +85,8 @@
 		this.init();
 	}
 
+	url += '&sid='+cms_session_id;
+
 	this.request.open('POST', url, this.async);
 	this.request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
 

Modified: cms/trunk/javascript/forums/forum_view.js
===================================================================
--- cms/trunk/javascript/forums/forum_view.js	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/javascript/forums/forum_view.js	2005-09-16 19:22:36 UTC (rev 128)
@@ -1,5 +1,5 @@
 // By Ryan Marshall ( viperal1 at gmail.com )
-
+//svn checkout svn://svn.berlios.de/viperals/cms/trunk /net/pork/export/nfs/home/groups/viperals/htdocs
 function tite_edit_init(id, mode)
 {
 	var area = document.getElementById(mode + '_' + id)
@@ -59,7 +59,7 @@
 
 				var input = document.getElementById(mode + '_input_' + id);
 
-				ajax.send('index.php?mod=Forums&file=ajax', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
+				ajax.send('ajax.php?mod=Forums', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
 
 				tite_edit_remove(id, mode);
 			}
@@ -126,7 +126,7 @@
 
 	var input = document.getElementById(mode + '_input_' + id);
 
-	ajax.send('index.php?mod=Forums&file=ajax', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
+	ajax.send('ajax.php?mod=Forums', '&mode=' + mode + '_edit_title&title=' + input.value + '&id=' + id);
 
 	tite_edit_remove(id, mode);
 }
\ No newline at end of file

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -28,6 +28,11 @@
 
 header('Content-Type: text/html');
 
+require_once($site_file_root.'includes/forums/functions.php');
+load_class($site_file_root.'includes/forums/auth.php', 'auth');
+
+$_CLASS['auth']->acl($_CLASS['core_user']->data);
+
 Switch (get_variable('mode', 'POST', false))
 {
 	case 'forum_edit_title':

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Forums/index.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -23,7 +23,7 @@
 
 $file = get_variable('file', 'REQUEST', false);
 
-$approved_files = array('ajax', 'viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');
+$approved_files = array('viewforum', 'viewtopic', 'report', 'faq', 'posting', 'download', 'mcp', 'search');
 
 if (!$file || !in_array($file, $approved_files))
 {

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Forums/posting.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -315,7 +315,7 @@
 		trigger_error('USER_CANNOT_EDIT');
 	}
 
-	if (!($posting_data['post_time'] > time() - $config['edit_time'] || !$config['edit_time']))
+	if ($config['edit_time'] && $posting_data['post_time'] > ($current_time - $config['edit_time']))
 	{
 		trigger_error('CANNOT_EDIT_TIME');
 	}
@@ -437,7 +437,7 @@
 
 	$_CLASS['core_db']->transaction('commit');
 
-	markread('topic', $forum_id, $topic_id, $current_time);
+	//markread('topic', $forum_id, $topic_id, $current_time);
 
 	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']->lang['LOGM_BUMP'], $posting_data['topic_title']));
 
@@ -1363,7 +1363,7 @@
 		return;
 	}
 
-	$current_time = gmtime();
+	$current_time = $_CLASS['core_user']->time;
 
 	if ($mode == 'post')
 	{
@@ -1862,7 +1862,7 @@
 	}
 
 	// Mark this topic as read and posted to.
-	markread('topic', $data['forum_id'], $data['topic_id'], $data['post_time']);
+	//markread('topic', $data['forum_id'], $data['topic_id'], $data['post_time']);
 
 	// Send Notifications
 	if ($mode != 'edit' && $mode != 'delete' && (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')))

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -87,7 +87,7 @@
 	{
 		$sql_lastread = $lastread_select = '';
 		$tracking_topics = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
-	
+
 		if (!is_array($tracking_topics))
 		{
 			$tracking_topics = array();
@@ -444,7 +444,8 @@
 		{
 			if ($mark_forum_read)
 			{
-				$mark_forum_read = ($row['topic_last_post_time'] < $mark_time_topic) ? (int) $mark_time_topic : false;
+				$mark_forum_read = ($row['topic_last_post_time'] > $mark_time_topic) ? false : max((int)$mark_forum_read, $mark_time_topic);
+			//echo $row['topic_last_post_time']. ' - '.$mark_time_topic.' :';
 			}
 			$mark_time = $mark_time_topic;
 		}

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -1269,13 +1269,14 @@
 	}
 	else
 	{
+		
 		$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
 
 		if (!is_array($tracking))
 		{
 			$tracking = array();
 		}
-		
+
 		$forum_id36 = base_convert($forum_id, 10, 36);
 		$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 
@@ -1287,33 +1288,29 @@
 
 	$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page']);
 	$update_forum_mark = true;
+	$last_forum_post = 0;
 
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		// DESC order so the first post is the last post
-		$last_forum_post = $row['topic_last_post_time'];
+		$last_forum_post = max($last_forum_post, $row['topic_last_post_time']);
 
-// add user view options
-		do
+		if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
 		{
-			if (!$_CLASS['core_user']->is_user || !$config['load_db_lastread'])
-			{
-				$topic_id36 = base_convert($topic_id, 10, 36);
-				$row['mark_time'] = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
-			}
+			$topic_id36 = base_convert($topic_id, 10, 36);
+			$row['mark_time'] = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+		}
 
-			$last_mark_time = max($row['mark_time'], $mark_time_forum);
+		$last_mark_time = max($row['mark_time'], $mark_time_forum);
 
-			if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
-			{
-				// We have a winner/loser
-				// Set so the forum isn't marked
-				$update_forum_mark = false;
-echo 'test';
-				break;
-			}
+		if ($row['topic_last_post_time'] > $last_mark_time && $row['topic_id'] != $topic_id)
+		{
+			// We have a winner/loser
+			// Set so the forum isn't marked
+			$update_forum_mark = false;
+
+			break;
 		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 	}
 	$_CLASS['core_db']->free_result($result);
 
@@ -1349,6 +1346,7 @@
 		return gmtime();
 	}
 
+
 	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])
 	{
 		$sql = 'SELECT MAX(mark_time) as mark_time

Added: cms/trunk/modules/Quick_Message/ajax.php
===================================================================
--- cms/trunk/modules/Quick_Message/ajax.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Quick_Message/ajax.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -0,0 +1,188 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $table_prefix;
+
+if (!defined('QUICK_MESSAGE_TABLE'))
+{
+	define('QUICK_MESSAGE_TABLE', $table_prefix.'quick_message');
+}
+
+$_CLASS['core_user']->user_setup();
+$mode = get_variable('mode', 'REQUEST', false);
+
+switch ($mode)
+{
+	case 'ajax_refresh':
+		require_once($site_file_root.'modules/Quick_Message/functions.php');
+
+		echo qm_block_content();
+
+		script_close();
+	break;
+
+	case 'ajax_add':
+		if ($_CLASS['core_user']->is_bot)
+		{
+			die;
+		}
+
+		$message = trim(get_variable('message', 'POST', false));
+
+		if (!$message)
+		{
+			die;
+		}
+
+		$length = mb_strlen($message);
+
+		if ($length > $_CORE_CONFIG['quick_message']['length_max'])
+		{ 
+			die;
+		}
+
+	// use limit
+		$result = $_CLASS['core_db']->query('SELECT COUNT(*) as count FROM '.QUICK_MESSAGE_TABLE." WHERE message_text='".$_CLASS['core_db']->escape($message)."' AND message_time >= ".($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['last_post_check']));
+		$count = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+	// add a count check here so it admin ajustable
+		if ($count['count'] > 0)
+		{
+			die;
+		}
+
+		$_CLASS['core_db']->free_result($result);
+
+		if ($_CLASS['core_user']->is_user)
+		{
+			$user_id =  $_CLASS['core_user']->data['user_id'];
+			$user_name = $_CLASS['core_user']->data['username'];
+		}
+		else
+		{
+			$user_id = 0;
+			$user_name = get_variable('poster_name', 'POST', false);
+
+			if (!$user_name)
+			{
+				if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
+				{
+					die;
+				}
+			}
+			else
+			{
+				$length = mb_strlen($user_name);
+
+				if ($length < 2)
+				{
+					die;
+				}
+
+				if ($length > 10)
+				{
+					die;
+				}
+
+				require($site_file_root.'includes/functions_user.php');
+				$status = validate_username($user_name);
+
+				if ($status !== true)
+				{
+					die;
+				}
+			}
+		}
+
+		$sql = 'INSERT INTO '.QUICK_MESSAGE_TABLE.' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			'poster_name'	=> (string) $user_name,
+			'poster_id'		=> (int) $user_id,
+			'poster_ip'		=> (string) $_CLASS['core_user']->ip,
+			'message_text'	=> (string) $message,
+			'message_time'	=> (int) $_CLASS['core_user']->time,
+		));
+
+		$_CLASS['core_db']->query($sql);
+
+		require_once($site_file_root.'modules/Quick_Message/functions.php');
+
+		echo qm_block_content();
+
+		script_close();
+
+	break;
+
+	case 'delete':
+		global $_CORE_CONFIG, $_CLASS;
+
+		$id = get_variable('id', 'GET', false, 'integer');
+
+		if (!$id)
+		{
+			die;
+		}
+
+		$result = $_CLASS['core_db']->query_limit('SELECT message_id, poster_id, poster_name, poster_ip, message_time FROM '.QUICK_MESSAGE_TABLE.' ORDER BY message_time DESC', 1);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		
+		if (!$row)
+		{
+			trigger_error('NO_MESSAGE');
+		}
+
+		$return = true;
+
+		if ($row['message_id'] == $id)
+		{
+			if ($row['message_time'] > ($_CLASS['core_user']->time - $_CORE_CONFIG['quick_message']['delete_time']))
+			{
+				if (($row['poster_id'] && $row['poster_id'] == $_CLASS['core_user']->data['user_id']) || (!$row['poster_id'] && $row['poster_ip'] == $_CLASS['core_user']->ip))
+				{
+					$return = false;
+				}
+			}
+		}
+
+		if ($return)
+		{
+			trigger_error('MESSAGE_NOT_DELETABLE');
+		}
+
+		$sql = 'DELETE FROM ' . QUICK_MESSAGE_TABLE . ' WHERE message_id = '.$id;
+		$_CLASS['core_db']->query($sql);
+
+		//trigger_error('MESSAGE_DELETED');
+		redirect(($_CLASS['core_user']->data['session_url']) ? generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)) : '');
+	break;
+}
+
+script_close(false);
+
+?>
\ No newline at end of file

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-16 19:22:36 UTC (rev 128)
@@ -39,16 +39,7 @@
 {
 	switch ($mode)
 	{
-		case 'ajax_refresh':
-			require_once($site_file_root.'modules/Quick_Message/functions.php');
-	
-			echo qm_block_content();
-	
-			script_close();
-		break;
-	
 		case 'add':
-		case 'ajax_add':
 			if ($_CLASS['core_user']->is_bot)
 			{
 				redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
@@ -58,11 +49,6 @@
 	
 			if (!$message)
 			{
-				if ($mode === 'ajax_add')
-				{
-					die;
-				}
-	
 				trigger_error('NO_MESSAGE');
 			}
 	
@@ -70,11 +56,6 @@
 	
 			if ($length > $_CORE_CONFIG['quick_message']['length_max'])
 			{ 
-				if ($mode === 'ajax_add')
-				{
-					die;
-				}
-	
 				trigger_error('LONG_MESSAGE');
 			}
 	
@@ -86,11 +67,6 @@
 		// add a count check here so it admin ajustable
 			if ($count['count'] > 0)
 			{
-				if ($mode === 'ajax_add')
-				{
-					die;
-				}
-	
 				trigger_error(sprintf($_CLASS['core_user']->lang['SAME_MESSAGE'], $_CORE_CONFIG['quick_message']['last_post_check'] / 60));
 			}
 	
@@ -110,10 +86,6 @@
 				{
 					if ($_CORE_CONFIG['quick_message']['anonymous_posting'] != '2')
 					{
-						if ($mode === 'ajax_add')
-						{
-							die;
-						}
 						trigger_error('NO_NAME');
 					}
 				}
@@ -123,19 +95,11 @@
 	
 					if ($length < 2)
 					{
-						if ($mode === 'ajax_add')
-						{
-							die;
-						}
 						trigger_error('SHORT_NAME');
 					}
 	
 					if ($length > 10)
 					{
-						if ($mode = 'ajax_add')
-						{
-							die;
-						}
 						trigger_error('LONG_NAME');
 					}
 	
@@ -144,10 +108,6 @@
 
 					if ($status !== true)
 					{
-						if ($mode === 'ajax_add')
-						{
-							die;
-						}
 						trigger_error($error);
 					}
 				}
@@ -162,16 +122,7 @@
 			));
 	
 			$_CLASS['core_db']->query($sql);
-	
-			if ($mode === 'ajax_add')
-			{
-				require_once($site_file_root.'modules/Quick_Message/functions.php');
-	
-				echo qm_block_content();
-	
-				script_close();
-			}
-	
+
 			redirect(generate_link($_CLASS['core_user']->data['session_url'], array('full' => true)));
 		break;
 	

Modified: cms/trunk/themes/viperal/style/style.css
===================================================================
--- cms/trunk/themes/viperal/style/style.css	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/themes/viperal/style/style.css	2005-09-16 19:22:36 UTC (rev 128)
@@ -18,7 +18,7 @@
 	z-index: 1;
 }
 
-#nav li a, .active
+#nav li a, .active
 {
 	display: block;
 	padding: 5px 10px 5px 5px; 
@@ -296,7 +296,14 @@
 p.forumdesc { margin: 0px 4px 0px 0px; padding: 4px; font-size: 100%; }
 a.forumlink { color: #069; font-size: 120%; font-weight: bold; }
 
-p.topictitle { margin: 1px 0px; display: inline; font-size: 100%; font-weight: bold; }
+.topictitle
+{
+	margin: 1px 0px;
+	display: inline;
+	font-size: 100%;
+	font-weight: bold;
+}
+
 p.topicauthor { margin: 1px 0px; font-size: 100%; }
 p.topicdetails { margin: 1px 0px; font-size: 95%; }
 
@@ -412,11 +419,6 @@
 	color: #000000; text-decoration: none;
 }
 
-a.topictitle:visited
-{
-	color: #5493B4; text-decoration: none;
-}
-
 a.th:link, a.th:active, a.th:visited
 {
 	color: #FFA34F; text-decoration: none;

Modified: cms/trunk/themes/viperal/template/header.html
===================================================================
--- cms/trunk/themes/viperal/template/header.html	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/themes/viperal/template/header.html	2005-09-16 19:22:36 UTC (rev 128)
@@ -6,10 +6,9 @@
 <meta name="author" content="{ $SITE_NAME }" /><meta http-equiv="expires" content="0" />
 <meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
 <meta name="robots" content="index, follow" />
-<!-- <link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" /> -->
-<style type="text/css">@import "{ $A_STYLESHEET }";</style>
+{ $HEADER_META }
+<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
 { $HEADER_REGULAR }
-
 { $HEADER_JS }
 <script type="text/javascript" src="javascript/collapse.js"></script>
 
@@ -23,7 +22,6 @@
 <![endif]-->
 </head>
 <body>
-{ $HEADER_BODY }
 
 <a name="Top"></a>
 

Modified: cms/trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-15 19:32:21 UTC (rev 127)
+++ cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-16 19:22:36 UTC (rev 128)
@@ -5,13 +5,12 @@
 <meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
 <meta name="author" content="{ $SITE_NAME }" /><meta http-equiv="expires" content="0" />
 <meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
-<meta name="robots" content="noindex, nofollow" />
-<!-- <link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" /> -->
-<style type="text/css">@import "{ $A_STYLESHEET }";</style>
-
+<!-- <meta name="robots" content="noindex, nofollow" /> -->
+<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+{ $HEADER_META }
+<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
 { $HEADER_REGULAR }
 { $HEADER_JS }
-
 <script type="text/javascript" src="javascript/collapse.js"></script>
 <script type="text/javascript" src="javascript/menu.js"></script>
 



From viperal at berlios.de  Fri Sep 16 21:56:46 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 16 Sep 2005 21:56:46 +0200
Subject: [Viperals-svncheckins] r129 - in cms/trunk/themes/viperal/template/modules: . articles
Message-ID: <200509161956.j8GJuk58004032@sheep.berlios.de>

Author: viperal
Date: 2005-09-16 21:56:44 +0200 (Fri, 16 Sep 2005)
New Revision: 129

Added:
   cms/trunk/themes/viperal/template/modules/articles/
   cms/trunk/themes/viperal/template/modules/articles/index.html
   cms/trunk/themes/viperal/template/modules/articles/print.html
   cms/trunk/themes/viperal/template/modules/articles/view.html
Removed:
   cms/trunk/themes/viperal/template/modules/News/
Log:


Added: cms/trunk/themes/viperal/template/modules/articles/index.html
===================================================================
--- cms/trunk/themes/viperal/template/modules/articles/index.html	2005-09-16 19:22:36 UTC (rev 128)
+++ cms/trunk/themes/viperal/template/modules/articles/index.html	2005-09-16 19:56:44 UTC (rev 129)
@@ -0,0 +1,26 @@
+<!-- DISPLAY_HEADER -->
+
+<div class="articles_block">
+	<!-- LOOP $articles -->
+	<div class="title" onclick="switch_collapse('a_{ $articles:id }');" style="cursor:pointer">{ $articles:title }</div>
+		<div class="content"<!-- IF { $articles:collapse } --> style="display: none"<!-- ENDIF --> id="a_{ $articles:id }">
+			{ $articles:content }
+			<br clear="all">
+			<p>
+				<!-- IF { $articles:full_story } --><a href="{ $articles:link_content }" > { $L_READMORE } ..</a><!-- ENDIF -->
+				<hr />
+				<div style="float: left; Top: -2.5em;">
+					<a onclick="window.open('{ $articles:link_print }', 'print{ $articles:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600,height=400'); return false;" href="{ $articles:link_print }" ><img src="themes/viperal/images/print.png" alt="" /></a>
+					<a onclick="window.open('{ $articles:link_send }', 'send{ $articles:id }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600'); return false;" href="{ $articles:link_send }" ><img src="themes/viperal/images/mail.png" alt="" /></a>
+				</div>
+				<div style="float: right; Top: -2.5em;">{ $L_POSTED } { $articles:time }<br/>
+					<!-- IF { $articles:link_poster } -->By: <a href="{ $articles:link_poster }">{ $articles:poster } </a><!-- ELSE -->By: { $articles:poster } <!-- ENDIF -->
+				</div>
+			</p>
+		</div>
+	<br /><br />
+	<!-- ENDLOOP $articles -->
+	<p align="center"> { $articles_pagination }</p>
+</div>
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/themes/viperal/template/modules/articles/print.html
===================================================================
--- cms/trunk/themes/viperal/template/modules/articles/print.html	2005-09-16 19:22:36 UTC (rev 128)
+++ cms/trunk/themes/viperal/template/modules/articles/print.html	2005-09-16 19:56:44 UTC (rev 129)
@@ -0,0 +1,26 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: News</title>
+<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
+</head>
+
+<body>
+	<div class="articles_block">
+		<div class="title">{ $ARTICLES_TITLE }</div>
+			<div class="content">
+				{ $ARTICLES_TEXT }
+			<br /><br /><hr />
+			<div style="text-align: left; margin-left: 60%">Posted: { $ARTICLES_TIME }<br/>
+				<!-- IF { $ARTICLES_POSTER_LINK } -->By: <a href="{ $ARTICLES_POSTER_LINK }">{ $ARTICLES_POSTER } </a><!-- ELSE -->By: { $ARTICLES_POSTER }<!-- ENDIF -->
+			</div>
+		</div>
+		<br />
+		<div style="text-align: center;">
+			<a href="#" onclick="javascript:window.print(); return false" title="Print">{ $L_PRINT }</a><br/>
+			<a href='javascript:window.close();'><span class="small"> { $L_CLOSE_WINDOW }</a>
+		</div>
+	</div>
+</body>
+</html>
\ No newline at end of file

Added: cms/trunk/themes/viperal/template/modules/articles/view.html
===================================================================
--- cms/trunk/themes/viperal/template/modules/articles/view.html	2005-09-16 19:22:36 UTC (rev 128)
+++ cms/trunk/themes/viperal/template/modules/articles/view.html	2005-09-16 19:56:44 UTC (rev 129)
@@ -0,0 +1,19 @@
+<!-- DISPLAY_HEADER -->
+
+<div class="articles_block">
+	<div class="title" onclick="blockswitch2('{ $ARTICLES_ID }');" style="cursor:pointer">{ $ARTICLES_TITLE }</div>
+		<div class="content">
+			{ $ARTICLES_TEXT }
+			<br /><br />
+		<hr />
+		<div style="float: left; Top: -2.5em;">
+			<a onclick="window.open('{ $ARTICLES_LINK_PRINT }', 'print{ $ARTICLES_ID }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600,height=400'); return false;" href="{ $ARTICLES_LINK_PRINT }" ><img src="themes/viperal/images/print.png" alt="" /></a>
+			<a onclick="window.open('{ $ARTICLES_LINK_SEND }', 'send{ $ARTICLES_ID }', 'status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=no,width=600'); return false;" href="{ $ARTICLES_LINK_SEND }" ><img src="themes/viperal/images/mail.png" alt="" /></a>
+		</div>
+		 <div style="text-align: left; margin-left: 60%">Posted: { $ARTICLES_TIME }<br/>
+		 <!-- IF { $ARTICLES_POSTER_LINK } -->By: <a href="{ $ARTICLES_POSTER_LINK }">{ $ARTICLES_POSTER } </a><!-- ELSE -->By: { $ARTICLES_POSTER } <!-- ENDIF --></div></div>
+		<br />
+	</div>
+<br />
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file



From viperal at berlios.de  Sat Sep 17 18:14:56 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sat, 17 Sep 2005 18:14:56 +0200
Subject: [Viperals-svncheckins] r130 - in cms/trunk: . includes includes/cache includes/display includes/templates includes/templates/en includes/templates/en/email includes/templates/en/email/contact includes/templates/modules/Contact javascript language/en
Message-ID: <200509171614.j8HGEu8u028473@sheep.berlios.de>

Author: viperal
Date: 2005-09-17 18:14:54 +0200 (Sat, 17 Sep 2005)
New Revision: 130

Added:
   cms/trunk/includes/templates/en/
   cms/trunk/includes/templates/en/email/
   cms/trunk/includes/templates/en/email/contact/
   cms/trunk/includes/templates/en/email/contact/index.html
Removed:
   cms/trunk/includes/templates/modules/Contact/email/
   cms/trunk/language/en/admin/
Modified:
   cms/trunk/admin.php
   cms/trunk/ajax.php
   cms/trunk/core.php
   cms/trunk/error.php
   cms/trunk/feed.php
   cms/trunk/includes/cache/cache_file.php
   cms/trunk/includes/display/blocks.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/handler.php
   cms/trunk/includes/mailer.php
   cms/trunk/includes/session.php
   cms/trunk/includes/system.php
   cms/trunk/includes/templates/login_admin.html
   cms/trunk/includes/templates/login_body_full.html
   cms/trunk/includes/templates/message.html
   cms/trunk/includes/user.php
   cms/trunk/index.php
   cms/trunk/installer.php
   cms/trunk/javascript/quick_messages.js
Log:
start changin $site_file_root to a define.
Other fixes

Modified: cms/trunk/admin.php
===================================================================
--- cms/trunk/admin.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/admin.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -15,13 +15,10 @@
 define('VIPERAL', 'Admin');
 //define('NEED_SID', true);
 
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
+require('core.php');
 
-require($site_file_root.'core.php');
-
 $_CLASS['core_user']->user_setup(null);
-$_CLASS['core_display']->load_theme('viperal_admin', $site_file_root.'themes_admin/viperal_admin');
+$_CLASS['core_display']->load_theme('viperal_admin', SITE_FILE_ROOT.'themes_admin/viperal_admin');
 
 $_CLASS['core_user']->add_lang('admin/common.php');
 
@@ -62,17 +59,17 @@
 if (!$mod || !$_CORE_MODULE)
 {
 	$_CORE_MODULE = array('module_title' => '', 'module_name' => '');
-	$file_path = $site_file_root.'admin/index.php';
+	$file_path = SITE_FILE_ROOT.'admin/index.php';
 }
 else
 {
-	if (file_exists($site_file_root.'admin/'.$_CORE_MODULE['module_name'].'.php'))
+	if (file_exists(SITE_FILE_ROOT.'admin/'.$_CORE_MODULE['module_name'].'.php'))
 	{
-		$file_path = $site_file_root.'admin/'.$_CORE_MODULE['module_name'].'.php';
+		$file_path = SITE_FILE_ROOT.'admin/'.$_CORE_MODULE['module_name'].'.php';
 	}
 	else
 	{
-		$file_path = (file_exists($site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php')) ? $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php' : false;
+		$file_path = (file_exists(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php')) ? SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/admin/index.php' : false;
 	}
 }
 
@@ -92,7 +89,7 @@
 $_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['module_title'];
 $_CORE_MODULE['module_sides'] = BLOCK_ALL;
 	
-require($site_file_root.'admin/menu.php');
+require(SITE_FILE_ROOT.'admin/menu.php');
 
 $main_menu = build_menu($menu);
 
@@ -105,7 +102,7 @@
 ));
 
 
-//load_class($site_file_root.'includes/core_editor.php', 'core_editor');
+//load_class(SITE_FILE_ROOT.'includes/core_editor.php', 'core_editor');
 //$_CLASS['core_editor']->setup();
 require($file_path);
     

Modified: cms/trunk/ajax.php
===================================================================
--- cms/trunk/ajax.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/ajax.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -19,11 +19,9 @@
 	die;
 }
 
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
+//require(SITE_FILE_ROOT.'core.php');
+require('core.php');
 
-require($site_file_root.'core.php');
-
 $mod = get_variable('mod', 'REQUEST', false);
 
 if (!$mod)
@@ -32,22 +30,6 @@
 }
 else
 {
-	/*
-	if ($mod === 'system')
-	{
-		include_once($site_file_root.'includes/system.php');
-
-		$mode = get_variable('mode', 'REQUEST', false);
-		if (!$mode || !function_exists($mode))
-		{
-			script_close(false);
-		}
-
-		$mode();
-		script_close(false);
-	}
-	*/
-
 	$sql = 'SELECT * FROM '.CORE_MODULES_TABLE.'
 				WHERE module_type = ' . MODULE_NORMAL . "
 				AND module_name = '" . $_CLASS['core_db']->escape($mod) . "'";
@@ -68,7 +50,7 @@
 	$_CORE_MODULE = $_CLASS['core_display']->get_module();
 }
 
-$path = $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/ajax.php';
+$path = SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/ajax.php';
 $_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
 
 require_once($path);

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/core.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -26,6 +26,7 @@
     die;
 }
 
+//ini_set('display_errors', 1);
 set_magic_quotes_runtime(0);
 
 //Error reporting tyoe
@@ -44,15 +45,17 @@
 	}
 }
 
-//change $site_file_root to a defined
-if (!$site_file_root)
+if (!defined('SITE_FILE_ROOT'))
 {
-	$site_file_root = str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/';
+	define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 }
 
+// TEMP
+$site_file_root = SITE_FILE_ROOT;
+
 if (!extension_loaded('mbstring'))
 {
-	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+	require_once(SITE_FILE_ROOT.'includes/compatiblity/mbstring.php');
 }
 
 mb_internal_encoding('UTF-8');
@@ -73,10 +76,10 @@
 	}
 }
 
-require_once($site_file_root.'includes/display/template.php');
-require_once($site_file_root.'includes/functions.php');
-require_once($site_file_root.'includes/handler.php');
-require_once($site_file_root.'config.php');
+require_once(SITE_FILE_ROOT.'includes/display/template.php');
+require_once(SITE_FILE_ROOT.'includes/functions.php');
+require_once(SITE_FILE_ROOT.'includes/handler.php');
+require_once(SITE_FILE_ROOT.'config.php');
 
 // Load basic classes
 load_class(false, 'core_template');
@@ -98,10 +101,10 @@
 	trigger_error('503:<p style="text-align:center">Site isn\'t Installed<br/><a href="installer.php">Click here to install</a></p>', E_USER_ERROR);
 }
 
-require_once($site_file_root.'includes/tables.php');
-require_once($site_file_root.'includes/db/'.$site_db['type'].'.php');
-require_once($site_file_root.'includes/cache/cache.php');
-require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+require_once(SITE_FILE_ROOT.'includes/tables.php');
+require_once(SITE_FILE_ROOT.'includes/db/'.$site_db['type'].'.php');
+require_once(SITE_FILE_ROOT.'includes/cache/cache.php');
+require_once(SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php');
 
 load_class(false, 'core_cache', 'cache_'.$acm_type);
 load_class(false, 'core_db', 'db_'.$site_db['type']);
@@ -171,6 +174,7 @@
 	$_CLASS['core_db']->free_result($result);
 }
 
+$_CORE_CONFIG['email']['site_mail'] = 'viperal1 at gmail.com';
 $_CLASS['core_db']->report_error(true);
 unset($config_error);
 
@@ -192,12 +196,12 @@
 }
 
 // Load user based classes, and display options
-require($site_file_root.'includes/session.php');
-require($site_file_root.'includes/user.php');
-require($site_file_root.'includes/auth/auth.php');
-require($site_file_root.'includes/auth/auth_db.php');
-require($site_file_root.'includes/display/blocks.php');
-require($site_file_root.'includes/display/display.php');
+require(SITE_FILE_ROOT.'includes/session.php');
+require(SITE_FILE_ROOT.'includes/user.php');
+require(SITE_FILE_ROOT.'includes/auth/auth.php');
+require(SITE_FILE_ROOT.'includes/auth/auth_db.php');
+require(SITE_FILE_ROOT.'includes/display/blocks.php');
+require(SITE_FILE_ROOT.'includes/display/display.php');
 
 load_class(false, 'core_display');
 load_class(false, 'core_blocks');

Modified: cms/trunk/error.php
===================================================================
--- cms/trunk/error.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/error.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -1,17 +1,26 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 define('VIPERAL', 'CMS');
 
 error_reporting(0);
@@ -21,8 +30,8 @@
 	ob_start('ob_gzhandler');
 }
 
-//echo str_replace('\\','/', getenv('DOCUMENT_ROOT')); die;
-$site_file_root = '';
+define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
+
 $lang = 'en';
 
 if (isset($_SERVER['HTTP_ACCEPT_LANGUAGE']))
@@ -31,14 +40,14 @@
 	foreach ($accept_lang_array as $accept_lang)
 	{
 		$accept_lang = substr($accept_lang, 0, 2);
-		if (file_exists($site_file_root.'language/' . $accept_lang . '/error.php'))
+		if (file_exists(SITE_FILE_ROOT.'language/' . $accept_lang . '/error.php'))
 		{
 			$lang = $accept_lang;
 			break;
 		}
 		
 		$accept_lang = substr($accept_lang, 0, 2) . '_' . strtoupper(substr($accept_lang, 3, 2));
-		if (file_exists($site_file_root.'language/' . $accept_lang . '/error.php'))
+		if (file_exists(SITE_FILE_ROOT.'language/' . $accept_lang . '/error.php'))
 		{
 			$lang = $accept_lang;
 			break;
@@ -46,8 +55,8 @@
 	}
 }
 
-require($site_file_root.'language/' . $lang . '/error.php');
-require($site_file_root.'includes/display/template.php');
+require(SITE_FILE_ROOT.'language/' . $lang . '/error.php');
+require(SITE_FILE_ROOT.'includes/display/template.php');
 
 $_CLASS['core_template'] =& new core_template();
 

Modified: cms/trunk/feed.php
===================================================================
--- cms/trunk/feed.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/feed.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -23,20 +23,26 @@
 
 define('VIPERAL', 'FEED');
 
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
+error_reporting(0);
 
-require($site_file_root.'core.php');
+//require(SITE_FILE_ROOT.'core.php');
+require('core.php');
 
-//error_reporting(0);
 header('Content-Type: text/xml');
 
 if (!defined('ARTICLES_TABLE'))
 {
-	define('ARTICLES_TABLE', $table_prefix.'articles');
+	define('ARTICLES_TABLE', $prefix.'articles');
 }
 
-$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+if (isset($_GET['mode']) && $_GET['mode'] == 'cms')
+{
+	$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 3);
+}
+else
+{
+	$result = $_CLASS['core_db']->query_limit('SELECT articles_id, articles_title, articles_intro, articles_text, articles_posted, articles_starts, poster_name FROM ' . ARTICLES_TABLE . ' ORDER BY articles_order ASC', 10);
+}
 
 $last_post_time = 0;
 

Modified: cms/trunk/includes/cache/cache_file.php
===================================================================
--- cms/trunk/includes/cache/cache_file.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/cache/cache_file.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -26,10 +26,8 @@
 
 	function cache_file()
 	{
-		global $site_file_root;
+		$this->cache_dir = SITE_FILE_ROOT.'cache/';
 
-		$this->cache_dir = $site_file_root.'cache/';
-
 		if (!is_writable($this->cache_dir))
 		{
 			//error here

Modified: cms/trunk/includes/display/blocks.php
===================================================================
--- cms/trunk/includes/display/blocks.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/display/blocks.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -144,9 +144,12 @@
 		global $_CLASS;
 
 		$this->content = '';
+		$count = count($this->blocks_array[$position]);
+		
+		for ($i = 0; $i < $count; $i++)
+		{
+			$this->block =& $this->blocks_array[$position][$i];
 
-		foreach($this->blocks_array[$position] as $this->block)
-		{
 			if ($this->block['block_auth'] && !$_CLASS['core_auth']->auth($this->block['block_auth']) && !$_CLASS['core_auth']->admin_power('blocks'))
 			{
 				continue;
@@ -217,15 +220,15 @@
 	*/
 	function block_file()
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/'.$this->block['block_file']))
+		if ($this->block['block_file'] && file_exists(SITE_FILE_ROOT.'blocks/'.$this->block['block_file']))
 		{
 			$this->info = false;
 
 			//$_CLASS['core_error_handler']->debug_start($this->block['block_title']);
 
-			include($site_file_root.'blocks/'.$this->block['block_file']);
+			include(SITE_FILE_ROOT.'blocks/'.$this->block['block_file']);
 
 			//$_CLASS['core_error_handler']->debug_stop($this->block['block_title']);
 
@@ -330,7 +333,7 @@
 
 	function block_feed()
 	{
-		global $site_file_root, $_CLASS;
+		global $_CLASS;
 // think about disabling the block automatically if there's url problems
 // update core_rss file
 		if ($this->block['block_content'] && (!$this->block['block_rss_expires'] || $this->block['block_rss_expires'] > (int) $_CLASS['core_user']->time))
@@ -349,9 +352,9 @@
 			return;
 		}
 
-		if ($this->block['block_file'] && file_exists($site_file_root.'blocks/rss/'.$this->block['block_file']))
+		if ($this->block['block_file'] && file_exists(SITE_FILE_ROOT.'blocks/rss/'.$this->block['block_file']))
 		{
-			include($site_file_root.'blocks/rss/'.$this->block['block_file']);
+			include(SITE_FILE_ROOT.'blocks/rss/'.$this->block['block_file']);
 			
 			if (!$this->content)
 			{
@@ -360,7 +363,7 @@
 		}
 		else
 		{
-			load_class($site_file_root.'includes/core_rss.php', 'core_rss');
+			load_class(SITE_FILE_ROOT.'includes/core_rss.php', 'core_rss');
 			$_CLASS['core_rss']->setup(false, array('title', 'link'));
 				
 			if (!$_CLASS['core_rss']->get_rss($this->block['block_rss_url']))

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/display/display.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -38,9 +38,9 @@
 	*/
 	function add_module($module, $homepage = true)
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
-		if (!$module || !file_exists($site_file_root.'modules/'.$module['module_name'].'/index.php'))
+		if (!$module || !file_exists(SITE_FILE_ROOT.'modules/'.$module['module_name'].'/index.php'))
 		{
 			return '404:_PAGE_NOT_FOUND';
 		}
@@ -218,9 +218,7 @@
 
 		if ($_CORE_MODULE = $this->get_module())
 		{
-			global $site_file_root;
-
-			require($site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
+			require(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php');
 		}
 
 		$this->displayed['footer'] = true;

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/display/template.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -41,8 +41,7 @@
 
     function core_template()
     {
-		global $site_file_root;
-		$this->cache_dir = $site_file_root.'cache/template/';
+		$this->cache_dir = SITE_FILE_ROOT.'cache/template/';
     }
     
     /*
@@ -160,23 +159,56 @@
     */
 	function generate_dirs($name)
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
 		$set = false;
+		$lang = array();
 
-		if (!empty($_CLASS['core_display']->theme_path) && file_exists($_CLASS['core_display']->theme_path.'/template/'.$name))
+		$lang[] = 'en';
+		
+		if (isset($_CLASS['core_user']) && $_CLASS['core_user']->lang_name !== 'en')
 		{
-			$this->template_dir = $_CLASS['core_display']->theme_path.'/template/';
-			$this->theme_themplate = true;
-			$set = true;
+			$lang[] = $this->lang_name;
 		}
-		elseif (file_exists($site_file_root.'includes/templates/'.$name))
+
+		$count = count($lang);
+
+		for ($i = 0; $i < $count; $i++)
 		{
-			$this->template_dir = $site_file_root.'includes/templates/';
-			$this->theme_themplate = false;
-			$set = true;
+			if (!empty($_CLASS['core_display']->theme_path) && file_exists($_CLASS['core_display']->theme_path."/template/{$lang[$i]}/$name"))
+			{
+				$this->template_dir = $_CLASS['core_display']->theme_path."/template/{$lang[$i]}/";
+				$this->cache_prefix = "{$_CLASS['core_display']->theme_name}#{$lang[$i]}#";
+				$set = true;
+
+				break;
+			}
+			elseif (file_exists(SITE_FILE_ROOT."includes/templates/{$lang[$i]}/$name"))
+			{
+				$this->template_dir = SITE_FILE_ROOT."includes/templates/{$lang[$i]}/";
+				$this->cache_prefix = "core#{$lang[$i]}#";
+				$set = true;
+				
+				break;
+			}
 		}
-		
+	
+		if (!$set)
+		{
+			if (!empty($_CLASS['core_display']->theme_path) && file_exists($_CLASS['core_display']->theme_path.'/template/'.$name))
+			{
+				$this->template_dir = $_CLASS['core_display']->theme_path.'/template/';
+				$this->cache_prefix = $_CLASS['core_display']->theme_name.'#';
+				$set = true;
+			}
+			elseif (file_exists(SITE_FILE_ROOT.'includes/templates/'.$name))
+			{
+				$this->template_dir = SITE_FILE_ROOT.'includes/templates/';
+				$this->cache_prefix = "core#";
+				$set = true;
+			}
+		}
+
 		return $set;
 	}
 
@@ -186,7 +218,7 @@
 
 		$file_name = str_replace(array('.', '/'), '#', $name);
 
-		return ($this->theme_themplate ? $_CLASS['core_display']->theme_name.'#' : '') . "$file_name.php";
+		return $this->cache_prefix."$file_name.php";
 	}
 
     function is_compiled($name)
@@ -410,7 +442,7 @@
 	{
 		global $_CLASS;
 
-		return $_CLASS['core_user']->get_lang($lang);
+		return isset($_CLASS['core_user']) ? $_CLASS['core_user']->get_lang($lang) : $lang;
 	}
 
 	function _parse_content($code)
@@ -432,7 +464,7 @@
 				continue;
 			}
 			
-			$values[1][$loop] = '<?php echo '.$parse.'; ?>';
+			$values[1][$loop] = "<?php echo $parse; ?> ";
 		}
 	
 		return str_replace($values[0], $values[1], $code);

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/functions.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -195,13 +195,7 @@
 
 function check_theme($theme)
 {
-	global $site_file_root;
-
-	if (file_exists($site_file_root.'themes/'.$theme.'/index.php'))
-	{
-		return true;
-	}
-	return false;
+	return file_exists(SITE_FILE_ROOT.'themes/'.$theme.'/index.php');
 }
 
 function display_confirmation($message = '', $hidden = '', $image = false)
@@ -575,14 +569,14 @@
 
 function script_close($save = true)
 {
-	global $_CORE_CONFIG, $site_file_root, $_CLASS;
+	global $_CORE_CONFIG, $_CLASS;
 
 	if (!empty($_CLASS['core_user']))
 	{
 		// phpbb 2.1.2 only remove.
-		if (file_exists($site_file_root.'cache/queue.php'))
+		if (file_exists(SITE_FILE_ROOT.'cache/queue.php'))
 		{
-			require_once($site_file_root.'includes/forums/functions_messenger.php');
+			require_once(SITE_FILE_ROOT.'includes/forums/functions_messenger.php');
 			$queue = new queue();
 			$queue->process();
 		}
@@ -718,7 +712,7 @@
 
 function select_theme($default = false)
 {
-	global $site_file_root, $_CLASS;
+	global $_CLASS;
 
 	if (!$default)
 	{
@@ -726,13 +720,13 @@
 	}
 
 	$theme_array = array();
-	$handle = opendir($site_file_root.'themes');
+	$handle = opendir(SITE_FILE_ROOT.'themes');
 	
 	while ($file = readdir($handle))
 	{
 		if (!mb_strpos($file, '.'))
 		{
-			if (file_exists($site_file_root."themes/$file/index.php"))
+			if (file_exists(SITE_FILE_ROOT."themes/$file/index.php"))
 			{
 				$theme_array[] = array('file' => $file, 'template'=> true);
 			}

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/functions_user.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -662,7 +662,7 @@
 	}
 
 	return false;
- }
+}
 
 function avatar_remote($data, &$error)
 {
@@ -705,10 +705,10 @@
 
 function avatar_upload($data, &$error)
 {
-	global $site_file_root, $config, $_CLASS;
+	global $config, $_CLASS;
 
 	// Init upload class
-	include_once($site_file_root.'includes/forums/functions_upload.php');
+	include_once(SITE_FILE_ROOT.'includes/forums/functions_upload.php');
 	
 	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
 							

Modified: cms/trunk/includes/handler.php
===================================================================
--- cms/trunk/includes/handler.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/handler.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -143,7 +143,7 @@
 
 	function error_handler($errtype, $error, $errfile, $errline)
 	{
-		global $_CLASS, $site_file_root, $_CORE_CONFIG;
+		global $_CLASS, $_CORE_CONFIG;
 
 		if ($this->report != ERROR_NONE)
 		{
@@ -152,7 +152,7 @@
 			//damn windows
 			$errfile = str_replace('\\','/', $errfile);
 			// Remove the root paths, site files, along with document root
-			$errfile = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $errfile));
+			$errfile = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $errfile));
 		}
 
 		switch ($errtype)

Modified: cms/trunk/includes/mailer.php
===================================================================
--- cms/trunk/includes/mailer.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/mailer.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -95,7 +95,6 @@
 		foreach ($address as $array)
 		{
 			$array['name'] = trim($array['name']);
-//"=?UTF-8?B?VmlwZXJhbA==?="
 			$formatted[] = ($array['name'] && $this->named_addresses) ?  '"' . mail_encode($array['name'], $this->encoding) . '" <' . $array['address'] . '>' : $array['address'];
 		}
 		return implode(', ', $formatted);
@@ -121,7 +120,6 @@
 
 		if (!$from)
 		{
-			// modify_lines ?
 			$from = '<' . $_CORE_CONFIG['email']['site_mail'] . '>';
 		}
 
@@ -179,13 +177,12 @@
 		{
 			$headers[] = 'Content-Type: text/plain; charset='.$this->encoding;
 			$headers[] = 'Content-Transfer-Encoding: 8bit';
-			$message = "\n".strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message)))."\n";
+			$message = "\n".$this->message."\n";
 		}
 
 		if ($_CORE_CONFIG['email']['smtp'])
 		{
 			$smtp = new smtp_mailer;
-
 			if ($connect = $smtp->connect($_CORE_CONFIG['email']['smtp_host'], $_CORE_CONFIG['email']['smtp_port']))
 			{
 				$login = $smtp->login($_CORE_CONFIG['email']['smtp_username'], $_CORE_CONFIG['email']['smtp_password']);
@@ -217,12 +214,16 @@
 
 			if (!$result)
 			{
+				$this->error = 'Mail Send failed';
+
 				return false;
 			}
 			
 			return true;
 		}
 
+		$this->error = 'Mail Function not found';
+
 		return false;
 	}
 }
@@ -286,7 +287,6 @@
 	// If login fails we disconnect, may do it differently later on
 	function login($user, $password)
 	{
-		$user = ''; $password='';
 		if (!$this->connection)
 		{
 			$this->error = 'No connection';
@@ -370,7 +370,7 @@
 		foreach ($this->recipients as $email)
 		{
 			$name = false;
-			
+
 			if (is_array($email))
 			{
 				$name = $email['name'];

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/session.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -40,13 +40,9 @@
 		$session_id = get_variable($_CORE_CONFIG['server']['cookie_name'] . '_sid', 'COOKIE');
 		$session_id_url = get_variable('sid', 'GET');
 
-		if ($session_id_url)
+		if ($session_id_url && (!$session_id || $session_id !== $session_id_url))
 		{
-			// session id in url > cookie
-			if (!$session_id || $session_id !== $session_id_url)
-			{
-				$session_id = $session_id_url;
-			}
+			$session_id = $session_id_url;
 		}
 		elseif (!defined('NEED_SID'))
 		{

Modified: cms/trunk/includes/system.php
===================================================================
--- cms/trunk/includes/system.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/system.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -23,7 +23,7 @@
 
 function confirmation_image($code = false, $size = false)
 {
-	global $_CLASS, $site_file_root;
+	global $_CLASS;
 
 	if (!$code && !($code = $_CLASS['core_user']->session_data_get('confirmation_code')))
 	{
@@ -44,8 +44,9 @@
 	{
 		$image_width = 5;
 		$image_height = 0;
-		//$font = $site_file_root.'includes/fonts/angltrr.ttf';
-		$font = $site_file_root.'includes/fonts/tomnr.ttf';
+		
+		//$font = SITE_FILE_ROOT.'includes/fonts/angltrr.ttf';
+		$font = SITE_FILE_ROOT.'includes/fonts/tomnr.ttf';
 
 		$count = strlen($code);
 		for ($loop = 0; $loop < $count; $loop++)
@@ -104,7 +105,7 @@
 		return;
 	}
 
-	$font = imageloadfont($site_file_root.'includes/fonts/tomnr.gdf');
+	$font = imageloadfont(SITE_FILE_ROOT.'includes/fonts/tomnr.gdf');
 
 	// needs work
 	if (!$font)
@@ -201,7 +202,7 @@
 	}
 	else
 	{
-		include_once($site_file_root.'includes/functions_user.php');
+		include_once(SITE_FILE_ROOT.'includes/functions_user.php');
 		user_activate($user_id);
 
 		set_core_config('user', 'newest_user_id', $row['user_id'], false);

Added: cms/trunk/includes/templates/en/email/contact/index.html
===================================================================
--- cms/trunk/includes/templates/en/email/contact/index.html	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/templates/en/email/contact/index.html	2005-09-17 16:14:54 UTC (rev 130)
@@ -0,0 +1,6 @@
+{ $MESSAGE }
+
+Sent From:	{ $SENT_FROM }
+Name:		{ $SENDER_NAME }
+email:		{ $SENDER_EMAIL }
+Sender Ip:	{ $SENDER_IP }
\ No newline at end of file

Modified: cms/trunk/includes/templates/login_admin.html
===================================================================
--- cms/trunk/includes/templates/login_admin.html	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/templates/login_admin.html	2005-09-17 16:14:54 UTC (rev 130)
@@ -126,11 +126,11 @@
 					<td align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
 				</tr>
 				<tr>
-					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text"></td>
+					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text" tabindex="3" /></td>
 				</tr>
 				<!-- ENDIF -->
 				<tr> 
-					<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="3" /></td>
+					<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="4" /></td>
 				</tr>
 			</table>
 		</form>

Modified: cms/trunk/includes/templates/login_body_full.html
===================================================================
--- cms/trunk/includes/templates/login_body_full.html	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/templates/login_body_full.html	2005-09-17 16:14:54 UTC (rev 130)
@@ -1,13 +1,13 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-<title>Viperal: Login</title>
-<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
-<meta http-equiv="expires" content="0" />
-
-<style type="text/css">
-<!--
-body
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+<title>Viperal: Login</title>
+<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+<meta http-equiv="expires" content="0" />
+
+<style type="text/css">
+<!--
+body
 {
     font-family: Verdana, Helvetica, sans-serif;
     font-size: 10px;
@@ -19,38 +19,38 @@
 
 .error { color: red; }
 
-#container
-{
-	position: absolute;
-	top: 50%;
-	left: 0px;
-	width: 100%;
-	margin-top: <!-- IF { $U_CONFIRM_IMAGE } -->-160px<!-- ELSE -->-100px<!-- ENDIF -->;
+#container
+{
+	position: absolute;
+	top: 50%;
+	left: 0px;
+	width: 100%;
+	margin-top: <!-- IF { $U_CONFIRM_IMAGE } -->-160px<!-- ELSE -->-100px<!-- ENDIF -->;
 }
-
-#wrapper
-{
-	position: relative;
-	text-align: left;
-	width: 300px;
-	margin: 0px auto;
+
+#wrapper
+{
+	position: relative;
+	text-align: left;
+	width: 300px;
+	margin: 0px auto;
 }
 
 .spacer
 {
 	background-color: #ECECEC;
-}
-
+}
+
 .button
 {
 	background-color: #DCE1E5;
 	border: 1px solid #ccc;
 	color: black;
-}
+}
 
 th { height: 28px; color: #FFA34F; font-size: 110%; font-weight: bold; background-color: #006699;white-space: nowrap; }
 .tablebg { background-color: #A9B8C2; }
-
+
 .row1 { background-color: #ECECEC; padding: 4px; }
 .row2 { background-color: #DCE1E5; padding: 4px; }
 .row3 { background-color: #C0C8D0; padding: 4px; }
@@ -63,78 +63,78 @@
 form { margin: 0px; padding: 0px; border: 0px; }
 input { font-weight: normal; background-color: #FAFAFA; border-style: solid; border-width: 1px; border-color: #ccc; color: black; font-family: Verdana, serif; font-size: 100%; }
 select { color: black; background-color: white; font-family: Verdana, serif; font-size: 100%; font-weight: normal; border-color: black; border-style: solid; border-width: 1px; }
-.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
+.post { background-color: white; border-style: solid; border-width: 1px; border-color: #ccc;}
 
--->
-</style>
-
-<body>
-
-<div id="container">
-	<div id="wrapper">
-		<form action="{$S_LOGIN_ACTION}" method="post">
-			<table align="center" class="tablebg" width="100%" cellspacing="1">
-				<tr> 
-					<th align="center">Login Info</th>
-				</tr>
-				<!-- IF { $LOGIN_EXPLAIN } -->
-				<tr>
-					<td class="row1" colspan="2" align="center"><span class="gensmall">{ $LOGIN_EXPLAIN }</td>
-				</tr>
-				<!-- ENDIF -->
-				<tr> 
-					<td class="row2">
-					<table width="100%" cellspacing="1" cellpadding="4">
-						<!-- IF { $LOGIN_ERROR } -->
-						<tr>
-							<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
-						</tr>
-						<!-- ENDIF -->
-						<tr> 
-							<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
-							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
-						</tr>
-						<tr> 
-							<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
-							<td>
-								<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
-								<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
-								<!-- IF { $U_RESEND_ACTIVATION } --><br /><a class="gensmall" href="{ $U_RESEND_ACTIVATION }">{ $L_RESEND_ACTIVATION }</a><!-- ENDIF -->
-							 </td>
-						</tr>
-						<!-- IF { $S_DISPLAY_FULL_LOGIN } -->
-						<tr> 
-							<td>&nbsp;</td>
-							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{$L_LOG_ME_IN}</span></td>
-						</tr>
-						<tr>
-							<td>&nbsp;</td>
-							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{$L_HIDE_ME}</span></td>
-						</tr>
-						<!-- ENDIF -->
-					</table>
-					</td>
-				</tr>
-				<!-- IF { $U_CONFIRM_IMAGE } -->
-				<tr> 
-					<th  align="center">{ $L_CONFIRMATION_CODE }</th>
-				</tr>
-				<tr> 
-					<td align="center" class="row1"><span class="gensmall">Enter the code exactly as you see it in the image<br/><b>This is case sensitive</b></span></td>
-				</tr>
-				<tr>
-					<td align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
-				</tr>
-				<tr>
-					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text"></td>
-				</tr>
-				<!-- ENDIF -->
-				<tr> 
-					<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="3" /></td>
-				</tr>
-			</table>
-		</form>
-	</div>
-</div>
-
+-->
+</style>
+
+<body>
+
+<div id="container">
+	<div id="wrapper">
+		<form action="{$S_LOGIN_ACTION}" method="post">
+			<table align="center" class="tablebg" width="100%" cellspacing="1">
+				<tr> 
+					<th align="center">Login Info</th>
+				</tr>
+				<!-- IF { $LOGIN_EXPLAIN } -->
+				<tr>
+					<td class="row1" colspan="2" align="center"><span class="gensmall">{ $LOGIN_EXPLAIN }</td>
+				</tr>
+				<!-- ENDIF -->
+				<tr> 
+					<td class="row2">
+					<table width="100%" cellspacing="1" cellpadding="4">
+						<!-- IF { $LOGIN_ERROR } -->
+						<tr>
+							<td class="gensmall" colspan="2" align="center"><span class="error">{$LOGIN_ERROR}</span></td>
+						</tr>
+						<!-- ENDIF -->
+						<tr> 
+							<td valign="top"><b class="gensmall">{$L_USERNAME}:</b></td>
+							<td><input class="post" type="text" name="username" size="25" maxlength="40" value="{$USERNAME}" tabindex="1" /><br /><a class="gensmall" href="{$U_REGISTER}">{$L_REGISTER}</a></td>
+						</tr>
+						<tr> 
+							<td valign="top"><b class="gensmall">{$L_PASSWORD}:</b></td>
+							<td>
+								<input class="post" type="password" name="password" size="25" maxlength="25" tabindex="2" />
+								<!-- IF { $U_SEND_PASSWORD } --><br /><a class="gensmall" href="{ $U_SEND_PASSWORD }">{ $L_FORGOT_PASS }</a><!-- ENDIF -->
+								<!-- IF { $U_RESEND_ACTIVATION } --><br /><a class="gensmall" href="{ $U_RESEND_ACTIVATION }">{ $L_RESEND_ACTIVATION }</a><!-- ENDIF -->
+							 </td>
+						</tr>
+						<!-- IF { $S_DISPLAY_FULL_LOGIN } -->
+						<tr> 
+							<td>&nbsp;</td>
+							<td><input type="checkbox" name="autologin" tabindex="4" /> <span class="gensmall">{$L_LOG_ME_IN}</span></td>
+						</tr>
+						<tr>
+							<td>&nbsp;</td>
+							<td><input type="checkbox" name="viewonline" tabindex="5" /> <span class="gensmall">{$L_HIDE_ME}</span></td>
+						</tr>
+						<!-- ENDIF -->
+					</table>
+					</td>
+				</tr>
+				<!-- IF { $U_CONFIRM_IMAGE } -->
+				<tr> 
+					<th  align="center">{ $L_CONFIRMATION_CODE }</th>
+				</tr>
+				<tr> 
+					<td align="center" class="row1"><span class="gensmall">Enter the code exactly as you see it in the image<br/><b>This is case sensitive</b></span></td>
+				</tr>
+				<tr>
+					<td align="center" class="row2">{ $U_CONFIRM_IMAGE }</td>
+				</tr>
+				<tr>
+					<td align="center" class="row1"><input class="post" name="confirm_code" size="10" maxlength="6" type="text" tabindex="3" /></td>
+				</tr>
+				<!-- ENDIF -->
+				<tr> 
+					<th colspan="2" align="center">{$S_HIDDEN_FIELDS}<input type="submit" name="login" class="button" value="{$L_LOGIN}" tabindex="4" /></td>
+				</tr>
+			</table>
+		</form>
+	</div>
+</div>
+
 </body>
\ No newline at end of file

Modified: cms/trunk/includes/templates/message.html
===================================================================
--- cms/trunk/includes/templates/message.html	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/templates/message.html	2005-09-17 16:14:54 UTC (rev 130)
@@ -2,10 +2,12 @@
 
 <table class="tablebg" width="100%" cellspacing="1" cellpadding="4">
 	<tr>
-		<td align="center"  class="row1">
+		<td align="center" class="row1">
 			{ $MESSAGE_TEXT }
 		</td>
 	</tr>
 </table>
+
+<br clear="all" />
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/includes/user.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -187,11 +187,18 @@
 		$this->data['session_time'] = $this->data['session_admin'] = 0;
 
 		$this->sid_link = $this->is_user = $this->is_bot = $this->is_admin = false;
+
+		if (isset($_CLASS['core_auth']))
+		{
+			unset($_CLASS['core_auth']);
+		}
+
+		load_class(false, 'core_auth', 'auth_db');
 	}
 
 	function user_setup($theme = false)
 	{
-		global $_CLASS, $_CORE_CONFIG, $site_file_root;
+		global $_CLASS, $_CORE_CONFIG;
 
 		if ($this->user_setup)
 		{
@@ -250,13 +257,13 @@
 				}
 			}
 
-			$path = $site_file_root.'themes/'.$theme;
+			$path = SITE_FILE_ROOT.'themes/'.$theme;
 			
 			$_CLASS['core_display']->load_theme($theme, $path);
 		}
 
 		$this->lang_name = $_CORE_CONFIG['global']['default_lang'];
-		$this->lang_path = $site_file_root.'language/' . $this->lang_name . '/';
+		$this->lang_path = SITE_FILE_ROOT.'language/' . $this->lang_name . '/';
 
 		$this->time_format = ($this->data['user_time_format']) ? $this->data['user_time_format'] : $_CORE_CONFIG['global']['default_dateformat'];
 		$this->timezone = ($this->data['user_timezone']) ? $this->data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
@@ -266,8 +273,6 @@
 
 	function add_img($img_file = false, $module = false, $lang = false)
 	{
-		global $site_file_root;
-
 		$img_file = ($img_file) ? "$img_file.php" : 'index.php';
 
 		if (!$img_file || !ereg('/', $img_file))
@@ -283,7 +288,7 @@
 			}
 			else
 			{
-				include($site_file_root.'modules/'.$module."/images/$img_file");
+				include(SITE_FILE_ROOT.'modules/'.$module."/images/$img_file");
 			}
 		}
 		else
@@ -324,7 +329,6 @@
 		
 	function add_lang($lang_file = false, $module = false)
 	{
-		global $site_file_root;
 //Need a check for if the lang file exsists
 	
 		//print_r(debug_backtrace());
@@ -343,7 +347,7 @@
 		{
 			if (mb_strpos($lang_file, '/') !== false)
 			{
-				include($site_file_root."language/$this->lang_name/$lang_file");
+				include(SITE_FILE_ROOT."language/$this->lang_name/$lang_file");
 
 				return;
 			}
@@ -359,12 +363,12 @@
 		{
 			global $_CORE_MODULE;
 			
-			include($site_file_root.'modules/'.$_CORE_MODULE['module_name']."/language/$this->lang_name/$lang_file");
+			include(SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name']."/language/$this->lang_name/$lang_file");
 
 			return;
 		}
 		
-		include($site_file_root."modules/$module/language/$this->lang_name/$lang_file");		
+		include(SITE_FILE_ROOT."modules/$module/language/$this->lang_name/$lang_file");		
 	}
 
 	function user_data_get($name, $default = false)

Modified: cms/trunk/index.php
===================================================================
--- cms/trunk/index.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/index.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -1,24 +1,32 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal?	)								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 define('VIPERAL', 'CMS');
-//print_r($_GET);
 
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
+error_reporting(E_ALL);
 
-require($site_file_root.'core.php');
+//require(SITE_FILE_ROOT.'core.php');
+require('core.php');
 
 $mod = get_variable('mod', 'REQUEST', false);
 
@@ -26,9 +34,10 @@
 {
 	// Set as homepage 
 	$_CLASS['core_display']->homepage = true;
-	//$_CORE_CONFIG['index_page'];
-	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name IN ( 'Contact' )");
+	$_CORE_CONFIG['global']['index_page'] = 'articles';
 
+	$result = $_CLASS['core_db']->query('SELECT * FROM '.CORE_MODULES_TABLE." WHERE module_name = '{$_CORE_CONFIG['global']['index_page']}'");
+
 	While ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$_CLASS['core_display']->add_module($row);
@@ -43,6 +52,7 @@
 
 		$_CLASS['core_user']->user_setup();
 		$_CLASS['core_display']->display_header();
+
 		// Hey admin we don't have a modules set
 		if ($_CLASS['core_auth']->admin_auth('modules'))
 		{
@@ -54,17 +64,20 @@
 }
 else
 {
-	if ($mod == 'system')
+	if ($mod === 'system')
 	{
-		include_once($site_file_root.'includes/system.php');
+		require_once(SITE_FILE_ROOT.'includes/system.php');
 
 		$mode = get_variable('mode', 'REQUEST', false);
+
 		if (!$mode || !function_exists($mode))
 		{
+			header("HTTP/1.0 503 Service Unavailable");
 			script_close(false);
 		}
 
 		$mode();
+
 		script_close(false);
 	}
 
@@ -87,7 +100,7 @@
 	$_CORE_MODULE = $_CLASS['core_display']->get_module();
 }
 
-$path = $site_file_root.'modules/'.$_CORE_MODULE['module_name'].'/index.php';
+$path = SITE_FILE_ROOT.'modules/'.$_CORE_MODULE['module_name'].'/index.php';
 $_CLASS['core_user']->page = $_CORE_MODULE['module_name'];
 
 require_once($path);

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/installer.php	2005-09-17 16:14:54 UTC (rev 130)
@@ -24,12 +24,11 @@
 
 error_reporting(E_ALL);
 
-//echo str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/'; die;
-$site_file_root = '';
+define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 
 if (!extension_loaded('mbstring'))
 {
-	require_once($site_file_root.'includes/compatiblity/mbstring.php');
+	require_once(SITE_FILE_ROOT.'includes/compatiblity/mbstring.php');
 }
 
 set_magic_quotes_runtime(0);
@@ -46,8 +45,8 @@
 	}
 }
 
-require_once($site_file_root.'includes/functions.php');
-require_once($site_file_root.'includes/display/template.php');
+require_once(SITE_FILE_ROOT.'includes/functions.php');
+require_once(SITE_FILE_ROOT.'includes/display/template.php');
 
 load_class(false, 'core_template');
 
@@ -107,9 +106,9 @@
 
 if ($stage === 4)
 {
-	if (file_exists($site_file_root.'config.php'))
+	if (file_exists(SITE_FILE_ROOT.'config.php'))
 	{
-		require_once($site_file_root.'config.php');
+		require_once(SITE_FILE_ROOT.'config.php');
 	}
 
 	$site_name		= get_variable('site_name', 'POST');
@@ -154,7 +153,7 @@
 
 	if (isset($site_db))
 	{
-		load_class($site_file_root.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
+		load_class(SITE_FILE_ROOT.'includes/db/'.$site_db['type'].'.php', 'core_db', 'db_'.$site_db['type']);
 
 		$_CLASS['core_db']->connect($site_db);
 		$config_content = '';
@@ -167,9 +166,9 @@
 
 	if (empty($error))
 	{
-		require_once($site_file_root.'includes/tables.php');
-		require_once($site_file_root.'includes/cache/cache.php');
-		require_once($site_file_root.'includes/cache/cache_' . $acm_type . '.php');
+		require_once(SITE_FILE_ROOT.'includes/tables.php');
+		require_once(SITE_FILE_ROOT.'includes/cache/cache.php');
+		require_once(SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php');
 
 		load_class(false, 'core_cache', 'cache_'.$acm_type);
 
@@ -229,7 +228,7 @@
 {
 	if ($db_layer && in_array($db_layer, array_keys($database_array)))
 	{
-		load_class($site_file_root.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
+		load_class(SITE_FILE_ROOT.'includes/db/'.$db_layer.'.php', 'core_db', 'db_'.$db_layer);
 
 		$site_db = array();
 		$site_db['type']		= $db_layer;
@@ -319,7 +318,7 @@
 		$user_prefix	= get_variable('user_prefix', 'POST');
 		$table_prefix	= get_variable('table_prefix', 'POST');
 		
-		require_once($site_file_root.'includes/tables.php');
+		require_once(SITE_FILE_ROOT.'includes/tables.php');
 	
 		$sql = 'SELECT * FROM ' . CORE_CONFIG_TABLE;
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -338,11 +337,11 @@
 	else
 	{
 		$_CLASS['core_db']->transaction();
-		require($site_file_root.'install/build_tables.php');
+		require(SITE_FILE_ROOT.'install/build_tables.php');
 		$_CLASS['core_db']->transaction('commit');
 	
 		$_CLASS['core_db']->transaction();
-		require($site_file_root.'install/build_data.php');
+		require(SITE_FILE_ROOT.'install/build_data.php');
 		$_CLASS['core_db']->transaction('commit');
 		
 		$_CLASS['core_db']->optimize_tables();
@@ -384,7 +383,7 @@
 			$config_data .= "if (!defined('ADMIN_PAGE'))\n{\n\tdefine('ADMIN_PAGE', 'admin.php');\n}\n\n";
 			$config_data .= '?>';
 
-			if (file_put_contents($site_file_root.'config.php', $config_data))
+			if (file_put_contents(SITE_FILE_ROOT.'config.php', $config_data))
 			{
 				$config_data = false;
 			}

Modified: cms/trunk/javascript/quick_messages.js
===================================================================
--- cms/trunk/javascript/quick_messages.js	2005-09-16 19:56:44 UTC (rev 129)
+++ cms/trunk/javascript/quick_messages.js	2005-09-17 16:14:54 UTC (rev 130)
@@ -27,7 +27,7 @@
 
 	poster_name = (poster_name) ? 'poster_name=' + poster_name.value : '';
 
-	ajax.send('index.php?mod=Quick_Message&mode=ajax_add', poster_name + '&message=' + message.value);
+	ajax.send('ajax.php?mod=Quick_Message&mode=ajax_add', poster_name + '&message=' + message.value);
 
 	return false;
 }
@@ -47,5 +47,5 @@
 
 	ajax.onreadystatechange(onreadystatechange);
 
-	ajax.send('index.php?mod=Quick_Message&mode=ajax_refresh', null);
+	ajax.send('ajax.php?mod=Quick_Message&mode=ajax_refresh', null);
 }
\ No newline at end of file



From viperal at berlios.de  Sun Sep 18 19:58:39 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Sun, 18 Sep 2005 19:58:39 +0200
Subject: [Viperals-svncheckins] r131 - in cms/trunk: blocks includes includes/auth includes/display includes/forums includes/templates/en/email includes/templates/en/email/contact includes/templates/en/email/core includes/templates/en/email/forums includes/templates/modules/Forums install modules/Control_Panel/ucp modules/Forums themes_admin/viperal_admin/template
Message-ID: <200509181758.j8IHwdV9021917@sheep.berlios.de>

Author: viperal
Date: 2005-09-18 19:58:38 +0200 (Sun, 18 Sep 2005)
New Revision: 131

Added:
   cms/trunk/includes/templates/en/email/contact/index.txt
   cms/trunk/includes/templates/en/email/core/
   cms/trunk/includes/templates/en/email/core/activation_active.txt
   cms/trunk/includes/templates/en/email/core/activation_admin_inactive.txt
   cms/trunk/includes/templates/en/email/core/activation_coppa_inactive.txt
   cms/trunk/includes/templates/en/email/core/activation_inactive.txt
   cms/trunk/includes/templates/en/email/forums/
   cms/trunk/includes/templates/en/email/forums/notify_forum.txt
   cms/trunk/includes/templates/en/email/forums/notify_newtopic.txt
   cms/trunk/includes/templates/en/email/forums/notify_topic.txt
Removed:
   cms/trunk/includes/templates/en/email/contact/index.html
Modified:
   cms/trunk/blocks/block-Admin_Forums.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_upload.php
   cms/trunk/includes/system.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/modules/Control_Panel/ucp/ucp_register.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Forums/viewtopic.php
   cms/trunk/themes_admin/viperal_admin/template/header.html
Log:
Added email templates for registration and topic post notification.
Almost complete topic attachments display
Other forums related fixes

Modified: cms/trunk/blocks/block-Admin_Forums.php
===================================================================
--- cms/trunk/blocks/block-Admin_Forums.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/blocks/block-Admin_Forums.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -18,7 +18,7 @@
 
 global $_CLASS;
 
-require($site_file_root.'includes/forums/admin/links.php');
+require(SITE_FILE_ROOT.'includes/forums/admin/links.php');
 
 $this->content .= '
 <table class="tablebg" width="100%" cellpadding="0" cellspacing="0" border="0">

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/auth/auth.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -44,15 +44,16 @@
 					FROM ' . USERS_TABLE . " WHERE username = '" . $_CLASS['core_db']->escape($user_name) . "'";
 
 		$result = $_CLASS['core_db']->query($sql);
-		$status = false;
 	
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if (encode_password($user_password, $row['user_password_encoding']) == $row['user_password'])
+			if (encode_password($user_password, $row['user_password_encoding']) === $row['user_password'])
 			{
-				if ($row['user_status'] != STATUS_ACTIVE)
+				settype($row['user_status'], 'int');
+
+				if ($row['user_status'] !== STATUS_ACTIVE)
 				{
-					$status =  ($row['user_status'] == STATUS_DISABLED) ? 'ACTIVE_ERROR' : 'UNACTIVATED_ERROR';
+					return ($row['user_status'] === STATUS_DISABLED) ? 'ACTIVE_ERROR' : 'UNACTIVATED_ERROR';
 				}
 
 				return (int) $row['user_id'];
@@ -60,8 +61,8 @@
 		}
 
 		$_CLASS['core_db']->free_result($result);
-		
-		return $status;
+
+		return false;
 	}
 
 	function admin_auth()

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/display/template.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -464,7 +464,7 @@
 				continue;
 			}
 			
-			$values[1][$loop] = "<?php echo $parse; ?> ";
+			$values[1][$loop] = "<?php echo $parse; ?>";
 		}
 	
 		return str_replace($values[0], $values[1], $code);

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/forums/auth.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -157,7 +157,7 @@
 		else
 		{
 			$acl |= $this->acl_get($opts, $f);
-		}		
+		}
 
 		return $acl;
 	}

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/forums/functions.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -184,7 +184,7 @@
 // Create forum rules for given forum 
 function generate_forum_rules(&$forum_data)
 {
-	global $_CLASS, $site_file_root;
+	global $_CLASS;
 	
 	if (!$forum_data['forum_rules'] && !$forum_data['forum_rules_link'])
 	{
@@ -194,7 +194,7 @@
 
 	if ($forum_data['forum_rules'])
 	{
-		require_once($site_file_root.'includes/forums/bbcode.php');
+		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$bbcode = new bbcode($forum_data['forum_rules_bbcode_bitfield']);
 		
 		$bbcode->bbcode_second_pass($forum_data['forum_rules'], $forum_data['forum_rules_bbcode_uid']);
@@ -337,8 +337,8 @@
 	$rules = array(
 		($_CLASS['auth']->acl_get('f_post', $forum_id)) ? $_CLASS['core_user']->lang['RULES_POST_CAN'] : $_CLASS['core_user']->lang['RULES_POST_CANNOT'],
 		($_CLASS['auth']->acl_get('f_reply', $forum_id)) ? $_CLASS['core_user']->lang['RULES_REPLY_CAN'] : $_CLASS['core_user']->lang['RULES_REPLY_CANNOT'],
-		($_CLASS['auth']->acl_gets('f_edit', 'm_edit', $forum_id)) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
-		($_CLASS['auth']->acl_gets('f_delete', 'm_delete', $forum_id)) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
+		($_CLASS['auth']->acl_gets(array('f_edit', 'm_edit'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
+		($_CLASS['auth']->acl_gets(array('f_delete', 'm_delete'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
 		($_CLASS['auth']->acl_get('f_attach', $forum_id) && $_CLASS['auth']->acl_get('u_attach', $forum_id)) ? $_CLASS['core_user']->lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']->lang['RULES_ATTACH_CANNOT']
 	);
 
@@ -545,9 +545,9 @@
 				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' '.$_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
 			}
 
-			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
-			//$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
-			//trigger_error($message);
+			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
+			trigger_error($message);
 		}
 	}
 	else
@@ -573,9 +573,9 @@
 				$_CLASS['core_db']->query($sql);
 			}
 
-			//$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
-			//$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
-			//trigger_error($message);
+			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
+			trigger_error($message);
 		}
 		else
 		{
@@ -875,7 +875,7 @@
 	{
 		// The rule is to only allow those extensions defined. ;)
 		$sql = 'SELECT e.extension, g.*
-			FROM ' . EXTENSIONS_TABLE . ' e, ' . EXTENSION_GROUPS_TABLE . ' g
+			FROM ' . FORUMS_EXTENSIONS_TABLE . ' e, ' . FORUMS_EXTENSION_GROUPS_TABLE . ' g
 			WHERE e.group_id = g.group_id
 				AND g.allow_group = 1';
 		$result = $_CLASS['core_db']->query($sql);
@@ -904,7 +904,7 @@
 
 		$_CLASS['core_cache']->put('extensions', $extensions);
 	}
-	
+
 	if ($forum_id !== false)
 	{
 		$return = array();

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -435,8 +435,7 @@
 {
 	global $config, $_CLASS;
 
-	$return_tpl = array();
-
+	$datas = array();
 	$extensions = obtain_attach_extensions();
 
 	foreach ($attachment_data as $attachment)
@@ -449,7 +448,7 @@
 		$data['lang_size'] = ($attachment['filesize'] >= 1048576) ? round((round($attachment['filesize'] / 1048576 * 100) / 100), 2) .$_CLASS['core_user']->lang['MB'] : (($attachment['filesize'] >= 1024) ? round((round($attachment['filesize'] / 1024 * 100) / 100), 2)  . $_CLASS['core_user']->lang['KB']: $attachment['filesize'] . $_CLASS['core_user']->lang['BYTES']);
 		$data['lang_views'] = (!$attachment['download_count']) ? $_CLASS['core_user']->lang['DOWNLOAD_NONE'] : (($attachment['download_count'] == 1) ? sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNT'], $attachment['download_count']) : sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNTS'], $attachment['download_count']));
 
-		$data['icon'] = ($extensions[$attachment['extension']]['upload_icon']) ? $config['upload_icons_path'] . '/' . trim($extensions[$attachment['extension']]['upload_icon']) : false;
+		$data['icon'] = (isset($extensions[$attachment['extension']]['upload_icon']) && $extensions[$attachment['extension']]['upload_icon']) ? $config['upload_icons_path'] . '/' . trim($extensions[$attachment['extension']]['upload_icon']) : false;
 		$data['name'] = basename($attachment['real_filename']);
 		$data['comment'] = str_replace("\n", '<br />', censor_text($attachment['comment']));
 
@@ -459,8 +458,6 @@
 		{
 			$data['category'] = 'DENIED';
 			$data['lang'] = sprintf($_CLASS['core_user']->get_lang('EXTENSION_DISABLED_AFTER_POSTING'), $attachment['extension']);
-
-			continue;
 		}
 		else
 		{

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -813,31 +813,36 @@
 {
 	global $config, $_CORE_CONFIG, $_CLASS, $site_file_root;
 
-return;
+	$titles = array(
+		'notify_topic'		=> 'Topic Reply Notification - '. $topic_title,
+		'notify_newtopic'	=> 'New Topic Notification - '. $topic_title,
+		'notify_forum'		=> 'Forum Post Notification - '. $forum_name,
+	);
 
 	if ($mode == 'reply' || $mode == 'quote')
 	{
+		$topic_title = $subject;
+
 		$notify_type = 'topic';
-		$template = 'topic_notify'; //forum_notify
+		$template = 'notify_topic'; //forum_notify
 		$where = "(w.forum_id = $forum_id OR w.topic_id = $topic_id)";
 	}
 	else
 	{
+		$topic_title = $topic_title;
+
 		$notify_type = 'forum';
-		$template = 'newtopic_notify';
+		$template = 'notify_newtopic';
 		$where = 'w.forum_id = '.$forum_id;
 	}
 
-	$topic_title = ($topic_notification) ? $topic_title : $subject;
 	$topic_title = censor_text($topic_title);
-
 	$holding = array();
 
 // Add use of notification type
 
 	// Lets get all the users that are set to be notified
-	// $sql = 'SELECT w.notify_type, u.user_id, u.username, u.user_email, u.user_lang, u.user_notify_type, u.user_jabber 
-	$sql = 'SELECT w.notify_type, u.user_id, u.username, u.user_email, u.user_lang
+	$sql = 'SELECT w.notify_type, w.forum_id, u.user_id, u.username, u.user_email, u.user_lang
 		FROM '.FORUMS_WATCH_TABLE.' w, ' . USERS_TABLE . " u
 		WHERE $where
 			AND w.notify_status = 0
@@ -845,7 +850,7 @@
 			AND u.user_id = w.user_id';
 	$result = $_CLASS['core_db']->query($sql);
 
-	while ($user = $_CLASS['core_db']->fetch_user_assoc($result))
+	while ($user = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$ignore_array[$user['user_id']] = $user['user_id'];
 
@@ -873,11 +878,13 @@
 	// Now we remove the users that aren't allowed to read the forum
 	$acl_list = $_CLASS['auth']->acl_get_list(array_keys($ignore_array), 'f_read', $forum_id);
 
-	foreach($forum_ary[$forum_id]['f_read'] as $user_id)
+	if (!empty($acl_list))
 	{
-		unset($ignore_array[$user_id]);
+		foreach ($acl_list[$forum_id]['f_read'] as $user_id)
+		{
+			unset($ignore_array[$user_id]);
+		}
 	}
-
 	$processed = $delete_array = $update_array = array();
 
 	foreach ($holding as $user)
@@ -925,11 +932,10 @@
 		$count = count($user_list);
 		for ($i = 0; $i < $count; $i++)
 		{
-			$mailer->to($user_list[$i]['user_id'], $user_list[$i]['username']);
+			$mailer->to($user_list[$i]['user_email'], $user_list[$i]['username']);
 		}
 
-// this has to change
-		$mailer->subject($_CLASS['core_user']->get_lang('FORUM_NOTIFICATION'));
+		$mailer->subject($titles[$template]);
 
 		$_CLASS['core_template']->assign_array(array(
 			'EMAIL_SIG'		=> $email_sig,
@@ -937,17 +943,19 @@
 			'TOPIC_TITLE'	=> $topic_title,  
 			'FORUM_NAME'	=> $forum_name,
 
-			'U_FORUM'				=> generate_link("Forums&amp;file=viewtopic&f=$forum_id&e=0", array('sid' => false, 'full' => true)),
-			'U_TOPIC'				=> generate_link("Forums&amp;file=viewtopic&t=$topic_id&e=0", array('sid' => false, 'full' => true)),
-			'U_NEWEST_POST'			=> generate_link("Forums&amp;file=viewtopic&t=$topic_id&p=$post_id&e=$post_id", array('sid' => false, 'full' => true)),
-			'U_STOP_WATCHING_TOPIC' => generate_link("Forums&amp;file=viewtopic&t=$topic_id&unwatch=topic", array('sid' => false, 'full' => true)),
-			'U_STOP_WATCHING_FORUM' => generate_link("Forums&amp;file=viewforum&f=$forum_id&unwatch=forum", array('sid' => false, 'full' => true)), 
+			'U_FORUM'				=> generate_link("Forums&file=viewforum&f=$forum_id&e=0", array('sid' => false, 'full' => true)),
+			'U_TOPIC'				=> generate_link("Forums&file=viewtopic&t=$topic_id&e=0", array('sid' => false, 'full' => true)),
+			'U_NEWEST_POST'			=> generate_link("Forums&file=viewtopic&t=$topic_id&p=$post_id&e=$post_id", array('sid' => false, 'full' => true)),
+			'U_STOP_WATCHING_TOPIC' => generate_link("Forums&file=viewtopic&t=$topic_id&unwatch=topic", array('sid' => false, 'full' => true)),
+			'U_STOP_WATCHING_FORUM' => generate_link("Forums&file=viewforum&f=$forum_id&unwatch=forum", array('sid' => false, 'full' => true)), 
 		));
+		
+		$mailer->message = trim($_CLASS['core_template']->display("email/forums/$template.txt", true));
 
-		//$mailer->message = trim($_CLASS['core_template']->display('fdsgfd'.$template, true));
-		//$mailer->send();
-		
-		unset($mailer);
+		if (!$mailer->send())
+		{
+			//echo $mailer->error;
+		}
 	}
 
 	$_CLASS['core_db']->transaction();
@@ -968,7 +976,7 @@
 				AND user_id IN (" . implode(', ', $update_array['forum']) . ")");
 	}
 
-	$_CLASS['core_db']->sql_transaction('commit');
+	$_CLASS['core_db']->transaction('commit');
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_upload.php
===================================================================
--- cms/trunk/includes/forums/functions_upload.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/forums/functions_upload.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -62,7 +62,8 @@
 			$this->mimetype = 'application/octetstream';
 		}
 		
-		$this->extension = array_pop(explode('.', strtolower($this->realname)));
+		$this->extension = explode('.', strtolower($this->realname));
+		$this->extension = array_pop($this->extension);
 
 		// Try to get real filesize from temporary folder (not always working) ;)
 		$this->filesize = (@filesize($this->filename)) ? @filesize($this->filename) : $this->filesize;
@@ -102,7 +103,8 @@
 
 			case 'unique':
 			default:
-				$this->realname = $prefix . md5(unique_id()) . '.' . $this->extension;
+				$this->realname = $prefix . md5(uniqid(mt_rand(), true)) . '.' . $this->extension;
+			break;
 		}
 	}
 
@@ -631,7 +633,7 @@
 
 	function valid_extension(&$file)
 	{
-		return (in_array($file->get('extension'), $this->allowed_extensions)) ? true : false;
+		return in_array($file->get('extension'), $this->allowed_extensions);
 	}
 
 	function valid_dimensions(&$file)

Modified: cms/trunk/includes/system.php
===================================================================
--- cms/trunk/includes/system.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/system.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -155,34 +155,36 @@
 
 function activate()
 {
-	global $_CLASS;
+	global $_CLASS, $_CORE_CONFIG;
 
-	$user_id = get_variable('user_id', 'GET', 0, 'integer');
+	$user_id = get_variable('user_id', 'GET', false, 'integer');
 	$key = get_variable('key', 'GET', false);
 
 	if (!$user_id || !$key)
 	{
 		trigger_error('CANT_ACTIVATED');
 	}
-	
+
 	$sql = 'SELECT username, user_status, user_group, user_new_password, user_new_password_encoding, user_act_key
 		FROM ' . USERS_TABLE . " WHERE user_id = $user_id AND user_type = ".USER_NORMAL;
 
-	$result = $_CLASS['core_db']->sql_query($sql);
-	$row = $_CLASS['core_db']->sql_fetchrow($result);
-	$_CLASS['core_db']->sql_freeresult($result);
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
 	if (!$row)
 	{
 		trigger_error('NO_USER');
 	}
-	
-	if ($row['user_status'] != USER_UNACTIVATED && !$row['user_new_password'])
+
+	settype($row['user_status'], 'int');
+
+	if ($row['user_status'] !== STATUS_PENDING && !$row['user_new_password'])
 	{
-		trigger_error(($row['user_status'] == USER_ACTIVE) ? 'ALREADY_ACTIVATED' : 'CANT_ACTIVATED');
+		trigger_error(($row['user_status'] === STATUS_ACTIVE) ? 'ALREADY_ACTIVATED' : 'CANT_ACTIVATED');
 	}
 
-	if ($row['user_act_key'] != $key)
+	if ($row['user_act_key'] !== $key)
 	{
 		trigger_error('WRONG_ACTIVATION_KEY');
 	}
@@ -193,26 +195,30 @@
 		'user_new_password_encoding'=> null
 	);
 
-	if ($row['user_status'] != USER_UNACTIVATED)
+	if ($row['user_status'] === STATUS_PENDING)
 	{
-		$sql_ary += array(
-			'user_password'				=> $row['user_new_password'],
-			'user_password_encoding'	=> $row['user_new_password_encoding'],
-		);
-	}
-	else
-	{
 		include_once(SITE_FILE_ROOT.'includes/functions_user.php');
 		user_activate($user_id);
 
 		set_core_config('user', 'newest_user_id', $row['user_id'], false);
 		set_core_config('user', 'newest_username', $row['username'], false);
+		set_core_config('user', 'total_users', $_CORE_CONFIG['user']['total_users'] + 1, false);
 	}
+	else
+	{
+		$sql_ary += array(
+			'user_password'				=> $row['user_new_password'],
+			'user_password_encoding'	=> $row['user_new_password_encoding'],
+		);
+	}
 
 	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
-		WHERE user_id = ' . $row['user_id'];
+		WHERE user_id = ' . $user_id;
+	$result = $_CLASS['core_db']->query($sql);
 
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$message = ($row['user_status'] === STATUS_PENDING) ? $_CLASS['core_user']->get_lang('ACCOUNT_ACTIVE') : $_CLASS['core_user']->get_lang('PASSWORD_ACTIVATED');
+
+	trigger_error($message. '<br /><br />' . sprintf($_CLASS['core_user']->get_lang('RETURN_INDEX'),  '<a href="'. generate_link() .'">', '</a>'));
 }
 
 function login()

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/tables.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -202,8 +202,9 @@
 define('FORUMS_WATCH_TABLE', $table_prefix.'forums_watch');
 define('FORUMS_TRACK_TABLE', $table_prefix.'forums_tracking');
 define('FORUMS_RANKS_TABLE', $table_prefix.'forums_ranks');
+define('FORUMS_EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
+define('FORUMS_EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
-
 define('ADMIN_AUTH_TABLE', $table_prefix.'admins');
 
 define('BLOCKS_TABLE', $table_prefix.'blocks');
@@ -220,8 +221,6 @@
 define('SESSIONS_TABLE', $table_prefix.'sessions');
 
 
-define('EXTENSIONS_TABLE', $table_prefix.'forums_extensions');
-define('EXTENSION_GROUPS_TABLE', $table_prefix.'forums_extension_groups');
 
 define('USERS_TABLE', $user_prefix.'users');
 define('USERS_NOTES_TABLE', $table_prefix.'forums_users_notes');

Deleted: cms/trunk/includes/templates/en/email/contact/index.html
===================================================================
--- cms/trunk/includes/templates/en/email/contact/index.html	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/contact/index.html	2005-09-18 17:58:38 UTC (rev 131)
@@ -1,6 +0,0 @@
-{ $MESSAGE }
-
-Sent From:	{ $SENT_FROM }
-Name:		{ $SENDER_NAME }
-email:		{ $SENDER_EMAIL }
-Sender Ip:	{ $SENDER_IP }
\ No newline at end of file

Copied: cms/trunk/includes/templates/en/email/contact/index.txt (from rev 130, cms/trunk/includes/templates/en/email/contact/index.html)
===================================================================
--- cms/trunk/includes/templates/en/email/contact/index.html	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/contact/index.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,6 @@
+{ $MESSAGE } 
+
+Sent From:	{ $SENT_FROM } 
+Name:		{ $SENDER_NAME } 
+email:		{ $SENDER_EMAIL } 
+Sender Ip:	{ $SENDER_IP } 
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/core/activation_active.txt
===================================================================
--- cms/trunk/includes/templates/en/email/core/activation_active.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/core/activation_active.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,14 @@
+{ $WELCOME_MSG } 
+
+Please keep this email for your records. Your account information is as follows:
+
+----------------------------
+Username: { $USERNAME } 
+Password: { $PASSWORD } 
+----------------------------
+
+Please do not forget your password as it has been encrypted in our database and we cannot retrieve it for you. However, should you forget your password you can request a new one which will be activated in the same way as this account.
+
+Thank you for registering.
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/core/activation_admin_inactive.txt
===================================================================
--- cms/trunk/includes/templates/en/email/core/activation_admin_inactive.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/core/activation_admin_inactive.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,16 @@
+{ $WELCOME_MSG } 
+
+Please keep this email for your records. Your account information is as follows:
+
+----------------------------
+Username: { $USERNAME } 
+Password: { $PASSWORD } 
+----------------------------
+
+Your account is currently inactive, a site administrator will need to activate it before you can log in. You will receive another email when this has occured.
+
+Please do not forget your password as it has been encrypted in our database and we cannot retrieve it for you. However, should you forget your password you can request a new one which will be activated in the same way as this account.
+
+Thank you for registering.
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/core/activation_coppa_inactive.txt
===================================================================
--- cms/trunk/includes/templates/en/email/core/activation_coppa_inactive.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/core/activation_coppa_inactive.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,50 @@
+{ $WELCOME_MSG } 
+
+In compliance with the COPPA act your account is currently inactive.
+
+Please print this message out and have your parent or guardian sign and date it. Then fax it to:
+
+{ $FAX_INFO } 
+
+OR mail it to:
+
+{ $MAIL_INFO } 
+
+------------------------------ CUT HERE ------------------------------
+Permission to Participate at { $SITENAME }
+
+Username: { $USERNAME } 
+Password: { $PASSWORD } 
+Email: { $EMAIL_ADDRESS } 
+
+ICQ Number: { $ICQ } 
+AIM Address: { $AIM } 
+MSN Messenger: { $MSN } 
+Yahoo Messenger: { $YIM } 
+Web Site: { $WEB_SITE } 
+From: { $FROM } 
+Occupation: { $OCC } 
+Interests: { $INTERESTS } 
+
+I HAVE REVIEWED THE INFORMATION PROVIDED BY MY CHILD AND HEREBY GRANT PERMISSION TO {SITENAME} TO STORE THIS INFORMATION. 
+I UNDERSTAND THIS INFORMATION CAN BE CHANGED AT ANY TIME BY ENTERING A PASSWORD. 
+I UNDERSTAND THAT I MAY REQUEST FOR THIS INFORMATION TO BE REMOVED FROM {SITENAME} AT ANY TIME.
+
+
+Parent or Guardian 
+(print your name here): _____________________
+
+(sign here): __________________ 
+
+Date: _______________
+
+------------------------------ CUT HERE ------------------------------
+
+
+Once the administrator has recived the above form via fax or regular mail your account will be activated.
+
+Please do not forget your password as it has been encrypted in our database and we cannot retrieve it for you. However, should you forget your password you can request a new one which will be activated in the same way as this account.
+
+Thank you for registering.
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/core/activation_inactive.txt
===================================================================
--- cms/trunk/includes/templates/en/email/core/activation_inactive.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/core/activation_inactive.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,18 @@
+{ $WELCOME_MSG } 
+
+Please keep this email for your records. Your account information is as follows:
+
+----------------------------
+Username: { $USERNAME } 
+Password: { $PASSWORD } 
+----------------------------
+
+Your account is currently inactive. You cannot use it until you visit the following link:
+
+{ $U_ACTIVATE } 
+
+Please do not forget your password as it has been encrypted in our database and we cannot retrieve it for you. However, should you forget your password you can request a new one which will be activated in the same way as this account.
+
+Thank you for registering.
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/forums/notify_forum.txt
===================================================================
--- cms/trunk/includes/templates/en/email/forums/notify_forum.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/forums/notify_forum.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,11 @@
+Hi,
+
+You are receiving this email because you are watching the forum, "{ $FORUM_NAME }" at { $SITENAME }. This forum has received a new reply to the topic "{ $TOPIC_TITLE }" since your last visit. You can use the following link to view this topic, no more notifications will be sent until you visit the topic.
+
+{ $U_NEWEST_POST } 
+
+If you no longer wish to watch this forum you can either click the "Stop watching this forum link" found at the bottom of the forum above, or by clicking the following link:
+
+{ $U_STOP_WATCHING_FORUM } 
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/forums/notify_newtopic.txt
===================================================================
--- cms/trunk/includes/templates/en/email/forums/notify_newtopic.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/forums/notify_newtopic.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,11 @@
+hi,
+
+You are receiving this email because you are watching the forum, "{ $FORUM_NAME }" at { $SITENAME }. This forum has received a new topic since your last visit, "{ $TOPIC_TITLE }". You can use the following link to view forum, no more notifications will be sent until you visit the forum.
+
+{ $U_FORUM } 
+
+If you no longer wish to watch this forum you can either click the "Stop watching this forum link" found at the bottom of the forum above, or by clicking the following link:
+
+{ $U_STOP_WATCHING_FORUM } 
+
+{ $EMAIL_SIG }
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/forums/notify_topic.txt
===================================================================
--- cms/trunk/includes/templates/en/email/forums/notify_topic.txt	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/en/email/forums/notify_topic.txt	2005-09-18 17:58:38 UTC (rev 131)
@@ -0,0 +1,15 @@
+Hi,
+
+You are receiving this email because you are watching the topic, "{ $TOPIC_TITLE }" at { $SITENAME }. This topic has received a reply since your last visit. You can use the following link to view the replies made, no more notifications will be sent until you visit the topic.
+
+If you want to view the newest post made since your last visit, click the following link:
+{ $U_NEWEST_POST } 
+
+If you want to view the topic, click the following link:
+{ $U_TOPIC } 
+
+If you no longer wish to watch this topic you can either click the "Stop watching this topic link" found at the bottom of the topic above, or by clicking the following link:
+
+{ $U_STOP_WATCHING_TOPIC } 
+
+{ $EMAIL_SIG }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-18 17:58:38 UTC (rev 131)
@@ -173,9 +173,9 @@
 						<br clear="all" />
 						<!-- ENDIF -->
 
-						<div class="postbody" style="min-height: 100px;">{ $postrow:MESSAGE }</div>
+						<!-- IF { $postrow:ATTACHMENTS } -->
+						<div class="postbody">{ $postrow:MESSAGE }</div>
 
-						<!-- IF { $postrow:ATTACHMENTS } -->
 						<br clear="all" /><br />
 						
 						<table class="tablebg" width="100%" cellspacing="1">
@@ -184,10 +184,35 @@
 							</tr>
 							<!-- LOOP $postrow:ATTACHMENTS -->
 							<tr>
-								<td class="row2">{ $postrow:ATTACHMENTS:DISPLAY_ATTACHMENT }</td>
+								<td class="row2">
+								<!-- IF { $postrow:ATTACHMENTS:category } == 'DENIED' -->
+									<span class="postbody">[ { $postrow:ATTACHMENTS:lang }]</span><br /><br />
+								<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'IMAGE' -->
+									<!-- IF { $postrow:ATTACHMENTS:comment } -->
+									<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+									<!-- ENDIF --><img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" /></span>
+									<br /><span class="gensmall"><strong>{ $postrow:ATTACHMENTS:name }</strong><br/> { $L_VIEWED } { $postrow:ATTACHMENTS:lang_views } </span>
+								<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'THUMBNAIL' -->
+									<!-- IF { $postrow:ATTACHMENTS:comment } -->
+									<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+									<!-- ENDIF -->		<a href="{ $postrow:ATTACHMENTS:link }" target="_blank"><img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" border="0" /></a></span>
+									<br /><span class="gensmall"><strong>{ $postrow:ATTACHMENTS:name }</strong><br/> { $L_VIEWED } { $postrow:ATTACHMENTS:lang_views } </span>
+								<!-- ELSE -->
+									<!-- IF { $postrow:ATTACHMENTS:comment } -->
+									<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+									<!-- ENDIF -->
+									<!-- IF { $postrow:ATTACHMENTS:icon } --><img src="{ $postrow:ATTACHMENTS:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $postrow:ATTACHMENTS:link }" target="_blank">{ $postrow:ATTACHMENTS:name }</a>
+									<span class="gensmall">
+									<br />{ $L_FILESIZE } { $postrow:ATTACHMENTS:lang_size }
+									<br />{ $L_DOWNLOADED } { $postrow:ATTACHMENTS:lang_views }
+									</span>
+								<!-- ENDIF -->
+								</td>
 							</tr>
 							<!-- ENDLOOP -->
-						</table>
+						</table>
+						<!-- ELSE -->
+							<div class="postbody" style="min-height: 100px;">{ $postrow:MESSAGE }</div>
 						<!-- ENDIF -->
 
 						<!-- IF { $postrow:S_DISPLAY_NOTICE } -->

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/install/build_data.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -38,7 +38,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'News', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'contact', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
@@ -462,4 +462,39 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Plain Text', 0, 0, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Documents', 0, 0, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Real Media', 3, 0, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Windows Media', 2, 0, 1, '', 0, '')");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'gif')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'png')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'jpeg')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'jpg')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'tif')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'tga')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'gtar')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'gz')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'tar')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'zip')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'rar')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'ace')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'txt')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'c')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'h')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'cpp')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'hpp')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'diz')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'xls')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'doc')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'dot')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'pdf')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ai')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ps')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ppt')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (5, 'rm')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wma')");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wmv')");
 ?>
\ No newline at end of file

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/install/build_tables.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -484,7 +484,7 @@
 $_CLASS['core_db']->add_table_field_char('upload_icon', 100);
 $_CLASS['core_db']->add_table_field_int('max_filesize', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_text('allowed_forums', 2000);
-$_CLASS['core_db']->add_table_field_int('allow_in_pm', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('allow_in_pm', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_index('group_id', 'primary');
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -29,7 +29,7 @@
 		
 		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
 		$submit		= isset($_POST['submit']);
-
+$_CORE_CONFIG['user']['activation'] = USER_ACTIVATION_SELF;
 		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
 			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			&& !$_CORE_CONFIG['email']['email_enable'])
@@ -142,50 +142,44 @@
 
 			if (empty($error))
 			{
-				$password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
+				$encode_password = encode_password($password, $_CORE_CONFIG['user']['password_encoding']);
 	
-				if (!$password)
+				if (!$encode_password)
 				{
 					//do some admin contact thing here
 					die('Activation disabled: Passwaord encoding problem');
 				}
-	
+
 				if ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 				{
-					if (!$_CORE_CONFIG['email']['email_enable'])
-					{
-						//do some admin contact thing here
-						die('Activation disabled: Email Disabled');
-					}
-
 					$user_status = STATUS_PENDING;
 					$user_act_key = generate_string(10);
 
 					if ($coppa)
 					{
-						$message = $_CLASS['core_user']->lang['ACCOUNT_COPPA'];
-						$email_template = 'coppa_welcome_inactive';
+						$message = $_CLASS['core_user']->get_lang('ACCOUNT_COPPA');
+						$email_template = 'activation_coppa_inactive.txt';
 					}
 					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF)
 					{
-						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE'];
-						$email_template = 'user_welcome_inactive';
+						$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE');
+						$email_template = 'activation_inactive.txt';
 					}
 					elseif ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 					{
-						$message = $_CLASS['core_user']->lang['ACCOUNT_INACTIVE_ADMIN'];
-						$email_template = 'admin_welcome_inactive';
+						$message = $_CLASS['core_user']->get_lang('ACCOUNT_INACTIVE_ADMIN');
+						$email_template = 'activation_admin_inactive.txt';
 					}
 				}
 				else
 				{
 					$user_status = STATUS_ACTIVE;
 					$user_act_key = null;
-
-					$email_template = 'user_welcome';
-					$message = $_CLASS['core_user']->lang['ACCOUNT_ADDED'];
+			
+					$email_template = 'activation_active.txt';
+					$message = $_CLASS['core_user']->get_lang('ACCOUNT_ADDED');
 				}
-	
+
 				$data = array(
 					'username'		=> (string) $username,
 					'user_email'	=> (string) $email,
@@ -194,7 +188,7 @@
 					'user_reg_date'	=> (int) $_CLASS['core_user']->time,
 					'user_timezone'	=> (string) $tz,
 
-					'user_password'			=> (string) $password,
+					'user_password'			=> (string) $encode_password,
 					'user_password_encoding'=> (string) $_CORE_CONFIG['user']['password_encoding'],
 
 					'user_lang'			=> ($lang) ? (string) $lang : null,
@@ -214,11 +208,11 @@
 				}
 
 				require_once($site_file_root.'includes/mailer.php');
-		
+
 				$mailer = new core_mailer();
 
 				$mailer->to($email, $username);
-				$mailer->subject($subject);
+				$mailer->subject('Welcome to ');
 
 				$_CLASS['core_template']->assign_array(array(
 					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
@@ -226,7 +220,7 @@
 					'USERNAME'		=> $username,
 					'PASSWORD'		=> $password,
 					'EMAIL_SIG'		=> '', //I like this
-					'U_ACTIVATE'	=> generate_link('system&amp;mode=activate&user_id='.$data['user_id'].'&key='.$user_act_key, array('sid' => false, 'full' => true))
+					'U_ACTIVATE'	=> generate_link('system&mode=activate&user_id='.$data['user_id'].'&key='.$user_act_key, array('sid' => false, 'full' => true))
 				));
 
 				if ($coppa)
@@ -239,7 +233,7 @@
 					));
 				}
 
-				$mailer->message = trim($_CLASS['core_template']->display('modules/Control_Panel/email/'.$email_template, true));
+				$mailer->message = trim($_CLASS['core_template']->display('email/core/'.$email_template, true));
 
 				$mailer->send();
 
@@ -269,7 +263,7 @@
 
 				if ($attempts > $_CORE_CONFIG['user']['max_reg_attempts'])
 				{
-					trigger_error($_CLASS['core_user']->lang['TOO_MANY_REGISTERS']);
+					trigger_error('TOO_MANY_ATTEMPTS');
 				}
 
 				$_CLASS['core_user']->session_data_get('reg_attempts', ($attempts + 1));

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/modules/Forums/posting.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -1097,7 +1097,7 @@
 $s_hidden_fields = ($mode == 'reply' || $mode == 'quote') ? '<input type="hidden" name="topic_cur_post_id" value="' . $topic_last_post_id . '" />' : '';
 $s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '<input type="hidden" name="draft_loaded" value="' . ((isset($_REQUEST['draft_loaded'])) ? intval($_REQUEST['draft_loaded']) : $draft_id) . '" />' : '';
 
-$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']->acl_gets('f_attach', 'u_attach', $forum_id)) ? '' : ' enctype="multipart/form-data"';
+$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']->acl_gets(array('f_attach', 'u_attach'), $forum_id)) ? '' : ' enctype="multipart/form-data"';
 
 // Start assigning vars for main posting page ...
 $_CLASS['core_template']->assign_array(array(
@@ -1182,8 +1182,7 @@
 }
 
 // Attachment entry
-// Not using acl_gets here, because it is using OR logic
-if ($_CLASS['auth']->acl_get('f_attach', $forum_id) && $_CLASS['auth']->acl_get('u_attach') && $config['allow_attachments'] && $form_enctype)
+if ($form_enctype)
 {
 	posting_gen_attachment_entry($attachment_data, $filename_data);
 }
@@ -1731,6 +1730,7 @@
 					'poster_id'			=> $poster_id,
 					'physical_filename'	=> basename($attach_row['physical_filename']),
 					'real_filename'		=> basename($attach_row['real_filename']),
+					'download_count'	=> 0,
 					'comment'			=> $attach_row['comment'],
 					'extension'			=> $attach_row['extension'],
 					'mimetype'			=> $attach_row['mimetype'],
@@ -1748,7 +1748,7 @@
 			}
 		}
 
-		if (sizeof($data['attachment_data']))
+		if (!empty($data['attachment_data']))
 		{
 			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET post_attachment = 1

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -317,7 +317,7 @@
 	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=> generate_link('Forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_MCP' 			=> ($_CLASS['auth']->acl_gets('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
+	'U_MCP' 			=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
 	'U_POST_NEW_TOPIC'	=> generate_link('Forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id), 
 	'U_VIEW_FORUM'		=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&amp;start=$start"), 
 	'U_MARK_TOPICS' 	=> generate_link("Forums&amp;file=viewforum&amp;f=$forum_id&amp;mark=topics"))
@@ -501,13 +501,13 @@
 			'TOPIC_ICON_IMG'        => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
 			'TOPIC_ICON_IMG_WIDTH'  => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
 			'TOPIC_ICON_IMG_HEIGHT' => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
-			'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+			'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 
 			'S_TOPIC_TYPE'			=> $row['topic_type'], 
 			'S_UNREAD_TOPIC'		=> $unread_topic,
 
-			'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_gets('m_', $forum_id)) ? true : false,
-			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_gets('m_approve', $forum_id)) ? true : false,
+			'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_get('m_', $forum_id)) ? true : false,
+			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_get('m_approve', $forum_id)) ? true : false,
 
 			'U_LAST_POST'       => generate_link($view_topic_url . $SID . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false, false, false),	
 			'U_LAST_POST_AUTHOR'=> ($_CLASS['core_user']->is_user && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-18 17:58:38 UTC (rev 131)
@@ -831,7 +831,7 @@
 // Pull attachment data
 if (!empty($attach_list))
 {
-	if ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id))
+	if ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id))
 	{
 		include($site_file_root.'includes/forums/functions_display.php');
 
@@ -1052,10 +1052,7 @@
 	// Remove this foreach.
 	if (isset($attachments[$row['post_id']]) && !empty($attachments[$row['post_id']]))
 	{
-		foreach ($attachments[$row['post_id']] as $attachment)
-		{
-			$post_attachments[] = array('DISPLAY_ATTACHMENT'	=> $attachment);
-		}
+		$post_attachments = display_attachments($forum_id, $attachments[$row['post_id']], $null);
 	}
 
 	if ($unread = ($row['post_time'] > $topic_last_read))
@@ -1107,7 +1104,7 @@
 		'U_JABBER'			=> $user_cache[$poster_id]['jabber'], 
 
 		'U_REPORT'			=> generate_link('Forums&amp;file=report&amp;p=' . $row['post_id']),
-		'U_MCP_REPORT'		=> ($_CLASS['auth']->acl_gets('m_', 'a_', 'f_report', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MCP_REPORT'		=> ($_CLASS['auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
 		'U_MCP_APPROVE'		=> ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
 		'U_MCP_DETAILS'		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
 		'U_MINI_POST'		=> generate_link('Forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
@@ -1116,10 +1113,10 @@
 		'POST_ID'           => $row['post_id'],
 		'S_IGNORE_POST' 	=> false, 
 		
-		'S_POST_UNAPPROVED'	=> ($row['post_approved']) ? FALSE : TRUE,
+		'S_POST_UNAPPROVED'	=> !$row['post_approved'],
 		'S_POST_REPORTED'	=> ($row['post_reported'] && $_CLASS['auth']->acl_get('m_', $forum_id)) ? TRUE : FALSE,
 		'S_DISPLAY_NOTICE'	=> ($display_notice && $row['post_attachment']) ? true : false, 
-		'S_FRIEND'			=> ($row['friend']) ? true : false,
+		'S_FRIEND'			=> $row['friend'],
 		'S_UNREAD_POST'		=> $unread,
 		'S_FIRST_UNREAD'	=> false,
 	);

Modified: cms/trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-17 16:14:54 UTC (rev 130)
+++ cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-18 17:58:38 UTC (rev 131)
@@ -27,10 +27,10 @@
 
 <body>
 
-{ $HEADER_BODY }
+<a name="Top"></a>
 
-<a name="Top"></a>
-<div style="position:fixed;top: -1px;left: -1px;z-index: 1;">
+<div style="position:fixed; top: -1px;left: -1px;z-index: 1;">
+
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
 	<tr>
 		<td nowrap="nowrap" class="row2"><a href="{ $LINK_HOME }">{ $L_SITE_INDEX }</a></td>
@@ -39,6 +39,7 @@
 		<td width="100%" class="row2"></td>
 	</tr>
 </table>
+
 </div>
 
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">



From viperal at berlios.de  Mon Sep 19 20:40:50 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 19 Sep 2005 20:40:50 +0200
Subject: [Viperals-svncheckins] r132 - in cms/trunk: . blocks includes/forums includes/forums/mcp includes/templates/modules/Forums modules/Control_Panel/ucp modules/Forums
Message-ID: <200509191840.j8JIeoSB005067@sheep.berlios.de>

Author: viperal
Date: 2005-09-19 20:40:49 +0200 (Mon, 19 Sep 2005)
New Revision: 132

Added:
   cms/trunk/blocks/block-forums_mcp.php
   cms/trunk/includes/templates/modules/Forums/mcp_sideblock.html
Removed:
   cms/trunk/includes/templates/modules/Forums/editor.js
Modified:
   cms/trunk/core.php
   cms/trunk/includes/forums/bbcode.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_front.php
   cms/trunk/includes/forums/mcp/mcp_queue.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/templates/modules/Forums/attachments.html
   cms/trunk/includes/templates/modules/Forums/mcp_footer.html
   cms/trunk/includes/templates/modules/Forums/mcp_header.html
   cms/trunk/includes/templates/modules/Forums/posting_preview.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
   cms/trunk/installer.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/viewtopic.php
Log:


Added: cms/trunk/blocks/block-forums_mcp.php
===================================================================
--- cms/trunk/blocks/block-forums_mcp.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/blocks/block-forums_mcp.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -0,0 +1,33 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $_CLASS;
+
+$this->content = $_CLASS['core_template']->display('modules/Forums/mcp_sideblock.html', true);
+
+?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/core.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -81,6 +81,8 @@
 require_once(SITE_FILE_ROOT.'includes/handler.php');
 require_once(SITE_FILE_ROOT.'config.php');
 
+ at register_shutdown_function('script_close');
+
 // Load basic classes
 load_class(false, 'core_template');
 load_class(false, 'core_error_handler');
@@ -109,11 +111,6 @@
 load_class(false, 'core_cache', 'cache_'.$acm_type);
 load_class(false, 'core_db', 'db_'.$site_db['type']);
 
-if (function_exists('register_shutdown_function'))
-{
-	register_shutdown_function('script_close');
-}
-
 $_CLASS['core_db']->connect($site_db);
 unset($sitedb);
 

Modified: cms/trunk/includes/forums/bbcode.php
===================================================================
--- cms/trunk/includes/forums/bbcode.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/bbcode.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -101,89 +101,9 @@
 		// Remove the uid from tags that have not been transformed into HTML
 		$message = str_replace(':' . $this->bbcode_uid, '', $message);
 
-		// remove
-		$match_count = preg_match_all("#\<!--php-->(.*?)\<!--/php-->#si", $message, $matches);
-		
-		if ($match_count)
-		{
-			$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
-
-			foreach ($conf as $ini_var)
-			{
-				ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));
-			}
-
-			for ($i = 0; $i < $match_count; $i++)
-			{
-				$after = $this->decode_php($matches[1][$i]);
-				$after = '<div class="codetitle"><b>PHP:</b></div><div class="codecontent">'.$after.'</div>';
-				
-				$before = '<!--php-->' . $matches[1][$i] . '<!--/php-->';
-				$message = str_replace($before, $after, $message);
-			}
-		}
 		return $message;
 	}
 	
-	function decode_php($text)
-	{
-		$text = trim($text);
-
-		$remove_tags = false;
-
-		//$text = strtr($text, array_flip(get_html_translation_table(HTML_ENTITIES)));
-
-		$str_from = array('&lt;', '&gt;', '&#39;');
-		$str_to = array('<', '>', '\'');
-
-		$text = str_replace($str_from, $str_to, $text);
-
-		if (!preg_match('/^\<\?(.*?)\?\>/is', $text))
-		{
-			$remove_tags = true;
-			$text = "<?php $text ?>";
-		}
-
-
-		if (version_compare(PHP_VERSION, '4.2.0', '<'))
-		{
-			ob_start();
-			highlight_string($text);
-			$text = ob_get_contents();
-			ob_end_clean();
-		}
-		else
-		{
-			$text = highlight_string($text, true);
-		}
-
-		$str_from = array('<font color="syntax', '</font>', '<code>', '</code>','[', ']', '.', ':', '&amp;#058;');
-		$str_to = array('<span class="syntax', '</span>', '', '', '&#91;', '&#93;', '&#46;', '&#58', '&#058;');
-
-		if ($remove_tags)
-		{
-			$str_from[] = '<span class="syntaxdefault">&lt;?php </span>';
-			$str_to[] = '';
-			$str_from[] = '<span class="syntaxkeyword">&lt;?</span><span class="syntaxdefault">php </span>';
-			$str_to[] = '';
-			$str_from[] = '<span class="syntaxdefault">&lt;?php ';
-			$str_to[] = '<span class="syntaxdefault">';
-		}
-
-		$text = str_replace($str_from, $str_to, $text);
-		$text = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#is', '$1$2$3', $text);
-
-		if ($remove_tags)
-		{
-			$text = preg_replace('#(<span class="[a-z]+">)?\?&gt;</span>#', '', $text);
-		}
-
-		$text = preg_replace('#^<span class="[a-z]+"><span class="([a-z]+)">(.*)</span></span>#s', '<span class="$1">$2</span>', $text);
-		$text = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*</span>$#', '</span>', $text);
-	
-		return $text;
-	}
-
 	//
 	// bbcode_cache_init()
 	//
@@ -225,7 +145,7 @@
 			$rowset = array();
 
 			$sql = 'SELECT *
-				FROM ' . FORUMS_BBCODES_TABLE . "
+				FROM ' . BBCODES_TABLE . "
 				WHERE bbcode_id IN ($sql)";
 
 			$result = $_CLASS['core_db']->query($sql);
@@ -250,24 +170,28 @@
 						)
 					);
 				break;
+
 				case 1:
 					$this->bbcode_cache[$bbcode_id] = array('str' => array(
 						'[b:$uid]'	=>	$this->bbcode_tpl('b_open', $bbcode_id),
 						'[/b:$uid]'	=>	$this->bbcode_tpl('b_close', $bbcode_id)
 					));
 				break;
+
 				case 2:
 					$this->bbcode_cache[$bbcode_id] = array('str' => array(
 						'[i:$uid]'	=>	$this->bbcode_tpl('i_open', $bbcode_id),
 						'[/i:$uid]'	=>	$this->bbcode_tpl('i_close', $bbcode_id)
 					));
 				break;
+
 				case 3:
 					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
 						'#\[url:$uid\]((.*?))\[/url:$uid\]#s'		=>	$this->bbcode_tpl('url', $bbcode_id),
 						'#\[url=([^\[]+?):$uid\](.*?)\[/url:$uid\]#s'	=>	$this->bbcode_tpl('url', $bbcode_id)
 					));
 				break;
+
 				case 4:
 					if ($_CLASS['core_user']->optionget('viewimg'))
 					{
@@ -282,27 +206,32 @@
 						));
 					}
 				break;
+
 				case 5:
 					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
 						'#\[size=([\-\+]?[1-2]?[0-9]):$uid\](.*?)\[/size:$uid\]#s'	=>	$this->bbcode_tpl('size', $bbcode_id)
 					));
 				break;
+
 				case 6:
 					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
 						'!\[color=(#[0-9A-F]{6}|[a-z\-]+):$uid\](.*?)\[/color:$uid\]!s'	=>	$this->bbcode_tpl('color', $bbcode_id)
 					));
 				break;
+
 				case 7:
 					$this->bbcode_cache[$bbcode_id] = array('str' => array(
 						'[u:$uid]'	=>	$this->bbcode_tpl('u_open', $bbcode_id),
 						'[/u:$uid]'	=>	$this->bbcode_tpl('u_close', $bbcode_id)
 					));
 				break;
+
 				case 8:
 					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
 						'#\[code(?:=([a-z]+))?:$uid\](.*?)\[/code:$uid\]#ise'	=>	"\$this->bbcode_second_pass_code('\$1', '\$2')"
 					));
 				break;
+
 				case 9:
 					$this->bbcode_cache[$bbcode_id] = array(
 						'preg' => array(
@@ -320,12 +249,14 @@
 						),
 					);
 				break;
+
 				case 10:
 					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
 							'#\[email:$uid\]((.*?))\[/email:$uid\]#is'				=>	$this->bbcode_tpl('email', $bbcode_id),
 							'#\[email=([^\[]+):$uid\](.*?)\[/email:$uid\]#is'	=>	$this->bbcode_tpl('email', $bbcode_id)
 					));
 				break;
+
 				case 11:
 					if ($_CLASS['core_user']->optionget('viewflash'))
 					{
@@ -340,6 +271,7 @@
 						));
 					}
 				break;
+
 				case 12:
 					$this->bbcode_cache[$bbcode_id] = array(
 						'str'	=> array(
@@ -347,7 +279,8 @@
 						'preg'	=> array(
 							'#\[attachment=([0-9]+):$uid\]#'	=> $this->bbcode_tpl('inline_attachment_open', $bbcode_id))
 					);
-					break;
+				break;
+
 				default:
 					if (isset($rowset[$bbcode_id]))
 					{

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/functions.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -1073,7 +1073,7 @@
 }
 
 // Inline Attachment processing
-function parse_inline_attachments(&$text, &$attachments, &$update_count, $forum_id = 0, $preview = false)
+function parse_inline_attachments(&$text, $attachments, &$update_count, $forum_id = 0, $preview = false)
 {
 	global $config, $_CLASS;
 
@@ -1081,6 +1081,7 @@
 	$tpl_size = count($attachments);
 
 	preg_match_all('#<!\-\- ia([0-9]+) \-\->(.*?)<!\-\- ia\1 \-\->#', $text, $matches, PREG_PATTERN_ORDER);
+
 	//print_r($matches);
 	if (count($matches[1]))
 	{

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -865,10 +865,11 @@
 				}
 			}
 
-			$sql = 'SELECT DISTINCT(post_id)
+		/*	$sql = 'SELECT DISTINCT(post_id)
 				FROM ' . FORUMS_REPORTS_TABLE . '
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 			$result = $_CLASS['core_db']->query($sql);
+		*/
 
 			$post_ids = array();
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1191,7 +1192,7 @@
 			$sql = 'SELECT t.topic_id, t.post_approved, COUNT(t.post_id) AS total_posts, MIN(t.post_id) AS first_post_id, MAX(t.post_id) AS last_post_id
 				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql
-				GROUP BY t.topic_id"; //, t.post_approved";
+				GROUP BY t.topic_id, t.post_approved";
 			$result = $_CLASS['core_db']->query($sql);
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -136,12 +136,12 @@
 
 function upload_attachment($form_name, $forum_id, $local = false, $local_storage = '', $is_message = false)
 {
-	global $_CLASS, $site_file_root, $config;
+	global $_CLASS, $config;
 
 	$filedata = array();
 	$filedata['error'] = array();
 
-	include_once($site_file_root. 'includes/forums/functions_upload.php');
+	include_once(SITE_FILE_ROOT. 'includes/forums/functions_upload.php');
 	$upload = new fileupload();
 	
 	if (!$local)
@@ -159,8 +159,7 @@
 		return $filedata;
 	}
 
-	$extensions = array();
-	obtain_attach_extensions($extensions, $forum_id);
+	$extensions = obtain_attach_extensions($forum_id);
 
 	$upload->set_allowed_extensions(array_keys($extensions['_allowed_']));
 
@@ -727,7 +726,7 @@
 // Topic Review
 function topic_review($topic_id, $forum_id, $mode = 'topic_review', $cur_post_id = 0, $show_quote_button = true)
 {
-	global $_CLASS, $bbcode, $site_file_root, $config;
+	global $_CLASS, $bbcode, $config;
 
 	// Go ahead and pull all data for this topic
 	$sql = 'SELECT u.username, u.user_id, p.post_id, p.post_username, p.post_subject, p.post_text, p.enable_smilies, p.bbcode_uid, p.bbcode_bitfield, p.post_time
@@ -756,7 +755,7 @@
 	// Instantiate BBCode class
 	if (!isset($bbcode) && $bbcode_bitfield)
 	{
-		require_once($site_file_root.'includes/forums/bbcode.php');
+		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
 
@@ -811,7 +810,7 @@
 // User Notification
 function user_notification($mode, $subject, $topic_title, $forum_name, $forum_id, $topic_id, $post_id)
 {
-	global $config, $_CORE_CONFIG, $_CLASS, $site_file_root;
+	global $config, $_CORE_CONFIG, $_CLASS;
 
 	$titles = array(
 		'notify_topic'		=> 'Topic Reply Notification - '. $topic_title,
@@ -923,7 +922,7 @@
 
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-	require_once($site_file_root.'includes/mailer.php');
+	require_once(SITE_FILE_ROOT.'includes/mailer.php');
 
 	foreach ($processed as $template => $user_list)
 	{

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -75,7 +75,8 @@
 	$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
 	$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
+		'S_TOPIC_ICONS'			=> false,
 		'FORUM_NAME'			=> $forum_info['forum_name'],
 
 		'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
@@ -97,40 +98,39 @@
 	);
 
 	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 	
 	$topic_rows = array();
 
 	$sql = 'SELECT t.*
-		FROM ' . TOPICS_TABLE . " t
+		FROM ' . FORUMS_TOPICS_TABLE . " t
 		WHERE (t.forum_id = $forum_id OR t.forum_id = 0)
 			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
 			AND t.topic_type IN (" . POST_ANNOUNCE . ", " . POST_GLOBAL . ")
 			$limit_time_sql
 		ORDER BY $sort_order_sql";
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$topic_rows[] = $row;
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	$sql = 'SELECT t.*
-		FROM ' . TOPICS_TABLE . " t
+		FROM ' . FORUMS_TOPICS_TABLE . " t
 		WHERE t.forum_id = $forum_id
 			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . '
 			AND t.topic_type IN (' . POST_NORMAL . ', ' . POST_STICKY . ")
 			$limit_time_sql
 		ORDER BY t.topic_type DESC, $sort_order_sql";
-	$result = $_CLASS['core_db']->sql_query_limit($sql, $topics_per_page, $start);
+	$result = $_CLASS['core_db']->query_limit($sql, $topics_per_page, $start);
 
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$topic_rows[] = $row;
 	}
-	$_CLASS['core_db']->sql_freeresult($result);
+	$_CLASS['core_db']->free_result($result);
 
 	foreach ($topic_rows as $row)
 	{
@@ -205,9 +205,10 @@
 			'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 			//'TOPIC_FOLDER_IMG_SRC'	=> $user->img($folder_img, $folder_alt, false, '', 'src'),
-			'TOPIC_ICON_IMG'	=> (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
-			'TOPIC_ICON_IMG_WIDTH'	=> (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
-			'TOPIC_ICON_IMG_HEIGHT' => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
+
+			'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
+			'TOPIC_ICON_IMG_WIDTH'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['width'],
+			'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['height'],
 			
 			'TOPIC_TYPE'		=> $topic_type,
 			'TOPIC_TITLE'		=> $topic_title,
@@ -216,9 +217,10 @@
 			'TOPIC_ID'			=> $row['topic_id'],
 			'S_TOPIC_CHECKED'	=> ($topic_id_list && in_array($row['topic_id'], $topic_id_list)) ? 'checked="checked" ' : '',
 
-			'S_TOPIC_REPORTED'	=> ($row['topic_reported']) ? true : false,
-			'S_TOPIC_UNAPPROVED'=> ($row['topic_approved']) ? false : true)
-		);
+			'S_TOPIC_REPORTED'	=> ($row['topic_reported']),
+			'S_TOPIC_UNAPPROVED'=> !($row['topic_approved']),
+			'NEWEST_POST_IMG' => false
+		));
 	}
 	unset($topic_rows);
 }
@@ -227,29 +229,30 @@
 {
 	global $_CLASS;
 
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
+	if (!($forum_id = check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_')))
 	{
 		return;
 	}
 
-	if (!sizeof($topic_ids))
+	if (empty($topic_ids))
 	{
 		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
+
 		return;
 	}
-	
+
 	// Sync everything and perform extra checks separately
 	sync('topic_reported', 'topic_id', $topic_ids, false, true);
 	sync('topic_attachment', 'topic_id', $topic_ids, false, true);
 	sync('topic', 'topic_id', $topic_ids, true, false);
 
 	$sql = 'SELECT topic_id, forum_id, topic_title
-		FROM ' . TOPICS_TABLE . '
+		FROM ' . FORUMS_TOPICS_TABLE . '
 		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
-	$result = $_CLASS['core_db']->sql_query($sql);
+	$result = $_CLASS['core_db']->query($sql);
 
 	// Log this action
-	while ($row = $_CLASS['core_db']->sql_fetchrow($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_TOPIC_RESYNC', $row['topic_title']);
 	}

Modified: cms/trunk/includes/forums/mcp/mcp_front.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -1,218 +1,227 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_front.php,v 1.3 2004/07/19 20:13:16 acydburn Exp $
-//
-// FILENAME  : mcp_front.php
-// STARTED   : Thu Jul 08, 2004
-// COPYRIGHT : ? 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//
-// TODO:
-//	- add list of forums user is moderator in (with links to common management facilities)
-//	- add statistics (how many reports handled, how many posts locked/moved... etc.? - 
-//			those would be only valid from the time the log is valid (and not purged)
-//
-
-function mcp_front_view($id, $mode, $action, $url)
-{
-	global $_CLASS;
-
-	// Latest 5 unapproved
-	$forum_list = get_forum_list('m_approve');
-	$post_list = array();
-	$forum_names = array();
-
-	$forum_id = request_var('f', 0);
-	
-	$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', (!empty($forum_list)) ? true : false);
-	if (!empty($forum_list))
-	{
-		$sql = 'SELECT COUNT(post_id) AS total
-			FROM ' . POSTS_TABLE . '
-			WHERE forum_id IN (0, ' . implode(', ', $forum_list) . ')
-				AND post_approved = 0';
-		$result = $_CLASS['core_db']->sql_query($sql);
-		$row = $_CLASS['core_db']->sql_fetchrow($result);
-		$total = $row['total'];
-
-		if ($total)
-		{
-			$sql = 'SELECT forum_id, forum_name
-				FROM ' . FORUMS_TABLE . '
-				WHERE forum_id IN (' . implode(', ', $forum_list) . ')';
-			$result = $_CLASS['core_db']->sql_query_limit($sql);
-			
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-			{
-				$forum_names[$row['forum_id']] = $row['forum_name'];
-			}
-			$_CLASS['core_db']->sql_freeresult($result);
-			
-			$sql = 'SELECT post_id
-				FROM ' . POSTS_TABLE . '
-				WHERE forum_id IN (0, ' . implode(', ', $forum_list) . ')
-					AND post_approved = 0
-				ORDER BY post_id DESC';
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 5);
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-			{
-				$post_list[] = $row['post_id'];
-			}
-
-			$sql = 'SELECT p.post_id, p.post_subject, p.post_time, p.poster_id, p.post_username, u.username, t.topic_id, t.topic_title, t.topic_first_post_id, p.forum_id
-				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t,  ' . USERS_TABLE . ' u
-				WHERE p.post_id IN (' . implode(', ', $post_list) . ')
-					AND t.topic_id = p.topic_id
-					AND p.poster_id = u.user_id
-				ORDER BY p.post_id DESC';
-			$result = $_CLASS['core_db']->sql_query($sql);
-
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-			{
-				$_CLASS['core_template']->assign_vars_array('unapproved', array(
-					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
-					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
-					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
-					'U_AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']),
-
-					'FORUM_NAME'	=> ($row['forum_id']) ? $forum_names[$row['forum_id']] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
-					'TOPIC_TITLE'	=> $row['topic_title'],
-					'AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? (($row['post_username']) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'],
-					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
-					'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']))
-				);				
-			}
-		}
-
-		if ($total == 0)
-		{
-			$_CLASS['core_template']->assign(array(
-				'L_UNAPPROVED_TOTAL'		=> $_CLASS['core_user']->lang['UNAPPROVED_POSTS_ZERO_TOTAL'],
-				'S_HAS_UNAPPROVED_POSTS'	=> false)
-			);
-		}
-		else
-		{
-			$_CLASS['core_template']->assign(array(
-				'L_UNAPPROVED_TOTAL'		=> ($total == 1) ? $_CLASS['core_user']->lang['UNAPPROVED_POST_TOTAL'] : sprintf($_CLASS['core_user']->lang['UNAPPROVED_POSTS_TOTAL'], $total),
-				'S_HAS_UNAPPROVED_POSTS'	=> true)
-			);
-		}
-	}
-
-	// Latest 5 reported
-	$forum_list = get_forum_list('m_');
-				
-	$_CLASS['core_template']->assign('S_SHOW_REPORTS', (!empty($forum_list)) ? true : false);
-	if (!empty($forum_list))
-	{
-		$sql = 'SELECT COUNT(r.report_id) AS total
-			FROM ' . REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
-			WHERE r.post_id = p.post_id
-				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
-		$result = $_CLASS['core_db']->sql_query($sql);
-		$row = $_CLASS['core_db']->sql_fetchrow($result);
-		$total = $row['total'];
-
-		if ($total)
-		{
-			$sql = 'SELECT r.*, p.post_id, p.post_subject, u.username, t.topic_id, t.topic_title, f.forum_id, f.forum_name
-				FROM ' . REPORTS_TABLE . ' r, ' . REASONS_TABLE . ' rr,' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u
-				LEFT JOIN ' . FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
-				WHERE r.post_id = p.post_id
-					AND r.reason_id = rr.reason_id
-					AND p.topic_id = t.topic_id
-					AND r.user_id = u.user_id
-					AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')
-				ORDER BY p.post_id DESC';
-			$result = $_CLASS['core_db']->sql_query_limit($sql, 5);
-
-			while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-			{
-				$_CLASS['core_template']->assign_vars_array('report', array(
-					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
-					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
-					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
-					'U_REPORTER'	=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-
-					'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['POST_GLOBAL'],
-					'TOPIC_TITLE'	=> $row['topic_title'],
-					'REPORTER'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
-					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
-					'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']))
-				);				
-			}
-		}
-
-		if ($total == 0)
-		{
-			$_CLASS['core_template']->assign(array(
-				'L_REPORTS_TOTAL'	=>	$_CLASS['core_user']->lang['REPORTS_ZERO_TOTAL'],
-				'S_HAS_REPORTS'		=>	false)
-			);
-		}
-		else
-		{
-			$_CLASS['core_template']->assign(array(
-				'L_REPORTS_TOTAL'	=> ($total == 1) ? $_CLASS['core_user']->lang['REPORT_TOTAL'] : sprintf($_CLASS['core_user']->lang['REPORTS_TOTAL'], $total),
-				'S_HAS_REPORTS'		=> true)
-			);
-		}
-	}
-
-	// Latest 5 logs
-	$forum_list = get_forum_list(array('m_', 'a_general'));
-
-	if (!empty($forum_list))
-	{
-		// Add forum_id 0 for global announcements
-		$forum_list[] = 0;
-
-		$log_count = 0;
-		$log = array();
-		view_log('mod', $log, $log_count, 5, 0, $forum_list);
-
-		foreach ($log as $row)
-		{
-			$_CLASS['core_template']->assign_vars_array('log', array(
-				'USERNAME'		=> $row['username'],
-				'IP'			=> $row['ip'],
-				'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
-				'ACTION'		=> $row['action'],
-				'U_VIEWTOPIC'	=> $row['viewtopic'],
-				'U_VIEWLOGS'	=> $row['viewlogs'])
-			);
-		}
-	}
-
-	$_CLASS['core_template']->assign(array(
-		'S_SHOW_LOGS'	=> (!empty($forum_list)) ? true : false,
-		'S_HAS_LOGS'	=> (!empty($log)) ? true : false)
-	);
-
-	$_CLASS['core_template']->assign('S_MCP_ACTION', generate_link($url));
-	make_jumpbox(generate_link($url . '&amp;mode=forum_view'), 0, false, 'm_');
-}
-
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_front.php,v 1.3 2004/07/19 20:13:16 acydburn Exp $
+//
+// FILENAME  : mcp_front.php
+// STARTED   : Thu Jul 08, 2004
+// COPYRIGHT : ? 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+//
+// TODO:
+//	- add list of forums user is moderator in (with links to common management facilities)
+//	- add statistics (how many reports handled, how many posts locked/moved... etc.? - 
+//			those would be only valid from the time the log is valid (and not purged)
+//
+
+function mcp_front_view($id, $mode, $action, $url)
+{
+	global $_CLASS;
+
+	// Latest 5 unapproved
+	$forum_list_all = get_forum_list('m_approve');
+	$post_list = array();
+	$forum_names = array();
+
+	$forum_id = request_var('f', 0);
+	
+	$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', !empty($forum_list_all));
+
+	if (!empty($forum_list_all))
+	{
+		$sql = 'SELECT COUNT(post_id) AS total
+			FROM ' . FORUMS_POSTS_TABLE . '
+			WHERE forum_id IN (0, ' . implode(', ', $forum_list_all) . ')
+				AND post_approved = 0';
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$total = isset($row['total']) ? (int) $row['total'] : false;;
+
+		if ($total)
+		{
+			$sql = 'SELECT post_id, forum_id
+				FROM ' . FORUMS_POSTS_TABLE . '
+				WHERE forum_id IN (0, ' . implode(', ', $forum_list) . ')
+					AND post_approved = 0
+				ORDER BY post_id DESC';
+			$result = $_CLASS['core_db']->query_limit($sql, 5);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$post_list[] = $row['post_id'];
+				$forum_list[] = $row['forum_id'];
+			}
+			unset($forum_list_all);
+
+			$sql = 'SELECT forum_id, forum_name
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id IN (' . implode(', ', $forum_list) . ')';
+			$result = $_CLASS['core_db']->query($sql);
+			
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$forum_names[$row['forum_id']] = $row['forum_name'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			unset($forum_id);
+
+			$sql = 'SELECT p.post_id, p.post_subject, p.post_time, p.poster_id, p.post_username, u.username, t.topic_id, t.topic_title, t.topic_first_post_id, p.forum_id
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t,  ' . USERS_TABLE . ' u
+				WHERE p.post_id IN (' . implode(', ', $post_list) . ')
+					AND t.topic_id = p.topic_id
+					AND p.poster_id = u.user_id
+				ORDER BY p.post_id DESC';
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$_CLASS['core_template']->assign_vars_array('unapproved', array(
+					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
+					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
+					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
+					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
+					'U_AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']),
+
+					'FORUM_NAME'	=> ($row['forum_id']) ? $forum_names[$row['forum_id']] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
+					'TOPIC_TITLE'	=> $row['topic_title'],
+					'AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? (($row['post_username']) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'],
+					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
+					'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']))
+				);				
+			}
+		}
+
+		if ($total)
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'L_UNAPPROVED_TOTAL'		=> ($total == 1) ? $_CLASS['core_user']->lang['UNAPPROVED_POST_TOTAL'] : sprintf($_CLASS['core_user']->lang['UNAPPROVED_POSTS_TOTAL'], $total),
+				'S_HAS_UNAPPROVED_POSTS'	=> true
+			));
+		}
+		else
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'L_UNAPPROVED_TOTAL'		=> $_CLASS['core_user']->lang['UNAPPROVED_POSTS_ZERO_TOTAL'],
+				'S_HAS_UNAPPROVED_POSTS'	=> false
+			));
+		}
+	}
+
+	// Latest 5 reported
+	//$forum_list = get_forum_list('m_');
+				
+	$_CLASS['core_template']->assign('S_SHOW_REPORTS', !empty($forum_list));
+
+	if (!empty($forum_list))
+	{
+		$sql = 'SELECT COUNT(r.report_id) AS total
+			FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
+			WHERE r.post_id = p.post_id
+				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$total = $row['total'];
+
+		if ($total)
+		{
+			$sql = 'SELECT r.*, p.post_id, p.post_subject, u.username, t.topic_id, t.topic_title, f.forum_id, f.forum_name
+				FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_REASONS_TABLE . ' rr,' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u
+				LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
+				WHERE r.post_id = p.post_id
+					AND r.reason_id = rr.reason_id
+					AND p.topic_id = t.topic_id
+					AND r.user_id = u.user_id
+					AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')
+				ORDER BY p.post_id DESC';
+			$result = $_CLASS['core_db']->query_limit($sql, 5);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$_CLASS['core_template']->assign_vars_array('report', array(
+					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
+					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
+					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
+					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
+					'U_REPORTER'	=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+
+					'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['POST_GLOBAL'],
+					'TOPIC_TITLE'	=> $row['topic_title'],
+					'REPORTER'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
+					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
+					'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']))
+				);				
+			}
+		}
+
+		if ($total == 0)
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'L_REPORTS_TOTAL'	=>	$_CLASS['core_user']->lang['REPORTS_ZERO_TOTAL'],
+				'S_HAS_REPORTS'		=>	false)
+			);
+		}
+		else
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'L_REPORTS_TOTAL'	=> ($total == 1) ? $_CLASS['core_user']->lang['REPORT_TOTAL'] : sprintf($_CLASS['core_user']->lang['REPORTS_TOTAL'], $total),
+				'S_HAS_REPORTS'		=> true)
+			);
+		}
+	}
+
+	// Latest 5 logs
+	$forum_list = get_forum_list(array('m_', 'a_general'));
+
+	if (!empty($forum_list))
+	{
+		// Add forum_id 0 for global announcements
+		$forum_list[] = 0;
+
+		$log_count = 0;
+		$log = array();
+		view_log('mod', $log, $log_count, 5, 0, $forum_list);
+
+		foreach ($log as $row)
+		{
+			$_CLASS['core_template']->assign_vars_array('log', array(
+				'USERNAME'		=> $row['username'],
+				'IP'			=> $row['ip'],
+				'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
+				'ACTION'		=> $row['action'],
+				'U_VIEWTOPIC'	=> $row['viewtopic'],
+				'U_VIEWLOGS'	=> $row['viewlogs'])
+			);
+		}
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_SHOW_LOGS'	=> !empty($forum_list),
+		'S_HAS_LOGS'	=> !empty($log)
+	));
+
+	$_CLASS['core_template']->assign('S_MCP_ACTION', generate_link($url));
+	make_jumpbox(generate_link($url . '&amp;mode=forum_view'), 0, false, 'm_');
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_queue.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_queue.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/mcp/mcp_queue.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -1,733 +1,734 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_queue.php,v 1.7 2004/08/04 19:19:42 acydburn Exp $
-//
-// FILENAME  : mcp_queue.php
-// STARTED   : Mon Sep 02, 2003
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-class mcp_queue extends module
-{
-
-	function mcp_queue($id, $mode, $url)
-	{
-		global $_CLASS, $site_file_root, $config;
-
-		$forum_id = request_var('f', 0);
-		$start = request_var('start', 0);
-
-		switch ($mode)
-		{
-			case 'approve':
-			case 'disapprove':
-				require_once($site_file_root.'includes/forums/functions_messenger.php');
-				require_once($site_file_root.'includes/forums/functions_posting.php');
-
-				$post_id_list = request_var('post_id_list', array(0));
-
-				if (!sizeof($post_id_list))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
-
-				if ($mode == 'approve')
-				{
-					approve_post($post_id_list);
-				}
-				else
-				{
-					disapprove_post($post_id_list);
-				}
-
-				break;
-			
-			case 'approve_details':
-				
-				$_CLASS['core_user']->add_lang('posting');
-				require_once($site_file_root.'includes/forums/functions_posting.php');
-
-				$post_id = request_var('p', 0);
-				$topic_id = request_var('t', 0);
-
-				if ($topic_id)
-				{
-					$topic_info = get_topic_data(array($topic_id), 'm_approve');
-					$post_id = (int) $topic_info[$topic_id]['topic_first_post_id'];
-				}
-
-				$post_info = get_post_data(array($post_id), 'm_approve');
-
-				if (!sizeof($post_info))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
-
-				$post_info = $post_info[$post_id];
-
-				if ($post_info['topic_first_post_id'] != $post_id && topic_review($post_info['topic_id'], $post_info['forum_id'], 'topic_review', 0, false))
-				{
-					$_CLASS['core_template']->assign(array(
-						'S_TOPIC_REVIEW'	=> true,
-						'TOPIC_TITLE'		=> $post_info['topic_title'])
-					);
-				}
-
-				// Set some vars
-				$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
-
-				// Process message, leave it uncensored
-				$message = $post_info['post_text'];
-				if ($post_info['bbcode_bitfield'])
-				{
-					require_once($site_file_root.'includes/forums/bbcode.php');
-					$bbcode = new bbcode($post_info['bbcode_bitfield']);
-					$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
-				}
-				$message = smiley_text($message);
-
-				$_CLASS['core_template']->assign(array(
-					'S_MCP_QUEUE'			=> true,
-					'S_APPROVE_ACTION'		=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;p=$post_id&amp;f=$forum_id"),
-					
-					'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
-					'S_POST_REPORTED'		=> $post_info['post_reported'],
-					'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
-					'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
-//					'S_USER_NOTES'			=> ($post_info['user_notes']) ? true : false,
-					'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
-
-					'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
-					'U_MCP_USERNOTES'		=> generate_link('Forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
-					'U_MCP_WARNINGS'		=> generate_link('Forums&amp;file=mcp&amp;i=warnings&amp;mode=view_user&amp;u=' . $post_info['user_id']),
-					'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
-
-					'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
-					'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
-					'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
-
-					'POSTER_NAME'			=> $poster,
-					'POST_PREVIEW'			=> $message,
-					'POST_SUBJECT'			=> $post_info['post_subject'],
-					'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
-					'POST_IP'				=> $post_info['poster_ip'],
-					'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
-					'POST_ID'				=> $post_info['post_id'])
-				);
-
-				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_post.html');
-
-				break;
-
-			case 'unapproved_topics':
-			case 'unapproved_posts':
-				$forum_info = array();
-
-				$forum_list_approve = get_forum_list('m_approve', false, true);
-
-				if (!$forum_id)
-				{
-					$forum_list = array();
-					foreach ($forum_list_approve as $row)
-					{
-						$forum_list[] = $row['forum_id'];
-					}
-					
-					if (!$forum_list = implode(', ', $forum_list))
-					{
-						trigger_error('NOT_MODERATOR');
-					}
-
-					$sql = 'SELECT SUM(forum_topics) as sum_forum_topics 
-						FROM ' . FORUMS_TABLE . "
-						WHERE forum_id IN ($forum_list)";
-					$result = $_CLASS['core_db']->sql_query($sql);
-					$forum_info['forum_topics'] = (int) $_CLASS['core_db']->sql_fetchfield('sum_forum_topics', 0, $result);
-					$_CLASS['core_db']->sql_freeresult($result);
-
-				}
-				else
-				{
-					$forum_info = get_forum_data(array($forum_id), 'm_approve');
-
-					if (!sizeof($forum_info))
-					{
-						trigger_error('NOT_MODERATOR');
-					}
-
-					$forum_info = $forum_info[$forum_id];
-					$forum_list = $forum_id;
-				}
-
-				$forum_options = '<option value="0"' . (($forum_id == 0) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ALL_FORUMS'] . '</option>';
-				foreach ($forum_list_approve as $row)
-				{
-					$forum_options .= '<option value="' . $row['forum_id'] . '"' . (($forum_id == $row['forum_id']) ? ' selected="selected"' : '') . '>' . $row['forum_name'] . '</option>';
-				}
-
-				mcp_sorting($mode, $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
-				$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
-				$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
-
-				if ($mode == 'unapproved_posts')
-				{
-					$sql = 'SELECT p.post_id
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . USERS_TABLE . ' u' : '') . "
-						WHERE p.forum_id IN ($forum_list)
-							AND p.post_approved = 0
-							" . (($sort_order_sql{0} == 'u') ? 'AND u.user_id = p.poster_id' : '') . "
-							AND t.topic_id = p.topic_id
-							AND t.topic_first_post_id <> p.post_id
-						ORDER BY $sort_order_sql";
-					$result = $_CLASS['core_db']->sql_query_limit($sql, $config['topics_per_page'], $start);
-
-					$i = 0;
-					$post_ids = array();
-					while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-					{
-						$post_ids[] = $row['post_id'];
-						$row_num[$row['post_id']] = $i++;
-					}
-
-					if (sizeof($post_ids))
-					{
-						$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, p.post_id, p.post_username, p.poster_id, p.post_time, u.username
-							FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f, ' . TOPICS_TABLE . ' t, ' . USERS_TABLE . " u
-							WHERE p.post_id IN (" . implode(', ', $post_ids) . ")
-								AND t.topic_id = p.topic_id
-								AND f.forum_id = p.forum_id
-								AND u.user_id = p.poster_id";
-
-						$result = $_CLASS['core_db']->sql_query($sql);
-						$post_data = $rowset = array();
-						while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-						{
-							$post_data[$row['post_id']] = $row;
-						}
-						$_CLASS['core_db']->sql_freeresult($result);
-
-						foreach ($post_ids as $post_id)
-						{
-							$rowset[] = $post_data[$post_id];
-						}
-						unset($post_data, $post_ids);
-					}
-					else
-					{
-						$rowset = array();
-					}
-				}
-				else
-				{
-					$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, t.topic_time AS post_time, t.topic_poster AS poster_id, t.topic_first_post_id AS post_id, t.topic_first_poster_name AS username
-						FROM ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . " f
-						WHERE t.topic_approved = 0
-							AND t.forum_id IN ($forum_list)
-							AND f.forum_id = t.forum_id
-						ORDER BY $sort_order_sql";
-					$result = $_CLASS['core_db']->sql_query_limit($sql, $config['topics_per_page'], $start);
-
-					$rowset = array();
-					while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-					{
-						$rowset[] = $row;
-					}
-					$_CLASS['core_db']->sql_freeresult($result);
-				}
-
-				foreach ($rowset as $row)
-				{
-					if ($row['poster_id'] == ANONYMOUS)
-					{
-						$poster = (!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST'];
-					}
-					else
-					{
-						$poster = $row['username'];
-					}
-
-					$s_checkbox = '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" />';
-
-					$_CLASS['core_template']->assign_vars_array('postrow', array(
-						'U_VIEWFORUM'	=> generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']),
-						// Q: Why accessing the topic by a post_id instead of its topic_id?
-						// A: To prevent the post from being hidden because of wrong encoding or different charset
-						'U_VIEWTOPIC'	=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;p=' . $row['post_id'] . (($mode == 'unapproved_posts') ? '#' . $row['post_id'] : '')),
-						'U_VIEW_DETAILS'=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;start=$start&amp;mode=approve_details&amp;f={$forum_id}&amp;p={$row['post_id']}"),
-						'U_VIEWPROFILE'	=> ($row['poster_id'] != ANONYMOUS) ? generate_link("Members_List&amp;mode=viewprofile&amp;u={$row['poster_id']}") : '',
-
-						'FORUM_NAME'	=> $row['forum_name'],
-						'TOPIC_TITLE'	=> $row['topic_title'],
-						'POSTER'		=> $poster,
-						'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']),
-						'S_CHECKBOX'	=> $s_checkbox)
-					);
-				}
-				unset($rowset);
-
-				// Now display the page
-				$_CLASS['core_template']->assign(array(
-					'L_DISPLAY_ITEMS'		=> ($mode == 'unapproved_posts') ? $_CLASS['core_user']->lang['DISPLAY_POSTS'] : $_CLASS['core_user']->lang['DISPLAY_TOPICS'],
-					'S_FORUM_OPTIONS'		=> $forum_options)
-				);
-
-				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_queue.html');
-				break;
-		}
-	}
-
-	function install()
-	{
-	}
-
-	function uninstall()
-	{
-	}
-
-	function module()
-	{
-		$details = array(
-			'name'			=> 'MCP - Queue',
-			'description'	=> 'Module for management of items waiting for approval', 
-			'filename'		=> 'queue',
-			'version'		=> '0.1.0', 
-			'phpbbversion'	=> '2.2.0'
-		);
-		return $details;
-	}
-}
-
-// Approve Post/Topic
-function approve_post($post_id_list)
-{
-	global $_CLASS, $_CORE_CONFIG, $config;
-
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
-	{
-		trigger_error('NOT_AUTHORIZED');
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-	$success_msg = '';
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
-		'mode'			=> 'approve',
-		'redirect'		=> $redirect)
-	);
-
-	if (confirm_box(true))
-	{
-		$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
-	
-		$post_info = get_post_data($post_id_list, 'm_approve');
-		
-		// If Topic -> total_topics = total_topics+1, total_posts = total_posts+1, forum_topics = forum_topics+1, forum_posts = forum_posts+1
-		// If Post -> total_posts = total_posts+1, forum_posts = forum_posts+1, topic_replies = topic_replies+1
-		
-		$total_topics = $total_posts = $forum_topics = $forum_posts = 0;
-		$topic_approve_sql = $topic_replies_sql = $post_approve_sql = $topic_id_list = array();
-		
-		foreach ($post_info as $post_id => $post_data)
-		{
-			$topic_id_list[$post_data['topic_id']] = 1;
-			
-			// Topic or Post. ;)
-			if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_last_post_id'] == $post_id)
-			{
-				if ($post_data['forum_id'])
-				{
-					$total_topics++;
-					$forum_topics++;
-				}
-
-				$topic_approve_sql[] = $post_data['topic_id'];
-			}
-			else
-			{
-				if (!isset($topic_replies_sql[$post_data['topic_id']]))
-				{
-					$topic_replies_sql[$post_data['topic_id']] = 1;
-				}
-				else
-				{
-					$topic_replies_sql[$post_data['topic_id']]++;
-				}
-			}
-
-			if ($post_data['forum_id'])
-			{
-				$total_posts++;
-				$forum_posts++;
-			}
-
-			$post_approve_sql[] = $post_id;
-		}
-		
-		if (sizeof($topic_approve_sql))
-		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
-				SET topic_approved = 1
-				WHERE topic_id IN (' . implode(', ', $topic_approve_sql) . ')';
-			$_CLASS['core_db']->sql_query($sql);
-		}
-
-		if (sizeof($post_approve_sql))
-		{
-			$sql = 'UPDATE ' . POSTS_TABLE . '
-				SET post_approved = 1
-				WHERE post_id IN (' . implode(', ', $post_approve_sql) . ')';
-			$_CLASS['core_db']->sql_query($sql);
-		}
-
-		if (sizeof($topic_replies_sql))
-		{
-			foreach ($topic_replies_sql as $topic_id => $num_replies)
-			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . "
-					SET topic_replies = topic_replies + $num_replies
-					WHERE topic_id = $topic_id";
-				$_CLASS['core_db']->sql_query($sql);
-			}
-		}
-
-		if ($forum_topics || $forum_posts)
-		{
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
-				SET ';
-			$sql .= ($forum_topics) ? "forum_topics = forum_topics + $forum_topics" : '';
-			$sql .= ($forum_topics && $forum_posts) ? ', ' : '';
-			$sql .= ($forum_posts) ? "forum_posts = forum_posts + $forum_posts" : '';
-			$sql .= " WHERE forum_id = $forum_id";
-
-			$_CLASS['core_db']->sql_query($sql);
-		}
-		
-		if ($total_topics)
-		{
-			set_config('num_topics', $config['num_topics'] + $total_topics, true);
-		}
-
-		if ($total_posts)
-		{
-			set_config('num_posts', $config['num_posts'] + $total_posts, true);
-		}
-		unset($topic_approve_sql, $topic_replies_sql, $post_approve_sql);
-
-		update_post_information('topic', array_keys($topic_id_list));
-		update_post_information('forum', $forum_id);
-		unset($topic_id_list);
-		
-		$messenger = new messenger();
-
-		// Notify Poster?
-		if ($notify_poster)
-		{
-			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
-			foreach ($post_info as $post_id => $post_data)
-			{
-				if ($post_data['poster_id'] == ANONYMOUS)
-				{
-					continue;
-				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_approved' : 'post_approved';
-
-				$messenger->template($email_template, $post_data['user_lang']);
-
-				$messenger->replyto($config['board_email']);
-				$messenger->to($post_data['user_email'], $post_data['username']);
-				$messenger->im($post_data['user_jabber'], $post_data['username']);
-
-				$messenger->assign_vars(array(
-					'EMAIL_SIG'		=> $email_sig,
-					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
-					'USERNAME'		=> $post_data['username'],
-					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']),
-
-					'U_VIEW_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&t={$post_data['topic_id']}&e=0"),
-					'U_VIEW_POST'	=> generate_link("Forums&amp;file=viewtopic7amp;f=$forum_id&t={$post_data['topic_id']}&p=$post_id&e=$post_id"))
-				);
-
-				$messenger->send($post_data['user_notify_type']);
-				$messenger->reset();
-			}
-			$messenger->save_queue();
-		}
-
-		// Send out normal user notifications
-		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
-		foreach ($post_info as $post_id => $post_data)
-		{
-			if ($post_id == $post_data['topic_first_post_id'] && $post_id == $post_data['topic_last_post_id'])
-			{
-				// Forum Notifications
-				user_notification('post', $post_data['topic_title'], $post_data['topic_title'], $post_data['forum_name'], $forum_id, $post_data['topic_id'], $post_id);
-			}
-			else
-			{
-				// Topic Notifications
-				user_notification('reply', $post_data['post_subject'], $post_data['topic_title'], $post_data['forum_name'], $forum_id, $post_data['topic_id'], $post_id);
-			}
-		}
-		unset($post_info);
-
-		if ($forum_topics)
-		{
-			$success_msg = ($forum_topics == 1) ? 'TOPIC_APPROVED_SUCCESS' : 'TOPICS_APPROVED_SUCCESS';
-		}
-		else
-		{
-			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_APPROVED_SUCCESS' : 'POSTS_APPROVED_SUCCESS';
-		}
-	}
-	else
-	{
-		$_CLASS['core_template']->assign(array(
-			'S_NOTIFY_POSTER'	=> true,
-			'S_APPROVE'			=> true)
-		);
-
-		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, $redirect);
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
-	}
-}
-
-// Disapprove Post/Topic
-function disapprove_post($post_id_list)
-{
-	global $_CLASS, $_CORE_CONFIG, $config;
-
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
-	{
-		trigger_error('NOT_AUTHORIZED');
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-	$reason = request_var('reason', '');
-	$reason_id = request_var('reason_id', 0);
-	$success_msg = $additional_msg = '';
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
-		'mode'			=> 'disapprove',
-		'redirect'		=> $redirect)
-	);
-
-	$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
-
-	if ($reason_id)
-	{
-		$sql = 'SELECT reason_name 
-			FROM ' . REASONS_TABLE . " 
-			WHERE reason_id = $reason_id";
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		if (!($row = $_CLASS['core_db']->sql_fetchrow($result)) || (!$reason && $row['reason_name'] == 'other'))
-		{
-			$additional_msg = 'Please give an appropiate reason for disapproval';
-			unset($_POST['confirm']);
-		}
-		else
-		{
-			$disapprove_reason = ($row['reason_name'] != 'other') ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])] : '';
-			$disapprove_reason .= ($reason) ? "\n\n" . $_REQUEST['reason'] : '';
-			unset($reason);
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-	}
-
-	if (confirm_box(true))
-	{
-		$post_info = get_post_data($post_id_list, 'm_approve');
-		
-		// If Topic -> forum_topics_real -= 1
-		// If Post -> topic_replies_real -= 1
-		
-		$forum_topics_real = 0;
-		$topic_replies_real_sql = $post_disapprove_sql = $topic_id_list = array();
-		
-		foreach ($post_info as $post_id => $post_data)
-		{
-			$topic_id_list[$post_data['topic_id']] = 1;
-			
-			// Topic or Post. ;)
-			if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_last_post_id'] == $post_id)
-			{
-				if ($post_data['forum_id'])
-				{
-					$forum_topics_real++;
-				}
-			}
-			else
-			{
-				if (!isset($topic_replies_real_sql[$post_data['topic_id']]))
-				{
-					$topic_replies_real_sql[$post_data['topic_id']] = 1;
-				}
-				else
-				{
-					$topic_replies_real_sql[$post_data['topic_id']]++;
-				}
-			}
-
-			$post_disapprove_sql[] = $post_id;
-		}
-		
-		if ($forum_topics_real)
-		{
-			$sql = 'UPDATE ' . FORUMS_TABLE . "
-				SET forum_topics_real = forum_topics_real - $forum_topics_real
-				WHERE forum_id = $forum_id";
-			$_CLASS['core_db']->sql_query($sql);
-		}
-
-		if (sizeof($topic_replies_real_sql))
-		{
-			foreach ($topic_replies_real_sql as $topic_id => $num_replies)
-			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . "
-					SET topic_replies_real = topic_replies_real - $num_replies
-					WHERE topic_id = $topic_id";
-				$_CLASS['core_db']->sql_query($sql);
-			}
-		}
-
-		if (sizeof($post_disapprove_sql))
-		{
-			// We do not check for permissions here, because the moderator allowed approval/disapproval should be allowed to delete the disapproved posts
-			delete_posts('post_id', $post_disapprove_sql);
-		}
-		unset($post_disapprove_sql, $topic_replies_real_sql);
-
-		update_post_information('topic', array_keys($topic_id_list));
-		update_post_information('forum', $forum_id);
-		unset($topic_id_list);
-		
-		$messenger = new messenger();
-
-		// Notify Poster?
-		if ($notify_poster)
-		{
-			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
-			foreach ($post_info as $post_id => $post_data)
-			{
-				if ($post_data['poster_id'] == ANONYMOUS)
-				{
-					continue;
-				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_disapproved' : 'post_disapproved';
-
-				$messenger->template($email_template, $post_data['user_lang']);
-
-				$messenger->replyto($config['board_email']);
-				$messenger->to($post_data['user_email'], $post_data['username']);
-				$messenger->im($post_data['user_jabber'], $post_data['username']);
-
-				$messenger->assign_vars(array(
-					'EMAIL_SIG'		=> $email_sig,
-					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
-					'USERNAME'		=> $post_data['username'],
-					'REASON'		=> stripslashes($disapprove_reason),
-					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']))
-				);
-
-				$messenger->send($post_data['user_notify_type']);
-				$messenger->reset();
-			}
-			$messenger->save_queue();
-		}
-		unset($post_info, $disapprove_reason);
-
-		if ($forum_topics_real)
-		{
-			$success_msg = ($forum_topics_real == 1) ? 'TOPIC_DISAPPROVED_SUCCESS' : 'TOPICS_DISAPPROVED_SUCCESS';
-		}
-		else
-		{
-			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_DISAPPROVED_SUCCESS' : 'POSTS_DISAPPROVED_SUCCESS';
-		}
-	}
-	else
-	{
-		$sql = 'SELECT * 
-			FROM ' . REASONS_TABLE . ' 
-			ORDER BY reason_priority ASC';
-		$result = $_CLASS['core_db']->sql_query($sql);
-
-		while ($row = $_CLASS['core_db']->sql_fetchrow($result))
-		{
-			$row['reason_name'] = strtoupper($row['reason_name']);
-
-			$reason_title = (!empty($_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']] : ucwords(str_replace('_', ' ', $row['reason_name']));
-
-			$reason_desc = (!empty($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_desc'];
-
-			$_CLASS['core_template']->assign_vars_array('reason', array(
-				'ID'			=>	$row['reason_id'],
-				'NAME'			=>	htmlspecialchars($reason_title),
-				'DESCRIPTION'	=>	htmlspecialchars($reason_desc),
-				'S_SELECTED'	=>	($row['reason_id'] == $reason_id) ? true : false)
-			);
-		}
-		$_CLASS['core_db']->sql_freeresult($result);
-
-		$_CLASS['core_template']->assign(array(
-			'S_NOTIFY_POSTER'	=> true,
-			'S_APPROVE'			=> false,
-			'REASON'			=> $reason,
-			'ADDITIONAL_MSG'	=> $additional_msg)
-		);
-
-		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewforum&amp;f=$forum_id"));
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
-	}
-}
-
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_queue.php,v 1.7 2004/08/04 19:19:42 acydburn Exp $
+//
+// FILENAME  : mcp_queue.php
+// STARTED   : Mon Sep 02, 2003
+// COPYRIGHT : ? 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+class mcp_queue extends module
+{
+
+	function mcp_queue($id, $mode, $url)
+	{
+		global $_CLASS, $site_file_root, $config;
+
+		$forum_id = request_var('f', 0);
+		$start = request_var('start', 0);
+
+		switch ($mode)
+		{
+			case 'approve':
+			case 'disapprove':
+				require_once($site_file_root.'includes/forums/functions_messenger.php');
+				require_once($site_file_root.'includes/forums/functions_posting.php');
+
+				$post_id_list = request_var('post_id_list', array(0));
+
+				if (!sizeof($post_id_list))
+				{
+					trigger_error('NO_POST_SELECTED');
+				}
+
+				if ($mode == 'approve')
+				{
+					approve_post($post_id_list);
+				}
+				else
+				{
+					disapprove_post($post_id_list);
+				}
+
+				break;
+			
+			case 'approve_details':
+				
+				$_CLASS['core_user']->add_lang('posting');
+				require_once($site_file_root.'includes/forums/functions_posting.php');
+
+				$post_id = request_var('p', 0);
+				$topic_id = request_var('t', 0);
+
+				if ($topic_id)
+				{
+					$topic_info = get_topic_data(array($topic_id), 'm_approve');
+					$post_id = (int) $topic_info[$topic_id]['topic_first_post_id'];
+				}
+
+				$post_info = get_post_data(array($post_id), 'm_approve');
+
+				if (!sizeof($post_info))
+				{
+					trigger_error('NO_POST_SELECTED');
+				}
+
+				$post_info = $post_info[$post_id];
+
+				if ($post_info['topic_first_post_id'] != $post_id && topic_review($post_info['topic_id'], $post_info['forum_id'], 'topic_review', 0, false))
+				{
+					$_CLASS['core_template']->assign_array(array(
+						'S_TOPIC_REVIEW'	=> true,
+						'TOPIC_TITLE'		=> $post_info['topic_title'])
+					);
+				}
+
+				// Set some vars
+				$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
+
+				// Process message, leave it uncensored
+				$message = $post_info['post_text'];
+				if ($post_info['bbcode_bitfield'])
+				{
+					require_once($site_file_root.'includes/forums/bbcode.php');
+					$bbcode = new bbcode($post_info['bbcode_bitfield']);
+					$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+				}
+				$message = smiley_text($message);
+
+				$_CLASS['core_template']->assign_array(array(
+					'S_MCP_QUEUE'			=> true,
+					'S_APPROVE_ACTION'		=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;p=$post_id&amp;f=$forum_id"),
+					
+					'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
+					'S_POST_REPORTED'		=> $post_info['post_reported'],
+					'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
+					'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
+//					'S_USER_NOTES'			=> ($post_info['user_notes']) ? true : false,
+					'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
+
+					'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
+					'U_MCP_USERNOTES'		=> generate_link('Forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
+					'U_MCP_WARNINGS'		=> generate_link('Forums&amp;file=mcp&amp;i=warnings&amp;mode=view_user&amp;u=' . $post_info['user_id']),
+					'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
+
+					'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
+					'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
+					'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
+
+					'POSTER_NAME'			=> $poster,
+					'POST_PREVIEW'			=> $message,
+					'POST_SUBJECT'			=> $post_info['post_subject'],
+					'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
+					'POST_IP'				=> $post_info['poster_ip'],
+					'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
+					'POST_ID'				=> $post_info['post_id'])
+				);
+
+				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_post.html');
+
+				break;
+
+			case 'unapproved_topics':
+			case 'unapproved_posts':
+				$forum_info = array();
+
+				$forum_list_approve = get_forum_list('m_approve', false, true);
+
+				if (!$forum_id)
+				{
+					$forum_list = array();
+					foreach ($forum_list_approve as $row)
+					{
+						$forum_list[] = $row['forum_id'];
+					}
+					
+					if (!$forum_list = implode(', ', $forum_list))
+					{
+						trigger_error('NOT_MODERATOR');
+					}
+
+					$sql = 'SELECT SUM(forum_topics) as sum_forum_topics 
+						FROM ' . FORUMS_FORUMS_TABLE . "
+						WHERE forum_id IN ($forum_list)";
+					$result = $_CLASS['core_db']->query($sql);
+					$row = $_CLASS['core_db']->fetch_row_assoc($result);
+					$_CLASS['core_db']->free_result($result);
+
+					$forum_info['forum_topics'] = (int) $row['sum_forum_topics'];
+				}
+				else
+				{
+					$forum_info = get_forum_data(array($forum_id), 'm_approve');
+
+					if (!sizeof($forum_info))
+					{
+						trigger_error('NOT_MODERATOR');
+					}
+
+					$forum_info = $forum_info[$forum_id];
+					$forum_list = $forum_id;
+				}
+
+				$forum_options = '<option value="0"' . (($forum_id == 0) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ALL_FORUMS'] . '</option>';
+				foreach ($forum_list_approve as $row)
+				{
+					$forum_options .= '<option value="' . $row['forum_id'] . '"' . (($forum_id == $row['forum_id']) ? ' selected="selected"' : '') . '>' . $row['forum_name'] . '</option>';
+				}
+
+				mcp_sorting($mode, $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
+				$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
+				$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+
+				if ($mode == 'unapproved_posts')
+				{
+					$sql = 'SELECT p.post_id
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . USERS_TABLE . ' u' : '') . "
+						WHERE p.forum_id IN ($forum_list)
+							AND p.post_approved = 0
+							" . (($sort_order_sql{0} == 'u') ? 'AND u.user_id = p.poster_id' : '') . "
+							AND t.topic_id = p.topic_id
+							AND t.topic_first_post_id <> p.post_id
+						ORDER BY $sort_order_sql";
+					$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+
+					$i = 0;
+					$post_ids = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$post_ids[] = $row['post_id'];
+						$row_num[$row['post_id']] = $i++;
+					}
+
+					if (sizeof($post_ids))
+					{
+						$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, p.post_id, p.post_username, p.poster_id, p.post_time, u.username
+							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . " u
+							WHERE p.post_id IN (" . implode(', ', $post_ids) . ")
+								AND t.topic_id = p.topic_id
+								AND f.forum_id = p.forum_id
+								AND u.user_id = p.poster_id";
+
+						$result = $_CLASS['core_db']->query($sql);
+						$post_data = $rowset = array();
+						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+						{
+							$post_data[$row['post_id']] = $row;
+						}
+						$_CLASS['core_db']->free_result($result);
+
+						foreach ($post_ids as $post_id)
+						{
+							$rowset[] = $post_data[$post_id];
+						}
+						unset($post_data, $post_ids);
+					}
+					else
+					{
+						$rowset = array();
+					}
+				}
+				else
+				{
+					$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, t.topic_time AS post_time, t.topic_poster AS poster_id, t.topic_first_post_id AS post_id, t.topic_first_poster_name AS username
+						FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
+						WHERE t.topic_approved = 0
+							AND t.forum_id IN ($forum_list)
+							AND f.forum_id = t.forum_id
+						ORDER BY $sort_order_sql";
+					$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+
+					$rowset = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$rowset[] = $row;
+					}
+					$_CLASS['core_db']->free_result($result);
+				}
+
+				foreach ($rowset as $row)
+				{
+					if ($row['poster_id'] == ANONYMOUS)
+					{
+						$poster = (!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST'];
+					}
+					else
+					{
+						$poster = $row['username'];
+					}
+
+					$s_checkbox = '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" />';
+
+					$_CLASS['core_template']->assign_vars_array('postrow', array(
+						'U_VIEWFORUM'	=> generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']),
+						// Q: Why accessing the topic by a post_id instead of its topic_id?
+						// A: To prevent the post from being hidden because of wrong encoding or different charset
+						'U_VIEWTOPIC'	=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;p=' . $row['post_id'] . (($mode == 'unapproved_posts') ? '#' . $row['post_id'] : '')),
+						'U_VIEW_DETAILS'=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;start=$start&amp;mode=approve_details&amp;f={$forum_id}&amp;p={$row['post_id']}"),
+						'U_VIEWPROFILE'	=> ($row['poster_id'] != ANONYMOUS) ? generate_link("Members_List&amp;mode=viewprofile&amp;u={$row['poster_id']}") : '',
+
+						'FORUM_NAME'	=> $row['forum_name'],
+						'TOPIC_TITLE'	=> $row['topic_title'],
+						'POSTER'		=> $poster,
+						'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']),
+						'S_CHECKBOX'	=> $s_checkbox)
+					);
+				}
+				unset($rowset);
+
+				// Now display the page
+				$_CLASS['core_template']->assign_array(array(
+					'L_DISPLAY_ITEMS'		=> ($mode == 'unapproved_posts') ? $_CLASS['core_user']->lang['DISPLAY_POSTS'] : $_CLASS['core_user']->lang['DISPLAY_TOPICS'],
+					'S_FORUM_OPTIONS'		=> $forum_options)
+				);
+
+				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_queue.html');
+				break;
+		}
+	}
+
+	function install()
+	{
+	}
+
+	function uninstall()
+	{
+	}
+
+	function module()
+	{
+		$details = array(
+			'name'			=> 'MCP - Queue',
+			'description'	=> 'Module for management of items waiting for approval', 
+			'filename'		=> 'queue',
+			'version'		=> '0.1.0', 
+			'phpbbversion'	=> '2.2.0'
+		);
+		return $details;
+	}
+}
+
+// Approve Post/Topic
+function approve_post($post_id_list)
+{
+	global $_CLASS, $_CORE_CONFIG, $config;
+
+	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
+	{
+		trigger_error('NOT_AUTHORIZED');
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$success_msg = '';
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'post_id_list'	=> $post_id_list,
+		'f'				=> $forum_id,
+		'mode'			=> 'approve',
+		'redirect'		=> $redirect)
+	);
+
+	if (confirm_box(true))
+	{
+		$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
+	
+		$post_info = get_post_data($post_id_list, 'm_approve');
+		
+		// If Topic -> total_topics = total_topics+1, total_posts = total_posts+1, forum_topics = forum_topics+1, forum_posts = forum_posts+1
+		// If Post -> total_posts = total_posts+1, forum_posts = forum_posts+1, topic_replies = topic_replies+1
+		
+		$total_topics = $total_posts = $forum_topics = $forum_posts = 0;
+		$topic_approve_sql = $topic_replies_sql = $post_approve_sql = $topic_id_list = array();
+		
+		foreach ($post_info as $post_id => $post_data)
+		{
+			$topic_id_list[$post_data['topic_id']] = 1;
+			
+			// Topic or Post. ;)
+			if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_last_post_id'] == $post_id)
+			{
+				if ($post_data['forum_id'])
+				{
+					$total_topics++;
+					$forum_topics++;
+				}
+
+				$topic_approve_sql[] = $post_data['topic_id'];
+			}
+			else
+			{
+				if (!isset($topic_replies_sql[$post_data['topic_id']]))
+				{
+					$topic_replies_sql[$post_data['topic_id']] = 1;
+				}
+				else
+				{
+					$topic_replies_sql[$post_data['topic_id']]++;
+				}
+			}
+
+			if ($post_data['forum_id'])
+			{
+				$total_posts++;
+				$forum_posts++;
+			}
+
+			$post_approve_sql[] = $post_id;
+		}
+		
+		if (sizeof($topic_approve_sql))
+		{
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+				SET topic_approved = 1
+				WHERE topic_id IN (' . implode(', ', $topic_approve_sql) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+
+		if (sizeof($post_approve_sql))
+		{
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET post_approved = 1
+				WHERE post_id IN (' . implode(', ', $post_approve_sql) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+
+		if (sizeof($topic_replies_sql))
+		{
+			foreach ($topic_replies_sql as $topic_id => $num_replies)
+			{
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
+					SET topic_replies = topic_replies + $num_replies
+					WHERE topic_id = $topic_id";
+				$_CLASS['core_db']->query($sql);
+			}
+		}
+
+		if ($forum_topics || $forum_posts)
+		{
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+				SET ';
+			$sql .= ($forum_topics) ? "forum_topics = forum_topics + $forum_topics" : '';
+			$sql .= ($forum_topics && $forum_posts) ? ', ' : '';
+			$sql .= ($forum_posts) ? "forum_posts = forum_posts + $forum_posts" : '';
+			$sql .= " WHERE forum_id = $forum_id";
+
+			$_CLASS['core_db']->query($sql);
+		}
+		
+		if ($total_topics)
+		{
+			set_config('num_topics', $config['num_topics'] + $total_topics, true);
+		}
+
+		if ($total_posts)
+		{
+			set_config('num_posts', $config['num_posts'] + $total_posts, true);
+		}
+		unset($topic_approve_sql, $topic_replies_sql, $post_approve_sql);
+
+		update_post_information('topic', array_keys($topic_id_list));
+		update_post_information('forum', $forum_id);
+		unset($topic_id_list);
+		
+		$messenger = new messenger();
+
+		// Notify Poster?
+		if ($notify_poster)
+		{
+			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
+		
+			foreach ($post_info as $post_id => $post_data)
+			{
+				if ($post_data['poster_id'] == ANONYMOUS)
+				{
+					continue;
+				}
+				
+				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_approved' : 'post_approved';
+
+				$messenger->template($email_template, $post_data['user_lang']);
+
+				$messenger->replyto($config['board_email']);
+				$messenger->to($post_data['user_email'], $post_data['username']);
+				$messenger->im($post_data['user_jabber'], $post_data['username']);
+
+				$messenger->assign_vars(array(
+					'EMAIL_SIG'		=> $email_sig,
+					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
+					'USERNAME'		=> $post_data['username'],
+					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
+					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']),
+
+					'U_VIEW_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&t={$post_data['topic_id']}&e=0"),
+					'U_VIEW_POST'	=> generate_link("Forums&amp;file=viewtopic7amp;f=$forum_id&t={$post_data['topic_id']}&p=$post_id&e=$post_id"))
+				);
+
+				$messenger->send($post_data['user_notify_type']);
+				$messenger->reset();
+			}
+			$messenger->save_queue();
+		}
+
+		// Send out normal user notifications
+		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
+		
+		foreach ($post_info as $post_id => $post_data)
+		{
+			if ($post_id == $post_data['topic_first_post_id'] && $post_id == $post_data['topic_last_post_id'])
+			{
+				// Forum Notifications
+				user_notification('post', $post_data['topic_title'], $post_data['topic_title'], $post_data['forum_name'], $forum_id, $post_data['topic_id'], $post_id);
+			}
+			else
+			{
+				// Topic Notifications
+				user_notification('reply', $post_data['post_subject'], $post_data['topic_title'], $post_data['forum_name'], $forum_id, $post_data['topic_id'], $post_id);
+			}
+		}
+		unset($post_info);
+
+		if ($forum_topics)
+		{
+			$success_msg = ($forum_topics == 1) ? 'TOPIC_APPROVED_SUCCESS' : 'TOPICS_APPROVED_SUCCESS';
+		}
+		else
+		{
+			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_APPROVED_SUCCESS' : 'POSTS_APPROVED_SUCCESS';
+		}
+	}
+	else
+	{
+		$_CLASS['core_template']->assign_array(array(
+			'S_NOTIFY_POSTER'	=> true,
+			'S_APPROVE'			=> true)
+		);
+
+		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	if (!$success_msg)
+	{
+		url_redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+	}
+}
+
+// Disapprove Post/Topic
+function disapprove_post($post_id_list)
+{
+	global $_CLASS, $_CORE_CONFIG, $config;
+
+	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
+	{
+		trigger_error('NOT_AUTHORIZED');
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$reason = request_var('reason', '');
+	$reason_id = request_var('reason_id', 0);
+	$success_msg = $additional_msg = '';
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'post_id_list'	=> $post_id_list,
+		'f'				=> $forum_id,
+		'mode'			=> 'disapprove',
+		'redirect'		=> $redirect)
+	);
+
+	$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
+
+	if ($reason_id)
+	{
+		$sql = 'SELECT reason_name 
+			FROM ' . REASONS_TABLE . " 
+			WHERE reason_id = $reason_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)) || (!$reason && $row['reason_name'] == 'other'))
+		{
+			$additional_msg = 'Please give an appropiate reason for disapproval';
+			unset($_POST['confirm']);
+		}
+		else
+		{
+			$disapprove_reason = ($row['reason_name'] != 'other') ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])] : '';
+			$disapprove_reason .= ($reason) ? "\n\n" . $_REQUEST['reason'] : '';
+			unset($reason);
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	if (confirm_box(true))
+	{
+		$post_info = get_post_data($post_id_list, 'm_approve');
+		
+		// If Topic -> forum_topics_real -= 1
+		// If Post -> topic_replies_real -= 1
+		
+		$forum_topics_real = 0;
+		$topic_replies_real_sql = $post_disapprove_sql = $topic_id_list = array();
+		
+		foreach ($post_info as $post_id => $post_data)
+		{
+			$topic_id_list[$post_data['topic_id']] = 1;
+			
+			// Topic or Post. ;)
+			if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_last_post_id'] == $post_id)
+			{
+				if ($post_data['forum_id'])
+				{
+					$forum_topics_real++;
+				}
+			}
+			else
+			{
+				if (!isset($topic_replies_real_sql[$post_data['topic_id']]))
+				{
+					$topic_replies_real_sql[$post_data['topic_id']] = 1;
+				}
+				else
+				{
+					$topic_replies_real_sql[$post_data['topic_id']]++;
+				}
+			}
+
+			$post_disapprove_sql[] = $post_id;
+		}
+		
+		if ($forum_topics_real)
+		{
+			$sql = 'UPDATE ' . FORUMS_TABLE . "
+				SET forum_topics_real = forum_topics_real - $forum_topics_real
+				WHERE forum_id = $forum_id";
+			$_CLASS['core_db']->query($sql);
+		}
+
+		if (sizeof($topic_replies_real_sql))
+		{
+			foreach ($topic_replies_real_sql as $topic_id => $num_replies)
+			{
+				$sql = 'UPDATE ' . TOPICS_TABLE . "
+					SET topic_replies_real = topic_replies_real - $num_replies
+					WHERE topic_id = $topic_id";
+				$_CLASS['core_db']->query($sql);
+			}
+		}
+
+		if (sizeof($post_disapprove_sql))
+		{
+			// We do not check for permissions here, because the moderator allowed approval/disapproval should be allowed to delete the disapproved posts
+			delete_posts('post_id', $post_disapprove_sql);
+		}
+		unset($post_disapprove_sql, $topic_replies_real_sql);
+
+		update_post_information('topic', array_keys($topic_id_list));
+		update_post_information('forum', $forum_id);
+		unset($topic_id_list);
+		
+		$messenger = new messenger();
+
+		// Notify Poster?
+		if ($notify_poster)
+		{
+			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
+		
+			foreach ($post_info as $post_id => $post_data)
+			{
+				if ($post_data['poster_id'] == ANONYMOUS)
+				{
+					continue;
+				}
+				
+				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_disapproved' : 'post_disapproved';
+
+				$messenger->template($email_template, $post_data['user_lang']);
+
+				$messenger->replyto($config['board_email']);
+				$messenger->to($post_data['user_email'], $post_data['username']);
+				$messenger->im($post_data['user_jabber'], $post_data['username']);
+
+				$messenger->assign_vars(array(
+					'EMAIL_SIG'		=> $email_sig,
+					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
+					'USERNAME'		=> $post_data['username'],
+					'REASON'		=> stripslashes($disapprove_reason),
+					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
+					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']))
+				);
+
+				$messenger->send($post_data['user_notify_type']);
+				$messenger->reset();
+			}
+			$messenger->save_queue();
+		}
+		unset($post_info, $disapprove_reason);
+
+		if ($forum_topics_real)
+		{
+			$success_msg = ($forum_topics_real == 1) ? 'TOPIC_DISAPPROVED_SUCCESS' : 'TOPICS_DISAPPROVED_SUCCESS';
+		}
+		else
+		{
+			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_DISAPPROVED_SUCCESS' : 'POSTS_DISAPPROVED_SUCCESS';
+		}
+	}
+	else
+	{
+		$sql = 'SELECT * 
+			FROM ' . REASONS_TABLE . ' 
+			ORDER BY reason_priority ASC';
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$row['reason_name'] = strtoupper($row['reason_name']);
+
+			$reason_title = (!empty($_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']] : ucwords(str_replace('_', ' ', $row['reason_name']));
+
+			$reason_desc = (!empty($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_desc'];
+
+			$_CLASS['core_template']->assign_vars_array('reason', array(
+				'ID'			=>	$row['reason_id'],
+				'NAME'			=>	htmlspecialchars($reason_title),
+				'DESCRIPTION'	=>	htmlspecialchars($reason_desc),
+				'S_SELECTED'	=>	($row['reason_id'] == $reason_id) ? true : false)
+			);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		$_CLASS['core_template']->assign_array(array(
+			'S_NOTIFY_POSTER'	=> true,
+			'S_APPROVE'			=> false,
+			'REASON'			=> $reason,
+			'ADDITIONAL_MSG'	=> $additional_msg)
+		);
+
+		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	if (!$success_msg)
+	{
+		url_redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewforum&amp;f=$forum_id"));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -41,7 +41,7 @@
 	}
 }
 
-require_once($site_file_root.'includes/forums/bbcode.php');
+require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 
 // BBCODE_FIRSTPASS
 //
@@ -89,6 +89,7 @@
 			// Because we add bbcode_uid to all tags, the message length
 			// will increase whenever a tag is found
 			$new_size = strlen($this->message);
+
 			if ($size != $new_size)
 			{
 				$this->bbcode_bitfield |= (1 << $bbcode_data['bbcode_id']);
@@ -122,11 +123,14 @@
 		
 		$this->parsed_items = array('code' => 0, 'quote' => 0, 'attachment' => 0, 'b' => 0, 'i' => 0, 'url' => 0, 'img' => 0, 'size' => 0, 'color' => 0, 'u' => 0, 'list' => 0, 'email' => 0, 'flash' => 0);
 		
+		/*
 		if (!is_array($rowset))
 		{
-			global $_CLASS;
 			$rowset = array();
 
+			
+			global $_CLASS;
+
 			$sql = 'SELECT bbcode_id, bbcode_tag, first_pass_match, first_pass_replace
 				FROM ' . FORUMS_BBCODES_TABLE;
 
@@ -136,6 +140,7 @@
 				$rowset[] = $row;
 			}
 			$_CLASS['core_db']->free_result($result);
+			
 		}
 		
 		foreach ($rowset as $row)
@@ -145,6 +150,7 @@
 				'regexp'	=>	array($row['first_pass_match'] => str_replace('$uid', $this->bbcode_uid, $row['first_pass_replace']))
 			);
 		}
+		*/
 	}
 	
 	function check_bbcode($bbcode, &$in)
@@ -301,52 +307,57 @@
 			{
 				case 'php':
 					$remove_tags = false;
-					$str_from = array('&lt;', '&gt;');
-					$str_to = array('<', '>');
 
+					$str_from = array('&lt;', '&gt;', '&amp;', '&quot;', '&\#039;', '&nbsp;');
+					$str_to = array('<', '>', '&', '"', "'", ' ');
+
 					$code = str_replace($str_from, $str_to, $code);
-					if (!preg_match('/^\<\?.*?\?\>/is', $code))
-					{
-						$remove_tags = true;
-						$code = "<?php $code ?>";
+
+					if (!preg_match('/^\<\?(.*?)\?\>/is', $code))
+					{
+						$remove_tags = true;
+						$code = "<?php $code";
 					}
 
-					$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
+					
+					$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
+
 					foreach ($conf as $ini_var)
 					{
 						ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));
 					}
 					
-					// Because highlight_string is specialcharing the text (but we already did this before), we have to reverse this in order to get correct results
-					$code = strtr($code, array_flip(get_html_translation_table(HTML_ENTITIES)));
-  	                                         
-					ob_start();
-					highlight_string($code);
-					$code = ob_get_contents();
-					ob_end_clean();
 
-					$str_from = array('<font color="syntax', '</font>', '<code>', '</code>','[', ']', '.', ':');
-					$str_to = array('<span class="syntax', '</span>', '', '', '&#91;', '&#93;', '&#46;', '&#58');
+					$code = highlight_string($code, true);
 
-					if ($remove_tags)
+					if (version_compare(PHP_VERSION, '5.0', '<'))
 					{
-						$str_from[] = '<span class="syntaxdefault">&lt;?php </span>';
-						$str_to[] = '';
-						$str_from[] = '<span class="syntaxdefault">&lt;?php ';
-						$str_to[] = '<span class="syntaxdefault">';
+						$code = str_replace('<font color="syntax', '<span class="syntax', $code);
+						$code = str_replace('<font color="', '<span style="color: ', $code);
+						$code = str_replace('</font>', '</span>', $code);
 					}
+					else
+					{
+						$code = str_replace('<span style="color: syntax', '<span class="syntax', $code);
+					}
 
+					$str_from = array('<code>', '</code>','[', ']', '.', ':', '&amp;#058;');
+					$str_to = array('', '', '&#91;', '&#93;', '&#46;', '&#58', '&#058;');
+
 					$code = str_replace($str_from, $str_to, $code);
-					$code = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#is', '$1$2$3', $code);
-
-					if ($remove_tags)
-					{
-						$code = preg_replace('#(<span class="[a-z]+">)?\?&gt;</span>#', '', $code);
+
+					if ($remove_tags)
+					{
+						// if theres any problems with this, find the first "php" without span remove it
+						// then find the first </span> and remove it
+						$pos = ($pos = mb_strpos($code, 'php&nbsp;</span>')) ? $pos + 16 : mb_strpos($code, 'php </span>') + 16;
+						$code = mb_substr($code, $pos);
 					}
-
-					$code = preg_replace('#^<span class="[a-z]+"><span class="([a-z]+)">(.*)</span></span>#s', '<span class="$1">$2</span>', $code);
-					$code = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*</span>$#', '</span>', $code);
-
+									
+					$code = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#is', '$1$2$3', $code);
+					$code = preg_replace('#^<span class="[a-z]+"><span class="([a-z]+)">(.*)</span></span>#s', '<span class="$1">$2</span>', $code);
+					$code = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*</span>$#', '</span>', $code);
+				
 					$out .= "[code=$stx:" . $this->bbcode_uid . ']' . trim($code) . '[/code:' . $this->bbcode_uid . ']';
 				break;
 
@@ -355,6 +366,7 @@
 					$str_to = array('&lt;', '&gt;', '&#91;', '&#93;', '&#46;', '&#58');
 
 					$out .= '[code:' . $this->bbcode_uid . ']' . str_replace($str_from, $str_to, $code) . '[/code:' . $this->bbcode_uid . ']';
+				break;
 			}
 
 			if (preg_match('#(.*?)\[code(?:=([a-z]+))?\](.+)#is', $in, $m))
@@ -756,8 +768,7 @@
 		// Parse smilies
 		if ($allow_smilies)
 		{	
-$config['max_' . $mode . '_smilies'] = 0;
-			$this->smilies($config['max_' . $mode . '_smilies']);
+			$this->smilies(isset($config['max_' . $mode . '_smilies']) ? $config['max_' . $mode . '_smilies'] : 0);
 		}
 		$num_urls = 0;
 		
@@ -765,7 +776,9 @@
 		if ($allow_bbcode && strpos($this->message, '[') !== false)
 		{
 			$this->bbcode_init();
+
 			$disallow = array('img', 'flash', 'quote');
+
 			foreach ($disallow as $bool)
 			{
 				if (!${'allow_' . $bool . '_bbcode'})
@@ -782,8 +795,8 @@
 		if ($allow_magic_url)
 		{
 			$this->magic_url();
-$config['max_' . $mode . '_urls'] = 0;
-			if ($config['max_' . $mode . '_urls'])
+
+			if (isset($config['max_' . $mode . '_urls']) && $config['max_' . $mode . '_urls'])
 			{
 				$num_urls += preg_match_all('#\<!-- (l|m|w|e) --\>.*?\<!-- \1 --\>#', $this->message, $matches);
 			}
@@ -982,11 +995,11 @@
 	// Parse Attachments
 	function parse_attachments($form_name, $mode, $forum_id, $submit, $preview, $refresh, $is_message = false)
 	{
-		global $config, $_CLASS, $site_file_root, $forum_id;
+		global $config, $_CLASS, $forum_id;
 
 		$error = array();
 
-		$num_attachments = sizeof($this->attachment_data);
+		$num_attachments = count($this->attachment_data);
 		$this->filename_data['filecomment'] = request_var('filecomment', '', true);
 		$upload_file = (isset($_FILES[$form_name]) && $_FILES[$form_name]['name'] != 'none' && trim($_FILES[$form_name]['name'])) ? true : false;
 		
@@ -1006,7 +1019,7 @@
 				
 				$error = $filedata['error'];
 
-				if ($filedata['post_attach'] && !sizeof($error))
+				if ($filedata['post_attach'] && empty($error))
 				{
 					$new_entry = array(
 						'physical_filename'	=> $filedata['physical_filename'],
@@ -1022,7 +1035,7 @@
 
 					$this->attachment_data = array_merge(array(0 => $new_entry), $this->attachment_data);
 					$this->message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', "'[attachment='.(\\1 + 1).']\\2[/attachment]'", $this->message);
-					
+
 					$this->filename_data['filecomment'] = '';
 
 					// This Variable is set to false here, because Attachments are entered into the

Modified: cms/trunk/includes/templates/modules/Forums/attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/attachments.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/attachments.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -3,22 +3,32 @@
 		<span class="postbody">[ { $attachments:lang }]</span><br /><br />
 	<!-- ELSEIF { $attachments:category } == 'IMAGE' -->
 		<!-- IF { $attachments:comment } -->
-		<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachments:comment }</span><hr />
-		<!-- ENDIF -->		<img src="{ $attachments:image_src }" alt="{ $attachments:name }" /></span>
-		<br /><span class="gensmall"><strong>{ $attachments:name }</strong><br/> { $L_VIEWED } { $attachments:lang_views } </span>
+			<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachments:comment }</span><hr />
+		<!-- ENDIF -->
+		<img src="{ $attachments:image_src }" alt="{ $attachments:name }" />
+		<br />
+		<span class="gensmall">
+			<strong>{ $attachments:name }</strong>
+			<br/> { $L_VIEWED } { $attachments:lang_views }
+		</span>
 	<!-- ELSEIF { $attachments:category } == 'THUMBNAIL' -->
 		<!-- IF { $attachments:comment } -->
-		<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachments:comment }</span><hr />
-		<!-- ENDIF -->		<a href="{ $attachments:link }" target="_blank"><img src="{ $attachments:image_src }" alt="{ $attachments:name }" border="0" /></a></span>
-		<br /><span class="gensmall"><strong>{ $attachments:name }</strong><br/> { $L_VIEWED } { $attachments:lang_views } </span>
+			<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachments:comment }</span><hr />
+		<!-- ENDIF -->
+		<a href="{ $attachments:link }" target="_blank"><img src="{ $attachments:image_src }" alt="{ $attachments:name }" border="0" /></a></span>
+		<br />
+		<span class="gensmall">
+			<strong>{ $attachments:name }</strong>
+			<br />{ $L_VIEWED } { $attachments:lang_views }
+		</span>
 	<!-- ELSE -->
 		<!-- IF { $attachments:comment } -->
 		<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $attachments:comment }</span><hr />
 		<!-- ENDIF -->
 		<!-- IF { $attachments:icon } --><img src="{ $attachments:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $attachments:link }" target="_blank">{ $attachments:name }</a>
 		<span class="gensmall">
-		<br />{ $L_FILESIZE } { $attachments:lang_size }
-		<br />{ $L_DOWNLOADED } { $attachments:lang_views }
+			<br />{ $L_FILESIZE } { $attachments:lang_size }
+			<br />{ $L_DOWNLOADED } { $attachments:lang_views }
 		</span>
 	<!-- ENDIF -->
 <!-- ENDLOOP $attachments -->

Deleted: cms/trunk/includes/templates/modules/Forums/editor.js
===================================================================
--- cms/trunk/includes/templates/modules/Forums/editor.js	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/editor.js	2005-09-19 18:40:49 UTC (rev 132)
@@ -1,361 +0,0 @@
-// bbCode control by subBlue design [ www.subBlue.com ]
-// Includes unixsafe colour palette selector by SHS`
-
-// Startup variables
-var imageTag = false;
-var theSelection = false;
-
-// Check for Browser & Platform for PC & IE specific bits
-// More details from: http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html
-var clientPC = navigator.userAgent.toLowerCase(); // Get client info
-var clientVer = parseInt(navigator.appVersion); // Get browser version
-
-var is_ie = ((clientPC.indexOf("msie") != -1) && (clientPC.indexOf("opera") == -1));
-var is_nav = ((clientPC.indexOf('mozilla')!=-1) && (clientPC.indexOf('spoofer')==-1)
-                && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera')==-1)
-                && (clientPC.indexOf('webtv')==-1) && (clientPC.indexOf('hotjava')==-1));
-
-var is_win = ((clientPC.indexOf("win")!=-1) || (clientPC.indexOf("16bit") != -1));
-var is_mac = (clientPC.indexOf("mac")!=-1);
-
-// Shows the help messages in the helpline window
-function helpline(help) {
-	document.forms[form_name].helpbox.value = eval(help + "_help");
-}
-
-// Replacement for arrayname.length property
-function getarraysize(thearray) {
-	for (i = 0; i < thearray.length; i++) {
-		if ((thearray[i] == "undefined") || (thearray[i] == "") || (thearray[i] == null))
-			return i;
-		}
-	return thearray.length;
-}
-
-// Replacement for arrayname.push(value) not implemented in IE until version 5.5
-// Appends element to the array
-function arraypush(thearray,value) {
-	thearray[ getarraysize(thearray) ] = value;
-}
-
-// Replacement for arrayname.pop() not implemented in IE until version 5.5
-// Removes and returns the last element of an array
-function arraypop(thearray) {
-	thearraysize = getarraysize(thearray);
-	retval = thearray[thearraysize - 1];
-	delete thearray[thearraysize - 1];
-	return retval;
-}
-
-function smiley(text) {
-	text = ' ' + text + ' ';
-	if (document.forms[form_name].elements[text_name].createTextRange && document.forms[form_name].elements[text_name].caretPos) {
-		var caretPos = document.forms[form_name].elements[text_name].caretPos;
-
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-		document.forms[form_name].elements[text_name].focus();
-	} else {
-		var selStart = document.forms[form_name].elements[text_name].selectionStart;
-		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
-
-		mozWrap(document.forms[form_name].elements[text_name], text, '')
-		document.forms[form_name].elements[text_name].focus();
-		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
-		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
-	}
-}
-
-function bbfontstyle(bbopen, bbclose) {
-	if ((clientVer >= 4) && is_ie && is_win) {
-		theSelection = document.selection.createRange().text;
-		if (!theSelection) {
-			insert_text(bbopen + bbclose);
-			document.forms[form_name].elements[text_name].focus();
-			return;
-		}
-		document.selection.createRange().text = bbopen + theSelection + bbclose;
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	} else {
-		insert_text(bbopen + bbclose);
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-	storeCaret(document.forms[form_name].elements[text_name]);
-}
-
-function insert_text(text) {
-	if (document.forms[form_name].elements[text_name].createTextRange && document.forms[form_name].elements[text_name].caretPos) {
-		var caretPos = document.forms[form_name].elements[text_name].caretPos;
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-	} else {
-		var selStart = document.forms[form_name].elements[text_name].selectionStart;
-		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
-
-		mozWrap(document.forms[form_name].elements[text_name], text, '')
-		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
-		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
-	}
-}
-
-function attach_inline() {
-	insert_text('[attachment=' + document.forms[form_name].elements['attachments'].value + ']' + document.forms[form_name].elements['attachments'].options[document.forms[form_name].elements['attachments'].selectedIndex].text + '[/attachment]');
-	document.forms[form_name].elements[text_name].focus();
-}
-
-function addquote(post_id, username) {
-
-	var message_name = 'message_' + post_id;
-	var theSelection = '';
-	var divarea = false;
-
-	if (document.all)
-	{
-		eval("divarea = document.all." + message_name + ";");
-	}
-	else
-	{
-		eval("divarea = document.getElementById('" + message_name + "');");
-	}
-
-	// Get text selection - not only the post content :(
-	if (window.getSelection)
-	{
-		theSelection = window.getSelection().toString();
-	}
-	else if (document.getSelection)
-	{
-		theSelection = document.getSelection();
-	}
-	else if (document.selection)
-	{
-		theSelection = document.selection.createRange().text;
-	}
-
-	if (theSelection == '')
-	{
-		if (document.all)
-		{
-			theSelection = divarea.innerText;
-		}
-		else if (divarea.textContent)
-		{
-			theSelection = divarea.textContent;
-		}
-		else if (divarea.firstChild.nodeValue)
-		{
-			theSelection = divarea.firstChild.nodeValue;
-		}
-	}
-	
-	if (theSelection)
-	{
-		insert_text('[quote="' + username + '"]' + theSelection + '[/quote]');
-	}
-
-	return;
-}
-
-function bbstyle(bbnumber) {
-
-	donotinsert = false;
-	theSelection = false;
-	bblast = 0;
-	document.forms[form_name].elements[text_name].focus();
-
-	if (bbnumber == -1) { // Close all open tags & default button names
-		while (bbcode[0]) {
-			butnumber = arraypop(bbcode) - 1;
-			document.forms[form_name].elements[text_name].value += bbtags[butnumber + 1];
-			buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
-			if (buttext != "[*]")
-			{
-				eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
-			}
-		}
-		document.forms[form_name].addbbcode10.value = "List";
-		bbtags[10] = "[list]";
-		document.forms[form_name].addbbcode12.value = "List=";
-		bbtags[12] = "[list=]";
-		imageTag = false; // All tags are closed including image tags :D
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-
-	if ((clientVer >= 4) && is_ie && is_win)
-	{
-		theSelection = document.selection.createRange().text; // Get text selection
-		if (theSelection) {
-			// Add tags around selection
-			document.selection.createRange().text = bbtags[bbnumber] + theSelection + bbtags[bbnumber+1];
-			document.forms[form_name].elements[text_name].focus();
-			theSelection = '';
-			return;
-		}
-	}
-	else if (document.forms[form_name].elements[text_name].selectionEnd && (document.forms[form_name].elements[text_name].selectionEnd - document.forms[form_name].elements[text_name].selectionStart > 0))
-	{
-		mozWrap(document.forms[form_name].elements[text_name], bbtags[bbnumber], bbtags[bbnumber+1]);
-		document.forms[form_name].elements[text_name].focus();
-		theSelection = '';
-		return;
-	}
-
-	// Find last occurance of an open tag the same as the one just clicked
-	for (i = 0; i < bbcode.length; i++) {
-		if (bbcode[i] == bbnumber+1) {
-			bblast = i;
-			donotinsert = true;
-		}
-	}
-
-	if ((bbnumber == 10) && (bbtags[10] != "[*]"))
-	{
-		if (donotinsert)
-		{
-			document.forms[form_name].addbbcode12.value = "List=";
-			tmp_help = o_help;
-			o_help = e_help;
-			e_help = tmp_help;
-			bbtags[12] = "[list=]";
-		}
-		else
-		{
-			document.forms[form_name].addbbcode12.value = "[*]";
-			tmp_help = o_help;
-			o_help = e_help;
-			e_help = tmp_help;
-			bbtags[12] = "[*]";
-		}
-	}
-
-	if ((bbnumber == 12) && (bbtags[12] != "[*]"))
-	{
-		if (donotinsert)
-		{
-			document.forms[form_name].addbbcode10.value = "List";
-			tmp_help = l_help;
-			l_help = e_help;
-			e_help = tmp_help;
-			bbtags[10] = "[list]";
-		}
-		else
-		{
-			document.forms[form_name].addbbcode10.value = "[*]";
-			tmp_help = l_help;
-			l_help = e_help;
-			e_help = tmp_help;
-			bbtags[10] = "[*]";
-		}
-	}
-
-	if (donotinsert) {		// Close all open tags up to the one just clicked & default button names
-		while (bbcode[bblast]) {
-				butnumber = arraypop(bbcode) - 1;
-				if (bbtags[butnumber] != "[*]")
-				{
-					insert_text(bbtags[butnumber + 1]);
-				}
-				else
-				{
-					insert_text(bbtags[butnumber]);
-				}
-				buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
-				if (bbtags[butnumber] != "[*]")
-				{
-					eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
-				}
-				imageTag = false;
-			}
-			document.forms[form_name].elements[text_name].focus();
-			return;
-	} else { // Open tags
-
-		if (imageTag && (bbnumber != 14)) {		// Close image tag before adding another
-			insert_text(bbtags[15]);
-
-			lastValue = arraypop(bbcode) - 1;	// Remove the close image tag from the list
-			document.forms[form_name].addbbcode14.value = "Img";	// Return button back to normal state
-			imageTag = false;
-		}
-
-		// Open tag
-		insert_text(bbtags[bbnumber]);
-
-		if ((bbnumber == 14) && (imageTag == false)) imageTag = 1; // Check to stop additional tags after an unclosed image tag
-		if (bbtags[bbnumber] != "[*]")
-		{
-			arraypush(bbcode,bbnumber+1);
-			eval('document.forms[form_name].addbbcode'+bbnumber+'.value += "*"');
-		}
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-
-	storeCaret(document.forms[form_name].elements[text_name]);
-}
-
-// From http://www.massless.org/mozedit/
-function mozWrap(txtarea, open, close)
-{
-	var selLength = txtarea.textLength;
-	var selStart = txtarea.selectionStart;
-	var selEnd = txtarea.selectionEnd;
-	if (selEnd == 1 || selEnd == 2) 
-		selEnd = selLength;
-
-	var s1 = (txtarea.value).substring(0,selStart);
-	var s2 = (txtarea.value).substring(selStart, selEnd)
-	var s3 = (txtarea.value).substring(selEnd, selLength);
-	txtarea.value = s1 + open + s2 + close + s3;
-	return;
-}
-
-// Insert at Claret position. Code from
-// http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
-function storeCaret(textEl) {
-	if (textEl.createTextRange) { textEl.caretPos = document.selection.createRange().duplicate(); }
-}
-
-function colorPalette(dir, width, height)
-{
-	var r = 0, g = 0, b = 0;
-	var numberList = new Array(6);
-	numberList[0] = "00";
-	numberList[1] = "40";
-	numberList[2] = "80";
-	numberList[3] = "BF";
-	numberList[4] = "FF";
-	document.writeln('<table cellspacing="1" cellpadding="0" border="0">');
-	for(r = 0; r < 5; r++)
-	{
-		if (dir == 'h')
-		{
-			document.writeln('<tr>');
-		}
-		for(g = 0; g < 5; g++)
-		{
-			if (dir == 'v')
-			{
-				document.writeln('<tr>');
-			}
-			for(b = 0; b < 5; b++)
-			{
-				color = String(numberList[r]) + String(numberList[g]) + String(numberList[b]);
-				document.write('<td bgcolor="#' + color + '">');
-				document.write('<a href="javascript:bbfontstyle(\'[color=#' + color + ']\', \'[/color]\');" onmouseover="helpline(\'s\');"><img src="images/spacer.gif" width="' + width + '" height="' + height + '" border="0" alt="#' + color + '" title="#' + color + '" /></a>');
-				document.writeln('</td>');
-			}
-			if (dir == 'v')
-			{
-				document.writeln('</tr>');
-			}
-		}
-		if (dir == 'h')
-		{
-			document.writeln('</tr>');
-		}
-	}
-	document.writeln('</table>');
-}
-

Modified: cms/trunk/includes/templates/modules/Forums/mcp_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_footer.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/mcp_footer.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -4,7 +4,7 @@
 		<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
 		<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL } ]&nbsp;</td>
 		<td class="gensmall" width="100%" align="right" nowrap="nowrap">
-		<!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{$L_GOTO_PAGE}</a><!-- IF { $PREVIOUS_PAGE } --><a href="{$PREVIOUS_PAGE}">{$L_PREVIOUS}</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+		<!-- IF { $PAGINATION } --><b>{$L_GOTO_PAGE}&nbsp;{ $PAGINATION }</b><!-- ENDIF --></td>
 	</tr>
 </table>
 <br />

Modified: cms/trunk/includes/templates/modules/Forums/mcp_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_header.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/mcp_header.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -12,75 +12,37 @@
 //-->
 </script>
 
-<!-- IF { $TOPIC_TITLE } || { $FORUM_NAME } -->
-<h2><!-- IF { $TOPIC_TITLE } --><a class="titles" href="{ $U_VIEWTOPIC }">{ $TOPIC_TITLE }</a><!-- ELSE --><a class="titles" href="{ $U_VIEW_FORUM }" title="{ $FORUM_DESC }">{ $FORUM_NAME }</a><!-- ENDIF --></h2>
-	<!-- IF { $MODERATORS } -->
-		<p class="moderators">{ $L_MODERATORS }: { $MODERATORS }</p>
-	<!-- ENDIF --><!-- IF { $U_MCP } -->
-		<p class="linkmcp">[ <a href="{ $U_MCP }">{ $L_MCP }</a> ]</p>
-	<!-- ENDIF -->
+<!-- IF isset({ $TOPIC_TITLE }) || isset({ $FORUM_NAME }) -->
+<h2><!-- IF isset({ $TOPIC_TITLE }) --><a class="titles" href="{ $U_VIEWTOPIC }">{ $TOPIC_TITLE }</a><!-- ELSE --><a class="titles" href="{ $U_VIEW_FORUM }" title="{ $FORUM_DESC }">{ $FORUM_NAME }</a><!-- ENDIF --></h2>
 <br clear="all" />
 <!-- ENDIF -->
 
-	<!-- IF { $MESSAGE } -->
-	<table class="tablebg" width="100%" cellspacing="1">
+<!-- IF isset({ $MESSAGE }) -->
+<table class="tablebg" width="100%" cellspacing="1">
+	<tr>
+		<th>{ $L_MESSAGE }</th>
+	</tr>
+	
+	<tr> 
+		<td class="row1" align="center"><span class="gen">{ $MESSAGE }</span></td>
+		<!-- <br />{ section name=return_linksloop loop=$return_links }{ $return_links[return_linksloop].MESSAGE_LINK }<br /><br />{ /section }-->
+	</tr>
+</table>
+
+<br />
+<!-- ENDIF -->
+
+<!-- IF isset({ $CONFIRM_MESSAGE }) -->
+<table class="tablebg" width="100%" cellspacing="1">
+	<form name="confirm" method="post" action="{$S_CONFIRM_ACTION}"{$S_FORM_ENCTYPE}>
 		<tr>
-			<th>{ $L_MESSAGE }</th>
+			<th><b>{ $L_PLEASE_CONFIRM }</b></th>
 		</tr>
 		<tr> 
-			<td class="row1" align="center"><br /><span class="gen">{ $MESSAGE }<br /><br />
-			{ section name=return_linksloop loop=$return_links }{ $return_links[return_linksloop].MESSAGE_LINK }<br /><br />{ /section }</span></td>
+			<td class="row1" align="center"><span class="gen"><br />{ $CONFIRM_MESSAGE }<br /><br />{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="confirm" value="{ $L_YES }" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="cancel" value="{ $L_NO }" /><br /><br /></span></td>
 		</tr>
-	</table>
+	</form>
+</table>
 
-	<br />
-	<!-- ENDIF -->
-
-	<!-- IF { $CONFIRM_MESSAGE } -->
-	<table class="tablebg" width="100%" cellspacing="1">
-		<form name="confirm" method="post" action="{$S_CONFIRM_ACTION}"{$S_FORM_ENCTYPE}>
-			<tr>
-				<th><b>{ $L_PLEASE_CONFIRM }</b></th>
-			</tr>
-			<tr> 
-				<td class="row1" align="center"><span class="gen"><br />{ $CONFIRM_MESSAGE }<br /><br />{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="confirm" value="{ $L_YES }" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="cancel" value="{ $L_NO }" /><br /><br /></span></td>
-			</tr>
-		</form>
-	</table>
-
-	<br />
-	<!-- ENDIF -->
-		
-		<!--
-		<td width="20%" valign="top">
-
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th>{ $L_OPTIONS }</th>
-				</tr>
-				{ section name=mcp_sectionloop loop=$mcp_section }
-				<tr>
-				 IF { $mcp_section[mcp_sectionloop].S_SELECTED } 
-					<td class="row1"><b class="nav">{$mcp_section[mcp_sectionloop].L_TITLE}</b>
-
-						<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
-
-						{ section name=mcp_subsectionloop loop=$mcp_subsection }
-							 IF { $mcp_subsection[mcp_subsectionloop].SECTION eq $smarty.section.forumrowloop.index }
-						<li>&#187; < IF { $mcp_subsection[mcp_subsectionloop].S_SELECTED }<b>{$mcp_subsection[mcp_subsectionloop].L_TITLE}F { $mcp_subsection[mcp_subsectionloop].ADD_ITEM } ({$mcp_subsection[mcp_subsectionloop].ADD_ITEM}){ /if }</b>{ else }<a href="{$mcp_subsection[mcp_subsectionloop].U_TITLE}">{$mcp_subsection[mcp_subsectionloop].L_TITLE}IF { $mcp_subsection[mcp_subsectionloop].ADD_ITEM } ({$mcp_subsection[mcp_subsectionloop].ADD_ITEM}){ /if }</a>{ /if }</li>
-							{ /if }
-						{ /section }
-						</ul>
-
-					{ else }
-					<td class="row2" nowrap="nowrap" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{$mcp_section[mcp_sectionloop].U_TITLE}'"><a class="nav" href="{$mcp_section[mcp_sectionloop].U_TITLE}">{$mcp_section[mcp_sectionloop].L_TITLE}</a>
-					{ /if }
-					</td>
-				</tr>
-				{ /section } 
-			</table>
-
-		</td>
-		
-		<td><img src="images/spacer.gif" width="4" alt="" /></td>
-		-->
\ No newline at end of file
+<br />
+<!-- ENDIF -->
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/Forums/mcp_sideblock.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_sideblock.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/mcp_sideblock.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -0,0 +1,42 @@
+???<table class="tablebg" width="100%" cellspacing="1">
+	<tr>
+		<th>{ $L_OPTIONS }</th>
+	</tr>
+	<!-- LOOP $mcp_section -->
+	<tr>
+		<!-- IF { $mcp_section:S_SELECTED } -->
+		<td class="row1"><b class="nav">{ $mcp_section:L_TITLE }</b>
+			<ul class="nav" style="margin: 0px; padding: 0px; list-style-type: none; line-height: 175%;">
+			<!-- LOOP $mcp_subsection -->
+			<li>&#187; <!-- IF { $mcp_subsection:S_SELECTED } --><b>{ $mcp_subsection:L_TITLE }</b><!-- ELSE --><a href="{$mcp_subsection:U_TITLE}">{ $mcp_subsection:L_TITLE }</a><!-- ENDIF --></li>
+			<!-- ENDLOOP $mcp_subsection -->
+			</ul>
+		<!-- ELSE -->
+		<td class="row2" nowrap="nowrap" onmouseover="this.className='row1'" onmouseout="this.className='row2'" onclick="location.href='{ $mcp_section:U_TITLE }'"><a class="nav" href="{ $mcp_section:U_TITLE }">{ $mcp_section:L_TITLE }</a>
+		<!-- ENDIF -->
+		</td>
+	</tr>
+	<!-- ENDLOOP $mcp_section -->
+</table>
+
+<div style="padding: 2px;"></div>
+
+<!-- IF isset({ $S_SHOW_COLOUR_LEGEND }) -->
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
+	<tr>
+		<th colspan="2">{ $L_MESSAGE_COLOURS }</th>
+	</tr>
+	<!-- LOOP $pm_colour_info -->
+	<tr>
+		<!-- IF { $pm_colour_info:IMG } -->
+			<td class="row1 { $pm_colour_info:CLASS }" width="5"><img src="images/spacer.gif" width="5" alt="{ $pm_colour_info:LANG }" border="0" /></td>
+		<!-- ELSE -->
+			<td class="row1" width="25" align="center">{ $pm_colour_info:IMG }</td>
+		<!-- ENDIF -->
+		<td class="row1"><span class="genmed">{ $pm_colour_info:LANG }</span></td>
+	</tr>
+	<!-- ENDLOOP $pm_colour_info -->
+</table>
+ 
+<div style="padding: 2px;"></div>
+<!-- ENDIF -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/posting_preview.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/posting_preview.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/posting_preview.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -49,11 +49,34 @@
 					<tr>
 						<td class="row3"><b class="genmed">{ $L_ATTACHMENTS }: </b></td>
 					</tr>
-					<!-- LOOP $attachment -->
-					<tr>
-						<td class="row2">{ $attachment:DISPLAY_ATTACHMENT }</td>
-					</tr>
-					<!-- ENDLOOP -->
+						<!-- LOOP $attachment -->
+						<tr>
+							<td class="row2">
+							<!-- IF { $attachment:category } == 'DENIED' -->
+								<span class="postbody">[ { $attachment:lang }]</span><br /><br />
+							<!-- ELSEIF { $attachment:category } == 'IMAGE' -->
+								<!-- IF { $attachment:comment } -->
+								<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
+								<!-- ENDIF --><img src="{ $attachment:image_src }" alt="{ $attachment:name }" /></span>
+								<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
+							<!-- ELSEIF { $attachment:category } == 'THUMBNAIL' -->
+								<!-- IF { $attachment:comment } -->
+								<span class="gensmall"><b>{ $L_COMMENT }:</b> { $attachment:comment }</span><hr />
+								<!-- ENDIF -->		<a href="{ $attachment:link }" target="_blank"><img src="{ $attachment:image_src }" alt="{ $attachment:name }" border="0" /></a></span>
+								<br /><span class="gensmall"><strong>{ $attachment:name }</strong><br/> { $L_VIEWED } { $attachment:lang_views } </span>
+							<!-- ELSE -->
+								<!-- IF { $attachment:comment } -->
+								<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $attachment:comment }</span><hr />
+								<!-- ENDIF -->
+								<!-- IF { $attachment:icon } --><img src="{ $attachment:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $attachment:link }" target="_blank">{ $attachment:name }</a>
+								<span class="gensmall">
+								<br />{ $L_FILESIZE } { $attachment:lang_size }
+								<br />{ $L_DOWNLOADED } { $attachment:lang_views }
+								</span>
+							<!-- ENDIF -->
+							</td>
+						</tr>
+						<!-- ENDLOOP -->
 				</table>
 				<!-- ENDIF -->
 				<!-- IF { $PREVIEW_SIGNATURE } --><span class="postbody"><br />_________________<br />{ $PREVIEW_SIGNATURE }</span><!-- ENDIF --></td>

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -104,12 +104,12 @@
 <table width="100%" cellspacing="1">
 	<tr>
 		<!-- IF { $S_IS_POSTABLE } -->
-		<td align="left" valign="middle"><a href="{ $U_POST_NEW_TOPIC }">{ $POST_IMG }</a></td>
+			<td align="left" valign="middle"><a href="{ $U_POST_NEW_TOPIC }">{ $POST_IMG }</a></td>
 		<!-- ENDIF -->
 		<!-- IF { $TOTAL_TOPICS } -->
-		<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-		<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]&nbsp;</td>
-		<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+			<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
+			<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]&nbsp;</td>
+			<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b>{ $L_GOTO_PAGE } &nbsp;{ $PAGINATION }</b><!-- ENDIF --></td>
 		<!-- ENDIF -->
 	</tr>
 </table>

Modified: cms/trunk/includes/templates/modules/Forums/viewtopic_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/includes/templates/modules/Forums/viewtopic_body.html	2005-09-19 18:40:49 UTC (rev 132)
@@ -185,28 +185,38 @@
 							<!-- LOOP $postrow:ATTACHMENTS -->
 							<tr>
 								<td class="row2">
-								<!-- IF { $postrow:ATTACHMENTS:category } == 'DENIED' -->
-									<span class="postbody">[ { $postrow:ATTACHMENTS:lang }]</span><br /><br />
-								<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'IMAGE' -->
-									<!-- IF { $postrow:ATTACHMENTS:comment } -->
-									<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
-									<!-- ENDIF --><img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" /></span>
-									<br /><span class="gensmall"><strong>{ $postrow:ATTACHMENTS:name }</strong><br/> { $L_VIEWED } { $postrow:ATTACHMENTS:lang_views } </span>
-								<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'THUMBNAIL' -->
-									<!-- IF { $postrow:ATTACHMENTS:comment } -->
-									<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
-									<!-- ENDIF -->		<a href="{ $postrow:ATTACHMENTS:link }" target="_blank"><img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" border="0" /></a></span>
-									<br /><span class="gensmall"><strong>{ $postrow:ATTACHMENTS:name }</strong><br/> { $L_VIEWED } { $postrow:ATTACHMENTS:lang_views } </span>
-								<!-- ELSE -->
-									<!-- IF { $postrow:ATTACHMENTS:comment } -->
-									<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+									<!-- IF { $postrow:ATTACHMENTS:category } == 'DENIED' -->
+										<span class="postbody">[ { $postrow:ATTACHMENTS:lang }]</span><br /><br />
+									<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'IMAGE' -->
+										<!-- IF { $postrow:ATTACHMENTS:comment } -->
+											<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+										<!-- ENDIF -->
+										<img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" />
+										<br />
+										<span class="gensmall">
+											<strong>{ $postrow:ATTACHMENTS:name }</strong>
+											<br/> { $L_VIEWED } { $postrow:ATTACHMENTS:lang_views }
+										</span>
+									<!-- ELSEIF { $postrow:ATTACHMENTS:category } == 'THUMBNAIL' -->
+										<!-- IF { $postrow:ATTACHMENTS:comment } -->
+											<span class="gensmall"><b>{ $L_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+										<!-- ENDIF -->
+										<a href="{ $postrow:ATTACHMENTS:link }" target="_blank"><img src="{ $postrow:ATTACHMENTS:image_src }" alt="{ $postrow:ATTACHMENTS:name }" border="0" /></a></span>
+										<br />
+										<span class="gensmall">
+											<strong>{ $postrow:ATTACHMENTS:name }</strong>
+											<br />{ $L_VIEWED } { $postrow:ATTACHMENTS:lang_views }
+										</span>
+									<!-- ELSE -->
+										<!-- IF { $postrow:ATTACHMENTS:comment } -->
+										<span class="gensmall"><b>{ $L_FILE_COMMENT }:</b> { $postrow:ATTACHMENTS:comment }</span><hr />
+										<!-- ENDIF -->
+										<!-- IF { $postrow:ATTACHMENTS:icon } --><img src="{ $postrow:ATTACHMENTS:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $postrow:ATTACHMENTS:link }" target="_blank">{ $postrow:ATTACHMENTS:name }</a>
+										<span class="gensmall">
+											<br />{ $L_FILESIZE } { $postrow:ATTACHMENTS:lang_size }
+											<br />{ $L_DOWNLOADED } { $postrow:ATTACHMENTS:lang_views }
+										</span>
 									<!-- ENDIF -->
-									<!-- IF { $postrow:ATTACHMENTS:icon } --><img src="{ $postrow:ATTACHMENTS:icon }" alt="" border="0" /><!-- ENDIF --> <a href="{ $postrow:ATTACHMENTS:link }" target="_blank">{ $postrow:ATTACHMENTS:name }</a>
-									<span class="gensmall">
-									<br />{ $L_FILESIZE } { $postrow:ATTACHMENTS:lang_size }
-									<br />{ $L_DOWNLOADED } { $postrow:ATTACHMENTS:lang_views }
-									</span>
-								<!-- ENDIF -->
 								</td>
 							</tr>
 							<!-- ENDLOOP -->

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/installer.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -461,11 +461,11 @@
 	{
 		$continue = false;
 	}
-	
+
 	$_CLASS['core_template']->assign_array(array(
 		'error'				=> false,
 		'magic_quotes_gpc'	=> ((bool) ini_get('magic_quotes_gpc') === false),
-		'output_buffering'	=> ((bool) ini_get('output_buffering') === false),
+		'output_buffering'	=> ((int) ini_get('output_buffering') > 0),
 		'register_globals'	=> ((bool) ini_get('register_globals') === false),
 		'safe_mode'			=> ((bool) ini_get('safe_mode') === false),
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -110,7 +110,7 @@
 					}
 				}
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'MESSAGE'			=> $l_new_message,
 					'U_JS_RETURN_INBOX'	=> $indox_link,
 					'S_NOT_LOGGED_IN'	=> ($_CLASS['core_user']->data['user_id'] == ANONYMOUS) ? true : false,
@@ -320,7 +320,7 @@
 				$folder_status = get_folder_status($folder_id, $folder);
 				$url = 'Control_Panel&amp;i='.$id;
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'CUR_FOLDER_ID'				=> $folder_id,
 					'CUR_FOLDER_NAME'			=> $folder_status['folder_name'],
 					'NUM_NOT_MOVED'				=> $num_not_moved,
@@ -359,7 +359,7 @@
 				}
 				else if ($action == 'view_message')
 				{
-					$_CLASS['core_template']->assign(array(
+					$_CLASS['core_template']->assign_array(array(
 						'S_VIEW_MESSAGE'=> true,
 						'MSG_ID'		=> $msg_id)
 					);
@@ -382,7 +382,7 @@
 			break;
 		}
 
-		$_CLASS['core_template']->assign(array( 
+		$_CLASS['core_template']->assign_array(array( 
 			'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PM_' . strtoupper($mode)],
 			'S_UCP_ACTION'      => generate_link("Control_Panel&amp;i=$id&amp;mode=$mode" . ((isset($action)) ? "&amp;action=$action" : '')))
 		);

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -22,7 +22,7 @@
 		$action = 'post';
 	}
 	
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_DISPLAY_FORM'				=> false,
 		'S_DRAFT_LOADED'				=> false, 
 		'S_SHOW_DRAFTS'					=> false,
@@ -555,8 +555,8 @@
 
 		if (empty($error))
 		{
-			$_CLASS['core_template']->assign(array(
-				'POST_DATE'					=> $_CLASS['core_user']->format_date($post_time),
+			$_CLASS['core_template']->assign_array(array(
+				'POST_DATE'				=> $_CLASS['core_user']->format_date($post_time),
 			
 				'PREVIEW_SUBJECT'		=> $preview_subject,
 				'PREVIEW_MESSAGE'		=> $preview_message, 
@@ -728,7 +728,7 @@
 	$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_pm_attach'] || !$_CLASS['auth']->acl_get('u_pm_attach')) ? '' : ' enctype="multipart/form-data"';
 
 	// Start assigning vars for main posting page ...
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'L_POST_A'					=> $page_title,
 		'L_ICON'					=> $_CLASS['core_user']->lang['PM_ICON'], 
 		'L_MESSAGE_BODY_EXPLAIN'	=> (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']->lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -17,7 +17,7 @@
 
 	$redirect_url = generate_link('Control_Panel&i=pm&mode=options');
 	
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'ERROR_MESSAGE'				=> false,
 		'S_RULE_DEFINED'			=> false,
 		'S_COND_DEFINED'			=> false,
@@ -404,7 +404,7 @@
 		}
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_FULL_FOLDER_OPTIONS'	=> $s_full_folder_options,
 		'S_TO_FOLDER_OPTIONS'	=> $s_to_folder_options,
 		'S_FOLDER_OPTIONS'		=> $s_folder_options,
@@ -501,7 +501,7 @@
 		}
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_CHECK_DEFINED'	=> true,
 		'S_CHECK_SELECT'	=> ($hardcoded) ? false : true,
 		'CHECK_CURRENT'		=> isset($check_lang[$check_option]) ? $check_lang[$check_option] : '',
@@ -545,7 +545,7 @@
 		}
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_ACTION_DEFINED'	=> true,
 		'S_ACTION_SELECT'	=> ($hardcoded) ? false : true,
 		'ACTION_CURRENT'	=> $l_action,
@@ -567,7 +567,7 @@
 		}
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_RULE_DEFINED'	=> true,
 		'S_RULE_SELECT'		=> !$hardcoded,
 		'RULE_CURRENT'		=> isset($rule_lang[$rule_option]) ? $rule_lang[$rule_option] : '',
@@ -580,7 +580,7 @@
 {
 	global $_CLASS;
 	
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_COND_DEFINED'	=> true,
 		'S_COND_SELECT'		=> (!$hardcoded && isset($global_rule_conditions[$rule_option])) ? true : false)
 	);
@@ -588,7 +588,7 @@
 	// Define COND_OPTION
 	if (!isset($global_rule_conditions[$rule_option]))
 	{
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'COND_OPTION'	=> 'none',
 			'COND_CURRENT'	=> false)
 		);
@@ -604,7 +604,7 @@
 		case 'text':
 			$rule_string = request_var('rule_string', '');
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'S_TEXT_CONDITION'	=> true,
 				'CURRENT_STRING'	=> $rule_string,
 				'CURRENT_USER_ID'	=> 0,
@@ -645,7 +645,7 @@
 				$_CLASS['core_db']->free_result($result);
 			}
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'S_USER_CONDITION'	=> true,
 				'CURRENT_STRING'	=> $rule_string,
 				'CURRENT_USER_ID'	=> $rule_user_id,
@@ -659,7 +659,7 @@
 			$rule_group_id = request_var('rule_group_id', 0);
 			$rule_string = request_var('rule_string', '');
 
-			$_CLASS['core_template']->assign(array(
+			$_CLASS['core_template']->assign_array(array(
 				'S_GROUP_CONDITION'	=> true,
 				'CURRENT_STRING'	=> $rule_string,
 				'CURRENT_USER_ID'	=> 0,
@@ -674,7 +674,7 @@
 			return;
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'COND_OPTION'	=> $condition,
 		'COND_CURRENT'	=> $current_value)
 	);

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -12,7 +12,7 @@
 // -------------------------------------------------------------
 
 // * Called from ucp_pm with mode == 'view_messages' && action == 'view_folder'
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'S_SHOW_RECIPIENTS'	=> false,
 	'messagerow'		=> false,
 	'S_PM_ICONS'		=> false
@@ -60,7 +60,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_UNREAD'		=> ($type == 'unread'),
 		'S_MARK_OPTIONS'=> $s_mark_options)
 	);
@@ -175,7 +175,7 @@
 		
 		unset($folder_info['rowset']);
 		
-		$_CLASS['core_template']->assign(array(
+		$_CLASS['core_template']->assign_array(array(
 			'S_SHOW_RECIPIENTS'	=> ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? true : false,
 			'S_SHOW_COLOUR_LEGEND'	=> true)
 		);
@@ -272,7 +272,7 @@
 		$sql_limit_time = '';
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'PAGINATION'		=> generate_pagination("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param", $pm_count, $config['topics_per_page'], $start),
 		'PAGE_NUMBER'		=> on_page($pm_count, $config['topics_per_page'], $start),
 		'TOTAL_MESSAGES'	=> (($pm_count == 1) ? $_CLASS['core_user']->lang['VIEW_PM_MESSAGE'] : sprintf($_CLASS['core_user']->lang['VIEW_PM_MESSAGES'], $pm_count)),

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewmessage.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -149,7 +149,7 @@
 
 	$url = 'Control_Panel&amp;i='.$id;
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'AUTHOR_NAME'		=> ($user_info['user_colour']) ? '<span style="color:#' . $user_info['user_colour'] . '">' . $user_info['username'] . '</span>' : $user_info['username'],
 		'AUTHOR_RANK' 		=> $user_info['rank_title'],
 		'RANK_IMAGE' 		=> $user_info['rank_image'],
@@ -343,7 +343,7 @@
 		$prev_id = $id;
 	}
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'QUOTE_IMG' => $_CLASS['core_user']->img('btn_quote', $_CLASS['core_user']->lang['REPLY_WITH_QUOTE']),
 		'TITLE'		=> $title,
 

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Forums/mcp.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -45,15 +45,6 @@
 	{
 		global $_CLASS, $config;
 		
-		$_CLASS['core_template']->assign(array(
-			'L_OPTIONS'				=> $_CLASS['core_user']->lang['OPTIONS'],
-			'L_MESSAGE'				=> $_CLASS['core_user']->lang['MESSAGE'],
-			'L_YES'					=> $_CLASS['core_user']->lang['YES'],
-			'L_NO'					=> $_CLASS['core_user']->lang['NO'],
-			'L_RESET'				=> $_CLASS['core_user']->lang['RESET'],
-			)
-		);
-		
 		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
 			FROM ' . FORUMS_MODULES_TABLE . "
 			WHERE module_type = '{$module_type}'
@@ -166,7 +157,17 @@
 		{
 			trigger_error('MODULE_NOT_EXIST');
 		}
+//$_CLASS['core_blocks']->load_blocks();
+$_CLASS['core_blocks']->blocks_loaded = true;
 
+		$data = array(
+			'block_title'		=> 'Forum Administration',
+			'block_position'	=> BLOCK_LEFT,
+			'block_file'		=> 'block-forums_mcp.php',
+		);
+
+		$_CLASS['core_blocks']->add_block($data);
+
 		$this->type = $module_type;
 		$this->id	= $module_id;
 		$this->name = $module_name;
@@ -253,24 +254,26 @@
 					WHERE forum_id IN (' . implode(', ', $forum_list) . ')
 						AND topic_approved = 0';
 				$result = $_CLASS['core_db']->query($sql);
-				$total_topics = $_CLASS['core_db']->sql_fetchfield('total', 0, $result);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
 
-				return ($total_topics) ? $total_topics : $_CLASS['core_user']->lang['NONE'];
-				break;
+				return ($row['total']) ? (int) $row['total'] : $_CLASS['core_user']->lang['NONE'];
+			break;
 
 			case 'unapproved_posts':
 
 				$sql = 'SELECT COUNT(*) AS total
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t 
 						WHERE p.forum_id IN (' . implode(', ', $forum_list) . ')
 							AND p.post_approved = 0
 							AND t.topic_id = p.topic_id
 							AND t.topic_first_post_id <> p.post_id';
 				$result = $_CLASS['core_db']->query($sql);
-				$total_posts = $_CLASS['core_db']->sql_fetchfield('total', 0, $result);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
 
-				return ($total_posts) ? $total_posts : $_CLASS['core_user']->lang['NONE'];
-				break;
+				return ($row['total']) ? (int) $row['total'] : $_CLASS['core_user']->lang['NONE'];
+			break;
 		}
 	}
 
@@ -706,7 +709,7 @@
 	$s_limit_days = $s_sort_key = $s_sort_dir = $sort_url = '';
 	gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $sort_url);
 
-	$_CLASS['core_template']->assign(array(
+	$_CLASS['core_template']->assign_array(array(
 		'S_SELECT_SORT_DIR'	=>	$s_sort_dir,
 		'S_SELECT_SORT_KEY' =>	$s_sort_key,
 		'S_SELECT_SORT_DAYS'=>	$s_limit_days)
@@ -723,7 +726,10 @@
 	}
 }
 
-//
+/*
+	This needs to be redone
+*/
+
 function check_ids(&$ids, $table, $sql_id, $acl_list = false)
 {
 	global $_CLASS;
@@ -741,15 +747,9 @@
 	$sql = "SELECT forum_id FROM $table
 		WHERE $sql_id = {$ids[0]}";
 	$result = $_CLASS['core_db']->query($sql);
-	$forum_id = (int) $_CLASS['core_db']->sql_fetchfield('forum_id', 0, $result);
+	list($forum_id) = $_CLASS['core_db']->fetch_row_num($result);
 	$_CLASS['core_db']->free_result($result);
 
-	if (!$forum_id)
-	{
-		// Global Announcement?
-		$forum_id = request_var('f', 0);
-	}
-
 	if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $forum_id))
 	{
 		trigger_error('NOT_AUTHORIZED');
@@ -772,7 +772,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	return $forum_id;
+	return (int) $forum_id;
 }
 
 // LITTLE HELPER

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Forums/posting.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -194,7 +194,7 @@
 	$_CLASS['core_db']->free_result($result);
 }
 
-$orig_poll_options_size = sizeof($poll_options);
+$orig_poll_options_size = count($poll_options);
 $message_parser = new parse_message();
 
 if (isset($post_text))
@@ -227,7 +227,10 @@
 		ORDER BY filetime " . ((!$config['display_order']) ? 'DESC' : 'ASC');
 	$result = $_CLASS['core_db']->query($sql);
 
-	$message_parser->attachment_data = array_merge($message_parser->attachment_data, $_CLASS['core_db']->fetch_row_assocset($result));
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$message_parser->attachment_data[] = $row;
+	}
 
 	$_CLASS['core_db']->free_result($result);
 }
@@ -242,7 +245,7 @@
 }
 
 $enable_urls = $posting_data['enable_magic_url'];
-$enable_html = (isset($enable_html)) ? $enable_html : $config['allow_html'];
+$enable_html = isset($enable_html) ? $enable_html : $config['allow_html'];
 
 if (!in_array($mode, array('quote', 'edit', 'delete')))
 {
@@ -403,14 +406,6 @@
 	trigger_error('USER_CANNOT_DELETE');
 }
 
-// HTML, BBCode, Smilies, Images and Flash status
-$html_status	= ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id));
-$bbcode_status	= ($config['allow_bbcode'] && $_CLASS['auth']->acl_get('f_bbcode', $forum_id));
-$smilies_status	= ($config['allow_smilies'] && $_CLASS['auth']->acl_get('f_smilies', $forum_id));
-$img_status		= ($_CLASS['auth']->acl_get('f_img', $forum_id));
-$flash_status	= ($_CLASS['auth']->acl_get('f_flash', $forum_id));
-$quote_status	= ($_CLASS['auth']->acl_get('f_quote', $forum_id));
-
 // Bump Topic
 if ($mode == 'bump' && ($bump_time = bump_topic_allowed($forum_id, $topic_bumped, $topic_last_post_time, $topic_poster, $topic_last_poster_id)))
 {
@@ -522,6 +517,14 @@
 	}
 }
 
+// HTML, BBCode, Smilies, Images and Flash status
+$html_status	= ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id));
+$bbcode_status	= ($config['allow_bbcode'] && $_CLASS['auth']->acl_get('f_bbcode', $forum_id));
+$smilies_status	= ($config['allow_smilies'] && $_CLASS['auth']->acl_get('f_smilies', $forum_id));
+$img_status		= ($_CLASS['auth']->acl_get('f_img', $forum_id));
+$flash_status	= ($_CLASS['auth']->acl_get('f_flash', $forum_id));
+$quote_status	= ($_CLASS['auth']->acl_get('f_quote', $forum_id));
+
 // Load Drafts
 if ($load && $drafts)
 {
@@ -680,14 +683,14 @@
 	}
 
 	// Validate username
-	if (($posting_data['username'] && !$_CLASS['core_user']->is_user) || ($mode == 'edit' && (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS)))
+	if ($posting_data['username'] && (!$_CLASS['core_user']->is_user || ($mode == 'edit' && (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS))))
 	{
 		require_once($site_file_root.'includes/functions_user.php');
 		$result = validate_username($posting_data['username']);
 
 		if ($result !== true)
 		{
-			$error[] = $result;
+			$error[] = $_CLASS['core_user']->get_lang($result);
 		}
 	}
 
@@ -758,7 +761,7 @@
 		}
 	}
 
-	if (sizeof($message_parser->warn_msg))
+	if (!empty($message_parser->warn_msg))
 	{
 		$error[] = implode('<br />', $message_parser->warn_msg);
 	}
@@ -877,11 +880,11 @@
 		}
 	}	
 
-	$post_subject = stripslashes($subject);
+	$post_subject = $subject;
 }
 
 // Preview
-if (!sizeof($error) && $preview)
+if (empty($error) && $preview)
 {
 	$posting_data['post_time'] = ($mode == 'edit') ? $posting_data['post_time'] : $current_time;
 
@@ -921,7 +924,7 @@
 		$parse_poll->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
 		
 		$_CLASS['core_template']->assign_array(array(
-			'S_HAS_POLL_OPTIONS'=> (sizeof($poll_options)),
+			'S_HAS_POLL_OPTIONS'=> !empty($poll_options),
 			'S_IS_MULTI_CHOICE'	=> ($poll_max_options > 1) ? true : false,
 
 			'POLL_QUESTION'		=> $parse_poll->message,
@@ -943,45 +946,40 @@
 	}
 
 	// Attachment Preview
-	if (sizeof($message_parser->attachment_data))
+	if (!empty($message_parser->attachment_data))
 	{
 		require($site_file_root.'includes/forums/functions_display.php');
 		$extensions = $update_count = array();
 
 		$_CLASS['core_template']->assign('S_HAS_ATTACHMENTS', true);
 		$attachment_data = $message_parser->attachment_data;
+
 		$unset_attachments = parse_inline_attachments($preview_message, $attachment_data, $update_count, $forum_id, true);
-		
+
+		// Needed to let not display the inlined attachments at the end of the post again
 		foreach ($unset_attachments as $index)
 		{
 			unset($attachment_data[$index]);
 		}
+		
+		$_CLASS['core_template']->assign('attachment', display_attachments($forum_id, $attachment_data, $null));
 
-		foreach ($attachment_data as $i => $attachment)
-		{
-			$_CLASS['core_template']->assign_vars_array('attachment', array(
-				'DISPLAY_ATTACHMENT'	=> $attachment)
-			);
-		}
 		unset($attachment_data, $attachment);
 	}
 
-	if (!sizeof($error))
-	{
-		$_CLASS['core_template']->assign_array(array(
-			'PREVIEW_SUBJECT'		=> $preview_subject,
-			'PREVIEW_MESSAGE'		=> $preview_message,
-			'PREVIEW_SIGNATURE'		=> $preview_signature,
+	$_CLASS['core_template']->assign_array(array(
+		'PREVIEW_SUBJECT'		=> $preview_subject,
+		'PREVIEW_MESSAGE'		=> $preview_message,
+		'PREVIEW_SIGNATURE'		=> $preview_signature,
 
-			'S_DISPLAY_PREVIEW'		=> true)
-		);
-	}
+		'S_DISPLAY_PREVIEW'		=> true
+	));
 
 	unset($post_text);
 }
 
 // Decode text for message display
-$bbcode_uid = ($mode == 'quote' && !$preview && !$refresh && !sizeof($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
+$bbcode_uid = ($mode == 'quote' && !$preview && !$refresh && empty($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
 $message_parser->decode_message($bbcode_uid);
 
 if ($mode == 'quote' && !$preview && !$refresh)
@@ -999,7 +997,7 @@
 $filename_data = $message_parser->filename_data;
 $post_text = $message_parser->message;
 
-if (sizeof($poll_options) && $poll_title)
+if (!empty($poll_options) && $poll_title)
 {
 	$message_parser->message = $poll_title;
 	$message_parser->bbcode_uid = $bbcode_uid;
@@ -1108,7 +1106,7 @@
 	'FORUM_NAME' 			=> $forum_name,
 	'FORUM_DESC'			=> ($forum_desc) ? strip_tags($forum_desc) : '',
 	'TOPIC_TITLE' 			=> $posting_data['topic_title'],
-	'MODERATORS' 			=> (sizeof($moderators)) ? implode(', ', $moderators[$forum_id]) : '',
+	'MODERATORS' 			=> empty($moderators) ? '' : implode(', ', $moderators[$forum_id]),
 	'USERNAME'				=> ((!$preview && $mode != 'quote') || $preview) ? $posting_data['username'] : '',
 	'SUBJECT'				=> $post_subject,
 	'MESSAGE'				=> $post_text,
@@ -1119,7 +1117,7 @@
 	'SMILIES_STATUS'		=> ($smilies_status) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF'],
 	'MINI_POST_IMG'			=> $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
 	'POST_DATE'				=> ($posting_data['post_time']) ? $_CLASS['core_user']->format_date($posting_data['post_time']) : '',
-	'ERROR'					=> (sizeof($error)) ? implode('<br />', $error) : '', 
+	'ERROR'					=> empty($error) ? '' : implode('<br />', $error), 
 	'TOPIC_TIME_LIMIT'		=> (int) $topic_time_limit,
 	'EDIT_REASON'			=> $posting_data['post_edit_reason'],
 
@@ -1274,7 +1272,7 @@
 				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
 			}
 
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->sql_escape($row['post_username']) : $_CLASS['core_db']->sql_escape($row['username'])) . "'";
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
 			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$next_post_id = (int) $row['post_id'];
@@ -1291,7 +1289,7 @@
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$update = update_last_post_information('topic', $topic_id);
-			if (sizeof($update))
+			if (!empty($update))
 			{
 				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update);
 				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update[0]);
@@ -1401,11 +1399,11 @@
 				'enable_smilies' 	=> $data['enable_smilies'],
 				'enable_magic_url' 	=> $data['enable_urls'],
 				'enable_sig' 		=> $data['enable_sig'],
-				'post_username'		=> (!$_CLASS['core_user']->is_user) ? stripslashes($username) : '',
+				'post_username'		=> (!$_CLASS['core_user']->is_user) ? $username : '',
 				'post_subject'		=> $subject,
 				'post_text' 		=> $data['message'],
 				'post_checksum'		=> $data['message_md5'],
-				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
 				'post_edit_locked'	=> $data['post_edit_locked']
@@ -1450,12 +1448,12 @@
 				'enable_smilies' 	=> $data['enable_smilies'],
 				'enable_magic_url' 	=> $data['enable_urls'],
 				'enable_sig' 		=> $data['enable_sig'],
-				'post_username'		=> ($username && $data['poster_id'] == ANONYMOUS) ? stripslashes($username) : '',
+				'post_username'		=> ($username && $data['poster_id'] == ANONYMOUS) ? $username : '',
 				'post_subject'		=> $subject,
 				'post_edit_reason'	=> $data['post_edit_reason'],
 				'post_edit_user'	=> (int) $data['post_edit_user'],
 				'post_checksum'		=> $data['message_md5'],
-				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
 				'post_edit_locked'	=> $data['post_edit_locked'])
@@ -1480,11 +1478,11 @@
 				'icon_id'				=> $data['icon_id'],
 				'topic_approved'		=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
 				'topic_title' 			=> $subject,
-				'topic_first_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? stripslashes($username) : $_CLASS['core_user']->data['username'],
+				'topic_first_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? $username : $_CLASS['core_user']->data['username'],
 				'topic_type'			=> $topic_type,
 				'topic_time_limit'		=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
 				'topic_status'			=> $data['topic_status'],
-				'topic_attachment'		=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'topic_attachment'		=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'topic_replies_real'	=> 0,
 				'topic_replies'			=> 0,
 				'topic_views'			=> 0,
@@ -1531,15 +1529,15 @@
 				'icon_id'					=> $data['icon_id'],
 				'topic_approved'			=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
 				'topic_title' 				=> $subject,
-				'topic_first_poster_name'	=> stripslashes($username),
+				'topic_first_poster_name'	=> $username,
 				'topic_type'				=> $topic_type,
 				'topic_time_limit'			=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'poll_title'				=> ($poll['poll_options']) ? $poll['poll_title'] : '',
-				'poll_start'				=> ($poll['poll_options']) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
-				'poll_max_options'			=> ($poll['poll_options']) ? $poll['poll_max_options'] : 1,
-				'poll_length'				=> ($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
-				'poll_vote_change'			=> $poll['poll_vote_change'],
-				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0) : $data['topic_attachment']
+				'poll_title'				=> isset($poll['poll_options']) ? $poll['poll_title'] : '',
+				'poll_start'				=> isset($poll['poll_options']) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
+				'poll_max_options'			=> isset($poll['poll_options']) ? $poll['poll_max_options'] : 1,
+				'poll_length'				=> isset($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
+				'poll_vote_change'			=> isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
+				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0) : $data['topic_attachment']
 			);
 			break;
 	}
@@ -1669,7 +1667,8 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 		
-		$size = sizeof($poll['poll_options']);
+		$size = count($poll['poll_options']);
+
 		for ($i = 0, $size; $i < $size; $i++)
 		{
 			if (trim($poll['poll_options'][$i]))
@@ -1677,13 +1676,13 @@
 				if (!$cur_poll_options[$i])
 				{
 					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . "  (poll_option_id, topic_id, poll_option_text)
-						VALUES ($i, " . $data['topic_id'] . ", '" . $_CLASS['core_db']->sql_escape($poll['poll_options'][$i]) . "')";
+						VALUES ($i, " . $data['topic_id'] . ", '" . $_CLASS['core_db']->escape($poll['poll_options'][$i]) . "')";
 					$_CLASS['core_db']->query($sql);
 				}
 				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
 				{
 					$sql = "UPDATE " . FORUMS_POLL_OPTIONS_TABLE . "
-						SET poll_option_text = '" . $_CLASS['core_db']->sql_escape($poll['poll_options'][$i]) . "'
+						SET poll_option_text = '" . $_CLASS['core_db']->escape($poll['poll_options'][$i]) . "'
 						WHERE poll_option_id = " . $cur_poll_options[$i]['poll_option_id'] . "
 							AND topic_id = " . $data['topic_id'];
 					$_CLASS['core_db']->query($sql);
@@ -1691,17 +1690,17 @@
 			}
 		}
 
-		if (sizeof($poll['poll_options']) < sizeof($cur_poll_options))
+		if (count($poll['poll_options']) < count($cur_poll_options))
 		{
 			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
-				WHERE poll_option_id >= ' . sizeof($poll['poll_options']) . '
+				WHERE poll_option_id >= ' . count($poll['poll_options']) . '
 					AND topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);
 		}
 	}
 
 	// Submit Attachments
-	if (sizeof($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
+	if (!empty($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
 	{
 		$space_taken = $files_added = 0;
 
@@ -1711,7 +1710,7 @@
 			{
 				// update entry in db if attachment already stored in db and filespace
 				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
-					SET comment = '" . $_CLASS['core_db']->sql_escape($attach_row['comment']) . "'
+					SET comment = '" . $_CLASS['core_db']->escape($attach_row['comment']) . "'
 					WHERE attach_id = " . (int) $attach_row['attach_id'];
 				$_CLASS['core_db']->query($sql);
 			}
@@ -1775,7 +1774,8 @@
 		}
 
 		$update = update_last_post_information('topic', $data['topic_id']);
-		if (sizeof($update))
+
+		if (!empty($update))
 		{
 			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
@@ -1789,7 +1789,8 @@
 	if ($post_mode == 'edit_topic')
 	{
 		$update = update_last_post_information('topic', $data['topic_id']);
-		if (sizeof($update))
+
+		if (!empty($update))
 		{
 			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
 		}
@@ -1867,7 +1868,7 @@
 	// Send Notifications
 	if ($mode != 'edit' && $mode != 'delete' && (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')))
 	{
-		user_notification($mode, stripslashes($subject), stripslashes($data['topic_title']), stripslashes($data['forum_name']), $data['forum_id'], $data['topic_id'], $data['post_id']);
+		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
 	}
 
 	if ($mode == 'post')

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-18 17:58:38 UTC (rev 131)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-19 18:40:49 UTC (rev 132)
@@ -341,9 +341,6 @@
 // Grab icons
 $icons =  obtain_icons();
 
-// Grab extensions if needed
-$extensions = ($topic_data['topic_attachment']) ? obtain_attach_extensions() : array();
-
 // Moderators
 $forum_moderators = get_moderators($forum_id);
 
@@ -353,7 +350,6 @@
 // Generate Forum Rules
 generate_forum_rules($topic_data);
 
-
 gen_forum_auth_level('topic', $forum_id);
 
 // Does this topic contain a poll?
@@ -915,8 +911,9 @@
 
 // Output the posts
 //foreach ($rowset as $i => $row)
+$end = sizeof($post_list);
 
-for ($i = 0, $end = sizeof($post_list); $i < $end; ++$i)
+for ($i = 0; $i < $end; ++$i)
 {
 	$row =& $rowset[$post_list[$i]];
 	$force_encoding = '';
@@ -948,26 +945,26 @@
 	}
 
 	// Parse the message and subject
-	$message = $row['post_text'];
+	$row['post_text'] = str_replace("\n", '<br />', $row['post_text']);
 
 	// If the board has HTML off but the post has HTML on then we process it, else leave it alone
 	if ($row['enable_html'] && (!$config['allow_html'] || !$_CLASS['auth']->acl_get('f_html', $forum_id)))
 	{
-		$message = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $message);
+		$row['post_text'] = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $row['post_text']);
 	}
 
 	// Second parse bbcode here
 	if ($row['bbcode_bitfield'])
 	{
-		$bbcode->bbcode_second_pass($message, $row['bbcode_uid'], $row['bbcode_bitfield']);
+		$bbcode->bbcode_second_pass($row['post_text'], $row['bbcode_uid'], $row['bbcode_bitfield']);
 	}
 
 	// Always process smilies after parsing bbcodes
-	$message = smiley_text($message);
+	$row['post_text'] = smiley_text($row['post_text']);
 
 	if (isset($attachments[$row['post_id']]) && !empty($attachments[$row['post_id']]))
 	{
-		$unset_attachments = parse_inline_attachments($message, $attachments[$row['post_id']], $update_count, $forum_id);
+		$unset_attachments = parse_inline_attachments($row['post_text'], $attachments[$row['post_id']], $update_count, $forum_id);
 
 		// Needed to let not display the inlined attachments at the end of the post again
 		foreach ($unset_attachments as $index)
@@ -981,19 +978,15 @@
 	{
 		// This was shamelessly 'borrowed' from volker at multiartstudio dot de
 		// via php.net's annotated manual
-		$message = str_replace('\"', '"', substr(preg_replace('#(\>(((?>([^><]+|(?R)))*)\<))#se', "preg_replace('#\b(" . str_replace('\\', '\\\\', addslashes($highlight_match)) . ")\b#i', '<span class=\"posthilit\">\\\\1</span>', '\\0')", '>' . $message . '<'), 1, -1));
+		$row['post_text'] = str_replace('\"', '"', substr(preg_replace('#(\>(((?>([^><]+|(?R)))*)\<))#se', "preg_replace('#\b(" . str_replace('\\', '\\\\', addslashes($highlight_match)) . ")\b#i', '<span class=\"posthilit\">\\\\1</span>', '\\0')", '>' . $row['post_text'] . '<'), 1, -1));
 	}
 
 	if ($row['enable_html'] && ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id)))
 	{
 		// Remove Comments from post content
-		$message = preg_replace('#<!\-\-(.*?)\-\->#is', '', $message);
+		$row['post_text'] = preg_replace('#<!\-\-(.*?)\-\->#is', '', $row['post_text']);
 	}
 	
-	// Replace naughty words such as farty pants
-	$row['post_subject'] = censor_text($row['post_subject']);
-	$message = str_replace("\n", '<br />', censor_text($message));
-
 	// Editing information
 	if (($row['post_edit_count'] && $config['display_last_edited']) || $row['post_edit_reason'])
 	{
@@ -1047,21 +1040,13 @@
 		$icons[$row['icon_id']] = array('img' => '' , 'width' => '', 'height' => '');
 	}
 
-	$post_attachments = array();
-
-	// Remove this foreach.
-	if (isset($attachments[$row['post_id']]) && !empty($attachments[$row['post_id']]))
-	{
-		$post_attachments = display_attachments($forum_id, $attachments[$row['post_id']], $null);
-	}
-
 	if ($unread = ($row['post_time'] > $topic_last_read))
 	{
 		$update_mark = ($update_mark) ? (int) max($row['post_time'], $update_mark) : $row['post_time'];
 	}
 
 	$postrow = array(
-		'ATTACHMENTS'	=> count($post_attachments) ? $post_attachments : false,
+		'ATTACHMENTS'	=> empty($attachments[$row['post_id']]) ? false : display_attachments($forum_id, $attachments[$row['post_id']], $null),
 		'POSTER_NAME' 	=> $row['poster'],
 		'POSTER_RANK' 	=> $user_cache[$poster_id]['rank_title'],
 		'RANK_IMAGE' 	=> $user_cache[$poster_id]['rank_image'],
@@ -1071,8 +1056,8 @@
 		'POSTER_AVATAR' => $user_cache[$poster_id]['avatar'],
 		
 		'POST_DATE' 	=> $_CLASS['core_user']->format_date($row['post_time']),
-		'POST_SUBJECT' 	=> $row['post_subject'],
-		'MESSAGE' 		=> $message,
+		'POST_SUBJECT' 	=> censor_text($row['post_subject']),
+		'MESSAGE' 		=> censor_text($row['post_text']),
 		'SIGNATURE' 	=> ($row['enable_sig']) ? $user_cache[$poster_id]['sig'] : '',
 		'EDITED_MESSAGE'=> $l_edited_by,
 		'EDIT_REASON'	=> $row['post_edit_reason'],
@@ -1132,7 +1117,7 @@
 	
 	$prev_post_id = $row['post_id'];
 
-	unset($rowset[$i], $post_attachments, $attachments[$row['post_id']]);
+	unset($rowset[$i], $attachments[$row['post_id']]);
 }
 
 unset($rowset, $user_cache);



From viperal at berlios.de  Mon Sep 19 21:26:36 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 19 Sep 2005 21:26:36 +0200
Subject: [Viperals-svncheckins] r133 - in cms/trunk: . includes/forums modules/Contact
Message-ID: <200509191926.j8JJQaX4007976@sheep.berlios.de>

Author: viperal
Date: 2005-09-19 21:26:34 +0200 (Mon, 19 Sep 2005)
New Revision: 133

Modified:
   cms/trunk/admin.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/modules/Contact/index.php
Log:


Modified: cms/trunk/admin.php
===================================================================
--- cms/trunk/admin.php	2005-09-19 18:40:49 UTC (rev 132)
+++ cms/trunk/admin.php	2005-09-19 19:26:34 UTC (rev 133)
@@ -20,7 +20,7 @@
 $_CLASS['core_user']->user_setup(null);
 $_CLASS['core_display']->load_theme('viperal_admin', SITE_FILE_ROOT.'themes_admin/viperal_admin');
 
-$_CLASS['core_user']->add_lang('admin/common.php');
+//$_CLASS['core_user']->add_lang('admin/common.php');
 
 $_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'];
 $_CORE_MODULE['module_sides'] = BLOCK_ALL;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-19 18:40:49 UTC (rev 132)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-19 19:26:34 UTC (rev 133)
@@ -858,7 +858,7 @@
 		
 		if ($notify_type == 'topic' && $user['forum_id'])
 		{
-			$holding[$user['user_id']]['template'] = 'forum_notify';
+			$holding[$user['user_id']]['template'] = 'notify_forum';
 			$holding[$user['user_id']]['update'] = 'forum';
 		}
 		else

Modified: cms/trunk/modules/Contact/index.php
===================================================================
--- cms/trunk/modules/Contact/index.php	2005-09-19 18:40:49 UTC (rev 132)
+++ cms/trunk/modules/Contact/index.php	2005-09-19 19:26:34 UTC (rev 133)
@@ -95,16 +95,16 @@
 		'MESSAGE' 		=> $message,
 	));
 
-	$body = trim($_CLASS['core_template']->display('modules/Contact/email/index.html', true));
+	$body = trim($_CLASS['core_template']->display('email/contact/index.txt', true));
 
 	if ($preview)
 	{
-		$_CLASS['core_template']->assign('PREVIEW', $body);
+		$_CLASS['core_template']->assign('PREVIEW', modify_lines($body, '<br/>'));
 
 		return;
 	}
 
-	require_once($site_file_root.'includes/mailer.php');
+	require_once(SITE_FILE_ROOT.'includes/mailer.php');
 
 	$mailer = new core_mailer;
 	$mailer->to($_CORE_CONFIG['email']['site_mail'], false);



From viperal at berlios.de  Mon Sep 19 21:56:10 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Mon, 19 Sep 2005 21:56:10 +0200
Subject: [Viperals-svncheckins] r134 - in cms/trunk/language/en: . admin
Message-ID: <200509191956.j8JJuAFR010725@sheep.berlios.de>

Author: viperal
Date: 2005-09-19 21:56:09 +0200 (Mon, 19 Sep 2005)
New Revision: 134

Added:
   cms/trunk/language/en/admin/
   cms/trunk/language/en/admin/blocks.php
   cms/trunk/language/en/admin/common.php
   cms/trunk/language/en/admin/system.php
Log:


Added: cms/trunk/language/en/admin/blocks.php
===================================================================
--- cms/trunk/language/en/admin/blocks.php	2005-09-19 19:26:34 UTC (rev 133)
+++ cms/trunk/language/en/admin/blocks.php	2005-09-19 19:56:09 UTC (rev 134)
@@ -0,0 +1,46 @@
+<?php
+
+$this->lang += array(
+	'TITLE'		=> 'Title',
+	'POSITION'	=> 'Position',
+	'STATUS'	=> 'Status',
+	'DELETE'	=> 'Delete',
+	'DELETE_THIS'=> 'Delete this message',
+	'EDIT'		=> 'Edit',
+	'DEACTIVATE'=> 'Deactive',
+	'ACTIVATE'	=> 'Active',
+	'VIEW'		=> 'View',
+	'EDIT'		=> 'Edit',
+	'OPTIONS'	=> 'Options',
+	'MOVE_DOWN'	=> 'Move down',
+	'MOVE_UP'	=> 'Move up',
+	'NEVER'		=> 'Never',
+	'EXPIRES'	=> 'Expires',
+	'STARTS'	=> 'Begins',
+	'ACTIVE'	=> 'Active',
+	'MESSAGE'	=> 'Message',
+	'SAVED'		=> 'Changes was successfully saved<br /><br /><a href="%s">Click to return</a>',
+	'ERROR_title' => 'Title is needed',
+	'ERROR_content' => 'Content Needed',
+	'ERROR_START_TIME' => 'Start time is not in a valid format',
+	'ERROR_END_TIME' 	=> 'END time is not in a valid format',
+	'TYPE_0'	=> 'FILE',
+	'TYPE_1'	=> 'FEED',
+	'TYPE_2'	=> 'HTML',
+	'TYPE_3'	=> 'SYSTEM',
+	'ORDER'		=> 'Order',
+	'TYPE'		=> 'TYPE',
+	'B_LEFT'				=> 'Left',
+	'B_RIGHT'				=> 'Right',
+	'B_CENTER_TOP'		=> 'Center Top',
+	'B_CENTER_BOTTOM'		=> 'Center bottom',
+	'FILE'		=> 'File',
+	'MOVE_UP'	=> 'Move up',
+	'ADD_NEW'	=> 'Add new %s block',
+	'HTML_CONTENT'		=> 'HTML Content',
+	'RSS_REFRESH'		=> 'RSS refresh rate',
+	'RSS_URL'		=> 'RSS URL address',
+
+);
+
+?>
\ No newline at end of file

Added: cms/trunk/language/en/admin/common.php
===================================================================
--- cms/trunk/language/en/admin/common.php	2005-09-19 19:26:34 UTC (rev 133)
+++ cms/trunk/language/en/admin/common.php	2005-09-19 19:56:09 UTC (rev 134)
@@ -0,0 +1,2116 @@
+<?php
+// -------------------------------------------------------------
+//
+// $Id: common.php,v 1.1 2005/09/04 15:39:04 viperal Exp $
+//
+// FILENAME  : admin.php [ English ]
+// STARTED   : Sat Dec 16, 2000
+// COPYRIGHT : ? 2001, 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+$this->lang += array(
+	'LOGIN_ADMIN'			=> 'To administer the board you must be an authenticated user.',
+	'LOGIN_ADMIN_CONFIRM'	=> 'To administer the board you must re-authenticate yourself.',
+	'LOGIN_ADMIN_SUCCESS'	=> 'You have successfully authenticated and will now be redirected to the Administration Control Panel',
+	'NO_ADMIN'		=> '<div align="center">You are not authorised to administer this Site.</div>',
+	'NO_FRAMES'		=> 'Sorry, your browser does not support frames.',
+
+	'ADMIN_TITLE'	=> 'Administration Panel',
+	'ADMIN'			=> 'Administration',
+
+	'RETURN_TO'		=> 'Return to ...',
+	'FORUM_INDEX'	=> 'Forum Index',
+	'ADMIN_INDEX'	=> 'Admin Index',
+
+	'DB_CAT'		=> 'Database', 
+	'DB_BACKUP'		=> 'Backup Database',
+	'DB_RESTORE'	=> 'Restore Database',
+	'SEARCH_INDEX'	=> 'Search Indexing', 
+	'DB_UTILS'		=> 'Database Utilities', 
+
+	'FORUM_CAT'	=> 'Forums',
+	'PRUNE'		=> 'Pruning',
+
+	'GENERAL_CAT'		=> 'General',
+	'AUTH_SETTINGS'		=> 'Authentication',
+	'AVATAR_SETTINGS'	=> 'Avatar Settings',
+	'BASIC_CONFIG'		=> 'Basic Configuration',
+	'BOARD_DEFAULTS'	=> 'Board Defaults',
+	'BOARD_SETTINGS'	=> 'Board Settings',
+	'COOKIE_SETTINGS'	=> 'Cookie Settings',
+	'MESSAGE_SETTINGS'	=> 'Message Settings',
+	'EMAIL_SETTINGS'	=> 'Email Settings',
+	'MASS_EMAIL'		=> 'Mass Email',
+	'SERVER_SETTINGS'	=> 'Server Settings', 
+	'LOAD_SETTINGS'		=> 'Load Settings', 
+	'EVENTS'			=> 'Events', 
+	'CRON'				=> 'Cronjobs', 
+	'PHP_INFO'			=> 'PHP Information', 
+	'IM'				=> 'Jabber Settings', 
+
+	'LOG_CAT'		=> 'Logging',
+	'ADMIN_LOGS'	=> 'Admin Log',
+	'MOD_LOGS'		=> 'Moderator Log',
+	'CRITICAL_LOGS'	=> 'Error Log',
+
+	'PERM_CAT'		=> 'Permissions', 
+	'USER_PERMS'	=> 'User permissions', 
+	'GROUP_PERMS'	=> 'Group permissions', 
+
+	'POST_CAT'		=> 'Posting',
+	'SMILE'			=> 'Smilies',
+	'ICONS'			=> 'Icons',
+	'WORD_CENSOR'	=> 'Word Censors',
+
+	'STYLE_CAT'			=> 'Styles',
+	'MANAGE_STYLE'		=> 'Styles', 
+	'MANAGE_TEMPLATE'	=> 'Templates', 
+	'MANAGE_THEME'		=> 'Themes', 
+	'MANAGE_IMAGESET'	=> 'Imagesets', 
+
+	'USER_CAT'		=> 'Users / Groups', 
+	'MANAGE_USERS'	=> 'Manage Users', 
+	'BAN_EMAILS'	=> 'Ban Emails',
+	'BAN_IPS'		=> 'Ban IPs',
+	'BAN_USERS'		=> 'Ban Usernames',
+	'DISALLOW'		=> 'Disallow names',
+	'RANKS'			=> 'Ranks',
+	'PRUNE_USERS'	=> 'Prune users', 
+	'BOTS'			=> 'Manage Bots', 
+	'GROUP_MANAGE'	=> 'Manage groups', 
+	'CUSTOM_PROFILE_FIELDS'	=> 'Profile fields', 
+
+	'ADMINISTRATORS'	=> 'Administrators',
+	'USERNAMES_EXPLAIN'	=> 'Place each username on a seperate line', 
+	'LOOK_UP_FORUM'		=> 'Select a Forum',
+	'MANAGE'			=> 'Manage',
+	'ADD'				=> 'Add', 
+	'PERMISSIONS'		=> 'Permissions', 
+	'UPDATE'			=> 'Update',
+	'EXPORT_STORE'		=> 'Store', 
+	'EXPORT_DOWNLOAD'	=> 'Download', 
+	'CONFIG_UPDATED'	=> 'Configuration updated successfully', 
+	'DOWNLOAD_STORE'		=> 'Download or Store file', 
+	'DOWNLOAD_STORE_EXPLAIN'=> 'You may directly download the file or save it in your store/ folder.', 
+	'COLOUR_SWATCH'		=> 'Web-safe colour swatch', 
+	'UPDATE_MARKED'		=> 'Update Marked',
+	'UPDATE_ALL'		=> 'Update All', 
+
+	'CONFIRM_OPERATION'	=> 'Are you sure you wish to carry out this operation?', 
+
+	'log_index_activate'	=> '<b>Activated inactive users</b><br />&#187; %s users',
+	'log_index_delete'		=> '<b>Deleted inactive users</b><br />&#187; %s',
+	'LOG_INDEX_REMIND'		=> '<b>Sent reminder emails to inactive users</b><br />&#187; %s',
+
+	'LOG_USER_INACTIVE'		=> '<b>User deactivated</b><br />&#187; %s', 
+	'LOG_USER_ACTIVE'		=> '<b>User activated</b><br />&#187; %s', 
+
+	'LOG_MASS_EMAIL'		=> '<b>Sent mass email</b><br />&#187; %s',
+
+	'LOG_DELETE_WORD'		=> '<b>Deleted word censor</b><br />&#187; %s',
+	'LOG_EDIT_WORD'			=> '<b>Edited word censor</b><br />&#187; %s',
+	'LOG_ADD_WORD'			=> '<b>Added word censor</b><br />&#187; %s',
+
+	'log_db_backup'			=> '<b>Database backup</b>',
+	'log_db_restore'		=> '<b>Database restore</b>',
+	'log_search_index'		=> '<b>Re-indexed search system</b><br />&#187; %s',
+
+	'log_disallow_add'		=> '<b>Added disallowed username</b><br />&#187; %s',
+	'log_disallow_delete'	=> '<b>Deleted disallowed username</b>',
+
+	'LOG_ADMIN_CLEAR'		=> '<b>Cleared admin log</b>',
+	'LOG_MOD_CLEAR'			=> '<b>Cleared moderator log</b>',
+	'LOG_CRITICAL_CLEAR'	=> '<b>Cleared error log</b>',
+
+	'LOG_PRUNE'				=> '<b>Pruned forums</b><br />&#187; %s',
+	'LOG_AUTO_PRUNE'		=> '<b>Auto-pruned forums</b><br />&#187; %s',
+
+	'LOG_BAN_EXCLUDE_USER'	=> '<b>Excluded user from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_EXCLUDE_IP'	=> '<b>Excluded ip from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_EXCLUDE_EMAIL' => '<b>Excluded email from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_USER'			=> '<b>Banned User</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_IP'			=> '<b>Banned ip</b> for reason %s<br />&#187; %s',
+	'LOG_BAN_EMAIL'			=> '<b>Banned email</b> for reason %s<br />&#187; %s',
+	'LOG_UNBAN_USER'		=> '<b>Unbanned user</b><br />&#187; %s',
+	'LOG_UNBAN_IP'			=> '<b>Unbanned ip</b><br />&#187; %s',
+	'LOG_UNBAN_EMAIL'		=> '<b>Unbanned email</b><br />&#187; %s',
+
+	'LOG_DOWNLOAD_EXCLUDE_IP'	=> '<b>Exluded ip/hostname from download list</b><br />&#187; %s',
+	'LOG_DOWNLOAD_IP'			=> '<b>Added ip/hostname to download list</b><br />&#187; %s',
+	'LOG_DOWNLOAD_REMOVE_IP'	=> '<b>Removed ip/hostname from download list</b><br />&#187; %s',
+	
+	'LOG_SERVER_CONFIG'		=> '<b>Altered server settings</b>',
+	'LOG_DEFAULT_CONFIG'	=> '<b>Altered board defaults</b>',
+	'LOG_SETTING_CONFIG'	=> '<b>Altered board settings</b>',
+	'LOG_COOKIE_CONFIG'		=> '<b>Altered cookie settings</b>',
+	'LOG_EMAIL_CONFIG'		=> '<b>Altered email settings</b>',
+	'LOG_AVATAR_CONFIG'		=> '<b>Altered avatar settings</b>',
+	'LOG_AUTH_CONFIG'		=> '<b>Altered authentication settings</b>',
+	'LOG_LOAD_CONFIG'		=> '<b>Altered load settings</b>', 
+	'LOG_MESSAGE_CONFIG'	=> '<b>Altered private message settings</b>',
+
+	'LOG_ATTACH_CONFIG'		=> '<b>Altered attachment settings</b>',
+	'LOG_ATTACH_EXT_ADD'	=> '<b>Added or edited attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXT_DEL'	=> '<b>Removed attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXT_UPDATE'	=> '<b>Updated attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_ADD' => '<b>Added extension group</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_EDIT' => '<b>Edited extension group</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_DEL' => '<b>Removed extension group</b><br />&#187; %s',
+	'LOG_ATTACH_FILEUPLOAD'	=> '<b>Orphan File uploaded to Post Number %1$d - %2$s</b>',
+	'LOG_ATTACH_ORPHAN_DEL'	=> '<b>Orphan Files deleted</b><br />&#187; %s',
+
+	'log_prune_user_deac'	=> '<b>Users Deactivated</b><br />%s',
+	'log_prune_user_del_del'=> '<b>Users Pruned and Posts Deleted</b><br />%s',
+	'log_prune_user_del_anon'=> '<b>Users Pruned and Posts Retained</b><br />%s',
+
+	'LOG_RESYNC_STATS'		=> '<b>Post, topic and user stats reset</b>', 
+	'LOG_RESET_DATE'		=> '<b>Board start date reset</b>', 
+	'LOG_RESET_ONLINE'		=> '<b>Most users online reset</b>',
+
+	'LOG_ACL_MOD_DEL'			=> '<b>Removed Moderators</b> from %s<br />&#187; %s', 
+	'LOG_ACL_MOD_ADD'			=> '<b>Added or edited Moderators</b> from %s<br />&#187; %s', 
+	'LOG_ACL_SUPERMOD_DEL'		=> '<b>Removed Super Moderators</b><br />&#187; %s', 
+	'LOG_ACL_SUPERMOD_ADD'		=> '<b>Added or edited Super Moderators</b><br />&#187; %s', 
+	'LOG_ACL_ADMIN_DEL'			=> '<b>Removed Administrators</b><br />&#187; %s', 
+	'LOG_ACL_ADMIN_ADD'			=> '<b>Added or edited Administrators</b><br />&#187; %s', 
+	'LOG_ACL_FORUM_DEL'			=> '<b>Removed Forum access</b> from %s<br />&#187; %s', 
+	'LOG_ACL_FORUM_ADD'			=> '<b>Added or edited Forum access</b> from %s<br />&#187; %s', 
+	'LOG_ACL_USER_ADD'			=> '<b>Edited User permissions</b><br />&#187; %s', 
+	'LOG_ACL_GROUP_ADD'			=> '<b>Edited Group permissions</b><br />&#187; %s', 
+	'LOG_ACL_PRESET_ADD'		=> '<b>Added or edited permission preset</b><br />&#187; %s', 
+	'LOG_ACL_PRESET_DEL'		=> '<b>Deleted permission preset</b><br />&#187; %s', 
+
+	'LOG_FORUM_ADD'			=> '<b>Created new forum</b><br />&#187; %s',
+	'LOG_FORUM_MOVE_UP'		=> '<b>Moved forum</b> %s <b>above</b> %s', 
+	'LOG_FORUM_MOVE_DOWN'	=> '<b>Moved forum</b> %s <b>below</b> %s', 
+	'LOG_FORUM_EDIT'		=> '<b>Edited forum details</b><br />&#187; %s', 
+	'LOG_FORUM_SYNC'		=> '<b>Re-synchronised forum</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS'	=> '<b>Deleted forum and its messages</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_FORUMS'	=> '<b>Deleted forum and its subforums</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS_MOVE_FORUMS'	=> '<b>Deleted forum and its messages, moved subforums</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS_FORUMS'	=> '<b>Deleted forum and its subforums, moved messages</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS'	=> '<b>Deleted forum and moved posts </b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_FORUMS'	=> '<b>Deleted forum and moved subforums</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS_FORUMS'=> '<b>Deleted forum, its messages and subforums</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS'	=> '<b>Deleted forum, moved posts</b> to %s <b>and subforums</b> to %s<br />&#187; %s', 
+
+	'LOG_GROUP_UPDATED'		=> '<b>Usergroup details updated</b><br />&#187; %s',
+	'LOG_GROUP_CREATED'		=> '<b>New usergroup created</b><br />&#187; %s',
+	'LOG_MODS_ADDED'		=> '<b>Added new leaders to usergroup</b> %s<br />&#187; %s', 
+	'LOG_USERS_ADDED'		=> '<b>Added new members to usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DEFAULTS'	=> '<b>Group made default for members</b><br />&#187; %s', 
+	'LOG_USERS_APPROVED'	=> '<b>Users approved in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DEMOTED'		=> '<b>Leaders demoted in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_PROMOTED'	=> '<b>Members promoted to leader in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_REMOVE'		=> '<b>Members removed from usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DELETE'		=> '<b>Usergroup deleted</b><br />&#187; %s', 
+
+	'LOG_ADD_STYLE'		=> '<b>Added new style</b><br />&#187; %s', 
+	'LOG_EDIT_STYLE'	=> '<b>Edited style</b><br />&#187; %s', 
+	'LOG_EXPORT_STYLE'	=> '<b>Exported style</b><br />&#187; %s', 
+	'LOG_DELETE_STYLE'	=> '<b>Deleted style</b><br />&#187; %s', 
+
+	'LOG_ADD_THEME_FS'		=> '<b>Add new theme on filesystem</b><br />&#187; %s', 
+	'LOG_ADD_THEME_DB'		=> '<b>Added new theme to database</b><br />&#187; %s', 
+	'LOG_EDIT_THEME'		=> '<b>Edited theme</b><br />&#187; %s', 
+	'LOG_EDIT_THEME_DETAILS'=> '<b>Edited theme details</b><br />&#187; %s', 
+	'LOG_EXPORT_THEME'		=> '<b>Exported theme</b><br />&#187; %s', 
+	'LOG_DELETE_THEME'		=> '<b>Theme deleted</b><br />&#187; %s', 
+
+	'LOG_ADD_TEMPLATE_FS'		=> '<b>Add new template set on filesystem</b><br />&#187; %s', 
+	'LOG_ADD_TEMPLATE_DB'		=> '<b>Added new template set to database</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE'			=> '<b>Edited template set</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE_DETAILS'	=> '<b>Edited template details</b><br />&#187; %s', 
+	'LOG_EXPORT_TEMPLATE'		=> '<b>Exported template set</b><br />&#187; %s', 
+	'LOG_DELETE_TEMPLATE'		=> '<b>Deleted template set</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE'			=> '<b>Edited template</b><br />&#187; %s [%s]', 
+	'LOG_CLEAR_TPLCACHE'		=> '<b>Cleared template cache</b><br />&#187; %s', 
+
+	'LOG_ADD_IMAGESET'			=> '<b>Added new imageset</b><br />&#187; %s', 
+	'LOG_EDIT_IMAGESET'			=> '<b>Edited imageset</b><br />&#187; %s', 
+	'LOG_EDIT_IMAGESET_DETAILS'	=> '<b>Edited imageset details</b><br />&#187; %s', 
+	'LOG_EXPORT_IMAGESET'		=> '<b>Exported imageset</b><br />&#187; %s', 
+	'LOG_DELETE_IMAGESET'		=> '<b>Deleted imageset</b><br />&#187; %s',
+	
+	'LOG_BBCODE_ADD'		=> '<b>Added new BBCode</b><br />&#187; %s',
+	'LOG_BBCODE_EDIT'		=> '<b>Edited BBCode</b><br />&#187; %s',
+	'LOG_BBCODE_DELETE'		=> '<b>Deleted BBCode</b><br />&#187; %s',
+
+	'LOG_JAB_PASSCHG'	=> '<b>Jabber password changed</b>', 
+	'LOG_JAB_REGISTER'	=> '<b>Jabber account registered</b>', 
+	'LOG_JAB_CHANGED'	=> '<b>Jabber account changed</b>', 
+
+	'LOG_EMAIL_ERROR'	=> '%s', 
+	'LOG_JABBER_ERROR'	=> '%s', 
+
+	'LOG_BOT_ADDED'		=> '<b>New bot added</b><br />&#187; %s',
+	'LOG_BOT_UPDATED'	=> '<b>Existing bot updated</b><br />&#187; %s',
+	'LOG_BOT_DELETE'	=> '<b>Deleted bot</b><br />&#187; %s',
+	
+	'UPLOAD_AVATAR_FILE'		=> 'Upload from your machine',
+	'UPLOAD_AVATAR_URL'			=> 'Upload from a URL',
+	'UPLOAD_AVATAR_URL_EXPLAIN'	=> 'Enter the URL of the location containing the image, it will be copied to this site.',
+	
+	'LINK_REMOTE_AVATAR'		=> 'Link off-site',
+	'LINK_REMOTE_AVATAR_EXPLAIN'=> 'Enter the URL of the location containing the Avatar image you wish to link to.',
+	'LINK_REMOTE_SIZE'			=> 'Avatar dimensions',
+	'LINK_REMOTE_SIZE_EXPLAIN'	=> 'Specify the width and height of the avatar, leave blank to attempt automatic verification.',
+	
+);
+
+// Index page
+$this->lang += array(
+	'WELCOME_PHPBB'	=> 'Welcome to phpBB',
+	'ADMIN_INTRO'	=> 'Thank you for choosing phpBB as your forum solution. This screen will give you a quick overview of all the various statistics of your board. The links on the left hand side of this screen allow you to control every aspect of your forum experience. Each page will have instructions on how to use the tools.',
+
+	'FORUM_STATS'	=> 'Forum Statistics',
+	'STATISTIC'		=> 'Statistic',
+	'VALUE'			=> 'Value',
+	'NUMBER_POSTS'	=> 'Number of posts',
+	'POSTS_PER_DAY' => 'Posts per day',
+	'NUMBER_TOPICS' => 'Number of topics',
+	'TOPICS_PER_DAY'=> 'Topics per day',
+	'NUMBER_USERS'	=> 'Number of users',
+	'USERS_PER_DAY' => 'Users per day',
+	'NUMBER_FILES'	=> 'Number of Attachments',
+	'FILES_PER_DAY'	=> 'Attachments per day',
+	'BOARD_STARTED' => 'Board started',
+	'AVATAR_DIR_SIZE'	=> 'Avatar directory size',
+	'UPLOAD_DIR_SIZE'	=> 'Upload directory size',
+	'DATABASE_SIZE'		=> 'Database size',
+	'GZIP_COMPRESSION'	=> 'Gzip compression',
+	'NOT_AVAILABLE'		=> 'Not available',
+	'ON'				=> 'ON',
+	'OFF'				=> 'OFF',
+	'RESET_ONLINE'		=> 'Reset Online', 
+	'RESET_DATE'		=> 'Reset Date', 
+	'RESYNC_STATS'		=> 'Resync Stats', 
+
+	'INACTIVE_USERS'		=> 'Inactive Users',
+	'INACTIVE_USERS_EXPLAIN'=> 'This is a list of users who have registered but whos accounts are inactive. You can activate, delete or remind (by sending an email) these users if you wish.',
+	'NO_INACTIVE_USERS'		=> 'No inactive users',
+	'ACTIVATE'				=> 'Activate', 
+	'REMIND'				=> 'Remind', 
+
+	'ADMIN_LOG'					=> 'Logged administrator actions',
+	'ADMIN_LOG_INDEX_EXPLAIN'	=> 'This gives an overview of the last five actions carried out by board administrators. A full copy of the log can be viewed from the appropriate menu item to the left.',
+	'IP'	=> 'User IP',
+	'ACTION'=> 'Action',
+);
+
+// Restore/Backup
+$this->lang += array(
+	'Database_Utilities' => 'Database Utilities',
+
+	'Backup'			=> 'Backup',
+	'Backup_explain'	=> 'Here you can backup all your phpBB related data. You may store the resulting archive in your store/ folder or download it directly. Depending on your server configuration you be able to compress the file in a number of formats. If you wish to include any additional "custom" tables please list them in the additional tables field, separated by commas. ',
+	'Backup_options'	=> 'Backup options',
+	'Backup_type'		=> 'Backup type',
+	'Start_backup'		=> 'Start Backup',
+	'Full_backup'		=> 'Full',
+	'Structure_only'	=> 'Structure Only',
+	'Data_only'			=> 'Data only',
+	'INC_SEARCH_INDEX'			=> 'Include Search Index tables',
+	'INC_SEARCH_INDEX_EXPLAIN'	=> 'Saying no here will reduce the size of the backup by ignoring the search indexes.',
+	'Additional_tables'			=> 'Additional tables',
+	'Additional_tables_explain' => 'Include the names of other tables you wish to backup here, comma separated.',
+	'Compress_file'			=> 'Compress file',
+	'Store_local'			=> 'Store file locally',
+	'Store_local_explain'	=> 'To store the file on the server rather than download it specify a path here relative to the phpBB2 root.',
+	'Backup_download'		=> 'Your download will start shortly please wait till it begins',
+	'Backup_writing'		=> 'The backup file is being generated please wait till it completes',
+	'Backup_success'		=> 'The backup file has been created successfully in the location you specified',
+	'Backups_not_supported' => 'Sorry but database backups are not currently supported for your database system',
+
+	'Restore' => 'Restore',
+	'Restore_explain' => 'This will perform a full restore of all phpBB tables from a saved file. You can <u>either</u> upload the backup file via this form or upload it manually to a location on the server. If your server supports it you may use a gzip compressed text file and it will automatically be decompressed. <b>WARNING</b> This will overwrite any existing data. The restore may take a long time to process please do not move from this page till it is complete.',
+	'Upload_file' => 'Upload backup file',
+	'Select_file' => 'Select a file',
+	'Local_backup_file' => 'Location of backup file',
+	'Local_backup_file_explain' => 'Location on the server where backup file is stored relative to the phpBB root, e.g. ../tmp/backup.sql',
+	'Supported_extensions' => 'Supported extensions',
+	'Start_Restore' => 'Start Restore',
+	'Restore_success' => 'The Database has been successfully restored.<br /><br />Your board should be back to the state it was when the backup was made.',
+	'Restore_Error_filename' => 'The file you uploaded had an unsupported extension.',
+	'Compress_unsupported' => 'The version of PHP installed on this server does not support the type of compression used for your backup. Please use a compression method listed on the previous page.',
+	'Restore_Error_no_file' => 'No file was uploaded',
+);
+
+// Permissions
+$this->lang += array(
+	'ACL_EXPLAIN'			=> 'Permissions are based on a simple YES / NO system. Setting an option to NO for a user or usergroup overrides any other value assigned to it. If you do not wish to assign a value for an option for this user or group select UNSET. If values are assigned for this option elsewhere they will be used in preference, else NO is assumed.',
+	'PERMISSIONS_EXPLAIN'	=> 'Here you can alter which users and groups can access which forums. To assign moderators or define administrators please use the appropriate page (see left hand side menu).',
+	'MODERATORS'			=> 'Moderators',
+	'MODERATORS_EXPLAIN'	=> 'Here you can assign users and groups as forum moderators. To assign users access to forums, to define super moderators or administrators please use the appropriate page (see left hand side menu). If you are permitted you can also change permissions for this forum from this page. Use the select box to change views.',
+	'SUPER_MODERATORS'			=> 'Super Moderators',
+	'SUPER_MODERATORS_EXPLAIN'	=> 'Here you can assign users and groups as super moderators. Super Moderators are like ordinary moderators accept they have access to every forum on your board. To assign users access to forums or define administrators please use the appropriate page (see left hand side menu). If you are permitted you can also set permissions for forum options from this page. Use the select box to change views.',
+	'ADMINISTRATORS_EXPLAIN'	=> 'Here you can assign administrator rights to users or groups. All users with admin permissions can view the administration panel. If you are permitted you can also change permissions for forums, super moderator and moderator options from this page. Use the select box to change views.',
+	'USER_PERMISSIONS'			=> 'User Permissions', 
+	'USER_PERMISSIONS_EXPLAIN'	=> 'Here you can set user based permissions. These include capabilities such as the use of avatars, sending private messages, etc. To alter these settings for large numbers of users the Group permissions system is the prefered method.', 
+	'GROUP_PERMISSIONS'			=> 'Group Permissions', 
+	'GROUP_PERMISSIONS_EXPLAIN' => 'Here you can set usergroup based permissions. These include capabilities such as the use of avatars, sending private messages, etc. To alter these settings for single users the User permissions system is the prefered method.', 
+	'DEPENDENCIES'			=>	'Dependencies', 
+	'DEPENDENCIES_EXPLAIN'	=>	'Here you can define relationships between administrator or moderator permission options and forum options. Using this you can automatically update forum permissions based on setting admin or moderator options. While this can save time care should be taken in defining these dependencies. Remember, these settings apply to all users and all groups.', 
+
+	'LOOK_UP_GROUP'		=> 'Look up Usergroup', 
+	'MANAGE_USERS'		=> 'Manage Users',
+	'ADD_USERS'			=> 'Add Users',
+	'MANAGE_GROUPS'		=> 'Manage Groups',
+	'ADD_GROUPS'		=> 'Add Groups',
+	'ALLOWED_USERS'		=> 'Allowed users',
+	'DISALLOWED_USERS'	=> 'Disallowed users',
+	'ALLOWED_GROUPS'	=> 'Allowed groups',
+	'DISALLOWED_GROUPS' => 'Disallowed groups',
+	'REMOVE_SELECTED'	=> 'Remove selected',
+	'SET_OPTIONS'	=> 'Set Options',
+	'OPTION'		=> 'Option',
+	'YES'			=> 'Yes',
+	'NO'			=> 'No',
+	'UNSET'			=> 'Unset', 
+	'IGNORE'		=> 'Ignore', 
+	'PRESETS'		=> 'Presets', 
+	'ALL_YES'		=> 'All Yes',
+	'ALL_NO'		=> 'All No',
+	'ALL_UNSET'		=> 'All Unset', 
+	'ALL_IGNORE'	=> 'All Ignore', 
+	'USER_PRESETS'	=> 'User presets', 
+	'FROM_PARENT'	=> 'From Parent', 
+	'SELECT_VIEW'	=> 'Select view', 
+	'ACL_SUBFORUMS'			=> 'Assign to sub-forums',
+	'ACL_SUBFORUMS_EXPLAIN'	=> 'Select the subforums (if any) you want to inherit these permissions',
+	'PRESETS_EXPLAIN'		=> 'To update or delete an existing preset select it from the list.', 
+	'SELECT_PRESET'			=> 'Select preset', 
+	'PRESET_NAME'			=> 'Preset name', 
+	'EMPTY'					=> 'Empty',
+	'WARNING'			=> 'Warning', 
+	'WARNING_EXPLAIN'	=> 'You have altered settings for one or alternative views. Be sure to verify these settings before updating', 
+	'NOTIFY'			=> 'Notification',
+	'SELECTED_USER'		=> 'Selected User', 
+	'SELECTED_USERS'	=> 'Selected Users', 
+	'SELECTED_GROUP'	=> 'Selected Group', 
+	'SELECTED_GROUPS'	=> 'Selected Groups', 
+	'SELECTED_FORUM'	=> 'Selected Forum', 
+	'SELECTED_FORUMS'	=> 'Selected Forums', 
+	'WILL_SET_OPTIONS'	=> 'Will set options in', 
+	'INHERIT_PARENT'	=> 'Inherit Parent',
+	'SAVE'				=> 'Save',
+
+	'ACL_VIEW_FORUM'	=> 'Forum Options', 
+	'ACL_VIEW_MOD'		=> 'Moderator Options', 
+	'ACL_VIEW_SUPERMOD'	=> 'Supermod Options', 
+	'ACL_VIEW_ADMIN'	=> 'Admin Options', 
+
+	'AUTH_UPDATED'	=> 'Permissions have been updated',
+
+	'acl_a_server' 		=> 'Can alter server and email settings',
+	'acl_a_defaults' 	=> 'Can alter board defaults',
+	'acl_a_board' 		=> 'Can alter board settings',
+	'acl_a_cookies' 	=> 'Can alter cookie settings',
+	'acl_a_names' 		=> 'Can alter disallowed names',
+	'acl_a_words' 		=> 'Can alter word censors',
+	'acl_a_icons' 		=> 'Can alter topic icons and emoticons',
+	'acl_a_search' 		=> 'Can re-index search tables',
+	'acl_a_prune' 		=> 'Can prune forums',
+	'acl_a_bbcode' 		=> 'Can define BBCode tags',
+	'acl_a_attach' 		=> 'Can manage attachments',
+	'acl_a_ranks'		=> 'Can manage ranks',
+	'acl_a_user' 		=> 'Can manage users',
+	'acl_a_userdel' 	=> 'Can delete or prune users',
+	'acl_a_useradd' 	=> 'Can add new users',
+	'acl_a_group' 		=> 'Can manage groups',
+	'acl_a_groupdel' 	=> 'Can delete groups',
+	'acl_a_groupadd' 	=> 'Can add new groups',
+	'acl_a_forum' 		=> 'Can manage forums',
+	'acl_a_forumdel' 	=> 'Can delete forums',
+	'acl_a_forumadd' 	=> 'Can add new forums',
+	'acl_a_ban' 		=> 'Can manage bans',
+	'acl_a_auth' 		=> 'Can alter forum permissions',
+	'acl_a_authmods' 	=> 'Can alter moderator permissions',
+	'acl_a_authadmins' 	=> 'Can alter admin permissions',
+	'acl_a_authusers' 	=> 'Can alter user permissions',
+	'acl_a_authgroups' 	=> 'Can alter group permissions',
+	'acl_a_email' 		=> 'Can send mass email',
+	'acl_a_styles' 		=> 'Can manage styles',
+	'acl_a_backup' 		=> 'Can backup database',
+	'acl_a_restore' 	=> 'Can restore database',
+	'acl_a_clearlogs' 	=> 'Can clear admin and mod logs',
+	'acl_a_events' 		=> 'Can use event system',
+	'acl_a_cron' 		=> 'Can use cron system',
+	'acl_a_authdeps'	=> 'Can set dependencies', 
+
+	'acl_m_edit'	=> 'Can edit posts',
+	'acl_m_delete'	=> 'Can delete posts',
+	'acl_m_move'	=> 'Can move topics',
+	'acl_m_lock'	=> 'Can lock topics',
+	'acl_m_split'	=> 'Can split topics',
+	'acl_m_merge'	=> 'Can merge topics',
+	'acl_m_approve' => 'Can approve posts',
+	'acl_m_unrate'	=> 'Can un-rate posts',
+	'acl_m_auth'	=> 'Can set permissions',
+	'acl_m_ip'		=> 'Can view IP\'s', 
+	'acl_m_info'	=> 'Can alter forum info', 
+
+	'acl_f_list'		=> 'Can see forum',
+	'acl_f_read'		=> 'Can read forum',
+	'acl_f_post'		=> 'Can post in forum',
+	'acl_f_reply'		=> 'Can reply to posts',
+	'acl_f_quote'		=> 'Can quote posts',
+	'acl_f_edit'		=> 'Can edit own posts',
+	'acl_f_user_lock'	=> 'Can lock own topics',
+	'acl_f_delete'		=> 'Can delete own posts',
+	'acl_f_poll'		=> 'Can create polls',
+	'acl_f_vote'		=> 'Can vote in polls',
+	'acl_f_votechg'		=> 'Can change existing vote',
+	'acl_f_announce'	=> 'Can post announcements',
+	'acl_f_sticky'		=> 'Can post stickies',
+	'acl_f_attach'		=> 'Can attach files',
+	'acl_f_download'	=> 'Can download files',
+	'acl_f_html'		=> 'Can post HTML',
+	'acl_f_bbcode'		=> 'Can post BBCode',
+	'acl_f_smilies'		=> 'Can post smilies',
+	'acl_f_img'			=> 'Can post images',
+	'acl_f_flash'		=> 'Can post Flash',
+	'acl_f_sigs'		=> 'Can use signatures',
+	'acl_f_search'		=> 'Can search the forum',
+	'acl_f_email'		=> 'Can email topics',
+	'acl_f_rate'		=> 'Can rate posts',
+	'acl_f_report'		=> 'Can report posts',
+	'acl_f_print'		=> 'Can print topics',
+	'acl_f_ignoreflood' => 'Can ignore flood limit',
+	'acl_f_postcount'	=> 'Increment post counter',
+	'acl_f_moderate'	=> 'Posts are moderated',
+	'acl_f_bump'		=> 'Can bump topics',
+	'acl_f_subscribe'	=> 'Can subscribe forum',
+
+	'acl_u_hideonline'	=> 'Can hide online status', 
+	'acl_u_viewonline'	=> 'Can view all online',
+	'acl_u_viewprofile'	=> 'Can view profiles',
+	'acl_u_sendemail'	=> 'Can send emails',
+	'acl_u_sendim'		=> 'Can send instant messages', 
+	'acl_u_sendpm'		=> 'Can send private messages',
+	'acl_u_readpm'		=> 'Can read private messages',
+	'acl_u_chgavatar'	=> 'Can change avatar',
+	'acl_u_chgemail'	=> 'Can change email address',
+	'acl_u_chgname'		=> 'Can change username',
+	'acl_u_chggrp'		=> 'Can change default usergroup',
+	'acl_u_chgpasswd'	=> 'Can change password',
+	'acl_u_chgcensors'	=> 'Can disable word censors',
+	'acl_u_search'		=> 'Can search board',
+	'acl_u_savedrafts'	=> 'Can save drafts',
+	'acl_u_download'	=> 'Can download files',
+	'acl_u_attach'		=> 'Can attach files',
+
+	'acl_u_pm_attach'	=> 'Can attach files in private messages',
+	'acl_u_pm_html'		=> 'Can post HTML in private messages',
+	'acl_u_pm_bbcode'	=> 'Can post BBCode in private messages',
+	'acl_u_pm_smilies'	=> 'Can post smilies in private messages',
+	'acl_u_pm_download'	=> 'Can download files in private messages',
+	'acl_u_pm_sig'		=> 'Can use signature in private messages',
+	'acl_u_pm_report'	=> 'Can report private messages',
+	'acl_u_pm_edit'		=> 'Can edit own private messages',
+	'acl_u_pm_printpm'	=> 'Can print private messages',
+	'acl_u_pm_emailpm'	=> 'Can email private messages',
+	'acl_u_pm_forward'	=> 'Can forward private messages',
+	'acl_u_pm_delete'	=> 'Can remove private messages from own folder',
+	'acl_u_pm_img'		=> 'Can post images in private messages',
+	'acl_u_pm_flash'	=> 'Can post Flash in private messages'
+);
+
+// User pruning
+$this->lang += array(
+	'PRUNE_USERS_EXPLAIN'	=> 'Here you can delete (or deactivate) users from you board. This can be done in a variety of ways; by post count, last activity, etc. Each of these criteria can be combined, i.e. you can prune users last active before 2002-01-01 with fewer than 10 posts. Alternatively you can enter a list of users directly into the text box, any criteria entered will be ignored. Take care with this facility! Once a user is deleted there is no way back.',
+	'SELECT_USERS_EXPLAIN'	=> 'Enter specific usernames here, they will be used in preference to the criteria above.',
+
+	'LAST_ACTIVE_EXPLAIN'		=> 'Enter a date in yyyy-mm-dd format.',
+	'JOINED_EXPLAIN'			=> 'Enter a date in yyyy-mm-dd format.',
+	'DELETE_USER_POSTS'			=> 'Delete pruned user posts',
+	'DELETE_USER_POSTS_EXPLAIN' => 'Removes posts made by deleted users, has no effect if users are deactivated.',
+	'DEACTIVATE_DELETE'			=> 'Deactivate or delete', 
+	'DEACTIVATE_DELETE_EXPLAIN'	=> 'Choose whether to deactivate users or delete them entirely, note there is no undo!', 
+	'DEACTIVATE'				=> 'Deactivate',
+	'DELETE_USERS'				=> 'Delete', 
+
+	'USER_DEACTIVATE_SUCCESS'	=> 'The selected users have been deactivated successfully',
+	'USER_DELETE_SUCCESS'		=> 'The selected users have been deleted successfully',
+);
+
+// Banning
+$this->lang += array(
+	'BAN_EXPLAIN'				=> 'Here you can control the banning of users by name, IP or email address. These methods prevent a user reaching any part of the board. You can give a short (255 character) reason for the ban if you wish. This will be displayed in the admin log. The length of a ban can also be specified. If you want the ban to end on a specific date rather than after a set time period select <u>Until</u> for the ban length and enter a date in yyyy-mm-dd format.',
+	'BAN_EXCLUDE'				=> 'Exclude from banning', 
+
+	'BAN_REASON'	=> 'Reason for ban',
+	'BAN_LENGTH'	=> 'Length of ban',
+	'PERMANENT'		=> 'Permanent',
+	'30_MINS'		=> '30 Minutes',
+	'1_HOUR'		=> '1 Hour',
+	'6_HOURS'		=> '6 Hours',
+	'OTHER'			=> 'Until', 
+
+	'BAN_USERNAME_EXPLAIN'		=> 'You can ban multiple users in one go by entering each name on a new line. Use the <u>Find a Username</u> facility to look up and add one or more users automatically.',
+	'UNBAN_USERNAME'			=> 'Un-ban or Un-exclude usernames',
+	'UNBAN_USERNAME_EXPLAIN'	=> 'You can unban (or un-exclude) multiple users in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded users have a grey background.',
+	'BAN_USER_EXCLUDE_EXPLAIN'	=> 'Enable this to exclude the entered users from all current bans.', 
+	'NO_BANNED_USERS'			=> 'No banned usernames',
+
+	'IP_HOSTNAME'			=> 'IP addresses or hostnames',
+	'BAN_IP_EXPLAIN'		=> 'To specify several different IP\'s or hostnames enter each on a new line. To specify a range of IP addresses separate the start and end with a hyphen (-), to specify a wildcard use *',
+	'UNBAN_IP'				=> 'Un-ban or Un-exclude IPs',
+	'UNBAN_IP_EXPLAIN'		=> 'You can unban (or un-exclude) multiple IP addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded IP\'s have a grey background.',
+	'BAN_IP_EXCLUDE_EXPLAIN'=> 'Enable this to exclude the entered IP from all current bans.', 
+	'NO_BANNED_IP'			=> 'No banned IP addresses',
+
+	'BAN_EMAIL'					=> 'Ban one or more email addresses',
+	'BAN_EMAIL_EXPLAIN'			=> 'To specify more than one email address enter each on a new line. To match partial addresses use * as the wildcard, e.g. *@hotmail.com, *@*.domain.tld, etc.',
+	'UNBAN_EMAIL'				=> 'Un-ban or Un-exclude Emails',
+	'UNBAN_EMAIL_EXPLAIN'		=> 'You can unban (or un-exclude) multiple email addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded email addresses have a grey background.',
+	'BAN_EMAIL_EXCLUDE_EXPLAIN' => 'Enable this to exclude the entered email address from all current bans.', 
+	'NO_BANNED_EMAIL'			=> 'No banned email addresses',
+
+	'BAN_UPDATE_SUCESSFUL'	=> 'The banlist has been updated successfully', 
+);
+
+// Jabber settings
+$this->lang += array(
+	'IM_EXPLAIN'	=> 'Here you can enable and control the use Jabber for instant messaging and board notices. Jabber is an opensource protocol and therefore available for use by anyone. Some Jabber servers include gateways or transports which allow you to contact users on other networks. Not all servers offer all transports and changes in protocols can prevent transports from operating. Note that it may take several seconds to update Jabber account details, do not stop the script till completed!', 
+
+	'JAB_ENABLE'			=> 'Enable Jabber', 
+	'JAB_ENABLE_EXPLAIN'	=> 'Enables use of jabber messaging and notifications', 
+
+	'JAB_SERVER'			=> 'Jabber server', 
+	'JAB_SERVER_EXPLAIN'	=> 'See %sjabber.org%s for a list of servers', 
+	'JAB_PORT'				=> 'Jabber port', 
+	'JAB_PORT_EXPLAIN'		=> 'Leave blank unless you know it is not 5222', 
+	'JAB_USERNAME'			=> 'Jabber username', 
+	'JAB_USERNAME_EXPLAIN'	=> 'If this user is not registered it will be created if possible.', 
+	'JAB_PASSWORD'			=> 'Jabber password', 
+	'JAB_RESOURCE'			=> 'Jabber resource', 
+	'JAB_RESOURCE_EXPLAIN'	=> 'The resource locates this particular connection, e.g. board, home, etc.', 
+
+	'JAB_PASS_CHANGED'		=> 'Jabber password changed successfully', 
+	'JAB_REGISTERED'		=> 'New account registered successfully', 
+	'JAB_CHANGED'			=> 'Jabber account changed successfully', 
+
+	'ERR_JAB_USERNAME'		=> 'The username specified already exists, please choose an alternative.', 
+	'ERR_JAB_REGISTER'		=> 'An error occured trying to register this account, %s', 
+	'ERR_JAB_PASSCHG'		=> 'Could not change password', 
+	'ERR_JAB_PASSFAIL'		=> 'Password update failed, %s', 
+);
+
+// Message Settings
+$this->lang += array(
+	'MESSAGE_SETTINGS_EXPLAIN'	=> 'Here you can set all default settings for private messaging',
+		
+	'BOXES_MAX'					=> 'Max private message folders',
+	'BOXES_MAX_EXPLAIN'			=> 'By default users may create this many personal folders for private messages..',
+	'BOXES_LIMIT'				=> 'Max private messages per box',
+	'BOXES_LIMIT_EXPLAIN'		=> 'Users may receive no more than this many messages in each of their private message boxes or zero for unlimited messages.',
+	'FULL_FOLDER_ACTION'		=> 'Full folder default action',
+	'FULL_FOLDER_ACTION_EXPLAIN'=> 'Default Action to take if an users folder is full and if the users folder action set is not applicable. For the special folder "SENTBOX" the default action is always deleting old messages.',
+	'HOLD_NEW_MESSAGES'			=> 'Hold new messages',
+	'PM_EDIT_TIME'				=> 'Limit editing time',
+	'PM_EDIT_TIME_EXPLAIN'		=> 'Limits the time available to edit a private message not already delivered, zero equals infinity',
+
+	'ALLOW_MASS_PM'		=> 'Allow Mass PM\'s',
+	'ALLOW_HTML_PM'		=> 'Allow HTML in private messages',
+	'ALLOW_BBCODE_PM'	=> 'Allow BBCode in private messages',
+	'ALLOW_SMILIES_PM'	=> 'Allow smilies in private messages',
+	'ALLOW_DOWNLOAD_PM'	=> 'Allow downloading of attachments in private messages',
+	'ALLOW_SIG_PM'		=> 'Allow signatures in private messages',
+	'ALLOW_REPORT_PM'	=> 'Allow reporting of private messages',
+	'ALLOW_FORWARD_PM'	=> 'Allow forwarding of private messages',
+	'ALLOW_QUOTE_PM'	=> 'Allow quoting of private messages',
+	'ALLOW_PRINT_PM'	=> 'Allow print view in private messaging',
+	'ALLOW_EMAIL_PM'	=> 'Allow emailing private messages',
+	'ALLOW_IMG_PM'		=> 'Allow use of IMG BBCode Tag',
+	'ALLOW_FLASH_PM'	=> 'Allow use of FLASH BBCode Tag',
+	'ENABLE_PM_ICONS'	=> 'Enable use of topic icons in private messages'
+);
+
+// Cookie settings
+$this->lang += array(
+	'COOKIE_SETTINGS_EXPLAIN'	=> 'These details define the data used to send cookies to your users browsers. In most cases the default values for the cookie settings should be sufficient. If you do need to change any do so with care, incorrect settings can prevent users logging in.',
+
+	'COOKIE_DOMAIN'			=> 'Cookie domain',
+	'COOKIE_NAME'			=> 'Cookie name',
+	'COOKIE_PATH'			=> 'Cookie path',
+	'COOKIE_SECURE'			=> 'Cookie secure',
+	'COOKIE_SECURE_EXPLAIN' => 'If your server is running via SSL set this to enabled else leave as disabled',
+);
+
+// Avatar settings
+$this->lang += array(
+	'AVATAR_SETTINGS_EXPLAIN'	=> 'Avatars are generally small, unique images a user can associate with themselves. Depending on the style they are usually displayed below the username when viewing topics. Here you can determine how users can define their avatars. Please note that in order to upload avatars you need to have created the directory you name below and ensure it can be written to by the web server. Please also note that filesize limits are only imposed on uploaded avatars, they do not apply to remotely linked images.',
+	'ALLOW_LOCAL'				=> 'Enable gallery avatars',
+	'ALLOW_REMOTE'				=> 'Enable remote avatars',
+	'ALLOW_REMOTE_EXPLAIN'		=> 'Avatars linked to from another website',
+	'ALLOW_UPLOAD'				=> 'Enable avatar uploading',
+	'MAX_FILESIZE'				=> 'Maximum Avatar File Size',
+	'MAX_FILESIZE_EXPLAIN'		=> 'For uploaded avatar files',
+	'MIN_AVATAR_SIZE'			=> 'Minimum Avatar Dimensions',
+	'MIN_AVATAR_SIZE_EXPLAIN'	=> '(Height x Width in pixels)',
+	'MAX_AVATAR_SIZE'			=> 'Maximum Avatar Dimensions',
+	'MAX_AVATAR_SIZE_EXPLAIN'	=> '(Height x Width in pixels)',
+	'AVATAR_STORAGE_PATH'		=> 'Avatar Storage Path',
+	'AVATAR_STORAGE_PATH_EXPLAIN'	=> 'Path under your phpBB root dir, e.g. images/avatars/upload',
+	'AVATAR_GALLERY_PATH'			=> 'Avatar Gallery Path',
+	'AVATAR_GALLERY_PATH_EXPLAIN'	=> 'Path under your phpBB root dir for pre-loaded images, e.g. images/avatars/gallery',
+);
+
+// Server settings
+$this->lang += array(
+	'SERVER_SETTINGS_EXPLAIN'	=> 'Here you define server and domain dependant settings. Please ensure the data you enter is accurate, errors will result in emails containing incorrect information. When entering the domain name remember it does include http:// or other protocol term. Only alter the port number if you know your server uses a different value, port 80 is correct in most cases.',
+	'SERVER_NAME'				=> 'Domain Name',
+	'SERVER_NAME_EXPLAIN'		=> 'The domain name this board runs from',
+	'SCRIPT_PATH'				=> 'Script path',
+	'SCRIPT_PATH_EXPLAIN'		=> 'The path where phpBB2 is located relative to the domain name',
+	'SERVER_PORT'				=> 'Server Port',
+	'SERVER_PORT_EXPLAIN'		=> 'The port your server is running on, usually 80, only change if different',
+	'IP_VALID'					=> 'Session IP validation',
+	'IP_VALID_EXPLAIN'			=> 'Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.',
+	'ALL'						=> 'All',
+	'CLASS_C'					=> 'A.B.C',
+	'CLASS_B'					=> 'A.B', 
+	'BROWSER_VALID'				=> 'Validate browser', 
+	'BROWSER_VALID_EXPLAIN'		=> 'Enables browser validation for each session inproving security.', 
+	'ENABLE_GZIP'				=> 'Enable GZip Compression',
+	'SMILIES_PATH'				=> 'Smilies storage path',
+	'SMILIES_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/smiles',
+	'ICONS_PATH'				=> 'Post icons storage path',
+	'ICONS_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/icons',
+	'UPLOAD_ICONS_PATH'			=> 'Extension group icons storage path',
+	'UPLOAD_ICONS_PATH_EXPLAIN'	=> 'Path under your phpBB root dir, e.g. images/upload_icons',
+	'RANKS_PATH'				=> 'Rank image storage path',
+	'RANKS_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/ranks',
+);
+
+// Load settings
+$this->lang += array(
+	'LOAD_SETTINGS_EXPLAIN'		=> 'Here you can enable and disable certain board functions to reduce the amount of processing required. On most servers there is no need to disable any functions. However on certain systems or in shared hosting environments it may be beneficial to disable capabilities you do not really need. You can also specify limits for system load and active sessions beyond which the board will go offline.', 
+	'LIMIT_LOAD'				=> 'Limit system load',
+	'LIMIT_LOAD_EXPLAIN'		=> 'If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.',
+	'LIMIT_SESSIONS'			=> 'Limit sessions',
+	'LIMIT_SESSIONS_EXPLAIN'	=> 'If the number of sessions exceeds this value within a one minute period the board will go offline. Set to 0 for unlimited sessions.',
+	'SESSION_LENGTH'			=> 'Session length', 
+	'SESSION_LENGTH_EXPLAIN'	=> 'Sessions will expire after this time, in seconds.', 
+	'YES_POST_MARKING'			=> 'Enable dotted topics', 
+	'YES_POST_MARKING_EXPLAIN'	=> 'Indicates whether user has posted to a topic.', 
+	'YES_READ_MARKING'			=> 'Enable server-side topic marking', 
+	'YES_READ_MARKING_EXPLAIN'	=> 'Stores read/unread status information in the database rather than a cookie.', 
+	'ONLINE_LENGTH'				=> 'View online time span', 
+	'ONLINE_LENGTH_EXPLAIN'		=> 'Time in minutes after which inactive users will not appear in viewonline listings, lower equals less processing.', 
+	'YES_ONLINE'				=> 'Enable online user listings', 
+	'YES_ONLINE_EXPLAIN'		=> 'Display online user information on index, forum and topic pages.', 
+	'YES_ONLINE_TRACK'			=> 'Enable display of user online img', 
+	'YES_ONLINE_TRACK_EXPLAIN'	=> 'Display online information for user in profiles and viewtopic.', 
+	'YES_BIRTHDAYS'				=> 'Enable birthday listing', 
+	'YES_MODERATORS'			=> 'Enable display of Moderators', 
+	'YES_JUMPBOX'				=> 'Enable display of Jumpbox', 
+	'YES_SEARCH'				=> 'Enable search facilities', 
+	'YES_SEARCH_EXPLAIN'		=> 'User and backend search functions including fulltext updates when posting.', 
+	'YES_SEARCH_UPDATE'			=> 'Enable fulltext updating', 
+	'YES_SEARCH_UPDATE_EXPLAIN'	=> 'Updating of fulltext indexes when posting, overriden if search is disabled.', 
+	'YES_SEARCH_PHRASE'			=> 'Enable phrase searching', 
+	'YES_SEARCH_PHRASE_EXPLAIN'	=> 'Searching for phrases requires additional processing.', 
+	'RECOMPILE_TEMPLATES'		=> 'Recompile stale templates', 
+	'RECOMPILE_TEMPLATES_EXPLAIN'=> 'Check for updated template files on filesystem and recompile.', 
+);
+
+// Email settings
+$this->lang += array(
+	'EMAIL_SETTINGS_EXPLAIN'	=> 'This information is used when the board sends emails to your users. Please ensure the email address you specify is valid, any bounced or undeliverable messages will likely be sent to that address. If your host does not provide a native (PHP based) email service you can instead send messages directly using SMTP. This requires the address of an appropriate server (ask your provider if necessary), do not specify any old name here! If the server requires authentication (and only if it does) enter the necessary username and password. Please note only basic authentication is offered, different authentication implementations are not currently supported.',
+	'ENABLE_EMAIL'				=> 'Enable board-wide emails',
+	'ENABLE_EMAIL_EXPLAIN'		=> 'If this is set to disabled no emails will be sent by the board at all.',
+	'BOARD_EMAIL_FORM'			=> 'Users send email via board',
+	'BOARD_EMAIL_FORM_EXPLAIN'	=> 'This function keeps email addresses completely private.',
+	'EMAIL_FUNCTION_NAME'		=> 'Email Function Name',
+	'EMAIL_FUNCTION_NAME_EXPLAIN' => 'The email function used to send mails through PHP.',
+	'EMAIL_PACKAGE_SIZE'		=> 'Email Package Size',
+	'EMAIL_PACKAGE_SIZE_EXPLAIN' => 'This is the number of emails sent in one package.',
+	'ADMIN_EMAIL'				=> 'Return Email Address',
+	'ADMIN_EMAIL_EXPLAIN'		=> 'This will be used as the return address on all emails.', 
+	'EMAIL_SIG'					=> 'Email Signature',
+	'EMAIL_SIG_EXPLAIN'			=> 'This text will be attached to all emails the board sends.',
+	'CONTACT_EMAIL'				=> 'Contact email address', 
+	'CONTACT_EMAIL_EXPLAIN'		=> 'This address will be used whenever a specific contact point is needed, e.g. spam, error output, etc.', 
+	'USE_SMTP'					=> 'Use SMTP Server for email',
+	'USE_SMTP_EXPLAIN'			=> 'Say yes if you want or have to send email via a named server instead of the local mail function.',
+	'SMTP_SERVER'				=> 'SMTP Server Address',
+	'SMTP_PORT'					=> 'SMTP Server Port',
+	'SMTP_PORT_EXPLAIN'			=> 'Only change this if you know your SMTP server is on a different port.',
+	'SMTP_AUTH_METHOD'			=> 'Authentication method for SMTP', 
+	'SMTP_AUTH_METHOD_EXPLAIN'	=> 'Only used if a username/password is set, ask your provider if you are unsure which method to use.', 
+	'SMTP_LOGIN'				=> 'LOGIN', 
+	'SMTP_PLAIN'				=> 'PLAIN', 
+	'SMTP_CRAM_MD5'				=> 'CRAM-MD5',
+	'SMTP_DIGEST_MD5'			=> 'DIGEST-MD5',
+	'SMTP_POP_BEFORE_SMTP'		=> 'POP-BEFORE-SMTP',
+	'SMTP_USERNAME'				=> 'SMTP Username',
+	'SMTP_USERNAME_EXPLAIN'		=> 'Only enter a username if your smtp server requires it.',
+	'SMTP_PASSWORD'				=> 'SMTP Password',
+	'SMTP_PASSWORD_EXPLAIN'		=> 'Only enter a password if your smtp server requires it.',
+);
+
+// Board settings
+$this->lang += array(
+	'BOARD_SETTINGS_EXPLAIN'	=> 'Here you can determine the basic operation of your board, from the site name through user registration to private messaging.',
+	'SITE_NAME'					=> 'Site name',
+	'SITE_DESC'					=> 'Site description',
+	'DISABLE_BOARD'				=> 'Disable board',
+	'DISABLE_BOARD_EXPLAIN'		=> 'This will make the board unavailable to users. You can also enter a short (255 character) message to display if you wish.',
+	'ACC_ACTIVATION'			=> 'Account activation',
+	'ACC_ACTIVATION_EXPLAIN'	=> 'This determines whether users have immediate access to the board or if confirmation is required. You can also completely disable new registrations.',
+	'ACC_NONE'					=> 'None',
+	'ACC_USER'					=> 'User',
+	'ACC_ADMIN'					=> 'Admin',
+	'ACC_USER_ADMIN'			=> 'User + Admin',
+	'ACC_DISABLE'				=> 'Disable',
+	'VISUAL_CONFIRM'			=> 'Enable visual confirmation',
+	'VISUAL_CONFIRM_EXPLAIN'	=> 'Requires new users enter a random code matching an image to help prevent mass registrations.',
+	'REG_LIMIT'					=> 'Registration attempts', 
+	'REG_LIMIT_EXPLAIN'			=> 'Number of attempts users can make at the confirmation code before being locked out that session.', 
+	'FORCE_PASS_CHANGE'			=> 'Force password change', 
+	'FORCE_PASS_CHANGE_EXPLAIN'	=> 'Require user to change their password after a set number of days or zero to disable.', 
+	'CHAR_LIMIT'				=> 'Max characters per post',
+	'CHAR_LIMIT_EXPLAIN'		=> 'Set to 0 for unlimited characters.',
+	'SMILIES_LIMIT'				=> 'Max smilies per post',
+	'SMILIES_LIMIT_EXPLAIN'		=> 'Set to 0 for unlimited smilies.',
+	'QUOTE_DEPTH_LIMIT'			=> 'Max nested quotes per post',
+	'QUOTE_DEPTH_LIMIT_EXPLAIN'	=> 'Set to 0 for unlimited depth.',
+	'USERNAME_LENGTH'			=> 'Username length', 
+	'USERNAME_LENGTH_EXPLAIN'	=> 'Minimum and maximum number of characters in usernames.', 
+	'USERNAME_CHARS'			=> 'Limit username chars', 
+	'USERNAME_CHARS_EXPLAIN'	=> 'Restrict type of characters that may be used in usernames, spacers are; space, -, +, _, [ and ]', 
+	'PASSWORD_LENGTH'			=> 'Password length', 
+	'PASSWORD_LENGTH_EXPLAIN'	=> 'Minimum and maximum number of characters in passwords.', 
+	'PASSWORD_TYPE'				=> 'Password complexity',
+	'PASSWORD_TYPE_EXPLAIN'		=> 'Determines how complex a password needs to be when set or altered, subsequent options include the previous ones.', 
+	'PASS_TYPE_ANY'				=> 'No requirements', 
+	'PASS_TYPE_CASE'			=> 'Must be mixed case', 
+	'PASS_TYPE_ALPHA'			=> 'Must contain alphanumerics', 
+	'PASS_TYPE_SYMBOL'			=> 'Must contain symbols', 
+	'MIN_CHARS'					=> 'Min', 
+	'MAX_CHARS'					=> 'Max', 
+	'ALLOW_EMAIL_REUSE'			=> 'Allow Email address re-use',
+	'ALLOW_EMAIL_REUSE_EXPLAIN'	=> 'Different users can register with the same email address.',
+	'USERNAME_CHARS_ANY'		=> 'Any character', 
+	'USERNAME_ALPHA_ONLY'		=> 'Alphanumeric only', 
+	'USERNAME_ALPHA_SPACERS'	=> 'Alphanumeric and spacers', 
+	'ENABLE_COPPA'				=> 'Enable COPPA',
+	'ENABLE_COPPA_EXPLAIN'		=> 'This requires users to declare whether they are 13 or over for compliance with the U.S. COPPA act.',
+	'COPPA_FAX'					=> 'COPPA Fax Number',
+	'COPPA_MAIL'				=> 'COPPA Mailing Address',
+	'COPPA_MAIL_EXPLAIN'		=> 'This is the mailing address where parents will send COPPA registration forms',
+	'BOARD_PM'					=> 'Private Messaging', 
+	'BOARD_PM_EXPLAIN'			=> 'Enable or disable private messaging for all users.', 
+	'EDIT_TIME'					=> 'Limit editing time',
+	'EDIT_TIME_EXPLAIN'			=> 'Limits the time available to edit a new post, zero equals infinity',
+	'DISPLAY_LAST_EDITED'		=> 'Display last edited time information',
+	'DISPLAY_LAST_EDITED_EXPLAIN' => 'Choose if the last edited by information to be displayed on posts',
+	'FLOOD_INTERVAL'			=> 'Flood Interval',
+	'FLOOD_INTERVAL_EXPLAIN'	=> 'Number of seconds a user must wait between posting new messages. To enable users to ignore this alter their permissions.',
+	'BUMP_INTERVAL'				=> 'Bump Interval',
+	'BUMP_INTERVAL_EXPLAIN'		=> 'Number of minutes, hours or days between the last post to a topic and the ability to bump this topic.',
+	'SEARCH_INTERVAL'			=> 'Search Flood Interval',
+	'SEARCH_INTERVAL_EXPLAIN'	=> 'Number of seconds users must wait between searches.',
+	'MIN_SEARCH_CHARS'			=> 'Min characters indexed by search',
+	'MIN_SEARCH_CHARS_EXPLAIN'	=> 'Words with at least this many characters will be indexed for searching.',
+	'MAX_SEARCH_CHARS'			=> 'Max characters indexed by search',
+	'MAX_SEARCH_CHARS_EXPLAIN'	=> 'Words with no more than this many characters will be indexed for searching.',
+	'TOPICS_PER_PAGE'			=> 'Topics Per Page',
+	'POSTS_PER_PAGE'			=> 'Posts Per Page',
+	'HOT_THRESHOLD'				=> 'Posts for Popular Threshold',
+	'MAX_POLL_OPTIONS'			=> 'Max number of poll options',
+);
+
+// Auth settings
+$this->lang += array(
+	'AUTH_SETTINGS_EXPLAIN'	=> 'phpBB2 supports authentication plug-ins, or modules. These allow you determine how users are authenticated when they log into the board. By default three plug-ins are provided; DB, LDAP and Apache. Not all methods require additional information so only fill out fields if they are relevant to the selected method.',
+	'AUTH_METHOD'			=> 'Select an authentication method',
+	'LDAP_SERVER'			=> 'LDAP server name',
+	'LDAP_SERVER_EXPLAIN'	=> 'If using LDAP this is the name or IP address of the server.',
+	'LDAP_DN'				=> 'LDAP base dn',
+	'LDAP_DN_EXPLAIN'		=> 'This is the Distinguished Name, locating the user information, e.g. o=My Company,c=US',
+	'LDAP_UID'				=> 'LDAP uid',
+	'LDAP_UID_EXPLAIN'		=> 'This is the key under which to search for a given login identity, e.g. uid, sn, etc.',
+);
+
+// Board defaults
+$this->lang += array(
+	'BOARD_DEFAULTS_EXPLAIN'	=> 'These settings allow you to define a number of default or global settings used by the board. For example, to disable the use of HTML across the entire board alter the relevant setting below. This data is also used for new user registrations and (where relevant) guest users. Please note that registered users can override some of these options with their own settings.',
+	'DEFAULT_STYLE'				=> 'Default Style',
+	'OVERRIDE_STYLE'			=> 'Override user style',
+	'OVERRIDE_STYLE_EXPLAIN'	=> 'Replaces users style with the default.',
+	'DEFAULT_LANGUAGE'			=> 'Default Language',
+	'DEFAULT_DATE_FORMAT'		=> 'Date Format',
+	'DEFAULT_DATE_FORMAT_EXPLAIN'=> 'The date format is the same as the PHP date function.',
+	'SYSTEM_TIMEZONE'			=> 'System Timezone',
+	'SYSTEM_DST'				=> 'Enable Daylight Savings Time',
+	'ALLOW_TOPIC_NOTIFY'		=> 'Allow Topic Watching',
+	'ALLOW_FORUM_NOTIFY'		=> 'Allow Forum Watching',
+	'ALLOW_NAME_CHANGE'			=> 'Allow Username changes',
+
+	'MIN_RATINGS'				=> 'Ratings count before karma',
+	'MIN_RATINGS_EXPLAIN'		=> 'Number of distinct ratings before users karma is calculated.',
+	'ALLOW_ATTACHMENTS'			=> 'Allow Attachments',
+	'ALLOW_PM_ATTACHMENTS'		=> 'Allow Attachments in Private Messages',
+	'ALLOW_HTML'				=> 'Allow HTML',
+	'ALLOWED_TAGS'				=> 'Allowed HTML tags',
+	'ALLOWED_TAGS_EXPLAIN'		=> 'Separate tags with commas.',
+	'ALLOW_BBCODE'				=> 'Allow BBCode',
+	'ALLOW_SMILIES'				=> 'Allow Smilies',
+	'ALLOW_SIG'					=> 'Allow Signatures',
+	'MAX_SIG_LENGTH'			=> 'Maximum signature length',
+	'MAX_SIG_LENGTH_EXPLAIN'	=> 'Maximum number of characters in user signatures.',
+	'ALLOW_NO_CENSORS'			=> 'Allow Disable of Censors',
+	'ALLOW_NO_CENSORS_EXPLAIN'	=> 'User can disable word censoring.',
+	'ALLOW_BOOKMARKS'			=> 'Allow bookmarking topics',
+	'ALLOW_BOOKMARKS_EXPLAIN'	=> 'User is able to store personal bookmarks'
+);
+
+// Karma settings
+$this->lang += array(
+	'KARMA_SETTINGS'		=> 'Karma Settings', 
+	'KARMA_SETTINGS_EXPLAIN'=> 'Here you can enable and disable the user Karma rating system. You can also modify the weighting factors used to derive each users karma.', 
+	'ENABLE_KARMA'			=> 'Enable Karma',
+
+	'KARMA_HIST_WEIGHT'			=> 'Historical ratings weighting', 
+	'KARMA_HIST_WEIGHT_EXPLAIN'	=> 'Ratings made before the previous 30 days', 
+	'KARMA_DAY_WEIGHT'			=> 'Recent ratings weighting', 
+	'KARMA_DAY_WEIGHT_EXPLAIN'	=> 'Ratings made in past 30 days', 
+	'KARMA_REG_WEIGHT'			=> 'Membership length weighting', 
+	'KARMA_REG_WEIGHT_EXPLAIN'	=> 'Total length of membership', 
+	'KARMA_POST_WEIGHT'			=> 'Total posts weighting', 
+);
+
+// Avatars
+$this->lang += array(
+	'AVATARS_GALLERY'	=> 'Avatar Gallery', 
+);
+
+// PHP info
+$this->lang += array(
+	'PHP_INFO_EXPLAIN'	=> 'This page lists information on the version of PHP installed on this server. It includes details of loaded modules, available variables and default settings. This information may be useful when diagnosing problems. Please be aware that some hosting companies will limit what information is displayed here for security reasons. You are advised to not give out any details on this page except when asked by support or other Team Member on the support forums.', 
+);
+
+// Forum admin
+$this->lang += array(
+	'FORUM_ADMIN'			=> 'Forum Administration',
+	'FORUM_ADMIN_EXPLAIN'	=> 'In phpBB 2.2 there are no categories, everything is forum based. Each forum can have an unlimited number of sub-forums and you can determine whether each may be posted to or not (i.e. whether it acts like an old category). Here you can add, edit, delete, lock, unlock individual forums as well as set certain additional controls. If your posts and topics have got out of sync you can also resynchronise a forum.',
+	'FORUM_EDIT_EXPLAIN'	=> 'The form below will allow you to customise this forum. Please note that moderation and post count controls are set via forum permissions for each user or usergroup.',
+	'FORUM_DELETE'			=> 'Delete Forum',
+	'FORUM_DELETE_EXPLAIN'	=> 'The form below will allow you to delete a forum and decide where you want to put all topics (or forums) it contained.', 
+
+	'EDIT_FORUM'	=> 'Edit forum',
+	'CREATE_FORUM'	=> 'Create new forum',
+	'REMOVE'		=> 'Remove',
+	'EDIT'			=> 'Edit',
+	'MOVE_UP'		=> 'Move up',
+	'MOVE_DOWN'		=> 'Move down',
+	'RESYNC'		=> 'Sync',
+	'UPDATE'		=> 'Update',
+
+	'FORUM_SETTINGS'	=> 'Forum Settings', 
+	'FORUM_GENERAL'		=> 'General Forum Settings',
+	'FORUM_TYPE'		=> 'Forum Type', 
+	'TYPE_FORUM'		=> 'Forum', 
+	'TYPE_CAT'			=> 'Category', 
+	'TYPE_LINK'			=> 'Link', 
+	'FORUM_NAME'		=> 'Forum Name',
+	'FORUM_DESC'		=> 'Description', 
+	'FORUM_DESC_EXPLAIN'=> 'Any markup entered here will displayed as is.', 
+	'FORUM_LINK'		=> 'Forum Link',
+	'FORUM_LINK_EXPLAIN'=> 'Full URL to location clicking this forum will take the user.',
+	'FORUM_LINK_TRACK'	=> 'Track Link Redirects', 
+	'FORUM_LINK_TRACK_EXPLAIN'	=> 'Records the number of times a forum link was clicked.', 
+	'FORUM_STATUS'		=> 'Forum Status',
+	'FORUM_STYLE'		=> 'Forum Style', 
+	'FORUM_IMAGE'		=> 'Forum Image', 
+	'FORUM_IMAGE_EXPLAIN'=> 'Location, relative to the phpBB root directory, of an image to associate with this forum.',
+	'FORUM_PARENT'		=> 'Parent Forum',
+
+	'FORUM_RULES'			=> 'Forum Rules',
+	'FORUM_RULES_EXPLAIN'	=> 'Forum Rules are displayed at any page within the given forum.',
+	'FORUM_RULES_LINK'		=> 'Link to Forum Rules',
+	'FORUM_RULES_LINK_EXPLAIN'=> 'You are able to enter the URL of the page/post containing your forum rules here. This setting will override the Forum Rules text you specified.',
+	'FORUM_RULES_PREVIEW'	=> 'Forum Rules preview',
+	'PARSE_BBCODE'			=> 'Parse BBCode',
+	'PARSE_SMILIES'			=> 'Parse Smilies',
+	'PARSE_URLS'			=> 'Parse Links',
+
+	'NO_PARENT'			=> 'No Parent',
+	'LINK'				=> 'Link',
+	'LOCKED'			=> 'Locked',
+	'UNLOCKED'			=> 'Unlocked', 
+	'ENABLE_NEWS'		=> 'Set as news forum', 
+	'ENABLE_NEWS_EXPLAIN' => 'If set to yes posts in this forum will be displayed as news items.',
+	'ENABLE_RECENT'		=> 'Display active topics', 
+	'ENABLE_RECENT_EXPLAIN' => 'If set to yes topics made to this forum will be shown in the active topics list.', 
+	'DISPLAY_ACTIVE_TOPICS'			=> 'Enable active topics', 
+	'DISPLAY_ACTIVE_TOPICS_EXPLAIN'	=> 'If set to yes active topics in selected subforums will be displayed under this category.', 
+	'ENABLE_INDEXING'	=> 'Enable search indexing', 
+	'ENABLE_INDEXING_EXPLAIN'	=> 'If set to yes posts made to this forum will be indexed for searching.', 
+	'ENABLE_TOPIC_ICONS'=> 'Enable Topic Icons', 
+	'LIST_INDEX'		=> 'List Forum On Index',
+	'LIST_INDEX_EXPLAIN'=> 'Displays a link to this forum under the root parent forum on the index.',
+	'FORUM_AUTO_PRUNE'			=> 'Enable Auto-Pruning',
+	'FORUM_AUTO_PRUNE_EXPLAIN'	=> 'Prunes the forum of topics, set the frequency/age parameters below.',
+	'AUTO_PRUNE_FREQ'			=> 'Auto-prune Frequency',
+	'AUTO_PRUNE_FREQ_EXPLAIN'	=> 'Time in days between pruning events.',
+	'AUTO_PRUNE_DAYS'			=> 'Auto-prune Post Age',
+	'AUTO_PRUNE_DAYS_EXPLAIN'	=> 'Number of days since last post after which topic is removed.', 
+	'AUTO_PRUNE_VIEWED'			=> 'Auto-prune Post Viewed Age',
+	'AUTO_PRUNE_VIEWED_EXPLAIN'	=> 'Number of days since topic was viewed after which topic is removed.',
+	'PRUNE_OLD_POLLS'			=> 'Prune Old Polls',
+	'PRUNE_OLD_POLLS_EXPLAIN'	=> 'Removes topics with polls not voted in for post age days.',
+	'PRUNE_FINISHED_POLLS'		=> 'Prune Closed Polls',
+	'PRUNE_FINISHED_POLLS_EXPLAIN'=> 'Removes topics with polls which have ended.',
+	'PRUNE_ANNOUNCEMENTS'		=> 'Prune Announcements',
+	'PRUNE_STICKY'				=> 'Prune Stickies',
+	'FORUM_TOPICS_PAGE'			=> 'Topics Per Page', 
+	'FORUM_TOPICS_PAGE_EXPLAIN'	=> 'If non-zero this value will override the default topics per page setting.', 
+	'ACTIVE_TOPICS_PAGE'			=> 'Number of active topics', 
+	'ACTIVE_TOPICS_PAGE_EXPLAIN'	=> 'If non-zero this value will override the default topics per page setting.', 
+	'FORUM_PASSWORD'			=> 'Forum Password', 
+	'FORUM_PASSWORD_EXPLAIN'	=> 'Defines a password for this forum, use the permission system in preference.', 
+	'FORUM_PASSWORD_CONFIRM'	=> 'Confirm Forum Password', 
+	'FORUM_PASSWORD_CONFIRM_EXPLAIN'	=> 'Only needs to be set if a forum password is entered.', 
+
+	'MOVE_POSTS_TO'		=> 'Move posts',
+	'MOVE_SUBFORUMS_TO' => 'Move subforums',
+	'DELETE_ALL_POSTS'	=> 'Delete posts',
+	'DELETE_SUBFORUMS'	=> 'Delete subforums and posts',
+
+	'NO_DESTINATION_FORUM'		=> 'You have not specified a forum to move content to',
+	'FORUM_PASSWORD_MISMATCH'	=> 'The passwords you entered did not match.',
+	'FORUM_NAME_EMPTY'			=> 'You must enter a name for this forum.', 
+	'FORUM_DATA_NEGATIVE'		=> 'Pruning parameters cannot be negative.', 
+	'FORUM_CREATED'				=> 'Forum created successfully.',
+	'FORUM_UPDATED'				=> 'Forum informations updated successfully.', 
+	'REDIRECT_ACL'				=> 'To set permissions for this forum click %sHERE%s.', 
+	'FORUM_DELETED'				=> 'Forum successfully deleted',
+	'FORUM_RESYNCED'			=> 'Forum successfully resynced',
+);
+
+// Smiley and topic icons
+$this->lang += array(
+	'ICONS_EXPLAIN'	=> 'From this page you can add, remove and edit the icons users may add to their topics or posts. These icons are generally displayed next to topic titles on the forum listing, or the post subjects in topic listings. You can also install and create new packages of icons.',
+	'SMILE_EXPLAIN' => 'Smilies or emoticons are typically small, sometimes animated images used to convey an emotion or feeling. From this page you can add, remove and edit the emoticons users can use in their posts and private messages. You can also install and create new packages of smilies.',
+	'IMPORT_SMILE'	=> 'Install smilies pak',
+	'EXPORT_SMILE'	=> 'Create smilies pak',
+	'IMPORT_ICONS'	=> 'Install icons pak',
+	'EXPORT_ICONS'	=> 'Create icons pak',
+	'MASS_ADD_SMILE'=> 'Add multiple smilies',
+	'ADD_SMILE'		=> 'Add single smilie',
+	'ADD_ICONS'		=> 'Add single icon',
+	'ADD_ICONS'		=> 'Add multiple icons',
+	'EDIT_SMILE'	=> 'Edit smilies',
+	'EDIT_ICONS'	=> 'Edit Icons',
+	'SMILE_NOT_DISPLAYED' => 'The following smilies are not displayed on the posting page',
+	'ICONS_NOT_DISPLAYED' => 'The following icons are not displayed on the posting page',
+	'EMOTION'		=> 'Emotion',
+	'REORDER'		=> 'Reorder',
+	'DISPLAY'		=> 'Display',
+	'DIMENSIONS'	=> 'Dimensions',
+	'FIRST'			=> 'First',
+	'AFTER_SMILE'	=> 'After %s',
+	'AFTER_ICONS'	=> 'After %s',
+	'SMILE_CONFIG'	=> 'Smilie configuration',
+	'SMILE_IMAGE'	=> 'Smilie image', 
+	'SMILE_CODE'	=> 'Smilie code',
+	'SMILE_URL'		=> 'Smilie image file',
+	'SMILE_ORDER'	=> 'Smilie order',
+	'SMILE_EMOTION' => 'Emotion',
+	'SMILE_ADD'		=> 'Add a new Smilie',
+	'SMILE_EDIT'	=> 'Edit Smilie',
+	'SMILE_LOCATION'=> 'Smilie location',
+	'ICONS_CONFIG'	=> 'Icon configuration',
+	'ICONS_IMAGE'	=> 'Icon image', 
+	'ICONS_ORDER'	=> 'Icon order',
+	'ICONS_LOCATION'=> 'Icon location',
+	'ICONS_ADD'		=> 'Add a new Icon',
+	'ICONS_EDIT'	=> 'Edit Icon',
+	'EXPORT_SMILE_EXPLAIN' => 'To create a package of your currently installed smilies, click %sHERE%s to download the emoticons.pak file. Once downloaded create a zip or tgz file containing all of your smilies plus this .pak configuration file.',
+	'EXPORT_ICONS_EXPLAIN' => 'To create a package of your currently installed icons, click %sHERE%s to download the icons package file. Once downloaded create a zip or tgz file containing all of your icons plus this .pak configuration file.',
+	'NO_SMILE_EXPORT'	=> 'You have no smilies with which to create a package.', 
+	'NO_ICONS_EXPORT'	=> 'You have no icons with which to create a package.', 
+	'WRONG_PAK_TYPE'	=> 'The specified package does not contain the appropriate data.', 
+	'SELECT_PACKAGE'	=> 'Select a package file',
+	'DELETE_ALL'		=> 'Delete all',
+	'KEEP_ALL'			=> 'Keep all',
+	'REPLACE_MATCHES'	=> 'Replace matches',
+	'NO_SMILE_PAK'		=> 'No smilie packages found.',
+	'CURRENT_SMILE'		=> 'Current smilies',
+	'SMILE_IMPORT_SUCCESS' => 'The smilies pack was imported successfully',
+	'NO_ICONS_PAK' => 'No icon packages found.',
+	'CURRENT_ICONS' => 'Current icons',
+	'ICONS_IMPORT_SUCCESS' => 'The icons pack was imported successfully',
+	'SMILE_DELETED' => 'The smilie has been removed successfully.',
+	'SMILE_EDITED' => 'The smilie has been updated successfully.',
+	'SMILE_ADDED' => 'The smilie has been added successfully.',
+	'SMILE_IMPORTED' => 'The smilies pack has been installed successfully.',
+	'ICONS_DELETED' => 'The icon has been removed successfully.',
+	'ICONS_EDITED' => 'The icon has been updated successfully.',
+	'ICONS_ADDED' => 'The icon has been added successfully.',
+	'ICONS_IMPORTED' => 'The icons pack has been installed successfully.',
+);
+
+// Custom bbcodes
+$this->lang += array(
+	'BBCODES'						=>	'BBCodes',
+	'BBCODES_EXPLAIN'			=>	'BBCode is a special implementation of HTML offering greater control over what and how something is displayed. Additionnally, you can save users from typing sometimes very long HTML code by providing them a single BBCode as replacement. From this page you can add, remove and edit custom BBCodes',
+
+	'TOO_MANY_BBCODES'		=>	'You cannot create any more BBCodes. Please remove one or more BBCodes then try again',
+	'BBCODE_NOT_EXIST'		=>	'The BBCode you selected does not exist',
+	'BBCODE_ADDED'				=>	'BBCode added successfully',
+	'BBCODE_EDITED'				=>	'BBCode edited successfully',
+
+	'BBCODE_TAG'					=>	'Tag',
+	'ADD_BBCODE'					=>	'Add a new BBCode',
+
+	// Note to translators: you can translate everything but what's between { and }
+	'BBCODE_USAGE'							=>	'BBCode usage',
+	'BBCODE_USAGE_EXPLAIN'			=>	'Here you define how to use the bbcode. Replace any variable input by the corresponding token (see below)',
+	'BBCODE_USAGE_EXAMPLE'			=>	'[colour={COLOR}]{TEXT}[/colour]<br /><br />[font={TEXT1}]{TEXT2}[/font]',
+	'HTML_REPLACEMENT'					=>	'HTML replacement',
+	'HTML_REPLACEMENT_EXPLAIN'		=>	'Here you define the default HTML replacement (each template can have its own HTML replacement). Do not forget to put back tokens you used above!',
+	'HTML_REPLACEMENT_EXAMPLE'	=>	'&lt;font color="{COLOR}"&gt;{TEXT}&lt;/font&gt;<br /><br />&lt;font face="{TEXT1}"&gt;{TEXT2}&lt;/font&gt;',
+	'TOKENS'										=>	'Tokens',
+	'TOKENS_EXPLAIN'						=>	'Tokens are placeholders for user input. The input will be validated only if it matches the corresponding definition. If needed, you can number them by adding a number as the last character between the braces, e.g. {USERNAME1}, {USERNAME2}.<br /><br />In addition to these tokens you can use any of lang string present in your language/ directory like this: {L_<i>&lt;stringname&gt;</i>} where <i>&lt;stringname&gt;</i> is the name of the translated string you want to add. For example, {L_WROTE} will be displayed as "wrote" or its translation according to user\'s locale',
+
+	'EXAMPLE'										=>	'Example:',
+	'EXAMPLES'									=>	'Examples:',
+
+	'TOKEN'							=>	'Token',
+	'TOKEN_DEFINITION'	 	=>	'What can it be?',
+
+	'tokens'	=>	array(
+		'TEXT'			=>	'Any text, including foreign characters, numbers, etc...',
+		'NUMBER'		=>	'Any serie of digits',
+		'EMAIL'			=>	'A valid email address',
+		'URL'				=>	'A valid URL using any protocol (http, ftp, etc... cannot be used for javascript exploits). If none is given, "http://" is prepended to to the string',
+		'LOCAL_URL'	=>	'A local URL. The URL must be relative to the topic page and cannot contain a server name or protocol',
+		'COLOR'		=>	'A HTML color, can be either in the numeric form #FF1234 or an english name such as "blue"'
+	)
+);
+
+// User admin
+$this->lang += array(
+	'USER_ADMIN'			=> 'User Administration',
+	'USER_ADMIN_EXPLAIN'	=> 'Here you can change your users information and certain specific options. To modify the users permissions please use the user and group permissions system.',
+	'SELECT_USER'			=> 'Select User', 
+
+	'SELECT_FORM'			=> 'Select form', 
+	'USER_ADMIN_OVERVIEW'	=> 'Overview',
+	'USER_ADMIN_FEEDBACK'	=> 'Feedback', 
+	'USER_ADMIN_PROFILE'	=> 'Profile', 
+	'USER_ADMIN_PREFS'		=> 'Preferences', 
+	'USER_ADMIN_AVATAR'		=> 'Avatar', 
+	'USER_ADMIN_SIG'		=> 'Signature', 
+	'USER_ADMIN_GROUP'		=> 'Groups', 
+	'USER_ADMIN_PERM'		=> 'Permissions', 
+	'USER_ADMIN_ATTACH'		=> 'Attachments',
+
+	'FOUNDER'				=> 'Founder', 
+	'FOUNDER_EXPLAIN'		=> 'Founders can never be banned, deleted or altered by non-founder members', 
+	'USER_INFO'				=> 'Basic information', 
+	'REGISTERED'			=> 'Registered', 
+	'REGISTERED_IP'			=> 'Registered from IP', 
+	'LAST_ACTIVE'			=> 'Last active', 
+	'WARNINGS'				=> 'Warnings', 
+	'WARNINGS_EXPLAIN'		=> 'You can directly alter the warnings this users has received.', 
+	'USER_TOOLS'			=> 'Basic tools', 
+	'QUICK_TOOLS'			=> 'Quick tools', 
+	'DELETE_USER'			=> 'Delete users', 
+	'DELETE_USER_EXPLAIN'	=> 'Please note that deleting a user is final, they cannot be recovered', 
+	'RETAIN_POSTS'			=> 'Retain posts', 
+	'DELETE_POSTS'			=> 'Delete posts', 
+	'USER_ADMIN_BAN_USER'	=> 'Ban by username', 
+	'USER_ADMIN_BAN_EMAIL'	=> 'Ban by email', 
+	'USER_ADMIN_BAN_IP'		=> 'Ban by IP', 
+	'USER_ADMIN_FORCE'		=> 'Force re-activation', 
+	'USER_ADMIN_DEACTIVATE'	=> 'Deactivate account', 
+	'USER_ADMIN_ACTIVATE'	=> 'Activate account', 
+	'USER_ADMIN_MOVE_POSTS'	=> 'Move all posts', 
+	'MOVE_POSTS_EXPLAIN'	=> 'Please select the forum to which you wish to move all the posts this user has made.', 
+
+	'USER_POSTING_PREFS'	=> 'Posting preferences', 
+
+	'ADMIN_SIGNATURE_PREVIEW'	=> 'Users signature will appear like this', 
+
+	'USER_ADMIN_BAN_NAME_REASON'	=> 'Username banned via user management', 
+	'USER_ADMIN_BAN_IP_REASON'		=> 'IP banned via user management', 
+	'USER_ADMIN_BAN_EMAIL_REASON'	=> 'Email address banned via user management', 
+
+	'USER_DELETED'			=> 'User deleted successfully',
+	'USER_OVERVIEW_UPDATED'	=> 'User details updated', 
+	'USER_PROFILE_UPDATED'	=> 'User profile updated', 
+	'USER_PREFS_UPDATED'	=> 'User preferences updated', 
+	'USER_ADMIN_INACTIVE'	=> 'User deactivated successfully', 
+	'USER_ADMIN_ACTIVE'		=> 'User activated successfully', 
+);
+
+// Group admin
+$this->lang += array(
+	'GROUP_MANAGE_EXPLAIN' => 'From this panel you can administer all your usergroups, you can; delete, create and edit existing groups. You may choose moderators, toggle open/closed group status and set the group name and description.',
+	'GROUP_MESSAGE_LIMIT'	=>	'Group Message Limit',
+	'GROUP_RECEIVE_PM'		=>	'Group can receive pm',
+	'USER_DEF_GROUPS'			=> 'User defined groups', 
+	'USER_DEF_GROUPS_EXPLAIN'	=> 'These are groups created by you or another admin on this board. You can manage memberships as well as edit group properties or even delete the group. By clicking "Default" you can set the relevant group to the default for all its members.', 
+	'SPECIAL_GROUPS'			=> 'Predefined groups',
+	'SPECIAL_GROUPS_EXPLAIN'	=> 'Pre-defined groups are special groups, they cannot be deleted or directly modified. However you can still add users and alter basic settings. By clicking "Default" you can set the relevant group to the default for all its members.',
+	'TOTAL_MEMBERS'			=> 'Members', 
+	'GROUP_DEFS_UPDATED'	=> 'Default group set for all members', 
+	'CREATE_GROUP'			=> 'Create new group', 
+
+	'GROUP_LIST'			=> 'Current members', 
+	'GROUP_LIST_EXPLAIN'	=> 'This is a complete list of all the current users with membership of this group. You can delete members (except in certain special groups) or add new ones as you see fit.', 
+	'GROUP_MEMBERS'			=> 'Group members', 
+	'GROUP_MEMBERS_EXPLAIN' => 'This is a complete listing of all the members of this usergroup. It includes seperate sections for leaders, pending and existing members. From here you can manage all aspects of who has membership of this group and what their role is. To remove a leader but keep them in the group use Demote rather than delete. Similarly use Promote to make an existing member a leader.', 
+	'GROUP_LEAD'			=> 'Group leaders', 
+	'GROUP_APPROVED'		=> 'Approved Members', 
+	'GROUP_PENDING'			=> 'Pending Members', 
+	'GROUPS_NO_MEMBERS'		=> 'This group has no members', 
+	'GROUPS_NO_MODS'		=> 'No group leaders defined', 
+	'SELECT_OPTION'	=> 'Select option', 
+	'GROUP_DEFAULT'	=> 'Default',
+	'GROUP_APPROVE'	=> 'Approve',
+	'GROUP_PROMOTE'	=> 'Promote',
+	'GROUP_DEMOTE'	=> 'Demote', 
+	'GROUP_DELETE'	=> 'Delete', 
+
+	'ADD_USERS_EXPLAIN'				=> 'Here you can add new users to the group. You may select whether this group becomes the new default for the selected users. Additionally you can define them as group leaders. Please enter each username on a seperate line.', 
+	'USER_DEFAULT'			=> 'User default', 
+	'USER_GROUP_DEFAULT'	=> 'Set as default group', 
+	'USER_GROUP_DEFAULT_EXPLAIN'	=> 'Saying yes here will set this group as the default group for the added users', 
+	'USER_GROUP_LEADER'		=> 'Set as group leader', 
+	'GROUP_USERS_EXIST'		=> 'The selected users are already members.',
+	'GROUP_USERS_ADDED'		=> 'New users added to group successfully.', 
+	'GROUP_MODS_ADDED'		=> 'New group moderators added successfully.', 
+	'USERS_APPROVED'		=> 'Users approved successfully.', 
+
+	'GROUP_EDIT_EXPLAIN'	=> 'Here you can edit an existing group. You can change its name, description and type (open, closed, etc.). You can also set certain groupwide options such as colouration, rank, etc. Changes made here override users current settings. Please note that group members can alter their avatar unless you set appropriate user permissions.', 
+	'GROUP_DETAILS'			=> 'Group details', 
+	'GROUP_NAME'			=> 'Group name',
+	'GROUP_DESC'			=> 'Group description',
+	'GROUP_TYPE'			=> 'Group type', 
+	'GROUP_TYPE_EXPLAIN'	=> 'This determines which users can join or view this group.', 
+	'GROUP_OPEN'			=> 'Open',
+	'GROUP_REQUEST'			=> 'Request',
+	'GROUP_CLOSED'			=> 'Closed',
+	'GROUP_HIDDEN'			=> 'Hidden',
+	'GROUP_COLOR'			=> 'Group colour', 
+	'GROUP_COLOR_EXPLAIN'	=> 'Defines the colour members usernames will appear in, leave blank for user default.', 
+	'FORCE_COLOR'			=> 'Force update', 
+	'GROUP_RANK'			=> 'Group rank', 
+	'GROUP_AVATAR'			=> 'Group avatar', 
+	'GROUP_AVATAR_EXPLAIN'	=> 'This image will be displayed in the Group Control Panel.', 
+	'GROUP_UPDATED'			=> 'Group preferences updated successfully.', 
+	'GROUP_CREATED'			=> 'Group has been created successfully', 
+
+	'GROUP_SETTINGS_SAVE'		=> 'Groupwide settings', 
+	'GROUP_SETTINGS'			=> 'Set user preferences', 
+	'GROUP_SETTINGS_EXPLAIN'	=> 'Here you can force changes in users current preferences. Please note these settings are not saved for the group itself. They are intended as a quick method of altering the preferences of all users in this group.', 
+	'GROUP_LANG'				=> 'Group language', 
+	'GROUP_TIMEZONE'			=> 'Group timezone', 
+	'GROUP_DST'					=> 'Group daylight savings', 
+
+	'GROUP_MODS_DEMOTED'		=> 'Group leaders demoted successfully', 
+	'GROUP_MODS_PROMOTED'		=> 'Group members promoted successfully', 
+	'GROUP_USERS_REMOVE'		=> 'Users removed from group and new defaults set successfully', 
+	'GROUP_DELETED'				=> 'Group deleted and user default groups set successfully', 
+
+	'GROUP_ERR_USERNAME'	=> 'No group name specified.',
+	'GROUP_ERR_USER_LONG'	=> 'Group name too long.',
+	'GROUP_ERR_DESC_LONG'	=> 'Group description too long.',
+	'GROUP_ERR_TYPE'		=> 'Inappropriate group type specified.', 
+	'GROUP_ERR_USERS_EXIST' => 'The specified users are already members of this group', 
+);
+
+// Forum Pruning
+$this->lang += array(
+	'FORUM_PRUNE_EXPLAIN' => 'This will delete any topic which has not been posted to within the number of days you select. If you do not enter a number then all topics will be deleted. It will not remove topics in which polls are still running nor will it remove announcements. You will need to remove these topics manually.',
+	'PRUNE_NOT_POSTED'	=> 'Days since last posted',
+	'PRUNE_NOT_VIEWED'	=> 'Days since last viewed',
+
+	'TOPICS_PRUNED'		=> 'Topics pruned',
+	'POSTS_PRUNED'		=> 'Posts pruned',
+	'PRUNE_SUCCESS'		=> 'Pruning of forums was successful',
+);
+
+// Word censors
+$this->lang += array(
+	'WORDS_TITLE' => 'Word Censoring',
+	'WORDS_EXPLAIN' => 'From this control panel you can add, edit, and remove words that will be automatically censored on your forums. In addition people will not be allowed to register with usernames containing these words. Wildcards (*) are accepted in the word field, eg. *test* will match detestable, test* would match testing, *test would match detest.',
+	'WORD' => 'Word',
+	'EDIT_WORD' => 'Edit word censor',
+	'REPLACEMENT' => 'Replacement',
+	'ADD_WORD' => 'Add new word',
+	'UPDATE_WORD' => 'Update word censor',
+	'ENTER_WORD' => 'You must enter a word and its replacement',
+	'NO_WORD' => 'No word selected for editing',
+	'WORD_UPDATED' => 'The selected word censor has been successfully updated',
+	'WORD_ADDED' => 'The word censor has been successfully added',
+	'WORD_REMOVED' => 'The selected word censor has been successfully removed', 
+);
+
+// Mass email
+$this->lang += array(
+	'MASS_EMAIL_EXPLAIN'	=> 'Here you can email a message to either all of your users, or all users of a specific group.  To do this, an email will be sent out to the administrative email address supplied, with a blind carbon copy sent to all recipients. If you are emailing a large group of people please be patient after submitting and do not stop the page halfway through. It is normal for a mass emailing to take a long time, you will be notified when the script has completed',
+	'COMPOSE'				=> 'Compose',
+	'SEND_TO_GROUP'			=> 'Send to group',
+	'SEND_TO_USERS'			=> 'Send to users',
+	'SEND_TO_USERS_EXPLAIN'	=> 'Entering names here will override any group selected above. Enter each username on a new line.', 
+	'MASS_MESSAGE'			=> 'Your message', 
+	'MASS_MESSAGE_EXPLAIN'	=> 'Please note that you may enter only plain text. All markup will be removed before sending.', 
+	'ALL_USERS'				=> 'All Users',
+	'NO_EMAIL_SUBJECT'		=> 'You must specify a subject for your message.', 
+	'NO_EMAIL_MESSAGE'		=> 'You must enter a message.', 
+	'EMAIL_SENT'			=> 'Your message has been queued for sending.',
+	'EMAIL_SEND_ERROR'		=> 'There were one or more errors while sending the email. Please check the %sError Log%s for detailed error messages.',
+	'SEND_IMMEDIATLY'		=> 'Send immediatly',
+	'LOG_SESSION'			=> 'Log Mail Session',
+	'MAIL_PRIORITY'			=> 'Mail Priority',
+	'MAIL_LOW_PRIORITY'		=> 'Low',
+	'MAIL_NORMAL_PRIORITY'	=> 'Normal',
+	'MAIL_HIGH_PRIORITY'	=> 'High'
+);
+
+// Ranks
+$this->lang += array(
+	'RANKS_EXPLAIN' => 'Using this form you can add, edit, view and delete ranks. You can also create custom ranks which can be applied to a user via the user management facility',
+	'ADD_RANK' => 'Add new rank',
+	'RANK_TITLE' => 'Rank Title',
+	'RANK_SPECIAL' => 'Set as Special Rank',
+	'RANK_MINIMUM' => 'Minimum Posts',
+	'RANK_IMAGE' => 'Rank Image',
+	'RANK_IMAGE_EXPLAIN' => 'Use this to define a small image associated with the rank. The path is relative to the root phpBB2 directory.',
+	'MUST_SELECT_RANK' => 'You must select a rank.',
+	'NO_ASSIGNED_RANK' => 'No special rank assigned.',
+	'RANK_UPDATED' => 'The rank was successfully updated.',
+	'RANK_ADDED' => 'The rank was successfully added.',
+	'RANK_REMOVED' => 'The rank was successfully deleted.',
+	'NO_UPDATE_RANKS' => 'The rank was successfully deleted. However user accounts using this rank were not updated.  You will need to manually reset the rank on these accounts.',
+);
+
+// Disallowed names
+$this->lang += array(
+	'Disallow_control' => 'Username Disallow Control',
+	'Disallow_explain' => 'Here you can control usernames which will not be allowed to be used.  Disallowed usernames are allowed to contain a wildcard character of *.  Please note that you will not be allowed to specify any username that has already been registered, you must first delete that name then disallow it',
+	'Delete_disallow' => 'Delete',
+	'Delete_disallow_title' => 'Remove a Disallowed Username',
+	'Delete_disallow_explain' => 'You can remove a disallowed username by selecting the username from this list and clicking submit',
+	'Add_disallow' => 'Add',
+	'Add_disallow_title' => 'Add a disallowed username',
+	'Add_disallow_explain' => 'You can disallow a username using the wildcard character * to match any character',
+	'No_disallowed' => 'No Disallowed Usernames',
+	'Disallowed_deleted' => 'The disallowed username has been successfully removed',
+	'Disallow_successful' => 'The disallowed username has been successfully added',
+	'Disallowed_already' => 'The name you entered could not be disallowed. It either already exists in the list, exists in the word censor list, or a matching username is present',
+);
+
+// Styling
+$this->lang += array(
+	'STYLES'			=> 'Styles', 
+	'STYLES_EXPLAIN'	=> 'Here you can manage the available styles on your board. A style consists off a template, theme and imageset. You may alter existing styles, delete, deactivate, reactivate, create or import new ones. You can also see what a style will look like using the preview function. The current default style is noted by the presence of an asterix, * Also listed is the total user count for each style, note that overriding user styles will not be reflected here.', 
+	'STYLE_NAME'			=> 'Style name', 
+	'STYLE_USED_BY'			=> 'Used by', 
+	'STYLE_ACTIVATE'		=> 'Activate', 
+	'STYLE_DEACTIVATE'		=> 'Deactivate', 
+	'CREATE_STYLE'			=> 'Create new style', 
+	'INSTALLED_STYLE'		=> 'Installed styles', 
+	'UNINSTALLED_STYLE'		=> 'Uninstalled styles', 
+	'NO_UNINSTALLED_STYLE'	=> 'No uninstalled styles detected', 
+	'DEACTIVATE_DEFAULT'	=> 'You cannot deactivate the default style.', 
+
+	'EDIT_DETAILS_STYLE'		=> 'Edit Style', 
+	'EDIT_DETAILS_STYLE_EXPLAIN'=> 'Using the form below you can modify this existing style. You may alter the combination of template, theme and imageset which define the style itself. You may also deactivate the style and alter its name.', 
+	'STYLE_ACTIVE'				=> 'Active', 
+	'STYLE_DEFAULT'				=> 'Make default style', 
+	'STYLE_IMAGESET'			=> 'Imageset', 
+	'STYLE_THEME'				=> 'Theme', 
+	'STYLE_TEMPLATE'			=> 'Template', 
+	'STYLE_ADDED'				=> 'Style added successfully', 
+	'STYLE_EDITED'				=> 'Style edited successfully', 
+
+	'ADD_STYLE'				=> 'Create Style', 
+	'ADD_STYLE_EXPLAIN'		=> 'Here you can create a new style. Depending on your server configuration and file permissions you may have additional options. For example you may be able to base this style on an existing one. You may also be able to upload or import (from the store directory) a style archive. If you upload or import an archive the style name will be determined automatically.', 
+	'INSTALL_STYLE'			=> 'Install Style', 
+	'INSTALL_STYLE_EXPLAIN'	=> 'Here you can install a new style and if appropriate the corresponding style elements. If you already have the relevant style elements installed they will not be overwritten. Some styles require existing style elements to already be installed. If you try installing such a style and do not have the required elements you will be notified.', 
+	'STYLE_BASIS'			=> 'Style based on', 
+	'SELECT_STYLE'			=> 'Select style', 
+	'STYLE_UPLOAD_BASIS'	=> 'Upload a style', 
+	'STYLE_IMPORT_BASIS'	=> 'Import style from store', 
+
+	'STYLE_EXPORT'			=> 'Export Style', 
+	'STYLE_EXPORT_EXPLAIN'	=> 'Here you can export a style in the form of an archive. A style does not need to contain all elements but it must contain at least one. For example if you have created a new theme and imageset for a commonly used template you could simply export the theme and imageset and ommit the template. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'INCLUDE_TEMPLATE'		=> 'Include template', 
+	'INCLUDE_THEME'			=> 'Include theme', 
+	'INCLUDE_IMAGESET'		=> 'Include imageset', 
+	'STYLE_EXPORTED'		=> 'Style exported succesfully and stored in %s', 
+
+	'DELETE_STYLE'			=> 'Delete style', 
+	'DELETE_STYLE_EXPLAIN'	=> 'Here you can remove the selected style. You cannot remove all the style elements from here. These must be deleted individually via their respective forms. Take care in deleting styles there is no undo facility.', 
+	'REPLACE_STYLE'			=> 'Replace style with', 
+	'REPLACE_STYLE_EXPLAIN'	=> 'This style will replace the one being deleted for members that use it.', 
+	'ONLY_STYLE'			=> 'This is the only remaining style, you cannot delete it',
+	'STYLE_DELETED'			=> 'Style deleted successfully', 
+
+	'TEMPLATES'					=> 'Templates', 
+	'TEMPLATES_EXPLAIN'			=> 'A Template set comprises all the markup used to generate the layout of your board. Here you can  edit existing template sets, delete, export, import and preview sets. You can also modify the templating code used to generate BBCode.', 
+	'CREATE_TEMPLATE'			=> 'Create new template set', 
+	'INSTALLED_TEMPLATE'		=> 'Installed templates', 
+	'UNINSTALLED_TEMPLATE'		=> 'Uninstalled templates', 
+	'NO_UNINSTALLED_TEMPLATE'	=> 'No uninstalled templates detected', 
+
+	'EDIT_TEMPLATE'			=> 'Edit Template',
+	'EDIT_TEMPLATE_EXPLAIN'	=> 'Here you can edit your template set directly. Please remember that these edits are permanent and cannot be undone once submitted. If PHP can write to the template files in your styles directory any changes here will be written directly to those files. If PHP cannot write to those files they will be copied into the database and all changes will only be reflected there. Please take care when editing your template set, remember to close all replacement variable terms {XXXX} and conditional statements.', 
+	'SELECTED_TEMPLATE'		=> 'Selected template set:', 
+	'RAW_HTML'				=> 'Raw HTML', 
+	'TEMPLATE_UPDATED'		=> 'Template updated successfully', 
+
+	'EDIT_DETAILS_TEMPLATE'			=> 'Edit template details', 
+	'EDIT_DETAILS_TEMPLATE_EXPLAIN'	=> 'Here you can edit certain templates details such as its name. You may also have the option to switch storage of the stylesheet from the filesystem to the database and vice versa. This option depends on your PHP configuration and whether your template set can be written to by the webserver.', 
+	'ADD_TEMPLATE'				=> 'Create Template', 
+	'ADD_TEMPLATE_EXPLAIN'		=> 'Here you can add a new template. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this template set on an existing one. You may also be able to upload or import (from the store directory) a template archive. If you upload or import an archive the template name can be optionally taken from the archive name (to do this leave the template name blank).', 
+	'INSTALL_TEMPLATE'			=> 'Install Template', 
+	'INSTALL_TEMPLATE_EXPLAIN'	=> 'Here you can install a new template set. Depending on your server configuration you may have a number of options here.', 
+	'TEMPLATE_NAME'				=> 'Template name', 
+	'SELECT_TEMPLATE'			=> 'Select template', 
+	'TEMPLATE_BASIS'			=> 'Template set based on', 
+	'TEMPLATE_UPLOAD_BASIS'		=> 'Upload a template', 
+	'TEMPLATE_IMPORT_BASIS'		=> 'Import template from store', 
+	'TEMPLATE_LOCATION'			=> 'Store templates in', 
+	'TEMPLATE_LOCATION_EXPLAIN'	=> 'Images are always stored on the filesystem.', 
+	'TEMPLATE_ADDED'			=> 'Template set added and stored on filesystem', 
+	'TEMPLATE_ADDED_DB'			=> 'Template set added and stored in database', 
+
+	'TEMPLATE_CACHE'		=> 'Template Cache', 
+	'TEMPLATE_CACHE_EXPLAIN'=> 'By default phpBB caches the compiled version of its templates. This decreases the load on the server each time a page is viewed and thus may reduce the page generation time. Here you can view the cache status of each file and delete individual files or the entire cache.', 
+	'CACHE_FILENAME'		=> 'Template file', 
+	'CACHE_FILESIZE'		=> 'Filesize', 
+	'CACHE_CACHED'			=> 'Cached', 
+	'CACHE_MODIFIED'		=> 'Modified', 
+	'NO_CACHED_TPL_FILES'		=> 'No cached files for this template', 
+	'TEMPLATE_CACHE_CLEARED'=> 'Cached templates deleted', 
+
+	'TEMPLATE_EXPORT'			=> 'Export Templates', 
+	'TEMPLATE_EXPORT_EXPLAIN'	=> 'Here you can export a template set in the form of an archive. This archive will contain all the files necessary to install the templates on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'TEMPLATE_EXPORTED'		=> 'Templates exported succesfully and stored in %s', 
+
+	'DELETE_TEMPLATE'			=> 'Delete Template', 
+	'DELETE_TEMPLATE_EXPLAIN'	=> 'Here you can remove the selected template set from the database. Additionally, if you have permission you can elect to remove the set from the filesystem. Please note that there is no undo capability. When the templates are deleted they are gone for good. It is recommended that you first export your set for possible future use.', 
+	'REPLACE_TEMPLATE'			=> 'Replate template with', 
+	'REPLACE_TEMPLATE_EXPLAIN'	=> 'This template set will replace the one you are deleting in any styles that use it.', 
+	'TEMPLATE_DELETED'			=> 'Template set deleted successfully', 
+	'TEMPLATE_DELETED_FS'		=> 'Template set removed from database but some files may remain on the filesystem', 
+	'ONLY_TEMPLATE'				=> 'This is the only remaining template set, you cannot delete it',
+
+	'THEMES'				=> 'Themes', 
+	'THEMES_EXPLAIN'		=> 'From here you can create, install, edit, delete and export themes. A theme is the combination of colours and images that are applied to your templates to define the basic look of your forum. The range of options open to you depends on the configuration of your server and phpBB installation, see the Manual for further details. Please note that when creating new themes the use of an existing theme as a basis is optional.', 
+	'SELECT_THEME_BASIS'	=> 'Select optional basis', 
+	'THEME_VERSION_DIFF'	=> 'This theme was designed for a version of phpBB 2.2 different from that installed you may encounter some issues in its use.', 
+	'CREATE_THEME'			=> 'Create new theme', 
+	'INSTALLED_THEME'		=> 'Installed themes', 
+	'UNINSTALLED_THEME'		=> 'Uninstalled themes', 
+	'NO_UNINSTALLED_THEME'	=> 'No uninstalled themes detected', 
+
+	'DELETE_THEME'			=> 'Delete theme', 
+	'DELETE_THEME_EXPLAIN'	=> 'Here you can remove the selected theme from the database. Additionally, if you have permission you can elect to remove the theme from the filesystem. Please note that there is no undo capability. When the theme is deleted it is gone for good. It is recommended that you first export your theme for possible future use.', 
+	'REPLACE_THEME'			=> 'Replace theme with', 
+	'REPLACE_THEME_EXPLAIN'	=> 'This theme will replace the one you are deleting in any styles that use it.', 
+	'THEME_DELETED'			=> 'Theme deleted successfully', 
+	'THEME_DELETED_FS'		=> 'Theme removed from database but files remain on the filesystem', 
+	'ONLY_THEME'			=> 'This is the only remaining theme, you cannot delete it',
+
+	'EDIT_DETAILS_THEME'		=> 'Edit theme details', 
+	'EDIT_DETAILS_THEME_EXPLAIN'=> 'Here you can edit certain theme details such as its name. You may also have the option to switch storage of the stylesheet from the filesystem to the database and vice versa. This option depends on your PHP configuration and whether your stylesheet can be written to by the webserver.', 
+	'ADD_THEME'			=> 'Create Theme', 
+	'ADD_THEME_EXPLAIN'	=> 'Here you can add a new theme. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this theme on an existing one. You may also be able to upload or import (from the store directory) a theme archive. If you upload or import an archive the theme name can be optionally taken from the archive name (to do this leave the theme name blank).', 
+	'INSTALL_THEME'			=> 'Install Theme', 
+	'INSTALL_THEME_EXPLAIN'	=> 'Here you can install your selected theme. You can edit certain details if you wish or use the installation defaults.', 
+	'THEME_NAME'			=> 'Theme Name', 
+	'THEME_BASIS'			=> 'Theme Basis', 
+	'THEME_BASIS'			=> 'Theme based on', 
+	'THEME_UPLOAD_BASIS'	=> 'Upload a theme', 
+	'THEME_IMPORT_BASIS'	=> 'Import theme from store', 
+	'THEME_LOCATION'		=> 'Store stylesheet in', 
+	'THEME_LOCATION_EXPLAIN'=> 'Images are always stored on the filesystem.', 
+
+	'EDIT_THEME'			=> 'Edit theme', 
+	'EDIT_THEME_EXPLAIN'	=> 'Here you can edit the selected theme, changing colours, images, etc. You can switch between a simplified interface where you can set basic colours, etc. and a more advanced "raw CSS" mode. The raw mode allows you add additional parameters such as borders, etc. Only set parameters you need else leave them blank or unset. Default classes used by this theme are coloured red in the select box. You may also add additional "custom" classes should your template or style make use of them.', 
+	'SELECTED_THEME'		=> 'Selected theme', 
+	'SELECT_CLASS'			=> 'Select class', 
+	'SHOW_RAW_CSS'			=> 'Show CSS', 
+	'HIDE_RAW_CSS'			=> 'Hide CSS', 
+	'SHOW_RAW_CSS_NOTE'		=> 'Note', 
+	'SHOW_RAW_CSS_EXPLAIN'	=> 'Enter each element on a new line, ending with a ; Expand the data for each element, e.g. do not use font: use font-family:, font-weight:, etc.', 
+	'CSS_CAT_LAYOUT'	=> 'Layout', 
+	'CSS_#HEADER'		=> 'Header', 
+	'CSS_#LOGO'			=> 'Header logo', 
+	'CSS_#MENU'			=> 'Menu container', 
+	'CSS_#INFO'			=> 'Info container', 
+	'CSS_#FOOTER'		=> 'Footer', 
+	'CSS_CAT_TEXT'		=> 'Text Classes', 
+	'CSS_BODY'			=> 'Body',
+	'CSS_P'				=> 'Paragraph', 
+	'CSS_H1'			=> 'Header 1', 
+	'CSS_H2'			=> 'Header 2', 
+	'CSS_H3'			=> 'Header 3', 
+	'CSS_TABLETITLE'	=> 'Table Title', 
+	'CSS_CATTITLE'		=> 'Category Title', 
+	'CSS_TOPICTITLE'	=> 'Topic Titles', 
+	'CSS_TOPICAUTHOR'	=> 'Topic Author', 
+	'CSS_TOPICDETAILS'	=> 'Topic Details', 
+	'CSS_POSTBODY'		=> 'Post Text', 
+	'CSS_POSTHILIT'		=> 'Post Highlight', 
+	'CSS_POSTAUTHOR'	=> 'Post Author', 
+	'CSS_POSTDETAILS'	=> 'Post Details',
+	'CSS_MAINMENU'		=> 'Main Menu', 
+	'CSS_NAV'			=> 'Navigation',
+	'CSS_GENMED'		=> 'General Medium', 
+	'CSS_GENSMALL'		=> 'General Small',
+	'CSS_COPYRIGHT'		=> 'Copyright', 
+	'CSS_CAT_TABLES'	=> 'Tabular Classes', 
+	'CSS_TABLE'			=> 'Table', 
+	'CSS_TH'			=> 'Table Header',
+	'CSS_TD'			=> 'Table Data',
+	'CSS_CAT'			=> 'Category Header', 
+	'CSS_CATDIV'		=> 'Category Fade', 
+	'CSS_ROW1'			=> 'Alternate Row 1', 
+	'CSS_ROW2'			=> 'Alternate Row 2', 
+	'CSS_ROW3'			=> 'Alternate Row 3', 
+	'CSS_SPACER'		=> 'Spacer Row', 
+	'CSS_HR'			=> 'Horizontal Rule', 
+	'CSS_CAT_FORMS'		=> 'Form Classes', 
+	'CSS_FORM'			=> 'Form', 
+	'CSS_INPUT'			=> 'Input', 
+	'CSS_SELECT'		=> 'Select', 
+	'CSS_TEXTAREA'		=> 'Textarea', 
+	'CSS_POST'			=> 'Text Input', 
+	'CSS_BTNMAIN'		=> 'Primary Buttons',
+	'CSS_BTNLITE'		=> 'Secondary Buttons',
+	'CSS_BTNBBCODE'		=> 'BBCode Buttons', 
+	'CSS_CAT_BBCODE'	=> 'BBCode Classes', 
+	'CSS_B'				=> 'Bold',
+	'CSS_U'				=> 'Underline',
+	'CSS_I'				=> 'Italics',
+	'CSS_COLOR'			=> 'Colour',
+	'CSS_SIZE'			=> 'Size',	
+	'CSS_CODE'			=> 'Code',
+	'CSS_QUOTE'			=> 'Quote',
+	'CSS_FLASH'			=> 'Flash',
+	'CSS_SYNTAXBG'		=> 'Syntax Background', 
+	'CSS_SYNTAXCOMMENT'	=> 'Syntax Comments',
+	'CSS_SYNTAXDEFAULT'	=> 'Syntax Default',
+	'CSS_SYNTAXHTML'	=> 'Syntax HTML',
+	'CSS_SYNTAXKEYWORD'	=> 'Syntax Keyword',
+	'CSS_SYNTAXSTRING'	=> 'Syntax String',
+	'CSS_CAT_CUSTOM'	=> 'Custom Classes', 
+	'CSS_ANCHOR_LINK'	=> 'Link',
+	'CSS_ANCHOR_ACTIVE'	=> 'Active',
+	'CSS_ANCHOR_VISITED'=> 'Visited',
+	'CSS_ANCHOR_HOVER'	=> 'Hover', 
+
+	'CSS_PARAMETER'		=> 'Parameter', 
+	'CSS_VALUE'			=> 'Value', 
+	'RAW_CSS'			=> 'Raw CSS', 
+	'BACKGROUND'		=> 'Background', 
+	'BACKGROUND_COLOUR' => 'Background colour', 
+	'BACKGROUND_IMAGE'	=> 'Background image', 
+	'BACKGROUND_REPEAT' => 'Repeat background', 
+	'REPEAT_NO'			=> 'None', 
+	'REPEAT_X'			=> 'Only horizontally', 
+	'REPEAT_Y'			=> 'Only vertically', 
+	'REPEAT_ALL'		=> 'Both directions', 
+	'FOREGROUND'		=> 'Foreground', 
+	'COLOUR_EXPLAIN'	=> 'This is a hex-triplet of the form #RRGGBB or colour name', 
+	'FONT_COLOUR'		=> 'Font colour', 
+	'FONT_FACE'			=> 'Font face', 
+	'FONT_FACE_EXPLAIN' => 'You can specify multiple fonts seperated by commas.', 
+	'FONT_SIZE'			=> 'Font size', 
+	'UNDERLINE'			=> 'Underline', 
+	'ITALIC'			=> 'Italic', 
+	'BOLD'				=> 'Bold', 
+	'LINE_SPACING'		=> 'Line spacing', 
+	'CUSTOM_CLASS'			=> 'Custom Class', 
+	'CUSTOM_CLASS_EXPLAIN'	=> 'You can add additional classes to this theme if you wish. You must provide the actual CSS class name below, it must be the same as that you have or will use in your template. Please remember that class names may contain only alphanumeric characters, periods (.), colons (:) and number/hash/pound (#). The new class will be added to the Custom Class category in the select box above.', 
+	'CSS_CLASS_NAME'		=> 'CSS class name', 
+	'CUSTOM_CLASS'			=> 'Custom Class', 
+
+	'THEME_CLASS_ADDED'		=> 'Custom class added successfully', 
+	'THEME_UPDATED'			=> 'Class updated successfully',
+	'THEME_ADDED_DB'		=> 'New theme added to database', 
+	'THEME_ADDED'			=> 'New theme added on filesystem', 
+	'THEME_DETAILS_UPDATE'	=> 'Theme details updated', 
+
+	'THEME_EXPORT'			=> 'Export Theme', 
+	'THEME_EXPORT_EXPLAIN'	=> 'Here you can export a theme in the form of an archive. This archive will contain all the data necessary to install the theme on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'THEME_EXPORTED'		=> 'Theme exported succesfully and stored in %s', 
+
+	'IMAGESETS'					=> 'Imagesets', 
+	'IMAGESETS_EXPLAIN'			=> 'Imagesets comprise all the button, forum, folder, etc. and other non-style specific images used by the board. Here you can edit, export or delete existing imagesets and import or activate new sets.', 
+	'CREATE_IMAGESET'			=> 'Create new imageset', 
+	'INSTALLED_IMAGESET'		=> 'Installed imagesets', 
+	'UNINSTALLED_IMAGESET'		=> 'Uninstalled imagesets', 
+	'NO_UNINSTALLED_IMAGESET'	=> 'No uninstalled imagesets detected', 
+
+	'EDIT_IMAGESET'			=> 'Edit Imageset', 
+	'EDIT_IMAGESET_EXPLAIN'	=> 'Here you can edit the individual images which define the imageset. You can also specify  dimensions for the image. Dimensions are optional, specifying them can overcome certain rendering issues with some browsers. By not specifying them you reduce the size of the database record a little.', 
+	'SELECTED_IMAGESET'		=> 'Selected imageset', 
+	'SELECT_IMAGE'			=> 'Select image', 
+	'IMAGE'					=> 'Image', 
+	'CURRENT_IMAGE'			=> 'Current Image', 
+	'SELECTED_IMAGE'		=> 'Selected Image', 
+	'DIMENSIONS'			=> 'Include dimensions', 
+	'DIMENSIONS_EXPLAIN'	=> 'Selecting yes here will include width/height parameters.', 
+	'IMAGE_PARAMETER'		=> 'Parameter', 
+	'IMAGE_VALUE'			=> 'Value', 
+	'LOCALISED_IMAGES'		=> 'Localised', 
+	'GLOBAL_IMAGES'			=> 'Global', 
+	'IMG_CAT_BUTTONS'		=> 'Localised buttons',
+	'IMG_BTN_POST'			=> 'New topic', 
+	'IMG_BTN_REPLY'			=> 'Reply topic', 
+	'IMG_BTN_LOCKED'		=> 'Topic locked', 
+	'IMG_BTN_POST_PM'		=> 'New message', 
+	'IMG_BTN_REPLY_PM'		=> 'Reply message', 
+	'IMG_BTN_DELETE'		=> 'Delete post', 
+	'IMG_BTN_QUOTE'			=> 'Quote post', 
+	'IMG_BTN_PROFILE'		=> 'Show profile', 
+	'IMG_BTN_EMAIL'			=> 'Send email', 
+	'IMG_BTN_SEARCH'		=> 'Search posts', 
+	'IMG_BTN_WWW'			=> 'Website', 
+	'IMG_BTN_IP'			=> 'Show IP', 
+	'IMG_BTN_EDIT'			=> 'Edit post', 
+	'IMG_BTN_AIM'			=> 'AIM', 
+	'IMG_BTN_ICQ'			=> 'ICQ', 
+	'IMG_BTN_JABBER'		=> 'Jabber', 
+	'IMG_BTN_YIM'			=> 'YIM', 
+	'IMG_BTN_MSNM'			=> 'MSNM', 
+	'IMG_BTN_ONLINE'		=> 'User online', 
+	'IMG_BTN_OFFLINE'		=> 'User offline', 
+	'IMG_BTN_REPORT'		=> 'Report post', 
+	'IMG_BTN_PM'			=> 'Send message', 
+	'IMG_BTN_FRIEND'		=> 'Add as friend', 
+	'IMG_BTN_FOE'			=> 'Add as foe', 
+	'IMG_CAT_ICONS'			=> 'General icons',
+	'IMG_ICON_UNAPPROVED'	=> 'Post unapproved', 
+	'IMG_ICON_REPORTED'		=> 'Post reported', 
+	'IMG_ICON_ATTACH'		=> 'Attachment', 
+	'IMG_ICON_POST'			=> 'Minipost', 
+	'IMG_ICON_POST_NEW'		=> 'New minipost', 
+	'IMG_ICON_POST_LATEST'	=> 'Last post', 
+	'IMG_ICON_POST_NEWEST'	=> 'Newest post', 
+	'IMG_CAT_FORUMS'		=> 'Forum icons',
+	'IMG_FORUM'				=> 'Forum', 
+	'IMG_FORUM_NEW'			=> 'Forum new posts', 
+	'IMG_FORUM_LOCKED'		=> 'Forum locked', 
+	'IMG_FORUM_LINK'		=> 'Forum link', 
+	'IMG_SUB_FORUM'			=> 'Subforum',
+	'IMG_SUB_FORUM_NEW'		=> 'Subforum new posts',
+	'IMG_CAT_FOLDERS'				=> 'Topic icons',
+	'IMG_FOLDER'					=> 'Topic', 
+	'IMG_FOLDER_NEW'				=> 'Topic new posts',
+	'IMG_FOLDER_LOCKED'				=> 'Topic locked', 
+	'IMG_FOLDER_POSTED'				=> 'Topic posted to',
+	'IMG_FOLDER_NEW_POSTED'			=> 'Topic posted to new', 
+	'IMG_FOLDER_LOCKED_NEW'			=> 'Topic locked new', 
+	'IMG_FOLDER_LOCKED_POSTED'		=> 'Topic locked posted to', 
+	'IMG_FOLDER_LOCKED_NEW_POSTED'	=> 'Topic locked posted to new', 
+	'IMG_FOLDER_HOT'				=> 'Topic hot', 
+	'IMG_FOLDER_HOT_NEW'			=> 'Topic hot new posts', 
+	'IMG_FOLDER_HOT_POSTED'			=> 'Topic hot posted to',
+	'IMG_FOLDER_HOT_NEW_POSTED'		=> 'Topic hot posted to new',
+	'IMG_FOLDER_STICKY'				=> 'Sticky topic', 
+	'IMG_FOLDER_STICKY_POSTED'		=> 'Sticky topic posted to', 
+	'IMG_FOLDER_STICKY_NEW'			=> 'Sticky topic new posts',
+	'IMG_FOLDER_STICKY_NEW_POSTED'	=> 'Sticky topic posted to new', 
+	'IMG_FOLDER_ANNOUNCE'				=> 'Announcement', 
+	'IMG_FOLDER_ANNOUNCE_NEW'			=> 'Announcement new posts', 
+	'IMG_FOLDER_ANNOUNCE_POSTED'		=> 'Announcement posted to', 
+	'IMG_FOLDER_ANNOUNCE_NEW_POSTED'	=> 'Announcement posted to new', 
+	'IMG_FOLDER_GLOBAL'				=> 'Global', 
+	'IMG_FOLDER_GLOBAL_NEW'			=> 'Global new posts', 
+	'IMG_FOLDER_GLOBAL_POSTED'		=> 'Global posted to', 
+	'IMG_FOLDER_GLOBAL_NEW_POSTED'	=> 'Global posted to new', 
+	'IMG_CAT_POLLS'		=> 'Polling images',
+	'IMG_POLL_LEFT'		=> 'Poll left end', 
+	'IMG_POLL_RIGHT'	=> 'Poll right end', 
+	'IMG_POLL_CENTER'	=> 'Poll centre', 
+	'IMG_CAT_KARMA'		=> 'Karma images', 
+	'IMG_KARMA_LEFT'	=> 'Karma left end', 
+	'IMG_KARMA_CENTER'	=> 'Karma centre', 
+	'IMG_KARMA_RIGHT'	=> 'Karma right end', 
+	'IMG_CAT_CUSTOM'	=> 'Custom images', 
+	'IMAGESET_UPDATED'	=> 'Imageset updated successfully', 
+
+	'EDIT_DETAILS_IMAGESET'	=> 'Edit imageset details', 
+	'EDIT_DETAILS_IMAGESET_EXPLAIN'=> 'Here you can edit certain imageset details such as its name.', 
+	'ADD_IMAGESET'			=> 'Create Imageset', 
+	'ADD_IMAGESET_EXPLAIN'	=> 'Here you can create a new imageset. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this imageset on an existing one. You may also be able to upload or import (from the store directory) a imageset archive. If you upload or import an archive the imageset name can be optionally taken from the archive name (to do this leave the imageset name blank).', 
+	'INSTALL_IMAGESET'			=> 'Install Imageset', 
+	'INSTALL_IMAGESET_EXPLAIN'	=> 'Here you can install your selected imageset. You can edit certain details if you wish or use the installation defaults.', 
+	'IMAGESET_NAME'				=> 'Imageset Name', 
+	'IMAGESET_BASIS'			=> 'Imageset Basis', 
+	'IMAGESET_BASIS'			=> 'Imageset based on', 
+	'IMAGESET_UPLOAD_BASIS'		=> 'Upload a imageset', 
+	'IMAGESET_IMPORT_BASIS'		=> 'Import imageset from store', 
+
+	'IMAGESET_EXPORT'			=> 'Export Imageset', 
+	'IMAGESET_EXPORT_EXPLAIN'	=> 'Here you can export an imageset in the form of an archive. This archive will contain all the data necessary to install the set of images on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'IMAGESET_EXPORTED'		=> 'Imageset exported succesfully and stored in %s', 
+	'DELETE_IMAGESET'			=> 'Delete Imageset', 
+	'DELETE_IMAGESET_EXPLAIN'	=> 'Here you can remove the selected imageset from the database. Additionally, if you have permission you can elect to remove the set from the filesystem. Please note that there is no undo capability. When the imageset is deleted it is gone for good. It is recommended that you first export your set for possible future use.', 
+	'REPLACE_IMAGESET'			=> 'Replace imageset with', 
+	'REPLACE_IMAGESET_EXPLAIN'	=> 'This imageset will replace the one you are deleting in any styles that use it.', 
+	'IMAGESET_DELETED'			=> 'Imageset set deleted successfully', 
+	'IMAGESET_DELETED_FS'		=> 'Imageset set removed from database but some files may remain on the filesystem', 
+	'ONLY_IMAGESET'				=> 'This is the only remaining imageset, you cannot delete it',
+
+	'STYLE_ERR_NOT_STYLE'		=> 'The imported or uploaded file did not contain a valid style archive.', 
+	'STYLE_ERR_MORE_ELEMENTS'	=> 'You must select at least two style elements.', 
+	'STYLE_ERR_STYLE_NAME'		=> 'You must supply a name for this style', 
+	'STYLE_ERR_NAME_LONG'		=> 'The style name can be no longer than 30 characters', 
+	'STYLE_ERR_NAME_EXIST'		=> 'A style with that name already exists', 
+	'STYLE_ERR_COPY_LONG'		=> 'The copyright can be no longer than 60 characters', 
+	'STYLE_ERR_NO_IDS'			=> 'You must select a template, theme and imageset for this style', 
+	'STYLE_ERR_NAME_CHARS'		=> 'The style name can only contain alphanumeric characters, -, +, _ and space',  
+	'REQUIRES_TEMPLATE'			=> 'This style requires the %s template set to be installed.', 
+	'REQUIRES_THEME'			=> 'This style requires the %s theme to be installed.', 
+	'REQUIRES_IMAGESET'			=> 'This style requires the %s imageset to be installed.', 
+	'TEMPLATE_ERR_STYLE_NAME'	=> 'You must supply a name for this templates', 
+	'TEMPLATE_ERR_NAME_CHARS'	=> 'The template name can only contain alphanumeric characters, -, +, _ and space',  
+	'TEMPLATE_ERR_NAME_LONG'	=> 'The template name can be no longer than 30 characters', 
+	'TEMPLATE_ERR_NAME_EXIST'	=> 'A template set with that name already exists', 
+	'TEMPLATE_ERR_COPY_LONG'	=> 'The copyright can be no longer than 60 characters', 
+	'TEMPLATE_ERR_ARCHIVE'		=> 'Please select an archive method', 
+	'TEMPLATE_ERR_NOT_TEMPLATE'	=> 'The archive you specified does not contain a valid template set.', 
+	'ERR_TPLCACHE_READ'			=> 'Cannot read the cache directory', 
+	'THEME_ERR_STYLE_NAME'		=> 'You must supply a name for this theme', 
+	'THEME_ERR_NAME_CHARS'		=> 'The theme name can only contain alphanumeric characters, -, +, _ and space',  
+	'THEME_ERR_NAME_LONG'		=> 'The theme name can be no longer than 30 characters', 
+	'THEME_ERR_NAME_EXIST'		=> 'A theme with that name already exists', 
+	'THEME_ERR_COPY_LONG'		=> 'The copyright can be no longer than 60 characters', 
+	'THEME_ERR_ARCHIVE'			=> 'Please select an archive method', 
+	'THEME_ERR_NOT_THEME'		=> 'The archive you specified does not contain a valid theme.', 
+	'THEME_ERR_CLASS_CHARS'		=> 'Only alphanumeric characters plus ., : and # are valid in class names.', 
+	'IMAGESET_ERR_STYLE_NAME'	=> 'You must supply a name for this imageset', 
+	'IMAGESET_ERR_NAME_CHARS'	=> 'The imageset name can only contain alphanumeric characters, -, +, _ and space',  
+	'IMAGESET_ERR_NAME_LONG'	=> 'The imageset name can be no longer than 30 characters', 
+	'IMAGESET_ERR_NAME_EXIST'	=> 'A imageset with that name already exists', 
+	'IMAGESET_ERR_COPY_LONG'	=> 'The copyright can be no longer than 60 characters', 
+	'IMAGESET_ERR_ARCHIVE'		=> 'Please select an archive method', 
+	'IMAGESET_ERR_NOT_IMAGESET'	=> 'The archive you specified does not contain a valid imageset.', 
+
+	'ARCHIVE_FORMAT'		=> 'Archive file type', 
+	'ALLOWED_FILETYPES'		=> 'Allowed filetypes', 
+	'SELECT_BASIS'			=> 'Select optional basis', 
+	'TEXT_COLUMNS'			=> 'Columns', 
+	'TEXT_ROWS'				=> 'Rows', 
+	'COPYRIGHT'				=> 'Copyright', 
+	'CACHE'					=> 'Cache', 
+	'EXPORT'				=> 'Export', 
+	'DETAILS'				=> 'Details', 
+	'REFRESH'				=> 'Refresh', 
+	'STORE_DATABASE'		=> 'Database', 
+	'STORE_FILESYSTEM'		=> 'Filesystem', 
+	'DELETE_FROM_FS'		=> 'Delete from filesystem', 
+	'INSTALL'				=> 'Install', 
+	'FROM'					=> 'from', // "Create new style .... from ..."
+	'OPTIONAL_BASIS'		=> 'Optional basis', 
+	'NO_IMAGESET'			=> 'Cannot find imageset on filesystem', 
+	'NO_THEME'				=> 'Cannot find theme on filesystem', 
+	'NO_TEMPLATE'			=> 'Cannot find template on filesystem', 
+	'NO_STYLE'				=> 'Cannot find style on filesystem', 
+	'NO_BASIS'				=> 'Do not use basis',
+	'NO_IMPORT'				=> 'Do not import', 
+	'UPLOAD_WRONG_TYPE'		=> 'Only the following filetypes are accepted: %s', 
+);
+
+// Search indexing
+$this->lang += array(
+	'SEARCH_INDEX_EXPLAIN' 	=> 'phpBB2 uses a fulltext search system. This breaks down each post into seperate words and then, if the word does not already exist it stores those words in a table. In turn the post is linked to each word it contains in this table. This allows quick searching of large databases and helps reduce load on the server compared to most other methods.</p><p>However, if the tables get out of sync for some reason or you change the minimum, maximum or disallowed list of words the tables need updating. This facility allows you to do just that.</p><p>Please be aware this procedure can take a long time, particularly on large databases. During this period your forum will be automatically shut down to prevent people posting. You can cancel the procedure at any time. Please remember this is an intensive operation and should only be carried out when absolutely necessarily. Do not run this script too often!</p>',
+	'SEARCH_INDEX_CANCEL'	=> 'Re-indexing of search system has been cancelled. Please note this will result in searches returning incomplete results. You can re-index the posts again at any stage.',
+	'SEARCH_INDEX_COMPLETE'	=> 'Re-indexing of search system has been completed. You can re-index the posts again at any stage.',
+	'START'					=> 'Start',
+	'STOP'					=> 'Stop', 
+);
+
+// Admin logs
+$this->lang += array(
+	'ADMIN_LOGS_EXPLAIN'	=> 'This lists all the actions carried out by board administrators. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'MOD_LOGS_EXPLAIN'		=> 'This lists the actions carried out by board moderators, select a forum from the drop down list. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'CRITICAL_LOGS_EXPLAIN'	=> 'This lists the actions carried out by the board itself. These log provides you with information you are able to use for solving specific problems, for example non-delivery of emails. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'DISPLAY_LOG'			=> 'Display entries from previous',
+
+	'ALL_ENTRIES'	=> 'All entries',
+	'SORT_IP'		=> 'IP address',
+	'SORT_DATE'		=> 'Date',
+	'SORT_ACTION'	=> 'Log action',
+	'NO_ENTRIES'	=> 'No log entries for this period',
+);
+
+// Attachments
+$this->lang += array(
+	'ATTACHMENT_SETTINGS'			=> 'Attachment Settings',
+	'ATTACHMENT_SETTINGS_EXPLAIN'	=> 'Here you can configure the Main Settings for Attachments and the associated Special Categories.',
+
+	'UPLOAD_DIR'					=> 'Upload Directory',
+	'UPLOAD_DIR_EXPLAIN'			=> 'Storage Path for Attachments.',
+	'DISPLAY_ORDER'					=> 'Attachment Display Order',
+	'DISPLAY_ORDER_EXPLAIN'			=> 'Display attachments ordered by time.',
+	'ATTACH_MAX_FILESIZE'			=> 'Maximum filesize',
+	'ATTACH_MAX_FILESIZE_EXPLAIN'	=> 'Maximum size of each file, 0 is unlimited.',
+	'ATTACH_QUOTA'					=> 'Total attachment quota',
+	'ATTACH_QUOTA_EXPLAIN'			=> 'Maximum drive space available for attachments in total, 0 is unlimited.',
+	'ATTACH_MAX_PM_FILESIZE'		=> 'Maximum filesize messaging',
+	'ATTACH_MAX_PM_FILESIZE_EXPLAIN' => 'Maximum drive space available per user for private message attachments, 0 is unlimited.',
+	'MAX_ATTACHMENTS'				=> 'Max attachments per post',
+	'MAX_ATTACHMENTS_PM'			=> 'Max attachments per message',
+
+	'SETTINGS_CAT_IMAGES'		=> 'Image category settings',
+	'ASSIGNED_GROUP'			=> 'Assigned Group',
+	'DISPLAY_INLINED'			=> 'Display images inline',
+	'DISPLAY_INLINED_EXPLAIN'	=> 'If set to No image attachments will show as a link.',
+	'CREATE_THUMBNAIL'			=> 'Create thumbnail',
+	'CREATE_THUMBNAIL_EXPLAIN'	=> 'Create a thumbnail in all possible situations.',
+	'MIN_THUMB_FILESIZE'		=> 'Minimum thumbnail filesize',
+	'MIN_THUMB_FILESIZE_EXPLAIN' => 'Do not create a thumbnail for images smaller than this.',
+	'IMAGICK_PATH'				=> 'Imagemagick path',
+	'IMAGICK_PATH_EXPLAIN'		=> 'Full path to the imagemagick convert application, e.g. /usr/bin/',
+	'SEARCH_IMAGICK'			=> 'Search for Imagemagick',
+	'MAX_IMAGE_SIZE'			=> 'Maximum Image Dimensions',
+	'MAX_IMAGE_SIZE_EXPLAIN'	=> 'Maximum size of image attachments, 0px by 0px disables image attachments.',
+	'IMAGE_LINK_SIZE'			=> 'Image Link Dimensions',
+	'IMAGE_LINK_SIZE_EXPLAIN'	=> 'Display image attachment as link if image is larger than this, set to 0px by 0px to disable.',
+	
+	'NO_UPLOAD_DIR'		=> 'The upload directory you specified does not exist.',
+	'UPLOAD_NOT_DIR'	=> 'The upload location you specified does not appear to be a directory.',
+	'NO_WRITE_UPLOAD'	=> 'The upload directory you specified cannot be written to. Please alter the permissions to allow the webserver to write to it.',
+
+	'ATTACHMENTS'				=> 'Attachments',
+	'ATTACH_EXTENSIONS_URL'		=> 'Extensions',
+	'ATTACH_EXT_GROUPS_URL'		=> 'Extension Groups',
+	'ATTACH_ORPHAN_URL'			=> 'Orphan Attachments',
+
+	'EXTENSION_GROUPS_TITLE'	=> 'Manage Extension Groups',
+	'EXTENSION_GROUPS_TITLE_EXPLAIN'	=> 'Here you can add, delete and modify your Extension Groups, you can disable Extension Groups, assign a special Category to them, change the download mechanism and you can define an Upload Icon which will be displayed in front of an Attachment belonging to the Group.',
+	'EXTENSION_GROUPS'			=> 'Extension Groups',
+	'EXTENSION_GROUP'			=> 'Extension Group',
+	'SPECIAL_CATEGORY'			=> 'Special Category',
+	'SPECIAL_CATEGORY_EXPLAIN'	=> 'Special Categories differ between the way presented within posts.',
+	'DOWNLOAD_MODE'				=> 'Download Mode',
+	'DOWNLOAD_MODE_EXPLAIN'		=> 'If you experience problems downloading files, set this to "physical", the user will be directed to the file directly. Do not set it to physical if not really needed, it discloses the filename.',
+	'UPLOAD_ICON'				=> 'Upload Icon',
+	'MAX_EXTGROUP_FILESIZE'		=> 'Maximum Filesize',
+	'ASSIGNED_EXTENSIONS'		=> 'Assigned Extensions',
+	'ADD_EXTENSION_GROUP'		=> 'Add Extension Group',
+	'EDIT_EXTENSION_GROUP'		=> 'Edit Extension Group',
+	'NO_EXT_GROUP_SPECIFIED'	=> 'No Extension Group specified',
+	'NO_EXT_GROUP_NAME'			=> 'No Group Name entered',
+	'SUCCESS_EXTENSION_GROUP_ADD'	=> 'Extension Group successfully added',
+	'SUCCESS_EXTENSION_GROUP_EDIT'	=> 'Extension Group successfully updated',
+	'EXTENSION_GROUP_EXIST'		=> 'The Extension Group %s already exist',
+	'EXTENSION_GROUP_DELETED'	=> 'Extension Group successfully deleted',
+	'ALLOWED_FORUMS'			=> 'Allowed Forums',
+	'ALLOWED_FORUMS_EXPLAIN'	=> 'Able to post the assigned extensions at the selected (or all if selected) forums',
+	'ALLOW_IN_PM'				=> 'Allowed in private messaging',
+	'ALLOW_ALL_FORUMS'			=> 'Allow All Forums',
+	'ALLOW_SELECTED_FORUMS'		=> 'Only Forums selected below',
+	'GO_TO_EXTENSIONS'			=> 'Go to Extension Management Screen',
+
+	'CAT_IMAGES'				=> 'Images',
+	'CAT_WM_FILES'				=> 'Win Media Streams',
+	'CAT_RM_FILES'				=> 'Real Media Streams',
+	'MODE_INLINE'				=> 'Inline',
+	'MODE_PHYSICAL'				=> 'Physical',
+	'NO_IMAGE'					=> 'No Image',
+
+	'MANAGE_EXTENSIONS'			=> 'Manage Extensions',
+	'MANAGE_EXTENSIONS_EXPLAIN' => 'Here you can manage your allowed extensions. To activate your Extensions, please refer to the extension groups management panel. We strongly recommend not to allow scripting extensions (such as php, php3, php4, phtml, pl, cgi, asp, aspx...)',
+	'ADD_EXTENSION'				=> 'Add extension',
+	'EXTENSIONS_UPDATED'		=> 'Extensions successfully updated',
+	'EXTENSION_EXIST'			=> 'The Extension %s already exist',
+	'NOT_ASSIGNED'				=> 'Not assigned',
+
+	'ORPHAN_ATTACHMENTS'		=> 'Orphan Attachments', // Title
+	'ORPHAN_ATTACHMENTS_EXPLAIN' => 'Here you are able to see files within the Attachments upload directory but not assigned to posts. This happens mostly if users are attaching files but not submitting the post. You are able to delete the files or attach them to existing posts. Attaching to posts requires a valid post id, you have to determine this id by yourself, this feature is mainly for those people wanting to upload files with another program and assigning those (mostly large) files to an existing post.',
+	'UPLOADING_FILES'			=> 'Uploading Files',
+	'UPLOADING_FILE_TO'			=> 'Uploading File "%1$s" to Post Number %2$d...',
+	'UPLOAD_DENIED_FORUM'		=> 'You do not have the permission to upload files to forum "%s"',
+	'ATTACH_POST_ID'			=> 'Post ID',
+	'ATTACH_TO_POST'			=> 'Attach file to post',
+	'SUCCESSFULLY_UPLOADED'		=> 'Succeessfully uploaded',
+	'ADMIN_UPLOAD_ERROR'		=> 'Errors while trying to attach file: %s',
+
+	'SECURE_DOWNLOADS'				=> 'Enable secure downloads',
+	'SECURE_DOWNLOADS_EXPLAIN'		=> 'With this option enabled, downloads are limited to IP\'s/hostnames you defined.',
+	'SECURE_ALLOW_DENY'				=> 'Allow/Deny List',
+	'SECURE_ALLOW_DENY_EXPLAIN'		=> 'Allow or Deny the list of addresses, this setting only applies to downloading files',
+	'ORDER_ALLOW_DENY'				=> 'Allow',
+	'ORDER_DENY_ALLOW'				=> 'Deny',
+	'SECURE_EMPTY_REFERER'			=> 'Allow empty referer',
+	'SECURE_EMPTY_REFERER_EXPLAIN'	=> 'Secure downloads are based on referers. Do you want to allow downloads for those ommitting the referer?',
+
+	'DEFINE_ALLOWED_IPS'			=> 'Define allowed IPs/Hostnames',
+	'DEFINE_DISALLOWED_IPS'			=> 'Define disallowed IPs/Hostnames',
+	'EXCLUDE_FROM_ALLOWED_IP'		=> 'Exclude IP from allowed IPs/Hostnames',
+	'EXCLUDE_FROM_DISALLOWED_IP'	=> 'Exclude IP from disallowed IPs/Hostnames',
+	'REMOVE_ALLOWED_IPS'			=> 'Remove or Un-exclude allowed IPs/Hostnames',
+	'REMOVE_DISALLOWED_IPS'			=> 'Remove or Un-exclude disallowed IPs/Hostnames',
+	'DOWNLOAD_ADD_IPS_EXPLAIN'		=> 'To specify several different IP\'s or hostnames enter each on a new line. To specify a range of IP addresses separate the start and end with a hyphen (-), to specify a wildcard use *',
+	'DOWNLOAD_REMOVE_IPS_EXPLAIN'	=> 'You can remove (or un-exclude) multiple IP addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded IP\'s have a blue background.',
+	'EXCLUDE_ENTERED_IP'			=> 'Enable this to exclude the entered IP/Hostname.',
+	'NO_IPS_DEFINED'				=> 'No IPs or Hostnames defined',
+	'SECURE_DOWNLOAD_UPDATE_SUCCESS'=> 'The IP list has been updated successfully',
+	'SECURE_DOWNLOAD_NOTICE'		=> 'Secure Downloads are not enabled. The settings below will be applied after enabling secure downloads.'
+);
+
+// Installation
+$this->lang += array(
+	'WELCOME_INSTALL'	=> 'Welcome to phpBB 2 Installation',
+
+	'INSTALL_REQUIRED'		=> 'Required', 
+	'INSTALL_OPTIONAL'		=> 'Optional', 
+	'UNAVAILABLE'	=> 'Unavailable', 
+	'AVAILABLE'		=> 'Available', 
+	'TESTS_PASSED'	=> 'Tests passed', 
+	'TESTS_FAILED'	=> 'Tests failed', 
+
+	'INSTALL_ADVICE'	=> 'Installation Compatibility', 
+	'INSTALL_ADVICE_EXPLAIN'=> 'Before proceeding with full installation phpBB will carry out some tests on your server and basic install. Please ensure you read through the results thoroughly and do not proceed until all tests are passed.', 
+	'PHP_AND_APPS'			=> 'PHP and Applications', 
+	'INSTALL_REQUIRED_PHP'	=> 'You must be running at least PHP 4.1.0 with support for at least one compatible database. If no support modules are shown as available you should contact your hosting provider or review the relevant PHP installation documentation for advice. If "safe mode" is displayed below your PHP installation is running in that mode. This will impose limitations on remote administration and similar features.', 
+	'INSTALL_OPTIONAL_PHP'	=> 'These modules or applications are optional, you do not need these to use phpBB 2.2. However if you do have them they will will enable greater functionality.', 
+	'PHP_VERSION_REQD'	=> 'PHP version >= 4.1.0',
+	'PHP_SAFE_MODE'		=> 'Safe Mode', 
+	'PHP_REQD_DB'		=> 'Supported Databases', 
+	'DLL_FIREBIRD'		=> 'Firebird 1.5+',
+	'DLL_MYSQL'			=> 'MySQL 3.23.x/4.x',
+	'DLL_MYSQL4'		=> 'MySQL 4.1+',
+	'DLL_MSSQL'			=> 'MSSQL Server 2000',
+	'DLL_MSSQL-ODBC'	=> 'MSSQL Server 2000 via ODBC',
+	'DLL_MSACCESS'		=> 'MS Access via ODBC', 
+	'DLL_ORACLE'		=> 'Oracle',
+	'DLL_POSTGRES'		=> 'PostgreSQL 7.x', 
+	'DLL_SQLITE'		=> 'SQLite', 
+	'DLL_MBSTRING'		=> 'Multi-byte character support', 
+	'DLL_ZLIB'			=> 'zlib Compression support [ Visual confirmation, gz, .tar.gz, .zip ]', 
+	'DLL_FTP'			=> 'Remote FTP support [ Installation ]',
+	'DLL_XML'			=> 'XML support [ Jabber ]', 
+	'DLL_MHASH'			=> 'Mhash hashing support [ Jabber ]', 
+	'APP_MAGICK'		=> 'Imagemagick support [ Attachments ]', 
+	'NO_LOCATION'		=> 'Cannot determine location', 
+	'DIRECTORIES_AND_FILES'		=> 'Directory and file setup', 
+	'INSTALL_REQUIRED_FILES'	=> 'In order to function correctly phpBB needs to be able to access or write to certain files or directories. If you see "Not Found" you need to create the relevant file or directory. If you see "Unwriteable" you need to change the permissions on the file or directory to allow phpBB to write to it.', 
+	'INSTALL_OPTIONAL_FILES'	=> 'These files, directories or permissions are optional. The installation routines will attempt to use various techniques to complete if they do not exist or cannot be written to. However, the presence of these files, directories or permissions will speed installation.', 
+	'FILE_FOUND'		=> 'Found', 
+	'FILE_NOT_FOUND'	=> 'Cannot find', 
+	'FILE_WRITEABLE'	=> 'Writeable', 
+	'FILE_UNWRITEABLE'	=> 'Unwriteable', 
+	'INSTALL_NEXT'		=> 'Next stage', 
+	'INSTALL_NEXT_PASS'	=> 'All the basic tests have been passed and you may proceed to the next stage of installation. If you have changed any permissions, modules, etc. and wish to re-test you can do so if you wish.', 
+	'INSTALL_NEXT_FAIL'	=> 'Some tests failed and you should correct these problems before proceeding to the next stage. Failure to do so may result in an incomplete installation.', 
+
+	'INITIAL_CONFIG'		=> 'Basic Configuration',
+	'INITIAL_CONFIG_EXPLAIN'=> 'Now that install has determined your server can run phpBB you need to supply some specific information. If you do not know how to connect to your database please contact your hosting provider (in the first instance) or  use the phpBB support forums. When entering data please ensure you check it thoroughly before continuing.', 
+	'ADMIN_CONFIG'			=> 'Admin Configuration',
+	'DEFAULT_LANG'			=> 'Default board language',
+	'ADMIN_USERNAME'		=> 'Administrator username',
+	'CONTACT_EMAIL'			=> 'Contact email address',
+	'CONTACT_EMAIL_CONFIRM'	=> 'Confirm contact email',
+	'ADMIN_PASSWORD'		=> 'Administrator password',
+	'ADMIN_PASSWORD_CONFIRM'=> 'Confirm administrator password',
+	'DB_CONFIG'			=> 'Database Configuration', 
+	'DBMS'				=> 'Database type',
+	'DB_HOST'			=> 'Database server hostname or DSN',
+	'DB_HOST_EXPLAIN'	=> 'DSN stands for Data Source Name and is relevant only for ODBC installs.', 
+	'DB_PORT'			=> 'Database server port', 
+	'DB_PORT_EXPLAIN'	=> 'Leave this blank unless you know the server operates on a non-standard port.', 
+	'DB_NAME'			=> 'Database name',
+	'DB_USERNAME'		=> 'Database username',
+	'DB_PASSWORD'		=> 'Database password',
+	'TABLE_PREFIX'		=> 'Prefix for tables in database', 
+	'DB_TEST'			=> 'Test Connection', 
+	'INSTALL_DB_CONNECT'=> 'Successfull Connection', 
+	'SERVER_CONFIG'			=> 'Server Configuration', 
+	'SERVER_NAME'			=> 'Domain name',
+	'SERVER_NAME_EXPLAIN'	=> 'The domain name this board runs from',
+	'SCRIPT_PATH'			=> 'Script path',
+	'SCRIPT_PATH_EXPLAIN'	=> 'The path where phpBB2 is located relative to the domain name',
+	'SERVER_PORT'			=> 'Server port',
+	'SERVER_PORT_EXPLAIN'	=> 'The port your server is running on, usually 80, only change if different',
+	'CACHE_STORE'			=> 'Cache type', 
+	'CACHE_STORE_EXPLAIN'	=> 'The physical location where data is cached, filesystem is prefered.', 
+	'INSTALL_TEST'	=> 'Test Again', 
+	'INSTALL_NEXT'	=> 'Next Stage', 
+	'INSTALL_START'	=> 'Start Install', 
+
+	'INSTALL_SEND_CONFIG'	=> 'Unfortunately phpBB could not write the configuration information directly to your config.php. This may be because the file does not exist or is not writeable. A number of options will be listed below enabling you to complete installation of config.php.', 
+	'FTP_CONFIG'		=> 'Transfer config by FTP', 
+	'FTP_CONFIG_EXPLAIN'=> 'phpBB has detected the presence of the ftp module on this server. You may attempt to install your config.php via this if you wish. You will need to supply the information listed below. Remember your username and password are those to your server! (ask your hosting provider for details if you are unsure what these are)', 
+	'FTP_PATH'			=> 'FTP Path',
+	'FTP_PATH_EXPLAIN'	=> 'This is the path from your root directory to that of phpBB2, e.g. htdocs/phpBB2/',
+	'FTP_USERNAME'		=> 'FTP Username',
+	'FTP_PASSWORD'		=> 'FTP Password',
+	'FTP_UPLOAD'		=> 'Upload', 
+	'DL_CONFIG'			=> 'Download config', 
+	'DL_CONFIG_EXPLAIN'	=> 'You may download the complete config.php to your own PC. You will then need to upload the file manually, replacing any existing config.php in your phpBB 2.2 root directory. Please remember to upload the file in ASCII format (see your FTP application documentation if you are unsure how to achieve this). When you have uploaded the config.php please click "Done" to move to the next stage.', 
+	'DL_DOWNLOAD'		=> 'Download', 
+	'DL_DONE'			=> 'Done', 
+	'RETRY_WRITE'			=> 'Retry writing config', 
+	'RETRY_WRITE_EXPLAIN'	=> 'If you wish you can change the permissions on config.php to allow phpBB to write to it. Should you wish to do that you can click Retry below to try again. Remember to return the permissions on config.php after phpBB2 has finished installation.', 
+	'CONFIG_RETRY'			=> 'Retry', 
+
+	'INSTALL_CONGRATS'			=> 'Congratulations',
+	'INSTALL_CONGRATS_EXPLAIN'	=> 'You have now successfully installed phpBB 2.2. Clicking the button below will take you to your Administration Control Panel (ACP). Take some time to examine the options available to you. Remember that help is available online via the Userguide and the phpBB support forums, see the %sREADME%s for further information.',
+	'INSTALL_LOGIN'				=> 'Login',
+
+	'INST_ERR_FATAL'			=> 'Fatal installation error', 
+	'INST_ERR_MISSING_DATA'		=> 'You must fill out all fields in this block', 
+	'INST_ERR_NO_DB'			=> 'Cannot load the PHP module for the selected database type',
+	'INST_ERR_EMAIL_MISMATCH'	=> 'The emails you entered did not match.',
+	'INST_ERR_PASSWORD_MISMATCH'=> 'The passwords you entered did not match.', 
+	'INST_ERR_DB_CONNECT'		=> 'Could not connect to the database, see error message below', 
+	'INST_ERR_DB_NO_ERROR'		=> 'No error message given', 
+	'INST_ERR_PREFIX'			=> 'Tables with the specified prefix already exist, please choose an alternative.', 
+	'INST_ERR_FATAL_DB'			=> 'A fatal and unrecoverable database error has occured. This may be because the specified user does not have appropriate rights to CREATE TABLES or INSERT data, etc. Further information may be given below. Please contact your hosting provider in the first instance or the support forums of phpBB for further assistance.', 
+	'INST_ERR_FTP_PATH'			=> 'Could not change to the given directory, please check the path.', 
+	'INST_ERR_FTP_LOGIN'		=> 'Could not login to ftp server, check your username and password', 
+);
+
+// Bots
+$this->lang += array(
+	'BOTS_EXPLAIN'	=> 'Bots or crawlers are automated agents most commonly used by search engines to update their databases. Since they rarely make proper use of sessions they can distort visitor counts, increase load and sometimes fail to index sites correctly. Here you can define a special type of user to overcome these problems.',
+	
+	'BOT_NAME'			=> 'Bot name',
+	'BOT_LAST_VISIT'	=> 'Last visit', 
+	'BOT_NEVER'			=> 'Never', 
+	'BOT_ACTIVATE'		=> 'Activate', 
+	'BOT_DEACTIVATE'	=> 'Deactivate', 
+	'BOT_ADD'			=> 'Add bot',
+
+	'BOT_EDIT'			=> 'Edit bots', 
+	'BOT_EDIT_EXPLAIN'	=> 'Here you can add or edit an existing bot entry. You may define an agent string and/or one or more IP addresses (or range of addresses) to match. Be careful when defining matching agent strings or addresses. You may also specify a style and language that the bot will view the board using. This may allow you to reduce bandwidth use by setting a simple style for bots. Remember to set appropriate permissions for the special Bot usergroup.', 
+	'BOT_NAME_EXPLAIN'	=> 'Used only for your own information.',
+	'BOT_LANG'			=> 'Bot language', 
+	'BOT_LANG_EXPLAIN'	=> 'The language presented to the bot as it browses.', 
+	'BOT_STYLE'			=> 'Bot style', 
+	'BOT_STYLE_EXPLAIN'	=> 'The style used for the board by the bot.', 
+	'BOT_VIS'			=> 'Bot visible', 
+	'BOT_VIS_EXPLAIN'	=> 'Allow bot to be seen by all users in online lists.', 
+	'BOT_ACTIVE'		=> 'Bot active', 
+	'BOT_AGENT'			=> 'Agent match', 
+	'BOT_AGENT_EXPLAIN'	=> 'A string matching the bots browser agent, partial matches are allowed.', 
+	'BOT_IP'			=> 'Bot IP address',
+	'BOT_IP_EXPLAIN'	=> 'Partial matches are allowed, seperate addresses with an apostrophe. A single hostname may be entered instead of an IP.',
+
+	'BOT_ADDED'		=> 'New bot successfully added', 
+	'BOT_UPDATED'	=> 'Existing bot updated successfully', 
+	'BOT_DELETED'	=> 'Bot deleted successfully', 
+
+	'NO_BOT'	=> 'Found no bot with the specified ID', 
+	'ERR_BOT_NO_MATCHES'	=> 'You must supply at least one of an agent or IP for this bot match.', 
+	'ERR_BOT_NO_IP'			=> 'The IP addresses you supplied were invalid or the hostname could not be resolved.', 
+);
+
+// Custom profile fields
+$this->lang += array(
+	'FIELD_INT'		=> 'Numbers',
+	'FIELD_STRING'	=> 'Single Textfield',
+	'FIELD_TEXT'	=> 'Textarea',
+	'FIELD_BOOL'	=> 'Boolean (Yes/No)',
+	'FIELD_DROPDOWN'=> 'Dropdown Box',
+	'FIELD_DATE'	=> 'Date',
+
+	'NO_FIELD_TYPE'				=> 'No Field type specified',
+	'FIRST_OPTION'				=> 'First Option',
+	'SECOND_OPTION'				=> 'Second Option',
+	'EMPTY_FIELD_NAME'			=> 'Empty field name',
+	'EMPTY_USER_FIELD_NAME'		=> 'Empty Field Name presented to the user',
+	'FIELD_IDENT_ALREADY_EXIST'	=> 'Field identifier %s already exist, please choose another Field Name.',
+	'NEXT_PAGE'					=> 'Next Page',
+	'PREVIOUS_PAGE'				=> 'Previous Page',
+	'STEP_1_TITLE'				=> 'Add Profile Field',
+	'STEP_1_EXPLAIN'			=> 'Here you can enter the first basic parameters of your new profile field. These informations are needed for the second step where you are able to set remaining options and where you are able to preview and tweak your profile field further.',
+	'STEP_2_TITLE'				=> 'Profile type specific options',
+	'STEP_2_EXPLAIN'			=> 'Here you are able to define some common options. Further you are able to preview the field you generated, as the user will see it. Play around with it until you are satisfied as how the field behaves.',
+	'STEP_3_TITLE'				=> 'Remaining Language Definitions',
+	'STEP_3_EXPLAIN'			=> 'Since you have more than one board language installed, you have to fill out the remaining language items too. The profile field will work with the default language enabled, you are able to fill out the remaining language items later too.',
+	'ROWS'						=> 'Rows',
+	'COLUMNS'					=> 'Columns',
+	'UPDATE_PREVIEW'			=> 'Update Preview',
+	'PREVIEW_PROFILE_FIELD'		=> 'Preview Profile Field',
+	'EVERYTHING_OK'				=> 'Everything OK',
+
+	'STRING_DEFAULT_VALUE_EXPLAIN'	=> 'Enter a default phrase to be displayed, a default value. Leave empty if you want to show it empty at the first place.',
+	'TEXT_DEFAULT_VALUE_EXPLAIN'=> 'Enter a default text to be displayed, a default value. Leave empty if you want to show it empty at the first place.',
+	'BOOL_ENTRIES_EXPLAIN'		=> 'Enter your options now',
+	'DROPDOWN_ENTRIES_EXPLAIN'	=> 'Enter your options now, every option in one line',
+
+	'REQUIRED_FIELD'			=> 'Required Field',
+	'REQUIRED_FIELD_EXPLAIN'	=> 'Force profile field to be filled out or specified by user',
+	'DISPLAY_AT_REGISTRATION'	=> 'Display at registration screen',
+	'HIDE_PROFILE_FIELD'		=> 'Hide Profile Field',
+	'HIDE_PROFILE_FIELD_EXPLAIN'=> 'Only Administrators and Moderators are able to see/fill out this profile field',
+
+	'ADDED_PROFILE_FIELD'		=> 'Successfully added custom profile field',
+	'CREATE_NEW_FIELD'			=> 'Create New Field',
+	'DELETED_PROFILE_FIELD'		=> 'Successfully deleted profile field.',
+	'CONFIRM_DELETE_PROFILE_FIELD'	=> 'Are you sure you want to delete this profile field?',
+	'PROFILE_FIELD_ACTIVATED'	=> 'Profile field successfully activated',
+	'PROFILE_FIELD_DEACTIVATED'	=> 'Profile field successfully deactivated',
+
+	'CHARS_ANY'		=> 'Any character', 
+	'NUMBERS_ONLY'	=> 'Only numbers (0-9)',
+	'ALPHA_ONLY'		=> 'Alphanumeric only', 
+	'ALPHA_SPACERS'	=> 'Alphanumeric and spacers', 
+
+	'FIELD_TYPE'			=> 'Field Type',
+	'FIELD_TYPE_EXPLAIN'	=> 'You are not able to change the field type later.',
+	'FIELD_NAME'			=> 'Field Name',
+	'FIELD_NAME_EXPLAIN'	=> 'The Field Name is a name for you to identify the profile field, it is not displayed to the user. You are able to use this name as template variable later.',
+	'LANG_SPECIFIC_OPTIONS'	=> 'Language specific options [<b>%s</b>]',
+	'USER_FIELD_NAME'		=> 'Field Name presented to the user',
+	'FIELD_DESCRIPTION'		=> 'Field Description',
+	'FIELD_DESCRIPTION_EXPLAIN'	=> 'The Explanation for this field presented to the user',
+
+	'CP_LANG_NAME'			=> 'Field Name presented to the user',
+	'CP_LANG_EXPLAIN'		=> 'Field Description',
+	'CP_LANG_EXPLAIN_EXPLAIN'	=> 'The Explanation for this field presented to the user',
+	'CP_LANG_DEFAULT_VALUE'	=> 'Default Value',
+	'CP_LANG_OPTIONS'		=> 'Options',
+
+	'FIELD_LENGTH'			=> 'Length of input box',
+	'MIN_FIELD_CHARS'		=> 'Minimum number of characters',
+	'MAX_FIELD_CHARS'		=> 'Maximum number of characters',
+	'MIN_FIELD_NUMBER'		=> 'Lowest allowed number',
+	'MAX_FIELD_NUMBER'		=> 'Highest allowed number',
+	'DEFAULT_VALUE'			=> 'Default Value',
+	'FIELD_VALIDATION'		=> 'Field Validation',
+	'ENTRIES'				=> 'Entries',
+	'BOOL_TYPE_EXPLAIN'		=> 'Define the Type, either a checkbox or radio buttons',
+	'RADIO_BUTTONS'			=> 'Radio Buttons',
+	'CHECKBOX'				=> 'Checkbox',
+	'NO_VALUE_OPTION'		=> 'Option equal to non entered value',
+	'NO_VALUE_OPTION_EXPLAIN'	=> 'Value for a non-entry. If the field is required, the user gets an error if he choose the option selected here',
+	'ALWAYS_TODAY'			=> 'Always the current date',
+
+	'DEFAULT_ISO_LANGUAGE'	=> 'Default Language [%s]',
+	'ISO_LANGUAGE'			=> 'Language [%s]',
+);
+
+?>
\ No newline at end of file

Added: cms/trunk/language/en/admin/system.php
===================================================================
--- cms/trunk/language/en/admin/system.php	2005-09-19 19:26:34 UTC (rev 133)
+++ cms/trunk/language/en/admin/system.php	2005-09-19 19:56:09 UTC (rev 134)
@@ -0,0 +1,1980 @@
+<?php
+// -------------------------------------------------------------
+//
+// $Id: system.php,v 1.1 2005/09/04 15:39:04 viperal Exp $
+//
+// FILENAME  : admin.php [ English ]
+// STARTED   : Sat Dec 16, 2000
+// COPYRIGHT : ? 2001, 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+
+$this->lang += array(
+	'SITE_URL'	=> 'Site Address', 
+	'SITE_LOGO'		=> 'Site Logo',
+	'SLOGAN'		=> 'Slogan',
+
+	'START_DATE'	=> 'Start date',
+	'MAINTENANCE'	=> 'Maintenance Mode',
+
+	'MAINTENANCE_TEXT'	=> 'Maintance Message',
+	'LINK_OPTIMIZATION'	=> 'Link Optimization',
+	'DEFAULT_THEME'		=> 'Default Theme',
+
+	'FOOTER_MESSAGE'	=> 'Footer messages', 
+	'EDITOR_OPTION'		=> 'Enable WYSIWYG editor',
+	'WYSIWYG_EDITOR'	=> 'WYSIWYG Editor',
+	'SITE'				=> 'Site Settings', 
+	'USERS_OPTIONS'		=> 'Users Options', 
+	'SYSTEM'			=> 'System',
+	'PRUNE'				=> 'Pruning',
+
+	'GENERAL_CAT'		=> 'General',
+	'AUTH_SETTINGS'		=> 'Authentication',
+	'AVATAR_SETTINGS'	=> 'Avatar Settings',
+	'BASIC_CONFIG'		=> 'Basic Configuration',
+	'BOARD_DEFAULTS'	=> 'Board Defaults',
+	'BOARD_SETTINGS'	=> 'Board Settings',
+	'COOKIE_SETTINGS'	=> 'Cookie Settings',
+	'MESSAGE_SETTINGS'	=> 'Message Settings',
+	'EMAIL_SETTINGS'	=> 'Email Settings',
+	'MASS_EMAIL'		=> 'Mass Email',
+	'SERVER_SETTINGS'	=> 'Server Settings', 
+	'LOAD_SETTINGS'		=> 'Load Settings', 
+	'EVENTS'			=> 'Events', 
+	'CRON'				=> 'Cronjobs', 
+	'PHP_INFO'			=> 'PHP Information', 
+	'IM'				=> 'Jabber Settings', 
+
+	'LOG_CAT'		=> 'Logging',
+	'ADMIN_LOGS'	=> 'Admin Log',
+	'MOD_LOGS'		=> 'Moderator Log',
+	'CRITICAL_LOGS'	=> 'Error Log',
+
+	'PERM_CAT'		=> 'Permissions', 
+	'USER_PERMS'	=> 'User permissions', 
+	'GROUP_PERMS'	=> 'Group permissions', 
+
+	'POST_CAT'		=> 'Posting',
+	'SMILE'			=> 'Smilies',
+	'ICONS'			=> 'Icons',
+	'WORD_CENSOR'	=> 'Word Censors',
+
+	'STYLE_CAT'			=> 'Styles',
+	'MANAGE_STYLE'		=> 'Styles', 
+	'MANAGE_TEMPLATE'	=> 'Templates', 
+	'MANAGE_THEME'		=> 'Themes', 
+	'MANAGE_IMAGESET'	=> 'Imagesets', 
+
+	'USER_CAT'		=> 'Users / Groups', 
+	'MANAGE_USERS'	=> 'Manage Users', 
+	'BAN_EMAILS'	=> 'Ban Emails',
+	'BAN_IPS'		=> 'Ban IPs',
+	'BAN_USERS'		=> 'Ban Usernames',
+	'DISALLOW'		=> 'Disallow names',
+	'RANKS'			=> 'Ranks',
+	'PRUNE_USERS'	=> 'Prune users', 
+	'BOTS'			=> 'Manage Bots', 
+	'GROUP_MANAGE'	=> 'Manage groups', 
+	'CUSTOM_PROFILE_FIELDS'	=> 'Profile fields', 
+
+	'ADMINISTRATORS'	=> 'Administrators',
+	'USERNAMES_EXPLAIN'	=> 'Place each username on a seperate line', 
+	'LOOK_UP_FORUM'		=> 'Select a Forum',
+	'MANAGE'			=> 'Manage',
+	'ADD'				=> 'Add', 
+	'PERMISSIONS'		=> 'Permissions', 
+	'UPDATE'			=> 'Update',
+	'EXPORT_STORE'		=> 'Store', 
+	'EXPORT_DOWNLOAD'	=> 'Download', 
+	'CONFIG_UPDATED'	=> 'Configuration updated successfully', 
+	'DOWNLOAD_STORE'		=> 'Download or Store file', 
+	'DOWNLOAD_STORE_EXPLAIN'=> 'You may directly download the file or save it in your store/ folder.', 
+	'COLOUR_SWATCH'		=> 'Web-safe colour swatch', 
+	'UPDATE_MARKED'		=> 'Update Marked',
+	'UPDATE_ALL'		=> 'Update All', 
+
+	'CONFIRM_OPERATION'	=> 'Are you sure you wish to carry out this operation?', 
+
+	'log_index_activate'	=> '<b>Activated inactive users</b><br />&#187; %s users',
+	'log_index_delete'		=> '<b>Deleted inactive users</b><br />&#187; %s',
+	'LOG_INDEX_REMIND'		=> '<b>Sent reminder emails to inactive users</b><br />&#187; %s',
+
+	'LOG_USER_INACTIVE'		=> '<b>User deactivated</b><br />&#187; %s', 
+	'LOG_USER_ACTIVE'		=> '<b>User activated</b><br />&#187; %s', 
+
+	'LOG_MASS_EMAIL'		=> '<b>Sent mass email</b><br />&#187; %s',
+
+	'LOG_DELETE_WORD'		=> '<b>Deleted word censor</b><br />&#187; %s',
+	'LOG_EDIT_WORD'			=> '<b>Edited word censor</b><br />&#187; %s',
+	'LOG_ADD_WORD'			=> '<b>Added word censor</b><br />&#187; %s',
+
+	'log_db_backup'			=> '<b>Database backup</b>',
+	'log_db_restore'		=> '<b>Database restore</b>',
+	'log_search_index'		=> '<b>Re-indexed search system</b><br />&#187; %s',
+
+	'log_disallow_add'		=> '<b>Added disallowed username</b><br />&#187; %s',
+	'log_disallow_delete'	=> '<b>Deleted disallowed username</b>',
+
+	'LOG_ADMIN_CLEAR'		=> '<b>Cleared admin log</b>',
+	'LOG_MOD_CLEAR'			=> '<b>Cleared moderator log</b>',
+	'LOG_CRITICAL_CLEAR'	=> '<b>Cleared error log</b>',
+
+	'LOG_PRUNE'				=> '<b>Pruned forums</b><br />&#187; %s',
+	'LOG_AUTO_PRUNE'		=> '<b>Auto-pruned forums</b><br />&#187; %s',
+
+	'LOG_BAN_EXCLUDE_USER'	=> '<b>Excluded user from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_EXCLUDE_IP'	=> '<b>Excluded ip from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_EXCLUDE_EMAIL' => '<b>Excluded email from ban</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_USER'			=> '<b>Banned User</b> for reason %s<br />&#187; %s ',
+	'LOG_BAN_IP'			=> '<b>Banned ip</b> for reason %s<br />&#187; %s',
+	'LOG_BAN_EMAIL'			=> '<b>Banned email</b> for reason %s<br />&#187; %s',
+	'LOG_UNBAN_USER'		=> '<b>Unbanned user</b><br />&#187; %s',
+	'LOG_UNBAN_IP'			=> '<b>Unbanned ip</b><br />&#187; %s',
+	'LOG_UNBAN_EMAIL'		=> '<b>Unbanned email</b><br />&#187; %s',
+
+	'LOG_DOWNLOAD_EXCLUDE_IP'	=> '<b>Exluded ip/hostname from download list</b><br />&#187; %s',
+	'LOG_DOWNLOAD_IP'			=> '<b>Added ip/hostname to download list</b><br />&#187; %s',
+	'LOG_DOWNLOAD_REMOVE_IP'	=> '<b>Removed ip/hostname from download list</b><br />&#187; %s',
+	
+	'LOG_SERVER_CONFIG'		=> '<b>Altered server settings</b>',
+	'LOG_DEFAULT_CONFIG'	=> '<b>Altered board defaults</b>',
+	'LOG_SETTING_CONFIG'	=> '<b>Altered board settings</b>',
+	'LOG_COOKIE_CONFIG'		=> '<b>Altered cookie settings</b>',
+	'LOG_EMAIL_CONFIG'		=> '<b>Altered email settings</b>',
+	'LOG_AVATAR_CONFIG'		=> '<b>Altered avatar settings</b>',
+	'LOG_AUTH_CONFIG'		=> '<b>Altered authentication settings</b>',
+	'LOG_LOAD_CONFIG'		=> '<b>Altered load settings</b>', 
+	'LOG_MESSAGE_CONFIG'	=> '<b>Altered private message settings</b>',
+
+	'LOG_ATTACH_CONFIG'		=> '<b>Altered attachment settings</b>',
+	'LOG_ATTACH_EXT_ADD'	=> '<b>Added or edited attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXT_DEL'	=> '<b>Removed attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXT_UPDATE'	=> '<b>Updated attachment extension</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_ADD' => '<b>Added extension group</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_EDIT' => '<b>Edited extension group</b><br />&#187; %s',
+	'LOG_ATTACH_EXTGROUP_DEL' => '<b>Removed extension group</b><br />&#187; %s',
+	'LOG_ATTACH_FILEUPLOAD'	=> '<b>Orphan File uploaded to Post Number %1$d - %2$s</b>',
+	'LOG_ATTACH_ORPHAN_DEL'	=> '<b>Orphan Files deleted</b><br />&#187; %s',
+
+	'log_prune_user_deac'	=> '<b>Users Deactivated</b><br />%s',
+	'log_prune_user_del_del'=> '<b>Users Pruned and Posts Deleted</b><br />%s',
+	'log_prune_user_del_anon'=> '<b>Users Pruned and Posts Retained</b><br />%s',
+
+	'LOG_RESYNC_STATS'		=> '<b>Post, topic and user stats reset</b>', 
+	'LOG_RESET_DATE'		=> '<b>Board start date reset</b>', 
+	'LOG_RESET_ONLINE'		=> '<b>Most users online reset</b>',
+
+	'LOG_ACL_MOD_DEL'			=> '<b>Removed Moderators</b> from %s<br />&#187; %s', 
+	'LOG_ACL_MOD_ADD'			=> '<b>Added or edited Moderators</b> from %s<br />&#187; %s', 
+	'LOG_ACL_SUPERMOD_DEL'		=> '<b>Removed Super Moderators</b><br />&#187; %s', 
+	'LOG_ACL_SUPERMOD_ADD'		=> '<b>Added or edited Super Moderators</b><br />&#187; %s', 
+	'LOG_ACL_ADMIN_DEL'			=> '<b>Removed Administrators</b><br />&#187; %s', 
+	'LOG_ACL_ADMIN_ADD'			=> '<b>Added or edited Administrators</b><br />&#187; %s', 
+	'LOG_ACL_FORUM_DEL'			=> '<b>Removed Forum access</b> from %s<br />&#187; %s', 
+	'LOG_ACL_FORUM_ADD'			=> '<b>Added or edited Forum access</b> from %s<br />&#187; %s', 
+	'LOG_ACL_USER_ADD'			=> '<b>Edited User permissions</b><br />&#187; %s', 
+	'LOG_ACL_GROUP_ADD'			=> '<b>Edited Group permissions</b><br />&#187; %s', 
+	'LOG_ACL_PRESET_ADD'		=> '<b>Added or edited permission preset</b><br />&#187; %s', 
+	'LOG_ACL_PRESET_DEL'		=> '<b>Deleted permission preset</b><br />&#187; %s', 
+
+	'LOG_FORUM_ADD'			=> '<b>Created new forum</b><br />&#187; %s',
+	'LOG_FORUM_MOVE_UP'		=> '<b>Moved forum</b> %s <b>above</b> %s', 
+	'LOG_FORUM_MOVE_DOWN'	=> '<b>Moved forum</b> %s <b>below</b> %s', 
+	'LOG_FORUM_EDIT'		=> '<b>Edited forum details</b><br />&#187; %s', 
+	'LOG_FORUM_SYNC'		=> '<b>Re-synchronised forum</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS'	=> '<b>Deleted forum and its messages</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_FORUMS'	=> '<b>Deleted forum and its subforums</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS_MOVE_FORUMS'	=> '<b>Deleted forum and its messages, moved subforums</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS_FORUMS'	=> '<b>Deleted forum and its subforums, moved messages</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS'	=> '<b>Deleted forum and moved posts </b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_FORUMS'	=> '<b>Deleted forum and moved subforums</b> to %s<br />&#187; %s', 
+	'LOG_FORUM_DEL_POSTS_FORUMS'=> '<b>Deleted forum, its messages and subforums</b><br />&#187; %s', 
+	'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS'	=> '<b>Deleted forum, moved posts</b> to %s <b>and subforums</b> to %s<br />&#187; %s', 
+
+	'LOG_GROUP_UPDATED'		=> '<b>Usergroup details updated</b><br />&#187; %s',
+	'LOG_GROUP_CREATED'		=> '<b>New usergroup created</b><br />&#187; %s',
+	'LOG_MODS_ADDED'		=> '<b>Added new leaders to usergroup</b> %s<br />&#187; %s', 
+	'LOG_USERS_ADDED'		=> '<b>Added new members to usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DEFAULTS'	=> '<b>Group made default for members</b><br />&#187; %s', 
+	'LOG_USERS_APPROVED'	=> '<b>Users approved in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DEMOTED'		=> '<b>Leaders demoted in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_PROMOTED'	=> '<b>Members promoted to leader in usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_REMOVE'		=> '<b>Members removed from usergroup</b> %s<br />&#187; %s', 
+	'LOG_GROUP_DELETE'		=> '<b>Usergroup deleted</b><br />&#187; %s', 
+
+	'LOG_ADD_STYLE'		=> '<b>Added new style</b><br />&#187; %s', 
+	'LOG_EDIT_STYLE'	=> '<b>Edited style</b><br />&#187; %s', 
+	'LOG_EXPORT_STYLE'	=> '<b>Exported style</b><br />&#187; %s', 
+	'LOG_DELETE_STYLE'	=> '<b>Deleted style</b><br />&#187; %s', 
+
+	'LOG_ADD_THEME_FS'		=> '<b>Add new theme on filesystem</b><br />&#187; %s', 
+	'LOG_ADD_THEME_DB'		=> '<b>Added new theme to database</b><br />&#187; %s', 
+	'LOG_EDIT_THEME'		=> '<b>Edited theme</b><br />&#187; %s', 
+	'LOG_EDIT_THEME_DETAILS'=> '<b>Edited theme details</b><br />&#187; %s', 
+	'LOG_EXPORT_THEME'		=> '<b>Exported theme</b><br />&#187; %s', 
+	'LOG_DELETE_THEME'		=> '<b>Theme deleted</b><br />&#187; %s', 
+
+	'LOG_ADD_TEMPLATE_FS'		=> '<b>Add new template set on filesystem</b><br />&#187; %s', 
+	'LOG_ADD_TEMPLATE_DB'		=> '<b>Added new template set to database</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE'			=> '<b>Edited template set</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE_DETAILS'	=> '<b>Edited template details</b><br />&#187; %s', 
+	'LOG_EXPORT_TEMPLATE'		=> '<b>Exported template set</b><br />&#187; %s', 
+	'LOG_DELETE_TEMPLATE'		=> '<b>Deleted template set</b><br />&#187; %s', 
+	'LOG_EDIT_TEMPLATE'			=> '<b>Edited template</b><br />&#187; %s [%s]', 
+	'LOG_CLEAR_TPLCACHE'		=> '<b>Cleared template cache</b><br />&#187; %s', 
+
+	'LOG_ADD_IMAGESET'			=> '<b>Added new imageset</b><br />&#187; %s', 
+	'LOG_EDIT_IMAGESET'			=> '<b>Edited imageset</b><br />&#187; %s', 
+	'LOG_EDIT_IMAGESET_DETAILS'	=> '<b>Edited imageset details</b><br />&#187; %s', 
+	'LOG_EXPORT_IMAGESET'		=> '<b>Exported imageset</b><br />&#187; %s', 
+	'LOG_DELETE_IMAGESET'		=> '<b>Deleted imageset</b><br />&#187; %s',
+	
+	'LOG_BBCODE_ADD'		=> '<b>Added new BBCode</b><br />&#187; %s',
+	'LOG_BBCODE_EDIT'		=> '<b>Edited BBCode</b><br />&#187; %s',
+	'LOG_BBCODE_DELETE'		=> '<b>Deleted BBCode</b><br />&#187; %s',
+
+	'LOG_JAB_PASSCHG'	=> '<b>Jabber password changed</b>', 
+	'LOG_JAB_REGISTER'	=> '<b>Jabber account registered</b>', 
+	'LOG_JAB_CHANGED'	=> '<b>Jabber account changed</b>', 
+
+	'LOG_EMAIL_ERROR'	=> '%s', 
+	'LOG_JABBER_ERROR'	=> '%s', 
+
+	'LOG_BOT_ADDED'		=> '<b>New bot added</b><br />&#187; %s',
+	'LOG_BOT_UPDATED'	=> '<b>Existing bot updated</b><br />&#187; %s',
+	'LOG_BOT_DELETE'	=> '<b>Deleted bot</b><br />&#187; %s', 
+);
+
+// Index page
+$this->lang += array(
+	'WELCOME_PHPBB'	=> 'Welcome to phpBB',
+	'ADMIN_INTRO'	=> 'Thank you for choosing phpBB as your forum solution. This screen will give you a quick overview of all the various statistics of your board. The links on the left hand side of this screen allow you to control every aspect of your forum experience. Each page will have instructions on how to use the tools.',
+
+	'FORUM_STATS'	=> 'Forum Statistics',
+	'STATISTIC'		=> 'Statistic',
+	'VALUE'			=> 'Value',
+	'NUMBER_POSTS'	=> 'Number of posts',
+	'POSTS_PER_DAY' => 'Posts per day',
+	'NUMBER_TOPICS' => 'Number of topics',
+	'TOPICS_PER_DAY'=> 'Topics per day',
+	'NUMBER_USERS'	=> 'Number of users',
+	'USERS_PER_DAY' => 'Users per day',
+	'NUMBER_FILES'	=> 'Number of Attachments',
+	'FILES_PER_DAY'	=> 'Attachments per day',
+	'BOARD_STARTED' => 'Board started',
+	'AVATAR_DIR_SIZE'	=> 'Avatar directory size',
+	'UPLOAD_DIR_SIZE'	=> 'Upload directory size',
+	'DATABASE_SIZE'		=> 'Database size',
+	'GZIP_COMPRESSION'	=> 'Gzip compression',
+	'NOT_AVAILABLE'		=> 'Not available',
+	'ON'				=> 'ON',
+	'OFF'				=> 'OFF',
+	'RESET_ONLINE'		=> 'Reset Online', 
+	'RESET_DATE'		=> 'Reset Date', 
+	'RESYNC_STATS'		=> 'Resync Stats', 
+
+	'INACTIVE_USERS'		=> 'Inactive Users',
+	'INACTIVE_USERS_EXPLAIN'=> 'This is a list of users who have registered but whos accounts are inactive. You can activate, delete or remind (by sending an email) these users if you wish.',
+	'NO_INACTIVE_USERS'		=> 'No inactive users',
+	'ACTIVATE'				=> 'Activate', 
+	'REMIND'				=> 'Remind', 
+
+	'ADMIN_LOG'					=> 'Logged administrator actions',
+	'ADMIN_LOG_INDEX_EXPLAIN'	=> 'This gives an overview of the last five actions carried out by board administrators. A full copy of the log can be viewed from the appropriate menu item to the left.',
+	'IP'	=> 'User IP',
+	'ACTION'=> 'Action',
+);
+
+// Restore/Backup
+$this->lang += array(
+	'Database_Utilities' => 'Database Utilities',
+
+	'Backup'			=> 'Backup',
+	'Backup_explain'	=> 'Here you can backup all your phpBB related data. You may store the resulting archive in your store/ folder or download it directly. Depending on your server configuration you be able to compress the file in a number of formats. If you wish to include any additional "custom" tables please list them in the additional tables field, separated by commas. ',
+	'Backup_options'	=> 'Backup options',
+	'Backup_type'		=> 'Backup type',
+	'Start_backup'		=> 'Start Backup',
+	'Full_backup'		=> 'Full',
+	'Structure_only'	=> 'Structure Only',
+	'Data_only'			=> 'Data only',
+	'INC_SEARCH_INDEX'			=> 'Include Search Index tables',
+	'INC_SEARCH_INDEX_EXPLAIN'	=> 'Saying no here will reduce the size of the backup by ignoring the search indexes.',
+	'Additional_tables'			=> 'Additional tables',
+	'Additional_tables_explain' => 'Include the names of other tables you wish to backup here, comma separated.',
+	'Compress_file'			=> 'Compress file',
+	'Store_local'			=> 'Store file locally',
+	'Store_local_explain'	=> 'To store the file on the server rather than download it specify a path here relative to the phpBB2 root.',
+	'Backup_download'		=> 'Your download will start shortly please wait till it begins',
+	'Backup_writing'		=> 'The backup file is being generated please wait till it completes',
+	'Backup_success'		=> 'The backup file has been created successfully in the location you specified',
+	'Backups_not_supported' => 'Sorry but database backups are not currently supported for your database system',
+
+	'Restore' => 'Restore',
+	'Restore_explain' => 'This will perform a full restore of all phpBB tables from a saved file. You can <u>either</u> upload the backup file via this form or upload it manually to a location on the server. If your server supports it you may use a gzip compressed text file and it will automatically be decompressed. <b>WARNING</b> This will overwrite any existing data. The restore may take a long time to process please do not move from this page till it is complete.',
+	'Upload_file' => 'Upload backup file',
+	'Select_file' => 'Select a file',
+	'Local_backup_file' => 'Location of backup file',
+	'Local_backup_file_explain' => 'Location on the server where backup file is stored relative to the phpBB root, e.g. ../tmp/backup.sql',
+	'Supported_extensions' => 'Supported extensions',
+	'Start_Restore' => 'Start Restore',
+	'Restore_success' => 'The Database has been successfully restored.<br /><br />Your board should be back to the state it was when the backup was made.',
+	'Restore_Error_filename' => 'The file you uploaded had an unsupported extension.',
+	'Compress_unsupported' => 'The version of PHP installed on this server does not support the type of compression used for your backup. Please use a compression method listed on the previous page.',
+	'Restore_Error_no_file' => 'No file was uploaded',
+);
+
+// Permissions
+$this->lang += array(
+	'ACL_EXPLAIN'			=> 'Permissions are based on a simple YES / NO system. Setting an option to NO for a user or usergroup overrides any other value assigned to it. If you do not wish to assign a value for an option for this user or group select UNSET. If values are assigned for this option elsewhere they will be used in preference, else NO is assumed.',
+	'PERMISSIONS_EXPLAIN'	=> 'Here you can alter which users and groups can access which forums. To assign moderators or define administrators please use the appropriate page (see left hand side menu).',
+	'MODERATORS'			=> 'Moderators',
+	'MODERATORS_EXPLAIN'	=> 'Here you can assign users and groups as forum moderators. To assign users access to forums, to define super moderators or administrators please use the appropriate page (see left hand side menu). If you are permitted you can also change permissions for this forum from this page. Use the select box to change views.',
+	'SUPER_MODERATORS'			=> 'Super Moderators',
+	'SUPER_MODERATORS_EXPLAIN'	=> 'Here you can assign users and groups as super moderators. Super Moderators are like ordinary moderators accept they have access to every forum on your board. To assign users access to forums or define administrators please use the appropriate page (see left hand side menu). If you are permitted you can also set permissions for forum options from this page. Use the select box to change views.',
+	'ADMINISTRATORS_EXPLAIN'	=> 'Here you can assign administrator rights to users or groups. All users with admin permissions can view the administration panel. If you are permitted you can also change permissions for forums, super moderator and moderator options from this page. Use the select box to change views.',
+	'USER_PERMISSIONS'			=> 'User Permissions', 
+	'USER_PERMISSIONS_EXPLAIN'	=> 'Here you can set user based permissions. These include capabilities such as the use of avatars, sending private messages, etc. To alter these settings for large numbers of users the Group permissions system is the prefered method.', 
+	'GROUP_PERMISSIONS'			=> 'Group Permissions', 
+	'GROUP_PERMISSIONS_EXPLAIN' => 'Here you can set usergroup based permissions. These include capabilities such as the use of avatars, sending private messages, etc. To alter these settings for single users the User permissions system is the prefered method.', 
+	'DEPENDENCIES'			=>	'Dependencies', 
+	'DEPENDENCIES_EXPLAIN'	=>	'Here you can define relationships between administrator or moderator permission options and forum options. Using this you can automatically update forum permissions based on setting admin or moderator options. While this can save time care should be taken in defining these dependencies. Remember, these settings apply to all users and all groups.', 
+
+	'LOOK_UP_GROUP'		=> 'Look up Usergroup', 
+	'MANAGE_USERS'		=> 'Manage Users',
+	'ADD_USERS'			=> 'Add Users',
+	'MANAGE_GROUPS'		=> 'Manage Groups',
+	'ADD_GROUPS'		=> 'Add Groups',
+	'ALLOWED_USERS'		=> 'Allowed users',
+	'DISALLOWED_USERS'	=> 'Disallowed users',
+	'ALLOWED_GROUPS'	=> 'Allowed groups',
+	'DISALLOWED_GROUPS' => 'Disallowed groups',
+	'REMOVE_SELECTED'	=> 'Remove selected',
+	'SET_OPTIONS'	=> 'Set Options',
+	'OPTION'		=> 'Option',
+	'YES'			=> 'Yes',
+	'NO'			=> 'No',
+	'UNSET'			=> 'Unset', 
+	'IGNORE'		=> 'Ignore', 
+	'PRESETS'		=> 'Presets', 
+	'ALL_YES'		=> 'All Yes',
+	'ALL_NO'		=> 'All No',
+	'ALL_UNSET'		=> 'All Unset', 
+	'ALL_IGNORE'	=> 'All Ignore', 
+	'USER_PRESETS'	=> 'User presets', 
+	'FROM_PARENT'	=> 'From Parent', 
+	'SELECT_VIEW'	=> 'Select view', 
+	'ACL_SUBFORUMS'			=> 'Assign to sub-forums',
+	'ACL_SUBFORUMS_EXPLAIN'	=> 'Select the subforums (if any) you want to inherit these permissions',
+	'PRESETS_EXPLAIN'		=> 'To update or delete an existing preset select it from the list.', 
+	'SELECT_PRESET'			=> 'Select preset', 
+	'PRESET_NAME'			=> 'Preset name', 
+	'EMPTY'					=> 'Empty',
+	'WARNING'			=> 'Warning', 
+	'WARNING_EXPLAIN'	=> 'You have altered settings for one or alternative views. Be sure to verify these settings before updating', 
+	'NOTIFY'			=> 'Notification',
+	'SELECTED_USER'		=> 'Selected User', 
+	'SELECTED_USERS'	=> 'Selected Users', 
+	'SELECTED_GROUP'	=> 'Selected Group', 
+	'SELECTED_GROUPS'	=> 'Selected Groups', 
+	'SELECTED_FORUM'	=> 'Selected Forum', 
+	'SELECTED_FORUMS'	=> 'Selected Forums', 
+	'WILL_SET_OPTIONS'	=> 'Will set options in', 
+	'INHERIT_PARENT'	=> 'Inherit Parent',
+	'SAVE'				=> 'Save',
+
+	'ACL_VIEW_FORUM'	=> 'Forum Options', 
+	'ACL_VIEW_MOD'		=> 'Moderator Options', 
+	'ACL_VIEW_SUPERMOD'	=> 'Supermod Options', 
+	'ACL_VIEW_ADMIN'	=> 'Admin Options', 
+
+	'AUTH_UPDATED'	=> 'Permissions have been updated',
+
+	'acl_a_server' 		=> 'Can alter server and email settings',
+	'acl_a_defaults' 	=> 'Can alter board defaults',
+	'acl_a_board' 		=> 'Can alter board settings',
+	'acl_a_cookies' 	=> 'Can alter cookie settings',
+	'acl_a_names' 		=> 'Can alter disallowed names',
+	'acl_a_words' 		=> 'Can alter word censors',
+	'acl_a_icons' 		=> 'Can alter topic icons and emoticons',
+	'acl_a_search' 		=> 'Can re-index search tables',
+	'acl_a_prune' 		=> 'Can prune forums',
+	'acl_a_bbcode' 		=> 'Can define BBCode tags',
+	'acl_a_attach' 		=> 'Can manage attachments',
+	'acl_a_ranks'		=> 'Can manage ranks',
+	'acl_a_user' 		=> 'Can manage users',
+	'acl_a_userdel' 	=> 'Can delete or prune users',
+	'acl_a_useradd' 	=> 'Can add new users',
+	'acl_a_group' 		=> 'Can manage groups',
+	'acl_a_groupdel' 	=> 'Can delete groups',
+	'acl_a_groupadd' 	=> 'Can add new groups',
+	'acl_a_forum' 		=> 'Can manage forums',
+	'acl_a_forumdel' 	=> 'Can delete forums',
+	'acl_a_forumadd' 	=> 'Can add new forums',
+	'acl_a_ban' 		=> 'Can manage bans',
+	'acl_a_auth' 		=> 'Can alter forum permissions',
+	'acl_a_authmods' 	=> 'Can alter moderator permissions',
+	'acl_a_authadmins' 	=> 'Can alter admin permissions',
+	'acl_a_authusers' 	=> 'Can alter user permissions',
+	'acl_a_authgroups' 	=> 'Can alter group permissions',
+	'acl_a_email' 		=> 'Can send mass email',
+	'acl_a_styles' 		=> 'Can manage styles',
+	'acl_a_backup' 		=> 'Can backup database',
+	'acl_a_restore' 	=> 'Can restore database',
+	'acl_a_clearlogs' 	=> 'Can clear admin and mod logs',
+	'acl_a_events' 		=> 'Can use event system',
+	'acl_a_cron' 		=> 'Can use cron system',
+	'acl_a_authdeps'	=> 'Can set dependencies', 
+
+	'acl_m_edit'	=> 'Can edit posts',
+	'acl_m_delete'	=> 'Can delete posts',
+	'acl_m_move'	=> 'Can move topics',
+	'acl_m_lock'	=> 'Can lock topics',
+	'acl_m_split'	=> 'Can split topics',
+	'acl_m_merge'	=> 'Can merge topics',
+	'acl_m_approve' => 'Can approve posts',
+	'acl_m_unrate'	=> 'Can un-rate posts',
+	'acl_m_auth'	=> 'Can set permissions',
+	'acl_m_ip'		=> 'Can view IP\'s', 
+	'acl_m_info'	=> 'Can alter forum info', 
+
+	'acl_f_list'		=> 'Can see forum',
+	'acl_f_read'		=> 'Can read forum',
+	'acl_f_post'		=> 'Can post in forum',
+	'acl_f_reply'		=> 'Can reply to posts',
+	'acl_f_quote'		=> 'Can quote posts',
+	'acl_f_edit'		=> 'Can edit own posts',
+	'acl_f_user_lock'	=> 'Can lock own topics',
+	'acl_f_delete'		=> 'Can delete own posts',
+	'acl_f_poll'		=> 'Can create polls',
+	'acl_f_vote'		=> 'Can vote in polls',
+	'acl_f_votechg'		=> 'Can change existing vote',
+	'acl_f_announce'	=> 'Can post announcements',
+	'acl_f_sticky'		=> 'Can post stickies',
+	'acl_f_attach'		=> 'Can attach files',
+	'acl_f_download'	=> 'Can download files',
+	'acl_f_html'		=> 'Can post HTML',
+	'acl_f_bbcode'		=> 'Can post BBCode',
+	'acl_f_smilies'		=> 'Can post smilies',
+	'acl_f_img'			=> 'Can post images',
+	'acl_f_flash'		=> 'Can post Flash',
+	'acl_f_sigs'		=> 'Can use signatures',
+	'acl_f_search'		=> 'Can search the forum',
+	'acl_f_email'		=> 'Can email topics',
+	'acl_f_rate'		=> 'Can rate posts',
+	'acl_f_report'		=> 'Can report posts',
+	'acl_f_print'		=> 'Can print topics',
+	'acl_f_ignoreflood' => 'Can ignore flood limit',
+	'acl_f_postcount'	=> 'Increment post counter',
+	'acl_f_moderate'	=> 'Posts are moderated',
+	'acl_f_bump'		=> 'Can bump topics',
+	'acl_f_subscribe'	=> 'Can subscribe forum',
+
+	'acl_u_hideonline'	=> 'Can hide online status', 
+	'acl_u_viewonline'	=> 'Can view all online',
+	'acl_u_viewprofile'	=> 'Can view profiles',
+	'acl_u_sendemail'	=> 'Can send emails',
+	'acl_u_sendim'		=> 'Can send instant messages', 
+	'acl_u_sendpm'		=> 'Can send private messages',
+	'acl_u_readpm'		=> 'Can read private messages',
+	'acl_u_chgavatar'	=> 'Can change avatar',
+	'acl_u_chgemail'	=> 'Can change email address',
+	'acl_u_chgname'		=> 'Can change username',
+	'acl_u_chggrp'		=> 'Can change default usergroup',
+	'acl_u_chgpasswd'	=> 'Can change password',
+	'acl_u_chgcensors'	=> 'Can disable word censors',
+	'acl_u_search'		=> 'Can search board',
+	'acl_u_savedrafts'	=> 'Can save drafts',
+	'acl_u_download'	=> 'Can download files',
+	'acl_u_attach'		=> 'Can attach files',
+
+	'acl_u_pm_attach'	=> 'Can attach files in private messages',
+	'acl_u_pm_html'		=> 'Can post HTML in private messages',
+	'acl_u_pm_bbcode'	=> 'Can post BBCode in private messages',
+	'acl_u_pm_smilies'	=> 'Can post smilies in private messages',
+	'acl_u_pm_download'	=> 'Can download files in private messages',
+	'acl_u_pm_sig'		=> 'Can use signature in private messages',
+	'acl_u_pm_report'	=> 'Can report private messages',
+	'acl_u_pm_edit'		=> 'Can edit own private messages',
+	'acl_u_pm_printpm'	=> 'Can print private messages',
+	'acl_u_pm_emailpm'	=> 'Can email private messages',
+	'acl_u_pm_forward'	=> 'Can forward private messages',
+	'acl_u_pm_delete'	=> 'Can remove private messages from own folder',
+	'acl_u_pm_img'		=> 'Can post images in private messages',
+	'acl_u_pm_flash'	=> 'Can post Flash in private messages'
+);
+
+// User pruning
+$this->lang += array(
+	'PRUNE_USERS_EXPLAIN'	=> 'Here you can delete (or deactivate) users from you board. This can be done in a variety of ways; by post count, last activity, etc. Each of these criteria can be combined, i.e. you can prune users last active before 2002-01-01 with fewer than 10 posts. Alternatively you can enter a list of users directly into the text box, any criteria entered will be ignored. Take care with this facility! Once a user is deleted there is no way back.',
+	'SELECT_USERS_EXPLAIN'	=> 'Enter specific usernames here, they will be used in preference to the criteria above.',
+
+	'LAST_ACTIVE_EXPLAIN'		=> 'Enter a date in yyyy-mm-dd format.',
+	'JOINED_EXPLAIN'			=> 'Enter a date in yyyy-mm-dd format.',
+	'DELETE_USER_POSTS'			=> 'Delete pruned user posts',
+	'DELETE_USER_POSTS_EXPLAIN' => 'Removes posts made by deleted users, has no effect if users are deactivated.',
+	'DEACTIVATE_DELETE'			=> 'Deactivate or delete', 
+	'DEACTIVATE_DELETE_EXPLAIN'	=> 'Choose whether to deactivate users or delete them entirely, note there is no undo!', 
+	'DEACTIVATE'				=> 'Deactivate',
+	'DELETE_USERS'				=> 'Delete', 
+
+	'USER_DEACTIVATE_SUCCESS'	=> 'The selected users have been deactivated successfully',
+	'USER_DELETE_SUCCESS'		=> 'The selected users have been deleted successfully',
+);
+
+// Banning
+$this->lang += array(
+	'BAN_EXPLAIN'				=> 'Here you can control the banning of users by name, IP or email address. These methods prevent a user reaching any part of the board. You can give a short (255 character) reason for the ban if you wish. This will be displayed in the admin log. The length of a ban can also be specified. If you want the ban to end on a specific date rather than after a set time period select <u>Until</u> for the ban length and enter a date in yyyy-mm-dd format.',
+	'BAN_EXCLUDE'				=> 'Exclude from banning', 
+
+	'BAN_REASON'	=> 'Reason for ban',
+	'BAN_LENGTH'	=> 'Length of ban',
+	'PERMANENT'		=> 'Permanent',
+	'30_MINS'		=> '30 Minutes',
+	'1_HOUR'		=> '1 Hour',
+	'6_HOURS'		=> '6 Hours',
+	'OTHER'			=> 'Until', 
+
+	'BAN_USERNAME_EXPLAIN'		=> 'You can ban multiple users in one go by entering each name on a new line. Use the <u>Find a Username</u> facility to look up and add one or more users automatically.',
+	'UNBAN_USERNAME'			=> 'Un-ban or Un-exclude usernames',
+	'UNBAN_USERNAME_EXPLAIN'	=> 'You can unban (or un-exclude) multiple users in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded users have a grey background.',
+	'BAN_USER_EXCLUDE_EXPLAIN'	=> 'Enable this to exclude the entered users from all current bans.', 
+	'NO_BANNED_USERS'			=> 'No banned usernames',
+
+	'IP_HOSTNAME'			=> 'IP addresses or hostnames',
+	'BAN_IP_EXPLAIN'		=> 'To specify several different IP\'s or hostnames enter each on a new line. To specify a range of IP addresses separate the start and end with a hyphen (-), to specify a wildcard use *',
+	'UNBAN_IP'				=> 'Un-ban or Un-exclude IPs',
+	'UNBAN_IP_EXPLAIN'		=> 'You can unban (or un-exclude) multiple IP addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded IP\'s have a grey background.',
+	'BAN_IP_EXCLUDE_EXPLAIN'=> 'Enable this to exclude the entered IP from all current bans.', 
+	'NO_BANNED_IP'			=> 'No banned IP addresses',
+
+	'BAN_EMAIL'					=> 'Ban one or more email addresses',
+	'BAN_EMAIL_EXPLAIN'			=> 'To specify more than one email address enter each on a new line. To match partial addresses use * as the wildcard, e.g. *@hotmail.com, *@*.domain.tld, etc.',
+	'UNBAN_EMAIL'				=> 'Un-ban or Un-exclude Emails',
+	'UNBAN_EMAIL_EXPLAIN'		=> 'You can unban (or un-exclude) multiple email addresses in one go using the appropriate combination of mouse and keyboard for your computer and browser. Excluded email addresses have a grey background.',
+	'BAN_EMAIL_EXCLUDE_EXPLAIN' => 'Enable this to exclude the entered email address from all current bans.', 
+	'NO_BANNED_EMAIL'			=> 'No banned email addresses',
+
+	'BAN_UPDATE_SUCESSFUL'	=> 'The banlist has been updated successfully', 
+);
+
+// Jabber settings
+$this->lang += array(
+	'IM_EXPLAIN'	=> 'Here you can enable and control the use Jabber for instant messaging and board notices. Jabber is an opensource protocol and therefore available for use by anyone. Some Jabber servers include gateways or transports which allow you to contact users on other networks. Not all servers offer all transports and changes in protocols can prevent transports from operating. Note that it may take several seconds to update Jabber account details, do not stop the script till completed!', 
+
+	'JAB_ENABLE'			=> 'Enable Jabber', 
+	'JAB_ENABLE_EXPLAIN'	=> 'Enables use of jabber messaging and notifications', 
+
+	'JAB_SERVER'			=> 'Jabber server', 
+	'JAB_SERVER_EXPLAIN'	=> 'See %sjabber.org%s for a list of servers', 
+	'JAB_PORT'				=> 'Jabber port', 
+	'JAB_PORT_EXPLAIN'		=> 'Leave blank unless you know it is not 5222', 
+	'JAB_USERNAME'			=> 'Jabber username', 
+	'JAB_USERNAME_EXPLAIN'	=> 'If this user is not registered it will be created if possible.', 
+	'JAB_PASSWORD'			=> 'Jabber password', 
+	'JAB_RESOURCE'			=> 'Jabber resource', 
+	'JAB_RESOURCE_EXPLAIN'	=> 'The resource locates this particular connection, e.g. board, home, etc.', 
+
+	'JAB_PASS_CHANGED'		=> 'Jabber password changed successfully', 
+	'JAB_REGISTERED'		=> 'New account registered successfully', 
+	'JAB_CHANGED'			=> 'Jabber account changed successfully', 
+
+	'ERR_JAB_USERNAME'		=> 'The username specified already exists, please choose an alternative.', 
+	'ERR_JAB_REGISTER'		=> 'An error occured trying to register this account, %s', 
+	'ERR_JAB_PASSCHG'		=> 'Could not change password', 
+	'ERR_JAB_PASSFAIL'		=> 'Password update failed, %s', 
+);
+
+// Message Settings
+$this->lang += array(
+	'MESSAGE_SETTINGS_EXPLAIN'	=> 'Here you can set all default settings for private messaging',
+		
+	'BOXES_MAX'					=> 'Max private message folders',
+	'BOXES_MAX_EXPLAIN'			=> 'By default users may create this many personal folders for private messages..',
+	'BOXES_LIMIT'				=> 'Max private messages per box',
+	'BOXES_LIMIT_EXPLAIN'		=> 'Users may receive no more than this many messages in each of their private message boxes or zero for unlimited messages.',
+	'FULL_FOLDER_ACTION'		=> 'Full folder default action',
+	'FULL_FOLDER_ACTION_EXPLAIN'=> 'Default Action to take if an users folder is full and if the users folder action set is not applicable. For the special folder "SENTBOX" the default action is always deleting old messages.',
+	'HOLD_NEW_MESSAGES'			=> 'Hold new messages',
+	'PM_EDIT_TIME'				=> 'Limit editing time',
+	'PM_EDIT_TIME_EXPLAIN'		=> 'Limits the time available to edit a private message not already delivered, zero equals infinity',
+
+	'ALLOW_MASS_PM'		=> 'Allow Mass PM\'s',
+	'ALLOW_HTML_PM'		=> 'Allow HTML in private messages',
+	'ALLOW_BBCODE_PM'	=> 'Allow BBCode in private messages',
+	'ALLOW_SMILIES_PM'	=> 'Allow smilies in private messages',
+	'ALLOW_DOWNLOAD_PM'	=> 'Allow downloading of attachments in private messages',
+	'ALLOW_SIG_PM'		=> 'Allow signatures in private messages',
+	'ALLOW_REPORT_PM'	=> 'Allow reporting of private messages',
+	'ALLOW_FORWARD_PM'	=> 'Allow forwarding of private messages',
+	'ALLOW_QUOTE_PM'	=> 'Allow quoting of private messages',
+	'ALLOW_PRINT_PM'	=> 'Allow print view in private messaging',
+	'ALLOW_EMAIL_PM'	=> 'Allow emailing private messages',
+	'ALLOW_IMG_PM'		=> 'Allow use of IMG BBCode Tag',
+	'ALLOW_FLASH_PM'	=> 'Allow use of FLASH BBCode Tag',
+	'ENABLE_PM_ICONS'	=> 'Enable use of topic icons in private messages'
+);
+
+// Cookie settings
+$this->lang += array(
+	'COOKIE_SETTINGS_EXPLAIN'	=> 'These details define the data used to send cookies to your users browsers. In most cases the default values for the cookie settings should be sufficient. If you do need to change any do so with care, incorrect settings can prevent users logging in.',
+
+	'COOKIE_DOMAIN'			=> 'Cookie domain',
+	'COOKIE_NAME'			=> 'Cookie name',
+	'COOKIE_PATH'			=> 'Cookie path',
+	'COOKIE_SECURE'			=> 'Cookie secure',
+	'COOKIE_SECURE_EXPLAIN' => 'If your server is running via SSL set this to enabled else leave as disabled',
+);
+
+// Avatar settings
+$this->lang += array(
+	'AVATAR_SETTINGS_EXPLAIN'	=> 'Avatars are generally small, unique images a user can associate with themselves. Depending on the style they are usually displayed below the username when viewing topics. Here you can determine how users can define their avatars. Please note that in order to upload avatars you need to have created the directory you name below and ensure it can be written to by the web server. Please also note that filesize limits are only imposed on uploaded avatars, they do not apply to remotely linked images.',
+	'ALLOW_LOCAL'				=> 'Enable gallery avatars',
+	'ALLOW_REMOTE'				=> 'Enable remote avatars',
+	'ALLOW_REMOTE_EXPLAIN'		=> 'Avatars linked to from another website',
+	'ALLOW_UPLOAD'				=> 'Enable avatar uploading',
+	'MAX_FILESIZE'				=> 'Maximum Avatar File Size',
+	'MAX_FILESIZE_EXPLAIN'		=> 'For uploaded avatar files',
+	'MIN_AVATAR_SIZE'			=> 'Minimum Avatar Dimensions',
+	'MIN_AVATAR_SIZE_EXPLAIN'	=> '(Height x Width in pixels)',
+	'MAX_AVATAR_SIZE'			=> 'Maximum Avatar Dimensions',
+	'MAX_AVATAR_SIZE_EXPLAIN'	=> '(Height x Width in pixels)',
+	'AVATAR_STORAGE_PATH'		=> 'Avatar Storage Path',
+	'AVATAR_STORAGE_PATH_EXPLAIN'	=> 'Path under your phpBB root dir, e.g. images/avatars/upload',
+	'AVATAR_GALLERY_PATH'			=> 'Avatar Gallery Path',
+	'AVATAR_GALLERY_PATH_EXPLAIN'	=> 'Path under your phpBB root dir for pre-loaded images, e.g. images/avatars/gallery',
+);
+
+// Server settings
+$this->lang += array(
+	'SERVER_SETTINGS_EXPLAIN'	=> 'Here you define server and domain dependant settings. Please ensure the data you enter is accurate, errors will result in emails containing incorrect information. When entering the domain name remember it does include http:// or other protocol term. Only alter the port number if you know your server uses a different value, port 80 is correct in most cases.',
+	'SERVER_NAME'				=> 'Domain Name',
+	'SERVER_NAME_EXPLAIN'		=> 'The domain name this board runs from',
+	'SCRIPT_PATH'				=> 'Script path',
+	'SCRIPT_PATH_EXPLAIN'		=> 'The path where phpBB2 is located relative to the domain name',
+	'SERVER_PORT'				=> 'Server Port',
+	'SERVER_PORT_EXPLAIN'		=> 'The port your server is running on, usually 80, only change if different',
+	'IP_VALID'					=> 'Session IP validation',
+	'IP_VALID_EXPLAIN'			=> 'Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.',
+	'ALL'						=> 'All',
+	'CLASS_C'					=> 'A.B.C',
+	'CLASS_B'					=> 'A.B', 
+	'BROWSER_VALID'				=> 'Validate browser', 
+	'BROWSER_VALID_EXPLAIN'		=> 'Enables browser validation for each session inproving security.', 
+	'ENABLE_GZIP'				=> 'Enable GZip Compression',
+	'SMILIES_PATH'				=> 'Smilies storage path',
+	'SMILIES_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/smiles',
+	'ICONS_PATH'				=> 'Post icons storage path',
+	'ICONS_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/icons',
+	'UPLOAD_ICONS_PATH'			=> 'Extension group icons storage path',
+	'UPLOAD_ICONS_PATH_EXPLAIN'	=> 'Path under your phpBB root dir, e.g. images/upload_icons',
+	'RANKS_PATH'				=> 'Rank image storage path',
+	'RANKS_PATH_EXPLAIN'		=> 'Path under your phpBB root dir, e.g. images/ranks',
+);
+
+// Load settings
+$this->lang += array(
+	'LOAD_SETTINGS_EXPLAIN'		=> 'Here you can enable and disable certain board functions to reduce the amount of processing required. On most servers there is no need to disable any functions. However on certain systems or in shared hosting environments it may be beneficial to disable capabilities you do not really need. You can also specify limits for system load and active sessions beyond which the board will go offline.', 
+	'LIMIT_LOAD'				=> 'Limit system load',
+	'LIMIT_LOAD_EXPLAIN'		=> 'If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.',
+	'LIMIT_SESSIONS'			=> 'Limit sessions',
+	'LIMIT_SESSIONS_EXPLAIN'	=> 'If the number of sessions exceeds this value within a one minute period the board will go offline. Set to 0 for unlimited sessions.',
+	'SESSION_LENGTH'			=> 'Session length', 
+	'SESSION_LENGTH_EXPLAIN'	=> 'Sessions will expire after this time, in seconds.', 
+	'YES_POST_MARKING'			=> 'Enable dotted topics', 
+	'YES_POST_MARKING_EXPLAIN'	=> 'Indicates whether user has posted to a topic.', 
+	'YES_READ_MARKING'			=> 'Enable server-side topic marking', 
+	'YES_READ_MARKING_EXPLAIN'	=> 'Stores read/unread status information in the database rather than a cookie.', 
+	'ONLINE_LENGTH'				=> 'View online time span', 
+	'ONLINE_LENGTH_EXPLAIN'		=> 'Time in minutes after which inactive users will not appear in viewonline listings, lower equals less processing.', 
+	'YES_ONLINE'				=> 'Enable online user listings', 
+	'YES_ONLINE_EXPLAIN'		=> 'Display online user information on index, forum and topic pages.', 
+	'YES_ONLINE_TRACK'			=> 'Enable display of user online img', 
+	'YES_ONLINE_TRACK_EXPLAIN'	=> 'Display online information for user in profiles and viewtopic.', 
+	'YES_BIRTHDAYS'				=> 'Enable birthday listing', 
+	'YES_MODERATORS'			=> 'Enable display of Moderators', 
+	'YES_JUMPBOX'				=> 'Enable display of Jumpbox', 
+	'YES_SEARCH'				=> 'Enable search facilities', 
+	'YES_SEARCH_EXPLAIN'		=> 'User and backend search functions including fulltext updates when posting.', 
+	'YES_SEARCH_UPDATE'			=> 'Enable fulltext updating', 
+	'YES_SEARCH_UPDATE_EXPLAIN'	=> 'Updating of fulltext indexes when posting, overriden if search is disabled.', 
+	'YES_SEARCH_PHRASE'			=> 'Enable phrase searching', 
+	'YES_SEARCH_PHRASE_EXPLAIN'	=> 'Searching for phrases requires additional processing.', 
+	'RECOMPILE_TEMPLATES'		=> 'Recompile stale templates', 
+	'RECOMPILE_TEMPLATES_EXPLAIN'=> 'Check for updated template files on filesystem and recompile.', 
+);
+
+// Email settings
+$this->lang += array(
+	'EMAIL_SETTINGS_EXPLAIN'	=> 'This information is used when the board sends emails to your users. Please ensure the email address you specify is valid, any bounced or undeliverable messages will likely be sent to that address. If your host does not provide a native (PHP based) email service you can instead send messages directly using SMTP. This requires the address of an appropriate server (ask your provider if necessary), do not specify any old name here! If the server requires authentication (and only if it does) enter the necessary username and password. Please note only basic authentication is offered, different authentication implementations are not currently supported.',
+	'ENABLE_EMAIL'				=> 'Enable board-wide emails',
+	'ENABLE_EMAIL_EXPLAIN'		=> 'If this is set to disabled no emails will be sent by the board at all.',
+	'BOARD_EMAIL_FORM'			=> 'Users send email via board',
+	'BOARD_EMAIL_FORM_EXPLAIN'	=> 'This function keeps email addresses completely private.',
+	'EMAIL_FUNCTION_NAME'		=> 'Email Function Name',
+	'EMAIL_FUNCTION_NAME_EXPLAIN' => 'The email function used to send mails through PHP.',
+	'EMAIL_PACKAGE_SIZE'		=> 'Email Package Size',
+	'EMAIL_PACKAGE_SIZE_EXPLAIN' => 'This is the number of emails sent in one package.',
+	'ADMIN_EMAIL'				=> 'Return Email Address',
+	'ADMIN_EMAIL_EXPLAIN'		=> 'This will be used as the return address on all emails.', 
+	'EMAIL_SIG'					=> 'Email Signature',
+	'EMAIL_SIG_EXPLAIN'			=> 'This text will be attached to all emails the board sends.',
+	'CONTACT_EMAIL'				=> 'Contact email address', 
+	'CONTACT_EMAIL_EXPLAIN'		=> 'This address will be used whenever a specific contact point is needed, e.g. spam, error output, etc.', 
+	'USE_SMTP'					=> 'Use SMTP Server for email',
+	'USE_SMTP_EXPLAIN'			=> 'Say yes if you want or have to send email via a named server instead of the local mail function.',
+	'SMTP_SERVER'				=> 'SMTP Server Address',
+	'SMTP_PORT'					=> 'SMTP Server Port',
+	'SMTP_PORT_EXPLAIN'			=> 'Only change this if you know your SMTP server is on a different port.',
+	'SMTP_AUTH_METHOD'			=> 'Authentication method for SMTP', 
+	'SMTP_AUTH_METHOD_EXPLAIN'	=> 'Only used if a username/password is set, ask your provider if you are unsure which method to use.', 
+	'SMTP_LOGIN'				=> 'LOGIN', 
+	'SMTP_PLAIN'				=> 'PLAIN', 
+	'SMTP_CRAM_MD5'				=> 'CRAM-MD5',
+	'SMTP_DIGEST_MD5'			=> 'DIGEST-MD5',
+	'SMTP_POP_BEFORE_SMTP'		=> 'POP-BEFORE-SMTP',
+	'SMTP_USERNAME'				=> 'SMTP Username',
+	'SMTP_USERNAME_EXPLAIN'		=> 'Only enter a username if your smtp server requires it.',
+	'SMTP_PASSWORD'				=> 'SMTP Password',
+	'SMTP_PASSWORD_EXPLAIN'		=> 'Only enter a password if your smtp server requires it.',
+);
+
+// Board settings
+$this->lang += array(
+	'BOARD_SETTINGS_EXPLAIN'	=> 'Here you can determine the basic operation of your board, from the site name through user registration to private messaging.',
+	'SITE_NAME'					=> 'Site name',
+	'SITE_DESC'					=> 'Site description',
+	'DISABLE_BOARD'				=> 'Disable board',
+	'DISABLE_BOARD_EXPLAIN'		=> 'This will make the board unavailable to users. You can also enter a short (255 character) message to display if you wish.',
+	'ACC_ACTIVATION'			=> 'Account activation',
+	'ACC_ACTIVATION_EXPLAIN'	=> 'This determines whether users have immediate access to the board or if confirmation is required. You can also completely disable new registrations.',
+	'ACC_NONE'					=> 'None',
+	'ACC_USER'					=> 'User',
+	'ACC_ADMIN'					=> 'Admin',
+	'ACC_USER_ADMIN'			=> 'User + Admin',
+	'ACC_DISABLE'				=> 'Disable',
+	'VISUAL_CONFIRM'			=> 'Enable visual confirmation',
+	'VISUAL_CONFIRM_EXPLAIN'	=> 'Requires new users enter a random code matching an image to help prevent mass registrations.',
+	'REG_LIMIT'					=> 'Registration attempts', 
+	'REG_LIMIT_EXPLAIN'			=> 'Number of attempts users can make at the confirmation code before being locked out that session.', 
+	'FORCE_PASS_CHANGE'			=> 'Force password change', 
+	'FORCE_PASS_CHANGE_EXPLAIN'	=> 'Require user to change their password after a set number of days or zero to disable.', 
+	'CHAR_LIMIT'				=> 'Max characters per post',
+	'CHAR_LIMIT_EXPLAIN'		=> 'Set to 0 for unlimited characters.',
+	'SMILIES_LIMIT'				=> 'Max smilies per post',
+	'SMILIES_LIMIT_EXPLAIN'		=> 'Set to 0 for unlimited smilies.',
+	'QUOTE_DEPTH_LIMIT'			=> 'Max nested quotes per post',
+	'QUOTE_DEPTH_LIMIT_EXPLAIN'	=> 'Set to 0 for unlimited depth.',
+	'USERNAME_LENGTH'			=> 'Username length', 
+	'USERNAME_LENGTH_EXPLAIN'	=> 'Minimum and maximum number of characters in usernames.', 
+	'USERNAME_CHARS'			=> 'Limit username chars', 
+	'USERNAME_CHARS_EXPLAIN'	=> 'Restrict type of characters that may be used in usernames, spacers are; space, -, +, _, [ and ]', 
+	'PASSWORD_LENGTH'			=> 'Password length', 
+	'PASSWORD_LENGTH_EXPLAIN'	=> 'Minimum and maximum number of characters in passwords.', 
+	'PASSWORD_TYPE'				=> 'Password complexity',
+	'PASSWORD_TYPE_EXPLAIN'		=> 'Determines how complex a password needs to be when set or altered, subsequent options include the previous ones.', 
+	'PASS_TYPE_ANY'				=> 'No requirements', 
+	'PASS_TYPE_CASE'			=> 'Must be mixed case', 
+	'PASS_TYPE_ALPHA'			=> 'Must contain alphanumerics', 
+	'PASS_TYPE_SYMBOL'			=> 'Must contain symbols', 
+	'MIN_CHARS'					=> 'Min', 
+	'MAX_CHARS'					=> 'Max', 
+	'ALLOW_EMAIL_REUSE'			=> 'Allow Email address re-use',
+	'ALLOW_EMAIL_REUSE_EXPLAIN'	=> 'Different users can register with the same email address.',
+	'USERNAME_CHARS_ANY'		=> 'Any character', 
+	'USERNAME_ALPHA_ONLY'		=> 'Alphanumeric only', 
+	'USERNAME_ALPHA_SPACERS'	=> 'Alphanumeric and spacers',
+	'ALLOW_NAME_CHANGE'			=> 'Allow Username changes',
+	'ENABLE_COPPA'				=> 'Enable COPPA',
+	'ENABLE_COPPA_EXPLAIN'		=> 'This requires users to declare whether they are 13 or over for compliance with the U.S. COPPA act.',
+	'COPPA_FAX'					=> 'COPPA Fax Number',
+	'COPPA_MAIL'				=> 'COPPA Mailing Address',
+	'COPPA_MAIL_EXPLAIN'		=> 'This is the mailing address where parents will send COPPA registration forms',
+	'BOARD_PM'					=> 'Private Messaging', 
+	'BOARD_PM_EXPLAIN'			=> 'Enable or disable private messaging for all users.', 
+	'EDIT_TIME'					=> 'Limit editing time',
+	'EDIT_TIME_EXPLAIN'			=> 'Limits the time available to edit a new post, zero equals infinity',
+	'DISPLAY_LAST_EDITED'		=> 'Display last edited time information',
+	'DISPLAY_LAST_EDITED_EXPLAIN' => 'Choose if the last edited by information to be displayed on posts',
+	'FLOOD_INTERVAL'			=> 'Flood Interval',
+	'FLOOD_INTERVAL_EXPLAIN'	=> 'Number of seconds a user must wait between posting new messages. To enable users to ignore this alter their permissions.',
+	'BUMP_INTERVAL'				=> 'Bump Interval',
+	'BUMP_INTERVAL_EXPLAIN'		=> 'Number of minutes, hours or days between the last post to a topic and the ability to bump this topic.',
+	'SEARCH_INTERVAL'			=> 'Search Flood Interval',
+	'SEARCH_INTERVAL_EXPLAIN'	=> 'Number of seconds users must wait between searches.',
+	'MIN_SEARCH_CHARS'			=> 'Min characters indexed by search',
+	'MIN_SEARCH_CHARS_EXPLAIN'	=> 'Words with at least this many characters will be indexed for searching.',
+	'MAX_SEARCH_CHARS'			=> 'Max characters indexed by search',
+	'MAX_SEARCH_CHARS_EXPLAIN'	=> 'Words with no more than this many characters will be indexed for searching.',
+	'TOPICS_PER_PAGE'			=> 'Topics Per Page',
+	'POSTS_PER_PAGE'			=> 'Posts Per Page',
+	'HOT_THRESHOLD'				=> 'Posts for Popular Threshold',
+	'MAX_POLL_OPTIONS'			=> 'Max number of poll options',
+);
+
+// Auth settings
+$this->lang += array(
+	'AUTH_SETTINGS_EXPLAIN'	=> 'phpBB2 supports authentication plug-ins, or modules. These allow you determine how users are authenticated when they log into the board. By default three plug-ins are provided; DB, LDAP and Apache. Not all methods require additional information so only fill out fields if they are relevant to the selected method.',
+	'AUTH_METHOD'			=> 'Select an authentication method',
+	'LDAP_SERVER'			=> 'LDAP server name',
+	'LDAP_SERVER_EXPLAIN'	=> 'If using LDAP this is the name or IP address of the server.',
+	'LDAP_DN'				=> 'LDAP base dn',
+	'LDAP_DN_EXPLAIN'		=> 'This is the Distinguished Name, locating the user information, e.g. o=My Company,c=US',
+	'LDAP_UID'				=> 'LDAP uid',
+	'LDAP_UID_EXPLAIN'		=> 'This is the key under which to search for a given login identity, e.g. uid, sn, etc.',
+);
+
+// Board defaults
+$this->lang += array(
+	'BOARD_DEFAULTS_EXPLAIN'	=> 'These settings allow you to define a number of default or global settings used by the board. For example, to disable the use of HTML across the entire board alter the relevant setting below. This data is also used for new user registrations and (where relevant) guest users. Please note that registered users can override some of these options with their own settings.',
+	'DEFAULT_STYLE'				=> 'Default Style',
+	'OVERRIDE_STYLE'			=> 'Override user style',
+	'OVERRIDE_STYLE_EXPLAIN'	=> 'Replaces users style with the default.',
+	'DEFAULT_LANGUAGE'			=> 'Default Language',
+	'DEFAULT_DATE_FORMAT'		=> 'Date Format',
+	'DEFAULT_DATE_FORMAT_EXPLAIN'=> 'The date format is the same as the PHP date function.',
+	'SYSTEM_TIMEZONE'			=> 'System Timezone',
+	'SYSTEM_DST'				=> 'Enable Daylight Savings Time',
+	'ALLOW_TOPIC_NOTIFY'		=> 'Allow Topic Watching',
+	'ALLOW_FORUM_NOTIFY'		=> 'Allow Forum Watching',
+	'ALLOW_NAME_CHANGE'			=> 'Allow Username changes',
+
+	'MIN_RATINGS'				=> 'Ratings count before karma',
+	'MIN_RATINGS_EXPLAIN'		=> 'Number of distinct ratings before users karma is calculated.',
+	'ALLOW_ATTACHMENTS'			=> 'Allow Attachments',
+	'ALLOW_PM_ATTACHMENTS'		=> 'Allow Attachments in Private Messages',
+	'ALLOW_HTML'				=> 'Allow HTML',
+	'ALLOWED_TAGS'				=> 'Allowed HTML tags',
+	'ALLOWED_TAGS_EXPLAIN'		=> 'Separate tags with commas.',
+	'ALLOW_BBCODE'				=> 'Allow BBCode',
+	'ALLOW_SMILIES'				=> 'Allow Smilies',
+	'ALLOW_SIG'					=> 'Allow Signatures',
+	'MAX_SIG_LENGTH'			=> 'Maximum signature length',
+	'MAX_SIG_LENGTH_EXPLAIN'	=> 'Maximum number of characters in user signatures.',
+	'ALLOW_NO_CENSORS'			=> 'Allow Disable of Censors',
+	'ALLOW_NO_CENSORS_EXPLAIN'	=> 'User can disable word censoring.',
+	'ALLOW_BOOKMARKS'			=> 'Allow bookmarking topics',
+	'ALLOW_BOOKMARKS_EXPLAIN'	=> 'User is able to store personal bookmarks'
+);
+
+// Karma settings
+$this->lang += array(
+	'KARMA_SETTINGS'		=> 'Karma Settings', 
+	'KARMA_SETTINGS_EXPLAIN'=> 'Here you can enable and disable the user Karma rating system. You can also modify the weighting factors used to derive each users karma.', 
+	'ENABLE_KARMA'			=> 'Enable Karma',
+
+	'KARMA_HIST_WEIGHT'			=> 'Historical ratings weighting', 
+	'KARMA_HIST_WEIGHT_EXPLAIN'	=> 'Ratings made before the previous 30 days', 
+	'KARMA_DAY_WEIGHT'			=> 'Recent ratings weighting', 
+	'KARMA_DAY_WEIGHT_EXPLAIN'	=> 'Ratings made in past 30 days', 
+	'KARMA_REG_WEIGHT'			=> 'Membership length weighting', 
+	'KARMA_REG_WEIGHT_EXPLAIN'	=> 'Total length of membership', 
+	'KARMA_POST_WEIGHT'			=> 'Total posts weighting', 
+);
+
+// Avatars
+$this->lang += array(
+	'AVATARS_GALLERY'	=> 'Avatar Gallery', 
+);
+
+// PHP info
+$this->lang += array(
+	'PHP_INFO_EXPLAIN'	=> 'This page lists information on the version of PHP installed on this server. It includes details of loaded modules, available variables and default settings. This information may be useful when diagnosing problems. Please be aware that some hosting companies will limit what information is displayed here for security reasons. You are advised to not give out any details on this page except when asked by support or other Team Member on the support forums.', 
+);
+
+// Forum admin
+$this->lang += array(
+	'FORUM_ADMIN'			=> 'Forum Administration',
+	'FORUM_ADMIN_EXPLAIN'	=> 'In phpBB 2.2 there are no categories, everything is forum based. Each forum can have an unlimited number of sub-forums and you can determine whether each may be posted to or not (i.e. whether it acts like an old category). Here you can add, edit, delete, lock, unlock individual forums as well as set certain additional controls. If your posts and topics have got out of sync you can also resynchronise a forum.',
+	'FORUM_EDIT_EXPLAIN'	=> 'The form below will allow you to customise this forum. Please note that moderation and post count controls are set via forum permissions for each user or usergroup.',
+	'FORUM_DELETE'			=> 'Delete Forum',
+	'FORUM_DELETE_EXPLAIN'	=> 'The form below will allow you to delete a forum and decide where you want to put all topics (or forums) it contained.', 
+
+	'EDIT_FORUM'	=> 'Edit forum',
+	'CREATE_FORUM'	=> 'Create new forum',
+	'REMOVE'		=> 'Remove',
+	'EDIT'			=> 'Edit',
+	'MOVE_UP'		=> 'Move up',
+	'MOVE_DOWN'		=> 'Move down',
+	'RESYNC'		=> 'Sync',
+	'UPDATE'		=> 'Update',
+
+	'FORUM_SETTINGS'	=> 'Forum Settings', 
+	'FORUM_GENERAL'		=> 'General Forum Settings',
+	'FORUM_TYPE'		=> 'Forum Type', 
+	'TYPE_FORUM'		=> 'Forum', 
+	'TYPE_CAT'			=> 'Category', 
+	'TYPE_LINK'			=> 'Link', 
+	'FORUM_NAME'		=> 'Forum Name',
+	'FORUM_DESC'		=> 'Description', 
+	'FORUM_DESC_EXPLAIN'=> 'Any markup entered here will displayed as is.', 
+	'FORUM_LINK'		=> 'Forum Link',
+	'FORUM_LINK_EXPLAIN'=> 'Full URL to location clicking this forum will take the user.',
+	'FORUM_LINK_TRACK'	=> 'Track Link Redirects', 
+	'FORUM_LINK_TRACK_EXPLAIN'	=> 'Records the number of times a forum link was clicked.', 
+	'FORUM_STATUS'		=> 'Forum Status',
+	'FORUM_STYLE'		=> 'Forum Style', 
+	'FORUM_IMAGE'		=> 'Forum Image', 
+	'FORUM_IMAGE_EXPLAIN'=> 'Location, relative to the phpBB root directory, of an image to associate with this forum.',
+	'FORUM_PARENT'		=> 'Parent Forum',
+
+	'FORUM_RULES'			=> 'Forum Rules',
+	'FORUM_RULES_EXPLAIN'	=> 'Forum Rules are displayed at any page within the given forum.',
+	'FORUM_RULES_LINK'		=> 'Link to Forum Rules',
+	'FORUM_RULES_LINK_EXPLAIN'=> 'You are able to enter the URL of the page/post containing your forum rules here. This setting will override the Forum Rules text you specified.',
+	'FORUM_RULES_PREVIEW'	=> 'Forum Rules preview',
+	'PARSE_BBCODE'			=> 'Parse BBCode',
+	'PARSE_SMILIES'			=> 'Parse Smilies',
+	'PARSE_URLS'			=> 'Parse Links',
+
+	'NO_PARENT'			=> 'No Parent',
+	'LINK'				=> 'Link',
+	'LOCKED'			=> 'Locked',
+	'UNLOCKED'			=> 'Unlocked', 
+	'ENABLE_NEWS'		=> 'Set as news forum', 
+	'ENABLE_NEWS_EXPLAIN' => 'If set to yes posts in this forum will be displayed as news items.',
+	'ENABLE_RECENT'		=> 'Display active topics', 
+	'ENABLE_RECENT_EXPLAIN' => 'If set to yes topics made to this forum will be shown in the active topics list.', 
+	'DISPLAY_ACTIVE_TOPICS'			=> 'Enable active topics', 
+	'DISPLAY_ACTIVE_TOPICS_EXPLAIN'	=> 'If set to yes active topics in selected subforums will be displayed under this category.', 
+	'ENABLE_INDEXING'	=> 'Enable search indexing', 
+	'ENABLE_INDEXING_EXPLAIN'	=> 'If set to yes posts made to this forum will be indexed for searching.', 
+	'ENABLE_TOPIC_ICONS'=> 'Enable Topic Icons', 
+	'LIST_INDEX'		=> 'List Forum On Index',
+	'LIST_INDEX_EXPLAIN'=> 'Displays a link to this forum under the root parent forum on the index.',
+	'FORUM_AUTO_PRUNE'			=> 'Enable Auto-Pruning',
+	'FORUM_AUTO_PRUNE_EXPLAIN'	=> 'Prunes the forum of topics, set the frequency/age parameters below.',
+	'AUTO_PRUNE_FREQ'			=> 'Auto-prune Frequency',
+	'AUTO_PRUNE_FREQ_EXPLAIN'	=> 'Time in days between pruning events.',
+	'AUTO_PRUNE_DAYS'			=> 'Auto-prune Post Age',
+	'AUTO_PRUNE_DAYS_EXPLAIN'	=> 'Number of days since last post after which topic is removed.', 
+	'AUTO_PRUNE_VIEWED'			=> 'Auto-prune Post Viewed Age',
+	'AUTO_PRUNE_VIEWED_EXPLAIN'	=> 'Number of days since topic was viewed after which topic is removed.',
+	'PRUNE_OLD_POLLS'			=> 'Prune Old Polls',
+	'PRUNE_OLD_POLLS_EXPLAIN'	=> 'Removes topics with polls not voted in for post age days.',
+	'PRUNE_FINISHED_POLLS'		=> 'Prune Closed Polls',
+	'PRUNE_FINISHED_POLLS_EXPLAIN'=> 'Removes topics with polls which have ended.',
+	'PRUNE_ANNOUNCEMENTS'		=> 'Prune Announcements',
+	'PRUNE_STICKY'				=> 'Prune Stickies',
+	'FORUM_TOPICS_PAGE'			=> 'Topics Per Page', 
+	'FORUM_TOPICS_PAGE_EXPLAIN'	=> 'If non-zero this value will override the default topics per page setting.', 
+	'ACTIVE_TOPICS_PAGE'			=> 'Number of active topics', 
+	'ACTIVE_TOPICS_PAGE_EXPLAIN'	=> 'If non-zero this value will override the default topics per page setting.', 
+	'FORUM_PASSWORD'			=> 'Forum Password', 
+	'FORUM_PASSWORD_EXPLAIN'	=> 'Defines a password for this forum, use the permission system in preference.', 
+	'FORUM_PASSWORD_CONFIRM'	=> 'Confirm Forum Password', 
+	'FORUM_PASSWORD_CONFIRM_EXPLAIN'	=> 'Only needs to be set if a forum password is entered.', 
+
+	'MOVE_POSTS_TO'		=> 'Move posts',
+	'MOVE_SUBFORUMS_TO' => 'Move subforums',
+	'DELETE_ALL_POSTS'	=> 'Delete posts',
+	'DELETE_SUBFORUMS'	=> 'Delete subforums and posts',
+
+	'NO_DESTINATION_FORUM'		=> 'You have not specified a forum to move content to',
+	'FORUM_PASSWORD_MISMATCH'	=> 'The passwords you entered did not match.',
+	'FORUM_NAME_EMPTY'			=> 'You must enter a name for this forum.', 
+	'FORUM_DATA_NEGATIVE'		=> 'Pruning parameters cannot be negative.', 
+	'FORUM_CREATED'				=> 'Forum created successfully.',
+	'FORUM_UPDATED'				=> 'Forum informations updated successfully.', 
+	'REDIRECT_ACL'				=> 'To set permissions for this forum click %sHERE%s.', 
+	'FORUM_DELETED'				=> 'Forum successfully deleted',
+	'FORUM_RESYNCED'			=> 'Forum successfully resynced',
+);
+
+// Smiley and topic icons
+$this->lang += array(
+	'ICONS_EXPLAIN'	=> 'From this page you can add, remove and edit the icons users may add to their topics or posts. These icons are generally displayed next to topic titles on the forum listing, or the post subjects in topic listings. You can also install and create new packages of icons.',
+	'SMILE_EXPLAIN' => 'Smilies or emoticons are typically small, sometimes animated images used to convey an emotion or feeling. From this page you can add, remove and edit the emoticons users can use in their posts and private messages. You can also install and create new packages of smilies.',
+	'IMPORT_SMILE'	=> 'Install smilies pak',
+	'EXPORT_SMILE'	=> 'Create smilies pak',
+	'IMPORT_ICONS'	=> 'Install icons pak',
+	'EXPORT_ICONS'	=> 'Create icons pak',
+	'MASS_ADD_SMILE'=> 'Add multiple smilies',
+	'ADD_SMILE'		=> 'Add single smilie',
+	'ADD_ICONS'		=> 'Add single icon',
+	'ADD_ICONS'		=> 'Add multiple icons',
+	'EDIT_SMILE'	=> 'Edit smilies',
+	'EDIT_ICONS'	=> 'Edit Icons',
+	'SMILE_NOT_DISPLAYED' => 'The following smilies are not displayed on the posting page',
+	'ICONS_NOT_DISPLAYED' => 'The following icons are not displayed on the posting page',
+	'EMOTION'		=> 'Emotion',
+	'REORDER'		=> 'Reorder',
+	'DISPLAY'		=> 'Display',
+	'DIMENSIONS'	=> 'Dimensions',
+	'FIRST'			=> 'First',
+	'AFTER_SMILE'	=> 'After %s',
+	'AFTER_ICONS'	=> 'After %s',
+	'SMILE_CONFIG'	=> 'Smilie configuration',
+	'SMILE_IMAGE'	=> 'Smilie image', 
+	'SMILE_CODE'	=> 'Smilie code',
+	'SMILE_URL'		=> 'Smilie image file',
+	'SMILE_ORDER'	=> 'Smilie order',
+	'SMILE_EMOTION' => 'Emotion',
+	'SMILE_ADD'		=> 'Add a new Smilie',
+	'SMILE_EDIT'	=> 'Edit Smilie',
+	'SMILE_LOCATION'=> 'Smilie location',
+	'ICONS_CONFIG'	=> 'Icon configuration',
+	'ICONS_IMAGE'	=> 'Icon image', 
+	'ICONS_ORDER'	=> 'Icon order',
+	'ICONS_LOCATION'=> 'Icon location',
+	'ICONS_ADD'		=> 'Add a new Icon',
+	'ICONS_EDIT'	=> 'Edit Icon',
+	'EXPORT_SMILE_EXPLAIN' => 'To create a package of your currently installed smilies, click %sHERE%s to download the emoticons.pak file. Once downloaded create a zip or tgz file containing all of your smilies plus this .pak configuration file.',
+	'EXPORT_ICONS_EXPLAIN' => 'To create a package of your currently installed icons, click %sHERE%s to download the icons package file. Once downloaded create a zip or tgz file containing all of your icons plus this .pak configuration file.',
+	'NO_SMILE_EXPORT'	=> 'You have no smilies with which to create a package.', 
+	'NO_ICONS_EXPORT'	=> 'You have no icons with which to create a package.', 
+	'WRONG_PAK_TYPE'	=> 'The specified package does not contain the appropriate data.', 
+	'SELECT_PACKAGE'	=> 'Select a package file',
+	'DELETE_ALL'		=> 'Delete all',
+	'KEEP_ALL'			=> 'Keep all',
+	'REPLACE_MATCHES'	=> 'Replace matches',
+	'NO_SMILE_PAK'		=> 'No smilie packages found.',
+	'CURRENT_SMILE'		=> 'Current smilies',
+	'SMILE_IMPORT_SUCCESS' => 'The smilies pack was imported successfully',
+	'NO_ICONS_PAK' => 'No icon packages found.',
+	'CURRENT_ICONS' => 'Current icons',
+	'ICONS_IMPORT_SUCCESS' => 'The icons pack was imported successfully',
+	'SMILE_DELETED' => 'The smilie has been removed successfully.',
+	'SMILE_EDITED' => 'The smilie has been updated successfully.',
+	'SMILE_ADDED' => 'The smilie has been added successfully.',
+	'SMILE_IMPORTED' => 'The smilies pack has been installed successfully.',
+	'ICONS_DELETED' => 'The icon has been removed successfully.',
+	'ICONS_EDITED' => 'The icon has been updated successfully.',
+	'ICONS_ADDED' => 'The icon has been added successfully.',
+	'ICONS_IMPORTED' => 'The icons pack has been installed successfully.',
+);
+
+// Custom bbcodes
+$this->lang += array(
+	'BBCODES'						=>	'BBCodes',
+	'BBCODES_EXPLAIN'			=>	'BBCode is a special implementation of HTML offering greater control over what and how something is displayed. Additionnally, you can save users from typing sometimes very long HTML code by providing them a single BBCode as replacement. From this page you can add, remove and edit custom BBCodes',
+
+	'TOO_MANY_BBCODES'		=>	'You cannot create any more BBCodes. Please remove one or more BBCodes then try again',
+	'BBCODE_NOT_EXIST'		=>	'The BBCode you selected does not exist',
+	'BBCODE_ADDED'				=>	'BBCode added successfully',
+	'BBCODE_EDITED'				=>	'BBCode edited successfully',
+
+	'BBCODE_TAG'					=>	'Tag',
+	'ADD_BBCODE'					=>	'Add a new BBCode',
+
+	// Note to translators: you can translate everything but what's between { and }
+	'BBCODE_USAGE'							=>	'BBCode usage',
+	'BBCODE_USAGE_EXPLAIN'			=>	'Here you define how to use the bbcode. Replace any variable input by the corresponding token (see below)',
+	'BBCODE_USAGE_EXAMPLE'			=>	'[colour={COLOR}]{TEXT}[/colour]<br /><br />[font={TEXT1}]{TEXT2}[/font]',
+	'HTML_REPLACEMENT'					=>	'HTML replacement',
+	'HTML_REPLACEMENT_EXPLAIN'		=>	'Here you define the default HTML replacement (each template can have its own HTML replacement). Do not forget to put back tokens you used above!',
+	'HTML_REPLACEMENT_EXAMPLE'	=>	'&lt;font color="{COLOR}"&gt;{TEXT}&lt;/font&gt;<br /><br />&lt;font face="{TEXT1}"&gt;{TEXT2}&lt;/font&gt;',
+	'TOKENS'										=>	'Tokens',
+	'TOKENS_EXPLAIN'						=>	'Tokens are placeholders for user input. The input will be validated only if it matches the corresponding definition. If needed, you can number them by adding a number as the last character between the braces, e.g. {USERNAME1}, {USERNAME2}.<br /><br />In addition to these tokens you can use any of lang string present in your language/ directory like this: {L_<i>&lt;stringname&gt;</i>} where <i>&lt;stringname&gt;</i> is the name of the translated string you want to add. For example, {L_WROTE} will be displayed as "wrote" or its translation according to user\'s locale',
+
+	'EXAMPLE'										=>	'Example:',
+	'EXAMPLES'									=>	'Examples:',
+
+	'TOKEN'							=>	'Token',
+	'TOKEN_DEFINITION'	 	=>	'What can it be?',
+
+	'tokens'	=>	array(
+		'TEXT'			=>	'Any text, including foreign characters, numbers, etc...',
+		'NUMBER'		=>	'Any serie of digits',
+		'EMAIL'			=>	'A valid email address',
+		'URL'				=>	'A valid URL using any protocol (http, ftp, etc... cannot be used for javascript exploits). If none is given, "http://" is prepended to to the string',
+		'LOCAL_URL'	=>	'A local URL. The URL must be relative to the topic page and cannot contain a server name or protocol',
+		'COLOR'		=>	'A HTML color, can be either in the numeric form #FF1234 or an english name such as "blue"'
+	)
+);
+
+// User admin
+$this->lang += array(
+	'USER_ADMIN'			=> 'User Administration',
+	'USER_ADMIN_EXPLAIN'	=> 'Here you can change your users information and certain specific options. To modify the users permissions please use the user and group permissions system.',
+	'SELECT_USER'			=> 'Select User', 
+
+	'SELECT_FORM'			=> 'Select form', 
+	'USER_ADMIN_OVERVIEW'	=> 'Overview',
+	'USER_ADMIN_FEEDBACK'	=> 'Feedback', 
+	'USER_ADMIN_PROFILE'	=> 'Profile', 
+	'USER_ADMIN_PREFS'		=> 'Preferences', 
+	'USER_ADMIN_AVATAR'		=> 'Avatar', 
+	'USER_ADMIN_SIG'		=> 'Signature', 
+	'USER_ADMIN_GROUP'		=> 'Groups', 
+	'USER_ADMIN_PERM'		=> 'Permissions', 
+	'USER_ADMIN_ATTACH'		=> 'Attachments',
+
+	'FOUNDER'				=> 'Founder', 
+	'FOUNDER_EXPLAIN'		=> 'Founders can never be banned, deleted or altered by non-founder members', 
+	'USER_INFO'				=> 'Basic information', 
+	'REGISTERED'			=> 'Registered', 
+	'REGISTERED_IP'			=> 'Registered from IP', 
+	'LAST_ACTIVE'			=> 'Last active', 
+	'WARNINGS'				=> 'Warnings', 
+	'WARNINGS_EXPLAIN'		=> 'You can directly alter the warnings this users has received.', 
+	'USER_TOOLS'			=> 'Basic tools', 
+	'QUICK_TOOLS'			=> 'Quick tools', 
+	'DELETE_USER'			=> 'Delete users', 
+	'DELETE_USER_EXPLAIN'	=> 'Please note that deleting a user is final, they cannot be recovered', 
+	'RETAIN_POSTS'			=> 'Retain posts', 
+	'DELETE_POSTS'			=> 'Delete posts', 
+	'USER_ADMIN_BAN_USER'	=> 'Ban by username', 
+	'USER_ADMIN_BAN_EMAIL'	=> 'Ban by email', 
+	'USER_ADMIN_BAN_IP'		=> 'Ban by IP', 
+	'USER_ADMIN_FORCE'		=> 'Force re-activation', 
+	'USER_ADMIN_DEACTIVATE'	=> 'Deactivate account', 
+	'USER_ADMIN_ACTIVATE'	=> 'Activate account', 
+	'USER_ADMIN_MOVE_POSTS'	=> 'Move all posts', 
+	'MOVE_POSTS_EXPLAIN'	=> 'Please select the forum to which you wish to move all the posts this user has made.', 
+
+	'USER_POSTING_PREFS'	=> 'Posting preferences', 
+
+	'ADMIN_SIGNATURE_PREVIEW'	=> 'Users signature will appear like this', 
+
+	'USER_ADMIN_BAN_NAME_REASON'	=> 'Username banned via user management', 
+	'USER_ADMIN_BAN_IP_REASON'		=> 'IP banned via user management', 
+	'USER_ADMIN_BAN_EMAIL_REASON'	=> 'Email address banned via user management', 
+
+	'USER_DELETED'			=> 'User deleted successfully',
+	'USER_OVERVIEW_UPDATED'	=> 'User details updated', 
+	'USER_PROFILE_UPDATED'	=> 'User profile updated', 
+	'USER_PREFS_UPDATED'	=> 'User preferences updated', 
+	'USER_ADMIN_INACTIVE'	=> 'User deactivated successfully', 
+	'USER_ADMIN_ACTIVE'		=> 'User activated successfully', 
+);
+
+// Group admin
+$this->lang += array(
+	'GROUP_MANAGE_EXPLAIN' => 'From this panel you can administer all your usergroups, you can; delete, create and edit existing groups. You may choose moderators, toggle open/closed group status and set the group name and description.',
+
+	'USER_DEF_GROUPS'			=> 'User defined groups', 
+	'USER_DEF_GROUPS_EXPLAIN'	=> 'These are groups created by you or another admin on this board. You can manage memberships as well as edit group properties or even delete the group. By clicking "Default" you can set the relevant group to the default for all its members.', 
+	'SPECIAL_GROUPS'			=> 'Predefined groups',
+	'SPECIAL_GROUPS_EXPLAIN'	=> 'Pre-defined groups are special groups, they cannot be deleted or directly modified. However you can still add users and alter basic settings. By clicking "Default" you can set the relevant group to the default for all its members.',
+	'TOTAL_MEMBERS'			=> 'Members', 
+	'GROUP_DEFS_UPDATED'	=> 'Default group set for all members', 
+	'CREATE_GROUP'			=> 'Create new group', 
+
+	'GROUP_LIST'			=> 'Current members', 
+	'GROUP_LIST_EXPLAIN'	=> 'This is a complete list of all the current users with membership of this group. You can delete members (except in certain special groups) or add new ones as you see fit.', 
+	'GROUP_MEMBERS'			=> 'Group members', 
+	'GROUP_MEMBERS_EXPLAIN' => 'This is a complete listing of all the members of this usergroup. It includes seperate sections for leaders, pending and existing members. From here you can manage all aspects of who has membership of this group and what their role is. To remove a leader but keep them in the group use Demote rather than delete. Similarly use Promote to make an existing member a leader.', 
+	'GROUP_LEAD'			=> 'Group leaders', 
+	'GROUP_APPROVED'		=> 'Approved Members', 
+	'GROUP_PENDING'			=> 'Pending Members', 
+	'GROUPS_NO_MEMBERS'		=> 'This group has no members', 
+	'GROUPS_NO_MODS'		=> 'No group leaders defined', 
+	'SELECT_OPTION'	=> 'Select option', 
+	'GROUP_DEFAULT'	=> 'Default',
+	'GROUP_APPROVE'	=> 'Approve',
+	'GROUP_PROMOTE'	=> 'Promote',
+	'GROUP_DEMOTE'	=> 'Demote', 
+	'GROUP_DELETE'	=> 'Delete', 
+
+	'ADD_USERS_EXPLAIN'				=> 'Here you can add new users to the group. You may select whether this group becomes the new default for the selected users. Additionally you can define them as group leaders. Please enter each username on a seperate line.', 
+	'USER_DEFAULT'			=> 'User default', 
+	'USER_GROUP_DEFAULT'	=> 'Set as default group', 
+	'USER_GROUP_DEFAULT_EXPLAIN'	=> 'Saying yes here will set this group as the default group for the added users', 
+	'USER_GROUP_LEADER'		=> 'Set as group leader', 
+	'GROUP_USERS_EXIST'		=> 'The selected users are already members.',
+	'GROUP_USERS_ADDED'		=> 'New users added to group successfully.', 
+	'GROUP_MODS_ADDED'		=> 'New group moderators added successfully.', 
+	'USERS_APPROVED'		=> 'Users approved successfully.', 
+
+	'GROUP_EDIT_EXPLAIN'	=> 'Here you can edit an existing group. You can change its name, description and type (open, closed, etc.). You can also set certain groupwide options such as colouration, rank, etc. Changes made here override users current settings. Please note that group members can alter their avatar unless you set appropriate user permissions.', 
+	'GROUP_DETAILS'			=> 'Group details', 
+	'GROUP_NAME'			=> 'Group name',
+	'GROUP_DESC'			=> 'Group description',
+	'GROUP_TYPE'			=> 'Group type', 
+	'GROUP_TYPE_EXPLAIN'	=> 'This determines which users can join or view this group.', 
+	'GROUP_OPEN'			=> 'Open',
+	'GROUP_REQUEST'			=> 'Request',
+	'GROUP_CLOSED'			=> 'Closed',
+	'GROUP_HIDDEN'			=> 'Hidden',
+	'GROUP_COLOR'			=> 'Group colour', 
+	'GROUP_COLOR_EXPLAIN'	=> 'Defines the colour members usernames will appear in, leave blank for user default.', 
+	'FORCE_COLOR'			=> 'Force update', 
+	'GROUP_RANK'			=> 'Group rank', 
+	'GROUP_AVATAR'			=> 'Group avatar', 
+	'GROUP_AVATAR_EXPLAIN'	=> 'This image will be displayed in the Group Control Panel.', 
+	'GROUP_UPDATED'			=> 'Group preferences updated successfully.', 
+	'GROUP_CREATED'			=> 'Group has been created successfully', 
+
+	'GROUP_SETTINGS_SAVE'		=> 'Groupwide settings', 
+	'GROUP_SETTINGS'			=> 'Set user preferences', 
+	'GROUP_SETTINGS_EXPLAIN'	=> 'Here you can force changes in users current preferences. Please note these settings are not saved for the group itself. They are intended as a quick method of altering the preferences of all users in this group.', 
+	'GROUP_LANG'				=> 'Group language', 
+	'GROUP_TIMEZONE'			=> 'Group timezone', 
+	'GROUP_DST'					=> 'Group daylight savings', 
+
+	'GROUP_MODS_DEMOTED'		=> 'Group leaders demoted successfully', 
+	'GROUP_MODS_PROMOTED'		=> 'Group members promoted successfully', 
+	'GROUP_USERS_REMOVE'		=> 'Users removed from group and new defaults set successfully', 
+	'GROUP_DELETED'				=> 'Group deleted and user default groups set successfully', 
+
+	'GROUP_ERR_USERNAME'	=> 'No group name specified.',
+	'GROUP_ERR_USER_LONG'	=> 'Group name too long.',
+	'GROUP_ERR_DESC_LONG'	=> 'Group description too long.',
+	'GROUP_ERR_TYPE'		=> 'Inappropriate group type specified.', 
+	'GROUP_ERR_USERS_EXIST' => 'The specified users are already members of this group', 
+);
+
+// Forum Pruning
+$this->lang += array(
+	'FORUM_PRUNE_EXPLAIN' => 'This will delete any topic which has not been posted to within the number of days you select. If you do not enter a number then all topics will be deleted. It will not remove topics in which polls are still running nor will it remove announcements. You will need to remove these topics manually.',
+	'PRUNE_NOT_POSTED'	=> 'Days since last posted',
+	'PRUNE_NOT_VIEWED'	=> 'Days since last viewed',
+
+	'TOPICS_PRUNED'		=> 'Topics pruned',
+	'POSTS_PRUNED'		=> 'Posts pruned',
+	'PRUNE_SUCCESS'		=> 'Pruning of forums was successful',
+);
+
+// Word censors
+$this->lang += array(
+	'WORDS_TITLE' => 'Word Censoring',
+	'WORDS_EXPLAIN' => 'From this control panel you can add, edit, and remove words that will be automatically censored on your forums. In addition people will not be allowed to register with usernames containing these words. Wildcards (*) are accepted in the word field, eg. *test* will match detestable, test* would match testing, *test would match detest.',
+	'WORD' => 'Word',
+	'EDIT_WORD' => 'Edit word censor',
+	'REPLACEMENT' => 'Replacement',
+	'ADD_WORD' => 'Add new word',
+	'UPDATE_WORD' => 'Update word censor',
+	'ENTER_WORD' => 'You must enter a word and its replacement',
+	'NO_WORD' => 'No word selected for editing',
+	'WORD_UPDATED' => 'The selected word censor has been successfully updated',
+	'WORD_ADDED' => 'The word censor has been successfully added',
+	'WORD_REMOVED' => 'The selected word censor has been successfully removed', 
+);
+
+// Mass email
+$this->lang += array(
+	'MASS_EMAIL_EXPLAIN'	=> 'Here you can email a message to either all of your users, or all users of a specific group.  To do this, an email will be sent out to the administrative email address supplied, with a blind carbon copy sent to all recipients. If you are emailing a large group of people please be patient after submitting and do not stop the page halfway through. It is normal for a mass emailing to take a long time, you will be notified when the script has completed',
+	'COMPOSE'				=> 'Compose',
+	'SEND_TO_GROUP'			=> 'Send to group',
+	'SEND_TO_USERS'			=> 'Send to users',
+	'SEND_TO_USERS_EXPLAIN'	=> 'Entering names here will override any group selected above. Enter each username on a new line.', 
+	'MASS_MESSAGE'			=> 'Your message', 
+	'MASS_MESSAGE_EXPLAIN'	=> 'Please note that you may enter only plain text. All markup will be removed before sending.', 
+	'ALL_USERS'				=> 'All Users',
+	'NO_EMAIL_SUBJECT'		=> 'You must specify a subject for your message.', 
+	'NO_EMAIL_MESSAGE'		=> 'You must enter a message.', 
+	'EMAIL_SENT'			=> 'Your message has been queued for sending.',
+	'EMAIL_SEND_ERROR'		=> 'There were one or more errors while sending the email. Please check the %sError Log%s for detailed error messages.',
+	'SEND_IMMEDIATLY'		=> 'Send immediatly',
+	'LOG_SESSION'			=> 'Log Mail Session',
+	'MAIL_PRIORITY'			=> 'Mail Priority',
+	'MAIL_LOW_PRIORITY'		=> 'Low',
+	'MAIL_NORMAL_PRIORITY'	=> 'Normal',
+	'MAIL_HIGH_PRIORITY'	=> 'High'
+);
+
+// Ranks
+$this->lang += array(
+	'RANKS_EXPLAIN' => 'Using this form you can add, edit, view and delete ranks. You can also create custom ranks which can be applied to a user via the user management facility',
+	'ADD_RANK' => 'Add new rank',
+	'RANK_TITLE' => 'Rank Title',
+	'RANK_SPECIAL' => 'Set as Special Rank',
+	'RANK_MINIMUM' => 'Minimum Posts',
+	'RANK_IMAGE' => 'Rank Image',
+	'RANK_IMAGE_EXPLAIN' => 'Use this to define a small image associated with the rank. The path is relative to the root phpBB2 directory.',
+	'MUST_SELECT_RANK' => 'You must select a rank.',
+	'NO_ASSIGNED_RANK' => 'No special rank assigned.',
+	'RANK_UPDATED' => 'The rank was successfully updated.',
+	'RANK_ADDED' => 'The rank was successfully added.',
+	'RANK_REMOVED' => 'The rank was successfully deleted.',
+	'NO_UPDATE_RANKS' => 'The rank was successfully deleted. However user accounts using this rank were not updated.  You will need to manually reset the rank on these accounts.',
+);
+
+// Disallowed names
+$this->lang += array(
+	'Disallow_control' => 'Username Disallow Control',
+	'Disallow_explain' => 'Here you can control usernames which will not be allowed to be used.  Disallowed usernames are allowed to contain a wildcard character of *.  Please note that you will not be allowed to specify any username that has already been registered, you must first delete that name then disallow it',
+	'Delete_disallow' => 'Delete',
+	'Delete_disallow_title' => 'Remove a Disallowed Username',
+	'Delete_disallow_explain' => 'You can remove a disallowed username by selecting the username from this list and clicking submit',
+	'Add_disallow' => 'Add',
+	'Add_disallow_title' => 'Add a disallowed username',
+	'Add_disallow_explain' => 'You can disallow a username using the wildcard character * to match any character',
+	'No_disallowed' => 'No Disallowed Usernames',
+	'Disallowed_deleted' => 'The disallowed username has been successfully removed',
+	'Disallow_successful' => 'The disallowed username has been successfully added',
+	'Disallowed_already' => 'The name you entered could not be disallowed. It either already exists in the list, exists in the word censor list, or a matching username is present',
+);
+
+// Styling
+$this->lang += array(
+	'STYLES'			=> 'Styles', 
+	'STYLES_EXPLAIN'	=> 'Here you can manage the available styles on your board. A style consists off a template, theme and imageset. You may alter existing styles, delete, deactivate, reactivate, create or import new ones. You can also see what a style will look like using the preview function. The current default style is noted by the presence of an asterix, * Also listed is the total user count for each style, note that overriding user styles will not be reflected here.', 
+	'STYLE_NAME'			=> 'Style name', 
+	'STYLE_USED_BY'			=> 'Used by', 
+	'STYLE_ACTIVATE'		=> 'Activate', 
+	'STYLE_DEACTIVATE'		=> 'Deactivate', 
+	'CREATE_STYLE'			=> 'Create new style', 
+	'INSTALLED_STYLE'		=> 'Installed styles', 
+	'UNINSTALLED_STYLE'		=> 'Uninstalled styles', 
+	'NO_UNINSTALLED_STYLE'	=> 'No uninstalled styles detected', 
+	'DEACTIVATE_DEFAULT'	=> 'You cannot deactivate the default style.', 
+
+	'EDIT_DETAILS_STYLE'		=> 'Edit Style', 
+	'EDIT_DETAILS_STYLE_EXPLAIN'=> 'Using the form below you can modify this existing style. You may alter the combination of template, theme and imageset which define the style itself. You may also deactivate the style and alter its name.', 
+	'STYLE_ACTIVE'				=> 'Active', 
+	'STYLE_DEFAULT'				=> 'Make default style', 
+	'STYLE_IMAGESET'			=> 'Imageset', 
+	'STYLE_THEME'				=> 'Theme', 
+	'STYLE_TEMPLATE'			=> 'Template', 
+	'STYLE_ADDED'				=> 'Style added successfully', 
+	'STYLE_EDITED'				=> 'Style edited successfully', 
+
+	'ADD_STYLE'				=> 'Create Style', 
+	'ADD_STYLE_EXPLAIN'		=> 'Here you can create a new style. Depending on your server configuration and file permissions you may have additional options. For example you may be able to base this style on an existing one. You may also be able to upload or import (from the store directory) a style archive. If you upload or import an archive the style name will be determined automatically.', 
+	'INSTALL_STYLE'			=> 'Install Style', 
+	'INSTALL_STYLE_EXPLAIN'	=> 'Here you can install a new style and if appropriate the corresponding style elements. If you already have the relevant style elements installed they will not be overwritten. Some styles require existing style elements to already be installed. If you try installing such a style and do not have the required elements you will be notified.', 
+	'STYLE_BASIS'			=> 'Style based on', 
+	'SELECT_STYLE'			=> 'Select style', 
+	'STYLE_UPLOAD_BASIS'	=> 'Upload a style', 
+	'STYLE_IMPORT_BASIS'	=> 'Import style from store', 
+
+	'STYLE_EXPORT'			=> 'Export Style', 
+	'STYLE_EXPORT_EXPLAIN'	=> 'Here you can export a style in the form of an archive. A style does not need to contain all elements but it must contain at least one. For example if you have created a new theme and imageset for a commonly used template you could simply export the theme and imageset and ommit the template. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'INCLUDE_TEMPLATE'		=> 'Include template', 
+	'INCLUDE_THEME'			=> 'Include theme', 
+	'INCLUDE_IMAGESET'		=> 'Include imageset', 
+	'STYLE_EXPORTED'		=> 'Style exported succesfully and stored in %s', 
+
+	'DELETE_STYLE'			=> 'Delete style', 
+	'DELETE_STYLE_EXPLAIN'	=> 'Here you can remove the selected style. You cannot remove all the style elements from here. These must be deleted individually via their respective forms. Take care in deleting styles there is no undo facility.', 
+	'REPLACE_STYLE'			=> 'Replace style with', 
+	'REPLACE_STYLE_EXPLAIN'	=> 'This style will replace the one being deleted for members that use it.', 
+	'ONLY_STYLE'			=> 'This is the only remaining style, you cannot delete it',
+	'STYLE_DELETED'			=> 'Style deleted successfully', 
+
+	'TEMPLATES'					=> 'Templates', 
+	'TEMPLATES_EXPLAIN'			=> 'A Template set comprises all the markup used to generate the layout of your board. Here you can  edit existing template sets, delete, export, import and preview sets. You can also modify the templating code used to generate BBCode.', 
+	'CREATE_TEMPLATE'			=> 'Create new template set', 
+	'INSTALLED_TEMPLATE'		=> 'Installed templates', 
+	'UNINSTALLED_TEMPLATE'		=> 'Uninstalled templates', 
+	'NO_UNINSTALLED_TEMPLATE'	=> 'No uninstalled templates detected', 
+
+	'EDIT_TEMPLATE'			=> 'Edit Template',
+	'EDIT_TEMPLATE_EXPLAIN'	=> 'Here you can edit your template set directly. Please remember that these edits are permanent and cannot be undone once submitted. If PHP can write to the template files in your styles directory any changes here will be written directly to those files. If PHP cannot write to those files they will be copied into the database and all changes will only be reflected there. Please take care when editing your template set, remember to close all replacement variable terms {XXXX} and conditional statements.', 
+	'SELECTED_TEMPLATE'		=> 'Selected template set:', 
+	'RAW_HTML'				=> 'Raw HTML', 
+	'TEMPLATE_UPDATED'		=> 'Template updated successfully', 
+
+	'EDIT_DETAILS_TEMPLATE'			=> 'Edit template details', 
+	'EDIT_DETAILS_TEMPLATE_EXPLAIN'	=> 'Here you can edit certain templates details such as its name. You may also have the option to switch storage of the stylesheet from the filesystem to the database and vice versa. This option depends on your PHP configuration and whether your template set can be written to by the webserver.', 
+	'ADD_TEMPLATE'				=> 'Create Template', 
+	'ADD_TEMPLATE_EXPLAIN'		=> 'Here you can add a new template. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this template set on an existing one. You may also be able to upload or import (from the store directory) a template archive. If you upload or import an archive the template name can be optionally taken from the archive name (to do this leave the template name blank).', 
+	'INSTALL_TEMPLATE'			=> 'Install Template', 
+	'INSTALL_TEMPLATE_EXPLAIN'	=> 'Here you can install a new template set. Depending on your server configuration you may have a number of options here.', 
+	'TEMPLATE_NAME'				=> 'Template name', 
+	'SELECT_TEMPLATE'			=> 'Select template', 
+	'TEMPLATE_BASIS'			=> 'Template set based on', 
+	'TEMPLATE_UPLOAD_BASIS'		=> 'Upload a template', 
+	'TEMPLATE_IMPORT_BASIS'		=> 'Import template from store', 
+	'TEMPLATE_LOCATION'			=> 'Store templates in', 
+	'TEMPLATE_LOCATION_EXPLAIN'	=> 'Images are always stored on the filesystem.', 
+	'TEMPLATE_ADDED'			=> 'Template set added and stored on filesystem', 
+	'TEMPLATE_ADDED_DB'			=> 'Template set added and stored in database', 
+
+	'TEMPLATE_CACHE'		=> 'Template Cache', 
+	'TEMPLATE_CACHE_EXPLAIN'=> 'By default phpBB caches the compiled version of its templates. This decreases the load on the server each time a page is viewed and thus may reduce the page generation time. Here you can view the cache status of each file and delete individual files or the entire cache.', 
+	'CACHE_FILENAME'		=> 'Template file', 
+	'CACHE_FILESIZE'		=> 'Filesize', 
+	'CACHE_CACHED'			=> 'Cached', 
+	'CACHE_MODIFIED'		=> 'Modified', 
+	'NO_CACHED_TPL_FILES'		=> 'No cached files for this template', 
+	'TEMPLATE_CACHE_CLEARED'=> 'Cached templates deleted', 
+
+	'TEMPLATE_EXPORT'			=> 'Export Templates', 
+	'TEMPLATE_EXPORT_EXPLAIN'	=> 'Here you can export a template set in the form of an archive. This archive will contain all the files necessary to install the templates on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'TEMPLATE_EXPORTED'		=> 'Templates exported succesfully and stored in %s', 
+
+	'DELETE_TEMPLATE'			=> 'Delete Template', 
+	'DELETE_TEMPLATE_EXPLAIN'	=> 'Here you can remove the selected template set from the database. Additionally, if you have permission you can elect to remove the set from the filesystem. Please note that there is no undo capability. When the templates are deleted they are gone for good. It is recommended that you first export your set for possible future use.', 
+	'REPLACE_TEMPLATE'			=> 'Replate template with', 
+	'REPLACE_TEMPLATE_EXPLAIN'	=> 'This template set will replace the one you are deleting in any styles that use it.', 
+	'TEMPLATE_DELETED'			=> 'Template set deleted successfully', 
+	'TEMPLATE_DELETED_FS'		=> 'Template set removed from database but some files may remain on the filesystem', 
+	'ONLY_TEMPLATE'				=> 'This is the only remaining template set, you cannot delete it',
+
+	'THEMES'				=> 'Themes', 
+	'THEMES_EXPLAIN'		=> 'From here you can create, install, edit, delete and export themes. A theme is the combination of colours and images that are applied to your templates to define the basic look of your forum. The range of options open to you depends on the configuration of your server and phpBB installation, see the Manual for further details. Please note that when creating new themes the use of an existing theme as a basis is optional.', 
+	'SELECT_THEME_BASIS'	=> 'Select optional basis', 
+	'THEME_VERSION_DIFF'	=> 'This theme was designed for a version of phpBB 2.2 different from that installed you may encounter some issues in its use.', 
+	'CREATE_THEME'			=> 'Create new theme', 
+	'INSTALLED_THEME'		=> 'Installed themes', 
+	'UNINSTALLED_THEME'		=> 'Uninstalled themes', 
+	'NO_UNINSTALLED_THEME'	=> 'No uninstalled themes detected', 
+
+	'DELETE_THEME'			=> 'Delete theme', 
+	'DELETE_THEME_EXPLAIN'	=> 'Here you can remove the selected theme from the database. Additionally, if you have permission you can elect to remove the theme from the filesystem. Please note that there is no undo capability. When the theme is deleted it is gone for good. It is recommended that you first export your theme for possible future use.', 
+	'REPLACE_THEME'			=> 'Replace theme with', 
+	'REPLACE_THEME_EXPLAIN'	=> 'This theme will replace the one you are deleting in any styles that use it.', 
+	'THEME_DELETED'			=> 'Theme deleted successfully', 
+	'THEME_DELETED_FS'		=> 'Theme removed from database but files remain on the filesystem', 
+	'ONLY_THEME'			=> 'This is the only remaining theme, you cannot delete it',
+
+	'EDIT_DETAILS_THEME'		=> 'Edit theme details', 
+	'EDIT_DETAILS_THEME_EXPLAIN'=> 'Here you can edit certain theme details such as its name. You may also have the option to switch storage of the stylesheet from the filesystem to the database and vice versa. This option depends on your PHP configuration and whether your stylesheet can be written to by the webserver.', 
+	'ADD_THEME'			=> 'Create Theme', 
+	'ADD_THEME_EXPLAIN'	=> 'Here you can add a new theme. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this theme on an existing one. You may also be able to upload or import (from the store directory) a theme archive. If you upload or import an archive the theme name can be optionally taken from the archive name (to do this leave the theme name blank).', 
+	'INSTALL_THEME'			=> 'Install Theme', 
+	'INSTALL_THEME_EXPLAIN'	=> 'Here you can install your selected theme. You can edit certain details if you wish or use the installation defaults.', 
+	'THEME_NAME'			=> 'Theme Name', 
+	'THEME_BASIS'			=> 'Theme Basis', 
+	'THEME_BASIS'			=> 'Theme based on', 
+	'THEME_UPLOAD_BASIS'	=> 'Upload a theme', 
+	'THEME_IMPORT_BASIS'	=> 'Import theme from store', 
+	'THEME_LOCATION'		=> 'Store stylesheet in', 
+	'THEME_LOCATION_EXPLAIN'=> 'Images are always stored on the filesystem.', 
+
+	'EDIT_THEME'			=> 'Edit theme', 
+	'EDIT_THEME_EXPLAIN'	=> 'Here you can edit the selected theme, changing colours, images, etc. You can switch between a simplified interface where you can set basic colours, etc. and a more advanced "raw CSS" mode. The raw mode allows you add additional parameters such as borders, etc. Only set parameters you need else leave them blank or unset. Default classes used by this theme are coloured red in the select box. You may also add additional "custom" classes should your template or style make use of them.', 
+	'SELECTED_THEME'		=> 'Selected theme', 
+	'SELECT_CLASS'			=> 'Select class', 
+	'SHOW_RAW_CSS'			=> 'Show CSS', 
+	'HIDE_RAW_CSS'			=> 'Hide CSS', 
+	'SHOW_RAW_CSS_NOTE'		=> 'Note', 
+	'SHOW_RAW_CSS_EXPLAIN'	=> 'Enter each element on a new line, ending with a ; Expand the data for each element, e.g. do not use font: use font-family:, font-weight:, etc.', 
+	'CSS_CAT_LAYOUT'	=> 'Layout', 
+	'CSS_#HEADER'		=> 'Header', 
+	'CSS_#LOGO'			=> 'Header logo', 
+	'CSS_#MENU'			=> 'Menu container', 
+	'CSS_#INFO'			=> 'Info container', 
+	'CSS_#FOOTER'		=> 'Footer', 
+	'CSS_CAT_TEXT'		=> 'Text Classes', 
+	'CSS_BODY'			=> 'Body',
+	'CSS_P'				=> 'Paragraph', 
+	'CSS_H1'			=> 'Header 1', 
+	'CSS_H2'			=> 'Header 2', 
+	'CSS_H3'			=> 'Header 3', 
+	'CSS_TABLETITLE'	=> 'Table Title', 
+	'CSS_CATTITLE'		=> 'Category Title', 
+	'CSS_TOPICTITLE'	=> 'Topic Titles', 
+	'CSS_TOPICAUTHOR'	=> 'Topic Author', 
+	'CSS_TOPICDETAILS'	=> 'Topic Details', 
+	'CSS_POSTBODY'		=> 'Post Text', 
+	'CSS_POSTHILIT'		=> 'Post Highlight', 
+	'CSS_POSTAUTHOR'	=> 'Post Author', 
+	'CSS_POSTDETAILS'	=> 'Post Details',
+	'CSS_MAINMENU'		=> 'Main Menu', 
+	'CSS_NAV'			=> 'Navigation',
+	'CSS_GENMED'		=> 'General Medium', 
+	'CSS_GENSMALL'		=> 'General Small',
+	'CSS_COPYRIGHT'		=> 'Copyright', 
+	'CSS_CAT_TABLES'	=> 'Tabular Classes', 
+	'CSS_TABLE'			=> 'Table', 
+	'CSS_TH'			=> 'Table Header',
+	'CSS_TD'			=> 'Table Data',
+	'CSS_CAT'			=> 'Category Header', 
+	'CSS_CATDIV'		=> 'Category Fade', 
+	'CSS_ROW1'			=> 'Alternate Row 1', 
+	'CSS_ROW2'			=> 'Alternate Row 2', 
+	'CSS_ROW3'			=> 'Alternate Row 3', 
+	'CSS_SPACER'		=> 'Spacer Row', 
+	'CSS_HR'			=> 'Horizontal Rule', 
+	'CSS_CAT_FORMS'		=> 'Form Classes', 
+	'CSS_FORM'			=> 'Form', 
+	'CSS_INPUT'			=> 'Input', 
+	'CSS_SELECT'		=> 'Select', 
+	'CSS_TEXTAREA'		=> 'Textarea', 
+	'CSS_POST'			=> 'Text Input', 
+	'CSS_BTNMAIN'		=> 'Primary Buttons',
+	'CSS_BTNLITE'		=> 'Secondary Buttons',
+	'CSS_BTNBBCODE'		=> 'BBCode Buttons', 
+	'CSS_CAT_BBCODE'	=> 'BBCode Classes', 
+	'CSS_B'				=> 'Bold',
+	'CSS_U'				=> 'Underline',
+	'CSS_I'				=> 'Italics',
+	'CSS_COLOR'			=> 'Colour',
+	'CSS_SIZE'			=> 'Size',	
+	'CSS_CODE'			=> 'Code',
+	'CSS_QUOTE'			=> 'Quote',
+	'CSS_FLASH'			=> 'Flash',
+	'CSS_SYNTAXBG'		=> 'Syntax Background', 
+	'CSS_SYNTAXCOMMENT'	=> 'Syntax Comments',
+	'CSS_SYNTAXDEFAULT'	=> 'Syntax Default',
+	'CSS_SYNTAXHTML'	=> 'Syntax HTML',
+	'CSS_SYNTAXKEYWORD'	=> 'Syntax Keyword',
+	'CSS_SYNTAXSTRING'	=> 'Syntax String',
+	'CSS_CAT_CUSTOM'	=> 'Custom Classes', 
+	'CSS_ANCHOR_LINK'	=> 'Link',
+	'CSS_ANCHOR_ACTIVE'	=> 'Active',
+	'CSS_ANCHOR_VISITED'=> 'Visited',
+	'CSS_ANCHOR_HOVER'	=> 'Hover', 
+
+	'CSS_PARAMETER'		=> 'Parameter', 
+	'CSS_VALUE'			=> 'Value', 
+	'RAW_CSS'			=> 'Raw CSS', 
+	'BACKGROUND'		=> 'Background', 
+	'BACKGROUND_COLOUR' => 'Background colour', 
+	'BACKGROUND_IMAGE'	=> 'Background image', 
+	'BACKGROUND_REPEAT' => 'Repeat background', 
+	'REPEAT_NO'			=> 'None', 
+	'REPEAT_X'			=> 'Only horizontally', 
+	'REPEAT_Y'			=> 'Only vertically', 
+	'REPEAT_ALL'		=> 'Both directions', 
+	'FOREGROUND'		=> 'Foreground', 
+	'COLOUR_EXPLAIN'	=> 'This is a hex-triplet of the form #RRGGBB or colour name', 
+	'FONT_COLOUR'		=> 'Font colour', 
+	'FONT_FACE'			=> 'Font face', 
+	'FONT_FACE_EXPLAIN' => 'You can specify multiple fonts seperated by commas.', 
+	'FONT_SIZE'			=> 'Font size', 
+	'UNDERLINE'			=> 'Underline', 
+	'ITALIC'			=> 'Italic', 
+	'BOLD'				=> 'Bold', 
+	'LINE_SPACING'		=> 'Line spacing', 
+	'CUSTOM_CLASS'			=> 'Custom Class', 
+	'CUSTOM_CLASS_EXPLAIN'	=> 'You can add additional classes to this theme if you wish. You must provide the actual CSS class name below, it must be the same as that you have or will use in your template. Please remember that class names may contain only alphanumeric characters, periods (.), colons (:) and number/hash/pound (#). The new class will be added to the Custom Class category in the select box above.', 
+	'CSS_CLASS_NAME'		=> 'CSS class name', 
+	'CUSTOM_CLASS'			=> 'Custom Class', 
+
+	'THEME_CLASS_ADDED'		=> 'Custom class added successfully', 
+	'THEME_UPDATED'			=> 'Class updated successfully',
+	'THEME_ADDED_DB'		=> 'New theme added to database', 
+	'THEME_ADDED'			=> 'New theme added on filesystem', 
+	'THEME_DETAILS_UPDATE'	=> 'Theme details updated', 
+
+	'THEME_EXPORT'			=> 'Export Theme', 
+	'THEME_EXPORT_EXPLAIN'	=> 'Here you can export a theme in the form of an archive. This archive will contain all the data necessary to install the theme on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'THEME_EXPORTED'		=> 'Theme exported succesfully and stored in %s', 
+
+	'IMAGESETS'					=> 'Imagesets', 
+	'IMAGESETS_EXPLAIN'			=> 'Imagesets comprise all the button, forum, folder, etc. and other non-style specific images used by the board. Here you can edit, export or delete existing imagesets and import or activate new sets.', 
+	'CREATE_IMAGESET'			=> 'Create new imageset', 
+	'INSTALLED_IMAGESET'		=> 'Installed imagesets', 
+	'UNINSTALLED_IMAGESET'		=> 'Uninstalled imagesets', 
+	'NO_UNINSTALLED_IMAGESET'	=> 'No uninstalled imagesets detected', 
+
+	'EDIT_IMAGESET'			=> 'Edit Imageset', 
+	'EDIT_IMAGESET_EXPLAIN'	=> 'Here you can edit the individual images which define the imageset. You can also specify  dimensions for the image. Dimensions are optional, specifying them can overcome certain rendering issues with some browsers. By not specifying them you reduce the size of the database record a little.', 
+	'SELECTED_IMAGESET'		=> 'Selected imageset', 
+	'SELECT_IMAGE'			=> 'Select image', 
+	'IMAGE'					=> 'Image', 
+	'CURRENT_IMAGE'			=> 'Current Image', 
+	'SELECTED_IMAGE'		=> 'Selected Image', 
+	'DIMENSIONS'			=> 'Include dimensions', 
+	'DIMENSIONS_EXPLAIN'	=> 'Selecting yes here will include width/height parameters.', 
+	'IMAGE_PARAMETER'		=> 'Parameter', 
+	'IMAGE_VALUE'			=> 'Value', 
+	'LOCALISED_IMAGES'		=> 'Localised', 
+	'GLOBAL_IMAGES'			=> 'Global', 
+	'IMG_CAT_BUTTONS'		=> 'Localised buttons',
+	'IMG_BTN_POST'			=> 'New topic', 
+	'IMG_BTN_REPLY'			=> 'Reply topic', 
+	'IMG_BTN_LOCKED'		=> 'Topic locked', 
+	'IMG_BTN_POST_PM'		=> 'New message', 
+	'IMG_BTN_REPLY_PM'		=> 'Reply message', 
+	'IMG_BTN_DELETE'		=> 'Delete post', 
+	'IMG_BTN_QUOTE'			=> 'Quote post', 
+	'IMG_BTN_PROFILE'		=> 'Show profile', 
+	'IMG_BTN_EMAIL'			=> 'Send email', 
+	'IMG_BTN_SEARCH'		=> 'Search posts', 
+	'IMG_BTN_WWW'			=> 'Website', 
+	'IMG_BTN_IP'			=> 'Show IP', 
+	'IMG_BTN_EDIT'			=> 'Edit post', 
+	'IMG_BTN_AIM'			=> 'AIM', 
+	'IMG_BTN_ICQ'			=> 'ICQ', 
+	'IMG_BTN_JABBER'		=> 'Jabber', 
+	'IMG_BTN_YIM'			=> 'YIM', 
+	'IMG_BTN_MSNM'			=> 'MSNM', 
+	'IMG_BTN_ONLINE'		=> 'User online', 
+	'IMG_BTN_OFFLINE'		=> 'User offline', 
+	'IMG_BTN_REPORT'		=> 'Report post', 
+	'IMG_BTN_PM'			=> 'Send message', 
+	'IMG_BTN_FRIEND'		=> 'Add as friend', 
+	'IMG_BTN_FOE'			=> 'Add as foe', 
+	'IMG_CAT_ICONS'			=> 'General icons',
+	'IMG_ICON_UNAPPROVED'	=> 'Post unapproved', 
+	'IMG_ICON_REPORTED'		=> 'Post reported', 
+	'IMG_ICON_ATTACH'		=> 'Attachment', 
+	'IMG_ICON_POST'			=> 'Minipost', 
+	'IMG_ICON_POST_NEW'		=> 'New minipost', 
+	'IMG_ICON_POST_LATEST'	=> 'Last post', 
+	'IMG_ICON_POST_NEWEST'	=> 'Newest post', 
+	'IMG_CAT_FORUMS'		=> 'Forum icons',
+	'IMG_FORUM'				=> 'Forum', 
+	'IMG_FORUM_NEW'			=> 'Forum new posts', 
+	'IMG_FORUM_LOCKED'		=> 'Forum locked', 
+	'IMG_FORUM_LINK'		=> 'Forum link', 
+	'IMG_SUB_FORUM'			=> 'Subforum',
+	'IMG_SUB_FORUM_NEW'		=> 'Subforum new posts',
+	'IMG_CAT_FOLDERS'				=> 'Topic icons',
+	'IMG_FOLDER'					=> 'Topic', 
+	'IMG_FOLDER_NEW'				=> 'Topic new posts',
+	'IMG_FOLDER_LOCKED'				=> 'Topic locked', 
+	'IMG_FOLDER_POSTED'				=> 'Topic posted to',
+	'IMG_FOLDER_NEW_POSTED'			=> 'Topic posted to new', 
+	'IMG_FOLDER_LOCKED_NEW'			=> 'Topic locked new', 
+	'IMG_FOLDER_LOCKED_POSTED'		=> 'Topic locked posted to', 
+	'IMG_FOLDER_LOCKED_NEW_POSTED'	=> 'Topic locked posted to new', 
+	'IMG_FOLDER_HOT'				=> 'Topic hot', 
+	'IMG_FOLDER_HOT_NEW'			=> 'Topic hot new posts', 
+	'IMG_FOLDER_HOT_POSTED'			=> 'Topic hot posted to',
+	'IMG_FOLDER_HOT_NEW_POSTED'		=> 'Topic hot posted to new',
+	'IMG_FOLDER_STICKY'				=> 'Sticky topic', 
+	'IMG_FOLDER_STICKY_POSTED'		=> 'Sticky topic posted to', 
+	'IMG_FOLDER_STICKY_NEW'			=> 'Sticky topic new posts',
+	'IMG_FOLDER_STICKY_NEW_POSTED'	=> 'Sticky topic posted to new', 
+	'IMG_FOLDER_ANNOUNCE'				=> 'Announcement', 
+	'IMG_FOLDER_ANNOUNCE_NEW'			=> 'Announcement new posts', 
+	'IMG_FOLDER_ANNOUNCE_POSTED'		=> 'Announcement posted to', 
+	'IMG_FOLDER_ANNOUNCE_NEW_POSTED'	=> 'Announcement posted to new', 
+	'IMG_FOLDER_GLOBAL'				=> 'Global', 
+	'IMG_FOLDER_GLOBAL_NEW'			=> 'Global new posts', 
+	'IMG_FOLDER_GLOBAL_POSTED'		=> 'Global posted to', 
+	'IMG_FOLDER_GLOBAL_NEW_POSTED'	=> 'Global posted to new', 
+	'IMG_CAT_POLLS'		=> 'Polling images',
+	'IMG_POLL_LEFT'		=> 'Poll left end', 
+	'IMG_POLL_RIGHT'	=> 'Poll right end', 
+	'IMG_POLL_CENTER'	=> 'Poll centre', 
+	'IMG_CAT_KARMA'		=> 'Karma images', 
+	'IMG_KARMA_LEFT'	=> 'Karma left end', 
+	'IMG_KARMA_CENTER'	=> 'Karma centre', 
+	'IMG_KARMA_RIGHT'	=> 'Karma right end', 
+	'IMG_CAT_CUSTOM'	=> 'Custom images', 
+	'IMAGESET_UPDATED'	=> 'Imageset updated successfully', 
+
+	'EDIT_DETAILS_IMAGESET'	=> 'Edit imageset details', 
+	'EDIT_DETAILS_IMAGESET_EXPLAIN'=> 'Here you can edit certain imageset details such as its name.', 
+	'ADD_IMAGESET'			=> 'Create Imageset', 
+	'ADD_IMAGESET_EXPLAIN'	=> 'Here you can create a new imageset. Depending on your server configuration and file permissions you may have additional options here. For example you may be able to base this imageset on an existing one. You may also be able to upload or import (from the store directory) a imageset archive. If you upload or import an archive the imageset name can be optionally taken from the archive name (to do this leave the imageset name blank).', 
+	'INSTALL_IMAGESET'			=> 'Install Imageset', 
+	'INSTALL_IMAGESET_EXPLAIN'	=> 'Here you can install your selected imageset. You can edit certain details if you wish or use the installation defaults.', 
+	'IMAGESET_NAME'				=> 'Imageset Name', 
+	'IMAGESET_BASIS'			=> 'Imageset Basis', 
+	'IMAGESET_BASIS'			=> 'Imageset based on', 
+	'IMAGESET_UPLOAD_BASIS'		=> 'Upload a imageset', 
+	'IMAGESET_IMPORT_BASIS'		=> 'Import imageset from store', 
+
+	'IMAGESET_EXPORT'			=> 'Export Imageset', 
+	'IMAGESET_EXPORT_EXPLAIN'	=> 'Here you can export an imageset in the form of an archive. This archive will contain all the data necessary to install the set of images on another board. You may select whether to download the file directly or to place it in your store folder for download later or via FTP.', 
+	'IMAGESET_EXPORTED'		=> 'Imageset exported succesfully and stored in %s', 
+	'DELETE_IMAGESET'			=> 'Delete Imageset', 
+	'DELETE_IMAGESET_EXPLAIN'	=> 'Here you can remove the selected imageset from the database. Additionally, if you have permission you can elect to remove the set from the filesystem. Please note that there is no undo capability. When the imageset is deleted it is gone for good. It is recommended that you first export your set for possible future use.', 
+	'REPLACE_IMAGESET'			=> 'Replace imageset with', 
+	'REPLACE_IMAGESET_EXPLAIN'	=> 'This imageset will replace the one you are deleting in any styles that use it.', 
+	'IMAGESET_DELETED'			=> 'Imageset set deleted successfully', 
+	'IMAGESET_DELETED_FS'		=> 'Imageset set removed from database but some files may remain on the filesystem', 
+	'ONLY_IMAGESET'				=> 'This is the only remaining imageset, you cannot delete it',
+
+	'STYLE_ERR_NOT_STYLE'		=> 'The imported or uploaded file did not contain a valid style archive.', 
+	'STYLE_ERR_MORE_ELEMENTS'	=> 'You must select at least two style elements.', 
+	'STYLE_ERR_STYLE_NAME'		=> 'You must supply a name for this style', 
+	'STYLE_ERR_NAME_LONG'		=> 'The style name can be no longer than 30 characters', 
+	'STYLE_ERR_NAME_EXIST'		=> 'A style with that name already exists', 
+	'STYLE_ERR_COPY_LONG'		=> 'The copyright can be no longer than 60 characters', 
+	'STYLE_ERR_NO_IDS'			=> 'You must select a template, theme and imageset for this style', 
+	'STYLE_ERR_NAME_CHARS'		=> 'The style name can only contain alphanumeric characters, -, +, _ and space',  
+	'REQUIRES_TEMPLATE'			=> 'This style requires the %s template set to be installed.', 
+	'REQUIRES_THEME'			=> 'This style requires the %s theme to be installed.', 
+	'REQUIRES_IMAGESET'			=> 'This style requires the %s imageset to be installed.', 
+	'TEMPLATE_ERR_STYLE_NAME'	=> 'You must supply a name for this templates', 
+	'TEMPLATE_ERR_NAME_CHARS'	=> 'The template name can only contain alphanumeric characters, -, +, _ and space',  
+	'TEMPLATE_ERR_NAME_LONG'	=> 'The template name can be no longer than 30 characters', 
+	'TEMPLATE_ERR_NAME_EXIST'	=> 'A template set with that name already exists', 
+	'TEMPLATE_ERR_COPY_LONG'	=> 'The copyright can be no longer than 60 characters', 
+	'TEMPLATE_ERR_ARCHIVE'		=> 'Please select an archive method', 
+	'TEMPLATE_ERR_NOT_TEMPLATE'	=> 'The archive you specified does not contain a valid template set.', 
+	'ERR_TPLCACHE_READ'			=> 'Cannot read the cache directory', 
+	'THEME_ERR_STYLE_NAME'		=> 'You must supply a name for this theme', 
+	'THEME_ERR_NAME_CHARS'		=> 'The theme name can only contain alphanumeric characters, -, +, _ and space',  
+	'THEME_ERR_NAME_LONG'		=> 'The theme name can be no longer than 30 characters', 
+	'THEME_ERR_NAME_EXIST'		=> 'A theme with that name already exists', 
+	'THEME_ERR_COPY_LONG'		=> 'The copyright can be no longer than 60 characters', 
+	'THEME_ERR_ARCHIVE'			=> 'Please select an archive method', 
+	'THEME_ERR_NOT_THEME'		=> 'The archive you specified does not contain a valid theme.', 
+	'THEME_ERR_CLASS_CHARS'		=> 'Only alphanumeric characters plus ., : and # are valid in class names.', 
+	'IMAGESET_ERR_STYLE_NAME'	=> 'You must supply a name for this imageset', 
+	'IMAGESET_ERR_NAME_CHARS'	=> 'The imageset name can only contain alphanumeric characters, -, +, _ and space',  
+	'IMAGESET_ERR_NAME_LONG'	=> 'The imageset name can be no longer than 30 characters', 
+	'IMAGESET_ERR_NAME_EXIST'	=> 'A imageset with that name already exists', 
+	'IMAGESET_ERR_COPY_LONG'	=> 'The copyright can be no longer than 60 characters', 
+	'IMAGESET_ERR_ARCHIVE'		=> 'Please select an archive method', 
+	'IMAGESET_ERR_NOT_IMAGESET'	=> 'The archive you specified does not contain a valid imageset.', 
+
+	'ARCHIVE_FORMAT'		=> 'Archive file type', 
+	'ALLOWED_FILETYPES'		=> 'Allowed filetypes', 
+	'SELECT_BASIS'			=> 'Select optional basis', 
+	'TEXT_COLUMNS'			=> 'Columns', 
+	'TEXT_ROWS'				=> 'Rows', 
+	'COPYRIGHT'				=> 'Copyright', 
+	'CACHE'					=> 'Cache', 
+	'EXPORT'				=> 'Export', 
+	'DETAILS'				=> 'Details', 
+	'REFRESH'				=> 'Refresh', 
+	'STORE_DATABASE'		=> 'Database', 
+	'STORE_FILESYSTEM'		=> 'Filesystem', 
+	'DELETE_FROM_FS'		=> 'Delete from filesystem', 
+	'INSTALL'				=> 'Install', 
+	'FROM'					=> 'from', // "Create new style .... from ..."
+	'OPTIONAL_BASIS'		=> 'Optional basis', 
+	'NO_IMAGESET'			=> 'Cannot find imageset on filesystem', 
+	'NO_THEME'				=> 'Cannot find theme on filesystem', 
+	'NO_TEMPLATE'			=> 'Cannot find template on filesystem', 
+	'NO_STYLE'				=> 'Cannot find style on filesystem', 
+	'NO_BASIS'				=> 'Do not use basis',
+	'NO_IMPORT'				=> 'Do not import', 
+	'UPLOAD_WRONG_TYPE'		=> 'Only the following filetypes are accepted: %s', 
+);
+
+
+// Admin logs
+$this->lang += array(
+	'ADMIN_LOGS_EXPLAIN'	=> 'This lists all the actions carried out by board administrators. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'MOD_LOGS_EXPLAIN'		=> 'This lists the actions carried out by board moderators, select a forum from the drop down list. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'CRITICAL_LOGS_EXPLAIN'	=> 'This lists the actions carried out by the board itself. These log provides you with information you are able to use for solving specific problems, for example non-delivery of emails. You can sort by username, date, IP or action. If you have appropriate permissions you can also clear individual operations or the log as a whole.',
+	'DISPLAY_LOG'			=> 'Display entries from previous',
+
+	'ALL_ENTRIES'	=> 'All entries',
+	'SORT_IP'		=> 'IP address',
+	'SORT_DATE'		=> 'Date',
+	'SORT_ACTION'	=> 'Log action',
+	'NO_ENTRIES'	=> 'No log entries for this period',
+);
+
+
+// Installation
+$this->lang += array(
+	'WELCOME_INSTALL'	=> 'Welcome to phpBB 2 Installation',
+
+	'INSTALL_REQUIRED'		=> 'Required', 
+	'INSTALL_OPTIONAL'		=> 'Optional', 
+	'UNAVAILABLE'	=> 'Unavailable', 
+	'AVAILABLE'		=> 'Available', 
+	'TESTS_PASSED'	=> 'Tests passed', 
+	'TESTS_FAILED'	=> 'Tests failed', 
+
+	'INSTALL_ADVICE'	=> 'Installation Compatibility', 
+	'INSTALL_ADVICE_EXPLAIN'=> 'Before proceeding with full installation phpBB will carry out some tests on your server and basic install. Please ensure you read through the results thoroughly and do not proceed until all tests are passed.', 
+	'PHP_AND_APPS'			=> 'PHP and Applications', 
+	'INSTALL_REQUIRED_PHP'	=> 'You must be running at least PHP 4.1.0 with support for at least one compatible database. If no support modules are shown as available you should contact your hosting provider or review the relevant PHP installation documentation for advice. If "safe mode" is displayed below your PHP installation is running in that mode. This will impose limitations on remote administration and similar features.', 
+	'INSTALL_OPTIONAL_PHP'	=> 'These modules or applications are optional, you do not need these to use phpBB 2.2. However if you do have them they will will enable greater functionality.', 
+	'PHP_VERSION_REQD'	=> 'PHP version >= 4.1.0',
+	'PHP_SAFE_MODE'		=> 'Safe Mode', 
+	'PHP_REQD_DB'		=> 'Supported Databases', 
+	'DLL_FIREBIRD'		=> 'Firebird 1.5+',
+	'DLL_MYSQL'			=> 'MySQL 3.23.x/4.x',
+	'DLL_MYSQL4'		=> 'MySQL 4.1+',
+	'DLL_MSSQL'			=> 'MSSQL Server 2000',
+	'DLL_MSSQL-ODBC'	=> 'MSSQL Server 2000 via ODBC',
+	'DLL_MSACCESS'		=> 'MS Access via ODBC', 
+	'DLL_ORACLE'		=> 'Oracle',
+	'DLL_POSTGRES'		=> 'PostgreSQL 7.x', 
+	'DLL_SQLITE'		=> 'SQLite', 
+	'DLL_MBSTRING'		=> 'Multi-byte character support', 
+	'DLL_ZLIB'			=> 'zlib Compression support [ Visual confirmation, gz, .tar.gz, .zip ]', 
+	'DLL_FTP'			=> 'Remote FTP support [ Installation ]',
+	'DLL_XML'			=> 'XML support [ Jabber ]', 
+	'DLL_MHASH'			=> 'Mhash hashing support [ Jabber ]', 
+	'APP_MAGICK'		=> 'Imagemagick support [ Attachments ]', 
+	'NO_LOCATION'		=> 'Cannot determine location', 
+	'DIRECTORIES_AND_FILES'		=> 'Directory and file setup', 
+	'INSTALL_REQUIRED_FILES'	=> 'In order to function correctly phpBB needs to be able to access or write to certain files or directories. If you see "Not Found" you need to create the relevant file or directory. If you see "Unwriteable" you need to change the permissions on the file or directory to allow phpBB to write to it.', 
+	'INSTALL_OPTIONAL_FILES'	=> 'These files, directories or permissions are optional. The installation routines will attempt to use various techniques to complete if they do not exist or cannot be written to. However, the presence of these files, directories or permissions will speed installation.', 
+	'FILE_FOUND'		=> 'Found', 
+	'FILE_NOT_FOUND'	=> 'Cannot find', 
+	'FILE_WRITEABLE'	=> 'Writeable', 
+	'FILE_UNWRITEABLE'	=> 'Unwriteable', 
+	'INSTALL_NEXT'		=> 'Next stage', 
+	'INSTALL_NEXT_PASS'	=> 'All the basic tests have been passed and you may proceed to the next stage of installation. If you have changed any permissions, modules, etc. and wish to re-test you can do so if you wish.', 
+	'INSTALL_NEXT_FAIL'	=> 'Some tests failed and you should correct these problems before proceeding to the next stage. Failure to do so may result in an incomplete installation.', 
+
+	'INITIAL_CONFIG'		=> 'Basic Configuration',
+	'INITIAL_CONFIG_EXPLAIN'=> 'Now that install has determined your server can run phpBB you need to supply some specific information. If you do not know how to connect to your database please contact your hosting provider (in the first instance) or  use the phpBB support forums. When entering data please ensure you check it thoroughly before continuing.', 
+	'ADMIN_CONFIG'			=> 'Admin Configuration',
+	'DEFAULT_LANG'			=> 'Default board language',
+	'ADMIN_USERNAME'		=> 'Administrator username',
+	'CONTACT_EMAIL'			=> 'Contact email address',
+	'CONTACT_EMAIL_CONFIRM'	=> 'Confirm contact email',
+	'ADMIN_PASSWORD'		=> 'Administrator password',
+	'ADMIN_PASSWORD_CONFIRM'=> 'Confirm administrator password',
+	'DB_CONFIG'			=> 'Database Configuration', 
+	'DBMS'				=> 'Database type',
+	'DB_HOST'			=> 'Database server hostname or DSN',
+	'DB_HOST_EXPLAIN'	=> 'DSN stands for Data Source Name and is relevant only for ODBC installs.', 
+	'DB_PORT'			=> 'Database server port', 
+	'DB_PORT_EXPLAIN'	=> 'Leave this blank unless you know the server operates on a non-standard port.', 
+	'DB_NAME'			=> 'Database name',
+	'DB_USERNAME'		=> 'Database username',
+	'DB_PASSWORD'		=> 'Database password',
+	'TABLE_PREFIX'		=> 'Prefix for tables in database', 
+	'DB_TEST'			=> 'Test Connection', 
+	'INSTALL_DB_CONNECT'=> 'Successfull Connection', 
+	'SERVER_CONFIG'			=> 'Server Configuration', 
+	'SERVER_NAME'			=> 'Domain name',
+	'SERVER_NAME_EXPLAIN'	=> 'The domain name this board runs from',
+	'SCRIPT_PATH'			=> 'Script path',
+	'SCRIPT_PATH_EXPLAIN'	=> 'The path where phpBB2 is located relative to the domain name',
+	'SERVER_PORT'			=> 'Server port',
+	'SERVER_PORT_EXPLAIN'	=> 'The port your server is running on, usually 80, only change if different',
+	'CACHE_STORE'			=> 'Cache type', 
+	'CACHE_STORE_EXPLAIN'	=> 'The physical location where data is cached, filesystem is prefered.', 
+	'INSTALL_TEST'	=> 'Test Again', 
+	'INSTALL_NEXT'	=> 'Next Stage', 
+	'INSTALL_START'	=> 'Start Install', 
+
+	'INSTALL_SEND_CONFIG'	=> 'Unfortunately phpBB could not write the configuration information directly to your config.php. This may be because the file does not exist or is not writeable. A number of options will be listed below enabling you to complete installation of config.php.', 
+	'FTP_CONFIG'		=> 'Transfer config by FTP', 
+	'FTP_CONFIG_EXPLAIN'=> 'phpBB has detected the presence of the ftp module on this server. You may attempt to install your config.php via this if you wish. You will need to supply the information listed below. Remember your username and password are those to your server! (ask your hosting provider for details if you are unsure what these are)', 
+	'FTP_PATH'			=> 'FTP Path',
+	'FTP_PATH_EXPLAIN'	=> 'This is the path from your root directory to that of phpBB2, e.g. htdocs/phpBB2/',
+	'FTP_USERNAME'		=> 'FTP Username',
+	'FTP_PASSWORD'		=> 'FTP Password',
+	'FTP_UPLOAD'		=> 'Upload', 
+	'DL_CONFIG'			=> 'Download config', 
+	'DL_CONFIG_EXPLAIN'	=> 'You may download the complete config.php to your own PC. You will then need to upload the file manually, replacing any existing config.php in your phpBB 2.2 root directory. Please remember to upload the file in ASCII format (see your FTP application documentation if you are unsure how to achieve this). When you have uploaded the config.php please click "Done" to move to the next stage.', 
+	'DL_DOWNLOAD'		=> 'Download', 
+	'DL_DONE'			=> 'Done', 
+	'RETRY_WRITE'			=> 'Retry writing config', 
+	'RETRY_WRITE_EXPLAIN'	=> 'If you wish you can change the permissions on config.php to allow phpBB to write to it. Should you wish to do that you can click Retry below to try again. Remember to return the permissions on config.php after phpBB2 has finished installation.', 
+	'CONFIG_RETRY'			=> 'Retry', 
+
+	'INSTALL_CONGRATS'			=> 'Congratulations',
+	'INSTALL_CONGRATS_EXPLAIN'	=> 'You have now successfully installed phpBB 2.2. Clicking the button below will take you to your Administration Control Panel (ACP). Take some time to examine the options available to you. Remember that help is available online via the Userguide and the phpBB support forums, see the %sREADME%s for further information.',
+	'INSTALL_LOGIN'				=> 'Login',
+
+	'INST_ERR_FATAL'			=> 'Fatal installation error', 
+	'INST_ERR_MISSING_DATA'		=> 'You must fill out all fields in this block', 
+	'INST_ERR_NO_DB'			=> 'Cannot load the PHP module for the selected database type',
+	'INST_ERR_EMAIL_MISMATCH'	=> 'The emails you entered did not match.',
+	'INST_ERR_PASSWORD_MISMATCH'=> 'The passwords you entered did not match.', 
+	'INST_ERR_DB_CONNECT'		=> 'Could not connect to the database, see error message below', 
+	'INST_ERR_DB_NO_ERROR'		=> 'No error message given', 
+	'INST_ERR_PREFIX'			=> 'Tables with the specified prefix already exist, please choose an alternative.', 
+	'INST_ERR_FATAL_DB'			=> 'A fatal and unrecoverable database error has occured. This may be because the specified user does not have appropriate rights to CREATE TABLES or INSERT data, etc. Further information may be given below. Please contact your hosting provider in the first instance or the support forums of phpBB for further assistance.', 
+	'INST_ERR_FTP_PATH'			=> 'Could not change to the given directory, please check the path.', 
+	'INST_ERR_FTP_LOGIN'		=> 'Could not login to ftp server, check your username and password', 
+);
+
+// Bots
+$this->lang += array(
+	'BOTS_EXPLAIN'	=> 'Bots or crawlers are automated agents most commonly used by search engines to update their databases. Since they rarely make proper use of sessions they can distort visitor counts, increase load and sometimes fail to index sites correctly. Here you can define a special type of user to overcome these problems.',
+	
+	'BOT_NAME'			=> 'Bot name',
+	'BOT_LAST_VISIT'	=> 'Last visit', 
+	'BOT_NEVER'			=> 'Never', 
+	'BOT_ACTIVATE'		=> 'Activate', 
+	'BOT_DEACTIVATE'	=> 'Deactivate', 
+	'BOT_ADD'			=> 'Add bot',
+
+	'BOT_EDIT'			=> 'Edit bots', 
+	'BOT_EDIT_EXPLAIN'	=> 'Here you can add or edit an existing bot entry. You may define an agent string and/or one or more IP addresses (or range of addresses) to match. Be careful when defining matching agent strings or addresses. You may also specify a style and language that the bot will view the board using. This may allow you to reduce bandwidth use by setting a simple style for bots. Remember to set appropriate permissions for the special Bot usergroup.', 
+	'BOT_NAME_EXPLAIN'	=> 'Used only for your own information.',
+	'BOT_LANG'			=> 'Bot language', 
+	'BOT_LANG_EXPLAIN'	=> 'The language presented to the bot as it browses.', 
+	'BOT_STYLE'			=> 'Bot style', 
+	'BOT_STYLE_EXPLAIN'	=> 'The style used for the board by the bot.', 
+	'BOT_VIS'			=> 'Bot visible', 
+	'BOT_VIS_EXPLAIN'	=> 'Allow bot to be seen by all users in online lists.', 
+	'BOT_ACTIVE'		=> 'Bot active', 
+	'BOT_AGENT'			=> 'Agent match', 
+	'BOT_AGENT_EXPLAIN'	=> 'A string matching the bots browser agent, partial matches are allowed.', 
+	'BOT_IP'			=> 'Bot IP address',
+	'BOT_IP_EXPLAIN'	=> 'Partial matches are allowed, seperate addresses with an apostrophe. A single hostname may be entered instead of an IP.',
+
+	'BOT_ADDED'		=> 'New bot successfully added', 
+	'BOT_UPDATED'	=> 'Existing bot updated successfully', 
+	'BOT_DELETED'	=> 'Bot deleted successfully', 
+
+	'NO_BOT'	=> 'Found no bot with the specified ID', 
+	'ERR_BOT_NO_MATCHES'	=> 'You must supply at least one of an agent or IP for this bot match.', 
+	'ERR_BOT_NO_IP'			=> 'The IP addresses you supplied were invalid or the hostname could not be resolved.', 
+);
+
+// Custom profile fields
+$this->lang += array(
+	'FIELD_INT'		=> 'Numbers',
+	'FIELD_STRING'	=> 'Single Textfield',
+	'FIELD_TEXT'	=> 'Textarea',
+	'FIELD_BOOL'	=> 'Boolean (Yes/No)',
+	'FIELD_DROPDOWN'=> 'Dropdown Box',
+	'FIELD_DATE'	=> 'Date',
+
+	'NO_FIELD_TYPE'				=> 'No Field type specified',
+	'FIRST_OPTION'				=> 'First Option',
+	'SECOND_OPTION'				=> 'Second Option',
+	'EMPTY_FIELD_NAME'			=> 'Empty field name',
+	'EMPTY_USER_FIELD_NAME'		=> 'Empty Field Name presented to the user',
+	'FIELD_IDENT_ALREADY_EXIST'	=> 'Field identifier %s already exist, please choose another Field Name.',
+	'NEXT_PAGE'					=> 'Next Page',
+	'PREVIOUS_PAGE'				=> 'Previous Page',
+	'STEP_1_TITLE'				=> 'Add Profile Field',
+	'STEP_1_EXPLAIN'			=> 'Here you can enter the first basic parameters of your new profile field. These informations are needed for the second step where you are able to set remaining options and where you are able to preview and tweak your profile field further.',
+	'STEP_2_TITLE'				=> 'Profile type specific options',
+	'STEP_2_EXPLAIN'			=> 'Here you are able to define some common options. Further you are able to preview the field you generated, as the user will see it. Play around with it until you are satisfied as how the field behaves.',
+	'STEP_3_TITLE'				=> 'Remaining Language Definitions',
+	'STEP_3_EXPLAIN'			=> 'Since you have more than one board language installed, you have to fill out the remaining language items too. The profile field will work with the default language enabled, you are able to fill out the remaining language items later too.',
+	'ROWS'						=> 'Rows',
+	'COLUMNS'					=> 'Columns',
+	'UPDATE_PREVIEW'			=> 'Update Preview',
+	'PREVIEW_PROFILE_FIELD'		=> 'Preview Profile Field',
+	'EVERYTHING_OK'				=> 'Everything OK',
+
+	'STRING_DEFAULT_VALUE_EXPLAIN'	=> 'Enter a default phrase to be displayed, a default value. Leave empty if you want to show it empty at the first place.',
+	'TEXT_DEFAULT_VALUE_EXPLAIN'=> 'Enter a default text to be displayed, a default value. Leave empty if you want to show it empty at the first place.',
+	'BOOL_ENTRIES_EXPLAIN'		=> 'Enter your options now',
+	'DROPDOWN_ENTRIES_EXPLAIN'	=> 'Enter your options now, every option in one line',
+
+	'REQUIRED_FIELD'			=> 'Required Field',
+	'REQUIRED_FIELD_EXPLAIN'	=> 'Force profile field to be filled out or specified by user',
+	'DISPLAY_AT_REGISTRATION'	=> 'Display at registration screen',
+	'HIDE_PROFILE_FIELD'		=> 'Hide Profile Field',
+	'HIDE_PROFILE_FIELD_EXPLAIN'=> 'Only Administrators and Moderators are able to see/fill out this profile field',
+
+	'ADDED_PROFILE_FIELD'		=> 'Successfully added custom profile field',
+	'CREATE_NEW_FIELD'			=> 'Create New Field',
+	'DELETED_PROFILE_FIELD'		=> 'Successfully deleted profile field.',
+	'CONFIRM_DELETE_PROFILE_FIELD'	=> 'Are you sure you want to delete this profile field?',
+	'PROFILE_FIELD_ACTIVATED'	=> 'Profile field successfully activated',
+	'PROFILE_FIELD_DEACTIVATED'	=> 'Profile field successfully deactivated',
+
+	'CHARS_ANY'		=> 'Any character', 
+	'NUMBERS_ONLY'	=> 'Only numbers (0-9)',
+	'ALPHA_ONLY'		=> 'Alphanumeric only', 
+	'ALPHA_SPACERS'	=> 'Alphanumeric and spacers', 
+
+	'FIELD_TYPE'			=> 'Field Type',
+	'FIELD_TYPE_EXPLAIN'	=> 'You are not able to change the field type later.',
+	'FIELD_NAME'			=> 'Field Name',
+	'FIELD_NAME_EXPLAIN'	=> 'The Field Name is a name for you to identify the profile field, it is not displayed to the user. You are able to use this name as template variable later.',
+	'LANG_SPECIFIC_OPTIONS'	=> 'Language specific options [<b>%s</b>]',
+	'USER_FIELD_NAME'		=> 'Field Name presented to the user',
+	'FIELD_DESCRIPTION'		=> 'Field Description',
+	'FIELD_DESCRIPTION_EXPLAIN'	=> 'The Explanation for this field presented to the user',
+
+	'CP_LANG_NAME'			=> 'Field Name presented to the user',
+	'CP_LANG_EXPLAIN'		=> 'Field Description',
+	'CP_LANG_EXPLAIN_EXPLAIN'	=> 'The Explanation for this field presented to the user',
+	'CP_LANG_DEFAULT_VALUE'	=> 'Default Value',
+	'CP_LANG_OPTIONS'		=> 'Options',
+
+	'FIELD_LENGTH'			=> 'Length of input box',
+	'MIN_FIELD_CHARS'		=> 'Minimum number of characters',
+	'MAX_FIELD_CHARS'		=> 'Maximum number of characters',
+	'MIN_FIELD_NUMBER'		=> 'Lowest allowed number',
+	'MAX_FIELD_NUMBER'		=> 'Highest allowed number',
+	'DEFAULT_VALUE'			=> 'Default Value',
+	'FIELD_VALIDATION'		=> 'Field Validation',
+	'ENTRIES'				=> 'Entries',
+	'BOOL_TYPE_EXPLAIN'		=> 'Define the Type, either a checkbox or radio buttons',
+	'RADIO_BUTTONS'			=> 'Radio Buttons',
+	'CHECKBOX'				=> 'Checkbox',
+	'NO_VALUE_OPTION'		=> 'Option equal to non entered value',
+	'NO_VALUE_OPTION_EXPLAIN'	=> 'Value for a non-entry. If the field is required, the user gets an error if he choose the option selected here',
+	'ALWAYS_TODAY'			=> 'Always the current date',
+
+	'DEFAULT_ISO_LANGUAGE'	=> 'Default Language [%s]',
+	'ISO_LANGUAGE'			=> 'Language [%s]',
+);
+
+?>
\ No newline at end of file



From viperal at berlios.de  Tue Sep 20 07:08:08 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 20 Sep 2005 07:08:08 +0200
Subject: [Viperals-svncheckins] r135 - in cms/trunk/includes: forums templates/modules/Forums
Message-ID: <200509200508.j8K588BR003618@sheep.berlios.de>

Author: viperal
Date: 2005-09-20 07:07:35 +0200 (Tue, 20 Sep 2005)
New Revision: 135

Modified:
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/templates/modules/Forums/posting_body.html
Log:
Small fixes to forums.

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-19 19:56:09 UTC (rev 134)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-20 05:07:35 UTC (rev 135)
@@ -434,7 +434,8 @@
 
 	$_CLASS['core_db']->transaction();
 
-	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
+	//$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
+	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
 	
 	foreach ($table_ary as $table)
 	{

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-19 19:56:09 UTC (rev 134)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-20 05:07:35 UTC (rev 135)
@@ -858,7 +858,7 @@
 		
 		if ($notify_type == 'topic' && $user['forum_id'])
 		{
-			$holding[$user['user_id']]['template'] = 'notify_forum';
+			$holding[$user['user_id']]['template'] = 'forum_notify';
 			$holding[$user['user_id']]['update'] = 'forum';
 		}
 		else

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-19 19:56:09 UTC (rev 134)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-20 05:07:35 UTC (rev 135)
@@ -350,7 +350,7 @@
 					{
 						// if theres any problems with this, find the first "php" without span remove it
 						// then find the first </span> and remove it
-						$pos = ($pos = mb_strpos($code, 'php&nbsp;</span>')) ? $pos + 16 : mb_strpos($code, 'php </span>') + 16;
+						$pos = ($pos = mb_strpos($code, 'php&nbsp;</span>')) ? $pos + 16 : mb_strpos($code, 'php </span>') + 11;
 						$code = mb_substr($code, $pos);
 					}
 									

Modified: cms/trunk/includes/templates/modules/Forums/posting_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/posting_body.html	2005-09-19 19:56:09 UTC (rev 134)
+++ cms/trunk/includes/templates/modules/Forums/posting_body.html	2005-09-20 05:07:35 UTC (rev 135)
@@ -10,7 +10,7 @@
 
 // Define the bbCode tags
 bbcode = new Array();
-bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]','[php]','[/php]');
+bbtags = new Array('[b]','[/b]','[i]','[/i]','[u]','[/u]','[quote]','[/quote]','[code]','[/code]','[list]','[/list]','[list=]','[/list]','[img]','[/img]','[url]','[/url]','[code=php]','[/code]');
 imageTag = false;
 
 // Helpline messages
@@ -203,7 +203,9 @@
 				<td><input type="button" class="btnbbcode" accesskey="z" name="addbbcode18" value="php" style="width: 40px" onclick="bbstyle(18)" onmouseover="helpline('z')" /></td>
 				<td><input type="button" class="btnbbcode" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
 				<td><input type="button" class="btnbbcode" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-				<td><input type="button" class="btnbbcode" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
+				<td><input type="button" class="btnbbcode" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
+			</tr>
+			<tr align="center" valign="middle">
 				<td><input type="button" class="btnbbcode" accesskey="w" name="addbbcode16" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(16)" onmouseover="helpline('w')" /></td>
 			</tr>
 			<tr>



From viperal at berlios.de  Tue Sep 20 23:46:51 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Tue, 20 Sep 2005 23:46:51 +0200
Subject: [Viperals-svncheckins] r136 - in cms/trunk: admin includes includes/display includes/forums modules modules/Control_Panel/ucp modules/Members_List modules/calender modules/calender/language modules/calender/language/en
Message-ID: <200509202146.j8KLkpWi011680@sheep.berlios.de>

Author: viperal
Date: 2005-09-20 23:46:50 +0200 (Tue, 20 Sep 2005)
New Revision: 136

Added:
   cms/trunk/includes/display/menu.php
   cms/trunk/modules/calender/
   cms/trunk/modules/calender/configurator.php
   cms/trunk/modules/calender/index.php
   cms/trunk/modules/calender/language/
   cms/trunk/modules/calender/language/en/
   cms/trunk/modules/calender/language/en/index.php
Modified:
   cms/trunk/admin/blocks.php
   cms/trunk/admin/messages.php
   cms/trunk/admin/modules.php
   cms/trunk/includes/display/calender.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/session.php
   cms/trunk/modules/Control_Panel/ucp/ucp_calender.php
   cms/trunk/modules/Members_List/index.php
Log:


Modified: cms/trunk/admin/blocks.php
===================================================================
--- cms/trunk/admin/blocks.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/admin/blocks.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -309,7 +309,7 @@
 	{
 		$start = strtotime($data['block_starts']);
 
-		if (!$start || $start == -1)
+		if (!$start || $start === -1)
 		{
 			$error .= $_CLASS['core_user']->lang['ERROR_START_TIME'].'<br />';
 		}
@@ -319,7 +319,7 @@
 	{
 		$expires = strtotime($data['block_expires']);
 
-		if (!$expires || $expires == -1)
+		if (!$expires || $expires === -1)
 		{
 			$error .= $_CLASS['core_user']->lang['ERROR_END_TIME'].'<br />';
 		}

Modified: cms/trunk/admin/messages.php
===================================================================
--- cms/trunk/admin/messages.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/admin/messages.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -234,7 +234,7 @@
 	{
 		$start = strtotime($data['block_starts']);
 
-		if (!$start || $start == -1)
+		if (!$start || $start === -1)
 		{
 			$error .= $_CLASS['core_user']->lang['ERROR_START_TIME'].'<br />';
 		}
@@ -244,7 +244,7 @@
 	{
 		$expires = strtotime($data['block_expires']);
 
-		if (!$expires || $expires == -1)
+		if (!$expires || $expires === -1)
 		{
 			$error .= $_CLASS['core_user']->lang['ERROR_END_TIME'].'<br />';
 		}

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/admin/modules.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -54,7 +54,7 @@
 		switch ($_REQUEST['mode'])
 		{
 			case 'change':
-				$result = $_CLASS['core_db']->query('SELECT module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
+				$result = $_CLASS['core_db']->query('SELECT module_name, module_status, module_type FROM '.CORE_MODULES_TABLE.' WHERE module_id = '.$id);
 				$module = $_CLASS['core_db']->fetch_row_assoc($result);
 				$_CLASS['core_db']->free_result($result);
 			
@@ -77,7 +77,7 @@
 					{
 						$module_configurer = new $name;
 
-						if (method_exists('status_change'))
+						if (method_exists($module_configurer, 'status_change'))
 						{
 							$report = $module_configurer->status_change($status, $module['module_status']);
 		
@@ -118,7 +118,7 @@
 						{
 							$module_configurer = new $name;
 	
-							if (method_exists('install'))
+							if (method_exists($module_configurer, 'install'))
 							{
 								$status = $module_configurer->install();
 			
@@ -158,7 +158,7 @@
 						{
 							$module_configurer = new $name;
 	
-							if (method_exists('uninstall'))
+							if (method_exists($module_configurer, 'uninstall'))
 							{
 								$status = $module_configurer->uninstall();
 			

Modified: cms/trunk/includes/display/calender.php
===================================================================
--- cms/trunk/includes/display/calender.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/display/calender.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -1,25 +1,33 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright 2004 - 2005										//
-//  By Ryan Marshall ( Viperal )								//
-//																//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class calender
 {
 	var $day;
 	var $month;
 	var $year;
 	var $month_data_array = array();
-	var $table = 'cms_calender';
+	var $table = false;
 	
 	// Use me, use me plz....
 	var $time_offset = 0;
@@ -29,7 +37,6 @@
 	*/
 	function set_date($day, $month = false, $year = false)
 	{
-		//(int)
 		$this->month = (!$month || $month > 12 || $month < 1) ? date('n') : $month;
 		
 		if ($year)
@@ -42,6 +49,7 @@
 			$this->year = date('Y');
 			$this->year_current = true;
 		}
+		//checkdate ( int month, int day, int year )
 
 		$this->last_day = date("t", mktime(0, 0, 0, $this->month, 1, $this->year));
 		$this->first_day = date("w", mktime(0, 0, 0, $this->month, 1, $this->year)) + 1;
@@ -149,7 +157,7 @@
 			{
 				$_CLASS['core_template']->assign_vars_array($template_name, array(
 					'NUMBER'	=> false
-					));
+				));
 				continue;
 			}
 			
@@ -160,7 +168,7 @@
 					'NUMBER'	=> $num,
 					'LINK'		=> ($num != $this->day || !$current_month) ? generate_link($link.'&amp;year='.$this->year.'&amp;month='.$this->month.'&amp;mode=day_view&amp;day='.$num) : false,
 					'DATA'		=> empty($this->month_data_array[($num - 1)]) ? false : $this->month_data_array[($num - 1)],
-					));
+				));
 			}
 
 			if ($num == $this->last_day)
@@ -185,39 +193,47 @@
 		
 		$date = explode(':', date('n:d:y', $time));
 		
-		$day['start'] = mktime(0, 0, 0, $date[0], $date[1], $date[2]);
+		$day['start'] = mktime(0, 0, 0, $date[0], $date[1], $date[2]) + 60;
 		$day['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 
 		$sql = 'SELECT * FROM '. $this->table .'
-					WHERE start_date <= '. $day['end'] .' 
-					AND end_date >= '. $day['start'];
+					WHERE calender_starts <= '. $day['end'] .' 
+					AND calender_expires >= '. $day['start'];
 					
 		$result = $_CLASS['core_db']->query($sql);
 		
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($row['recur'] && ($row['start_date'] < $day['start']))
+			if ($row['calender_recur_rate'] && ($row['calender_starts'] < $day['start']))
 			{
-				$row['start_date'] = $row['start_date'] + ($row['recur'] * ceil(($day['start'] - $row['start_date']) / $row['recur']));
+				$row['calender_starts'] = $row['calender_starts'] + ($row['calender_recur_rate'] * ceil(($day['start'] - $row['calender_starts']) / $row['calender_recur_rate']));
 								
-				if ($row['start_date'] > $day['end'])
+				if ($row['calender_starts'] > $day['end'])
 				{
 					continue;
 				}
 			}
 
-			$time = explode(':', $row['start_time']);
+			if ($row['calender_start_time'])
+			{
+				$temp_time = explode(':', $row['calender_start_time']);
 
-			$start_time = mktime($time[0], $time[1], 0, $date[0], $date[1], $date[2]);
-			$end_time = $start_time + $row['duration'];
+				$start_time = mktime($temp_time[0], $temp_time[1], 0, $date[0], $date[1], $date[2]);
+				$end_time = $start_time + $row['duration'];
+			}
+			else
+			{
+				$start_time = ($row['calender_starts'] > $day['start']) ? $day['start'] : $row['calender_starts'];
+				$end_time = $row['calender_expires'];
+			}
  
 			$_CLASS['core_template']->assign_vars_array($template_name, array(
-					'TITLE'			=> $row['title'],
-					'ID'			=> $row['id'],
-					'DESCRIPTION'	=> $row['description'],
-					'LINK'			=> generate_link("$link&amp;mode=details&amp;id=".$row['id']),
-					'START_TIME'	=> $_CLASS['core_user']->format_date($start_time, 'g:i A'),
-					'END_TIME'		=> $_CLASS['core_user']->format_date($end_time, 'g:i A'),
+					'TITLE'				=> $row['calender_title'],
+					'ID'				=> $row['calender_id'],
+					'DESCRIPTION'		=> $row['calender_text'],
+					'LINK'				=> generate_link("$link&amp;mode=details&amp;id=".$row['calender_id']),
+					'START_TIME'		=> $_CLASS['core_user']->format_date($start_time, 'g:i A'),
+					'END_TIME'			=> $_CLASS['core_user']->format_date($end_time, 'g:i A'),
 			));
 		}
 		$_CLASS['core_db']->free_result($result);
@@ -238,8 +254,8 @@
 		$month['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 
 		$sql = 'SELECT * FROM '. $this->table .'
-					WHERE start_date <= '. $month['end'] .' 
-					AND end_date >= '. $month['start'];
+					WHERE calender_starts <= '. $month['end'] .' 
+					AND calender_expires >= '. $month['start'];
 		
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -248,9 +264,9 @@
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			// Does time between start and end span more than one day ?
-			if (($row['end_date'] - $row['start_date']) >= 86400)
+			if (($row['calender_expires'] - $row['calender_starts']) >= 86400)
 			{
-				$days = $this->generate_days($row['start_date'], $row['end_date'], $month['start'], $month['end'],  $row['recur']);
+				$days = $this->generate_days($row['calender_starts'], $row['calender_expires'], $month['start'], $month['end'],  $row['calender_recur_rate']);
 
 				foreach ($days as $day => $null)
 				{
@@ -261,19 +277,20 @@
 						continue;
 					}
 		
-					$row['link']  = generate_link($link.'&amp;mode=details&amp;id='.$row['id']);
+					$row['calender_link']  = generate_link($link.'&amp;mode=details&amp;id='.$row['calender_id']);
 					$this->month_data_array[$day][] = $row;
 				}
 			}
 			else
 			{
-				$day = date('j', $row['start_date']) - 1;
+				$day = date('j', $row['calender_starts']) - 1;
+
 				if (count($this->month_data_array[$day]) >= $limit)
 				{
 					continue;
 				}
 	
-				$row['link']  = generate_link($link.'&amp;mode=details&amp;id='.$row['id']);
+				$row['calender_link']  = generate_link($link.'&amp;mode=details&amp;id='.$row['calender_id']);
 				$this->month_data_array[$day][] = $row;
 			}
 		}
@@ -281,46 +298,56 @@
 		$_CLASS['core_db']->free_result($result);		
 	}
 
-	function generate_days($start_time, $end_time, $start_date, $end_date, $recurring = 86400)
+	function generate_days($calender_start_time, $end_time, $calender_starts, $calender_expires, $calender_recur = 86400)
 	{
 		global $_CLASS;
 
 		// Never know how some versions may treat things, or what other people may do.
-		settype($start_time, 'integer');
-		settype($start_date, 'integer');
+		settype($calender_start_time, 'integer');
+		settype($calender_starts, 'integer');
 		settype($end_time, 'integer');
-		settype($end_date, 'integer');
+		settype($calender_expires, 'integer');
 
-		// we don't want useless loops if the recurrence less than 1 day
-		if (is_numeric($recurring))
+		$calender_recurring = false;
+
+		if (is_string($calender_recur) && in_array($calender_recur, 'everyday', 'every_other', 'weekly', 'monthly', 'years'))
 		{
-			$recurring = ($recurring > 86400) ? (int) $recurring : 86400;
+			Switch ($calender_recur)
+			{
+				Case 'weekly':
+					
+				Case 'monthly':
+			}
 		}
-// Add recurrence for months, years (maybe)..
-// Damit why couldn't there always be 31 days in a month :-(
+		
+		// we don't want useless loops if the calender_recurrence less than 1 day
+		if (!$calender_recurring)
+		{
+			$calender_recurring = ($calender_recurring > 86400) ? (int) $calender_recurring : 86400;
+		}
 
-		$end_time = ($end_time < $end_date) ? (int) $end_time : (int) $end_date;
+		$end_time = ($end_time < $calender_expires) ? (int) $end_time : (int) $calender_expires;
 
-		// Get the closest time to our start_date, if start_time is before that start_date
-		if ($start_time < $start_date)
+		// Get the closest time to our calender_starts, if calender_start_time is before that calender_starts
+		if ($calender_start_time < $calender_starts)
 		{
-			$start_time = $start_time + ($recurring * ceil(($start_date - $start_time) / $recurring));
+			$calender_start_time = $calender_start_time + ($calender_recurring * ceil(($calender_starts - $calender_start_time) / $calender_recurring));
 		}
 
-		// mainly a check for the above, since recurrence can be out of the start/end date range
-		if ($start_time > $end_date)
+		// mainly a check for the above, since calender_recurrence can be out of the start/end date range
+		if ($calender_start_time > $calender_expires)
 		{
 			return array(); //return empty array.
 		}
 
-		$loop_time = $start_time;
+		$loop_time = $calender_start_time;
 		$days = array();
 
 		While ($loop_time < $end_time)
 		{
 			$days[date('j', $loop_time)] = true;
 
-			$loop_time += $recurring;
+			$loop_time += $calender_recurring;
 		}
 		
 		return $days;
@@ -331,20 +358,33 @@
 		global $_CLASS;
 		
 		$sql = 'SELECT * FROM '. $this->table .'
-					WHERE id = '.$id;
+					WHERE calender_id = '.$id;
 					
 		$result = $_CLASS['core_db']->query($sql);
 		
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 		
-		$time = explode(':', $row['start_time']);
-		//echo $row['start_time'];
-// Needs fixing
-		$row['start_time'] = mktime($time[0], $time[1], 0, 0, 0, 2005);
-		//echo $row['start_time'];
-		$row['end_time'] = $row['start_time'] + $row['duration'];
+		if ($row['calender_start_time'])
+		{
+			if (!$time)
+			{
+				$time = mktime(12, 0, 0, $this->month, $this->day, $this->year);
+			}
+	
+			$date = explode(',', date('n,t,Y', $time));
 
+			$temp_time = explode(':', $row['calender_start_time']);
+
+			$row['start_time'] = mktime($temp_time[0], $temp_time[1], 0, $date[0], $date[1], $date[2]);
+			$row['end_time'] = $start_time + $row['duration'];
+		}
+		else
+		{
+			$row['start_time'] = $row['calender_starts'];
+			$row['end_time'] = $row['calender_expires'];
+		}
+
 		return $row;
 	}
 }

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/display/display.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -176,11 +176,12 @@
 
 		$this->header['js'][] = '<script type="text/javascript" src="javascript/common.js"></script>';
 		$this->header['js'][] = "<script type=\"text/javascript\">\nvar cms_session_id = '{$_CLASS['core_user']->data['session_id']}';\nvar cms_cookie_path = '{$_CORE_CONFIG['server']['cookie_path']}';\nvar cms_cookie_domain = '{$_CORE_CONFIG['server']['cookie_domain']}';\n</script>";
+		$this->header['meta'][] = '<base href="'.generate_base_url().'" />';
 
 		$_CLASS['core_template']->assign_array(array(
 			'SITE_LANG'			=>	$_CLASS['core_user']->lang['LANG'],
 			'SITE_TITLE'		=>	$_CORE_CONFIG['global']['site_name'].': '.(is_array($_CORE_MODULE['module_title']) ? implode(' &gt; ', $_CORE_MODULE['module_title']) : $_CORE_MODULE['module_title']),
-			'SITE_BASE'			=>	generate_base_url(),
+			'SITE_URL'			=>	generate_base_url(),
 			'SID'				=>	empty($_CLASS['core_user']->data['session_id']) ? '' : $_CLASS['core_user']->data['session_id'],
 			'SITE_NAME'			=>	$_CORE_CONFIG['global']['site_name'],
 			'HEADER_MESSAGE'	=>	$this->message,

Added: cms/trunk/includes/display/menu.php
===================================================================
--- cms/trunk/includes/display/menu.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/display/menu.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -0,0 +1,65 @@
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+class menu
+{
+
+	var $menu = '<script language="JavaScript" type="text/javascript">';
+	var $menuname = 'Menu';
+	var $options = '<script language="JavaScript" type="text/javascript">var AdminM =[';
+
+	var $mainopen = false;
+	function main($image='null', $name, $link ,$t2='null',$t3=false)
+	{
+		if ($this->mainopen)
+		{
+			$this->options .= "]\n";
+		}
+		$this->options .= "[null,'$name','$link',null,'Home Page',\n";
+
+	}
+	
+	function sub($image='null', $name, $link ,$t2='null',$t3=false)
+	{
+
+		$this->options .= "[null,'$name','$link',null,'Home Page'],\n";
+
+	}
+	
+	function menuarray($menu, $previous=false) {
+
+		foreach  ($menu as $name => $value)
+		{
+			if ($previous == $name)
+			{
+				$this->main($image='null', $name, $value ,$t2='null',$t3='null');
+			} else {
+			
+				if (is_array($value))
+				{
+					$this->menuarray($value, $name);
+				} else {
+					$this->sub($image='null', $name, $value ,$t2='null',$t3='null');
+				}
+			}
+		}
+		$this->options .= "],\n";
+	}
+	
+	function menuclose() {
+			$this->options = substr($this->options, 0, -2). ";\ncmDraw ('AdminMenu', AdminM, 'hbr', cmThemeOffice, 'ThemeOffice');
+</script>\n"; 
+	}
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/forums/auth.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -1,4 +1,4 @@
-<?php
+<?php
 /*
 ||**************************************************************||
 ||  Viperal CMS ?? :												||
@@ -19,335 +19,359 @@
 ||**************************************************************||
 
 $Id$
-*/
-
-// -------------------------------------------------------------
-//
-// COPYRIGHT : 2001, 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-//
-// -------------------------------------------------------------
-
-// Will be keeping my eye of 'other products' to ensure these things don't
-// mysteriously appear elsewhere, think up your own solutions!
-class auth
-{
-	var $founder = false;
-	var $acl = array();
-	var $option = array();
-	var $acl_options = array();
-
-	function acl(&$userdata)
-	{
-		global $_CLASS;
-
-		if (is_null($this->acl_options = $_CLASS['core_cache']->get('acl_options')))
-		{
-			$sql = 'SELECT auth_option, is_global, is_local
-				FROM ' . FORUMS_ACL_OPTIONS_TABLE . '
-				ORDER BY auth_option_id';
-			$result = $_CLASS['core_db']->query($sql);
-
-			$global = $local = 0;
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				if (!empty($row['is_global']))
-				{
-					$this->acl_options['global'][$row['auth_option']] = $global++;
-				}
-				if (!empty($row['is_local']))
-				{
-					$this->acl_options['local'][$row['auth_option']] = $local++;
-				}
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$_CLASS['core_cache']->put('acl_options', $this->acl_options);
-
-			$this->acl_clear_prefetch();
-			$this->acl_cache($userdata);
-		}
-		elseif (!trim($userdata['user_permissions']))
-		{
-			$this->acl_cache($userdata);
-		}
-
-		foreach (explode("\n", $userdata['user_permissions']) as $f => $seq)
-		{
-			if ($seq)
-			{
-				$i = 0;
-				while ($subseq = substr($seq, $i, 6))
-				{
-					if (!isset($this->acl[$f]))
-					{
-						$this->acl[$f] = '';
-					}
-					$this->acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
-					$i += 6;
-				}
-			}
-		}
-		return;
-	}
-
-	// Look up an option
-	function acl_get($opt, $f = 0)
-	{
-		static $cache;
-
-		if (!isset($cache[$f][$opt]))
-		{
-			$cache[$f][$opt] = false;
-			if (isset($this->acl_options['global'][$opt]))
-			{
-				if (isset($this->acl[0]))
-				{
-					$cache[$f][$opt] = $this->acl[0]{$this->acl_options['global'][$opt]};
-				}
-			}
-
-			if (isset($this->acl_options['local'][$opt]))
-			{
-				if (isset($this->acl[$f]))
-				{
-					$cache[$f][$opt] |= $this->acl[$f]{$this->acl_options['local'][$opt]};
-				}
-			}
-		}
-
-		return isset($cache[$f][$opt]) ? $cache[$f][$opt] : false;
-	}
-
-	function acl_getf($opt)
-	{
-		static $cache;
-
-		if (isset($this->acl_options['local'][$opt]))
-		{
-			foreach ($this->acl as $f => $bitstring)
-			{
-				if (!isset($cache[$f][$opt]))
-				{
-					$cache[$f][$opt] = false;
-
-					$cache[$f][$opt] = $bitstring{$this->acl_options['local'][$opt]};
-					if (isset($this->acl_options['global'][$opt]))
-					{
-						$cache[$f][$opt] |= $this->acl[0]{$this->acl_options['global'][$opt]};
-					}
-				}
-			}
-		}
-
-		return $cache;
-	}
-
-	function acl_gets($opts, $f = 0)
-	{
-		$acl = 0;
-
-		if (is_array($opts))
-		{
-			foreach ($opts as $opt)
-			{
-				$acl |= $this->acl_get($opt, $f);
-			}
-		}
-		else
-		{
-			$acl |= $this->acl_get($opts, $f);
-		}
-
-		return $acl;
-	}
-
-	function acl_get_list($user_id = false, $opts = false, $forum_id = false)
-	{
-		$hold_ary = $this->acl_raw_data($user_id, $opts, $forum_id);
-
-		$auth_ary = array();
-		foreach ($hold_ary as $user_id => $forum_ary)
-		{
-			foreach ($forum_ary as $forum_id => $auth_option_ary)
-			{
-				foreach ($auth_option_ary as $auth_option => $auth_setting)
-				{
-					if ($auth_setting == ACL_YES)
-					{
-						$auth_ary[$forum_id][$auth_option][] = $user_id;
-					}
-				}
-			}
-		}
-
-		return $auth_ary;
-	}
-
-	// Cache data
-	function acl_cache(&$userdata)
-	{
-		global $_CLASS;
-
-		$hold_ary = $this->acl_raw_data($userdata['user_id'], false, false);
-		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
-
-		$hold_str = '';
-		if (is_array($hold_ary))
-		{
-			ksort($hold_ary);
-
-			$last_f = 0;
-			foreach ($hold_ary as $f => $auth_ary)
-			{
-				$ary_key = (!$f) ? 'global' : 'local';
-
-				$bitstring = array();
-				foreach ($this->acl_options[$ary_key] as $opt => $id)
-				{
-					if (!empty($auth_ary[$opt]))
-					{
-						$bitstring[$id] = 1;
-
-						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
-						if (empty($holding[$this->acl_options[$ary_key][$option_key]]))
-						{
-							$bitstring[$this->acl_options[$ary_key][$option_key]] = 1;
-						}
-					}
-					else
-					{
-						$bitstring[$id] = 0;
-					}
-				}
-
-				$bitstring = implode('', $bitstring);
-
-				$hold_str .= str_repeat("\n", $f - $last_f);
-
-				for ($i = 0; $i < strlen($bitstring); $i += 31)
-				{
-					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
-				}
-
-				$last_f = $f;
-			}
-			unset($bitstring);
-
-			$userdata['user_permissions'] = rtrim($hold_str);
-
-			$sql = 'UPDATE ' . USERS_TABLE . "
-				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "'
-				WHERE user_id = " . $userdata['user_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-		unset($hold_ary);
-	}
-
-	function acl_raw_data($user_id = false, $opts = false, $forum_id = false)
-	{
-		global $_CLASS;
-
-		if (!$user_id)
-		{
-// not sure if that is needed anywhere. maybe add the others later...
-			return;
-		}
-
-		$sql_user = ($user_id) ? (is_array($user_id) ? 'user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
-		$sql_forum = ($forum_id) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
-		$sql_opts = ($opts) ? (is_array($opts) ? ' AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')' : "AND ao.auth_option = '".$_CLASS['core_db']->escape($opts)."'") : '';
-		$groups = $group_members = $hold_ary = array();
-
-		$sql = 'SELECT group_id, user_id FROM ' . USER_GROUP_TABLE ." WHERE $sql_user AND member_status <> ".STATUS_PENDING;
-// This is the why phpBB3 seems to be, the why they wanted it to act may have been the above.
-// atleast when you look at the coding....	
-		//$sql = 'SELECT group_id, user_id FROM ' . USERS_TABLE .' WHERE '.$sql_user;
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$groups[] = $row['group_id'];
-			$group_members[$row['group_id']][] = $row['user_id'];
-		}
-
-// make sure AND ( bla=blaa OR blaa2=baa2 ) works right with all databases
-		$sql_user = empty($groups) ? ' AND a.' . $sql_user :  'AND (a.'.$sql_user.' OR a.group_id IN ('.implode(', ', $groups).'))';
-
-		// Sort by group_id since we want user setting to over right grp..  specific > broad
-		$sql = 'SELECT ao.auth_option, a.user_id, a.group_id, a.forum_id, a.auth_setting
-					FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_OPTIONS_TABLE . " ao
-					WHERE a.auth_option_id = ao.auth_option_id 
-						$sql_user $sql_forum $sql_opts
-						ORDER BY a.group_id";
-
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			if ($row['auth_setting'] != ACL_YES)
-			{
-				continue;
-			}
-
-			if ($row['group_id'])
-			{
-				foreach ($group_members[$row['group_id']] as $user_id)
-				{
-					$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
-				}
-
-				continue;
-			}
-
-			$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
-		}
-//print_r($hold_ary);
-		return $hold_ary;
-	}
-
-	// Clear one or all users cached permission settings
-	function acl_clear_prefetch($user_id = false)
-	{
-		global $_CLASS;
-
-		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : " = $user_id") : '';
-
-		$sql = 'UPDATE ' . USERS_TABLE . "
-			SET user_permissions = ''
-			$where_sql";
-		$_CLASS['core_db']->query($sql);
-
-		return;
-	}
-
-	function acl_group_raw_data($group_id = false, $opts = false, $forum_id = false)
-	{
-		global $_CLASS;
-
-		$sql_group = ($group_id) ? ((!is_array($group_id)) ? "group_id = $group_id" : 'group_id IN (' . implode(', ', $group_id) . ')') : '';
-		$sql_forum = ($forum_id) ? ((!is_array($forum_id)) ? "AND a.forum_id = $forum_id" : 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')') : '';
-		$sql_opts = ($opts) ? ((!is_array($opts)) ? "AND ao.auth_option = '$opts'" : 'AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')') : '';
-
-		$hold_ary = array();
-
-		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
-		$sql = 'SELECT a.group_id, ao.auth_option, a.forum_id, a.auth_setting
-			FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_GROUPS_TABLE . ' a
-			WHERE ao.auth_option_id = a.auth_option_id
-				' . (($sql_group) ? 'AND a.' . $sql_group : '') . "
-				$sql_forum
-				$sql_opts
-			ORDER BY a.forum_id, ao.auth_option";
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		return $hold_ary;
-	}
-}
+*/
+
+// -------------------------------------------------------------
+//
+// COPYRIGHT : 2001, 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+//
+// -------------------------------------------------------------
+
+// Will be keeping my eye of 'other products' to ensure these things don't
+// mysteriously appear elsewhere, think up your own solutions!
+class auth
+{
+	var $founder = false;
+	var $acl = array();
+	var $option = array();
+	var $acl_options = array();
+
+	function acl(&$userdata)
+	{
+		global $_CLASS;
+
+		if (is_null($this->acl_options = $_CLASS['core_cache']->get('acl_options')))
+		{
+			$sql = 'SELECT auth_option, is_global, is_local
+				FROM ' . FORUMS_ACL_OPTIONS_TABLE . '
+				ORDER BY auth_option_id';
+			$result = $_CLASS['core_db']->query($sql);
+
+			$global = $local = 0;
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				if (!empty($row['is_global']))
+				{
+					$this->acl_options['global'][$row['auth_option']] = $global++;
+				}
+				if (!empty($row['is_local']))
+				{
+					$this->acl_options['local'][$row['auth_option']] = $local++;
+				}
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$_CLASS['core_cache']->put('acl_options', $this->acl_options);
+
+			$this->acl_clear_prefetch();
+			$this->acl_cache($userdata);
+		}
+		elseif (!trim($userdata['user_permissions']))
+		{
+			$this->acl_cache($userdata);
+		}
+
+		foreach (explode("\n", $userdata['user_permissions']) as $f => $seq)
+		{
+			if ($seq)
+			{
+				$i = 0;
+				while ($subseq = substr($seq, $i, 6))
+				{
+					if (!isset($this->acl[$f]))
+					{
+						$this->acl[$f] = '';
+					}
+					$this->acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
+					$i += 6;
+				}
+			}
+		}
+		return;
+	}
+
+	// Look up an option
+	function acl_get($opt, $f = 0)
+	{
+		static $cache;
+
+		if (!isset($cache[$f][$opt]))
+		{
+			$cache[$f][$opt] = false;
+			if (isset($this->acl_options['global'][$opt]))
+			{
+				if (isset($this->acl[0]))
+				{
+					$cache[$f][$opt] = $this->acl[0]{$this->acl_options['global'][$opt]};
+				}
+			}
+
+			if (isset($this->acl_options['local'][$opt]))
+			{
+				if (isset($this->acl[$f]))
+				{
+					$cache[$f][$opt] |= $this->acl[$f]{$this->acl_options['local'][$opt]};
+				}
+			}
+		}
+
+		return isset($cache[$f][$opt]) ? $cache[$f][$opt] : false;
+	}
+
+	function acl_getf($opt)
+	{
+		static $cache;
+
+		if (isset($this->acl_options['local'][$opt]))
+		{
+			foreach ($this->acl as $f => $bitstring)
+			{
+				if (!isset($cache[$f][$opt]))
+				{
+					$cache[$f][$opt] = false;
+
+					$cache[$f][$opt] = $bitstring{$this->acl_options['local'][$opt]};
+					if (isset($this->acl_options['global'][$opt]))
+					{
+						$cache[$f][$opt] |= $this->acl[0]{$this->acl_options['global'][$opt]};
+					}
+				}
+			}
+		}
+
+		return $cache;
+	}
+
+	function acl_gets($opts, $f = 0)
+	{
+		$acl = 0;
+
+		if (is_array($opts))
+		{
+			foreach ($opts as $opt)
+			{
+				$acl |= $this->acl_get($opt, $f);
+			}
+		}
+		else
+		{
+			$acl |= $this->acl_get($opts, $f);
+		}
+
+		return $acl;
+	}
+
+	function acl_get_list($user_id = false, $opts = false, $forum_id = false)
+	{
+		$hold_ary = $this->acl_raw_data($user_id, $opts, $forum_id);
+		
+		if (empty($hold_ary))
+		{
+			return array();
+		}
+
+		$auth_ary = array();
+
+		foreach ($hold_ary as $user_id => $forum_ary)
+		{
+			foreach ($forum_ary as $forum_id => $auth_option_ary)
+			{
+				foreach ($auth_option_ary as $auth_option => $auth_setting)
+				{
+					$auth_ary[$forum_id][$auth_option][] = $user_id;
+				}
+			}
+		}
+
+		return $auth_ary;
+	}
+
+	// Cache data
+	function acl_cache(&$userdata)
+	{
+		global $_CLASS;
+
+		$hold_ary = $this->acl_raw_data($userdata['user_id'], false, false);
+		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
+
+		$hold_str = '';
+		if (is_array($hold_ary))
+		{
+			ksort($hold_ary);
+
+			$last_f = 0;
+			foreach ($hold_ary as $f => $auth_ary)
+			{
+				$ary_key = (!$f) ? 'global' : 'local';
+
+				$bitstring = array();
+				foreach ($this->acl_options[$ary_key] as $opt => $id)
+				{
+					if (!empty($auth_ary[$opt]))
+					{
+						$bitstring[$id] = 1;
+
+						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
+						if (empty($holding[$this->acl_options[$ary_key][$option_key]]))
+						{
+							$bitstring[$this->acl_options[$ary_key][$option_key]] = 1;
+						}
+					}
+					else
+					{
+						$bitstring[$id] = 0;
+					}
+				}
+
+				$bitstring = implode('', $bitstring);
+
+				$hold_str .= str_repeat("\n", $f - $last_f);
+
+				for ($i = 0; $i < strlen($bitstring); $i += 31)
+				{
+					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
+				}
+
+				$last_f = $f;
+			}
+			unset($bitstring);
+
+			$userdata['user_permissions'] = rtrim($hold_str);
+
+			$sql = 'UPDATE ' . USERS_TABLE . "
+				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "'
+				WHERE user_id = " . $userdata['user_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+		unset($hold_ary);
+	}
+
+	function acl_raw_data($user_id = false, $opts = false, $forum_id = false)
+	{
+		global $_CLASS;
+
+		$sql_user = ($user_id) ? (is_array($user_id) ? 'user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
+		$sql_forum = ($forum_id) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
+		$sql_opts = ($opts) ? (is_array($opts) ? ' AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')' : "AND ao.auth_option = '".$_CLASS['core_db']->escape($opts)."'") : '';
+		$groups = $group_id_array = $group_members = $hold_ary = array();
+
+		if ($sql_user)
+		{
+			$sql = 'SELECT group_id, user_id FROM ' . USER_GROUP_TABLE ." WHERE $sql_user AND member_status <> ".STATUS_PENDING;
+
+			$result = $_CLASS['core_db']->query($sql);
+	
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$groups[] = $row['group_id'];
+				$group_members[$row['group_id']][] = $row['user_id'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$sql_user = empty($groups) ? ' AND a.' . $sql_user :  'AND (a.'.$sql_user.' OR a.group_id IN ('.implode(', ', $groups).'))';
+		}
+
+		// Sort by group_id since we want user setting to over right grp..  specific > broad
+		$sql = 'SELECT ao.auth_option, a.user_id, a.group_id, a.forum_id, a.auth_setting
+					FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_OPTIONS_TABLE . " ao
+					WHERE a.auth_option_id = ao.auth_option_id 
+						$sql_user $sql_forum $sql_opts
+						ORDER BY a.group_id";
+
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			if ($row['auth_setting'] != ACL_YES)
+			{
+				continue;
+			}
+
+			if ($row['group_id'])
+			{
+				$group_id_array[$row['group_id']] = $row;
+
+				continue;
+			}
+
+			$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		if (!empty($group_id_array))
+		{
+			if (empty($group_members))
+			{
+				$sql = 'SELECT user_group, user_id FROM ' . USERS_TABLE .' WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).') AND user_status = '.STATUS_ACTIVE;
+				$result = $_CLASS['core_db']->query($sql);
+	
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$group_members[$row['user_group']][] = $row['user_id'];
+				}
+				$_CLASS['core_db']->free_result($result);
+			}
+
+			foreach ($group_id_array as $group_id => $row)
+			{
+				if (empty($group_members[$group_id]))
+				{
+					continue;
+				}
+
+				foreach ($group_members[$group_id] as $user_id)
+				{
+					$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+				}
+			}
+		}
+
+		return $hold_ary;
+	}
+
+	// Clear one or all users cached permission settings
+	function acl_clear_prefetch($user_id = false)
+	{
+		global $_CLASS;
+
+		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : " = $user_id") : '';
+
+		$sql = 'UPDATE ' . USERS_TABLE . "
+			SET user_permissions = ''
+			$where_sql";
+		$_CLASS['core_db']->query($sql);
+
+		return;
+	}
+
+	function acl_group_raw_data($group_id = false, $opts = false, $forum_id = false)
+	{
+		global $_CLASS;
+
+		$sql_group = ($group_id) ? ((!is_array($group_id)) ? "group_id = $group_id" : 'group_id IN (' . implode(', ', $group_id) . ')') : '';
+		$sql_forum = ($forum_id) ? ((!is_array($forum_id)) ? "AND a.forum_id = $forum_id" : 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')') : '';
+		$sql_opts = ($opts) ? ((!is_array($opts)) ? "AND ao.auth_option = '$opts'" : 'AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')') : '';
+
+		$hold_ary = array();
+
+		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
+		$sql = 'SELECT a.group_id, ao.auth_option, a.forum_id, a.auth_setting
+			FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_GROUPS_TABLE . ' a
+			WHERE ao.auth_option_id = a.auth_option_id
+				' . (($sql_group) ? 'AND a.' . $sql_group : '') . "
+				$sql_forum
+				$sql_opts
+			ORDER BY a.forum_id, ao.auth_option";
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$hold_ary[$row['group_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		return $hold_ary;
+	}
+}
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/functions.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -374,18 +374,25 @@
 function generate_link($link = false, $link_options = false)
 {
 	global $_CLASS, $_CORE_MODULE;
+	//static $SEO = array('?', '&', '&amp;');
 
 	$options = array(
 		'admin'		=> false,
 		'full'		=> false,
 		'sid'		=> true,
-		'force_sid' => false
+		'force_sid' => false,
+		'seo'		=> true
 	);
 
 	if (is_array($link_options))
 	{
 		$options = array_merge($options, $link_options);
 	} 
+$options['seo'] = false;
+	if ($options['admin'])
+	{
+		$options['seo'] = false;
+	}
 
 	if ($link && strpos($link, '#'))
 	{
@@ -400,32 +407,47 @@
 
 	if (!$link)
 	{
-		$link = $file;
-
 		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
 		{
-			$link .= '?'.$_CLASS['core_user']->sid_link;
+			$options['seo'] = false;
+
+			$link = $file.'?'.$_CLASS['core_user']->sid_link;
 		}
+		else
+		{
+			$link = ($options['seo']) ? 'index' : $file;
+		}
 	}
 	else
 	{
+		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
+		{
+			$link .= '&amp;'.$_CLASS['core_user']->sid_link;
+		}
+
 		if ($link{0} == '&')
 		{
 			$link = $_CORE_MODULE['name'].$link;
 		}
 
-		$link = $file.'?mod='.$link;
-
-		if ($options['force_sid'] || ($options['sid'] && $_CLASS['core_user']->need_sid))
+		if (!$options['seo'])
 		{
-			$link .= '&amp;'.$_CLASS['core_user']->sid_link;
+			$link = $file.'?mod='.$link;
 		}
+		else
+		{
+			$link = str_replace(array('?', '&amp;', '&'), '/', $link);
+		}
     }
 
     if ($what_you_call_this)
     {
-		$link .= '#'.$what_you_call_this;
+		$link .= ($options['seo']) ? '.html#'.$what_you_call_this : '#'.$what_you_call_this;
 	}
+	elseif ($options['seo'])
+	{
+		$link .= '.html';
+	}
 
     return ($options['full']) ? generate_base_url().$link : $link;
 }

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/includes/session.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -55,7 +55,6 @@
 				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . " u
 				WHERE s.session_id = '" . $_CLASS['core_db']->escape($session_id) . "'
 					AND u.user_id = s.session_user_id";
-
 			$result = $_CLASS['core_db']->query($sql);
 
 			$this->data = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -83,7 +82,7 @@
 				if ($valid)
 				{
 					// Set session update a minute or so after last update or if page changes
-					if (($this->time - $this->data['session_time']) > 60 || ($this->data['session_url'] != $this->url))
+					if (($this->time - $this->data['session_time']) > 60 || ($this->data['session_url'] !== $this->url))
 					{
 						$this->save_session = true;
 					}
@@ -168,6 +167,30 @@
 			$this->session_destroy(false, false);
 		}
 
+		if ($this->is_bot)
+		{
+			$sql = 'SELECT u.*, s.*
+				FROM ' . SESSIONS_TABLE . ' s, ' . USERS_TABLE . ' u
+				WHERE s.session_user_id = '. (int) $this->data['user_id'] .'
+					AND u.user_id = s.session_user_id';
+
+			$result = $_CLASS['core_db']->query($sql);
+			$temp = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+			
+			if ($temp)
+			{
+				$this->data = $temp;
+
+				if (($this->time - $this->data['session_time']) > 60 || ($this->data['session_url'] !== $this->url))
+				{
+					$this->save_session = true;
+				}
+
+				return true;
+			}
+		}
+
 		$this->data['session_last_visit'] = ($this->data['user_last_visit']) ? $this->data['user_last_visit'] : $this->time;
 
 		$session_id = function_exists('sha1') ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true));

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_calender.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_calender.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_calender.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -4,8 +4,13 @@
 {
 	function ucp_calender($id, $mode)
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS, $table_prefix, $site_file_root;
 
+		if (!defined('CALENDER_TABLE'))
+		{
+			define('CALENDER_TABLE', $table_prefix.'calender');
+		}
+
 		$link = 'Control_Panel&amp;i='.$id;
 		
 		$day = get_variable('day', 'REQUEST', false, 'integer');
@@ -13,6 +18,7 @@
 		$year = get_variable('year', 'REQUEST', false, 'integer');
 		
 		load_class($site_file_root.'includes/display/calender.php', 'calender');
+		$_CLASS['calender']->table = CALENDER_TABLE;
 		$_CLASS['calender']->set_date($day, $month, $year);
 		
 		if (isset($_GET['mode']) && $_GET['mode'] == 'details')
@@ -34,7 +40,7 @@
 				$previous_month = generate_link($link.'&amp;mode=day_view&amp;year='.$month_flanks['previous_month']['year'].'&amp;month='.$month_flanks['previous_month']['month']);
 				$next_month = generate_link($link.'&amp;mode=day_view&amp;year='.$month_flanks['next_month']['year'].'&amp;month='.$month_flanks['next_month']['month']);
 				
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'L_SUNDAY'				=> $_CLASS['core_user']->lang['datetime']['Sun'],
 					'L_MONDAY'				=> $_CLASS['core_user']->lang['datetime']['Mon'],
 					'L_TUESDAY'				=> $_CLASS['core_user']->lang['datetime']['Tue'],
@@ -54,11 +60,15 @@
 			case 'add_event':
 				if (isset($_POST['submit']))
 				{
-					$this->add_event();
+					if ($this->add_event() === false)
+					{
+						echo implode('<br/>', $this->error);
+					}
+					
 					break;
 				}
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'S_UCP_ACTION'	=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"),
 				));
 
@@ -71,15 +81,14 @@
 				$data = false;
 				$data = $_CLASS['calender']->get_events_details($id);
 				
-				$_CLASS['core_template']->assign(array(
-					'CAL_TITLE'			=> $data['title'],
-					'CAL_DESCRIPTION'	=> $data['description'],
+				$_CLASS['core_template']->assign_array(array(
+					'CAL_TITLE'			=> $data['calender_title'],
+					'CAL_DESCRIPTION'	=> $data['calender_text'],
 					'CAL_START_TIME'	=> $_CLASS['core_user']->format_date($data['start_time']),
 					'CAL_END_TIME'		=> $_CLASS['core_user']->format_date($data['end_time']),
 				));
 			
-				$_CLASS['core_template']->display('modules/Control_Panel/ucp_calender_details.html');
-				$_CLASS['core_display']->display_footer();
+				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_details.html');
 			break;
 			
 			case 'month_view':
@@ -90,7 +99,7 @@
 
 				$month_flanks = $_CLASS['calender']->flank_months();
 
-				$_CLASS['core_template']->assign(array(
+				$_CLASS['core_template']->assign_array(array(
 					'L_SUNDAY'				=> $_CLASS['core_user']->lang['datetime']['Sunday'],
 					'L_MONDAY'				=> $_CLASS['core_user']->lang['datetime']['Monday'],
 					'L_TUESDAY'				=> $_CLASS['core_user']->lang['datetime']['Tuesday'],
@@ -120,41 +129,53 @@
 		global $_CLASS;
 
 		$data_array = array(
-			'title'			=> get_variable('title', 'POST', false),
-			'description'	=> get_variable('description', 'POST', false),
-			'note'			=> get_variable('note', 'POST', false),
-			'start_time'	=> get_variable('start', 'POST', false),
-			'end_time'		=> get_variable('end', 'POST', false),
-			'recur'			=> false,
+			'calender_title'	=> get_variable('title', 'POST', false),
+			'calender_text'		=> get_variable('description', 'POST', false),
+			'calender_notes'	=> get_variable('note', 'POST', false),
+			'calender_starts'	=> get_variable('start', 'POST', false),
+			'calender_expires'	=> get_variable('end', 'POST', false),
+			//'recur'			=> false,
 		);
 
-		$error = '';
+		$error = array();
 
-		if (($start_time = strtotime($data_array['start_time'])) === -1)
+		$start_time = strtotime($data_array['calender_starts']);
+
+		if (!$start_time || $start_time === -1)
 		{
-			$error .= $_CLASS['core_user']->get_lang('ERROR_START_TIME').'<br />';
+			$error[] = $_CLASS['core_user']->get_lang('ERROR_START_TIME');
 		}
 
-		if (($end_time = strtotime($data_array['end_time'])) === -1)
+		$end_time = strtotime($data_array['calender_expires']);
+
+		if (!$end_time || $end_time === -1)
 		{
-			$error .= $_CLASS['core_user']->get_lang('ERROR_END_TIME').'<br />';
+			$error[] = $_CLASS['core_user']->get_lang('ERROR_END_TIME');
 		}
 		
 		if (!$error && $start_time > $end_time)
 		{
-			$error .= $_CLASS['core_user']->get_lang('ERROR_').'<br />';
+			$error[] = $_CLASS['core_user']->get_lang('ERROR_');
 		}
 
-		if (!$error)
+		if (!empty($error))
 		{
-			//$duration = $start_time - $end_time;
-			//$start_time = $date = implode(''. explode(':', date('H:i', $start_time)));;
+			$this->error = $error;
 
-			$data_array['start_time'] = $data_array['start_date'] = $start_time;
-			$data_array['end_time'] = $data_array['end_date'] = $end_time;
-			
-			$_CLASS['core_db']->sql_query('INSERT INTO cms_calender ' . $_CLASS['core_db']->sql_build_array('INSERT', $data_array));
+			return false;
 		}
+
+		//$duration = $start_time - $end_time;
+		//$start_time = $date = implode(''. explode(':', date('H:i', $start_time)));;
+
+		$data_array['calender_starts'] = $start_time;
+		$data_array['calender_expires'] = $end_time;
+		
+		$_CLASS['core_db']->query('INSERT INTO ' . CALENDER_TABLE .' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data_array));
+
+		$data_array['calender_id'] = $_CLASS['core_db']->insert_id(CALENDER_TABLE, 'calender_id');
+
+		return $data_array;
 	}
 }
 

Modified: cms/trunk/modules/Members_List/index.php
===================================================================
--- cms/trunk/modules/Members_List/index.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/modules/Members_List/index.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -62,7 +62,8 @@
 // What do you want to do today? ... oops, I think that line is taken ...
 switch ($mode)
 {
-	case 'leaders':
+
+	case 'forum_leaders':
 		// Display a listing of board admins, moderators
 
 		$_CLASS['core_user']->add_lang('groups', 'Forums');
@@ -90,7 +91,7 @@
 		}
 
 		$sql = 'SELECT forum_id, forum_name 
-			FROM ' . FORUMS_TABLE . '
+			FROM ' . FORUMS_FORUMS_TABLE . '
 			WHERE forum_type = ' . FORUM_POST;
 		$result = $_CLASS['core_db']->query($sql);
 		
@@ -105,7 +106,7 @@
 			FROM ' . USERS_TABLE . ' u, ' . GROUPS_TABLE . ' g
 			LEFT JOIN ' . USER_GROUP_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')
 			WHERE u.user_id IN (' . implode(', ', $admin_id_ary + $mod_id_ary) . ')
-				AND u.group_id = g.group_id
+				AND u.user_group = g.group_id
 			ORDER BY g.group_name ASC, u.username ASC';
 		$result = $_CLASS['core_db']->query($sql);
 
@@ -158,7 +159,7 @@
 		$_CLASS['core_db']->free_result($result);
 
 		$_CLASS['core_template']->assign('PM_IMG', $_CLASS['core_user']->img('btn_pm', $_CLASS['core_user']->lang['MESSAGE']));
-		break;
+	break;
 
 	case 'contact':
 		$_CLASS['core_template']->assign_array(array(
@@ -305,6 +306,7 @@
 		if (!$member || (!$_CLASS['core_auth']->admin_power('users') && $member['user_status'] != STATUS_ACTIVE))
 		{
 			$_CLASS['core_db']->free_result($result);
+
 			trigger_error(($member) ? 'USER_INACTIVE' : 'NO_USER');
 		}
 		
@@ -334,55 +336,45 @@
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		$member['session_time'] = (isset($row['session_time'])) ? $row['session_time'] : 0;
+		$member['session_time'] = isset($row['session_time']) ? $row['session_time'] : 0;
 		unset($row);
 
+		$num_real_posts = $_CLASS['core_user']->data['user_posts'];
+
+		/*
 		// Obtain list of forums where this users post count is incremented
 		$auth2 = new auth();
 		$auth2->acl($member);
-		$f_postcount_ary = $auth2->acl_getf('f_postcount');
-
-		$sql_forums = array();
-		foreach ($f_postcount_ary as $forum_id => $allow)
+		
+		if ($permission_array = $auth2->acl_getf('f_postcount'))
 		{
-			if ($allow['f_postcount'])
-			{
-				$sql_forums[] = $forum_id;
-			}
-		}
+			$sql_forums = array_keys($permission_array);
 
-		$post_count_sql = (sizeof($sql_forums)) ? 'AND f.forum_id IN (' . implode(', ', $sql_forums) . ')' : '';
-		unset($sql_forums, $f_postcount_ary, $auth2);
+			// Grab all the relevant data
+			$sql = 'SELECT COUNT(*) AS num_posts
+				FROM ' . FORUMS_POSTS_TABLE . "
+					WHERE poster_id = $user_id
+					AND forum_id IN (" . implode(', ', $sql_forums) . ')';
 
-		// Grab all the relevant data
-		$sql = 'SELECT COUNT(p.post_id) AS num_posts
-			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . " f
-			WHERE p.poster_id = $user_id
-				AND f.forum_id = p.forum_id
-				$post_count_sql";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+	
+			$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $row['num_posts']);
 
-		$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $row['num_posts']);
+			unset($sql_forums, $permission_array, $auth2);
 
-		// Change post_count_sql to an forum_id array the user is able to see
-		$f_forum_ary = $_CLASS['auth']->acl_getf('f_read');
+		}		
+		$active_f_row = $active_t_row = array();
+		*/
 
-		$sql_forums = array();
-		foreach ($f_forum_ary as $forum_id => $allow)
+		// Change post_count_sql to an forum_id array the user is able to see
+		if ($permission_array = $_CLASS['auth']->acl_getf('f_read'))
 		{
-			if (isset($allow['f_read']) && $allow['f_read'])
-			{
-				$sql_forums[] = $forum_id;
-			}
-		}
-
-		$post_count_sql = (sizeof($sql_forums)) ? 'AND f.forum_id IN (' . implode(', ', $sql_forums) . ')' : '';
-		unset($sql_forums, $f_forum_ary);
-
-		if ($post_count_sql)
-		{
+			$sql_forums = array_keys($permission_array);
+	
+			$post_count_sql = 'AND f.forum_id IN (' . implode(', ', $sql_forums) . ')';
+	
 			$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts
 				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . " f
 				WHERE p.poster_id = $user_id
@@ -407,11 +399,9 @@
 
 			$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
 			$_CLASS['core_db']->free_result($result);
+	
+			unset($sql_forums, $permission_array, $post_count_sql);
 		}
-		else
-		{
-			$active_f_row = $active_t_row = array();
-		}
 
 		// Do the relevant calculations
 		$memberdays = max(1, round((time() - $member['user_reg_date']) / 86400));
@@ -1136,12 +1126,11 @@
 
 function show_profile($data)
 {
-	global $config, $_CORE_CONFIG, $_CLASS, $ranks, $SID;
+	global $config, $_CORE_CONFIG, $_CLASS;
 
-	$username = $data['username'];
 	$user_id = $data['user_id'];
+	$rank_title = $rank_img = '';
 
-	$rank_title = $rank_img = '';
 	get_user_rank($data['user_rank'], $data['user_posts'], $rank_title, $rank_img);
 	
 	if (!empty($data['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
@@ -1152,37 +1141,35 @@
 	{
 		$email = '';
 	}
-	
-	$last_visit = (!empty($data['session_time'])) ? $data['session_time'] : $data['user_last_visit'];
 
-	// Dump it out to the template
-	// TODO
-	// Add permission check for IM clients
+	$last_visit = ($data['session_time']) ? $data['session_time'] : $data['user_last_visit'];
+	$online = ($data['session_time'] >= ($_CLASS['core_user']->time - ($config['load_online_time'] * 60)));
+
 	return array(
-		'USERNAME'		=> $username,
-		'USER_COLOR'	=> (!empty($data['user_colour'])) ? $data['user_colour'] : '',
+		'USERNAME'		=> $data['username'],
+		'USER_COLOR'	=> ($data['user_colour']) ? $data['user_colour'] : '',
 		'RANK_TITLE'	=> $rank_title,
 
-		'JOINED'		=> $_CLASS['core_user']->format_date($data['user_reg_date'], $_CLASS['core_user']->lang['DATE_FORMAT']),
-		'VISITED'		=> (empty($last_visit)) ? ' - ' : $_CLASS['core_user']->format_date($last_visit, $_CLASS['core_user']->lang['DATE_FORMAT']),
+		'JOINED'		=> $_CLASS['core_user']->format_date($data['user_reg_date']),
+		'VISITED'		=> ($last_visit) ? ' - ' : $_CLASS['core_user']->format_date($last_visit),
 		'POSTS'			=> ($data['user_posts']) ? $data['user_posts'] : 0,
 
-		'ONLINE_IMG'	=> (intval($data['session_time']) >= time() - ($config['load_online_time'] * 60)) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['USER_ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['USER_ONLINE']),
+		'ONLINE_IMG'	=> ($online) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['USER_ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['USER_ONLINE']),
 		'RANK_IMG'		=> $rank_img,
-		'ICQ_STATUS_IMG'=> (!empty($data['user_icq'])) ? '<img src="http://web.icq.com/whitepages/online?icq=' . $data['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />' : '',
-		
+		'ICQ_STATUS_IMG'=> ($data['user_icq']) ? '<img src="http://web.icq.com/whitepages/online?icq=' . $data['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />' : '',
+
 		'U_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$user_id),
-		'U_SEARCH_USER'	=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($username) . '&amp;show_results=posts') : '',
+		'U_SEARCH_USER'	=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($data['username']) . '&amp;show_results=posts') : '',
 		'U_PM'			=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;u='.$user_id) : '',
 		'U_EMAIL'		=> $email,
-		'U_WWW'			=> (!empty($data['user_website'])) ? $data['user_website'] : '',
+		'U_WWW'			=> ($data['user_website']) ? $data['user_website'] : '',
 		'U_ICQ'			=> ($data['user_icq']) ? generate_link('Members_List&amp;mode=contact&amp;action=icq&amp;u='.$user_id) : '',
 		'U_AIM'			=> ($data['user_aim']) ? generate_link('Members_List&amp;mode=contact&amp;action=aim&amp;u='.$user_id) : '',
 		'U_YIM'			=> ($data['user_yim']) ? 'http://edit.yahoo.com/config/send_webmesg?.target=' . $data['user_yim'] . '&.src=pg' : '',
 		'U_MSN'			=> ($data['user_msnm']) ? generate_link('Members_List&amp;mode=contact&amp;action=msnm&amp;u='.$user_id) : '',
 		'U_JABBER'		=> ($data['user_jabber']) ? generate_link('Members_List&amp;mode=contact&amp;action=jabber&amp;u='.$user_id) : '',
 
-		'S_ONLINE'		=> (intval($data['session_time']) >= time() - 300) ? true : false
+		'S_ONLINE'		=> $online
 	);
 }
 

Added: cms/trunk/modules/calender/configurator.php
===================================================================
--- cms/trunk/modules/calender/configurator.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/modules/calender/configurator.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -0,0 +1,90 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $table_prefix;
+
+if (!defined('CALENDER_TABLE'))
+{
+	define('CALENDER_TABLE', $table_prefix.'calender');
+}
+
+class calender_configurator
+{
+	var $error = array();
+	
+	function install()
+	{
+		global $_CLASS;
+
+		$_CLASS['core_db']->table_create('start', CALENDER_TABLE);
+		
+		$_CLASS['core_db']->add_table_field_int('calender_id', array('max' => 16000000, 'auto_increment' => true));
+		$_CLASS['core_db']->add_table_field_char('calender_title', 80);
+		$_CLASS['core_db']->add_table_field_int('calender_starts', array('max' => 200000000));
+		$_CLASS['core_db']->add_table_field_int('calender_expires', array('max' => 200000000));
+		$_CLASS['core_db']->add_table_field_text('calender_text', 60000, true);
+		$_CLASS['core_db']->add_table_field_text('calender_notes', 60000, true);
+		$_CLASS['core_db']->add_table_field_char('calender_recur_rate', 80);
+		$_CLASS['core_db']->add_table_field_char('calender_start_time', 5, true);
+		$_CLASS['core_db']->add_table_field_int('calender_duration', array('max' => 200000000, 'null' => true));
+
+		$_CLASS['core_db']->add_table_index('calender_id', 'primary');
+		$_CLASS['core_db']->add_table_index('calender_starts');
+		$_CLASS['core_db']->add_table_index('calender_expires');
+
+		$_CLASS['core_db']->table_create('commit');
+
+		/*$array = array(
+			'articles_title'	=> 'Welcome Post',
+			'articles_posted'	=> (int) $_CLASS['core_user']->time,
+			'articles_text'		=> '<p align="center">I need something snappy here</p>',
+			'articles_order'	=> 1,
+			'articles_type'		=> 1,
+			'articles_status'	=> STATUS_ACTIVE,
+			'poster_id'			=> 0,
+			'poster_ip'			=> (string) ''
+		);*/
+
+		//$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' '. $_CLASS['core_db']->sql_build_array('INSERT', $array));
+
+		return true;
+	}
+
+	function uninstall()
+	{
+		global $_CLASS;
+
+		$_CLASS['core_db']->report_error(false);
+
+		$_CLASS['core_db']->query('DROP TABLE ' . CALENDER_TABLE);
+
+		$_CLASS['core_db']->report_error(true);
+	}
+}
+
+?>
\ No newline at end of file

Added: cms/trunk/modules/calender/index.php
===================================================================
--- cms/trunk/modules/calender/index.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/modules/calender/index.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -0,0 +1,130 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+if (!defined('CALENDER_TABLE'))
+{
+	define('CALENDER_TABLE', $table_prefix.'calender');
+}
+
+$_CLASS['core_user']->user_setup();
+$_CLASS['core_user']->add_lang();
+
+$mode = get_variable('mode', 'GET', false);
+
+$link = 'calender';
+
+$day = get_variable('day', 'REQUEST', false, 'integer');
+$month = get_variable('month', 'REQUEST', false, 'integer');
+$year = get_variable('year', 'REQUEST', false, 'integer');
+
+load_class(SITE_FILE_ROOT.'includes/display/calender.php', 'calender');
+
+$_CLASS['calender']->table = CALENDER_TABLE;
+$_CLASS['calender']->set_date($day, $month, $year);
+
+switch ($mode)
+{
+	case 'day_view':
+		$_CLASS['calender']->month_view($link);
+		$_CLASS['calender']->get_events_day($link);
+
+		$day_flanks = $_CLASS['calender']->flank_days();
+		$month_flanks = $_CLASS['calender']->flank_months();
+
+		$previous_day = generate_link($link.'&amp;mode=day_view&amp;year='.$day_flanks['previous_day']['year'].'&amp;month='.$day_flanks['previous_day']['month'].'&amp;day='.$day_flanks['previous_day']['day']);
+		$next_day = generate_link($link.'&amp;mode=day_view&amp;year='.$day_flanks['next_day']['year'].'&amp;month='.$day_flanks['next_day']['month'].'&amp;day='.$day_flanks['next_day']['day']);
+		$previous_month = generate_link($link.'&amp;mode=day_view&amp;year='.$month_flanks['previous_month']['year'].'&amp;month='.$month_flanks['previous_month']['month']);
+		$next_month = generate_link($link.'&amp;mode=day_view&amp;year='.$month_flanks['next_month']['year'].'&amp;month='.$month_flanks['next_month']['month']);
+		
+		$_CLASS['core_template']->assign_array(array(
+			'L_SUNDAY'				=> $_CLASS['core_user']->lang['datetime']['Sun'],
+			'L_MONDAY'				=> $_CLASS['core_user']->lang['datetime']['Mon'],
+			'L_TUESDAY'				=> $_CLASS['core_user']->lang['datetime']['Tue'],
+			'L_WEDNESDAY'			=> $_CLASS['core_user']->lang['datetime']['Wed'],
+			'L_THURSDAY'			=> $_CLASS['core_user']->lang['datetime']['Thu'],
+			'L_FRIDAY'				=> $_CLASS['core_user']->lang['datetime']['Fri'],
+			'L_SATURDAY'			=> $_CLASS['core_user']->lang['datetime']['Sat'],
+			'L_TODAY'				=> $_CLASS['core_user']->lang['datetime']['TODAY'],
+			'THIS_DAY'				=> date('F j, Y', mktime(0, 0, 0, $_CLASS['calender']->month, $_CLASS['calender']->day, $_CLASS['calender']->year)),
+			'PREVIOUS_DAY_LINK'		=> $previous_day,
+			'NEXT_DAY_LINK'			=> $next_day,
+		));
+
+		$_CLASS['core_display']->display(false, 'modules/calender/calender_day.html');
+	break;
+		
+	case 'details':
+	
+		$id = get_variable('id', 'GET', false, 'integer');
+		$data = false;
+		$data = $_CLASS['calender']->get_events_details($id);
+		
+		$_CLASS['core_template']->assign_array(array(
+			'CAL_TITLE'			=> $data['calender_title'],
+			'CAL_DESCRIPTION'	=> $data['calender_text'],
+			'CAL_START_TIME'	=> $_CLASS['core_user']->format_date($data['start_time']),
+			'CAL_END_TIME'		=> $_CLASS['core_user']->format_date($data['end_time']),
+		));
+	
+		$_CLASS['core_display']->display(false, 'modules/calender/calender_details.html');
+
+	break;
+	
+	case 'month_view':
+	default:
+		$_CLASS['calender']->get_events_month($link);
+		$_CLASS['calender']->month_view($link);
+
+		$month_flanks = $_CLASS['calender']->flank_months();
+
+		$_CLASS['core_template']->assign_array(array(
+			'L_SUNDAY'				=> $_CLASS['core_user']->lang['datetime']['Sunday'],
+			'L_MONDAY'				=> $_CLASS['core_user']->lang['datetime']['Monday'],
+			'L_TUESDAY'				=> $_CLASS['core_user']->lang['datetime']['Tuesday'],
+			'L_WEDNESDAY'			=> $_CLASS['core_user']->lang['datetime']['Wednesday'],
+			'L_THURSDAY'			=> $_CLASS['core_user']->lang['datetime']['Thursday'],
+			'L_FRIDAY'				=> $_CLASS['core_user']->lang['datetime']['Friday'],
+			'L_SATURDAY'			=> $_CLASS['core_user']->lang['datetime']['Saturday'],
+			'L_TODAY'				=> $_CLASS['core_user']->lang['datetime']['TODAY'],
+			
+			'THIS_MONTH_NAME'		=> $_CLASS['core_user']->lang['datetime'][date('F', mktime(0, 0, 0, $_CLASS['calender']->month, 1, $_CLASS['calender']->year))],
+			'NEXT_MONTH_NAME'		=> $_CLASS['core_user']->lang['datetime'][date('F', mktime(0, 0, 0, $month_flanks['next_month']['month'], 1, $_CLASS['calender']->year))],
+			'PREVIOUS_MONTH_NAME'	=> $_CLASS['core_user']->lang['datetime'][date('F', mktime(0, 0, 0, $month_flanks['previous_month']['month'], 1, $_CLASS['calender']->year))],
+			'NEXT_MONTH_YEAR'		=> $month_flanks['next_month']['year'],
+			'PREVIOUS_MONTH_YEAR'	=> $month_flanks['previous_month']['year'],
+			'CURRENT_YEAR'			=> $_CLASS['calender']->year,
+			'PREVIOUS_MONTH'		=> generate_link($link.'&amp;mode=month_view&amp;year='.$month_flanks['previous_month']['year'].'&amp;month='.$month_flanks['previous_month']['month']),
+			'NEXT_MONTH'			=> generate_link($link.'&amp;mode=month_view&amp;year='.$month_flanks['next_month']['year'].'&amp;month='.$month_flanks['next_month']['month']),
+		));
+
+		$_CLASS['core_display']->display(false, 'modules/calender/calender_main.html');
+
+	break;	
+}
+
+?>
\ No newline at end of file

Added: cms/trunk/modules/calender/language/en/index.php
===================================================================
--- cms/trunk/modules/calender/language/en/index.php	2005-09-20 05:07:35 UTC (rev 135)
+++ cms/trunk/modules/calender/language/en/index.php	2005-09-20 21:46:50 UTC (rev 136)
@@ -0,0 +1,488 @@
+<?php
+// -------------------------------------------------------------
+//
+// $Id: ucp.php,v 1.12 2004/06/06 21:44:49 acydburn Exp $
+//
+// FILENAME  : ucp.php [ English ]
+// STARTED   : Sat Dec 16, 2000
+// COPYRIGHT : ?? 2001, 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+// DEVELOPERS PLEASE NOTE 
+//
+// Placeholders can now contain order information, e.g. instead of
+// 'Page %s of %s' you can (and should) write 'Page %1$s of %2$s', this allows
+// translators to re-order the output of data while ensuring it remains correct
+//
+// You do not need this where single placeholders are used, e.g. 'Message %d' is fine
+// equally where a string contains only two placeholders which are used to wrap text
+// in a url you again do not need to specify an order e.g., 'Click %sHERE%s' is fine
+$this->lang += array(
+	'ACCOUNT_ACTIVE'			=> 'Your account has now been activated. Thank you for registering',
+	'ACCOUNT_ACTIVE_ADMIN'		=> 'The account has now been activated',
+	'ACCOUNT_ADDED'				=> 'Thank you for registering, your account has been created. You may now login with your username and password',
+	'ACCOUNT_COPPA'				=> 'Your account has been created but has to be approved, please check your email for details.',
+	'ACCOUNT_INACTIVE'			=> 'Your account has been created. However, this forum requires account activation, an activation key has been sent to the email address you provided. Please check your email for further information',
+	'ACCOUNT_INACTIVE_ADMIN'	=> 'Your account has been created. However, this forum requires account activation by the administrator. An email has been sent to them and you will be informed when your account has been activated',
+	'ACTIVATION_EMAIL_SENT'		=> 'The activation email has been sent to your email address',
+	
+	'ADD'						=> 'Add',
+	'ADD_BCC'					=> 'Add [Bcc]',
+	'ADD_FOES'					=> 'Add new foes',
+	'ADD_FOES_EXPLAIN'			=> 'You may enter several usernames each on a different line',
+	'ADD_FOLDER'				=> 'Add folder',
+	'ADD_FRIENDS'				=> 'Add new friends',
+	'ADD_FRIENDS_EXPLAIN'		=> 'You may enter several usernames each on a different line',
+	'ADD_NEW_RULE'				=> 'Add new Rule',
+	'ADD_RULE'					=> 'Add Rule',
+	'ADD_TO'					=> 'Add [To]',
+	'ADMIN_EMAIL'				=> 'Administrators can email me information',
+	'AGREE'						=> 'I agree to these terms',
+	'ALLOW_PM'					=> 'Allow users to send you private messages',
+	'ALLOW_PM_EXPLAIN'			=> 'Note that admins and moderators will always be able to send you messages.',
+	'ALREADY_ACTIVATED'			=> 'You have already activated your account',
+	'ATTACHMENTS_DELETED'		=> 'Attachments successfully deleted',
+	'ATTACHMENT_DELETED'		=> 'Attachment successfully deleted',
+	'AVATAR_CATEGORY'			=> 'Category',
+	'AVATAR_EXPLAIN'			=> 'Maximum dimensions; width %1$d pixels, height %2$d pixels, filesize %3$dkB.',
+	'AVATAR_GALLERY'			=> 'Local gallery',
+	'AVATAR_PAGE'				=> 'Page',
+
+	'BACK_TO_DRAFTS'			=> 'Back to saved drafts',
+	'BIRTHDAY'					=> 'Birthday',
+	'BIRTHDAY_EXPLAIN'			=> 'Setting a year will list your age when it is your birthday.',
+	'BOARD_DATE_FORMAT'			=> 'My date format',
+	'BOARD_DATE_FORMAT_EXPLAIN'	=> 'The syntax used is identical to the PHP <a href="http://www.php.net/date" target="_other">date()</a> function',
+	'BOARD_DST'					=> 'Daylight Saving Time is in effect',
+	'BOARD_LANGUAGE'			=> 'My language',
+	'BOARD_STYLE'				=> 'My board style',
+	'BOARD_TIMEZONE'			=> 'My timezone',
+	'BOOKMARKS'					=> 'Bookmarks',
+	'BOOKMARKS_FORUMS'			=> 'Bookmarks ( Forums )',
+	'BOOKMARKS_SITE'			=> 'Bookmarks ( Site )',
+	'BOOKMARKS_DISABLED'		=> 'Bookmarks are disabled on this board',
+	'BOOKMARKS_REMOVED'			=> 'Bookmarks removed successfully',
+
+	'CANNOT_EDIT_MESSAGE_TIME'	=> 'You can no longer edit or delete that message',
+	'CANNOT_MOVE_TO_SAME_FOLDER'=> 'Messages can not be moved to the folder you want to remove.',
+	'CANNOT_RENAME_FOLDER'		=> 'This folder can not be renamed.',
+	'CANNOT_REMOVE_FOLDER'		=> 'This folder can not be removed.',
+	'CHANGE_PASSWORD'			=> 'Change password',
+	'CHANGE_PASSWORD_EXPLAIN'	=> 'Must be between %1$d and %2$d characters.',
+	'CLICK_RETURN_FOLDER'		=> 'Click %1$sHere%2$s to return to your "%3$s" Folder',
+	'CONFIRMATION'				=> 'Confirmation of registration',
+	'CONFIRM_CODE'				=> 'Confirmation code',
+	'CONFIRM_CODE_EXPLAIN'		=> 'Enter the code exactly as you see it in the image, it is case sensitive, zero has a diagonal line through it.',
+	'CONFIRM_CODE_WRONG'		=> 'The confirmation code you entered was incorrect.',
+	'CONFIRM_EMAIL'				=> 'Confirm email address',
+	'CONFIRM_EMAIL_EXPLAIN'		=> 'You only need to specify this if you are changing your email address.',
+	'CONFIRM_EXPLAIN'			=> 'To prevent automated registrations the board administrator requires you to enter a confirmation code. The code is displayed in the image you should see below. If you are visually impaired or cannot otherwise read this code please contact the %sBoard Administrator%s.',
+	'CONFIRM_PASSWORD'			=> 'Confirm password',
+	'CONFIRM_PASSWORD_EXPLAIN'	=> 'You only need to confirm your password if you changed it above',
+	'COPPA_BIRTHDAY'			=> 'To continue with the registration procedure please tell us when you were born.',
+	'COPPA_COMPLIANCE'			=> 'COPPA Compliance',
+	'COPPA_EXPLAIN'				=> 'Please note that clicking submit will create your account. However it cannot be activated until a parent or guardian approves your registration. You will be emailed a copy of the necessary form with details of where to send it.',
+	'CREATE_FOLDER'				=> 'Add Folder...',
+	'CURRENT_IMAGE'				=> 'Current Image',
+	'CURRENT_PASSWORD'			=> 'Current password',
+	'CURRENT_PASSWORD_EXPLAIN'	=> 'You must confirm your current password if you wish to change it, alter your email address or username.',
+	'CUR_PASSWORD_ERROR'		=> 'The current password you entered is incorrect.',
+
+	'DEFAULT_ACTION'			=> 'Default Action',
+	'DEFAULT_ACTION_EXPLAIN'	=> 'This Action will be triggered if none of the above is applicable',
+	'DEFAULT_ADD_SIG'			=> 'Attach my signature by default',
+	'DEFAULT_BBCODE'			=> 'Enable BBCode by default',
+	'DEFAULT_HTML'				=> 'Enable HTML by default',
+	'DEFAULT_NOTIFY'			=> 'Notify me upon replies by default',
+	'DEFAULT_SMILIES'			=> 'Enable smilies by default',
+	'DEFINED_RULES'				=> 'Defined Rules',
+	'DELETE_ALL'				=> 'Delete all',
+	'DELETE_ATTACHMENT'			=> 'Delete Attachment',
+	'DELETE_ATTACHMENTS'		=> 'Delete Attachments',
+	'DELETE_ATTACHMENT_CONFIRM'	=> 'Are you sure you want to delete this attachment?',
+	'DELETE_ATTACHMENTS_CONFIRM'=> 'Are you sure you want to delete these attachments?',
+	'DELETE_AVATAR'				=> 'Delete Image',
+	'DELETE_COOKIES_CONFIRM'	=> 'Are you sure you want to delete all cookies set by this board?',
+	'DELETE_MARKED_PM'			=> 'Delete Marked Messages',
+	'DELETE_MARKED_PM_CONFIRM'	=> 'Are you sure you want to delete all marked messages?',
+	'DELETE_OLDEST_MESSAGES'	=> 'Delete Oldest Messages',
+	'DELETE_MESSAGE'			=> 'Delete Message',
+	'DELETE_MESSAGE_CONFIRM'	=> 'Are you sure you want to delete this private message?',
+	'DELETE_MESSAGES_IN_FOLDER'	=> 'Delete all messages within removed folder',
+	'DELETE_RULE'				=> 'Delete Rule',
+	'DELETE_RULE_CONFIRM'		=> 'Are you sure you want to delete this rule?',
+	'DISABLE_CENSORS'			=> 'Enable Word censoring',
+	'DISPLAY_GALLERY'			=> 'Display gallery',
+	'DOWNLOADS'					=> 'Downloads',
+	'DRAFTS_DELETED'			=> 'All selected drafts were successfully deleted.',
+	'DRAFTS_EXPLAIN'			=> 'Here you can view, edit and delete your saved drafts.',
+	'DRAFT_UPDATED'				=> 'Draft successfully updated.',
+
+	'EDIT_DRAFT_EXPLAIN'		=> 'Here you are able to edit your draft. Drafts do not contain attachment and poll informations.',
+	'EMAIL_INVALID_EMAIL'		=> 'The email address you entered is invalid.',
+	'EMAIL_REMIND'				=> 'This must be the email address you supplied when registering.',
+	'EMAIL_PM'					=> 'Email PM',
+	'EMAIL_TAKEN_EMAIL'			=> 'The entered email address is already in use',
+	'EMPTY_DRAFT'				=> 'You must enter a message to submit your changes',
+	'EMPTY_DRAFT_TITLE'			=> 'You must enter a draft title',
+	'EXPORT_AS_XML'				=> 'Export as XML',
+	'EXPORT_AS_CSV'				=> 'Export as CSV',
+	'EXPORT_AS_TXT'				=> 'Export as TXT',
+	'EXPORT_AS_MSG'				=> 'Export as MSG',
+
+	'FIELD_REQUIRED'			=> 'The field "%s" must be completed.',
+	'FIELD_TOO_SHORT'			=> 'The field "%1$s" is too short, a minimum of %2$d characters is required.',
+	'FIELD_TOO_LONG'			=> 'The field "%1$s" is too long, a maximum of %2$d characters is allowed.',
+	'FIELD_TOO_SMALL'			=> 'The value of "%1$s" is too small, a minimum value of %2$d is required.',
+	'FIELD_TOO_LARGE'			=> 'The value of "%1$s" is too large, a maximum value of %2$d is allowed.',
+	'FIELD_INVALID_CHARS_NUMBERS_ONLY'	=> 'The field "%s" has invalid characters, only numbers are allowed.',
+	'FIELD_INVALID_CHARS_ALPHA_ONLY'	=> 'The field "%s" has invalid characters, only alphanumeric characters are allowed.',
+	'FIELD_INVALID_CHARS_SPACERS_ONLY'	=> 'The field "%s" has invalid characters, only alphanumeric, space or -+_[] characters are allowed.',
+	'FIELD_INVALID_DATE'		=> 'The field "%s" has an invalid date.',
+
+	'FOE_MESSAGE'				=> 'Message from foe',
+	'FOES_EXPLAIN'				=> 'Foes are users which will be ignored by default. Posts by these users will not be fully visible and personal messages will not be permitted. Please note that you cannot ignore moderators or administrators.',
+	'FOES_UPDATED'				=> 'Your foes list has been updated successfully',
+	'FOLDER_ADDED'				=> 'Folder successfully added',
+	'FOLDER_MESSAGE_STATUS'		=> '%1$d from %2$d messages stored',
+	'FOLDER_NAME_EXIST'			=> 'Folder <b>%s</b> already exist',
+	'FOLDER_OPTIONS'			=> 'Folder Options',
+	'FOLDER_RENAMED'			=> 'Folder successfully renamed',
+	'FOLDER_REMOVED'			=> 'Folder successfully removed',
+	'FOLDER_STATUS_MSG'			=> 'Folder is %1$d%% full (%2$d from %3$d messages stored)',
+	'FORWARD_PM'				=> 'Forward PM',
+	'FRIEND_MESSAGE'			=> 'Message from friend',
+	'FRIENDS'					=> 'Friends',
+	'FRIENDS_EXPLAIN'			=> 'Friends enable you quick access to members you communicate with frequently. If the template has relevant support any posts made by a friend may be highlighted.',
+	'FRIENDS_OFFLINE'			=> 'Offline',
+	'FRIENDS_ONLINE'			=> 'Online',
+	'FRIENDS_UPDATED'			=> 'Your friends list has been updated successfully',
+	'FULL_FOLDER_OPTION_CHANGED'=> 'Full Folder Option changed successfully',
+	'FWD_ORIGINAL_MESSAGE'		=> '-------- Original Message --------',
+	'FWD_SUBJECT'				=> 'Subject: %s',
+	'FWD_DATE'					=> 'Date: %s',
+	'FWD_FROM'					=> 'From: %s',
+	'FWD_TO'					=> 'To: %s',
+
+	'HIDE_ONLINE'				=> 'Hide my online status',
+	'HOLD_NEW_MESSAGES'			=> 'Do not accept new messages (New messages will be held back until enough space is available)',
+
+	'IF_FOLDER_FULL'			=> 'If Folder Full',
+	'IMPORTANT_NEWS'			=> 'Important announcements',
+
+	'LANGUAGE'					=> 'Language',
+	'LINK_REMOTE_AVATAR'		=> 'Link off-site',
+	'LINK_REMOTE_AVATAR_EXPLAIN'=> 'Enter the URL of the location containing the Avatar image you wish to link to.',
+	'LINK_REMOTE_SIZE'			=> 'Avatar dimensions',
+	'LINK_REMOTE_SIZE_EXPLAIN'	=> 'Specify the width and height of the avatar, leave blank to attempt automatic verification.',
+	'LOGIN_EXPLAIN_UCP'			=> 'Please Login in order to access the User Control Panel',
+	'LOGIN_REDIRECT'			=> 'You have been successfully logged in.',
+	'LOGOUT_REDIRECT'			=> 'You have been successfully logged out.',
+
+	'MARK_IMPORTANT'			=> 'Mark as Important',
+	'MARKED_MESSAGE'			=> 'Marked Message',
+	'MAX_FOLDER_REACHED'		=> 'Maximum number of allowed user defined folder reached',
+	'MESSAGE_COLOURS'			=> 'Message Colours',
+	'MESSAGE_DELETED'			=> 'Message successfully deleted',
+	'MESSAGE_HISTORY'			=> 'Message History',
+	'MESSAGE_REMOVED_FROM_OUTBOX'	=> 'This message has been removed by it\'s author before it was delivered',
+	'MESSAGE_REPORTED'			=> 'Click to view reports',
+	'MESSAGE_REPORTED_MESSAGE'	=> 'Reported Message',
+	'MESSAGE_STORED'			=> 'The message has been send successfully',
+	'MESSAGES_DELETED'			=> 'Messages successfully deleted',
+	'MOVE_DELETED_MESSAGES_TO'	=> 'Move messages from removed folder to',
+	'MOVE_DOWN'					=> 'Move down',
+	'MOVE_PM_ERROR'				=> 'An error occurred while moving the messages to the new folder, only %1d from %2d messages were moved.',
+	'MOVE_TO_FOLDER'			=> 'Move to Folder',
+	'MOVE_UP'					=> 'Move up',
+
+	'NEW_EMAIL_ERROR'			=> 'The email addresses you entered do not match.',
+	'NEW_FOLDER_NAME'			=> 'New folder name',
+	'NEW_PASSWORD'				=> 'Password',
+	'NEW_PASSWORD_ERROR'		=> 'The passwords you entered do not match.',
+	'NEW_PASSWORD_EXPLAIN'		=> 'Must be between %1$d and %2$d characters.',
+	'MINIMUM_KARMA'				=> 'Minimum User Karma',
+	'MINIMUM_KARMA_EXPLAIN'		=> 'Posts by users with Karma less than this will be ignored.',
+	'NOTIFY_METHOD'				=> 'Notification method',
+	'NOTIFY_METHOD_BOTH'		=> 'Both',
+	'NOTIFY_METHOD_EMAIL'		=> 'Email only',
+	'NOTIFY_METHOD_EXPLAIN'		=> 'Method for sending messages sent via this board.',
+	'NOTIFY_METHOD_IM'			=> 'Jabber only',
+	'NOTIFY_ON_PM'				=> 'Email me on new private messages',
+	'NOT_ADDED_FOES'			=> 'Usernames not added to foes list because of administrator/moderator status.',
+	'NOT_AGREE'					=> 'I do not agree to these terms',
+	'NOT_ENOUGH_SPACE_FOLDER'	=> 'The Destination Folder "%s" seems to be full. The requested action has not been taken.',
+	'NOT_MOVED_MESSAGE'			=> 'You have 1 private message currently on hold because of full folder.',
+	'NOT_MOVED_MESSAGES'		=> 'You have %d private messages currently on hold because of full folder.',
+	'NO_ACTION_MODE'			=> 'No message action specified',
+	'NO_AUTHOR'					=> 'No author defined for this message',
+	
+	'NO_AUTH_DELETE_MESSAGE'	=> 'You are not authorized to delete private messages.',
+	'NO_AUTH_EDIT_MESSAGE'		=> 'You are not authorized to edit private messages.',
+	'NO_AUTH_FORWARD_MESSAGE'	=> 'You are not authorized to forward private messages.',
+	'NO_AUTH_GROUP_MESSAGE'		=> 'You are not authorized to send private messages to groups.',
+	'NO_AUTH_READ_MESSAGE'		=> 'You are not authorized to read private messages.',
+	'NO_AUTH_READ_REMOVED_MESSAGE'	=> 'You are not able to read this message because it was removed by the author.',
+	'NO_AUTH_SEND_MESSAGE'		=> 'You are not authorized sending private messages.',
+	'NO_AUTH_SIGNATURE'			=> 'You are not authorized to define a signature',
+
+	'NO_BOOKMARKS'				=> 'You have no bookmarks',
+	'NO_BOOKMARKS_SELECTED'		=> 'You have selected no bookmarks',
+	'NO_EMAIL_USER'				=> 'The email/username information submitted could not be found',
+	'NO_FOES'					=> 'No foes currently defined',
+	'NO_FRIENDS'				=> 'No friends currently defined',
+	'NO_FRIENDS_OFFLINE'		=> 'No friends offline',
+	'NO_FRIENDS_ONLINE'			=> 'No friends online',
+	'NO_IMPORTANT_NEWS'			=> 'No important announcements present',
+	'NO_MESSAGE'				=> 'Private Message could not be found',
+	'NO_NEW_FOLDER_NAME'		=> 'You have to specify a new folder name',
+	'NO_NEWER_PM'				=> 'No newer messages',
+	'NO_OLDER_PM'				=> 'No older messages',
+	'NO_RECIPIENT'				=> 'No recipient defined',
+	'NO_RULES_DEFINED'			=> 'No rules defined',
+	'NO_SAVED_DRAFTS'			=> 'No drafts saved',
+	'NO_WATCHED_FORUMS'			=> 'You are not watching any forums.',
+	'NO_WATCHED_TOPICS'			=> 'You are not watching any topics.',
+
+	'PASSWORD_ACTIVATED'		=> 'Your new password has been activated',
+	'PASSWORD_UPDATED'			=> 'Your password has been sent successfully to your original email address.',
+	'PM_DISABLED'				=> 'Private messaging has been disabled on this board',
+	'PM_FROM'					=> 'From',
+	'PM_ICON'					=> 'PM Icon',
+	'PM_INBOX'					=> 'Inbox',
+	'PM_OUTBOX'					=> 'Outbox',
+	'PM_SENTBOX'				=> 'Sentbox',
+	'PM_SUBJECT'				=> 'Message Subject',
+	'PM_TO'						=> 'Send To',
+	'POPUP_ON_PM'				=> 'Pop up window on new private message',
+	'POST_EDIT_PM'				=> 'Edit message',
+	'POST_FORWARD_PM'			=> 'Forward message',
+	'POST_NEW_PM'				=> 'Post message',
+	'POST_PM_LOCKED'			=> 'Private Messaging is locked',
+	'POST_QUOTE_PM'				=> 'Quote message',
+	'POST_REPLY_PM'				=> 'Reply to message',
+	'PRINT_PM'					=> 'Print View',
+	'PREFERENCES_UPDATED'		=> 'Your preferences have been updated.',
+	'PROFILE_INFO_NOTICE'		=> 'Please note that this information will be viewable to other members. Be careful when including any personal details. Any fields marked with a * must be completed.',
+	'PROFILE_UPDATED'			=> 'Your profile has been updated.',
+
+	'RECIPIENT'					=> 'Recipient',
+	'RECIPIENTS'				=> 'Recipients',
+	'REGISTRATION'				=> 'Registration',
+	'RELEASE_MESSAGES'			=> 'Click %sHere%s to release the on-hold messages, they will be re-sorted into the appropiate folder if enough space is made available.',
+	'REMOVE_ADDRESS'			=> 'Remove address',
+	'REMOVE_SELECTED_BOOKMARKS'	=> 'Remove selected bookmarks',
+	'REMOVE_SELECTED_BOOKMARKS_CONFIRM' => 'Are you sure you want to delete all selected bookmarks?',
+	'REMOVE_BOOKMARK_MARKED'	=> 'Remove marked bookmarks',
+	'REMOVE_FOLDER'				=> 'Remove folder',
+	'REMOVE_FOLDER_CONFIRM'		=> 'Are you sure you want to remove this folder?',
+	'RENAME'					=> 'Rename',
+	'RENAME_FOLDER'				=> 'Rename folder',
+	'REPLIED_MESSAGE'			=> 'Replied to Message',
+	'REPORT_PM'					=> 'Report PM',
+	'REPORT_PM_NOTIFY'			=> 'Send report notifications as PM',
+	'REPORT_PM_NOTIFY_EXPLAIN'	=> 'If enabled, notifications and status updates to new reports get send as PM instead of emailing them.',
+	'RETURN_FOLDER'				=> 'Click %1$sHere%2$s to return to folder',
+	'RETURN_UCP'				=> 'Click %sHere%s to return to the User Control Panel',
+	'RULE_ADDED'				=> 'Rule successfully added',
+	'RULE_ALREADY_DEFINED'		=> 'This rule was defined previously',
+	'RULE_DELETED'				=> 'Rule successfully removed',
+	'RULE_NOT_DEFINED'			=> 'Rule not correctly specified',
+
+	'SEARCH_YOUR_POSTS'			=> 'Show your posts',
+	'SEND_PASSWORD'				=> 'Send password',
+	'SENT_AT'					=> 'Sent At',
+	'SHOW_EMAIL'				=> 'Users can contact me by email',
+	'SIGNATURE_EXPLAIN'			=> 'This is a block of text that can be added to posts you make. There is a %d character limit',
+	'SIGNATURE_PREVIEW'			=> 'Your signature will appear like this in posts',
+	'SIGNATURE_TOO_LONG'		=> 'Your signature is too long.',
+	'SORT'						=> 'Sort',
+	'SORT_COMMENT'				=> 'File Comment',
+	'SORT_DOWNLOADS'			=> 'Downloads',
+	'SORT_EXTENSION'			=> 'Extension',
+	'SORT_FILENAME'				=> 'Filename',
+	'SORT_POST_TIME'			=> 'Post Time',
+	'SORT_SIZE'					=> 'Filesize',
+
+	'TERMS_OF_USE_CONTENT'		=> 'While the administrators and moderators of this forum will attempt to remove or edit any generally objectionable material as quickly as possible, it is impossible to review every message. Therefore you acknowledge that all posts made to these forums express the views and opinions of the author and not the administrators, moderators or webmaster (except for posts by these people) and hence will not be held liable.<br /><br />You agree not to post any abusive, obscene, vulgar, slanderous, hateful, threatening, sexually-orientated or any other material that may violate any applicable laws. Doing so may lead to you being immediately and permanently banned (and your service provider being informed). The IP address of all posts is recorded to aid in enforcing these conditions. You agree that the webmaster, administrator and moderators of this forum have the right to remove, edit, move or close any topic at any time should they see fit. As a user you a!
 gree to any information you	have entered above being stored in a database. While this information will not be disclosed to any third party without your consent the webmaster, administrator and moderators cannot be held responsible for any hacking attempt that may lead to the data being compromised.<br /><br />This forum system uses cookies to store information on your local computer. These cookies do not contain any of the information you have entered above, they serve only to improve your viewing pleasure. The email address is used only for confirming your registration details and password (and for sending new passwords should you forget your current one).<br /><br />By clicking Register below you agree to be bound by these conditions.',
+	'TIMEZONE'					=> 'Timezone',
+	'TO'						=> 'To',
+	'TOO_MANY_RECIPIENTS'		=> 'Too many recipients',
+	'TOO_MANY_REGISTERS'		=> 'You have exceeded the maximum number of registration attempts for this session. Please try again later.',
+
+	'UCP'						=> 'User Control Panel',
+	'UCP_ADMIN_ACTIVATE'		=> 'Please note that you will need to enter a valid email address before your account is activated. The administrator will review your account and if approved you will an email at the address you specified.',
+	'UCP_AIM'					=> 'AOL Instant Messenger',
+	'UCP_ATTACHMENTS'			=> 'Attachments',
+	'UCP_CALENDER_DAY_VIEW'		=> 'Day Details',
+	'UCP_CALENDER_MANAGE'		=> 'Manage',
+	'UCP_CALENDER_MONTH_VIEW'	=> 'Month View',
+	'UCP_COPPA_BEFORE'			=> 'Before %s',
+	'UCP_COPPA_ON_AFTER'		=> 'On or After %s',
+	'UCP_EMAIL_ACTIVATE'		=> 'Please note that you will need to enter a valid email address before your account is activated. You will recieve an email at the address you provide that contains an account activation link.',
+	'UCP_ICQ'					=> 'ICQ Number',
+	'UCP_JABBER'				=> 'Jabber Address',
+	
+	'UCP_MAIN'					=> 'Overview',
+	'UCP_MAIN_BOOKMARKS'		=> 'Bookmarks',
+	'UCP_MAIN_DRAFTS'			=> 'Saved drafts',
+	'UCP_MAIN_FRONT'			=> 'Front page',
+	'UCP_MAIN_SUBSCRIBED'		=> 'Subscribed',
+	
+	'UCP_MSNM'					=> 'MSN Messenger',
+	'UCP_NO_ATTACHMENTS'		=> 'You have posted no files',
+	
+	'UCP_PREFS'					=> 'Preferences',
+	'UCP_PREFS_PERSONAL'		=> 'Personal Settings',
+	'UCP_PREFS_POST'			=> 'Posting Messages',
+	'UCP_PREFS_VIEW'			=> 'Viewing Posts',
+	
+	'UCP_PM'					=> 'Private Messages',
+	'UCP_PM_COMPOSE'			=> 'Compose Message',
+	'UCP_PM_DRAFTS'				=> 'PM Drafts',
+	'UCP_PM_OPTIONS'			=> 'Options',
+	'UCP_PM_POPUP'				=> 'Private Messages',
+	'UCP_PM_UNREAD'				=> 'Unread Messages',
+	'UCP_PM_VIEW_MESSAGES'		=> 'View Messages',
+	
+	'UCP_PROFILE'				=> 'Profile',
+	'UCP_PROFILE_AVATAR'		=> 'Your avatar',
+	'UCP_PROFILE_PROFILE_INFO'	=> 'Your Profile',
+	'UCP_PROFILE_REG_DETAILS'	=> 'Registration details',
+	'UCP_PROFILE_SIGNATURE'		=> 'Your signature',
+	
+	'UCP_REGISTER_DISABLE'		=> 'Creating a new account is currently not possible.',
+	'UCP_REMIND'				=> 'Send password',
+	'UCP_RESEND'				=> 'Send activation email',
+	'UCP_WATCHED'				=> 'Watched items',
+	'UCP_WELCOME'				=> 'Welcome to the User Control Panel. From here you can monitor, view and update your profile, preferences, subscribed forums and topics. You can also send messages to other users (if permitted). Please ensure you read any announcements before continuing.',
+	'UCP_YIM'					=> 'Yahoo Messenger',
+	'UCP_ZEBRA'					=> 'Friends and Foes',
+	'UCP_ZEBRA_FOES'			=> 'Foes',
+	'UCP_ZEBRA_FRIENDS'			=> 'Friends',
+	'UNKNOWN_FOLDER'			=> 'Unknown Folder',
+	'UNREAD_MESSAGES'			=> 'Unread Messages',
+	'UNWATCH_MARKED'			=> 'Unwatch marked',
+	'UPLOAD_AVATAR_FILE'		=> 'Upload from your machine',
+	'UPLOAD_AVATAR_URL'			=> 'Upload from a URL',
+	'UPLOAD_AVATAR_URL_EXPLAIN'	=> 'Enter the URL of the location containing the image, it will be copied to this site.',
+	'USERNAME_ALPHA_ONLY_EXPLAIN'	=> 'Username must be between %1$d and %2$d chars long and use only alphanumeric characters',
+	'USERNAME_ALPHA_SPACERS_EXPLAIN'=> 'Username must be between %1$d and %2$d chars long and use alphanumeric, space or -+_[] characters.',
+	'USERNAME_CHARS_ANY_EXPLAIN'=> 'Length must be between %1$d and %2$d characters.',
+	'USERNAME_TAKEN_USERNAME'	=> 'The username you entered is already in use, please select an alternative.',
+	'USER_NOT_FOUND'			=> 'The usernames you specified could not be found.',
+
+	'VIEW_AVATARS'				=> 'Display Avatars',
+	'VIEW_EDIT'					=> 'View/Edit',
+	'VIEW_FLASH'				=> 'Display Flash animations',
+	'VIEW_IMAGES'				=> 'Display Images within posts',
+	'VIEW_NEXT_HISTORY'			=> 'Next PM in history',
+	'VIEW_NEXT_PM'				=> 'Next PM',
+	'VIEW_PM'					=> 'View Message',
+	'VIEW_PM_INFO'				=> 'Message Details',
+	'VIEW_PM_MESSAGE'			=> '1 Message',
+	'VIEW_PM_MESSAGES'			=> '%d Messages',
+	'VIEW_PREVIOUS_HISTORY'		=> 'Previous PM in history',
+	'VIEW_PREVIOUS_PM'			=> 'Previous PM',
+	'VIEW_SIGS'					=> 'Display Signatures',
+	'VIEW_SMILIES'				=> 'Display Smileys as images',
+	'VIEW_TOPICS_DAYS'			=> 'Display topics from previous days',
+	'VIEW_TOPICS_DIR'			=> 'Display topic order direction',
+	'VIEW_TOPICS_KEY'			=> 'Display topics ordering by',
+	'VIEW_POSTS_DAYS'			=> 'Display posts from previous days',
+	'VIEW_POSTS_DIR'			=> 'Display post order direction',
+	'VIEW_POSTS_KEY'			=> 'Display posts ordering by',
+	
+	'WATCHED_FORUMS'			=> 'Watched Forums',
+	'WATCHED_TOPICS'			=> 'Watched Topics',
+	'WRONG_ACTIVATION'			=> 'The activation key you supplied does not match any in the database',
+
+	'YOUR_DETAILS'				=> 'Your activity',
+	'YOUR_FOES'					=> 'Your foes',
+	'YOUR_FOES_EXPLAIN'			=> 'To remove usernames select them and click submit',
+	'YOUR_FRIENDS'				=> 'Your friends',
+	'YOUR_FRIENDS_EXPLAIN'		=> 'To remove usernames select them and click submit',
+	'YOUR_KARMA'				=> 'Your Karma level',
+	'YOUR_WARNINGS'				=> 'Your Warning level',
+
+	'PM_ACTION' => array(
+		'PLACE_INTO_FOLDER'	=> 'Place into folder',
+		'MARK_AS_READ'		=> 'Mark as read',
+		'MARK_AS_IMPORTANT'	=> 'Mark Message',
+		'DELETE_MESSAGE'	=> 'Delete Message'
+	),
+	'PM_CHECK' => array(
+		'SUBJECT'	=> 'Subject',
+		'SENDER'	=> 'Sender',
+		'MESSAGE'	=> 'Message',
+		'STATUS'	=> 'Message Status',
+		'TO'		=> 'Sent To'
+	),
+	'PM_RULE' => array(
+		'IS_LIKE'		=> 'Is Like',
+		'IS_NOT_LIKE'	=> 'Is Not Like',
+		'IS'			=> 'Is',
+		'IS_NOT'		=> 'Is Not',
+		'BEGINS_WITH'	=> 'Begins with',
+		'ENDS_WITH'		=> 'Ends with',
+		'IS_FRIEND'		=> 'Is Friend',
+		'IS_FOE'		=> 'Is Foe',
+		'IS_USER'		=> 'Is User',
+		'IS_GROUP'		=> 'Is In Usergroup',
+		'ANSWERED'		=> 'Answered',
+		'FORWARDED'		=> 'Forwarded',
+		'REPORTED'		=> 'Reported',
+		'TO_GROUP'		=> 'Usergroup',
+		'TO_ME'			=> 'Me'
+	),
+
+
+	'UCP_GROUPS_MEMBERSHIP'	=> 'Memberships', 
+	'UCP_GROUPS_MANAGE'		=> 'Manage groups', 
+	'GROUPS_EXPLAIN'		=> 'Usergroups enable board admins to better administer users. By default you will be placed in a specific group, this is your default group. This group defines how you may appear to other users, for example your username colouration, avatar, rank, etc. Depending on whether the administrator allows it you may be allowed to change your default group. You may also be placed in or allowed to join other groups. Some groups may give you extra rights to view content or increase your capabilities in other areas.', 
+	'GROUP_LEADER'		=> 'Leaderships', 
+	'GROUP_MEMBER'		=> 'Memberships', 
+	'GROUP_PENDING'		=> 'Pending memberships', 
+	'GROUP_NONMEMBER'	=> 'Non-memberships', 
+	'GROUP_DETAILS'		=> 'Group details', 
+
+	'NO_LEADER'		=> 'No group leaderships',
+	'NO_MEMBER'		=> 'No group memberships', 
+	'NO_PENDING'	=> 'No pending memberships', 
+	'NO_NONMEMBER'	=> 'No non-member groups', 
+
+	'QUIT_ALL'		=> 'Quit all', 
+	'QUIT_MARKED'	=> 'Quit marked', 
+	'JOIN_ALL'		=> 'Join all', 
+	'JOIN_MARKED'	=> 'Join marked', 
+	
+	'ACTIVE_TOPICS'			=> 'Active Topics',
+	'ANNOUNCEMENTS'			=> 'Announcements',
+	
+	'ICON_ANNOUNCEMENT'		=> 'Announcement',
+	'ICON_STICKY'			=> 'Sticky',
+
+	'LOGIN_NOTIFY_FORUM'	=> 'You have been notified about this forum, please login to view it.',
+
+	'MARK_TOPICS_READ'		=> 'Mark Topics Read',
+	'MOVED_TOPIC'			=> 'Moved Topic',
+
+	'NEW_POSTS_HOT'			=> 'New posts [ Popular ]',
+	'NEW_POSTS_LOCKED'		=> 'New posts [ Locked ]',
+	'NO_NEW_POSTS_HOT'		=> 'No new posts [ Popular ]',
+	'NO_NEW_POSTS_LOCKED'	=> 'No new posts [ Locked ]',
+
+	'POST_FORUM_LOCKED'		=> 'Forum is locked',
+	'POST_NEW_TOPIC'		=> 'Post new topic',
+	
+	'TOPICS_MARKED'			=> 'The topics for this forum have now been marked read',
+
+	'VIEW_FORUM'			=> 'View Forum',
+	'VIEW_FORUM_TOPIC'		=> '1 Topic',
+	'VIEW_FORUM_TOPICS'		=> '%d Topics',
+);
+
+?>
\ No newline at end of file



From viperal at berlios.de  Wed Sep 21 05:53:49 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 21 Sep 2005 05:53:49 +0200
Subject: [Viperals-svncheckins] r137 - in cms/trunk: . includes includes/nusoap includes/templates includes/templates/modules includes/templates/modules/Forums includes/templates/modules/google_search install modules/Forums modules/Forums/admin
Message-ID: <200509210353.j8L3rnvV028976@sheep.berlios.de>

Author: viperal
Date: 2005-09-21 05:53:30 +0200 (Wed, 21 Sep 2005)
New Revision: 137

Added:
   cms/trunk/includes/nusoap/
   cms/trunk/includes/nusoap/changelog
   cms/trunk/includes/nusoap/class.nusoap_base.php
   cms/trunk/includes/nusoap/class.soap_fault.php
   cms/trunk/includes/nusoap/class.soap_parser.php
   cms/trunk/includes/nusoap/class.soap_server.php
   cms/trunk/includes/nusoap/class.soap_transport_http.php
   cms/trunk/includes/nusoap/class.soap_val.php
   cms/trunk/includes/nusoap/class.soapclient.php
   cms/trunk/includes/nusoap/class.wsdl.php
   cms/trunk/includes/nusoap/class.wsdlcache.php
   cms/trunk/includes/nusoap/class.xmlschema.php
   cms/trunk/includes/nusoap/nusoap.php
   cms/trunk/includes/nusoap/nusoapmime.php
   cms/trunk/includes/templates/error_document.html
   cms/trunk/includes/templates/modules/google_search/
   cms/trunk/includes/templates/modules/google_search/index.html
Modified:
   cms/trunk/error.php
   cms/trunk/includes/templates/modules/Forums/search_body.html
   cms/trunk/includes/templates/modules/Forums/search_results.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/modules/Forums/admin/index.php
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Forums/main.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/search.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Forums/viewtopic.php
Log:


Modified: cms/trunk/error.php
===================================================================
--- cms/trunk/error.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/error.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -60,12 +60,17 @@
 
 $_CLASS['core_template'] =& new core_template();
 
-header(empty($error[$_GET['error']]['header']) ? $error['404']['header'] : $error[$_GET['error']]['header']);
+$_SERVER['REDIRECT_STATUS'] = isset($_SERVER['REDIRECT_STATUS']) ? $_SERVER['REDIRECT_STATUS'] : (isset($_GET['error']) ? $_GET['error'] : 404);
 
-$_CLASS['core_template']->assign('MESSAGE_TEXT',  (empty($error[$_GET['error']]['lang']) ? $error['404']['lang'] : $error[$_GET['error']]['lang']));
-		
-$_CLASS['core_template']->display('error.html');
+header(empty($error[$_SERVER['REDIRECT_STATUS']]['header']) ? $error['404']['header'] : $error[$_SERVER['REDIRECT_STATUS']]['header']);
+
+$_CLASS['core_template']->assign_array(array(
+	'MESSAGE_TEXT'	=> empty($error[$_SERVER['REDIRECT_STATUS']]['lang']) ? $error['404']['lang'] : $error[$_SERVER['REDIRECT_STATUS']]['lang'],
+	'SITE_LINK'		=> 'http://'.(empty($_SERVER['SERVER_NAME']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME']),
+));
 	
+$_CLASS['core_template']->display('error_document.html');
+	
 die;
 
 ?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/changelog
===================================================================
--- cms/trunk/includes/nusoap/changelog	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/changelog	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,438 @@
+2003-07-21, version 0.6.5
+- soap_transport_http: SOAPAction header is quoted again, fixes problem w/ Weblogic Server
+- applied Jason Levitt patch for proper array serialization, fixes problem w/ Amazon shopping cart services
+- fixed null value serialization
+- applied patch from "BZC ToOn'S" - fixes wsdl serialization when no parameters
+- applied John's patch, implementing compression for the server
+
+2003-07-22, version 0.6.5
+- soap_server: fixed bug causing charset encoding not to be passed to the parser
+- soap_fault: added default encoding to the fault serialization
+- soap_parser: changed the parser to pre-load the parent's result array when processing scalar values. This increases parsing speed.
+
+2003-07-23, version 0.6.5
+- soap_base: fix code that overwrites user-supplied attributes in serialize_val
+- soap_base: use arrays-of-arrays rather than attempting multi-dimensional in serialize_val
+- xmlschema: emit import statements and qualify all elements with prefix in serializeSchema (better interop with validation tools)
+- soapclient: get xml character encoding from HTTP Content-Type header if provided, e.g. text/xml;charset="UTF-8"
+- soapclient: use headers in call if provided (previously ignored this parameter)
+- soap_server: in parse_request, if neither getallheaders nor $_SERVER are available, use $HTTP_SERVER_VARS to get SOAPAction and xml encoding
+
+2003-07-24, version 0.6.5
+- soap_transport_http: apply patch from Steven Brown "if the server closes connection prematurely, nusoap would spin trying to read data that isn't there"
+
+2003-07-25, version 0.6.5
+- wsdl: apply patch from Sven to workaround single schema limitation
+- wsdl: apply a variant of the patch from Holger to handle empty values for array by serializing an array with 0 elements
+- xmlschema: remove the redundant default namespace attribute on the schema element; everything in xsd is explicitly specified as being from xsd
+- soap_transport_http: fix setCredentials and add TODO comments in sendHTTPS about what to change if this setCredentials stays
+
+2003-07-30, version 0.6.5
+- nusoap_base: change documentation of soap_defencoding to specify it is the encoding for outgoing messages
+- nusoap_base: only change &, <, > to entities, not all HTML entities
+- soap_transport_http: update the Content-Type header in sendRequest, since soap_defencoding could be changed after ctor is called
+- soap_server: use soap_defencoding instead of charset_encoding
+- soap_server: read encoding from _SERVER if available
+- nusoap_base: do entity translation for string parameters with an xsd type specified (thanks David Derr)
+
+2003-07-31, version 0.6.5
+- soap_transport_http: add proxy authentication
+- soap_transport_http: build payload the same way for http and https
+- wsdl: add proxy authentication
+- soapclient: add proxy authentication
+- soapclient: allow proxy information in ctor, so that it can be used for wsdl
+
+2003-08-01, version 0.6.5
+- soap_transport_http: close a persistent connection that's at EOF
+- soap_transport_http: prevent conflicts between setEncoding and usePersistentConnection
+- soap_transport_http: fix use of $headers instead of $this->incoming_headers in getResponse
+- soapclient: improve handling of persistent connections
+- soapclient: force xml_encoding to upper case
+- soap_server: let the Web server decide whether to close the connection (no Connection: close header)
+- soap_server: force xml_encoding to upper case
+
+2003-08-04, version 0.6.5
+- soap_parser: use XML type information to pick a PHP data type; also decode base64
+- soap_server: read all HTTP headers when using _SERVER or HTTP_SERVER_VARS
+- soap_server: add gzip encoding support for outgoing messages
+- soap_transport_http: deflate is gzcompress/gzuncompress (cf. http://archive.develooper.com/libwww at perl.org/msg04650.html)
+- soap_transport_http: clean use of persistentConnection so it's always a set boolean
+- soapclient: add responseData member to access deflated/gunzipped payload
+
+2003-08-05, version 0.6.5
+- soap_server: look multiple places when setting debug_flag
+
+2003-08-07, version 0.6.5
+- nusoap_base: serialize specified type (e.g. ArrayOfString) even for simple array
+- wsdl: only specify encodingStyle in the input/output soap bindings when it is not empty (thanks Guillaume)
+
+2003-08-15, version 0.6.5
+- soap_parser: fix parsing of elements with no XSD type specified
+- soap_parser: use PHP string type for XSD long and unsignedLong types
+
+2003-08-16, version 0.6.5
+- soap_parser: fix code generating warning (thanks Torsten)
+
+2003-08-19, version 0.6.5
+- soap_parser: fix another line of code generating a warning (thanks Torsten)
+
+2003-08-22, version 0.6.5
+- soap_server: remove all '--' from debug_str; previous code changed '---' to '- --'
+- wsdl, soapclient, soap_parser: patch submitted by Mark Spavin as described by
+                                 the following...
+> Changes for the multiple/nested imports from the wsdl file. This builds an
+> array of files not just the last one and also checks for relative paths to
+> the parent. This will then get the imported files from the remote site
+> instead of your local disk. Local wsdl files should still work (untested).
+>
+> Changes for multiple encoding sytles as previously posted
+
+2003-08-24, version 0.6.5
+- wsdl, soapclient: fix some PHP notices from previous update
+
+2003-08-26, version 0.6.5
+- wsdl: support multiple SOAP ports
+- soapclient, soap_server: when no charset is specified, use UTF-8, even though HTTP specifies US-ASCII.
+- soap_transport_http: do not prepend $host with 'ssl://' for https (is this required for older cURL versions?)
+
+2003-08-27, version 0.6.5
+- soap_server: support compressed request messages (thanks John Huong)
+- soap_parser: deserialize Apache Vector as an array
+- xmlschema: use $this->typemap in getPHPType (which is not used)
+- soapclient, wsdl: check for WSDL errors after serializing parameters
+- nusoap_base: add serialization of Apache Map (when not using WSDL)
+- wsdl: add serialization of Apache Map (when using WSDL)
+- wsdl: only change &, <, > to entities, not all HTML entities
+
+2003-08-28, version 0.6.5
+- soap_transport_http: disable cURL verification of peer and server (formerly the cURL default)
+- soap_transport_http: mingle cURL code with straight http, so sendHTTP is no longer needed
+
+2003-08-29, version 0.6.6
+- soap_transport_http: add setContentType
+- soapclient: call setContentType using new getHTTPContentType and getHTTPContentTypeCharset
+
+2003-09-05, version 0.6.6
+- wsdl: add some more code to handle null/nil values (but there's still a way to go)
+
+2003-10-21, version 0.6.6
+- soap_transport_http: only include port in Host header if it was specified in the URL
+- soap_transport_http: add some code to use OpenSSL for PHP ssl:// scheme, but comment out since it's not ready
+- soap_server: use $_SERVER['PHP_SELF'] if $GLOBALS['PHP_SELF'] is not set
+- wsdl: add WSDL request and response and transport debug to debug
+- wsdl: handle custom type extending xmlschema namespace (GLUE ... Thanks Matt)
+- soap_parser: add param to docs
+- soapclient: add getHTTPBody, getHTTPContentType, getHTTPContentTypeCharset (anticipating MIME subclass)
+
+2003-10-28, version 0.6.6
+- nusoap_base: add expandEntities method
+- wsdl: use expandEntities
+- soap_fault: use expandEntities
+- soap_transport_http: Allow credentials to be included in URL, rather than requiring setCredentials
+- soap_transport_http: Merge HTTP headers that span multiple lines
+- soap_parser: Properly set errors in ctor
+- soapclient: Pass headers to parseResponse and parse them in that method
+
+2003-10-30, version 0.6.6
+- xmlschema: Add some information for the related type to an element
+
+2003-12-09, version 0.6.6
+- nusoap_base: Add some namespace methods previously in xmlschema
+- xmlschema: Improve parsing of complexType, element and simpleType
+- xmlschema: Improve serialization
+- xmlschema: Track imports
+- xmlschema: Track elementFormDefault and form attributes
+- wsdl: Support multiple <schema> (note that setting $server->wsdl->schemaTargetNamespace no longer does anything!  Use configureWSDL instead.)
+- wsdl: Use form attribute of element to control namespace specification
+- wsdl: Support chained imports (A imports B which imports C)
+- wsdl: Include port in endpoint address when serializing
+- soap_server: Fix use of style (rpc|document) and use (encoded|literal)
+- soap_server: Support _SERVER[CONTENT_TYPE] in addition to _SERVER[HTTP_CONTENT_TYPE]
+- soap_server: Support wsdl with multiple <schema>
+- soap_client: Remove a var_dump
+- soap_client: Add style and use parameters to call method to support doc/lit without WSDL
+- soap_transport_http: Check that $this->fp exists when doing persistent connections
+
+2003-12-17, version 0.6.6
+- soap_server: pass namespaces to xmlschema constructor
+- wsdl: post-process after all imports
+- wsdl: remove some debug, add some error handling
+- xmlschema: allow enclosing namespaces to be specified in constructor
+- xmlschema: improve handling of compositors and simple types
+
+2004-01-08, version 0.6.6
+- soap_server: when requested WSDL is in a file, return to client using passthru (thanks Ingo Fischer)
+- soapclient: have proxy inherit more client state
+- soapclient: allow timeout and response timeout to be specified in the constructor
+- wsdl: allow timeout and response timeout to be specified in the constructor
+- soap_transport_http: allow response timeout to be specified in send and sendHTTPS
+
+2004-01-28, version 0.6.6
+- wsdl: add namespace for array and scalar when form is qualified
+- wsdl: fix a bug in which data type of complexType elements were ignored in serialization
+- wsdl: enhance handling of URLs with file scheme
+- wsdl: add addSimpleType
+- xmlschema: add addSimpleType
+- xmlschema: always set phpType elements
+- soapclient: allow a wsdl instance to be specified in constructor
+- soap_server: allow a wsdl instance to be specified in constructor (not tested!)
+- soap_server: fix default SOAPAction created in register method
+- soap_transport_http: accept chunking with LF separators in addition to CRLF.
+- wsdlcache: added class
+- nusoapmime: fix comments
+
+2004-02-23, version 0.6.6
+- soap_transport_http: don't try to unchunk cURL data, since cURL already does it
+- soap_transport_http: append CVS revision to version in User-Agent
+- wsdl: serialize boolean as true|false, not 1|0, to agree with XML Schema
+- soap_server: always exit() after returning WSDL
+- soap_server: use the WSDL URL scheme as the default endpoint URL scheme
+- soap_server: append CVS revision to version in X-SOAP-Server
+- nusoap_base: add (CVS) revision
+- wsdlcache: synchronize using a per-WSDL lock file (Thanks Ingo)
+- wsdlcache: add cache lifetime, after which cache contents are invalidated (Thanks Ingo)
+
+2004-03-15, version 0.6.6
+- nusoap_base: add isArraySimpleOrStruct method
+- soap_server: improve WSDL URL scheme determination
+- soap_server: only deflate/gzip payloads > 1024 bytes
+- soap_server: fix parameter order in fault method (always used as faultcode, faultstring)
+- soap_server: refactor parse_request into multiple functions (for sanity)
+- soap_server: set the namespace on the Response element to the same as the request
+- soap_server: name the return value element 'return' by default
+- soap_server: added and documented data fields, so that service programmers can use them if desired
+- soap_parser: standardize parsing error message
+- soap_parser: fix document and responseHeaders so they are the correct XML text (as documented)
+- soap_transport_http: fix read from persistent connection
+- soapclient: clean up debugging for persistent connection
+- wsdl: enforce correct naming of messages parts when an associative array is used for parameters
+- wsdl: better serialization of null values
+- wsdl: standardize parsing error message
+- xmlschema: standardize parsing error message
+
+2004-03-24, version 0.6.7
+- soap_transport_http: add digest authentication (based on code by Kevin A. Miller)
+- xmlschema: improve parsing of import elements
+- wsdl: do schema imports even if there are no wsdl imports
+
+2004-04-12, version 0.6.7
+- wsdl: serialize multiple elements when maxOccurs="unbounded" and value is an array
+- wsdl: serialize soapval values (used to force an XML type, e.g. when WSDL uses an abstract type)
+- nusoapmime: do not require nusoap.php (it is now the programmer's responsibility)
+
+2004-04-21, version 0.6.7
+- soap_parser: parse repeated element name into an array (de-serializes doc/lit array into a PHP array when there is more than 1 array element)
+- soap_server: do not wrap response in a response element for a document style service
+
+2004-04-30, version 0.6.7
+- soap_transport_http: allow digest auth params to be separated by "," as well as ", "
+- soap_transport_http: re-initialize incoming headers for each response
+- soap_server: add methodreturnisliteralxml property to allow service function to return XML as a string
+- soapclient: improve rpc/literal support
+- soapclient: allow XML string as call params in addition to array
+- soapclient: support document style and literal encoding when not using WSDL
+
+2004-05-05, version 0.6.7
+- wsdl: serialize PHP objects for WSDL XML Schema complexTypes, in addition to associative arrays
+- wsdl: fix WSDL generation when there is no encodingStyle
+- soap_transport_http: suppress fsockopen warnings
+- soap_transport_http: detect socket timeouts when reading (0 bytes returned)
+- soap_transport_http: read chunked content "in-line" so it works on a persistent connection
+- nusoap_base: serialize boolean as true|false, not 1|0, to agree with XML Schema
+- nusoap_base: serialize array of struct differently than array of array
+
+2004-06-25, version 0.6.8
+- soap_server: prefer gzip to deflate, since IE does not like our deflate
+- soap_server: move webDescription to the wsdl class
+- soap_server: allow class and instance method calls for service (thanks Ingo Fischer and Roland Knall)
+- wsdl: get webDescription from the soap_server class
+- wsdl: allow compression from the server
+- wsdl: fix serialization of soapval without a type
+- wsdl: propagate debug value from query string to SOAP endpoint in programmatic WSDL generation
+- nusoap_base: add anyType, anySimpleType for 2001 XML Schema
+- nusoap_base: provide additional debug functions
+- soap_transport_http: ignore Content-Length when chunked encoding is used
+- soap_transport_http: remove ':' from username for Basic authentication (cf. RFC 2617)
+- soap_transport_http: urldecode username and password taken from URL
+- soap_transport_http: use raw inflate/deflate for IE/IIS compatibility, rather than having Zlib headers according to HTTP 1.1 spec
+- soap_transport_http: attempt to handle the case when both the service application and Web server compress the response
+- soapclient: when creating proxy methods, replace '.' in operation name with '__' in function name
+- soapclient: initialize requestHeaders in proxy
+- general: use new debug methods; never access debug_str directly
+
+2004-09-30, version 0.6.8
+- soapclient: do not allow getProxy call when WSDL is not used
+- soapclient: use ISO-8859-1 as the charset if not specified in the Content-Type header
+- soapclient: when an empty string is specified for the call namespace, do not put the method element in a namespace
+- soapclient: let soap_transport_http check for SSL support
+- soapclient: have proxy inherit soap_defencoding from the client from which it is generated
+- soapclient: do not assume that 'ns1' is an unused namespace prefix; always generate namespace prefixes randomly
+- soap_parser: compare any encoding in the XML declaration to the charset from the HTTP Content-Type header (thanks Ingo Fischer)
+- soap_parser: improve parse repeated element name into an array (de-serializes doc/lit array into a PHP array when there is more than 1 array element)
+- soap_server: use ISO-8859-1 as the charset if not specified in the Content-Type header
+- soap_server: allow suppression of automatic UTF-8 decoding
+- soap_server: fix a bug when call_user_func_array() is used
+- soap_transport_http: correct digest authentication through a proxy
+- wsdl: serialize SOAP-ENC types similarly to XSD types
+- xmlschema: force unprefixed type into default namespace
+- xmlschema: fix serialization of definition of simple types
+
+2004-10-01, version 0.6.8
+- soap_parser: handle default namespace attributes
+- soap_server: add default_utf8 field
+- soap_server: support literal encoding (with RPC style)
+- soap_transport_http: parse HTTP status and generate error for 300, 302-307, 400, 401-417, 501-505 (thanks for the idea Ghislain)
+- soap_transport_http: follow HTTP redirection (HTTP status 301 and Location header) (thanks for the idea Ghislain)
+- xmlschema: allow any attributes to be specified in an element of a complexType, e.g., abstract, default, form, minOccurs, maxOccurs, nillable (thanks Jirka Pech for the original patch)
+
+2004-10-02, version 0.6.8
+- soapclient: read/write cookies (thanks Ingo)
+- soap_server: change faultcode on non-resendable faults to Client
+- soap_transport_http: read/write cookies (thanks Ingo)
+
+2004-10-05, version 0.6.8
+- wsdl: add addElement method
+- wsdl: support the document style in the register method
+- xmlschema: parse unnamed simpleTypes, rather than ignoring them
+- xmlschema: include untyped elements when parsing a complexType
+- xmlschema: add addElement method
+
+2004-10-14, version 0.6.8
+- soapclient: support client certificates
+- soap_parser: deserialize attributes, prefixing names with "!"
+- soap_server: notify the client with HTML when WSDL is requested but not supported by service
+- soap_transport_http: support client certificates
+- wsdl: support defaults for elements of a complexType
+- wsdl: serialize elements from complexType extension base
+- wsdl: serialize data (associative array elements) as attributes according to XML Schema
+- xmlschema: record extension base if present for a complexType
+
+2004-12-15, version 0.6.8
+- nusoap_base: add 2000 XML Schema (rare, but used by Akamai)
+- soap_parser: avoid deserializing more common attributes that are not data
+- soap_parser: be lax when HTTP specifies ISO-8859-1 (the default) and XML specifies UTF-8 (the norm)
+- soap_server: account for the fact that get_class_methods returns methods in all lower case (thanks Steve Haldane)
+- soap_transport_http: parse digest info that includes '=' in the data (thanks Jinsuk Kim)
+- wsdl: feably handle some cases for literal serialization of form="unqualified" elements
+- wsdl: don't serialize the decimal portion of a PHP double when the XML type is long
+- wsdl: fix serialization of attributes for complexType that is an extension
+- wsdlcache: enhance diagnostics
+- xmlschema: handle untyped elements
+- xmlschema: handle WSDL for SOAP Array that uses the base attribute plus a sequence of element
+
+2005-01-22, version 0.6.8
+- wsdl: allow an element in one schema to have a type from another schema
+
+2005-01-24, version 0.6.8
+- xmlschema: correctly parse nested complexType definitions
+
+2005-02-14, version 0.6.8
+- nusoap_base: fix a bug in which attributes were sometimes not serialized with a value
+- nusoap_base: improve serialization of null values (thanks Dominique Stender)
+- soap_parser: parse null values by handling the nil attribute (thanks Dominique Stender)
+- soap_server: set character encoding for a fault to be the same as for the server (thanks Mark Scott)
+- soap_server: correctly check for null value returned from method when WSDL is used (without WSDL, cannot distinguish whether NULL or void return is desired)
+- soapclient: for document style, call should always return an array rooted at the response part (all bets are off when there are multiple parts)
+- xmlschema: save enumeration values parsed from WSDL
+
+2005-02-10, version 0.6.9
+- soapclient: only set SOAP headers when they are specified in call params (so setHeaders still works)
+
+2005-04-04, version 0.6.9
+- soap_server: use get_class instead of is_a (thanks Thomas Noel)
+- soapclient: use get_class instead of is_a (thanks Thomas Noel)
+- soapclient: add setEndpoint method
+- soap_transport_http: fix client certificates (thanks Doug Anarino and Eryan Eriobowo)
+
+2005-04-29, version 0.6.9
+- nusoap_base: add global variable and methods for setting debug level
+- nusoap_base: use xsd:anyType instead of xsd:ur-type to serialize arrays with multiple element types (thanks Ingo Fischer)
+- nusoap_base: expand entities in attributes (thanks Gaetano Giunta)
+- soapclient: call parent constructor
+- soapval: call parent constructor
+- soap_fault: call parent constructor
+- soap_parser: call parent constructor
+- soap_server: assume get_class_methods always returns lower case for PHP 4.x only
+- soap_server: call parent constructor
+- soap_transport_http: do nothing in setEncoding if gzdeflate is not present (thanks Franck Touanen for pointing this out)
+- soap_transport_http: fix check for server request for digest authentication (thanks Mark Spavin)
+- soap_transport_http: call parent constructor
+- wsdl: fix documentation page popup of one method after another (thanks Owen)
+- wsdl: call parent constructor
+- wsdl: expand entities in attributes (thanks Gaetano Giunta)
+- xmlschema: call parent constructor
+
+2005-06-03, version 0.6.9
+- nusoap_base: serialize empty arrays as having elements xsd:anyType[0]
+- nusoap_base: add encodingStyle parameter to serializeEnvelope
+- nusoap_base: serialize xsi:type with nil values
+- nusoap_base: improve debug and comments
+- soap_parser: correctly parse an empty array to an empty array, not an empty string
+- soap_parser: improve debug and comments
+- soap_server: specify encodingStyle for envelope when WSDL is used
+- soapclient: factor out new getProxyClassCode method
+- soapclient: specify encodingStyle for envelope
+- soapclient: improve debug and comments
+- wsdl: add namespace for Apache SOAP types if a variable of such type is serialized
+- wsdl: serialize nil value for nillable elements when no value is provided
+- wsdl: serialize xsi:type with nil values
+- wsdl: copy attributes as well as elements to an element from its complexType
+- wsdl: specify encodingStyle for operations
+- wsdl: improve debug and comments
+- xmlschema: improve debug and comments
+
+2005-06-03, version 0.7.0
+- nusoap_base: improve debug and comments
+- nusoap_base: fix version, which should have been 0.7.0 since 2005-03-04
+
+2005-06-06, version 0.7.1
+- nusoap_base: adjust numeric element names for serialization, instead of forcing them to 'soapVal'
+- nusoapmime: add type=text/xml to multipart/related (thanks Emmanuel Cordonnier)
+- soap_fault: fix serialization of detail
+- soap_server: check required parameters for register method
+- soap_server: when getallheaders is used, massage header names
+- soap_server: use SOAPAction to determine operation when doc/lit service does not wrap parameters in an element with the method name (thanks Peter Hrastnik)
+- soap_transport_http: correctly handle multiple HTTP/1.1 100 responses for https (thanks Jan Slabon)
+- wsdl: fixed documentation for addComplexType (thanks Csintalan ?d?m)
+- wsdl: serialize array data when maxOccurs = 'unbounded' OR maxOccurs > 1 (thanks Dominique Schreckling)
+- wsdl: when serializing a string == 'false' as a boolean, set the value to false
+- wsdl: when serializing a complexType, require the PHP value supplied to be an array
+
+2005-07-01, version 0.7.1
+- nusoap_base: Allow SOAP headers to be supplied as an array like parameters
+- soap_parser: de-serialize simpleContent that accompanies complexContent
+- soap_server: append debug information when programmatically-defined WSDL is returned
+- soap_transport_http: Add debug when an outgoing header is set
+- soapclient: Allow SOAP headers to be supplied as an array like parameters
+- xmlschema: serialize attributes more generally, rather than assuming they are for SOAP 1.1 Array
+- wsdl: when serializing, look up types by namespace, not prefix (simple programmatic doc/lit WSDL now seems to work)
+- wsdl: process namespace declarations first when parsing an element
+
+2005-07-27, version 0.7.1
+- nusoap_base: do not override supplied element name with class name when serializing an object in serialize_val
+- nusoap_base: remove http://soapinterop.org/xsd (si) from namespaces array
+- nusoapmime: add nusoapservermime class to implement MIME attachments on the server
+- soap_fault: improve documentation
+- soap_server: improve documentation
+- soap_server: make consistent use of _SERVER and HTTP_SERVER_VARS
+- soap_server: make all incoming HTTP header keys lower case
+- soap_server: add hook functions to support subclassing for MIME attachments
+- soap_transport_http: remove an unnecessary global statement
+- soapclient: when creating a proxy, make $params within each function an associative array
+- soapval: improve documentation
+- wsdl: when serializing complexType elements, used typed serialization if there is either a type or a reference for the element
+- wsdl: allow PHP objects to be serialized as SOAP structs in serializeType
+- wsdl: for WSDL and XML Schema imports, don't forget to use the TCP port number (thanks Luca GIOPPO)
+- wsdl: make consistent use of _SERVER and HTTP_SERVER_VARS
+- xmlschema: improve documentation
+
+2005-07-31, version 0.7.2
+- nusoap_base: correctly serialize attributes in serialize_val (thanks Hidran Arias)
+- soap_parser: when resolving references, do not assume that buildVal returns an array (thanks Akshell)
+- soap_parser: removed decode_entities, which does not work (thanks Martin Sarsale)
+- soap_server: fix a bug parsing headers from _SERVER and HTTP_SERVER_VARS (thanks Bert Catsburg)
+- soap_server: parse all "headers" from HTTP_SERVER_VARS (not just HTTP_*)
+- soap_server: use PHP_SELF instead of SCRIPT_NAME for WSDL endpoint
+- soap_server: when generating a fault while debug_flag is true, put debug into faultdetail
+- wsdl: add enumeration parameter to addSimpleType
+- xmlschema: add enumeration parameter to addSimpleType

Added: cms/trunk/includes/nusoap/class.nusoap_base.php
===================================================================
--- cms/trunk/includes/nusoap/class.nusoap_base.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.nusoap_base.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,905 @@
+<?php
+
+/*
+$Id: class.nusoap_base.php,v 1.43 2005/08/04 01:27:42 snichol Exp $
+
+NuSOAP - Web Services Toolkit for PHP
+
+Copyright (c) 2002 NuSphere Corporation
+
+This library is free software; you can redistribute it and/or
+modify it under the terms of the GNU Lesser General Public
+License as published by the Free Software Foundation; either
+version 2.1 of the License, or (at your option) any later version.
+
+This library is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+Lesser General Public License for more details.
+
+You should have received a copy of the GNU Lesser General Public
+License along with this library; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+If you have any questions or comments, please email:
+
+Dietrich Ayala
+dietrich at ganx4.com
+http://dietrich.ganx4.com/nusoap
+
+NuSphere Corporation
+http://www.nusphere.com
+
+*/
+
+/* load classes
+
+// necessary classes
+require_once('class.soapclient.php');
+require_once('class.soap_val.php');
+require_once('class.soap_parser.php');
+require_once('class.soap_fault.php');
+
+// transport classes
+require_once('class.soap_transport_http.php');
+
+// optional add-on classes
+require_once('class.xmlschema.php');
+require_once('class.wsdl.php');
+
+// server class
+require_once('class.soap_server.php');*/
+
+// class variable emulation
+// cf. http://www.webkreator.com/php/techniques/php-static-class-variables.html
+$GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel = 9;
+
+/**
+*
+* nusoap_base
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.nusoap_base.php,v 1.43 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class nusoap_base {
+	/**
+	 * Identification for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $title = 'NuSOAP';
+	/**
+	 * Version for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $version = '0.7.2';
+	/**
+	 * CVS revision for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $revision = '$Revision: 1.43 $';
+    /**
+     * Current error string (manipulated by getError/setError)
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $error_str = '';
+    /**
+     * Current debug string (manipulated by debug/appendDebug/clearDebug/getDebug/getDebugAsXMLComment)
+	 *
+	 * @var string
+	 * @access private
+	 */
+    var $debug_str = '';
+    /**
+	 * toggles automatic encoding of special characters as entities
+	 * (should always be true, I think)
+	 *
+	 * @var boolean
+	 * @access private
+	 */
+	var $charencoding = true;
+	/**
+	 * the debug level for this instance
+	 *
+	 * @var	integer
+	 * @access private
+	 */
+	var $debugLevel;
+
+    /**
+	* set schema version
+	*
+	* @var      string
+	* @access   public
+	*/
+	var $XMLSchemaVersion = 'http://www.w3.org/2001/XMLSchema';
+	
+    /**
+	* charset encoding for outgoing messages
+	*
+	* @var      string
+	* @access   public
+	*/
+    var $soap_defencoding = 'ISO-8859-1';
+	//var $soap_defencoding = 'UTF-8';
+
+	/**
+	* namespaces in an array of prefix => uri
+	*
+	* this is "seeded" by a set of constants, but it may be altered by code
+	*
+	* @var      array
+	* @access   public
+	*/
+	var $namespaces = array(
+		'SOAP-ENV' => 'http://schemas.xmlsoap.org/soap/envelope/',
+		'xsd' => 'http://www.w3.org/2001/XMLSchema',
+		'xsi' => 'http://www.w3.org/2001/XMLSchema-instance',
+		'SOAP-ENC' => 'http://schemas.xmlsoap.org/soap/encoding/'
+		);
+
+	/**
+	* namespaces used in the current context, e.g. during serialization
+	*
+	* @var      array
+	* @access   private
+	*/
+	var $usedNamespaces = array();
+
+	/**
+	* XML Schema types in an array of uri => (array of xml type => php type)
+	* is this legacy yet?
+	* no, this is used by the xmlschema class to verify type => namespace mappings.
+	* @var      array
+	* @access   public
+	*/
+	var $typemap = array(
+	'http://www.w3.org/2001/XMLSchema' => array(
+		'string'=>'string','boolean'=>'boolean','float'=>'double','double'=>'double','decimal'=>'double',
+		'duration'=>'','dateTime'=>'string','time'=>'string','date'=>'string','gYearMonth'=>'',
+		'gYear'=>'','gMonthDay'=>'','gDay'=>'','gMonth'=>'','hexBinary'=>'string','base64Binary'=>'string',
+		// abstract "any" types
+		'anyType'=>'string','anySimpleType'=>'string',
+		// derived datatypes
+		'normalizedString'=>'string','token'=>'string','language'=>'','NMTOKEN'=>'','NMTOKENS'=>'','Name'=>'','NCName'=>'','ID'=>'',
+		'IDREF'=>'','IDREFS'=>'','ENTITY'=>'','ENTITIES'=>'','integer'=>'integer','nonPositiveInteger'=>'integer',
+		'negativeInteger'=>'integer','long'=>'integer','int'=>'integer','short'=>'integer','byte'=>'integer','nonNegativeInteger'=>'integer',
+		'unsignedLong'=>'','unsignedInt'=>'','unsignedShort'=>'','unsignedByte'=>'','positiveInteger'=>''),
+	'http://www.w3.org/2000/10/XMLSchema' => array(
+		'i4'=>'','int'=>'integer','boolean'=>'boolean','string'=>'string','double'=>'double',
+		'float'=>'double','dateTime'=>'string',
+		'timeInstant'=>'string','base64Binary'=>'string','base64'=>'string','ur-type'=>'array'),
+	'http://www.w3.org/1999/XMLSchema' => array(
+		'i4'=>'','int'=>'integer','boolean'=>'boolean','string'=>'string','double'=>'double',
+		'float'=>'double','dateTime'=>'string',
+		'timeInstant'=>'string','base64Binary'=>'string','base64'=>'string','ur-type'=>'array'),
+	'http://soapinterop.org/xsd' => array('SOAPStruct'=>'struct'),
+	'http://schemas.xmlsoap.org/soap/encoding/' => array('base64'=>'string','array'=>'array','Array'=>'array'),
+    'http://xml.apache.org/xml-soap' => array('Map')
+	);
+
+	/**
+	* XML entities to convert
+	*
+	* @var      array
+	* @access   public
+	* @deprecated
+	* @see	expandEntities
+	*/
+	var $xmlEntities = array('quot' => '"','amp' => '&',
+		'lt' => '<','gt' => '>','apos' => "'");
+
+	/**
+	* constructor
+	*
+	* @access	public
+	*/
+	function nusoap_base() {
+		$this->debugLevel = $GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel;
+	}
+
+	/**
+	* gets the global debug level, which applies to future instances
+	*
+	* @return	integer	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function getGlobalDebugLevel() {
+		return $GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel;
+	}
+
+	/**
+	* sets the global debug level, which applies to future instances
+	*
+	* @param	int	$level	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function setGlobalDebugLevel($level) {
+		$GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel = $level;
+	}
+
+	/**
+	* gets the debug level for this instance
+	*
+	* @return	int	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function getDebugLevel() {
+		return $this->debugLevel;
+	}
+
+	/**
+	* sets the debug level for this instance
+	*
+	* @param	int	$level	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function setDebugLevel($level) {
+		$this->debugLevel = $level;
+	}
+
+	/**
+	* adds debug data to the instance debug string with formatting
+	*
+	* @param    string $string debug data
+	* @access   private
+	*/
+	function debug($string){
+		if ($this->debugLevel > 0) {
+			$this->appendDebug($this->getmicrotime().' '.get_class($this).": $string\n");
+		}
+	}
+
+	/**
+	* adds debug data to the instance debug string without formatting
+	*
+	* @param    string $string debug data
+	* @access   public
+	*/
+	function appendDebug($string){
+		if ($this->debugLevel > 0) {
+			// it would be nice to use a memory stream here to use
+			// memory more efficiently
+			$this->debug_str .= $string;
+		}
+	}
+
+	/**
+	* clears the current debug data for this instance
+	*
+	* @access   public
+	*/
+	function clearDebug() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		$this->debug_str = '';
+	}
+
+	/**
+	* gets the current debug data for this instance
+	*
+	* @return   debug data
+	* @access   public
+	*/
+	function &getDebug() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		return $this->debug_str;
+	}
+
+	/**
+	* gets the current debug data for this instance as an XML comment
+	* this may change the contents of the debug data
+	*
+	* @return   debug data as an XML comment
+	* @access   public
+	*/
+	function &getDebugAsXMLComment() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		while (strpos($this->debug_str, '--')) {
+			$this->debug_str = str_replace('--', '- -', $this->debug_str);
+		}
+    	return "<!--\n" . $this->debug_str . "\n-->";
+	}
+
+	/**
+	* expands entities, e.g. changes '<' to '&lt;'.
+	*
+	* @param	string	$val	The string in which to expand entities.
+	* @access	private
+	*/
+	function expandEntities($val) {
+		if ($this->charencoding) {
+	    	$val = str_replace('&', '&amp;', $val);
+	    	$val = str_replace("'", '&apos;', $val);
+	    	$val = str_replace('"', '&quot;', $val);
+	    	$val = str_replace('<', '&lt;', $val);
+	    	$val = str_replace('>', '&gt;', $val);
+	    }
+	    return $val;
+	}
+
+	/**
+	* returns error string if present
+	*
+	* @return   mixed error string or false
+	* @access   public
+	*/
+	function getError(){
+		if($this->error_str != ''){
+			return $this->error_str;
+		}
+		return false;
+	}
+
+	/**
+	* sets error string
+	*
+	* @return   boolean $string error string
+	* @access   private
+	*/
+	function setError($str){
+		$this->error_str = $str;
+	}
+
+	/**
+	* detect if array is a simple array or a struct (associative array)
+	*
+	* @param	mixed	$val	The PHP array
+	* @return	string	(arraySimple|arrayStruct)
+	* @access	private
+	*/
+	function isArraySimpleOrStruct($val) {
+        $keyList = array_keys($val);
+		foreach ($keyList as $keyListValue) {
+			if (!is_int($keyListValue)) {
+				return 'arrayStruct';
+			}
+		}
+		return 'arraySimple';
+	}
+
+	/**
+	* serializes PHP values in accordance w/ section 5. Type information is
+	* not serialized if $use == 'literal'.
+	*
+	* @param	mixed	$val	The value to serialize
+	* @param	string	$name	The name (local part) of the XML element
+	* @param	string	$type	The XML schema type (local part) for the element
+	* @param	string	$name_ns	The namespace for the name of the XML element
+	* @param	string	$type_ns	The namespace for the type of the element
+	* @param	array	$attributes	The attributes to serialize as name=>value pairs
+	* @param	string	$use	The WSDL "use" (encoded|literal)
+	* @return	string	The serialized element, possibly with child elements
+    * @access	public
+	*/
+	function serialize_val($val,$name=false,$type=false,$name_ns=false,$type_ns=false,$attributes=false,$use='encoded'){
+		$this->debug("in serialize_val: name=$name, type=$type, name_ns=$name_ns, type_ns=$type_ns, use=$use");
+		$this->appendDebug('value=' . $this->varDump($val));
+		$this->appendDebug('attributes=' . $this->varDump($attributes));
+		
+    	if(is_object($val) && get_class($val) == 'soapval'){
+        	return $val->serialize($use);
+        }
+		// force valid name if necessary
+		if (is_numeric($name)) {
+			$name = '__numeric_' . $name;
+		} elseif (! $name) {
+			$name = 'noname';
+		}
+		// if name has ns, add ns prefix to name
+		$xmlns = '';
+        if($name_ns){
+			$prefix = 'nu'.rand(1000,9999);
+			$name = $prefix.':'.$name;
+			$xmlns .= " xmlns:$prefix=\"$name_ns\"";
+		}
+		// if type is prefixed, create type prefix
+		if($type_ns != '' && $type_ns == $this->namespaces['xsd']){
+			// need to fix this. shouldn't default to xsd if no ns specified
+		    // w/o checking against typemap
+			$type_prefix = 'xsd';
+		} elseif($type_ns){
+			$type_prefix = 'ns'.rand(1000,9999);
+			$xmlns .= " xmlns:$type_prefix=\"$type_ns\"";
+		}
+		// serialize attributes if present
+		$atts = '';
+		if($attributes){
+			foreach($attributes as $k => $v){
+				$atts .= " $k=\"".$this->expandEntities($v).'"';
+			}
+		}
+		// serialize null value
+		if (is_null($val)) {
+			if ($use == 'literal') {
+				// TODO: depends on minOccurs
+	        	return "<$name$xmlns $atts/>";
+        	} else {
+				if (isset($type) && isset($type_prefix)) {
+					$type_str = " xsi:type=\"$type_prefix:$type\"";
+				} else {
+					$type_str = '';
+				}
+	        	return "<$name$xmlns$type_str $atts xsi:nil=\"true\"/>";
+        	}
+		}
+        // serialize if an xsd built-in primitive type
+        if($type != '' && isset($this->typemap[$this->XMLSchemaVersion][$type])){
+        	if (is_bool($val)) {
+        		if ($type == 'boolean') {
+	        		$val = $val ? 'true' : 'false';
+	        	} elseif (! $val) {
+	        		$val = 0;
+	        	}
+			} else if (is_string($val)) {
+				$val = $this->expandEntities($val);
+			}
+			if ($use == 'literal') {
+	        	return "<$name$xmlns $atts>$val</$name>";
+        	} else {
+	        	return "<$name$xmlns $atts xsi:type=\"xsd:$type\">$val</$name>";
+        	}
+        }
+		// detect type and serialize
+		$xml = '';
+		switch(true) {
+			case (is_bool($val) || $type == 'boolean'):
+        		if ($type == 'boolean') {
+	        		$val = $val ? 'true' : 'false';
+	        	} elseif (! $val) {
+	        		$val = 0;
+	        	}
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:boolean\"$atts>$val</$name>";
+				}
+				break;
+			case (is_int($val) || is_long($val) || $type == 'int'):
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:int\"$atts>$val</$name>";
+				}
+				break;
+			case (is_float($val)|| is_double($val) || $type == 'float'):
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:float\"$atts>$val</$name>";
+				}
+				break;
+			case (is_string($val) || $type == 'string'):
+				$val = $this->expandEntities($val);
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:string\"$atts>$val</$name>";
+				}
+				break;
+			case is_object($val):
+				if (! $name) {
+					$name = get_class($val);
+					$this->debug("In serialize_val, used class name $name as element name");
+				} else {
+					$this->debug("In serialize_val, do not override name $name for element name for class " . get_class($val));
+				}
+				foreach(get_object_vars($val) as $k => $v){
+					$pXml = isset($pXml) ? $pXml.$this->serialize_val($v,$k,false,false,false,false,$use) : $this->serialize_val($v,$k,false,false,false,false,$use);
+				}
+				$xml .= '<'.$name.'>'.$pXml.'</'.$name.'>';
+				break;
+			break;
+			case (is_array($val) || $type):
+				// detect if struct or array
+				$valueType = $this->isArraySimpleOrStruct($val);
+                if($valueType=='arraySimple' || ereg('^ArrayOf',$type)){
+					$i = 0;
+					if(is_array($val) && count($val)> 0){
+						foreach($val as $v){
+	                    	if(is_object($v) && get_class($v) ==  'soapval'){
+								$tt_ns = $v->type_ns;
+								$tt = $v->type;
+							} elseif (is_array($v)) {
+								$tt = $this->isArraySimpleOrStruct($v);
+							} else {
+								$tt = gettype($v);
+	                        }
+							$array_types[$tt] = 1;
+							// TODO: for literal, the name should be $name
+							$xml .= $this->serialize_val($v,'item',false,false,false,false,$use);
+							++$i;
+						}
+						if(count($array_types) > 1){
+							$array_typename = 'xsd:anyType';
+						} elseif(isset($tt) && isset($this->typemap[$this->XMLSchemaVersion][$tt])) {
+							if ($tt == 'integer') {
+								$tt = 'int';
+							}
+							$array_typename = 'xsd:'.$tt;
+						} elseif(isset($tt) && $tt == 'arraySimple'){
+							$array_typename = 'SOAP-ENC:Array';
+						} elseif(isset($tt) && $tt == 'arrayStruct'){
+							$array_typename = 'unnamed_struct_use_soapval';
+						} else {
+							// if type is prefixed, create type prefix
+							if ($tt_ns != '' && $tt_ns == $this->namespaces['xsd']){
+								 $array_typename = 'xsd:' . $tt;
+							} elseif ($tt_ns) {
+								$tt_prefix = 'ns' . rand(1000, 9999);
+								$array_typename = "$tt_prefix:$tt";
+								$xmlns .= " xmlns:$tt_prefix=\"$tt_ns\"";
+							} else {
+								$array_typename = $tt;
+							}
+						}
+						$array_type = $i;
+						if ($use == 'literal') {
+							$type_str = '';
+						} else if (isset($type) && isset($type_prefix)) {
+							$type_str = " xsi:type=\"$type_prefix:$type\"";
+						} else {
+							$type_str = " xsi:type=\"SOAP-ENC:Array\" SOAP-ENC:arrayType=\"".$array_typename."[$array_type]\"";
+						}
+					// empty array
+					} else {
+						if ($use == 'literal') {
+							$type_str = '';
+						} else if (isset($type) && isset($type_prefix)) {
+							$type_str = " xsi:type=\"$type_prefix:$type\"";
+						} else {
+							$type_str = " xsi:type=\"SOAP-ENC:Array\" SOAP-ENC:arrayType=\"xsd:anyType[0]\"";
+						}
+					}
+					// TODO: for array in literal, there is no wrapper here
+					$xml = "<$name$xmlns$type_str$atts>".$xml."</$name>";
+				} else {
+					// got a struct
+					if(isset($type) && isset($type_prefix)){
+						$type_str = " xsi:type=\"$type_prefix:$type\"";
+					} else {
+						$type_str = '';
+					}
+					if ($use == 'literal') {
+						$xml .= "<$name$xmlns $atts>";
+					} else {
+						$xml .= "<$name$xmlns$type_str$atts>";
+					}
+					foreach($val as $k => $v){
+						// Apache Map
+						if ($type == 'Map' && $type_ns == 'http://xml.apache.org/xml-soap') {
+							$xml .= '<item>';
+							$xml .= $this->serialize_val($k,'key',false,false,false,false,$use);
+							$xml .= $this->serialize_val($v,'value',false,false,false,false,$use);
+							$xml .= '</item>';
+						} else {
+							$xml .= $this->serialize_val($v,$k,false,false,false,false,$use);
+						}
+					}
+					$xml .= "</$name>";
+				}
+				break;
+			default:
+				$xml .= 'not detected, got '.gettype($val).' for '.$val;
+				break;
+		}
+		return $xml;
+	}
+
+    /**
+    * serializes a message
+    *
+    * @param string $body the XML of the SOAP body
+    * @param mixed $headers optional string of XML with SOAP header content, or array of soapval objects for SOAP headers
+    * @param array $namespaces optional the namespaces used in generating the body and headers
+    * @param string $style optional (rpc|document)
+    * @param string $use optional (encoded|literal)
+    * @param string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+    * @return string the message
+    * @access public
+    */
+    function serializeEnvelope($body,$headers=false,$namespaces=array(),$style='rpc',$use='encoded',$encodingStyle='http://schemas.xmlsoap.org/soap/encoding/'){
+    // TODO: add an option to automatically run utf8_encode on $body and $headers
+    // if $this->soap_defencoding is UTF-8.  Not doing this automatically allows
+    // one to send arbitrary UTF-8 characters, not just characters that map to ISO-8859-1
+
+	$this->debug("In serializeEnvelope length=" . strlen($body) . " body (max 1000 characters)=" . substr($body, 0, 1000) . " style=$style use=$use encodingStyle=$encodingStyle");
+	$this->debug("headers:");
+	$this->appendDebug($this->varDump($headers));
+	$this->debug("namespaces:");
+	$this->appendDebug($this->varDump($namespaces));
+
+	// serialize namespaces
+    $ns_string = '';
+	foreach(array_merge($this->namespaces,$namespaces) as $k => $v){
+		$ns_string .= " xmlns:$k=\"$v\"";
+	}
+	if($encodingStyle) {
+		$ns_string = " SOAP-ENV:encodingStyle=\"$encodingStyle\"$ns_string";
+	}
+
+	// serialize headers
+	if($headers){
+		if (is_array($headers)) {
+			$xml = '';
+			foreach ($headers as $header) {
+				$xml .= $this->serialize_val($header, false, false, false, false, false, $use);
+			}
+			$headers = $xml;
+			$this->debug("In serializeEnvelope, serialzied array of headers to $headers");
+		}
+		$headers = "<SOAP-ENV:Header>".$headers."</SOAP-ENV:Header>";
+	}
+	// serialize envelope
+	return
+	'<?xml version="1.0" encoding="'.$this->soap_defencoding .'"?'.">".
+	'<SOAP-ENV:Envelope'.$ns_string.">".
+	$headers.
+	"<SOAP-ENV:Body>".
+		$body.
+	"</SOAP-ENV:Body>".
+	"</SOAP-ENV:Envelope>";
+    }
+
+	/**
+	 * formats a string to be inserted into an HTML stream
+	 *
+	 * @param string $str The string to format
+	 * @return string The formatted string
+	 * @access public
+	 * @deprecated
+	 */
+    function formatDump($str){
+		$str = htmlspecialchars($str);
+		return nl2br($str);
+    }
+
+	/**
+	* contracts (changes namespace to prefix) a qualified name
+	*
+	* @param    string $qname qname
+	* @return	string contracted qname
+	* @access   private
+	*/
+	function contractQname($qname){
+		// get element namespace
+		//$this->xdebug("Contract $qname");
+		if (strrpos($qname, ':')) {
+			// get unqualified name
+			$name = substr($qname, strrpos($qname, ':') + 1);
+			// get ns
+			$ns = substr($qname, 0, strrpos($qname, ':'));
+			$p = $this->getPrefixFromNamespace($ns);
+			if ($p) {
+				return $p . ':' . $name;
+			}
+			return $qname;
+		} else {
+			return $qname;
+		}
+	}
+
+	/**
+	* expands (changes prefix to namespace) a qualified name
+	*
+	* @param    string $string qname
+	* @return	string expanded qname
+	* @access   private
+	*/
+	function expandQname($qname){
+		// get element prefix
+		if(strpos($qname,':') && !ereg('^http://',$qname)){
+			// get unqualified name
+			$name = substr(strstr($qname,':'),1);
+			// get ns prefix
+			$prefix = substr($qname,0,strpos($qname,':'));
+			if(isset($this->namespaces[$prefix])){
+				return $this->namespaces[$prefix].':'.$name;
+			} else {
+				return $qname;
+			}
+		} else {
+			return $qname;
+		}
+	}
+
+    /**
+    * returns the local part of a prefixed string
+    * returns the original string, if not prefixed
+    *
+    * @param string $str The prefixed string
+    * @return string The local part
+    * @access public
+    */
+	function getLocalPart($str){
+		if($sstr = strrchr($str,':')){
+			// get unqualified name
+			return substr( $sstr, 1 );
+		} else {
+			return $str;
+		}
+	}
+
+	/**
+    * returns the prefix part of a prefixed string
+    * returns false, if not prefixed
+    *
+    * @param string $str The prefixed string
+    * @return mixed The prefix or false if there is no prefix
+    * @access public
+    */
+	function getPrefix($str){
+		if($pos = strrpos($str,':')){
+			// get prefix
+			return substr($str,0,$pos);
+		}
+		return false;
+	}
+
+	/**
+    * pass it a prefix, it returns a namespace
+    *
+    * @param string $prefix The prefix
+    * @return mixed The namespace, false if no namespace has the specified prefix
+    * @access public
+    */
+	function getNamespaceFromPrefix($prefix){
+		if (isset($this->namespaces[$prefix])) {
+			return $this->namespaces[$prefix];
+		}
+		//$this->setError("No namespace registered for prefix '$prefix'");
+		return false;
+	}
+
+	/**
+    * returns the prefix for a given namespace (or prefix)
+    * or false if no prefixes registered for the given namespace
+    *
+    * @param string $ns The namespace
+    * @return mixed The prefix, false if the namespace has no prefixes
+    * @access public
+    */
+	function getPrefixFromNamespace($ns) {
+		foreach ($this->namespaces as $p => $n) {
+			if ($ns == $n || $ns == $p) {
+			    $this->usedNamespaces[$p] = $n;
+				return $p;
+			}
+		}
+		return false;
+	}
+
+	/**
+    * returns the time in ODBC canonical form with microseconds
+    *
+    * @return string The time in ODBC canonical form with microseconds
+    * @access public
+    */
+	function getmicrotime() {
+		if (function_exists('gettimeofday')) {
+			$tod = gettimeofday();
+			$sec = $tod['sec'];
+			$usec = $tod['usec'];
+		} else {
+			$sec = time();
+			$usec = 0;
+		}
+		return strftime('%Y-%m-%d %H:%M:%S', $sec) . '.' . sprintf('%06d', $usec);
+	}
+
+	/**
+	 * Returns a string with the output of var_dump
+	 *
+	 * @param mixed $data The variable to var_dump
+	 * @return string The output of var_dump
+	 * @access public
+	 */
+    function varDump($data) {
+		ob_start();
+		var_dump($data);
+		$ret_val = ob_get_contents();
+		ob_end_clean();
+		return $ret_val;
+	}
+}
+
+// XML Schema Datatype Helper Functions
+
+//xsd:dateTime helpers
+
+/**
+* convert unix timestamp to ISO 8601 compliant date string
+*
+* @param    string $timestamp Unix time stamp
+* @access   public
+*/
+function timestamp_to_iso8601($timestamp,$utc=true){
+	$datestr = date('Y-m-d\TH:i:sO',$timestamp);
+	if($utc){
+		$eregStr =
+		'([0-9]{4})-'.	// centuries & years CCYY-
+		'([0-9]{2})-'.	// months MM-
+		'([0-9]{2})'.	// days DD
+		'T'.			// separator T
+		'([0-9]{2}):'.	// hours hh:
+		'([0-9]{2}):'.	// minutes mm:
+		'([0-9]{2})(\.[0-9]*)?'. // seconds ss.ss...
+		'(Z|[+\-][0-9]{2}:?[0-9]{2})?'; // Z to indicate UTC, -/+HH:MM:SS.SS... for local tz's
+
+		if(ereg($eregStr,$datestr,$regs)){
+			return sprintf('%04d-%02d-%02dT%02d:%02d:%02dZ',$regs[1],$regs[2],$regs[3],$regs[4],$regs[5],$regs[6]);
+		}
+		return false;
+	} else {
+		return $datestr;
+	}
+}
+
+/**
+* convert ISO 8601 compliant date string to unix timestamp
+*
+* @param    string $datestr ISO 8601 compliant date string
+* @access   public
+*/
+function iso8601_to_timestamp($datestr){
+	$eregStr =
+	'([0-9]{4})-'.	// centuries & years CCYY-
+	'([0-9]{2})-'.	// months MM-
+	'([0-9]{2})'.	// days DD
+	'T'.			// separator T
+	'([0-9]{2}):'.	// hours hh:
+	'([0-9]{2}):'.	// minutes mm:
+	'([0-9]{2})(\.[0-9]+)?'. // seconds ss.ss...
+	'(Z|[+\-][0-9]{2}:?[0-9]{2})?'; // Z to indicate UTC, -/+HH:MM:SS.SS... for local tz's
+	if(ereg($eregStr,$datestr,$regs)){
+		// not utc
+		if($regs[8] != 'Z'){
+			$op = substr($regs[8],0,1);
+			$h = substr($regs[8],1,2);
+			$m = substr($regs[8],strlen($regs[8])-2,2);
+			if($op == '-'){
+				$regs[4] = $regs[4] + $h;
+				$regs[5] = $regs[5] + $m;
+			} elseif($op == '+'){
+				$regs[4] = $regs[4] - $h;
+				$regs[5] = $regs[5] - $m;
+			}
+		}
+		return strtotime("$regs[1]-$regs[2]-$regs[3] $regs[4]:$regs[5]:$regs[6]Z");
+	} else {
+		return false;
+	}
+}
+
+/**
+* sleeps some number of microseconds
+*
+* @param    string $usec the number of microseconds to sleep
+* @access   public
+* @deprecated
+*/
+function usleepWindows($usec)
+{
+	$start = gettimeofday();
+	
+	do
+	{
+		$stop = gettimeofday();
+		$timePassed = 1000000 * ($stop['sec'] - $start['sec'])
+		+ $stop['usec'] - $start['usec'];
+	}
+	while ($timePassed < $usec);
+}
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soap_fault.php
===================================================================
--- cms/trunk/includes/nusoap/class.soap_fault.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soap_fault.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,86 @@
+<?php
+
+
+
+
+/**
+* Contains information for a SOAP fault.
+* Mainly used for returning faults from deployed functions
+* in a server instance.
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soap_fault.php,v 1.12 2005/07/27 19:24:42 snichol Exp $
+* @access public
+*/
+class soap_fault extends nusoap_base {
+	/**
+	 * The fault code (client|server)
+	 * @var string
+	 * @access private
+	 */
+	var $faultcode;
+	/**
+	 * The fault actor
+	 * @var string
+	 * @access private
+	 */
+	var $faultactor;
+	/**
+	 * The fault string, a description of the fault
+	 * @var string
+	 * @access private
+	 */
+	var $faultstring;
+	/**
+	 * The fault detail, typically a string or array of string
+	 * @var mixed
+	 * @access private
+	 */
+	var $faultdetail;
+
+	/**
+	* constructor
+    *
+    * @param string $faultcode (client | server)
+    * @param string $faultactor only used when msg routed between multiple actors
+    * @param string $faultstring human readable error message
+    * @param mixed $faultdetail detail, typically a string or array of string
+	*/
+	function soap_fault($faultcode,$faultactor='',$faultstring='',$faultdetail=''){
+		parent::nusoap_base();
+		$this->faultcode = $faultcode;
+		$this->faultactor = $faultactor;
+		$this->faultstring = $faultstring;
+		$this->faultdetail = $faultdetail;
+	}
+
+	/**
+	* serialize a fault
+	*
+	* @return	string	The serialization of the fault instance.
+	* @access   public
+	*/
+	function serialize(){
+		$ns_string = '';
+		foreach($this->namespaces as $k => $v){
+			$ns_string .= "\n  xmlns:$k=\"$v\"";
+		}
+		$return_msg =
+			'<?xml version="1.0" encoding="'.$this->soap_defencoding.'"?>'.
+			'<SOAP-ENV:Envelope SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"'.$ns_string.">\n".
+				'<SOAP-ENV:Body>'.
+				'<SOAP-ENV:Fault>'.
+					$this->serialize_val($this->faultcode, 'faultcode').
+					$this->serialize_val($this->faultactor, 'faultactor').
+					$this->serialize_val($this->faultstring, 'faultstring').
+					$this->serialize_val($this->faultdetail, 'detail').
+				'</SOAP-ENV:Fault>'.
+				'</SOAP-ENV:Body>'.
+			'</SOAP-ENV:Envelope>';
+		return $return_msg;
+	}
+}
+
+
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soap_parser.php
===================================================================
--- cms/trunk/includes/nusoap/class.soap_parser.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soap_parser.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,599 @@
+<?php
+
+
+
+
+/**
+*
+* soap_parser class parses SOAP XML messages into native PHP values
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soap_parser.php,v 1.36 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soap_parser extends nusoap_base {
+
+	var $xml = '';
+	var $xml_encoding = '';
+	var $method = '';
+	var $root_struct = '';
+	var $root_struct_name = '';
+	var $root_struct_namespace = '';
+	var $root_header = '';
+    var $document = '';			// incoming SOAP body (text)
+	// determines where in the message we are (envelope,header,body,method)
+	var $status = '';
+	var $position = 0;
+	var $depth = 0;
+	var $default_namespace = '';
+	var $namespaces = array();
+	var $message = array();
+    var $parent = '';
+	var $fault = false;
+	var $fault_code = '';
+	var $fault_str = '';
+	var $fault_detail = '';
+	var $depth_array = array();
+	var $debug_flag = true;
+	var $soapresponse = NULL;
+	var $responseHeaders = '';	// incoming SOAP headers (text)
+	var $body_position = 0;
+	// for multiref parsing:
+	// array of id => pos
+	var $ids = array();
+	// array of id => hrefs => pos
+	var $multirefs = array();
+	// toggle for auto-decoding element content
+	var $decode_utf8 = true;
+
+	/**
+	* constructor that actually does the parsing
+	*
+	* @param    string $xml SOAP message
+	* @param    string $encoding character encoding scheme of message
+	* @param    string $method method for which XML is parsed (unused?)
+	* @param    string $decode_utf8 whether to decode UTF-8 to ISO-8859-1
+	* @access   public
+	*/
+	function soap_parser($xml,$encoding='UTF-8',$method='',$decode_utf8=true){
+		parent::nusoap_base();
+		$this->xml = $xml;
+		$this->xml_encoding = $encoding;
+		$this->method = $method;
+		$this->decode_utf8 = $decode_utf8;
+
+		// Check whether content has been read.
+		if(!empty($xml)){
+			// Check XML encoding
+			$pos_xml = strpos($xml, '<?xml');
+			if ($pos_xml !== FALSE) {
+				$xml_decl = substr($xml, $pos_xml, strpos($xml, '?>', $pos_xml + 2) - $pos_xml + 1);
+				if (preg_match("/encoding=[\"']([^\"']*)[\"']/", $xml_decl, $res)) {
+					$xml_encoding = $res[1];
+					if (strtoupper($xml_encoding) != $encoding) {
+						$err = "Charset from HTTP Content-Type '" . $encoding . "' does not match encoding from XML declaration '" . $xml_encoding . "'";
+						$this->debug($err);
+						if ($encoding != 'ISO-8859-1' || strtoupper($xml_encoding) != 'UTF-8') {
+							$this->setError($err);
+							return;
+						}
+						// when HTTP says ISO-8859-1 (the default) and XML says UTF-8 (the typical), assume the other endpoint is just sloppy and proceed
+					} else {
+						$this->debug('Charset from HTTP Content-Type matches encoding from XML declaration');
+					}
+				} else {
+					$this->debug('No encoding specified in XML declaration');
+				}
+			} else {
+				$this->debug('No XML declaration');
+			}
+			$this->debug('Entering soap_parser(), length='.strlen($xml).', encoding='.$encoding);
+			// Create an XML parser - why not xml_parser_create_ns?
+			$this->parser = xml_parser_create($this->xml_encoding);
+			// Set the options for parsing the XML data.
+			//xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);
+			xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0);
+			xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, $this->xml_encoding);
+			// Set the object for the parser.
+			xml_set_object($this->parser, $this);
+			// Set the element handlers for the parser.
+			xml_set_element_handler($this->parser, 'start_element','end_element');
+			xml_set_character_data_handler($this->parser,'character_data');
+
+			// Parse the XML file.
+			if(!xml_parse($this->parser,$xml,true)){
+			    // Display an error message.
+			    $err = sprintf('XML error parsing SOAP payload on line %d: %s',
+			    xml_get_current_line_number($this->parser),
+			    xml_error_string(xml_get_error_code($this->parser)));
+				$this->debug($err);
+				$this->debug("XML payload:\n" . $xml);
+				$this->setError($err);
+			} else {
+				$this->debug('parsed successfully, found root struct: '.$this->root_struct.' of name '.$this->root_struct_name);
+				// get final value
+				$this->soapresponse = $this->message[$this->root_struct]['result'];
+				// get header value: no, because this is documented as XML string
+//				if($this->root_header != '' && isset($this->message[$this->root_header]['result'])){
+//					$this->responseHeaders = $this->message[$this->root_header]['result'];
+//				}
+				// resolve hrefs/ids
+				if(sizeof($this->multirefs) > 0){
+					foreach($this->multirefs as $id => $hrefs){
+						$this->debug('resolving multirefs for id: '.$id);
+						$idVal = $this->buildVal($this->ids[$id]);
+						if (is_array($idVal) && isset($idVal['!id'])) {
+							unset($idVal['!id']);
+						}
+						foreach($hrefs as $refPos => $ref){
+							$this->debug('resolving href at pos '.$refPos);
+							$this->multirefs[$id][$refPos] = $idVal;
+						}
+					}
+				}
+			}
+			xml_parser_free($this->parser);
+		} else {
+			$this->debug('xml was empty, didn\'t parse!');
+			$this->setError('xml was empty, didn\'t parse!');
+		}
+	}
+
+	/**
+	* start-element handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $name element name
+	* @param    array $attrs associative array of attributes
+	* @access   private
+	*/
+	function start_element($parser, $name, $attrs) {
+		// position in a total number of elements, starting from 0
+		// update class level pos
+		$pos = $this->position++;
+		// and set mine
+		$this->message[$pos] = array('pos' => $pos,'children'=>'','cdata'=>'');
+		// depth = how many levels removed from root?
+		// set mine as current global depth and increment global depth value
+		$this->message[$pos]['depth'] = $this->depth++;
+
+		// else add self as child to whoever the current parent is
+		if($pos != 0){
+			$this->message[$this->parent]['children'] .= '|'.$pos;
+		}
+		// set my parent
+		$this->message[$pos]['parent'] = $this->parent;
+		// set self as current parent
+		$this->parent = $pos;
+		// set self as current value for this depth
+		$this->depth_array[$this->depth] = $pos;
+		// get element prefix
+		if(strpos($name,':')){
+			// get ns prefix
+			$prefix = substr($name,0,strpos($name,':'));
+			// get unqualified name
+			$name = substr(strstr($name,':'),1);
+		}
+		// set status
+		if($name == 'Envelope'){
+			$this->status = 'envelope';
+		} elseif($name == 'Header'){
+			$this->root_header = $pos;
+			$this->status = 'header';
+		} elseif($name == 'Body'){
+			$this->status = 'body';
+			$this->body_position = $pos;
+		// set method
+		} elseif($this->status == 'body' && $pos == ($this->body_position+1)){
+			$this->status = 'method';
+			$this->root_struct_name = $name;
+			$this->root_struct = $pos;
+			$this->message[$pos]['type'] = 'struct';
+			$this->debug("found root struct $this->root_struct_name, pos $this->root_struct");
+		}
+		// set my status
+		$this->message[$pos]['status'] = $this->status;
+		// set name
+		$this->message[$pos]['name'] = htmlspecialchars($name);
+		// set attrs
+		$this->message[$pos]['attrs'] = $attrs;
+
+		// loop through atts, logging ns and type declarations
+        $attstr = '';
+		foreach($attrs as $key => $value){
+        	$key_prefix = $this->getPrefix($key);
+			$key_localpart = $this->getLocalPart($key);
+			// if ns declarations, add to class level array of valid namespaces
+            if($key_prefix == 'xmlns'){
+				if(ereg('^http://www.w3.org/[0-9]{4}/XMLSchema$',$value)){
+					$this->XMLSchemaVersion = $value;
+					$this->namespaces['xsd'] = $this->XMLSchemaVersion;
+					$this->namespaces['xsi'] = $this->XMLSchemaVersion.'-instance';
+				}
+                $this->namespaces[$key_localpart] = $value;
+				// set method namespace
+				if($name == $this->root_struct_name){
+					$this->methodNamespace = $value;
+				}
+			// if it's a type declaration, set type
+            } elseif($key_localpart == 'type'){
+            	$value_prefix = $this->getPrefix($value);
+                $value_localpart = $this->getLocalPart($value);
+				$this->message[$pos]['type'] = $value_localpart;
+				$this->message[$pos]['typePrefix'] = $value_prefix;
+                if(isset($this->namespaces[$value_prefix])){
+                	$this->message[$pos]['type_namespace'] = $this->namespaces[$value_prefix];
+                } else if(isset($attrs['xmlns:'.$value_prefix])) {
+					$this->message[$pos]['type_namespace'] = $attrs['xmlns:'.$value_prefix];
+                }
+				// should do something here with the namespace of specified type?
+			} elseif($key_localpart == 'arrayType'){
+				$this->message[$pos]['type'] = 'array';
+				/* do arrayType ereg here
+				[1]    arrayTypeValue    ::=    atype asize
+				[2]    atype    ::=    QName rank*
+				[3]    rank    ::=    '[' (',')* ']'
+				[4]    asize    ::=    '[' length~ ']'
+				[5]    length    ::=    nextDimension* Digit+
+				[6]    nextDimension    ::=    Digit+ ','
+				*/
+				$expr = '([A-Za-z0-9_]+):([A-Za-z]+[A-Za-z0-9_]+)\[([0-9]+),?([0-9]*)\]';
+				if(ereg($expr,$value,$regs)){
+					$this->message[$pos]['typePrefix'] = $regs[1];
+					$this->message[$pos]['arrayTypePrefix'] = $regs[1];
+	                if (isset($this->namespaces[$regs[1]])) {
+	                	$this->message[$pos]['arrayTypeNamespace'] = $this->namespaces[$regs[1]];
+	                } else if (isset($attrs['xmlns:'.$regs[1]])) {
+						$this->message[$pos]['arrayTypeNamespace'] = $attrs['xmlns:'.$regs[1]];
+	                }
+					$this->message[$pos]['arrayType'] = $regs[2];
+					$this->message[$pos]['arraySize'] = $regs[3];
+					$this->message[$pos]['arrayCols'] = $regs[4];
+				}
+			// specifies nil value (or not)
+			} elseif ($key_localpart == 'nil'){
+				$this->message[$pos]['nil'] = ($value == 'true' || $value == '1');
+			// some other attribute
+			} elseif ($key != 'href' && $key != 'xmlns' && $key_localpart != 'encodingStyle' && $key_localpart != 'root') {
+				$this->message[$pos]['xattrs']['!' . $key] = $value;
+			}
+
+			if ($key == 'xmlns') {
+				$this->default_namespace = $value;
+			}
+			// log id
+			if($key == 'id'){
+				$this->ids[$value] = $pos;
+			}
+			// root
+			if($key_localpart == 'root' && $value == 1){
+				$this->status = 'method';
+				$this->root_struct_name = $name;
+				$this->root_struct = $pos;
+				$this->debug("found root struct $this->root_struct_name, pos $pos");
+			}
+            // for doclit
+            $attstr .= " $key=\"$value\"";
+		}
+        // get namespace - must be done after namespace atts are processed
+		if(isset($prefix)){
+			$this->message[$pos]['namespace'] = $this->namespaces[$prefix];
+			$this->default_namespace = $this->namespaces[$prefix];
+		} else {
+			$this->message[$pos]['namespace'] = $this->default_namespace;
+		}
+        if($this->status == 'header'){
+        	if ($this->root_header != $pos) {
+	        	$this->responseHeaders .= "<" . (isset($prefix) ? $prefix . ':' : '') . "$name$attstr>";
+	        }
+        } elseif($this->root_struct_name != ''){
+        	$this->document .= "<" . (isset($prefix) ? $prefix . ':' : '') . "$name$attstr>";
+        }
+	}
+
+	/**
+	* end-element handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $name element name
+	* @access   private
+	*/
+	function end_element($parser, $name) {
+		// position of current element is equal to the last value left in depth_array for my depth
+		$pos = $this->depth_array[$this->depth--];
+
+        // get element prefix
+		if(strpos($name,':')){
+			// get ns prefix
+			$prefix = substr($name,0,strpos($name,':'));
+			// get unqualified name
+			$name = substr(strstr($name,':'),1);
+		}
+		
+		// build to native type
+		if(isset($this->body_position) && $pos > $this->body_position){
+			// deal w/ multirefs
+			if(isset($this->message[$pos]['attrs']['href'])){
+				// get id
+				$id = substr($this->message[$pos]['attrs']['href'],1);
+				// add placeholder to href array
+				$this->multirefs[$id][$pos] = 'placeholder';
+				// add set a reference to it as the result value
+				$this->message[$pos]['result'] =& $this->multirefs[$id][$pos];
+            // build complexType values
+			} elseif($this->message[$pos]['children'] != ''){
+				// if result has already been generated (struct/array)
+				if(!isset($this->message[$pos]['result'])){
+					$this->message[$pos]['result'] = $this->buildVal($pos);
+				}
+			// build complexType values of attributes and possibly simpleContent
+			} elseif (isset($this->message[$pos]['xattrs'])) {
+				if (isset($this->message[$pos]['nil']) && $this->message[$pos]['nil']) {
+					$this->message[$pos]['xattrs']['!'] = null;
+				} elseif (isset($this->message[$pos]['cdata']) && trim($this->message[$pos]['cdata']) != '') {
+	            	if (isset($this->message[$pos]['type'])) {
+						$this->message[$pos]['xattrs']['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+					} else {
+						$parent = $this->message[$pos]['parent'];
+						if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+							$this->message[$pos]['xattrs']['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+						} else {
+							$this->message[$pos]['xattrs']['!'] = $this->message[$pos]['cdata'];
+						}
+					}
+				}
+				$this->message[$pos]['result'] = $this->message[$pos]['xattrs'];
+			// set value of simpleType (or nil complexType)
+			} else {
+            	//$this->debug('adding data for scalar value '.$this->message[$pos]['name'].' of value '.$this->message[$pos]['cdata']);
+				if (isset($this->message[$pos]['nil']) && $this->message[$pos]['nil']) {
+					$this->message[$pos]['xattrs']['!'] = null;
+				} elseif (isset($this->message[$pos]['type'])) {
+					$this->message[$pos]['result'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+				} else {
+					$parent = $this->message[$pos]['parent'];
+					if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+						$this->message[$pos]['result'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+					} else {
+						$this->message[$pos]['result'] = $this->message[$pos]['cdata'];
+					}
+				}
+
+				/* add value to parent's result, if parent is struct/array
+				$parent = $this->message[$pos]['parent'];
+				if($this->message[$parent]['type'] != 'map'){
+					if(strtolower($this->message[$parent]['type']) == 'array'){
+						$this->message[$parent]['result'][] = $this->message[$pos]['result'];
+					} else {
+						$this->message[$parent]['result'][$this->message[$pos]['name']] = $this->message[$pos]['result'];
+					}
+				}
+				*/
+			}
+		}
+		
+        // for doclit
+        if($this->status == 'header'){
+        	if ($this->root_header != $pos) {
+	        	$this->responseHeaders .= "</" . (isset($prefix) ? $prefix . ':' : '') . "$name>";
+	        }
+        } elseif($pos >= $this->root_struct){
+        	$this->document .= "</" . (isset($prefix) ? $prefix . ':' : '') . "$name>";
+        }
+		// switch status
+		if($pos == $this->root_struct){
+			$this->status = 'body';
+			$this->root_struct_namespace = $this->message[$pos]['namespace'];
+		} elseif($name == 'Body'){
+			$this->status = 'envelope';
+		 } elseif($name == 'Header'){
+			$this->status = 'envelope';
+		} elseif($name == 'Envelope'){
+			//
+		}
+		// set parent back to my parent
+		$this->parent = $this->message[$pos]['parent'];
+	}
+
+	/**
+	* element content handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $data element content
+	* @access   private
+	*/
+	function character_data($parser, $data){
+		$pos = $this->depth_array[$this->depth];
+		if ($this->xml_encoding=='UTF-8'){
+			// TODO: add an option to disable this for folks who want
+			// raw UTF-8 that, e.g., might not map to iso-8859-1
+			// TODO: this can also be handled with xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, "ISO-8859-1");
+			if($this->decode_utf8){
+				$data = utf8_decode($data);
+			}
+		}
+        $this->message[$pos]['cdata'] .= $data;
+        // for doclit
+        if($this->status == 'header'){
+        	$this->responseHeaders .= $data;
+        } else {
+        	$this->document .= $data;
+        }
+	}
+
+	/**
+	* get the parsed message
+	*
+	* @return	mixed
+	* @access   public
+	*/
+	function get_response(){
+		return $this->soapresponse;
+	}
+
+	/**
+	* get the parsed headers
+	*
+	* @return	string XML or empty if no headers
+	* @access   public
+	*/
+	function getHeaders(){
+	    return $this->responseHeaders;
+	}
+
+	/**
+	* decodes simple types into PHP variables
+	*
+	* @param    string $value value to decode
+	* @param    string $type XML type to decode
+	* @param    string $typens XML type namespace to decode
+	* @return	mixed PHP value
+	* @access   private
+	*/
+	function decodeSimple($value, $type, $typens) {
+		// TODO: use the namespace!
+		if ((!isset($type)) || $type == 'string' || $type == 'long' || $type == 'unsignedLong') {
+			return (string) $value;
+		}
+		if ($type == 'int' || $type == 'integer' || $type == 'short' || $type == 'byte') {
+			return (int) $value;
+		}
+		if ($type == 'float' || $type == 'double' || $type == 'decimal') {
+			return (double) $value;
+		}
+		if ($type == 'boolean') {
+			if (strtolower($value) == 'false' || strtolower($value) == 'f') {
+				return false;
+			}
+			return (boolean) $value;
+		}
+		if ($type == 'base64' || $type == 'base64Binary') {
+			$this->debug('Decode base64 value');
+			return base64_decode($value);
+		}
+		// obscure numeric types
+		if ($type == 'nonPositiveInteger' || $type == 'negativeInteger'
+			|| $type == 'nonNegativeInteger' || $type == 'positiveInteger'
+			|| $type == 'unsignedInt'
+			|| $type == 'unsignedShort' || $type == 'unsignedByte') {
+			return (int) $value;
+		}
+		// bogus: parser treats array with no elements as a simple type
+		if ($type == 'array') {
+			return array();
+		}
+		// everything else
+		return (string) $value;
+	}
+
+	/**
+	* builds response structures for compound values (arrays/structs)
+	* and scalars
+	*
+	* @param    integer $pos position in node tree
+	* @return	mixed	PHP value
+	* @access   private
+	*/
+	function buildVal($pos){
+		if(!isset($this->message[$pos]['type'])){
+			$this->message[$pos]['type'] = '';
+		}
+		$this->debug('in buildVal() for '.$this->message[$pos]['name']."(pos $pos) of type ".$this->message[$pos]['type']);
+		// if there are children...
+		if($this->message[$pos]['children'] != ''){
+			$this->debug('in buildVal, there are children');
+			$children = explode('|',$this->message[$pos]['children']);
+			array_shift($children); // knock off empty
+			// md array
+			if(isset($this->message[$pos]['arrayCols']) && $this->message[$pos]['arrayCols'] != ''){
+            	$r=0; // rowcount
+            	$c=0; // colcount
+            	foreach($children as $child_pos){
+					$this->debug("in buildVal, got an MD array element: $r, $c");
+					$params[$r][] = $this->message[$child_pos]['result'];
+				    $c++;
+				    if($c == $this->message[$pos]['arrayCols']){
+				    	$c = 0;
+						$r++;
+				    }
+                }
+            // array
+			} elseif($this->message[$pos]['type'] == 'array' || $this->message[$pos]['type'] == 'Array'){
+                $this->debug('in buildVal, adding array '.$this->message[$pos]['name']);
+                foreach($children as $child_pos){
+                	$params[] = &$this->message[$child_pos]['result'];
+                }
+            // apache Map type: java hashtable
+            } elseif($this->message[$pos]['type'] == 'Map' && $this->message[$pos]['type_namespace'] == 'http://xml.apache.org/xml-soap'){
+                $this->debug('in buildVal, Java Map '.$this->message[$pos]['name']);
+                foreach($children as $child_pos){
+                	$kv = explode("|",$this->message[$child_pos]['children']);
+                   	$params[$this->message[$kv[1]]['result']] = &$this->message[$kv[2]]['result'];
+                }
+            // generic compound type
+            //} elseif($this->message[$pos]['type'] == 'SOAPStruct' || $this->message[$pos]['type'] == 'struct') {
+		    } else {
+	    		// Apache Vector type: treat as an array
+                $this->debug('in buildVal, adding Java Vector '.$this->message[$pos]['name']);
+				if ($this->message[$pos]['type'] == 'Vector' && $this->message[$pos]['type_namespace'] == 'http://xml.apache.org/xml-soap') {
+					$notstruct = 1;
+				} else {
+					$notstruct = 0;
+	            }
+            	//
+            	foreach($children as $child_pos){
+            		if($notstruct){
+            			$params[] = &$this->message[$child_pos]['result'];
+            		} else {
+            			if (isset($params[$this->message[$child_pos]['name']])) {
+            				// de-serialize repeated element name into an array
+            				if ((!is_array($params[$this->message[$child_pos]['name']])) || (!isset($params[$this->message[$child_pos]['name']][0]))) {
+            					$params[$this->message[$child_pos]['name']] = array($params[$this->message[$child_pos]['name']]);
+            				}
+            				$params[$this->message[$child_pos]['name']][] = &$this->message[$child_pos]['result'];
+            			} else {
+					    	$params[$this->message[$child_pos]['name']] = &$this->message[$child_pos]['result'];
+					    }
+                	}
+                }
+			}
+			if (isset($this->message[$pos]['xattrs'])) {
+                $this->debug('in buildVal, handling attributes');
+				foreach ($this->message[$pos]['xattrs'] as $n => $v) {
+					$params[$n] = $v;
+				}
+			}
+			// handle simpleContent
+			if (isset($this->message[$pos]['cdata']) && trim($this->message[$pos]['cdata']) != '') {
+                $this->debug('in buildVal, handling simpleContent');
+            	if (isset($this->message[$pos]['type'])) {
+					$params['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+				} else {
+					$parent = $this->message[$pos]['parent'];
+					if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+						$params['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+					} else {
+						$params['!'] = $this->message[$pos]['cdata'];
+					}
+				}
+			}
+			return is_array($params) ? $params : array();
+		} else {
+        	$this->debug('in buildVal, no children, building scalar');
+			$cdata = isset($this->message[$pos]['cdata']) ? $this->message[$pos]['cdata'] : '';
+        	if (isset($this->message[$pos]['type'])) {
+				return $this->decodeSimple($cdata, $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+			}
+			$parent = $this->message[$pos]['parent'];
+			if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+				return $this->decodeSimple($cdata, $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+			}
+           	return $this->message[$pos]['cdata'];
+		}
+	}
+}
+
+
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soap_server.php
===================================================================
--- cms/trunk/includes/nusoap/class.soap_server.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soap_server.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,1038 @@
+<?php
+
+
+
+
+/**
+*
+* soap_server allows the user to create a SOAP server
+* that is capable of receiving messages and returning responses
+*
+* NOTE: WSDL functionality is experimental
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soap_server.php,v 1.48 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soap_server extends nusoap_base {
+	/**
+	 * HTTP headers of request
+	 * @var array
+	 * @access private
+	 */
+	var $headers = array();
+	/**
+	 * HTTP request
+	 * @var string
+	 * @access private
+	 */
+	var $request = '';
+	/**
+	 * SOAP headers from request (incomplete namespace resolution; special characters not escaped) (text)
+	 * @var string
+	 * @access public
+	 */
+	var $requestHeaders = '';
+	/**
+	 * SOAP body request portion (incomplete namespace resolution; special characters not escaped) (text)
+	 * @var string
+	 * @access public
+	 */
+	var $document = '';
+	/**
+	 * SOAP payload for request (text)
+	 * @var string
+	 * @access public
+	 */
+	var $requestSOAP = '';
+	/**
+	 * requested method namespace URI
+	 * @var string
+	 * @access private
+	 */
+	var $methodURI = '';
+	/**
+	 * name of method requested
+	 * @var string
+	 * @access private
+	 */
+	var $methodname = '';
+	/**
+	 * method parameters from request
+	 * @var array
+	 * @access private
+	 */
+	var $methodparams = array();
+	/**
+	 * SOAP Action from request
+	 * @var string
+	 * @access private
+	 */
+	var $SOAPAction = '';
+	/**
+	 * character set encoding of incoming (request) messages
+	 * @var string
+	 * @access public
+	 */
+	var $xml_encoding = '';
+	/**
+	 * toggles whether the parser decodes element content w/ utf8_decode()
+	 * @var boolean
+	 * @access public
+	 */
+    var $decode_utf8 = true;
+
+	/**
+	 * HTTP headers of response
+	 * @var array
+	 * @access public
+	 */
+	var $outgoing_headers = array();
+	/**
+	 * HTTP response
+	 * @var string
+	 * @access private
+	 */
+	var $response = '';
+	/**
+	 * SOAP headers for response (text)
+	 * @var string
+	 * @access public
+	 */
+	var $responseHeaders = '';
+	/**
+	 * SOAP payload for response (text)
+	 * @var string
+	 * @access private
+	 */
+	var $responseSOAP = '';
+	/**
+	 * method return value to place in response
+	 * @var mixed
+	 * @access private
+	 */
+	var $methodreturn = false;
+	/**
+	 * whether $methodreturn is a string of literal XML
+	 * @var boolean
+	 * @access public
+	 */
+	var $methodreturnisliteralxml = false;
+	/**
+	 * SOAP fault for response (or false)
+	 * @var mixed
+	 * @access private
+	 */
+	var $fault = false;
+	/**
+	 * text indication of result (for debugging)
+	 * @var string
+	 * @access private
+	 */
+	var $result = 'successful';
+
+	/**
+	 * assoc array of operations => opData; operations are added by the register()
+	 * method or by parsing an external WSDL definition
+	 * @var array
+	 * @access private
+	 */
+	var $operations = array();
+	/**
+	 * wsdl instance (if one)
+	 * @var mixed
+	 * @access private
+	 */
+	var $wsdl = false;
+	/**
+	 * URL for WSDL (if one)
+	 * @var mixed
+	 * @access private
+	 */
+	var $externalWSDLURL = false;
+	/**
+	 * whether to append debug to response as XML comment
+	 * @var boolean
+	 * @access public
+	 */
+	var $debug_flag = false;
+
+
+	/**
+	* constructor
+    * the optional parameter is a path to a WSDL file that you'd like to bind the server instance to.
+	*
+    * @param mixed $wsdl file path or URL (string), or wsdl instance (object)
+	* @access   public
+	*/
+	function soap_server($wsdl=false){
+		parent::nusoap_base();
+		// turn on debugging?
+		global $debug;
+		global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$this->debug("_SERVER is defined:");
+			$this->appendDebug($this->varDump($_SERVER));
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$this->debug("HTTP_SERVER_VARS is defined:");
+			$this->appendDebug($this->varDump($HTTP_SERVER_VARS));
+		} else {
+			$this->debug("Neither _SERVER nor HTTP_SERVER_VARS is defined.");
+		}
+
+		if (isset($debug)) {
+			$this->debug("In soap_server, set debug_flag=$debug based on global flag");
+			$this->debug_flag = $debug;
+		} elseif (isset($_SERVER['QUERY_STRING'])) {
+			$qs = explode('&', $_SERVER['QUERY_STRING']);
+			foreach ($qs as $v) {
+				if (substr($v, 0, 6) == 'debug=') {
+					$this->debug("In soap_server, set debug_flag=" . substr($v, 6) . " based on query string #1");
+					$this->debug_flag = substr($v, 6);
+				}
+			}
+		} elseif (isset($HTTP_SERVER_VARS['QUERY_STRING'])) {
+			$qs = explode('&', $HTTP_SERVER_VARS['QUERY_STRING']);
+			foreach ($qs as $v) {
+				if (substr($v, 0, 6) == 'debug=') {
+					$this->debug("In soap_server, set debug_flag=" . substr($v, 6) . " based on query string #2");
+					$this->debug_flag = substr($v, 6);
+				}
+			}
+		}
+
+		// wsdl
+		if($wsdl){
+			$this->debug("In soap_server, WSDL is specified");
+			if (is_object($wsdl) && (get_class($wsdl) == 'wsdl')) {
+				$this->wsdl = $wsdl;
+				$this->externalWSDLURL = $this->wsdl->wsdl;
+				$this->debug('Use existing wsdl instance from ' . $this->externalWSDLURL);
+			} else {
+				$this->debug('Create wsdl from ' . $wsdl);
+				$this->wsdl = new wsdl($wsdl);
+				$this->externalWSDLURL = $wsdl;
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			if($err = $this->wsdl->getError()){
+				die('WSDL ERROR: '.$err);
+			}
+		}
+	}
+
+	/**
+	* processes request and returns response
+	*
+	* @param    string $data usually is the value of $HTTP_RAW_POST_DATA
+	* @access   public
+	*/
+	function service($data){
+		global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER['QUERY_STRING'])) {
+			$qs = $_SERVER['QUERY_STRING'];
+		} elseif (isset($HTTP_SERVER_VARS['QUERY_STRING'])) {
+			$qs = $HTTP_SERVER_VARS['QUERY_STRING'];
+		} else {
+			$qs = '';
+		}
+		$this->debug("In service, query string=$qs");
+
+		if (ereg('wsdl', $qs) ){
+			$this->debug("In service, this is a request for WSDL");
+			if($this->externalWSDLURL){
+              if (strpos($this->externalWSDLURL,"://")!==false) { // assume URL
+				header('Location: '.$this->externalWSDLURL);
+              } else { // assume file
+                header("Content-Type: text/xml\r\n");
+                $fp = fopen($this->externalWSDLURL, 'r');
+                fpassthru($fp);
+              }
+			} elseif ($this->wsdl) {
+				header("Content-Type: text/xml; charset=ISO-8859-1\r\n");
+				print $this->wsdl->serialize($this->debug_flag);
+				if ($this->debug_flag) {
+					$this->debug('wsdl:');
+					$this->appendDebug($this->varDump($this->wsdl));
+					print $this->getDebugAsXMLComment();
+				}
+			} else {
+				header("Content-Type: text/html; charset=ISO-8859-1\r\n");
+				print "This service does not provide WSDL";
+			}
+		} elseif ($data == '' && $this->wsdl) {
+			$this->debug("In service, there is no data, so return Web description");
+			print $this->wsdl->webDescription();
+		} else {
+			$this->debug("In service, invoke the request");
+			$this->parse_request($data);
+			if (! $this->fault) {
+				$this->invoke_method();
+			}
+			if (! $this->fault) {
+				$this->serialize_return();
+			}
+			$this->send_response();
+		}
+	}
+
+	/**
+	* parses HTTP request headers.
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* headers
+	* request
+	* xml_encoding
+	* SOAPAction
+	*
+	* @access   private
+	*/
+	function parse_http_headers() {
+		global $HTTP_SERVER_VARS;
+
+		$this->request = '';
+		$this->SOAPAction = '';
+		if(function_exists('getallheaders')){
+			$this->debug("In parse_http_headers, use getallheaders");
+			$headers = getallheaders();
+			foreach($headers as $k=>$v){
+				$k = strtolower($k);
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+			// get SOAPAction header
+			if(isset($this->headers['soapaction'])){
+				$this->SOAPAction = str_replace('"','',$this->headers['soapaction']);
+			}
+			// get the character encoding of the incoming request
+			if(isset($this->headers['content-type']) && strpos($this->headers['content-type'],'=')){
+				$enc = str_replace('"','',substr(strstr($this->headers["content-type"],'='),1));
+				if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+					$this->xml_encoding = strtoupper($enc);
+				} else {
+					$this->xml_encoding = 'US-ASCII';
+				}
+			} else {
+				// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+				$this->xml_encoding = 'ISO-8859-1';
+			}
+		} elseif(isset($_SERVER) && is_array($_SERVER)){
+			$this->debug("In parse_http_headers, use _SERVER");
+			foreach ($_SERVER as $k => $v) {
+				if (substr($k, 0, 5) == 'HTTP_') {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', substr($k, 5)))); 	                                         $k = strtolower(substr($k, 5));
+				} else {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', $k))); 	                                         $k = strtolower($k);
+				}
+				if ($k == 'soapaction') {
+					// get SOAPAction header
+					$k = 'SOAPAction';
+					$v = str_replace('"', '', $v);
+					$v = str_replace('\\', '', $v);
+					$this->SOAPAction = $v;
+				} else if ($k == 'content-type') {
+					// get the character encoding of the incoming request
+					if (strpos($v, '=')) {
+						$enc = substr(strstr($v, '='), 1);
+						$enc = str_replace('"', '', $enc);
+						$enc = str_replace('\\', '', $enc);
+						if (eregi('^(ISO-8859-1|US-ASCII|UTF-8)$', $enc)) {
+							$this->xml_encoding = strtoupper($enc);
+						} else {
+							$this->xml_encoding = 'US-ASCII';
+						}
+					} else {
+						// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+						$this->xml_encoding = 'ISO-8859-1';
+					}
+				}
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+		} elseif (is_array($HTTP_SERVER_VARS)) {
+			$this->debug("In parse_http_headers, use HTTP_SERVER_VARS");
+			foreach ($HTTP_SERVER_VARS as $k => $v) {
+				if (substr($k, 0, 5) == 'HTTP_') {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', substr($k, 5)))); 	                                         $k = strtolower(substr($k, 5));
+				} else {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', $k))); 	                                         $k = strtolower($k);
+				}
+				if ($k == 'soapaction') {
+					// get SOAPAction header
+					$k = 'SOAPAction';
+					$v = str_replace('"', '', $v);
+					$v = str_replace('\\', '', $v);
+					$this->SOAPAction = $v;
+				} else if ($k == 'content-type') {
+					// get the character encoding of the incoming request
+					if (strpos($v, '=')) {
+						$enc = substr(strstr($v, '='), 1);
+						$enc = str_replace('"', '', $enc);
+						$enc = str_replace('\\', '', $enc);
+						if (eregi('^(ISO-8859-1|US-ASCII|UTF-8)$', $enc)) {
+							$this->xml_encoding = strtoupper($enc);
+						} else {
+							$this->xml_encoding = 'US-ASCII';
+						}
+					} else {
+						// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+						$this->xml_encoding = 'ISO-8859-1';
+					}
+				}
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+		} else {
+			$this->debug("In parse_http_headers, HTTP headers not accessible");
+			$this->setError("HTTP headers not accessible");
+		}
+	}
+
+	/**
+	* parses a request
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* headers
+	* request
+	* xml_encoding
+	* SOAPAction
+	* request
+	* requestSOAP
+	* methodURI
+	* methodname
+	* methodparams
+	* requestHeaders
+	* document
+	*
+	* This sets the fault field on error
+	*
+	* @param    string $data XML string
+	* @access   private
+	*/
+	function parse_request($data='') {
+		$this->debug('entering parse_request()');
+		$this->parse_http_headers();
+		$this->debug('got character encoding: '.$this->xml_encoding);
+		// uncompress if necessary
+		if (isset($this->headers['content-encoding']) && $this->headers['content-encoding'] != '') {
+			$this->debug('got content encoding: ' . $this->headers['content-encoding']);
+			if ($this->headers['content-encoding'] == 'deflate' || $this->headers['content-encoding'] == 'gzip') {
+		    	// if decoding works, use it. else assume data wasn't gzencoded
+				if (function_exists('gzuncompress')) {
+					if ($this->headers['content-encoding'] == 'deflate' && $degzdata = @gzuncompress($data)) {
+						$data = $degzdata;
+					} elseif ($this->headers['content-encoding'] == 'gzip' && $degzdata = gzinflate(substr($data, 10))) {
+						$data = $degzdata;
+					} else {
+						$this->fault('Client', 'Errors occurred when trying to decode the data');
+						return;
+					}
+				} else {
+					$this->fault('Client', 'This Server does not support compressed data');
+					return;
+				}
+			}
+		}
+		$this->request .= "\r\n".$data;
+		$data = $this->parseRequest($this->headers, $data);
+		$this->requestSOAP = $data;
+		$this->debug('leaving parse_request');
+	}
+
+	/**
+	* invokes a PHP function for the requested SOAP method
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* methodreturn
+	*
+	* Note that the PHP function that is called may also set the following
+	* fields to affect the response sent to the client
+	*
+	* responseHeaders
+	* outgoing_headers
+	*
+	* This sets the fault field on error
+	*
+	* @access   private
+	*/
+	function invoke_method() {
+		$this->debug('in invoke_method, methodname=' . $this->methodname . ' methodURI=' . $this->methodURI . ' SOAPAction=' . $this->SOAPAction);
+
+		if ($this->wsdl) {
+			if ($this->opData = $this->wsdl->getOperationData($this->methodname)) {
+				$this->debug('in invoke_method, found WSDL operation=' . $this->methodname);
+				$this->appendDebug('opData=' . $this->varDump($this->opData));
+			} elseif ($this->opData = $this->wsdl->getOperationDataForSoapAction($this->SOAPAction)) {
+				// Note: hopefully this case will only be used for doc/lit, since rpc services should have wrapper element
+				$this->debug('in invoke_method, found WSDL soapAction=' . $this->SOAPAction . ' for operation=' . $this->opData['name']);
+				$this->appendDebug('opData=' . $this->varDump($this->opData));
+				$this->methodname = $this->opData['name'];
+			} else {
+				$this->debug('in invoke_method, no WSDL for operation=' . $this->methodname);
+				$this->fault('Client', "Operation '" . $this->methodname . "' is not defined in the WSDL for this service");
+				return;
+			}
+		} else {
+			$this->debug('in invoke_method, no WSDL to validate method');
+		}
+
+		// if a . is present in $this->methodname, we see if there is a class in scope,
+		// which could be referred to. We will also distinguish between two deliminators,
+		// to allow methods to be called a the class or an instance
+		$class = '';
+		$method = '';
+		if (strpos($this->methodname, '..') > 0) {
+			$delim = '..';
+		} else if (strpos($this->methodname, '.') > 0) {
+			$delim = '.';
+		} else {
+			$delim = '';
+		}
+
+		if (strlen($delim) > 0 && substr_count($this->methodname, $delim) == 1 &&
+			class_exists(substr($this->methodname, 0, strpos($this->methodname, $delim)))) {
+			// get the class and method name
+			$class = substr($this->methodname, 0, strpos($this->methodname, $delim));
+			$method = substr($this->methodname, strpos($this->methodname, $delim) + strlen($delim));
+			$this->debug("in invoke_method, class=$class method=$method delim=$delim");
+		}
+
+		// does method exist?
+		if ($class == '') {
+			if (!function_exists($this->methodname)) {
+				$this->debug("in invoke_method, function '$this->methodname' not found!");
+				$this->result = 'fault: method not found';
+				$this->fault('Client',"method '$this->methodname' not defined in service");
+				return;
+			}
+		} else {
+			$method_to_compare = (substr(phpversion(), 0, 2) == '4.') ? strtolower($method) : $method;
+			if (!in_array($method_to_compare, get_class_methods($class))) {
+				$this->debug("in invoke_method, method '$this->methodname' not found in class '$class'!");
+				$this->result = 'fault: method not found';
+				$this->fault('Client',"method '$this->methodname' not defined in service");
+				return;
+			}
+		}
+
+		// evaluate message, getting back parameters
+		// verify that request parameters match the method's signature
+		if(! $this->verify_method($this->methodname,$this->methodparams)){
+			// debug
+			$this->debug('ERROR: request not verified against method signature');
+			$this->result = 'fault: request failed validation against method signature';
+			// return fault
+			$this->fault('Client',"Operation '$this->methodname' not defined in service.");
+			return;
+		}
+
+		// if there are parameters to pass
+		$this->debug('in invoke_method, params:');
+		$this->appendDebug($this->varDump($this->methodparams));
+		$this->debug("in invoke_method, calling '$this->methodname'");
+		if (!function_exists('call_user_func_array')) {
+			if ($class == '') {
+				$this->debug('in invoke_method, calling function using eval()');
+				$funcCall = "\$this->methodreturn = $this->methodname(";
+			} else {
+				if ($delim == '..') {
+					$this->debug('in invoke_method, calling class method using eval()');
+					$funcCall = "\$this->methodreturn = ".$class."::".$method."(";
+				} else {
+					$this->debug('in invoke_method, calling instance method using eval()');
+					// generate unique instance name
+					$instname = "\$inst_".time();
+					$funcCall = $instname." = new ".$class."(); ";
+					$funcCall .= "\$this->methodreturn = ".$instname."->".$method."(";
+				}
+			}
+			if ($this->methodparams) {
+				foreach ($this->methodparams as $param) {
+					if (is_array($param)) {
+						$this->fault('Client', 'NuSOAP does not handle complexType parameters correctly when using eval; call_user_func_array must be available');
+						return;
+					}
+					$funcCall .= "\"$param\",";
+				}
+				$funcCall = substr($funcCall, 0, -1);
+			}
+			$funcCall .= ');';
+			$this->debug('in invoke_method, function call: '.$funcCall);
+			@eval($funcCall);
+		} else {
+			if ($class == '') {
+				$this->debug('in invoke_method, calling function using call_user_func_array()');
+				$call_arg = "$this->methodname";	// straight assignment changes $this->methodname to lower case after call_user_func_array()
+			} elseif ($delim == '..') {
+				$this->debug('in invoke_method, calling class method using call_user_func_array()');
+				$call_arg = array ($class, $method);
+			} else {
+				$this->debug('in invoke_method, calling instance method using call_user_func_array()');
+				$instance = new $class ();
+				$call_arg = array(&$instance, $method);
+			}
+			$this->methodreturn = call_user_func_array($call_arg, $this->methodparams);
+		}
+        $this->debug('in invoke_method, methodreturn:');
+        $this->appendDebug($this->varDump($this->methodreturn));
+		$this->debug("in invoke_method, called method $this->methodname, received $this->methodreturn of type ".gettype($this->methodreturn));
+	}
+
+	/**
+	* serializes the return value from a PHP function into a full SOAP Envelope
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* responseSOAP
+	*
+	* This sets the fault field on error
+	*
+	* @access   private
+	*/
+	function serialize_return() {
+		$this->debug('Entering serialize_return methodname: ' . $this->methodname . ' methodURI: ' . $this->methodURI);
+		// if fault
+		if (isset($this->methodreturn) && (get_class($this->methodreturn) == 'soap_fault')) {
+			$this->debug('got a fault object from method');
+			$this->fault = $this->methodreturn;
+			return;
+		} elseif ($this->methodreturnisliteralxml) {
+			$return_val = $this->methodreturn;
+		// returned value(s)
+		} else {
+			$this->debug('got a(n) '.gettype($this->methodreturn).' from method');
+			$this->debug('serializing return value');
+			if($this->wsdl){
+				// weak attempt at supporting multiple output params
+				if(sizeof($this->opData['output']['parts']) > 1){
+			    	$opParams = $this->methodreturn;
+			    } else {
+			    	// TODO: is this really necessary?
+			    	$opParams = array($this->methodreturn);
+			    }
+			    $return_val = $this->wsdl->serializeRPCParameters($this->methodname,'output',$opParams);
+			    $this->appendDebug($this->wsdl->getDebug());
+			    $this->wsdl->clearDebug();
+				if($errstr = $this->wsdl->getError()){
+					$this->debug('got wsdl error: '.$errstr);
+					$this->fault('Server', 'unable to serialize result');
+					return;
+				}
+			} else {
+				if (isset($this->methodreturn)) {
+					$return_val = $this->serialize_val($this->methodreturn, 'return');
+				} else {
+					$return_val = '';
+					$this->debug('in absence of WSDL, assume void return for backward compatibility');
+				}
+			}
+		}
+		$this->debug('return value:');
+		$this->appendDebug($this->varDump($return_val));
+
+		$this->debug('serializing response');
+		if ($this->wsdl) {
+			$this->debug('have WSDL for serialization: style is ' . $this->opData['style']);
+			if ($this->opData['style'] == 'rpc') {
+				$this->debug('style is rpc for serialization: use is ' . $this->opData['output']['use']);
+				if ($this->opData['output']['use'] == 'literal') {
+					$payload = '<'.$this->methodname.'Response xmlns="'.$this->methodURI.'">'.$return_val.'</'.$this->methodname."Response>";
+				} else {
+					$payload = '<ns1:'.$this->methodname.'Response xmlns:ns1="'.$this->methodURI.'">'.$return_val.'</ns1:'.$this->methodname."Response>";
+				}
+			} else {
+				$this->debug('style is not rpc for serialization: assume document');
+				$payload = $return_val;
+			}
+		} else {
+			$this->debug('do not have WSDL for serialization: assume rpc/encoded');
+			$payload = '<ns1:'.$this->methodname.'Response xmlns:ns1="'.$this->methodURI.'">'.$return_val.'</ns1:'.$this->methodname."Response>";
+		}
+		$this->result = 'successful';
+		if($this->wsdl){
+			//if($this->debug_flag){
+            	$this->appendDebug($this->wsdl->getDebug());
+            //	}
+			if (isset($opData['output']['encodingStyle'])) {
+				$encodingStyle = $opData['output']['encodingStyle'];
+			} else {
+				$encodingStyle = '';
+			}
+			// Added: In case we use a WSDL, return a serialized env. WITH the usedNamespaces.
+			$this->responseSOAP = $this->serializeEnvelope($payload,$this->responseHeaders,$this->wsdl->usedNamespaces,$this->opData['style'],$encodingStyle);
+		} else {
+			$this->responseSOAP = $this->serializeEnvelope($payload,$this->responseHeaders);
+		}
+		$this->debug("Leaving serialize_return");
+	}
+
+	/**
+	* sends an HTTP response
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* outgoing_headers
+	* response
+	*
+	* @access   private
+	*/
+	function send_response() {
+		$this->debug('Enter send_response');
+		if ($this->fault) {
+			$payload = $this->fault->serialize();
+			$this->outgoing_headers[] = "HTTP/1.0 500 Internal Server Error";
+			$this->outgoing_headers[] = "Status: 500 Internal Server Error";
+		} else {
+			$payload = $this->responseSOAP;
+			// Some combinations of PHP+Web server allow the Status
+			// to come through as a header.  Since OK is the default
+			// just do nothing.
+			// $this->outgoing_headers[] = "HTTP/1.0 200 OK";
+			// $this->outgoing_headers[] = "Status: 200 OK";
+		}
+        // add debug data if in debug mode
+		if(isset($this->debug_flag) && $this->debug_flag){
+        	$payload .= $this->getDebugAsXMLComment();
+        }
+		$this->outgoing_headers[] = "Server: $this->title Server v$this->version";
+		ereg('\$Revisio' . 'n: ([^ ]+)', $this->revision, $rev);
+		$this->outgoing_headers[] = "X-SOAP-Server: $this->title/$this->version (".$rev[1].")";
+		// Let the Web server decide about this
+		//$this->outgoing_headers[] = "Connection: Close\r\n";
+		$payload = $this->getHTTPBody($payload);
+		$type = $this->getHTTPContentType();
+		$charset = $this->getHTTPContentTypeCharset();
+		$this->outgoing_headers[] = "Content-Type: $type" . ($charset ? '; charset=' . $charset : '');
+		//begin code to compress payload - by John
+		// NOTE: there is no way to know whether the Web server will also compress
+		// this data.
+		if (strlen($payload) > 1024 && isset($this->headers) && isset($this->headers['accept-encoding'])) {	
+			if (strstr($this->headers['accept-encoding'], 'gzip')) {
+				if (function_exists('gzencode')) {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content being gzipped -->";
+					}
+					$this->outgoing_headers[] = "Content-Encoding: gzip";
+					$payload = gzencode($payload);
+				} else {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content will not be gzipped: no gzencode -->";
+					}
+				}
+			} elseif (strstr($this->headers['accept-encoding'], 'deflate')) {
+				// Note: MSIE requires gzdeflate output (no Zlib header and checksum),
+				// instead of gzcompress output,
+				// which conflicts with HTTP 1.1 spec (http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.5)
+				if (function_exists('gzdeflate')) {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content being deflated -->";
+					}
+					$this->outgoing_headers[] = "Content-Encoding: deflate";
+					$payload = gzdeflate($payload);
+				} else {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content will not be deflated: no gzcompress -->";
+					}
+				}
+			}
+		}
+		//end code
+		$this->outgoing_headers[] = "Content-Length: ".strlen($payload);
+		reset($this->outgoing_headers);
+		foreach($this->outgoing_headers as $hdr){
+			header($hdr, false);
+		}
+		print $payload;
+		$this->response = join("\r\n",$this->outgoing_headers)."\r\n\r\n".$payload;
+	}
+
+	/**
+	* takes the value that was created by parsing the request
+	* and compares to the method's signature, if available.
+	*
+	* @param	string	$operation	The operation to be invoked
+	* @param	array	$request	The array of parameter values
+	* @return	boolean	Whether the operation was found
+	* @access   private
+	*/
+	function verify_method($operation,$request){
+		if(isset($this->wsdl) && is_object($this->wsdl)){
+			if($this->wsdl->getOperationData($operation)){
+				return true;
+			}
+	    } elseif(isset($this->operations[$operation])){
+			return true;
+		}
+		return false;
+	}
+
+	/**
+	* processes SOAP message received from client
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed request data from client
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseRequest($headers, $data) {
+		$this->debug('Entering parseRequest() for data of length ' . strlen($data) . ' and type ' . $headers['content-type']);
+		if (!strstr($headers['content-type'], 'text/xml')) {
+			$this->setError('Request not of type text/xml');
+			return false;
+		}
+		if (strpos($headers['content-type'], '=')) {
+			$enc = str_replace('"', '', substr(strstr($headers["content-type"], '='), 1));
+			$this->debug('Got response encoding: ' . $enc);
+			if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+				$this->xml_encoding = strtoupper($enc);
+			} else {
+				$this->xml_encoding = 'US-ASCII';
+			}
+		} else {
+			// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+			$this->xml_encoding = 'ISO-8859-1';
+		}
+		$this->debug('Use encoding: ' . $this->xml_encoding . ' when creating soap_parser');
+		// parse response, get soap parser obj
+		$parser = new soap_parser($data,$this->xml_encoding,'',$this->decode_utf8);
+		// parser debug
+		$this->debug("parser debug: \n".$parser->getDebug());
+		// if fault occurred during message parsing
+		if($err = $parser->getError()){
+			$this->result = 'fault: error in msg parsing: '.$err;
+			$this->fault('Client',"error in msg parsing:\n".$err);
+		// else successfully parsed request into soapval object
+		} else {
+			// get/set methodname
+			$this->methodURI = $parser->root_struct_namespace;
+			$this->methodname = $parser->root_struct_name;
+			$this->debug('methodname: '.$this->methodname.' methodURI: '.$this->methodURI);
+			$this->debug('calling parser->get_response()');
+			$this->methodparams = $parser->get_response();
+			// get SOAP headers
+			$this->requestHeaders = $parser->getHeaders();
+            // add document for doclit support
+            $this->document = $parser->document;
+		}
+	 }
+
+	/**
+	* gets the HTTP body for the current response.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		return $soapmsg;
+	}
+	
+	/**
+	* gets the HTTP content type for the current response.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current response.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		return 'text/xml';
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current response.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current response.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		return $this->soap_defencoding;
+	}
+
+	/**
+	* add a method to the dispatch map (this has been replaced by the register method)
+	*
+	* @param    string $methodname
+	* @param    string $in array of input values
+	* @param    string $out array of output values
+	* @access   public
+	* @deprecated
+	*/
+	function add_to_map($methodname,$in,$out){
+			$this->operations[$methodname] = array('name' => $methodname,'in' => $in,'out' => $out);
+	}
+
+	/**
+	* register a service function with the server
+	*
+	* @param    string $name the name of the PHP function, class.method or class..method
+	* @param    array $in assoc array of input values: key = param name, value = param type
+	* @param    array $out assoc array of output values: key = param name, value = param type
+	* @param	mixed $namespace the element namespace for the method or false
+	* @param	mixed $soapaction the soapaction for the method or false
+	* @param	mixed $style optional (rpc|document) or false Note: when 'document' is specified, parameter and return wrappers are created for you automatically
+	* @param	mixed $use optional (encoded|literal) or false
+	* @param	string $documentation optional Description to include in WSDL
+	* @param	string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+	* @access   public
+	*/
+	function register($name,$in=array(),$out=array(),$namespace=false,$soapaction=false,$style=false,$use=false,$documentation='',$encodingStyle=''){
+		global $HTTP_SERVER_VARS;
+
+		if($this->externalWSDLURL){
+			die('You cannot bind to an external WSDL file, and register methods outside of it! Please choose either WSDL or no WSDL.');
+		}
+		if (! $name) {
+			die('You must specify a name when you register an operation');
+		}
+		if (!is_array($in)) {
+			die('You must provide an array for operation inputs');
+		}
+		if (!is_array($out)) {
+			die('You must provide an array for operation outputs');
+		}
+		if(false == $namespace) {
+		}
+		if(false == $soapaction) {
+			if (isset($_SERVER)) {
+				$SERVER_NAME = $_SERVER['SERVER_NAME'];
+				$SCRIPT_NAME = isset($_SERVER['PHP_SELF']) ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
+			} elseif (isset($HTTP_SERVER_VARS)) {
+				$SERVER_NAME = $HTTP_SERVER_VARS['SERVER_NAME'];
+				$SCRIPT_NAME = isset($HTTP_SERVER_VARS['PHP_SELF']) ? $HTTP_SERVER_VARS['PHP_SELF'] : $HTTP_SERVER_VARS['SCRIPT_NAME'];
+			} else {
+				$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+			}
+			$soapaction = "http://$SERVER_NAME$SCRIPT_NAME/$name";
+		}
+		if(false == $style) {
+			$style = "rpc";
+		}
+		if(false == $use) {
+			$use = "encoded";
+		}
+		if ($use == 'encoded' && $encodingStyle = '') {
+			$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		}
+
+		$this->operations[$name] = array(
+	    'name' => $name,
+	    'in' => $in,
+	    'out' => $out,
+	    'namespace' => $namespace,
+	    'soapaction' => $soapaction,
+	    'style' => $style);
+        if($this->wsdl){
+        	$this->wsdl->addOperation($name,$in,$out,$namespace,$soapaction,$style,$use,$documentation,$encodingStyle);
+	    }
+		return true;
+	}
+
+	/**
+	* Specify a fault to be returned to the client.
+	* This also acts as a flag to the server that a fault has occured.
+	*
+	* @param	string $faultcode
+	* @param	string $faultstring
+	* @param	string $faultactor
+	* @param	string $faultdetail
+	* @access   public
+	*/
+	function fault($faultcode,$faultstring,$faultactor='',$faultdetail=''){
+		if ($faultdetail == '' && $this->debug_flag) {
+			$faultdetail = $this->getDebug();
+		}
+		$this->fault = new soap_fault($faultcode,$faultactor,$faultstring,$faultdetail);
+		$this->fault->soap_defencoding = $this->soap_defencoding;
+	}
+
+    /**
+    * Sets up wsdl object.
+    * Acts as a flag to enable internal WSDL generation
+    *
+    * @param string $serviceName, name of the service
+    * @param mixed $namespace optional 'tns' service namespace or false
+    * @param mixed $endpoint optional URL of service endpoint or false
+    * @param string $style optional (rpc|document) WSDL style (also specified by operation)
+    * @param string $transport optional SOAP transport
+    * @param mixed $schemaTargetNamespace optional 'types' targetNamespace for service schema or false
+    */
+    function configureWSDL($serviceName,$namespace = false,$endpoint = false,$style='rpc', $transport = 'http://schemas.xmlsoap.org/soap/http', $schemaTargetNamespace = false)
+    {
+    	global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$SERVER_NAME = $_SERVER['SERVER_NAME'];
+			$SERVER_PORT = $_SERVER['SERVER_PORT'];
+			$SCRIPT_NAME = isset($_SERVER['PHP_SELF']) ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
+			$HTTPS = $_SERVER['HTTPS'];
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$SERVER_NAME = $HTTP_SERVER_VARS['SERVER_NAME'];
+			$SERVER_PORT = $HTTP_SERVER_VARS['SERVER_PORT'];
+			$SCRIPT_NAME = isset($HTTP_SERVER_VARS['PHP_SELF']) ? $HTTP_SERVER_VARS['PHP_SELF'] : $HTTP_SERVER_VARS['SCRIPT_NAME'];
+			$HTTPS = $HTTP_SERVER_VARS['HTTPS'];
+		} else {
+			$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+		}
+		if ($SERVER_PORT == 80) {
+			$SERVER_PORT = '';
+		} else {
+			$SERVER_PORT = ':' . $SERVER_PORT;
+		}
+        if(false == $namespace) {
+            $namespace = "http://$SERVER_NAME/soap/$serviceName";
+        }
+        
+        if(false == $endpoint) {
+        	if ($HTTPS == '1' || $HTTPS == 'on') {
+        		$SCHEME = 'https';
+        	} else {
+        		$SCHEME = 'http';
+        	}
+            $endpoint = "$SCHEME://$SERVER_NAME$SERVER_PORT$SCRIPT_NAME";
+        }
+        
+        if(false == $schemaTargetNamespace) {
+            $schemaTargetNamespace = $namespace;
+        }
+        
+		$this->wsdl = new wsdl;
+		$this->wsdl->serviceName = $serviceName;
+        $this->wsdl->endpoint = $endpoint;
+		$this->wsdl->namespaces['tns'] = $namespace;
+		$this->wsdl->namespaces['soap'] = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		$this->wsdl->namespaces['wsdl'] = 'http://schemas.xmlsoap.org/wsdl/';
+		if ($schemaTargetNamespace != $namespace) {
+			$this->wsdl->namespaces['types'] = $schemaTargetNamespace;
+		}
+        $this->wsdl->schemas[$schemaTargetNamespace][0] = new xmlschema('', '', $this->wsdl->namespaces);
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->schemaTargetNamespace = $schemaTargetNamespace;
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->imports['http://schemas.xmlsoap.org/soap/encoding/'][0] = array('location' => '', 'loaded' => true);
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->imports['http://schemas.xmlsoap.org/wsdl/'][0] = array('location' => '', 'loaded' => true);
+        $this->wsdl->bindings[$serviceName.'Binding'] = array(
+        	'name'=>$serviceName.'Binding',
+            'style'=>$style,
+            'transport'=>$transport,
+            'portType'=>$serviceName.'PortType');
+        $this->wsdl->ports[$serviceName.'Port'] = array(
+        	'binding'=>$serviceName.'Binding',
+            'location'=>$endpoint,
+            'bindingType'=>'http://schemas.xmlsoap.org/wsdl/soap/');
+    }
+}
+
+
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soap_transport_http.php
===================================================================
--- cms/trunk/includes/nusoap/class.soap_transport_http.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soap_transport_http.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,1038 @@
+<?php
+
+
+
+
+/**
+* transport class for sending/receiving data via HTTP and HTTPS
+* NOTE: PHP must be compiled with the CURL extension for HTTPS support
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soap_transport_http.php,v 1.57 2005/07/27 19:24:42 snichol Exp $
+* @access public
+*/
+class soap_transport_http extends nusoap_base {
+
+	var $url = '';
+	var $uri = '';
+	var $digest_uri = '';
+	var $scheme = '';
+	var $host = '';
+	var $port = '';
+	var $path = '';
+	var $request_method = 'POST';
+	var $protocol_version = '1.0';
+	var $encoding = '';
+	var $outgoing_headers = array();
+	var $incoming_headers = array();
+	var $incoming_cookies = array();
+	var $outgoing_payload = '';
+	var $incoming_payload = '';
+	var $useSOAPAction = true;
+	var $persistentConnection = false;
+	var $ch = false;	// cURL handle
+	var $username = '';
+	var $password = '';
+	var $authtype = '';
+	var $digestRequest = array();
+	var $certRequest = array();	// keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional)
+								// cainfofile: certificate authority file, e.g. '$pathToPemFiles/rootca.pem'
+								// sslcertfile: SSL certificate file, e.g. '$pathToPemFiles/mycert.pem'
+								// sslkeyfile: SSL key file, e.g. '$pathToPemFiles/mykey.pem'
+								// passphrase: SSL key password/passphrase
+								// verifypeer: default is 1
+								// verifyhost: default is 1
+
+	/**
+	* constructor
+	*/
+	function soap_transport_http($url){
+		parent::nusoap_base();
+		$this->setURL($url);
+		ereg('\$Revisio' . 'n: ([^ ]+)', $this->revision, $rev);
+		$this->outgoing_headers['User-Agent'] = $this->title.'/'.$this->version.' ('.$rev[1].')';
+		$this->debug('set User-Agent: ' . $this->outgoing_headers['User-Agent']);
+	}
+
+	function setURL($url) {
+		$this->url = $url;
+
+		$u = parse_url($url);
+		foreach($u as $k => $v){
+			$this->debug("$k = $v");
+			$this->$k = $v;
+		}
+		
+		// add any GET params to path
+		if(isset($u['query']) && $u['query'] != ''){
+            $this->path .= '?' . $u['query'];
+		}
+		
+		// set default port
+		if(!isset($u['port'])){
+			if($u['scheme'] == 'https'){
+				$this->port = 443;
+			} else {
+				$this->port = 80;
+			}
+		}
+		
+		$this->uri = $this->path;
+		$this->digest_uri = $this->uri;
+		
+		// build headers
+		if (!isset($u['port'])) {
+			$this->outgoing_headers['Host'] = $this->host;
+		} else {
+			$this->outgoing_headers['Host'] = $this->host.':'.$this->port;
+		}
+		$this->debug('set Host: ' . $this->outgoing_headers['Host']);
+
+		if (isset($u['user']) && $u['user'] != '') {
+			$this->setCredentials(urldecode($u['user']), isset($u['pass']) ? urldecode($u['pass']) : '');
+		}
+	}
+	
+	function connect($connection_timeout=0,$response_timeout=30){
+	  	// For PHP 4.3 with OpenSSL, change https scheme to ssl, then treat like
+	  	// "regular" socket.
+	  	// TODO: disabled for now because OpenSSL must be *compiled* in (not just
+	  	//       loaded), and until PHP5 stream_get_wrappers is not available.
+//	  	if ($this->scheme == 'https') {
+//		  	if (version_compare(phpversion(), '4.3.0') >= 0) {
+//		  		if (extension_loaded('openssl')) {
+//		  			$this->scheme = 'ssl';
+//		  			$this->debug('Using SSL over OpenSSL');
+//		  		}
+//		  	}
+//		}
+		$this->debug("connect connection_timeout $connection_timeout, response_timeout $response_timeout, scheme $this->scheme, host $this->host, port $this->port");
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+		// use persistent connection
+		if($this->persistentConnection && isset($this->fp) && is_resource($this->fp)){
+			if (!feof($this->fp)) {
+				$this->debug('Re-use persistent connection');
+				return true;
+			}
+			fclose($this->fp);
+			$this->debug('Closed persistent connection at EOF');
+		}
+
+		// munge host if using OpenSSL
+		if ($this->scheme == 'ssl') {
+			$host = 'ssl://' . $this->host;
+		} else {
+			$host = $this->host;
+		}
+		$this->debug('calling fsockopen with host ' . $host . ' connection_timeout ' . $connection_timeout);
+
+		// open socket
+		if($connection_timeout > 0){
+			$this->fp = @fsockopen( $host, $this->port, $this->errno, $this->error_str, $connection_timeout);
+		} else {
+			$this->fp = @fsockopen( $host, $this->port, $this->errno, $this->error_str);
+		}
+		
+		// test pointer
+		if(!$this->fp) {
+			$msg = 'Couldn\'t open socket connection to server ' . $this->url;
+			if ($this->errno) {
+				$msg .= ', Error ('.$this->errno.'): '.$this->error_str;
+			} else {
+				$msg .= ' prior to connect().  This is often a problem looking up the host name.';
+			}
+			$this->debug($msg);
+			$this->setError($msg);
+			return false;
+		}
+		
+		// set response timeout
+		$this->debug('set response timeout to ' . $response_timeout);
+		socket_set_timeout( $this->fp, $response_timeout);
+
+		$this->debug('socket connected');
+		return true;
+	  } else if ($this->scheme == 'https') {
+		if (!extension_loaded('curl')) {
+			$this->setError('CURL Extension, or OpenSSL extension w/ PHP version >= 4.3 is required for HTTPS');
+			return false;
+		}
+		$this->debug('connect using https');
+		// init CURL
+		$this->ch = curl_init();
+		// set url
+		$hostURL = ($this->port != '') ? "https://$this->host:$this->port" : "https://$this->host";
+		// add path
+		$hostURL .= $this->path;
+		curl_setopt($this->ch, CURLOPT_URL, $hostURL);
+		// follow location headers (re-directs)
+		curl_setopt($this->ch, CURLOPT_FOLLOWLOCATION, 1);
+		// ask for headers in the response output
+		curl_setopt($this->ch, CURLOPT_HEADER, 1);
+		// ask for the response output as the return value
+		curl_setopt($this->ch, CURLOPT_RETURNTRANSFER, 1);
+		// encode
+		// We manage this ourselves through headers and encoding
+//		if(function_exists('gzuncompress')){
+//			curl_setopt($this->ch, CURLOPT_ENCODING, 'deflate');
+//		}
+		// persistent connection
+		if ($this->persistentConnection) {
+			// The way we send data, we cannot use persistent connections, since
+			// there will be some "junk" at the end of our request.
+			//curl_setopt($this->ch, CURL_HTTP_VERSION_1_1, true);
+			$this->persistentConnection = false;
+			$this->outgoing_headers['Connection'] = 'close';
+			$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+		}
+		// set timeout
+		if ($connection_timeout != 0) {
+			curl_setopt($this->ch, CURLOPT_TIMEOUT, $connection_timeout);
+		}
+		// TODO: cURL has added a connection timeout separate from the response timeout
+		//if ($connection_timeout != 0) {
+		//	curl_setopt($this->ch, CURLOPT_CONNECTIONTIMEOUT, $connection_timeout);
+		//}
+		//if ($response_timeout != 0) {
+		//	curl_setopt($this->ch, CURLOPT_TIMEOUT, $response_timeout);
+		//}
+
+		// recent versions of cURL turn on peer/host checking by default,
+		// while PHP binaries are not compiled with a default location for the
+		// CA cert bundle, so disable peer/host checking.
+//curl_setopt($this->ch, CURLOPT_CAINFO, 'f:\php-4.3.2-win32\extensions\curl-ca-bundle.crt');		
+		curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, 0);
+		curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, 0);
+
+		// support client certificates (thanks Tobias Boes, Doug Anarino, Eryan Ariobowo)
+		if ($this->authtype == 'certificate') {
+			if (isset($this->certRequest['cainfofile'])) {
+				curl_setopt($this->ch, CURLOPT_CAINFO, $this->certRequest['cainfofile']);
+			}
+			if (isset($this->certRequest['verifypeer'])) {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, $this->certRequest['verifypeer']);
+			} else {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, 1);
+			}
+			if (isset($this->certRequest['verifyhost'])) {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, $this->certRequest['verifyhost']);
+			} else {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, 1);
+			}
+			if (isset($this->certRequest['sslcertfile'])) {
+				curl_setopt($this->ch, CURLOPT_SSLCERT, $this->certRequest['sslcertfile']);
+			}
+			if (isset($this->certRequest['sslkeyfile'])) {
+				curl_setopt($this->ch, CURLOPT_SSLKEY, $this->certRequest['sslkeyfile']);
+			}
+			if (isset($this->certRequest['passphrase'])) {
+				curl_setopt($this->ch, CURLOPT_SSLKEYPASSWD , $this->certRequest['passphrase']);
+			}
+		}
+		$this->debug('cURL connection set up');
+		return true;
+	  } else {
+		$this->setError('Unknown scheme ' . $this->scheme);
+		$this->debug('Unknown scheme ' . $this->scheme);
+		return false;
+	  }
+	}
+	
+	/**
+	* send the SOAP message via HTTP
+	*
+	* @param    string $data message data
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @param	array $cookies cookies to send
+	* @return	string data
+	* @access   public
+	*/
+	function send($data, $timeout=0, $response_timeout=30, $cookies=NULL) {
+		
+		$this->debug('entered send() with data of length: '.strlen($data));
+
+		$this->tryagain = true;
+		$tries = 0;
+		while ($this->tryagain) {
+			$this->tryagain = false;
+			if ($tries++ < 2) {
+				// make connnection
+				if (!$this->connect($timeout, $response_timeout)){
+					return false;
+				}
+				
+				// send request
+				if (!$this->sendRequest($data, $cookies)){
+					return false;
+				}
+				
+				// get response
+				$respdata = $this->getResponse();
+			} else {
+				$this->setError('Too many tries to get an OK response');
+			}
+		}		
+		$this->debug('end of send()');
+		return $respdata;
+	}
+
+
+	/**
+	* send the SOAP message via HTTPS 1.0 using CURL
+	*
+	* @param    string $msg message data
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @param	array $cookies cookies to send
+	* @return	string data
+	* @access   public
+	*/
+	function sendHTTPS($data, $timeout=0, $response_timeout=30, $cookies) {
+		return $this->send($data, $timeout, $response_timeout, $cookies);
+	}
+	
+	/**
+	* if authenticating, set user credentials here
+	*
+	* @param    string $username
+	* @param    string $password
+	* @param	string $authtype (basic, digest, certificate)
+	* @param	array $digestRequest (keys must be nonce, nc, realm, qop)
+	* @param	array $certRequest (keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional): see corresponding options in cURL docs)
+	* @access   public
+	*/
+	function setCredentials($username, $password, $authtype = 'basic', $digestRequest = array(), $certRequest = array()) {
+		$this->debug("Set credentials for authtype $authtype");
+		// cf. RFC 2617
+		if ($authtype == 'basic') {
+			$this->outgoing_headers['Authorization'] = 'Basic '.base64_encode(str_replace(':','',$username).':'.$password);
+		} elseif ($authtype == 'digest') {
+			if (isset($digestRequest['nonce'])) {
+				$digestRequest['nc'] = isset($digestRequest['nc']) ? $digestRequest['nc']++ : 1;
+				
+				// calculate the Digest hashes (calculate code based on digest implementation found at: http://www.rassoc.com/gregr/weblog/stories/2002/07/09/webServicesSecurityHttpDigestAuthenticationWithoutActiveDirectory.html)
+	
+				// A1 = unq(username-value) ":" unq(realm-value) ":" passwd
+				$A1 = $username. ':' . (isset($digestRequest['realm']) ? $digestRequest['realm'] : '') . ':' . $password;
+	
+				// H(A1) = MD5(A1)
+				$HA1 = md5($A1);
+	
+				// A2 = Method ":" digest-uri-value
+				$A2 = 'POST:' . $this->digest_uri;
+	
+				// H(A2)
+				$HA2 =  md5($A2);
+	
+				// KD(secret, data) = H(concat(secret, ":", data))
+				// if qop == auth:
+				// request-digest  = <"> < KD ( H(A1),     unq(nonce-value)
+				//                              ":" nc-value
+				//                              ":" unq(cnonce-value)
+				//                              ":" unq(qop-value)
+				//                              ":" H(A2)
+				//                            ) <">
+				// if qop is missing,
+				// request-digest  = <"> < KD ( H(A1), unq(nonce-value) ":" H(A2) ) > <">
+	
+				$unhashedDigest = '';
+				$nonce = isset($digestRequest['nonce']) ? $digestRequest['nonce'] : '';
+				$cnonce = $nonce;
+				if ($digestRequest['qop'] != '') {
+					$unhashedDigest = $HA1 . ':' . $nonce . ':' . sprintf("%08d", $digestRequest['nc']) . ':' . $cnonce . ':' . $digestRequest['qop'] . ':' . $HA2;
+				} else {
+					$unhashedDigest = $HA1 . ':' . $nonce . ':' . $HA2;
+				}
+	
+				$hashedDigest = md5($unhashedDigest);
+	
+				$this->outgoing_headers['Authorization'] = 'Digest username="' . $username . '", realm="' . $digestRequest['realm'] . '", nonce="' . $nonce . '", uri="' . $this->digest_uri . '", cnonce="' . $cnonce . '", nc=' . sprintf("%08x", $digestRequest['nc']) . ', qop="' . $digestRequest['qop'] . '", response="' . $hashedDigest . '"';
+			}
+		} elseif ($authtype == 'certificate') {
+			$this->certRequest = $certRequest;
+		}
+		$this->username = $username;
+		$this->password = $password;
+		$this->authtype = $authtype;
+		$this->digestRequest = $digestRequest;
+		
+		if (isset($this->outgoing_headers['Authorization'])) {
+			$this->debug('set Authorization: ' . substr($this->outgoing_headers['Authorization'], 0, 12) . '...');
+		} else {
+			$this->debug('Authorization header not set');
+		}
+	}
+	
+	/**
+	* set the soapaction value
+	*
+	* @param    string $soapaction
+	* @access   public
+	*/
+	function setSOAPAction($soapaction) {
+		$this->outgoing_headers['SOAPAction'] = '"' . $soapaction . '"';
+		$this->debug('set SOAPAction: ' . $this->outgoing_headers['SOAPAction']);
+	}
+	
+	/**
+	* use http encoding
+	*
+	* @param    string $enc encoding style. supported values: gzip, deflate, or both
+	* @access   public
+	*/
+	function setEncoding($enc='gzip, deflate') {
+		if (function_exists('gzdeflate')) {
+			$this->protocol_version = '1.1';
+			$this->outgoing_headers['Accept-Encoding'] = $enc;
+			$this->debug('set Accept-Encoding: ' . $this->outgoing_headers['Accept-Encoding']);
+			if (!isset($this->outgoing_headers['Connection'])) {
+				$this->outgoing_headers['Connection'] = 'close';
+				$this->persistentConnection = false;
+				$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+			}
+			set_magic_quotes_runtime(0);
+			// deprecated
+			$this->encoding = $enc;
+		}
+	}
+	
+	/**
+	* set proxy info here
+	*
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @access   public
+	*/
+	function setProxy($proxyhost, $proxyport, $proxyusername = '', $proxypassword = '') {
+		$this->uri = $this->url;
+		$this->host = $proxyhost;
+		$this->port = $proxyport;
+		if ($proxyusername != '' && $proxypassword != '') {
+			$this->outgoing_headers['Proxy-Authorization'] = ' Basic '.base64_encode($proxyusername.':'.$proxypassword);
+			$this->debug('set Proxy-Authorization: ' . $this->outgoing_headers['Proxy-Authorization']);
+		}
+	}
+	
+	/**
+	* decode a string that is encoded w/ "chunked' transfer encoding
+ 	* as defined in RFC2068 19.4.6
+	*
+	* @param    string $buffer
+	* @param    string $lb
+	* @returns	string
+	* @access   public
+	* @deprecated
+	*/
+	function decodeChunked($buffer, $lb){
+		// length := 0
+		$length = 0;
+		$new = '';
+		
+		// read chunk-size, chunk-extension (if any) and CRLF
+		// get the position of the linebreak
+		$chunkend = strpos($buffer, $lb);
+		if ($chunkend == FALSE) {
+			$this->debug('no linebreak found in decodeChunked');
+			return $new;
+		}
+		$temp = substr($buffer,0,$chunkend);
+		$chunk_size = hexdec( trim($temp) );
+		$chunkstart = $chunkend + strlen($lb);
+		// while (chunk-size > 0) {
+		while ($chunk_size > 0) {
+			$this->debug("chunkstart: $chunkstart chunk_size: $chunk_size");
+			$chunkend = strpos( $buffer, $lb, $chunkstart + $chunk_size);
+		  	
+			// Just in case we got a broken connection
+		  	if ($chunkend == FALSE) {
+		  	    $chunk = substr($buffer,$chunkstart);
+				// append chunk-data to entity-body
+		    	$new .= $chunk;
+		  	    $length += strlen($chunk);
+		  	    break;
+			}
+			
+		  	// read chunk-data and CRLF
+		  	$chunk = substr($buffer,$chunkstart,$chunkend-$chunkstart);
+		  	// append chunk-data to entity-body
+		  	$new .= $chunk;
+		  	// length := length + chunk-size
+		  	$length += strlen($chunk);
+		  	// read chunk-size and CRLF
+		  	$chunkstart = $chunkend + strlen($lb);
+			
+		  	$chunkend = strpos($buffer, $lb, $chunkstart) + strlen($lb);
+			if ($chunkend == FALSE) {
+				break; //Just in case we got a broken connection
+			}
+			$temp = substr($buffer,$chunkstart,$chunkend-$chunkstart);
+			$chunk_size = hexdec( trim($temp) );
+			$chunkstart = $chunkend;
+		}
+		return $new;
+	}
+	
+	/*
+	 *	Writes payload, including HTTP headers, to $this->outgoing_payload.
+	 */
+	function buildPayload($data, $cookie_str = '') {
+		// add content-length header
+		$this->outgoing_headers['Content-Length'] = strlen($data);
+		$this->debug('set Content-Length: ' . $this->outgoing_headers['Content-Length']);
+
+		// start building outgoing payload:
+		$req = "$this->request_method $this->uri HTTP/$this->protocol_version";
+		$this->debug("HTTP request: $req");
+		$this->outgoing_payload = "$req\r\n";
+
+		// loop thru headers, serializing
+		foreach($this->outgoing_headers as $k => $v){
+			$hdr = $k.': '.$v;
+			$this->debug("HTTP header: $hdr");
+			$this->outgoing_payload .= "$hdr\r\n";
+		}
+
+		// add any cookies
+		if ($cookie_str != '') {
+			$hdr = 'Cookie: '.$cookie_str;
+			$this->debug("HTTP header: $hdr");
+			$this->outgoing_payload .= "$hdr\r\n";
+		}
+
+		// header/body separator
+		$this->outgoing_payload .= "\r\n";
+		
+		// add data
+		$this->outgoing_payload .= $data;
+	}
+
+	function sendRequest($data, $cookies = NULL) {
+		// build cookie string
+		$cookie_str = $this->getCookiesForRequest($cookies, (($this->scheme == 'ssl') || ($this->scheme == 'https')));
+
+		// build payload
+		$this->buildPayload($data, $cookie_str);
+
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+		// send payload
+		if(!fputs($this->fp, $this->outgoing_payload, strlen($this->outgoing_payload))) {
+			$this->setError('couldn\'t write message data to socket');
+			$this->debug('couldn\'t write message data to socket');
+			return false;
+		}
+		$this->debug('wrote data to socket, length = ' . strlen($this->outgoing_payload));
+		return true;
+	  } else if ($this->scheme == 'https') {
+		// set payload
+		// TODO: cURL does say this should only be the verb, and in fact it
+		// turns out that the URI and HTTP version are appended to this, which
+		// some servers refuse to work with
+		//curl_setopt($this->ch, CURLOPT_CUSTOMREQUEST, $this->outgoing_payload);
+		foreach($this->outgoing_headers as $k => $v){
+			$curl_headers[] = "$k: $v";
+		}
+		if ($cookie_str != '') {
+			$curl_headers[] = 'Cookie: ' . $cookie_str;
+		}
+		curl_setopt($this->ch, CURLOPT_HTTPHEADER, $curl_headers);
+		if ($this->request_method == "POST") {
+	  		curl_setopt($this->ch, CURLOPT_POST, 1);
+	  		curl_setopt($this->ch, CURLOPT_POSTFIELDS, $data);
+	  	} else {
+	  	}
+		$this->debug('set cURL payload');
+		return true;
+	  }
+	}
+
+	function getResponse(){
+		$this->incoming_payload = '';
+	    
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+	    // loop until headers have been retrieved
+	    $data = '';
+	    while (!isset($lb)){
+
+			// We might EOF during header read.
+			if(feof($this->fp)) {
+				$this->incoming_payload = $data;
+				$this->debug('found no headers before EOF after length ' . strlen($data));
+				$this->debug("received before EOF:\n" . $data);
+				$this->setError('server failed to send headers');
+				return false;
+			}
+
+			$tmp = fgets($this->fp, 256);
+			$tmplen = strlen($tmp);
+			$this->debug("read line of $tmplen bytes: " . trim($tmp));
+
+			if ($tmplen == 0) {
+				$this->incoming_payload = $data;
+				$this->debug('socket read of headers timed out after length ' . strlen($data));
+				$this->debug("read before timeout: " . $data);
+				$this->setError('socket read of headers timed out');
+				return false;
+			}
+
+			$data .= $tmp;
+			$pos = strpos($data,"\r\n\r\n");
+			if($pos > 1){
+				$lb = "\r\n";
+			} else {
+				$pos = strpos($data,"\n\n");
+				if($pos > 1){
+					$lb = "\n";
+				}
+			}
+			// remove 100 header
+			if(isset($lb) && ereg('^HTTP/1.1 100',$data)){
+				unset($lb);
+				$data = '';
+			}//
+		}
+		// store header data
+		$this->incoming_payload .= $data;
+		$this->debug('found end of headers after length ' . strlen($data));
+		// process headers
+		$header_data = trim(substr($data,0,$pos));
+		$header_array = explode($lb,$header_data);
+		$this->incoming_headers = array();
+		$this->incoming_cookies = array();
+		foreach($header_array as $header_line){
+			$arr = explode(':',$header_line, 2);
+			if(count($arr) > 1){
+				$header_name = strtolower(trim($arr[0]));
+				$this->incoming_headers[$header_name] = trim($arr[1]);
+				if ($header_name == 'set-cookie') {
+					// TODO: allow multiple cookies from parseCookie
+					$cookie = $this->parseCookie(trim($arr[1]));
+					if ($cookie) {
+						$this->incoming_cookies[] = $cookie;
+						$this->debug('found cookie: ' . $cookie['name'] . ' = ' . $cookie['value']);
+					} else {
+						$this->debug('did not find cookie in ' . trim($arr[1]));
+					}
+    			}
+			} else if (isset($header_name)) {
+				// append continuation line to previous header
+				$this->incoming_headers[$header_name] .= $lb . ' ' . $header_line;
+			}
+		}
+		
+		// loop until msg has been received
+		if (isset($this->incoming_headers['transfer-encoding']) && strtolower($this->incoming_headers['transfer-encoding']) == 'chunked') {
+			$content_length =  2147483647;	// ignore any content-length header
+			$chunked = true;
+			$this->debug("want to read chunked content");
+		} elseif (isset($this->incoming_headers['content-length'])) {
+			$content_length = $this->incoming_headers['content-length'];
+			$chunked = false;
+			$this->debug("want to read content of length $content_length");
+		} else {
+			$content_length =  2147483647;
+			$chunked = false;
+			$this->debug("want to read content to EOF");
+		}
+		$data = '';
+		do {
+			if ($chunked) {
+				$tmp = fgets($this->fp, 256);
+				$tmplen = strlen($tmp);
+				$this->debug("read chunk line of $tmplen bytes");
+				if ($tmplen == 0) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of chunk length timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of chunk length timed out');
+					return false;
+				}
+				$content_length = hexdec(trim($tmp));
+				$this->debug("chunk length $content_length");
+			}
+			$strlen = 0;
+		    while (($strlen < $content_length) && (!feof($this->fp))) {
+		    	$readlen = min(8192, $content_length - $strlen);
+				$tmp = fread($this->fp, $readlen);
+				$tmplen = strlen($tmp);
+				$this->debug("read buffer of $tmplen bytes");
+				if (($tmplen == 0) && (!feof($this->fp))) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of body timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of body timed out');
+					return false;
+				}
+				$strlen += $tmplen;
+				$data .= $tmp;
+			}
+			if ($chunked && ($content_length > 0)) {
+				$tmp = fgets($this->fp, 256);
+				$tmplen = strlen($tmp);
+				$this->debug("read chunk terminator of $tmplen bytes");
+				if ($tmplen == 0) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of chunk terminator timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of chunk terminator timed out');
+					return false;
+				}
+			}
+		} while ($chunked && ($content_length > 0) && (!feof($this->fp)));
+		if (feof($this->fp)) {
+			$this->debug('read to EOF');
+		}
+		$this->debug('read body of length ' . strlen($data));
+		$this->incoming_payload .= $data;
+		$this->debug('received a total of '.strlen($this->incoming_payload).' bytes of data from server');
+		
+		// close filepointer
+		if(
+			(isset($this->incoming_headers['connection']) && strtolower($this->incoming_headers['connection']) == 'close') || 
+			(! $this->persistentConnection) || feof($this->fp)){
+			fclose($this->fp);
+			$this->fp = false;
+			$this->debug('closed socket');
+		}
+		
+		// connection was closed unexpectedly
+		if($this->incoming_payload == ''){
+			$this->setError('no response from server');
+			return false;
+		}
+		
+		// decode transfer-encoding
+//		if(isset($this->incoming_headers['transfer-encoding']) && strtolower($this->incoming_headers['transfer-encoding']) == 'chunked'){
+//			if(!$data = $this->decodeChunked($data, $lb)){
+//				$this->setError('Decoding of chunked data failed');
+//				return false;
+//			}
+			//print "<pre>\nde-chunked:\n---------------\n$data\n\n---------------\n</pre>";
+			// set decoded payload
+//			$this->incoming_payload = $header_data.$lb.$lb.$data;
+//		}
+	
+	  } else if ($this->scheme == 'https') {
+		// send and receive
+		$this->debug('send and receive with cURL');
+		$this->incoming_payload = curl_exec($this->ch);
+		$data = $this->incoming_payload;
+
+        $cErr = curl_error($this->ch);
+		if ($cErr != '') {
+        	$err = 'cURL ERROR: '.curl_errno($this->ch).': '.$cErr.'<br>';
+        	// TODO: there is a PHP bug that can cause this to SEGV for CURLINFO_CONTENT_TYPE
+			foreach(curl_getinfo($this->ch) as $k => $v){
+				$err .= "$k: $v<br>";
+			}
+			$this->debug($err);
+			$this->setError($err);
+			curl_close($this->ch);
+	    	return false;
+		} else {
+			//echo '<pre>';
+			//var_dump(curl_getinfo($this->ch));
+			//echo '</pre>';
+		}
+		// close curl
+		$this->debug('No cURL error, closing cURL');
+		curl_close($this->ch);
+		
+		// remove 100 header(s)
+		while (ereg('^HTTP/1.1 100',$data)) {
+			if ($pos = strpos($data,"\r\n\r\n")) {
+				$data = ltrim(substr($data,$pos));
+			} elseif($pos = strpos($data,"\n\n") ) {
+				$data = ltrim(substr($data,$pos));
+			}
+		}
+		
+		// separate content from HTTP headers
+		if ($pos = strpos($data,"\r\n\r\n")) {
+			$lb = "\r\n";
+		} elseif( $pos = strpos($data,"\n\n")) {
+			$lb = "\n";
+		} else {
+			$this->debug('no proper separation of headers and document');
+			$this->setError('no proper separation of headers and document');
+			return false;
+		}
+		$header_data = trim(substr($data,0,$pos));
+		$header_array = explode($lb,$header_data);
+		$data = ltrim(substr($data,$pos));
+		$this->debug('found proper separation of headers and document');
+		$this->debug('cleaned data, stringlen: '.strlen($data));
+		// clean headers
+		foreach ($header_array as $header_line) {
+			$arr = explode(':',$header_line,2);
+			if(count($arr) > 1){
+				$header_name = strtolower(trim($arr[0]));
+				$this->incoming_headers[$header_name] = trim($arr[1]);
+				if ($header_name == 'set-cookie') {
+					// TODO: allow multiple cookies from parseCookie
+					$cookie = $this->parseCookie(trim($arr[1]));
+					if ($cookie) {
+						$this->incoming_cookies[] = $cookie;
+						$this->debug('found cookie: ' . $cookie['name'] . ' = ' . $cookie['value']);
+					} else {
+						$this->debug('did not find cookie in ' . trim($arr[1]));
+					}
+    			}
+			} else if (isset($header_name)) {
+				// append continuation line to previous header
+				$this->incoming_headers[$header_name] .= $lb . ' ' . $header_line;
+			}
+		}
+	  }
+
+		$arr = explode(' ', $header_array[0], 3);
+		$http_version = $arr[0];
+		$http_status = intval($arr[1]);
+		$http_reason = count($arr) > 2 ? $arr[2] : '';
+
+ 		// see if we need to resend the request with http digest authentication
+ 		if (isset($this->incoming_headers['location']) && $http_status == 301) {
+ 			$this->debug("Got 301 $http_reason with Location: " . $this->incoming_headers['location']);
+ 			$this->setURL($this->incoming_headers['location']);
+			$this->tryagain = true;
+			return false;
+		}
+
+ 		// see if we need to resend the request with http digest authentication
+ 		if (isset($this->incoming_headers['www-authenticate']) && $http_status == 401) {
+ 			$this->debug("Got 401 $http_reason with WWW-Authenticate: " . $this->incoming_headers['www-authenticate']);
+ 			if (strstr($this->incoming_headers['www-authenticate'], "Digest ")) {
+ 				$this->debug('Server wants digest authentication');
+ 				// remove "Digest " from our elements
+ 				$digestString = str_replace('Digest ', '', $this->incoming_headers['www-authenticate']);
+ 				
+ 				// parse elements into array
+ 				$digestElements = explode(',', $digestString);
+ 				foreach ($digestElements as $val) {
+ 					$tempElement = explode('=', trim($val), 2);
+ 					$digestRequest[$tempElement[0]] = str_replace("\"", '', $tempElement[1]);
+ 				}
+
+				// should have (at least) qop, realm, nonce
+ 				if (isset($digestRequest['nonce'])) {
+ 					$this->setCredentials($this->username, $this->password, 'digest', $digestRequest);
+ 					$this->tryagain = true;
+ 					return false;
+ 				}
+ 			}
+			$this->debug('HTTP authentication failed');
+			$this->setError('HTTP authentication failed');
+			return false;
+ 		}
+		
+		if (
+			($http_status >= 300 && $http_status <= 307) ||
+			($http_status >= 400 && $http_status <= 417) ||
+			($http_status >= 501 && $http_status <= 505)
+		   ) {
+			$this->setError("Unsupported HTTP response status $http_status $http_reason (soapclient->response has contents of the response)");
+			return false;
+		}
+
+		// decode content-encoding
+		if(isset($this->incoming_headers['content-encoding']) && $this->incoming_headers['content-encoding'] != ''){
+			if(strtolower($this->incoming_headers['content-encoding']) == 'deflate' || strtolower($this->incoming_headers['content-encoding']) == 'gzip'){
+    			// if decoding works, use it. else assume data wasn't gzencoded
+    			if(function_exists('gzinflate')){
+					//$timer->setMarker('starting decoding of gzip/deflated content');
+					// IIS 5 requires gzinflate instead of gzuncompress (similar to IE 5 and gzdeflate v. gzcompress)
+					// this means there are no Zlib headers, although there should be
+					$this->debug('The gzinflate function exists');
+					$datalen = strlen($data);
+					if ($this->incoming_headers['content-encoding'] == 'deflate') {
+						if ($degzdata = @gzinflate($data)) {
+	    					$data = $degzdata;
+	    					$this->debug('The payload has been inflated to ' . strlen($data) . ' bytes');
+	    					if (strlen($data) < $datalen) {
+	    						// test for the case that the payload has been compressed twice
+		    					$this->debug('The inflated payload is smaller than the gzipped one; try again');
+								if ($degzdata = @gzinflate($data)) {
+			    					$data = $degzdata;
+			    					$this->debug('The payload has been inflated again to ' . strlen($data) . ' bytes');
+								}
+	    					}
+	    				} else {
+	    					$this->debug('Error using gzinflate to inflate the payload');
+	    					$this->setError('Error using gzinflate to inflate the payload');
+	    				}
+					} elseif ($this->incoming_headers['content-encoding'] == 'gzip') {
+						if ($degzdata = @gzinflate(substr($data, 10))) {	// do our best
+							$data = $degzdata;
+	    					$this->debug('The payload has been un-gzipped to ' . strlen($data) . ' bytes');
+	    					if (strlen($data) < $datalen) {
+	    						// test for the case that the payload has been compressed twice
+		    					$this->debug('The un-gzipped payload is smaller than the gzipped one; try again');
+								if ($degzdata = @gzinflate(substr($data, 10))) {
+			    					$data = $degzdata;
+			    					$this->debug('The payload has been un-gzipped again to ' . strlen($data) . ' bytes');
+								}
+	    					}
+	    				} else {
+	    					$this->debug('Error using gzinflate to un-gzip the payload');
+							$this->setError('Error using gzinflate to un-gzip the payload');
+	    				}
+					}
+					//$timer->setMarker('finished decoding of gzip/deflated content');
+					//print "<xmp>\nde-inflated:\n---------------\n$data\n-------------\n</xmp>";
+					// set decoded payload
+					$this->incoming_payload = $header_data.$lb.$lb.$data;
+    			} else {
+					$this->debug('The server sent compressed data. Your php install must have the Zlib extension compiled in to support this.');
+					$this->setError('The server sent compressed data. Your php install must have the Zlib extension compiled in to support this.');
+				}
+			} else {
+				$this->debug('Unsupported Content-Encoding ' . $this->incoming_headers['content-encoding']);
+				$this->setError('Unsupported Content-Encoding ' . $this->incoming_headers['content-encoding']);
+			}
+		} else {
+			$this->debug('No Content-Encoding header');
+		}
+		
+		if(strlen($data) == 0){
+			$this->debug('no data after headers!');
+			$this->setError('no data present after HTTP headers');
+			return false;
+		}
+		
+		return $data;
+	}
+
+	function setContentType($type, $charset = false) {
+		$this->outgoing_headers['Content-Type'] = $type . ($charset ? '; charset=' . $charset : '');
+		$this->debug('set Content-Type: ' . $this->outgoing_headers['Content-Type']);
+	}
+
+	function usePersistentConnection(){
+		if (isset($this->outgoing_headers['Accept-Encoding'])) {
+			return false;
+		}
+		$this->protocol_version = '1.1';
+		$this->persistentConnection = true;
+		$this->outgoing_headers['Connection'] = 'Keep-Alive';
+		$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+		return true;
+	}
+
+	/**
+	 * parse an incoming Cookie into it's parts
+	 *
+	 * @param	string $cookie_str content of cookie
+	 * @return	array with data of that cookie
+	 * @access	private
+	 */
+	/*
+	 * TODO: allow a Set-Cookie string to be parsed into multiple cookies
+	 */
+	function parseCookie($cookie_str) {
+		$cookie_str = str_replace('; ', ';', $cookie_str) . ';';
+		$data = split(';', $cookie_str);
+		$value_str = $data[0];
+
+		$cookie_param = 'domain=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ($start > 0) {
+			$domain = substr($cookie_str, $start + strlen($cookie_param));
+			$domain = substr($domain, 0, strpos($domain, ';'));
+		} else {
+			$domain = '';
+		}
+
+		$cookie_param = 'expires=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ($start > 0) {
+			$expires = substr($cookie_str, $start + strlen($cookie_param));
+			$expires = substr($expires, 0, strpos($expires, ';'));
+		} else {
+			$expires = '';
+		}
+
+		$cookie_param = 'path=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ( $start > 0 ) {
+			$path = substr($cookie_str, $start + strlen($cookie_param));
+			$path = substr($path, 0, strpos($path, ';'));
+		} else {
+			$path = '/';
+		}
+						
+		$cookie_param = ';secure;';
+		if (strpos($cookie_str, $cookie_param) !== FALSE) {
+			$secure = true;
+		} else {
+			$secure = false;
+		}
+
+		$sep_pos = strpos($value_str, '=');
+
+		if ($sep_pos) {
+			$name = substr($value_str, 0, $sep_pos);
+			$value = substr($value_str, $sep_pos + 1);
+			$cookie= array(	'name' => $name,
+			                'value' => $value,
+							'domain' => $domain,
+							'path' => $path,
+							'expires' => $expires,
+							'secure' => $secure
+							);		
+			return $cookie;
+		}
+		return false;
+	}
+  
+	/**
+	 * sort out cookies for the current request
+	 *
+	 * @param	array $cookies array with all cookies
+	 * @param	boolean $secure is the send-content secure or not?
+	 * @return	string for Cookie-HTTP-Header
+	 * @access	private
+	 */
+	function getCookiesForRequest($cookies, $secure=false) {
+		$cookie_str = '';
+		if ((! is_null($cookies)) && (is_array($cookies))) {
+			foreach ($cookies as $cookie) {
+				if (! is_array($cookie)) {
+					continue;
+				}
+	    		$this->debug("check cookie for validity: ".$cookie['name'].'='.$cookie['value']);
+				if ((isset($cookie['expires'])) && (! empty($cookie['expires']))) {
+					if (strtotime($cookie['expires']) <= time()) {
+						$this->debug('cookie has expired');
+						continue;
+					}
+				}
+				if ((isset($cookie['domain'])) && (! empty($cookie['domain']))) {
+					$domain = preg_quote($cookie['domain']);
+					if (! preg_match("'.*$domain$'i", $this->host)) {
+						$this->debug('cookie has different domain');
+						continue;
+					}
+				}
+				if ((isset($cookie['path'])) && (! empty($cookie['path']))) {
+					$path = preg_quote($cookie['path']);
+					if (! preg_match("'^$path.*'i", $this->path)) {
+						$this->debug('cookie is for a different path');
+						continue;
+					}
+				}
+				if ((! $secure) && (isset($cookie['secure'])) && ($cookie['secure'])) {
+					$this->debug('cookie is secure, transport is not');
+					continue;
+				}
+				$cookie_str .= $cookie['name'] . '=' . $cookie['value'] . '; ';
+	    		$this->debug('add cookie to Cookie-String: ' . $cookie['name'] . '=' . $cookie['value']);
+			}
+		}
+		return $cookie_str;
+  }
+}
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soap_val.php
===================================================================
--- cms/trunk/includes/nusoap/class.soap_val.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soap_val.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,107 @@
+<?php
+
+
+
+
+/**
+* For creating serializable abstractions of native PHP types.  This class
+* allows element name/namespace, XSD type, and XML attributes to be
+* associated with a value.  This is extremely useful when WSDL is not
+* used, but is also useful when WSDL is used with polymorphic types, including
+* xsd:anyType and user-defined types.
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soap_val.php,v 1.9 2005/07/27 19:24:42 snichol Exp $
+* @access   public
+*/
+class soapval extends nusoap_base {
+	/**
+	 * The XML element name
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $name;
+	/**
+	 * The XML type name (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $type;
+	/**
+	 * The PHP value
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $value;
+	/**
+	 * The XML element namespace (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $element_ns;
+	/**
+	 * The XML type namespace (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $type_ns;
+	/**
+	 * The XML element attributes (array or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $attributes;
+
+	/**
+	* constructor
+	*
+	* @param    string $name optional name
+	* @param    mixed $type optional type name
+	* @param	mixed $value optional value
+	* @param	mixed $element_ns optional namespace of value
+	* @param	mixed $type_ns optional namespace of type
+	* @param	mixed $attributes associative array of attributes to add to element serialization
+	* @access   public
+	*/
+  	function soapval($name='soapval',$type=false,$value=-1,$element_ns=false,$type_ns=false,$attributes=false) {
+		parent::nusoap_base();
+		$this->name = $name;
+		$this->type = $type;
+		$this->value = $value;
+		$this->element_ns = $element_ns;
+		$this->type_ns = $type_ns;
+		$this->attributes = $attributes;
+    }
+
+	/**
+	* return serialized value
+	*
+	* @param	string $use The WSDL use value (encoded|literal)
+	* @return	string XML data
+	* @access   public
+	*/
+	function serialize($use='encoded') {
+		return $this->serialize_val($this->value,$this->name,$this->type,$this->element_ns,$this->type_ns,$this->attributes,$use);
+    }
+
+	/**
+	* decodes a soapval object into a PHP native type
+	*
+	* @return	mixed
+	* @access   public
+	*/
+	function decode(){
+		return $this->value;
+	}
+}
+
+
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.soapclient.php
===================================================================
--- cms/trunk/includes/nusoap/class.soapclient.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.soapclient.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,859 @@
+<?php
+
+
+
+
+/**
+*
+* soapclient higher level class for easy usage.
+*
+* usage:
+*
+* // instantiate client with server info
+* $soapclient = new soapclient( string path [ ,boolean wsdl] );
+*
+* // call method, get results
+* echo $soapclient->call( string methodname [ ,array parameters] );
+*
+* // bye bye client
+* unset($soapclient);
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.soapclient.php,v 1.52 2005/07/27 19:24:42 snichol Exp $
+* @access   public
+*/
+class soapclient extends nusoap_base  {
+
+	var $username = '';
+	var $password = '';
+	var $authtype = '';
+	var $certRequest = array();
+	var $requestHeaders = false;	// SOAP headers in request (text)
+	var $responseHeaders = '';		// SOAP headers from response (incomplete namespace resolution) (text)
+	var $document = '';				// SOAP body response portion (incomplete namespace resolution) (text)
+	var $endpoint;
+	var $forceEndpoint = '';		// overrides WSDL endpoint
+    var $proxyhost = '';
+    var $proxyport = '';
+	var $proxyusername = '';
+	var $proxypassword = '';
+    var $xml_encoding = '';			// character set encoding of incoming (response) messages
+	var $http_encoding = false;
+	var $timeout = 0;				// HTTP connection timeout
+	var $response_timeout = 30;		// HTTP response timeout
+	var $endpointType = '';			// soap|wsdl, empty for WSDL initialization error
+	var $persistentConnection = false;
+	var $defaultRpcParams = false;	// This is no longer used
+	var $request = '';				// HTTP request
+	var $response = '';				// HTTP response
+	var $responseData = '';			// SOAP payload of response
+	var $cookies = array();			// Cookies from response or for request
+    var $decode_utf8 = true;		// toggles whether the parser decodes element content w/ utf8_decode()
+	var $operations = array();		// WSDL operations, empty for WSDL initialization error
+	
+	/*
+	 * fault related variables
+	 */
+	/**
+	 * @var      fault
+	 * @access   public
+	 */
+	var $fault;
+	/**
+	 * @var      faultcode
+	 * @access   public
+	 */
+	var $faultcode;
+	/**
+	 * @var      faultstring
+	 * @access   public
+	 */
+	var $faultstring;
+	/**
+	 * @var      faultdetail
+	 * @access   public
+	 */
+	var $faultdetail;
+
+	/**
+	* constructor
+	*
+	* @param    mixed $endpoint SOAP server or WSDL URL (string), or wsdl instance (object)
+	* @param    bool $wsdl optional, set to true if using WSDL
+	* @param	int $portName optional portName in WSDL document
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @param	integer $timeout set the connection timeout
+	* @param	integer $response_timeout set the response timeout
+	* @access   public
+	*/
+	function soapclient($endpoint,$wsdl = false,$proxyhost = false,$proxyport = false,$proxyusername = false, $proxypassword = false, $timeout = 0, $response_timeout = 30){
+		parent::nusoap_base();
+		$this->endpoint = $endpoint;
+		$this->proxyhost = $proxyhost;
+		$this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+		$this->timeout = $timeout;
+		$this->response_timeout = $response_timeout;
+
+		// make values
+		if($wsdl){
+			if (is_object($endpoint) && (get_class($endpoint) == 'wsdl')) {
+				$this->wsdl = $endpoint;
+				$this->endpoint = $this->wsdl->wsdl;
+				$this->wsdlFile = $this->endpoint;
+				$this->debug('existing wsdl instance created from ' . $this->endpoint);
+			} else {
+				$this->wsdlFile = $this->endpoint;
+				
+				// instantiate wsdl object and parse wsdl file
+				$this->debug('instantiating wsdl class with doc: '.$endpoint);
+				$this->wsdl =& new wsdl($this->wsdlFile,$this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword,$this->timeout,$this->response_timeout);
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			// catch errors
+			if($errstr = $this->wsdl->getError()){
+				$this->debug('got wsdl error: '.$errstr);
+				$this->setError('wsdl error: '.$errstr);
+			} elseif($this->operations = $this->wsdl->getOperations()){
+				$this->debug( 'got '.count($this->operations).' operations from wsdl '.$this->wsdlFile);
+				$this->endpointType = 'wsdl';
+			} else {
+				$this->debug( 'getOperations returned false');
+				$this->setError('no operations defined in the WSDL document!');
+			}
+		} else {
+			$this->debug("instantiate SOAP with endpoint at $endpoint");
+			$this->endpointType = 'soap';
+		}
+	}
+
+	/**
+	* calls method, returns PHP native type
+	*
+	* @param    string $method SOAP server URL or path
+	* @param    mixed $params An array, associative or simple, of the parameters
+	*			              for the method call, or a string that is the XML
+	*			              for the call.  For rpc style, this call will
+	*			              wrap the XML in a tag named after the method, as
+	*			              well as the SOAP Envelope and Body.  For document
+	*			              style, this will only wrap with the Envelope and Body.
+	*			              IMPORTANT: when using an array with document style,
+	*			              in which case there
+	*                         is really one parameter, the root of the fragment
+	*                         used in the call, which encloses what programmers
+	*                         normally think of parameters.  A parameter array
+	*                         *must* include the wrapper.
+	* @param	string $namespace optional method namespace (WSDL can override)
+	* @param	string $soapAction optional SOAPAction value (WSDL can override)
+	* @param	mixed $headers optional string of XML with SOAP header content, or array of soapval objects for SOAP headers
+	* @param	boolean $rpcParams optional (no longer used)
+	* @param	string	$style optional (rpc|document) the style to use when serializing parameters (WSDL can override)
+	* @param	string	$use optional (encoded|literal) the use when serializing parameters (WSDL can override)
+	* @return	mixed	response from SOAP call
+	* @access   public
+	*/
+	function call($operation,$params=array(),$namespace='http://tempuri.org',$soapAction='',$headers=false,$rpcParams=null,$style='rpc',$use='encoded'){
+		$this->operation = $operation;
+		$this->fault = false;
+		$this->setError('');
+		$this->request = '';
+		$this->response = '';
+		$this->responseData = '';
+		$this->faultstring = '';
+		$this->faultcode = '';
+		$this->opData = array();
+		
+		$this->debug("call: operation=$operation, namespace=$namespace, soapAction=$soapAction, rpcParams=$rpcParams, style=$style, use=$use, endpointType=$this->endpointType");
+		$this->appendDebug('params=' . $this->varDump($params));
+		$this->appendDebug('headers=' . $this->varDump($headers));
+		if ($headers) {
+			$this->requestHeaders = $headers;
+		}
+		// serialize parameters
+		if($this->endpointType == 'wsdl' && $opData = $this->getOperationData($operation)){
+			// use WSDL for operation
+			$this->opData = $opData;
+			$this->debug("found operation");
+			$this->appendDebug('opData=' . $this->varDump($opData));
+			if (isset($opData['soapAction'])) {
+				$soapAction = $opData['soapAction'];
+			}
+			if (! $this->forceEndpoint) {
+				$this->endpoint = $opData['endpoint'];
+			} else {
+				$this->endpoint = $this->forceEndpoint;
+			}
+			$namespace = isset($opData['input']['namespace']) ? $opData['input']['namespace'] :	$namespace;
+			$style = $opData['style'];
+			$use = $opData['input']['use'];
+			// add ns to ns array
+			if($namespace != '' && !isset($this->wsdl->namespaces[$namespace])){
+				$nsPrefix = 'ns' . rand(1000, 9999);
+				$this->wsdl->namespaces[$nsPrefix] = $namespace;
+			}
+            $nsPrefix = $this->wsdl->getPrefixFromNamespace($namespace);
+			// serialize payload
+			if (is_string($params)) {
+				$this->debug("serializing param string for WSDL operation $operation");
+				$payload = $params;
+			} elseif (is_array($params)) {
+				$this->debug("serializing param array for WSDL operation $operation");
+				$payload = $this->wsdl->serializeRPCParameters($operation,'input',$params);
+			} else {
+				$this->debug('params must be array or string');
+				$this->setError('params must be array or string');
+				return false;
+			}
+            $usedNamespaces = $this->wsdl->usedNamespaces;
+			if (isset($opData['input']['encodingStyle'])) {
+				$encodingStyle = $opData['input']['encodingStyle'];
+			} else {
+				$encodingStyle = '';
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			if ($errstr = $this->wsdl->getError()) {
+				$this->debug('got wsdl error: '.$errstr);
+				$this->setError('wsdl error: '.$errstr);
+				return false;
+			}
+		} elseif($this->endpointType == 'wsdl') {
+			// operation not in WSDL
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			$this->setError( 'operation '.$operation.' not present.');
+			$this->debug("operation '$operation' not present.");
+			return false;
+		} else {
+			// no WSDL
+			//$this->namespaces['ns1'] = $namespace;
+			$nsPrefix = 'ns' . rand(1000, 9999);
+			// serialize 
+			$payload = '';
+			if (is_string($params)) {
+				$this->debug("serializing param string for operation $operation");
+				$payload = $params;
+			} elseif (is_array($params)) {
+				$this->debug("serializing param array for operation $operation");
+				foreach($params as $k => $v){
+					$payload .= $this->serialize_val($v,$k,false,false,false,false,$use);
+				}
+			} else {
+				$this->debug('params must be array or string');
+				$this->setError('params must be array or string');
+				return false;
+			}
+			$usedNamespaces = array();
+			if ($use == 'encoded') {
+				$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+			} else {
+				$encodingStyle = '';
+			}
+		}
+		// wrap RPC calls with method element
+		if ($style == 'rpc') {
+			if ($use == 'literal') {
+				$this->debug("wrapping RPC request with literal method element");
+				if ($namespace) {
+					$payload = "<$operation xmlns=\"$namespace\">" . $payload . "</$operation>";
+				} else {
+					$payload = "<$operation>" . $payload . "</$operation>";
+				}
+			} else {
+				$this->debug("wrapping RPC request with encoded method element");
+				if ($namespace) {
+					$payload = "<$nsPrefix:$operation xmlns:$nsPrefix=\"$namespace\">" .
+								$payload .
+								"</$nsPrefix:$operation>";
+				} else {
+					$payload = "<$operation>" .
+								$payload .
+								"</$operation>";
+				}
+			}
+		}
+		// serialize envelope
+		$soapmsg = $this->serializeEnvelope($payload,$this->requestHeaders,$usedNamespaces,$style,$use,$encodingStyle);
+		$this->debug("endpoint=$this->endpoint, soapAction=$soapAction, namespace=$namespace, style=$style, use=$use, encodingStyle=$encodingStyle");
+		$this->debug('SOAP message length=' . strlen($soapmsg) . ' contents (max 1000 bytes)=' . substr($soapmsg, 0, 1000));
+		// send
+		$return = $this->send($this->getHTTPBody($soapmsg),$soapAction,$this->timeout,$this->response_timeout);
+		if($errstr = $this->getError()){
+			$this->debug('Error: '.$errstr);
+			return false;
+		} else {
+			$this->return = $return;
+			$this->debug('sent message successfully and got a(n) '.gettype($return));
+           	$this->appendDebug('return=' . $this->varDump($return));
+			
+			// fault?
+			if(is_array($return) && isset($return['faultcode'])){
+				$this->debug('got fault');
+				$this->setError($return['faultcode'].': '.$return['faultstring']);
+				$this->fault = true;
+				foreach($return as $k => $v){
+					$this->$k = $v;
+					$this->debug("$k = $v<br>");
+				}
+				return $return;
+			} elseif ($style == 'document') {
+				// NOTE: if the response is defined to have multiple parts (i.e. unwrapped),
+				// we are only going to return the first part here...sorry about that
+				return $return;
+			} else {
+				// array of return values
+				if(is_array($return)){
+					// multiple 'out' parameters, which we return wrapped up
+					// in the array
+					if(sizeof($return) > 1){
+						return $return;
+					}
+					// single 'out' parameter (normally the return value)
+					$return = array_shift($return);
+					$this->debug('return shifted value: ');
+					$this->appendDebug($this->varDump($return));
+           			return $return;
+				// nothing returned (ie, echoVoid)
+				} else {
+					return "";
+				}
+			}
+		}
+	}
+
+	/**
+	* get available data pertaining to an operation
+	*
+	* @param    string $operation operation name
+	* @return	array array of data pertaining to the operation
+	* @access   public
+	*/
+	function getOperationData($operation){
+		if(isset($this->operations[$operation])){
+			return $this->operations[$operation];
+		}
+		$this->debug("No data for operation: $operation");
+	}
+
+    /**
+    * send the SOAP message
+    *
+    * Note: if the operation has multiple return values
+    * the return value of this method will be an array
+    * of those values.
+    *
+	* @param    string $msg a SOAPx4 soapmsg object
+	* @param    string $soapaction SOAPAction value
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @return	mixed native PHP types.
+	* @access   private
+	*/
+	function send($msg, $soapaction = '', $timeout=0, $response_timeout=30) {
+		$this->checkCookies();
+		// detect transport
+		switch(true){
+			// http(s)
+			case ereg('^http',$this->endpoint):
+				$this->debug('transporting via HTTP');
+				if($this->persistentConnection == true && is_object($this->persistentConnection)){
+					$http =& $this->persistentConnection;
+				} else {
+					$http = new soap_transport_http($this->endpoint);
+					if ($this->persistentConnection) {
+						$http->usePersistentConnection();
+					}
+				}
+				$http->setContentType($this->getHTTPContentType(), $this->getHTTPContentTypeCharset());
+				$http->setSOAPAction($soapaction);
+				if($this->proxyhost && $this->proxyport){
+					$http->setProxy($this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword);
+				}
+                if($this->authtype != '') {
+					$http->setCredentials($this->username, $this->password, $this->authtype, array(), $this->certRequest);
+				}
+				if($this->http_encoding != ''){
+					$http->setEncoding($this->http_encoding);
+				}
+				$this->debug('sending message, length='.strlen($msg));
+				if(ereg('^http:',$this->endpoint)){
+				//if(strpos($this->endpoint,'http:')){
+					$this->responseData = $http->send($msg,$timeout,$response_timeout,$this->cookies);
+				} elseif(ereg('^https',$this->endpoint)){
+				//} elseif(strpos($this->endpoint,'https:')){
+					//if(phpversion() == '4.3.0-dev'){
+						//$response = $http->send($msg,$timeout,$response_timeout);
+                   		//$this->request = $http->outgoing_payload;
+						//$this->response = $http->incoming_payload;
+					//} else
+					$this->responseData = $http->sendHTTPS($msg,$timeout,$response_timeout,$this->cookies);
+				} else {
+					$this->setError('no http/s in endpoint url');
+				}
+				$this->request = $http->outgoing_payload;
+				$this->response = $http->incoming_payload;
+				$this->appendDebug($http->getDebug());
+				$this->UpdateCookies($http->incoming_cookies);
+
+				// save transport object if using persistent connections
+				if ($this->persistentConnection) {
+					$http->clearDebug();
+					if (!is_object($this->persistentConnection)) {
+						$this->persistentConnection = $http;
+					}
+				}
+				
+				if($err = $http->getError()){
+					$this->setError('HTTP Error: '.$err);
+					return false;
+				} elseif($this->getError()){
+					return false;
+				} else {
+					$this->debug('got response, length='. strlen($this->responseData).' type='.$http->incoming_headers['content-type']);
+					return $this->parseResponse($http->incoming_headers, $this->responseData);
+				}
+			break;
+			default:
+				$this->setError('no transport found, or selected transport is not yet supported!');
+			return false;
+			break;
+		}
+	}
+
+	/**
+	* processes SOAP message returned from server
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed response data from server
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseResponse($headers, $data) {
+		$this->debug('Entering parseResponse() for data of length ' . strlen($data) . ' and type ' . $headers['content-type']);
+		if (!strstr($headers['content-type'], 'text/xml')) {
+			$this->setError('Response not of type text/xml');
+			return false;
+		}
+		if (strpos($headers['content-type'], '=')) {
+			$enc = str_replace('"', '', substr(strstr($headers["content-type"], '='), 1));
+			$this->debug('Got response encoding: ' . $enc);
+			if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+				$this->xml_encoding = strtoupper($enc);
+			} else {
+				$this->xml_encoding = 'US-ASCII';
+			}
+		} else {
+			// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+			$this->xml_encoding = 'ISO-8859-1';
+		}
+		$this->debug('Use encoding: ' . $this->xml_encoding . ' when creating soap_parser');
+		$parser = new soap_parser($data,$this->xml_encoding,$this->operation,$this->decode_utf8);
+		// add parser debug data to our debug
+		$this->appendDebug($parser->getDebug());
+		// if parse errors
+		if($errstr = $parser->getError()){
+			$this->setError( $errstr);
+			// destroy the parser object
+			unset($parser);
+			return false;
+		} else {
+			// get SOAP headers
+			$this->responseHeaders = $parser->getHeaders();
+			// get decoded message
+			$return = $parser->get_response();
+            // add document for doclit support
+            $this->document = $parser->document;
+			// destroy the parser object
+			unset($parser);
+			// return decode message
+			return $return;
+		}
+	 }
+
+	/**
+	* sets the SOAP endpoint, which can override WSDL
+	*
+	* @param	$endpoint string The endpoint URL to use, or empty string or false to prevent override
+	* @access   public
+	*/
+	function setEndpoint($endpoint) {
+		$this->forceEndpoint = $endpoint;
+	}
+
+	/**
+	* set the SOAP headers
+	*
+	* @param	$headers mixed String of XML with SOAP header content, or array of soapval objects for SOAP headers
+	* @access   public
+	*/
+	function setHeaders($headers){
+		$this->requestHeaders = $headers;
+	}
+
+	/**
+	* get the SOAP response headers (namespace resolution incomplete)
+	*
+	* @return	string
+	* @access   public
+	*/
+	function getHeaders(){
+		return $this->responseHeaders;
+	}
+
+	/**
+	* set proxy info here
+	*
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @access   public
+	*/
+	function setHTTPProxy($proxyhost, $proxyport, $proxyusername = '', $proxypassword = '') {
+		$this->proxyhost = $proxyhost;
+		$this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+	}
+
+	/**
+	* if authenticating, set user credentials here
+	*
+	* @param    string $username
+	* @param    string $password
+	* @param	string $authtype (basic|digest|certificate)
+	* @param	array $certRequest (keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional): see corresponding options in cURL docs)
+	* @access   public
+	*/
+	function setCredentials($username, $password, $authtype = 'basic', $certRequest = array()) {
+		$this->username = $username;
+		$this->password = $password;
+		$this->authtype = $authtype;
+		$this->certRequest = $certRequest;
+	}
+	
+	/**
+	* use HTTP encoding
+	*
+	* @param    string $enc
+	* @access   public
+	*/
+	function setHTTPEncoding($enc='gzip, deflate'){
+		$this->http_encoding = $enc;
+	}
+	
+	/**
+	* use HTTP persistent connections if possible
+	*
+	* @access   public
+	*/
+	function useHTTPPersistentConnection(){
+		$this->persistentConnection = true;
+	}
+	
+	/**
+	* gets the default RPC parameter setting.
+	* If true, default is that call params are like RPC even for document style.
+	* Each call() can override this value.
+	*
+	* This is no longer used.
+	*
+	* @return boolean
+	* @access public
+	* @deprecated
+	*/
+	function getDefaultRpcParams() {
+		return $this->defaultRpcParams;
+	}
+
+	/**
+	* sets the default RPC parameter setting.
+	* If true, default is that call params are like RPC even for document style
+	* Each call() can override this value.
+	*
+	* This is no longer used.
+	*
+	* @param    boolean $rpcParams
+	* @access public
+	* @deprecated
+	*/
+	function setDefaultRpcParams($rpcParams) {
+		$this->defaultRpcParams = $rpcParams;
+	}
+	
+	/**
+	* dynamically creates an instance of a proxy class,
+	* allowing user to directly call methods from wsdl
+	*
+	* @return   object soap_proxy object
+	* @access   public
+	*/
+	function getProxy(){
+		$r = rand();
+		$evalStr = $this->_getProxyClassCode($r);
+		//$this->debug("proxy class: $evalStr";
+		// eval the class
+		eval($evalStr);
+		// instantiate proxy object
+		eval("\$proxy = new soap_proxy_$r('');");
+		// transfer current wsdl data to the proxy thereby avoiding parsing the wsdl twice
+		$proxy->endpointType = 'wsdl';
+		$proxy->wsdlFile = $this->wsdlFile;
+		$proxy->wsdl = $this->wsdl;
+		$proxy->operations = $this->operations;
+		$proxy->defaultRpcParams = $this->defaultRpcParams;
+		// transfer other state
+		$proxy->username = $this->username;
+		$proxy->password = $this->password;
+		$proxy->authtype = $this->authtype;
+		$proxy->proxyhost = $this->proxyhost;
+		$proxy->proxyport = $this->proxyport;
+		$proxy->proxyusername = $this->proxyusername;
+		$proxy->proxypassword = $this->proxypassword;
+		$proxy->timeout = $this->timeout;
+		$proxy->response_timeout = $this->response_timeout;
+		$proxy->http_encoding = $this->http_encoding;
+		$proxy->persistentConnection = $this->persistentConnection;
+		$proxy->requestHeaders = $this->requestHeaders;
+		$proxy->soap_defencoding = $this->soap_defencoding;
+		$proxy->endpoint = $this->endpoint;
+		$proxy->forceEndpoint = $this->forceEndpoint;
+		return $proxy;
+	}
+
+	/**
+	* dynamically creates proxy class code
+	*
+	* @return   string PHP/NuSOAP code for the proxy class
+	* @access   private
+	*/
+	function _getProxyClassCode($r) {
+		if ($this->endpointType != 'wsdl') {
+			$evalStr = 'A proxy can only be created for a WSDL client';
+			$this->setError($evalStr);
+			return $evalStr;
+		}
+		$evalStr = '';
+		foreach ($this->operations as $operation => $opData) {
+			if ($operation != '') {
+				// create param string and param comment string
+				if (sizeof($opData['input']['parts']) > 0) {
+					$paramStr = '';
+					$paramArrayStr = '';
+					$paramCommentStr = '';
+					foreach ($opData['input']['parts'] as $name => $type) {
+						$paramStr .= "\$$name, ";
+						$paramArrayStr .= "'$name' => \$$name, ";
+						$paramCommentStr .= "$type \$$name, ";
+					}
+					$paramStr = substr($paramStr, 0, strlen($paramStr)-2);
+					$paramArrayStr = substr($paramArrayStr, 0, strlen($paramArrayStr)-2);
+					$paramCommentStr = substr($paramCommentStr, 0, strlen($paramCommentStr)-2);
+				} else {
+					$paramStr = '';
+					$paramCommentStr = 'void';
+				}
+				$opData['namespace'] = !isset($opData['namespace']) ? 'http://testuri.com' : $opData['namespace'];
+				$evalStr .= "// $paramCommentStr
+	function " . str_replace('.', '__', $operation) . "($paramStr) {
+		\$params = array($paramArrayStr);
+		return \$this->call('$operation', \$params, '".$opData['namespace']."', '".(isset($opData['soapAction']) ? $opData['soapAction'] : '')."');
+	}
+	";
+				unset($paramStr);
+				unset($paramCommentStr);
+			}
+		}
+		$evalStr = 'class soap_proxy_'.$r.' extends soapclient {
+	'.$evalStr.'
+}';
+		return $evalStr;
+	}
+
+	/**
+	* dynamically creates proxy class code
+	*
+	* @return   string PHP/NuSOAP code for the proxy class
+	* @access   public
+	*/
+	function getProxyClassCode() {
+		$r = rand();
+		return $this->_getProxyClassCode($r);
+	}
+
+	/**
+	* gets the HTTP body for the current request.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		return $soapmsg;
+	}
+	
+	/**
+	* gets the HTTP content type for the current request.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current request.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		return 'text/xml';
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current request.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current request.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		return $this->soap_defencoding;
+	}
+
+	/*
+	* whether or not parser should decode utf8 element content
+    *
+    * @return   always returns true
+    * @access   public
+    */
+    function decodeUTF8($bool){
+		$this->decode_utf8 = $bool;
+		return true;
+    }
+
+	/**
+	 * adds a new Cookie into $this->cookies array
+	 *
+	 * @param	string $name Cookie Name
+	 * @param	string $value Cookie Value
+	 * @return	if cookie-set was successful returns true, else false
+	 * @access	public
+	 */
+	function setCookie($name, $value) {
+		if (strlen($name) == 0) {
+			return false;
+		}
+		$this->cookies[] = array('name' => $name, 'value' => $value);
+		return true;
+	}
+
+	/**
+	 * gets all Cookies
+	 *
+	 * @return   array with all internal cookies
+	 * @access   public
+	 */
+	function getCookies() {
+		return $this->cookies;
+	}
+
+	/**
+	 * checks all Cookies and delete those which are expired
+	 *
+	 * @return   always return true
+	 * @access   private
+	 */
+	function checkCookies() {
+		if (sizeof($this->cookies) == 0) {
+			return true;
+		}
+		$this->debug('checkCookie: check ' . sizeof($this->cookies) . ' cookies');
+		$curr_cookies = $this->cookies;
+		$this->cookies = array();
+		foreach ($curr_cookies as $cookie) {
+			if (! is_array($cookie)) {
+				$this->debug('Remove cookie that is not an array');
+				continue;
+			}
+			if ((isset($cookie['expires'])) && (! empty($cookie['expires']))) {
+				if (strtotime($cookie['expires']) > time()) {
+					$this->cookies[] = $cookie;
+				} else {
+					$this->debug('Remove expired cookie ' . $cookie['name']);
+				}
+			} else {
+				$this->cookies[] = $cookie;
+			}
+		}
+		$this->debug('checkCookie: '.sizeof($this->cookies).' cookies left in array');
+		return true;
+	}
+
+	/**
+	 * updates the current cookies with a new set
+	 *
+	 * @param	array $cookies new cookies with which to update current ones
+	 * @return	always return true
+	 * @access	private
+	 */
+	function UpdateCookies($cookies) {
+		if (sizeof($this->cookies) == 0) {
+			// no existing cookies: take whatever is new
+			if (sizeof($cookies) > 0) {
+				$this->debug('Setting new cookie(s)');
+				$this->cookies = $cookies;
+			}
+			return true;
+		}
+		if (sizeof($cookies) == 0) {
+			// no new cookies: keep what we've got
+			return true;
+		}
+		// merge
+		foreach ($cookies as $newCookie) {
+			if (!is_array($newCookie)) {
+				continue;
+			}
+			if ((!isset($newCookie['name'])) || (!isset($newCookie['value']))) {
+				continue;
+			}
+			$newName = $newCookie['name'];
+
+			$found = false;
+			for ($i = 0; $i < count($this->cookies); $i++) {
+				$cookie = $this->cookies[$i];
+				if (!is_array($cookie)) {
+					continue;
+				}
+				if (!isset($cookie['name'])) {
+					continue;
+				}
+				if ($newName != $cookie['name']) {
+					continue;
+				}
+				$newDomain = isset($newCookie['domain']) ? $newCookie['domain'] : 'NODOMAIN';
+				$domain = isset($cookie['domain']) ? $cookie['domain'] : 'NODOMAIN';
+				if ($newDomain != $domain) {
+					continue;
+				}
+				$newPath = isset($newCookie['path']) ? $newCookie['path'] : 'NOPATH';
+				$path = isset($cookie['path']) ? $cookie['path'] : 'NOPATH';
+				if ($newPath != $path) {
+					continue;
+				}
+				$this->cookies[$i] = $newCookie;
+				$found = true;
+				$this->debug('Update cookie ' . $newName . '=' . $newCookie['value']);
+				break;
+			}
+			if (! $found) {
+				$this->debug('Add cookie ' . $newName . '=' . $newCookie['value']);
+				$this->cookies[] = $newCookie;
+			}
+		}
+		return true;
+	}
+}
+?>

Added: cms/trunk/includes/nusoap/class.wsdl.php
===================================================================
--- cms/trunk/includes/nusoap/class.wsdl.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.wsdl.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,1727 @@
+<?php
+
+
+
+
+/**
+* parses a WSDL file, allows access to it's data, other utility methods
+* 
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.wsdl.php,v 1.56 2005/08/04 01:27:42 snichol Exp $
+* @access public 
+*/
+class wsdl extends nusoap_base {
+	// URL or filename of the root of this WSDL
+    var $wsdl; 
+    // define internal arrays of bindings, ports, operations, messages, etc.
+    var $schemas = array();
+    var $currentSchema;
+    var $message = array();
+    var $complexTypes = array();
+    var $messages = array();
+    var $currentMessage;
+    var $currentOperation;
+    var $portTypes = array();
+    var $currentPortType;
+    var $bindings = array();
+    var $currentBinding;
+    var $ports = array();
+    var $currentPort;
+    var $opData = array();
+    var $status = '';
+    var $documentation = false;
+    var $endpoint = ''; 
+    // array of wsdl docs to import
+    var $import = array(); 
+    // parser vars
+    var $parser;
+    var $position = 0;
+    var $depth = 0;
+    var $depth_array = array();
+	// for getting wsdl
+	var $proxyhost = '';
+    var $proxyport = '';
+	var $proxyusername = '';
+	var $proxypassword = '';
+	var $timeout = 0;
+	var $response_timeout = 30;
+
+    /**
+     * constructor
+     * 
+     * @param string $wsdl WSDL document URL
+	 * @param string $proxyhost
+	 * @param string $proxyport
+	 * @param string $proxyusername
+	 * @param string $proxypassword
+	 * @param integer $timeout set the connection timeout
+	 * @param integer $response_timeout set the response timeout
+     * @access public 
+     */
+    function wsdl($wsdl = '',$proxyhost=false,$proxyport=false,$proxyusername=false,$proxypassword=false,$timeout=0,$response_timeout=30){
+		parent::nusoap_base();
+        $this->wsdl = $wsdl;
+        $this->proxyhost = $proxyhost;
+        $this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+		$this->timeout = $timeout;
+		$this->response_timeout = $response_timeout;
+        
+        // parse wsdl file
+        if ($wsdl != "") {
+            $this->debug('initial wsdl URL: ' . $wsdl);
+            $this->parseWSDL($wsdl);
+        }
+        // imports
+        // TODO: handle imports more properly, grabbing them in-line and nesting them
+        	$imported_urls = array();
+        	$imported = 1;
+        	while ($imported > 0) {
+        		$imported = 0;
+        		// Schema imports
+        		foreach ($this->schemas as $ns => $list) {
+        			foreach ($list as $xs) {
+						$wsdlparts = parse_url($this->wsdl);	// this is bogusly simple!
+			            foreach ($xs->imports as $ns2 => $list2) {
+			                for ($ii = 0; $ii < count($list2); $ii++) {
+			                	if (! $list2[$ii]['loaded']) {
+			                		$this->schemas[$ns]->imports[$ns2][$ii]['loaded'] = true;
+			                		$url = $list2[$ii]['location'];
+									if ($url != '') {
+										$urlparts = parse_url($url);
+										if (!isset($urlparts['host'])) {
+											$url = $wsdlparts['scheme'] . '://' . $wsdlparts['host'] . (isset($wsdlparts['port']) ? ':' .$wsdlparts['port'] : '') .
+													substr($wsdlparts['path'],0,strrpos($wsdlparts['path'],'/') + 1) .$urlparts['path'];
+										}
+										if (! in_array($url, $imported_urls)) {
+						                	$this->parseWSDL($url);
+					                		$imported++;
+					                		$imported_urls[] = $url;
+					                	}
+									} else {
+										$this->debug("Unexpected scenario: empty URL for unloaded import");
+									}
+								}
+							}
+			            } 
+        			}
+        		}
+        		// WSDL imports
+				$wsdlparts = parse_url($this->wsdl);	// this is bogusly simple!
+	            foreach ($this->import as $ns => $list) {
+	                for ($ii = 0; $ii < count($list); $ii++) {
+	                	if (! $list[$ii]['loaded']) {
+	                		$this->import[$ns][$ii]['loaded'] = true;
+	                		$url = $list[$ii]['location'];
+							if ($url != '') {
+								$urlparts = parse_url($url);
+								if (!isset($urlparts['host'])) {
+									$url = $wsdlparts['scheme'] . '://' . $wsdlparts['host'] . (isset($wsdlparts['port']) ? ':' . $wsdlparts['port'] : '') .
+											substr($wsdlparts['path'],0,strrpos($wsdlparts['path'],'/') + 1) .$urlparts['path'];
+								}
+								if (! in_array($url, $imported_urls)) {
+				                	$this->parseWSDL($url);
+			                		$imported++;
+			                		$imported_urls[] = $url;
+			                	}
+							} else {
+								$this->debug("Unexpected scenario: empty URL for unloaded import");
+							}
+						}
+					}
+	            } 
+			}
+        // add new data to operation data
+        foreach($this->bindings as $binding => $bindingData) {
+            if (isset($bindingData['operations']) && is_array($bindingData['operations'])) {
+                foreach($bindingData['operations'] as $operation => $data) {
+                    $this->debug('post-parse data gathering for ' . $operation);
+                    $this->bindings[$binding]['operations'][$operation]['input'] = 
+						isset($this->bindings[$binding]['operations'][$operation]['input']) ? 
+						array_merge($this->bindings[$binding]['operations'][$operation]['input'], $this->portTypes[ $bindingData['portType'] ][$operation]['input']) :
+						$this->portTypes[ $bindingData['portType'] ][$operation]['input'];
+                    $this->bindings[$binding]['operations'][$operation]['output'] = 
+						isset($this->bindings[$binding]['operations'][$operation]['output']) ?
+						array_merge($this->bindings[$binding]['operations'][$operation]['output'], $this->portTypes[ $bindingData['portType'] ][$operation]['output']) :
+						$this->portTypes[ $bindingData['portType'] ][$operation]['output'];
+                    if(isset($this->messages[ $this->bindings[$binding]['operations'][$operation]['input']['message'] ])){
+						$this->bindings[$binding]['operations'][$operation]['input']['parts'] = $this->messages[ $this->bindings[$binding]['operations'][$operation]['input']['message'] ];
+					}
+					if(isset($this->messages[ $this->bindings[$binding]['operations'][$operation]['output']['message'] ])){
+                   		$this->bindings[$binding]['operations'][$operation]['output']['parts'] = $this->messages[ $this->bindings[$binding]['operations'][$operation]['output']['message'] ];
+                    }
+					if (isset($bindingData['style'])) {
+                        $this->bindings[$binding]['operations'][$operation]['style'] = $bindingData['style'];
+                    }
+                    $this->bindings[$binding]['operations'][$operation]['transport'] = isset($bindingData['transport']) ? $bindingData['transport'] : '';
+                    $this->bindings[$binding]['operations'][$operation]['documentation'] = isset($this->portTypes[ $bindingData['portType'] ][$operation]['documentation']) ? $this->portTypes[ $bindingData['portType'] ][$operation]['documentation'] : '';
+                    $this->bindings[$binding]['operations'][$operation]['endpoint'] = isset($bindingData['endpoint']) ? $bindingData['endpoint'] : '';
+                } 
+            } 
+        }
+    }
+
+    /**
+     * parses the wsdl document
+     * 
+     * @param string $wsdl path or URL
+     * @access private 
+     */
+    function parseWSDL($wsdl = '')
+    {
+        if ($wsdl == '') {
+            $this->debug('no wsdl passed to parseWSDL()!!');
+            $this->setError('no wsdl passed to parseWSDL()!!');
+            return false;
+        }
+        
+        // parse $wsdl for url format
+        $wsdl_props = parse_url($wsdl);
+
+        if (isset($wsdl_props['scheme']) && ($wsdl_props['scheme'] == 'http' || $wsdl_props['scheme'] == 'https')) {
+            $this->debug('getting WSDL http(s) URL ' . $wsdl);
+        	// get wsdl
+	        $tr = new soap_transport_http($wsdl);
+			$tr->request_method = 'GET';
+			$tr->useSOAPAction = false;
+			if($this->proxyhost && $this->proxyport){
+				$tr->setProxy($this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword);
+			}
+			$tr->setEncoding('gzip, deflate');
+			$wsdl_string = $tr->send('', $this->timeout, $this->response_timeout);
+			//$this->debug("WSDL request\n" . $tr->outgoing_payload);
+			//$this->debug("WSDL response\n" . $tr->incoming_payload);
+			$this->appendDebug($tr->getDebug());
+			// catch errors
+			if($err = $tr->getError() ){
+				$errstr = 'HTTP ERROR: '.$err;
+				$this->debug($errstr);
+	            $this->setError($errstr);
+				unset($tr);
+	            return false;
+			}
+			unset($tr);
+			$this->debug("got WSDL URL");
+        } else {
+            // $wsdl is not http(s), so treat it as a file URL or plain file path
+        	if (isset($wsdl_props['scheme']) && ($wsdl_props['scheme'] == 'file') && isset($wsdl_props['path'])) {
+        		$path = isset($wsdl_props['host']) ? ($wsdl_props['host'] . ':' . $wsdl_props['path']) : $wsdl_props['path'];
+        	} else {
+        		$path = $wsdl;
+        	}
+            $this->debug('getting WSDL file ' . $path);
+            if ($fp = @fopen($path, 'r')) {
+                $wsdl_string = '';
+                while ($data = fread($fp, 32768)) {
+                    $wsdl_string .= $data;
+                } 
+                fclose($fp);
+            } else {
+            	$errstr = "Bad path to WSDL file $path";
+            	$this->debug($errstr);
+                $this->setError($errstr);
+                return false;
+            } 
+        }
+        $this->debug('Parse WSDL');
+        // end new code added
+        // Create an XML parser.
+        $this->parser = xml_parser_create(); 
+        // Set the options for parsing the XML data.
+        // xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);
+        xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0); 
+        // Set the object for the parser.
+        xml_set_object($this->parser, $this); 
+        // Set the element handlers for the parser.
+        xml_set_element_handler($this->parser, 'start_element', 'end_element');
+        xml_set_character_data_handler($this->parser, 'character_data');
+        // Parse the XML file.
+        if (!xml_parse($this->parser, $wsdl_string, true)) {
+            // Display an error message.
+            $errstr = sprintf(
+				'XML error parsing WSDL from %s on line %d: %s',
+				$wsdl,
+                xml_get_current_line_number($this->parser),
+                xml_error_string(xml_get_error_code($this->parser))
+                );
+            $this->debug($errstr);
+			$this->debug("XML payload:\n" . $wsdl_string);
+            $this->setError($errstr);
+            return false;
+        } 
+		// free the parser
+        xml_parser_free($this->parser);
+        $this->debug('Parsing WSDL done');
+		// catch wsdl parse errors
+		if($this->getError()){
+			return false;
+		}
+        return true;
+    } 
+
+    /**
+     * start-element handler
+     * 
+     * @param string $parser XML parser object
+     * @param string $name element name
+     * @param string $attrs associative array of attributes
+     * @access private 
+     */
+    function start_element($parser, $name, $attrs)
+    {
+        if ($this->status == 'schema') {
+            $this->currentSchema->schemaStartElement($parser, $name, $attrs);
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+        } elseif (ereg('schema$', $name)) {
+        	$this->debug('Parsing WSDL schema');
+            // $this->debug("startElement for $name ($attrs[name]). status = $this->status (".$this->getLocalPart($name).")");
+            $this->status = 'schema';
+            $this->currentSchema = new xmlschema('', '', $this->namespaces);
+            $this->currentSchema->schemaStartElement($parser, $name, $attrs);
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+        } else {
+            // position in the total number of elements, starting from 0
+            $pos = $this->position++;
+            $depth = $this->depth++; 
+            // set self as current value for this depth
+            $this->depth_array[$depth] = $pos;
+            $this->message[$pos] = array('cdata' => ''); 
+            // process attributes
+            if (count($attrs) > 0) {
+				// register namespace declarations
+                foreach($attrs as $k => $v) {
+                    if (ereg("^xmlns", $k)) {
+                        if ($ns_prefix = substr(strrchr($k, ':'), 1)) {
+                            $this->namespaces[$ns_prefix] = $v;
+                        } else {
+                            $this->namespaces['ns' . (count($this->namespaces) + 1)] = $v;
+                        } 
+                        if ($v == 'http://www.w3.org/2001/XMLSchema' || $v == 'http://www.w3.org/1999/XMLSchema' || $v == 'http://www.w3.org/2000/10/XMLSchema') {
+                            $this->XMLSchemaVersion = $v;
+                            $this->namespaces['xsi'] = $v . '-instance';
+                        } 
+                    }
+                }
+                // expand each attribute prefix to its namespace
+                foreach($attrs as $k => $v) {
+                    $k = strpos($k, ':') ? $this->expandQname($k) : $k;
+                    if ($k != 'location' && $k != 'soapAction' && $k != 'namespace') {
+                        $v = strpos($v, ':') ? $this->expandQname($v) : $v;
+                    } 
+                    $eAttrs[$k] = $v;
+                } 
+                $attrs = $eAttrs;
+            } else {
+                $attrs = array();
+            } 
+            // get element prefix, namespace and name
+            if (ereg(':', $name)) {
+                // get ns prefix
+                $prefix = substr($name, 0, strpos($name, ':')); 
+                // get ns
+                $namespace = isset($this->namespaces[$prefix]) ? $this->namespaces[$prefix] : ''; 
+                // get unqualified name
+                $name = substr(strstr($name, ':'), 1);
+            } 
+			// process attributes, expanding any prefixes to namespaces
+            // find status, register data
+            switch ($this->status) {
+                case 'message':
+                    if ($name == 'part') {
+			            if (isset($attrs['type'])) {
+		                    $this->debug("msg " . $this->currentMessage . ": found part $attrs[name]: " . implode(',', $attrs));
+		                    $this->messages[$this->currentMessage][$attrs['name']] = $attrs['type'];
+            			} 
+			            if (isset($attrs['element'])) {
+		                    $this->debug("msg " . $this->currentMessage . ": found part $attrs[name]: " . implode(',', $attrs));
+			                $this->messages[$this->currentMessage][$attrs['name']] = $attrs['element'];
+			            } 
+        			} 
+        			break;
+			    case 'portType':
+			        switch ($name) {
+			            case 'operation':
+			                $this->currentPortOperation = $attrs['name'];
+			                $this->debug("portType $this->currentPortType operation: $this->currentPortOperation");
+			                if (isset($attrs['parameterOrder'])) {
+			                	$this->portTypes[$this->currentPortType][$attrs['name']]['parameterOrder'] = $attrs['parameterOrder'];
+			        		} 
+			        		break;
+					    case 'documentation':
+					        $this->documentation = true;
+					        break; 
+					    // merge input/output data
+					    default:
+					        $m = isset($attrs['message']) ? $this->getLocalPart($attrs['message']) : '';
+					        $this->portTypes[$this->currentPortType][$this->currentPortOperation][$name]['message'] = $m;
+					        break;
+					} 
+			    	break;
+				case 'binding':
+				    switch ($name) {
+				        case 'binding': 
+				            // get ns prefix
+				            if (isset($attrs['style'])) {
+				            $this->bindings[$this->currentBinding]['prefix'] = $prefix;
+					    	} 
+					    	$this->bindings[$this->currentBinding] = array_merge($this->bindings[$this->currentBinding], $attrs);
+					    	break;
+						case 'header':
+						    $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus]['headers'][] = $attrs;
+						    break;
+						case 'operation':
+						    if (isset($attrs['soapAction'])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['soapAction'] = $attrs['soapAction'];
+						    } 
+						    if (isset($attrs['style'])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['style'] = $attrs['style'];
+						    } 
+						    if (isset($attrs['name'])) {
+						        $this->currentOperation = $attrs['name'];
+						        $this->debug("current binding operation: $this->currentOperation");
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['name'] = $attrs['name'];
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['binding'] = $this->currentBinding;
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['endpoint'] = isset($this->bindings[$this->currentBinding]['endpoint']) ? $this->bindings[$this->currentBinding]['endpoint'] : '';
+						    } 
+						    break;
+						case 'input':
+						    $this->opStatus = 'input';
+						    break;
+						case 'output':
+						    $this->opStatus = 'output';
+						    break;
+						case 'body':
+						    if (isset($this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus] = array_merge($this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus], $attrs);
+						    } else {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus] = $attrs;
+						    } 
+						    break;
+					} 
+					break;
+				case 'service':
+					switch ($name) {
+					    case 'port':
+					        $this->currentPort = $attrs['name'];
+					        $this->debug('current port: ' . $this->currentPort);
+					        $this->ports[$this->currentPort]['binding'] = $this->getLocalPart($attrs['binding']);
+					
+					        break;
+					    case 'address':
+					        $this->ports[$this->currentPort]['location'] = $attrs['location'];
+					        $this->ports[$this->currentPort]['bindingType'] = $namespace;
+					        $this->bindings[ $this->ports[$this->currentPort]['binding'] ]['bindingType'] = $namespace;
+					        $this->bindings[ $this->ports[$this->currentPort]['binding'] ]['endpoint'] = $attrs['location'];
+					        break;
+					} 
+					break;
+			} 
+		// set status
+		switch ($name) {
+			case 'import':
+			    if (isset($attrs['location'])) {
+                    $this->import[$attrs['namespace']][] = array('location' => $attrs['location'], 'loaded' => false);
+                    $this->debug('parsing import ' . $attrs['namespace']. ' - ' . $attrs['location'] . ' (' . count($this->import[$attrs['namespace']]).')');
+				} else {
+                    $this->import[$attrs['namespace']][] = array('location' => '', 'loaded' => true);
+					if (! $this->getPrefixFromNamespace($attrs['namespace'])) {
+						$this->namespaces['ns'.(count($this->namespaces)+1)] = $attrs['namespace'];
+					}
+                    $this->debug('parsing import ' . $attrs['namespace']. ' - [no location] (' . count($this->import[$attrs['namespace']]).')');
+				}
+				break;
+			//wait for schema
+			//case 'types':
+			//	$this->status = 'schema';
+			//	break;
+			case 'message':
+				$this->status = 'message';
+				$this->messages[$attrs['name']] = array();
+				$this->currentMessage = $attrs['name'];
+				break;
+			case 'portType':
+				$this->status = 'portType';
+				$this->portTypes[$attrs['name']] = array();
+				$this->currentPortType = $attrs['name'];
+				break;
+			case "binding":
+				if (isset($attrs['name'])) {
+				// get binding name
+					if (strpos($attrs['name'], ':')) {
+			    		$this->currentBinding = $this->getLocalPart($attrs['name']);
+					} else {
+			    		$this->currentBinding = $attrs['name'];
+					} 
+					$this->status = 'binding';
+					$this->bindings[$this->currentBinding]['portType'] = $this->getLocalPart($attrs['type']);
+					$this->debug("current binding: $this->currentBinding of portType: " . $attrs['type']);
+				} 
+				break;
+			case 'service':
+				$this->serviceName = $attrs['name'];
+				$this->status = 'service';
+				$this->debug('current service: ' . $this->serviceName);
+				break;
+			case 'definitions':
+				foreach ($attrs as $name => $value) {
+					$this->wsdl_info[$name] = $value;
+				} 
+				break;
+			} 
+		} 
+	} 
+
+	/**
+	* end-element handler
+	* 
+	* @param string $parser XML parser object
+	* @param string $name element name
+	* @access private 
+	*/
+	function end_element($parser, $name){ 
+		// unset schema status
+		if (/*ereg('types$', $name) ||*/ ereg('schema$', $name)) {
+			$this->status = "";
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+			$this->schemas[$this->currentSchema->schemaTargetNamespace][] = $this->currentSchema;
+        	$this->debug('Parsing WSDL schema done');
+		} 
+		if ($this->status == 'schema') {
+			$this->currentSchema->schemaEndElement($parser, $name);
+		} else {
+			// bring depth down a notch
+			$this->depth--;
+		} 
+		// end documentation
+		if ($this->documentation) {
+			//TODO: track the node to which documentation should be assigned; it can be a part, message, etc.
+			//$this->portTypes[$this->currentPortType][$this->currentPortOperation]['documentation'] = $this->documentation;
+			$this->documentation = false;
+		} 
+	} 
+
+	/**
+	 * element content handler
+	 * 
+	 * @param string $parser XML parser object
+	 * @param string $data element content
+	 * @access private 
+	 */
+	function character_data($parser, $data)
+	{
+		$pos = isset($this->depth_array[$this->depth]) ? $this->depth_array[$this->depth] : 0;
+		if (isset($this->message[$pos]['cdata'])) {
+			$this->message[$pos]['cdata'] .= $data;
+		} 
+		if ($this->documentation) {
+			$this->documentation .= $data;
+		} 
+	} 
+	
+	function getBindingData($binding)
+	{
+		if (is_array($this->bindings[$binding])) {
+			return $this->bindings[$binding];
+		} 
+	}
+	
+	/**
+	 * returns an assoc array of operation names => operation data
+	 * 
+	 * @param string $bindingType eg: soap, smtp, dime (only soap is currently supported)
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperations($bindingType = 'soap')
+	{
+		$ops = array();
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				//$this->debug("getOperations for port $port");
+				//$this->debug("port data: " . $this->varDump($portData));
+				//$this->debug("bindings: " . $this->varDump($this->bindings[ $portData['binding'] ]));
+				// merge bindings
+				if (isset($this->bindings[ $portData['binding'] ]['operations'])) {
+					$ops = array_merge ($ops, $this->bindings[ $portData['binding'] ]['operations']);
+				}
+			}
+		} 
+		return $ops;
+	} 
+	
+	/**
+	 * returns an associative array of data necessary for calling an operation
+	 * 
+	 * @param string $operation , name of operation
+	 * @param string $bindingType , type of binding eg: soap
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperationData($operation, $bindingType = 'soap')
+	{
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				// get binding
+				//foreach($this->bindings[ $portData['binding'] ]['operations'] as $bOperation => $opData) {
+				foreach(array_keys($this->bindings[ $portData['binding'] ]['operations']) as $bOperation) {
+					// note that we could/should also check the namespace here
+					if ($operation == $bOperation) {
+						$opData = $this->bindings[ $portData['binding'] ]['operations'][$operation];
+					    return $opData;
+					} 
+				} 
+			}
+		} 
+	}
+	
+	/**
+	 * returns an associative array of data necessary for calling an operation
+	 * 
+	 * @param string $soapAction soapAction for operation
+	 * @param string $bindingType type of binding eg: soap
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperationDataForSoapAction($soapAction, $bindingType = 'soap') {
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				// loop through operations for the binding
+				foreach ($this->bindings[ $portData['binding'] ]['operations'] as $bOperation => $opData) {
+					if ($opData['soapAction'] == $soapAction) {
+					    return $opData;
+					} 
+				} 
+			}
+		} 
+	}
+	
+	/**
+    * returns an array of information about a given type
+    * returns false if no type exists by the given name
+    *
+	*	 typeDef = array(
+	*	 'elements' => array(), // refs to elements array
+	*	'restrictionBase' => '',
+	*	'phpType' => '',
+	*	'order' => '(sequence|all)',
+	*	'attrs' => array() // refs to attributes array
+	*	)
+    *
+    * @param $type string the type
+    * @param $ns string namespace (not prefix) of the type
+    * @return mixed
+    * @access public
+    * @see xmlschema
+    */
+	function getTypeDef($type, $ns) {
+		$this->debug("in getTypeDef: type=$type, ns=$ns");
+		if ((! $ns) && isset($this->namespaces['tns'])) {
+			$ns = $this->namespaces['tns'];
+			$this->debug("in getTypeDef: type namespace forced to $ns");
+		}
+		if (isset($this->schemas[$ns])) {
+			$this->debug("in getTypeDef: have schema for namespace $ns");
+			for ($i = 0; $i < count($this->schemas[$ns]); $i++) {
+				$xs = &$this->schemas[$ns][$i];
+				$t = $xs->getTypeDef($type);
+				$this->appendDebug($xs->getDebug());
+				$xs->clearDebug();
+				if ($t) {
+					if (!isset($t['phpType'])) {
+						// get info for type to tack onto the element
+						$uqType = substr($t['type'], strrpos($t['type'], ':') + 1);
+						$ns = substr($t['type'], 0, strrpos($t['type'], ':'));
+						$etype = $this->getTypeDef($uqType, $ns);
+						if ($etype) {
+							$this->debug("found type for [element] $type:");
+							$this->debug($this->varDump($etype));
+							if (isset($etype['phpType'])) {
+								$t['phpType'] = $etype['phpType'];
+							}
+							if (isset($etype['elements'])) {
+								$t['elements'] = $etype['elements'];
+							}
+							if (isset($etype['attrs'])) {
+								$t['attrs'] = $etype['attrs'];
+							}
+						}
+					}
+					return $t;
+				}
+			}
+		} else {
+			$this->debug("in getTypeDef: do not have schema for namespace $ns");
+		}
+		return false;
+	}
+
+    /**
+    * prints html description of services
+    *
+    * @access private
+    */
+    function webDescription(){
+    	global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$PHP_SELF = $_SERVER['PHP_SELF'];
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$PHP_SELF = $HTTP_SERVER_VARS['PHP_SELF'];
+		} else {
+			$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+		}
+
+		$b = '
+		<html><head><title>NuSOAP: '.$this->serviceName.'</title>
+		<style type="text/css">
+		    body    { font-family: arial; color: #000000; background-color: #ffffff; margin: 0px 0px 0px 0px; }
+		    p       { font-family: arial; color: #000000; margin-top: 0px; margin-bottom: 12px; }
+		    pre { background-color: silver; padding: 5px; font-family: Courier New; font-size: x-small; color: #000000;}
+		    ul      { margin-top: 10px; margin-left: 20px; }
+		    li      { list-style-type: none; margin-top: 10px; color: #000000; }
+		    .content{
+			margin-left: 0px; padding-bottom: 2em; }
+		    .nav {
+			padding-top: 10px; padding-bottom: 10px; padding-left: 15px; font-size: .70em;
+			margin-top: 10px; margin-left: 0px; color: #000000;
+			background-color: #ccccff; width: 20%; margin-left: 20px; margin-top: 20px; }
+		    .title {
+			font-family: arial; font-size: 26px; color: #ffffff;
+			background-color: #999999; width: 105%; margin-left: 0px;
+			padding-top: 10px; padding-bottom: 10px; padding-left: 15px;}
+		    .hidden {
+			position: absolute; visibility: hidden; z-index: 200; left: 250px; top: 100px;
+			font-family: arial; overflow: hidden; width: 600;
+			padding: 20px; font-size: 10px; background-color: #999999;
+			layer-background-color:#FFFFFF; }
+		    a,a:active  { color: charcoal; font-weight: bold; }
+		    a:visited   { color: #666666; font-weight: bold; }
+		    a:hover     { color: cc3300; font-weight: bold; }
+		</style>
+		<script language="JavaScript" type="text/javascript">
+		<!--
+		// POP-UP CAPTIONS...
+		function lib_bwcheck(){ //Browsercheck (needed)
+		    this.ver=navigator.appVersion
+		    this.agent=navigator.userAgent
+		    this.dom=document.getElementById?1:0
+		    this.opera5=this.agent.indexOf("Opera 5")>-1
+		    this.ie5=(this.ver.indexOf("MSIE 5")>-1 && this.dom && !this.opera5)?1:0;
+		    this.ie6=(this.ver.indexOf("MSIE 6")>-1 && this.dom && !this.opera5)?1:0;
+		    this.ie4=(document.all && !this.dom && !this.opera5)?1:0;
+		    this.ie=this.ie4||this.ie5||this.ie6
+		    this.mac=this.agent.indexOf("Mac")>-1
+		    this.ns6=(this.dom && parseInt(this.ver) >= 5) ?1:0;
+		    this.ns4=(document.layers && !this.dom)?1:0;
+		    this.bw=(this.ie6 || this.ie5 || this.ie4 || this.ns4 || this.ns6 || this.opera5)
+		    return this
+		}
+		var bw = new lib_bwcheck()
+		//Makes crossbrowser object.
+		function makeObj(obj){
+		    this.evnt=bw.dom? document.getElementById(obj):bw.ie4?document.all[obj]:bw.ns4?document.layers[obj]:0;
+		    if(!this.evnt) return false
+		    this.css=bw.dom||bw.ie4?this.evnt.style:bw.ns4?this.evnt:0;
+		    this.wref=bw.dom||bw.ie4?this.evnt:bw.ns4?this.css.document:0;
+		    this.writeIt=b_writeIt;
+		    return this
+		}
+		// A unit of measure that will be added when setting the position of a layer.
+		//var px = bw.ns4||window.opera?"":"px";
+		function b_writeIt(text){
+		    if (bw.ns4){this.wref.write(text);this.wref.close()}
+		    else this.wref.innerHTML = text
+		}
+		//Shows the messages
+		var oDesc;
+		function popup(divid){
+		    if(oDesc = new makeObj(divid)){
+			oDesc.css.visibility = "visible"
+		    }
+		}
+		function popout(){ // Hides message
+		    if(oDesc) oDesc.css.visibility = "hidden"
+		}
+		//-->
+		</script>
+		</head>
+		<body>
+		<div class=content>
+			<br><br>
+			<div class=title>'.$this->serviceName.'</div>
+			<div class=nav>
+				<p>View the <a href="'.$PHP_SELF.'?wsdl">WSDL</a> for the service.
+				Click on an operation name to view it&apos;s details.</p>
+				<ul>';
+				foreach($this->getOperations() as $op => $data){
+				    $b .= "<li><a href='#' onclick=\"popout();popup('$op')\">$op</a></li>";
+				    // create hidden div
+				    $b .= "<div id='$op' class='hidden'>
+				    <a href='#' onclick='popout()'><font color='#ffffff'>Close</font></a><br><br>";
+				    foreach($data as $donnie => $marie){ // loop through opdata
+						if($donnie == 'input' || $donnie == 'output'){ // show input/output data
+						    $b .= "<font color='white'>".ucfirst($donnie).':</font><br>';
+						    foreach($marie as $captain => $tenille){ // loop through data
+								if($captain == 'parts'){ // loop thru parts
+								    $b .= "&nbsp;&nbsp;$captain:<br>";
+					                //if(is_array($tenille)){
+								    	foreach($tenille as $joanie => $chachi){
+											$b .= "&nbsp;&nbsp;&nbsp;&nbsp;$joanie: $chachi<br>";
+								    	}
+					        		//}
+								} else {
+								    $b .= "&nbsp;&nbsp;$captain: $tenille<br>";
+								}
+						    }
+						} else {
+						    $b .= "<font color='white'>".ucfirst($donnie).":</font> $marie<br>";
+						}
+				    }
+					$b .= '</div>';
+				}
+				$b .= '
+				<ul>
+			</div>
+		</div></body></html>';
+		return $b;
+    }
+
+	/**
+	* serialize the parsed wsdl
+	*
+	* @param mixed $debug whether to put debug=1 in endpoint URL
+	* @return string serialization of WSDL
+	* @access public 
+	*/
+	function serialize($debug = 0)
+	{
+		$xml = '<?xml version="1.0" encoding="ISO-8859-1"?>';
+		$xml .= "\n<definitions";
+		foreach($this->namespaces as $k => $v) {
+			$xml .= " xmlns:$k=\"$v\"";
+		} 
+		// 10.9.02 - add poulter fix for wsdl and tns declarations
+		if (isset($this->namespaces['wsdl'])) {
+			$xml .= " xmlns=\"" . $this->namespaces['wsdl'] . "\"";
+		} 
+		if (isset($this->namespaces['tns'])) {
+			$xml .= " targetNamespace=\"" . $this->namespaces['tns'] . "\"";
+		} 
+		$xml .= '>'; 
+		// imports
+		if (sizeof($this->import) > 0) {
+			foreach($this->import as $ns => $list) {
+				foreach ($list as $ii) {
+					if ($ii['location'] != '') {
+						$xml .= '<import location="' . $ii['location'] . '" namespace="' . $ns . '" />';
+					} else {
+						$xml .= '<import namespace="' . $ns . '" />';
+					}
+				}
+			} 
+		} 
+		// types
+		if (count($this->schemas)>=1) {
+			$xml .= "\n<types>";
+			foreach ($this->schemas as $ns => $list) {
+				foreach ($list as $xs) {
+					$xml .= $xs->serializeSchema();
+				}
+			}
+			$xml .= '</types>';
+		} 
+		// messages
+		if (count($this->messages) >= 1) {
+			foreach($this->messages as $msgName => $msgParts) {
+				$xml .= "\n<message name=\"" . $msgName . '">';
+				if(is_array($msgParts)){
+					foreach($msgParts as $partName => $partType) {
+						// print 'serializing '.$partType.', sv: '.$this->XMLSchemaVersion.'<br>';
+						if (strpos($partType, ':')) {
+						    $typePrefix = $this->getPrefixFromNamespace($this->getPrefix($partType));
+						} elseif (isset($this->typemap[$this->namespaces['xsd']][$partType])) {
+						    // print 'checking typemap: '.$this->XMLSchemaVersion.'<br>';
+						    $typePrefix = 'xsd';
+						} else {
+						    foreach($this->typemap as $ns => $types) {
+						        if (isset($types[$partType])) {
+						            $typePrefix = $this->getPrefixFromNamespace($ns);
+						        } 
+						    } 
+						    if (!isset($typePrefix)) {
+						        die("$partType has no namespace!");
+						    } 
+						}
+						$ns = $this->getNamespaceFromPrefix($typePrefix);
+						$typeDef = $this->getTypeDef($this->getLocalPart($partType), $ns);
+						if ($typeDef['typeClass'] == 'element') {
+							$elementortype = 'element';
+						} else {
+							$elementortype = 'type';
+						}
+						$xml .= '<part name="' . $partName . '" ' . $elementortype . '="' . $typePrefix . ':' . $this->getLocalPart($partType) . '" />';
+					}
+				}
+				$xml .= '</message>';
+			} 
+		} 
+		// bindings & porttypes
+		if (count($this->bindings) >= 1) {
+			$binding_xml = '';
+			$portType_xml = '';
+			foreach($this->bindings as $bindingName => $attrs) {
+				$binding_xml .= "\n<binding name=\"" . $bindingName . '" type="tns:' . $attrs['portType'] . '">';
+				$binding_xml .= '<soap:binding style="' . $attrs['style'] . '" transport="' . $attrs['transport'] . '"/>';
+				$portType_xml .= "\n<portType name=\"" . $attrs['portType'] . '">';
+				foreach($attrs['operations'] as $opName => $opParts) {
+					$binding_xml .= '<operation name="' . $opName . '">';
+					$binding_xml .= '<soap:operation soapAction="' . $opParts['soapAction'] . '" style="'. $opParts['style'] . '"/>';
+					if (isset($opParts['input']['encodingStyle']) && $opParts['input']['encodingStyle'] != '') {
+						$enc_style = ' encodingStyle="' . $opParts['input']['encodingStyle'] . '"';
+					} else {
+						$enc_style = '';
+					}
+					$binding_xml .= '<input><soap:body use="' . $opParts['input']['use'] . '" namespace="' . $opParts['input']['namespace'] . '"' . $enc_style . '/></input>';
+					if (isset($opParts['output']['encodingStyle']) && $opParts['output']['encodingStyle'] != '') {
+						$enc_style = ' encodingStyle="' . $opParts['output']['encodingStyle'] . '"';
+					} else {
+						$enc_style = '';
+					}
+					$binding_xml .= '<output><soap:body use="' . $opParts['output']['use'] . '" namespace="' . $opParts['output']['namespace'] . '"' . $enc_style . '/></output>';
+					$binding_xml .= '</operation>';
+					$portType_xml .= '<operation name="' . $opParts['name'] . '"';
+					if (isset($opParts['parameterOrder'])) {
+					    $portType_xml .= ' parameterOrder="' . $opParts['parameterOrder'] . '"';
+					} 
+					$portType_xml .= '>';
+					if(isset($opParts['documentation']) && $opParts['documentation'] != '') {
+						$portType_xml .= '<documentation>' . htmlspecialchars($opParts['documentation']) . '</documentation>';
+					}
+					$portType_xml .= '<input message="tns:' . $opParts['input']['message'] . '"/>';
+					$portType_xml .= '<output message="tns:' . $opParts['output']['message'] . '"/>';
+					$portType_xml .= '</operation>';
+				} 
+				$portType_xml .= '</portType>';
+				$binding_xml .= '</binding>';
+			} 
+			$xml .= $portType_xml . $binding_xml;
+		} 
+		// services
+		$xml .= "\n<service name=\"" . $this->serviceName . '">';
+		if (count($this->ports) >= 1) {
+			foreach($this->ports as $pName => $attrs) {
+				$xml .= '<port name="' . $pName . '" binding="tns:' . $attrs['binding'] . '">';
+				$xml .= '<soap:address location="' . $attrs['location'] . ($debug ? '?debug=1' : '') . '"/>';
+				$xml .= '</port>';
+			} 
+		} 
+		$xml .= '</service>';
+		return $xml . "\n</definitions>";
+	} 
+	
+	/**
+	 * serialize PHP values according to a WSDL message definition
+	 *
+	 * TODO
+	 * - multi-ref serialization
+	 * - validate PHP values against type definitions, return errors if invalid
+	 * 
+	 * @param string $operation operation name
+	 * @param string $direction (input|output)
+	 * @param mixed $parameters parameter value(s)
+	 * @return mixed parameters serialized as XML or false on error (e.g. operation not found)
+	 * @access public
+	 */
+	function serializeRPCParameters($operation, $direction, $parameters)
+	{
+		$this->debug("in serializeRPCParameters: operation=$operation, direction=$direction, XMLSchemaVersion=$this->XMLSchemaVersion"); 
+		$this->appendDebug('parameters=' . $this->varDump($parameters));
+		
+		if ($direction != 'input' && $direction != 'output') {
+			$this->debug('The value of the \$direction argument needs to be either "input" or "output"');
+			$this->setError('The value of the \$direction argument needs to be either "input" or "output"');
+			return false;
+		} 
+		if (!$opData = $this->getOperationData($operation)) {
+			$this->debug('Unable to retrieve WSDL data for operation: ' . $operation);
+			$this->setError('Unable to retrieve WSDL data for operation: ' . $operation);
+			return false;
+		}
+		$this->debug('opData:');
+		$this->appendDebug($this->varDump($opData));
+
+		// Get encoding style for output and set to current
+		$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		if(($direction == 'input') && isset($opData['output']['encodingStyle']) && ($opData['output']['encodingStyle'] != $encodingStyle)) {
+			$encodingStyle = $opData['output']['encodingStyle'];
+			$enc_style = $encodingStyle;
+		}
+
+		// set input params
+		$xml = '';
+		if (isset($opData[$direction]['parts']) && sizeof($opData[$direction]['parts']) > 0) {
+			
+			$use = $opData[$direction]['use'];
+			$this->debug('have ' . count($opData[$direction]['parts']) . ' part(s) to serialize');
+			if (is_array($parameters)) {
+				$parametersArrayType = $this->isArraySimpleOrStruct($parameters);
+				$this->debug('have ' . count($parameters) . ' parameter(s) provided as ' . $parametersArrayType . ' to serialize');
+				foreach($opData[$direction]['parts'] as $name => $type) {
+					$this->debug('serializing part "'.$name.'" of type "'.$type.'"');
+					// Track encoding style
+					if (isset($opData[$direction]['encodingStyle']) && $encodingStyle != $opData[$direction]['encodingStyle']) {
+						$encodingStyle = $opData[$direction]['encodingStyle'];			
+						$enc_style = $encodingStyle;
+					} else {
+						$enc_style = false;
+					}
+					// NOTE: add error handling here
+					// if serializeType returns false, then catch global error and fault
+					if ($parametersArrayType == 'arraySimple') {
+						$p = array_shift($parameters);
+						$this->debug('calling serializeType w/indexed param');
+						$xml .= $this->serializeType($name, $type, $p, $use, $enc_style);
+					} elseif (isset($parameters[$name])) {
+						$this->debug('calling serializeType w/named param');
+						$xml .= $this->serializeType($name, $type, $parameters[$name], $use, $enc_style);
+					} else {
+						// TODO: only send nillable
+						$this->debug('calling serializeType w/null param');
+						$xml .= $this->serializeType($name, $type, null, $use, $enc_style);
+					}
+				}
+			} else {
+				$this->debug('no parameters passed.');
+			}
+		}
+		$this->debug("serializeRPCParameters returning: $xml");
+		return $xml;
+	} 
+	
+	/**
+	 * serialize a PHP value according to a WSDL message definition
+	 * 
+	 * TODO
+	 * - multi-ref serialization
+	 * - validate PHP values against type definitions, return errors if invalid
+	 * 
+	 * @param string $ type name
+	 * @param mixed $ param value
+	 * @return mixed new param or false if initial value didn't validate
+	 * @access public
+	 * @deprecated
+	 */
+	function serializeParameters($operation, $direction, $parameters)
+	{
+		$this->debug("in serializeParameters: operation=$operation, direction=$direction, XMLSchemaVersion=$this->XMLSchemaVersion"); 
+		$this->appendDebug('parameters=' . $this->varDump($parameters));
+		
+		if ($direction != 'input' && $direction != 'output') {
+			$this->debug('The value of the \$direction argument needs to be either "input" or "output"');
+			$this->setError('The value of the \$direction argument needs to be either "input" or "output"');
+			return false;
+		} 
+		if (!$opData = $this->getOperationData($operation)) {
+			$this->debug('Unable to retrieve WSDL data for operation: ' . $operation);
+			$this->setError('Unable to retrieve WSDL data for operation: ' . $operation);
+			return false;
+		}
+		$this->debug('opData:');
+		$this->appendDebug($this->varDump($opData));
+		
+		// Get encoding style for output and set to current
+		$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		if(($direction == 'input') && isset($opData['output']['encodingStyle']) && ($opData['output']['encodingStyle'] != $encodingStyle)) {
+			$encodingStyle = $opData['output']['encodingStyle'];
+			$enc_style = $encodingStyle;
+		}
+		
+		// set input params
+		$xml = '';
+		if (isset($opData[$direction]['parts']) && sizeof($opData[$direction]['parts']) > 0) {
+			
+			$use = $opData[$direction]['use'];
+			$this->debug("use=$use");
+			$this->debug('got ' . count($opData[$direction]['parts']) . ' part(s)');
+			if (is_array($parameters)) {
+				$parametersArrayType = $this->isArraySimpleOrStruct($parameters);
+				$this->debug('have ' . $parametersArrayType . ' parameters');
+				foreach($opData[$direction]['parts'] as $name => $type) {
+					$this->debug('serializing part "'.$name.'" of type "'.$type.'"');
+					// Track encoding style
+					if(isset($opData[$direction]['encodingStyle']) && $encodingStyle != $opData[$direction]['encodingStyle']) {
+						$encodingStyle = $opData[$direction]['encodingStyle'];			
+						$enc_style = $encodingStyle;
+					} else {
+						$enc_style = false;
+					}
+					// NOTE: add error handling here
+					// if serializeType returns false, then catch global error and fault
+					if ($parametersArrayType == 'arraySimple') {
+						$p = array_shift($parameters);
+						$this->debug('calling serializeType w/indexed param');
+						$xml .= $this->serializeType($name, $type, $p, $use, $enc_style);
+					} elseif (isset($parameters[$name])) {
+						$this->debug('calling serializeType w/named param');
+						$xml .= $this->serializeType($name, $type, $parameters[$name], $use, $enc_style);
+					} else {
+						// TODO: only send nillable
+						$this->debug('calling serializeType w/null param');
+						$xml .= $this->serializeType($name, $type, null, $use, $enc_style);
+					}
+				}
+			} else {
+				$this->debug('no parameters passed.');
+			}
+		}
+		$this->debug("serializeParameters returning: $xml");
+		return $xml;
+	} 
+	
+	/**
+	 * serializes a PHP value according a given type definition
+	 * 
+	 * @param string $name name of value (part or element)
+	 * @param string $type XML schema type of value (type or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $use use for part (encoded|literal)
+	 * @param string $encodingStyle SOAP encoding style for the value (if different than the enclosing style)
+	 * @param boolean $unqualified a kludge for what should be XML namespace form handling
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeType($name, $type, $value, $use='encoded', $encodingStyle=false, $unqualified=false)
+	{
+		$this->debug("in serializeType: name=$name, type=$type, use=$use, encodingStyle=$encodingStyle, unqualified=" . ($unqualified ? "unqualified" : "qualified"));
+		$this->appendDebug("value=" . $this->varDump($value));
+		if($use == 'encoded' && $encodingStyle) {
+			$encodingStyle = ' SOAP-ENV:encodingStyle="' . $encodingStyle . '"';
+		}
+
+		// if a soapval has been supplied, let its type override the WSDL
+    	if (is_object($value) && get_class($value) == 'soapval') {
+    		if ($value->type_ns) {
+    			$type = $value->type_ns . ':' . $value->type;
+		    	$forceType = true;
+		    	$this->debug("in serializeType: soapval overrides type to $type");
+    		} elseif ($value->type) {
+	    		$type = $value->type;
+		    	$forceType = true;
+		    	$this->debug("in serializeType: soapval overrides type to $type");
+	    	} else {
+	    		$forceType = false;
+		    	$this->debug("in serializeType: soapval does not override type");
+	    	}
+	    	$attrs = $value->attributes;
+	    	$value = $value->value;
+	    	$this->debug("in serializeType: soapval overrides value to $value");
+	    	if ($attrs) {
+	    		if (!is_array($value)) {
+	    			$value['!'] = $value;
+	    		}
+	    		foreach ($attrs as $n => $v) {
+	    			$value['!' . $n] = $v;
+	    		}
+		    	$this->debug("in serializeType: soapval provides attributes");
+		    }
+        } else {
+        	$forceType = false;
+        }
+
+		$xml = '';
+		if (strpos($type, ':')) {
+			$uqType = substr($type, strrpos($type, ':') + 1);
+			$ns = substr($type, 0, strrpos($type, ':'));
+			$this->debug("in serializeType: got a prefixed type: $uqType, $ns");
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+				$this->debug("in serializeType: expanded prefixed type: $uqType, $ns");
+			}
+
+			if($ns == $this->XMLSchemaVersion || $ns == 'http://schemas.xmlsoap.org/soap/encoding/'){
+				$this->debug('in serializeType: type namespace indicates XML Schema or SOAP Encoding type');
+				if ($unqualified  && $use == 'literal') {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+				if (is_null($value)) {
+					if ($use == 'literal') {
+						// TODO: depends on minOccurs
+						$xml = "<$name$elementNS/>";
+					} else {
+						// TODO: depends on nillable, which should be checked before calling this method
+						$xml = "<$name$elementNS xsi:nil=\"true\" xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"/>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+		    	if ($uqType == 'boolean') {
+		    		if ((is_string($value) && $value == 'false') || (! $value)) {
+						$value = 'false';
+					} else {
+						$value = 'true';
+					}
+				} 
+				if ($uqType == 'string' && gettype($value) == 'string') {
+					$value = $this->expandEntities($value);
+				}
+				if (($uqType == 'long' || $uqType == 'unsignedLong') && gettype($value) == 'double') {
+					$value = sprintf("%.0lf", $value);
+				}
+				// it's a scalar
+				// TODO: what about null/nil values?
+				// check type isn't a custom type extending xmlschema namespace
+				if (!$this->getTypeDef($uqType, $ns)) {
+					if ($use == 'literal') {
+						if ($forceType) {
+							$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">$value</$name>";
+						} else {
+							$xml = "<$name$elementNS>$value</$name>";
+						}
+					} else {
+						$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>$value</$name>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+				$this->debug('custom type extends XML Schema or SOAP Encoding namespace (yuck)');
+			} else if ($ns == 'http://xml.apache.org/xml-soap') {
+				$this->debug('in serializeType: appears to be Apache SOAP type');
+				if ($uqType == 'Map') {
+					$tt_prefix = $this->getPrefixFromNamespace('http://xml.apache.org/xml-soap');
+					if (! $tt_prefix) {
+						$this->debug('in serializeType: Add namespace for Apache SOAP type');
+						$tt_prefix = 'ns' . rand(1000, 9999);
+						$this->namespaces[$tt_prefix] = 'http://xml.apache.org/xml-soap';
+						// force this to be added to usedNamespaces
+						$tt_prefix = $this->getPrefixFromNamespace('http://xml.apache.org/xml-soap');
+					}
+					$contents = '';
+					foreach($value as $k => $v) {
+						$this->debug("serializing map element: key $k, value $v");
+						$contents .= '<item>';
+						$contents .= $this->serialize_val($k,'key',false,false,false,false,$use);
+						$contents .= $this->serialize_val($v,'value',false,false,false,false,$use);
+						$contents .= '</item>';
+					}
+					if ($use == 'literal') {
+						if ($forceType) {
+							$xml = "<$name xsi:type=\"" . $tt_prefix . ":$uqType\">$contents</$name>";
+						} else {
+							$xml = "<$name>$contents</$name>";
+						}
+					} else {
+						$xml = "<$name xsi:type=\"" . $tt_prefix . ":$uqType\"$encodingStyle>$contents</$name>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+				$this->debug('in serializeType: Apache SOAP type, but only support Map');
+			}
+		} else {
+			// TODO: should the type be compared to types in XSD, and the namespace
+			// set to XSD if the type matches?
+			$this->debug("in serializeType: No namespace for type $type");
+			$ns = '';
+			$uqType = $type;
+		}
+		if(!$typeDef = $this->getTypeDef($uqType, $ns)){
+			$this->setError("$type ($uqType) is not a supported type.");
+			$this->debug("in serializeType: $type ($uqType) is not a supported type.");
+			return false;
+		} else {
+			$this->debug("in serializeType: found typeDef");
+			$this->appendDebug('typeDef=' . $this->varDump($typeDef));
+		}
+		$phpType = $typeDef['phpType'];
+		$this->debug("in serializeType: uqType: $uqType, ns: $ns, phptype: $phpType, arrayType: " . (isset($typeDef['arrayType']) ? $typeDef['arrayType'] : '') ); 
+		// if php type == struct, map value to the <all> element names
+		if ($phpType == 'struct') {
+			if (isset($typeDef['typeClass']) && $typeDef['typeClass'] == 'element') {
+				$elementName = $uqType;
+				if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+					$elementNS = " xmlns=\"$ns\"";
+				} else {
+					$elementNS = " xmlns=\"\"";
+				}
+			} else {
+				$elementName = $name;
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if (is_null($value)) {
+				if ($use == 'literal') {
+					// TODO: depends on minOccurs
+					$xml = "<$elementName$elementNS/>";
+				} else {
+					$xml = "<$elementName$elementNS xsi:nil=\"true\" xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"/>";
+				}
+				$this->debug("in serializeType: returning: $xml");
+				return $xml;
+			}
+			if (is_object($value)) {
+				$value = get_object_vars($value);
+			}
+			if (is_array($value)) {
+				$elementAttrs = $this->serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType);
+				if ($use == 'literal') {
+					if ($forceType) {
+						$xml = "<$elementName$elementNS$elementAttrs xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">";
+					} else {
+						$xml = "<$elementName$elementNS$elementAttrs>";
+					}
+				} else {
+					$xml = "<$elementName$elementNS$elementAttrs xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>";
+				}
+	
+				$xml .= $this->serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use, $encodingStyle);
+				$xml .= "</$elementName>";
+			} else {
+				$this->debug("in serializeType: phpType is struct, but value is not an array");
+				$this->setError("phpType is struct, but value is not an array: see debug output for details");
+				$xml = '';
+			}
+		} elseif ($phpType == 'array') {
+			if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+				$elementNS = " xmlns=\"$ns\"";
+			} else {
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if (is_null($value)) {
+				if ($use == 'literal') {
+					// TODO: depends on minOccurs
+					$xml = "<$name$elementNS/>";
+				} else {
+					$xml = "<$name$elementNS xsi:nil=\"true\" xsi:type=\"" .
+						$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/') .
+						":Array\" " .
+						$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/') .
+						':arrayType="' .
+						$this->getPrefixFromNamespace($this->getPrefix($typeDef['arrayType'])) .
+						':' .
+						$this->getLocalPart($typeDef['arrayType'])."[0]\"/>";
+				}
+				$this->debug("in serializeType: returning: $xml");
+				return $xml;
+			}
+			if (isset($typeDef['multidimensional'])) {
+				$nv = array();
+				foreach($value as $v) {
+					$cols = ',' . sizeof($v);
+					$nv = array_merge($nv, $v);
+				} 
+				$value = $nv;
+			} else {
+				$cols = '';
+			} 
+			if (is_array($value) && sizeof($value) >= 1) {
+				$rows = sizeof($value);
+				$contents = '';
+				foreach($value as $k => $v) {
+					$this->debug("serializing array element: $k, $v of type: $typeDef[arrayType]");
+					//if (strpos($typeDef['arrayType'], ':') ) {
+					if (!in_array($typeDef['arrayType'],$this->typemap['http://www.w3.org/2001/XMLSchema'])) {
+					    $contents .= $this->serializeType('item', $typeDef['arrayType'], $v, $use);
+					} else {
+					    $contents .= $this->serialize_val($v, 'item', $typeDef['arrayType'], null, $this->XMLSchemaVersion, false, $use);
+					} 
+				}
+			} else {
+				$rows = 0;
+				$contents = null;
+			}
+			// TODO: for now, an empty value will be serialized as a zero element
+			// array.  Revisit this when coding the handling of null/nil values.
+			if ($use == 'literal') {
+				$xml = "<$name$elementNS>"
+					.$contents
+					."</$name>";
+			} else {
+				$xml = "<$name$elementNS xsi:type=\"".$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/').':Array" '.
+					$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/')
+					.':arrayType="'
+					.$this->getPrefixFromNamespace($this->getPrefix($typeDef['arrayType']))
+					.":".$this->getLocalPart($typeDef['arrayType'])."[$rows$cols]\">"
+					.$contents
+					."</$name>";
+			}
+		} elseif ($phpType == 'scalar') {
+			if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+				$elementNS = " xmlns=\"$ns\"";
+			} else {
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if ($use == 'literal') {
+				if ($forceType) {
+					$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">$value</$name>";
+				} else {
+					$xml = "<$name$elementNS>$value</$name>";
+				}
+			} else {
+				$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>$value</$name>";
+			}
+		}
+		$this->debug("in serializeType: returning: $xml");
+		return $xml;
+	}
+	
+	/**
+	 * serializes the attributes for a complexType
+	 *
+	 * @param array $typeDef our internal representation of an XML schema type (or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $ns the namespace of the type
+	 * @param string $uqType the local part of the type
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType) {
+		$xml = '';
+		if (isset($typeDef['attrs']) && is_array($typeDef['attrs'])) {
+			$this->debug("serialize attributes for XML Schema type $ns:$uqType");
+			if (is_array($value)) {
+				$xvalue = $value;
+			} elseif (is_object($value)) {
+				$xvalue = get_object_vars($value);
+			} else {
+				$this->debug("value is neither an array nor an object for XML Schema type $ns:$uqType");
+				$xvalue = array();
+			}
+			foreach ($typeDef['attrs'] as $aName => $attrs) {
+				if (isset($xvalue['!' . $aName])) {
+					$xname = '!' . $aName;
+					$this->debug("value provided for attribute $aName with key $xname");
+				} elseif (isset($xvalue[$aName])) {
+					$xname = $aName;
+					$this->debug("value provided for attribute $aName with key $xname");
+				} elseif (isset($attrs['default'])) {
+					$xname = '!' . $aName;
+					$xvalue[$xname] = $attrs['default'];
+					$this->debug('use default value of ' . $xvalue[$aName] . ' for attribute ' . $aName);
+				} else {
+					$xname = '';
+					$this->debug("no value provided for attribute $aName");
+				}
+				if ($xname) {
+					$xml .=  " $aName=\"" . $this->expandEntities($xvalue[$xname]) . "\"";
+				}
+			} 
+		} else {
+			$this->debug("no attributes to serialize for XML Schema type $ns:$uqType");
+		}
+		if (isset($typeDef['extensionBase'])) {
+			$ns = $this->getPrefix($typeDef['extensionBase']);
+			$uqType = $this->getLocalPart($typeDef['extensionBase']);
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+			}
+			if ($typeDef = $this->getTypeDef($uqType, $ns)) {
+				$this->debug("serialize attributes for extension base $ns:$uqType");
+				$xml .= $this->serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType);
+			} else {
+				$this->debug("extension base $ns:$uqType is not a supported type");
+			}
+		}
+		return $xml;
+	}
+
+	/**
+	 * serializes the elements for a complexType
+	 *
+	 * @param array $typeDef our internal representation of an XML schema type (or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $ns the namespace of the type
+	 * @param string $uqType the local part of the type
+	 * @param string $use use for part (encoded|literal)
+	 * @param string $encodingStyle SOAP encoding style for the value (if different than the enclosing style)
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use='encoded', $encodingStyle=false) {
+		$xml = '';
+		if (isset($typeDef['elements']) && is_array($typeDef['elements'])) {
+			$this->debug("in serializeComplexTypeElements, serialize elements for XML Schema type $ns:$uqType");
+			if (is_array($value)) {
+				$xvalue = $value;
+			} elseif (is_object($value)) {
+				$xvalue = get_object_vars($value);
+			} else {
+				$this->debug("value is neither an array nor an object for XML Schema type $ns:$uqType");
+				$xvalue = array();
+			}
+			// toggle whether all elements are present - ideally should validate against schema
+			if (count($typeDef['elements']) != count($xvalue)){
+				$optionals = true;
+			}
+			foreach ($typeDef['elements'] as $eName => $attrs) {
+				if (!isset($xvalue[$eName])) {
+					if (isset($attrs['default'])) {
+						$xvalue[$eName] = $attrs['default'];
+						$this->debug('use default value of ' . $xvalue[$eName] . ' for element ' . $eName);
+					}
+				}
+				// if user took advantage of a minOccurs=0, then only serialize named parameters
+				if (isset($optionals)
+				    && (!isset($xvalue[$eName])) 
+					&& ( (!isset($attrs['nillable'])) || $attrs['nillable'] != 'true')
+					){
+					if (isset($attrs['minOccurs']) && $attrs['minOccurs'] <> '0') {
+						$this->debug("apparent error: no value provided for element $eName with minOccurs=" . $attrs['minOccurs']);
+					}
+					// do nothing
+					$this->debug("no value provided for complexType element $eName and element is not nillable, so serialize nothing");
+				} else {
+					// get value
+					if (isset($xvalue[$eName])) {
+					    $v = $xvalue[$eName];
+					} else {
+					    $v = null;
+					}
+					if (isset($attrs['form'])) {
+						$unqualified = ($attrs['form'] == 'unqualified');
+					} else {
+						$unqualified = false;
+					}
+					if (isset($attrs['maxOccurs']) && ($attrs['maxOccurs'] == 'unbounded' || $attrs['maxOccurs'] > 1) && isset($v) && is_array($v) && $this->isArraySimpleOrStruct($v) == 'arraySimple') {
+						$vv = $v;
+						foreach ($vv as $k => $v) {
+							if (isset($attrs['type']) || isset($attrs['ref'])) {
+								// serialize schema-defined type
+							    $xml .= $this->serializeType($eName, isset($attrs['type']) ? $attrs['type'] : $attrs['ref'], $v, $use, $encodingStyle, $unqualified);
+							} else {
+								// serialize generic type (can this ever really happen?)
+							    $this->debug("calling serialize_val() for $v, $eName, false, false, false, false, $use");
+							    $xml .= $this->serialize_val($v, $eName, false, false, false, false, $use);
+							}
+						}
+					} else {
+						if (isset($attrs['type']) || isset($attrs['ref'])) {
+							// serialize schema-defined type
+						    $xml .= $this->serializeType($eName, isset($attrs['type']) ? $attrs['type'] : $attrs['ref'], $v, $use, $encodingStyle, $unqualified);
+						} else {
+							// serialize generic type (can this ever really happen?)
+						    $this->debug("calling serialize_val() for $v, $eName, false, false, false, false, $use");
+						    $xml .= $this->serialize_val($v, $eName, false, false, false, false, $use);
+						}
+					}
+				}
+			} 
+		} else {
+			$this->debug("no elements to serialize for XML Schema type $ns:$uqType");
+		}
+		if (isset($typeDef['extensionBase'])) {
+			$ns = $this->getPrefix($typeDef['extensionBase']);
+			$uqType = $this->getLocalPart($typeDef['extensionBase']);
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+			}
+			if ($typeDef = $this->getTypeDef($uqType, $ns)) {
+				$this->debug("serialize elements for extension base $ns:$uqType");
+				$xml .= $this->serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use, $encodingStyle);
+			} else {
+				$this->debug("extension base $ns:$uqType is not a supported type");
+			}
+		}
+		return $xml;
+	}
+
+	/**
+	* adds an XML Schema complex type to the WSDL types
+	*
+	* @param string	name
+	* @param string typeClass (complexType|simpleType|attribute)
+	* @param string phpType: currently supported are array and struct (php assoc array)
+	* @param string compositor (all|sequence|choice)
+	* @param string restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param array elements = array ( name => array(name=>'',type=>'') )
+	* @param array attrs = 	array(array('ref'=>'SOAP-ENC:arrayType','wsdl:arrayType'=>'xsd:string[]'))
+	* @param string arrayType: namespace:name (xsd:string)
+	* @see xmlschema
+	* @access public
+	*/
+	function addComplexType($name,$typeClass='complexType',$phpType='array',$compositor='',$restrictionBase='',$elements=array(),$attrs=array(),$arrayType='') {
+		if (count($elements) > 0) {
+	    	foreach($elements as $n => $e){
+	            // expand each element
+	            foreach ($e as $k => $v) {
+		            $k = strpos($k,':') ? $this->expandQname($k) : $k;
+		            $v = strpos($v,':') ? $this->expandQname($v) : $v;
+		            $ee[$k] = $v;
+		    	}
+	    		$eElements[$n] = $ee;
+	    	}
+	    	$elements = $eElements;
+		}
+		
+		if (count($attrs) > 0) {
+	    	foreach($attrs as $n => $a){
+	            // expand each attribute
+	            foreach ($a as $k => $v) {
+		            $k = strpos($k,':') ? $this->expandQname($k) : $k;
+		            $v = strpos($v,':') ? $this->expandQname($v) : $v;
+		            $aa[$k] = $v;
+		    	}
+	    		$eAttrs[$n] = $aa;
+	    	}
+	    	$attrs = $eAttrs;
+		}
+
+		$restrictionBase = strpos($restrictionBase,':') ? $this->expandQname($restrictionBase) : $restrictionBase;
+		$arrayType = strpos($arrayType,':') ? $this->expandQname($arrayType) : $arrayType;
+
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addComplexType($name,$typeClass,$phpType,$compositor,$restrictionBase,$elements,$attrs,$arrayType);
+	}
+
+	/**
+	* adds an XML Schema simple type to the WSDL types
+	*
+	* @param string $name
+	* @param string $restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param string $typeClass (should always be simpleType)
+	* @param string $phpType (should always be scalar)
+	* @param array $enumeration array of values
+	* @see xmlschema
+	* @access public
+	*/
+	function addSimpleType($name, $restrictionBase='', $typeClass='simpleType', $phpType='scalar', $enumeration=array()) {
+		$restrictionBase = strpos($restrictionBase,':') ? $this->expandQname($restrictionBase) : $restrictionBase;
+
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addSimpleType($name, $restrictionBase, $typeClass, $phpType, $enumeration);
+	}
+
+	/**
+	* adds an element to the WSDL types
+	*
+	* @param array $attrs attributes that must include name and type
+	* @see xmlschema
+	* @access public
+	*/
+	function addElement($attrs) {
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addElement($attrs);
+	}
+
+	/**
+	* register an operation with the server
+	* 
+	* @param string $name operation (method) name
+	* @param array $in assoc array of input values: key = param name, value = param type
+	* @param array $out assoc array of output values: key = param name, value = param type
+	* @param string $namespace optional The namespace for the operation
+	* @param string $soapaction optional The soapaction for the operation
+	* @param string $style (rpc|document) optional The style for the operation Note: when 'document' is specified, parameter and return wrappers are created for you automatically
+	* @param string $use (encoded|literal) optional The use for the parameters (cannot mix right now)
+	* @param string $documentation optional The description to include in the WSDL
+	* @param string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+	* @access public 
+	*/
+	function addOperation($name, $in = false, $out = false, $namespace = false, $soapaction = false, $style = 'rpc', $use = 'encoded', $documentation = '', $encodingStyle = ''){
+		if ($use == 'encoded' && $encodingStyle == '') {
+			$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		}
+
+		if ($style == 'document') {
+			$elements = array();
+			foreach ($in as $n => $t) {
+				$elements[$n] = array('name' => $n, 'type' => $t);
+			}
+			$this->addComplexType($name . 'RequestType', 'complexType', 'struct', 'all', '', $elements);
+			$this->addElement(array('name' => $name, 'type' => $name . 'RequestType'));
+			$in = array('parameters' => 'tns:' . $name);
+
+			$elements = array();
+			foreach ($out as $n => $t) {
+				$elements[$n] = array('name' => $n, 'type' => $t);
+			}
+			$this->addComplexType($name . 'ResponseType', 'complexType', 'struct', 'all', '', $elements);
+			$this->addElement(array('name' => $name . 'Response', 'type' => $name . 'ResponseType'));
+			$out = array('parameters' => 'tns:' . $name . 'Response');
+		}
+
+		// get binding
+		$this->bindings[ $this->serviceName . 'Binding' ]['operations'][$name] =
+		array(
+		'name' => $name,
+		'binding' => $this->serviceName . 'Binding',
+		'endpoint' => $this->endpoint,
+		'soapAction' => $soapaction,
+		'style' => $style,
+		'input' => array(
+			'use' => $use,
+			'namespace' => $namespace,
+			'encodingStyle' => $encodingStyle,
+			'message' => $name . 'Request',
+			'parts' => $in),
+		'output' => array(
+			'use' => $use,
+			'namespace' => $namespace,
+			'encodingStyle' => $encodingStyle,
+			'message' => $name . 'Response',
+			'parts' => $out),
+		'namespace' => $namespace,
+		'transport' => 'http://schemas.xmlsoap.org/soap/http',
+		'documentation' => $documentation); 
+		// add portTypes
+		// add messages
+		if($in)
+		{
+			foreach($in as $pName => $pType)
+			{
+				if(strpos($pType,':')) {
+					$pType = $this->getNamespaceFromPrefix($this->getPrefix($pType)).":".$this->getLocalPart($pType);
+				}
+				$this->messages[$name.'Request'][$pName] = $pType;
+			}
+		} else {
+            $this->messages[$name.'Request']= '0';
+        }
+		if($out)
+		{
+			foreach($out as $pName => $pType)
+			{
+				if(strpos($pType,':')) {
+					$pType = $this->getNamespaceFromPrefix($this->getPrefix($pType)).":".$this->getLocalPart($pType);
+				}
+				$this->messages[$name.'Response'][$pName] = $pType;
+			}
+		} else {
+            $this->messages[$name.'Response']= '0';
+        }
+		return true;
+	} 
+}
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/class.wsdlcache.php
===================================================================
--- cms/trunk/includes/nusoap/class.wsdlcache.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.wsdlcache.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,184 @@
+<?php
+
+
+
+/**
+* caches instances of the wsdl class
+* 
+* @author   Scott Nichol <snichol at computer.org>
+* @author	Ingo Fischer <ingo at apollon.de>
+* @version  $Id: class.wsdlcache.php,v 1.5 2005/05/20 17:58:17 snichol Exp $
+* @access public 
+*/
+class wsdlcache {
+	/**
+	 *	@var resource
+	 *	@access private
+	 */
+	var $fplock;
+	/**
+	 *	@var integer
+	 *	@access private
+	 */
+	var $cache_lifetime;
+	/**
+	 *	@var string
+	 *	@access private
+	 */
+	var $cache_dir;
+	/**
+	 *	@var string
+	 *	@access public
+	 */
+	var $debug_str = '';
+
+	/**
+	* constructor
+	*
+	* @param string $cache_dir directory for cache-files
+	* @param integer $cache_lifetime lifetime for caching-files in seconds or 0 for unlimited
+	* @access public
+	*/
+	function wsdlcache($cache_dir='.', $cache_lifetime=0) {
+		$this->fplock = array();
+		$this->cache_dir = $cache_dir != '' ? $cache_dir : '.';
+		$this->cache_lifetime = $cache_lifetime;
+	}
+
+	/**
+	* creates the filename used to cache a wsdl instance
+	*
+	* @param string $wsdl The URL of the wsdl instance
+	* @return string The filename used to cache the instance
+	* @access private
+	*/
+	function createFilename($wsdl) {
+		return $this->cache_dir.'/wsdlcache-' . md5($wsdl);
+	}
+
+	/**
+	* adds debug data to the class level debug string
+	*
+	* @param    string $string debug data
+	* @access   private
+	*/
+	function debug($string){
+		$this->debug_str .= get_class($this).": $string\n";
+	}
+
+	/**
+	* gets a wsdl instance from the cache
+	*
+	* @param string $wsdl The URL of the wsdl instance
+	* @return object wsdl The cached wsdl instance, null if the instance is not in the cache
+	* @access public
+	*/
+	function get($wsdl) {
+		$filename = $this->createFilename($wsdl);
+		if ($this->obtainMutex($filename, "r")) {
+			// check for expired WSDL that must be removed from the cache
+ 			if ($this->cache_lifetime > 0) {
+				if (file_exists($filename) && (time() - filemtime($filename) > $this->cache_lifetime)) {
+					unlink($filename);
+					$this->debug("Expired $wsdl ($filename) from cache");
+					$this->releaseMutex($filename);
+					return null;
+  				}
+			}
+			// see what there is to return
+			$fp = @fopen($filename, "r");
+			if ($fp) {
+				$s = implode("", @file($filename));
+				fclose($fp);
+				$this->debug("Got $wsdl ($filename) from cache");
+			} else {
+				$s = null;
+				$this->debug("$wsdl ($filename) not in cache");
+			}
+			$this->releaseMutex($filename);
+			return (!is_null($s)) ? unserialize($s) : null;
+		} else {
+			$this->debug("Unable to obtain mutex for $filename in get");
+		}
+		return null;
+	}
+
+	/**
+	* obtains the local mutex
+	*
+	* @param string $filename The Filename of the Cache to lock
+	* @param string $mode The open-mode ("r" or "w") or the file - affects lock-mode
+	* @return boolean Lock successfully obtained ?!
+	* @access private
+	*/
+	function obtainMutex($filename, $mode) {
+		if (isset($this->fplock[md5($filename)])) {
+			$this->debug("Lock for $filename already exists");
+			return false;
+		}
+		$this->fplock[md5($filename)] = fopen($filename.".lock", "w");
+		if ($mode == "r") {
+			return flock($this->fplock[md5($filename)], LOCK_SH);
+		} else {
+			return flock($this->fplock[md5($filename)], LOCK_EX);
+		}
+	}
+
+	/**
+	* adds a wsdl instance to the cache
+	*
+	* @param object wsdl $wsdl_instance The wsdl instance to add
+	* @return boolean WSDL successfully cached
+	* @access public
+	*/
+	function put($wsdl_instance) {
+		$filename = $this->createFilename($wsdl_instance->wsdl);
+		$s = serialize($wsdl_instance);
+		if ($this->obtainMutex($filename, "w")) {
+			$fp = fopen($filename, "w");
+			fputs($fp, $s);
+			fclose($fp);
+			$this->debug("Put $wsdl_instance->wsdl ($filename) in cache");
+			$this->releaseMutex($filename);
+			return true;
+		} else {
+			$this->debug("Unable to obtain mutex for $filename in put");
+		}
+		return false;
+	}
+
+	/**
+	* releases the local mutex
+	*
+	* @param string $filename The Filename of the Cache to lock
+	* @return boolean Lock successfully released
+	* @access private
+	*/
+	function releaseMutex($filename) {
+		$ret = flock($this->fplock[md5($filename)], LOCK_UN);
+		fclose($this->fplock[md5($filename)]);
+		unset($this->fplock[md5($filename)]);
+		if (! $ret) {
+			$this->debug("Not able to release lock for $filename");
+		}
+		return $ret;
+	}
+
+	/**
+	* removes a wsdl instance from the cache
+	*
+	* @param string $wsdl The URL of the wsdl instance
+	* @return boolean Whether there was an instance to remove
+	* @access public
+	*/
+	function remove($wsdl) {
+		$filename = $this->createFilename($wsdl);
+		// ignore errors obtaining mutex
+		$this->obtainMutex($filename, "w");
+		$ret = unlink($filename);
+		$this->debug("Removed ($ret) $wsdl ($filename) from cache");
+		$this->releaseMutex($filename);
+		return $ret;
+	}
+}
+?>

Added: cms/trunk/includes/nusoap/class.xmlschema.php
===================================================================
--- cms/trunk/includes/nusoap/class.xmlschema.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/class.xmlschema.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,906 @@
+<?php
+
+
+
+
+/**
+* parses an XML Schema, allows access to it's data, other utility methods
+* no validation... yet.
+* very experimental and limited. As is discussed on XML-DEV, I'm one of the people
+* that just doesn't have time to read the spec(s) thoroughly, and just have a couple of trusty
+* tutorials I refer to :)
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: class.xmlschema.php,v 1.39 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class XMLSchema extends nusoap_base  {
+	
+	// files
+	var $schema = '';
+	var $xml = '';
+	// namespaces
+	var $enclosingNamespaces;
+	// schema info
+	var $schemaInfo = array();
+	var $schemaTargetNamespace = '';
+	// types, elements, attributes defined by the schema
+	var $attributes = array();
+	var $complexTypes = array();
+	var $complexTypeStack = array();
+	var $currentComplexType = null;
+	var $elements = array();
+	var $elementStack = array();
+	var $currentElement = null;
+	var $simpleTypes = array();
+	var $simpleTypeStack = array();
+	var $currentSimpleType = null;
+	// imports
+	var $imports = array();
+	// parser vars
+	var $parser;
+	var $position = 0;
+	var $depth = 0;
+	var $depth_array = array();
+	var $message = array();
+	var $defaultNamespace = array();
+    
+	/**
+	* constructor
+	*
+	* @param    string $schema schema document URI
+	* @param    string $xml xml document URI
+	* @param	string $namespaces namespaces defined in enclosing XML
+	* @access   public
+	*/
+	function XMLSchema($schema='',$xml='',$namespaces=array()){
+		parent::nusoap_base();
+		$this->debug('xmlschema class instantiated, inside constructor');
+		// files
+		$this->schema = $schema;
+		$this->xml = $xml;
+
+		// namespaces
+		$this->enclosingNamespaces = $namespaces;
+		$this->namespaces = array_merge($this->namespaces, $namespaces);
+
+		// parse schema file
+		if($schema != ''){
+			$this->debug('initial schema file: '.$schema);
+			$this->parseFile($schema, 'schema');
+		}
+
+		// parse xml file
+		if($xml != ''){
+			$this->debug('initial xml file: '.$xml);
+			$this->parseFile($xml, 'xml');
+		}
+
+	}
+
+    /**
+    * parse an XML file
+    *
+    * @param string $xml, path/URL to XML file
+    * @param string $type, (schema | xml)
+	* @return boolean
+    * @access public
+    */
+	function parseFile($xml,$type){
+		// parse xml file
+		if($xml != ""){
+			$xmlStr = @join("", at file($xml));
+			if($xmlStr == ""){
+				$msg = 'Error reading XML from '.$xml;
+				$this->setError($msg);
+				$this->debug($msg);
+			return false;
+			} else {
+				$this->debug("parsing $xml");
+				$this->parseString($xmlStr,$type);
+				$this->debug("done parsing $xml");
+			return true;
+			}
+		}
+		return false;
+	}
+
+	/**
+	* parse an XML string
+	*
+	* @param    string $xml path or URL
+    * @param string $type, (schema|xml)
+	* @access   private
+	*/
+	function parseString($xml,$type){
+		// parse xml string
+		if($xml != ""){
+
+	    	// Create an XML parser.
+	    	$this->parser = xml_parser_create();
+	    	// Set the options for parsing the XML data.
+	    	xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0);
+
+	    	// Set the object for the parser.
+	    	xml_set_object($this->parser, $this);
+
+	    	// Set the element handlers for the parser.
+			if($type == "schema"){
+		    	xml_set_element_handler($this->parser, 'schemaStartElement','schemaEndElement');
+		    	xml_set_character_data_handler($this->parser,'schemaCharacterData');
+			} elseif($type == "xml"){
+				xml_set_element_handler($this->parser, 'xmlStartElement','xmlEndElement');
+		    	xml_set_character_data_handler($this->parser,'xmlCharacterData');
+			}
+
+		    // Parse the XML file.
+		    if(!xml_parse($this->parser,$xml,true)){
+			// Display an error message.
+				$errstr = sprintf('XML error parsing XML schema on line %d: %s',
+				xml_get_current_line_number($this->parser),
+				xml_error_string(xml_get_error_code($this->parser))
+				);
+				$this->debug($errstr);
+				$this->debug("XML payload:\n" . $xml);
+				$this->setError($errstr);
+	    	}
+            
+			xml_parser_free($this->parser);
+		} else{
+			$this->debug('no xml passed to parseString()!!');
+			$this->setError('no xml passed to parseString()!!');
+		}
+	}
+
+	/**
+	* start-element handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $name element name
+	* @param    string $attrs associative array of attributes
+	* @access   private
+	*/
+	function schemaStartElement($parser, $name, $attrs) {
+		
+		// position in the total number of elements, starting from 0
+		$pos = $this->position++;
+		$depth = $this->depth++;
+		// set self as current value for this depth
+		$this->depth_array[$depth] = $pos;
+		$this->message[$pos] = array('cdata' => ''); 
+		if ($depth > 0) {
+			$this->defaultNamespace[$pos] = $this->defaultNamespace[$this->depth_array[$depth - 1]];
+		} else {
+			$this->defaultNamespace[$pos] = false;
+		}
+
+		// get element prefix
+		if($prefix = $this->getPrefix($name)){
+			// get unqualified name
+			$name = $this->getLocalPart($name);
+		} else {
+        	$prefix = '';
+        }
+		
+        // loop thru attributes, expanding, and registering namespace declarations
+        if(count($attrs) > 0){
+        	foreach($attrs as $k => $v){
+                // if ns declarations, add to class level array of valid namespaces
+				if(ereg("^xmlns",$k)){
+                	//$this->xdebug("$k: $v");
+                	//$this->xdebug('ns_prefix: '.$this->getPrefix($k));
+                	if($ns_prefix = substr(strrchr($k,':'),1)){
+                		//$this->xdebug("Add namespace[$ns_prefix] = $v");
+						$this->namespaces[$ns_prefix] = $v;
+					} else {
+						$this->defaultNamespace[$pos] = $v;
+						if (! $this->getPrefixFromNamespace($v)) {
+							$this->namespaces['ns'.(count($this->namespaces)+1)] = $v;
+						}
+					}
+					if($v == 'http://www.w3.org/2001/XMLSchema' || $v == 'http://www.w3.org/1999/XMLSchema' || $v == 'http://www.w3.org/2000/10/XMLSchema'){
+						$this->XMLSchemaVersion = $v;
+						$this->namespaces['xsi'] = $v.'-instance';
+					}
+				}
+        	}
+        	foreach($attrs as $k => $v){
+                // expand each attribute
+                $k = strpos($k,':') ? $this->expandQname($k) : $k;
+                $v = strpos($v,':') ? $this->expandQname($v) : $v;
+        		$eAttrs[$k] = $v;
+        	}
+        	$attrs = $eAttrs;
+        } else {
+        	$attrs = array();
+        }
+		// find status, register data
+		switch($name){
+			case 'all':			// (optional) compositor content for a complexType
+			case 'choice':
+			case 'group':
+			case 'sequence':
+				//$this->xdebug("compositor $name for currentComplexType: $this->currentComplexType and currentElement: $this->currentElement");
+				$this->complexTypes[$this->currentComplexType]['compositor'] = $name;
+				//if($name == 'all' || $name == 'sequence'){
+				//	$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+				//}
+			break;
+			case 'attribute':	// complexType attribute
+            	//$this->xdebug("parsing attribute $attrs[name] $attrs[ref] of value: ".$attrs['http://schemas.xmlsoap.org/wsdl/:arrayType']);
+            	$this->xdebug("parsing attribute:");
+            	$this->appendDebug($this->varDump($attrs));
+				if (!isset($attrs['form'])) {
+					$attrs['form'] = $this->schemaInfo['attributeFormDefault'];
+				}
+            	if (isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])) {
+					$v = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+					if (!strpos($v, ':')) {
+						// no namespace in arrayType attribute value...
+						if ($this->defaultNamespace[$pos]) {
+							// ...so use the default
+							$attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'] = $this->defaultNamespace[$pos] . ':' . $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+						}
+					}
+            	}
+                if(isset($attrs['name'])){
+					$this->attributes[$attrs['name']] = $attrs;
+					$aname = $attrs['name'];
+				} elseif(isset($attrs['ref']) && $attrs['ref'] == 'http://schemas.xmlsoap.org/soap/encoding/:arrayType'){
+					if (isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])) {
+	                	$aname = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+	                } else {
+	                	$aname = '';
+	                }
+				} elseif(isset($attrs['ref'])){
+					$aname = $attrs['ref'];
+                    $this->attributes[$attrs['ref']] = $attrs;
+				}
+                
+				if($this->currentComplexType){	// This should *always* be
+					$this->complexTypes[$this->currentComplexType]['attrs'][$aname] = $attrs;
+				}
+				// arrayType attribute
+				if(isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType']) || $this->getLocalPart($aname) == 'arrayType'){
+					$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+                	$prefix = $this->getPrefix($aname);
+					if(isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])){
+						$v = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+					} else {
+						$v = '';
+					}
+                    if(strpos($v,'[,]')){
+                        $this->complexTypes[$this->currentComplexType]['multidimensional'] = true;
+                    }
+                    $v = substr($v,0,strpos($v,'[')); // clip the []
+                    if(!strpos($v,':') && isset($this->typemap[$this->XMLSchemaVersion][$v])){
+                        $v = $this->XMLSchemaVersion.':'.$v;
+                    }
+                    $this->complexTypes[$this->currentComplexType]['arrayType'] = $v;
+				}
+			break;
+			case 'complexContent':	// (optional) content for a complexType
+			break;
+			case 'complexType':
+				array_push($this->complexTypeStack, $this->currentComplexType);
+				if(isset($attrs['name'])){
+					$this->xdebug('processing named complexType '.$attrs['name']);
+					//$this->currentElement = false;
+					$this->currentComplexType = $attrs['name'];
+					$this->complexTypes[$this->currentComplexType] = $attrs;
+					$this->complexTypes[$this->currentComplexType]['typeClass'] = 'complexType';
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if(isset($attrs['base']) && ereg(':Array$',$attrs['base'])){
+						$this->xdebug('complexType is unusual array');
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					} else {
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+					}
+				}else{
+					$this->xdebug('processing unnamed complexType for element '.$this->currentElement);
+					$this->currentComplexType = $this->currentElement . '_ContainedType';
+					//$this->currentElement = false;
+					$this->complexTypes[$this->currentComplexType] = $attrs;
+					$this->complexTypes[$this->currentComplexType]['typeClass'] = 'complexType';
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if(isset($attrs['base']) && ereg(':Array$',$attrs['base'])){
+						$this->xdebug('complexType is unusual array');
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					} else {
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+					}
+				}
+			break;
+			case 'element':
+				array_push($this->elementStack, $this->currentElement);
+				// elements defined as part of a complex type should
+				// not really be added to $this->elements, but for some
+				// reason, they are
+				if (!isset($attrs['form'])) {
+					$attrs['form'] = $this->schemaInfo['elementFormDefault'];
+				}
+				if(isset($attrs['type'])){
+					$this->xdebug("processing typed element ".$attrs['name']." of type ".$attrs['type']);
+					if (! $this->getPrefix($attrs['type'])) {
+						if ($this->defaultNamespace[$pos]) {
+							$attrs['type'] = $this->defaultNamespace[$pos] . ':' . $attrs['type'];
+							$this->xdebug('used default namespace to make type ' . $attrs['type']);
+						}
+					}
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if ($this->currentComplexType && $this->complexTypes[$this->currentComplexType]['phpType'] == 'array') {
+						$this->xdebug('arrayType for unusual array is ' . $attrs['type']);
+						$this->complexTypes[$this->currentComplexType]['arrayType'] = $attrs['type'];
+					}
+					$this->currentElement = $attrs['name'];
+					$this->elements[ $attrs['name'] ] = $attrs;
+					$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+					$ename = $attrs['name'];
+				} elseif(isset($attrs['ref'])){
+					$this->xdebug("processing element as ref to ".$attrs['ref']);
+					$this->currentElement = "ref to ".$attrs['ref'];
+					$ename = $this->getLocalPart($attrs['ref']);
+				} else {
+					$this->xdebug("processing untyped element ".$attrs['name']);
+					$this->currentElement = $attrs['name'];
+					$this->elements[ $attrs['name'] ] = $attrs;
+					$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+					$attrs['type'] = $this->schemaTargetNamespace . ':' . $attrs['name'] . '_ContainedType';
+					$this->elements[ $attrs['name'] ]['type'] = $attrs['type'];
+					$ename = $attrs['name'];
+				}
+				if(isset($ename) && $this->currentComplexType){
+					$this->complexTypes[$this->currentComplexType]['elements'][$ename] = $attrs;
+				}
+			break;
+			case 'enumeration':	//	restriction value list member
+				$this->xdebug('enumeration ' . $attrs['value']);
+				if ($this->currentSimpleType) {
+					$this->simpleTypes[$this->currentSimpleType]['enumeration'][] = $attrs['value'];
+				} elseif ($this->currentComplexType) {
+					$this->complexTypes[$this->currentComplexType]['enumeration'][] = $attrs['value'];
+				}
+			break;
+			case 'extension':	// simpleContent or complexContent type extension
+				$this->xdebug('extension ' . $attrs['base']);
+				if ($this->currentComplexType) {
+					$this->complexTypes[$this->currentComplexType]['extensionBase'] = $attrs['base'];
+				}
+			break;
+			case 'import':
+			    if (isset($attrs['schemaLocation'])) {
+					//$this->xdebug('import namespace ' . $attrs['namespace'] . ' from ' . $attrs['schemaLocation']);
+                    $this->imports[$attrs['namespace']][] = array('location' => $attrs['schemaLocation'], 'loaded' => false);
+				} else {
+					//$this->xdebug('import namespace ' . $attrs['namespace']);
+                    $this->imports[$attrs['namespace']][] = array('location' => '', 'loaded' => true);
+					if (! $this->getPrefixFromNamespace($attrs['namespace'])) {
+						$this->namespaces['ns'.(count($this->namespaces)+1)] = $attrs['namespace'];
+					}
+				}
+			break;
+			case 'list':	// simpleType value list
+			break;
+			case 'restriction':	// simpleType, simpleContent or complexContent value restriction
+				$this->xdebug('restriction ' . $attrs['base']);
+				if($this->currentSimpleType){
+					$this->simpleTypes[$this->currentSimpleType]['type'] = $attrs['base'];
+				} elseif($this->currentComplexType){
+					$this->complexTypes[$this->currentComplexType]['restrictionBase'] = $attrs['base'];
+					if(strstr($attrs['base'],':') == ':Array'){
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					}
+				}
+			break;
+			case 'schema':
+				$this->schemaInfo = $attrs;
+				$this->schemaInfo['schemaVersion'] = $this->getNamespaceFromPrefix($prefix);
+				if (isset($attrs['targetNamespace'])) {
+					$this->schemaTargetNamespace = $attrs['targetNamespace'];
+				}
+				if (!isset($attrs['elementFormDefault'])) {
+					$this->schemaInfo['elementFormDefault'] = 'unqualified';
+				}
+				if (!isset($attrs['attributeFormDefault'])) {
+					$this->schemaInfo['attributeFormDefault'] = 'unqualified';
+				}
+			break;
+			case 'simpleContent':	// (optional) content for a complexType
+			break;
+			case 'simpleType':
+				array_push($this->simpleTypeStack, $this->currentSimpleType);
+				if(isset($attrs['name'])){
+					$this->xdebug("processing simpleType for name " . $attrs['name']);
+					$this->currentSimpleType = $attrs['name'];
+					$this->simpleTypes[ $attrs['name'] ] = $attrs;
+					$this->simpleTypes[ $attrs['name'] ]['typeClass'] = 'simpleType';
+					$this->simpleTypes[ $attrs['name'] ]['phpType'] = 'scalar';
+				} else {
+					$this->xdebug('processing unnamed simpleType for element '.$this->currentElement);
+					$this->currentSimpleType = $this->currentElement . '_ContainedType';
+					//$this->currentElement = false;
+					$this->simpleTypes[$this->currentSimpleType] = $attrs;
+					$this->simpleTypes[$this->currentSimpleType]['phpType'] = 'scalar';
+				}
+			break;
+			case 'union':	// simpleType type list
+			break;
+			default:
+				//$this->xdebug("do not have anything to do for element $name");
+		}
+	}
+
+	/**
+	* end-element handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $name element name
+	* @access   private
+	*/
+	function schemaEndElement($parser, $name) {
+		// bring depth down a notch
+		$this->depth--;
+		// position of current element is equal to the last value left in depth_array for my depth
+		if(isset($this->depth_array[$this->depth])){
+        	$pos = $this->depth_array[$this->depth];
+        }
+		// get element prefix
+		if ($prefix = $this->getPrefix($name)){
+			// get unqualified name
+			$name = $this->getLocalPart($name);
+		} else {
+        	$prefix = '';
+        }
+		// move on...
+		if($name == 'complexType'){
+			$this->xdebug('done processing complexType ' . ($this->currentComplexType ? $this->currentComplexType : '(unknown)'));
+			$this->currentComplexType = array_pop($this->complexTypeStack);
+			//$this->currentElement = false;
+		}
+		if($name == 'element'){
+			$this->xdebug('done processing element ' . ($this->currentElement ? $this->currentElement : '(unknown)'));
+			$this->currentElement = array_pop($this->elementStack);
+		}
+		if($name == 'simpleType'){
+			$this->xdebug('done processing simpleType ' . ($this->currentSimpleType ? $this->currentSimpleType : '(unknown)'));
+			$this->currentSimpleType = array_pop($this->simpleTypeStack);
+		}
+	}
+
+	/**
+	* element content handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $data element content
+	* @access   private
+	*/
+	function schemaCharacterData($parser, $data){
+		$pos = $this->depth_array[$this->depth - 1];
+		$this->message[$pos]['cdata'] .= $data;
+	}
+
+	/**
+	* serialize the schema
+	*
+	* @access   public
+	*/
+	function serializeSchema(){
+
+		$schemaPrefix = $this->getPrefixFromNamespace($this->XMLSchemaVersion);
+		$xml = '';
+		// imports
+		if (sizeof($this->imports) > 0) {
+			foreach($this->imports as $ns => $list) {
+				foreach ($list as $ii) {
+					if ($ii['location'] != '') {
+						$xml .= " <$schemaPrefix:import location=\"" . $ii['location'] . '" namespace="' . $ns . "\" />\n";
+					} else {
+						$xml .= " <$schemaPrefix:import namespace=\"" . $ns . "\" />\n";
+					}
+				}
+			} 
+		} 
+		// complex types
+		foreach($this->complexTypes as $typeName => $attrs){
+			$contentStr = '';
+			// serialize child elements
+			if(isset($attrs['elements']) && (count($attrs['elements']) > 0)){
+				foreach($attrs['elements'] as $element => $eParts){
+					if(isset($eParts['ref'])){
+						$contentStr .= "   <$schemaPrefix:element ref=\"$element\"/>\n";
+					} else {
+						$contentStr .= "   <$schemaPrefix:element name=\"$element\" type=\"" . $this->contractQName($eParts['type']) . "\"";
+						foreach ($eParts as $aName => $aValue) {
+							// handle, e.g., abstract, default, form, minOccurs, maxOccurs, nillable
+							if ($aName != 'name' && $aName != 'type') {
+								$contentStr .= " $aName=\"$aValue\"";
+							}
+						}
+						$contentStr .= "/>\n";
+					}
+				}
+				// compositor wraps elements
+				if (isset($attrs['compositor']) && ($attrs['compositor'] != '')) {
+					$contentStr = "  <$schemaPrefix:$attrs[compositor]>\n".$contentStr."  </$schemaPrefix:$attrs[compositor]>\n";
+				}
+			}
+			// attributes
+			if(isset($attrs['attrs']) && (count($attrs['attrs']) >= 1)){
+				foreach($attrs['attrs'] as $attr => $aParts){
+					$contentStr .= "    <$schemaPrefix:attribute";
+					foreach ($aParts as $a => $v) {
+						if ($a == 'ref' || $a == 'type') {
+							$contentStr .= " $a=\"".$this->contractQName($v).'"';
+						} elseif ($a == 'http://schemas.xmlsoap.org/wsdl/:arrayType') {
+							$this->usedNamespaces['wsdl'] = $this->namespaces['wsdl'];
+							$contentStr .= ' wsdl:arrayType="'.$this->contractQName($v).'"';
+						} else {
+							$contentStr .= " $a=\"$v\"";
+						}
+					}
+					$contentStr .= "/>\n";
+				}
+			}
+			// if restriction
+			if (isset($attrs['restrictionBase']) && $attrs['restrictionBase'] != ''){
+				$contentStr = "   <$schemaPrefix:restriction base=\"".$this->contractQName($attrs['restrictionBase'])."\">\n".$contentStr."   </$schemaPrefix:restriction>\n";
+				// complex or simple content
+				if ((isset($attrs['elements']) && count($attrs['elements']) > 0) || (isset($attrs['attrs']) && count($attrs['attrs']) > 0)){
+					$contentStr = "  <$schemaPrefix:complexContent>\n".$contentStr."  </$schemaPrefix:complexContent>\n";
+				}
+			}
+			// finalize complex type
+			if($contentStr != ''){
+				$contentStr = " <$schemaPrefix:complexType name=\"$typeName\">\n".$contentStr." </$schemaPrefix:complexType>\n";
+			} else {
+				$contentStr = " <$schemaPrefix:complexType name=\"$typeName\"/>\n";
+			}
+			$xml .= $contentStr;
+		}
+		// simple types
+		if(isset($this->simpleTypes) && count($this->simpleTypes) > 0){
+			foreach($this->simpleTypes as $typeName => $eParts){
+				$xml .= " <$schemaPrefix:simpleType name=\"$typeName\">\n  <$schemaPrefix:restriction base=\"".$this->contractQName($eParts['type'])."\"/>\n";
+				if (isset($eParts['enumeration'])) {
+					foreach ($eParts['enumeration'] as $e) {
+						$xml .= "  <$schemaPrefix:enumeration value=\"$e\"/>\n";
+					}
+				}
+				$xml .= " </$schemaPrefix:simpleType>";
+			}
+		}
+		// elements
+		if(isset($this->elements) && count($this->elements) > 0){
+			foreach($this->elements as $element => $eParts){
+				$xml .= " <$schemaPrefix:element name=\"$element\" type=\"".$this->contractQName($eParts['type'])."\"/>\n";
+			}
+		}
+		// attributes
+		if(isset($this->attributes) && count($this->attributes) > 0){
+			foreach($this->attributes as $attr => $aParts){
+				$xml .= " <$schemaPrefix:attribute name=\"$attr\" type=\"".$this->contractQName($aParts['type'])."\"\n/>";
+			}
+		}
+		// finish 'er up
+		$el = "<$schemaPrefix:schema targetNamespace=\"$this->schemaTargetNamespace\"\n";
+		foreach (array_diff($this->usedNamespaces, $this->enclosingNamespaces) as $nsp => $ns) {
+			$el .= " xmlns:$nsp=\"$ns\"\n";
+		}
+		$xml = $el . ">\n".$xml."</$schemaPrefix:schema>\n";
+		return $xml;
+	}
+
+	/**
+	* adds debug data to the clas level debug string
+	*
+	* @param    string $string debug data
+	* @access   private
+	*/
+	function xdebug($string){
+		$this->debug('<' . $this->schemaTargetNamespace . '> '.$string);
+	}
+
+    /**
+    * get the PHP type of a user defined type in the schema
+    * PHP type is kind of a misnomer since it actually returns 'struct' for assoc. arrays
+    * returns false if no type exists, or not w/ the given namespace
+    * else returns a string that is either a native php type, or 'struct'
+    *
+    * @param string $type, name of defined type
+    * @param string $ns, namespace of type
+    * @return mixed
+    * @access public
+    * @deprecated
+    */
+	function getPHPType($type,$ns){
+		if(isset($this->typemap[$ns][$type])){
+			//print "found type '$type' and ns $ns in typemap<br>";
+			return $this->typemap[$ns][$type];
+		} elseif(isset($this->complexTypes[$type])){
+			//print "getting type '$type' and ns $ns from complexTypes array<br>";
+			return $this->complexTypes[$type]['phpType'];
+		}
+		return false;
+	}
+
+	/**
+    * returns an associative array of information about a given type
+    * returns false if no type exists by the given name
+    *
+	*	For a complexType typeDef = array(
+	*	'restrictionBase' => '',
+	*	'phpType' => '',
+	*	'compositor' => '(sequence|all)',
+	*	'elements' => array(), // refs to elements array
+	*	'attrs' => array() // refs to attributes array
+	*	... and so on (see addComplexType)
+	*	)
+	*
+	*   For simpleType or element, the array has different keys.
+    *
+    * @param string
+    * @return mixed
+    * @access public
+    * @see addComplexType
+    * @see addSimpleType
+    * @see addElement
+    */
+	function getTypeDef($type){
+		//$this->debug("in getTypeDef for type $type");
+		if(isset($this->complexTypes[$type])){
+			$this->xdebug("in getTypeDef, found complexType $type");
+			return $this->complexTypes[$type];
+		} elseif(isset($this->simpleTypes[$type])){
+			$this->xdebug("in getTypeDef, found simpleType $type");
+			if (!isset($this->simpleTypes[$type]['phpType'])) {
+				// get info for type to tack onto the simple type
+				// TODO: can this ever really apply (i.e. what is a simpleType really?)
+				$uqType = substr($this->simpleTypes[$type]['type'], strrpos($this->simpleTypes[$type]['type'], ':') + 1);
+				$ns = substr($this->simpleTypes[$type]['type'], 0, strrpos($this->simpleTypes[$type]['type'], ':'));
+				$etype = $this->getTypeDef($uqType);
+				if ($etype) {
+					$this->xdebug("in getTypeDef, found type for simpleType $type:");
+					$this->xdebug($this->varDump($etype));
+					if (isset($etype['phpType'])) {
+						$this->simpleTypes[$type]['phpType'] = $etype['phpType'];
+					}
+					if (isset($etype['elements'])) {
+						$this->simpleTypes[$type]['elements'] = $etype['elements'];
+					}
+				}
+			}
+			return $this->simpleTypes[$type];
+		} elseif(isset($this->elements[$type])){
+			$this->xdebug("in getTypeDef, found element $type");
+			if (!isset($this->elements[$type]['phpType'])) {
+				// get info for type to tack onto the element
+				$uqType = substr($this->elements[$type]['type'], strrpos($this->elements[$type]['type'], ':') + 1);
+				$ns = substr($this->elements[$type]['type'], 0, strrpos($this->elements[$type]['type'], ':'));
+				$etype = $this->getTypeDef($uqType);
+				if ($etype) {
+					$this->xdebug("in getTypeDef, found type for element $type:");
+					$this->xdebug($this->varDump($etype));
+					if (isset($etype['phpType'])) {
+						$this->elements[$type]['phpType'] = $etype['phpType'];
+					}
+					if (isset($etype['elements'])) {
+						$this->elements[$type]['elements'] = $etype['elements'];
+					}
+				} elseif ($ns == 'http://www.w3.org/2001/XMLSchema') {
+					$this->xdebug("in getTypeDef, element $type is an XSD type");
+					$this->elements[$type]['phpType'] = 'scalar';
+				}
+			}
+			return $this->elements[$type];
+		} elseif(isset($this->attributes[$type])){
+			$this->xdebug("in getTypeDef, found attribute $type");
+			return $this->attributes[$type];
+		} elseif (ereg('_ContainedType$', $type)) {
+			$this->xdebug("in getTypeDef, have an untyped element $type");
+			$typeDef['typeClass'] = 'simpleType';
+			$typeDef['phpType'] = 'scalar';
+			$typeDef['type'] = 'http://www.w3.org/2001/XMLSchema:string';
+			return $typeDef;
+		}
+		$this->xdebug("in getTypeDef, did not find $type");
+		return false;
+	}
+
+	/**
+    * returns a sample serialization of a given type, or false if no type by the given name
+    *
+    * @param string $type, name of type
+    * @return mixed
+    * @access public
+    * @deprecated
+    */
+    function serializeTypeDef($type){
+    	//print "in sTD() for type $type<br>";
+	if($typeDef = $this->getTypeDef($type)){
+		$str .= '<'.$type;
+	    if(is_array($typeDef['attrs'])){
+		foreach($attrs as $attName => $data){
+		    $str .= " $attName=\"{type = ".$data['type']."}\"";
+		}
+	    }
+	    $str .= " xmlns=\"".$this->schema['targetNamespace']."\"";
+	    if(count($typeDef['elements']) > 0){
+		$str .= ">";
+		foreach($typeDef['elements'] as $element => $eData){
+		    $str .= $this->serializeTypeDef($element);
+		}
+		$str .= "</$type>";
+	    } elseif($typeDef['typeClass'] == 'element') {
+		$str .= "></$type>";
+	    } else {
+		$str .= "/>";
+	    }
+			return $str;
+	}
+    	return false;
+    }
+
+    /**
+    * returns HTML form elements that allow a user
+    * to enter values for creating an instance of the given type.
+    *
+    * @param string $name, name for type instance
+    * @param string $type, name of type
+    * @return string
+    * @access public
+    * @deprecated
+	*/
+	function typeToForm($name,$type){
+		// get typedef
+		if($typeDef = $this->getTypeDef($type)){
+			// if struct
+			if($typeDef['phpType'] == 'struct'){
+				$buffer .= '<table>';
+				foreach($typeDef['elements'] as $child => $childDef){
+					$buffer .= "
+					<tr><td align='right'>$childDef[name] (type: ".$this->getLocalPart($childDef['type'])."):</td>
+					<td><input type='text' name='parameters[".$name."][$childDef[name]]'></td></tr>";
+				}
+				$buffer .= '</table>';
+			// if array
+			} elseif($typeDef['phpType'] == 'array'){
+				$buffer .= '<table>';
+				for($i=0;$i < 3; $i++){
+					$buffer .= "
+					<tr><td align='right'>array item (type: $typeDef[arrayType]):</td>
+					<td><input type='text' name='parameters[".$name."][]'></td></tr>";
+				}
+				$buffer .= '</table>';
+			// if scalar
+			} else {
+				$buffer .= "<input type='text' name='parameters[$name]'>";
+			}
+		} else {
+			$buffer .= "<input type='text' name='parameters[$name]'>";
+		}
+		return $buffer;
+	}
+	
+	/**
+	* adds a complex type to the schema
+	* 
+	* example: array
+	* 
+	* addType(
+	* 	'ArrayOfstring',
+	* 	'complexType',
+	* 	'array',
+	* 	'',
+	* 	'SOAP-ENC:Array',
+	* 	array('ref'=>'SOAP-ENC:arrayType','wsdl:arrayType'=>'string[]'),
+	* 	'xsd:string'
+	* );
+	* 
+	* example: PHP associative array ( SOAP Struct )
+	* 
+	* addType(
+	* 	'SOAPStruct',
+	* 	'complexType',
+	* 	'struct',
+	* 	'all',
+	* 	array('myVar'=> array('name'=>'myVar','type'=>'string')
+	* );
+	* 
+	* @param name
+	* @param typeClass (complexType|simpleType|attribute)
+	* @param phpType: currently supported are array and struct (php assoc array)
+	* @param compositor (all|sequence|choice)
+	* @param restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param elements = array ( name = array(name=>'',type=>'') )
+	* @param attrs = array(
+	* 	array(
+	*		'ref' => "http://schemas.xmlsoap.org/soap/encoding/:arrayType",
+	*		"http://schemas.xmlsoap.org/wsdl/:arrayType" => "string[]"
+	* 	)
+	* )
+	* @param arrayType: namespace:name (http://www.w3.org/2001/XMLSchema:string)
+	* @access public
+	* @see getTypeDef
+	*/
+	function addComplexType($name,$typeClass='complexType',$phpType='array',$compositor='',$restrictionBase='',$elements=array(),$attrs=array(),$arrayType=''){
+		$this->complexTypes[$name] = array(
+	    'name'		=> $name,
+	    'typeClass'	=> $typeClass,
+	    'phpType'	=> $phpType,
+		'compositor'=> $compositor,
+	    'restrictionBase' => $restrictionBase,
+		'elements'	=> $elements,
+	    'attrs'		=> $attrs,
+	    'arrayType'	=> $arrayType
+		);
+		
+		$this->xdebug("addComplexType $name:");
+		$this->appendDebug($this->varDump($this->complexTypes[$name]));
+	}
+	
+	/**
+	* adds a simple type to the schema
+	*
+	* @param string $name
+	* @param string $restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param string $typeClass (should always be simpleType)
+	* @param string $phpType (should always be scalar)
+	* @param array $enumeration array of values
+	* @access public
+	* @see xmlschema
+	* @see getTypeDef
+	*/
+	function addSimpleType($name, $restrictionBase='', $typeClass='simpleType', $phpType='scalar', $enumeration=array()) {
+		$this->simpleTypes[$name] = array(
+	    'name'			=> $name,
+	    'typeClass'		=> $typeClass,
+	    'phpType'		=> $phpType,
+	    'type'			=> $restrictionBase,
+	    'enumeration'	=> $enumeration
+		);
+		
+		$this->xdebug("addSimpleType $name:");
+		$this->appendDebug($this->varDump($this->simpleTypes[$name]));
+	}
+
+	/**
+	* adds an element to the schema
+	*
+	* @param array $attrs attributes that must include name and type
+	* @see xmlschema
+	* @access public
+	*/
+	function addElement($attrs) {
+		if (! $this->getPrefix($attrs['type'])) {
+			$attrs['type'] = $this->schemaTargetNamespace . ':' . $attrs['type'];
+		}
+		$this->elements[ $attrs['name'] ] = $attrs;
+		$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+		
+		$this->xdebug("addElement " . $attrs['name']);
+		$this->appendDebug($this->varDump($this->elements[ $attrs['name'] ]));
+	}
+}
+
+
+
+
+?>
\ No newline at end of file

Added: cms/trunk/includes/nusoap/nusoap.php
===================================================================
--- cms/trunk/includes/nusoap/nusoap.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/nusoap.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,7241 @@
+<?php
+
+/*
+$Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+
+NuSOAP - Web Services Toolkit for PHP
+
+Copyright (c) 2002 NuSphere Corporation
+
+This library is free software; you can redistribute it and/or
+modify it under the terms of the GNU Lesser General Public
+License as published by the Free Software Foundation; either
+version 2.1 of the License, or (at your option) any later version.
+
+This library is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+Lesser General Public License for more details.
+
+You should have received a copy of the GNU Lesser General Public
+License along with this library; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+If you have any questions or comments, please email:
+
+Dietrich Ayala
+dietrich at ganx4.com
+http://dietrich.ganx4.com/nusoap
+
+NuSphere Corporation
+http://www.nusphere.com
+
+*/
+
+/* load classes
+
+// necessary classes
+require_once('class.soapclient.php');
+require_once('class.soap_val.php');
+require_once('class.soap_parser.php');
+require_once('class.soap_fault.php');
+
+// transport classes
+require_once('class.soap_transport_http.php');
+
+// optional add-on classes
+require_once('class.xmlschema.php');
+require_once('class.wsdl.php');
+
+// server class
+require_once('class.soap_server.php');*/
+
+// class variable emulation
+// cf. http://www.webkreator.com/php/techniques/php-static-class-variables.html
+$GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel = 9;
+
+/**
+*
+* nusoap_base
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class nusoap_base {
+	/**
+	 * Identification for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $title = 'NuSOAP';
+	/**
+	 * Version for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $version = '0.7.2';
+	/**
+	 * CVS revision for HTTP headers.
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $revision = '$Revision: 1.94 $';
+    /**
+     * Current error string (manipulated by getError/setError)
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $error_str = '';
+    /**
+     * Current debug string (manipulated by debug/appendDebug/clearDebug/getDebug/getDebugAsXMLComment)
+	 *
+	 * @var string
+	 * @access private
+	 */
+    var $debug_str = '';
+    /**
+	 * toggles automatic encoding of special characters as entities
+	 * (should always be true, I think)
+	 *
+	 * @var boolean
+	 * @access private
+	 */
+	var $charencoding = true;
+	/**
+	 * the debug level for this instance
+	 *
+	 * @var	integer
+	 * @access private
+	 */
+	var $debugLevel;
+
+    /**
+	* set schema version
+	*
+	* @var      string
+	* @access   public
+	*/
+	var $XMLSchemaVersion = 'http://www.w3.org/2001/XMLSchema';
+	
+    /**
+	* charset encoding for outgoing messages
+	*
+	* @var      string
+	* @access   public
+	*/
+    var $soap_defencoding = 'ISO-8859-1';
+	//var $soap_defencoding = 'UTF-8';
+
+	/**
+	* namespaces in an array of prefix => uri
+	*
+	* this is "seeded" by a set of constants, but it may be altered by code
+	*
+	* @var      array
+	* @access   public
+	*/
+	var $namespaces = array(
+		'SOAP-ENV' => 'http://schemas.xmlsoap.org/soap/envelope/',
+		'xsd' => 'http://www.w3.org/2001/XMLSchema',
+		'xsi' => 'http://www.w3.org/2001/XMLSchema-instance',
+		'SOAP-ENC' => 'http://schemas.xmlsoap.org/soap/encoding/'
+		);
+
+	/**
+	* namespaces used in the current context, e.g. during serialization
+	*
+	* @var      array
+	* @access   private
+	*/
+	var $usedNamespaces = array();
+
+	/**
+	* XML Schema types in an array of uri => (array of xml type => php type)
+	* is this legacy yet?
+	* no, this is used by the xmlschema class to verify type => namespace mappings.
+	* @var      array
+	* @access   public
+	*/
+	var $typemap = array(
+	'http://www.w3.org/2001/XMLSchema' => array(
+		'string'=>'string','boolean'=>'boolean','float'=>'double','double'=>'double','decimal'=>'double',
+		'duration'=>'','dateTime'=>'string','time'=>'string','date'=>'string','gYearMonth'=>'',
+		'gYear'=>'','gMonthDay'=>'','gDay'=>'','gMonth'=>'','hexBinary'=>'string','base64Binary'=>'string',
+		// abstract "any" types
+		'anyType'=>'string','anySimpleType'=>'string',
+		// derived datatypes
+		'normalizedString'=>'string','token'=>'string','language'=>'','NMTOKEN'=>'','NMTOKENS'=>'','Name'=>'','NCName'=>'','ID'=>'',
+		'IDREF'=>'','IDREFS'=>'','ENTITY'=>'','ENTITIES'=>'','integer'=>'integer','nonPositiveInteger'=>'integer',
+		'negativeInteger'=>'integer','long'=>'integer','int'=>'integer','short'=>'integer','byte'=>'integer','nonNegativeInteger'=>'integer',
+		'unsignedLong'=>'','unsignedInt'=>'','unsignedShort'=>'','unsignedByte'=>'','positiveInteger'=>''),
+	'http://www.w3.org/2000/10/XMLSchema' => array(
+		'i4'=>'','int'=>'integer','boolean'=>'boolean','string'=>'string','double'=>'double',
+		'float'=>'double','dateTime'=>'string',
+		'timeInstant'=>'string','base64Binary'=>'string','base64'=>'string','ur-type'=>'array'),
+	'http://www.w3.org/1999/XMLSchema' => array(
+		'i4'=>'','int'=>'integer','boolean'=>'boolean','string'=>'string','double'=>'double',
+		'float'=>'double','dateTime'=>'string',
+		'timeInstant'=>'string','base64Binary'=>'string','base64'=>'string','ur-type'=>'array'),
+	'http://soapinterop.org/xsd' => array('SOAPStruct'=>'struct'),
+	'http://schemas.xmlsoap.org/soap/encoding/' => array('base64'=>'string','array'=>'array','Array'=>'array'),
+    'http://xml.apache.org/xml-soap' => array('Map')
+	);
+
+	/**
+	* XML entities to convert
+	*
+	* @var      array
+	* @access   public
+	* @deprecated
+	* @see	expandEntities
+	*/
+	var $xmlEntities = array('quot' => '"','amp' => '&',
+		'lt' => '<','gt' => '>','apos' => "'");
+
+	/**
+	* constructor
+	*
+	* @access	public
+	*/
+	function nusoap_base() {
+		$this->debugLevel = $GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel;
+	}
+
+	/**
+	* gets the global debug level, which applies to future instances
+	*
+	* @return	integer	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function getGlobalDebugLevel() {
+		return $GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel;
+	}
+
+	/**
+	* sets the global debug level, which applies to future instances
+	*
+	* @param	int	$level	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function setGlobalDebugLevel($level) {
+		$GLOBALS['_transient']['static']['nusoap_base']->globalDebugLevel = $level;
+	}
+
+	/**
+	* gets the debug level for this instance
+	*
+	* @return	int	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function getDebugLevel() {
+		return $this->debugLevel;
+	}
+
+	/**
+	* sets the debug level for this instance
+	*
+	* @param	int	$level	Debug level 0-9, where 0 turns off
+	* @access	public
+	*/
+	function setDebugLevel($level) {
+		$this->debugLevel = $level;
+	}
+
+	/**
+	* adds debug data to the instance debug string with formatting
+	*
+	* @param    string $string debug data
+	* @access   private
+	*/
+	function debug($string){
+		if ($this->debugLevel > 0) {
+			$this->appendDebug($this->getmicrotime().' '.get_class($this).": $string\n");
+		}
+	}
+
+	/**
+	* adds debug data to the instance debug string without formatting
+	*
+	* @param    string $string debug data
+	* @access   public
+	*/
+	function appendDebug($string){
+		if ($this->debugLevel > 0) {
+			// it would be nice to use a memory stream here to use
+			// memory more efficiently
+			$this->debug_str .= $string;
+		}
+	}
+
+	/**
+	* clears the current debug data for this instance
+	*
+	* @access   public
+	*/
+	function clearDebug() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		$this->debug_str = '';
+	}
+
+	/**
+	* gets the current debug data for this instance
+	*
+	* @return   debug data
+	* @access   public
+	*/
+	function &getDebug() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		return $this->debug_str;
+	}
+
+	/**
+	* gets the current debug data for this instance as an XML comment
+	* this may change the contents of the debug data
+	*
+	* @return   debug data as an XML comment
+	* @access   public
+	*/
+	function &getDebugAsXMLComment() {
+		// it would be nice to use a memory stream here to use
+		// memory more efficiently
+		while (strpos($this->debug_str, '--')) {
+			$this->debug_str = str_replace('--', '- -', $this->debug_str);
+		}
+    	return "<!--\n" . $this->debug_str . "\n-->";
+	}
+
+	/**
+	* expands entities, e.g. changes '<' to '&lt;'.
+	*
+	* @param	string	$val	The string in which to expand entities.
+	* @access	private
+	*/
+	function expandEntities($val) {
+		if ($this->charencoding) {
+	    	$val = str_replace('&', '&amp;', $val);
+	    	$val = str_replace("'", '&apos;', $val);
+	    	$val = str_replace('"', '&quot;', $val);
+	    	$val = str_replace('<', '&lt;', $val);
+	    	$val = str_replace('>', '&gt;', $val);
+	    }
+	    return $val;
+	}
+
+	/**
+	* returns error string if present
+	*
+	* @return   mixed error string or false
+	* @access   public
+	*/
+	function getError(){
+		if($this->error_str != ''){
+			return $this->error_str;
+		}
+		return false;
+	}
+
+	/**
+	* sets error string
+	*
+	* @return   boolean $string error string
+	* @access   private
+	*/
+	function setError($str){
+		$this->error_str = $str;
+	}
+
+	/**
+	* detect if array is a simple array or a struct (associative array)
+	*
+	* @param	mixed	$val	The PHP array
+	* @return	string	(arraySimple|arrayStruct)
+	* @access	private
+	*/
+	function isArraySimpleOrStruct($val) {
+        $keyList = array_keys($val);
+		foreach ($keyList as $keyListValue) {
+			if (!is_int($keyListValue)) {
+				return 'arrayStruct';
+			}
+		}
+		return 'arraySimple';
+	}
+
+	/**
+	* serializes PHP values in accordance w/ section 5. Type information is
+	* not serialized if $use == 'literal'.
+	*
+	* @param	mixed	$val	The value to serialize
+	* @param	string	$name	The name (local part) of the XML element
+	* @param	string	$type	The XML schema type (local part) for the element
+	* @param	string	$name_ns	The namespace for the name of the XML element
+	* @param	string	$type_ns	The namespace for the type of the element
+	* @param	array	$attributes	The attributes to serialize as name=>value pairs
+	* @param	string	$use	The WSDL "use" (encoded|literal)
+	* @return	string	The serialized element, possibly with child elements
+    * @access	public
+	*/
+	function serialize_val($val,$name=false,$type=false,$name_ns=false,$type_ns=false,$attributes=false,$use='encoded'){
+		$this->debug("in serialize_val: name=$name, type=$type, name_ns=$name_ns, type_ns=$type_ns, use=$use");
+		$this->appendDebug('value=' . $this->varDump($val));
+		$this->appendDebug('attributes=' . $this->varDump($attributes));
+		
+    	if(is_object($val) && get_class($val) == 'soapval'){
+        	return $val->serialize($use);
+        }
+		// force valid name if necessary
+		if (is_numeric($name)) {
+			$name = '__numeric_' . $name;
+		} elseif (! $name) {
+			$name = 'noname';
+		}
+		// if name has ns, add ns prefix to name
+		$xmlns = '';
+        if($name_ns){
+			$prefix = 'nu'.rand(1000,9999);
+			$name = $prefix.':'.$name;
+			$xmlns .= " xmlns:$prefix=\"$name_ns\"";
+		}
+		// if type is prefixed, create type prefix
+		if($type_ns != '' && $type_ns == $this->namespaces['xsd']){
+			// need to fix this. shouldn't default to xsd if no ns specified
+		    // w/o checking against typemap
+			$type_prefix = 'xsd';
+		} elseif($type_ns){
+			$type_prefix = 'ns'.rand(1000,9999);
+			$xmlns .= " xmlns:$type_prefix=\"$type_ns\"";
+		}
+		// serialize attributes if present
+		$atts = '';
+		if($attributes){
+			foreach($attributes as $k => $v){
+				$atts .= " $k=\"".$this->expandEntities($v).'"';
+			}
+		}
+		// serialize null value
+		if (is_null($val)) {
+			if ($use == 'literal') {
+				// TODO: depends on minOccurs
+	        	return "<$name$xmlns $atts/>";
+        	} else {
+				if (isset($type) && isset($type_prefix)) {
+					$type_str = " xsi:type=\"$type_prefix:$type\"";
+				} else {
+					$type_str = '';
+				}
+	        	return "<$name$xmlns$type_str $atts xsi:nil=\"true\"/>";
+        	}
+		}
+        // serialize if an xsd built-in primitive type
+        if($type != '' && isset($this->typemap[$this->XMLSchemaVersion][$type])){
+        	if (is_bool($val)) {
+        		if ($type == 'boolean') {
+	        		$val = $val ? 'true' : 'false';
+	        	} elseif (! $val) {
+	        		$val = 0;
+	        	}
+			} else if (is_string($val)) {
+				$val = $this->expandEntities($val);
+			}
+			if ($use == 'literal') {
+	        	return "<$name$xmlns $atts>$val</$name>";
+        	} else {
+	        	return "<$name$xmlns $atts xsi:type=\"xsd:$type\">$val</$name>";
+        	}
+        }
+		// detect type and serialize
+		$xml = '';
+		switch(true) {
+			case (is_bool($val) || $type == 'boolean'):
+        		if ($type == 'boolean') {
+	        		$val = $val ? 'true' : 'false';
+	        	} elseif (! $val) {
+	        		$val = 0;
+	        	}
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:boolean\"$atts>$val</$name>";
+				}
+				break;
+			case (is_int($val) || is_long($val) || $type == 'int'):
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:int\"$atts>$val</$name>";
+				}
+				break;
+			case (is_float($val)|| is_double($val) || $type == 'float'):
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:float\"$atts>$val</$name>";
+				}
+				break;
+			case (is_string($val) || $type == 'string'):
+				$val = $this->expandEntities($val);
+				if ($use == 'literal') {
+					$xml .= "<$name$xmlns $atts>$val</$name>";
+				} else {
+					$xml .= "<$name$xmlns xsi:type=\"xsd:string\"$atts>$val</$name>";
+				}
+				break;
+			case is_object($val):
+				if (! $name) {
+					$name = get_class($val);
+					$this->debug("In serialize_val, used class name $name as element name");
+				} else {
+					$this->debug("In serialize_val, do not override name $name for element name for class " . get_class($val));
+				}
+				foreach(get_object_vars($val) as $k => $v){
+					$pXml = isset($pXml) ? $pXml.$this->serialize_val($v,$k,false,false,false,false,$use) : $this->serialize_val($v,$k,false,false,false,false,$use);
+				}
+				$xml .= '<'.$name.'>'.$pXml.'</'.$name.'>';
+				break;
+			break;
+			case (is_array($val) || $type):
+				// detect if struct or array
+				$valueType = $this->isArraySimpleOrStruct($val);
+                if($valueType=='arraySimple' || ereg('^ArrayOf',$type)){
+					$i = 0;
+					if(is_array($val) && count($val)> 0){
+						foreach($val as $v){
+	                    	if(is_object($v) && get_class($v) ==  'soapval'){
+								$tt_ns = $v->type_ns;
+								$tt = $v->type;
+							} elseif (is_array($v)) {
+								$tt = $this->isArraySimpleOrStruct($v);
+							} else {
+								$tt = gettype($v);
+	                        }
+							$array_types[$tt] = 1;
+							// TODO: for literal, the name should be $name
+							$xml .= $this->serialize_val($v,'item',false,false,false,false,$use);
+							++$i;
+						}
+						if(count($array_types) > 1){
+							$array_typename = 'xsd:anyType';
+						} elseif(isset($tt) && isset($this->typemap[$this->XMLSchemaVersion][$tt])) {
+							if ($tt == 'integer') {
+								$tt = 'int';
+							}
+							$array_typename = 'xsd:'.$tt;
+						} elseif(isset($tt) && $tt == 'arraySimple'){
+							$array_typename = 'SOAP-ENC:Array';
+						} elseif(isset($tt) && $tt == 'arrayStruct'){
+							$array_typename = 'unnamed_struct_use_soapval';
+						} else {
+							// if type is prefixed, create type prefix
+							if ($tt_ns != '' && $tt_ns == $this->namespaces['xsd']){
+								 $array_typename = 'xsd:' . $tt;
+							} elseif ($tt_ns) {
+								$tt_prefix = 'ns' . rand(1000, 9999);
+								$array_typename = "$tt_prefix:$tt";
+								$xmlns .= " xmlns:$tt_prefix=\"$tt_ns\"";
+							} else {
+								$array_typename = $tt;
+							}
+						}
+						$array_type = $i;
+						if ($use == 'literal') {
+							$type_str = '';
+						} else if (isset($type) && isset($type_prefix)) {
+							$type_str = " xsi:type=\"$type_prefix:$type\"";
+						} else {
+							$type_str = " xsi:type=\"SOAP-ENC:Array\" SOAP-ENC:arrayType=\"".$array_typename."[$array_type]\"";
+						}
+					// empty array
+					} else {
+						if ($use == 'literal') {
+							$type_str = '';
+						} else if (isset($type) && isset($type_prefix)) {
+							$type_str = " xsi:type=\"$type_prefix:$type\"";
+						} else {
+							$type_str = " xsi:type=\"SOAP-ENC:Array\" SOAP-ENC:arrayType=\"xsd:anyType[0]\"";
+						}
+					}
+					// TODO: for array in literal, there is no wrapper here
+					$xml = "<$name$xmlns$type_str$atts>".$xml."</$name>";
+				} else {
+					// got a struct
+					if(isset($type) && isset($type_prefix)){
+						$type_str = " xsi:type=\"$type_prefix:$type\"";
+					} else {
+						$type_str = '';
+					}
+					if ($use == 'literal') {
+						$xml .= "<$name$xmlns $atts>";
+					} else {
+						$xml .= "<$name$xmlns$type_str$atts>";
+					}
+					foreach($val as $k => $v){
+						// Apache Map
+						if ($type == 'Map' && $type_ns == 'http://xml.apache.org/xml-soap') {
+							$xml .= '<item>';
+							$xml .= $this->serialize_val($k,'key',false,false,false,false,$use);
+							$xml .= $this->serialize_val($v,'value',false,false,false,false,$use);
+							$xml .= '</item>';
+						} else {
+							$xml .= $this->serialize_val($v,$k,false,false,false,false,$use);
+						}
+					}
+					$xml .= "</$name>";
+				}
+				break;
+			default:
+				$xml .= 'not detected, got '.gettype($val).' for '.$val;
+				break;
+		}
+		return $xml;
+	}
+
+    /**
+    * serializes a message
+    *
+    * @param string $body the XML of the SOAP body
+    * @param mixed $headers optional string of XML with SOAP header content, or array of soapval objects for SOAP headers
+    * @param array $namespaces optional the namespaces used in generating the body and headers
+    * @param string $style optional (rpc|document)
+    * @param string $use optional (encoded|literal)
+    * @param string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+    * @return string the message
+    * @access public
+    */
+    function serializeEnvelope($body,$headers=false,$namespaces=array(),$style='rpc',$use='encoded',$encodingStyle='http://schemas.xmlsoap.org/soap/encoding/'){
+    // TODO: add an option to automatically run utf8_encode on $body and $headers
+    // if $this->soap_defencoding is UTF-8.  Not doing this automatically allows
+    // one to send arbitrary UTF-8 characters, not just characters that map to ISO-8859-1
+
+	$this->debug("In serializeEnvelope length=" . strlen($body) . " body (max 1000 characters)=" . substr($body, 0, 1000) . " style=$style use=$use encodingStyle=$encodingStyle");
+	$this->debug("headers:");
+	$this->appendDebug($this->varDump($headers));
+	$this->debug("namespaces:");
+	$this->appendDebug($this->varDump($namespaces));
+
+	// serialize namespaces
+    $ns_string = '';
+	foreach(array_merge($this->namespaces,$namespaces) as $k => $v){
+		$ns_string .= " xmlns:$k=\"$v\"";
+	}
+	if($encodingStyle) {
+		$ns_string = " SOAP-ENV:encodingStyle=\"$encodingStyle\"$ns_string";
+	}
+
+	// serialize headers
+	if($headers){
+		if (is_array($headers)) {
+			$xml = '';
+			foreach ($headers as $header) {
+				$xml .= $this->serialize_val($header, false, false, false, false, false, $use);
+			}
+			$headers = $xml;
+			$this->debug("In serializeEnvelope, serialzied array of headers to $headers");
+		}
+		$headers = "<SOAP-ENV:Header>".$headers."</SOAP-ENV:Header>";
+	}
+	// serialize envelope
+	return
+	'<?xml version="1.0" encoding="'.$this->soap_defencoding .'"?'.">".
+	'<SOAP-ENV:Envelope'.$ns_string.">".
+	$headers.
+	"<SOAP-ENV:Body>".
+		$body.
+	"</SOAP-ENV:Body>".
+	"</SOAP-ENV:Envelope>";
+    }
+
+	/**
+	 * formats a string to be inserted into an HTML stream
+	 *
+	 * @param string $str The string to format
+	 * @return string The formatted string
+	 * @access public
+	 * @deprecated
+	 */
+    function formatDump($str){
+		$str = htmlspecialchars($str);
+		return nl2br($str);
+    }
+
+	/**
+	* contracts (changes namespace to prefix) a qualified name
+	*
+	* @param    string $qname qname
+	* @return	string contracted qname
+	* @access   private
+	*/
+	function contractQname($qname){
+		// get element namespace
+		//$this->xdebug("Contract $qname");
+		if (strrpos($qname, ':')) {
+			// get unqualified name
+			$name = substr($qname, strrpos($qname, ':') + 1);
+			// get ns
+			$ns = substr($qname, 0, strrpos($qname, ':'));
+			$p = $this->getPrefixFromNamespace($ns);
+			if ($p) {
+				return $p . ':' . $name;
+			}
+			return $qname;
+		} else {
+			return $qname;
+		}
+	}
+
+	/**
+	* expands (changes prefix to namespace) a qualified name
+	*
+	* @param    string $string qname
+	* @return	string expanded qname
+	* @access   private
+	*/
+	function expandQname($qname){
+		// get element prefix
+		if(strpos($qname,':') && !ereg('^http://',$qname)){
+			// get unqualified name
+			$name = substr(strstr($qname,':'),1);
+			// get ns prefix
+			$prefix = substr($qname,0,strpos($qname,':'));
+			if(isset($this->namespaces[$prefix])){
+				return $this->namespaces[$prefix].':'.$name;
+			} else {
+				return $qname;
+			}
+		} else {
+			return $qname;
+		}
+	}
+
+    /**
+    * returns the local part of a prefixed string
+    * returns the original string, if not prefixed
+    *
+    * @param string $str The prefixed string
+    * @return string The local part
+    * @access public
+    */
+	function getLocalPart($str){
+		if($sstr = strrchr($str,':')){
+			// get unqualified name
+			return substr( $sstr, 1 );
+		} else {
+			return $str;
+		}
+	}
+
+	/**
+    * returns the prefix part of a prefixed string
+    * returns false, if not prefixed
+    *
+    * @param string $str The prefixed string
+    * @return mixed The prefix or false if there is no prefix
+    * @access public
+    */
+	function getPrefix($str){
+		if($pos = strrpos($str,':')){
+			// get prefix
+			return substr($str,0,$pos);
+		}
+		return false;
+	}
+
+	/**
+    * pass it a prefix, it returns a namespace
+    *
+    * @param string $prefix The prefix
+    * @return mixed The namespace, false if no namespace has the specified prefix
+    * @access public
+    */
+	function getNamespaceFromPrefix($prefix){
+		if (isset($this->namespaces[$prefix])) {
+			return $this->namespaces[$prefix];
+		}
+		//$this->setError("No namespace registered for prefix '$prefix'");
+		return false;
+	}
+
+	/**
+    * returns the prefix for a given namespace (or prefix)
+    * or false if no prefixes registered for the given namespace
+    *
+    * @param string $ns The namespace
+    * @return mixed The prefix, false if the namespace has no prefixes
+    * @access public
+    */
+	function getPrefixFromNamespace($ns) {
+		foreach ($this->namespaces as $p => $n) {
+			if ($ns == $n || $ns == $p) {
+			    $this->usedNamespaces[$p] = $n;
+				return $p;
+			}
+		}
+		return false;
+	}
+
+	/**
+    * returns the time in ODBC canonical form with microseconds
+    *
+    * @return string The time in ODBC canonical form with microseconds
+    * @access public
+    */
+	function getmicrotime() {
+		if (function_exists('gettimeofday')) {
+			$tod = gettimeofday();
+			$sec = $tod['sec'];
+			$usec = $tod['usec'];
+		} else {
+			$sec = time();
+			$usec = 0;
+		}
+		return strftime('%Y-%m-%d %H:%M:%S', $sec) . '.' . sprintf('%06d', $usec);
+	}
+
+	/**
+	 * Returns a string with the output of var_dump
+	 *
+	 * @param mixed $data The variable to var_dump
+	 * @return string The output of var_dump
+	 * @access public
+	 */
+    function varDump($data) {
+		ob_start();
+		var_dump($data);
+		$ret_val = ob_get_contents();
+		ob_end_clean();
+		return $ret_val;
+	}
+}
+
+// XML Schema Datatype Helper Functions
+
+//xsd:dateTime helpers
+
+/**
+* convert unix timestamp to ISO 8601 compliant date string
+*
+* @param    string $timestamp Unix time stamp
+* @access   public
+*/
+function timestamp_to_iso8601($timestamp,$utc=true){
+	$datestr = date('Y-m-d\TH:i:sO',$timestamp);
+	if($utc){
+		$eregStr =
+		'([0-9]{4})-'.	// centuries & years CCYY-
+		'([0-9]{2})-'.	// months MM-
+		'([0-9]{2})'.	// days DD
+		'T'.			// separator T
+		'([0-9]{2}):'.	// hours hh:
+		'([0-9]{2}):'.	// minutes mm:
+		'([0-9]{2})(\.[0-9]*)?'. // seconds ss.ss...
+		'(Z|[+\-][0-9]{2}:?[0-9]{2})?'; // Z to indicate UTC, -/+HH:MM:SS.SS... for local tz's
+
+		if(ereg($eregStr,$datestr,$regs)){
+			return sprintf('%04d-%02d-%02dT%02d:%02d:%02dZ',$regs[1],$regs[2],$regs[3],$regs[4],$regs[5],$regs[6]);
+		}
+		return false;
+	} else {
+		return $datestr;
+	}
+}
+
+/**
+* convert ISO 8601 compliant date string to unix timestamp
+*
+* @param    string $datestr ISO 8601 compliant date string
+* @access   public
+*/
+function iso8601_to_timestamp($datestr){
+	$eregStr =
+	'([0-9]{4})-'.	// centuries & years CCYY-
+	'([0-9]{2})-'.	// months MM-
+	'([0-9]{2})'.	// days DD
+	'T'.			// separator T
+	'([0-9]{2}):'.	// hours hh:
+	'([0-9]{2}):'.	// minutes mm:
+	'([0-9]{2})(\.[0-9]+)?'. // seconds ss.ss...
+	'(Z|[+\-][0-9]{2}:?[0-9]{2})?'; // Z to indicate UTC, -/+HH:MM:SS.SS... for local tz's
+	if(ereg($eregStr,$datestr,$regs)){
+		// not utc
+		if($regs[8] != 'Z'){
+			$op = substr($regs[8],0,1);
+			$h = substr($regs[8],1,2);
+			$m = substr($regs[8],strlen($regs[8])-2,2);
+			if($op == '-'){
+				$regs[4] = $regs[4] + $h;
+				$regs[5] = $regs[5] + $m;
+			} elseif($op == '+'){
+				$regs[4] = $regs[4] - $h;
+				$regs[5] = $regs[5] - $m;
+			}
+		}
+		return strtotime("$regs[1]-$regs[2]-$regs[3] $regs[4]:$regs[5]:$regs[6]Z");
+	} else {
+		return false;
+	}
+}
+
+/**
+* sleeps some number of microseconds
+*
+* @param    string $usec the number of microseconds to sleep
+* @access   public
+* @deprecated
+*/
+function usleepWindows($usec)
+{
+	$start = gettimeofday();
+	
+	do
+	{
+		$stop = gettimeofday();
+		$timePassed = 1000000 * ($stop['sec'] - $start['sec'])
+		+ $stop['usec'] - $start['usec'];
+	}
+	while ($timePassed < $usec);
+}
+
+?><?php
+
+
+
+/**
+* Contains information for a SOAP fault.
+* Mainly used for returning faults from deployed functions
+* in a server instance.
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access public
+*/
+class soap_fault extends nusoap_base {
+	/**
+	 * The fault code (client|server)
+	 * @var string
+	 * @access private
+	 */
+	var $faultcode;
+	/**
+	 * The fault actor
+	 * @var string
+	 * @access private
+	 */
+	var $faultactor;
+	/**
+	 * The fault string, a description of the fault
+	 * @var string
+	 * @access private
+	 */
+	var $faultstring;
+	/**
+	 * The fault detail, typically a string or array of string
+	 * @var mixed
+	 * @access private
+	 */
+	var $faultdetail;
+
+	/**
+	* constructor
+    *
+    * @param string $faultcode (client | server)
+    * @param string $faultactor only used when msg routed between multiple actors
+    * @param string $faultstring human readable error message
+    * @param mixed $faultdetail detail, typically a string or array of string
+	*/
+	function soap_fault($faultcode,$faultactor='',$faultstring='',$faultdetail=''){
+		parent::nusoap_base();
+		$this->faultcode = $faultcode;
+		$this->faultactor = $faultactor;
+		$this->faultstring = $faultstring;
+		$this->faultdetail = $faultdetail;
+	}
+
+	/**
+	* serialize a fault
+	*
+	* @return	string	The serialization of the fault instance.
+	* @access   public
+	*/
+	function serialize(){
+		$ns_string = '';
+		foreach($this->namespaces as $k => $v){
+			$ns_string .= "\n  xmlns:$k=\"$v\"";
+		}
+		$return_msg =
+			'<?xml version="1.0" encoding="'.$this->soap_defencoding.'"?>'.
+			'<SOAP-ENV:Envelope SOAP-ENV:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/"'.$ns_string.">\n".
+				'<SOAP-ENV:Body>'.
+				'<SOAP-ENV:Fault>'.
+					$this->serialize_val($this->faultcode, 'faultcode').
+					$this->serialize_val($this->faultactor, 'faultactor').
+					$this->serialize_val($this->faultstring, 'faultstring').
+					$this->serialize_val($this->faultdetail, 'detail').
+				'</SOAP-ENV:Fault>'.
+				'</SOAP-ENV:Body>'.
+			'</SOAP-ENV:Envelope>';
+		return $return_msg;
+	}
+}
+
+
+
+?><?php
+
+
+
+/**
+* parses an XML Schema, allows access to it's data, other utility methods
+* no validation... yet.
+* very experimental and limited. As is discussed on XML-DEV, I'm one of the people
+* that just doesn't have time to read the spec(s) thoroughly, and just have a couple of trusty
+* tutorials I refer to :)
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class XMLSchema extends nusoap_base  {
+	
+	// files
+	var $schema = '';
+	var $xml = '';
+	// namespaces
+	var $enclosingNamespaces;
+	// schema info
+	var $schemaInfo = array();
+	var $schemaTargetNamespace = '';
+	// types, elements, attributes defined by the schema
+	var $attributes = array();
+	var $complexTypes = array();
+	var $complexTypeStack = array();
+	var $currentComplexType = null;
+	var $elements = array();
+	var $elementStack = array();
+	var $currentElement = null;
+	var $simpleTypes = array();
+	var $simpleTypeStack = array();
+	var $currentSimpleType = null;
+	// imports
+	var $imports = array();
+	// parser vars
+	var $parser;
+	var $position = 0;
+	var $depth = 0;
+	var $depth_array = array();
+	var $message = array();
+	var $defaultNamespace = array();
+    
+	/**
+	* constructor
+	*
+	* @param    string $schema schema document URI
+	* @param    string $xml xml document URI
+	* @param	string $namespaces namespaces defined in enclosing XML
+	* @access   public
+	*/
+	function XMLSchema($schema='',$xml='',$namespaces=array()){
+		parent::nusoap_base();
+		$this->debug('xmlschema class instantiated, inside constructor');
+		// files
+		$this->schema = $schema;
+		$this->xml = $xml;
+
+		// namespaces
+		$this->enclosingNamespaces = $namespaces;
+		$this->namespaces = array_merge($this->namespaces, $namespaces);
+
+		// parse schema file
+		if($schema != ''){
+			$this->debug('initial schema file: '.$schema);
+			$this->parseFile($schema, 'schema');
+		}
+
+		// parse xml file
+		if($xml != ''){
+			$this->debug('initial xml file: '.$xml);
+			$this->parseFile($xml, 'xml');
+		}
+
+	}
+
+    /**
+    * parse an XML file
+    *
+    * @param string $xml, path/URL to XML file
+    * @param string $type, (schema | xml)
+	* @return boolean
+    * @access public
+    */
+	function parseFile($xml,$type){
+		// parse xml file
+		if($xml != ""){
+			$xmlStr = @join("", at file($xml));
+			if($xmlStr == ""){
+				$msg = 'Error reading XML from '.$xml;
+				$this->setError($msg);
+				$this->debug($msg);
+			return false;
+			} else {
+				$this->debug("parsing $xml");
+				$this->parseString($xmlStr,$type);
+				$this->debug("done parsing $xml");
+			return true;
+			}
+		}
+		return false;
+	}
+
+	/**
+	* parse an XML string
+	*
+	* @param    string $xml path or URL
+    * @param string $type, (schema|xml)
+	* @access   private
+	*/
+	function parseString($xml,$type){
+		// parse xml string
+		if($xml != ""){
+
+	    	// Create an XML parser.
+	    	$this->parser = xml_parser_create();
+	    	// Set the options for parsing the XML data.
+	    	xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0);
+
+	    	// Set the object for the parser.
+	    	xml_set_object($this->parser, $this);
+
+	    	// Set the element handlers for the parser.
+			if($type == "schema"){
+		    	xml_set_element_handler($this->parser, 'schemaStartElement','schemaEndElement');
+		    	xml_set_character_data_handler($this->parser,'schemaCharacterData');
+			} elseif($type == "xml"){
+				xml_set_element_handler($this->parser, 'xmlStartElement','xmlEndElement');
+		    	xml_set_character_data_handler($this->parser,'xmlCharacterData');
+			}
+
+		    // Parse the XML file.
+		    if(!xml_parse($this->parser,$xml,true)){
+			// Display an error message.
+				$errstr = sprintf('XML error parsing XML schema on line %d: %s',
+				xml_get_current_line_number($this->parser),
+				xml_error_string(xml_get_error_code($this->parser))
+				);
+				$this->debug($errstr);
+				$this->debug("XML payload:\n" . $xml);
+				$this->setError($errstr);
+	    	}
+            
+			xml_parser_free($this->parser);
+		} else{
+			$this->debug('no xml passed to parseString()!!');
+			$this->setError('no xml passed to parseString()!!');
+		}
+	}
+
+	/**
+	* start-element handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $name element name
+	* @param    string $attrs associative array of attributes
+	* @access   private
+	*/
+	function schemaStartElement($parser, $name, $attrs) {
+		
+		// position in the total number of elements, starting from 0
+		$pos = $this->position++;
+		$depth = $this->depth++;
+		// set self as current value for this depth
+		$this->depth_array[$depth] = $pos;
+		$this->message[$pos] = array('cdata' => ''); 
+		if ($depth > 0) {
+			$this->defaultNamespace[$pos] = $this->defaultNamespace[$this->depth_array[$depth - 1]];
+		} else {
+			$this->defaultNamespace[$pos] = false;
+		}
+
+		// get element prefix
+		if($prefix = $this->getPrefix($name)){
+			// get unqualified name
+			$name = $this->getLocalPart($name);
+		} else {
+        	$prefix = '';
+        }
+		
+        // loop thru attributes, expanding, and registering namespace declarations
+        if(count($attrs) > 0){
+        	foreach($attrs as $k => $v){
+                // if ns declarations, add to class level array of valid namespaces
+				if(ereg("^xmlns",$k)){
+                	//$this->xdebug("$k: $v");
+                	//$this->xdebug('ns_prefix: '.$this->getPrefix($k));
+                	if($ns_prefix = substr(strrchr($k,':'),1)){
+                		//$this->xdebug("Add namespace[$ns_prefix] = $v");
+						$this->namespaces[$ns_prefix] = $v;
+					} else {
+						$this->defaultNamespace[$pos] = $v;
+						if (! $this->getPrefixFromNamespace($v)) {
+							$this->namespaces['ns'.(count($this->namespaces)+1)] = $v;
+						}
+					}
+					if($v == 'http://www.w3.org/2001/XMLSchema' || $v == 'http://www.w3.org/1999/XMLSchema' || $v == 'http://www.w3.org/2000/10/XMLSchema'){
+						$this->XMLSchemaVersion = $v;
+						$this->namespaces['xsi'] = $v.'-instance';
+					}
+				}
+        	}
+        	foreach($attrs as $k => $v){
+                // expand each attribute
+                $k = strpos($k,':') ? $this->expandQname($k) : $k;
+                $v = strpos($v,':') ? $this->expandQname($v) : $v;
+        		$eAttrs[$k] = $v;
+        	}
+        	$attrs = $eAttrs;
+        } else {
+        	$attrs = array();
+        }
+		// find status, register data
+		switch($name){
+			case 'all':			// (optional) compositor content for a complexType
+			case 'choice':
+			case 'group':
+			case 'sequence':
+				//$this->xdebug("compositor $name for currentComplexType: $this->currentComplexType and currentElement: $this->currentElement");
+				$this->complexTypes[$this->currentComplexType]['compositor'] = $name;
+				//if($name == 'all' || $name == 'sequence'){
+				//	$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+				//}
+			break;
+			case 'attribute':	// complexType attribute
+            	//$this->xdebug("parsing attribute $attrs[name] $attrs[ref] of value: ".$attrs['http://schemas.xmlsoap.org/wsdl/:arrayType']);
+            	$this->xdebug("parsing attribute:");
+            	$this->appendDebug($this->varDump($attrs));
+				if (!isset($attrs['form'])) {
+					$attrs['form'] = $this->schemaInfo['attributeFormDefault'];
+				}
+            	if (isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])) {
+					$v = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+					if (!strpos($v, ':')) {
+						// no namespace in arrayType attribute value...
+						if ($this->defaultNamespace[$pos]) {
+							// ...so use the default
+							$attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'] = $this->defaultNamespace[$pos] . ':' . $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+						}
+					}
+            	}
+                if(isset($attrs['name'])){
+					$this->attributes[$attrs['name']] = $attrs;
+					$aname = $attrs['name'];
+				} elseif(isset($attrs['ref']) && $attrs['ref'] == 'http://schemas.xmlsoap.org/soap/encoding/:arrayType'){
+					if (isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])) {
+	                	$aname = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+	                } else {
+	                	$aname = '';
+	                }
+				} elseif(isset($attrs['ref'])){
+					$aname = $attrs['ref'];
+                    $this->attributes[$attrs['ref']] = $attrs;
+				}
+                
+				if($this->currentComplexType){	// This should *always* be
+					$this->complexTypes[$this->currentComplexType]['attrs'][$aname] = $attrs;
+				}
+				// arrayType attribute
+				if(isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType']) || $this->getLocalPart($aname) == 'arrayType'){
+					$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+                	$prefix = $this->getPrefix($aname);
+					if(isset($attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'])){
+						$v = $attrs['http://schemas.xmlsoap.org/wsdl/:arrayType'];
+					} else {
+						$v = '';
+					}
+                    if(strpos($v,'[,]')){
+                        $this->complexTypes[$this->currentComplexType]['multidimensional'] = true;
+                    }
+                    $v = substr($v,0,strpos($v,'[')); // clip the []
+                    if(!strpos($v,':') && isset($this->typemap[$this->XMLSchemaVersion][$v])){
+                        $v = $this->XMLSchemaVersion.':'.$v;
+                    }
+                    $this->complexTypes[$this->currentComplexType]['arrayType'] = $v;
+				}
+			break;
+			case 'complexContent':	// (optional) content for a complexType
+			break;
+			case 'complexType':
+				array_push($this->complexTypeStack, $this->currentComplexType);
+				if(isset($attrs['name'])){
+					$this->xdebug('processing named complexType '.$attrs['name']);
+					//$this->currentElement = false;
+					$this->currentComplexType = $attrs['name'];
+					$this->complexTypes[$this->currentComplexType] = $attrs;
+					$this->complexTypes[$this->currentComplexType]['typeClass'] = 'complexType';
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if(isset($attrs['base']) && ereg(':Array$',$attrs['base'])){
+						$this->xdebug('complexType is unusual array');
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					} else {
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+					}
+				}else{
+					$this->xdebug('processing unnamed complexType for element '.$this->currentElement);
+					$this->currentComplexType = $this->currentElement . '_ContainedType';
+					//$this->currentElement = false;
+					$this->complexTypes[$this->currentComplexType] = $attrs;
+					$this->complexTypes[$this->currentComplexType]['typeClass'] = 'complexType';
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if(isset($attrs['base']) && ereg(':Array$',$attrs['base'])){
+						$this->xdebug('complexType is unusual array');
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					} else {
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'struct';
+					}
+				}
+			break;
+			case 'element':
+				array_push($this->elementStack, $this->currentElement);
+				// elements defined as part of a complex type should
+				// not really be added to $this->elements, but for some
+				// reason, they are
+				if (!isset($attrs['form'])) {
+					$attrs['form'] = $this->schemaInfo['elementFormDefault'];
+				}
+				if(isset($attrs['type'])){
+					$this->xdebug("processing typed element ".$attrs['name']." of type ".$attrs['type']);
+					if (! $this->getPrefix($attrs['type'])) {
+						if ($this->defaultNamespace[$pos]) {
+							$attrs['type'] = $this->defaultNamespace[$pos] . ':' . $attrs['type'];
+							$this->xdebug('used default namespace to make type ' . $attrs['type']);
+						}
+					}
+					// This is for constructs like
+					//           <complexType name="ListOfString" base="soap:Array">
+					//                <sequence>
+					//                    <element name="string" type="xsd:string"
+					//                        minOccurs="0" maxOccurs="unbounded" />
+					//                </sequence>
+					//            </complexType>
+					if ($this->currentComplexType && $this->complexTypes[$this->currentComplexType]['phpType'] == 'array') {
+						$this->xdebug('arrayType for unusual array is ' . $attrs['type']);
+						$this->complexTypes[$this->currentComplexType]['arrayType'] = $attrs['type'];
+					}
+					$this->currentElement = $attrs['name'];
+					$this->elements[ $attrs['name'] ] = $attrs;
+					$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+					$ename = $attrs['name'];
+				} elseif(isset($attrs['ref'])){
+					$this->xdebug("processing element as ref to ".$attrs['ref']);
+					$this->currentElement = "ref to ".$attrs['ref'];
+					$ename = $this->getLocalPart($attrs['ref']);
+				} else {
+					$this->xdebug("processing untyped element ".$attrs['name']);
+					$this->currentElement = $attrs['name'];
+					$this->elements[ $attrs['name'] ] = $attrs;
+					$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+					$attrs['type'] = $this->schemaTargetNamespace . ':' . $attrs['name'] . '_ContainedType';
+					$this->elements[ $attrs['name'] ]['type'] = $attrs['type'];
+					$ename = $attrs['name'];
+				}
+				if(isset($ename) && $this->currentComplexType){
+					$this->complexTypes[$this->currentComplexType]['elements'][$ename] = $attrs;
+				}
+			break;
+			case 'enumeration':	//	restriction value list member
+				$this->xdebug('enumeration ' . $attrs['value']);
+				if ($this->currentSimpleType) {
+					$this->simpleTypes[$this->currentSimpleType]['enumeration'][] = $attrs['value'];
+				} elseif ($this->currentComplexType) {
+					$this->complexTypes[$this->currentComplexType]['enumeration'][] = $attrs['value'];
+				}
+			break;
+			case 'extension':	// simpleContent or complexContent type extension
+				$this->xdebug('extension ' . $attrs['base']);
+				if ($this->currentComplexType) {
+					$this->complexTypes[$this->currentComplexType]['extensionBase'] = $attrs['base'];
+				}
+			break;
+			case 'import':
+			    if (isset($attrs['schemaLocation'])) {
+					//$this->xdebug('import namespace ' . $attrs['namespace'] . ' from ' . $attrs['schemaLocation']);
+                    $this->imports[$attrs['namespace']][] = array('location' => $attrs['schemaLocation'], 'loaded' => false);
+				} else {
+					//$this->xdebug('import namespace ' . $attrs['namespace']);
+                    $this->imports[$attrs['namespace']][] = array('location' => '', 'loaded' => true);
+					if (! $this->getPrefixFromNamespace($attrs['namespace'])) {
+						$this->namespaces['ns'.(count($this->namespaces)+1)] = $attrs['namespace'];
+					}
+				}
+			break;
+			case 'list':	// simpleType value list
+			break;
+			case 'restriction':	// simpleType, simpleContent or complexContent value restriction
+				$this->xdebug('restriction ' . $attrs['base']);
+				if($this->currentSimpleType){
+					$this->simpleTypes[$this->currentSimpleType]['type'] = $attrs['base'];
+				} elseif($this->currentComplexType){
+					$this->complexTypes[$this->currentComplexType]['restrictionBase'] = $attrs['base'];
+					if(strstr($attrs['base'],':') == ':Array'){
+						$this->complexTypes[$this->currentComplexType]['phpType'] = 'array';
+					}
+				}
+			break;
+			case 'schema':
+				$this->schemaInfo = $attrs;
+				$this->schemaInfo['schemaVersion'] = $this->getNamespaceFromPrefix($prefix);
+				if (isset($attrs['targetNamespace'])) {
+					$this->schemaTargetNamespace = $attrs['targetNamespace'];
+				}
+				if (!isset($attrs['elementFormDefault'])) {
+					$this->schemaInfo['elementFormDefault'] = 'unqualified';
+				}
+				if (!isset($attrs['attributeFormDefault'])) {
+					$this->schemaInfo['attributeFormDefault'] = 'unqualified';
+				}
+			break;
+			case 'simpleContent':	// (optional) content for a complexType
+			break;
+			case 'simpleType':
+				array_push($this->simpleTypeStack, $this->currentSimpleType);
+				if(isset($attrs['name'])){
+					$this->xdebug("processing simpleType for name " . $attrs['name']);
+					$this->currentSimpleType = $attrs['name'];
+					$this->simpleTypes[ $attrs['name'] ] = $attrs;
+					$this->simpleTypes[ $attrs['name'] ]['typeClass'] = 'simpleType';
+					$this->simpleTypes[ $attrs['name'] ]['phpType'] = 'scalar';
+				} else {
+					$this->xdebug('processing unnamed simpleType for element '.$this->currentElement);
+					$this->currentSimpleType = $this->currentElement . '_ContainedType';
+					//$this->currentElement = false;
+					$this->simpleTypes[$this->currentSimpleType] = $attrs;
+					$this->simpleTypes[$this->currentSimpleType]['phpType'] = 'scalar';
+				}
+			break;
+			case 'union':	// simpleType type list
+			break;
+			default:
+				//$this->xdebug("do not have anything to do for element $name");
+		}
+	}
+
+	/**
+	* end-element handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $name element name
+	* @access   private
+	*/
+	function schemaEndElement($parser, $name) {
+		// bring depth down a notch
+		$this->depth--;
+		// position of current element is equal to the last value left in depth_array for my depth
+		if(isset($this->depth_array[$this->depth])){
+        	$pos = $this->depth_array[$this->depth];
+        }
+		// get element prefix
+		if ($prefix = $this->getPrefix($name)){
+			// get unqualified name
+			$name = $this->getLocalPart($name);
+		} else {
+        	$prefix = '';
+        }
+		// move on...
+		if($name == 'complexType'){
+			$this->xdebug('done processing complexType ' . ($this->currentComplexType ? $this->currentComplexType : '(unknown)'));
+			$this->currentComplexType = array_pop($this->complexTypeStack);
+			//$this->currentElement = false;
+		}
+		if($name == 'element'){
+			$this->xdebug('done processing element ' . ($this->currentElement ? $this->currentElement : '(unknown)'));
+			$this->currentElement = array_pop($this->elementStack);
+		}
+		if($name == 'simpleType'){
+			$this->xdebug('done processing simpleType ' . ($this->currentSimpleType ? $this->currentSimpleType : '(unknown)'));
+			$this->currentSimpleType = array_pop($this->simpleTypeStack);
+		}
+	}
+
+	/**
+	* element content handler
+	*
+	* @param    string $parser XML parser object
+	* @param    string $data element content
+	* @access   private
+	*/
+	function schemaCharacterData($parser, $data){
+		$pos = $this->depth_array[$this->depth - 1];
+		$this->message[$pos]['cdata'] .= $data;
+	}
+
+	/**
+	* serialize the schema
+	*
+	* @access   public
+	*/
+	function serializeSchema(){
+
+		$schemaPrefix = $this->getPrefixFromNamespace($this->XMLSchemaVersion);
+		$xml = '';
+		// imports
+		if (sizeof($this->imports) > 0) {
+			foreach($this->imports as $ns => $list) {
+				foreach ($list as $ii) {
+					if ($ii['location'] != '') {
+						$xml .= " <$schemaPrefix:import location=\"" . $ii['location'] . '" namespace="' . $ns . "\" />\n";
+					} else {
+						$xml .= " <$schemaPrefix:import namespace=\"" . $ns . "\" />\n";
+					}
+				}
+			} 
+		} 
+		// complex types
+		foreach($this->complexTypes as $typeName => $attrs){
+			$contentStr = '';
+			// serialize child elements
+			if(isset($attrs['elements']) && (count($attrs['elements']) > 0)){
+				foreach($attrs['elements'] as $element => $eParts){
+					if(isset($eParts['ref'])){
+						$contentStr .= "   <$schemaPrefix:element ref=\"$element\"/>\n";
+					} else {
+						$contentStr .= "   <$schemaPrefix:element name=\"$element\" type=\"" . $this->contractQName($eParts['type']) . "\"";
+						foreach ($eParts as $aName => $aValue) {
+							// handle, e.g., abstract, default, form, minOccurs, maxOccurs, nillable
+							if ($aName != 'name' && $aName != 'type') {
+								$contentStr .= " $aName=\"$aValue\"";
+							}
+						}
+						$contentStr .= "/>\n";
+					}
+				}
+				// compositor wraps elements
+				if (isset($attrs['compositor']) && ($attrs['compositor'] != '')) {
+					$contentStr = "  <$schemaPrefix:$attrs[compositor]>\n".$contentStr."  </$schemaPrefix:$attrs[compositor]>\n";
+				}
+			}
+			// attributes
+			if(isset($attrs['attrs']) && (count($attrs['attrs']) >= 1)){
+				foreach($attrs['attrs'] as $attr => $aParts){
+					$contentStr .= "    <$schemaPrefix:attribute";
+					foreach ($aParts as $a => $v) {
+						if ($a == 'ref' || $a == 'type') {
+							$contentStr .= " $a=\"".$this->contractQName($v).'"';
+						} elseif ($a == 'http://schemas.xmlsoap.org/wsdl/:arrayType') {
+							$this->usedNamespaces['wsdl'] = $this->namespaces['wsdl'];
+							$contentStr .= ' wsdl:arrayType="'.$this->contractQName($v).'"';
+						} else {
+							$contentStr .= " $a=\"$v\"";
+						}
+					}
+					$contentStr .= "/>\n";
+				}
+			}
+			// if restriction
+			if (isset($attrs['restrictionBase']) && $attrs['restrictionBase'] != ''){
+				$contentStr = "   <$schemaPrefix:restriction base=\"".$this->contractQName($attrs['restrictionBase'])."\">\n".$contentStr."   </$schemaPrefix:restriction>\n";
+				// complex or simple content
+				if ((isset($attrs['elements']) && count($attrs['elements']) > 0) || (isset($attrs['attrs']) && count($attrs['attrs']) > 0)){
+					$contentStr = "  <$schemaPrefix:complexContent>\n".$contentStr."  </$schemaPrefix:complexContent>\n";
+				}
+			}
+			// finalize complex type
+			if($contentStr != ''){
+				$contentStr = " <$schemaPrefix:complexType name=\"$typeName\">\n".$contentStr." </$schemaPrefix:complexType>\n";
+			} else {
+				$contentStr = " <$schemaPrefix:complexType name=\"$typeName\"/>\n";
+			}
+			$xml .= $contentStr;
+		}
+		// simple types
+		if(isset($this->simpleTypes) && count($this->simpleTypes) > 0){
+			foreach($this->simpleTypes as $typeName => $eParts){
+				$xml .= " <$schemaPrefix:simpleType name=\"$typeName\">\n  <$schemaPrefix:restriction base=\"".$this->contractQName($eParts['type'])."\"/>\n";
+				if (isset($eParts['enumeration'])) {
+					foreach ($eParts['enumeration'] as $e) {
+						$xml .= "  <$schemaPrefix:enumeration value=\"$e\"/>\n";
+					}
+				}
+				$xml .= " </$schemaPrefix:simpleType>";
+			}
+		}
+		// elements
+		if(isset($this->elements) && count($this->elements) > 0){
+			foreach($this->elements as $element => $eParts){
+				$xml .= " <$schemaPrefix:element name=\"$element\" type=\"".$this->contractQName($eParts['type'])."\"/>\n";
+			}
+		}
+		// attributes
+		if(isset($this->attributes) && count($this->attributes) > 0){
+			foreach($this->attributes as $attr => $aParts){
+				$xml .= " <$schemaPrefix:attribute name=\"$attr\" type=\"".$this->contractQName($aParts['type'])."\"\n/>";
+			}
+		}
+		// finish 'er up
+		$el = "<$schemaPrefix:schema targetNamespace=\"$this->schemaTargetNamespace\"\n";
+		foreach (array_diff($this->usedNamespaces, $this->enclosingNamespaces) as $nsp => $ns) {
+			$el .= " xmlns:$nsp=\"$ns\"\n";
+		}
+		$xml = $el . ">\n".$xml."</$schemaPrefix:schema>\n";
+		return $xml;
+	}
+
+	/**
+	* adds debug data to the clas level debug string
+	*
+	* @param    string $string debug data
+	* @access   private
+	*/
+	function xdebug($string){
+		$this->debug('<' . $this->schemaTargetNamespace . '> '.$string);
+	}
+
+    /**
+    * get the PHP type of a user defined type in the schema
+    * PHP type is kind of a misnomer since it actually returns 'struct' for assoc. arrays
+    * returns false if no type exists, or not w/ the given namespace
+    * else returns a string that is either a native php type, or 'struct'
+    *
+    * @param string $type, name of defined type
+    * @param string $ns, namespace of type
+    * @return mixed
+    * @access public
+    * @deprecated
+    */
+	function getPHPType($type,$ns){
+		if(isset($this->typemap[$ns][$type])){
+			//print "found type '$type' and ns $ns in typemap<br>";
+			return $this->typemap[$ns][$type];
+		} elseif(isset($this->complexTypes[$type])){
+			//print "getting type '$type' and ns $ns from complexTypes array<br>";
+			return $this->complexTypes[$type]['phpType'];
+		}
+		return false;
+	}
+
+	/**
+    * returns an associative array of information about a given type
+    * returns false if no type exists by the given name
+    *
+	*	For a complexType typeDef = array(
+	*	'restrictionBase' => '',
+	*	'phpType' => '',
+	*	'compositor' => '(sequence|all)',
+	*	'elements' => array(), // refs to elements array
+	*	'attrs' => array() // refs to attributes array
+	*	... and so on (see addComplexType)
+	*	)
+	*
+	*   For simpleType or element, the array has different keys.
+    *
+    * @param string
+    * @return mixed
+    * @access public
+    * @see addComplexType
+    * @see addSimpleType
+    * @see addElement
+    */
+	function getTypeDef($type){
+		//$this->debug("in getTypeDef for type $type");
+		if(isset($this->complexTypes[$type])){
+			$this->xdebug("in getTypeDef, found complexType $type");
+			return $this->complexTypes[$type];
+		} elseif(isset($this->simpleTypes[$type])){
+			$this->xdebug("in getTypeDef, found simpleType $type");
+			if (!isset($this->simpleTypes[$type]['phpType'])) {
+				// get info for type to tack onto the simple type
+				// TODO: can this ever really apply (i.e. what is a simpleType really?)
+				$uqType = substr($this->simpleTypes[$type]['type'], strrpos($this->simpleTypes[$type]['type'], ':') + 1);
+				$ns = substr($this->simpleTypes[$type]['type'], 0, strrpos($this->simpleTypes[$type]['type'], ':'));
+				$etype = $this->getTypeDef($uqType);
+				if ($etype) {
+					$this->xdebug("in getTypeDef, found type for simpleType $type:");
+					$this->xdebug($this->varDump($etype));
+					if (isset($etype['phpType'])) {
+						$this->simpleTypes[$type]['phpType'] = $etype['phpType'];
+					}
+					if (isset($etype['elements'])) {
+						$this->simpleTypes[$type]['elements'] = $etype['elements'];
+					}
+				}
+			}
+			return $this->simpleTypes[$type];
+		} elseif(isset($this->elements[$type])){
+			$this->xdebug("in getTypeDef, found element $type");
+			if (!isset($this->elements[$type]['phpType'])) {
+				// get info for type to tack onto the element
+				$uqType = substr($this->elements[$type]['type'], strrpos($this->elements[$type]['type'], ':') + 1);
+				$ns = substr($this->elements[$type]['type'], 0, strrpos($this->elements[$type]['type'], ':'));
+				$etype = $this->getTypeDef($uqType);
+				if ($etype) {
+					$this->xdebug("in getTypeDef, found type for element $type:");
+					$this->xdebug($this->varDump($etype));
+					if (isset($etype['phpType'])) {
+						$this->elements[$type]['phpType'] = $etype['phpType'];
+					}
+					if (isset($etype['elements'])) {
+						$this->elements[$type]['elements'] = $etype['elements'];
+					}
+				} elseif ($ns == 'http://www.w3.org/2001/XMLSchema') {
+					$this->xdebug("in getTypeDef, element $type is an XSD type");
+					$this->elements[$type]['phpType'] = 'scalar';
+				}
+			}
+			return $this->elements[$type];
+		} elseif(isset($this->attributes[$type])){
+			$this->xdebug("in getTypeDef, found attribute $type");
+			return $this->attributes[$type];
+		} elseif (ereg('_ContainedType$', $type)) {
+			$this->xdebug("in getTypeDef, have an untyped element $type");
+			$typeDef['typeClass'] = 'simpleType';
+			$typeDef['phpType'] = 'scalar';
+			$typeDef['type'] = 'http://www.w3.org/2001/XMLSchema:string';
+			return $typeDef;
+		}
+		$this->xdebug("in getTypeDef, did not find $type");
+		return false;
+	}
+
+	/**
+    * returns a sample serialization of a given type, or false if no type by the given name
+    *
+    * @param string $type, name of type
+    * @return mixed
+    * @access public
+    * @deprecated
+    */
+    function serializeTypeDef($type){
+    	//print "in sTD() for type $type<br>";
+	if($typeDef = $this->getTypeDef($type)){
+		$str .= '<'.$type;
+	    if(is_array($typeDef['attrs'])){
+		foreach($attrs as $attName => $data){
+		    $str .= " $attName=\"{type = ".$data['type']."}\"";
+		}
+	    }
+	    $str .= " xmlns=\"".$this->schema['targetNamespace']."\"";
+	    if(count($typeDef['elements']) > 0){
+		$str .= ">";
+		foreach($typeDef['elements'] as $element => $eData){
+		    $str .= $this->serializeTypeDef($element);
+		}
+		$str .= "</$type>";
+	    } elseif($typeDef['typeClass'] == 'element') {
+		$str .= "></$type>";
+	    } else {
+		$str .= "/>";
+	    }
+			return $str;
+	}
+    	return false;
+    }
+
+    /**
+    * returns HTML form elements that allow a user
+    * to enter values for creating an instance of the given type.
+    *
+    * @param string $name, name for type instance
+    * @param string $type, name of type
+    * @return string
+    * @access public
+    * @deprecated
+	*/
+	function typeToForm($name,$type){
+		// get typedef
+		if($typeDef = $this->getTypeDef($type)){
+			// if struct
+			if($typeDef['phpType'] == 'struct'){
+				$buffer .= '<table>';
+				foreach($typeDef['elements'] as $child => $childDef){
+					$buffer .= "
+					<tr><td align='right'>$childDef[name] (type: ".$this->getLocalPart($childDef['type'])."):</td>
+					<td><input type='text' name='parameters[".$name."][$childDef[name]]'></td></tr>";
+				}
+				$buffer .= '</table>';
+			// if array
+			} elseif($typeDef['phpType'] == 'array'){
+				$buffer .= '<table>';
+				for($i=0;$i < 3; $i++){
+					$buffer .= "
+					<tr><td align='right'>array item (type: $typeDef[arrayType]):</td>
+					<td><input type='text' name='parameters[".$name."][]'></td></tr>";
+				}
+				$buffer .= '</table>';
+			// if scalar
+			} else {
+				$buffer .= "<input type='text' name='parameters[$name]'>";
+			}
+		} else {
+			$buffer .= "<input type='text' name='parameters[$name]'>";
+		}
+		return $buffer;
+	}
+	
+	/**
+	* adds a complex type to the schema
+	* 
+	* example: array
+	* 
+	* addType(
+	* 	'ArrayOfstring',
+	* 	'complexType',
+	* 	'array',
+	* 	'',
+	* 	'SOAP-ENC:Array',
+	* 	array('ref'=>'SOAP-ENC:arrayType','wsdl:arrayType'=>'string[]'),
+	* 	'xsd:string'
+	* );
+	* 
+	* example: PHP associative array ( SOAP Struct )
+	* 
+	* addType(
+	* 	'SOAPStruct',
+	* 	'complexType',
+	* 	'struct',
+	* 	'all',
+	* 	array('myVar'=> array('name'=>'myVar','type'=>'string')
+	* );
+	* 
+	* @param name
+	* @param typeClass (complexType|simpleType|attribute)
+	* @param phpType: currently supported are array and struct (php assoc array)
+	* @param compositor (all|sequence|choice)
+	* @param restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param elements = array ( name = array(name=>'',type=>'') )
+	* @param attrs = array(
+	* 	array(
+	*		'ref' => "http://schemas.xmlsoap.org/soap/encoding/:arrayType",
+	*		"http://schemas.xmlsoap.org/wsdl/:arrayType" => "string[]"
+	* 	)
+	* )
+	* @param arrayType: namespace:name (http://www.w3.org/2001/XMLSchema:string)
+	* @access public
+	* @see getTypeDef
+	*/
+	function addComplexType($name,$typeClass='complexType',$phpType='array',$compositor='',$restrictionBase='',$elements=array(),$attrs=array(),$arrayType=''){
+		$this->complexTypes[$name] = array(
+	    'name'		=> $name,
+	    'typeClass'	=> $typeClass,
+	    'phpType'	=> $phpType,
+		'compositor'=> $compositor,
+	    'restrictionBase' => $restrictionBase,
+		'elements'	=> $elements,
+	    'attrs'		=> $attrs,
+	    'arrayType'	=> $arrayType
+		);
+		
+		$this->xdebug("addComplexType $name:");
+		$this->appendDebug($this->varDump($this->complexTypes[$name]));
+	}
+	
+	/**
+	* adds a simple type to the schema
+	*
+	* @param string $name
+	* @param string $restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param string $typeClass (should always be simpleType)
+	* @param string $phpType (should always be scalar)
+	* @param array $enumeration array of values
+	* @access public
+	* @see xmlschema
+	* @see getTypeDef
+	*/
+	function addSimpleType($name, $restrictionBase='', $typeClass='simpleType', $phpType='scalar', $enumeration=array()) {
+		$this->simpleTypes[$name] = array(
+	    'name'			=> $name,
+	    'typeClass'		=> $typeClass,
+	    'phpType'		=> $phpType,
+	    'type'			=> $restrictionBase,
+	    'enumeration'	=> $enumeration
+		);
+		
+		$this->xdebug("addSimpleType $name:");
+		$this->appendDebug($this->varDump($this->simpleTypes[$name]));
+	}
+
+	/**
+	* adds an element to the schema
+	*
+	* @param array $attrs attributes that must include name and type
+	* @see xmlschema
+	* @access public
+	*/
+	function addElement($attrs) {
+		if (! $this->getPrefix($attrs['type'])) {
+			$attrs['type'] = $this->schemaTargetNamespace . ':' . $attrs['type'];
+		}
+		$this->elements[ $attrs['name'] ] = $attrs;
+		$this->elements[ $attrs['name'] ]['typeClass'] = 'element';
+		
+		$this->xdebug("addElement " . $attrs['name']);
+		$this->appendDebug($this->varDump($this->elements[ $attrs['name'] ]));
+	}
+}
+
+
+
+?><?php
+
+
+
+/**
+* For creating serializable abstractions of native PHP types.  This class
+* allows element name/namespace, XSD type, and XML attributes to be
+* associated with a value.  This is extremely useful when WSDL is not
+* used, but is also useful when WSDL is used with polymorphic types, including
+* xsd:anyType and user-defined types.
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soapval extends nusoap_base {
+	/**
+	 * The XML element name
+	 *
+	 * @var string
+	 * @access private
+	 */
+	var $name;
+	/**
+	 * The XML type name (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $type;
+	/**
+	 * The PHP value
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $value;
+	/**
+	 * The XML element namespace (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $element_ns;
+	/**
+	 * The XML type namespace (string or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $type_ns;
+	/**
+	 * The XML element attributes (array or false)
+	 *
+	 * @var mixed
+	 * @access private
+	 */
+	var $attributes;
+
+	/**
+	* constructor
+	*
+	* @param    string $name optional name
+	* @param    mixed $type optional type name
+	* @param	mixed $value optional value
+	* @param	mixed $element_ns optional namespace of value
+	* @param	mixed $type_ns optional namespace of type
+	* @param	mixed $attributes associative array of attributes to add to element serialization
+	* @access   public
+	*/
+  	function soapval($name='soapval',$type=false,$value=-1,$element_ns=false,$type_ns=false,$attributes=false) {
+		parent::nusoap_base();
+		$this->name = $name;
+		$this->type = $type;
+		$this->value = $value;
+		$this->element_ns = $element_ns;
+		$this->type_ns = $type_ns;
+		$this->attributes = $attributes;
+    }
+
+	/**
+	* return serialized value
+	*
+	* @param	string $use The WSDL use value (encoded|literal)
+	* @return	string XML data
+	* @access   public
+	*/
+	function serialize($use='encoded') {
+		return $this->serialize_val($this->value,$this->name,$this->type,$this->element_ns,$this->type_ns,$this->attributes,$use);
+    }
+
+	/**
+	* decodes a soapval object into a PHP native type
+	*
+	* @return	mixed
+	* @access   public
+	*/
+	function decode(){
+		return $this->value;
+	}
+}
+
+
+
+?><?php
+
+
+
+/**
+* transport class for sending/receiving data via HTTP and HTTPS
+* NOTE: PHP must be compiled with the CURL extension for HTTPS support
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access public
+*/
+class soap_transport_http extends nusoap_base {
+
+	var $url = '';
+	var $uri = '';
+	var $digest_uri = '';
+	var $scheme = '';
+	var $host = '';
+	var $port = '';
+	var $path = '';
+	var $request_method = 'POST';
+	var $protocol_version = '1.0';
+	var $encoding = '';
+	var $outgoing_headers = array();
+	var $incoming_headers = array();
+	var $incoming_cookies = array();
+	var $outgoing_payload = '';
+	var $incoming_payload = '';
+	var $useSOAPAction = true;
+	var $persistentConnection = false;
+	var $ch = false;	// cURL handle
+	var $username = '';
+	var $password = '';
+	var $authtype = '';
+	var $digestRequest = array();
+	var $certRequest = array();	// keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional)
+								// cainfofile: certificate authority file, e.g. '$pathToPemFiles/rootca.pem'
+								// sslcertfile: SSL certificate file, e.g. '$pathToPemFiles/mycert.pem'
+								// sslkeyfile: SSL key file, e.g. '$pathToPemFiles/mykey.pem'
+								// passphrase: SSL key password/passphrase
+								// verifypeer: default is 1
+								// verifyhost: default is 1
+
+	/**
+	* constructor
+	*/
+	function soap_transport_http($url){
+		parent::nusoap_base();
+		$this->setURL($url);
+		ereg('\$Revisio' . 'n: ([^ ]+)', $this->revision, $rev);
+		$this->outgoing_headers['User-Agent'] = $this->title.'/'.$this->version.' ('.$rev[1].')';
+		$this->debug('set User-Agent: ' . $this->outgoing_headers['User-Agent']);
+	}
+
+	function setURL($url) {
+		$this->url = $url;
+
+		$u = parse_url($url);
+		foreach($u as $k => $v){
+			$this->debug("$k = $v");
+			$this->$k = $v;
+		}
+		
+		// add any GET params to path
+		if(isset($u['query']) && $u['query'] != ''){
+            $this->path .= '?' . $u['query'];
+		}
+		
+		// set default port
+		if(!isset($u['port'])){
+			if($u['scheme'] == 'https'){
+				$this->port = 443;
+			} else {
+				$this->port = 80;
+			}
+		}
+		
+		$this->uri = $this->path;
+		$this->digest_uri = $this->uri;
+		
+		// build headers
+		if (!isset($u['port'])) {
+			$this->outgoing_headers['Host'] = $this->host;
+		} else {
+			$this->outgoing_headers['Host'] = $this->host.':'.$this->port;
+		}
+		$this->debug('set Host: ' . $this->outgoing_headers['Host']);
+
+		if (isset($u['user']) && $u['user'] != '') {
+			$this->setCredentials(urldecode($u['user']), isset($u['pass']) ? urldecode($u['pass']) : '');
+		}
+	}
+	
+	function connect($connection_timeout=0,$response_timeout=30){
+	  	// For PHP 4.3 with OpenSSL, change https scheme to ssl, then treat like
+	  	// "regular" socket.
+	  	// TODO: disabled for now because OpenSSL must be *compiled* in (not just
+	  	//       loaded), and until PHP5 stream_get_wrappers is not available.
+//	  	if ($this->scheme == 'https') {
+//		  	if (version_compare(phpversion(), '4.3.0') >= 0) {
+//		  		if (extension_loaded('openssl')) {
+//		  			$this->scheme = 'ssl';
+//		  			$this->debug('Using SSL over OpenSSL');
+//		  		}
+//		  	}
+//		}
+		$this->debug("connect connection_timeout $connection_timeout, response_timeout $response_timeout, scheme $this->scheme, host $this->host, port $this->port");
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+		// use persistent connection
+		if($this->persistentConnection && isset($this->fp) && is_resource($this->fp)){
+			if (!feof($this->fp)) {
+				$this->debug('Re-use persistent connection');
+				return true;
+			}
+			fclose($this->fp);
+			$this->debug('Closed persistent connection at EOF');
+		}
+
+		// munge host if using OpenSSL
+		if ($this->scheme == 'ssl') {
+			$host = 'ssl://' . $this->host;
+		} else {
+			$host = $this->host;
+		}
+		$this->debug('calling fsockopen with host ' . $host . ' connection_timeout ' . $connection_timeout);
+
+		// open socket
+		if($connection_timeout > 0){
+			$this->fp = @fsockopen( $host, $this->port, $this->errno, $this->error_str, $connection_timeout);
+		} else {
+			$this->fp = @fsockopen( $host, $this->port, $this->errno, $this->error_str);
+		}
+		
+		// test pointer
+		if(!$this->fp) {
+			$msg = 'Couldn\'t open socket connection to server ' . $this->url;
+			if ($this->errno) {
+				$msg .= ', Error ('.$this->errno.'): '.$this->error_str;
+			} else {
+				$msg .= ' prior to connect().  This is often a problem looking up the host name.';
+			}
+			$this->debug($msg);
+			$this->setError($msg);
+			return false;
+		}
+		
+		// set response timeout
+		$this->debug('set response timeout to ' . $response_timeout);
+		socket_set_timeout( $this->fp, $response_timeout);
+
+		$this->debug('socket connected');
+		return true;
+	  } else if ($this->scheme == 'https') {
+		if (!extension_loaded('curl')) {
+			$this->setError('CURL Extension, or OpenSSL extension w/ PHP version >= 4.3 is required for HTTPS');
+			return false;
+		}
+		$this->debug('connect using https');
+		// init CURL
+		$this->ch = curl_init();
+		// set url
+		$hostURL = ($this->port != '') ? "https://$this->host:$this->port" : "https://$this->host";
+		// add path
+		$hostURL .= $this->path;
+		curl_setopt($this->ch, CURLOPT_URL, $hostURL);
+		// follow location headers (re-directs)
+		curl_setopt($this->ch, CURLOPT_FOLLOWLOCATION, 1);
+		// ask for headers in the response output
+		curl_setopt($this->ch, CURLOPT_HEADER, 1);
+		// ask for the response output as the return value
+		curl_setopt($this->ch, CURLOPT_RETURNTRANSFER, 1);
+		// encode
+		// We manage this ourselves through headers and encoding
+//		if(function_exists('gzuncompress')){
+//			curl_setopt($this->ch, CURLOPT_ENCODING, 'deflate');
+//		}
+		// persistent connection
+		if ($this->persistentConnection) {
+			// The way we send data, we cannot use persistent connections, since
+			// there will be some "junk" at the end of our request.
+			//curl_setopt($this->ch, CURL_HTTP_VERSION_1_1, true);
+			$this->persistentConnection = false;
+			$this->outgoing_headers['Connection'] = 'close';
+			$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+		}
+		// set timeout
+		if ($connection_timeout != 0) {
+			curl_setopt($this->ch, CURLOPT_TIMEOUT, $connection_timeout);
+		}
+		// TODO: cURL has added a connection timeout separate from the response timeout
+		//if ($connection_timeout != 0) {
+		//	curl_setopt($this->ch, CURLOPT_CONNECTIONTIMEOUT, $connection_timeout);
+		//}
+		//if ($response_timeout != 0) {
+		//	curl_setopt($this->ch, CURLOPT_TIMEOUT, $response_timeout);
+		//}
+
+		// recent versions of cURL turn on peer/host checking by default,
+		// while PHP binaries are not compiled with a default location for the
+		// CA cert bundle, so disable peer/host checking.
+//curl_setopt($this->ch, CURLOPT_CAINFO, 'f:\php-4.3.2-win32\extensions\curl-ca-bundle.crt');		
+		curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, 0);
+		curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, 0);
+
+		// support client certificates (thanks Tobias Boes, Doug Anarino, Eryan Ariobowo)
+		if ($this->authtype == 'certificate') {
+			if (isset($this->certRequest['cainfofile'])) {
+				curl_setopt($this->ch, CURLOPT_CAINFO, $this->certRequest['cainfofile']);
+			}
+			if (isset($this->certRequest['verifypeer'])) {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, $this->certRequest['verifypeer']);
+			} else {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYPEER, 1);
+			}
+			if (isset($this->certRequest['verifyhost'])) {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, $this->certRequest['verifyhost']);
+			} else {
+				curl_setopt($this->ch, CURLOPT_SSL_VERIFYHOST, 1);
+			}
+			if (isset($this->certRequest['sslcertfile'])) {
+				curl_setopt($this->ch, CURLOPT_SSLCERT, $this->certRequest['sslcertfile']);
+			}
+			if (isset($this->certRequest['sslkeyfile'])) {
+				curl_setopt($this->ch, CURLOPT_SSLKEY, $this->certRequest['sslkeyfile']);
+			}
+			if (isset($this->certRequest['passphrase'])) {
+				curl_setopt($this->ch, CURLOPT_SSLKEYPASSWD , $this->certRequest['passphrase']);
+			}
+		}
+		$this->debug('cURL connection set up');
+		return true;
+	  } else {
+		$this->setError('Unknown scheme ' . $this->scheme);
+		$this->debug('Unknown scheme ' . $this->scheme);
+		return false;
+	  }
+	}
+	
+	/**
+	* send the SOAP message via HTTP
+	*
+	* @param    string $data message data
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @param	array $cookies cookies to send
+	* @return	string data
+	* @access   public
+	*/
+	function send($data, $timeout=0, $response_timeout=30, $cookies=NULL) {
+		
+		$this->debug('entered send() with data of length: '.strlen($data));
+
+		$this->tryagain = true;
+		$tries = 0;
+		while ($this->tryagain) {
+			$this->tryagain = false;
+			if ($tries++ < 2) {
+				// make connnection
+				if (!$this->connect($timeout, $response_timeout)){
+					return false;
+				}
+				
+				// send request
+				if (!$this->sendRequest($data, $cookies)){
+					return false;
+				}
+				
+				// get response
+				$respdata = $this->getResponse();
+			} else {
+				$this->setError('Too many tries to get an OK response');
+			}
+		}		
+		$this->debug('end of send()');
+		return $respdata;
+	}
+
+
+	/**
+	* send the SOAP message via HTTPS 1.0 using CURL
+	*
+	* @param    string $msg message data
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @param	array $cookies cookies to send
+	* @return	string data
+	* @access   public
+	*/
+	function sendHTTPS($data, $timeout=0, $response_timeout=30, $cookies) {
+		return $this->send($data, $timeout, $response_timeout, $cookies);
+	}
+	
+	/**
+	* if authenticating, set user credentials here
+	*
+	* @param    string $username
+	* @param    string $password
+	* @param	string $authtype (basic, digest, certificate)
+	* @param	array $digestRequest (keys must be nonce, nc, realm, qop)
+	* @param	array $certRequest (keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional): see corresponding options in cURL docs)
+	* @access   public
+	*/
+	function setCredentials($username, $password, $authtype = 'basic', $digestRequest = array(), $certRequest = array()) {
+		$this->debug("Set credentials for authtype $authtype");
+		// cf. RFC 2617
+		if ($authtype == 'basic') {
+			$this->outgoing_headers['Authorization'] = 'Basic '.base64_encode(str_replace(':','',$username).':'.$password);
+		} elseif ($authtype == 'digest') {
+			if (isset($digestRequest['nonce'])) {
+				$digestRequest['nc'] = isset($digestRequest['nc']) ? $digestRequest['nc']++ : 1;
+				
+				// calculate the Digest hashes (calculate code based on digest implementation found at: http://www.rassoc.com/gregr/weblog/stories/2002/07/09/webServicesSecurityHttpDigestAuthenticationWithoutActiveDirectory.html)
+	
+				// A1 = unq(username-value) ":" unq(realm-value) ":" passwd
+				$A1 = $username. ':' . (isset($digestRequest['realm']) ? $digestRequest['realm'] : '') . ':' . $password;
+	
+				// H(A1) = MD5(A1)
+				$HA1 = md5($A1);
+	
+				// A2 = Method ":" digest-uri-value
+				$A2 = 'POST:' . $this->digest_uri;
+	
+				// H(A2)
+				$HA2 =  md5($A2);
+	
+				// KD(secret, data) = H(concat(secret, ":", data))
+				// if qop == auth:
+				// request-digest  = <"> < KD ( H(A1),     unq(nonce-value)
+				//                              ":" nc-value
+				//                              ":" unq(cnonce-value)
+				//                              ":" unq(qop-value)
+				//                              ":" H(A2)
+				//                            ) <">
+				// if qop is missing,
+				// request-digest  = <"> < KD ( H(A1), unq(nonce-value) ":" H(A2) ) > <">
+	
+				$unhashedDigest = '';
+				$nonce = isset($digestRequest['nonce']) ? $digestRequest['nonce'] : '';
+				$cnonce = $nonce;
+				if ($digestRequest['qop'] != '') {
+					$unhashedDigest = $HA1 . ':' . $nonce . ':' . sprintf("%08d", $digestRequest['nc']) . ':' . $cnonce . ':' . $digestRequest['qop'] . ':' . $HA2;
+				} else {
+					$unhashedDigest = $HA1 . ':' . $nonce . ':' . $HA2;
+				}
+	
+				$hashedDigest = md5($unhashedDigest);
+	
+				$this->outgoing_headers['Authorization'] = 'Digest username="' . $username . '", realm="' . $digestRequest['realm'] . '", nonce="' . $nonce . '", uri="' . $this->digest_uri . '", cnonce="' . $cnonce . '", nc=' . sprintf("%08x", $digestRequest['nc']) . ', qop="' . $digestRequest['qop'] . '", response="' . $hashedDigest . '"';
+			}
+		} elseif ($authtype == 'certificate') {
+			$this->certRequest = $certRequest;
+		}
+		$this->username = $username;
+		$this->password = $password;
+		$this->authtype = $authtype;
+		$this->digestRequest = $digestRequest;
+		
+		if (isset($this->outgoing_headers['Authorization'])) {
+			$this->debug('set Authorization: ' . substr($this->outgoing_headers['Authorization'], 0, 12) . '...');
+		} else {
+			$this->debug('Authorization header not set');
+		}
+	}
+	
+	/**
+	* set the soapaction value
+	*
+	* @param    string $soapaction
+	* @access   public
+	*/
+	function setSOAPAction($soapaction) {
+		$this->outgoing_headers['SOAPAction'] = '"' . $soapaction . '"';
+		$this->debug('set SOAPAction: ' . $this->outgoing_headers['SOAPAction']);
+	}
+	
+	/**
+	* use http encoding
+	*
+	* @param    string $enc encoding style. supported values: gzip, deflate, or both
+	* @access   public
+	*/
+	function setEncoding($enc='gzip, deflate') {
+		if (function_exists('gzdeflate')) {
+			$this->protocol_version = '1.1';
+			$this->outgoing_headers['Accept-Encoding'] = $enc;
+			$this->debug('set Accept-Encoding: ' . $this->outgoing_headers['Accept-Encoding']);
+			if (!isset($this->outgoing_headers['Connection'])) {
+				$this->outgoing_headers['Connection'] = 'close';
+				$this->persistentConnection = false;
+				$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+			}
+			set_magic_quotes_runtime(0);
+			// deprecated
+			$this->encoding = $enc;
+		}
+	}
+	
+	/**
+	* set proxy info here
+	*
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @access   public
+	*/
+	function setProxy($proxyhost, $proxyport, $proxyusername = '', $proxypassword = '') {
+		$this->uri = $this->url;
+		$this->host = $proxyhost;
+		$this->port = $proxyport;
+		if ($proxyusername != '' && $proxypassword != '') {
+			$this->outgoing_headers['Proxy-Authorization'] = ' Basic '.base64_encode($proxyusername.':'.$proxypassword);
+			$this->debug('set Proxy-Authorization: ' . $this->outgoing_headers['Proxy-Authorization']);
+		}
+	}
+	
+	/**
+	* decode a string that is encoded w/ "chunked' transfer encoding
+ 	* as defined in RFC2068 19.4.6
+	*
+	* @param    string $buffer
+	* @param    string $lb
+	* @returns	string
+	* @access   public
+	* @deprecated
+	*/
+	function decodeChunked($buffer, $lb){
+		// length := 0
+		$length = 0;
+		$new = '';
+		
+		// read chunk-size, chunk-extension (if any) and CRLF
+		// get the position of the linebreak
+		$chunkend = strpos($buffer, $lb);
+		if ($chunkend == FALSE) {
+			$this->debug('no linebreak found in decodeChunked');
+			return $new;
+		}
+		$temp = substr($buffer,0,$chunkend);
+		$chunk_size = hexdec( trim($temp) );
+		$chunkstart = $chunkend + strlen($lb);
+		// while (chunk-size > 0) {
+		while ($chunk_size > 0) {
+			$this->debug("chunkstart: $chunkstart chunk_size: $chunk_size");
+			$chunkend = strpos( $buffer, $lb, $chunkstart + $chunk_size);
+		  	
+			// Just in case we got a broken connection
+		  	if ($chunkend == FALSE) {
+		  	    $chunk = substr($buffer,$chunkstart);
+				// append chunk-data to entity-body
+		    	$new .= $chunk;
+		  	    $length += strlen($chunk);
+		  	    break;
+			}
+			
+		  	// read chunk-data and CRLF
+		  	$chunk = substr($buffer,$chunkstart,$chunkend-$chunkstart);
+		  	// append chunk-data to entity-body
+		  	$new .= $chunk;
+		  	// length := length + chunk-size
+		  	$length += strlen($chunk);
+		  	// read chunk-size and CRLF
+		  	$chunkstart = $chunkend + strlen($lb);
+			
+		  	$chunkend = strpos($buffer, $lb, $chunkstart) + strlen($lb);
+			if ($chunkend == FALSE) {
+				break; //Just in case we got a broken connection
+			}
+			$temp = substr($buffer,$chunkstart,$chunkend-$chunkstart);
+			$chunk_size = hexdec( trim($temp) );
+			$chunkstart = $chunkend;
+		}
+		return $new;
+	}
+	
+	/*
+	 *	Writes payload, including HTTP headers, to $this->outgoing_payload.
+	 */
+	function buildPayload($data, $cookie_str = '') {
+		// add content-length header
+		$this->outgoing_headers['Content-Length'] = strlen($data);
+		$this->debug('set Content-Length: ' . $this->outgoing_headers['Content-Length']);
+
+		// start building outgoing payload:
+		$req = "$this->request_method $this->uri HTTP/$this->protocol_version";
+		$this->debug("HTTP request: $req");
+		$this->outgoing_payload = "$req\r\n";
+
+		// loop thru headers, serializing
+		foreach($this->outgoing_headers as $k => $v){
+			$hdr = $k.': '.$v;
+			$this->debug("HTTP header: $hdr");
+			$this->outgoing_payload .= "$hdr\r\n";
+		}
+
+		// add any cookies
+		if ($cookie_str != '') {
+			$hdr = 'Cookie: '.$cookie_str;
+			$this->debug("HTTP header: $hdr");
+			$this->outgoing_payload .= "$hdr\r\n";
+		}
+
+		// header/body separator
+		$this->outgoing_payload .= "\r\n";
+		
+		// add data
+		$this->outgoing_payload .= $data;
+	}
+
+	function sendRequest($data, $cookies = NULL) {
+		// build cookie string
+		$cookie_str = $this->getCookiesForRequest($cookies, (($this->scheme == 'ssl') || ($this->scheme == 'https')));
+
+		// build payload
+		$this->buildPayload($data, $cookie_str);
+
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+		// send payload
+		if(!fputs($this->fp, $this->outgoing_payload, strlen($this->outgoing_payload))) {
+			$this->setError('couldn\'t write message data to socket');
+			$this->debug('couldn\'t write message data to socket');
+			return false;
+		}
+		$this->debug('wrote data to socket, length = ' . strlen($this->outgoing_payload));
+		return true;
+	  } else if ($this->scheme == 'https') {
+		// set payload
+		// TODO: cURL does say this should only be the verb, and in fact it
+		// turns out that the URI and HTTP version are appended to this, which
+		// some servers refuse to work with
+		//curl_setopt($this->ch, CURLOPT_CUSTOMREQUEST, $this->outgoing_payload);
+		foreach($this->outgoing_headers as $k => $v){
+			$curl_headers[] = "$k: $v";
+		}
+		if ($cookie_str != '') {
+			$curl_headers[] = 'Cookie: ' . $cookie_str;
+		}
+		curl_setopt($this->ch, CURLOPT_HTTPHEADER, $curl_headers);
+		if ($this->request_method == "POST") {
+	  		curl_setopt($this->ch, CURLOPT_POST, 1);
+	  		curl_setopt($this->ch, CURLOPT_POSTFIELDS, $data);
+	  	} else {
+	  	}
+		$this->debug('set cURL payload');
+		return true;
+	  }
+	}
+
+	function getResponse(){
+		$this->incoming_payload = '';
+	    
+	  if ($this->scheme == 'http' || $this->scheme == 'ssl') {
+	    // loop until headers have been retrieved
+	    $data = '';
+	    while (!isset($lb)){
+
+			// We might EOF during header read.
+			if(feof($this->fp)) {
+				$this->incoming_payload = $data;
+				$this->debug('found no headers before EOF after length ' . strlen($data));
+				$this->debug("received before EOF:\n" . $data);
+				$this->setError('server failed to send headers');
+				return false;
+			}
+
+			$tmp = fgets($this->fp, 256);
+			$tmplen = strlen($tmp);
+			$this->debug("read line of $tmplen bytes: " . trim($tmp));
+
+			if ($tmplen == 0) {
+				$this->incoming_payload = $data;
+				$this->debug('socket read of headers timed out after length ' . strlen($data));
+				$this->debug("read before timeout: " . $data);
+				$this->setError('socket read of headers timed out');
+				return false;
+			}
+
+			$data .= $tmp;
+			$pos = strpos($data,"\r\n\r\n");
+			if($pos > 1){
+				$lb = "\r\n";
+			} else {
+				$pos = strpos($data,"\n\n");
+				if($pos > 1){
+					$lb = "\n";
+				}
+			}
+			// remove 100 header
+			if(isset($lb) && ereg('^HTTP/1.1 100',$data)){
+				unset($lb);
+				$data = '';
+			}//
+		}
+		// store header data
+		$this->incoming_payload .= $data;
+		$this->debug('found end of headers after length ' . strlen($data));
+		// process headers
+		$header_data = trim(substr($data,0,$pos));
+		$header_array = explode($lb,$header_data);
+		$this->incoming_headers = array();
+		$this->incoming_cookies = array();
+		foreach($header_array as $header_line){
+			$arr = explode(':',$header_line, 2);
+			if(count($arr) > 1){
+				$header_name = strtolower(trim($arr[0]));
+				$this->incoming_headers[$header_name] = trim($arr[1]);
+				if ($header_name == 'set-cookie') {
+					// TODO: allow multiple cookies from parseCookie
+					$cookie = $this->parseCookie(trim($arr[1]));
+					if ($cookie) {
+						$this->incoming_cookies[] = $cookie;
+						$this->debug('found cookie: ' . $cookie['name'] . ' = ' . $cookie['value']);
+					} else {
+						$this->debug('did not find cookie in ' . trim($arr[1]));
+					}
+    			}
+			} else if (isset($header_name)) {
+				// append continuation line to previous header
+				$this->incoming_headers[$header_name] .= $lb . ' ' . $header_line;
+			}
+		}
+		
+		// loop until msg has been received
+		if (isset($this->incoming_headers['transfer-encoding']) && strtolower($this->incoming_headers['transfer-encoding']) == 'chunked') {
+			$content_length =  2147483647;	// ignore any content-length header
+			$chunked = true;
+			$this->debug("want to read chunked content");
+		} elseif (isset($this->incoming_headers['content-length'])) {
+			$content_length = $this->incoming_headers['content-length'];
+			$chunked = false;
+			$this->debug("want to read content of length $content_length");
+		} else {
+			$content_length =  2147483647;
+			$chunked = false;
+			$this->debug("want to read content to EOF");
+		}
+		$data = '';
+		do {
+			if ($chunked) {
+				$tmp = fgets($this->fp, 256);
+				$tmplen = strlen($tmp);
+				$this->debug("read chunk line of $tmplen bytes");
+				if ($tmplen == 0) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of chunk length timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of chunk length timed out');
+					return false;
+				}
+				$content_length = hexdec(trim($tmp));
+				$this->debug("chunk length $content_length");
+			}
+			$strlen = 0;
+		    while (($strlen < $content_length) && (!feof($this->fp))) {
+		    	$readlen = min(8192, $content_length - $strlen);
+				$tmp = fread($this->fp, $readlen);
+				$tmplen = strlen($tmp);
+				$this->debug("read buffer of $tmplen bytes");
+				if (($tmplen == 0) && (!feof($this->fp))) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of body timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of body timed out');
+					return false;
+				}
+				$strlen += $tmplen;
+				$data .= $tmp;
+			}
+			if ($chunked && ($content_length > 0)) {
+				$tmp = fgets($this->fp, 256);
+				$tmplen = strlen($tmp);
+				$this->debug("read chunk terminator of $tmplen bytes");
+				if ($tmplen == 0) {
+					$this->incoming_payload = $data;
+					$this->debug('socket read of chunk terminator timed out after length ' . strlen($data));
+					$this->debug("read before timeout:\n" . $data);
+					$this->setError('socket read of chunk terminator timed out');
+					return false;
+				}
+			}
+		} while ($chunked && ($content_length > 0) && (!feof($this->fp)));
+		if (feof($this->fp)) {
+			$this->debug('read to EOF');
+		}
+		$this->debug('read body of length ' . strlen($data));
+		$this->incoming_payload .= $data;
+		$this->debug('received a total of '.strlen($this->incoming_payload).' bytes of data from server');
+		
+		// close filepointer
+		if(
+			(isset($this->incoming_headers['connection']) && strtolower($this->incoming_headers['connection']) == 'close') || 
+			(! $this->persistentConnection) || feof($this->fp)){
+			fclose($this->fp);
+			$this->fp = false;
+			$this->debug('closed socket');
+		}
+		
+		// connection was closed unexpectedly
+		if($this->incoming_payload == ''){
+			$this->setError('no response from server');
+			return false;
+		}
+		
+		// decode transfer-encoding
+//		if(isset($this->incoming_headers['transfer-encoding']) && strtolower($this->incoming_headers['transfer-encoding']) == 'chunked'){
+//			if(!$data = $this->decodeChunked($data, $lb)){
+//				$this->setError('Decoding of chunked data failed');
+//				return false;
+//			}
+			//print "<pre>\nde-chunked:\n---------------\n$data\n\n---------------\n</pre>";
+			// set decoded payload
+//			$this->incoming_payload = $header_data.$lb.$lb.$data;
+//		}
+	
+	  } else if ($this->scheme == 'https') {
+		// send and receive
+		$this->debug('send and receive with cURL');
+		$this->incoming_payload = curl_exec($this->ch);
+		$data = $this->incoming_payload;
+
+        $cErr = curl_error($this->ch);
+		if ($cErr != '') {
+        	$err = 'cURL ERROR: '.curl_errno($this->ch).': '.$cErr.'<br>';
+        	// TODO: there is a PHP bug that can cause this to SEGV for CURLINFO_CONTENT_TYPE
+			foreach(curl_getinfo($this->ch) as $k => $v){
+				$err .= "$k: $v<br>";
+			}
+			$this->debug($err);
+			$this->setError($err);
+			curl_close($this->ch);
+	    	return false;
+		} else {
+			//echo '<pre>';
+			//var_dump(curl_getinfo($this->ch));
+			//echo '</pre>';
+		}
+		// close curl
+		$this->debug('No cURL error, closing cURL');
+		curl_close($this->ch);
+		
+		// remove 100 header(s)
+		while (ereg('^HTTP/1.1 100',$data)) {
+			if ($pos = strpos($data,"\r\n\r\n")) {
+				$data = ltrim(substr($data,$pos));
+			} elseif($pos = strpos($data,"\n\n") ) {
+				$data = ltrim(substr($data,$pos));
+			}
+		}
+		
+		// separate content from HTTP headers
+		if ($pos = strpos($data,"\r\n\r\n")) {
+			$lb = "\r\n";
+		} elseif( $pos = strpos($data,"\n\n")) {
+			$lb = "\n";
+		} else {
+			$this->debug('no proper separation of headers and document');
+			$this->setError('no proper separation of headers and document');
+			return false;
+		}
+		$header_data = trim(substr($data,0,$pos));
+		$header_array = explode($lb,$header_data);
+		$data = ltrim(substr($data,$pos));
+		$this->debug('found proper separation of headers and document');
+		$this->debug('cleaned data, stringlen: '.strlen($data));
+		// clean headers
+		foreach ($header_array as $header_line) {
+			$arr = explode(':',$header_line,2);
+			if(count($arr) > 1){
+				$header_name = strtolower(trim($arr[0]));
+				$this->incoming_headers[$header_name] = trim($arr[1]);
+				if ($header_name == 'set-cookie') {
+					// TODO: allow multiple cookies from parseCookie
+					$cookie = $this->parseCookie(trim($arr[1]));
+					if ($cookie) {
+						$this->incoming_cookies[] = $cookie;
+						$this->debug('found cookie: ' . $cookie['name'] . ' = ' . $cookie['value']);
+					} else {
+						$this->debug('did not find cookie in ' . trim($arr[1]));
+					}
+    			}
+			} else if (isset($header_name)) {
+				// append continuation line to previous header
+				$this->incoming_headers[$header_name] .= $lb . ' ' . $header_line;
+			}
+		}
+	  }
+
+		$arr = explode(' ', $header_array[0], 3);
+		$http_version = $arr[0];
+		$http_status = intval($arr[1]);
+		$http_reason = count($arr) > 2 ? $arr[2] : '';
+
+ 		// see if we need to resend the request with http digest authentication
+ 		if (isset($this->incoming_headers['location']) && $http_status == 301) {
+ 			$this->debug("Got 301 $http_reason with Location: " . $this->incoming_headers['location']);
+ 			$this->setURL($this->incoming_headers['location']);
+			$this->tryagain = true;
+			return false;
+		}
+
+ 		// see if we need to resend the request with http digest authentication
+ 		if (isset($this->incoming_headers['www-authenticate']) && $http_status == 401) {
+ 			$this->debug("Got 401 $http_reason with WWW-Authenticate: " . $this->incoming_headers['www-authenticate']);
+ 			if (strstr($this->incoming_headers['www-authenticate'], "Digest ")) {
+ 				$this->debug('Server wants digest authentication');
+ 				// remove "Digest " from our elements
+ 				$digestString = str_replace('Digest ', '', $this->incoming_headers['www-authenticate']);
+ 				
+ 				// parse elements into array
+ 				$digestElements = explode(',', $digestString);
+ 				foreach ($digestElements as $val) {
+ 					$tempElement = explode('=', trim($val), 2);
+ 					$digestRequest[$tempElement[0]] = str_replace("\"", '', $tempElement[1]);
+ 				}
+
+				// should have (at least) qop, realm, nonce
+ 				if (isset($digestRequest['nonce'])) {
+ 					$this->setCredentials($this->username, $this->password, 'digest', $digestRequest);
+ 					$this->tryagain = true;
+ 					return false;
+ 				}
+ 			}
+			$this->debug('HTTP authentication failed');
+			$this->setError('HTTP authentication failed');
+			return false;
+ 		}
+		
+		if (
+			($http_status >= 300 && $http_status <= 307) ||
+			($http_status >= 400 && $http_status <= 417) ||
+			($http_status >= 501 && $http_status <= 505)
+		   ) {
+			$this->setError("Unsupported HTTP response status $http_status $http_reason (soapclient->response has contents of the response)");
+			return false;
+		}
+
+		// decode content-encoding
+		if(isset($this->incoming_headers['content-encoding']) && $this->incoming_headers['content-encoding'] != ''){
+			if(strtolower($this->incoming_headers['content-encoding']) == 'deflate' || strtolower($this->incoming_headers['content-encoding']) == 'gzip'){
+    			// if decoding works, use it. else assume data wasn't gzencoded
+    			if(function_exists('gzinflate')){
+					//$timer->setMarker('starting decoding of gzip/deflated content');
+					// IIS 5 requires gzinflate instead of gzuncompress (similar to IE 5 and gzdeflate v. gzcompress)
+					// this means there are no Zlib headers, although there should be
+					$this->debug('The gzinflate function exists');
+					$datalen = strlen($data);
+					if ($this->incoming_headers['content-encoding'] == 'deflate') {
+						if ($degzdata = @gzinflate($data)) {
+	    					$data = $degzdata;
+	    					$this->debug('The payload has been inflated to ' . strlen($data) . ' bytes');
+	    					if (strlen($data) < $datalen) {
+	    						// test for the case that the payload has been compressed twice
+		    					$this->debug('The inflated payload is smaller than the gzipped one; try again');
+								if ($degzdata = @gzinflate($data)) {
+			    					$data = $degzdata;
+			    					$this->debug('The payload has been inflated again to ' . strlen($data) . ' bytes');
+								}
+	    					}
+	    				} else {
+	    					$this->debug('Error using gzinflate to inflate the payload');
+	    					$this->setError('Error using gzinflate to inflate the payload');
+	    				}
+					} elseif ($this->incoming_headers['content-encoding'] == 'gzip') {
+						if ($degzdata = @gzinflate(substr($data, 10))) {	// do our best
+							$data = $degzdata;
+	    					$this->debug('The payload has been un-gzipped to ' . strlen($data) . ' bytes');
+	    					if (strlen($data) < $datalen) {
+	    						// test for the case that the payload has been compressed twice
+		    					$this->debug('The un-gzipped payload is smaller than the gzipped one; try again');
+								if ($degzdata = @gzinflate(substr($data, 10))) {
+			    					$data = $degzdata;
+			    					$this->debug('The payload has been un-gzipped again to ' . strlen($data) . ' bytes');
+								}
+	    					}
+	    				} else {
+	    					$this->debug('Error using gzinflate to un-gzip the payload');
+							$this->setError('Error using gzinflate to un-gzip the payload');
+	    				}
+					}
+					//$timer->setMarker('finished decoding of gzip/deflated content');
+					//print "<xmp>\nde-inflated:\n---------------\n$data\n-------------\n</xmp>";
+					// set decoded payload
+					$this->incoming_payload = $header_data.$lb.$lb.$data;
+    			} else {
+					$this->debug('The server sent compressed data. Your php install must have the Zlib extension compiled in to support this.');
+					$this->setError('The server sent compressed data. Your php install must have the Zlib extension compiled in to support this.');
+				}
+			} else {
+				$this->debug('Unsupported Content-Encoding ' . $this->incoming_headers['content-encoding']);
+				$this->setError('Unsupported Content-Encoding ' . $this->incoming_headers['content-encoding']);
+			}
+		} else {
+			$this->debug('No Content-Encoding header');
+		}
+		
+		if(strlen($data) == 0){
+			$this->debug('no data after headers!');
+			$this->setError('no data present after HTTP headers');
+			return false;
+		}
+		
+		return $data;
+	}
+
+	function setContentType($type, $charset = false) {
+		$this->outgoing_headers['Content-Type'] = $type . ($charset ? '; charset=' . $charset : '');
+		$this->debug('set Content-Type: ' . $this->outgoing_headers['Content-Type']);
+	}
+
+	function usePersistentConnection(){
+		if (isset($this->outgoing_headers['Accept-Encoding'])) {
+			return false;
+		}
+		$this->protocol_version = '1.1';
+		$this->persistentConnection = true;
+		$this->outgoing_headers['Connection'] = 'Keep-Alive';
+		$this->debug('set Connection: ' . $this->outgoing_headers['Connection']);
+		return true;
+	}
+
+	/**
+	 * parse an incoming Cookie into it's parts
+	 *
+	 * @param	string $cookie_str content of cookie
+	 * @return	array with data of that cookie
+	 * @access	private
+	 */
+	/*
+	 * TODO: allow a Set-Cookie string to be parsed into multiple cookies
+	 */
+	function parseCookie($cookie_str) {
+		$cookie_str = str_replace('; ', ';', $cookie_str) . ';';
+		$data = split(';', $cookie_str);
+		$value_str = $data[0];
+
+		$cookie_param = 'domain=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ($start > 0) {
+			$domain = substr($cookie_str, $start + strlen($cookie_param));
+			$domain = substr($domain, 0, strpos($domain, ';'));
+		} else {
+			$domain = '';
+		}
+
+		$cookie_param = 'expires=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ($start > 0) {
+			$expires = substr($cookie_str, $start + strlen($cookie_param));
+			$expires = substr($expires, 0, strpos($expires, ';'));
+		} else {
+			$expires = '';
+		}
+
+		$cookie_param = 'path=';
+		$start = strpos($cookie_str, $cookie_param);
+		if ( $start > 0 ) {
+			$path = substr($cookie_str, $start + strlen($cookie_param));
+			$path = substr($path, 0, strpos($path, ';'));
+		} else {
+			$path = '/';
+		}
+						
+		$cookie_param = ';secure;';
+		if (strpos($cookie_str, $cookie_param) !== FALSE) {
+			$secure = true;
+		} else {
+			$secure = false;
+		}
+
+		$sep_pos = strpos($value_str, '=');
+
+		if ($sep_pos) {
+			$name = substr($value_str, 0, $sep_pos);
+			$value = substr($value_str, $sep_pos + 1);
+			$cookie= array(	'name' => $name,
+			                'value' => $value,
+							'domain' => $domain,
+							'path' => $path,
+							'expires' => $expires,
+							'secure' => $secure
+							);		
+			return $cookie;
+		}
+		return false;
+	}
+  
+	/**
+	 * sort out cookies for the current request
+	 *
+	 * @param	array $cookies array with all cookies
+	 * @param	boolean $secure is the send-content secure or not?
+	 * @return	string for Cookie-HTTP-Header
+	 * @access	private
+	 */
+	function getCookiesForRequest($cookies, $secure=false) {
+		$cookie_str = '';
+		if ((! is_null($cookies)) && (is_array($cookies))) {
+			foreach ($cookies as $cookie) {
+				if (! is_array($cookie)) {
+					continue;
+				}
+	    		$this->debug("check cookie for validity: ".$cookie['name'].'='.$cookie['value']);
+				if ((isset($cookie['expires'])) && (! empty($cookie['expires']))) {
+					if (strtotime($cookie['expires']) <= time()) {
+						$this->debug('cookie has expired');
+						continue;
+					}
+				}
+				if ((isset($cookie['domain'])) && (! empty($cookie['domain']))) {
+					$domain = preg_quote($cookie['domain']);
+					if (! preg_match("'.*$domain$'i", $this->host)) {
+						$this->debug('cookie has different domain');
+						continue;
+					}
+				}
+				if ((isset($cookie['path'])) && (! empty($cookie['path']))) {
+					$path = preg_quote($cookie['path']);
+					if (! preg_match("'^$path.*'i", $this->path)) {
+						$this->debug('cookie is for a different path');
+						continue;
+					}
+				}
+				if ((! $secure) && (isset($cookie['secure'])) && ($cookie['secure'])) {
+					$this->debug('cookie is secure, transport is not');
+					continue;
+				}
+				$cookie_str .= $cookie['name'] . '=' . $cookie['value'] . '; ';
+	    		$this->debug('add cookie to Cookie-String: ' . $cookie['name'] . '=' . $cookie['value']);
+			}
+		}
+		return $cookie_str;
+  }
+}
+
+?><?php
+
+
+
+/**
+*
+* soap_server allows the user to create a SOAP server
+* that is capable of receiving messages and returning responses
+*
+* NOTE: WSDL functionality is experimental
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soap_server extends nusoap_base {
+	/**
+	 * HTTP headers of request
+	 * @var array
+	 * @access private
+	 */
+	var $headers = array();
+	/**
+	 * HTTP request
+	 * @var string
+	 * @access private
+	 */
+	var $request = '';
+	/**
+	 * SOAP headers from request (incomplete namespace resolution; special characters not escaped) (text)
+	 * @var string
+	 * @access public
+	 */
+	var $requestHeaders = '';
+	/**
+	 * SOAP body request portion (incomplete namespace resolution; special characters not escaped) (text)
+	 * @var string
+	 * @access public
+	 */
+	var $document = '';
+	/**
+	 * SOAP payload for request (text)
+	 * @var string
+	 * @access public
+	 */
+	var $requestSOAP = '';
+	/**
+	 * requested method namespace URI
+	 * @var string
+	 * @access private
+	 */
+	var $methodURI = '';
+	/**
+	 * name of method requested
+	 * @var string
+	 * @access private
+	 */
+	var $methodname = '';
+	/**
+	 * method parameters from request
+	 * @var array
+	 * @access private
+	 */
+	var $methodparams = array();
+	/**
+	 * SOAP Action from request
+	 * @var string
+	 * @access private
+	 */
+	var $SOAPAction = '';
+	/**
+	 * character set encoding of incoming (request) messages
+	 * @var string
+	 * @access public
+	 */
+	var $xml_encoding = '';
+	/**
+	 * toggles whether the parser decodes element content w/ utf8_decode()
+	 * @var boolean
+	 * @access public
+	 */
+    var $decode_utf8 = true;
+
+	/**
+	 * HTTP headers of response
+	 * @var array
+	 * @access public
+	 */
+	var $outgoing_headers = array();
+	/**
+	 * HTTP response
+	 * @var string
+	 * @access private
+	 */
+	var $response = '';
+	/**
+	 * SOAP headers for response (text)
+	 * @var string
+	 * @access public
+	 */
+	var $responseHeaders = '';
+	/**
+	 * SOAP payload for response (text)
+	 * @var string
+	 * @access private
+	 */
+	var $responseSOAP = '';
+	/**
+	 * method return value to place in response
+	 * @var mixed
+	 * @access private
+	 */
+	var $methodreturn = false;
+	/**
+	 * whether $methodreturn is a string of literal XML
+	 * @var boolean
+	 * @access public
+	 */
+	var $methodreturnisliteralxml = false;
+	/**
+	 * SOAP fault for response (or false)
+	 * @var mixed
+	 * @access private
+	 */
+	var $fault = false;
+	/**
+	 * text indication of result (for debugging)
+	 * @var string
+	 * @access private
+	 */
+	var $result = 'successful';
+
+	/**
+	 * assoc array of operations => opData; operations are added by the register()
+	 * method or by parsing an external WSDL definition
+	 * @var array
+	 * @access private
+	 */
+	var $operations = array();
+	/**
+	 * wsdl instance (if one)
+	 * @var mixed
+	 * @access private
+	 */
+	var $wsdl = false;
+	/**
+	 * URL for WSDL (if one)
+	 * @var mixed
+	 * @access private
+	 */
+	var $externalWSDLURL = false;
+	/**
+	 * whether to append debug to response as XML comment
+	 * @var boolean
+	 * @access public
+	 */
+	var $debug_flag = false;
+
+
+	/**
+	* constructor
+    * the optional parameter is a path to a WSDL file that you'd like to bind the server instance to.
+	*
+    * @param mixed $wsdl file path or URL (string), or wsdl instance (object)
+	* @access   public
+	*/
+	function soap_server($wsdl=false){
+		parent::nusoap_base();
+		// turn on debugging?
+		global $debug;
+		global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$this->debug("_SERVER is defined:");
+			$this->appendDebug($this->varDump($_SERVER));
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$this->debug("HTTP_SERVER_VARS is defined:");
+			$this->appendDebug($this->varDump($HTTP_SERVER_VARS));
+		} else {
+			$this->debug("Neither _SERVER nor HTTP_SERVER_VARS is defined.");
+		}
+
+		if (isset($debug)) {
+			$this->debug("In soap_server, set debug_flag=$debug based on global flag");
+			$this->debug_flag = $debug;
+		} elseif (isset($_SERVER['QUERY_STRING'])) {
+			$qs = explode('&', $_SERVER['QUERY_STRING']);
+			foreach ($qs as $v) {
+				if (substr($v, 0, 6) == 'debug=') {
+					$this->debug("In soap_server, set debug_flag=" . substr($v, 6) . " based on query string #1");
+					$this->debug_flag = substr($v, 6);
+				}
+			}
+		} elseif (isset($HTTP_SERVER_VARS['QUERY_STRING'])) {
+			$qs = explode('&', $HTTP_SERVER_VARS['QUERY_STRING']);
+			foreach ($qs as $v) {
+				if (substr($v, 0, 6) == 'debug=') {
+					$this->debug("In soap_server, set debug_flag=" . substr($v, 6) . " based on query string #2");
+					$this->debug_flag = substr($v, 6);
+				}
+			}
+		}
+
+		// wsdl
+		if($wsdl){
+			$this->debug("In soap_server, WSDL is specified");
+			if (is_object($wsdl) && (get_class($wsdl) == 'wsdl')) {
+				$this->wsdl = $wsdl;
+				$this->externalWSDLURL = $this->wsdl->wsdl;
+				$this->debug('Use existing wsdl instance from ' . $this->externalWSDLURL);
+			} else {
+				$this->debug('Create wsdl from ' . $wsdl);
+				$this->wsdl = new wsdl($wsdl);
+				$this->externalWSDLURL = $wsdl;
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			if($err = $this->wsdl->getError()){
+				die('WSDL ERROR: '.$err);
+			}
+		}
+	}
+
+	/**
+	* processes request and returns response
+	*
+	* @param    string $data usually is the value of $HTTP_RAW_POST_DATA
+	* @access   public
+	*/
+	function service($data){
+		global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER['QUERY_STRING'])) {
+			$qs = $_SERVER['QUERY_STRING'];
+		} elseif (isset($HTTP_SERVER_VARS['QUERY_STRING'])) {
+			$qs = $HTTP_SERVER_VARS['QUERY_STRING'];
+		} else {
+			$qs = '';
+		}
+		$this->debug("In service, query string=$qs");
+
+		if (ereg('wsdl', $qs) ){
+			$this->debug("In service, this is a request for WSDL");
+			if($this->externalWSDLURL){
+              if (strpos($this->externalWSDLURL,"://")!==false) { // assume URL
+				header('Location: '.$this->externalWSDLURL);
+              } else { // assume file
+                header("Content-Type: text/xml\r\n");
+                $fp = fopen($this->externalWSDLURL, 'r');
+                fpassthru($fp);
+              }
+			} elseif ($this->wsdl) {
+				header("Content-Type: text/xml; charset=ISO-8859-1\r\n");
+				print $this->wsdl->serialize($this->debug_flag);
+				if ($this->debug_flag) {
+					$this->debug('wsdl:');
+					$this->appendDebug($this->varDump($this->wsdl));
+					print $this->getDebugAsXMLComment();
+				}
+			} else {
+				header("Content-Type: text/html; charset=ISO-8859-1\r\n");
+				print "This service does not provide WSDL";
+			}
+		} elseif ($data == '' && $this->wsdl) {
+			$this->debug("In service, there is no data, so return Web description");
+			print $this->wsdl->webDescription();
+		} else {
+			$this->debug("In service, invoke the request");
+			$this->parse_request($data);
+			if (! $this->fault) {
+				$this->invoke_method();
+			}
+			if (! $this->fault) {
+				$this->serialize_return();
+			}
+			$this->send_response();
+		}
+	}
+
+	/**
+	* parses HTTP request headers.
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* headers
+	* request
+	* xml_encoding
+	* SOAPAction
+	*
+	* @access   private
+	*/
+	function parse_http_headers() {
+		global $HTTP_SERVER_VARS;
+
+		$this->request = '';
+		$this->SOAPAction = '';
+		if(function_exists('getallheaders')){
+			$this->debug("In parse_http_headers, use getallheaders");
+			$headers = getallheaders();
+			foreach($headers as $k=>$v){
+				$k = strtolower($k);
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+			// get SOAPAction header
+			if(isset($this->headers['soapaction'])){
+				$this->SOAPAction = str_replace('"','',$this->headers['soapaction']);
+			}
+			// get the character encoding of the incoming request
+			if(isset($this->headers['content-type']) && strpos($this->headers['content-type'],'=')){
+				$enc = str_replace('"','',substr(strstr($this->headers["content-type"],'='),1));
+				if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+					$this->xml_encoding = strtoupper($enc);
+				} else {
+					$this->xml_encoding = 'US-ASCII';
+				}
+			} else {
+				// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+				$this->xml_encoding = 'ISO-8859-1';
+			}
+		} elseif(isset($_SERVER) && is_array($_SERVER)){
+			$this->debug("In parse_http_headers, use _SERVER");
+			foreach ($_SERVER as $k => $v) {
+				if (substr($k, 0, 5) == 'HTTP_') {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', substr($k, 5)))); 	                                         $k = strtolower(substr($k, 5));
+				} else {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', $k))); 	                                         $k = strtolower($k);
+				}
+				if ($k == 'soapaction') {
+					// get SOAPAction header
+					$k = 'SOAPAction';
+					$v = str_replace('"', '', $v);
+					$v = str_replace('\\', '', $v);
+					$this->SOAPAction = $v;
+				} else if ($k == 'content-type') {
+					// get the character encoding of the incoming request
+					if (strpos($v, '=')) {
+						$enc = substr(strstr($v, '='), 1);
+						$enc = str_replace('"', '', $enc);
+						$enc = str_replace('\\', '', $enc);
+						if (eregi('^(ISO-8859-1|US-ASCII|UTF-8)$', $enc)) {
+							$this->xml_encoding = strtoupper($enc);
+						} else {
+							$this->xml_encoding = 'US-ASCII';
+						}
+					} else {
+						// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+						$this->xml_encoding = 'ISO-8859-1';
+					}
+				}
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+		} elseif (is_array($HTTP_SERVER_VARS)) {
+			$this->debug("In parse_http_headers, use HTTP_SERVER_VARS");
+			foreach ($HTTP_SERVER_VARS as $k => $v) {
+				if (substr($k, 0, 5) == 'HTTP_') {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', substr($k, 5)))); 	                                         $k = strtolower(substr($k, 5));
+				} else {
+					$k = str_replace(' ', '-', strtolower(str_replace('_', ' ', $k))); 	                                         $k = strtolower($k);
+				}
+				if ($k == 'soapaction') {
+					// get SOAPAction header
+					$k = 'SOAPAction';
+					$v = str_replace('"', '', $v);
+					$v = str_replace('\\', '', $v);
+					$this->SOAPAction = $v;
+				} else if ($k == 'content-type') {
+					// get the character encoding of the incoming request
+					if (strpos($v, '=')) {
+						$enc = substr(strstr($v, '='), 1);
+						$enc = str_replace('"', '', $enc);
+						$enc = str_replace('\\', '', $enc);
+						if (eregi('^(ISO-8859-1|US-ASCII|UTF-8)$', $enc)) {
+							$this->xml_encoding = strtoupper($enc);
+						} else {
+							$this->xml_encoding = 'US-ASCII';
+						}
+					} else {
+						// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+						$this->xml_encoding = 'ISO-8859-1';
+					}
+				}
+				$this->headers[$k] = $v;
+				$this->request .= "$k: $v\r\n";
+				$this->debug("$k: $v");
+			}
+		} else {
+			$this->debug("In parse_http_headers, HTTP headers not accessible");
+			$this->setError("HTTP headers not accessible");
+		}
+	}
+
+	/**
+	* parses a request
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* headers
+	* request
+	* xml_encoding
+	* SOAPAction
+	* request
+	* requestSOAP
+	* methodURI
+	* methodname
+	* methodparams
+	* requestHeaders
+	* document
+	*
+	* This sets the fault field on error
+	*
+	* @param    string $data XML string
+	* @access   private
+	*/
+	function parse_request($data='') {
+		$this->debug('entering parse_request()');
+		$this->parse_http_headers();
+		$this->debug('got character encoding: '.$this->xml_encoding);
+		// uncompress if necessary
+		if (isset($this->headers['content-encoding']) && $this->headers['content-encoding'] != '') {
+			$this->debug('got content encoding: ' . $this->headers['content-encoding']);
+			if ($this->headers['content-encoding'] == 'deflate' || $this->headers['content-encoding'] == 'gzip') {
+		    	// if decoding works, use it. else assume data wasn't gzencoded
+				if (function_exists('gzuncompress')) {
+					if ($this->headers['content-encoding'] == 'deflate' && $degzdata = @gzuncompress($data)) {
+						$data = $degzdata;
+					} elseif ($this->headers['content-encoding'] == 'gzip' && $degzdata = gzinflate(substr($data, 10))) {
+						$data = $degzdata;
+					} else {
+						$this->fault('Client', 'Errors occurred when trying to decode the data');
+						return;
+					}
+				} else {
+					$this->fault('Client', 'This Server does not support compressed data');
+					return;
+				}
+			}
+		}
+		$this->request .= "\r\n".$data;
+		$data = $this->parseRequest($this->headers, $data);
+		$this->requestSOAP = $data;
+		$this->debug('leaving parse_request');
+	}
+
+	/**
+	* invokes a PHP function for the requested SOAP method
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* methodreturn
+	*
+	* Note that the PHP function that is called may also set the following
+	* fields to affect the response sent to the client
+	*
+	* responseHeaders
+	* outgoing_headers
+	*
+	* This sets the fault field on error
+	*
+	* @access   private
+	*/
+	function invoke_method() {
+		$this->debug('in invoke_method, methodname=' . $this->methodname . ' methodURI=' . $this->methodURI . ' SOAPAction=' . $this->SOAPAction);
+
+		if ($this->wsdl) {
+			if ($this->opData = $this->wsdl->getOperationData($this->methodname)) {
+				$this->debug('in invoke_method, found WSDL operation=' . $this->methodname);
+				$this->appendDebug('opData=' . $this->varDump($this->opData));
+			} elseif ($this->opData = $this->wsdl->getOperationDataForSoapAction($this->SOAPAction)) {
+				// Note: hopefully this case will only be used for doc/lit, since rpc services should have wrapper element
+				$this->debug('in invoke_method, found WSDL soapAction=' . $this->SOAPAction . ' for operation=' . $this->opData['name']);
+				$this->appendDebug('opData=' . $this->varDump($this->opData));
+				$this->methodname = $this->opData['name'];
+			} else {
+				$this->debug('in invoke_method, no WSDL for operation=' . $this->methodname);
+				$this->fault('Client', "Operation '" . $this->methodname . "' is not defined in the WSDL for this service");
+				return;
+			}
+		} else {
+			$this->debug('in invoke_method, no WSDL to validate method');
+		}
+
+		// if a . is present in $this->methodname, we see if there is a class in scope,
+		// which could be referred to. We will also distinguish between two deliminators,
+		// to allow methods to be called a the class or an instance
+		$class = '';
+		$method = '';
+		if (strpos($this->methodname, '..') > 0) {
+			$delim = '..';
+		} else if (strpos($this->methodname, '.') > 0) {
+			$delim = '.';
+		} else {
+			$delim = '';
+		}
+
+		if (strlen($delim) > 0 && substr_count($this->methodname, $delim) == 1 &&
+			class_exists(substr($this->methodname, 0, strpos($this->methodname, $delim)))) {
+			// get the class and method name
+			$class = substr($this->methodname, 0, strpos($this->methodname, $delim));
+			$method = substr($this->methodname, strpos($this->methodname, $delim) + strlen($delim));
+			$this->debug("in invoke_method, class=$class method=$method delim=$delim");
+		}
+
+		// does method exist?
+		if ($class == '') {
+			if (!function_exists($this->methodname)) {
+				$this->debug("in invoke_method, function '$this->methodname' not found!");
+				$this->result = 'fault: method not found';
+				$this->fault('Client',"method '$this->methodname' not defined in service");
+				return;
+			}
+		} else {
+			$method_to_compare = (substr(phpversion(), 0, 2) == '4.') ? strtolower($method) : $method;
+			if (!in_array($method_to_compare, get_class_methods($class))) {
+				$this->debug("in invoke_method, method '$this->methodname' not found in class '$class'!");
+				$this->result = 'fault: method not found';
+				$this->fault('Client',"method '$this->methodname' not defined in service");
+				return;
+			}
+		}
+
+		// evaluate message, getting back parameters
+		// verify that request parameters match the method's signature
+		if(! $this->verify_method($this->methodname,$this->methodparams)){
+			// debug
+			$this->debug('ERROR: request not verified against method signature');
+			$this->result = 'fault: request failed validation against method signature';
+			// return fault
+			$this->fault('Client',"Operation '$this->methodname' not defined in service.");
+			return;
+		}
+
+		// if there are parameters to pass
+		$this->debug('in invoke_method, params:');
+		$this->appendDebug($this->varDump($this->methodparams));
+		$this->debug("in invoke_method, calling '$this->methodname'");
+		if (!function_exists('call_user_func_array')) {
+			if ($class == '') {
+				$this->debug('in invoke_method, calling function using eval()');
+				$funcCall = "\$this->methodreturn = $this->methodname(";
+			} else {
+				if ($delim == '..') {
+					$this->debug('in invoke_method, calling class method using eval()');
+					$funcCall = "\$this->methodreturn = ".$class."::".$method."(";
+				} else {
+					$this->debug('in invoke_method, calling instance method using eval()');
+					// generate unique instance name
+					$instname = "\$inst_".time();
+					$funcCall = $instname." = new ".$class."(); ";
+					$funcCall .= "\$this->methodreturn = ".$instname."->".$method."(";
+				}
+			}
+			if ($this->methodparams) {
+				foreach ($this->methodparams as $param) {
+					if (is_array($param)) {
+						$this->fault('Client', 'NuSOAP does not handle complexType parameters correctly when using eval; call_user_func_array must be available');
+						return;
+					}
+					$funcCall .= "\"$param\",";
+				}
+				$funcCall = substr($funcCall, 0, -1);
+			}
+			$funcCall .= ');';
+			$this->debug('in invoke_method, function call: '.$funcCall);
+			@eval($funcCall);
+		} else {
+			if ($class == '') {
+				$this->debug('in invoke_method, calling function using call_user_func_array()');
+				$call_arg = "$this->methodname";	// straight assignment changes $this->methodname to lower case after call_user_func_array()
+			} elseif ($delim == '..') {
+				$this->debug('in invoke_method, calling class method using call_user_func_array()');
+				$call_arg = array ($class, $method);
+			} else {
+				$this->debug('in invoke_method, calling instance method using call_user_func_array()');
+				$instance = new $class ();
+				$call_arg = array(&$instance, $method);
+			}
+			$this->methodreturn = call_user_func_array($call_arg, $this->methodparams);
+		}
+        $this->debug('in invoke_method, methodreturn:');
+        $this->appendDebug($this->varDump($this->methodreturn));
+		$this->debug("in invoke_method, called method $this->methodname, received $this->methodreturn of type ".gettype($this->methodreturn));
+	}
+
+	/**
+	* serializes the return value from a PHP function into a full SOAP Envelope
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* responseSOAP
+	*
+	* This sets the fault field on error
+	*
+	* @access   private
+	*/
+	function serialize_return() {
+		$this->debug('Entering serialize_return methodname: ' . $this->methodname . ' methodURI: ' . $this->methodURI);
+		// if fault
+		if (isset($this->methodreturn) && (get_class($this->methodreturn) == 'soap_fault')) {
+			$this->debug('got a fault object from method');
+			$this->fault = $this->methodreturn;
+			return;
+		} elseif ($this->methodreturnisliteralxml) {
+			$return_val = $this->methodreturn;
+		// returned value(s)
+		} else {
+			$this->debug('got a(n) '.gettype($this->methodreturn).' from method');
+			$this->debug('serializing return value');
+			if($this->wsdl){
+				// weak attempt at supporting multiple output params
+				if(sizeof($this->opData['output']['parts']) > 1){
+			    	$opParams = $this->methodreturn;
+			    } else {
+			    	// TODO: is this really necessary?
+			    	$opParams = array($this->methodreturn);
+			    }
+			    $return_val = $this->wsdl->serializeRPCParameters($this->methodname,'output',$opParams);
+			    $this->appendDebug($this->wsdl->getDebug());
+			    $this->wsdl->clearDebug();
+				if($errstr = $this->wsdl->getError()){
+					$this->debug('got wsdl error: '.$errstr);
+					$this->fault('Server', 'unable to serialize result');
+					return;
+				}
+			} else {
+				if (isset($this->methodreturn)) {
+					$return_val = $this->serialize_val($this->methodreturn, 'return');
+				} else {
+					$return_val = '';
+					$this->debug('in absence of WSDL, assume void return for backward compatibility');
+				}
+			}
+		}
+		$this->debug('return value:');
+		$this->appendDebug($this->varDump($return_val));
+
+		$this->debug('serializing response');
+		if ($this->wsdl) {
+			$this->debug('have WSDL for serialization: style is ' . $this->opData['style']);
+			if ($this->opData['style'] == 'rpc') {
+				$this->debug('style is rpc for serialization: use is ' . $this->opData['output']['use']);
+				if ($this->opData['output']['use'] == 'literal') {
+					$payload = '<'.$this->methodname.'Response xmlns="'.$this->methodURI.'">'.$return_val.'</'.$this->methodname."Response>";
+				} else {
+					$payload = '<ns1:'.$this->methodname.'Response xmlns:ns1="'.$this->methodURI.'">'.$return_val.'</ns1:'.$this->methodname."Response>";
+				}
+			} else {
+				$this->debug('style is not rpc for serialization: assume document');
+				$payload = $return_val;
+			}
+		} else {
+			$this->debug('do not have WSDL for serialization: assume rpc/encoded');
+			$payload = '<ns1:'.$this->methodname.'Response xmlns:ns1="'.$this->methodURI.'">'.$return_val.'</ns1:'.$this->methodname."Response>";
+		}
+		$this->result = 'successful';
+		if($this->wsdl){
+			//if($this->debug_flag){
+            	$this->appendDebug($this->wsdl->getDebug());
+            //	}
+			if (isset($opData['output']['encodingStyle'])) {
+				$encodingStyle = $opData['output']['encodingStyle'];
+			} else {
+				$encodingStyle = '';
+			}
+			// Added: In case we use a WSDL, return a serialized env. WITH the usedNamespaces.
+			$this->responseSOAP = $this->serializeEnvelope($payload,$this->responseHeaders,$this->wsdl->usedNamespaces,$this->opData['style'],$encodingStyle);
+		} else {
+			$this->responseSOAP = $this->serializeEnvelope($payload,$this->responseHeaders);
+		}
+		$this->debug("Leaving serialize_return");
+	}
+
+	/**
+	* sends an HTTP response
+	*
+	* The following fields are set by this function (when successful)
+	*
+	* outgoing_headers
+	* response
+	*
+	* @access   private
+	*/
+	function send_response() {
+		$this->debug('Enter send_response');
+		if ($this->fault) {
+			$payload = $this->fault->serialize();
+			$this->outgoing_headers[] = "HTTP/1.0 500 Internal Server Error";
+			$this->outgoing_headers[] = "Status: 500 Internal Server Error";
+		} else {
+			$payload = $this->responseSOAP;
+			// Some combinations of PHP+Web server allow the Status
+			// to come through as a header.  Since OK is the default
+			// just do nothing.
+			// $this->outgoing_headers[] = "HTTP/1.0 200 OK";
+			// $this->outgoing_headers[] = "Status: 200 OK";
+		}
+        // add debug data if in debug mode
+		if(isset($this->debug_flag) && $this->debug_flag){
+        	$payload .= $this->getDebugAsXMLComment();
+        }
+		$this->outgoing_headers[] = "Server: $this->title Server v$this->version";
+		ereg('\$Revisio' . 'n: ([^ ]+)', $this->revision, $rev);
+		$this->outgoing_headers[] = "X-SOAP-Server: $this->title/$this->version (".$rev[1].")";
+		// Let the Web server decide about this
+		//$this->outgoing_headers[] = "Connection: Close\r\n";
+		$payload = $this->getHTTPBody($payload);
+		$type = $this->getHTTPContentType();
+		$charset = $this->getHTTPContentTypeCharset();
+		$this->outgoing_headers[] = "Content-Type: $type" . ($charset ? '; charset=' . $charset : '');
+		//begin code to compress payload - by John
+		// NOTE: there is no way to know whether the Web server will also compress
+		// this data.
+		if (strlen($payload) > 1024 && isset($this->headers) && isset($this->headers['accept-encoding'])) {	
+			if (strstr($this->headers['accept-encoding'], 'gzip')) {
+				if (function_exists('gzencode')) {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content being gzipped -->";
+					}
+					$this->outgoing_headers[] = "Content-Encoding: gzip";
+					$payload = gzencode($payload);
+				} else {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content will not be gzipped: no gzencode -->";
+					}
+				}
+			} elseif (strstr($this->headers['accept-encoding'], 'deflate')) {
+				// Note: MSIE requires gzdeflate output (no Zlib header and checksum),
+				// instead of gzcompress output,
+				// which conflicts with HTTP 1.1 spec (http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.5)
+				if (function_exists('gzdeflate')) {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content being deflated -->";
+					}
+					$this->outgoing_headers[] = "Content-Encoding: deflate";
+					$payload = gzdeflate($payload);
+				} else {
+					if (isset($this->debug_flag) && $this->debug_flag) {
+						$payload .= "<!-- Content will not be deflated: no gzcompress -->";
+					}
+				}
+			}
+		}
+		//end code
+		$this->outgoing_headers[] = "Content-Length: ".strlen($payload);
+		reset($this->outgoing_headers);
+		foreach($this->outgoing_headers as $hdr){
+			header($hdr, false);
+		}
+		print $payload;
+		$this->response = join("\r\n",$this->outgoing_headers)."\r\n\r\n".$payload;
+	}
+
+	/**
+	* takes the value that was created by parsing the request
+	* and compares to the method's signature, if available.
+	*
+	* @param	string	$operation	The operation to be invoked
+	* @param	array	$request	The array of parameter values
+	* @return	boolean	Whether the operation was found
+	* @access   private
+	*/
+	function verify_method($operation,$request){
+		if(isset($this->wsdl) && is_object($this->wsdl)){
+			if($this->wsdl->getOperationData($operation)){
+				return true;
+			}
+	    } elseif(isset($this->operations[$operation])){
+			return true;
+		}
+		return false;
+	}
+
+	/**
+	* processes SOAP message received from client
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed request data from client
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseRequest($headers, $data) {
+		$this->debug('Entering parseRequest() for data of length ' . strlen($data) . ' and type ' . $headers['content-type']);
+		if (!strstr($headers['content-type'], 'text/xml')) {
+			$this->setError('Request not of type text/xml');
+			return false;
+		}
+		if (strpos($headers['content-type'], '=')) {
+			$enc = str_replace('"', '', substr(strstr($headers["content-type"], '='), 1));
+			$this->debug('Got response encoding: ' . $enc);
+			if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+				$this->xml_encoding = strtoupper($enc);
+			} else {
+				$this->xml_encoding = 'US-ASCII';
+			}
+		} else {
+			// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+			$this->xml_encoding = 'ISO-8859-1';
+		}
+		$this->debug('Use encoding: ' . $this->xml_encoding . ' when creating soap_parser');
+		// parse response, get soap parser obj
+		$parser = new soap_parser($data,$this->xml_encoding,'',$this->decode_utf8);
+		// parser debug
+		$this->debug("parser debug: \n".$parser->getDebug());
+		// if fault occurred during message parsing
+		if($err = $parser->getError()){
+			$this->result = 'fault: error in msg parsing: '.$err;
+			$this->fault('Client',"error in msg parsing:\n".$err);
+		// else successfully parsed request into soapval object
+		} else {
+			// get/set methodname
+			$this->methodURI = $parser->root_struct_namespace;
+			$this->methodname = $parser->root_struct_name;
+			$this->debug('methodname: '.$this->methodname.' methodURI: '.$this->methodURI);
+			$this->debug('calling parser->get_response()');
+			$this->methodparams = $parser->get_response();
+			// get SOAP headers
+			$this->requestHeaders = $parser->getHeaders();
+            // add document for doclit support
+            $this->document = $parser->document;
+		}
+	 }
+
+	/**
+	* gets the HTTP body for the current response.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		return $soapmsg;
+	}
+	
+	/**
+	* gets the HTTP content type for the current response.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current response.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		return 'text/xml';
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current response.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current response.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		return $this->soap_defencoding;
+	}
+
+	/**
+	* add a method to the dispatch map (this has been replaced by the register method)
+	*
+	* @param    string $methodname
+	* @param    string $in array of input values
+	* @param    string $out array of output values
+	* @access   public
+	* @deprecated
+	*/
+	function add_to_map($methodname,$in,$out){
+			$this->operations[$methodname] = array('name' => $methodname,'in' => $in,'out' => $out);
+	}
+
+	/**
+	* register a service function with the server
+	*
+	* @param    string $name the name of the PHP function, class.method or class..method
+	* @param    array $in assoc array of input values: key = param name, value = param type
+	* @param    array $out assoc array of output values: key = param name, value = param type
+	* @param	mixed $namespace the element namespace for the method or false
+	* @param	mixed $soapaction the soapaction for the method or false
+	* @param	mixed $style optional (rpc|document) or false Note: when 'document' is specified, parameter and return wrappers are created for you automatically
+	* @param	mixed $use optional (encoded|literal) or false
+	* @param	string $documentation optional Description to include in WSDL
+	* @param	string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+	* @access   public
+	*/
+	function register($name,$in=array(),$out=array(),$namespace=false,$soapaction=false,$style=false,$use=false,$documentation='',$encodingStyle=''){
+		global $HTTP_SERVER_VARS;
+
+		if($this->externalWSDLURL){
+			die('You cannot bind to an external WSDL file, and register methods outside of it! Please choose either WSDL or no WSDL.');
+		}
+		if (! $name) {
+			die('You must specify a name when you register an operation');
+		}
+		if (!is_array($in)) {
+			die('You must provide an array for operation inputs');
+		}
+		if (!is_array($out)) {
+			die('You must provide an array for operation outputs');
+		}
+		if(false == $namespace) {
+		}
+		if(false == $soapaction) {
+			if (isset($_SERVER)) {
+				$SERVER_NAME = $_SERVER['SERVER_NAME'];
+				$SCRIPT_NAME = isset($_SERVER['PHP_SELF']) ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
+			} elseif (isset($HTTP_SERVER_VARS)) {
+				$SERVER_NAME = $HTTP_SERVER_VARS['SERVER_NAME'];
+				$SCRIPT_NAME = isset($HTTP_SERVER_VARS['PHP_SELF']) ? $HTTP_SERVER_VARS['PHP_SELF'] : $HTTP_SERVER_VARS['SCRIPT_NAME'];
+			} else {
+				$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+			}
+			$soapaction = "http://$SERVER_NAME$SCRIPT_NAME/$name";
+		}
+		if(false == $style) {
+			$style = "rpc";
+		}
+		if(false == $use) {
+			$use = "encoded";
+		}
+		if ($use == 'encoded' && $encodingStyle = '') {
+			$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		}
+
+		$this->operations[$name] = array(
+	    'name' => $name,
+	    'in' => $in,
+	    'out' => $out,
+	    'namespace' => $namespace,
+	    'soapaction' => $soapaction,
+	    'style' => $style);
+        if($this->wsdl){
+        	$this->wsdl->addOperation($name,$in,$out,$namespace,$soapaction,$style,$use,$documentation,$encodingStyle);
+	    }
+		return true;
+	}
+
+	/**
+	* Specify a fault to be returned to the client.
+	* This also acts as a flag to the server that a fault has occured.
+	*
+	* @param	string $faultcode
+	* @param	string $faultstring
+	* @param	string $faultactor
+	* @param	string $faultdetail
+	* @access   public
+	*/
+	function fault($faultcode,$faultstring,$faultactor='',$faultdetail=''){
+		if ($faultdetail == '' && $this->debug_flag) {
+			$faultdetail = $this->getDebug();
+		}
+		$this->fault = new soap_fault($faultcode,$faultactor,$faultstring,$faultdetail);
+		$this->fault->soap_defencoding = $this->soap_defencoding;
+	}
+
+    /**
+    * Sets up wsdl object.
+    * Acts as a flag to enable internal WSDL generation
+    *
+    * @param string $serviceName, name of the service
+    * @param mixed $namespace optional 'tns' service namespace or false
+    * @param mixed $endpoint optional URL of service endpoint or false
+    * @param string $style optional (rpc|document) WSDL style (also specified by operation)
+    * @param string $transport optional SOAP transport
+    * @param mixed $schemaTargetNamespace optional 'types' targetNamespace for service schema or false
+    */
+    function configureWSDL($serviceName,$namespace = false,$endpoint = false,$style='rpc', $transport = 'http://schemas.xmlsoap.org/soap/http', $schemaTargetNamespace = false)
+    {
+    	global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$SERVER_NAME = $_SERVER['SERVER_NAME'];
+			$SERVER_PORT = $_SERVER['SERVER_PORT'];
+			$SCRIPT_NAME = isset($_SERVER['PHP_SELF']) ? $_SERVER['PHP_SELF'] : $_SERVER['SCRIPT_NAME'];
+			$HTTPS = $_SERVER['HTTPS'];
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$SERVER_NAME = $HTTP_SERVER_VARS['SERVER_NAME'];
+			$SERVER_PORT = $HTTP_SERVER_VARS['SERVER_PORT'];
+			$SCRIPT_NAME = isset($HTTP_SERVER_VARS['PHP_SELF']) ? $HTTP_SERVER_VARS['PHP_SELF'] : $HTTP_SERVER_VARS['SCRIPT_NAME'];
+			$HTTPS = $HTTP_SERVER_VARS['HTTPS'];
+		} else {
+			$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+		}
+		if ($SERVER_PORT == 80) {
+			$SERVER_PORT = '';
+		} else {
+			$SERVER_PORT = ':' . $SERVER_PORT;
+		}
+        if(false == $namespace) {
+            $namespace = "http://$SERVER_NAME/soap/$serviceName";
+        }
+        
+        if(false == $endpoint) {
+        	if ($HTTPS == '1' || $HTTPS == 'on') {
+        		$SCHEME = 'https';
+        	} else {
+        		$SCHEME = 'http';
+        	}
+            $endpoint = "$SCHEME://$SERVER_NAME$SERVER_PORT$SCRIPT_NAME";
+        }
+        
+        if(false == $schemaTargetNamespace) {
+            $schemaTargetNamespace = $namespace;
+        }
+        
+		$this->wsdl = new wsdl;
+		$this->wsdl->serviceName = $serviceName;
+        $this->wsdl->endpoint = $endpoint;
+		$this->wsdl->namespaces['tns'] = $namespace;
+		$this->wsdl->namespaces['soap'] = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		$this->wsdl->namespaces['wsdl'] = 'http://schemas.xmlsoap.org/wsdl/';
+		if ($schemaTargetNamespace != $namespace) {
+			$this->wsdl->namespaces['types'] = $schemaTargetNamespace;
+		}
+        $this->wsdl->schemas[$schemaTargetNamespace][0] = new xmlschema('', '', $this->wsdl->namespaces);
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->schemaTargetNamespace = $schemaTargetNamespace;
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->imports['http://schemas.xmlsoap.org/soap/encoding/'][0] = array('location' => '', 'loaded' => true);
+        $this->wsdl->schemas[$schemaTargetNamespace][0]->imports['http://schemas.xmlsoap.org/wsdl/'][0] = array('location' => '', 'loaded' => true);
+        $this->wsdl->bindings[$serviceName.'Binding'] = array(
+        	'name'=>$serviceName.'Binding',
+            'style'=>$style,
+            'transport'=>$transport,
+            'portType'=>$serviceName.'PortType');
+        $this->wsdl->ports[$serviceName.'Port'] = array(
+        	'binding'=>$serviceName.'Binding',
+            'location'=>$endpoint,
+            'bindingType'=>'http://schemas.xmlsoap.org/wsdl/soap/');
+    }
+}
+
+
+
+?><?php
+
+
+
+/**
+* parses a WSDL file, allows access to it's data, other utility methods
+* 
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access public 
+*/
+class wsdl extends nusoap_base {
+	// URL or filename of the root of this WSDL
+    var $wsdl; 
+    // define internal arrays of bindings, ports, operations, messages, etc.
+    var $schemas = array();
+    var $currentSchema;
+    var $message = array();
+    var $complexTypes = array();
+    var $messages = array();
+    var $currentMessage;
+    var $currentOperation;
+    var $portTypes = array();
+    var $currentPortType;
+    var $bindings = array();
+    var $currentBinding;
+    var $ports = array();
+    var $currentPort;
+    var $opData = array();
+    var $status = '';
+    var $documentation = false;
+    var $endpoint = ''; 
+    // array of wsdl docs to import
+    var $import = array(); 
+    // parser vars
+    var $parser;
+    var $position = 0;
+    var $depth = 0;
+    var $depth_array = array();
+	// for getting wsdl
+	var $proxyhost = '';
+    var $proxyport = '';
+	var $proxyusername = '';
+	var $proxypassword = '';
+	var $timeout = 0;
+	var $response_timeout = 30;
+
+    /**
+     * constructor
+     * 
+     * @param string $wsdl WSDL document URL
+	 * @param string $proxyhost
+	 * @param string $proxyport
+	 * @param string $proxyusername
+	 * @param string $proxypassword
+	 * @param integer $timeout set the connection timeout
+	 * @param integer $response_timeout set the response timeout
+     * @access public 
+     */
+    function wsdl($wsdl = '',$proxyhost=false,$proxyport=false,$proxyusername=false,$proxypassword=false,$timeout=0,$response_timeout=30){
+		parent::nusoap_base();
+        $this->wsdl = $wsdl;
+        $this->proxyhost = $proxyhost;
+        $this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+		$this->timeout = $timeout;
+		$this->response_timeout = $response_timeout;
+        
+        // parse wsdl file
+        if ($wsdl != "") {
+            $this->debug('initial wsdl URL: ' . $wsdl);
+            $this->parseWSDL($wsdl);
+        }
+        // imports
+        // TODO: handle imports more properly, grabbing them in-line and nesting them
+        	$imported_urls = array();
+        	$imported = 1;
+        	while ($imported > 0) {
+        		$imported = 0;
+        		// Schema imports
+        		foreach ($this->schemas as $ns => $list) {
+        			foreach ($list as $xs) {
+						$wsdlparts = parse_url($this->wsdl);	// this is bogusly simple!
+			            foreach ($xs->imports as $ns2 => $list2) {
+			                for ($ii = 0; $ii < count($list2); $ii++) {
+			                	if (! $list2[$ii]['loaded']) {
+			                		$this->schemas[$ns]->imports[$ns2][$ii]['loaded'] = true;
+			                		$url = $list2[$ii]['location'];
+									if ($url != '') {
+										$urlparts = parse_url($url);
+										if (!isset($urlparts['host'])) {
+											$url = $wsdlparts['scheme'] . '://' . $wsdlparts['host'] . (isset($wsdlparts['port']) ? ':' .$wsdlparts['port'] : '') .
+													substr($wsdlparts['path'],0,strrpos($wsdlparts['path'],'/') + 1) .$urlparts['path'];
+										}
+										if (! in_array($url, $imported_urls)) {
+						                	$this->parseWSDL($url);
+					                		$imported++;
+					                		$imported_urls[] = $url;
+					                	}
+									} else {
+										$this->debug("Unexpected scenario: empty URL for unloaded import");
+									}
+								}
+							}
+			            } 
+        			}
+        		}
+        		// WSDL imports
+				$wsdlparts = parse_url($this->wsdl);	// this is bogusly simple!
+	            foreach ($this->import as $ns => $list) {
+	                for ($ii = 0; $ii < count($list); $ii++) {
+	                	if (! $list[$ii]['loaded']) {
+	                		$this->import[$ns][$ii]['loaded'] = true;
+	                		$url = $list[$ii]['location'];
+							if ($url != '') {
+								$urlparts = parse_url($url);
+								if (!isset($urlparts['host'])) {
+									$url = $wsdlparts['scheme'] . '://' . $wsdlparts['host'] . (isset($wsdlparts['port']) ? ':' . $wsdlparts['port'] : '') .
+											substr($wsdlparts['path'],0,strrpos($wsdlparts['path'],'/') + 1) .$urlparts['path'];
+								}
+								if (! in_array($url, $imported_urls)) {
+				                	$this->parseWSDL($url);
+			                		$imported++;
+			                		$imported_urls[] = $url;
+			                	}
+							} else {
+								$this->debug("Unexpected scenario: empty URL for unloaded import");
+							}
+						}
+					}
+	            } 
+			}
+        // add new data to operation data
+        foreach($this->bindings as $binding => $bindingData) {
+            if (isset($bindingData['operations']) && is_array($bindingData['operations'])) {
+                foreach($bindingData['operations'] as $operation => $data) {
+                    $this->debug('post-parse data gathering for ' . $operation);
+                    $this->bindings[$binding]['operations'][$operation]['input'] = 
+						isset($this->bindings[$binding]['operations'][$operation]['input']) ? 
+						array_merge($this->bindings[$binding]['operations'][$operation]['input'], $this->portTypes[ $bindingData['portType'] ][$operation]['input']) :
+						$this->portTypes[ $bindingData['portType'] ][$operation]['input'];
+                    $this->bindings[$binding]['operations'][$operation]['output'] = 
+						isset($this->bindings[$binding]['operations'][$operation]['output']) ?
+						array_merge($this->bindings[$binding]['operations'][$operation]['output'], $this->portTypes[ $bindingData['portType'] ][$operation]['output']) :
+						$this->portTypes[ $bindingData['portType'] ][$operation]['output'];
+                    if(isset($this->messages[ $this->bindings[$binding]['operations'][$operation]['input']['message'] ])){
+						$this->bindings[$binding]['operations'][$operation]['input']['parts'] = $this->messages[ $this->bindings[$binding]['operations'][$operation]['input']['message'] ];
+					}
+					if(isset($this->messages[ $this->bindings[$binding]['operations'][$operation]['output']['message'] ])){
+                   		$this->bindings[$binding]['operations'][$operation]['output']['parts'] = $this->messages[ $this->bindings[$binding]['operations'][$operation]['output']['message'] ];
+                    }
+					if (isset($bindingData['style'])) {
+                        $this->bindings[$binding]['operations'][$operation]['style'] = $bindingData['style'];
+                    }
+                    $this->bindings[$binding]['operations'][$operation]['transport'] = isset($bindingData['transport']) ? $bindingData['transport'] : '';
+                    $this->bindings[$binding]['operations'][$operation]['documentation'] = isset($this->portTypes[ $bindingData['portType'] ][$operation]['documentation']) ? $this->portTypes[ $bindingData['portType'] ][$operation]['documentation'] : '';
+                    $this->bindings[$binding]['operations'][$operation]['endpoint'] = isset($bindingData['endpoint']) ? $bindingData['endpoint'] : '';
+                } 
+            } 
+        }
+    }
+
+    /**
+     * parses the wsdl document
+     * 
+     * @param string $wsdl path or URL
+     * @access private 
+     */
+    function parseWSDL($wsdl = '')
+    {
+        if ($wsdl == '') {
+            $this->debug('no wsdl passed to parseWSDL()!!');
+            $this->setError('no wsdl passed to parseWSDL()!!');
+            return false;
+        }
+        
+        // parse $wsdl for url format
+        $wsdl_props = parse_url($wsdl);
+
+        if (isset($wsdl_props['scheme']) && ($wsdl_props['scheme'] == 'http' || $wsdl_props['scheme'] == 'https')) {
+            $this->debug('getting WSDL http(s) URL ' . $wsdl);
+        	// get wsdl
+	        $tr = new soap_transport_http($wsdl);
+			$tr->request_method = 'GET';
+			$tr->useSOAPAction = false;
+			if($this->proxyhost && $this->proxyport){
+				$tr->setProxy($this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword);
+			}
+			$tr->setEncoding('gzip, deflate');
+			$wsdl_string = $tr->send('', $this->timeout, $this->response_timeout);
+			//$this->debug("WSDL request\n" . $tr->outgoing_payload);
+			//$this->debug("WSDL response\n" . $tr->incoming_payload);
+			$this->appendDebug($tr->getDebug());
+			// catch errors
+			if($err = $tr->getError() ){
+				$errstr = 'HTTP ERROR: '.$err;
+				$this->debug($errstr);
+	            $this->setError($errstr);
+				unset($tr);
+	            return false;
+			}
+			unset($tr);
+			$this->debug("got WSDL URL");
+        } else {
+            // $wsdl is not http(s), so treat it as a file URL or plain file path
+        	if (isset($wsdl_props['scheme']) && ($wsdl_props['scheme'] == 'file') && isset($wsdl_props['path'])) {
+        		$path = isset($wsdl_props['host']) ? ($wsdl_props['host'] . ':' . $wsdl_props['path']) : $wsdl_props['path'];
+        	} else {
+        		$path = $wsdl;
+        	}
+            $this->debug('getting WSDL file ' . $path);
+            if ($fp = @fopen($path, 'r')) {
+                $wsdl_string = '';
+                while ($data = fread($fp, 32768)) {
+                    $wsdl_string .= $data;
+                } 
+                fclose($fp);
+            } else {
+            	$errstr = "Bad path to WSDL file $path";
+            	$this->debug($errstr);
+                $this->setError($errstr);
+                return false;
+            } 
+        }
+        $this->debug('Parse WSDL');
+        // end new code added
+        // Create an XML parser.
+        $this->parser = xml_parser_create(); 
+        // Set the options for parsing the XML data.
+        // xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);
+        xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0); 
+        // Set the object for the parser.
+        xml_set_object($this->parser, $this); 
+        // Set the element handlers for the parser.
+        xml_set_element_handler($this->parser, 'start_element', 'end_element');
+        xml_set_character_data_handler($this->parser, 'character_data');
+        // Parse the XML file.
+        if (!xml_parse($this->parser, $wsdl_string, true)) {
+            // Display an error message.
+            $errstr = sprintf(
+				'XML error parsing WSDL from %s on line %d: %s',
+				$wsdl,
+                xml_get_current_line_number($this->parser),
+                xml_error_string(xml_get_error_code($this->parser))
+                );
+            $this->debug($errstr);
+			$this->debug("XML payload:\n" . $wsdl_string);
+            $this->setError($errstr);
+            return false;
+        } 
+		// free the parser
+        xml_parser_free($this->parser);
+        $this->debug('Parsing WSDL done');
+		// catch wsdl parse errors
+		if($this->getError()){
+			return false;
+		}
+        return true;
+    } 
+
+    /**
+     * start-element handler
+     * 
+     * @param string $parser XML parser object
+     * @param string $name element name
+     * @param string $attrs associative array of attributes
+     * @access private 
+     */
+    function start_element($parser, $name, $attrs)
+    {
+        if ($this->status == 'schema') {
+            $this->currentSchema->schemaStartElement($parser, $name, $attrs);
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+        } elseif (ereg('schema$', $name)) {
+        	$this->debug('Parsing WSDL schema');
+            // $this->debug("startElement for $name ($attrs[name]). status = $this->status (".$this->getLocalPart($name).")");
+            $this->status = 'schema';
+            $this->currentSchema = new xmlschema('', '', $this->namespaces);
+            $this->currentSchema->schemaStartElement($parser, $name, $attrs);
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+        } else {
+            // position in the total number of elements, starting from 0
+            $pos = $this->position++;
+            $depth = $this->depth++; 
+            // set self as current value for this depth
+            $this->depth_array[$depth] = $pos;
+            $this->message[$pos] = array('cdata' => ''); 
+            // process attributes
+            if (count($attrs) > 0) {
+				// register namespace declarations
+                foreach($attrs as $k => $v) {
+                    if (ereg("^xmlns", $k)) {
+                        if ($ns_prefix = substr(strrchr($k, ':'), 1)) {
+                            $this->namespaces[$ns_prefix] = $v;
+                        } else {
+                            $this->namespaces['ns' . (count($this->namespaces) + 1)] = $v;
+                        } 
+                        if ($v == 'http://www.w3.org/2001/XMLSchema' || $v == 'http://www.w3.org/1999/XMLSchema' || $v == 'http://www.w3.org/2000/10/XMLSchema') {
+                            $this->XMLSchemaVersion = $v;
+                            $this->namespaces['xsi'] = $v . '-instance';
+                        } 
+                    }
+                }
+                // expand each attribute prefix to its namespace
+                foreach($attrs as $k => $v) {
+                    $k = strpos($k, ':') ? $this->expandQname($k) : $k;
+                    if ($k != 'location' && $k != 'soapAction' && $k != 'namespace') {
+                        $v = strpos($v, ':') ? $this->expandQname($v) : $v;
+                    } 
+                    $eAttrs[$k] = $v;
+                } 
+                $attrs = $eAttrs;
+            } else {
+                $attrs = array();
+            } 
+            // get element prefix, namespace and name
+            if (ereg(':', $name)) {
+                // get ns prefix
+                $prefix = substr($name, 0, strpos($name, ':')); 
+                // get ns
+                $namespace = isset($this->namespaces[$prefix]) ? $this->namespaces[$prefix] : ''; 
+                // get unqualified name
+                $name = substr(strstr($name, ':'), 1);
+            } 
+			// process attributes, expanding any prefixes to namespaces
+            // find status, register data
+            switch ($this->status) {
+                case 'message':
+                    if ($name == 'part') {
+			            if (isset($attrs['type'])) {
+		                    $this->debug("msg " . $this->currentMessage . ": found part $attrs[name]: " . implode(',', $attrs));
+		                    $this->messages[$this->currentMessage][$attrs['name']] = $attrs['type'];
+            			} 
+			            if (isset($attrs['element'])) {
+		                    $this->debug("msg " . $this->currentMessage . ": found part $attrs[name]: " . implode(',', $attrs));
+			                $this->messages[$this->currentMessage][$attrs['name']] = $attrs['element'];
+			            } 
+        			} 
+        			break;
+			    case 'portType':
+			        switch ($name) {
+			            case 'operation':
+			                $this->currentPortOperation = $attrs['name'];
+			                $this->debug("portType $this->currentPortType operation: $this->currentPortOperation");
+			                if (isset($attrs['parameterOrder'])) {
+			                	$this->portTypes[$this->currentPortType][$attrs['name']]['parameterOrder'] = $attrs['parameterOrder'];
+			        		} 
+			        		break;
+					    case 'documentation':
+					        $this->documentation = true;
+					        break; 
+					    // merge input/output data
+					    default:
+					        $m = isset($attrs['message']) ? $this->getLocalPart($attrs['message']) : '';
+					        $this->portTypes[$this->currentPortType][$this->currentPortOperation][$name]['message'] = $m;
+					        break;
+					} 
+			    	break;
+				case 'binding':
+				    switch ($name) {
+				        case 'binding': 
+				            // get ns prefix
+				            if (isset($attrs['style'])) {
+				            $this->bindings[$this->currentBinding]['prefix'] = $prefix;
+					    	} 
+					    	$this->bindings[$this->currentBinding] = array_merge($this->bindings[$this->currentBinding], $attrs);
+					    	break;
+						case 'header':
+						    $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus]['headers'][] = $attrs;
+						    break;
+						case 'operation':
+						    if (isset($attrs['soapAction'])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['soapAction'] = $attrs['soapAction'];
+						    } 
+						    if (isset($attrs['style'])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['style'] = $attrs['style'];
+						    } 
+						    if (isset($attrs['name'])) {
+						        $this->currentOperation = $attrs['name'];
+						        $this->debug("current binding operation: $this->currentOperation");
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['name'] = $attrs['name'];
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['binding'] = $this->currentBinding;
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation]['endpoint'] = isset($this->bindings[$this->currentBinding]['endpoint']) ? $this->bindings[$this->currentBinding]['endpoint'] : '';
+						    } 
+						    break;
+						case 'input':
+						    $this->opStatus = 'input';
+						    break;
+						case 'output':
+						    $this->opStatus = 'output';
+						    break;
+						case 'body':
+						    if (isset($this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus])) {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus] = array_merge($this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus], $attrs);
+						    } else {
+						        $this->bindings[$this->currentBinding]['operations'][$this->currentOperation][$this->opStatus] = $attrs;
+						    } 
+						    break;
+					} 
+					break;
+				case 'service':
+					switch ($name) {
+					    case 'port':
+					        $this->currentPort = $attrs['name'];
+					        $this->debug('current port: ' . $this->currentPort);
+					        $this->ports[$this->currentPort]['binding'] = $this->getLocalPart($attrs['binding']);
+					
+					        break;
+					    case 'address':
+					        $this->ports[$this->currentPort]['location'] = $attrs['location'];
+					        $this->ports[$this->currentPort]['bindingType'] = $namespace;
+					        $this->bindings[ $this->ports[$this->currentPort]['binding'] ]['bindingType'] = $namespace;
+					        $this->bindings[ $this->ports[$this->currentPort]['binding'] ]['endpoint'] = $attrs['location'];
+					        break;
+					} 
+					break;
+			} 
+		// set status
+		switch ($name) {
+			case 'import':
+			    if (isset($attrs['location'])) {
+                    $this->import[$attrs['namespace']][] = array('location' => $attrs['location'], 'loaded' => false);
+                    $this->debug('parsing import ' . $attrs['namespace']. ' - ' . $attrs['location'] . ' (' . count($this->import[$attrs['namespace']]).')');
+				} else {
+                    $this->import[$attrs['namespace']][] = array('location' => '', 'loaded' => true);
+					if (! $this->getPrefixFromNamespace($attrs['namespace'])) {
+						$this->namespaces['ns'.(count($this->namespaces)+1)] = $attrs['namespace'];
+					}
+                    $this->debug('parsing import ' . $attrs['namespace']. ' - [no location] (' . count($this->import[$attrs['namespace']]).')');
+				}
+				break;
+			//wait for schema
+			//case 'types':
+			//	$this->status = 'schema';
+			//	break;
+			case 'message':
+				$this->status = 'message';
+				$this->messages[$attrs['name']] = array();
+				$this->currentMessage = $attrs['name'];
+				break;
+			case 'portType':
+				$this->status = 'portType';
+				$this->portTypes[$attrs['name']] = array();
+				$this->currentPortType = $attrs['name'];
+				break;
+			case "binding":
+				if (isset($attrs['name'])) {
+				// get binding name
+					if (strpos($attrs['name'], ':')) {
+			    		$this->currentBinding = $this->getLocalPart($attrs['name']);
+					} else {
+			    		$this->currentBinding = $attrs['name'];
+					} 
+					$this->status = 'binding';
+					$this->bindings[$this->currentBinding]['portType'] = $this->getLocalPart($attrs['type']);
+					$this->debug("current binding: $this->currentBinding of portType: " . $attrs['type']);
+				} 
+				break;
+			case 'service':
+				$this->serviceName = $attrs['name'];
+				$this->status = 'service';
+				$this->debug('current service: ' . $this->serviceName);
+				break;
+			case 'definitions':
+				foreach ($attrs as $name => $value) {
+					$this->wsdl_info[$name] = $value;
+				} 
+				break;
+			} 
+		} 
+	} 
+
+	/**
+	* end-element handler
+	* 
+	* @param string $parser XML parser object
+	* @param string $name element name
+	* @access private 
+	*/
+	function end_element($parser, $name){ 
+		// unset schema status
+		if (/*ereg('types$', $name) ||*/ ereg('schema$', $name)) {
+			$this->status = "";
+            $this->appendDebug($this->currentSchema->getDebug());
+            $this->currentSchema->clearDebug();
+			$this->schemas[$this->currentSchema->schemaTargetNamespace][] = $this->currentSchema;
+        	$this->debug('Parsing WSDL schema done');
+		} 
+		if ($this->status == 'schema') {
+			$this->currentSchema->schemaEndElement($parser, $name);
+		} else {
+			// bring depth down a notch
+			$this->depth--;
+		} 
+		// end documentation
+		if ($this->documentation) {
+			//TODO: track the node to which documentation should be assigned; it can be a part, message, etc.
+			//$this->portTypes[$this->currentPortType][$this->currentPortOperation]['documentation'] = $this->documentation;
+			$this->documentation = false;
+		} 
+	} 
+
+	/**
+	 * element content handler
+	 * 
+	 * @param string $parser XML parser object
+	 * @param string $data element content
+	 * @access private 
+	 */
+	function character_data($parser, $data)
+	{
+		$pos = isset($this->depth_array[$this->depth]) ? $this->depth_array[$this->depth] : 0;
+		if (isset($this->message[$pos]['cdata'])) {
+			$this->message[$pos]['cdata'] .= $data;
+		} 
+		if ($this->documentation) {
+			$this->documentation .= $data;
+		} 
+	} 
+	
+	function getBindingData($binding)
+	{
+		if (is_array($this->bindings[$binding])) {
+			return $this->bindings[$binding];
+		} 
+	}
+	
+	/**
+	 * returns an assoc array of operation names => operation data
+	 * 
+	 * @param string $bindingType eg: soap, smtp, dime (only soap is currently supported)
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperations($bindingType = 'soap')
+	{
+		$ops = array();
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				//$this->debug("getOperations for port $port");
+				//$this->debug("port data: " . $this->varDump($portData));
+				//$this->debug("bindings: " . $this->varDump($this->bindings[ $portData['binding'] ]));
+				// merge bindings
+				if (isset($this->bindings[ $portData['binding'] ]['operations'])) {
+					$ops = array_merge ($ops, $this->bindings[ $portData['binding'] ]['operations']);
+				}
+			}
+		} 
+		return $ops;
+	} 
+	
+	/**
+	 * returns an associative array of data necessary for calling an operation
+	 * 
+	 * @param string $operation , name of operation
+	 * @param string $bindingType , type of binding eg: soap
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperationData($operation, $bindingType = 'soap')
+	{
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				// get binding
+				//foreach($this->bindings[ $portData['binding'] ]['operations'] as $bOperation => $opData) {
+				foreach(array_keys($this->bindings[ $portData['binding'] ]['operations']) as $bOperation) {
+					// note that we could/should also check the namespace here
+					if ($operation == $bOperation) {
+						$opData = $this->bindings[ $portData['binding'] ]['operations'][$operation];
+					    return $opData;
+					} 
+				} 
+			}
+		} 
+	}
+	
+	/**
+	 * returns an associative array of data necessary for calling an operation
+	 * 
+	 * @param string $soapAction soapAction for operation
+	 * @param string $bindingType type of binding eg: soap
+	 * @return array 
+	 * @access public 
+	 */
+	function getOperationDataForSoapAction($soapAction, $bindingType = 'soap') {
+		if ($bindingType == 'soap') {
+			$bindingType = 'http://schemas.xmlsoap.org/wsdl/soap/';
+		}
+		// loop thru ports
+		foreach($this->ports as $port => $portData) {
+			// binding type of port matches parameter
+			if ($portData['bindingType'] == $bindingType) {
+				// loop through operations for the binding
+				foreach ($this->bindings[ $portData['binding'] ]['operations'] as $bOperation => $opData) {
+					if ($opData['soapAction'] == $soapAction) {
+					    return $opData;
+					} 
+				} 
+			}
+		} 
+	}
+	
+	/**
+    * returns an array of information about a given type
+    * returns false if no type exists by the given name
+    *
+	*	 typeDef = array(
+	*	 'elements' => array(), // refs to elements array
+	*	'restrictionBase' => '',
+	*	'phpType' => '',
+	*	'order' => '(sequence|all)',
+	*	'attrs' => array() // refs to attributes array
+	*	)
+    *
+    * @param $type string the type
+    * @param $ns string namespace (not prefix) of the type
+    * @return mixed
+    * @access public
+    * @see xmlschema
+    */
+	function getTypeDef($type, $ns) {
+		$this->debug("in getTypeDef: type=$type, ns=$ns");
+		if ((! $ns) && isset($this->namespaces['tns'])) {
+			$ns = $this->namespaces['tns'];
+			$this->debug("in getTypeDef: type namespace forced to $ns");
+		}
+		if (isset($this->schemas[$ns])) {
+			$this->debug("in getTypeDef: have schema for namespace $ns");
+			for ($i = 0; $i < count($this->schemas[$ns]); $i++) {
+				$xs = &$this->schemas[$ns][$i];
+				$t = $xs->getTypeDef($type);
+				$this->appendDebug($xs->getDebug());
+				$xs->clearDebug();
+				if ($t) {
+					if (!isset($t['phpType'])) {
+						// get info for type to tack onto the element
+						$uqType = substr($t['type'], strrpos($t['type'], ':') + 1);
+						$ns = substr($t['type'], 0, strrpos($t['type'], ':'));
+						$etype = $this->getTypeDef($uqType, $ns);
+						if ($etype) {
+							$this->debug("found type for [element] $type:");
+							$this->debug($this->varDump($etype));
+							if (isset($etype['phpType'])) {
+								$t['phpType'] = $etype['phpType'];
+							}
+							if (isset($etype['elements'])) {
+								$t['elements'] = $etype['elements'];
+							}
+							if (isset($etype['attrs'])) {
+								$t['attrs'] = $etype['attrs'];
+							}
+						}
+					}
+					return $t;
+				}
+			}
+		} else {
+			$this->debug("in getTypeDef: do not have schema for namespace $ns");
+		}
+		return false;
+	}
+
+    /**
+    * prints html description of services
+    *
+    * @access private
+    */
+    function webDescription(){
+    	global $HTTP_SERVER_VARS;
+
+		if (isset($_SERVER)) {
+			$PHP_SELF = $_SERVER['PHP_SELF'];
+		} elseif (isset($HTTP_SERVER_VARS)) {
+			$PHP_SELF = $HTTP_SERVER_VARS['PHP_SELF'];
+		} else {
+			$this->setError("Neither _SERVER nor HTTP_SERVER_VARS is available");
+		}
+
+		$b = '
+		<html><head><title>NuSOAP: '.$this->serviceName.'</title>
+		<style type="text/css">
+		    body    { font-family: arial; color: #000000; background-color: #ffffff; margin: 0px 0px 0px 0px; }
+		    p       { font-family: arial; color: #000000; margin-top: 0px; margin-bottom: 12px; }
+		    pre { background-color: silver; padding: 5px; font-family: Courier New; font-size: x-small; color: #000000;}
+		    ul      { margin-top: 10px; margin-left: 20px; }
+		    li      { list-style-type: none; margin-top: 10px; color: #000000; }
+		    .content{
+			margin-left: 0px; padding-bottom: 2em; }
+		    .nav {
+			padding-top: 10px; padding-bottom: 10px; padding-left: 15px; font-size: .70em;
+			margin-top: 10px; margin-left: 0px; color: #000000;
+			background-color: #ccccff; width: 20%; margin-left: 20px; margin-top: 20px; }
+		    .title {
+			font-family: arial; font-size: 26px; color: #ffffff;
+			background-color: #999999; width: 105%; margin-left: 0px;
+			padding-top: 10px; padding-bottom: 10px; padding-left: 15px;}
+		    .hidden {
+			position: absolute; visibility: hidden; z-index: 200; left: 250px; top: 100px;
+			font-family: arial; overflow: hidden; width: 600;
+			padding: 20px; font-size: 10px; background-color: #999999;
+			layer-background-color:#FFFFFF; }
+		    a,a:active  { color: charcoal; font-weight: bold; }
+		    a:visited   { color: #666666; font-weight: bold; }
+		    a:hover     { color: cc3300; font-weight: bold; }
+		</style>
+		<script language="JavaScript" type="text/javascript">
+		<!--
+		// POP-UP CAPTIONS...
+		function lib_bwcheck(){ //Browsercheck (needed)
+		    this.ver=navigator.appVersion
+		    this.agent=navigator.userAgent
+		    this.dom=document.getElementById?1:0
+		    this.opera5=this.agent.indexOf("Opera 5")>-1
+		    this.ie5=(this.ver.indexOf("MSIE 5")>-1 && this.dom && !this.opera5)?1:0;
+		    this.ie6=(this.ver.indexOf("MSIE 6")>-1 && this.dom && !this.opera5)?1:0;
+		    this.ie4=(document.all && !this.dom && !this.opera5)?1:0;
+		    this.ie=this.ie4||this.ie5||this.ie6
+		    this.mac=this.agent.indexOf("Mac")>-1
+		    this.ns6=(this.dom && parseInt(this.ver) >= 5) ?1:0;
+		    this.ns4=(document.layers && !this.dom)?1:0;
+		    this.bw=(this.ie6 || this.ie5 || this.ie4 || this.ns4 || this.ns6 || this.opera5)
+		    return this
+		}
+		var bw = new lib_bwcheck()
+		//Makes crossbrowser object.
+		function makeObj(obj){
+		    this.evnt=bw.dom? document.getElementById(obj):bw.ie4?document.all[obj]:bw.ns4?document.layers[obj]:0;
+		    if(!this.evnt) return false
+		    this.css=bw.dom||bw.ie4?this.evnt.style:bw.ns4?this.evnt:0;
+		    this.wref=bw.dom||bw.ie4?this.evnt:bw.ns4?this.css.document:0;
+		    this.writeIt=b_writeIt;
+		    return this
+		}
+		// A unit of measure that will be added when setting the position of a layer.
+		//var px = bw.ns4||window.opera?"":"px";
+		function b_writeIt(text){
+		    if (bw.ns4){this.wref.write(text);this.wref.close()}
+		    else this.wref.innerHTML = text
+		}
+		//Shows the messages
+		var oDesc;
+		function popup(divid){
+		    if(oDesc = new makeObj(divid)){
+			oDesc.css.visibility = "visible"
+		    }
+		}
+		function popout(){ // Hides message
+		    if(oDesc) oDesc.css.visibility = "hidden"
+		}
+		//-->
+		</script>
+		</head>
+		<body>
+		<div class=content>
+			<br><br>
+			<div class=title>'.$this->serviceName.'</div>
+			<div class=nav>
+				<p>View the <a href="'.$PHP_SELF.'?wsdl">WSDL</a> for the service.
+				Click on an operation name to view it&apos;s details.</p>
+				<ul>';
+				foreach($this->getOperations() as $op => $data){
+				    $b .= "<li><a href='#' onclick=\"popout();popup('$op')\">$op</a></li>";
+				    // create hidden div
+				    $b .= "<div id='$op' class='hidden'>
+				    <a href='#' onclick='popout()'><font color='#ffffff'>Close</font></a><br><br>";
+				    foreach($data as $donnie => $marie){ // loop through opdata
+						if($donnie == 'input' || $donnie == 'output'){ // show input/output data
+						    $b .= "<font color='white'>".ucfirst($donnie).':</font><br>';
+						    foreach($marie as $captain => $tenille){ // loop through data
+								if($captain == 'parts'){ // loop thru parts
+								    $b .= "&nbsp;&nbsp;$captain:<br>";
+					                //if(is_array($tenille)){
+								    	foreach($tenille as $joanie => $chachi){
+											$b .= "&nbsp;&nbsp;&nbsp;&nbsp;$joanie: $chachi<br>";
+								    	}
+					        		//}
+								} else {
+								    $b .= "&nbsp;&nbsp;$captain: $tenille<br>";
+								}
+						    }
+						} else {
+						    $b .= "<font color='white'>".ucfirst($donnie).":</font> $marie<br>";
+						}
+				    }
+					$b .= '</div>';
+				}
+				$b .= '
+				<ul>
+			</div>
+		</div></body></html>';
+		return $b;
+    }
+
+	/**
+	* serialize the parsed wsdl
+	*
+	* @param mixed $debug whether to put debug=1 in endpoint URL
+	* @return string serialization of WSDL
+	* @access public 
+	*/
+	function serialize($debug = 0)
+	{
+		$xml = '<?xml version="1.0" encoding="ISO-8859-1"?>';
+		$xml .= "\n<definitions";
+		foreach($this->namespaces as $k => $v) {
+			$xml .= " xmlns:$k=\"$v\"";
+		} 
+		// 10.9.02 - add poulter fix for wsdl and tns declarations
+		if (isset($this->namespaces['wsdl'])) {
+			$xml .= " xmlns=\"" . $this->namespaces['wsdl'] . "\"";
+		} 
+		if (isset($this->namespaces['tns'])) {
+			$xml .= " targetNamespace=\"" . $this->namespaces['tns'] . "\"";
+		} 
+		$xml .= '>'; 
+		// imports
+		if (sizeof($this->import) > 0) {
+			foreach($this->import as $ns => $list) {
+				foreach ($list as $ii) {
+					if ($ii['location'] != '') {
+						$xml .= '<import location="' . $ii['location'] . '" namespace="' . $ns . '" />';
+					} else {
+						$xml .= '<import namespace="' . $ns . '" />';
+					}
+				}
+			} 
+		} 
+		// types
+		if (count($this->schemas)>=1) {
+			$xml .= "\n<types>";
+			foreach ($this->schemas as $ns => $list) {
+				foreach ($list as $xs) {
+					$xml .= $xs->serializeSchema();
+				}
+			}
+			$xml .= '</types>';
+		} 
+		// messages
+		if (count($this->messages) >= 1) {
+			foreach($this->messages as $msgName => $msgParts) {
+				$xml .= "\n<message name=\"" . $msgName . '">';
+				if(is_array($msgParts)){
+					foreach($msgParts as $partName => $partType) {
+						// print 'serializing '.$partType.', sv: '.$this->XMLSchemaVersion.'<br>';
+						if (strpos($partType, ':')) {
+						    $typePrefix = $this->getPrefixFromNamespace($this->getPrefix($partType));
+						} elseif (isset($this->typemap[$this->namespaces['xsd']][$partType])) {
+						    // print 'checking typemap: '.$this->XMLSchemaVersion.'<br>';
+						    $typePrefix = 'xsd';
+						} else {
+						    foreach($this->typemap as $ns => $types) {
+						        if (isset($types[$partType])) {
+						            $typePrefix = $this->getPrefixFromNamespace($ns);
+						        } 
+						    } 
+						    if (!isset($typePrefix)) {
+						        die("$partType has no namespace!");
+						    } 
+						}
+						$ns = $this->getNamespaceFromPrefix($typePrefix);
+						$typeDef = $this->getTypeDef($this->getLocalPart($partType), $ns);
+						if ($typeDef['typeClass'] == 'element') {
+							$elementortype = 'element';
+						} else {
+							$elementortype = 'type';
+						}
+						$xml .= '<part name="' . $partName . '" ' . $elementortype . '="' . $typePrefix . ':' . $this->getLocalPart($partType) . '" />';
+					}
+				}
+				$xml .= '</message>';
+			} 
+		} 
+		// bindings & porttypes
+		if (count($this->bindings) >= 1) {
+			$binding_xml = '';
+			$portType_xml = '';
+			foreach($this->bindings as $bindingName => $attrs) {
+				$binding_xml .= "\n<binding name=\"" . $bindingName . '" type="tns:' . $attrs['portType'] . '">';
+				$binding_xml .= '<soap:binding style="' . $attrs['style'] . '" transport="' . $attrs['transport'] . '"/>';
+				$portType_xml .= "\n<portType name=\"" . $attrs['portType'] . '">';
+				foreach($attrs['operations'] as $opName => $opParts) {
+					$binding_xml .= '<operation name="' . $opName . '">';
+					$binding_xml .= '<soap:operation soapAction="' . $opParts['soapAction'] . '" style="'. $opParts['style'] . '"/>';
+					if (isset($opParts['input']['encodingStyle']) && $opParts['input']['encodingStyle'] != '') {
+						$enc_style = ' encodingStyle="' . $opParts['input']['encodingStyle'] . '"';
+					} else {
+						$enc_style = '';
+					}
+					$binding_xml .= '<input><soap:body use="' . $opParts['input']['use'] . '" namespace="' . $opParts['input']['namespace'] . '"' . $enc_style . '/></input>';
+					if (isset($opParts['output']['encodingStyle']) && $opParts['output']['encodingStyle'] != '') {
+						$enc_style = ' encodingStyle="' . $opParts['output']['encodingStyle'] . '"';
+					} else {
+						$enc_style = '';
+					}
+					$binding_xml .= '<output><soap:body use="' . $opParts['output']['use'] . '" namespace="' . $opParts['output']['namespace'] . '"' . $enc_style . '/></output>';
+					$binding_xml .= '</operation>';
+					$portType_xml .= '<operation name="' . $opParts['name'] . '"';
+					if (isset($opParts['parameterOrder'])) {
+					    $portType_xml .= ' parameterOrder="' . $opParts['parameterOrder'] . '"';
+					} 
+					$portType_xml .= '>';
+					if(isset($opParts['documentation']) && $opParts['documentation'] != '') {
+						$portType_xml .= '<documentation>' . htmlspecialchars($opParts['documentation']) . '</documentation>';
+					}
+					$portType_xml .= '<input message="tns:' . $opParts['input']['message'] . '"/>';
+					$portType_xml .= '<output message="tns:' . $opParts['output']['message'] . '"/>';
+					$portType_xml .= '</operation>';
+				} 
+				$portType_xml .= '</portType>';
+				$binding_xml .= '</binding>';
+			} 
+			$xml .= $portType_xml . $binding_xml;
+		} 
+		// services
+		$xml .= "\n<service name=\"" . $this->serviceName . '">';
+		if (count($this->ports) >= 1) {
+			foreach($this->ports as $pName => $attrs) {
+				$xml .= '<port name="' . $pName . '" binding="tns:' . $attrs['binding'] . '">';
+				$xml .= '<soap:address location="' . $attrs['location'] . ($debug ? '?debug=1' : '') . '"/>';
+				$xml .= '</port>';
+			} 
+		} 
+		$xml .= '</service>';
+		return $xml . "\n</definitions>";
+	} 
+	
+	/**
+	 * serialize PHP values according to a WSDL message definition
+	 *
+	 * TODO
+	 * - multi-ref serialization
+	 * - validate PHP values against type definitions, return errors if invalid
+	 * 
+	 * @param string $operation operation name
+	 * @param string $direction (input|output)
+	 * @param mixed $parameters parameter value(s)
+	 * @return mixed parameters serialized as XML or false on error (e.g. operation not found)
+	 * @access public
+	 */
+	function serializeRPCParameters($operation, $direction, $parameters)
+	{
+		$this->debug("in serializeRPCParameters: operation=$operation, direction=$direction, XMLSchemaVersion=$this->XMLSchemaVersion"); 
+		$this->appendDebug('parameters=' . $this->varDump($parameters));
+		
+		if ($direction != 'input' && $direction != 'output') {
+			$this->debug('The value of the \$direction argument needs to be either "input" or "output"');
+			$this->setError('The value of the \$direction argument needs to be either "input" or "output"');
+			return false;
+		} 
+		if (!$opData = $this->getOperationData($operation)) {
+			$this->debug('Unable to retrieve WSDL data for operation: ' . $operation);
+			$this->setError('Unable to retrieve WSDL data for operation: ' . $operation);
+			return false;
+		}
+		$this->debug('opData:');
+		$this->appendDebug($this->varDump($opData));
+
+		// Get encoding style for output and set to current
+		$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		if(($direction == 'input') && isset($opData['output']['encodingStyle']) && ($opData['output']['encodingStyle'] != $encodingStyle)) {
+			$encodingStyle = $opData['output']['encodingStyle'];
+			$enc_style = $encodingStyle;
+		}
+
+		// set input params
+		$xml = '';
+		if (isset($opData[$direction]['parts']) && sizeof($opData[$direction]['parts']) > 0) {
+			
+			$use = $opData[$direction]['use'];
+			$this->debug('have ' . count($opData[$direction]['parts']) . ' part(s) to serialize');
+			if (is_array($parameters)) {
+				$parametersArrayType = $this->isArraySimpleOrStruct($parameters);
+				$this->debug('have ' . count($parameters) . ' parameter(s) provided as ' . $parametersArrayType . ' to serialize');
+				foreach($opData[$direction]['parts'] as $name => $type) {
+					$this->debug('serializing part "'.$name.'" of type "'.$type.'"');
+					// Track encoding style
+					if (isset($opData[$direction]['encodingStyle']) && $encodingStyle != $opData[$direction]['encodingStyle']) {
+						$encodingStyle = $opData[$direction]['encodingStyle'];			
+						$enc_style = $encodingStyle;
+					} else {
+						$enc_style = false;
+					}
+					// NOTE: add error handling here
+					// if serializeType returns false, then catch global error and fault
+					if ($parametersArrayType == 'arraySimple') {
+						$p = array_shift($parameters);
+						$this->debug('calling serializeType w/indexed param');
+						$xml .= $this->serializeType($name, $type, $p, $use, $enc_style);
+					} elseif (isset($parameters[$name])) {
+						$this->debug('calling serializeType w/named param');
+						$xml .= $this->serializeType($name, $type, $parameters[$name], $use, $enc_style);
+					} else {
+						// TODO: only send nillable
+						$this->debug('calling serializeType w/null param');
+						$xml .= $this->serializeType($name, $type, null, $use, $enc_style);
+					}
+				}
+			} else {
+				$this->debug('no parameters passed.');
+			}
+		}
+		$this->debug("serializeRPCParameters returning: $xml");
+		return $xml;
+	} 
+	
+	/**
+	 * serialize a PHP value according to a WSDL message definition
+	 * 
+	 * TODO
+	 * - multi-ref serialization
+	 * - validate PHP values against type definitions, return errors if invalid
+	 * 
+	 * @param string $ type name
+	 * @param mixed $ param value
+	 * @return mixed new param or false if initial value didn't validate
+	 * @access public
+	 * @deprecated
+	 */
+	function serializeParameters($operation, $direction, $parameters)
+	{
+		$this->debug("in serializeParameters: operation=$operation, direction=$direction, XMLSchemaVersion=$this->XMLSchemaVersion"); 
+		$this->appendDebug('parameters=' . $this->varDump($parameters));
+		
+		if ($direction != 'input' && $direction != 'output') {
+			$this->debug('The value of the \$direction argument needs to be either "input" or "output"');
+			$this->setError('The value of the \$direction argument needs to be either "input" or "output"');
+			return false;
+		} 
+		if (!$opData = $this->getOperationData($operation)) {
+			$this->debug('Unable to retrieve WSDL data for operation: ' . $operation);
+			$this->setError('Unable to retrieve WSDL data for operation: ' . $operation);
+			return false;
+		}
+		$this->debug('opData:');
+		$this->appendDebug($this->varDump($opData));
+		
+		// Get encoding style for output and set to current
+		$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		if(($direction == 'input') && isset($opData['output']['encodingStyle']) && ($opData['output']['encodingStyle'] != $encodingStyle)) {
+			$encodingStyle = $opData['output']['encodingStyle'];
+			$enc_style = $encodingStyle;
+		}
+		
+		// set input params
+		$xml = '';
+		if (isset($opData[$direction]['parts']) && sizeof($opData[$direction]['parts']) > 0) {
+			
+			$use = $opData[$direction]['use'];
+			$this->debug("use=$use");
+			$this->debug('got ' . count($opData[$direction]['parts']) . ' part(s)');
+			if (is_array($parameters)) {
+				$parametersArrayType = $this->isArraySimpleOrStruct($parameters);
+				$this->debug('have ' . $parametersArrayType . ' parameters');
+				foreach($opData[$direction]['parts'] as $name => $type) {
+					$this->debug('serializing part "'.$name.'" of type "'.$type.'"');
+					// Track encoding style
+					if(isset($opData[$direction]['encodingStyle']) && $encodingStyle != $opData[$direction]['encodingStyle']) {
+						$encodingStyle = $opData[$direction]['encodingStyle'];			
+						$enc_style = $encodingStyle;
+					} else {
+						$enc_style = false;
+					}
+					// NOTE: add error handling here
+					// if serializeType returns false, then catch global error and fault
+					if ($parametersArrayType == 'arraySimple') {
+						$p = array_shift($parameters);
+						$this->debug('calling serializeType w/indexed param');
+						$xml .= $this->serializeType($name, $type, $p, $use, $enc_style);
+					} elseif (isset($parameters[$name])) {
+						$this->debug('calling serializeType w/named param');
+						$xml .= $this->serializeType($name, $type, $parameters[$name], $use, $enc_style);
+					} else {
+						// TODO: only send nillable
+						$this->debug('calling serializeType w/null param');
+						$xml .= $this->serializeType($name, $type, null, $use, $enc_style);
+					}
+				}
+			} else {
+				$this->debug('no parameters passed.');
+			}
+		}
+		$this->debug("serializeParameters returning: $xml");
+		return $xml;
+	} 
+	
+	/**
+	 * serializes a PHP value according a given type definition
+	 * 
+	 * @param string $name name of value (part or element)
+	 * @param string $type XML schema type of value (type or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $use use for part (encoded|literal)
+	 * @param string $encodingStyle SOAP encoding style for the value (if different than the enclosing style)
+	 * @param boolean $unqualified a kludge for what should be XML namespace form handling
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeType($name, $type, $value, $use='encoded', $encodingStyle=false, $unqualified=false)
+	{
+		$this->debug("in serializeType: name=$name, type=$type, use=$use, encodingStyle=$encodingStyle, unqualified=" . ($unqualified ? "unqualified" : "qualified"));
+		$this->appendDebug("value=" . $this->varDump($value));
+		if($use == 'encoded' && $encodingStyle) {
+			$encodingStyle = ' SOAP-ENV:encodingStyle="' . $encodingStyle . '"';
+		}
+
+		// if a soapval has been supplied, let its type override the WSDL
+    	if (is_object($value) && get_class($value) == 'soapval') {
+    		if ($value->type_ns) {
+    			$type = $value->type_ns . ':' . $value->type;
+		    	$forceType = true;
+		    	$this->debug("in serializeType: soapval overrides type to $type");
+    		} elseif ($value->type) {
+	    		$type = $value->type;
+		    	$forceType = true;
+		    	$this->debug("in serializeType: soapval overrides type to $type");
+	    	} else {
+	    		$forceType = false;
+		    	$this->debug("in serializeType: soapval does not override type");
+	    	}
+	    	$attrs = $value->attributes;
+	    	$value = $value->value;
+	    	$this->debug("in serializeType: soapval overrides value to $value");
+	    	if ($attrs) {
+	    		if (!is_array($value)) {
+	    			$value['!'] = $value;
+	    		}
+	    		foreach ($attrs as $n => $v) {
+	    			$value['!' . $n] = $v;
+	    		}
+		    	$this->debug("in serializeType: soapval provides attributes");
+		    }
+        } else {
+        	$forceType = false;
+        }
+
+		$xml = '';
+		if (strpos($type, ':')) {
+			$uqType = substr($type, strrpos($type, ':') + 1);
+			$ns = substr($type, 0, strrpos($type, ':'));
+			$this->debug("in serializeType: got a prefixed type: $uqType, $ns");
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+				$this->debug("in serializeType: expanded prefixed type: $uqType, $ns");
+			}
+
+			if($ns == $this->XMLSchemaVersion || $ns == 'http://schemas.xmlsoap.org/soap/encoding/'){
+				$this->debug('in serializeType: type namespace indicates XML Schema or SOAP Encoding type');
+				if ($unqualified  && $use == 'literal') {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+				if (is_null($value)) {
+					if ($use == 'literal') {
+						// TODO: depends on minOccurs
+						$xml = "<$name$elementNS/>";
+					} else {
+						// TODO: depends on nillable, which should be checked before calling this method
+						$xml = "<$name$elementNS xsi:nil=\"true\" xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"/>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+		    	if ($uqType == 'boolean') {
+		    		if ((is_string($value) && $value == 'false') || (! $value)) {
+						$value = 'false';
+					} else {
+						$value = 'true';
+					}
+				} 
+				if ($uqType == 'string' && gettype($value) == 'string') {
+					$value = $this->expandEntities($value);
+				}
+				if (($uqType == 'long' || $uqType == 'unsignedLong') && gettype($value) == 'double') {
+					$value = sprintf("%.0lf", $value);
+				}
+				// it's a scalar
+				// TODO: what about null/nil values?
+				// check type isn't a custom type extending xmlschema namespace
+				if (!$this->getTypeDef($uqType, $ns)) {
+					if ($use == 'literal') {
+						if ($forceType) {
+							$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">$value</$name>";
+						} else {
+							$xml = "<$name$elementNS>$value</$name>";
+						}
+					} else {
+						$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>$value</$name>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+				$this->debug('custom type extends XML Schema or SOAP Encoding namespace (yuck)');
+			} else if ($ns == 'http://xml.apache.org/xml-soap') {
+				$this->debug('in serializeType: appears to be Apache SOAP type');
+				if ($uqType == 'Map') {
+					$tt_prefix = $this->getPrefixFromNamespace('http://xml.apache.org/xml-soap');
+					if (! $tt_prefix) {
+						$this->debug('in serializeType: Add namespace for Apache SOAP type');
+						$tt_prefix = 'ns' . rand(1000, 9999);
+						$this->namespaces[$tt_prefix] = 'http://xml.apache.org/xml-soap';
+						// force this to be added to usedNamespaces
+						$tt_prefix = $this->getPrefixFromNamespace('http://xml.apache.org/xml-soap');
+					}
+					$contents = '';
+					foreach($value as $k => $v) {
+						$this->debug("serializing map element: key $k, value $v");
+						$contents .= '<item>';
+						$contents .= $this->serialize_val($k,'key',false,false,false,false,$use);
+						$contents .= $this->serialize_val($v,'value',false,false,false,false,$use);
+						$contents .= '</item>';
+					}
+					if ($use == 'literal') {
+						if ($forceType) {
+							$xml = "<$name xsi:type=\"" . $tt_prefix . ":$uqType\">$contents</$name>";
+						} else {
+							$xml = "<$name>$contents</$name>";
+						}
+					} else {
+						$xml = "<$name xsi:type=\"" . $tt_prefix . ":$uqType\"$encodingStyle>$contents</$name>";
+					}
+					$this->debug("in serializeType: returning: $xml");
+					return $xml;
+				}
+				$this->debug('in serializeType: Apache SOAP type, but only support Map');
+			}
+		} else {
+			// TODO: should the type be compared to types in XSD, and the namespace
+			// set to XSD if the type matches?
+			$this->debug("in serializeType: No namespace for type $type");
+			$ns = '';
+			$uqType = $type;
+		}
+		if(!$typeDef = $this->getTypeDef($uqType, $ns)){
+			$this->setError("$type ($uqType) is not a supported type.");
+			$this->debug("in serializeType: $type ($uqType) is not a supported type.");
+			return false;
+		} else {
+			$this->debug("in serializeType: found typeDef");
+			$this->appendDebug('typeDef=' . $this->varDump($typeDef));
+		}
+		$phpType = $typeDef['phpType'];
+		$this->debug("in serializeType: uqType: $uqType, ns: $ns, phptype: $phpType, arrayType: " . (isset($typeDef['arrayType']) ? $typeDef['arrayType'] : '') ); 
+		// if php type == struct, map value to the <all> element names
+		if ($phpType == 'struct') {
+			if (isset($typeDef['typeClass']) && $typeDef['typeClass'] == 'element') {
+				$elementName = $uqType;
+				if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+					$elementNS = " xmlns=\"$ns\"";
+				} else {
+					$elementNS = " xmlns=\"\"";
+				}
+			} else {
+				$elementName = $name;
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if (is_null($value)) {
+				if ($use == 'literal') {
+					// TODO: depends on minOccurs
+					$xml = "<$elementName$elementNS/>";
+				} else {
+					$xml = "<$elementName$elementNS xsi:nil=\"true\" xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"/>";
+				}
+				$this->debug("in serializeType: returning: $xml");
+				return $xml;
+			}
+			if (is_object($value)) {
+				$value = get_object_vars($value);
+			}
+			if (is_array($value)) {
+				$elementAttrs = $this->serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType);
+				if ($use == 'literal') {
+					if ($forceType) {
+						$xml = "<$elementName$elementNS$elementAttrs xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">";
+					} else {
+						$xml = "<$elementName$elementNS$elementAttrs>";
+					}
+				} else {
+					$xml = "<$elementName$elementNS$elementAttrs xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>";
+				}
+	
+				$xml .= $this->serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use, $encodingStyle);
+				$xml .= "</$elementName>";
+			} else {
+				$this->debug("in serializeType: phpType is struct, but value is not an array");
+				$this->setError("phpType is struct, but value is not an array: see debug output for details");
+				$xml = '';
+			}
+		} elseif ($phpType == 'array') {
+			if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+				$elementNS = " xmlns=\"$ns\"";
+			} else {
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if (is_null($value)) {
+				if ($use == 'literal') {
+					// TODO: depends on minOccurs
+					$xml = "<$name$elementNS/>";
+				} else {
+					$xml = "<$name$elementNS xsi:nil=\"true\" xsi:type=\"" .
+						$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/') .
+						":Array\" " .
+						$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/') .
+						':arrayType="' .
+						$this->getPrefixFromNamespace($this->getPrefix($typeDef['arrayType'])) .
+						':' .
+						$this->getLocalPart($typeDef['arrayType'])."[0]\"/>";
+				}
+				$this->debug("in serializeType: returning: $xml");
+				return $xml;
+			}
+			if (isset($typeDef['multidimensional'])) {
+				$nv = array();
+				foreach($value as $v) {
+					$cols = ',' . sizeof($v);
+					$nv = array_merge($nv, $v);
+				} 
+				$value = $nv;
+			} else {
+				$cols = '';
+			} 
+			if (is_array($value) && sizeof($value) >= 1) {
+				$rows = sizeof($value);
+				$contents = '';
+				foreach($value as $k => $v) {
+					$this->debug("serializing array element: $k, $v of type: $typeDef[arrayType]");
+					//if (strpos($typeDef['arrayType'], ':') ) {
+					if (!in_array($typeDef['arrayType'],$this->typemap['http://www.w3.org/2001/XMLSchema'])) {
+					    $contents .= $this->serializeType('item', $typeDef['arrayType'], $v, $use);
+					} else {
+					    $contents .= $this->serialize_val($v, 'item', $typeDef['arrayType'], null, $this->XMLSchemaVersion, false, $use);
+					} 
+				}
+			} else {
+				$rows = 0;
+				$contents = null;
+			}
+			// TODO: for now, an empty value will be serialized as a zero element
+			// array.  Revisit this when coding the handling of null/nil values.
+			if ($use == 'literal') {
+				$xml = "<$name$elementNS>"
+					.$contents
+					."</$name>";
+			} else {
+				$xml = "<$name$elementNS xsi:type=\"".$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/').':Array" '.
+					$this->getPrefixFromNamespace('http://schemas.xmlsoap.org/soap/encoding/')
+					.':arrayType="'
+					.$this->getPrefixFromNamespace($this->getPrefix($typeDef['arrayType']))
+					.":".$this->getLocalPart($typeDef['arrayType'])."[$rows$cols]\">"
+					.$contents
+					."</$name>";
+			}
+		} elseif ($phpType == 'scalar') {
+			if (isset($typeDef['form']) && ($typeDef['form'] == 'qualified')) {
+				$elementNS = " xmlns=\"$ns\"";
+			} else {
+				if ($unqualified) {
+					$elementNS = " xmlns=\"\"";
+				} else {
+					$elementNS = '';
+				}
+			}
+			if ($use == 'literal') {
+				if ($forceType) {
+					$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\">$value</$name>";
+				} else {
+					$xml = "<$name$elementNS>$value</$name>";
+				}
+			} else {
+				$xml = "<$name$elementNS xsi:type=\"" . $this->getPrefixFromNamespace($ns) . ":$uqType\"$encodingStyle>$value</$name>";
+			}
+		}
+		$this->debug("in serializeType: returning: $xml");
+		return $xml;
+	}
+	
+	/**
+	 * serializes the attributes for a complexType
+	 *
+	 * @param array $typeDef our internal representation of an XML schema type (or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $ns the namespace of the type
+	 * @param string $uqType the local part of the type
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType) {
+		$xml = '';
+		if (isset($typeDef['attrs']) && is_array($typeDef['attrs'])) {
+			$this->debug("serialize attributes for XML Schema type $ns:$uqType");
+			if (is_array($value)) {
+				$xvalue = $value;
+			} elseif (is_object($value)) {
+				$xvalue = get_object_vars($value);
+			} else {
+				$this->debug("value is neither an array nor an object for XML Schema type $ns:$uqType");
+				$xvalue = array();
+			}
+			foreach ($typeDef['attrs'] as $aName => $attrs) {
+				if (isset($xvalue['!' . $aName])) {
+					$xname = '!' . $aName;
+					$this->debug("value provided for attribute $aName with key $xname");
+				} elseif (isset($xvalue[$aName])) {
+					$xname = $aName;
+					$this->debug("value provided for attribute $aName with key $xname");
+				} elseif (isset($attrs['default'])) {
+					$xname = '!' . $aName;
+					$xvalue[$xname] = $attrs['default'];
+					$this->debug('use default value of ' . $xvalue[$aName] . ' for attribute ' . $aName);
+				} else {
+					$xname = '';
+					$this->debug("no value provided for attribute $aName");
+				}
+				if ($xname) {
+					$xml .=  " $aName=\"" . $this->expandEntities($xvalue[$xname]) . "\"";
+				}
+			} 
+		} else {
+			$this->debug("no attributes to serialize for XML Schema type $ns:$uqType");
+		}
+		if (isset($typeDef['extensionBase'])) {
+			$ns = $this->getPrefix($typeDef['extensionBase']);
+			$uqType = $this->getLocalPart($typeDef['extensionBase']);
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+			}
+			if ($typeDef = $this->getTypeDef($uqType, $ns)) {
+				$this->debug("serialize attributes for extension base $ns:$uqType");
+				$xml .= $this->serializeComplexTypeAttributes($typeDef, $value, $ns, $uqType);
+			} else {
+				$this->debug("extension base $ns:$uqType is not a supported type");
+			}
+		}
+		return $xml;
+	}
+
+	/**
+	 * serializes the elements for a complexType
+	 *
+	 * @param array $typeDef our internal representation of an XML schema type (or element)
+	 * @param mixed $value a native PHP value (parameter value)
+	 * @param string $ns the namespace of the type
+	 * @param string $uqType the local part of the type
+	 * @param string $use use for part (encoded|literal)
+	 * @param string $encodingStyle SOAP encoding style for the value (if different than the enclosing style)
+	 * @return string value serialized as an XML string
+	 * @access private
+	 */
+	function serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use='encoded', $encodingStyle=false) {
+		$xml = '';
+		if (isset($typeDef['elements']) && is_array($typeDef['elements'])) {
+			$this->debug("in serializeComplexTypeElements, serialize elements for XML Schema type $ns:$uqType");
+			if (is_array($value)) {
+				$xvalue = $value;
+			} elseif (is_object($value)) {
+				$xvalue = get_object_vars($value);
+			} else {
+				$this->debug("value is neither an array nor an object for XML Schema type $ns:$uqType");
+				$xvalue = array();
+			}
+			// toggle whether all elements are present - ideally should validate against schema
+			if (count($typeDef['elements']) != count($xvalue)){
+				$optionals = true;
+			}
+			foreach ($typeDef['elements'] as $eName => $attrs) {
+				if (!isset($xvalue[$eName])) {
+					if (isset($attrs['default'])) {
+						$xvalue[$eName] = $attrs['default'];
+						$this->debug('use default value of ' . $xvalue[$eName] . ' for element ' . $eName);
+					}
+				}
+				// if user took advantage of a minOccurs=0, then only serialize named parameters
+				if (isset($optionals)
+				    && (!isset($xvalue[$eName])) 
+					&& ( (!isset($attrs['nillable'])) || $attrs['nillable'] != 'true')
+					){
+					if (isset($attrs['minOccurs']) && $attrs['minOccurs'] <> '0') {
+						$this->debug("apparent error: no value provided for element $eName with minOccurs=" . $attrs['minOccurs']);
+					}
+					// do nothing
+					$this->debug("no value provided for complexType element $eName and element is not nillable, so serialize nothing");
+				} else {
+					// get value
+					if (isset($xvalue[$eName])) {
+					    $v = $xvalue[$eName];
+					} else {
+					    $v = null;
+					}
+					if (isset($attrs['form'])) {
+						$unqualified = ($attrs['form'] == 'unqualified');
+					} else {
+						$unqualified = false;
+					}
+					if (isset($attrs['maxOccurs']) && ($attrs['maxOccurs'] == 'unbounded' || $attrs['maxOccurs'] > 1) && isset($v) && is_array($v) && $this->isArraySimpleOrStruct($v) == 'arraySimple') {
+						$vv = $v;
+						foreach ($vv as $k => $v) {
+							if (isset($attrs['type']) || isset($attrs['ref'])) {
+								// serialize schema-defined type
+							    $xml .= $this->serializeType($eName, isset($attrs['type']) ? $attrs['type'] : $attrs['ref'], $v, $use, $encodingStyle, $unqualified);
+							} else {
+								// serialize generic type (can this ever really happen?)
+							    $this->debug("calling serialize_val() for $v, $eName, false, false, false, false, $use");
+							    $xml .= $this->serialize_val($v, $eName, false, false, false, false, $use);
+							}
+						}
+					} else {
+						if (isset($attrs['type']) || isset($attrs['ref'])) {
+							// serialize schema-defined type
+						    $xml .= $this->serializeType($eName, isset($attrs['type']) ? $attrs['type'] : $attrs['ref'], $v, $use, $encodingStyle, $unqualified);
+						} else {
+							// serialize generic type (can this ever really happen?)
+						    $this->debug("calling serialize_val() for $v, $eName, false, false, false, false, $use");
+						    $xml .= $this->serialize_val($v, $eName, false, false, false, false, $use);
+						}
+					}
+				}
+			} 
+		} else {
+			$this->debug("no elements to serialize for XML Schema type $ns:$uqType");
+		}
+		if (isset($typeDef['extensionBase'])) {
+			$ns = $this->getPrefix($typeDef['extensionBase']);
+			$uqType = $this->getLocalPart($typeDef['extensionBase']);
+			if ($this->getNamespaceFromPrefix($ns)) {
+				$ns = $this->getNamespaceFromPrefix($ns);
+			}
+			if ($typeDef = $this->getTypeDef($uqType, $ns)) {
+				$this->debug("serialize elements for extension base $ns:$uqType");
+				$xml .= $this->serializeComplexTypeElements($typeDef, $value, $ns, $uqType, $use, $encodingStyle);
+			} else {
+				$this->debug("extension base $ns:$uqType is not a supported type");
+			}
+		}
+		return $xml;
+	}
+
+	/**
+	* adds an XML Schema complex type to the WSDL types
+	*
+	* @param string	name
+	* @param string typeClass (complexType|simpleType|attribute)
+	* @param string phpType: currently supported are array and struct (php assoc array)
+	* @param string compositor (all|sequence|choice)
+	* @param string restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param array elements = array ( name => array(name=>'',type=>'') )
+	* @param array attrs = 	array(array('ref'=>'SOAP-ENC:arrayType','wsdl:arrayType'=>'xsd:string[]'))
+	* @param string arrayType: namespace:name (xsd:string)
+	* @see xmlschema
+	* @access public
+	*/
+	function addComplexType($name,$typeClass='complexType',$phpType='array',$compositor='',$restrictionBase='',$elements=array(),$attrs=array(),$arrayType='') {
+		if (count($elements) > 0) {
+	    	foreach($elements as $n => $e){
+	            // expand each element
+	            foreach ($e as $k => $v) {
+		            $k = strpos($k,':') ? $this->expandQname($k) : $k;
+		            $v = strpos($v,':') ? $this->expandQname($v) : $v;
+		            $ee[$k] = $v;
+		    	}
+	    		$eElements[$n] = $ee;
+	    	}
+	    	$elements = $eElements;
+		}
+		
+		if (count($attrs) > 0) {
+	    	foreach($attrs as $n => $a){
+	            // expand each attribute
+	            foreach ($a as $k => $v) {
+		            $k = strpos($k,':') ? $this->expandQname($k) : $k;
+		            $v = strpos($v,':') ? $this->expandQname($v) : $v;
+		            $aa[$k] = $v;
+		    	}
+	    		$eAttrs[$n] = $aa;
+	    	}
+	    	$attrs = $eAttrs;
+		}
+
+		$restrictionBase = strpos($restrictionBase,':') ? $this->expandQname($restrictionBase) : $restrictionBase;
+		$arrayType = strpos($arrayType,':') ? $this->expandQname($arrayType) : $arrayType;
+
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addComplexType($name,$typeClass,$phpType,$compositor,$restrictionBase,$elements,$attrs,$arrayType);
+	}
+
+	/**
+	* adds an XML Schema simple type to the WSDL types
+	*
+	* @param string $name
+	* @param string $restrictionBase namespace:name (http://schemas.xmlsoap.org/soap/encoding/:Array)
+	* @param string $typeClass (should always be simpleType)
+	* @param string $phpType (should always be scalar)
+	* @param array $enumeration array of values
+	* @see xmlschema
+	* @access public
+	*/
+	function addSimpleType($name, $restrictionBase='', $typeClass='simpleType', $phpType='scalar', $enumeration=array()) {
+		$restrictionBase = strpos($restrictionBase,':') ? $this->expandQname($restrictionBase) : $restrictionBase;
+
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addSimpleType($name, $restrictionBase, $typeClass, $phpType, $enumeration);
+	}
+
+	/**
+	* adds an element to the WSDL types
+	*
+	* @param array $attrs attributes that must include name and type
+	* @see xmlschema
+	* @access public
+	*/
+	function addElement($attrs) {
+		$typens = isset($this->namespaces['types']) ? $this->namespaces['types'] : $this->namespaces['tns'];
+		$this->schemas[$typens][0]->addElement($attrs);
+	}
+
+	/**
+	* register an operation with the server
+	* 
+	* @param string $name operation (method) name
+	* @param array $in assoc array of input values: key = param name, value = param type
+	* @param array $out assoc array of output values: key = param name, value = param type
+	* @param string $namespace optional The namespace for the operation
+	* @param string $soapaction optional The soapaction for the operation
+	* @param string $style (rpc|document) optional The style for the operation Note: when 'document' is specified, parameter and return wrappers are created for you automatically
+	* @param string $use (encoded|literal) optional The use for the parameters (cannot mix right now)
+	* @param string $documentation optional The description to include in the WSDL
+	* @param string $encodingStyle optional (usually 'http://schemas.xmlsoap.org/soap/encoding/' for encoded)
+	* @access public 
+	*/
+	function addOperation($name, $in = false, $out = false, $namespace = false, $soapaction = false, $style = 'rpc', $use = 'encoded', $documentation = '', $encodingStyle = ''){
+		if ($use == 'encoded' && $encodingStyle == '') {
+			$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+		}
+
+		if ($style == 'document') {
+			$elements = array();
+			foreach ($in as $n => $t) {
+				$elements[$n] = array('name' => $n, 'type' => $t);
+			}
+			$this->addComplexType($name . 'RequestType', 'complexType', 'struct', 'all', '', $elements);
+			$this->addElement(array('name' => $name, 'type' => $name . 'RequestType'));
+			$in = array('parameters' => 'tns:' . $name);
+
+			$elements = array();
+			foreach ($out as $n => $t) {
+				$elements[$n] = array('name' => $n, 'type' => $t);
+			}
+			$this->addComplexType($name . 'ResponseType', 'complexType', 'struct', 'all', '', $elements);
+			$this->addElement(array('name' => $name . 'Response', 'type' => $name . 'ResponseType'));
+			$out = array('parameters' => 'tns:' . $name . 'Response');
+		}
+
+		// get binding
+		$this->bindings[ $this->serviceName . 'Binding' ]['operations'][$name] =
+		array(
+		'name' => $name,
+		'binding' => $this->serviceName . 'Binding',
+		'endpoint' => $this->endpoint,
+		'soapAction' => $soapaction,
+		'style' => $style,
+		'input' => array(
+			'use' => $use,
+			'namespace' => $namespace,
+			'encodingStyle' => $encodingStyle,
+			'message' => $name . 'Request',
+			'parts' => $in),
+		'output' => array(
+			'use' => $use,
+			'namespace' => $namespace,
+			'encodingStyle' => $encodingStyle,
+			'message' => $name . 'Response',
+			'parts' => $out),
+		'namespace' => $namespace,
+		'transport' => 'http://schemas.xmlsoap.org/soap/http',
+		'documentation' => $documentation); 
+		// add portTypes
+		// add messages
+		if($in)
+		{
+			foreach($in as $pName => $pType)
+			{
+				if(strpos($pType,':')) {
+					$pType = $this->getNamespaceFromPrefix($this->getPrefix($pType)).":".$this->getLocalPart($pType);
+				}
+				$this->messages[$name.'Request'][$pName] = $pType;
+			}
+		} else {
+            $this->messages[$name.'Request']= '0';
+        }
+		if($out)
+		{
+			foreach($out as $pName => $pType)
+			{
+				if(strpos($pType,':')) {
+					$pType = $this->getNamespaceFromPrefix($this->getPrefix($pType)).":".$this->getLocalPart($pType);
+				}
+				$this->messages[$name.'Response'][$pName] = $pType;
+			}
+		} else {
+            $this->messages[$name.'Response']= '0';
+        }
+		return true;
+	} 
+}
+?><?php
+
+
+
+/**
+*
+* soap_parser class parses SOAP XML messages into native PHP values
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soap_parser extends nusoap_base {
+
+	var $xml = '';
+	var $xml_encoding = '';
+	var $method = '';
+	var $root_struct = '';
+	var $root_struct_name = '';
+	var $root_struct_namespace = '';
+	var $root_header = '';
+    var $document = '';			// incoming SOAP body (text)
+	// determines where in the message we are (envelope,header,body,method)
+	var $status = '';
+	var $position = 0;
+	var $depth = 0;
+	var $default_namespace = '';
+	var $namespaces = array();
+	var $message = array();
+    var $parent = '';
+	var $fault = false;
+	var $fault_code = '';
+	var $fault_str = '';
+	var $fault_detail = '';
+	var $depth_array = array();
+	var $debug_flag = true;
+	var $soapresponse = NULL;
+	var $responseHeaders = '';	// incoming SOAP headers (text)
+	var $body_position = 0;
+	// for multiref parsing:
+	// array of id => pos
+	var $ids = array();
+	// array of id => hrefs => pos
+	var $multirefs = array();
+	// toggle for auto-decoding element content
+	var $decode_utf8 = true;
+
+	/**
+	* constructor that actually does the parsing
+	*
+	* @param    string $xml SOAP message
+	* @param    string $encoding character encoding scheme of message
+	* @param    string $method method for which XML is parsed (unused?)
+	* @param    string $decode_utf8 whether to decode UTF-8 to ISO-8859-1
+	* @access   public
+	*/
+	function soap_parser($xml,$encoding='UTF-8',$method='',$decode_utf8=true){
+		parent::nusoap_base();
+		$this->xml = $xml;
+		$this->xml_encoding = $encoding;
+		$this->method = $method;
+		$this->decode_utf8 = $decode_utf8;
+
+		// Check whether content has been read.
+		if(!empty($xml)){
+			// Check XML encoding
+			$pos_xml = strpos($xml, '<?xml');
+			if ($pos_xml !== FALSE) {
+				$xml_decl = substr($xml, $pos_xml, strpos($xml, '?>', $pos_xml + 2) - $pos_xml + 1);
+				if (preg_match("/encoding=[\"']([^\"']*)[\"']/", $xml_decl, $res)) {
+					$xml_encoding = $res[1];
+					if (strtoupper($xml_encoding) != $encoding) {
+						$err = "Charset from HTTP Content-Type '" . $encoding . "' does not match encoding from XML declaration '" . $xml_encoding . "'";
+						$this->debug($err);
+						if ($encoding != 'ISO-8859-1' || strtoupper($xml_encoding) != 'UTF-8') {
+							$this->setError($err);
+							return;
+						}
+						// when HTTP says ISO-8859-1 (the default) and XML says UTF-8 (the typical), assume the other endpoint is just sloppy and proceed
+					} else {
+						$this->debug('Charset from HTTP Content-Type matches encoding from XML declaration');
+					}
+				} else {
+					$this->debug('No encoding specified in XML declaration');
+				}
+			} else {
+				$this->debug('No XML declaration');
+			}
+			$this->debug('Entering soap_parser(), length='.strlen($xml).', encoding='.$encoding);
+			// Create an XML parser - why not xml_parser_create_ns?
+			$this->parser = xml_parser_create($this->xml_encoding);
+			// Set the options for parsing the XML data.
+			//xml_parser_set_option($parser, XML_OPTION_SKIP_WHITE, 1);
+			xml_parser_set_option($this->parser, XML_OPTION_CASE_FOLDING, 0);
+			xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, $this->xml_encoding);
+			// Set the object for the parser.
+			xml_set_object($this->parser, $this);
+			// Set the element handlers for the parser.
+			xml_set_element_handler($this->parser, 'start_element','end_element');
+			xml_set_character_data_handler($this->parser,'character_data');
+
+			// Parse the XML file.
+			if(!xml_parse($this->parser,$xml,true)){
+			    // Display an error message.
+			    $err = sprintf('XML error parsing SOAP payload on line %d: %s',
+			    xml_get_current_line_number($this->parser),
+			    xml_error_string(xml_get_error_code($this->parser)));
+				$this->debug($err);
+				$this->debug("XML payload:\n" . $xml);
+				$this->setError($err);
+			} else {
+				$this->debug('parsed successfully, found root struct: '.$this->root_struct.' of name '.$this->root_struct_name);
+				// get final value
+				$this->soapresponse = $this->message[$this->root_struct]['result'];
+				// get header value: no, because this is documented as XML string
+//				if($this->root_header != '' && isset($this->message[$this->root_header]['result'])){
+//					$this->responseHeaders = $this->message[$this->root_header]['result'];
+//				}
+				// resolve hrefs/ids
+				if(sizeof($this->multirefs) > 0){
+					foreach($this->multirefs as $id => $hrefs){
+						$this->debug('resolving multirefs for id: '.$id);
+						$idVal = $this->buildVal($this->ids[$id]);
+						if (is_array($idVal) && isset($idVal['!id'])) {
+							unset($idVal['!id']);
+						}
+						foreach($hrefs as $refPos => $ref){
+							$this->debug('resolving href at pos '.$refPos);
+							$this->multirefs[$id][$refPos] = $idVal;
+						}
+					}
+				}
+			}
+			xml_parser_free($this->parser);
+		} else {
+			$this->debug('xml was empty, didn\'t parse!');
+			$this->setError('xml was empty, didn\'t parse!');
+		}
+	}
+
+	/**
+	* start-element handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $name element name
+	* @param    array $attrs associative array of attributes
+	* @access   private
+	*/
+	function start_element($parser, $name, $attrs) {
+		// position in a total number of elements, starting from 0
+		// update class level pos
+		$pos = $this->position++;
+		// and set mine
+		$this->message[$pos] = array('pos' => $pos,'children'=>'','cdata'=>'');
+		// depth = how many levels removed from root?
+		// set mine as current global depth and increment global depth value
+		$this->message[$pos]['depth'] = $this->depth++;
+
+		// else add self as child to whoever the current parent is
+		if($pos != 0){
+			$this->message[$this->parent]['children'] .= '|'.$pos;
+		}
+		// set my parent
+		$this->message[$pos]['parent'] = $this->parent;
+		// set self as current parent
+		$this->parent = $pos;
+		// set self as current value for this depth
+		$this->depth_array[$this->depth] = $pos;
+		// get element prefix
+		if(strpos($name,':')){
+			// get ns prefix
+			$prefix = substr($name,0,strpos($name,':'));
+			// get unqualified name
+			$name = substr(strstr($name,':'),1);
+		}
+		// set status
+		if($name == 'Envelope'){
+			$this->status = 'envelope';
+		} elseif($name == 'Header'){
+			$this->root_header = $pos;
+			$this->status = 'header';
+		} elseif($name == 'Body'){
+			$this->status = 'body';
+			$this->body_position = $pos;
+		// set method
+		} elseif($this->status == 'body' && $pos == ($this->body_position+1)){
+			$this->status = 'method';
+			$this->root_struct_name = $name;
+			$this->root_struct = $pos;
+			$this->message[$pos]['type'] = 'struct';
+			$this->debug("found root struct $this->root_struct_name, pos $this->root_struct");
+		}
+		// set my status
+		$this->message[$pos]['status'] = $this->status;
+		// set name
+		$this->message[$pos]['name'] = htmlspecialchars($name);
+		// set attrs
+		$this->message[$pos]['attrs'] = $attrs;
+
+		// loop through atts, logging ns and type declarations
+        $attstr = '';
+		foreach($attrs as $key => $value){
+        	$key_prefix = $this->getPrefix($key);
+			$key_localpart = $this->getLocalPart($key);
+			// if ns declarations, add to class level array of valid namespaces
+            if($key_prefix == 'xmlns'){
+				if(ereg('^http://www.w3.org/[0-9]{4}/XMLSchema$',$value)){
+					$this->XMLSchemaVersion = $value;
+					$this->namespaces['xsd'] = $this->XMLSchemaVersion;
+					$this->namespaces['xsi'] = $this->XMLSchemaVersion.'-instance';
+				}
+                $this->namespaces[$key_localpart] = $value;
+				// set method namespace
+				if($name == $this->root_struct_name){
+					$this->methodNamespace = $value;
+				}
+			// if it's a type declaration, set type
+            } elseif($key_localpart == 'type'){
+            	$value_prefix = $this->getPrefix($value);
+                $value_localpart = $this->getLocalPart($value);
+				$this->message[$pos]['type'] = $value_localpart;
+				$this->message[$pos]['typePrefix'] = $value_prefix;
+                if(isset($this->namespaces[$value_prefix])){
+                	$this->message[$pos]['type_namespace'] = $this->namespaces[$value_prefix];
+                } else if(isset($attrs['xmlns:'.$value_prefix])) {
+					$this->message[$pos]['type_namespace'] = $attrs['xmlns:'.$value_prefix];
+                }
+				// should do something here with the namespace of specified type?
+			} elseif($key_localpart == 'arrayType'){
+				$this->message[$pos]['type'] = 'array';
+				/* do arrayType ereg here
+				[1]    arrayTypeValue    ::=    atype asize
+				[2]    atype    ::=    QName rank*
+				[3]    rank    ::=    '[' (',')* ']'
+				[4]    asize    ::=    '[' length~ ']'
+				[5]    length    ::=    nextDimension* Digit+
+				[6]    nextDimension    ::=    Digit+ ','
+				*/
+				$expr = '([A-Za-z0-9_]+):([A-Za-z]+[A-Za-z0-9_]+)\[([0-9]+),?([0-9]*)\]';
+				if(ereg($expr,$value,$regs)){
+					$this->message[$pos]['typePrefix'] = $regs[1];
+					$this->message[$pos]['arrayTypePrefix'] = $regs[1];
+	                if (isset($this->namespaces[$regs[1]])) {
+	                	$this->message[$pos]['arrayTypeNamespace'] = $this->namespaces[$regs[1]];
+	                } else if (isset($attrs['xmlns:'.$regs[1]])) {
+						$this->message[$pos]['arrayTypeNamespace'] = $attrs['xmlns:'.$regs[1]];
+	                }
+					$this->message[$pos]['arrayType'] = $regs[2];
+					$this->message[$pos]['arraySize'] = $regs[3];
+					$this->message[$pos]['arrayCols'] = $regs[4];
+				}
+			// specifies nil value (or not)
+			} elseif ($key_localpart == 'nil'){
+				$this->message[$pos]['nil'] = ($value == 'true' || $value == '1');
+			// some other attribute
+			} elseif ($key != 'href' && $key != 'xmlns' && $key_localpart != 'encodingStyle' && $key_localpart != 'root') {
+				$this->message[$pos]['xattrs']['!' . $key] = $value;
+			}
+
+			if ($key == 'xmlns') {
+				$this->default_namespace = $value;
+			}
+			// log id
+			if($key == 'id'){
+				$this->ids[$value] = $pos;
+			}
+			// root
+			if($key_localpart == 'root' && $value == 1){
+				$this->status = 'method';
+				$this->root_struct_name = $name;
+				$this->root_struct = $pos;
+				$this->debug("found root struct $this->root_struct_name, pos $pos");
+			}
+            // for doclit
+            $attstr .= " $key=\"$value\"";
+		}
+        // get namespace - must be done after namespace atts are processed
+		if(isset($prefix)){
+			$this->message[$pos]['namespace'] = $this->namespaces[$prefix];
+			$this->default_namespace = $this->namespaces[$prefix];
+		} else {
+			$this->message[$pos]['namespace'] = $this->default_namespace;
+		}
+        if($this->status == 'header'){
+        	if ($this->root_header != $pos) {
+	        	$this->responseHeaders .= "<" . (isset($prefix) ? $prefix . ':' : '') . "$name$attstr>";
+	        }
+        } elseif($this->root_struct_name != ''){
+        	$this->document .= "<" . (isset($prefix) ? $prefix . ':' : '') . "$name$attstr>";
+        }
+	}
+
+	/**
+	* end-element handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $name element name
+	* @access   private
+	*/
+	function end_element($parser, $name) {
+		// position of current element is equal to the last value left in depth_array for my depth
+		$pos = $this->depth_array[$this->depth--];
+
+        // get element prefix
+		if(strpos($name,':')){
+			// get ns prefix
+			$prefix = substr($name,0,strpos($name,':'));
+			// get unqualified name
+			$name = substr(strstr($name,':'),1);
+		}
+		
+		// build to native type
+		if(isset($this->body_position) && $pos > $this->body_position){
+			// deal w/ multirefs
+			if(isset($this->message[$pos]['attrs']['href'])){
+				// get id
+				$id = substr($this->message[$pos]['attrs']['href'],1);
+				// add placeholder to href array
+				$this->multirefs[$id][$pos] = 'placeholder';
+				// add set a reference to it as the result value
+				$this->message[$pos]['result'] =& $this->multirefs[$id][$pos];
+            // build complexType values
+			} elseif($this->message[$pos]['children'] != ''){
+				// if result has already been generated (struct/array)
+				if(!isset($this->message[$pos]['result'])){
+					$this->message[$pos]['result'] = $this->buildVal($pos);
+				}
+			// build complexType values of attributes and possibly simpleContent
+			} elseif (isset($this->message[$pos]['xattrs'])) {
+				if (isset($this->message[$pos]['nil']) && $this->message[$pos]['nil']) {
+					$this->message[$pos]['xattrs']['!'] = null;
+				} elseif (isset($this->message[$pos]['cdata']) && trim($this->message[$pos]['cdata']) != '') {
+	            	if (isset($this->message[$pos]['type'])) {
+						$this->message[$pos]['xattrs']['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+					} else {
+						$parent = $this->message[$pos]['parent'];
+						if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+							$this->message[$pos]['xattrs']['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+						} else {
+							$this->message[$pos]['xattrs']['!'] = $this->message[$pos]['cdata'];
+						}
+					}
+				}
+				$this->message[$pos]['result'] = $this->message[$pos]['xattrs'];
+			// set value of simpleType (or nil complexType)
+			} else {
+            	//$this->debug('adding data for scalar value '.$this->message[$pos]['name'].' of value '.$this->message[$pos]['cdata']);
+				if (isset($this->message[$pos]['nil']) && $this->message[$pos]['nil']) {
+					$this->message[$pos]['xattrs']['!'] = null;
+				} elseif (isset($this->message[$pos]['type'])) {
+					$this->message[$pos]['result'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+				} else {
+					$parent = $this->message[$pos]['parent'];
+					if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+						$this->message[$pos]['result'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+					} else {
+						$this->message[$pos]['result'] = $this->message[$pos]['cdata'];
+					}
+				}
+
+				/* add value to parent's result, if parent is struct/array
+				$parent = $this->message[$pos]['parent'];
+				if($this->message[$parent]['type'] != 'map'){
+					if(strtolower($this->message[$parent]['type']) == 'array'){
+						$this->message[$parent]['result'][] = $this->message[$pos]['result'];
+					} else {
+						$this->message[$parent]['result'][$this->message[$pos]['name']] = $this->message[$pos]['result'];
+					}
+				}
+				*/
+			}
+		}
+		
+        // for doclit
+        if($this->status == 'header'){
+        	if ($this->root_header != $pos) {
+	        	$this->responseHeaders .= "</" . (isset($prefix) ? $prefix . ':' : '') . "$name>";
+	        }
+        } elseif($pos >= $this->root_struct){
+        	$this->document .= "</" . (isset($prefix) ? $prefix . ':' : '') . "$name>";
+        }
+		// switch status
+		if($pos == $this->root_struct){
+			$this->status = 'body';
+			$this->root_struct_namespace = $this->message[$pos]['namespace'];
+		} elseif($name == 'Body'){
+			$this->status = 'envelope';
+		 } elseif($name == 'Header'){
+			$this->status = 'envelope';
+		} elseif($name == 'Envelope'){
+			//
+		}
+		// set parent back to my parent
+		$this->parent = $this->message[$pos]['parent'];
+	}
+
+	/**
+	* element content handler
+	*
+	* @param    resource $parser XML parser object
+	* @param    string $data element content
+	* @access   private
+	*/
+	function character_data($parser, $data){
+		$pos = $this->depth_array[$this->depth];
+		if ($this->xml_encoding=='UTF-8'){
+			// TODO: add an option to disable this for folks who want
+			// raw UTF-8 that, e.g., might not map to iso-8859-1
+			// TODO: this can also be handled with xml_parser_set_option($this->parser, XML_OPTION_TARGET_ENCODING, "ISO-8859-1");
+			if($this->decode_utf8){
+				$data = utf8_decode($data);
+			}
+		}
+        $this->message[$pos]['cdata'] .= $data;
+        // for doclit
+        if($this->status == 'header'){
+        	$this->responseHeaders .= $data;
+        } else {
+        	$this->document .= $data;
+        }
+	}
+
+	/**
+	* get the parsed message
+	*
+	* @return	mixed
+	* @access   public
+	*/
+	function get_response(){
+		return $this->soapresponse;
+	}
+
+	/**
+	* get the parsed headers
+	*
+	* @return	string XML or empty if no headers
+	* @access   public
+	*/
+	function getHeaders(){
+	    return $this->responseHeaders;
+	}
+
+	/**
+	* decodes simple types into PHP variables
+	*
+	* @param    string $value value to decode
+	* @param    string $type XML type to decode
+	* @param    string $typens XML type namespace to decode
+	* @return	mixed PHP value
+	* @access   private
+	*/
+	function decodeSimple($value, $type, $typens) {
+		// TODO: use the namespace!
+		if ((!isset($type)) || $type == 'string' || $type == 'long' || $type == 'unsignedLong') {
+			return (string) $value;
+		}
+		if ($type == 'int' || $type == 'integer' || $type == 'short' || $type == 'byte') {
+			return (int) $value;
+		}
+		if ($type == 'float' || $type == 'double' || $type == 'decimal') {
+			return (double) $value;
+		}
+		if ($type == 'boolean') {
+			if (strtolower($value) == 'false' || strtolower($value) == 'f') {
+				return false;
+			}
+			return (boolean) $value;
+		}
+		if ($type == 'base64' || $type == 'base64Binary') {
+			$this->debug('Decode base64 value');
+			return base64_decode($value);
+		}
+		// obscure numeric types
+		if ($type == 'nonPositiveInteger' || $type == 'negativeInteger'
+			|| $type == 'nonNegativeInteger' || $type == 'positiveInteger'
+			|| $type == 'unsignedInt'
+			|| $type == 'unsignedShort' || $type == 'unsignedByte') {
+			return (int) $value;
+		}
+		// bogus: parser treats array with no elements as a simple type
+		if ($type == 'array') {
+			return array();
+		}
+		// everything else
+		return (string) $value;
+	}
+
+	/**
+	* builds response structures for compound values (arrays/structs)
+	* and scalars
+	*
+	* @param    integer $pos position in node tree
+	* @return	mixed	PHP value
+	* @access   private
+	*/
+	function buildVal($pos){
+		if(!isset($this->message[$pos]['type'])){
+			$this->message[$pos]['type'] = '';
+		}
+		$this->debug('in buildVal() for '.$this->message[$pos]['name']."(pos $pos) of type ".$this->message[$pos]['type']);
+		// if there are children...
+		if($this->message[$pos]['children'] != ''){
+			$this->debug('in buildVal, there are children');
+			$children = explode('|',$this->message[$pos]['children']);
+			array_shift($children); // knock off empty
+			// md array
+			if(isset($this->message[$pos]['arrayCols']) && $this->message[$pos]['arrayCols'] != ''){
+            	$r=0; // rowcount
+            	$c=0; // colcount
+            	foreach($children as $child_pos){
+					$this->debug("in buildVal, got an MD array element: $r, $c");
+					$params[$r][] = $this->message[$child_pos]['result'];
+				    $c++;
+				    if($c == $this->message[$pos]['arrayCols']){
+				    	$c = 0;
+						$r++;
+				    }
+                }
+            // array
+			} elseif($this->message[$pos]['type'] == 'array' || $this->message[$pos]['type'] == 'Array'){
+                $this->debug('in buildVal, adding array '.$this->message[$pos]['name']);
+                foreach($children as $child_pos){
+                	$params[] = &$this->message[$child_pos]['result'];
+                }
+            // apache Map type: java hashtable
+            } elseif($this->message[$pos]['type'] == 'Map' && $this->message[$pos]['type_namespace'] == 'http://xml.apache.org/xml-soap'){
+                $this->debug('in buildVal, Java Map '.$this->message[$pos]['name']);
+                foreach($children as $child_pos){
+                	$kv = explode("|",$this->message[$child_pos]['children']);
+                   	$params[$this->message[$kv[1]]['result']] = &$this->message[$kv[2]]['result'];
+                }
+            // generic compound type
+            //} elseif($this->message[$pos]['type'] == 'SOAPStruct' || $this->message[$pos]['type'] == 'struct') {
+		    } else {
+	    		// Apache Vector type: treat as an array
+                $this->debug('in buildVal, adding Java Vector '.$this->message[$pos]['name']);
+				if ($this->message[$pos]['type'] == 'Vector' && $this->message[$pos]['type_namespace'] == 'http://xml.apache.org/xml-soap') {
+					$notstruct = 1;
+				} else {
+					$notstruct = 0;
+	            }
+            	//
+            	foreach($children as $child_pos){
+            		if($notstruct){
+            			$params[] = &$this->message[$child_pos]['result'];
+            		} else {
+            			if (isset($params[$this->message[$child_pos]['name']])) {
+            				// de-serialize repeated element name into an array
+            				if ((!is_array($params[$this->message[$child_pos]['name']])) || (!isset($params[$this->message[$child_pos]['name']][0]))) {
+            					$params[$this->message[$child_pos]['name']] = array($params[$this->message[$child_pos]['name']]);
+            				}
+            				$params[$this->message[$child_pos]['name']][] = &$this->message[$child_pos]['result'];
+            			} else {
+					    	$params[$this->message[$child_pos]['name']] = &$this->message[$child_pos]['result'];
+					    }
+                	}
+                }
+			}
+			if (isset($this->message[$pos]['xattrs'])) {
+                $this->debug('in buildVal, handling attributes');
+				foreach ($this->message[$pos]['xattrs'] as $n => $v) {
+					$params[$n] = $v;
+				}
+			}
+			// handle simpleContent
+			if (isset($this->message[$pos]['cdata']) && trim($this->message[$pos]['cdata']) != '') {
+                $this->debug('in buildVal, handling simpleContent');
+            	if (isset($this->message[$pos]['type'])) {
+					$params['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+				} else {
+					$parent = $this->message[$pos]['parent'];
+					if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+						$params['!'] = $this->decodeSimple($this->message[$pos]['cdata'], $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+					} else {
+						$params['!'] = $this->message[$pos]['cdata'];
+					}
+				}
+			}
+			return is_array($params) ? $params : array();
+		} else {
+        	$this->debug('in buildVal, no children, building scalar');
+			$cdata = isset($this->message[$pos]['cdata']) ? $this->message[$pos]['cdata'] : '';
+        	if (isset($this->message[$pos]['type'])) {
+				return $this->decodeSimple($cdata, $this->message[$pos]['type'], isset($this->message[$pos]['type_namespace']) ? $this->message[$pos]['type_namespace'] : '');
+			}
+			$parent = $this->message[$pos]['parent'];
+			if (isset($this->message[$parent]['type']) && ($this->message[$parent]['type'] == 'array') && isset($this->message[$parent]['arrayType'])) {
+				return $this->decodeSimple($cdata, $this->message[$parent]['arrayType'], isset($this->message[$parent]['arrayTypeNamespace']) ? $this->message[$parent]['arrayTypeNamespace'] : '');
+			}
+           	return $this->message[$pos]['cdata'];
+		}
+	}
+}
+
+
+
+?><?php
+
+
+
+/**
+*
+* soapclient higher level class for easy usage.
+*
+* usage:
+*
+* // instantiate client with server info
+* $soapclient = new soapclient( string path [ ,boolean wsdl] );
+*
+* // call method, get results
+* echo $soapclient->call( string methodname [ ,array parameters] );
+*
+* // bye bye client
+* unset($soapclient);
+*
+* @author   Dietrich Ayala <dietrich at ganx4.com>
+* @version  $Id: nusoap.php,v 1.94 2005/08/04 01:27:42 snichol Exp $
+* @access   public
+*/
+class soapclient extends nusoap_base  {
+
+	var $username = '';
+	var $password = '';
+	var $authtype = '';
+	var $certRequest = array();
+	var $requestHeaders = false;	// SOAP headers in request (text)
+	var $responseHeaders = '';		// SOAP headers from response (incomplete namespace resolution) (text)
+	var $document = '';				// SOAP body response portion (incomplete namespace resolution) (text)
+	var $endpoint;
+	var $forceEndpoint = '';		// overrides WSDL endpoint
+    var $proxyhost = '';
+    var $proxyport = '';
+	var $proxyusername = '';
+	var $proxypassword = '';
+    var $xml_encoding = '';			// character set encoding of incoming (response) messages
+	var $http_encoding = false;
+	var $timeout = 0;				// HTTP connection timeout
+	var $response_timeout = 30;		// HTTP response timeout
+	var $endpointType = '';			// soap|wsdl, empty for WSDL initialization error
+	var $persistentConnection = false;
+	var $defaultRpcParams = false;	// This is no longer used
+	var $request = '';				// HTTP request
+	var $response = '';				// HTTP response
+	var $responseData = '';			// SOAP payload of response
+	var $cookies = array();			// Cookies from response or for request
+    var $decode_utf8 = true;		// toggles whether the parser decodes element content w/ utf8_decode()
+	var $operations = array();		// WSDL operations, empty for WSDL initialization error
+	
+	/*
+	 * fault related variables
+	 */
+	/**
+	 * @var      fault
+	 * @access   public
+	 */
+	var $fault;
+	/**
+	 * @var      faultcode
+	 * @access   public
+	 */
+	var $faultcode;
+	/**
+	 * @var      faultstring
+	 * @access   public
+	 */
+	var $faultstring;
+	/**
+	 * @var      faultdetail
+	 * @access   public
+	 */
+	var $faultdetail;
+
+	/**
+	* constructor
+	*
+	* @param    mixed $endpoint SOAP server or WSDL URL (string), or wsdl instance (object)
+	* @param    bool $wsdl optional, set to true if using WSDL
+	* @param	int $portName optional portName in WSDL document
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @param	integer $timeout set the connection timeout
+	* @param	integer $response_timeout set the response timeout
+	* @access   public
+	*/
+	function soapclient($endpoint,$wsdl = false,$proxyhost = false,$proxyport = false,$proxyusername = false, $proxypassword = false, $timeout = 0, $response_timeout = 30){
+		parent::nusoap_base();
+		$this->endpoint = $endpoint;
+		$this->proxyhost = $proxyhost;
+		$this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+		$this->timeout = $timeout;
+		$this->response_timeout = $response_timeout;
+
+		// make values
+		if($wsdl){
+			if (is_object($endpoint) && (get_class($endpoint) == 'wsdl')) {
+				$this->wsdl = $endpoint;
+				$this->endpoint = $this->wsdl->wsdl;
+				$this->wsdlFile = $this->endpoint;
+				$this->debug('existing wsdl instance created from ' . $this->endpoint);
+			} else {
+				$this->wsdlFile = $this->endpoint;
+				
+				// instantiate wsdl object and parse wsdl file
+				$this->debug('instantiating wsdl class with doc: '.$endpoint);
+				$this->wsdl =& new wsdl($this->wsdlFile,$this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword,$this->timeout,$this->response_timeout);
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			// catch errors
+			if($errstr = $this->wsdl->getError()){
+				$this->debug('got wsdl error: '.$errstr);
+				$this->setError('wsdl error: '.$errstr);
+			} elseif($this->operations = $this->wsdl->getOperations()){
+				$this->debug( 'got '.count($this->operations).' operations from wsdl '.$this->wsdlFile);
+				$this->endpointType = 'wsdl';
+			} else {
+				$this->debug( 'getOperations returned false');
+				$this->setError('no operations defined in the WSDL document!');
+			}
+		} else {
+			$this->debug("instantiate SOAP with endpoint at $endpoint");
+			$this->endpointType = 'soap';
+		}
+	}
+
+	/**
+	* calls method, returns PHP native type
+	*
+	* @param    string $method SOAP server URL or path
+	* @param    mixed $params An array, associative or simple, of the parameters
+	*			              for the method call, or a string that is the XML
+	*			              for the call.  For rpc style, this call will
+	*			              wrap the XML in a tag named after the method, as
+	*			              well as the SOAP Envelope and Body.  For document
+	*			              style, this will only wrap with the Envelope and Body.
+	*			              IMPORTANT: when using an array with document style,
+	*			              in which case there
+	*                         is really one parameter, the root of the fragment
+	*                         used in the call, which encloses what programmers
+	*                         normally think of parameters.  A parameter array
+	*                         *must* include the wrapper.
+	* @param	string $namespace optional method namespace (WSDL can override)
+	* @param	string $soapAction optional SOAPAction value (WSDL can override)
+	* @param	mixed $headers optional string of XML with SOAP header content, or array of soapval objects for SOAP headers
+	* @param	boolean $rpcParams optional (no longer used)
+	* @param	string	$style optional (rpc|document) the style to use when serializing parameters (WSDL can override)
+	* @param	string	$use optional (encoded|literal) the use when serializing parameters (WSDL can override)
+	* @return	mixed	response from SOAP call
+	* @access   public
+	*/
+	function call($operation,$params=array(),$namespace='http://tempuri.org',$soapAction='',$headers=false,$rpcParams=null,$style='rpc',$use='encoded'){
+		$this->operation = $operation;
+		$this->fault = false;
+		$this->setError('');
+		$this->request = '';
+		$this->response = '';
+		$this->responseData = '';
+		$this->faultstring = '';
+		$this->faultcode = '';
+		$this->opData = array();
+		
+		$this->debug("call: operation=$operation, namespace=$namespace, soapAction=$soapAction, rpcParams=$rpcParams, style=$style, use=$use, endpointType=$this->endpointType");
+		$this->appendDebug('params=' . $this->varDump($params));
+		$this->appendDebug('headers=' . $this->varDump($headers));
+		if ($headers) {
+			$this->requestHeaders = $headers;
+		}
+		// serialize parameters
+		if($this->endpointType == 'wsdl' && $opData = $this->getOperationData($operation)){
+			// use WSDL for operation
+			$this->opData = $opData;
+			$this->debug("found operation");
+			$this->appendDebug('opData=' . $this->varDump($opData));
+			if (isset($opData['soapAction'])) {
+				$soapAction = $opData['soapAction'];
+			}
+			if (! $this->forceEndpoint) {
+				$this->endpoint = $opData['endpoint'];
+			} else {
+				$this->endpoint = $this->forceEndpoint;
+			}
+			$namespace = isset($opData['input']['namespace']) ? $opData['input']['namespace'] :	$namespace;
+			$style = $opData['style'];
+			$use = $opData['input']['use'];
+			// add ns to ns array
+			if($namespace != '' && !isset($this->wsdl->namespaces[$namespace])){
+				$nsPrefix = 'ns' . rand(1000, 9999);
+				$this->wsdl->namespaces[$nsPrefix] = $namespace;
+			}
+            $nsPrefix = $this->wsdl->getPrefixFromNamespace($namespace);
+			// serialize payload
+			if (is_string($params)) {
+				$this->debug("serializing param string for WSDL operation $operation");
+				$payload = $params;
+			} elseif (is_array($params)) {
+				$this->debug("serializing param array for WSDL operation $operation");
+				$payload = $this->wsdl->serializeRPCParameters($operation,'input',$params);
+			} else {
+				$this->debug('params must be array or string');
+				$this->setError('params must be array or string');
+				return false;
+			}
+            $usedNamespaces = $this->wsdl->usedNamespaces;
+			if (isset($opData['input']['encodingStyle'])) {
+				$encodingStyle = $opData['input']['encodingStyle'];
+			} else {
+				$encodingStyle = '';
+			}
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			if ($errstr = $this->wsdl->getError()) {
+				$this->debug('got wsdl error: '.$errstr);
+				$this->setError('wsdl error: '.$errstr);
+				return false;
+			}
+		} elseif($this->endpointType == 'wsdl') {
+			// operation not in WSDL
+			$this->appendDebug($this->wsdl->getDebug());
+			$this->wsdl->clearDebug();
+			$this->setError( 'operation '.$operation.' not present.');
+			$this->debug("operation '$operation' not present.");
+			return false;
+		} else {
+			// no WSDL
+			//$this->namespaces['ns1'] = $namespace;
+			$nsPrefix = 'ns' . rand(1000, 9999);
+			// serialize 
+			$payload = '';
+			if (is_string($params)) {
+				$this->debug("serializing param string for operation $operation");
+				$payload = $params;
+			} elseif (is_array($params)) {
+				$this->debug("serializing param array for operation $operation");
+				foreach($params as $k => $v){
+					$payload .= $this->serialize_val($v,$k,false,false,false,false,$use);
+				}
+			} else {
+				$this->debug('params must be array or string');
+				$this->setError('params must be array or string');
+				return false;
+			}
+			$usedNamespaces = array();
+			if ($use == 'encoded') {
+				$encodingStyle = 'http://schemas.xmlsoap.org/soap/encoding/';
+			} else {
+				$encodingStyle = '';
+			}
+		}
+		// wrap RPC calls with method element
+		if ($style == 'rpc') {
+			if ($use == 'literal') {
+				$this->debug("wrapping RPC request with literal method element");
+				if ($namespace) {
+					$payload = "<$operation xmlns=\"$namespace\">" . $payload . "</$operation>";
+				} else {
+					$payload = "<$operation>" . $payload . "</$operation>";
+				}
+			} else {
+				$this->debug("wrapping RPC request with encoded method element");
+				if ($namespace) {
+					$payload = "<$nsPrefix:$operation xmlns:$nsPrefix=\"$namespace\">" .
+								$payload .
+								"</$nsPrefix:$operation>";
+				} else {
+					$payload = "<$operation>" .
+								$payload .
+								"</$operation>";
+				}
+			}
+		}
+		// serialize envelope
+		$soapmsg = $this->serializeEnvelope($payload,$this->requestHeaders,$usedNamespaces,$style,$use,$encodingStyle);
+		$this->debug("endpoint=$this->endpoint, soapAction=$soapAction, namespace=$namespace, style=$style, use=$use, encodingStyle=$encodingStyle");
+		$this->debug('SOAP message length=' . strlen($soapmsg) . ' contents (max 1000 bytes)=' . substr($soapmsg, 0, 1000));
+		// send
+		$return = $this->send($this->getHTTPBody($soapmsg),$soapAction,$this->timeout,$this->response_timeout);
+		if($errstr = $this->getError()){
+			$this->debug('Error: '.$errstr);
+			return false;
+		} else {
+			$this->return = $return;
+			$this->debug('sent message successfully and got a(n) '.gettype($return));
+           	$this->appendDebug('return=' . $this->varDump($return));
+			
+			// fault?
+			if(is_array($return) && isset($return['faultcode'])){
+				$this->debug('got fault');
+				$this->setError($return['faultcode'].': '.$return['faultstring']);
+				$this->fault = true;
+				foreach($return as $k => $v){
+					$this->$k = $v;
+					$this->debug("$k = $v<br>");
+				}
+				return $return;
+			} elseif ($style == 'document') {
+				// NOTE: if the response is defined to have multiple parts (i.e. unwrapped),
+				// we are only going to return the first part here...sorry about that
+				return $return;
+			} else {
+				// array of return values
+				if(is_array($return)){
+					// multiple 'out' parameters, which we return wrapped up
+					// in the array
+					if(sizeof($return) > 1){
+						return $return;
+					}
+					// single 'out' parameter (normally the return value)
+					$return = array_shift($return);
+					$this->debug('return shifted value: ');
+					$this->appendDebug($this->varDump($return));
+           			return $return;
+				// nothing returned (ie, echoVoid)
+				} else {
+					return "";
+				}
+			}
+		}
+	}
+
+	/**
+	* get available data pertaining to an operation
+	*
+	* @param    string $operation operation name
+	* @return	array array of data pertaining to the operation
+	* @access   public
+	*/
+	function getOperationData($operation){
+		if(isset($this->operations[$operation])){
+			return $this->operations[$operation];
+		}
+		$this->debug("No data for operation: $operation");
+	}
+
+    /**
+    * send the SOAP message
+    *
+    * Note: if the operation has multiple return values
+    * the return value of this method will be an array
+    * of those values.
+    *
+	* @param    string $msg a SOAPx4 soapmsg object
+	* @param    string $soapaction SOAPAction value
+	* @param    integer $timeout set connection timeout in seconds
+	* @param	integer $response_timeout set response timeout in seconds
+	* @return	mixed native PHP types.
+	* @access   private
+	*/
+	function send($msg, $soapaction = '', $timeout=0, $response_timeout=30) {
+		$this->checkCookies();
+		// detect transport
+		switch(true){
+			// http(s)
+			case ereg('^http',$this->endpoint):
+				$this->debug('transporting via HTTP');
+				if($this->persistentConnection == true && is_object($this->persistentConnection)){
+					$http =& $this->persistentConnection;
+				} else {
+					$http = new soap_transport_http($this->endpoint);
+					if ($this->persistentConnection) {
+						$http->usePersistentConnection();
+					}
+				}
+				$http->setContentType($this->getHTTPContentType(), $this->getHTTPContentTypeCharset());
+				$http->setSOAPAction($soapaction);
+				if($this->proxyhost && $this->proxyport){
+					$http->setProxy($this->proxyhost,$this->proxyport,$this->proxyusername,$this->proxypassword);
+				}
+                if($this->authtype != '') {
+					$http->setCredentials($this->username, $this->password, $this->authtype, array(), $this->certRequest);
+				}
+				if($this->http_encoding != ''){
+					$http->setEncoding($this->http_encoding);
+				}
+				$this->debug('sending message, length='.strlen($msg));
+				if(ereg('^http:',$this->endpoint)){
+				//if(strpos($this->endpoint,'http:')){
+					$this->responseData = $http->send($msg,$timeout,$response_timeout,$this->cookies);
+				} elseif(ereg('^https',$this->endpoint)){
+				//} elseif(strpos($this->endpoint,'https:')){
+					//if(phpversion() == '4.3.0-dev'){
+						//$response = $http->send($msg,$timeout,$response_timeout);
+                   		//$this->request = $http->outgoing_payload;
+						//$this->response = $http->incoming_payload;
+					//} else
+					$this->responseData = $http->sendHTTPS($msg,$timeout,$response_timeout,$this->cookies);
+				} else {
+					$this->setError('no http/s in endpoint url');
+				}
+				$this->request = $http->outgoing_payload;
+				$this->response = $http->incoming_payload;
+				$this->appendDebug($http->getDebug());
+				$this->UpdateCookies($http->incoming_cookies);
+
+				// save transport object if using persistent connections
+				if ($this->persistentConnection) {
+					$http->clearDebug();
+					if (!is_object($this->persistentConnection)) {
+						$this->persistentConnection = $http;
+					}
+				}
+				
+				if($err = $http->getError()){
+					$this->setError('HTTP Error: '.$err);
+					return false;
+				} elseif($this->getError()){
+					return false;
+				} else {
+					$this->debug('got response, length='. strlen($this->responseData).' type='.$http->incoming_headers['content-type']);
+					return $this->parseResponse($http->incoming_headers, $this->responseData);
+				}
+			break;
+			default:
+				$this->setError('no transport found, or selected transport is not yet supported!');
+			return false;
+			break;
+		}
+	}
+
+	/**
+	* processes SOAP message returned from server
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed response data from server
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseResponse($headers, $data) {
+		$this->debug('Entering parseResponse() for data of length ' . strlen($data) . ' and type ' . $headers['content-type']);
+		if (!strstr($headers['content-type'], 'text/xml')) {
+			$this->setError('Response not of type text/xml');
+			return false;
+		}
+		if (strpos($headers['content-type'], '=')) {
+			$enc = str_replace('"', '', substr(strstr($headers["content-type"], '='), 1));
+			$this->debug('Got response encoding: ' . $enc);
+			if(eregi('^(ISO-8859-1|US-ASCII|UTF-8)$',$enc)){
+				$this->xml_encoding = strtoupper($enc);
+			} else {
+				$this->xml_encoding = 'US-ASCII';
+			}
+		} else {
+			// should be US-ASCII for HTTP 1.0 or ISO-8859-1 for HTTP 1.1
+			$this->xml_encoding = 'ISO-8859-1';
+		}
+		$this->debug('Use encoding: ' . $this->xml_encoding . ' when creating soap_parser');
+		$parser = new soap_parser($data,$this->xml_encoding,$this->operation,$this->decode_utf8);
+		// add parser debug data to our debug
+		$this->appendDebug($parser->getDebug());
+		// if parse errors
+		if($errstr = $parser->getError()){
+			$this->setError( $errstr);
+			// destroy the parser object
+			unset($parser);
+			return false;
+		} else {
+			// get SOAP headers
+			$this->responseHeaders = $parser->getHeaders();
+			// get decoded message
+			$return = $parser->get_response();
+            // add document for doclit support
+            $this->document = $parser->document;
+			// destroy the parser object
+			unset($parser);
+			// return decode message
+			return $return;
+		}
+	 }
+
+	/**
+	* sets the SOAP endpoint, which can override WSDL
+	*
+	* @param	$endpoint string The endpoint URL to use, or empty string or false to prevent override
+	* @access   public
+	*/
+	function setEndpoint($endpoint) {
+		$this->forceEndpoint = $endpoint;
+	}
+
+	/**
+	* set the SOAP headers
+	*
+	* @param	$headers mixed String of XML with SOAP header content, or array of soapval objects for SOAP headers
+	* @access   public
+	*/
+	function setHeaders($headers){
+		$this->requestHeaders = $headers;
+	}
+
+	/**
+	* get the SOAP response headers (namespace resolution incomplete)
+	*
+	* @return	string
+	* @access   public
+	*/
+	function getHeaders(){
+		return $this->responseHeaders;
+	}
+
+	/**
+	* set proxy info here
+	*
+	* @param    string $proxyhost
+	* @param    string $proxyport
+	* @param	string $proxyusername
+	* @param	string $proxypassword
+	* @access   public
+	*/
+	function setHTTPProxy($proxyhost, $proxyport, $proxyusername = '', $proxypassword = '') {
+		$this->proxyhost = $proxyhost;
+		$this->proxyport = $proxyport;
+		$this->proxyusername = $proxyusername;
+		$this->proxypassword = $proxypassword;
+	}
+
+	/**
+	* if authenticating, set user credentials here
+	*
+	* @param    string $username
+	* @param    string $password
+	* @param	string $authtype (basic|digest|certificate)
+	* @param	array $certRequest (keys must be cainfofile (optional), sslcertfile, sslkeyfile, passphrase, verifypeer (optional), verifyhost (optional): see corresponding options in cURL docs)
+	* @access   public
+	*/
+	function setCredentials($username, $password, $authtype = 'basic', $certRequest = array()) {
+		$this->username = $username;
+		$this->password = $password;
+		$this->authtype = $authtype;
+		$this->certRequest = $certRequest;
+	}
+	
+	/**
+	* use HTTP encoding
+	*
+	* @param    string $enc
+	* @access   public
+	*/
+	function setHTTPEncoding($enc='gzip, deflate'){
+		$this->http_encoding = $enc;
+	}
+	
+	/**
+	* use HTTP persistent connections if possible
+	*
+	* @access   public
+	*/
+	function useHTTPPersistentConnection(){
+		$this->persistentConnection = true;
+	}
+	
+	/**
+	* gets the default RPC parameter setting.
+	* If true, default is that call params are like RPC even for document style.
+	* Each call() can override this value.
+	*
+	* This is no longer used.
+	*
+	* @return boolean
+	* @access public
+	* @deprecated
+	*/
+	function getDefaultRpcParams() {
+		return $this->defaultRpcParams;
+	}
+
+	/**
+	* sets the default RPC parameter setting.
+	* If true, default is that call params are like RPC even for document style
+	* Each call() can override this value.
+	*
+	* This is no longer used.
+	*
+	* @param    boolean $rpcParams
+	* @access public
+	* @deprecated
+	*/
+	function setDefaultRpcParams($rpcParams) {
+		$this->defaultRpcParams = $rpcParams;
+	}
+	
+	/**
+	* dynamically creates an instance of a proxy class,
+	* allowing user to directly call methods from wsdl
+	*
+	* @return   object soap_proxy object
+	* @access   public
+	*/
+	function getProxy(){
+		$r = rand();
+		$evalStr = $this->_getProxyClassCode($r);
+		//$this->debug("proxy class: $evalStr";
+		// eval the class
+		eval($evalStr);
+		// instantiate proxy object
+		eval("\$proxy = new soap_proxy_$r('');");
+		// transfer current wsdl data to the proxy thereby avoiding parsing the wsdl twice
+		$proxy->endpointType = 'wsdl';
+		$proxy->wsdlFile = $this->wsdlFile;
+		$proxy->wsdl = $this->wsdl;
+		$proxy->operations = $this->operations;
+		$proxy->defaultRpcParams = $this->defaultRpcParams;
+		// transfer other state
+		$proxy->username = $this->username;
+		$proxy->password = $this->password;
+		$proxy->authtype = $this->authtype;
+		$proxy->proxyhost = $this->proxyhost;
+		$proxy->proxyport = $this->proxyport;
+		$proxy->proxyusername = $this->proxyusername;
+		$proxy->proxypassword = $this->proxypassword;
+		$proxy->timeout = $this->timeout;
+		$proxy->response_timeout = $this->response_timeout;
+		$proxy->http_encoding = $this->http_encoding;
+		$proxy->persistentConnection = $this->persistentConnection;
+		$proxy->requestHeaders = $this->requestHeaders;
+		$proxy->soap_defencoding = $this->soap_defencoding;
+		$proxy->endpoint = $this->endpoint;
+		$proxy->forceEndpoint = $this->forceEndpoint;
+		return $proxy;
+	}
+
+	/**
+	* dynamically creates proxy class code
+	*
+	* @return   string PHP/NuSOAP code for the proxy class
+	* @access   private
+	*/
+	function _getProxyClassCode($r) {
+		if ($this->endpointType != 'wsdl') {
+			$evalStr = 'A proxy can only be created for a WSDL client';
+			$this->setError($evalStr);
+			return $evalStr;
+		}
+		$evalStr = '';
+		foreach ($this->operations as $operation => $opData) {
+			if ($operation != '') {
+				// create param string and param comment string
+				if (sizeof($opData['input']['parts']) > 0) {
+					$paramStr = '';
+					$paramArrayStr = '';
+					$paramCommentStr = '';
+					foreach ($opData['input']['parts'] as $name => $type) {
+						$paramStr .= "\$$name, ";
+						$paramArrayStr .= "'$name' => \$$name, ";
+						$paramCommentStr .= "$type \$$name, ";
+					}
+					$paramStr = substr($paramStr, 0, strlen($paramStr)-2);
+					$paramArrayStr = substr($paramArrayStr, 0, strlen($paramArrayStr)-2);
+					$paramCommentStr = substr($paramCommentStr, 0, strlen($paramCommentStr)-2);
+				} else {
+					$paramStr = '';
+					$paramCommentStr = 'void';
+				}
+				$opData['namespace'] = !isset($opData['namespace']) ? 'http://testuri.com' : $opData['namespace'];
+				$evalStr .= "// $paramCommentStr
+	function " . str_replace('.', '__', $operation) . "($paramStr) {
+		\$params = array($paramArrayStr);
+		return \$this->call('$operation', \$params, '".$opData['namespace']."', '".(isset($opData['soapAction']) ? $opData['soapAction'] : '')."');
+	}
+	";
+				unset($paramStr);
+				unset($paramCommentStr);
+			}
+		}
+		$evalStr = 'class soap_proxy_'.$r.' extends soapclient {
+	'.$evalStr.'
+}';
+		return $evalStr;
+	}
+
+	/**
+	* dynamically creates proxy class code
+	*
+	* @return   string PHP/NuSOAP code for the proxy class
+	* @access   public
+	*/
+	function getProxyClassCode() {
+		$r = rand();
+		return $this->_getProxyClassCode($r);
+	}
+
+	/**
+	* gets the HTTP body for the current request.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		return $soapmsg;
+	}
+	
+	/**
+	* gets the HTTP content type for the current request.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current request.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		return 'text/xml';
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current request.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current request.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		return $this->soap_defencoding;
+	}
+
+	/*
+	* whether or not parser should decode utf8 element content
+    *
+    * @return   always returns true
+    * @access   public
+    */
+    function decodeUTF8($bool){
+		$this->decode_utf8 = $bool;
+		return true;
+    }
+
+	/**
+	 * adds a new Cookie into $this->cookies array
+	 *
+	 * @param	string $name Cookie Name
+	 * @param	string $value Cookie Value
+	 * @return	if cookie-set was successful returns true, else false
+	 * @access	public
+	 */
+	function setCookie($name, $value) {
+		if (strlen($name) == 0) {
+			return false;
+		}
+		$this->cookies[] = array('name' => $name, 'value' => $value);
+		return true;
+	}
+
+	/**
+	 * gets all Cookies
+	 *
+	 * @return   array with all internal cookies
+	 * @access   public
+	 */
+	function getCookies() {
+		return $this->cookies;
+	}
+
+	/**
+	 * checks all Cookies and delete those which are expired
+	 *
+	 * @return   always return true
+	 * @access   private
+	 */
+	function checkCookies() {
+		if (sizeof($this->cookies) == 0) {
+			return true;
+		}
+		$this->debug('checkCookie: check ' . sizeof($this->cookies) . ' cookies');
+		$curr_cookies = $this->cookies;
+		$this->cookies = array();
+		foreach ($curr_cookies as $cookie) {
+			if (! is_array($cookie)) {
+				$this->debug('Remove cookie that is not an array');
+				continue;
+			}
+			if ((isset($cookie['expires'])) && (! empty($cookie['expires']))) {
+				if (strtotime($cookie['expires']) > time()) {
+					$this->cookies[] = $cookie;
+				} else {
+					$this->debug('Remove expired cookie ' . $cookie['name']);
+				}
+			} else {
+				$this->cookies[] = $cookie;
+			}
+		}
+		$this->debug('checkCookie: '.sizeof($this->cookies).' cookies left in array');
+		return true;
+	}
+
+	/**
+	 * updates the current cookies with a new set
+	 *
+	 * @param	array $cookies new cookies with which to update current ones
+	 * @return	always return true
+	 * @access	private
+	 */
+	function UpdateCookies($cookies) {
+		if (sizeof($this->cookies) == 0) {
+			// no existing cookies: take whatever is new
+			if (sizeof($cookies) > 0) {
+				$this->debug('Setting new cookie(s)');
+				$this->cookies = $cookies;
+			}
+			return true;
+		}
+		if (sizeof($cookies) == 0) {
+			// no new cookies: keep what we've got
+			return true;
+		}
+		// merge
+		foreach ($cookies as $newCookie) {
+			if (!is_array($newCookie)) {
+				continue;
+			}
+			if ((!isset($newCookie['name'])) || (!isset($newCookie['value']))) {
+				continue;
+			}
+			$newName = $newCookie['name'];
+
+			$found = false;
+			for ($i = 0; $i < count($this->cookies); $i++) {
+				$cookie = $this->cookies[$i];
+				if (!is_array($cookie)) {
+					continue;
+				}
+				if (!isset($cookie['name'])) {
+					continue;
+				}
+				if ($newName != $cookie['name']) {
+					continue;
+				}
+				$newDomain = isset($newCookie['domain']) ? $newCookie['domain'] : 'NODOMAIN';
+				$domain = isset($cookie['domain']) ? $cookie['domain'] : 'NODOMAIN';
+				if ($newDomain != $domain) {
+					continue;
+				}
+				$newPath = isset($newCookie['path']) ? $newCookie['path'] : 'NOPATH';
+				$path = isset($cookie['path']) ? $cookie['path'] : 'NOPATH';
+				if ($newPath != $path) {
+					continue;
+				}
+				$this->cookies[$i] = $newCookie;
+				$found = true;
+				$this->debug('Update cookie ' . $newName . '=' . $newCookie['value']);
+				break;
+			}
+			if (! $found) {
+				$this->debug('Add cookie ' . $newName . '=' . $newCookie['value']);
+				$this->cookies[] = $newCookie;
+			}
+		}
+		return true;
+	}
+}
+?>

Added: cms/trunk/includes/nusoap/nusoapmime.php
===================================================================
--- cms/trunk/includes/nusoap/nusoapmime.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/nusoap/nusoapmime.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,478 @@
+<?php
+/*
+$Id: nusoapmime.php,v 1.7 2005/07/27 19:24:42 snichol Exp $
+
+NuSOAP - Web Services Toolkit for PHP
+
+Copyright (c) 2002 NuSphere Corporation
+
+This library is free software; you can redistribute it and/or
+modify it under the terms of the GNU Lesser General Public
+License as published by the Free Software Foundation; either
+version 2.1 of the License, or (at your option) any later version.
+
+This library is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+Lesser General Public License for more details.
+
+You should have received a copy of the GNU Lesser General Public
+License along with this library; if not, write to the Free Software
+Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
+
+If you have any questions or comments, please email:
+
+Dietrich Ayala
+dietrich at ganx4.com
+http://dietrich.ganx4.com/nusoap
+
+NuSphere Corporation
+http://www.nusphere.com
+
+*/
+
+/*require_once('nusoap.php');*/
+/* PEAR Mail_MIME library */
+require_once('Mail/mimeDecode.php');
+require_once('Mail/mimePart.php');
+
+/**
+* soapclientmime client supporting MIME attachments defined at
+* http://www.w3.org/TR/SOAP-attachments.  It depends on the PEAR Mail_MIME library.
+*
+* @author   Scott Nichol <snichol at sourceforge.net>
+* @author	Thanks to Guillaume and Henning Reich for posting great attachment code to the mail list
+* @version  $Id: nusoapmime.php,v 1.7 2005/07/27 19:24:42 snichol Exp $
+* @access   public
+*/
+class soapclientmime extends soapclient {
+	/**
+	 * @var array Each array element in the return is an associative array with keys
+	 * data, filename, contenttype, cid
+	 * @access private
+	 */
+	var $requestAttachments = array();
+	/**
+	 * @var array Each array element in the return is an associative array with keys
+	 * data, filename, contenttype, cid
+	 * @access private
+	 */
+	var $responseAttachments;
+	/**
+	 * @var string
+	 * @access private
+	 */
+	var $mimeContentType;
+	
+	/**
+	* adds a MIME attachment to the current request.
+	*
+	* If the $data parameter contains an empty string, this method will read
+	* the contents of the file named by the $filename parameter.
+	*
+	* If the $cid parameter is false, this method will generate the cid.
+	*
+	* @param string $data The data of the attachment
+	* @param string $filename The filename of the attachment (default is empty string)
+	* @param string $contenttype The MIME Content-Type of the attachment (default is application/octet-stream)
+	* @param string $cid The content-id (cid) of the attachment (default is false)
+	* @return string The content-id (cid) of the attachment
+	* @access public
+	*/
+	function addAttachment($data, $filename = '', $contenttype = 'application/octet-stream', $cid = false) {
+		if (! $cid) {
+			$cid = md5(uniqid(time()));
+		}
+
+		$info['data'] = $data;
+		$info['filename'] = $filename;
+		$info['contenttype'] = $contenttype;
+		$info['cid'] = $cid;
+		
+		$this->requestAttachments[] = $info;
+
+		return $cid;
+	}
+
+	/**
+	* clears the MIME attachments for the current request.
+	*
+	* @access public
+	*/
+	function clearAttachments() {
+		$this->requestAttachments = array();
+	}
+
+	/**
+	* gets the MIME attachments from the current response.
+	*
+	* Each array element in the return is an associative array with keys
+	* data, filename, contenttype, cid.  These keys correspond to the parameters
+	* for addAttachment.
+	*
+	* @return array The attachments.
+	* @access public
+	*/
+	function getAttachments() {
+		return $this->responseAttachments;
+	}
+
+	/**
+	* gets the HTTP body for the current request.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		if (count($this->requestAttachments) > 0) {
+			$params['content_type'] = 'multipart/related; type=text/xml';
+			$mimeMessage =& new Mail_mimePart('', $params);
+			unset($params);
+
+			$params['content_type'] = 'text/xml';
+			$params['encoding']     = '8bit';
+			$params['charset']      = $this->soap_defencoding;
+			$mimeMessage->addSubpart($soapmsg, $params);
+			
+			foreach ($this->requestAttachments as $att) {
+				unset($params);
+
+				$params['content_type'] = $att['contenttype'];
+				$params['encoding']     = 'base64';
+				$params['disposition']  = 'attachment';
+				$params['dfilename']    = $att['filename'];
+				$params['cid']          = $att['cid'];
+
+				if ($att['data'] == '' && $att['filename'] <> '') {
+					if ($fd = fopen($att['filename'], 'rb')) {
+						$data = fread($fd, filesize($att['filename']));
+						fclose($fd);
+					} else {
+						$data = '';
+					}
+					$mimeMessage->addSubpart($data, $params);
+				} else {
+					$mimeMessage->addSubpart($att['data'], $params);
+				}
+			}
+
+			$output = $mimeMessage->encode();
+			$mimeHeaders = $output['headers'];
+	
+			foreach ($mimeHeaders as $k => $v) {
+				$this->debug("MIME header $k: $v");
+				if (strtolower($k) == 'content-type') {
+					// PHP header() seems to strip leading whitespace starting
+					// the second line, so force everything to one line
+					$this->mimeContentType = str_replace("\r\n", " ", $v);
+				}
+			}
+	
+			return $output['body'];
+		}
+
+		return parent::getHTTPBody($soapmsg);
+	}
+	
+	/**
+	* gets the HTTP content type for the current request.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current request.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		if (count($this->requestAttachments) > 0) {
+			return $this->mimeContentType;
+		}
+		return parent::getHTTPContentType();
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current request.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current request.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		if (count($this->requestAttachments) > 0) {
+			return false;
+		}
+		return parent::getHTTPContentTypeCharset();
+	}
+
+	/**
+	* processes SOAP message returned from server
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed response data from server
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseResponse($headers, $data) {
+		$this->debug('Entering parseResponse() for payload of length ' . strlen($data) . ' and type of ' . $headers['content-type']);
+		$this->responseAttachments = array();
+		if (strstr($headers['content-type'], 'multipart/related')) {
+			$this->debug('Decode multipart/related');
+			$input = '';
+			foreach ($headers as $k => $v) {
+				$input .= "$k: $v\r\n";
+			}
+			$params['input'] = $input . "\r\n" . $data;
+			$params['include_bodies'] = true;
+			$params['decode_bodies'] = true;
+			$params['decode_headers'] = true;
+			
+			$structure = Mail_mimeDecode::decode($params);
+
+			foreach ($structure->parts as $part) {
+				if (!isset($part->disposition)) {
+					$this->debug('Have root part of type ' . $part->headers['content-type']);
+					$return = parent::parseResponse($part->headers, $part->body);
+				} else {
+					$this->debug('Have an attachment of type ' . $part->headers['content-type']);
+					$info['data'] = $part->body;
+					$info['filename'] = isset($part->d_parameters['filename']) ? $part->d_parameters['filename'] : '';
+					$info['contenttype'] = $part->headers['content-type'];
+					$info['cid'] = $part->headers['content-id'];
+					$this->responseAttachments[] = $info;
+				}
+			}
+		
+			if (isset($return)) {
+				return $return;
+			}
+			
+			$this->setError('No root part found in multipart/related content');
+			return;
+		}
+		$this->debug('Not multipart/related');
+		return parent::parseResponse($headers, $data);
+	}
+}
+
+/**
+* nusoapservermime server supporting MIME attachments defined at
+* http://www.w3.org/TR/SOAP-attachments.  It depends on the PEAR Mail_MIME library.
+*
+* @author   Scott Nichol <snichol at sourceforge.net>
+* @author	Thanks to Guillaume and Henning Reich for posting great attachment code to the mail list
+* @version  $Id: nusoapmime.php,v 1.7 2005/07/27 19:24:42 snichol Exp $
+* @access   public
+*/
+class nusoapservermime extends soap_server {
+	/**
+	 * @var array Each array element in the return is an associative array with keys
+	 * data, filename, contenttype, cid
+	 * @access private
+	 */
+	var $requestAttachments = array();
+	/**
+	 * @var array Each array element in the return is an associative array with keys
+	 * data, filename, contenttype, cid
+	 * @access private
+	 */
+	var $responseAttachments;
+	/**
+	 * @var string
+	 * @access private
+	 */
+	var $mimeContentType;
+	
+	/**
+	* adds a MIME attachment to the current response.
+	*
+	* If the $data parameter contains an empty string, this method will read
+	* the contents of the file named by the $filename parameter.
+	*
+	* If the $cid parameter is false, this method will generate the cid.
+	*
+	* @param string $data The data of the attachment
+	* @param string $filename The filename of the attachment (default is empty string)
+	* @param string $contenttype The MIME Content-Type of the attachment (default is application/octet-stream)
+	* @param string $cid The content-id (cid) of the attachment (default is false)
+	* @return string The content-id (cid) of the attachment
+	* @access public
+	*/
+	function addAttachment($data, $filename = '', $contenttype = 'application/octet-stream', $cid = false) {
+		if (! $cid) {
+			$cid = md5(uniqid(time()));
+		}
+
+		$info['data'] = $data;
+		$info['filename'] = $filename;
+		$info['contenttype'] = $contenttype;
+		$info['cid'] = $cid;
+		
+		$this->responseAttachments[] = $info;
+
+		return $cid;
+	}
+
+	/**
+	* clears the MIME attachments for the current response.
+	*
+	* @access public
+	*/
+	function clearAttachments() {
+		$this->responseAttachments = array();
+	}
+
+	/**
+	* gets the MIME attachments from the current request.
+	*
+	* Each array element in the return is an associative array with keys
+	* data, filename, contenttype, cid.  These keys correspond to the parameters
+	* for addAttachment.
+	*
+	* @return array The attachments.
+	* @access public
+	*/
+	function getAttachments() {
+		return $this->requestAttachments;
+	}
+
+	/**
+	* gets the HTTP body for the current response.
+	*
+	* @param string $soapmsg The SOAP payload
+	* @return string The HTTP body, which includes the SOAP payload
+	* @access private
+	*/
+	function getHTTPBody($soapmsg) {
+		if (count($this->responseAttachments) > 0) {
+			$params['content_type'] = 'multipart/related; type=text/xml';
+			$mimeMessage =& new Mail_mimePart('', $params);
+			unset($params);
+
+			$params['content_type'] = 'text/xml';
+			$params['encoding']     = '8bit';
+			$params['charset']      = $this->soap_defencoding;
+			$mimeMessage->addSubpart($soapmsg, $params);
+			
+			foreach ($this->responseAttachments as $att) {
+				unset($params);
+
+				$params['content_type'] = $att['contenttype'];
+				$params['encoding']     = 'base64';
+				$params['disposition']  = 'attachment';
+				$params['dfilename']    = $att['filename'];
+				$params['cid']          = $att['cid'];
+
+				if ($att['data'] == '' && $att['filename'] <> '') {
+					if ($fd = fopen($att['filename'], 'rb')) {
+						$data = fread($fd, filesize($att['filename']));
+						fclose($fd);
+					} else {
+						$data = '';
+					}
+					$mimeMessage->addSubpart($data, $params);
+				} else {
+					$mimeMessage->addSubpart($att['data'], $params);
+				}
+			}
+
+			$output = $mimeMessage->encode();
+			$mimeHeaders = $output['headers'];
+	
+			foreach ($mimeHeaders as $k => $v) {
+				$this->debug("MIME header $k: $v");
+				if (strtolower($k) == 'content-type') {
+					// PHP header() seems to strip leading whitespace starting
+					// the second line, so force everything to one line
+					$this->mimeContentType = str_replace("\r\n", " ", $v);
+				}
+			}
+	
+			return $output['body'];
+		}
+
+		return parent::getHTTPBody($soapmsg);
+	}
+	
+	/**
+	* gets the HTTP content type for the current response.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type for the current response.
+	* @access private
+	*/
+	function getHTTPContentType() {
+		if (count($this->responseAttachments) > 0) {
+			return $this->mimeContentType;
+		}
+		return parent::getHTTPContentType();
+	}
+	
+	/**
+	* gets the HTTP content type charset for the current response.
+	* returns false for non-text content types.
+	*
+	* Note: getHTTPBody must be called before this.
+	*
+	* @return string the HTTP content type charset for the current response.
+	* @access private
+	*/
+	function getHTTPContentTypeCharset() {
+		if (count($this->responseAttachments) > 0) {
+			return false;
+		}
+		return parent::getHTTPContentTypeCharset();
+	}
+
+	/**
+	* processes SOAP message received from client
+	*
+	* @param	array	$headers	The HTTP headers
+	* @param	string	$data		unprocessed request data from client
+	* @return	mixed	value of the message, decoded into a PHP type
+	* @access   private
+	*/
+    function parseRequest($headers, $data) {
+		$this->debug('Entering parseRequest() for payload of length ' . strlen($data) . ' and type of ' . $headers['content-type']);
+		$this->requestAttachments = array();
+		if (strstr($headers['content-type'], 'multipart/related')) {
+			$this->debug('Decode multipart/related');
+			$input = '';
+			foreach ($headers as $k => $v) {
+				$input .= "$k: $v\r\n";
+			}
+			$params['input'] = $input . "\r\n" . $data;
+			$params['include_bodies'] = true;
+			$params['decode_bodies'] = true;
+			$params['decode_headers'] = true;
+			
+			$structure = Mail_mimeDecode::decode($params);
+
+			foreach ($structure->parts as $part) {
+				if (!isset($part->disposition)) {
+					$this->debug('Have root part of type ' . $part->headers['content-type']);
+					$return = parent::parseRequest($part->headers, $part->body);
+				} else {
+					$this->debug('Have an attachment of type ' . $part->headers['content-type']);
+					$info['data'] = $part->body;
+					$info['filename'] = isset($part->d_parameters['filename']) ? $part->d_parameters['filename'] : '';
+					$info['contenttype'] = $part->headers['content-type'];
+					$info['cid'] = $part->headers['content-id'];
+					$this->requestAttachments[] = $info;
+				}
+			}
+		
+			if (isset($return)) {
+				return $return;
+			}
+			
+			$this->setError('No root part found in multipart/related content');
+			return;
+		}
+		$this->debug('Not multipart/related');
+		return parent::parseRequest($headers, $data);
+	}
+}
+?>

Added: cms/trunk/includes/templates/error_document.html
===================================================================
--- cms/trunk/includes/templates/error_document.html	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/templates/error_document.html	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,20 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+
+<head>
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
+<title>Error</title>
+</head>
+
+<body style="background: url(images/bg.gif);">
+	<table style="position: absolute; left: 25%; top: 25%;">
+		<tr>
+			<td valign="top">
+				{ $MESSAGE_TEXT }
+				<br /><a href="{ $SITE_LINK }">Click here to homepage</a><br />[ <a href="javascript:history.go(-1)">Go Back</a> ]</div>
+			</td>
+		</tr>
+	</table>
+</body>
+
+</html>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/search_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/search_body.html	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/templates/modules/Forums/search_body.html	2005-09-21 03:53:30 UTC (rev 137)
@@ -2,47 +2,49 @@
 
 <!-- INCLUDE modules/Forums/overall_header.html -->
 
-<form method="post" action="{ $S_SEARCH_ACTION }"><table class="tablebg" width="100%" cellspacing="1">
-	<tr> 
-		<th colspan="4">{ $L_SEARCH_QUERY }</th>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2" width="50%"><b class="genmed">{ $L_SEARCH_KEYWORDS }: </b><br /><span class="gensmall">{ $L_SEARCH_KEYWORDS_EXPLAIN }</span></td>
-		<td class="row2" colspan="2" valign="top"><input type="text" style="width: 300px" class="post" name="search_keywords" size="30" /><br /><input type="radio" name="search_terms" value="all" checked="checked" /> <span class="genmed">{ $L_SEARCH_ALL_TERMS }</span><br /><input type="radio" name="search_terms" value="any" /> <span class="genmed">{ $L_SEARCH_ANY_TERMS }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2"><b class="genmed">{ $L_SEARCH_AUTHOR }:</b><br /><span class="gensmall">{ $L_SEARCH_AUTHOR_EXPLAIN }</span></td>
-		<td class="row2" colspan="2" valign="middle"><input type="text" style="width: 300px" class="post" name="search_author" size="30" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2"><b class="genmed">{ $L_SEARCH_FORUMS }: </b><br /><span class="gensmall">{ $L_SEARCH_FORUMS_EXPLAIN }</span></td>
-		<td class="row2" colspan="2"><select name="search_forum[]" multiple="multiple" style="min-width: 200px" size="5">{ $S_FORUM_OPTIONS }</select></td>
-	</tr>
-	<tr> 
-		<th colspan="4">{ $L_SEARCH_OPTIONS }</th>
-	</tr>
-	<tr> 
-		<td class="row1" width="25%" nowrap="nowrap"><b class="genmed">{ $L_SEARCH_SUBFORUMS }: </b></td>
-		<td class="row2" width="25%" nowrap="nowrap"><input type="radio" name="search_child" value="1" checked="checked" /> <span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="search_child" value="0" /> <span class="genmed">{ $L_NO }</span></td>
-		<td class="row1" width="25%" nowrap="nowrap"><b class="genmed">{ $L_SEARCH_WITHIN }: </b></td>
-		<td class="row2" width="25%" nowrap="nowrap"><input type="radio" name="search_fields" value="all" checked="checked" /> <span class="genmed">{ $L_SEARCH_TITLE_MSG }</span><br /><input type="radio" name="search_fields" value="msgonly" /> <span class="genmed">{ $L_SEARCH_MSG_ONLY }</span> <br /><input type="radio" name="search_fields" value="titleonly" /> <span class="genmed">{ $L_SEARCH_TITLE_ONLY }</span></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{ $L_RESULT_SORT }: </b></td>
-		<td class="row2" nowrap="nowrap">{ $S_SELECT_SORT_KEY }<br /><input type="radio" name="sd" value="a" /> <span class="genmed">{ $L_SORT_ASCENDING }</span><br /><input type="radio" name="sd" value="d" checked="checked" /> <span class="genmed">{ $L_SORT_DESCENDING }</span></td>
-		<td class="row1" nowrap="nowrap"><b class="genmed">{ $L_DISPLAY_RESULTS }: </b></td>
-		<td class="row2" nowrap="nowrap"><input type="radio" name="show_results" value="posts" /> <span class="genmed">{ $L_POSTS }</span>&nbsp;&nbsp;<input type="radio" name="show_results" value="topics" checked="checked" /> <span class="genmed">{ $L_TOPICS }</td>
-	</tr>
-	<tr> 
-		<td class="row1" width="25%"><b class="genmed">{ $L_RESULT_DAYS }: </b></td>
-		<td class="row2" width="25%" nowrap="nowrap">{ $S_SELECT_SORT_DAYS }</td>
-		<td class="row1" nowrap="nowrap"><b class="genmed">{ $L_RETURN_FIRST }: </b></td>
-		<td class="row2" nowrap="nowrap"><select name="return_chars">{ $S_CHARACTER_OPTIONS }</select> <span class="genmed">{ $L_POST_CHARACTERS }</span></td>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" value="{ $L_SEARCH }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" /></td>
-	</tr>
-</table></form>
+<form method="post" action="{ $S_SEARCH_ACTION }">
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr> 
+			<th colspan="4">{ $L_SEARCH_QUERY }</th>
+		</tr>
+		<tr> 
+			<td class="row1" colspan="2" width="50%"><b class="genmed">{ $L_SEARCH_KEYWORDS }: </b><br /><span class="gensmall">{ $L_SEARCH_KEYWORDS_EXPLAIN }</span></td>
+			<td class="row2" colspan="2" valign="top"><input type="text" style="width: 300px" class="post" name="search_keywords" size="30" /><br /><input type="radio" name="search_terms" value="all" checked="checked" /> <span class="genmed">{ $L_SEARCH_ALL_TERMS }</span><br /><input type="radio" name="search_terms" value="any" /> <span class="genmed">{ $L_SEARCH_ANY_TERMS }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" colspan="2"><b class="genmed">{ $L_SEARCH_AUTHOR }:</b><br /><span class="gensmall">{ $L_SEARCH_AUTHOR_EXPLAIN }</span></td>
+			<td class="row2" colspan="2" valign="middle"><input type="text" style="width: 300px" class="post" name="search_author" size="30" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" colspan="2"><b class="genmed">{ $L_SEARCH_FORUMS }: </b><br /><span class="gensmall">{ $L_SEARCH_FORUMS_EXPLAIN }</span></td>
+			<td class="row2" colspan="2"><select name="search_forum[]" multiple="multiple" style="min-width: 200px" size="5">{ $S_FORUM_OPTIONS }</select></td>
+		</tr>
+		<tr> 
+			<th colspan="4">{ $L_SEARCH_OPTIONS }</th>
+		</tr>
+		<tr> 
+			<td class="row1" width="25%" nowrap="nowrap"><b class="genmed">{ $L_SEARCH_SUBFORUMS }: </b></td>
+			<td class="row2" width="25%" nowrap="nowrap"><input type="radio" name="search_child" value="1" checked="checked" /> <span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="search_child" value="0" /> <span class="genmed">{ $L_NO }</span></td>
+			<td class="row1" width="25%" nowrap="nowrap"><b class="genmed">{ $L_SEARCH_WITHIN }: </b></td>
+			<td class="row2" width="25%" nowrap="nowrap"><input type="radio" name="search_fields" value="all" checked="checked" /> <span class="genmed">{ $L_SEARCH_TITLE_MSG }</span><br /><input type="radio" name="search_fields" value="msgonly" /> <span class="genmed">{ $L_SEARCH_MSG_ONLY }</span> <br /><input type="radio" name="search_fields" value="titleonly" /> <span class="genmed">{ $L_SEARCH_TITLE_ONLY }</span></td>
+		</tr>
+		<tr>
+			<td class="row1"><b class="genmed">{ $L_RESULT_SORT }: </b></td>
+			<td class="row2" nowrap="nowrap">{ $S_SELECT_SORT_KEY }<br /><input type="radio" name="sd" value="a" /> <span class="genmed">{ $L_SORT_ASCENDING }</span><br /><input type="radio" name="sd" value="d" checked="checked" /> <span class="genmed">{ $L_SORT_DESCENDING }</span></td>
+			<td class="row1" nowrap="nowrap"><b class="genmed">{ $L_DISPLAY_RESULTS }: </b></td>
+			<td class="row2" nowrap="nowrap"><input type="radio" name="show_results" value="posts" /> <span class="genmed">{ $L_POSTS }</span>&nbsp;&nbsp;<input type="radio" name="show_results" value="topics" checked="checked" /> <span class="genmed">{ $L_TOPICS }</td>
+		</tr>
+		<tr> 
+			<td class="row1" width="25%"><b class="genmed">{ $L_RESULT_DAYS }: </b></td>
+			<td class="row2" width="25%" nowrap="nowrap">{ $S_SELECT_SORT_DAYS }</td>
+			<td class="row1" nowrap="nowrap"><b class="genmed">{ $L_RETURN_FIRST }: </b></td>
+			<td class="row2" nowrap="nowrap"><select name="return_chars">{ $S_CHARACTER_OPTIONS }</select> <span class="genmed">{ $L_POST_CHARACTERS }</span></td>
+		</tr>
+		<tr> 
+			<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" value="{ $L_SEARCH }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" /></td>
+		</tr>
+	</table>
+</form>
 
 <br clear="all" />
 
@@ -51,15 +53,14 @@
 		<th colspan="2">{ $L_RECENT_SEARCHES }</th>
 	</tr>
 	<!-- LOOP $recentsearch -->
-
-	<!-- IF { $recentsearch:#index } % 2 -->
-	<tr class="row2">
-	<!-- ELSE -->
-	<tr class="row1">
-	<!-- ENDIF -->
-		<td class="genmed" style="padding: 4px;" width="70%"><a href="{ $recentsearch:U_KEYWORDS }">{ $recentsearch:KEYWORDS }</a></td>
-		<td class="genmed" style="padding: 4px;" width="30%" align="center">{ $recentsearch:TIME}</td>
-	</tr>
+		<!-- IF { $recentsearch:#LOOP_INDEX } % 2 -->
+		<tr class="row2">
+		<!-- ELSE -->
+		<tr class="row1">
+		<!-- ENDIF -->
+			<td class="genmed" style="padding: 4px;" width="70%"><a href="{ $recentsearch:U_KEYWORDS }">{ $recentsearch:KEYWORDS }</a></td>
+			<td class="genmed" style="padding: 4px;" width="30%" align="center">{ $recentsearch:TIME }</td>
+		</tr>
 	<!-- LOOPELSE -->
 	<tr>
 		<td class="row1" colspan="2" align="center"><span class="genmed">{ $L_NO_RECENT_SEARCHES }</span></td>
@@ -79,9 +80,14 @@
 </table>
 
 <br clear="all" />
+<!-- IF { $S_DISPLAY_JUMPBOX } -->
+<div style="float:right">
+<!-- INCLUDE modules/Forums/jumpbox.html -->
+</div>
+<!-- ENDIF -->
+
+<br clear="all" />
 
-<div style="float:right"><!-- IF { $S_DISPLAY_JUMPBOX } --><!-- INCLUDE modules/Forums/jumpbox.html --><!-- ENDIF --></div>
-
 <!-- INCLUDE modules/Forums/overall_footer.html -->
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/search_results.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/search_results.html	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/templates/modules/Forums/search_results.html	2005-09-21 03:53:30 UTC (rev 137)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/overall_header.html -->
 
 <form method="post" action="{ $S_SEARCH_ACTION }">
@@ -37,12 +39,12 @@
 		</td>
 		<td class="row1">
 			<!-- IF { $searchresults:S_TOPIC_UNAPPROVED } -->
-				<a href="{ $topicrow.U_MCP_QUEUE}">{ $UNAPPROVED_IMG }</a>&nbsp;
+				<a href="{ $searchresults.U_MCP_QUEUE}">{ $UNAPPROVED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
 			<!-- IF { $searchresults:S_TOPIC_REPORTED } -->
-				<a href="{ $topicrow.U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
+				<a href="{ $searchresults.U_MCP_REPORT}">{ $REPORTED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
-			<p class="topictitle"> { $topicrow:ATTACH_ICON_IMG } <a href="{ $searchresults:U_VIEW_TOPIC }">{ $searchresults:TOPIC_TITLE }</a></p>
+			<p class="topictitle"> { $searchresults:ATTACH_ICON_IMG } <a href="{ $searchresults:U_VIEW_TOPIC }">{ $searchresults:TOPIC_TITLE }</a></p>
 			<!-- IF { $searchresults:PAGINATION } -->
 				<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $searchresults:PAGINATION } ] </p>
 			<!-- ENDIF -->
@@ -87,7 +89,7 @@
 		<td align="center" valign="middle"><b class="postauthor">{ $searchresults:POSTER_NAME }</b></td>
 		<td height="25"><table width="100%" cellspacing="0" cellpadding="0" border="0">
 			<tr>
-				<td class="gensmall"><div style="float:left">&nbsp;<b>{ $L_POST_SUBJECT }:</b> <a href="{ $searchresults:U_VIEW_POST }">{ $searchresults:POST_SUBJECT }</a></div><div style="float:right"><a href="{ $searchresults:U_VIEW_POST}">{ $searchresults:MINI_POST_IMG }</a><b>{ $L_POSTED }:</b> { $searchresults:POST_DATE }&nbsp;</div></td>
+				<td class="gensmall"><div style="float:left">&nbsp;<b>{ $L_POST_SUBJECT }:</b> <a href="{ $searchresults:U_VIEW_POST }">{ $searchresults:POST_SUBJECT }</a></div><div style="float:right"><a href="{ $searchresults:U_VIEW_POST}"></a><b>{ $L_POSTED }:</b> { $searchresults:POST_DATE }&nbsp;</div></td>
 			</tr>
 		</table></td>
 	</tr>
@@ -116,7 +118,7 @@
 
 </form>
 
-<div class="nav" style="float:left"><!-- IF { $PAGINATION } -->{ $PAGE_NUMBER }&nbsp;[ { $TOTAL_MATCHES } ]<!-- ENDIF -->&nbsp;</div><div class="nav" style="float:right"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></div>
+<div class="nav" style="float:left"><!-- IF { $PAGINATION } -->{ $PAGE_NUMBER }&nbsp;[ { $TOTAL_MATCHES } ]<!-- ENDIF -->&nbsp;</div><div class="nav" style="float:right"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a>{ $PAGINATION }</b><!-- ENDIF --></div>
 
 <br clear="all" /><br />
 
@@ -130,4 +132,6 @@
 
 <div style="float:right"><!-- IF { $S_DISPLAY_JUMPBOX } --><!-- INCLUDE modules/Forums/jumpbox.html --><!-- ENDIF --></div>
 
-<!-- INCLUDE modules/Forums/overall_footer.html -->
\ No newline at end of file
+<!-- INCLUDE modules/Forums/overall_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/google_search/index.html
===================================================================
--- cms/trunk/includes/templates/modules/google_search/index.html	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/includes/templates/modules/google_search/index.html	2005-09-21 03:53:30 UTC (rev 137)
@@ -0,0 +1,58 @@
+<!-- DISPLAY_HEADER -->
+
+{ $A_TABLE_OPEN }
+
+<form method="post" action="">
+	<input name="q" size="15" maxlength="200" value="" type="text" /> <input class="button" name="submit" value="Search" type="submit" />
+</form>
+	
+<table class="tablebg" width="100%" cellpadding="1" cellspacing="1">
+	<tbody>
+		<!-- IF { $google_pagination } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="2">
+				<div style="padding-right: 5px; text-align: right;">{ $google_pagination }</div>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="spacer" colspan="2" height="7"></td>
+		</tr>
+		<!-- LOOP $google_result -->
+		<tr>
+			<td align="center" class="row1">
+				<b>{ $google_result:num }</b>
+			</td>
+			<td class="row1">
+				<a href="{ $google_result:url } "><b>{ $google_result:title }</b></a>
+			</td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row1">
+				<p>{ $google_result:snippet }</p>
+			</td>
+		</tr>
+		<tr>
+			<td class="spacer" colspan="2" height="7"></td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row2">
+			<td align="center" colspan="2">
+				{ $L_RESULTS_FOUND }
+			</td>
+		</tr>
+		<!-- ENDLOOP -->
+
+		<!-- IF { $google_pagination } -->
+		<tr class="row2">
+			<td style="padding: 5px;" valign="middle" colspan="2">
+				<div style="padding-right: 5px; text-align: right;">{ $google_pagination }</div>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+	</tbody>
+</table>
+
+{ $A_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/install/build_data.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -46,7 +46,7 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mb_mail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mail', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/install/build_tables.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -959,4 +959,17 @@
 
 $_CLASS['core_db']->table_create('commit');
 
+
+$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_results');
+
+$_CLASS['core_db']->add_table_field_int('search_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_char('session_id', 40);
+field_unix_time('search_time', true);
+$_CLASS['core_db']->add_table_field_text('search_array', 16000000);
+
+$_CLASS['core_db']->add_table_index('search_id', 'primary');
+$_CLASS['core_db']->add_table_index('session_id', 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Forums/admin/index.php
===================================================================
--- cms/trunk/modules/Forums/admin/index.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/admin/index.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -49,9 +49,9 @@
 
 $_CLASS['core_blocks']->add_block($data);
 
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
-require_once($site_file_root.'includes/forums/functions.php');
-require_once($site_file_root.'includes/forums/functions_admin.php');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 
 $_CLASS['core_user']->add_lang('admin', 'Forums');
 //$_CLASS['core_user']->add_img(false, 'Forums');
@@ -59,13 +59,13 @@
 
 $file = get_variable('file', 'REQUEST', 'main');
 
-if (file_exists($site_file_root.'includes/forums/admin/'.$file.'.php'))
+if (file_exists(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php'))
 {
-	require($site_file_root.'includes/forums/admin/'.$file.'.php');
+	require(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php');
 }
 else
 {
-	require($site_file_root.'includes/forums/admin/main.php');
+	require(SITE_FILE_ROOT.'includes/forums/admin/main.php');
 }
 
 

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -28,8 +28,8 @@
 
 header('Content-Type: text/html');
 
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
 
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
 

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/index.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -32,8 +32,8 @@
 
 unset($approved_files);
 
-require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
 
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
 

Modified: cms/trunk/modules/Forums/main.php
===================================================================
--- cms/trunk/modules/Forums/main.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/main.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -37,12 +37,12 @@
     die;
 }
 
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
 
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_img();
 
-require($site_file_root.'includes/forums/functions_display.php');
+require(SITE_FILE_ROOT.'includes/forums/functions_display.php');
 display_forums('', $config['load_moderators']);
 
 // Grab group details for legend display

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/posting.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -1258,7 +1258,7 @@
 
 		case 'delete_first_post':
 			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_USERS_TABLE . " u
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . " u
 				WHERE p.topic_id = $topic_id 
 					AND p.poster_id = u.user_id 
 				ORDER BY p.post_time ASC";

Modified: cms/trunk/modules/Forums/search.php
===================================================================
--- cms/trunk/modules/Forums/search.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/search.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -1,4 +1,26 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: search.php,v 1.108 2004/10/19 19:20:30 acydburn Exp $
@@ -46,7 +68,7 @@
 $search_child		= request_var('search_child', true);
 
 $return_chars	= request_var('return_chars', 200);
-$search_forum	= request_var('search_forum', 0);
+$search_forum	= request_var('search_forum', array(0));
 
 $sort_days	= request_var('st', 0);
 $sort_key	= request_var('sk', 't');
@@ -60,20 +82,20 @@
 gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
 
 $store_vars		= array('sort_key', 'sort_dir', 'sort_days', 'show_results', 'return_chars', 'total_match_count');
-$current_time	= time();
+$current_time	= $_CLASS['core_user']->time;
 $stopped_words	= array();
 
 // Check last search time ... if applicable
 if ($config['search_interval'])
 {
 	$sql = 'SELECT MAX(search_time) as last_time
-		FROM ' . SEARCH_TABLE."
-			WHERE session_id = '" . $_CLASS['core_db']->escape($_CLASS['core_user']->data['session_id']) . '\'';
+		FROM ' . FORUMS_SEARCH_TABLE."
+			WHERE session_id = '" . $_CLASS['core_db']->escape($_CLASS['core_user']->data['session_id']) . "'";
 	$result = $_CLASS['core_db']->query($sql);
 
 	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		if ($row['last_time'] > time() - $config['search_interval'])
+		if ($row['last_time'] > $_CLASS['core_user']->time - $config['search_interval'])
 		{
 			trigger_error('NO_SEARCH_TIME');
 		}
@@ -84,74 +106,78 @@
 {
 	$post_id_ary = $split_words = $old_split_words = $common_words = array();
 
-	// Which forums can we view?
-	$sql_where = (sizeof($search_forum) && !$search_child) ? 'WHERE forum_id IN (' . implode(', ', $search_forum) . ')' : '';
-	$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, right_id, forum_password
-		FROM ' . FORUMS_TABLE . "
-		$sql_where
-		ORDER BY left_id";
-	$result = $_CLASS['core_db']->query($sql);
+	$permission_array = array_keys($_CLASS['auth']->acl_getf('f_read'));
 
-	$right_id = 0;
-	$sql_forums = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if (!empty($search_forum))
 	{
-		if ($search_child)
+		$search_forum = array_unique($search_forum);
+		$difference = array_diff($search_forum, $permission_array);
+
+		// I'm sure theres a better way to do this, but it's close to midnight
+		if (!empty($difference))
 		{
-			if (!$search_forum || (in_array($row['forum_id'], $search_forum) && $row['right_id'] > $right_id))
+			$count = count($search_forum);
+			
+			for ($i = 0; $i < $count; $i++)
 			{
-				$right_id = $row['right_id'];
+				if (!in_array($search_forum[$i], $difference))
+				{
+					$temp[] = $search_forum[$i];
+				}
 			}
-			elseif ($row['right_id'] > $right_id)
-			{
-				continue;
-			}
-		}
+			$search_forum = $temp;
 
-// Fix password
-		if ($_CLASS['auth']->acl_get('f_read', $row['forum_id']) && (!$row['forum_password']))
-		{
-			$sql_forums[] = $row['forum_id'];
+			unset($temp);
 		}
 	}
-	$_CLASS['core_db']->free_result($result);
+	else
+	{
+		$search_forum =& $permission_array;
+	}
 
-	if (!sizeof($sql_forums))
+	if (empty($search_forum))
 	{
 		trigger_error('NO_SEARCH_RESULTS');
 	}
 
-	$sql_forums = ' AND p.forum_id IN (' . implode(', ', $sql_forums) . ')';
-	unset($search_forum);
+// This should be only intergers
+	$sql_forums = ' AND p.forum_id IN (' . implode(', ', $search_forum) . ')';
 
+	unset($search_forum, $permission_array);
 
-	if ($search_id == 'egosearch')
+	if ($search_id === 'egosearch')
 	{
 		$search_author = $_CLASS['core_user']->data['username'];
 	}
 
-
 	// Are we looking for a user?
 	$sql_author = '';
+
 	if ($search_author)
 	{
-		$sql_where = (strstr($search_author, '*') !== false) ? ' LIKE ' : ' = ';
+		$sql_where = (mb_strpos($search_author, '*') !== false) ? ' LIKE ' : ' = ';
+
 		$sql = 'SELECT user_id 
 			FROM ' . USERS_TABLE . "
 			WHERE username $sql_where '" . $_CLASS['core_db']->escape(preg_replace('#\*+#', '%', $search_author)) . "'
-				AND user_type IN (" . USER_NORMAL . ', ' . USER_FOUNDER . ')';
+				AND user_type = " . USER_NORMAL;
 		$result = $_CLASS['core_db']->query($sql);
+		
+		
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$sql_author[] = $row['user_id'];
+		}
+		$_CLASS['core_db']->free_result($result);
 
-		if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
+		if (empty($sql_author))
 		{
 			trigger_error('NO_SEARCH_RESULTS');
 		}
-		$_CLASS['core_db']->free_result($result);
 
-		$sql_author = ' p.poster_id = ' . $row['user_id'];
+		$sql_author = (count($sql_author) == 1) ?  ' p.poster_id = ' . $sql_author[0] : ' p.poster_id IN (' . implode(', ', $sql_author) . ')';
 	}
 
-	
 	if ($search_id)
 	{
 		switch ($search_id)
@@ -166,11 +192,11 @@
 					gen_sort_selects($limit_days, $sort_by_text, $sort_days, $sort_key, $sort_dir, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
 				}
 
-				$last_post_time = (gmtime() - ($sort_days * 24 * 3600));
+				$last_post_time = ($_CLASS['core_user']->time - ($sort_days * 24 * 3600));
 
 				$sql = 'SELECT DISTINCT t.topic_id
-					FROM ' . POSTS_TABLE . ' p
-					LEFT JOIN ' . TOPICS_TABLE . " t ON (t.topic_approved = 1 AND p.topic_id = t.topic_id)
+					FROM ' . FORUMS_POSTS_TABLE . ' p
+					LEFT JOIN ' . FORUMS_TOPICS_TABLE . " t ON (t.topic_approved = 1 AND p.topic_id = t.topic_id)
 					WHERE p.post_time > $last_post_time
 						$sql_forums
 					ORDER BY t.topic_last_post_time DESC";
@@ -180,17 +206,22 @@
 				{
 					$post_id_ary[] = $row['topic_id'];
 				}
-				$_CLASS['core_db']->free_result($result);
-				break;
+				$_CLASS['core_db']->free_result($result);
 				
+				if (empty($post_id_ary))
+				{
+					trigger_error('NO_SEARCH_RESULTS');
+				}
+			break;
+				
 			case 'egosearch':
-				break;
+			break;
 
 			case 'unanswered':
 				if ($show_results == 'posts')
 				{
 					$sql = 'SELECT p.post_id 
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . " t 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . " t 
 						WHERE t.topic_replies = 0
 							AND p.topic_id = t.topic_id
 							$sql_forums";
@@ -199,7 +230,7 @@
 				else
 				{
 					$sql = 'SELECT t.topic_id 
-						FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . " t 
+						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . " t 
 						WHERE t.topic_replies = 0 
 							AND p.topic_id = t.topic_id
 							$sql_forums
@@ -214,17 +245,17 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-				if (!sizeof($post_id_ary))
+				if (empty($post_id_ary))
 				{
 					trigger_error('NO_SEARCH_RESULTS');
 				}
-				break;
+			break;
 
 			case 'newposts':
 				if ($show_results == 'posts')
 				{
 					$sql = 'SELECT p.post_id 
-						FROM ' . POSTS_TABLE . ' p 
+						FROM ' . FORUMS_POSTS_TABLE . ' p 
 						WHERE p.post_time > ' . $_CLASS['core_user']->data['user_last_visit'] . "
 							$sql_forums";
 					$field = 'post_id';
@@ -232,7 +263,7 @@
 				else
 				{
 					$sql = 'SELECT t.topic_id
-						FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . ' p 
+						FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . ' p 
 						WHERE p.post_time > ' . $_CLASS['core_user']->data['user_last_visit'] . " 
 							AND t.topic_id = p.topic_id 
 							$sql_forums 
@@ -247,23 +278,25 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-				if (!sizeof($post_id_ary))
+				if (empty($post_id_ary))
 				{
 					trigger_error('NO_SEARCH_RESULTS');
 				}
-				break;
+			break;
 		}
 	}
 	
 	if ($search_session_id)
 	{
 		$sql = 'SELECT search_array
-			FROM ' . SEARCH_TABLE . "
+			FROM ' . FORUMS_SEARCH_TABLE . "
 			WHERE search_id = $search_session_id
 				AND session_id = '" . $_CLASS['core_db']->escape($_CLASS['core_user']->data['session_id']) . "'";
 		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		if ($row)
 		{
 			$data = explode('#', $row['search_array']);
 
@@ -285,9 +318,11 @@
 			$sql_where = (($show_results == 'posts') ? 'p.post_id' : 't.topic_id') . ' IN (' . implode(', ', $data) . ')';
 			unset($data);
 		}
-		$_CLASS['core_db']->free_result($result);
+		else
+		{
+			$search_session_id = false;
+		}
 	}
-	// TODO: hook in fulltext_phpbb/mysql
 
 	// Are we looking for words
 	if ($search_keywords)
@@ -307,8 +342,9 @@
 		if ($fp = @fopen($_CLASS['core_user']->lang_path . '/search_synonyms.txt', 'rb'))
 		{
 			preg_match_all('#^(.*?) (.*?)$#ms', fread($fp, filesize($_CLASS['core_user']->lang_path . '/search_synonyms.txt')), $match);
-			$replace_synonym = &$match[1];
-			$match_synonym = &$match[2];
+			
+			$replace_synonym = $match[1];
+			$match_synonym = $match[2];
 		}
 		fclose($fp);
 
@@ -346,12 +382,12 @@
 		}
 	}
 
-	if (isset($old_split_words) && sizeof($old_split_words))
+	if (!empty($old_split_words))
 	{
-		$split_words = (sizeof($split_words)) ? array_diff($split_words, $old_split_words) : $old_split_words;
+		$split_words = !empty($split_words) ? array_diff($split_words, $old_split_words) : $old_split_words;
 	}
-	
-	if (sizeof($split_words))
+
+	if (!empty($split_words))
 	{
 		// This "entire" section may be switched out to allow for alternative search systems
 		// such as that built-in to MySQL, MSSQL, etc. or external solutions which provide
@@ -359,23 +395,28 @@
 
 		$bool = ($search_terms == 'all') ? 'AND' : 'OR';
 		$sql_words = '';
+
 		foreach ($split_words as $word)
 		{
 			switch ($word)
 			{
 				case '-':
 					$bool = 'NOT';
-					continue;
+				break;
+
 				case '+':
 					$bool = 'AND';
-					continue;
+				break;
+
 				case '|':
 					$bool = 'OR';
-					continue;
+				break;
+
 				default:
 					$bool = ($search_terms != 'all') ? 'OR' : $bool;
 					$sql_words[$bool][] = "'" . preg_replace('#\*+#', '%', trim($word)) . "'";
 					$bool = ($search_terms == 'all') ? 'AND' : 'OR';
+				break;
 			}
 		}
 
@@ -393,13 +434,14 @@
 
 		// Build some display specific variable strings
 		$sql_select = ($show_results == 'posts') ? 'm.post_id' : 'DISTINCT t.topic_id';
-		$sql_from = ($show_results == 'posts') ? '' : TOPICS_TABLE . ' t, ';
+		$sql_from = ($show_results == 'posts') ? '' : FORUMS_TOPICS_TABLE . ' t, ';
 		$sql_topic = ($show_results == 'posts') ? '' : 'AND t.topic_id = p.topic_id';
 		$sql_time = ($sort_days) ? 'AND p.post_time >= ' . ($current_time - ($sort_days * 86400)) : '';
 		$field = ($show_results == 'posts') ? 'm.post_id' : 't.topic_id';
 
 		// Are we searching within an existing search set? Yes, then include the old ids
-		$sql_find_in = ($sql_where) ? "AND $sql_where" : '';
+		//$sql_find_in = ($sql_where) ? "AND $sql_where" : '';
+		$sql_find_in = '';
 
 		$result_ary = array();
 		foreach (array('AND', 'OR', 'NOT') as $bool)
@@ -422,7 +464,7 @@
 							$sql_and = (isset($result_ary['AND']) && sizeof($result_ary['AND'])) ? "AND $field IN (" . implode(', ', $result_ary['AND']) . ')' : '';
 
 							$sql = "SELECT $sql_select 
-								FROM $sql_from" . POSTS_TABLE . ' p, ' . SEARCH_MATCH_TABLE . ' m, ' . SEARCH_WORD_TABLE . " w 
+								FROM $sql_from" . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_SEARCH_MATCH_TABLE . ' m, ' . FORUMS_SEARCH_WORD_TABLE . " w 
 								WHERE w.word_text $sql_where 
 									AND m.word_id = w.word_id 
 									AND w.word_common <> 1 
@@ -477,7 +519,7 @@
 
 						$sql_and = (sizeof($result_ary['AND'])) ? "AND $field IN (" . implode(', ', $result_ary['AND']) . ')' : '';
 						$sql = "SELECT $sql_select 
-							FROM $sql_from" . POSTS_TABLE . ' p, ' . SEARCH_MATCH_TABLE . ' m, ' . SEARCH_WORD_TABLE . " w 
+							FROM $sql_from" . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_SEARCH_MATCH_TABLE . ' m, ' . FORUMS_SEARCH_WORD_TABLE . " w 
 							WHERE ($sql_where) 
 								AND m.word_id = w.word_id 
 								AND w.word_common <> 1 
@@ -529,7 +571,7 @@
 		}
 
 		$sql = 'SELECT word_text 
-			FROM ' . SEARCH_WORD_TABLE . ' 
+			FROM ' . FORUMS_SEARCH_WORD_TABLE . ' 
 			WHERE word_text IN (' . implode(', ', array_unique(array_merge($sql_words['AND'], $sql_words['OR'], $sql_words['NOT']))) . ')
 				AND word_common = 1';
 		$result = $_CLASS['core_db']->query($sql);
@@ -540,12 +582,12 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 	}
-	else if ($search_author)
+	elseif ($search_author)
 	{
-		if ($show_results == 'posts')
+		if ($show_results === 'posts')
 		{
 			$sql = 'SELECT p.post_id 
-				FROM ' . POSTS_TABLE . " p 
+				FROM ' . FORUMS_POSTS_TABLE . " p 
 				WHERE $sql_author 
 					$sql_forums";
 			$field = 'post_id';
@@ -553,7 +595,7 @@
 		else
 		{
 			$sql = 'SELECT t.topic_id 
-				FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p 
+				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p 
 				WHERE $sql_author
 					$sql_forums
 					AND t.topic_id = p.topic_id 
@@ -569,32 +611,40 @@
 		$_CLASS['core_db']->free_result($result);
 	}
 
-
-	if ($post_id_ary && sizeof($post_id_ary))
+	if (!empty($post_id_ary))
 	{
-		// Finish building query (for all combinations) and run it ...
+/*
+ Make uses of autoinsert for search_id
+ also rethink the why this is done, storing things more then one shouldn't be needed
+*/
 		$sql = 'SELECT session_id
-			FROM ' . SESSIONS_TABLE;
-		if ($result = $_CLASS['core_db']->query($sql))
+			FROM ' . SESSIONS_TABLE ."
+			WHERE session_id <> '" . $_CLASS['core_user']->data['session_id'] . "'";
+		$result = $_CLASS['core_db']->query($sql);
+
+		$delete_search_ids = array();
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$delete_search_ids = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$delete_search_ids[] = "'" . $_CLASS['core_db']->escape($row['session_id']) . "'";
-			}
+			$delete_search_ids[] = "'" . $_CLASS['core_db']->escape($row['session_id']) . "'";
+		}
 
-			if (sizeof($delete_search_ids))
-			{
-				$sql = 'DELETE FROM ' . SEARCH_TABLE . '
-					WHERE session_id NOT IN (' . implode(", ", $delete_search_ids) . ')';
-				$_CLASS['core_db']->query($sql);
-			}
+		if (empty($delete_search_ids))
+		{
+			$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
 		}
+		else
+		{
+			$sql = 'DELETE FROM ' . FORUMS_SEARCH_TABLE . '
+				WHERE session_id NOT IN (' . implode(', ', $delete_search_ids) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+		unset($delete_search_ids);
 
-		$total_match_count = sizeof($post_id_ary);
-		$sql_where = (($show_results == 'posts') ? 'p.post_id' : 't.topic_id') . ' IN (' . implode(', ', $post_id_ary) . ')';
+		$total_match_count = count($post_id_ary);
 
-		if (sizeof($old_split_words) && array_diff($split_words, $old_split_words))
+		$sql_where = (($show_results === 'posts') ? 'p.post_id' : 't.topic_id') . ' IN (' . implode(', ', $post_id_ary) . ')';
+
+		if (!empty($old_split_words) && array_diff($split_words, $old_split_words))
 		{
 			$split_words = array_merge($split_words, $old_split_words);
 		}
@@ -610,7 +660,6 @@
 		$data .= '#' . implode('#', $post_id_ary);
 		unset($post_id_ary);
 
-		srand ((double) microtime() * 1000000);
 		$search_session_id = rand();
 
 		$sql_ary = array(
@@ -620,12 +669,11 @@
 			'search_array'	=> $data
 		);
 
-		$sql = 'INSERT INTO ' . SEARCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_SEARCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 		unset($data);
 	}
 
-	if ($show_results == 'posts')
+	if ($show_results === 'posts')
 	{
 		require($site_file_root.'includes/forums/functions_posting.php');
 	}
@@ -635,11 +683,10 @@
 	}
 
 	// Look up data ...
-	$per_page = ($show_results == 'posts') ? $config['posts_per_page'] : $config['topics_per_page'];
+	$per_page = ($show_results === 'posts') ? $config['posts_per_page'] : $config['topics_per_page'];
 
 	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	// Output header
 	$l_search_matches = ($total_match_count == 1) ? sprintf($_CLASS['core_user']->lang['FOUND_SEARCH_MATCH'], $total_match_count) : sprintf($_CLASS['core_user']->lang['FOUND_SEARCH_MATCHES'], $total_match_count);
@@ -649,11 +696,14 @@
 	$split_words = htmlspecialchars(implode(' ', $split_words));
 	$ignored_words = htmlspecialchars(implode(' ', $stopped_words));
 
-	$_CLASS['core_template']->assign(array(
+	$pagination = generate_pagination("Forums&amp;file=search&amp;search_session_id=$search_session_id&amp;search_id=$search_id&amp;hilit=$hilit&amp;$u_sort_param", $total_match_count, $per_page, $start);
+
+	$_CLASS['core_template']->assign_array(array(
 		'SEARCH_MATCHES'	=> $l_search_matches,
 		'SEARCH_WORDS'		=> $split_words, 
 		'IGNORED_WORDS'		=> ($ignored_words) ? $ignored_words : '', 
-		'PAGINATION'		=> generate_pagination("Forums&amp;file=search&amp;search_session_id=$search_session_id&amp;search_id=$search_id&amp;hilit=$hilit&amp;$u_sort_param", $total_match_count, $per_page, $start),
+		'PAGINATION'		=> $pagination['formated'],
+		'PAGINATION_ARRAY'	=> $pagination['array'],
 		'PAGE_NUMBER'		=> on_page($total_match_count, $per_page, $start),
 		'TOTAL_MATCHES'		=> $total_match_count,
 
@@ -695,7 +745,7 @@
 			$_CLASS['core_db']->free_result($result);
 	
 			$sql = 'SELECT p.*, f.forum_id, f.forum_name, t.*, u.username, u.user_sig, u.user_sig_bbcode_uid
-				FROM ' . FORUMS_TABLE . ' f, ' . TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u, ' . POSTS_TABLE . " p 
+				FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u, ' . FORUMS_POSTS_TABLE . " p 
 				WHERE $sql_where 
 					AND f.forum_id = p.forum_id
 					AND p.topic_id = t.topic_id
@@ -704,13 +754,14 @@
 		else
 		{
 			$sql = 'SELECT t.*, f.forum_id, f.forum_name
-				FROM ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . " f 
+				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f 
 				WHERE $sql_where 
 					AND f.forum_id = t.forum_id";
 		}
-		$sql .= ' ORDER BY ' . $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC') . " LIMIT $start, $per_page";
-		$result = $_CLASS['core_db']->query($sql);
-	
+
+		$sql .= ' ORDER BY ' . $sort_by_sql[$sort_key] . ' ' . (($sort_dir == 'd') ? 'DESC' : 'ASC');
+		$result = $_CLASS['core_db']->query_limit($sql, $per_page, $start);
+
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$forum_id = $row['forum_id'];
@@ -718,20 +769,23 @@
 	
 			$view_topic_url = "Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;hilit=$u_hilit";
 	
-			if ($show_results == 'topics')
+			if ($show_results === 'topics')
 			{
 				$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
 	
 				$folder_img = $folder_alt = $topic_type = '';
-				topic_status($row, $replies, time(), time(), $folder_img, $folder_alt, $topic_type);
-	
+				topic_status($row, $replies, $_CLASS['core_user']->time, $folder_img, $folder_alt, $topic_type);
+
+				$pagination = generate_pagination($view_topic_url, $replies, $config['posts_per_page'], 0);
+
 				$tpl_ary = array(
 					'TOPIC_AUTHOR' 		=> topic_topic_author($row),
 					'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 					'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 					'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 					'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-					'PAGINATION' 		=> topic_generate_pagination($replies, $view_topic_url),
+					'PAGINATION'		=> $pagination['formated'],
+					'PAGINATION_ARRAY'	=> $pagination['array'],
 					'REPLIES' 			=> $replies,
 					'VIEWS' 			=> $row['topic_views'],
 					'TOPIC_TYPE' 		=> $topic_type,
@@ -741,12 +795,12 @@
 					'TOPIC_ICON_IMG'		=> (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
 					'TOPIC_ICON_IMG_WIDTH'	=> (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
 					'TOPIC_ICON_IMG_HEIGHT'	=> (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
-					'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+					'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 					'S_TOPIC_TYPE'			=> $row['topic_type'],
 					'S_USER_POSTED'			=> (!empty($row['mark_type'])) ? true : false,
 	
-					'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_gets('m_', $forum_id)) ? true : false,
-					'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_gets('m_approve', $forum_id)) ? true : false,
+					'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_get('m_', $forum_id)) ? true : false,
+					'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_get('m_approve', $forum_id)) ? true : false,
 					'S_IGNORE_POST'			=> false,
 
 					'U_LAST_POST'		=> generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false),
@@ -766,34 +820,34 @@
 	
 					continue;
 				}
-	
+
 				if ($row['enable_html'])
 				{
 					$row['post_text'] = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $row['post_text']);
 				}
-	
+
 				$row['post_text'] = censor_text($row['post_text']);
-	
+
 				decode_message($row['post_text'], $row['bbcode_uid']);
-			
+
 				if ($return_chars)
 				{
 					$row['post_text'] = (strlen($row['post_text']) < $return_chars + 3) ? $row['post_text'] : substr($row['post_text'], 0, $return_chars) . '...';
 				}
-	
+
 				if ($hilit)
 				{
 					// This was shamelessly 'borrowed' from volker at multiartstudio dot de
 					// via php.net's annotated manual
 					$row['post_text'] = str_replace('\"', '"', substr(preg_replace('#(\>(((?>([^><]+|(?R)))*)\<))#se', "preg_replace('#\b(" . str_replace('\\', '\\\\', addslashes($hilit)) . ")\b#i', '<span class=\"posthilit\">\\\\1</span>', '\\0')", '>' .  $row['post_text'] . '<'), 1, -1));
 				}
-				
+
 				$row['post_text'] = smiley_text($row['post_text']);
-				
+
 				// Replace naughty words such as farty pants
 				$row['post_subject'] = censor_text($row['post_subject']);
 				$row['post_text'] = str_replace("\n", '<br />', censor_text($row['post_text']));
-				
+
 				$tpl_ary = array(
 					'POSTER_NAME'		=> ($row['poster_id'] == ANONYMOUS) ? ((!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'], 
 					'POST_SUBJECT'		=> censor_text($row['post_subject']), 
@@ -833,62 +887,61 @@
 
 // Search forum
 $s_forums = '';
-$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id, forum_password
-	FROM ' . FORUMS_TABLE . '
-	ORDER BY left_id ASC';
-$result = $_CLASS['core_db']->query($sql);
 
-$right = $cat_right = $padding_inc = 0;
-$padding = $forum_list = $holding = '';
-$pad_store = array('0' => '');
-$search_forums = array();
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+if ($permission_array = $_CLASS['auth']->acl_getf('f_list'))
 {
-	if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
-	{
-		// Non-postable forum with no subforums, don't display
-		continue;
-	}
+	$sql = 'SELECT forum_id, forum_name, parent_id, forum_type, left_id, right_id, forum_password
+		FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id IN (' . implode(', ', array_keys($permission_array)) . ')
+			ORDER BY left_id ASC';
 
-// fix password
-	if (!$_CLASS['auth']->acl_get('f_list', $row['forum_id']) || $row['forum_type'] == FORUM_LINK || ($row['forum_password']))
+	$result = $_CLASS['core_db']->query($sql);
+	
+	$right = $cat_right = $padding_inc = 0;
+	$padding = $forum_list = $holding = '';
+	$pad_store = array('0' => '');
+	$search_forums = array();
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		// if the user does not have permissions to list this forum skip
-		continue;
-	}
+		if (($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id'])) || $row['forum_type'] == FORUM_LINK || ($row['forum_password']))
+		{
+			continue;
+		}
 
-	if ($row['left_id'] < $right)
-	{
-		$padding .= '&nbsp; &nbsp;';
-		$pad_store[$row['parent_id']] = $padding;
-	}
-	else if ($row['left_id'] > $right + 1)
-	{
-		$padding = $pad_store[$row['parent_id']];
-	}
+		if ($row['left_id'] < $right)
+		{
+			$padding .= '&nbsp; &nbsp;';
+			$pad_store[$row['parent_id']] = $padding;
+		}
+		else if ($row['left_id'] > $right + 1)
+		{
+			$padding = $pad_store[$row['parent_id']];
+		}
 
-	$right = $row['right_id'];
+		$right = $row['right_id'];
 
-	$selected = (!sizeof($search_forums) || in_array($row['forum_id'], $search_forums)) ? ' selected="selected"' : '';
+		$selected = (empty($search_forums) || in_array($row['forum_id'], $search_forums)) ? ' selected="selected"' : '';
 
-	if ($row['left_id'] > $cat_right)
-	{
-		$holding = '';
-	}
+		if ($row['left_id'] > $cat_right)
+		{
+			$holding = '';
+		}
 
-	if ($row['right_id'] - $row['left_id'] > 1)
-	{
-		$cat_right = max($cat_right, $row['right_id']);
-
-		$holding .= '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
+		if ($row['right_id'] - $row['left_id'] > 1)
+		{
+			$cat_right = max($cat_right, $row['right_id']);
+	
+			$holding .= '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
+		}
+		else
+		{
+			$s_forums .= $holding . '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
+			$holding = '';
+		}
 	}
-	else
-	{
-		$s_forums .= $holding . '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
-		$holding = '';
-	}
+	$_CLASS['core_db']->free_result($result);
 }
-$_CLASS['core_db']->free_result($result);
 unset($pad_store);
 
 // Number of chars returned
@@ -903,7 +956,7 @@
 	$s_characters .= '<option value="' . $i . '"' . $selected . '>' . $i . '</option>';
 }
 
-$_CLASS['core_template']->assign(array(
+$_CLASS['core_template']->assign_array(array(
 	'S_SEARCH_ACTION'		=> generate_link('Forums&amp;file=search&amp;mode=results'),
 	'S_CHARACTER_OPTIONS'	=> $s_characters,
 	'S_FORUM_OPTIONS'		=> $s_forums,
@@ -913,18 +966,12 @@
 );
 
 $sql = 'SELECT search_id, search_time, search_array 
-	FROM ' . SEARCH_TABLE . '
+	FROM ' . FORUMS_SEARCH_TABLE . '
 	ORDER BY search_time DESC';
-$result = $_CLASS['core_db']->query($sql);
+$result = $_CLASS['core_db']->query_limit($sql, 5);
 
-$i = 0;
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	if ($i == 5)
-	{
-		break;
-	}
-
 	$data = explode('#', $row['search_array']);
 	$split_words = htmlspecialchars(implode(' ', unserialize(array_shift($data))));
 
@@ -934,7 +981,6 @@
 	}
 
 	$stopped_words = htmlspecialchars(implode(' ', unserialize(array_shift($data))));
-	unset($data);
 
 	$_CLASS['core_template']->assign_vars_array('recentsearch', array(
 		'KEYWORDS'	=> $split_words,
@@ -942,11 +988,10 @@
 
 		'U_KEYWORDS'	=> generate_link('Forums&amp;file=search&amp;search_keywords=' . urlencode($split_words)))
 	);
-
-	$i++;
 }
 $_CLASS['core_db']->free_result($result);
 
+unset($data, $split_words, $stopped_words);
 // Output the basic page
 
 page_header();

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -39,7 +39,7 @@
     die;
 }
 
-require($site_file_root.'includes/forums/functions_display.php');
+require(SITE_FILE_ROOT.'includes/forums/functions_display.php');
 
 // Start initial var setup
 $forum_id	= request_var('f', 0);
@@ -204,7 +204,7 @@
 // Do the forum Prune thang - cron type job ...
 if ($forum_data['prune_next'] < time() && $forum_data['enable_prune'])
 {
-	require_once($site_file_root.'includes/forums/functions_admin.php');
+	require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 
 	if ($forum_data['prune_days'])
 	{

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-20 21:46:50 UTC (rev 136)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-21 03:53:30 UTC (rev 137)
@@ -482,7 +482,7 @@
 
 	if ($poll_info[0]['bbcode_bitfield'])
 	{
-		require_once($site_file_root.'includes/forums/bbcode.php');
+		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$poll_bbcode = new bbcode();
 		
 		$size = !empty($poll_info);
@@ -829,7 +829,7 @@
 {
 	if ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id))
 	{
-		include($site_file_root.'includes/forums/functions_display.php');
+		include(SITE_FILE_ROOT.'includes/forums/functions_display.php');
 
 		$sql = 'SELECT * 
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -899,7 +899,7 @@
 // Instantiate BBCode if need be
 if ($bbcode_bitfield)
 {
-	require_once($site_file_root.'includes/forums/bbcode.php');
+	require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 



From viperal at berlios.de  Wed Sep 21 20:04:47 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 21 Sep 2005 20:04:47 +0200
Subject: [Viperals-svncheckins] r139 - in cms/trunk: includes/forums includes/forums/mcp includes/templates/modules/Forums modules/Forums
Message-ID: <200509211804.j8LI4lji015192@sheep.berlios.de>

Author: viperal
Date: 2005-09-21 20:04:46 +0200 (Wed, 21 Sep 2005)
New Revision: 139

Modified:
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_front.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/templates/modules/Forums/mcp_forum.html
   cms/trunk/includes/templates/modules/Forums/mcp_topic.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/modules/Forums/mcp.php
Log:


Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -317,7 +317,7 @@
 
 	// Get those messages not yet placed into any box
 	// NOTE: Expand Group Information to all groups the user/author is in? 
-	$sql = 'SELECT t.*, p.*, u.username, u.group_id as author_in_group
+	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,266 +1,283 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_forum.php,v 1.3 2004/07/19 20:13:16 acydburn Exp $
-//
-// FILENAME  : mcp_forum.php
-// STARTED   : Thu Jul 08, 2004
-// COPYRIGHT : ? 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//
-// TODO:
-//
-
-function mcp_forum_view($id, $mode, $action, $url, $forum_info)
-{
-	global $config, $_CLASS;
-	
-	if ($action == 'merge_select')
-	{
-		// Fixes a "bug" that makes forum_view use the same ordering as topic_view
-		unset($_POST['sk'], $_POST['sd'], $_REQUEST['sk'], $_REQUEST['sd']);
-	}
-
-	$forum_id = $forum_info['forum_id'];
-	$start = request_var('start', 0);
-	$topic_id_list = request_var('topic_id_list', array(0));
-	$post_id_list = request_var('post_id_list', array(0));
-	$topic_id = request_var('t', 0);
-
-	// Resync Topics
-	if ($action == 'resync')
-	{
-		$topic_ids = request_var('topic_id_list', array(0));
-
-		if (!sizeof($topic_ids))
-		{
-			$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
-		}
-		else
-		{
-			mcp_resync_topics($topic_ids);
-		}
-	}
-
-	$selected_ids = '';
-	if (sizeof($post_id_list))
-	{
-		foreach ($post_id_list as $num => $post_id)
-		{
-			$selected_ids .= '&amp;post_id_list[' . $num . ']=' . $post_id;
-		}
-	}
-
-	make_jumpbox(generate_link($url . "&amp;action=$action&amp;mode=$mode", $forum_id . (($action == 'merge_select') ? $selected_ids : '')), false, 'm_');
-
-	$topics_per_page = ($forum_info['forum_topics_per_page']) ? $forum_info['forum_topics_per_page'] : $config['topics_per_page'];
-
-	mcp_sorting('viewforum', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
-	$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
-	$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
-
-	$_CLASS['core_template']->assign_array(array(
-		'S_TOPIC_ICONS'			=> false,
-		'FORUM_NAME'			=> $forum_info['forum_name'],
-
-		'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
-		'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', 'TOPIC_UNAPPROVED'),
-
-		'S_CAN_DELETE'			=> $_CLASS['auth']->acl_get('m_delete', $forum_id),
-		'S_CAN_MOVE'			=> $_CLASS['auth']->acl_get('m_move', $forum_id),
-		'S_CAN_FORK'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
-		'S_CAN_LOCK'			=> $_CLASS['auth']->acl_get('m_lock', $forum_id),
-		'S_CAN_SYNC'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
-		'S_CAN_APPROVE'			=> $_CLASS['auth']->acl_get('m_approve', $forum_id),
-
-		'U_VIEW_FORUM'			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
-		'S_MCP_ACTION'			=> generate_link($url . "&amp;action=$action&amp;mode=$mode&amp;start=$start" . (($action == 'merge_select') ? $selected_ids : '')),
-
-		'PAGINATION'			=> generate_pagination($url . "&amp;action=$action&amp;mode=$mode" . (($action == 'merge_select') ? $selected_ids : ''), $forum_topics, $topics_per_page, $start),
-		'PAGE_NUMBER'			=> on_page($forum_topics, $topics_per_page, $start),
-		'TOTAL'					=> $forum_topics)
-	);
-
-	// Grab icons
-	$icons = obtain_icons();
-	
-	$topic_rows = array();
-
-	$sql = 'SELECT t.*
-		FROM ' . FORUMS_TOPICS_TABLE . " t
-		WHERE (t.forum_id = $forum_id OR t.forum_id = 0)
-			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
-			AND t.topic_type IN (" . POST_ANNOUNCE . ", " . POST_GLOBAL . ")
-			$limit_time_sql
-		ORDER BY $sort_order_sql";
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$topic_rows[] = $row;
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql = 'SELECT t.*
-		FROM ' . FORUMS_TOPICS_TABLE . " t
-		WHERE t.forum_id = $forum_id
-			" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . '
-			AND t.topic_type IN (' . POST_NORMAL . ', ' . POST_STICKY . ")
-			$limit_time_sql
-		ORDER BY t.topic_type DESC, $sort_order_sql";
-	$result = $_CLASS['core_db']->query_limit($sql, $topics_per_page, $start);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$topic_rows[] = $row;
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	foreach ($topic_rows as $row)
-	{
-		$topic_title = '';
-
-		if ($_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
-		{
-			$row['topic_replies'] = $row['topic_replies_real'];
-		}
-
-		if ($row['topic_status'] == ITEM_LOCKED)
-		{
-			$folder_img = 'folder_locked';
-			$folder_alt = 'VIEW_TOPIC_LOCKED';
-		}
-		else
-		{
-			if ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL)
-			{
-				$folder_img = 'folder_announce';
-				$folder_alt = 'VIEW_TOPIC_ANNOUNCEMENT';
-			}
-			else if ($row['topic_type'] == POST_STICKY)
-			{
-				$folder_img = 'folder_sticky';
-				$folder_alt = 'VIEW_TOPIC_STICKY';
-			}
-			else if ($row['topic_status'] == ITEM_MOVED)
-			{
-				$folder_img = 'folder_moved';
-				$folder_alt = 'VIEW_TOPIC_MOVED';
-			}
-			else
-			{
-				$folder_img = 'folder';
-				$folder_alt = 'NO_NEW_POSTS';
-			}
-		}
-
-		if ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL)
-		{
-			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'] . ' ';
-		}
-		else if ($row['topic_type'] == POST_STICKY)
-		{
-			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'] . ' ';
-		}
-		else if ($row['topic_status'] == ITEM_MOVED)
-		{
-			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'] . ' ';
-		}
-		else
-		{
-			$topic_type = '';
-		}
-
-		if (intval($row['poll_start']))
-		{
-			$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'] . ' ';
-		}
-
-		$topic_title = censor_text($row['topic_title']);
-			
-		$_CLASS['core_template']->assign_vars_array('topicrow', array(
-			'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;t={$row['topic_id']}&amp;mode=topic_view"),
-
-			'S_SELECT_TOPIC'	=> ($action == 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
-			'U_SELECT_TOPIC'	=> generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
-			'U_MCP_QUEUE'		=> generate_link($url . '&amp;i=queue&amp;mode=approve_details&amp;t=' . $row['topic_id'], false, false),
-			'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports"),
-
-			'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
-			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-			//'TOPIC_FOLDER_IMG_SRC'	=> $user->img($folder_img, $folder_alt, false, '', 'src'),
-
-			'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
-			'TOPIC_ICON_IMG_WIDTH'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['width'],
-			'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['height'],
-			
-			'TOPIC_TYPE'		=> $topic_type,
-			'TOPIC_TITLE'		=> $topic_title,
-			'REPLIES'			=> $row['topic_replies'],
-			'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
-			'TOPIC_ID'			=> $row['topic_id'],
-			'S_TOPIC_CHECKED'	=> ($topic_id_list && in_array($row['topic_id'], $topic_id_list)) ? 'checked="checked" ' : '',
-
-			'S_TOPIC_REPORTED'	=> ($row['topic_reported']),
-			'S_TOPIC_UNAPPROVED'=> !($row['topic_approved']),
-			'NEWEST_POST_IMG' => false
-		));
-	}
-	unset($topic_rows);
-}
-
-function mcp_resync_topics($topic_ids)
-{
-	global $_CLASS;
-
-	if (!($forum_id = check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_')))
-	{
-		return;
-	}
-
-	if (empty($topic_ids))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
-
-		return;
-	}
-
-	// Sync everything and perform extra checks separately
-	sync('topic_reported', 'topic_id', $topic_ids, false, true);
-	sync('topic_attachment', 'topic_id', $topic_ids, false, true);
-	sync('topic', 'topic_id', $topic_ids, true, false);
-
-	$sql = 'SELECT topic_id, forum_id, topic_title
-		FROM ' . FORUMS_TOPICS_TABLE . '
-		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
-	$result = $_CLASS['core_db']->query($sql);
-
-	// Log this action
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_TOPIC_RESYNC', $row['topic_title']);
-	}
-
-	$msg = (sizeof($topic_ids) == 1) ? $_CLASS['core_user']->lang['TOPIC_RESYNC_SUCCESS'] : $_CLASS['core_user']->lang['TOPICS_RESYNC_SUCCESS'];
-	$_CLASS['core_template']->assign('MESSAGE', $msg);
-
-	return;
-}
-
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_forum.php,v 1.3 2004/07/19 20:13:16 acydburn Exp $
+//
+// FILENAME  : mcp_forum.php
+// STARTED   : Thu Jul 08, 2004
+// COPYRIGHT : 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+//
+// TODO:
+//
+
+$_CLASS['core_user']->add_lang('viewforum');
+$forum_info = get_forum_data($forum_id, 'm_');
+
+if (empty($forum_info[$forum_id]))
+{
+	exit;
+}
+
+$forum_info = $forum_info[$forum_id];
+		
+if ($action === 'merge_select')
+{
+	// Fixes a "bug" that makes forum_view use the same ordering as topic_view
+	unset($_POST['sk'], $_POST['sd'], $_REQUEST['sk'], $_REQUEST['sd']);
+}
+
+$start = request_var('start', 0);
+$topic_id_list = request_var('topic_id_list', array(0));
+$post_id_list = request_var('post_id_list', array(0));
+$topic_id = request_var('t', 0);
+
+// Resync Topics
+if ($action == 'resync')
+{
+	$topic_ids = request_var('topic_id_list', array(0));
+
+	if (!sizeof($topic_ids))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
+	}
+	else
+	{
+		mcp_resync_topics($topic_ids);
+	}
+}
+
+$selected_ids = '';
+if (sizeof($post_id_list))
+{
+	foreach ($post_id_list as $num => $post_id)
+	{
+		$selected_ids .= '&amp;post_id_list[' . $num . ']=' . $post_id;
+	}
+}
+
+make_jumpbox(generate_link($url . "&amp;action=$action&amp;mode=$mode", $forum_id . (($action == 'merge_select') ? $selected_ids : '')), false, 'm_');
+
+$topics_per_page = ($forum_info['forum_topics_per_page']) ? $forum_info['forum_topics_per_page'] : $config['topics_per_page'];
+
+mcp_sorting('viewforum', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
+$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
+$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+
+$_CLASS['core_template']->assign_array(array(
+	'S_TOPIC_ICONS'			=> false,
+	'FORUM_NAME'			=> $forum_info['forum_name'],
+
+	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
+	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', 'TOPIC_UNAPPROVED'),
+
+	'S_CAN_DELETE'			=> $_CLASS['auth']->acl_get('m_delete', $forum_id),
+	'S_CAN_MOVE'			=> $_CLASS['auth']->acl_get('m_move', $forum_id),
+	'S_CAN_FORK'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
+	'S_CAN_LOCK'			=> $_CLASS['auth']->acl_get('m_lock', $forum_id),
+	'S_CAN_SYNC'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
+	'S_CAN_APPROVE'			=> $_CLASS['auth']->acl_get('m_approve', $forum_id),
+
+	'U_VIEW_FORUM'			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
+	'S_MCP_ACTION'			=> generate_link($url . "&amp;action=$action&amp;mode=$mode&amp;start=$start" . (($action == 'merge_select') ? $selected_ids : '')),
+
+	'PAGINATION'			=> generate_pagination($url . "&amp;action=$action&amp;mode=$mode" . (($action == 'merge_select') ? $selected_ids : ''), $forum_topics, $topics_per_page, $start),
+	'PAGE_NUMBER'			=> on_page($forum_topics, $topics_per_page, $start),
+	'TOTAL'					=> $forum_topics)
+);
+
+// Grab icons
+$icons = obtain_icons();
+
+$topic_rows = array();
+
+$sql = 'SELECT t.*
+	FROM ' . FORUMS_TOPICS_TABLE . " t
+	WHERE (t.forum_id = $forum_id OR t.forum_id = 0)
+		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
+		AND t.topic_type IN (" . POST_ANNOUNCE . ", " . POST_GLOBAL . ")
+		$limit_time_sql
+	ORDER BY $sort_order_sql";
+$result = $_CLASS['core_db']->query($sql);
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$topic_rows[] = $row;
+}
+$_CLASS['core_db']->free_result($result);
+
+$sql = 'SELECT t.*
+	FROM ' . FORUMS_TOPICS_TABLE . " t
+	WHERE t.forum_id = $forum_id
+		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . '
+		AND t.topic_type IN (' . POST_NORMAL . ', ' . POST_STICKY . ")
+		$limit_time_sql
+	ORDER BY t.topic_type DESC, $sort_order_sql";
+$result = $_CLASS['core_db']->query_limit($sql, $topics_per_page, $start);
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$topic_rows[] = $row;
+}
+$_CLASS['core_db']->free_result($result);
+
+foreach ($topic_rows as $row)
+{
+	$topic_title = '';
+
+	if ($_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
+	{
+		$row['topic_replies'] = $row['topic_replies_real'];
+	}
+
+	if ($row['topic_status'] == ITEM_LOCKED)
+	{
+		$folder_img = 'folder_locked';
+		$folder_alt = 'VIEW_TOPIC_LOCKED';
+	}
+	else
+	{
+		if ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL)
+		{
+			$folder_img = 'folder_announce';
+			$folder_alt = 'VIEW_TOPIC_ANNOUNCEMENT';
+		}
+		else if ($row['topic_type'] == POST_STICKY)
+		{
+			$folder_img = 'folder_sticky';
+			$folder_alt = 'VIEW_TOPIC_STICKY';
+		}
+		else if ($row['topic_status'] == ITEM_MOVED)
+		{
+			$folder_img = 'folder_moved';
+			$folder_alt = 'VIEW_TOPIC_MOVED';
+		}
+		else
+		{
+			$folder_img = 'folder';
+			$folder_alt = 'NO_NEW_POSTS';
+		}
+	}
+
+	if ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL)
+	{
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'] . ' ';
+	}
+	else if ($row['topic_type'] == POST_STICKY)
+	{
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'] . ' ';
+	}
+	else if ($row['topic_status'] == ITEM_MOVED)
+	{
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'] . ' ';
+	}
+	else
+	{
+		$topic_type = '';
+	}
+
+	if (intval($row['poll_start']))
+	{
+		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'] . ' ';
+	}
+
+	$topic_title = censor_text($row['topic_title']);
+		
+	$_CLASS['core_template']->assign_vars_array('topicrow', array(
+		'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;t={$row['topic_id']}&amp;mode=topic_view"),
+
+		'S_SELECT_TOPIC'	=> ($action == 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
+		'U_SELECT_TOPIC'	=> generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
+		'U_MCP_QUEUE'		=> generate_link($url . '&amp;i=queue&amp;mode=approve_details&amp;t=' . $row['topic_id'], false, false),
+		'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports"),
+
+		'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+		'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
+		//'TOPIC_FOLDER_IMG_SRC'	=> $user->img($folder_img, $folder_alt, false, '', 'src'),
+
+		'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
+		'TOPIC_ICON_IMG_WIDTH'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['width'],
+		'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['height'],
+		
+		'TOPIC_TYPE'		=> $topic_type,
+		'TOPIC_TITLE'		=> $topic_title,
+		'REPLIES'			=> $row['topic_replies'],
+		'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
+		'TOPIC_ID'			=> $row['topic_id'],
+		'S_TOPIC_CHECKED'	=> ($topic_id_list && in_array($row['topic_id'], $topic_id_list)) ? 'checked="checked" ' : '',
+
+		'S_TOPIC_REPORTED'	=> ($row['topic_reported']),
+		'S_TOPIC_UNAPPROVED'=> !($row['topic_approved']),
+		'NEWEST_POST_IMG' => false
+	));
+}
+unset($topic_rows);
+
+page_header();
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_forum.html');
+
+function mcp_resync_topics($topic_ids)
+{
+	global $_CLASS;
+
+	if (!($forum_id = check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_')))
+	{
+		return;
+	}
+
+	if (empty($topic_ids))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
+
+		return;
+	}
+
+	// Sync everything and perform extra checks separately
+	sync('topic_reported', 'topic_id', $topic_ids, false, true);
+	sync('topic_attachment', 'topic_id', $topic_ids, false, true);
+	sync('topic', 'topic_id', $topic_ids, true, false);
+
+	$sql = 'SELECT topic_id, forum_id, topic_title
+		FROM ' . FORUMS_TOPICS_TABLE . '
+		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	// Log this action
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_TOPIC_RESYNC', $row['topic_title']);
+	}
+
+	$msg = (sizeof($topic_ids) == 1) ? $_CLASS['core_user']->lang['TOPIC_RESYNC_SUCCESS'] : $_CLASS['core_user']->lang['TOPICS_RESYNC_SUCCESS'];
+	$_CLASS['core_template']->assign('MESSAGE', $msg);
+
+	return;
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_front.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,23 +1,33 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: mcp_front.php,v 1.3 2004/07/19 20:13:16 acydburn Exp $
 //
 // FILENAME  : mcp_front.php
 // STARTED   : Thu Jul 08, 2004
-// COPYRIGHT : ? 2004 phpBB Group
+// COPYRIGHT : 2004 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,15 +1,25 @@
 <?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
 
 // -------------------------------------------------------------
 //
@@ -17,258 +27,172 @@
 //
 // FILENAME  : mcp_main.php
 // STARTED   : Mon Sep 02, 2003
-// COPYRIGHT : ? 2003 phpBB Group
+// COPYRIGHT : 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
 // -------------------------------------------------------------
 
-class mcp_main extends module
+global $_CLASS;
+
+$action = request_var('action', '');
+$quickmod = request_var('quickmod', '');
+
+switch ($mode)
 {
-	function mcp_main($id, $mode, $url)
-	{
-		global $_CLASS, $site_file_root, $db;
-		
-		$action = request_var('action', '');
-		$quickmod = request_var('quickmod', '');
+	case 'lock':
+	case 'unlock':
+		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
 
-		if (is_array($action))
+		if (empty($topic_ids))
 		{
-			list($action, ) = each($action);
+			trigger_error('NO_TOPIC_SELECTED');
 		}
 
-		switch ($mode)
-		{
-			case 'lock':
-			case 'unlock':
-				$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-		
-				if (!sizeof($topic_ids))
-				{
-					trigger_error('NO_TOPIC_SELECTED');
-				}
+		lock_unlock($mode, $topic_ids);
+	break;
 
-				lock_unlock($mode, $topic_ids);
-				break;
+	case 'lock_post':
+	case 'unlock_post':
+		$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
 
-			case 'lock_post':
-			case 'unlock_post':
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
 
-				$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
-		
-				if (!sizeof($post_ids))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
+		lock_unlock($mode, $post_ids);
+	break;
 
-				lock_unlock($mode, $post_ids);
-				break;
-
-			case 'make_announce':
-			case 'make_sticky':
-			case 'make_global':
-			case 'make_normal':
-				
-				$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
+	case 'make_announce':
+	case 'make_sticky':
+	case 'make_global':
+	case 'make_normal':
 		
-				if (!sizeof($topic_ids))
-				{
-					trigger_error('NO_TOPIC_SELECTED');
-				}
+		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
 
-				change_topic_type($mode, $topic_ids);
-			
-				break;
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
 
-			case 'move':
-				$_CLASS['core_user']->add_lang('viewtopic');
+		change_topic_type($mode, $topic_ids);
+	break;
 
-				$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-		
-				if (!sizeof($topic_ids))
-				{
-					trigger_error('NO_TOPIC_SELECTED');
-				}
+	case 'move':
+		$_CLASS['core_user']->add_lang('viewtopic');
 
-				mcp_move_topic($topic_ids);
-			
-				break;
+		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
 
-			case 'fork':
-				$_CLASS['core_user']->add_lang('viewtopic');
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
 
-				$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-		
-				if (!sizeof($topic_ids))
-				{
-					trigger_error('NO_TOPIC_SELECTED');
-				}
+		mcp_move_topic($topic_ids);
+	break;
 
-				mcp_fork_topic($topic_ids);
-			
-				break;
+	case 'fork':
+		$_CLASS['core_user']->add_lang('viewtopic');
 
-			case 'delete_topic':
-				$_CLASS['core_user']->add_lang('viewtopic');
+		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
 
-				$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-		
-				if (!sizeof($topic_ids))
-				{
-					trigger_error('NO_TOPIC_SELECTED');
-				}
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
 
-				mcp_delete_topic($topic_ids);
-				break;
+		mcp_fork_topic($topic_ids);
+	break;
 
-			case 'delete_post':
-				$_CLASS['core_user']->add_lang('posting');
+	case 'delete_topic':
+		$_CLASS['core_user']->add_lang('viewtopic');
 
-				$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
-		
-				if (!sizeof($post_ids))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
+		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
 
-				mcp_delete_post($post_ids);
-				break;
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
 
-			case 'front':
-				require($site_file_root.'includes/forums/mcp/mcp_front.php');
+		mcp_delete_topic($topic_ids);
+	break;
 
-				mcp_front_view($id, $mode, $action, $url);
+	case 'delete_post':
+		$_CLASS['core_user']->add_lang('posting');
 
-				$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
-				break;
+		$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
 
-			case 'forum_view':
-				require($site_file_root.'includes/forums/mcp/mcp_forum.php');
-				
-				$_CLASS['core_user']->add_lang('viewforum');
-
-				$forum_id = request_var('f', 0);
-
-				$forum_info = get_forum_data($forum_id, 'm_');
-
-				if (!sizeof($forum_info))
-				{
-					$this->mcp_main('mcp', 'front', $url);
-					exit;
-				}
-
-				$forum_info = $forum_info[$forum_id];
-
-				mcp_forum_view($id, $mode, $action, $url, $forum_info);
-				
-				$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_forum.html');
-				break;
-
-			case 'topic_view':
-				require($site_file_root.'includes/forums/mcp/mcp_topic.php');
-				
-				mcp_topic_view($id, $mode, $action, $url);
-				
-				$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_topic.html');
-				break;
-				
-			case 'post_details':
-				require($site_file_root.'includes/forums/mcp/mcp_post.php');
-				
-				mcp_post_details($id, $mode, $action, $url);
-				
-				$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_post.html');
-				break;			
-
-			default:
-				trigger_error("Unknown mode: $mode");
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
 		}
-	}
 
-	function install()
-	{
-	}
+		mcp_delete_post($post_ids);
+	break;
 
-	function uninstall()
-	{
-	}
-
-	function module()
-	{
-		$details = array(
-			'name'			=> 'MCP - Main',
-			'description'	=> 'Front end for Moderator Control Panel', 
-			'filename'		=> 'main',
-			'version'		=> '0.1.0', 
-			'phpbbversion'	=> '2.2.0'
-		);
-		return $details;
-	}
+	default:
+		trigger_error("Unknown mode: $mode");
 }
 
-
-
-
 // Lock/Unlock Topic/Post
 function lock_unlock($mode, $ids)
 {
-	global $db, $_CLASS;
+	global $_CLASS;
 
-	if ($mode == 'lock' || $mode == 'unlock')
+	if ($mode === 'lock' || $mode === 'unlock')
 	{
-		$table = TOPICS_TABLE;
+		$table = FORUMS_TOPICS_TABLE;
 		$sql_id = 'topic_id';
 		$set_id = 'topic_status';
 		$l_prefix = 'TOPIC';
 	}
 	else
 	{
-		$table = POSTS_TABLE;
+		$table = FORUMS_POSTS_TABLE;
 		$sql_id = 'post_id';
 		$set_id = 'post_edit_locked';
 		$l_prefix = 'POST';
 	}
 	
-	if (!($forum_id = check_ids($ids, $table, $sql_id, 'm_lock')))
-	{
+	if (!check_ids($ids, $table, $sql_id, 'm_lock'))
+	{// redirect maybe
 		return;
 	}
-	
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$message = $_CLASS['core_user']->get_lang(strtoupper($mode) . '_' . $l_prefix . ((count($ids) === 1) ? '' : 'S'));
+
+	$hidden_fields = build_hidden_fields(array(
 		$sql_id . '_list'	=> $ids,
 		'mode'				=> $mode,
 		'redirect'			=> $redirect)
 	);
-	$success_msg = '';
 
-	if (confirm_box(true))
+	$success_msg = false;
+
+	if (display_confirmation($message, $hidden_fields))
 	{
 		$sql = "UPDATE $table
 			SET $set_id = " . (($mode == 'lock' || $mode == 'lock_post') ? ITEM_LOCKED : ITEM_UNLOCKED) . "
 			WHERE $sql_id IN (" . implode(', ', $ids) . ")";
-		$db->sql_query($sql);
+		$_CLASS['core_db']->query($sql);
 
-		$data = ($mode == 'lock' || $mode == 'unlock') ? get_topic_data($ids) : get_post_data($ids);
+		$data = ($mode === 'lock' || $mode === 'unlock') ? get_topic_data($ids) : get_post_data($ids);
 
 		foreach ($data as $id => $row)
 		{
-			add_log('mod', $forum_id, $row['topic_id'], 'LOG_' . strtoupper($mode), $row['topic_title']);
+			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_' . strtoupper($mode), $row['topic_title']);
 		}
-		
-		$success_msg = $l_prefix . ((sizeof($ids) == 1) ? '' : 'S') . '_' . (($mode == 'lock' || $mode == 'lock_post') ? 'LOCKED' : 'UNLOCKED') . '_SUCCESS';
+
+		$success_msg = $l_prefix . ((count($ids) === 1) ? '' : 'S') . '_' . (($mode == 'lock' || $mode == 'lock_post') ? 'LOCKED' : 'UNLOCKED') . '_SUCCESS';
 	}
-	else
-	{
-		confirm_box(false, strtoupper($mode) . '_' . $l_prefix . ((sizeof($ids) == 1) ? '' : 'S'), $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link($redirect);
 
 	if (!$success_msg)
 	{
-		url_redirect($redirect);
+		redirect($redirect);
 	}
 	else
 	{

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,498 +1,506 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_topic.php,v 1.4 2004/07/19 20:13:16 acydburn Exp $
-//
-// FILENAME  : mcp_topic.php
-// STARTED   : Thu Jul 08, 2004
-// COPYRIGHT : ? 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//
-// TODO:
-//
-
-function mcp_topic_view($id, $mode, $action, $url)
-{
-	global $config, $site_file_root, $_CLASS;
-
-	$_CLASS['core_user']->add_lang('viewtopic');
-
-	$topic_id = request_var('t', 0);
-	$topic_info = get_topic_data(array($topic_id));
-
-	if (!sizeof($topic_info))
-	{
-		trigger_error($_CLASS['core_user']->lang['TOPIC_NOT_EXIST']);
-	}
-
-	$topic_info = $topic_info[$topic_id];
-
-	// Set up some vars
-	$icon_id = request_var('icon', 0);
-	$subject = request_var('subject', '');
-	$start = request_var('start', 0);
-	$to_topic_id = request_var('to_topic_id', 0);
-	$to_forum_id = request_var('to_forum_id', 0);
-	$post_id_list = request_var('post_id_list', array(0));
-
-	// Split Topic?
-	if ($action == 'split_all' || $action == 'split_beyond')
-	{
-		split_topic($action, $topic_id, $to_forum_id, $subject);
-		$action = 'split';
-	}
-
-	// Merge Posts?
-	if ($action == 'merge_posts')
-	{
-		merge_posts($topic_id, $to_topic_id);
-		$action = 'merge';
-	}
-	
-	$topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
-
-	if ($action == 'split' && !$subject)
-	{
-		$subject = $topic_info['topic_title'];
-	}
-
-	// Jumpbox, sort selects and that kind of things
-	make_jumpbox($url . '&amp;mode=forum_view', $topic_info['forum_id'], false, 'm_');
-	$where_sql = ($action == 'reports') ? 'WHERE post_reported = 1 AND ' : 'WHERE';
-	mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $topic_info['forum_id'], $topic_id, $where_sql);
-
-	$forum_topics = ($total == -1) ? $topic_info['forum_topics'] : $total;
-	$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
-
-	if ($total == -1)
-	{
-		$total = $topic_info['topic_replies'] + 1;
-	}
-	$posts_per_page = max(0, request_var('posts_per_page', intval($config['posts_per_page'])));
-
-	$sql = 'SELECT u.username, u.user_colour, p.*
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
-		WHERE ' . (($action == 'reports') ? 'p.post_reported = 1 AND ' : '') . "
-			p.topic_id = {$topic_id}
-			AND p.poster_id = u.user_id
-		ORDER BY $sort_order_sql";
-	$result = $_CLASS['core_db']->query_limit($sql, $posts_per_page, $start);
-
-	$rowset = array();
-	$bbcode_bitfield = 0;
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$rowset[] = $row;
-		$bbcode_bitfield |= $row['bbcode_bitfield'];
-	}
-
-	if ($bbcode_bitfield)
-	{
-		require_once($site_file_root.'includes/forums/bbcode.php');
-		$bbcode = new bbcode($bbcode_bitfield);
-	}
-
-	foreach ($rowset as $i => $row)
-	{
-		$has_unapproved_posts = false;
-		$poster = ($row['poster_id'] != ANONYMOUS) ? $row['username'] : ((!$row['post_username']) ? $_CLASS['core_user']->lang['GUEST'] : $row['post_username']);
-		$poster = ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster;
-
-		$message = $row['post_text'];
-		$post_subject = ($row['post_subject'] != '') ? $row['post_subject'] : $topic_info['topic_title'];
-
-		// If the board has HTML off but the post has HTML
-		// on then we process it, else leave it alone
-		if (!$config['allow_html'] && $row['enable_html'])
-		{
-			$message = preg_replace('#(<)([\/]?.*?)(>)#is', '&lt;\\2&gt;', $message);
-		}
-
-		if ($row['bbcode_bitfield'])
-		{
-			$bbcode->bbcode_second_pass($message, $row['bbcode_uid'], $row['bbcode_bitfield']);
-		}
-
-		$message = smiley_text($message);
-		$message = str_replace("\n", '<br />', $message);
-
-		$checked = ($post_id_list && in_array(intval($row['post_id']), $post_id_list)) ? 'checked="checked" ' : '';
-		$s_checkbox = ($row['post_id'] == $topic_info['topic_first_post_id'] && $action == 'split') ? '&nbsp;' : '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" ' . $checked . '/>';
-
-		if (!$row['post_approved'])
-		{
-			$has_unapproved_posts = true;
-		}
-
-		$_CLASS['core_template']->assign_vars_array('postrow', array(
-			'POSTER_NAME'	=> $poster,
-			'POST_DATE'		=> $_CLASS['core_user']->format_date($row['post_time']),
-			'POST_SUBJECT'	=> $post_subject,
-			'MESSAGE'		=> $message,
-			'POST_ID'		=> $row['post_id'],
-
-			'MINI_POST_IMG' => ($row['post_time'] > $_CLASS['core_user']->data['user_last_visit'] && $_CLASS['core_user']->is_user) ? $_CLASS['core_user']->img('icon_post_new', $_CLASS['core_user']->lang['NEW_POST']) : $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
-			
-			'S_CHECKBOX'		=> $s_checkbox,
-			'S_POST_REPORTED'	=> ($row['post_reported']) ? true : false,
-			'S_POST_UNAPPROVED'	=> ($row['post_approved']) ? false : true,
-						
-			'U_POST_DETAILS'	=> generate_link("$url&amp;p={$row['post_id']}&amp;mode=post_details"),
-			'U_MCP_APPROVE'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id']))
-		);
-
-		unset($rowset[$i]);
-	}
-
-	// Display topic icons for split topic
-	$s_topic_icons = false;
-
-	if ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']))
-	{
-		require_once($site_file_root.'includes/forums/functions_posting.php');
-		$s_topic_icons = posting_gen_topic_icons('', $icon_id);
-
-		// Has the user selected a topic for merge?
-		if ($to_topic_id)
-		{
-			$to_topic_info = get_topic_data(array($to_topic_id), 'm_merge');
-			
-			if (!sizeof($to_topic_info))
-			{
-				$to_topic_id = 0;
-			}
-			else
-			{
-				$to_topic_info = $to_topic_info[$to_topic_id];
-			}
-			
-
-			if (!$to_topic_info['enable_icons'])
-			{
-				$s_topic_icons = false;
-			}
-		}
-	}
-
-	$_CLASS['core_template']->assign(array(
-		'TOPIC_TITLE'		=> $topic_info['topic_title'],
-		'U_VIEWTOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $topic_info['forum_id'] . '&amp;t=' . $topic_info['topic_id']),
-
-		'TO_TOPIC_ID'		=> $to_topic_id,
-		'TO_TOPIC_INFO'		=> ($to_topic_id) ? sprintf($_CLASS['core_user']->lang['YOU_SELECTED_TOPIC'], $to_topic_id, '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_topic_info['forum_id'] . '&amp;t=' . $to_topic_id) . '" target="_new">' . $to_topic_info['topic_title'] . '</a>') : '',
-
-		'SPLIT_SUBJECT'		=> $subject,
-		'POSTS_PER_PAGE'	=> $posts_per_page,
-		'MODE'				=> $mode,
-
-		'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED', false, true),
-		'UNAPPROVED_IMG'	=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED', false, true),
-
-		'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode&amp;action=$action&amp;start=$start"),
-		'S_FORUM_SELECT'	=> '<select name="to_forum_id">' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '</select>',
-		'S_CAN_SPLIT'		=> ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']) && $action != 'merge') ? true : false,
-		'S_CAN_MERGE'		=> ($_CLASS['auth']->acl_get('m_merge', $topic_info['forum_id']) && $action != 'split') ? true : false,
-		'S_CAN_DELETE'		=> ($_CLASS['auth']->acl_get('m_delete', $topic_info['forum_id'])) ? true : false,
-		'S_CAN_APPROVE'		=> ($has_unapproved_posts && $_CLASS['auth']->acl_get('m_approve', $topic_info['forum_id'])) ? true : false,
-		'S_CAN_LOCK'		=> ($_CLASS['auth']->acl_get('m_lock', $topic_info['forum_id'])) ? true : false,
-		'S_REPORT_VIEW'		=> ($action == 'reports') ? true : false,
-
-		'S_SHOW_TOPIC_ICONS'=> $s_topic_icons,
-		'S_TOPIC_ICON'		=> $icon_id,
-
-		'RETURN_TOPIC'		=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f={$topic_info['forum_id']}&amp;t={$topic_info['topic_id']}&amp;start=$start.").'">', '</a>'),
-		'RETURN_FORUM'		=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$topic_info['forum_id']}&amp;start=$start").'">', '</a>'),
-
-		'PAGE_NUMBER'		=> on_page($total, $posts_per_page, $start),
-		'PAGINATION'		=> (!$posts_per_page) ? '' : generate_pagination('Forums&amp;file=mcp&amp;t=' . $topic_info['topic_id'] . "&amp;mode=$mode&amp;action=$action&amp;to_topic_id=$to_topic_id&amp;posts_per_page=$posts_per_page&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir", $total, $posts_per_page, $start),
-		'TOTAL'				=> $total)
-	);
-}
-
-function split_topic($mode, $topic_id, $to_forum_id, $subject)
-{
-	global $_CLASS ;
-
-	$post_id_list   = request_var('post_id_list', array(0));
-	$start			= request_var('start', 0);
-		
-	if (!sizeof($post_id_list))
-	{
-		trigger_error('NO_POST_SELECTED');
-	}
-	
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_split')))
-	{
-		return;
-	}
-
-	$post_id = $post_id_list[0];
-	$post_info = get_post_data(array($post_id));
-
-	if (!sizeof($post_info))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_POST_SELECTED']);
-		return;
-	}
-
-	$post_info = $post_info[$post_id];
-	$subject = trim($subject);
-
-	// Make some tests
-	if (!$subject)
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['EMPTY_SUBJECT']);
-		return;
-	}
-
-	if ($to_forum_id <= 0)
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_DESTINATION_FORUM']);
-		return;
-	}
-
-	$forum_info = get_forum_data(array($to_forum_id), 'm_split');
-
-	if (!sizeof($forum_info))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NOT_MODERATOR']);
-		return;
-	}
-
-	$forum_info = $forum_info[$to_forum_id];
-
-	if ($forum_info['forum_type'] != FORUM_POST)
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE']);
-		return;
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
-		'mode'			=> 'topic_view',
-		'start'			=> $start,
-		'action'		=> $mode,
-		't'				=> $topic_id,
-		'redirect'		=> $redirect,
-		'subject'		=> $subject,
-		'to_forum_id'	=> $to_forum_id,
-		'icon'			=> request_var('icon', 0))
-	);
-	$success_msg = $return_link = '';
-
-	if (confirm_box(true))
-	{
-		if ($mode == 'split_beyond')
-		{
-			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
-			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
-
-			if ($sort_order_sql{0} == 'u')
-			{
-				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
-					FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . " u
-					WHERE p.topic_id = $topic_id
-						AND p.poster_id = u.user_id
-						$limit_time_sql
-					ORDER BY $sort_order_sql";
-			}
-			else
-			{
-				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
-					FROM ' . POSTS_TABLE . " p
-					WHERE p.topic_id = $topic_id
-						$limit_time_sql
-					ORDER BY $sort_order_sql";
-			}
-			$result = $_CLASS['core_db']->query_limit($sql, 0, $start);
-
-			$store = false;
-			$post_id_list = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				// If splitted from selected post (split_beyond), we split the unapproved items too.
-				if (!$row['post_approved'] && !$_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
-				{
-//					continue;
-				}
-
-				// Start to store post_ids as soon as we see the first post that was selected
-				if ($row['post_id'] == $post_id)
-				{
-					$store = true;
-				}
-
-				if ($store)
-				{
-					$post_id_list[] = $row['post_id'];
-				}
-			}
-		}
-
-		if (!sizeof($post_id_list))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_POST_SELECTED']);
-		}
-
-		$icon_id = request_var('icon', 0);
-
-		$sql_ary = array(
-			'forum_id'		=> $to_forum_id,
-			'topic_title'	=> $subject,
-			'icon_id'		=> $icon_id,
-			'topic_approved'=> 1
-		);
-	
-		$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']->sql_query($sql);
-
-		$to_topic_id = $_CLASS['core_db']->sql_nextid();
-		move_posts($post_id_list, $to_topic_id);
-
-		// Change topic title of first post
-		$sql = 'UPDATE ' . POSTS_TABLE . " 
-			SET post_subject = '" . $_CLASS['core_db']->sql_escape($subject) . "'
-			WHERE post_id = {$post_id_list[0]}";
-		$_CLASS['core_db']->sql_query($sql);
-		
-		$success_msg = 'TOPIC_SPLIT_SUCCESS';
-
-		// Link back to both topics
-		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $post_info['forum_id'] . '&amp;t=' . $post_info['topic_id']) . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_forum_id . '&amp;t=' . $to_topic_id) . '">', '</a>');
-	}
-	else
-	{
-		confirm_box(false, ($mode == 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND', $s_hidden_fields);
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	/*if (strpos($redirect, '?') === false)
-	{
-		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
-	}*/
-
-	if (!$success_msg)
-	{
-		return;
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$to_forum_id&amp;t=$to_topic_id"));
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
-	}
-}
-
-// Merge selected posts into selected topic
-function merge_posts($topic_id, $to_topic_id)
-{
-	global $_CLASS;
-
-	if (!$to_topic_id)
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_FINAL_TOPIC_SELECTED']);
-		return;
-	}
-
-	$topic_data = get_topic_data(array($to_topic_id), 'm_merge');
-
-	if (!sizeof($topic_data))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_FINAL_TOPIC_SELECTED']);
-		return;
-	}
-
-	$topic_data = $topic_data[$to_topic_id];
-
-	$post_id_list	= request_var('post_id_list', array(0));
-	$start			= request_var('start', 0);
-		
-	if (!sizeof($post_id_list))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_POST_SELECTED']);
-		return;
-	}
-	
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_merge')))
-	{
-		return;
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'post_id_list'	=> $post_id_list,
-		'to_topic_id'	=> $to_topic_id,
-		'mode'			=> 'topic_view',
-		'action'		=> 'merge_posts',
-		'start'			=> $start,
-		'redirect'		=> $redirect,
-		'f'				=> $forum_id,
-		't'				=> $topic_id)
-	);
-	$success_msg = $return_link = '';
-
-	if (confirm_box(true))
-	{
-		$to_forum_id = $topic_data['forum_id'];
-
-		move_posts($post_id_list, $to_topic_id);
-		add_log('mod', $to_forum_id, $to_topic_id, 'LOG_MERGE', $topic_data['topic_title']);
-				
-		// Message and return links
-		$success_msg = 'POSTS_MERGED_SUCCESS';
-
-		// Does the original topic still exist? If yes, link back to it
-		$topic_data = get_topic_data(array($topic_id));
-
-		if (sizeof($topic_data))
-		{
-			$return_link .= sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $forum_id . '&amp;t=' . $topic_id) . '">', '</a>');
-		}
-
-		// Link to the new topic
-		$return_link .= (($return_link) ? '<br /><br />' : '') . sprintf($_CLASS['core_user']->lang['RETURN_NEW_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_forum_id . '&amp;t=' . $to_topic_id) . '">', '</a>');
-	}
-	else
-	{
-		confirm_box(false, 'MERGE_POSTS', $s_hidden_fields);
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	/*if (strpos($redirect, '?') === false)
-	{
-		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
-	}*/
-
-	if (!$success_msg)
-	{
-		return;
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$to_forum_id&amp;t=$to_topic_id"));
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
-	}
-}
-
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_topic.php,v 1.4 2004/07/19 20:13:16 acydburn Exp $
+//
+// FILENAME  : mcp_topic.php
+// STARTED   : Thu Jul 08, 2004
+// COPYRIGHT : 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+//
+// TODO:
+//
+
+$_CLASS['core_user']->add_lang('viewtopic');
+
+$topic_id = request_var('t', 0);
+$topic_info = get_topic_data(array($topic_id));
+
+if (empty($topic_info[$topic_id]))
+{
+	trigger_error('TOPIC_NOT_EXIST');
+}
+
+$topic_info = $topic_info[$topic_id];
+
+// Set up some vars
+$icon_id = request_var('icon', 0);
+$subject = request_var('subject', '');
+$start = request_var('start', 0);
+$to_topic_id = request_var('to_topic_id', 0);
+$to_forum_id = request_var('to_forum_id', 0);
+$post_id_list = request_var('post_id_list', array(0));
+
+// Split Topic?
+if ($action == 'split_all' || $action == 'split_beyond')
+{
+	split_topic($action, $topic_id, $to_forum_id, $subject);
+	$action = 'split';
+}
+
+// Merge Posts?
+if ($action == 'merge_posts')
+{
+	merge_posts($topic_id, $to_topic_id);
+	$action = 'merge';
+}
+
+$topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
+
+if ($action == 'split' && !$subject)
+{
+	$subject = $topic_info['topic_title'];
+}
+
+// Jumpbox, sort selects and that kind of things
+make_jumpbox($url . '&amp;mode=forum_view', $topic_info['forum_id'], false, 'm_');
+$where_sql = ($action == 'reports') ? 'WHERE post_reported = 1 AND ' : 'WHERE';
+mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $topic_info['forum_id'], $topic_id, $where_sql);
+
+$forum_topics = ($total == -1) ? $topic_info['forum_topics'] : $total;
+$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+
+if ($total == -1)
+{
+	$total = $topic_info['topic_replies'] + 1;
+}
+$posts_per_page = max(0, request_var('posts_per_page', intval($config['posts_per_page'])));
+
+$sql = 'SELECT u.username, u.user_colour, p.*
+	FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+	WHERE ' . (($action == 'reports') ? 'p.post_reported = 1 AND ' : '') . "
+		p.topic_id = {$topic_id}
+		AND p.poster_id = u.user_id
+	ORDER BY $sort_order_sql";
+$result = $_CLASS['core_db']->query_limit($sql, $posts_per_page, $start);
+
+$rowset = array();
+$bbcode_bitfield = 0;
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$rowset[] = $row;
+	$bbcode_bitfield |= $row['bbcode_bitfield'];
+}
+
+if ($bbcode_bitfield)
+{
+	require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+	$bbcode = new bbcode($bbcode_bitfield);
+}
+
+foreach ($rowset as $i => $row)
+{
+	$has_unapproved_posts = false;
+	$poster = ($row['poster_id'] != ANONYMOUS) ? $row['username'] : ((!$row['post_username']) ? $_CLASS['core_user']->lang['GUEST'] : $row['post_username']);
+	$poster = ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster;
+
+	$message = $row['post_text'];
+	$post_subject = ($row['post_subject'] != '') ? $row['post_subject'] : $topic_info['topic_title'];
+
+	// If the board has HTML off but the post has HTML
+	// on then we process it, else leave it alone
+	if (!$config['allow_html'] && $row['enable_html'])
+	{
+		$message = preg_replace('#(<)([\/]?.*?)(>)#is', '&lt;\\2&gt;', $message);
+	}
+
+	if ($row['bbcode_bitfield'])
+	{
+		$bbcode->bbcode_second_pass($message, $row['bbcode_uid'], $row['bbcode_bitfield']);
+	}
+
+	$message = smiley_text($message);
+	$message = str_replace("\n", '<br />', $message);
+
+	$checked = ($post_id_list && in_array(intval($row['post_id']), $post_id_list)) ? 'checked="checked" ' : '';
+	$s_checkbox = ($row['post_id'] == $topic_info['topic_first_post_id'] && $action == 'split') ? '&nbsp;' : '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" ' . $checked . '/>';
+
+	if (!$row['post_approved'])
+	{
+		$has_unapproved_posts = true;
+	}
+
+	$_CLASS['core_template']->assign_vars_array('postrow', array(
+		'POSTER_NAME'	=> $poster,
+		'POST_DATE'		=> $_CLASS['core_user']->format_date($row['post_time']),
+		'POST_SUBJECT'	=> $post_subject,
+		'MESSAGE'		=> $message,
+		'POST_ID'		=> $row['post_id'],
+
+		'MINI_POST_IMG' => ($row['post_time'] > $_CLASS['core_user']->data['user_last_visit'] && $_CLASS['core_user']->is_user) ? $_CLASS['core_user']->img('icon_post_new', $_CLASS['core_user']->lang['NEW_POST']) : $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
+		
+		'S_CHECKBOX'		=> $s_checkbox,
+		'S_POST_REPORTED'	=> ($row['post_reported']) ? true : false,
+		'S_POST_UNAPPROVED'	=> ($row['post_approved']) ? false : true,
+					
+		'U_POST_DETAILS'	=> generate_link("$url&amp;p={$row['post_id']}&amp;mode=post_details"),
+		'U_MCP_APPROVE'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id']))
+	);
+
+	unset($rowset[$i]);
+}
+
+// Display topic icons for split topic
+$s_topic_icons = false;
+
+if ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']))
+{
+	require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+	$s_topic_icons = posting_gen_topic_icons('', $icon_id);
+
+	// Has the user selected a topic for merge?
+	if ($to_topic_id)
+	{
+		$to_topic_info = get_topic_data(array($to_topic_id), 'm_merge');
+		
+		if (!sizeof($to_topic_info))
+		{
+			$to_topic_id = 0;
+		}
+		else
+		{
+			$to_topic_info = $to_topic_info[$to_topic_id];
+		}
+		
+
+		if (!$to_topic_info['enable_icons'])
+		{
+			$s_topic_icons = false;
+		}
+	}
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'TOPIC_TITLE'		=> $topic_info['topic_title'],
+	'U_VIEWTOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $topic_info['forum_id'] . '&amp;t=' . $topic_info['topic_id']),
+
+	'TO_TOPIC_ID'		=> $to_topic_id,
+	'TO_TOPIC_INFO'		=> ($to_topic_id) ? sprintf($_CLASS['core_user']->lang['YOU_SELECTED_TOPIC'], $to_topic_id, '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_topic_info['forum_id'] . '&amp;t=' . $to_topic_id) . '" target="_new">' . $to_topic_info['topic_title'] . '</a>') : '',
+
+	'SPLIT_SUBJECT'		=> $subject,
+	'POSTS_PER_PAGE'	=> $posts_per_page,
+	'MODE'				=> $mode,
+
+	'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED', false, true),
+	'UNAPPROVED_IMG'	=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED', false, true),
+
+	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode&amp;action=$action&amp;start=$start"),
+	'S_FORUM_SELECT'	=> '<select name="to_forum_id">' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '</select>',
+	'S_CAN_SPLIT'		=> ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']) && $action != 'merge') ? true : false,
+	'S_CAN_MERGE'		=> ($_CLASS['auth']->acl_get('m_merge', $topic_info['forum_id']) && $action != 'split') ? true : false,
+	'S_CAN_DELETE'		=> ($_CLASS['auth']->acl_get('m_delete', $topic_info['forum_id'])) ? true : false,
+	'S_CAN_APPROVE'		=> ($has_unapproved_posts && $_CLASS['auth']->acl_get('m_approve', $topic_info['forum_id'])) ? true : false,
+	'S_CAN_LOCK'		=> ($_CLASS['auth']->acl_get('m_lock', $topic_info['forum_id'])) ? true : false,
+	'S_REPORT_VIEW'		=> ($action == 'reports') ? true : false,
+
+	'S_SHOW_TOPIC_ICONS'=> $s_topic_icons,
+	'S_TOPIC_ICON'		=> $icon_id,
+
+	'RETURN_TOPIC'		=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f={$topic_info['forum_id']}&amp;t={$topic_info['topic_id']}&amp;start=$start.").'">', '</a>'),
+	'RETURN_FORUM'		=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$topic_info['forum_id']}&amp;start=$start").'">', '</a>'),
+
+	'PAGE_NUMBER'		=> on_page($total, $posts_per_page, $start),
+	'PAGINATION'		=> (!$posts_per_page) ? '' : generate_pagination('Forums&amp;file=mcp&amp;t=' . $topic_info['topic_id'] . "&amp;mode=$mode&amp;action=$action&amp;to_topic_id=$to_topic_id&amp;posts_per_page=$posts_per_page&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir", $total, $posts_per_page, $start),
+	'TOTAL'				=> $total)
+);
+
+page_header();
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_topic.html');
+
+function split_topic($mode, $topic_id, $to_forum_id, $subject)
+{
+	global $_CLASS ;
+
+	$post_id_list   = request_var('post_id_list', array(0));
+	$start			= request_var('start', 0);
+		
+	if (!sizeof($post_id_list))
+	{
+		trigger_error('NO_POST_SELECTED');
+	}
+	
+	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_split')))
+	{
+		return;
+	}
+
+	$post_id = $post_id_list[0];
+	$post_info = get_post_data(array($post_id));
+
+	if (!sizeof($post_info))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_POST_SELECTED']);
+		return;
+	}
+
+	$post_info = $post_info[$post_id];
+	$subject = trim($subject);
+
+	// Make some tests
+	if (!$subject)
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['EMPTY_SUBJECT']);
+		return;
+	}
+
+	if ($to_forum_id <= 0)
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_DESTINATION_FORUM']);
+		return;
+	}
+
+	$forum_info = get_forum_data(array($to_forum_id), 'm_split');
+
+	if (!sizeof($forum_info))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NOT_MODERATOR']);
+		return;
+	}
+
+	$forum_info = $forum_info[$to_forum_id];
+
+	if ($forum_info['forum_type'] != FORUM_POST)
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE']);
+		return;
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'post_id_list'	=> $post_id_list,
+		'f'				=> $forum_id,
+		'mode'			=> 'topic_view',
+		'start'			=> $start,
+		'action'		=> $mode,
+		't'				=> $topic_id,
+		'redirect'		=> $redirect,
+		'subject'		=> $subject,
+		'to_forum_id'	=> $to_forum_id,
+		'icon'			=> request_var('icon', 0))
+	);
+	$success_msg = $return_link = '';
+
+	if (confirm_box(true))
+	{
+		if ($mode == 'split_beyond')
+		{
+			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
+			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+
+			if ($sort_order_sql{0} == 'u')
+			{
+				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
+					FROM ' . POSTS_TABLE . ' p, ' . USERS_TABLE . " u
+					WHERE p.topic_id = $topic_id
+						AND p.poster_id = u.user_id
+						$limit_time_sql
+					ORDER BY $sort_order_sql";
+			}
+			else
+			{
+				$sql = 'SELECT p.post_id, p.forum_id, p.post_approved
+					FROM ' . POSTS_TABLE . " p
+					WHERE p.topic_id = $topic_id
+						$limit_time_sql
+					ORDER BY $sort_order_sql";
+			}
+			$result = $_CLASS['core_db']->query_limit($sql, 0, $start);
+
+			$store = false;
+			$post_id_list = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				// If splitted from selected post (split_beyond), we split the unapproved items too.
+				if (!$row['post_approved'] && !$_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
+				{
+//					continue;
+				}
+
+				// Start to store post_ids as soon as we see the first post that was selected
+				if ($row['post_id'] == $post_id)
+				{
+					$store = true;
+				}
+
+				if ($store)
+				{
+					$post_id_list[] = $row['post_id'];
+				}
+			}
+		}
+
+		if (!sizeof($post_id_list))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_POST_SELECTED']);
+		}
+
+		$icon_id = request_var('icon', 0);
+
+		$sql_ary = array(
+			'forum_id'		=> $to_forum_id,
+			'topic_title'	=> $subject,
+			'icon_id'		=> $icon_id,
+			'topic_approved'=> 1
+		);
+	
+		$sql = 'INSERT INTO ' . TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
+		$_CLASS['core_db']->sql_query($sql);
+
+		$to_topic_id = $_CLASS['core_db']->sql_nextid();
+		move_posts($post_id_list, $to_topic_id);
+
+		// Change topic title of first post
+		$sql = 'UPDATE ' . POSTS_TABLE . " 
+			SET post_subject = '" . $_CLASS['core_db']->sql_escape($subject) . "'
+			WHERE post_id = {$post_id_list[0]}";
+		$_CLASS['core_db']->sql_query($sql);
+		
+		$success_msg = 'TOPIC_SPLIT_SUCCESS';
+
+		// Link back to both topics
+		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $post_info['forum_id'] . '&amp;t=' . $post_info['topic_id']) . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_forum_id . '&amp;t=' . $to_topic_id) . '">', '</a>');
+	}
+	else
+	{
+		confirm_box(false, ($mode == 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND', $s_hidden_fields);
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	/*if (strpos($redirect, '?') === false)
+	{
+		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
+	}*/
+
+	if (!$success_msg)
+	{
+		return;
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$to_forum_id&amp;t=$to_topic_id"));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
+	}
+}
+
+// Merge selected posts into selected topic
+function merge_posts($topic_id, $to_topic_id)
+{
+	global $_CLASS;
+
+	if (!$to_topic_id)
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_FINAL_TOPIC_SELECTED']);
+		return;
+	}
+
+	$topic_data = get_topic_data(array($to_topic_id), 'm_merge');
+
+	if (!sizeof($topic_data))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_FINAL_TOPIC_SELECTED']);
+		return;
+	}
+
+	$topic_data = $topic_data[$to_topic_id];
+
+	$post_id_list	= request_var('post_id_list', array(0));
+	$start			= request_var('start', 0);
+		
+	if (!sizeof($post_id_list))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_POST_SELECTED']);
+		return;
+	}
+	
+	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_merge')))
+	{
+		return;
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'post_id_list'	=> $post_id_list,
+		'to_topic_id'	=> $to_topic_id,
+		'mode'			=> 'topic_view',
+		'action'		=> 'merge_posts',
+		'start'			=> $start,
+		'redirect'		=> $redirect,
+		'f'				=> $forum_id,
+		't'				=> $topic_id)
+	);
+	$success_msg = $return_link = '';
+
+	if (confirm_box(true))
+	{
+		$to_forum_id = $topic_data['forum_id'];
+
+		move_posts($post_id_list, $to_topic_id);
+		add_log('mod', $to_forum_id, $to_topic_id, 'LOG_MERGE', $topic_data['topic_title']);
+				
+		// Message and return links
+		$success_msg = 'POSTS_MERGED_SUCCESS';
+
+		// Does the original topic still exist? If yes, link back to it
+		$topic_data = get_topic_data(array($topic_id));
+
+		if (sizeof($topic_data))
+		{
+			$return_link .= sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $forum_id . '&amp;t=' . $topic_id) . '">', '</a>');
+		}
+
+		// Link to the new topic
+		$return_link .= (($return_link) ? '<br /><br />' : '') . sprintf($_CLASS['core_user']->lang['RETURN_NEW_TOPIC'], '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_forum_id . '&amp;t=' . $to_topic_id) . '">', '</a>');
+	}
+	else
+	{
+		confirm_box(false, 'MERGE_POSTS', $s_hidden_fields);
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	/*if (strpos($redirect, '?') === false)
+	{
+		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
+	}*/
+
+	if (!$success_msg)
+	{
+		return;
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$to_forum_id&amp;t=$to_topic_id"));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/mcp_forum.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_forum.html	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/templates/modules/Forums/mcp_forum.html	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
 <form method="post" name="mcp" action="{ $S_MCP_ACTION }"><table class="tablebg" width="100%" cellspacing="1">
@@ -62,4 +64,6 @@
 </table>
 </form>
 
-<!-- INCLUDE modules/Forums/mcp_footer.html -->
\ No newline at end of file
+<!-- INCLUDE modules/Forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/mcp_topic.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_topic.html	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/templates/modules/Forums/mcp_topic.html	2005-09-21 18:04:46 UTC (rev 139)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
 <form name="mcp" method="post" action="{ $S_MCP_ACTION }"><table class="tablebg" width="100%" cellspacing="1">
@@ -134,4 +136,6 @@
 	</tr>
 </table>
 
-<!-- INCLUDE modules/Forums/mcp_footer.html -->
\ No newline at end of file
+<!-- INCLUDE modules/Forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-21 18:04:46 UTC (rev 139)
@@ -206,7 +206,7 @@
 		<td align="left" valign="middle"><a href="{ $U_POST_NEW_TOPIC }">{ $POST_IMG }</a></td>
 		<td class="nav" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }</td>
 		<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]</td>
-		<td class="nav" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+		<td class="nav" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b>{ $L_GOTO_PAGE } { $PAGINATION }</b><!-- ENDIF --></td>
 	</tr>
 </table>
 

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-09-21 14:41:08 UTC (rev 138)
+++ cms/trunk/modules/Forums/mcp.php	2005-09-21 18:04:46 UTC (rev 139)
@@ -194,37 +194,9 @@
 		if (!class_exists($this->type . '_' . $this->name))
 		{
 			require($site_file_root."includes/forums/{$this->type}/{$this->type}_{$this->name}.php");
-
-			if ($run)
-			{
-				if (!isset($this->mode))
-				{
-					$this->mode = $mode;
-				}
-
-				eval("\$this->module = new {$this->type}_{$this->name}(\$this->id, \$this->mode, \$this->url);");
-				if (method_exists($this->module, 'init'))
-				{
-					$this->module->init();
-				}
-			}
 		}
 	}
 
-	// Displays the appropriate template with the given title
-	function display($page_title, $tpl_name)
-	{
-		global $_CLASS;
-
-		$_CLASS['core_display']->display_header($page_title);
-		
-		page_header();
-
-		$_CLASS['core_template']->display('modules/Forums/'.$tpl_name);
-
-		$_CLASS['core_display']->display_footer();
-	}
-
 	// Add Item to Submodule Title
 	function add_menu_item($module_name, $mode)
 	{
@@ -276,32 +248,6 @@
 			break;
 		}
 	}
-
-	// Public methods to be overwritten by modules
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-
-	function install()
-	{
-		return false;
-	}
-
-	function uninstall()
-	{
-		return false;
-	}
 }
 //
 // FUNCTIONS
@@ -325,36 +271,25 @@
 
 // Basic parameter data
 $mode	= request_var('mode', '');
-$mode2	= (isset($_REQUEST['quick'])) ? request_var('mode2', '') : '';
 $module = request_var('i', '');
 
-if (is_array($mode))
-{
-	list($mode, ) = each($mode);
-}
-
-if ($mode2)
-{
-	$mode = $mode2;
-	$action = '';
-	unset($mode2);
-}
-
 // Make sure we are using the correct module
 if ($mode == 'approve' || $mode == 'disapprove')
 {
 	$module = 'queue';
 }
 
-$quickmod = (isset($_REQUEST['quickmod'])) ? true : false;
+$quickmod = isset($_REQUEST['quickmod']);
 $action = request_var('action', '');
+/*
 $action_ary = request_var('action', array('' => 0));
 
-if (sizeof($action_ary))
+if (!empty($action_ary))
 {
 	list($action, ) = each($action);
 }
 unset($action_ary);
+*/
 
 if ($action == 'merge_select')
 {
@@ -379,10 +314,15 @@
 
 if (!$quickmod)
 {
-	$post_id = request_var('p', 0);
-	$topic_id = request_var('t', 0);
-	$forum_id = request_var('f', 0);
-	
+	$post_id = get_variable('p', 'REQUEST', false, 'int');
+	$topic_id = get_variable('t', 'REQUEST', false, 'int');
+	$forum_id = get_variable('f', 'REQUEST', false, 'int');
+
+	$url = 'Forums&amp;file=mcp';
+	$url .= ($post_id) ? "&amp;p=$post_id" : '';
+	$url .= ($topic_id) ? "&amp;t=$topic_id" : '';
+	$url .= ($forum_id) ? "&amp;f=$forum_id" : '';
+
 	if ($post_id)
 	{
 		// We determine the topic and forum id here, to make sure the moderator really has moderative rights on this post
@@ -396,8 +336,7 @@
 		$topic_id = (int) $row['topic_id'];
 		$forum_id = (int) $row['forum_id'];
 	}
-
-	if ($topic_id && !$forum_id)
+	elseif ($topic_id)
 	{
 		$sql = 'SELECT forum_id
 			FROM ' . FORUMS_TOPICS_TABLE . "
@@ -409,12 +348,16 @@
 		$forum_id = (int) $row['forum_id'];
 	}
 
-	// If we do not have a forum id and the user is not a super moderator (global options are set to false, even if the user is able to moderator at least one forum
+	if ($forum_id && !$_CLASS['auth']->acl_get('m_', $forum_id))
+	{
+		trigger_error('MODULE_NOT_EXIST');
+	}
+
 	if (!$forum_id && !$_CLASS['auth']->acl_get('m_'))
 	{
 		$forum_list = get_forum_list('m_');
 
-		if (!sizeof($forum_list))
+		if (empty($forum_list))
 		{
 			trigger_error('MODULE_NOT_EXIST');
 		}
@@ -422,13 +365,40 @@
 		// We do not check all forums, only the first one should be sufficiant.
 		$forum_id = $forum_list[0];
 	}
-	
+
+// remove
 	// Instantiate module system and generate list of available modules
-	$mcp->create('mcp', 'Forums&amp;file=mcp', $post_id, $topic_id, $forum_id, $module, $mode);
+	$mcp->create('mcp', 'Forums&amp;file=mcp', $post_id, $topic_id, $forum_id, $module);
 
-	// Load and execute the relevant module
-	$mcp->load('mcp', false, $mode);
-	exit;
+	switch ($mode)
+	{
+		case 'front':
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
+		break;
+
+		case 'forum_view':
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_forum.php');
+		break;
+		
+		case 'topic_view':
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+		break;
+			
+		case 'post_details':
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_post.php');
+			
+			mcp_post_details($id, $mode, $action, $url);
+			
+			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_post.html');
+		break;
+
+		default:
+			require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+		break;
+	}
+
+	script_close(false);
 }
 
 switch ($mode)
@@ -437,26 +407,24 @@
 	case 'unlock':
 	case 'lock_post':
 	case 'unlock_post':
-		$mcp->load('mcp', 'main', $mode);
-		break;
 	case 'make_sticky':
 	case 'make_announce':
 	case 'make_global':
 	case 'make_normal':
-		$mcp->load('mcp', 'main', $mode);
-		break;
 	case 'fork':
 	case 'move':
-		$mcp->load('mcp', 'main', $mode);
-		break;
 	case 'delete_post':
 	case 'delete_topic':
-		$mcp->load('mcp', 'main', $mode);
-		break;
+		require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+	break;
+
 	default:
 		trigger_error("$mode not allowed as quickmod");
+	break;
 }
 
+script_close(false);
+
 // Build simple hidden fields from array
 function build_hidden_fields($field_ary)
 {
@@ -484,9 +452,8 @@
 function get_topic_data($topic_ids, $acl_list = false)
 {
 	global $_CLASS;
-	$rowset = array();
 
-	if (implode(', ', $topic_ids) == '')
+	if (empty($topic_ids))
 	{
 		return array();
 	}
@@ -496,7 +463,9 @@
 			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON t.forum_id = f.forum_id
 		WHERE t.topic_id IN (' . implode(', ', $topic_ids) . ')';
 	$result = $_CLASS['core_db']->query($sql);
-		
+
+	$rowset = array();
+
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
@@ -726,53 +695,33 @@
 	}
 }
 
-/*
-	This needs to be redone
-*/
-
 function check_ids(&$ids, $table, $sql_id, $acl_list = false)
 {
 	global $_CLASS;
 
 	if (!is_array($ids) || !$ids)
 	{
-		return 0;
+		return false;
 	}
 
-	// a small logical error, since global announcement are assigned to forum_id == 0
-	// If the first topic id is a global announcement, we can force the forum. Though only global announcements can be
-	// tricked... i really do not know how to prevent this atm.
-
-	// With those two queries we make sure all ids are within one forum...
-	$sql = "SELECT forum_id FROM $table
-		WHERE $sql_id = {$ids[0]}";
+	$sql = "SELECT forum_id, $sql_id FROM $table
+		WHERE $sql_id IN (" . implode(', ', $ids) . ')';
 	$result = $_CLASS['core_db']->query($sql);
-	list($forum_id) = $_CLASS['core_db']->fetch_row_num($result);
-	$_CLASS['core_db']->free_result($result);
 
-	if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $forum_id))
-	{
-		trigger_error('NOT_AUTHORIZED');
-	}
-
-	if (!$forum_id)
-	{
-		trigger_error('Missing forum_id, has to be in url if global announcement...');
-	}
-
-	$sql = "SELECT $sql_id FROM $table
-		WHERE $sql_id IN (" . implode(', ', $ids) . ")
-			AND (forum_id = $forum_id OR forum_id = 0)";
-	$result = $_CLASS['core_db']->query($sql);
-
 	$ids = array();
+
+// Should make this better
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$ids[] = $row[$sql_id];
+		if (!$acl_list || $_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
+		{
+			$forum_ids[] = $row['forum_id'];
+			$ids[] = $row[$sql_id];
+		}
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	return (int) $forum_id;
+	return empty($ids) ? false : $forum_ids;
 }
 
 // LITTLE HELPER



From viperal at berlios.de  Thu Sep 22 01:23:14 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 22 Sep 2005 01:23:14 +0200
Subject: [Viperals-svncheckins] r140 - in cms/trunk: includes includes/forums includes/forums/mcp includes/templates/modules/Forums install modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Quick_Message modules/articles
Message-ID: <200509212323.j8LNNEf1014598@sheep.berlios.de>

Author: viperal
Date: 2005-09-22 01:22:59 +0200 (Thu, 22 Sep 2005)
New Revision: 140

Modified:
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_front.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/modules/Forums/mcp_forum.html
   cms/trunk/includes/templates/modules/Forums/mcp_front.html
   cms/trunk/includes/templates/modules/Forums/mcp_move.html
   cms/trunk/includes/templates/modules/Forums/mcp_topic.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/install/build_tables.php
   cms/trunk/modules/Control_Panel/index.php
   cms/trunk/modules/Control_Panel/ucp/ucp_main.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Quick_Message/ajax.php
   cms/trunk/modules/Quick_Message/functions.php
   cms/trunk/modules/Quick_Message/index.php
   cms/trunk/modules/articles/configurator.php
   cms/trunk/modules/articles/index.php
Log:


Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -329,9 +329,10 @@
 	}
 }
 
-function delete_topics($where_type, $where_ids, $auto_sync = TRUE)
+function delete_topics($where_type, $where_ids, $auto_sync = true)
 {
 	global $_CLASS;
+
 	$forum_ids = $topic_ids = array();
 
 	if (is_array($where_ids))
@@ -397,7 +398,7 @@
 	return $return;
 }
 
-function delete_posts($where_type, $where_ids, $auto_sync = TRUE)
+function delete_posts($where_type, $where_ids, $auto_sync = true)
 {
 	global $_CLASS;
 
@@ -1293,7 +1294,7 @@
 			// approved becomes unapproved, and vice-versa
 			if (!empty($approved_unapproved_ids))
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . '
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 					SET topic_approved = 1 - topic_approved
 					WHERE topic_id IN (' . implode(', ', $approved_unapproved_ids) . ')';
 				$_CLASS['core_db']->query($sql);
@@ -1324,7 +1325,7 @@
 				// This routine assumes that post_attachment values are correct
 				// if they are not, use sync('post_attachment') first
 				$sql = 'SELECT t.topic_id, p.post_id
-					FROM ' . TOPICS_TABLE . ' t, ' . POSTS_TABLE . " p
+					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_attachment = 1
 					GROUP BY t.topic_id";
@@ -1352,7 +1353,7 @@
 
 				if (!empty($sql))
 				{
-					$sql = 'UPDATE ' . TOPICS_TABLE . '
+					$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
 						SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . '
 						WHERE topic_id = ' . $topic_id;
 					$_CLASS['core_db']->query($sql);

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -346,17 +346,6 @@
 	return $active_forum_ary;
 }
 
-function topic_topic_author(&$topic_row)
-{
-	global $_CLASS;
-
-	$topic_author = ($topic_row['topic_poster'] != ANONYMOUS) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $topic_row['topic_poster']) . '">' : '';
-	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? $topic_row['topic_first_poster_name'] : (($topic_row['topic_first_poster_name'] != '') ? $topic_row['topic_first_poster_name'] : $_CLASS['core_user']->lang['GUEST']);
-	$topic_author .= ($topic_row['topic_poster'] != ANONYMOUS) ? '</a>' : '';
-
-	return $topic_author;
-}
-
 function topic_status(&$topic_row, $replies, $mark_time, &$folder_img, &$folder_alt, &$topic_type)
 {
 	global $_CLASS, $config;

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -33,10 +33,13 @@
 // 
 // -------------------------------------------------------------
 
-//
-// TODO:
-//
+$forum_id = get_variable('f', 'REQUEST', false, 'int');
 
+if (!$forum_id || !$_CLASS['auth']->acl_get('m_', $forum_id))
+{
+	trigger_error('MODULE_NOT_EXIST');
+}
+	
 $_CLASS['core_user']->add_lang('viewforum');
 $forum_info = get_forum_data($forum_id, 'm_');
 
@@ -46,6 +49,9 @@
 }
 
 $forum_info = $forum_info[$forum_id];
+
+$url = 'Forums&amp;file=mcp&amp;f='.$forum_id;
+$action = get_variable('action', 'REQUEST');
 		
 if ($action === 'merge_select')
 {
@@ -53,28 +59,27 @@
 	unset($_POST['sk'], $_POST['sd'], $_REQUEST['sk'], $_REQUEST['sd']);
 }
 
-$start = request_var('start', 0);
-$topic_id_list = request_var('topic_id_list', array(0));
-$post_id_list = request_var('post_id_list', array(0));
-$topic_id = request_var('t', 0);
+$start = get_variable('start', 'REQUEST', false, 'int');
+$topic_id_list = array_unique(request_var('topic_id_list', array(0)));
+$post_id_list = array_unique(request_var('post_id_list', array(0)));
+$topic_id = get_variable('t', 'REQUEST', false, 'int');;
 
 // Resync Topics
 if ($action == 'resync')
 {
-	$topic_ids = request_var('topic_id_list', array(0));
-
-	if (!sizeof($topic_ids))
+	if (empty($topic_id_list))
 	{
 		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_TOPIC_SELECTED']);
 	}
 	else
 	{
-		mcp_resync_topics($topic_ids);
+		mcp_resync_topics($topic_id_list);
 	}
 }
 
 $selected_ids = '';
-if (sizeof($post_id_list))
+
+if (!empty($post_id_list))
 {
 	foreach ($post_id_list as $num => $post_id)
 	{
@@ -87,9 +92,12 @@
 $topics_per_page = ($forum_info['forum_topics_per_page']) ? $forum_info['forum_topics_per_page'] : $config['topics_per_page'];
 
 mcp_sorting('viewforum', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
+
 $forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
 $limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
 
+$pagination = generate_pagination($url . "&amp;action=$action&amp;mode=$mode" . (($action == 'merge_select') ? $selected_ids : ''), $forum_topics, $topics_per_page, $start);
+
 $_CLASS['core_template']->assign_array(array(
 	'S_TOPIC_ICONS'			=> false,
 	'FORUM_NAME'			=> $forum_info['forum_name'],
@@ -105,14 +113,14 @@
 	'S_CAN_APPROVE'			=> $_CLASS['auth']->acl_get('m_approve', $forum_id),
 
 	'U_VIEW_FORUM'			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
-	'S_MCP_ACTION'			=> generate_link($url . "&amp;action=$action&amp;mode=$mode&amp;start=$start" . (($action == 'merge_select') ? $selected_ids : '')),
+	'S_MCP_ACTION'			=> generate_link($url . "&amp;mode=$mode&amp;start=$start" . (($action == 'merge_select') ? $selected_ids : '')),
 
-	'PAGINATION'			=> generate_pagination($url . "&amp;action=$action&amp;mode=$mode" . (($action == 'merge_select') ? $selected_ids : ''), $forum_topics, $topics_per_page, $start),
+	'PAGINATION'		=> $pagination['formated'],
+	'PAGINATION_ARRAY'	=> $pagination['array'],
 	'PAGE_NUMBER'			=> on_page($forum_topics, $topics_per_page, $start),
 	'TOTAL'					=> $forum_topics)
 );
 
-// Grab icons
 $icons = obtain_icons();
 
 $topic_rows = array();
@@ -210,7 +218,7 @@
 	$topic_title = censor_text($row['topic_title']);
 		
 	$_CLASS['core_template']->assign_vars_array('topicrow', array(
-		'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;f=$forum_id&amp;t={$row['topic_id']}&amp;mode=topic_view"),
+		'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;t={$row['topic_id']}&amp;mode=topic_view"),
 
 		'S_SELECT_TOPIC'	=> ($action == 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
 		'U_SELECT_TOPIC'	=> generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
@@ -221,7 +229,7 @@
 		'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 		//'TOPIC_FOLDER_IMG_SRC'	=> $user->img($folder_img, $folder_alt, false, '', 'src'),
 
-		'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
+		'TOPIC_ICON_IMG'		=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
 		'TOPIC_ICON_IMG_WIDTH'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['width'],
 		'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['height'],
 		
@@ -246,7 +254,7 @@
 {
 	global $_CLASS;
 
-	if (!($forum_id = check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_')))
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
 	{
 		return;
 	}
@@ -274,10 +282,9 @@
 		add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_TOPIC_RESYNC', $row['topic_title']);
 	}
 
-	$msg = (sizeof($topic_ids) == 1) ? $_CLASS['core_user']->lang['TOPIC_RESYNC_SUCCESS'] : $_CLASS['core_user']->lang['TOPICS_RESYNC_SUCCESS'];
+	$msg = (count($topic_ids) == 1) ? $_CLASS['core_user']->lang['TOPIC_RESYNC_SUCCESS'] : $_CLASS['core_user']->lang['TOPICS_RESYNC_SUCCESS'];
+
 	$_CLASS['core_template']->assign('MESSAGE', $msg);
-
-	return;
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_front.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/mcp/mcp_front.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -40,198 +40,185 @@
 //			those would be only valid from the time the log is valid (and not purged)
 //
 
-function mcp_front_view($id, $mode, $action, $url)
-{
-	global $_CLASS;
+$forum_id = get_variable('f', 'REQUEST', false, 'int');
 
-	// Latest 5 unapproved
-	$forum_list_all = get_forum_list('m_approve');
-	$post_list = array();
-	$forum_names = array();
+$url = 'Forums&amp;file=mcp';
 
-	$forum_id = request_var('f', 0);
-	
-	$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', !empty($forum_list_all));
+$forum_list_approve = get_forum_list('m_approve');
+$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', false);
 
-	if (!empty($forum_list_all))
-	{
-		$sql = 'SELECT COUNT(post_id) AS total
-			FROM ' . FORUMS_POSTS_TABLE . '
-			WHERE forum_id IN (0, ' . implode(', ', $forum_list_all) . ')
-				AND post_approved = 0';
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
+if (!empty($forum_list_approve))
+{
+	$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', true);
 
-		$total = isset($row['total']) ? (int) $row['total'] : false;;
+	$sql = 'SELECT post_id, forum_id
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE forum_id IN (0, ' . implode(', ', $forum_list_approve) . ')
+			AND post_approved = 0
+		ORDER BY post_id DESC';
+	$result = $_CLASS['core_db']->query_limit($sql, 5);
 
-		if ($total)
-		{
-			$sql = 'SELECT post_id, forum_id
-				FROM ' . FORUMS_POSTS_TABLE . '
-				WHERE forum_id IN (0, ' . implode(', ', $forum_list) . ')
-					AND post_approved = 0
-				ORDER BY post_id DESC';
-			$result = $_CLASS['core_db']->query_limit($sql, 5);
+	$forum_list = $post_list = array();
 
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$post_list[] = $row['post_id'];
-				$forum_list[] = $row['forum_id'];
-			}
-			unset($forum_list_all);
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$post_list[] = $row['post_id'];
+		$forum_list[] = $row['forum_id'];
+	}
+	$_CLASS['core_db']->free_result($result);
 
-			$sql = 'SELECT forum_id, forum_name
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id IN (' . implode(', ', $forum_list) . ')';
-			$result = $_CLASS['core_db']->query($sql);
-			
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$forum_names[$row['forum_id']] = $row['forum_name'];
-			}
-			$_CLASS['core_db']->free_result($result);
+	unset($forum_list_approve);
 
-			unset($forum_id);
+	if (!empty($forum_list))
+	{
+		$sql = 'SELECT forum_id, forum_name
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id IN (' . implode(', ', $forum_list) . ')';
+		$result = $_CLASS['core_db']->query($sql);
 
-			$sql = 'SELECT p.post_id, p.post_subject, p.post_time, p.poster_id, p.post_username, u.username, t.topic_id, t.topic_title, t.topic_first_post_id, p.forum_id
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t,  ' . USERS_TABLE . ' u
-				WHERE p.post_id IN (' . implode(', ', $post_list) . ')
-					AND t.topic_id = p.topic_id
-					AND p.poster_id = u.user_id
-				ORDER BY p.post_id DESC';
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$_CLASS['core_template']->assign_vars_array('unapproved', array(
-					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
-					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
-					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
-					'U_AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']),
-
-					'FORUM_NAME'	=> ($row['forum_id']) ? $forum_names[$row['forum_id']] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
-					'TOPIC_TITLE'	=> $row['topic_title'],
-					'AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? (($row['post_username']) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'],
-					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
-					'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']))
-				);				
-			}
-		}
-
-		if ($total)
+		$forum_names = array();
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$_CLASS['core_template']->assign_array(array(
-				'L_UNAPPROVED_TOTAL'		=> ($total == 1) ? $_CLASS['core_user']->lang['UNAPPROVED_POST_TOTAL'] : sprintf($_CLASS['core_user']->lang['UNAPPROVED_POSTS_TOTAL'], $total),
-				'S_HAS_UNAPPROVED_POSTS'	=> true
-			));
+			$forum_names[$row['forum_id']] = $row['forum_name'];
 		}
-		else
+		$_CLASS['core_db']->free_result($result);
+	
+		unset($forum_id);
+	
+		$sql = 'SELECT p.post_id, p.post_subject, p.post_time, p.poster_id, p.post_username, u.username, t.topic_id, t.topic_title, t.topic_first_post_id, p.forum_id
+			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t,  ' . USERS_TABLE . ' u
+			WHERE p.post_id IN (' . implode(', ', $post_list) . ')
+				AND t.topic_id = p.topic_id
+				AND p.poster_id = u.user_id
+			ORDER BY p.post_id DESC';
+		$result = $_CLASS['core_db']->query($sql);
+	
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$_CLASS['core_template']->assign_array(array(
-				'L_UNAPPROVED_TOTAL'		=> $_CLASS['core_user']->lang['UNAPPROVED_POSTS_ZERO_TOTAL'],
-				'S_HAS_UNAPPROVED_POSTS'	=> false
-			));
+			$_CLASS['core_template']->assign_vars_array('unapproved', array(
+				'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
+				'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
+				'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
+				'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+				'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
+				'U_AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']),
+
+				'FORUM_NAME'	=> ($row['forum_id']) ? $forum_names[$row['forum_id']] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
+				'TOPIC_TITLE'	=> $row['topic_title'],
+				'AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? (($row['post_username']) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'],
+				'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
+				'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']))
+			);				
 		}
+
+		$_CLASS['core_template']->assign_array(array(
+			'L_UNAPPROVED_TOTAL'		=> ($total == 1) ? $_CLASS['core_user']->lang['UNAPPROVED_POST_TOTAL'] : sprintf($_CLASS['core_user']->lang['UNAPPROVED_POSTS_TOTAL'], $total),
+			'S_HAS_UNAPPROVED_POSTS'	=> true
+		));
 	}
+	else
+	{
+		$_CLASS['core_template']->assign_array(array(
+			'L_UNAPPROVED_TOTAL'		=> $_CLASS['core_user']->lang['UNAPPROVED_POSTS_ZERO_TOTAL'],
+			'S_HAS_UNAPPROVED_POSTS'	=> false
+		));
+	}
+}
 
-	// Latest 5 reported
-	//$forum_list = get_forum_list('m_');
-				
-	$_CLASS['core_template']->assign('S_SHOW_REPORTS', !empty($forum_list));
+/*
+// Latest 5 reported
+$forum_list = get_forum_list('m_reports');
+$_CLASS['core_template']->assign('S_SHOW_REPORTS', !empty($forum_list));
 
-	if (!empty($forum_list))
+if (!empty($forum_list))
+{
+	$sql = 'SELECT COUNT(r.report_id) AS total
+		FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
+		WHERE r.post_id = p.post_id
+			AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$total = $row['total'];
+
+	if ($total)
 	{
-		$sql = 'SELECT COUNT(r.report_id) AS total
-			FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
+		$sql = 'SELECT r.*, p.post_id, p.post_subject, u.username, t.topic_id, t.topic_title, f.forum_id, f.forum_name
+			FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_REASONS_TABLE . ' rr,' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u
+			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
 			WHERE r.post_id = p.post_id
-				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$total = $row['total'];
+				AND r.reason_id = rr.reason_id
+				AND p.topic_id = t.topic_id
+				AND r.user_id = u.user_id
+				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')
+			ORDER BY p.post_id DESC';
+		$result = $_CLASS['core_db']->query_limit($sql, 5);
 
-		if ($total)
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$sql = 'SELECT r.*, p.post_id, p.post_subject, u.username, t.topic_id, t.topic_title, f.forum_id, f.forum_name
-				FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_REASONS_TABLE . ' rr,' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u
-				LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
-				WHERE r.post_id = p.post_id
-					AND r.reason_id = rr.reason_id
-					AND p.topic_id = t.topic_id
-					AND r.user_id = u.user_id
-					AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')
-				ORDER BY p.post_id DESC';
-			$result = $_CLASS['core_db']->query_limit($sql, 5);
+			$_CLASS['core_template']->assign_vars_array('report', array(
+				'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
+				'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
+				'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
+				'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+				'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
+				'U_REPORTER'	=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$_CLASS['core_template']->assign_vars_array('report', array(
-					'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
-					'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
-					'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-					'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-					'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
-					'U_REPORTER'	=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-
-					'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['POST_GLOBAL'],
-					'TOPIC_TITLE'	=> $row['topic_title'],
-					'REPORTER'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
-					'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
-					'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']))
-				);				
-			}
+				'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['POST_GLOBAL'],
+				'TOPIC_TITLE'	=> $row['topic_title'],
+				'REPORTER'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
+				'SUBJECT'		=> ($row['post_subject']) ? $row['post_subject'] : $_CLASS['core_user']->lang['NO_SUBJECT'],
+				'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']))
+			);				
 		}
-
-		if ($total == 0)
-		{
-			$_CLASS['core_template']->assign_array(array(
-				'L_REPORTS_TOTAL'	=>	$_CLASS['core_user']->lang['REPORTS_ZERO_TOTAL'],
-				'S_HAS_REPORTS'		=>	false)
-			);
-		}
-		else
-		{
-			$_CLASS['core_template']->assign_array(array(
-				'L_REPORTS_TOTAL'	=> ($total == 1) ? $_CLASS['core_user']->lang['REPORT_TOTAL'] : sprintf($_CLASS['core_user']->lang['REPORTS_TOTAL'], $total),
-				'S_HAS_REPORTS'		=> true)
-			);
-		}
 	}
 
-	// Latest 5 logs
-	$forum_list = get_forum_list(array('m_', 'a_general'));
-
-	if (!empty($forum_list))
+	if ($total == 0)
 	{
-		// Add forum_id 0 for global announcements
-		$forum_list[] = 0;
+		$_CLASS['core_template']->assign_array(array(
+			'L_REPORTS_TOTAL'	=>	$_CLASS['core_user']->lang['REPORTS_ZERO_TOTAL'],
+			'S_HAS_REPORTS'		=>	false)
+		);
+	}
+	else
+	{
+		$_CLASS['core_template']->assign_array(array(
+			'L_REPORTS_TOTAL'	=> ($total == 1) ? $_CLASS['core_user']->lang['REPORT_TOTAL'] : sprintf($_CLASS['core_user']->lang['REPORTS_TOTAL'], $total),
+			'S_HAS_REPORTS'		=> true)
+		);
+	}
+}
+*/
 
-		$log_count = 0;
-		$log = array();
-		view_log('mod', $log, $log_count, 5, 0, $forum_list);
+$forum_list_log = get_forum_list(array('m_', 'a_general'));
+// Add forum_id 0 for global announcements
+$forum_list_log[] = 0;
 
-		foreach ($log as $row)
-		{
-			$_CLASS['core_template']->assign_vars_array('log', array(
-				'USERNAME'		=> $row['username'],
-				'IP'			=> $row['ip'],
-				'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
-				'ACTION'		=> $row['action'],
-				'U_VIEWTOPIC'	=> $row['viewtopic'],
-				'U_VIEWLOGS'	=> $row['viewlogs'])
-			);
-		}
-	}
+$log_count = 0;
+$log = array();
 
-	$_CLASS['core_template']->assign_array(array(
-		'S_SHOW_LOGS'	=> !empty($forum_list),
-		'S_HAS_LOGS'	=> !empty($log)
-	));
+view_log('mod', $log, $log_count, 5, 0, $forum_list_log);
 
-	$_CLASS['core_template']->assign('S_MCP_ACTION', generate_link($url));
-	make_jumpbox(generate_link($url . '&amp;mode=forum_view'), 0, false, 'm_');
+foreach ($log as $row)
+{
+	$_CLASS['core_template']->assign_vars_array('log', array(
+		'USERNAME'		=> $row['username'],
+		'IP'			=> $row['ip'],
+		'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
+		'ACTION'		=> $row['action'],
+		'U_VIEWTOPIC'	=> $row['viewtopic'],
+		'U_VIEWLOGS'	=> $row['viewlogs']
+	));
 }
 
+$_CLASS['core_template']->assign_array(array(
+	'S_SHOW_LOGS'	=> true,
+	'S_HAS_LOGS'	=> !empty($log)
+));
+
+$_CLASS['core_template']->assign('S_MCP_ACTION', generate_link($url));
+make_jumpbox(generate_link($url . '&amp;mode=forum_view'), 0, false, 'm_');
+
+page_header();
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_front.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -1,4 +1,4 @@
-<?php
+<?php
 /*
 ||**************************************************************||
 ||  Viperal CMS ? :												||
@@ -19,843 +19,837 @@
 ||**************************************************************||
 
 $Id$
-*/
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_main.php,v 1.9 2004/07/10 22:47:42 acydburn Exp $
-//
-// FILENAME  : mcp_main.php
-// STARTED   : Mon Sep 02, 2003
-// COPYRIGHT : 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-global $_CLASS;
-
-$action = request_var('action', '');
-$quickmod = request_var('quickmod', '');
-
-switch ($mode)
-{
-	case 'lock':
-	case 'unlock':
-		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		lock_unlock($mode, $topic_ids);
-	break;
-
-	case 'lock_post':
-	case 'unlock_post':
-		$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		lock_unlock($mode, $post_ids);
-	break;
-
-	case 'make_announce':
-	case 'make_sticky':
-	case 'make_global':
-	case 'make_normal':
-		
-		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		change_topic_type($mode, $topic_ids);
-	break;
-
-	case 'move':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_move_topic($topic_ids);
-	break;
-
-	case 'fork':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_fork_topic($topic_ids);
-	break;
-
-	case 'delete_topic':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? request_var('topic_id_list', array(0)) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_delete_topic($topic_ids);
-	break;
-
-	case 'delete_post':
-		$_CLASS['core_user']->add_lang('posting');
-
-		$post_ids = (!$quickmod) ? request_var('post_id_list', array(0)) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		mcp_delete_post($post_ids);
-	break;
-
-	default:
-		trigger_error("Unknown mode: $mode");
-}
-
-// Lock/Unlock Topic/Post
-function lock_unlock($mode, $ids)
-{
-	global $_CLASS;
-
-	if ($mode === 'lock' || $mode === 'unlock')
-	{
-		$table = FORUMS_TOPICS_TABLE;
-		$sql_id = 'topic_id';
-		$set_id = 'topic_status';
-		$l_prefix = 'TOPIC';
-	}
-	else
-	{
-		$table = FORUMS_POSTS_TABLE;
-		$sql_id = 'post_id';
-		$set_id = 'post_edit_locked';
-		$l_prefix = 'POST';
-	}
-	
-	if (!check_ids($ids, $table, $sql_id, 'm_lock'))
-	{// redirect maybe
-		return;
-	}
-
-	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
-	$message = $_CLASS['core_user']->get_lang(strtoupper($mode) . '_' . $l_prefix . ((count($ids) === 1) ? '' : 'S'));
-
-	$hidden_fields = build_hidden_fields(array(
-		$sql_id . '_list'	=> $ids,
-		'mode'				=> $mode,
-		'redirect'			=> $redirect)
-	);
-
-	$success_msg = false;
-
-	if (display_confirmation($message, $hidden_fields))
-	{
-		$sql = "UPDATE $table
-			SET $set_id = " . (($mode == 'lock' || $mode == 'lock_post') ? ITEM_LOCKED : ITEM_UNLOCKED) . "
-			WHERE $sql_id IN (" . implode(', ', $ids) . ")";
-		$_CLASS['core_db']->query($sql);
-
-		$data = ($mode === 'lock' || $mode === 'unlock') ? get_topic_data($ids) : get_post_data($ids);
-
-		foreach ($data as $id => $row)
-		{
-			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_' . strtoupper($mode), $row['topic_title']);
-		}
-
-		$success_msg = $l_prefix . ((count($ids) === 1) ? '' : 'S') . '_' . (($mode == 'lock' || $mode == 'lock_post') ? 'LOCKED' : 'UNLOCKED') . '_SUCCESS';
-	}
-
-	$redirect = generate_link($redirect);
-
-	if (!$success_msg)
-	{
-		redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(2, $redirect);
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-	}
-}
-
-// Change Topic Type
-function change_topic_type($mode, $topic_ids)
-{
-	global $db, $_CLASS;
-
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
-	{
-		return;
-	}
-
-	switch ($mode)
-	{
-		case 'make_announce':
-			$new_topic_type = POST_ANNOUNCE;
-			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
-			break;
-		case 'make_global':
-			$new_topic_type = POST_GLOBAL;
-			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
-			break;
-		case 'make_sticky':
-			$new_topic_type = POST_STICKY;
-			$check_acl = 'f_sticky';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
-			break;
-		default:
-			$new_topic_type = POST_NORMAL;
-			$check_acl = '';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
-			break;
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'topic_id_list'	=> $topic_ids,
-		'f'				=> $forum_id,
-		'mode'			=> $mode,
-		'redirect'		=> $redirect)
-	);
-	$success_msg = '';
-
-	if (confirm_box(true))
-	{
-		if ($new_topic_type != POST_GLOBAL)
-		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . "
-				SET topic_type = $new_topic_type
-				WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
-					AND forum_id <> 0';
-			$db->sql_query($sql);
-
-			// Reset forum id if a global topic is within the array
-			if ($forum_id)
-			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . "
-					SET topic_type = $new_topic_type, forum_id = $forum_id
-						WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
-						AND forum_id = 0';
-				$db->sql_query($sql);
-			}
-		}
-		else
-		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . "
-				SET topic_type = $new_topic_type, forum_id = 0
-				WHERE topic_id IN (" . implode(', ', $topic_ids) . ")";
-			$db->sql_query($sql);
-		}
-
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
-
-		$data = get_topic_data($topic_ids);
-
-		foreach ($data as $topic_id => $row)
-		{
-			add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);
-		}
-	}
-	else
-	{
-		confirm_box(false, $l_new_type, $s_hidden_fields);
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(2, $redirect);
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-	}
-}
-
-// Move Topic
-function mcp_move_topic($topic_ids)
-{
-	global $db, $_CLASS;
-	
-	$_CLASS['core_template']->assign(array(
-		'L_SELECT_DESTINATION_FORUM'=> $_CLASS['core_user']->lang['SELECT_DESTINATION_FORUM'],
-		'L_LEAVE_SHADOW'			=> $_CLASS['core_user']->lang['LEAVE_SHADOW'])
-	);
-	
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_move')))
-	{
-		return;
-	}
-				
-	$to_forum_id = request_var('to_forum_id', 0);
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-	$additional_msg = $success_msg = '';
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'topic_id_list'	=> $topic_ids,
-		'f'				=> $forum_id,
-		'mode'			=> 'move',
-		'redirect'		=> $redirect)
-	);
-
-	if ($to_forum_id)
-	{
-		$forum_data = get_forum_data($to_forum_id);
-
-		if (!sizeof($forum_data))
-		{
-			$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_EXIST'];
-		}
-		else
-		{
-			$forum_data = $forum_data[$to_forum_id];
-	
-			if ($forum_data['forum_type'] != FORUM_POST)
-			{
-				$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE'];
-			}
-			else if (!$_CLASS['auth']->acl_get('f_post', $to_forum_id))
-			{
-				$additional_msg = $_CLASS['core_user']->lang['USER_CANNOT_POST'];
-			}
-			else if ($forum_id == $to_forum_id)
-			{
-				$additional_msg = $_CLASS['core_user']->lang['CANNOT_MOVE_SAME_FORUM'];
-			}
-		}
-	}
-
-	if (!$to_forum_id || $additional_msg)
-	{
-		unset($_POST['confirm']);
-	}
-	
-	if (confirm_box(true))
-	{
-		$topic_data = get_topic_data($topic_ids);
-		$leave_shadow = (isset($_POST['move_leave_shadow'])) ? true : false;
-
-		// Move topics, but do not resync yet
-		move_topics($topic_ids, $to_forum_id, false);
-
-		$forum_ids = array($to_forum_id);
-		foreach ($topic_data as $topic_id => $row)
-		{
-			// Get the list of forums to resync, add a log entry
-			$forum_ids[] = $row['forum_id'];
-			add_log('mod', $to_forum_id, $topic_id, 'LOG_MOVE', $row['forum_name']);
-
-			// Leave a redirection if required and only if the topic is visible to users
-			if ($leave_shadow && $row['topic_approved'])
-			{
-				$shadow = array(
-					'forum_id'				=>	(int) $row['forum_id'],
-					'icon_id'				=>	(int) $row['icon_id'],
-					'topic_attachment'		=>	(int) $row['topic_attachment'],
-					'topic_approved'		=>	1,
-					'topic_reported'		=>	(int) $row['topic_reported'],
-					'topic_title'			=>	(string) $row['topic_title'],
-					'topic_poster'			=>	(int) $row['topic_poster'],
-					'topic_time'			=>	(int) $row['topic_time'],
-					'topic_time_limit'		=>	(int) $row['topic_time_limit'],
-					'topic_views'			=>	(int) $row['topic_views'],
-					'topic_replies'			=>	(int) $row['topic_replies'],
-					'topic_replies_real'	=>	(int) $row['topic_replies_real'],
-					'topic_status'			=>	ITEM_MOVED,
-					'topic_type'			=>	(int) $row['topic_type'],
-					'topic_first_post_id'	=>	(int) $row['topic_first_post_id'],
-					'topic_first_poster_name'=>	(string) $row['topic_first_poster_name'],
-					'topic_last_post_id'	=>	(int) $row['topic_last_post_id'],
-					'topic_last_poster_id'	=>	(int) $row['topic_last_poster_id'],
-					'topic_last_poster_name'=>	(string) $row['topic_last_poster_name'],
-					'topic_last_post_time'	=>	(int) $row['topic_last_post_time'],
-					'topic_last_view_time'	=>	(int) $row['topic_last_view_time'],
-					'topic_moved_id'		=>	(int) $row['topic_id'],
-					'topic_bumped'			=>	(int) $row['topic_bumped'],
-					'topic_bumper'			=>	(int) $row['topic_bumper'],
-					'poll_title'			=>	(string) $row['poll_title'],
-					'poll_start'			=>	(int) $row['poll_start'],
-					'poll_length'			=>	(int) $row['poll_length'],
-					'poll_max_options'		=>	(int) $row['poll_max_options'],
-					'poll_last_vote'		=>	(int) $row['poll_last_vote']
-				);
-
-				$db->sql_query('INSERT INTO ' . TOPICS_TABLE . $db->sql_build_array('INSERT', $shadow));
-				
-				// $next_id = $db->sql_nextid();
-				// Mark Shadow topic read
-				// markread('topic', $row['forum_id'], $next_id);
-			}
-		}
-		unset($topic_data);
-
-		// Now sync forums
-		sync('forum', 'forum_id', $forum_ids);
-
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
-	}
-	else
-	{
-		$_CLASS['core_template']->assign(array(
-			'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, $forum_id, false, true, true),
-			'S_CAN_LEAVE_SHADOW'	=> true,
-			'ADDITIONAL_MSG'		=> $additional_msg)
-		);
-
-		page_header();
-		confirm_box(false, 'MOVE_TOPIC' . ((sizeof($topic_ids) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_move.html');
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, $redirect);
-
-		$message = $_CLASS['core_user']->lang[$success_msg];
-		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>');
-		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
-		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href='.generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id).'">', '</a>');
-		
-		trigger_error($message);
-	}
-}
-
-// Delete Topics
-function mcp_delete_topic($topic_ids)
-{
-	global $_CLASS, $db;
-
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_delete')))
-	{
-		return;
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'topic_id_list'	=> $topic_ids,
-		'f'				=> $forum_id,
-		'mode'			=> 'delete_topic',
-		'redirect'		=> $redirect)
-	);
-	$success_msg = '';
-
-	if (confirm_box(true))
-	{
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_DELETED_SUCCESS' : 'TOPICS_DELETED_SUCCESS';
-
-		$data = get_topic_data($topic_ids);
-
-		foreach ($data as $topic_id => $row)
-		{
-			add_log('mod', $forum_id, 0, 'LOG_TOPIC_DELETED', $row['topic_title']);
-		}
-
-		$return = delete_topics('topic_id', $topic_ids, true);
-
-		// TODO: Adjust total post count...
-	}
-	else
-	{
-		confirm_box(false, (sizeof($topic_ids) == 1) ? 'DELETE_TOPIC' : 'DELETE_TOPICS', $s_hidden_fields);
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id));
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
-	}
-}
-
-// Delete Posts
-function mcp_delete_post($post_ids)
-{
-	global $_CLASS, $db;
-
-	if (!($forum_id = check_ids($post_ids, POSTS_TABLE, 'post_id', 'm_delete')))
-	{
-		return;
-	}
-
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'post_id_list'	=> $post_ids,
-		'f'				=> $forum_id,
-		'mode'			=> 'delete_post',
-		'redirect'		=> $redirect)
-	);
-	$success_msg = '';
-
-	if (confirm_box(true))
-	{
-		// Count the number of topics that are affected
-		// I did not use COUNT(DISTINCT ...) because I remember having problems
-		// with it on older versions of MySQL -- Ashe
-
-		$sql = 'SELECT DISTINCT topic_id
-			FROM ' . POSTS_TABLE . '
-			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
-		$result = $db->sql_query($sql);
-
-		$topic_id_list = array();
-		while ($row = $db->sql_fetchrow($result))
-		{
-			$topic_id_list[] = $row['topic_id'];
-		}
-		$affected_topics = sizeof($topic_id_list);
-		$db->sql_freeresult($result);
-
-		$post_data = get_post_data($post_ids);
-
-		foreach ($post_data as $id => $row)
-		{
-			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_DELETE_POST', $row['post_subject']);
-		}
-
-		// Now delete the posts, topics and forums are automatically resync'ed
-		delete_posts('post_id', $post_ids);
-					
-		$sql = 'SELECT COUNT(topic_id) AS topics_left
-			FROM ' . TOPICS_TABLE . '
-			WHERE topic_id IN (' . implode(', ', $topic_id_list) . ')';
-		$result = $db->sql_query_limit($sql, 1);
-
-		$deleted_topics = ($row = $db->sql_fetchrow($result)) ? ($affected_topics - $row['topics_left']) : $affected_topics;
-		$db->sql_freeresult($result);
-
-		$topic_id = request_var('t', 0);
-
-		// Return links
-		$return_link = array();
-		if ($affected_topics == 1 && !$deleted_topics && $topic_id)
-		{
-			$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
-		}
-		$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
-
-		if (sizeof($post_ids) == 1)
-		{
-			if ($deleted_topics)
-			{
-				// We deleted the only post of a topic, which in turn has
-				// been removed from the database
-				$success_msg = $_CLASS['core_user']->lang['TOPIC_DELETED_SUCCESS'];
-			}
-			else
-			{
-				$success_msg = $_CLASS['core_user']->lang['POST_DELETED_SUCCESS'];
-			}
-		}
-		else
-		{
-			if ($deleted_topics)
-			{
-				// Some of topics disappeared
-				$success_msg = $_CLASS['core_user']->lang['POSTS_DELETED_SUCCESS'] . '<br /><br />' . $_CLASS['core_user']->lang['EMPTY_TOPICS_REMOVED_WARNING'];
-			}
-			else
-			{
-				$success_msg = $_CLASS['core_user']->lang['POSTS_DELETED_SUCCESS'];
-			}
-		}
-	}
-	else
-	{
-		confirm_box(false, (sizeof($post_ids) == 1) ? 'DELETE_POST' : 'DELETE_POSTS', $s_hidden_fields);
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, $redirect);
-		trigger_error($success_msg . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . implode('<br /><br />', $return_link));
-	}
-}
-
-// Fork Topic
-function mcp_fork_topic($topic_ids)
-{
-	global $db, $_CLASS, $config;
-
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
-	{
-		return;
-	}
-	
-	$to_forum_id = request_var('to_forum_id', 0);
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-	$additional_msg = $success_msg = '';
-
-	$s_hidden_fields = build_hidden_fields(array(
-		'topic_id_list'	=> $topic_ids,
-		'f'				=> $forum_id,
-		'mode'			=> 'fork',
-		'redirect'		=> $redirect)
-	);
-
-	if ($to_forum_id)
-	{
-		$forum_data = get_forum_data($to_forum_id);
-
-		if (!sizeof($topic_ids))
-		{
-			$additional_msg = $_CLASS['core_user']->lang['NO_TOPICS_SELECTED'];
-		}
-		else if (!sizeof($forum_data))
-		{
-			$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_EXIST'];
-		}
-		else
-		{
-			$forum_data = $forum_data[$to_forum_id];
-	
-			if ($forum_data['forum_type'] != FORUM_POST)
-			{
-				$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE'];
-			}
-			else if (!$_CLASS['auth']->acl_get('f_post', $to_forum_id))
-			{
-				$additional_msg = $_CLASS['core_user']->lang['USER_CANNOT_POST'];
-			}
-		}
-	}
-
-	if (!$to_forum_id || $additional_msg)
-	{
-		unset($_POST['confirm']);
-	}
-	
-	if (confirm_box(true))
-	{
-		$topic_data = get_topic_data($topic_ids);
-		
-		$total_posts = 0;
-		$new_topic_id_list = array();
-		foreach ($topic_data as $topic_id => $topic_row)
-		{
-			$sql_ary = array(
-				'forum_id'					=> (int) $to_forum_id,
-				'icon_id'					=> (int) $topic_row['icon_id'],
-				'topic_attachment'			=> (int) $topic_row['topic_attachment'],
-				'topic_approved'			=> 1,
-				'topic_reported'			=> 0,
-				'topic_title'				=> (string) $topic_row['topic_title'],
-				'topic_poster'				=> (int) $topic_row['topic_poster'],
-				'topic_time'				=> (int) $topic_row['topic_time'],
-				'topic_replies'				=> (int) $topic_row['topic_replies_real'],
-				'topic_replies_real'		=> (int) $topic_row['topic_replies_real'],
-				'topic_status'				=> (int) $topic_row['topic_status'],
-				'topic_type'				=> (int) $topic_row['topic_type'],
-				'topic_first_poster_name'	=> (string) $topic_row['topic_first_poster_name'],
-				'topic_last_poster_id'		=> (int) $topic_row['topic_last_poster_id'],
-				'topic_last_poster_name'	=> (string) $topic_row['topic_last_poster_name'],
-				'topic_last_post_time'		=> (int) $topic_row['topic_last_post_time'],
-				'topic_last_view_time'		=> (int) $topic_row['topic_last_view_time'],
-				'topic_bumped'				=> (int) $topic_row['topic_bumped'],
-				'topic_bumper'				=> (int) $topic_row['topic_bumper'],
-				'poll_title'				=> (string) $topic_row['poll_title'],
-				'poll_start'				=> (int) $topic_row['poll_start'],
-				'poll_length'				=> (int) $topic_row['poll_length']
-			);
-
-			$db->sql_query('INSERT INTO ' . TOPICS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
-			$new_topic_id = $db->sql_nextid();
-			$new_topic_id_list[$topic_id] = $new_topic_id;
-
-			markread('topic', $to_forum_id, $new_topic_id);
-
-			if ($topic_row['poll_start'])
-			{
-				$poll_rows = array();
-
-				$sql = 'SELECT * 
-					FROM ' . POLL_OPTIONS_TABLE . " 
-					WHERE topic_id = $topic_id";
-				$result = $db->sql_query($sql);
-
-				while ($row = $db->sql_fetchrow($result))
-				{
-					$sql = 'INSERT INTO ' . POLL_OPTIONS_TABLE . ' (poll_option_id, topic_id, poll_option_text, poll_option_total)
-						VALUES (' . $row['poll_option_id'] . ', ' . $new_topic_id . ", '" . $db->sql_escape($row['poll_option_text']) . "', 0)";
-					$db->sql_query($sql);
-				}
-			}
-
-			$sql = 'SELECT *
-				FROM ' . POSTS_TABLE . "
-				WHERE topic_id = $topic_id
-				ORDER BY post_id ASC";
-			$result = $db->sql_query($sql);
-	
-			$post_rows = array();
-			while ($row = $db->sql_fetchrow($result))
-			{
-				$post_rows[] = $row;
-			}
-			$db->sql_freeresult();
-
-			if (!sizeof($post_rows))
-			{
-				continue;
-			}
-
-			$total_posts += sizeof($post_rows);
-			foreach ($post_rows as $row)
-			{
-				$sql_ary = array(
-					'topic_id'			=> (int) $new_topic_id,
-					'forum_id'			=> (int) $to_forum_id,
-					'poster_id'			=> (int) $row['poster_id'],
-					'icon_id'			=> (int) $row['icon_id'],
-					'poster_ip'			=> (string) $row['poster_ip'],
-					'post_time'			=> (int) $row['post_time'],
-					'post_approved'		=> 1,
-					'post_reported'		=> 0,
-					'enable_bbcode'		=> (int) $row['enable_bbcode'],
-					'enable_html'		=> (int) $row['enable_html'],
-					'enable_smilies'	=> (int) $row['enable_smilies'],
-					'enable_magic_url'	=> (int) $row['enable_magic_url'],
-					'enable_sig'		=> (int) $row['enable_sig'],
-					'post_username'		=> (string) $row['post_username'],
-					'post_subject'		=> (string) $row['post_subject'],
-					'post_text'			=> (string) $row['post_text'],
-					'post_edit_reason'	=> (string) $row['post_edit_reason'],
-					'post_edit_user'	=> (int) $row['post_edit_user'],
-					'post_checksum'		=> (string) $row['post_checksum'],
-					'post_encoding'		=> (string) $row['post_encoding'],
-					'post_attachment'	=> (int) $row['post_attachment'],
-					'bbcode_bitfield'	=> (int) $row['bbcode_bitfield'],
-					'bbcode_uid'		=> (string) $row['bbcode_uid'],
-					'post_edit_time'	=> (int) $row['post_edit_time'],
-					'post_edit_count'	=> (int) $row['post_edit_count'],
-					'post_edit_locked'	=> (int) $row['post_edit_locked']
-				);
-
-				$db->sql_query('INSERT INTO ' . POSTS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
-				$new_post_id = $db->sql_nextid();
-
-				// Copy Attachments
-				if ($row['post_attachment'])
-				{
-					$sql = 'SELECT * FROM ' . ATTACHMENTS_TABLE . "
-						WHERE post_msg_id = {$row['post_id']}
-							AND topic_id = $topic_id
-							AND in_message = 0";
-					$result = $db->sql_query($sql);
-					
-					while ($attach_row = $db->sql_fetchrow($result))
-					{
-						$sql_ary = array(
-							'post_msg_id'		=> (int) $new_post_id,
-							'topic_id'			=> (int) $new_topic_id,
-							'in_message'		=> 0,
-							'poster_id'			=> (int) $attach_row['poster_id'],
-							'physical_filename'	=> (string) basename($attach_row['physical_filename']),
-							'real_filename'		=> (string) basename($attach_row['real_filename']),
-							'download_count'	=> (int) $attach_row['download_count'],
-							'comment'			=> (string) $attach_row['comment'],
-							'extension'			=> (string) $attach_row['extension'],
-							'mimetype'			=> (string) $attach_row['mimetype'],
-							'filesize'			=> (int) $attach_row['filesize'],
-							'filetime'			=> (int) $attach_row['filetime'],
-							'thumbnail'			=> (int) $attach_row['thumbnail']
-						);
-						
-						$db->sql_query('INSERT INTO ' . ATTACHMENTS_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary));
-					}
-					$db->sql_freeresult($result);
-				}
-			}
-		}
-
-		// Sync new topics, parent forums and board stats
-		sync('topic', 'topic_id', $new_topic_id_list, true);
-		sync('forum', 'forum_id', $to_forum_id, true);
-		set_config('num_topics', $config['num_topics'] + sizeof($new_topic_id_list));
-		set_config('num_posts', $config['num_posts'] + $total_posts);
-
-		foreach ($new_topic_id_list as $topic_id => $new_topic_id)
-		{
-			add_log('mod', $to_forum_id, $new_topic_id, 'LOG_FORK', $topic_row['forum_name']);
-		}
-
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_FORKED_SUCCESS' : 'TOPICS_FORKED_SUCCESS';
-	}
-	else
-	{
-		$_CLASS['core_template']->assign(array(
-			'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, false, false, true, true),
-			'S_CAN_LEAVE_SHADOW'	=> false,
-			'ADDITIONAL_MSG'		=> $additional_msg)
-		);
-
-		page_header();
-		confirm_box(false, 'FORK_TOPIC' . ((sizeof($topic_ids) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_move.html');
-	}
-
-	$redirect = request_var('redirect', generate_link('Forums'));
-
-	if (!$success_msg)
-	{
-		url_redirect($redirect);
-	}
-	else
-	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id));
-		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>');
-
-		if ($forum_id != $to_forum_id)
-		{
-			$return_link .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $to_forum_id) . '">', '</a>');
-		}
-
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
-	}
-}
-
+*/
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_main.php,v 1.9 2004/07/10 22:47:42 acydburn Exp $
+//
+// FILENAME  : mcp_main.php
+// STARTED   : Mon Sep 02, 2003
+// COPYRIGHT : 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+global $_CLASS;
+
+$action = request_var('action', '');
+$quickmod = request_var('quickmod', '');
+
+switch ($mode)
+{
+	case 'lock':
+	case 'unlock':
+		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		lock_unlock($mode, $topic_ids);
+	break;
+
+	case 'lock_post':
+	case 'unlock_post':
+		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		lock_unlock($mode, $post_ids);
+	break;
+
+	case 'make_announce':
+	case 'make_sticky':
+	case 'make_global':
+	case 'make_normal':
+		
+		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		change_topic_type($mode, $topic_ids);
+	break;
+
+	case 'move':
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_move_topic($topic_ids);
+	break;
+
+	case 'fork':
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_fork_topic($topic_ids);
+	break;
+
+	case 'delete_topic':
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_delete_topic($topic_ids);
+	break;
+
+	case 'delete_post':
+		$_CLASS['core_user']->add_lang('posting');
+
+		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		mcp_delete_post($post_ids);
+	break;
+
+	default:
+		trigger_error("Unknown mode: $mode");
+	break;
+}
+
+trigger_error('I need to put something here');
+
+// Lock/Unlock Topic/Post
+function lock_unlock($mode, $ids)
+{
+	global $_CLASS;
+
+	if ($mode === 'lock' || $mode === 'unlock')
+	{
+		$table = FORUMS_TOPICS_TABLE;
+		$sql_id = 'topic_id';
+		$set_id = 'topic_status';
+		$l_prefix = 'TOPIC';
+	}
+	else
+	{
+		$table = FORUMS_POSTS_TABLE;
+		$sql_id = 'post_id';
+		$set_id = 'post_edit_locked';
+		$l_prefix = 'POST';
+	}
+	
+	if (!check_ids($ids, $table, $sql_id, 'm_lock'))
+	{// redirect maybe
+		return;
+	}
+
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$message = $_CLASS['core_user']->get_lang(strtoupper($mode) . '_' . $l_prefix . ((count($ids) === 1) ? '' : 'S'));
+
+	$hidden_fields = build_hidden_fields(array(
+		$sql_id . '_list'	=> $ids,
+		'mode'				=> $mode,
+		'redirect'			=> $redirect)
+	);
+
+	$success_msg = false;
+
+	if (display_confirmation($message, $hidden_fields))
+	{
+		$sql = "UPDATE $table
+			SET $set_id = " . (($mode == 'lock' || $mode == 'lock_post') ? ITEM_LOCKED : ITEM_UNLOCKED) . "
+			WHERE $sql_id IN (" . implode(', ', $ids) . ")";
+		$_CLASS['core_db']->query($sql);
+
+		$data = ($mode === 'lock' || $mode === 'unlock') ? get_topic_data($ids) : get_post_data($ids);
+
+		foreach ($data as $id => $row)
+		{
+			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_' . strtoupper($mode), $row['topic_title']);
+		}
+
+		$success_msg = $l_prefix . ((count($ids) === 1) ? '' : 'S') . '_' . (($mode == 'lock' || $mode == 'lock_post') ? 'LOCKED' : 'UNLOCKED') . '_SUCCESS';
+	}
+
+	$redirect = generate_link($redirect);
+
+	if (!$success_msg)
+	{
+		redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(2, $redirect);
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+	}
+}
+
+// Change Topic Type
+function change_topic_type($mode, $topic_ids)
+{
+	global $db, $_CLASS;
+
+	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
+	{
+		return;
+	}
+
+	switch ($mode)
+	{
+		case 'make_announce':
+			$new_topic_type = POST_ANNOUNCE;
+			$check_acl = 'f_announce';
+			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
+			break;
+		case 'make_global':
+			$new_topic_type = POST_GLOBAL;
+			$check_acl = 'f_announce';
+			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
+			break;
+		case 'make_sticky':
+			$new_topic_type = POST_STICKY;
+			$check_acl = 'f_sticky';
+			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
+			break;
+		default:
+			$new_topic_type = POST_NORMAL;
+			$check_acl = '';
+			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
+			break;
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'topic_id_list'	=> $topic_ids,
+		'f'				=> $forum_id,
+		'mode'			=> $mode,
+		'redirect'		=> $redirect)
+	);
+	$success_msg = '';
+
+	if (confirm_box(true))
+	{
+		if ($new_topic_type != POST_GLOBAL)
+		{
+			$sql = 'UPDATE ' . TOPICS_TABLE . "
+				SET topic_type = $new_topic_type
+				WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
+					AND forum_id <> 0';
+			$db->query($sql);
+
+			// Reset forum id if a global topic is within the array
+			if ($forum_id)
+			{
+				$sql = 'UPDATE ' . TOPICS_TABLE . "
+					SET topic_type = $new_topic_type, forum_id = $forum_id
+						WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
+						AND forum_id = 0';
+				$db->query($sql);
+			}
+		}
+		else
+		{
+			$sql = 'UPDATE ' . TOPICS_TABLE . "
+				SET topic_type = $new_topic_type, forum_id = 0
+				WHERE topic_id IN (" . implode(', ', $topic_ids) . ")";
+			$db->query($sql);
+		}
+
+		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
+
+		$data = get_topic_data($topic_ids);
+
+		foreach ($data as $topic_id => $row)
+		{
+			add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);
+		}
+	}
+	else
+	{
+		confirm_box(false, $l_new_type, $s_hidden_fields);
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	if (!$success_msg)
+	{
+		url_redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(2, $redirect);
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+	}
+}
+
+// Move Topic
+function mcp_move_topic($topic_ids)
+{
+	global $_CLASS;
+	
+	$old_forums = check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_move');
+
+	if (!$old_forums)
+	{
+		return;
+	}
+
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$to_forum_id = get_variable('to_forum_id', 'POST', 0, 'int');
+
+	$additional_msg = $success_msg = '';
+
+	if ($to_forum_id)
+	{
+		$forum_data = get_forum_data($to_forum_id, 'm_');
+
+		if (empty($forum_data[$to_forum_id]))
+		{
+			$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_EXIST'];
+			$to_forum_id = 0;
+		}
+		else
+		{
+			$forum_data = $forum_data[$to_forum_id];
+
+			if ($forum_data['forum_type'] != FORUM_POST)
+			{
+				$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE'];
+			}
+			elseif (!$_CLASS['auth']->acl_get('f_post', $to_forum_id))
+			{
+				$additional_msg = $_CLASS['core_user']->lang['USER_CANNOT_POST'];
+			}
+			elseif (in_array($to_forum_id, $old_forums))
+			{
+				$additional_msg = $_CLASS['core_user']->lang['CANNOT_MOVE_SAME_FORUM'];
+			}
+		}
+	}
+
+	if (!$to_forum_id || $additional_msg)
+	{
+		unset($_POST['confirm']);
+	}
+	
+	$hidden_fields = build_hidden_fields(array(
+		'topic_id_list'	=> $topic_ids,
+		'mode'			=> 'move',
+		'redirect'		=> $redirect
+	));
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, $old_forums, false, true, true),
+		'S_CAN_LEAVE_SHADOW'	=> true,
+		'ADDITIONAL_MSG'		=> $additional_msg)
+	);
+
+	$message = $_CLASS['core_user']->get_lang('MOVE_TOPIC' . ((count($topic_ids) === 1) ? '' : 'S'));
+
+	page_header();
+
+	if (display_confirmation($message, $hidden_fields, 'modules/Forums/mcp_move.html'))
+	{
+		$topic_data = get_topic_data($topic_ids);
+		$leave_shadow = isset($_POST['move_leave_shadow']);
+
+		// Move topics, but do not resync yet
+		move_topics($topic_ids, $to_forum_id, false);
+
+		$_CLASS['core_db']->transaction();
+
+		$forum_ids = array($to_forum_id);
+		foreach ($topic_data as $topic_id => $row)
+		{
+			// Get the list of forums to resync, add a log entry
+			$forum_ids[] = $row['forum_id'];
+			add_log('mod', $to_forum_id, $topic_id, 'LOG_MOVE', $row['forum_name']);
+
+			// Leave a redirection if required and only if the topic is visible to users
+			if ($leave_shadow && $row['topic_approved'])
+			{
+				$shadow = array(
+					'forum_id'				=>	(int) $row['forum_id'],
+					'icon_id'				=>	(int) $row['icon_id'],
+					'topic_attachment'		=>	(int) $row['topic_attachment'],
+					'topic_approved'		=>	(int) $row['topic_approved'],
+					'topic_reported'		=>	(int) $row['topic_reported'],
+					'topic_title'			=>	(string) $row['topic_title'],
+					'topic_poster'			=>	(int) $row['topic_poster'],
+					'topic_time'			=>	(int) $row['topic_time'],
+					'topic_time_limit'		=>	(int) $row['topic_time_limit'],
+					'topic_views'			=>	(int) $row['topic_views'],
+					'topic_replies'			=>	(int) $row['topic_replies'],
+					'topic_replies_real'	=>	(int) $row['topic_replies_real'],
+					'topic_status'			=>	ITEM_MOVED,
+					'topic_type'			=>	(int) $row['topic_type'],
+					'topic_first_post_id'	=>	(int) $row['topic_first_post_id'],
+					'topic_first_poster_name'=>	(string) $row['topic_first_poster_name'],
+					'topic_last_post_id'	=>	(int) $row['topic_last_post_id'],
+					'topic_last_poster_id'	=>	(int) $row['topic_last_poster_id'],
+					'topic_last_poster_name'=>	(string) $row['topic_last_poster_name'],
+					'topic_last_post_time'	=>	(int) $row['topic_last_post_time'],
+					'topic_last_view_time'	=>	(int) $row['topic_last_view_time'],
+					'topic_moved_id'		=>	(int) $row['topic_id'],
+					'topic_bumped'			=>	(int) $row['topic_bumped'],
+					'topic_bumper'			=>	(int) $row['topic_bumper'],
+					'poll_title'			=>	(string) $row['poll_title'],
+					'poll_start'			=>	(int) $row['poll_start'],
+					'poll_length'			=>	(int) $row['poll_length'],
+					'poll_max_options'		=>	(int) $row['poll_max_options'],
+					'poll_last_vote'		=>	(int) $row['poll_last_vote']
+				);
+
+				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $shadow));
+			}
+		}
+		unset($topic_data, $shadow);
+
+		$_CLASS['core_db']->transaction('commit');
+
+		// Now sync forums
+		sync('forum', 'forum_id', $forum_ids);
+
+		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
+	}
+
+	$redirect = generate_link($redirect);
+
+	if (!$success_msg)
+	{
+		redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+
+		$message = $_CLASS['core_user']->lang[$success_msg];
+		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>');
+		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id).'">', '</a>');
+		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href='.generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id).'">', '</a>');
+		
+		trigger_error($message);
+	}
+}
+
+// Delete Topics
+function mcp_delete_topic($topic_ids)
+{
+	global $_CLASS, $db;
+
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_delete'))
+	{
+		return;
+	}
+
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
+
+	$hidden_fields = build_hidden_fields(array(
+		'topic_id_list'	=> $topic_ids,
+		'mode'			=> 'delete_topic',
+		'redirect'		=> $redirect
+	));
+
+	$success_msg = '';
+	$message = $_CLASS['core_user']->get_lang((count($topic_ids) === 1) ? 'DELETE_TOPIC' : 'DELETE_TOPICS');
+
+	if (display_confirmation($message, $hidden_fields))
+	{
+		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_DELETED_SUCCESS' : 'TOPICS_DELETED_SUCCESS';
+
+		$data = get_topic_data($topic_ids);
+
+		foreach ($data as $topic_id => $row)
+		{
+			add_log('mod', $row['forum_id'], 0, 'LOG_TOPIC_DELETED', $row['topic_title']);
+		}
+
+		$return = delete_topics('topic_id', $topic_ids, true);
+
+		// TODO: Adjust total post count...
+	}
+
+	$redirect = generate_link($redirect);
+
+	if (!$success_msg)
+	{
+		redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+	}
+}
+
+// Delete Posts
+function mcp_delete_post($post_ids)
+{
+	global $_CLASS, $db;
+
+	if (!($forum_id = check_ids($post_ids, POSTS_TABLE, 'post_id', 'm_delete')))
+	{
+		return;
+	}
+
+	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+
+	$s_hidden_fields = build_hidden_fields(array(
+		'post_id_list'	=> $post_ids,
+		'f'				=> $forum_id,
+		'mode'			=> 'delete_post',
+		'redirect'		=> $redirect)
+	);
+	$success_msg = '';
+
+	if (confirm_box(true))
+	{
+		// Count the number of topics that are affected
+		// I did not use COUNT(DISTINCT ...) because I remember having problems
+		// with it on older versions of MySQL -- Ashe
+
+		$sql = 'SELECT DISTINCT topic_id
+			FROM ' . POSTS_TABLE . '
+			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
+		$result = $db->query($sql);
+
+		$topic_id_list = array();
+		while ($row = $db->sql_fetchrow($result))
+		{
+			$topic_id_list[] = $row['topic_id'];
+		}
+		$affected_topics = sizeof($topic_id_list);
+		$db->sql_freeresult($result);
+
+		$post_data = get_post_data($post_ids);
+
+		foreach ($post_data as $id => $row)
+		{
+			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_DELETE_POST', $row['post_subject']);
+		}
+
+		// Now delete the posts, topics and forums are automatically resync'ed
+		delete_posts('post_id', $post_ids);
+					
+		$sql = 'SELECT COUNT(topic_id) AS topics_left
+			FROM ' . TOPICS_TABLE . '
+			WHERE topic_id IN (' . implode(', ', $topic_id_list) . ')';
+		$result = $db->query_limit($sql, 1);
+
+		$deleted_topics = ($row = $db->sql_fetchrow($result)) ? ($affected_topics - $row['topics_left']) : $affected_topics;
+		$db->sql_freeresult($result);
+
+		$topic_id = request_var('t', 0);
+
+		// Return links
+		$return_link = array();
+		if ($affected_topics == 1 && !$deleted_topics && $topic_id)
+		{
+			$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
+		}
+		$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
+
+		if (sizeof($post_ids) == 1)
+		{
+			if ($deleted_topics)
+			{
+				// We deleted the only post of a topic, which in turn has
+				// been removed from the database
+				$success_msg = $_CLASS['core_user']->lang['TOPIC_DELETED_SUCCESS'];
+			}
+			else
+			{
+				$success_msg = $_CLASS['core_user']->lang['POST_DELETED_SUCCESS'];
+			}
+		}
+		else
+		{
+			if ($deleted_topics)
+			{
+				// Some of topics disappeared
+				$success_msg = $_CLASS['core_user']->lang['POSTS_DELETED_SUCCESS'] . '<br /><br />' . $_CLASS['core_user']->lang['EMPTY_TOPICS_REMOVED_WARNING'];
+			}
+			else
+			{
+				$success_msg = $_CLASS['core_user']->lang['POSTS_DELETED_SUCCESS'];
+			}
+		}
+	}
+	else
+	{
+		confirm_box(false, (sizeof($post_ids) == 1) ? 'DELETE_POST' : 'DELETE_POSTS', $s_hidden_fields);
+	}
+
+	$redirect = request_var('redirect', generate_link('Forums'));
+
+	if (!$success_msg)
+	{
+		url_redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+		trigger_error($success_msg . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . implode('<br /><br />', $return_link));
+	}
+}
+
+// Fork Topic
+function mcp_fork_topic($topic_ids)
+{
+	global $db, $_CLASS, $config;
+
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
+	{
+		return;
+	}
+
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$to_forum_id = get_variable('to_forum_id', 'POST', 0, 'int');
+
+	$additional_msg = $success_msg = '';
+
+	if ($to_forum_id)
+	{
+		$forum_data = get_forum_data($to_forum_id, 'm_');
+
+		if (empty($forum_data[$to_forum_id]))
+		{
+			$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_EXIST'];
+		}
+		else
+		{
+			$forum_data = $forum_data[$to_forum_id];
+
+			if ($forum_data['forum_type'] != FORUM_POST)
+			{
+				$additional_msg = $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE'];
+			}
+			elseif (!$_CLASS['auth']->acl_get('f_post', $to_forum_id))
+			{
+				$additional_msg = $_CLASS['core_user']->lang['USER_CANNOT_POST'];
+			}
+		}
+	}
+
+	if (!$to_forum_id || $additional_msg)
+	{
+		unset($_POST['confirm']);
+	}
+
+	$hidden_fields = build_hidden_fields(array(
+		'topic_id_list'	=> $topic_ids,
+		'mode'			=> 'fork',
+		'redirect'		=> $redirect
+	));
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, false, false, true, true),
+		'S_CAN_LEAVE_SHADOW'	=> false,
+		'ADDITIONAL_MSG'		=> $additional_msg)
+	);
+
+	$message = $_CLASS['core_user']->get_lang('FORK_TOPIC' . ((count($topic_ids) === 1) ? '' : 'S'));
+
+	page_header();
+
+	if (display_confirmation($message, $hidden_fields, 'modules/Forums/mcp_move.html'))
+	{
+		$topic_data = get_topic_data($topic_ids);
+
+		$total_posts = 0;
+		$new_topic_id_list = array();
+
+		$_CLASS['core_db']->transaction();
+
+		foreach ($topic_data as $topic_id => $topic_row)
+		{
+// just change $row values for forum_id, topic_reported;
+// get_topic_data gets some unneeded stuff, remove it so we can just use $row
+
+			$sql_ary = array(
+				'forum_id'					=> (int) $to_forum_id,
+				'icon_id'					=> (int) $topic_row['icon_id'],
+				'topic_attachment'			=> (int) $topic_row['topic_attachment'],
+				'topic_approved'			=> 1,
+				'topic_reported'			=> 0,
+				'topic_title'				=> (string) $topic_row['topic_title'],
+				'topic_poster'				=> (int) $topic_row['topic_poster'],
+				'topic_time'				=> (int) $topic_row['topic_time'],
+				'topic_replies'				=> (int) $topic_row['topic_replies_real'],
+				'topic_replies_real'		=> (int) $topic_row['topic_replies_real'],
+				'topic_status'				=> (int) $topic_row['topic_status'],
+				'topic_type'				=> (int) $topic_row['topic_type'],
+				'topic_first_poster_name'	=> (string) $topic_row['topic_first_poster_name'],
+				'topic_last_poster_id'		=> (int) $topic_row['topic_last_poster_id'],
+				'topic_last_poster_name'	=> (string) $topic_row['topic_last_poster_name'],
+				'topic_last_post_time'		=> (int) $topic_row['topic_last_post_time'],
+				'topic_last_view_time'		=> (int) $topic_row['topic_last_view_time'],
+				'topic_bumped'				=> (int) $topic_row['topic_bumped'],
+				'topic_bumper'				=> (int) $topic_row['topic_bumper'],
+				'topic_views'				=> (int) $topic_row['topic_views'],
+				'poll_title'				=> (string) $topic_row['poll_title'],
+				'poll_start'				=> (int) $topic_row['poll_start'],
+				'poll_length'				=> (int) $topic_row['poll_length']
+			);
+
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+			$new_topic_id = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
+
+			$new_topic_id_list[$topic_id] = $new_topic_id;
+
+			if ($topic_row['poll_start'])
+			{
+				$poll_rows = array();
+
+				$sql = 'SELECT * 
+					FROM ' . FORUMS_POLL_OPTIONS_TABLE . " 
+					WHERE topic_id = $topic_id";
+				$result = $_CLASS['core_db']->query($sql);
+
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' (poll_option_id, topic_id, poll_option_text, poll_option_total)
+						VALUES (' . $row['poll_option_id'] . ', ' . $new_topic_id . ", '" . $db->sql_escape($row['poll_option_text']) . "', 0)";
+					$_CLASS['core_db']->query($sql);
+				}
+				$_CLASS['core_db']->free_result($result);
+			}
+
+			$sql = 'SELECT *
+				FROM ' . FORUMS_POSTS_TABLE . "
+				WHERE topic_id = $topic_id
+				ORDER BY post_id ASC";
+			$result = $_CLASS['core_db']->query($sql);
+	
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$total_posts++;
+// just change $row values for topic_id, forum_id, post_reported;
+
+				$sql_ary = array(
+					'topic_id'			=> (int) $new_topic_id,
+					'forum_id'			=> (int) $to_forum_id,
+					'poster_id'			=> (int) $row['poster_id'],
+					'icon_id'			=> (int) $row['icon_id'],
+					'poster_ip'			=> (string) $row['poster_ip'],
+					'post_time'			=> (int) $row['post_time'],
+					'post_approved'		=> 1,
+					'post_reported'		=> 0,
+					'enable_bbcode'		=> (int) $row['enable_bbcode'],
+					'enable_html'		=> (int) $row['enable_html'],
+					'enable_smilies'	=> (int) $row['enable_smilies'],
+					'enable_magic_url'	=> (int) $row['enable_magic_url'],
+					'enable_sig'		=> (int) $row['enable_sig'],
+					'post_username'		=> (string) $row['post_username'],
+					'post_subject'		=> (string) $row['post_subject'],
+					'post_text'			=> (string) $row['post_text'],
+					'post_edit_reason'	=> (string) $row['post_edit_reason'],
+					'post_edit_user'	=> (int) $row['post_edit_user'],
+					'post_checksum'		=> (string) $row['post_checksum'],
+					'post_attachment'	=> (int) $row['post_attachment'],
+					'bbcode_bitfield'	=> (int) $row['bbcode_bitfield'],
+					'bbcode_uid'		=> (string) $row['bbcode_uid'],
+					'post_edit_time'	=> (int) $row['post_edit_time'],
+					'post_edit_count'	=> (int) $row['post_edit_count'],
+					'post_edit_locked'	=> (int) $row['post_edit_locked']
+				);
+
+				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+
+				// Copy Attachments
+				if ($row['post_attachment'])
+				{
+					$new_post_id = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
+
+					$sql = 'SELECT * FROM ' . FORUMS_ATTACHMENTS_TABLE . "
+						WHERE post_msg_id = {$row['post_id']}
+							AND topic_id = $topic_id
+							AND in_message = 0";
+					$result = $_CLASS['core_db']->query($sql);
+					
+					while ($attach_row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$sql_ary = array(
+							'post_msg_id'		=> (int) $new_post_id,
+							'topic_id'			=> (int) $new_topic_id,
+							'in_message'		=> 0,
+							'poster_id'			=> (int) $attach_row['poster_id'],
+							'physical_filename'	=> (string) basename($attach_row['physical_filename']),
+							'real_filename'		=> (string) basename($attach_row['real_filename']),
+							'download_count'	=> (int) $attach_row['download_count'],
+							'comment'			=> (string) $attach_row['comment'],
+							'extension'			=> (string) $attach_row['extension'],
+							'mimetype'			=> (string) $attach_row['mimetype'],
+							'filesize'			=> (int) $attach_row['filesize'],
+							'filetime'			=> (int) $attach_row['filetime'],
+							'thumbnail'			=> (int) $attach_row['thumbnail']
+						);
+						
+						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+					}
+					$_CLASS['core_db']->free_result($result);
+				}
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		$_CLASS['core_db']->transaction('commit');
+
+		if (!empty($new_topic_id_list))
+		{
+			// Sync new topics, parent forums and board stats
+			sync('topic', 'topic_id', $new_topic_id_list, true);
+			sync('forum', 'forum_id', $to_forum_id, true);
+			set_config('num_topics', $config['num_topics'] + count($new_topic_id_list));
+			set_config('num_posts', $config['num_posts'] + $total_posts);
+	
+			foreach ($new_topic_id_list as $topic_id => $new_topic_id)
+			{
+				add_log('mod', $to_forum_id, $new_topic_id, 'LOG_FORK', $topic_row['forum_name']);
+			}
+			
+			$success_msg = (count($topic_ids) === 1) ? 'TOPIC_FORKED_SUCCESS' : 'TOPICS_FORKED_SUCCESS';
+		}
+		else
+		{
+			trigger_error('Something Failed');
+		}
+	}
+
+	$redirect = generate_link($redirect);
+
+	if (!$success_msg)
+	{
+		redirect($redirect);
+	}
+	else
+	{
+		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id));
+		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $to_forum_id) . '">', '</a>');
+
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -39,7 +39,11 @@
 
 $_CLASS['core_user']->add_lang('viewtopic');
 
-$topic_id = request_var('t', 0);
+if (!$topic_id = get_variable('t', 'REQUEST', false, 'int'))
+{
+	trigger_error('TOPIC_NOT_EXIST');
+}
+
 $topic_info = get_topic_data(array($topic_id));
 
 if (empty($topic_info[$topic_id]))
@@ -49,18 +53,32 @@
 
 $topic_info = $topic_info[$topic_id];
 
-// Set up some vars
-$icon_id = request_var('icon', 0);
-$subject = request_var('subject', '');
-$start = request_var('start', 0);
-$to_topic_id = request_var('to_topic_id', 0);
-$to_forum_id = request_var('to_forum_id', 0);
-$post_id_list = request_var('post_id_list', array(0));
+$url = 'Forums&amp;file=mcp&amp;t='.$topic_id;
 
+$action = get_variable('action', 'REQUEST');
+$icon_id = get_variable('icon', 'REQUEST', false, 'int');
+$subject = get_variable('subject', 'POST');
+
+$start = get_variable('start', 'REQUEST', false, 'int');
+
+$to_topic_id = get_variable('to_topic_id', 'REQUEST', false, 'int');
+$to_forum_id = get_variable('to_forum_id', 'REQUEST', false, 'int');
+
+$post_id_list = array_unique(request_var('post_id_list', array(0)));
+//echo $action;
 // Split Topic?
-if ($action == 'split_all' || $action == 'split_beyond')
+if ($action === 'split_all' || $action === 'split_beyond')
 {
-	split_topic($action, $topic_id, $to_forum_id, $subject);
+	if (empty($post_id_list))
+	{
+		trigger_error('NO_POST_SELECTED');
+	}
+
+	if ($message = split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject))
+	{
+		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->get_lang($message));
+	}
+
 	$action = 'split';
 }
 
@@ -68,30 +86,30 @@
 if ($action == 'merge_posts')
 {
 	merge_posts($topic_id, $to_topic_id);
+
 	$action = 'merge';
 }
 
 $topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
 
-if ($action == 'split' && !$subject)
+if ($action === 'split' && !$subject)
 {
 	$subject = $topic_info['topic_title'];
 }
 
-// Jumpbox, sort selects and that kind of things
-make_jumpbox($url . '&amp;mode=forum_view', $topic_info['forum_id'], false, 'm_');
-$where_sql = ($action == 'reports') ? 'WHERE post_reported = 1 AND ' : 'WHERE';
+$where_sql = ($action === 'reports') ? 'WHERE post_reported = 1 AND ' : 'WHERE';
 mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $topic_info['forum_id'], $topic_id, $where_sql);
 
 $forum_topics = ($total == -1) ? $topic_info['forum_topics'] : $total;
-$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
 if ($total == -1)
 {
 	$total = $topic_info['topic_replies'] + 1;
 }
-$posts_per_page = max(0, request_var('posts_per_page', intval($config['posts_per_page'])));
 
+$posts_per_page = max(0, get_variable('posts_per_page', 'POST', intval($config['posts_per_page'])));
+
 $sql = 'SELECT u.username, u.user_colour, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
 	WHERE ' . (($action == 'reports') ? 'p.post_reported = 1 AND ' : '') . "
@@ -102,6 +120,7 @@
 
 $rowset = array();
 $bbcode_bitfield = 0;
+
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	$rowset[] = $row;
@@ -210,7 +229,7 @@
 	'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED', false, true),
 	'UNAPPROVED_IMG'	=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED', false, true),
 
-	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode&amp;action=$action&amp;start=$start"),
+	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode".(($start) ? '&amp;start='.$start : '')),
 	'S_FORUM_SELECT'	=> '<select name="to_forum_id">' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '</select>',
 	'S_CAN_SPLIT'		=> ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']) && $action != 'merge') ? true : false,
 	'S_CAN_MERGE'		=> ($_CLASS['auth']->acl_get('m_merge', $topic_info['forum_id']) && $action != 'split') ? true : false,
@@ -231,64 +250,54 @@
 );
 
 page_header();
+make_jumpbox($url . '&amp;mode=forum_view', $topic_info['forum_id'], false, 'm_');
+
 $_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_topic.html');
 
-function split_topic($mode, $topic_id, $to_forum_id, $subject)
+function split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject)
 {
 	global $_CLASS ;
 
-	$post_id_list   = request_var('post_id_list', array(0));
-	$start			= request_var('start', 0);
+	$start	= request_var('start', 0);
 		
-	if (!sizeof($post_id_list))
+	if (empty($post_id_list) || !check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_split'))
 	{
-		trigger_error('NO_POST_SELECTED');
+		return false;
 	}
-	
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_split')))
-	{
-		return;
-	}
 
-	$post_id = $post_id_list[0];
-	$post_info = get_post_data(array($post_id));
+	//$post_id = $post_id_list[0];
 
-	if (!sizeof($post_info))
+	$post_info = get_post_data($post_id_list);
+
+	if (empty($post_info))
 	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_POST_SELECTED']);
-		return;
+		return 'NO_POST_SELECTED';
 	}
 
-	$post_info = $post_info[$post_id];
 	$subject = trim($subject);
 
-	// Make some tests
 	if (!$subject)
 	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['EMPTY_SUBJECT']);
-		return;
+		return 'EMPTY_SUBJECT';
 	}
 
 	if ($to_forum_id <= 0)
 	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_DESTINATION_FORUM']);
-		return;
+		return 'NO_DESTINATION_FORUM';
 	}
 
 	$forum_info = get_forum_data(array($to_forum_id), 'm_split');
 
-	if (!sizeof($forum_info))
+	if (empty($forum_info))
 	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NOT_MODERATOR']);
-		return;
+		return 'NOT_MODERATOR_DESTINATION';
 	}
 
 	$forum_info = $forum_info[$to_forum_id];
 
 	if ($forum_info['forum_type'] != FORUM_POST)
 	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['FORUM_NOT_POSTABLE']);
-		return;
+		return 'DESTINATION_FORUM_NOT_POSTABLE';
 	}
 
 	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
@@ -309,6 +318,8 @@
 
 	if (confirm_box(true))
 	{
+		//$post_info = $post_info[$post_id];
+
 		if ($mode == 'split_beyond')
 		{
 			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/functions.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -198,7 +198,7 @@
 	return file_exists(SITE_FILE_ROOT.'themes/'.$theme.'/index.php');
 }
 
-function display_confirmation($message = '', $hidden = '', $image = false)
+function display_confirmation($message = '', $hidden = '', $template = false, $image = false)
 {
 	global $_CLASS;
 // Add user entered confirmation code as a choose, maybe ...
@@ -241,9 +241,9 @@
 		'HIDDEN_FIELDS'	=> $hidden
 	));
 
-	$_CLASS['core_template']->display('confirmation.html');
+	$_CLASS['core_template']->display($template ? $template : 'confirmation.html');
 
-	script_close();
+	script_close(false);
 }
 
 function encode_password($pure, $encoding)
@@ -427,7 +427,7 @@
 
 		if ($link{0} == '&')
 		{
-			$link = $_CORE_MODULE['name'].$link;
+			$link = $_CORE_MODULE['module_name'].$link;
 		}
 
 		if (!$options['seo'])

Modified: cms/trunk/includes/templates/modules/Forums/mcp_forum.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_forum.html	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/templates/modules/Forums/mcp_forum.html	2005-09-21 23:22:59 UTC (rev 140)
@@ -53,12 +53,13 @@
 				<!-- ENDIF --><!-- IF { $S_CAN_FORK } -->
 				<option value="fork">{ $L_FORK }</option>
 				<!-- ENDIF --><!-- IF { $S_CAN_LOCK } -->
-				<option value="lock">{ $L_LOCK }</option><option value="unlock">{ $L_UNLOCK }</option>
+				<option value="lock">{ $L_LOCK }</option>
+				<option value="unlock">{ $L_UNLOCK }</option>
 				<!-- ENDIF --><!-- IF { $S_CAN_SYNC } -->
 				<option value="resync">{ $L_RESYNC }</option>
 				<!-- ENDIF -->
 			</select>
-			<input class="btnmain" type="submit" value="{ $L_SUBMIT }" />
+			<input class="button" type="submit" value="{ $L_SUBMIT }" />
 		</td>
 	</tr>
 </table>

Modified: cms/trunk/includes/templates/modules/Forums/mcp_front.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_front.html	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/templates/modules/Forums/mcp_front.html	2005-09-21 23:22:59 UTC (rev 140)
@@ -1,3 +1,5 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
 <!-- IF { $S_SHOW_UNAPPROVED } -->
@@ -101,4 +103,6 @@
 <br clear="all" />
 <!-- ENDIF -->
 
-<!-- INCLUDE modules/Forums/mcp_footer.html -->
\ No newline at end of file
+<!-- INCLUDE modules/Forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/mcp_move.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_move.html	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/templates/modules/Forums/mcp_move.html	2005-09-21 23:22:59 UTC (rev 140)
@@ -1,25 +1,29 @@
+<!-- DISPLAY_HEADER -->
+
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
-	<form name="confirm" action="{ $S_CONFIRM_ACTION }" method="post">
-		<table class="tablebg" width="100%" cellspacing="1">
-			<tr>
-				<th>{ $MESSAGE_TITLE }</th>
-			</tr>
-			<tr>
-				<td class="row1" align="center">
-					<!-- IF { $ADDITIONAL_MSG } -->
-						<span class="gen" style="color:red">{ $ADDITIONAL_MSG }</span><br />
-					<!-- ENDIF -->
-					<span class="gen"><br />{ $L_SELECT_DESTINATION_FORUM }&nbsp;&nbsp;<br /></span>
-						<select name="to_forum_id">{ $S_FORUM_SELECT }</select><br />
-					<!-- IF { $S_CAN_LEAVE_SHADOW } -->
-						<input type="checkbox" name="move_leave_shadow" checked="checked" /><span class="gen">{ $L_LEAVE_SHADOW }</span><br />
-					<!-- ENDIF -->
-					<br />{ $S_HIDDEN_FIELDS }<span class="gen">{ $MESSAGE_TEXT }</span><br /><br />
-					<input type="submit" name="confirm" value="{ $YES_VALUE }" class="btnmain" />&nbsp;&nbsp;<input type="submit" name="cancel" value="{ $L_NO }" class="btnlite" /></span>
-				</td>
-			</tr>
-		</table>
-	</form>
+<form name="confirm" action="{ $CONFIRM_ACTION }" method="post">
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th>{ $MESSAGE }</th>
+		</tr>
+		<tr>
+			<td class="row1" align="center">
+				<!-- IF { $ADDITIONAL_MSG } -->
+					<span class="gen" style="color:red">{ $ADDITIONAL_MSG }</span><br />
+				<!-- ENDIF -->
+				<span class="gen"><br />{ $L_SELECT_DESTINATION_FORUM }&nbsp;&nbsp;<br /></span>
+					<select name="to_forum_id">{ $S_FORUM_SELECT }</select><br />
+				<!-- IF { $S_CAN_LEAVE_SHADOW } -->
+					<input type="checkbox" name="move_leave_shadow" checked="checked" /><span class="gen">{ $L_LEAVE_SHADOW }</span><br />
+				<!-- ENDIF -->
+				<br />{ $HIDDEN_FIELDS }<span class="gen">{ $MESSAGE }</span><br /><br />
+				<input class="button" name="confirm" value="Submit" type="submit" />&nbsp;&nbsp;<input class="button" value="{ $L_CANCEL }" name="cancel" type="submit" />
+			</td>
+		</tr>
+	</table>
+</form>
+	
+<!-- INCLUDE modules/Forums/mcp_footer.html -->
 
-<!-- INCLUDE modules/Forums/mcp_footer.html -->
\ No newline at end of file
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/mcp_topic.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/mcp_topic.html	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/templates/modules/Forums/mcp_topic.html	2005-09-21 23:22:59 UTC (rev 140)
@@ -2,132 +2,134 @@
 
 <!-- INCLUDE modules/Forums/mcp_header.html -->
 
-<form name="mcp" method="post" action="{ $S_MCP_ACTION }"><table class="tablebg" width="100%" cellspacing="1">
-	<!-- IF { $S_CAN_SPLIT } -->
-	<tr>
-		<th colspan="3" nowrap="nowrap">{ $L_SPLIT_TOPIC }</th>
-	</tr>
-	<tr>
-		<td class="row2" colspan="3" align="center"><span class="gensmall">{ $L_SPLIT_TOPIC_EXPLAIN }</span></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><span class="gen">{ $L_SPLIT_SUBJECT }</span></td>
-		<td class="row2" colspan="2"><input class="post" style="width: 350px" type="text" size="35" maxlength="100" name="subject" value="{ $SPLIT_SUBJECT }" /></span></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><span class="gen">{ $L_SPLIT_FORUM }</span></td>
-		<td class="row2" colspan="2">{ $S_FORUM_SELECT }</td>
-	</tr>
-	<!-- IF { $S_SHOW_TOPIC_ICONS } -->
-	<tr>
-		<td class="row1"><span class="gen">{ $L_TOPIC_ICON }</span></td>
-		<td class="row2" colspan="2"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-			<tr>
-				<td><input type="radio" name="icon" value="0"<!-- IF !{ $S_TOPIC_ICON } --> checked="checked"<!-- ENDIF --> /><span class="genmed">{ $L_NONE }</span>
-				<!-- LOOP $topic_icon --><input type="radio" name="icon" value="{ $topic_icon:ICON_ID }"<!-- IF { $topic_icon:S_CHECKED } --> checked="checked"<!-- ENDIF --> /><img src="{ $topic_icon:ICON_IMG }" width="{ $topic_icon:ICON_WIDTH }" height="{ $topic_icon:ICON_HEIGHT }" alt="" title="" hspace="2" vspace="2" /><!-- ENDLOOP --></td>
-			</tr>
-		</table></td>
-	</tr>
-	<!-- ENDIF --><!-- ENDIF -->
-
-	<!-- IF { $S_CAN_MERGE } -->
-	<tr>
-		<th colspan="3" nowrap="nowrap">{ $L_MERGE_TOPIC }</th>
-	</tr>
-	<tr>
-		<td class="row2" colspan="3" align="center"><span class="gensmall">{ $L_MERGE_TOPIC_EXPLAIN }</span></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><span class="gen">{ $L_MERGE_TOPIC_ID }</span></td>
-		<td class="row2" colspan="2"><input class="post" type="text" size="6" name="to_topic_id" value="{ $TO_TOPIC_ID }" /> <input class="btnlite" type="submit" name="action[merge_select]" value="{ $L_SELECT_TOPIC }" /></td>
-	</tr>
-	<!-- IF { $TO_TOPIC_INFO } -->
-	<tr>
-		<td class="row3" colspan="3" align="center"><b class="gen">{ $TO_TOPIC_INFO }</b></td>
-	</tr>
-	<!-- ENDIF --><!-- ENDIF -->
-	<tr>
-		<th colspan="3"  nowrap="nowrap">{ $L_DISPLAY_OPTIONS }</th>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><span class="gen">{ $L_POSTS_PER_PAGE }</span><br /><span class="gensmall">{ $L_POSTS_PER_PAGE_EXPLAIN }</span</td>
-		<td class="row2" colspan="2"><input class="post" type="text" name="posts_per_page" size="6" value="{ $POSTS_PER_PAGE }"></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="3" height="28" align="center"><span class="gensmall">{ $L_DISPLAY_POSTS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" /></span></td>
-	</tr>
-	<tr>
-		<th height="28" nowrap="nowrap">{ $L_AUTHOR }</th>
-		<th nowrap="nowrap">{ $L_MESSAGE }</th>
-		<th nowrap="nowrap">{ $L_SELECT }</th>
-	</tr>
-	<!-- LOOP $postrow -->
-		<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
-			<tr class="row1">
-		<!-- ELSE -->
-			<tr class="row2">
-		<!-- ENDIF -->
-
-			<td align="center"><b class="postauthor">{ $postrow:POSTER_NAME }</b></td>
-			<td width="100%" height="28"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-				<tr valign="top">
-					<td class="gensmall" nowrap="nowrap">&nbsp;<b>{ $L_POST_SUBJECT }:</b>&nbsp;</td>
-					<td class="gensmall" width="100%">{ $postrow:POST_SUBJECT }</td>
-				</tr>
-			</table></td>
-			<td rowspan="2" width="5%" align="center">{ $postrow:S_CHECKBOX }</td>
+<form name="mcp" method="post" action="{ $S_MCP_ACTION }">
+	<table class="tablebg" width="100%" cellspacing="1">
+		<!-- IF { $S_CAN_SPLIT } -->
+		<tr>
+			<th colspan="3" nowrap="nowrap">{ $L_SPLIT_TOPIC }</th>
 		</tr>
-		<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
-			<tr class="row1">
-		<!-- ELSE -->
-			<tr class="row2">
-		<!-- ENDIF -->
-			<td valign="bottom">
-				<table width="100%" cellspacing="0" cellpadding="0" border="0">
-					<tr valign="middle">
-						<td height="28" align="center"><span class="gensmall">[ <a href="{ $postrow:U_POST_DETAILS }">{$L_POST_DETAILS}</a> ]</span></td>
-					</tr>
-				</table>
-			</td>
-			<td width="100%" valign="top"><table width="100%" cellspacing="0" cellpadding="2" border="0">
+		<tr>
+			<td class="row2" colspan="3" align="center"><span class="gensmall">{ $L_SPLIT_TOPIC_EXPLAIN }</span></td>
+		</tr>
+		<tr>
+			<td class="row1" nowrap="nowrap"><span class="gen">{ $L_SPLIT_SUBJECT }</span></td>
+			<td class="row2" colspan="2"><input class="post" style="width: 350px" type="text" size="35" maxlength="100" name="subject" value="{ $SPLIT_SUBJECT }" /></span></td>
+		</tr>
+		<tr>
+			<td class="row1" nowrap="nowrap"><span class="gen">{ $L_SPLIT_FORUM }</span></td>
+			<td class="row2" colspan="2">{ $S_FORUM_SELECT }</td>
+		</tr>
+		<!-- IF { $S_SHOW_TOPIC_ICONS } -->
+		<tr>
+			<td class="row1"><span class="gen">{ $L_TOPIC_ICON }</span></td>
+			<td class="row2" colspan="2"><table width="100%" cellspacing="0" cellpadding="0" border="0">
 				<tr>
-					<td class="postbody" valign="top">{ $postrow:MESSAGE }<br /><br /></td>
+					<td><input type="radio" name="icon" value="0"<!-- IF !{ $S_TOPIC_ICON } --> checked="checked"<!-- ENDIF --> /><span class="genmed">{ $L_NONE }</span>
+					<!-- LOOP $topic_icon --><input type="radio" name="icon" value="{ $topic_icon:ICON_ID }"<!-- IF { $topic_icon:S_CHECKED } --> checked="checked"<!-- ENDIF --> /><img src="{ $topic_icon:ICON_IMG }" width="{ $topic_icon:ICON_WIDTH }" height="{ $topic_icon:ICON_HEIGHT }" alt="" title="" hspace="2" vspace="2" /><!-- ENDLOOP --></td>
 				</tr>
-				<tr>
-					<td valign="bottom">
-						<table width="100%" cellspacing="0" cellpadding="0" border="0">
-							<tr valign="middle">
-								<!-- IF { $postrow:S_POST_UNAPPROVED } -->
-								<td width="5">{ $UNAPPROVED_IMG }</td>
-								<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:green"  href="{ $postrow:U_MCP_APPROVE }">{ $L_POST_UNAPPROVED }</a></b>&nbsp;&nbsp;</td>
-								<!-- ENDIF -->
-								<!-- IF { $postrow:S_POST_REPORTED } -->
-								<td width="5">{ $REPORTED_IMG }</td>
-								<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:red" href="{ $postrow:U_POST_DETAILS }">{ $L_POST_REPORTED }</a></b>&nbsp;</td>
-								<!-- ENDIF -->
-								<td width="100%">&nbsp;</td>
-								<td width="10" nowrap="nowrap">{ $postrow:MINI_POST_IMG }</td>
-								<td class="gensmall" nowrap="nowrap"><b>{ $L_POSTED }:</b> { $postrow:POST_DATE }</td>
-							</tr>
-						</table>
-					</td>
-				</tr>
 			</table></td>
 		</tr>
+		<!-- ENDIF --><!-- ENDIF -->
+	
+		<!-- IF { $S_CAN_MERGE } -->
 		<tr>
-			<td class="row3" colspan="3" height="1"><img src="images/spacer.gif" width="1" height="1" alt="" /></td>
+			<th colspan="3" nowrap="nowrap">{ $L_MERGE_TOPIC }</th>
 		</tr>
-	<!-- ENDLOOP -->
-	<tr>
-		<td class="cat" colspan="3" height="28" align="center"><select name="mode2"><option value="" selected="selected">{ $L_SELECT_ACTION }</option>			
-			<!-- IF { $S_CAN_APPROVE } --><option value="approve">{ $L_APPROVE_POSTS}</option><!-- ENDIF -->
-			<!-- IF { $S_CAN_LOCK } --><option value="lock_post">{ $L_LOCK_POST_POSTS } [ { $L_LOCK_POST_EXPLAIN } ]</option><option value="unlock_post">{ $L_UNLOCK_POST_POSTS }</option><!-- ENDIF -->
-			<!-- IF { $S_CAN_DELETE } --><option value="delete_post">{ $L_DELETE_POSTS }</option><!-- ENDIF -->
-			<!-- IF { $S_CAN_MERGE } --><option value="merge_posts"<!-- IF { $MODE } == 'merge' --> selected="selected"<!-- ENDIF -->>{ $L_MERGE_POSTS }</option><!-- ENDIF -->
-			<!-- IF { $S_CAN_SPLIT } --><option value="split_all"<!-- IF { $MODE } == 'split' --> selected="selected"<!-- ENDIF -->>{ $L_SPLIT_POSTS }</option><option value="split_beyond">{ $L_SPLIT_AFTER }</option><!-- ENDIF -->
-		</select>&nbsp;<input class="btnmain" type="submit" name="quick" value="{$L_SUBMIT}"></form></td>
-	</tr>
-</table>
+		<tr>
+			<td class="row2" colspan="3" align="center"><span class="gensmall">{ $L_MERGE_TOPIC_EXPLAIN }</span></td>
+		</tr>
+		<tr>
+			<td class="row1" nowrap="nowrap"><span class="gen">{ $L_MERGE_TOPIC_ID }</span></td>
+			<td class="row2" colspan="2"><input class="post" type="text" size="6" name="to_topic_id" value="{ $TO_TOPIC_ID }" /> <input class="btnlite" type="submit" name="action[merge_select]" value="{ $L_SELECT_TOPIC }" /></td>
+		</tr>
+		<!-- IF { $TO_TOPIC_INFO } -->
+		<tr>
+			<td class="row3" colspan="3" align="center"><b class="gen">{ $TO_TOPIC_INFO }</b></td>
+		</tr>
+		<!-- ENDIF --><!-- ENDIF -->
+		<tr>
+			<th colspan="3"  nowrap="nowrap">{ $L_DISPLAY_OPTIONS }</th>
+		</tr>
+		<tr>
+			<td class="row1" nowrap="nowrap"><span class="gen">{ $L_POSTS_PER_PAGE }</span><br /><span class="gensmall">{ $L_POSTS_PER_PAGE_EXPLAIN }</span</td>
+			<td class="row2" colspan="2"><input class="post" type="text" name="posts_per_page" size="6" value="{ $POSTS_PER_PAGE }"></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="3" height="28" align="center"><span class="gensmall">{ $L_DISPLAY_POSTS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" /></span></td>
+		</tr>
+		<tr>
+			<th height="28" nowrap="nowrap">{ $L_AUTHOR }</th>
+			<th nowrap="nowrap">{ $L_MESSAGE }</th>
+			<th nowrap="nowrap">{ $L_SELECT }</th>
+		</tr>
+		<!-- LOOP $postrow -->
+			<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
+				<tr class="row1">
+			<!-- ELSE -->
+				<tr class="row2">
+			<!-- ENDIF -->
+	
+				<td align="center"><b class="postauthor">{ $postrow:POSTER_NAME }</b></td>
+				<td width="100%" height="28"><table width="100%" cellspacing="0" cellpadding="0" border="0">
+					<tr valign="top">
+						<td class="gensmall" nowrap="nowrap">&nbsp;<b>{ $L_POST_SUBJECT }:</b>&nbsp;</td>
+						<td class="gensmall" width="100%">{ $postrow:POST_SUBJECT }</td>
+					</tr>
+				</table></td>
+				<td rowspan="2" width="5%" align="center">{ $postrow:S_CHECKBOX }</td>
+			</tr>
+			<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
+				<tr class="row1">
+			<!-- ELSE -->
+				<tr class="row2">
+			<!-- ENDIF -->
+				<td valign="bottom">
+					<table width="100%" cellspacing="0" cellpadding="0" border="0">
+						<tr valign="middle">
+							<td height="28" align="center"><span class="gensmall">[ <a href="{ $postrow:U_POST_DETAILS }">{$L_POST_DETAILS}</a> ]</span></td>
+						</tr>
+					</table>
+				</td>
+				<td width="100%" valign="top"><table width="100%" cellspacing="0" cellpadding="2" border="0">
+					<tr>
+						<td class="postbody" valign="top">{ $postrow:MESSAGE }<br /><br /></td>
+					</tr>
+					<tr>
+						<td valign="bottom">
+							<table width="100%" cellspacing="0" cellpadding="0" border="0">
+								<tr valign="middle">
+									<!-- IF { $postrow:S_POST_UNAPPROVED } -->
+									<td width="5">{ $UNAPPROVED_IMG }</td>
+									<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:green"  href="{ $postrow:U_MCP_APPROVE }">{ $L_POST_UNAPPROVED }</a></b>&nbsp;&nbsp;</td>
+									<!-- ENDIF -->
+									<!-- IF { $postrow:S_POST_REPORTED } -->
+									<td width="5">{ $REPORTED_IMG }</td>
+									<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:red" href="{ $postrow:U_POST_DETAILS }">{ $L_POST_REPORTED }</a></b>&nbsp;</td>
+									<!-- ENDIF -->
+									<td width="100%">&nbsp;</td>
+									<td width="10" nowrap="nowrap">{ $postrow:MINI_POST_IMG }</td>
+									<td class="gensmall" nowrap="nowrap"><b>{ $L_POSTED }:</b> { $postrow:POST_DATE }</td>
+								</tr>
+							</table>
+						</td>
+					</tr>
+				</table></td>
+			</tr>
+			<tr>
+				<td class="spacer" colspan="3" height="10"></td>
+			</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td class="cat" colspan="3" height="28" align="center"><select name="action">
+				<option value="" selected="selected">{ $L_SELECT_ACTION }</option>			
+				<!-- IF { $S_CAN_APPROVE } --><option value="approve">{ $L_APPROVE_POSTS}</option><!-- ENDIF -->
+				<!-- IF { $S_CAN_LOCK } --><option value="lock_post">{ $L_LOCK_POST_POSTS } [ { $L_LOCK_POST_EXPLAIN } ]</option><option value="unlock_post">{ $L_UNLOCK_POST_POSTS }</option><!-- ENDIF -->
+				<!-- IF { $S_CAN_DELETE } --><option value="delete_post">{ $L_DELETE_POSTS }</option><!-- ENDIF -->
+				<!-- IF { $S_CAN_MERGE } --><option value="merge_posts"<!-- IF { $MODE } == 'merge' --> selected="selected"<!-- ENDIF -->>{ $L_MERGE_POSTS }</option><!-- ENDIF -->
+				<!-- IF { $S_CAN_SPLIT } --><option value="split_all"<!-- IF { $MODE } == 'split' --> selected="selected"<!-- ENDIF -->>{ $L_SPLIT_POSTS }</option><option value="split_beyond">{ $L_SPLIT_AFTER }</option><!-- ENDIF -->
+			</select>&nbsp;<input class="btnmain" type="submit" name="quick" value="{$L_SUBMIT}"></form></td>
+		</tr>
+	</table>
 </form>
 
 <table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-21 23:22:59 UTC (rev 140)
@@ -51,7 +51,15 @@
 		<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 		<!-- ENDIF -->
 		</td>
-		<td class="row2" align="center" width="100"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row2" align="center" width="100">
+			<p class="topicauthor">
+				<!-- IF { $topicrow:LINK_AUTHOR } -->
+				<a href="{ $topicrow:LINK_AUTHOR }">{ $topicrow:AUTHOR }</a>
+				<!-- ELSE -->
+				{ $topicrow:AUTHOR }
+				<!-- ENDIF -->
+			</p>
+		</td>
 		<td class="row1" align="center" width="50"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
 		<td class="row2" align="center" width="50"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
 		<td class="row1" align="center" width="120">
@@ -167,7 +175,15 @@
 			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
 			<!-- ENDIF -->
 		</td>
-		<td class="row2" align="center" width="100" nowrap="nowrap"><p class="topicauthor">{ $topicrow:TOPIC_AUTHOR }</p></td>
+		<td class="row2" align="center" width="100" nowrap="nowrap">
+			<p class="topicauthor">
+				<!-- IF { $topicrow:LINK_AUTHOR } -->
+				<a href="{ $topicrow:LINK_AUTHOR }">{ $topicrow:AUTHOR }</a>
+				<!-- ELSE -->
+				{ $topicrow:AUTHOR }
+				<!-- ENDIF -->
+			</p>
+		</td>
 		<td class="row1" align="center" width="50"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
 		<td class="row2" align="center" width="50"><p class="topicdetails">{ $topicrow:VIEWS }</p></td>
 		<td class="row1" align="center" width="150" nowrap="nowrap">

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/install/build_tables.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -608,7 +608,7 @@
 $_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1, 'null' => true)); 
-field_unix_time('topic_time_limit');
+field_unix_time('topic_time_limit', true);
 $_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
 $_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000, 'null' => true));

Modified: cms/trunk/modules/Control_Panel/index.php
===================================================================
--- cms/trunk/modules/Control_Panel/index.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Control_Panel/index.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -70,8 +70,12 @@
 			if ($row['module_acl'])
 			{
 				$is_auth = false;
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('$_CLASS[\'auth\']->acl_get("\\1")', '$config["\\1"]'), trim($row['module_acl'])) . ');');
+				//echo $row['module_acl'];
+				$row['module_acl'] = preg_replace(array('#acl_([a-z_]+)#', '#cfg_([a-z_]+)#'), array('$_CLASS[\'auth\']->acl_get("\\1")', '$config["\\1"]'), trim($row['module_acl']));
+				//echo $row['module_acl'];
 
+				eval('$is_auth = ('.$row['module_acl'].');');
+
 				// The user is not authorised to use this module, skip it
 				if (!$is_auth)
 				{

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -138,68 +138,68 @@
 				$_CLASS['core_db']->free_result($result);
 
 /// 
+				$num_real_posts = $_CLASS['core_user']->data['user_posts'];
+				$active_f_row = $active_t_row = array();
+
 				$_CLASS['auth']->acl_getf('f_read');
-				$post_count_ary = $_CLASS['auth']->acl_getf('f_postcount');
-				
-				$forum_ary = array();
-				foreach ($post_count_ary as $forum_id => $allowed)
+/*
+				if ($post_count_ary = $_CLASS['auth']->acl_getf('f_postcount'))
 				{
-					if ($allowed['f_read'] && $allowed['f_postcount'])
+					$forum_ary = array();
+					foreach ($post_count_ary as $forum_id => $allowed)
 					{
-						$forum_ary[] = $forum_id;
+						if ($allowed['f_read'] && $allowed['f_postcount'])
+						{
+							$forum_ary[] = $forum_id;
+						}
 					}
+	
+					$post_count_sql = (sizeof($forum_ary)) ? 'AND f.forum_id IN (' . implode(', ', $forum_ary) . ')' : '';
+					unset($forum_ary, $post_count_ary);
+	
+					if ($post_count_sql)
+					{
+						// NOTE: The following three queries could be a problem for big boards
+						
+						// Grab all the relevant data
+						$sql = 'SELECT COUNT(p.post_id) AS num_posts   
+							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
+							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
+								AND f.forum_id = p.forum_id 
+								$post_count_sql";
+						$result = $_CLASS['core_db']->query($sql);
+						list($num_posts) = $_CLASS['core_db']->fetch_row_num($result);
+						$_CLASS['core_db']->free_result($result);
+	
+						$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $num_posts);
+	
+						$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
+							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
+							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
+								AND f.forum_id = p.forum_id 
+								$post_count_sql
+							GROUP BY f.forum_id, f.forum_name  
+							ORDER BY num_posts DESC"; 
+						$result = $_CLASS['core_db']->query_limit($sql, 1);
+	
+						$active_f_row = $_CLASS['core_db']->fetch_row_assoc($result);
+						$_CLASS['core_db']->free_result($result);
+	
+						$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
+							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
+							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
+								AND t.topic_id = p.topic_id  
+								AND f.forum_id = t.forum_id 
+								$post_count_sql
+							GROUP BY t.topic_id, t.topic_title  
+							ORDER BY num_posts DESC";
+						$result = $_CLASS['core_db']->query_limit($sql, 1);
+	
+						$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
+						$_CLASS['core_db']->free_result($result);
+					}
 				}
-
-				$post_count_sql = (sizeof($forum_ary)) ? 'AND f.forum_id IN (' . implode(', ', $forum_ary) . ')' : '';
-				unset($forum_ary, $post_count_ary);
-
-				if ($post_count_sql)
-				{
-					// NOTE: The following three queries could be a problem for big boards
-					
-					// Grab all the relevant data
-					$sql = 'SELECT COUNT(p.post_id) AS num_posts   
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
-						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-							AND f.forum_id = p.forum_id 
-							$post_count_sql";
-					$result = $_CLASS['core_db']->query($sql);
-					list($num_posts) = $_CLASS['core_db']->fetch_row_num($result);
-					$_CLASS['core_db']->free_result($result);
-
-					$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $num_posts);
-
-					$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
-						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-							AND f.forum_id = p.forum_id 
-							$post_count_sql
-						GROUP BY f.forum_id, f.forum_name  
-						ORDER BY num_posts DESC"; 
-					$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-					$active_f_row = $_CLASS['core_db']->fetch_row_assoc($result);
-					$_CLASS['core_db']->free_result($result);
-
-					$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
-						WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-							AND t.topic_id = p.topic_id  
-							AND f.forum_id = t.forum_id 
-							$post_count_sql
-						GROUP BY t.topic_id, t.topic_title  
-						ORDER BY num_posts DESC";
-					$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-					$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
-					$_CLASS['core_db']->free_result($result);
-				}
-				else
-				{
-					$num_real_posts = 0;
-					$active_f_row = $active_t_row = array();
-				}
-
+			*/
 				// Do the relevant calculations 
 				$memberdays = max(1, round((time() - $_CLASS['core_user']->data['user_reg_date']) / 86400));
 				$posts_per_day = $_CLASS['core_user']->data['user_posts'] / $memberdays;

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Forums/mcp.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -29,230 +29,6 @@
 
 require_once($site_file_root.'includes/forums/functions_admin.php');
 
-// ---------
-// FUNCTIONS
-//
-class module
-{
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
-	var $url;
-
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $post_id, $topic_id, $forum_id, $selected_mod = false, $selected_submod = false)
-	{
-		global $_CLASS, $config;
-		
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . FORUMS_MODULES_TABLE . "
-			WHERE module_type = '{$module_type}'
-				AND module_enabled = 1
-			ORDER BY module_order ASC";
-		$result = $_CLASS['core_db']->query($sql);
-
-		$i = 0;
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']->acl_get("\\1", ' . $forum_id . ')', '(int) $config["\\1"]'), trim($row['module_acl'])) . ');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod && !$i)) ?  true : false;
-
-			// Get the localised lang string if available, or make up our own otherwise
-			$module_lang = strtoupper($module_type) . '_' . $row['module_title'];
-
-			$_CLASS['core_template']->assign_vars_array($module_type . '_section', array(
-				'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
-				'S_SELECTED'	=> $selected, 
-				'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $row['module_id']))
-			);
-
-			if ($selected)
-			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
-				{
-					$j = 0;
-					$submodules_ary = explode("\n", $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
-					{
-						$submodule = trim($submodule);
-						if (!$submodule)
-						{
-							continue;
-						}
-
-						$submodule = explode(',', $submodule);
-						$submodule_title = array_shift($submodule);
-						//print_r( $submodule);
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('(int) $_CLASS[\'auth\']->acl_get("\\1", ' . $forum_id . ')', '(int) $config["\\1"]'), trim($auth_option)) . ');');
-
-							if (!$is_auth)
-							{
-								break;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						// Only show those rows we are able to access
-						if (($submodule_title == 'post_details' && !$post_id) || 
-							($submodule_title == 'topic_view' && !$topic_id) ||
-							($submodule_title == 'forum_view' && !$forum_id))
-						{
-							continue;
-						}
-			
-						$suffix = ($post_id) ? "&amp;p=$post_id" : '';
-						$suffix .= ($topic_id) ? "&amp;t=$topic_id" : '';
-						$suffix .= ($forum_id) ? "&amp;f=$forum_id" : '';
-											
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod && !$j)) ? true : false;
-
-						// Get the localised lang string if available, or make up our own otherwise
-						$module_lang = strtoupper($module_type . '_' . $module_name . '_' . $submodule_title);
-
-						$_CLASS['core_template']->assign_vars_array("{$module_type}_subsection", array(
-							'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($module_lang))),
-							'S_SELECTED'	=> $selected,
-							'ADD_ITEM'		=> $this->add_menu_item($row['module_filename'], $submodule_title),
-							'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title . $suffix))
-						);
-
-						if ($selected)
-						{
-							$this->mode = $submodule_title;
-						}
-
-						$j++;
-					}
-				}
-			}
-
-			$i++;
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		if (!$module_id)
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-//$_CLASS['core_blocks']->load_blocks();
-$_CLASS['core_blocks']->blocks_loaded = true;
-
-		$data = array(
-			'block_title'		=> 'Forum Administration',
-			'block_position'	=> BLOCK_LEFT,
-			'block_file'		=> 'block-forums_mcp.php',
-		);
-
-		$_CLASS['core_blocks']->add_block($data);
-
-		$this->type = $module_type;
-		$this->id	= $module_id;
-		$this->name = $module_name;
-		$this->url = 'Forums&amp;file=mcp';
-		$this->url .= ($post_id) ? "&amp;p=$post_id" : '';
-		$this->url .= ($topic_id) ? "&amp;t=$topic_id" : '';
-		$this->url .= ($forum_id) ? "&amp;f=$forum_id" : '';
-	}
-
-	function load($type = false, $name = false, $mode = false, $run = true)
-	{
-		global $site_file_root;
-
-		if ($type)
-		{
-			$this->type = $type;
-		}
-
-		if ($name)
-		{
-			$this->name = $name;
-		}
-
-		if (!class_exists($this->type . '_' . $this->name))
-		{
-			require($site_file_root."includes/forums/{$this->type}/{$this->type}_{$this->name}.php");
-		}
-	}
-
-	// Add Item to Submodule Title
-	function add_menu_item($module_name, $mode)
-	{
-		global $_CLASS;
-
-		if ($module_name != 'queue')
-		{
-			return '';
-		}
-
-		$forum_id = request_var('f', 0);
-		if ($forum_id && $_CLASS['auth']->acl_get('m_approve', $forum_id))
-		{
-			$forum_list = array($forum_id);
-		}
-		else
-		{
-			$forum_list = get_forum_list('m_approve');
-		}
-
-		switch ($mode)
-		{
-			case 'unapproved_topics':
-
-				$sql = 'SELECT COUNT(*) AS total
-					FROM ' . FORUMS_TOPICS_TABLE . '
-					WHERE forum_id IN (' . implode(', ', $forum_list) . ')
-						AND topic_approved = 0';
-				$result = $_CLASS['core_db']->query($sql);
-				$row = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-
-				return ($row['total']) ? (int) $row['total'] : $_CLASS['core_user']->lang['NONE'];
-			break;
-
-			case 'unapproved_posts':
-
-				$sql = 'SELECT COUNT(*) AS total
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t 
-						WHERE p.forum_id IN (' . implode(', ', $forum_list) . ')
-							AND p.post_approved = 0
-							AND t.topic_id = p.topic_id
-							AND t.topic_first_post_id <> p.post_id';
-				$result = $_CLASS['core_db']->query($sql);
-				$row = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-
-				return ($row['total']) ? (int) $row['total'] : $_CLASS['core_user']->lang['NONE'];
-			break;
-		}
-	}
-}
-//
-// FUNCTIONS
-// ---------
-
 $_CLASS['core_user']->add_img();
 $_CLASS['core_user']->add_lang('mcp');
 
@@ -267,29 +43,19 @@
 	login_box(array('admin_login' => true, 'full_login' => false, 'explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_MCP']));
 }
 
-$mcp = new module();
-
-// Basic parameter data
-$mode	= request_var('mode', '');
-$module = request_var('i', '');
-
-// Make sure we are using the correct module
-if ($mode == 'approve' || $mode == 'disapprove')
+if (!$_CLASS['auth']->acl_get('m_'))
 {
-	$module = 'queue';
+	trigger_error('YOUR_NO_MODERATOR');
 }
 
-$quickmod = isset($_REQUEST['quickmod']);
-$action = request_var('action', '');
-/*
-$action_ary = request_var('action', array('' => 0));
+$mode	= get_variable('mode', 'REQUEST', 'front');
+$action = get_variable('action', 'REQUEST');
+$quick_mod = isset($_REQUEST['quickmod']);
 
-if (!empty($action_ary))
+if ($mode === 'approve' || $mode === 'disapprove')
 {
-	list($action, ) = each($action);
+	$module = 'queue';
 }
-unset($action_ary);
-*/
 
 if ($action == 'merge_select')
 {
@@ -312,69 +78,13 @@
 	$quickmod = false;
 }
 
-if (!$quickmod)
+if (!$quick_mod)
 {
-	$post_id = get_variable('p', 'REQUEST', false, 'int');
-	$topic_id = get_variable('t', 'REQUEST', false, 'int');
-	$forum_id = get_variable('f', 'REQUEST', false, 'int');
-
-	$url = 'Forums&amp;file=mcp';
-	$url .= ($post_id) ? "&amp;p=$post_id" : '';
-	$url .= ($topic_id) ? "&amp;t=$topic_id" : '';
-	$url .= ($forum_id) ? "&amp;f=$forum_id" : '';
-
-	if ($post_id)
-	{
-		// We determine the topic and forum id here, to make sure the moderator really has moderative rights on this post
-		$sql = 'SELECT topic_id, forum_id
-			FROM ' . FORUMS_POSTS_TABLE . "
-			WHERE post_id = $post_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$topic_id = (int) $row['topic_id'];
-		$forum_id = (int) $row['forum_id'];
-	}
-	elseif ($topic_id)
-	{
-		$sql = 'SELECT forum_id
-			FROM ' . FORUMS_TOPICS_TABLE . "
-			WHERE topic_id = $topic_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$forum_id = (int) $row['forum_id'];
-	}
-
-	if ($forum_id && !$_CLASS['auth']->acl_get('m_', $forum_id))
-	{
-		trigger_error('MODULE_NOT_EXIST');
-	}
-
-	if (!$forum_id && !$_CLASS['auth']->acl_get('m_'))
-	{
-		$forum_list = get_forum_list('m_');
-
-		if (empty($forum_list))
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-
-		// We do not check all forums, only the first one should be sufficiant.
-		$forum_id = $forum_list[0];
-	}
-
-// remove
-	// Instantiate module system and generate list of available modules
-	$mcp->create('mcp', 'Forums&amp;file=mcp', $post_id, $topic_id, $forum_id, $module);
-
 	switch ($mode)
 	{
 		case 'front':
 			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
-			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
+			//$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
 		break;
 
 		case 'forum_view':
@@ -483,16 +193,17 @@
 function get_post_data($post_ids, $acl_list = false)
 {
 	global $_CLASS;
+
 	$rowset = array();
 
 	$sql = 'SELECT p.*, u.*, t.*, f.*
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
-			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
+		FROM ' . FORUMS_POSTS_TABLE . ' p LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON (f.forum_id = p.forum_id),
+		' . USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
 		WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 			AND u.user_id = p.poster_id
 			AND t.topic_id = p.topic_id';
 	$result = $_CLASS['core_db']->query($sql);
-		
+
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		if ($acl_list && !$_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
@@ -721,7 +432,7 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	return empty($ids) ? false : $forum_ids;
+	return empty($ids) ? false : array_unique($forum_ids);
 }
 
 // LITTLE HELPER

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -484,15 +484,20 @@
 		$_CLASS['core_template']->assign_vars_array('topicrow', array(
 			'FORUM_ID' 			=> $forum_id,
 			'TOPIC_ID' 			=> $topic_id,
-			'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+
+			'AUTHOR' 			=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+			'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+
 			'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 			'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 			'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 			'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+
 			'PAGINATION'		=> $pagination['formated'],
 			'PAGINATION_ARRAY'	=> $pagination['array'],
+
 			'REPLIES' 			=> $replies,
-			'VIEWS' 			=> (int) $row['topic_views'],
+			'VIEWS' 			=> $row['topic_views'],
 			'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
 			'TOPIC_TYPE' 		=> $topic_type,
 
@@ -500,23 +505,27 @@
 			'NEWEST_POST_IMG' 	=> $newest_post_img,
 			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 			//'TOPIC_FOLDER_IMG_SRC'	=> $_CLASS['core_user']->img($folder_img, $folder_alt, false, '', 'src'),
-			'TOPIC_ICON_IMG'        => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['img'] : '',
-			'TOPIC_ICON_IMG_WIDTH'  => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['width'] : '',
-			'TOPIC_ICON_IMG_HEIGHT' => (!empty($icons[$row['icon_id']])) ? $icons[$row['icon_id']]['height'] : '',
-			'ATTACH_ICON_IMG'       => ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 
+			'TOPIC_ICON_IMG'        => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
+			'TOPIC_ICON_IMG_WIDTH'  => empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['width'],
+			'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['height'],
+	
+			'ATTACH_ICON_IMG'       => ($row['topic_attachment'] && $_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id)) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+
 			'S_TOPIC_TYPE'			=> $row['topic_type'], 
 			'S_UNREAD_TOPIC'		=> $unread_topic,
 
-			'S_TOPIC_REPORTED'		=> (!empty($row['topic_reported']) && $_CLASS['auth']->acl_get('m_', $forum_id)) ? true : false,
-			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_get('m_approve', $forum_id)) ? true : false,
+			'S_TOPIC_REPORTED'		=> ($row['topic_reported'] && $_CLASS['auth']->acl_get('m_report', $forum_id)),
+			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_get('m_approve', $forum_id)),
 
-			'U_LAST_POST'       => generate_link($view_topic_url . $SID . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id'], false, false, false),	
-			'U_LAST_POST_AUTHOR'=> ($_CLASS['core_user']->is_user && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+			'U_LAST_POST'       => generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
+			'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 			'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
-			'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;mode=reports&amp;t=$topic_id"),
+
+			'U_MCP_REPORT'		=> generate_link('Forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
 			'U_MCP_QUEUE'       => generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
-			'S_TOPIC_TYPE_SWITCH'   => ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
+
+			'S_TOPIC_TYPE_SWITCH'=> ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
 		);
 
 		$s_type_switch = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;

Modified: cms/trunk/modules/Quick_Message/ajax.php
===================================================================
--- cms/trunk/modules/Quick_Message/ajax.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Quick_Message/ajax.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -39,7 +39,7 @@
 switch ($mode)
 {
 	case 'ajax_refresh':
-		require_once($site_file_root.'modules/Quick_Message/functions.php');
+		require_once(SITE_FILE_ROOT.'modules/Quick_Message/functions.php');
 
 		echo qm_block_content();
 
@@ -110,7 +110,7 @@
 					die;
 				}
 
-				require($site_file_root.'includes/functions_user.php');
+				require(SITE_FILE_ROOT.'includes/functions_user.php');
 				$status = validate_username($user_name);
 
 				if ($status !== true)
@@ -130,7 +130,7 @@
 
 		$_CLASS['core_db']->query($sql);
 
-		require_once($site_file_root.'modules/Quick_Message/functions.php');
+		require_once(SITE_FILE_ROOT.'modules/Quick_Message/functions.php');
 
 		echo qm_block_content();
 

Modified: cms/trunk/modules/Quick_Message/functions.php
===================================================================
--- cms/trunk/modules/Quick_Message/functions.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Quick_Message/functions.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -35,7 +35,7 @@
 
 function qm_block_content()
 {
-	global $prefix, $_CLASS, $_CORE_CONFIG;
+	global $_CLASS, $_CORE_CONFIG;
 	
 	$content = '<div style="width: 100%; height: '.$_CORE_CONFIG['quick_message']['height'].'px; overflow: auto;">';
 	

Modified: cms/trunk/modules/Quick_Message/index.php
===================================================================
--- cms/trunk/modules/Quick_Message/index.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/Quick_Message/index.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -103,7 +103,7 @@
 						trigger_error('LONG_NAME');
 					}
 	
-					require($site_file_root.'includes/functions_user.php');
+					require(SITE_FILE_ROOT.'includes/functions_user.php');
 					$status = validate_username($user_name);
 
 					if ($status !== true)
@@ -192,7 +192,6 @@
 	));
 
 	$_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
-	script_close();
 }
 
 $delete_link = '';
@@ -271,7 +270,5 @@
 ));
 
 $_CLASS['core_display']->display(false, 'modules/Quick_Message/index.html');
-	
-script_close();
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/articles/configurator.php
===================================================================
--- cms/trunk/modules/articles/configurator.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/articles/configurator.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -26,7 +26,7 @@
     die;
 }
 
-global $prefix;
+global $table_prefix;
 
 if (!defined('ARTICLES_TABLE'))
 {

Modified: cms/trunk/modules/articles/index.php
===================================================================
--- cms/trunk/modules/articles/index.php	2005-09-21 18:04:46 UTC (rev 139)
+++ cms/trunk/modules/articles/index.php	2005-09-21 23:22:59 UTC (rev 140)
@@ -154,9 +154,8 @@
 $_CLASS['core_template']->assign_array(array(
 	'articles_pagination' 		=> $pagination['formated'],
 	'articles_pagination_array' => $pagination['array']
-
 ));
 
-$_CLASS['core_template']->display('modules/articles/index.html');
+$_CLASS['core_display']->display(false, 'modules/articles/index.html');
 
 ?>
\ No newline at end of file



From viperal at berlios.de  Thu Sep 22 06:21:51 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 22 Sep 2005 06:21:51 +0200
Subject: [Viperals-svncheckins] r141 - in cms/trunk: includes includes/forums includes/templates/modules/Forums install javascript/forums modules/Forums
Message-ID: <200509220421.j8M4Lpka028653@sheep.berlios.de>

Author: viperal
Date: 2005-09-22 06:21:44 +0200 (Thu, 22 Sep 2005)
New Revision: 141

Modified:
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/templates/modules/Forums/index_body.html
   cms/trunk/includes/templates/modules/Forums/viewforum_body.html
   cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html
   cms/trunk/install/build_data.php
   cms/trunk/javascript/forums/forum_view.js
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/viewforum.php
Log:
Topic and forum locking via ajax,
updated topic title ajax edit to check for permission.

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/includes/forums/functions_display.php	2005-09-22 04:21:44 UTC (rev 141)
@@ -319,6 +319,9 @@
 			//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $row['forum_image'] : $_CLASS['core_user']->img($folder_image, $folder_alt, false, '', 'src'),
 			'FORUM_NAME'		=> $row['forum_name'],
 			'FORUM_DESC'		=> $row['forum_desc'], 
+			'FORUM_LOCKED' 		=> ($row['forum_status'] == ITEM_LOCKED) ? 1 : 0,
+
+			
 			$l_post_click_count	=> $post_click_count,
 			'TOPICS'			=> $row['forum_topics'],
 			'LAST_POST_TIME'	=> $last_post_time,
@@ -346,27 +349,27 @@
 	return $active_forum_ary;
 }
 
-function topic_status(&$topic_row, $replies, $mark_time, &$folder_img, &$folder_alt, &$topic_type)
+function topic_status(&$topic_row, $replies, $mark_time, &$unread, &$folder_img, &$folder_alt, &$topic_type)
 {
 	global $_CLASS, $config;
-	
+
 	$folder = $folder_new = '';
-	$unread_topic = false;
+	$unread = ($mark_time < $topic_row['topic_last_post_time']);
 
 	if ($topic_row['topic_status'] == ITEM_MOVED)
 	{
 		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
 		$folder_img = 'folder_moved';
 		$folder_alt = 'VIEW_TOPIC_MOVED';
+		$status = 9;
 	}
 	else
 	{
 		if ($topic_row['topic_status'] == ITEM_LOCKED)
 		{
 			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
-			$folder = 'folder_locked';
-			$folder_new = 'folder_locked_new';
-			
+			$folder_img = ($unread) ? 'folder_locked_new' :'folder_locked';
+			$status = ($unread) ? 11 : 10;
 		}
 		else
 		{
@@ -375,40 +378,32 @@
 				case POST_GLOBAL:
 				case POST_ANNOUNCE:
 					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
-					$folder = 'folder_announce';
-					$folder_new = 'folder_announce_new';
-					break;
+					$folder_img = ($unread) ? 'folder_announce_new' : 'folder_announce';
+					$status = ($unread) ? 8 : 7;
+				break;
 	
 				case POST_STICKY:
 					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
-					$folder = 'folder_sticky';
-					$folder_new = 'folder_sticky_new';
-					break;
+					$folder_img = ($unread) ? 'folder_sticky_new' : 'folder_sticky';
+					$status = ($unread) ? 6 : 5;
+				break;
 	
 				default:
 					if ($replies >= $config['hot_threshold'])
 					{
-						$folder = 'folder_hot';
-						$folder_new = 'folder_hot_new';
+						$folder_img = ($unread) ? 'folder_hot_new': 'folder_hot';
+						$status = ($unread) ? 4 : 3;
 					}
 					else
 					{
-						$folder = 'folder';
-						$folder_new = 'folder_new';
+						$folder_img = ($unread) ? 'folder_new' : 'folder';
+						$status = ($unread) ? 2 : 1;
 					}
-					break;
+				break;
 			}
 		}
 
-		$unread_topic = true;
-
-		if ($mark_time >= $topic_row['topic_last_post_time'])
-		{
-			$unread_topic = false;
-		}
-
-		$folder_img = ($unread_topic) ? $folder_new : $folder;
-		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+		$folder_alt = ($unread) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
 	}
 
 	if ($topic_row['poll_start'])
@@ -416,7 +411,7 @@
 		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
 	}
 
-	return $unread_topic;
+	return $status;
 }
 
 // Display Attachments

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/includes/functions_user.php	2005-09-22 04:21:44 UTC (rev 141)
@@ -153,6 +153,21 @@
 		'user_allow_email'		=> 1,
 	);
 
+	$default_data['user_data'] = serialize(array(
+		'viewimg' => 1,
+		'viewflash' => 1,
+		'viewsmilies' => 1,
+		'viewsigs'	=> 1,
+		'viewavatars' => 1,
+		'viewcensors' => 1,
+
+		'bbcode' => 1,
+		'html'	=> 1,
+		'smilies' => 1,
+		'attachsig' => 1,
+		'html'	=> 1,
+	));
+
 	$data = array_merge($default_data, $data);
 
 // add a required array here, then find feilds that are not in the data array

Modified: cms/trunk/includes/templates/modules/Forums/index_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-22 04:21:44 UTC (rev 141)
@@ -35,7 +35,7 @@
 	</tr>
 	<!-- ELSE -->
 	<tr>
-		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
+		<td class="row1" width="50" height="40" align="center" id="forum_folder_status_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } --> onmouseover="lock_unlock_init('{ $forumrow:FORUM_ID }', 'forum', { $forumrow:FORUM_LOCKED });" <!-- ENDIF -->>{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a>
 			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p>
@@ -157,10 +157,10 @@
 		<td width="20" align="center">{ $FORUM_NEW_IMG }</td>
 		<td><span class="gensmall">{ $L_NEW_POSTS }</span></td>
 		<td>&nbsp;&nbsp;</td>
-		<td width="20" align="center">{ $FORUM_IMG }</td>
+		<td width="20" align="center" id="forum_unlocked_status">{ $FORUM_IMG }</td>
 		<td><span class="gensmall">{ $L_NO_NEW_POSTS }</span></td>
 		<td>&nbsp;&nbsp;</td>
-		<td width="20" align="center">{ $FORUM_LOCKED_IMG }</td>
+		<td width="20" align="center" id="forum_locked_status">{ $FORUM_LOCKED_IMG }</td>
 		<td><span class="gensmall">{ $L_FORUM_LOCKED }</span></td>
 	</tr>
 </table>

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_body.html	2005-09-22 04:21:44 UTC (rev 141)
@@ -35,7 +35,7 @@
 
 	<!-- LOOP $topicrow -->
 	<tr>
-		<td class="row1" align="center" width="25">{ $topicrow:TOPIC_FOLDER_IMG }</td>
+		<td class="row1" align="center" width="25" id="topic_folder_status_{ $topicrow:TOPIC_ID }">{ $topicrow:TOPIC_FOLDER_IMG }</td>
 		<!-- IF { $S_TOPIC_ICONS } -->
 		<td class="row1" align="center" width="25"><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /></td>
 		<!-- ENDIF -->
@@ -159,11 +159,11 @@
 	</tr>
 	<!-- ENDIF -->
 	<tr>
-		<td class="row1" align="center" width="25">{ $topicrow:TOPIC_FOLDER_IMG }</td>
+		<td class="row1" align="center" width="25" id="topic_folder_status_{ $topicrow:TOPIC_ID }" <!-- IF { $MOD_TOPIC_LOCK } --> onmouseover="lock_unlock_init('{ $topicrow:TOPIC_ID }', 'topic', { $topicrow:TOPIC_LOCKED });" <!-- ENDIF -->>{ $topicrow:TOPIC_FOLDER_IMG }</td>
 		<!-- IF { $S_TOPIC_ICONS } -->
 		<td class="row1" align="center" width="25"><!-- IF { $topicrow:TOPIC_ICON_IMG } --><img src="{ $T_ICONS_PATH }{ $topicrow:TOPIC_ICON_IMG }" width="{ $topicrow:TOPIC_ICON_IMG_WIDTH }" height="{ $topicrow:TOPIC_ICON_IMG_HEIGHT }" alt="" title="" /><!-- ENDIF --></td>
 		<!-- ENDIF -->
-		<td class="row1" id="topic_{ $topicrow:TOPIC_ID }" onmouseover="tite_edit_init('{ $topicrow:TOPIC_ID }', 'topic');">
+		<td class="row1" id="topic_{ $topicrow:TOPIC_ID }" <!-- IF { $MOD_TOPIC_TITLE } --> onmouseover="tite_edit_init('{ $topicrow:TOPIC_ID }', 'topic');" <!-- ENDIF -->>
 			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
 				<a href="{ $topicrow:U_MCP_QUEUE }">{ $UNAPPROVED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
@@ -258,40 +258,58 @@
 
 <table width="100%" cellspacing="0">
 	<tr>
-		<td align="left" valign="top"><table cellspacing="3" cellpadding="0" border="0">
-			<tr>
-				<td width="20" align="left">{ $FOLDER_NEW_IMG }</td>
-				<td class="gensmall">{ $L_NEW_POSTS }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td width="20" align="center">{ $FOLDER_IMG }</td>
-				<td class="gensmall">{ $L_NO_NEW_POSTS }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td width="20" align="center">{ $FOLDER_ANNOUNCE_IMG }</td>
-				<td class="gensmall">{ $L_ICON_ANNOUNCEMENT }</td>
-			</tr>
-			<tr>
-				<td width="20" align="center">{ $FOLDER_HOT_NEW_IMG }</td>
-				<td class="gensmall">{ $L_NEW_POSTS_HOT }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td width="20" align="center">{ $FOLDER_HOT_IMG }</td>
-				<td class="gensmall">{ $L_NO_NEW_POSTS_HOT }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td width="20" align="center">{ $FOLDER_STICKY_IMG }</td>
-				<td class="gensmall">{ $L_ICON_STICKY }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $FOLDER_LOCKED_NEW_IMG }</td>
-				<td class="gensmall">{ $L_NEW_POSTS_LOCKED }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td class="gensmall">{ $FOLDER_LOCKED_IMG }</td>
-				<td class="gensmall">{ $L_NO_NEW_POSTS_LOCKED }</td>
-				<td>&nbsp;&nbsp;</td>
-				<td width="20" align="center">{ $FOLDER_MOVED_IMG }</td>
-				<td class="gensmall">{ $L_MOVED_TOPIC }</td>
-			</tr>
-		</table>
+		<td align="left" valign="top">
+			<table cellspacing="3" cellpadding="0" border="0">
+				<tr>
+					<td align="center">{ $FOLDER_NEW_IMG }</td>
+					<td class="gensmall">{ $L_NEW_POSTS }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center" id="topic_unlocked_status">{ $FOLDER_IMG }</td>
+					<td class="gensmall">{ $L_NO_NEW_POSTS }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center">{ $FOLDER_ANNOUNCE_IMG }</td>
+					<td class="gensmall">{ $L_ICON_ANNOUNCEMENT }</td>
+				</tr>
+				<tr>
+					<td align="center">{ $FOLDER_HOT_NEW_IMG }</td>
+					<td class="gensmall">{ $L_NEW_POSTS_HOT }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center">{ $FOLDER_HOT_IMG }</td>
+					<td class="gensmall">{ $L_NO_NEW_POSTS_HOT }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center">{ $FOLDER_STICKY_IMG }</td>
+					<td class="gensmall">{ $L_ICON_STICKY }</td>
+				</tr>
+				<tr>
+					<td class="gensmall" align="center">{ $FOLDER_LOCKED_NEW_IMG }</td>
+					<td class="gensmall">{ $L_NEW_POSTS_LOCKED }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td class="gensmall" align="center" id="topic_locked_status">{ $FOLDER_LOCKED_IMG }</td>
+					<td class="gensmall">{ $L_NO_NEW_POSTS_LOCKED }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center">{ $FOLDER_MOVED_IMG }</td>
+					<td class="gensmall">{ $L_MOVED_TOPIC }</td>
+				</tr>
+				<!-- IF { $S_HAS_SUBFORUM } -->
+				<tr>
+					<td colspan="8" align="center">
+						<br/><b>Forums Status Legend</b>
+					</td>
+				</tr>
+				<tr>
+					<td align="center">{ $FORUM_NEW_IMG }</td>
+					<td class="gensmall">{ $L_NEW_POSTS }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center" id="forum_unlocked_status">{ $FORUM_IMG }</td>
+					<td class="gensmall">{ $L_NO_NEW_POSTS }</td>
+					<td>&nbsp;&nbsp;</td>
+					<td align="center" id="forum_locked_status">{ $FORUM_LOCKED_IMG }</td>
+					<td class="gensmall">{ $L_FORUM_LOCKED }</td>
+				</tr>
+				<!-- ENDIF -->
+			</table>
 		</td>
-		<td align="right">
+		<td valign="top" align="right">
 			<span class="gensmall">
 			<!-- LOOP $rules -->{ $rules:RULE }<br /><!-- ENDLOOP -->
 			</span>
@@ -299,6 +317,8 @@
 	</tr>
 </table>
 <!-- ENDIF -->
+
+
 <br clear="all" />
 
 <table width="100%" cellspacing="0">

Modified: cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/includes/templates/modules/Forums/viewforum_subforum.html	2005-09-22 04:21:44 UTC (rev 141)
@@ -10,8 +10,7 @@
 		<th width="50" nowrap="nowrap">&nbsp;{ $L_POSTS }&nbsp;</th>
 		<th nowrap="nowrap">&nbsp;{ $L_LAST_POST }&nbsp;</th>
 	</tr>
-	<!-- LOOP $forumrow -->
-	
+<!-- LOOP $forumrow -->
 	<!-- IF { $forumrow:S_IS_CAT } -->
 	<tr>
 		<td class="cat" colspan="2"><a class="cattitle" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></td>
@@ -34,7 +33,7 @@
 	</tr>
 	<!-- ELSE -->
 	<tr>
-		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
+		<td class="row1" width="50" height="40" align="center" id="forum_folder_status_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } --> onmouseover="lock_unlock_init('{ $forumrow:FORUM_ID }', 'forum', { $forumrow:FORUM_LOCKED });" <!-- ENDIF -->>{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<td class="row1" width="100%" height="40"  id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF -->>
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
 			<!-- IF { $forumrow:FORUM_DESC } -->
@@ -58,7 +57,7 @@
 		</td>
 	</tr>
 	<!-- ENDIF -->
-	<!-- ENDLOOP $forumrow -->
+<!-- ENDLOOP $forumrow -->
 </table>
 
 <br clear="all" />
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/install/build_data.php	2005-09-22 04:21:44 UTC (rev 141)
@@ -159,10 +159,23 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
-$admin_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
-$guest_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
-$bot_data = $_CLASS['core_db']->escape('a:6:{s:7:"viewimg";b:1;s:9:"viewflash";b:1;s:11:"viewsmilies";b:1;s:8:"viewsigs";b:1;s:11:"viewavatars";b:1;s:11:"viewcensors";b:1;}');
+$data = serialize(array(
+	'viewimg' => 1,
+	'viewflash' => 1,
+	'viewsmilies' => 1,
+	'viewsigs'	=> 1,
+	'viewavatars' => 1,
+	'viewcensors' => 1,
 
+	'bbcode' => 1,
+	'html'	=> 1,
+	'smilies' => 1,
+	'attachsig' => 1,
+	'html'	=> 1,
+));
+
+$admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
+
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");

Modified: cms/trunk/javascript/forums/forum_view.js
===================================================================
--- cms/trunk/javascript/forums/forum_view.js	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/javascript/forums/forum_view.js	2005-09-22 04:21:44 UTC (rev 141)
@@ -1,12 +1,65 @@
 // By Ryan Marshall ( viperal1 at gmail.com )
 //svn checkout svn://svn.berlios.de/viperals/cms/trunk /net/pork/export/nfs/home/groups/viperals/htdocs
+
+function lock_unlock_init(id, mode, status)
+{
+	var area = document.getElementById(mode + '_folder_status_' + id);
+
+	if (!area)
+	{
+		return;
+	}
+
+	area.onmouseover = '';
+	area.ondblclick = function()
+	{
+		lock_unlock(id, mode, status);
+	}
+}
+
+// make this support more than 1 id
+function lock_unlock(id, mode, status)
+{
+	var area = document.getElementById(mode + '_folder_status_' + id);
+
+	ajax = new core_ajax();
+	var lock = (status) ? 0 : 1;
+
+	var onreadystatechange = function()
+	{
+		if (ajax.state_ready() && ajax.responseText())
+		{
+			if (ajax.responseText() == 'unlock')
+			{ 
+				var new_status = 0;
+				var status = document.getElementById(mode +'_unlocked_status');
+			}
+			else
+			{
+				var new_status = 1;
+				var status = document.getElementById(mode +'_locked_status');
+			}
+
+			area.innerHTML = status.innerHTML;
+			area.ondblclick = function()
+			{
+				lock_unlock(id, mode, new_status);
+			}
+		}
+	}
+
+	ajax.onreadystatechange(onreadystatechange);
+
+	ajax.send('ajax.php?mod=Forums', '&mode=' + mode + '_lock_unlock&lock=' + lock + '&id=' + id);
+}
+
 function tite_edit_init(id, mode)
 {
-	var area = document.getElementById(mode + '_' + id)
+	var area = document.getElementById(mode + '_' + id);
 
 	if (!area)
 	{
-		return
+		return;
 	}
 
 	area.onmouseover = '';

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-22 04:21:44 UTC (rev 141)
@@ -79,6 +79,55 @@
 
 		echo $title;
 	break;
+	
+	case 'topic_lock_unlock':
+		$topic_id = get_variable('id', 'POST', false, 'int');
+		$lock = get_variable('lock', 'POST', 0, 'int');
+
+		if (!$topic_id)
+		{
+			die;
+		}
+
+		$result = $_CLASS['core_db']->query('SELECT forum_id FROM ' . FORUMS_TOPICS_TABLE . ' WHERE topic_id = '.$topic_id);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$row || !$_CLASS['auth']->acl_get('m_lock', $row['forum_id']))
+		{
+			die;
+		}
+
+		$status = ($lock) ? ITEM_LOCKED : ITEM_UNLOCKED;
+		//	WHERE topic_id IN (" . implode(', ', $topic_id) . ")";
+
+		$sql = 'UPDATE '. FORUMS_TOPICS_TABLE ." 
+			SET topic_status = $status
+			WHERE topic_id = $topic_id";
+		$_CLASS['core_db']->query($sql);
+
+		echo ($lock) ? 'lock' : 'unlock';
+	break;
+	
+	case 'forum_lock_unlock':
+		$forum_id = get_variable('id', 'POST', false, 'int');
+		$lock = get_variable('lock', 'POST', 0, 'int');
+
+		if (!$forum_id || !$_CLASS['auth']->acl_get('a_forum', $forum_id))
+		{
+			die;
+		}
+
+		$status = ($lock) ? ITEM_LOCKED : ITEM_UNLOCKED;
+		//	WHERE topic_id IN (" . implode(', ', $topic_id) . ")";
+
+		$sql = 'UPDATE '. FORUMS_FORUMS_TABLE ." 
+			SET forum_status = $status
+			WHERE forum_id = $forum_id";
+		$_CLASS['core_db']->query($sql);
+
+		echo ($lock) ? 'lock' : 'unlock';
+	break;
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-21 23:22:59 UTC (rev 140)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-22 04:21:44 UTC (rev 141)
@@ -202,7 +202,8 @@
 /*
 Need test this first
 // Do the forum Prune thang - cron type job ...
-if ($forum_data['prune_next'] < time() && $forum_data['enable_prune'])
+
+if ($forum_data['enable_prune'] && $forum_data['prune_next'] < $_CLASS['core_user']->time)
 {
 	require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 
@@ -220,7 +221,7 @@
 
 if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
 {
-	$notify_status = (isset($forum_data['notify_status'])) ? $forum_data['notify_status'] : NULL;
+	$notify_status = isset($forum_data['notify_status']) ? $forum_data['notify_status'] : null;
 	$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, 0, $notify_status);
 }
 else
@@ -244,7 +245,7 @@
 // Limit topics to certain time frame, obtain correct topic count
 if ($sort_days)
 {
-	$min_post_time = time() - ($sort_days * 86400);
+	$min_post_time = $_CLASS['core_user']->time - ($sort_days * 86400);
 
 	$sql = 'SELECT COUNT(topic_id) AS num_topics
 		FROM ' . FORUMS_TOPICS_TABLE . "
@@ -288,6 +289,14 @@
 	'MODERATORS'		=> empty($moderators[$forum_id]) ? '' : implode(', ', $moderators[$forum_id]),
 
 	'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
+
+	'MOD_TOPIC_LOCK'	=>	$_CLASS['auth']->acl_get('m_lock', $forum_id),
+	'MOD_TOPIC_TITLE'	=>	$_CLASS['auth']->acl_get('m_', $forum_id),
+
+	'FORUM_IMG'			=>	$_CLASS['core_user']->img('forum', 'NO_NEW_POSTS'),
+	'FORUM_NEW_IMG'		=>	$_CLASS['core_user']->img('forum_new', 'NEW_POSTS'),
+	'FORUM_LOCKED_IMG'	=>	$_CLASS['core_user']->img('forum_locked', 'NO_NEW_POSTS_LOCKED'),
+
 	'FOLDER_IMG' 			=> $_CLASS['core_user']->img('folder', 'NO_NEW_POSTS'),
 	'FOLDER_NEW_IMG' 		=> $_CLASS['core_user']->img('folder_new', 'NEW_POSTS'),
 	'FOLDER_HOT_IMG' 		=> $_CLASS['core_user']->img('folder_hot', 'NO_NEW_POSTS_HOT'),
@@ -466,13 +475,15 @@
 
 		if ($row['topic_status'] == ITEM_MOVED)
 		{
+// currently no marking supported
 			$topic_id = $row['topic_moved_id'];
 		}
 
 		// Get folder img, topic status/type related informations
 		$folder_img = $folder_alt = $topic_type = '';
-		$unread_topic = topic_status($row, $replies, $mark_time, $folder_img, $folder_alt, $topic_type);
-		
+	//	$status = topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+		topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+
 		$newest_post_img = ($unread_topic) ? '<a href="' . generate_link("Forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread") . '">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
 		// Generate all the URIs ...
@@ -501,6 +512,8 @@
 			'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
 			'TOPIC_TYPE' 		=> $topic_type,
 
+			'TOPIC_LOCKED' 		=> ($row['topic_status'] == ITEM_LOCKED) ? 1 : 0,
+
 			'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 			'NEWEST_POST_IMG' 	=> $newest_post_img,
 			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),



From viperal at berlios.de  Thu Sep 22 18:52:02 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 22 Sep 2005 18:52:02 +0200
Subject: [Viperals-svncheckins] r142 - in cms/trunk: includes includes/forums includes/templates/modules/Control_Panel modules/Control_Panel/ucp modules/Forums
Message-ID: <200509221652.j8MGq25m003446@sheep.berlios.de>

Author: viperal
Date: 2005-09-22 18:51:53 +0200 (Thu, 22 Sep 2005)
New Revision: 142

Modified:
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_viewfolder.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_sideblock.html
   cms/trunk/includes/user.php
   cms/trunk/modules/Control_Panel/ucp/ucp_main.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/modules/Forums/viewtopic.php
Log:


/usr/local/bin/commit-email.pl: `/usr/bin/svnlook diff /svnroot/repos/viperals -r 142' failed with this output:
Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================


From viperal at berlios.de  Wed Sep 28 01:58:03 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 01:58:03 +0200
Subject: [Viperals-svncheckins] r143 - in cms/trunk: includes includes/db includes/display includes/forums includes/forums/mcp includes/templates includes/templates/en/email includes/templates/en/email/members_list includes/templates/modules/Contact includes/templates/modules/Control_Panel includes/templates/modules/Forums includes/templates/modules/Members_List includes/templates/modules/Quick_Message install javascript modules/Control_Panel modules/Control_Panel/ucp modules/Forums modules/Forums/admin modules/Members_List
Message-ID: <200509272358.j8RNw3gq020637@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 01:57:50 +0200 (Wed, 28 Sep 2005)
New Revision: 143

Added:
   cms/trunk/includes/templates/en/email/members_list/
   cms/trunk/includes/templates/en/email/members_list/email_notify.txt
   cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt
Modified:
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/templates/confirmation.html
   cms/trunk/includes/templates/login_body.html
   cms/trunk/includes/templates/modules/Contact/index.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html
   cms/trunk/includes/templates/modules/Forums/overall_footer.html
   cms/trunk/includes/templates/modules/Forums/overall_header.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html
   cms/trunk/includes/templates/modules/Members_List/memberlist_header.html
   cms/trunk/includes/templates/modules/Quick_Message/index.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/common.js
   cms/trunk/javascript/menu.js
   cms/trunk/modules/Control_Panel/index.php
   cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
   cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
   cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
   cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
   cms/trunk/modules/Control_Panel/ucp/ucp_register.php
   cms/trunk/modules/Forums/admin/index.php
   cms/trunk/modules/Forums/ajax.php
   cms/trunk/modules/Forums/index.php
   cms/trunk/modules/Forums/mcp.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/search.php
   cms/trunk/modules/Forums/viewtopic.php
   cms/trunk/modules/Members_List/index.php
Log:


Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/db/postgres.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -465,30 +465,32 @@
 
 		if (function_exists('pg_version'))
 		{
-			$version = pg_version($this->link_identifier);
-			return $version['server'];	
-		}
-		else
-		{
-			$result = $this->query('SELECT VERSION() AS version');
-			$row = $this->fetch_row_assoc($result);
-			$this->free_result($result);
+			$version = pg_version($this->link_identifier);
 
-			if (!$row)
+			if (isset($version['server']))
 			{
-				return;
-			}
-
-			if ($return_dbname)
-			{	// should we return the full info ?
-				return $row['version'];
-			}
-			else
-			{
-				$version = explode(' ', $row['version']);
-				return $version[1];
+				return $version['server'];
 			}
 		}
+
+		$result = $this->query('SELECT VERSION() AS version');
+		$row = $this->fetch_row_assoc($result);
+		$this->free_result($result);
+
+		if (!$row)
+		{
+			return;
+		}
+
+		if ($return_dbname)
+		{	// should we return the full info ?
+			return $row['version'];
+		}
+		else
+		{
+			$version = explode(' ', $row['version']);
+			return $version[1];
+		}
 	}
 
 	function _debug($mode, $backtrace)

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/display/display.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -169,7 +169,7 @@
 
 		$this->header['regular'][] = '<link rel="alternate" type="application/xml" title="RSS" href="'.generate_base_url().'feed.php?feed=rdf" />';
 
-		if ($_CORE_CONFIG['maintenance']['active'] && $_CORE_CONFIG['maintenance']['start'] < time())
+		if ($_CORE_CONFIG['maintenance']['active'] && $_CORE_CONFIG['maintenance']['start'] < $_CLASS['core_user']->time)
 		{
 			$this->message = '<b>System is in maintenance mode</b><br />';
 		}

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/auth.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -30,7 +30,7 @@
 
 // Will be keeping my eye of 'other products' to ensure these things don't
 // mysteriously appear elsewhere, think up your own solutions!
-class auth
+class forums_auth
 {
 	var $founder = false;
 	var $acl = array();
@@ -121,10 +121,12 @@
 
 	function acl_getf($opt)
 	{
-		static $cache;
+		$cache = false;
 
 		if (isset($this->acl_options['local'][$opt]))
 		{
+			$cache = array();
+
 			foreach ($this->acl as $f => $bitstring)
 			{
 				if (!isset($cache[$f][$opt]))
@@ -132,6 +134,7 @@
 					$cache[$f][$opt] = false;
 
 					$cache[$f][$opt] = $bitstring{$this->acl_options['local'][$opt]};
+
 					if (isset($this->acl_options['global'][$opt]))
 					{
 						$cache[$f][$opt] |= $this->acl[0]{$this->acl_options['global'][$opt]};

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/functions_admin.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -113,19 +113,19 @@
 }
 
 // Obtain authed forums list
-function get_forum_list($acl_list = 'f_list', $id_only = TRUE, $postable_only = FALSE, $no_cache = FALSE)
+function get_forum_list($acl_list = 'f_list', $id_only = true, $postable_only = false)
 {
 	global $_CLASS;
 	static $forum_rows;
+	
+//print_r($_CLASS['forums_auth']->acl_getf('f_read'));
 
-	if (!isset($forum_rows))
+	if (empty($forum_rows))
 	{
 		// This query is identical to the jumpbox one
-		$expire_time = ($no_cache) ? 0 : 120;
 		$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			ORDER BY left_id ASC';
-		$result = $_CLASS['core_db']->query($sql, $expire_time);
+			FROM ' . FORUMS_FORUMS_TABLE . ' ORDER BY left_id ASC';
+		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
@@ -135,6 +135,7 @@
 	}
 
 	$rowset = array();
+
 	foreach ($forum_rows as $row)
 	{
 		if ($postable_only && $row['forum_type'] != FORUM_POST)
@@ -142,7 +143,7 @@
 			continue;
 		}
 
-		if ($acl_list == '' || ($acl_list != '' && $_CLASS['auth']->acl_gets($acl_list, $row['forum_id'])))
+		if (!$acl_list || $_CLASS['auth']->acl_gets($acl_list, $row['forum_id']))
 		{
 			$rowset[] = ($id_only) ? $row['forum_id'] : $row;
 		}
@@ -375,6 +376,7 @@
 	$_CLASS['core_db']->transaction();
 
 	$table_ary = array(FORUMS_TRACK_TABLE, FORUMS_POLL_VOTES_TABLE, FORUMS_POLL_OPTIONS_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE);
+
 	foreach ($table_ary as $table)
 	{
 		$sql = "DELETE FROM $table 
@@ -990,7 +992,7 @@
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
-			break;
+		break;
 
 		case 'topic_attachment':
 			if ($sync_extra)
@@ -1859,9 +1861,9 @@
 }
 
 // Extension of auth class for changing permissions
-if (class_exists('auth'))
+if (class_exists('forums_auth'))
 {
-	class auth_admin extends auth
+	class auth_admin extends forums_auth
 	{
 		// Set a user or group ACL record
 		function acl_set($ug_type, &$forum_id, &$ug_id, &$auth)

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,1451 +1,1489 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_privmsgs.php,v 1.7 2004/09/16 18:33:20 acydburn Exp $
-//
-// FILENAME  : functions_privmsgs.php
-// STARTED   : Sun Apr 18, 2004
-// COPYRIGHT : ? 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-// Define Rule processing schema
-// NOTE: might change
-
-/*
-	Ability to simply add own rules by doing three things:
-		1) Add an appropiate constant
-		2) Add a new check array to the global_privmsgs_rules variable and the condition array (if one is required)
-		3) Add a new language variable to ucp.php
-		
-		The user is then able to select the new rule. It will be checked against and handled as specified.
-		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
-*/
-
-define('RULE_IS_LIKE', 1); // Is Like
-define('RULE_IS_NOT_LIKE', 2); // Is Not Like
-define('RULE_IS', 3); // Is
-define('RULE_IS_NOT', 4); // Is Not
-define('RULE_BEGINS_WITH', 5); // Begins with
-define('RULE_ENDS_WITH', 6); // Ends with
-define('RULE_IS_FRIEND', 7); // Is Friend
-define('RULE_IS_FOE', 8); // Is Foe
-define('RULE_IS_USER', 9); // Is User
-define('RULE_IS_GROUP', 10); // Is In Usergroup
-define('RULE_ANSWERED', 11); // Answered
-define('RULE_FORWARDED', 12); // Forwarded
-define('RULE_REPORTED', 13); // Reported
-define('RULE_TO_GROUP', 14); // Usergroup
-define('RULE_TO_ME', 15); // Me
-
-define('ACTION_PLACE_INTO_FOLDER', 1);
-define('ACTION_MARK_AS_READ', 2);
-define('ACTION_MARK_AS_IMPORTANT', 3);
-define('ACTION_DELETE_MESSAGE', 4);
-
-define('CHECK_SUBJECT', 1);
-define('CHECK_SENDER', 2);
-define('CHECK_MESSAGE', 3);
-define('CHECK_STATUS', 4);
-define('CHECK_TO', 5);
-
-$global_privmsgs_rules = array(
-	CHECK_SUBJECT	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'message_subject', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'message_subject', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'message_subject', 'function' => '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=> array('check0' => 'message_subject', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_ENDS_WITH		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})')),
-
-	CHECK_SENDER	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'username', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'username', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'username', 'function' => '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=> array('check0' => 'username', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_ENDS_WITH		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})'),
-		RULE_IS_FRIEND		=> array('check0' => 'friend', 'function' => '{CHECK0} == 1'),
-		RULE_IS_FOE			=> array('check0' => 'foe', 'function' => '{CHECK0} == 1'),
-		RULE_IS_USER		=> array('check0' => 'author_id', 'function' => '{CHECK0} == {USER_ID}'),
-		RULE_IS_GROUP       => array('check0' => 'author_in_group', 'function' => 'in_array({GROUP_ID}, {CHECK0})')),
-
-	CHECK_MESSAGE	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'message_text', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'message_text', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'message_text', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'message_text', 'function' => '{CHECK0} != {STRING}')),
-		
-	CHECK_STATUS	=> array(
-		RULE_ANSWERED		=> array('check0' => 'replied', 'function' => '{CHECK0} == 1'),
-		RULE_FORWARDED		=> array('check0' => 'forwarded', 'function' => '{CHECK0} == 1'),
-		RULE_REPORTED		=> array('check0' => 'message_reported', 'function' => '{CHECK0} == 1')),
-		
-	CHECK_TO		=> array(
-		RULE_TO_GROUP		=> array('check0' => 'to', 'check1' => 'bcc', 'check2' => 'user_in_group', 'function' => 'in_array("g_" . {CHECK2}, {CHECK0}) || in_array("g_" . {CHECK2}, {CHECK1})'),
-		RULE_TO_ME			=> array('check0' => 'to', 'check1' => 'bcc', 'function' => 'in_array("u_" . $user_id, {CHECK0}) || in_array("u_" . $user_id, {CHECK1})'))
-);
-
-// This is for defining which condition fields to show for which Rule
-$global_rule_conditions = array(
-	RULE_IS_LIKE		=> 'text',
-	RULE_IS_NOT_LIKE	=> 'text',
-	RULE_IS				=> 'text',
-	RULE_IS_NOT			=> 'text',
-	RULE_BEGINS_WITH	=> 'text',
-	RULE_ENDS_WITH		=> 'text',
-	RULE_IS_USER		=> 'user',
-	RULE_IS_GROUP		=> 'group'
-);
-
-// Get all folder
-function get_folder($user_id, &$folder, $folder_id = false)
-{
-	global $_CLASS;
-
-	if (!is_array($folder))
-	{
-		$folder = array();
-	}
-
-	// Get folder informations
-	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-		WHERE user_id = $user_id
-			AND folder_id <> " . PRIVMSGS_NO_BOX . '
-		GROUP BY folder_id';
-	$result = $_CLASS['core_db']->query($sql);
-
-	$num_messages = $num_unread = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$num_messages[(int) $row['folder_id']] = $row['num_messages'];
-		$num_unread[(int) $row['folder_id']] = $row['num_unread'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// Make sure the default boxes are defined
-	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
-	foreach ($folder_array as $default_folder)
-	{
-		if (!isset($num_messages[$default_folder]))
-		{
-			$num_messages[$default_folder] = 0;
-		}
-
-		if (!isset($num_unread[$default_folder]))
-		{
-			$num_unread[$default_folder] = 0;
-		}
-	}
-
-	// Adjust unread status for outbox
-	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
-	
-	$folder[PRIVMSGS_INBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_INBOX'], 'num_messages' => $num_messages[PRIVMSGS_INBOX], 'unread_messages' => $num_unread[PRIVMSGS_INBOX]);
-
-	// Custom Folder
-	$sql = 'SELECT folder_id, folder_name, pm_count
-		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
-			WHERE user_id = $user_id";
-	$result = $_CLASS['core_db']->query($sql);
-			
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$folder[$row['folder_id']] = array('folder_name' => $row['folder_name'], 'num_messages' => $row['pm_count'], 'unread_messages' => ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$folder[PRIVMSGS_OUTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_OUTBOX'], 'num_messages' => $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' => $num_unread[PRIVMSGS_OUTBOX]);
-	$folder[PRIVMSGS_SENTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_SENTBOX'], 'num_messages' => $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' => $num_unread[PRIVMSGS_SENTBOX]);
-
-	// Define Folder Array for template designers (and for making custom folders usable by the template too)
-	foreach ($folder as $f_id => $folder_ary)
-	{
-		$_CLASS['core_template']->assign_vars_array('folder', array(
-			'FOLDER_ID'			=> $f_id,
-			'FOLDER_NAME'		=> $folder_ary['folder_name'],
-			'NUM_MESSAGES'		=> $folder_ary['num_messages'],
-			'UNREAD_MESSAGES'	=> $folder_ary['unread_messages'],
-
-			'S_CUR_FOLDER'		=> ($f_id == $folder_id) ? true : false,
-			'S_UNREAD_MESSAGES'	=> ($folder_ary['unread_messages']) ? true : false,
-			'S_CUSTOM_FOLDER'	=> ($f_id > 0) ? true : false)
-		);
-	}
-
-	return;
-}
-
-// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
-function clean_sentbox($num_sentbox_messages)
-{
-	global $_CLASS, $config;
-// TEMP
-$_CLASS['core_user']->data['user_message_limit'] = isset($_CLASS['core_user']->data['user_message_limit']) ? $_CLASS['core_user']->data['user_message_limit'] : false;
-	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
-	
-	// Check Message Limit - 
-	if ($message_limit && $num_sentbox_messages > $message_limit)
-	{
-		// Delete old messages
-		$sql = 'SELECT t.msg_id
-			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
-			WHERE t.msg_id = p.msg_id
-				AND t.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
-			ORDER BY p.message_time ASC';
-		$result = $_CLASS['core_db']->query_limit($sql, ($num_sentbox_messages - $message_limit));
-
-		$delete_ids = array();
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$delete_ids[] = $row['msg_id'];
-		}
-		$_CLASS['core_db']->free_result($result);
-		delete_pm($_CLASS['core_user']->data['user_id'], $delete_ids, PRIVMSGS_SENTBOX);
-	}
-}
-
-// Check Rule against Message Informations
-function check_rule(&$rules, &$rule_row, &$message_row, $user_id)
-{
-	global $_CLASS, $config;
-
-	if (!isset($rules[$rule_row['rule_check']][$rule_row['rule_connection']]))
-	{
-		return false;
-	}
-
-	$check_ary = $rules[$rule_row['rule_check']][$rule_row['rule_connection']];
-
-	// Replace Check Literals
-	$evaluate = $check_ary['function'];
-	$evaluate = preg_replace('/{(CHECK[0-9])}/', '$message_row[$check_ary[strtolower("\1")]]', $evaluate);
-
-	// Replace Rule Literals
-	$evaluate = preg_replace('/{(STRING|USER_ID|GROUP_ID)}/', '$rule_row["rule_" . strtolower("\1")]', $evaluate);
-
-	// Eval Statement
-	$result = false;
-	eval('$result = (' . $evaluate . ') ? true : false;');
-		
-	if (!$result)
-	{
-		return false;
-	}
-
-	switch ($rule_row['rule_action'])
-	{
-		case ACTION_PLACE_INTO_FOLDER:
-			return array('action' => $rule_row['rule_action'], 'folder_id' => $rule_row['rule_folder_id']);
-			break;
-		case ACTION_MARK_AS_READ:
-		case ACTION_MARK_AS_IMPORTANT:
-		case ACTION_DELETE_MESSAGE:
-			return array('action' => $rule_row['rule_action'], 'unread' => $row['unread'], 'important' => $row['important']);
-			break;
-		default:
-			return false;
-	}
-
-	return false;
-}
-
-// Place new messages into appropiate folder
-function place_pm_into_folder(&$global_privmsgs_rules, $release = false)
-{
-	global $_CLASS, $config;
-
-	if (!$_CLASS['core_user']->data['user_new_privmsg'])
-	{
-		return;
-	}
-
-	$user_new_privmsg = (int) $_CLASS['core_user']->data['user_new_privmsg'];
-	$user_message_rules = (int) $_CLASS['core_user']->data['user_message_rules'];
-	$user_id = (int) $_CLASS['core_user']->data['user_id'];
-
-	$user_rules = $zebra = array();
-	if ($user_message_rules)
-	{
-		$sql = 'SELECT * 
-			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . "
-			WHERE user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		$user_rules = $_CLASS['core_db']->fetch_row_assocset($result);
-		$_CLASS['core_db']->free_result($result);
-
-		if (!empty($user_rules))
-		{
-			$sql = 'SELECT zebra_id, friend, foe
-				FROM ' . ZEBRA_TABLE . "
-				WHERE user_id = $user_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$zebra[$row['zebra_id']] = $row;
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-	}
-
-	if ($release)
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_NO_BOX . '
-			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
-				AND user_id = $user_id";
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Get those messages not yet placed into any box
-	// NOTE: Expand Group Information to all groups the user/author is in? 
-	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
-		WHERE t.user_id = $user_id
-			AND p.author_id = u.user_id
-			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
-			AND t.msg_id = p.msg_id';
-	$result = $_CLASS['core_db']->query($sql);
-
-	$action_ary = $move_into_folder = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$row['to']		= explode(':', $row['to_address']);
-		$row['bcc']		= explode(':', $row['bcc_address']);
-		$row['friend']	= (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['friend'] : 0;
-		$row['foe']		= (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['foe'] : 0;
-		$row['user_in_group'] = $_CLASS['core_user']->data['group_id'];
-						
-		// Check Rule - this should be very quick since we have all informations we need
-		$is_match = false;
-		foreach ($user_rules as $rule_row)
-		{
-			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
-			{
-				$is_match = true;
-				$action_ary[$row['msg_id']][] = $action;
-			}
-		}
-	
-		if (!$is_match)
-		{
-			$action_ary[$row['msg_id']][] = array('action' => false);
-			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// We place actions into arrays, to save queries.
-	$num_new = $num_unread = 0;
-	$sql = $unread_ids = $delete_ids = $important_ids = array();
-
-	foreach ($action_ary as $msg_id => $msg_ary)
-	{
-		// It is allowed to execute actions more than once, except placing messages into folder
-		$folder_action = false;
-
-		foreach ($msg_ary as $pos => $rule_ary)
-		{
-			if ($folder_action && $rule_ary['action'] == ACTION_PLACE_INTO_FOLDER)
-			{
-				continue;
-			}
-	
-			switch ($rule_ary['action'])
-			{
-				case ACTION_PLACE_INTO_FOLDER:
-					$folder_action = true;
-					$_folder_id = (int) $rule_ary['folder_id'];
-					$move_into_folder[$_folder_id][] = $msg_id;
-					$num_new++;
-					break;
-
-				case ACTION_MARK_AS_READ:
-					if ($rule_ary['unread'])
-					{
-						$unread_ids[] = $msg_id;
-					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
-					break;
-
-				case ACTION_DELETE_MESSAGE:
-					$delete_ids[] = $msg_id;
-					break;
-
-				case ACTION_MARK_AS_IMPORTANT:
-					if (!$rule_ary['important'])
-					{
-						$important_ids[] = $msg_id;
-					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
-					break;
-
-				default:
-			}
-		}
-	}
-
-	$num_new += sizeof(array_unique($delete_ids));
-	$num_unread += sizeof(array_unique($delete_ids));
-	$num_unread += sizeof(array_unique($unread_ids));
-
-	// Do not change the order of processing
-	// The number of queries needed to be executed here highly depends on the defined rules and are
-	// only gone through if new messages arrive.
-	$num_not_moved = 0;
-
-	// Delete messages
-	if (sizeof($delete_ids))
-	{
-		delete_pm($user_id, $delete_ids, PRIVMSGS_NO_BOX);
-	}
-
-	// Set messages to Unread
-	if (sizeof($unread_ids))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET unread = 0
-			WHERE msg_id IN (' . implode(', ', $unread_ids) . ")
-				AND user_id = $user_id
-				AND folder_id = " . PRIVMSGS_NO_BOX;
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// mark messages as important
-	if (sizeof($important_ids))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET marked = !marked
-			WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
-				AND user_id = $user_id
-				AND msg_id IN (" . implode(', ', $important_ids) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Move into folder
-	$folder = array();
-
-	if (sizeof($move_into_folder))
-	{
-		// Determine Full Folder Action - we need the move to folder id later eventually
-		$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
-
-		$sql = 'SELECT folder_id, pm_count 
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action >= 0) ? ', ' . $full_folder_action : '') . ")
-				AND user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
-		{
-			$sql = 'SELECT folder_id, COUNT(*) as num_messages
-				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-				WHERE user_id = $user_id
-					AND folder_id = " . PRIVMSGS_INBOX . "
-				GROUP BY folder_id";
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
-			
-			$folder[PRIVMSGS_INBOX] = (int) $_CLASS['core_db']->sql_fetchfield('num_messages', 0, $result);
-			$_CLASS['core_db']->free_result($result);			
-		}
-	}
-
-	// Here we have ideally only one folder to move into
-	$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
-
-	foreach ($move_into_folder as $folder_id => $msg_ary)
-	{
-		$dest_folder = $folder_id;
-		$full_folder_action = FULL_FOLDER_NONE;
-
-		// Check Message Limit - we calculate with the complete array, most of the time it is one message
-		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
-		if ($message_limit && $folder[$folder_id] && ($folder[$folder_id] + sizeof($msg_ary)) > $message_limit)
-		{
-			$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
-
-			// If destination folder itself is full...
-			if ($full_folder_action >= 0 && ($folder[$full_folder_action] + sizeof($msg_ary)) > $message_limit)
-			{
-				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
-			}
-
-			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
-			if ($full_folder_action >= 0)
-			{
-				$dest_folder = $full_folder_action;
-			}
-			else if ($full_folder_action == FULL_FOLDER_DELETE)
-			{
-				// Delete some messages ;)
-				$sql = 'SELECT t.msg_id
-					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
-					WHERE t.msg_id = p.msg_id
-						AND t.user_id = $user_id
-						AND t.folder_id = $dest_folder
-					ORDER BY p.message_time ASC";
-				$result = $_CLASS['core_db']->query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $message_limit));
-
-				$delete_ids = array();
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					$delete_ids[] = $row['msg_id'];
-				}
-				$_CLASS['core_db']->free_result($result);
-				delete_pm($user_id, $delete_ids, $dest_folder);
-			}
-		}
-		
-		if ($full_folder_action == FULL_FOLDER_HOLD)
-		{
-			$num_not_moved += sizeof($msg_ary);
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
-				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
-					AND user_id = $user_id
-					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-		}
-		else
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
-				SET folder_id = $dest_folder, msg_new = 0
-				WHERE folder_id = " . PRIVMSGS_NO_BOX . "
-					AND user_id = $user_id
-					AND msg_new = 1
-					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-
-			if ($dest_folder != PRIVMSGS_INBOX)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->sql_affectedrows() . "
-					WHERE folder_id = $dest_folder
-						AND user_id = $user_id";
-				$_CLASS['core_db']->query($sql);
-			}
-			else
-			{
-				$num_new += $_CLASS['core_db']->sql_affectedrows();
-			}
-		}
-	}
-
-	if (sizeof($action_ary))
-	{
-		// Move from OUTBOX to SENTBOX
-		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_SENTBOX . '
-			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql != '') ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-		
-		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
-		$_CLASS['core_user']->data['user_new_privmsg'] -= $num_new;
-		$_CLASS['core_user']->data['user_unread_privmsg'] -= $num_unread;
-	}
-
-	return $num_not_moved;
-}
-
-// Move PM from one to another folder
-function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
-{
-	global $_CLASS;
-	
-	if (!is_array($move_msg_ids))
-	{
-		$move_msg_ids = array($move_msg_ids);
-	}
-	
-	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
-	{
-		return 0;
-	}
-	
-	// We have to check the destination folder ;)
-	if ($dest_folder !== PRIVMSGS_INBOX)
-	{
-		$sql = 'SELECT folder_id, folder_name, pm_count
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
-			WHERE folder_id = $dest_folder
-				AND user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		if (!$row)
-		{
-			trigger_error('NOT_AUTHORIZED');
-		}
-// is message limit per folder ?
-		if ($row['pm_count'] + count($move_msg_ids) > $message_limit)
-		{
-			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '<br /><br />';
-			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'">', '</a>', $row['folder_name']);
-
-			trigger_error($message);
-		}
-	}
-	else
-	{
-		$sql = 'SELECT COUNT(*) as num_messages
-			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			WHERE folder_id = ' . PRIVMSGS_INBOX . "
-				AND user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) > $message_limit)
-		{
-			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']->lang['PM_INBOX']) . '<br /><br />';
-			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'">', '</a>', $_CLASS['core_user']->lang['PM_INBOX']);
-			trigger_error($message);
-		}
-	}
-
-	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
-		SET folder_id = $dest_folder
-		WHERE folder_id = $cur_folder_id
-			AND user_id = $user_id
-			AND msg_id IN (" . implode(', ', $move_msg_ids) . ')';
-
-	$_CLASS['core_db']->query($sql);
-	$num_moved = $_CLASS['core_db']->affected_rows();
-
-	// Update pm counts
-	if ($num_moved)
-	{
-// We should maybe add moving of atleast sentbox messages, maybe
-		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
-		if ($cur_folder_id !== PRIVMSGS_INBOX)
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
-				SET pm_count = pm_count - $num_moved
-				WHERE folder_id = $cur_folder_id
-					AND user_id = $user_id";
-			$_CLASS['core_db']->query($sql);
-		}
-
-		if ($dest_folder !== PRIVMSGS_INBOX)
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
-				SET pm_count = pm_count + $num_moved
-				WHERE folder_id = $dest_folder
-					AND user_id = $user_id";
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-
-	return $num_moved;
-}
-
-function set_read_status($read, $msg_id, $user_id, $folder_id)
-{
-	global $_CLASS;
-
-	if (empty($msg_id))
-	{
-		return;
-	}
-
-	$read = ($read) ? 0 : 1;
-
-	$sql_msg = is_array($msg_id) ? 'IN ('.implode(', ', $msg_id).')' : '= '.(int) $msg_id;
-
-	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
-		SET unread = $read
-		WHERE msg_id $sql_msg
-			AND user_id = $user_id
-			AND folder_id = $folder_id";
-	$_CLASS['core_db']->query($sql);
-	
-	$count = $_CLASS['core_db']->affected_rows();
-
-	if ($count)
-	{
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_unread_privmsg = user_unread_privmsg '.(($read) ? '+ ' : '- '). " $count
-			WHERE user_id = $user_id";
-		$_CLASS['core_db']->query($sql);
-	}
-}
-
-// Handle all actions possible with marked messages
-function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
-{
-	global $_CLASS;
-
-	if (empty($msg_ids))
-	{
-		return;
-	}
-
-	switch ($mark_action)
-	{
-		case 'mark_important':
-
-			$mark_list = array();
-
-			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-				WHERE folder_id = $cur_folder_id
-					AND user_id = $user_id
-					AND msg_id IN (" . implode(', ', $msg_ids) . ')';
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$row['marked'] = ($row['marked']) ? 0 : 1;
-				$mark_list[$row['marked']][] = $row['msg_id'];
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			if (empty($mark_list))
-			{
-				break;
-			}
-
-			foreach ($mark_list as $mark => $ids)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
-					SET marked = $mark
-					WHERE msg_id IN (" . implode(', ', $ids) . ')';
-				$_CLASS['core_db']->query($sql);
-			}
-		break;
-
-		case 'delete_marked':
-			$hidden_fields = array('marked_msg_id' => $msg_ids, 'cur_folder_id' => $cur_folder_id, 'mark_option' => 'delete_marked', 'submit_mark' => true);
-
-			if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
-			{
-				delete_pm($user_id, $msg_ids, $cur_folder_id);
-				
-				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
-				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
-				$_CLASS['core_display']->meta_refresh(3, $redirect);
-				
-				trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FOLDER'], '<a href="' . $redirect . '">', '</a>'));
-			}
-		break;
-
-		case 'export_as_xml':
-		case 'export_as_csv':
-		case 'export_as_txt':
-			$export_as = str_replace('export_as_', '', $mark_action);
-			break;
-
-		default:
-			return false;
-	}
-
-	return true;
-}
-
-// Delete PM(s)
-function delete_pm($user_id, $msg_ids, $folder_id)
-{
-	global $_CLASS;
-
-	$user_id	= (int) $user_id;
-	$folder_id	= (int) $folder_id;
-
-	if (!$user_id)
-	{
-		return false;
-	}
-
-	if (!is_array($msg_ids))
-	{
-		if (!$msg_ids)
-		{
-			return false;
-		}
-
-		$msg_ids = array($msg_ids);
-	}
-
-	if (empty($msg_ids))
-	{
-		return false;
-	}
-
-	// Get PM Informations for later deleting
-	$sql = 'SELECT msg_id, unread, msg_new
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . ")
-			AND folder_id = $folder_id
-			AND user_id = $user_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$delete_rows = array();
-	$num_unread = $num_new = $num_deleted = 0;
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$num_unread += ($row['unread']) ? 1 : 0;
-		$num_new += ($row['msg_new']) ? 1 : 0;
-
-		$delete_rows[$row['msg_id']] = 1;
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	unset($msg_ids);
-
-	if (empty($delete_rows))
-	{
-		return false;
-	}
-
-	// if no one has read the message yet (meaning it is in users outbox)
-	// then mark the message as deleted...
-	if ($folder_id === PRIVMSGS_OUTBOX)
-	{
-		// Remove PM from Outbox
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-			WHERE user_id = $user_id AND folder_id = " . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		// Update PM Information for safety
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . " SET message_text = ''
-			WHERE msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		// Set delete flag for those intended to receive the PM
-		// We do not remove the message actually, to retain some basic informations (sent time for example)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET deleted = 1
-			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
-	}
-	else
-	{
-		// Delete Private Message Informations
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-			WHERE user_id = $user_id
-				AND folder_id = $folder_id
-				AND msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
-		$_CLASS['core_db']->query($sql);
-		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
-	}
-
-	// if folder id is user defined folder then decrease pm_count
-	if (!in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX, PRIVMSGS_NO_BOX)))
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . " 
-			SET pm_count = pm_count - $num_deleted 
-			WHERE folder_id = $folder_id";
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql != '') ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-		
-		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
-	}
-	
-	// Now we have to check which messages we can delete completely	
-	$sql = 'SELECT msg_id 
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
-		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		unset($delete_rows[$row['msg_id']]);
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$delete_ids = implode(', ', array_keys($delete_rows));
-
-	if ($delete_ids)
-	{
-		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TABLE . '
-			WHERE msg_id IN (' . $delete_ids . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-}
-
-// Rebuild message header
-function rebuild_header($check_ary)
-{
-	$address = array();
-
-	foreach ($check_ary as $check_type => $address_field)
-	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id => $type)
-		{
-			${$type}[] = (int) $match[2][$id];
-		}
-
-		foreach (array('u', 'g') as $type)
-		{
-			if (sizeof($$type))
-			{
-				foreach ($$type as $id)
-				{
-					$address[$type][$id] = $check_type;
-				}
-			}
-		}
-	}
-
-	return $address;
-}
-
-// Print out/Assign recipient informations
-function write_pm_addresses($check_ary, $author_id, $plaintext = false)
-{
-	global $_CLASS;
-
-	$addresses = array();
-	
-	foreach ($check_ary as $check_type => $address_field)
-	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id => $type)
-		{
-			${$type}[] = (int) $match[2][$id];
-		}
-
-		$address = array();
-		if (sizeof($u))
-		{
-			$sql = 'SELECT user_id, username, user_colour 
-				FROM ' . USERS_TABLE . '
-				WHERE user_id IN (' . implode(', ', $u) . ')
-					AND user_type = ' . USER_NORMAL;
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
-				{
-					if ($plaintext)
-					{
-						$address[] = $row['username'];
-					}
-					else
-					{
-						$address['user'][$row['user_id']] = array('name' => $row['username'], 'colour' => $row['user_colour']);
-					}
-				}
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-
-		if (sizeof($g))
-		{
-			if ($plaintext)
-			{
-				$sql = 'SELECT group_name
-					FROM ' . GROUPS_TABLE . ' 
-						WHERE group_id IN (' . implode(', ', $g) . ')';
-				$result = $_CLASS['core_db']->query($sql);
-		
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
-					{
-						$address[] = $row['group_name'];
-					}
-				}
-				$_CLASS['core_db']->free_result($result);
-			}
-			else
-			{
-				$sql = 'SELECT g.group_id, g.group_name, g.group_colour, ug.user_id
-					FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
-						WHERE g.group_id IN (' . implode(', ', $g) . ')
-						AND g.group_id = ug.group_id
-						AND ug.user_pending = 0';
-				$result = $_CLASS['core_db']->query($sql);
-		
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					if (!isset($address['group'][$row['group_id']]))
-					{
-						if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
-						{
-							$address['group'][$row['group_id']] = array('name' => $row['group_name'], 'colour' => $row['group_colour']);
-						}
-					}
-	
-					if (isset($address['user'][$row['user_id']]))
-					{
-						$address['user'][$row['user_id']]['in_group'] = $row['group_id'];
-					}
-				}
-				$_CLASS['core_db']->free_result($result);
-			}
-		}
-
-		if (sizeof($address) && !$plaintext)
-		{
-			$_CLASS['core_template']->assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
-
-			foreach ($address as $type => $adr_ary)
-			{
-				foreach ($adr_ary as $id => $row)
-				{
-					$_CLASS['core_template']->assign_vars_array($check_type . '_recipient', array(
-						'NAME'		=> $row['name'],
-						'IS_GROUP'	=> ($type == 'group'),
-						'IS_USER'	=> ($type == 'user'),
-						'COLOUR'	=> ($row['colour']) ? $row['colour'] : '',
-						'UG_ID'		=> $id,
-						'U_VIEW'	=> ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
-					);
-				}
-			}
-		}
-
-		$addresses[$check_type] = $address;
-	}
-
-	return $addresses;
-}
-
-// Get folder status
-function get_folder_status($folder_id, $folder)
-{
-	global $_CLASS, $config;
-
-	if (isset($folder[$folder_id]))
-	{
-		$folder = $folder[$folder_id];
-	}
-	else
-	{
-		return false;
-	}
-
-	$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
-
-	$return = array(
-		'folder_name'	=> $folder['folder_name'], 
-		'cur'			=> $folder['num_messages'],
-		'remaining'		=> $message_limit - $folder['num_messages'],
-		'max'			=> $message_limit,
-		'percent'		=> ($message_limit) ? round(($folder['num_messages'] / $message_limit) * 100) : 100
-	);
-
-	$return['message'] = sprintf($_CLASS['core_user']->lang['FOLDER_STATUS_MSG'], $return['percent'], $return['cur'], $return['max']);
-
-	return $return;
-}
-
-//
-// COMPOSE MESSAGES
-//
-
-// Submit PM
-function submit_pm($mode, $subject, &$data, $update_message, $put_in_outbox = true)
-{
-	global $_CLASS, $config;
-
-	// We do not handle erasing posts here
-	if ($mode == 'delete')
-	{
-		return;
-	}
-
-	// Collect some basic informations about which tables and which rows to update/insert
-	$sql_data = array();
-	$root_level = 0;
-
-	// Recipient Informations
-	$recipients = $to = $bcc = array();
-
-	if ($mode != 'edit')
-	{
-		// Build Recipient List
-		// u|g => array($user_id => 'to'|'bcc')
-		foreach (array('u', 'g') as $ug_type)
-		{
-			if (isset($data['address_list'][$ug_type]) && sizeof($data['address_list'][$ug_type]))
-			{
-				foreach ($data['address_list'][$ug_type] as $id => $field)
-				{
-					$field = ($field == 'to') ? 'to' : 'bcc';
-					if ($ug_type == 'u')
-					{
-						$recipients[$id] = $field;
-					}
-					${$field}[] = $ug_type . '_' . (int) $id;
-				}
-			}
-		}
-
-		if (isset($data['address_list']['g']) && sizeof($data['address_list']['g']))
-		{
-			$sql = 'SELECT group_id, user_id
-				FROM ' . USER_GROUP_TABLE . '
-				WHERE group_id IN (' . implode(', ', array_keys($data['address_list']['g'])) . ')
-					AND user_pending = 0';
-			$result = $_CLASS['core_db']->query($sql);
-	
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
-				$recipients[$row['user_id']] = $field;
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-
-		if (!sizeof($recipients))
-		{
-			trigger_error('NO_RECIPIENT');
-		}
-	}
-
-	$sql = '';
-	
-	switch ($mode)
-	{
-		case 'reply':
-		case 'quote':
-			$root_level = ($data['reply_from_root_level']) ? $data['reply_from_root_level'] : $data['reply_from_msg_id']; 
-
-			// Set message_replied switch for this user
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET replied = 1
-				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-					AND msg_id = ' . $data['reply_from_msg_id'];
-
-		case 'forward':
-		case 'post':
-			$sql_data = array(
-				'root_level'		=> $root_level,
-				'author_id'			=> (int) $_CLASS['core_user']->data['user_id'],
-				'icon_id'			=> $data['icon_id'], 
-				'author_ip' 		=> $_CLASS['core_user']->ip,
-				'message_time'		=> $_CLASS['core_user']->time,
-				'enable_bbcode' 	=> $data['enable_bbcode'],
-				'enable_html' 		=> $data['enable_html'],
-				'enable_smilies' 	=> $data['enable_smilies'],
-				'enable_magic_url' 	=> $data['enable_urls'],
-				'enable_sig' 		=> $data['enable_sig'],
-				'message_subject'	=> $subject,
-				'message_text' 		=> $data['message'],
-				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
-				'bbcode_uid'		=> $data['bbcode_uid'],
-				'to_address'		=> implode(':', $to),
-				'bcc_address'		=> implode(':', $bcc)
-			);
-			break;
-
-		case 'edit':
-			$sql_data = array(
-				'icon_id'			=> $data['icon_id'],
-				'message_edit_time'	=> $_CLASS['core_user']->time,
-				'enable_bbcode' 	=> $data['enable_bbcode'],
-				'enable_html' 		=> $data['enable_html'],
-				'enable_smilies' 	=> $data['enable_smilies'],
-				'enable_magic_url' 	=> $data['enable_urls'],
-				'enable_sig' 		=> $data['enable_sig'],
-				'message_subject'	=> $subject,
-				'message_text' 		=> $data['message'],
-				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
-				'bbcode_uid'		=> $data['bbcode_uid']
-			);
-		break;
-	}
-
-	$_CLASS['core_db']->transaction();
-
-	if (!empty($sql_data))
-	{
-		if ($mode === 'post' || $mode === 'reply' || $mode === 'quote' || $mode === 'forward')
-		{
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
-			$data['msg_id'] = $_CLASS['core_db']->insert_id(FORUMS_PRIVMSGS_TABLE, 'msg_id');
-		}
-		else if ($mode === 'edit')
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
-				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data) . ' 
-				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-	
-	if ($mode !== 'edit')
-	{
-		if ($sql)
-		{
-			$_CLASS['core_db']->query($sql);
-		}
-
-		foreach ($recipients as $user_id => $type)
-		{
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'msg_id'	=> $data['msg_id'],
-				'user_id'	=> $user_id,
-				'author_id'	=> $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> PRIVMSGS_INBOX,
-				'msg_new'	=> 1,
-				'unread'	=> 1,
-				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
-			);
-		}
-
-		$sql = 'UPDATE ' . USERS_TABLE . ' 
-			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
-			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		// Put PM into outbox
-		if ($put_in_outbox)
-		{
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'msg_id'	=> (int) $data['msg_id'],
-				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> PRIVMSGS_OUTBOX,
-				'msg_new'	=> 0,
-				'unread'	=> 0,
-				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
-			);
-		}
-	}
-
-	// Set user last post time
-	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
-	{
-		$sql = 'UPDATE ' . USERS_TABLE . "
-			SET user_last_post_time = {$_CLASS['core_user']->time}
-			WHERE user_id = " . $_CLASS['core_user']->data['user_id'];
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Submit Attachments
-	if (!empty($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
-	{
-		$space_taken = $files_added = 0;
-
-		foreach ($data['attachment_data'] as $pos => $attach_row)
-		{
-			if ($attach_row['attach_id'])
-			{
-				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . " 
-					SET comment = '" . $_CLASS['core_db']->sql_escape($attach_row['comment']) . "' 
-					WHERE attach_id = " . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']->query($sql);
-			}
-			else
-			{
-				// insert attachment into db 
-				$attach_sql = array(
-					'post_msg_id'		=> $data['msg_id'],
-					'download_count'	=> 0,
-					'topic_id'			=> 0,
-					'in_message'		=> 1,
-					'poster_id'			=> $_CLASS['core_user']->data['user_id'],
-					'physical_filename'	=> basename($attach_row['physical_filename']),
-					'real_filename'		=> basename($attach_row['real_filename']),
-					'comment'			=> $attach_row['comment'],
-					'extension'			=> $attach_row['extension'],
-					'mimetype'			=> $attach_row['mimetype'],
-					'filesize'			=> $attach_row['filesize'],
-					'filetime'			=> $attach_row['filetime'],
-					'thumbnail'			=> $attach_row['thumbnail']
-				);
-
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql));
-
-				$space_taken += $attach_row['filesize'];
-
-				$files_added++;
-			}
-		}
-		
-		if (!empty($data['attachment_data']))
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
-				SET message_attachment = 1
-				WHERE msg_id = ' . $data['msg_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-
-		if ($space_taken && $files_added)
-		{
-			set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
-			set_config('num_files', $config['num_files'] + $files_added, true);
-		}
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-
-	// Delete draft if post was loaded...
-	$draft_id = request_var('draft_loaded', 0);
-
-	if ($draft_id)
-	{
-		$sql = 'DELETE FROM ' . DRAFTS_TABLE . " 
-			WHERE draft_id = $draft_id 
-				AND user_id = " . $_CLASS['core_user']->data['user_id'];
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Send Notifications
-	if ($mode != 'edit')
-	{
-		pm_notification($mode, stripslashes($_CLASS['core_user']->data['username']), $recipients, stripslashes($subject), stripslashes($data['message']));
-	}
-
-	return $data['msg_id'];
-}
-
-// PM Notification
-function pm_notification($mode, $author, $recipients, $subject, $message)
-{
-	global $_CLASS, $config;
-return;
-	$subject = censor_text($subject);
-	
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
-
-	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (isset($row['ban_userid']))
-		{
-			unset($recipients[$row['ban_userid']]);
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	if (!sizeof($recipients))
-	{
-		return;
-	}
-
-	$recipient_list = implode(', ', array_keys($recipients));
-
-	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
-		FROM ' . USERS_TABLE . "
-		WHERE user_id IN ($recipient_list)";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$msg_list_ary = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($row['user_notify_pm'] == 1 && trim($row['user_email']))
-		{
-			$msg_list_ary[] = array(
-				'method'	=> $row['user_notify_type'],
-				'email'		=> $row['user_email'],
-				'jabber'	=> $row['user_jabber'],
-				'name'		=> $row['username'],
-				'lang'		=> $row['user_lang']
-			);
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-	
-	if (!sizeof($msg_list_ary))
-	{
-		return;
-	}
-
-	require_once('includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
-	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-
-	foreach ($msg_list_ary as $pos => $addr)
-	{
-		$messenger->template('privmsg_notify', $addr['lang']);
-
-		$messenger->replyto($config['board_email']);
-		$messenger->to($addr['email'], $addr['name']);
-		$messenger->im($addr['jabber'], $addr['name']);
-
-		$messenger->assign_vars(array(
-			'EMAIL_SIG'		=> $email_sig,
-			'SITENAME'		=> $config['sitename'],
-			'SUBJECT'		=> $subject,
-			'AUTHOR_NAME'	=> $author,
-			'USERNAME'		=> $addr['name'],
-
-			'U_INBOX'		=> generate_link('Control_Panel&amp;i=pm&mode=unread', array('full' => true, 'sid' => true)))
-		);
-
-		$messenger->send($addr['method']);
-		$messenger->reset();
-	}
-	unset($msg_list_ary);
-
-	if ($messenger->queue)
-	{
-		$messenger->save_queue();
-	}
-
-	unset($messenger);
-}
-
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: functions_privmsgs.php,v 1.7 2004/09/16 18:33:20 acydburn Exp $
+//
+// FILENAME  : functions_privmsgs.php
+// STARTED   : Sun Apr 18, 2004
+// COPYRIGHT : ? 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+// Define Rule processing schema
+// NOTE: might change
+
+/*
+	Ability to simply add own rules by doing three things:
+		1) Add an appropiate constant
+		2) Add a new check array to the global_privmsgs_rules variable and the condition array (if one is required)
+		3) Add a new language variable to ucp.php
+		
+		The user is then able to select the new rule. It will be checked against and handled as specified.
+		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
+*/
+
+define('RULE_IS_LIKE', 1); // Is Like
+define('RULE_IS_NOT_LIKE', 2); // Is Not Like
+define('RULE_IS', 3); // Is
+define('RULE_IS_NOT', 4); // Is Not
+define('RULE_BEGINS_WITH', 5); // Begins with
+define('RULE_ENDS_WITH', 6); // Ends with
+define('RULE_IS_FRIEND', 7); // Is Friend
+define('RULE_IS_FOE', 8); // Is Foe
+define('RULE_IS_USER', 9); // Is User
+define('RULE_IS_GROUP', 10); // Is In Usergroup
+define('RULE_ANSWERED', 11); // Answered
+define('RULE_FORWARDED', 12); // Forwarded
+define('RULE_REPORTED', 13); // Reported
+define('RULE_TO_GROUP', 14); // Usergroup
+define('RULE_TO_ME', 15); // Me
+
+define('ACTION_PLACE_INTO_FOLDER', 1);
+define('ACTION_MARK_AS_READ', 2);
+define('ACTION_MARK_AS_IMPORTANT', 3);
+define('ACTION_DELETE_MESSAGE', 4);
+
+define('CHECK_SUBJECT', 1);
+define('CHECK_SENDER', 2);
+define('CHECK_MESSAGE', 3);
+define('CHECK_STATUS', 4);
+define('CHECK_TO', 5);
+
+$global_privmsgs_rules = array(
+	CHECK_SUBJECT	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'message_subject', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'message_subject', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'message_subject', 'function' => '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=> array('check0' => 'message_subject', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
+		RULE_ENDS_WITH		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})')),
+
+	CHECK_SENDER	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'username', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'username', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'username', 'function' => '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=> array('check0' => 'username', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
+		RULE_ENDS_WITH		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})'),
+		RULE_IS_FRIEND		=> array('check0' => 'friend', 'function' => '{CHECK0} == 1'),
+		RULE_IS_FOE			=> array('check0' => 'foe', 'function' => '{CHECK0} == 1'),
+		RULE_IS_USER		=> array('check0' => 'author_id', 'function' => '{CHECK0} == {USER_ID}'),
+		RULE_IS_GROUP       => array('check0' => 'author_in_group', 'function' => 'in_array({GROUP_ID}, {CHECK0})')),
+
+	CHECK_MESSAGE	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'message_text', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'message_text', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'message_text', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'message_text', 'function' => '{CHECK0} != {STRING}')),
+		
+	CHECK_STATUS	=> array(
+		RULE_ANSWERED		=> array('check0' => 'replied', 'function' => '{CHECK0} == 1'),
+		RULE_FORWARDED		=> array('check0' => 'forwarded', 'function' => '{CHECK0} == 1'),
+		RULE_REPORTED		=> array('check0' => 'message_reported', 'function' => '{CHECK0} == 1')),
+		
+	CHECK_TO		=> array(
+		RULE_TO_GROUP		=> array('check0' => 'to', 'check1' => 'bcc', 'check2' => 'user_in_group', 'function' => 'in_array("g_" . {CHECK2}, {CHECK0}) || in_array("g_" . {CHECK2}, {CHECK1})'),
+		RULE_TO_ME			=> array('check0' => 'to', 'check1' => 'bcc', 'function' => 'in_array("u_" . $user_id, {CHECK0}) || in_array("u_" . $user_id, {CHECK1})'))
+);
+
+// This is for defining which condition fields to show for which Rule
+$global_rule_conditions = array(
+	RULE_IS_LIKE		=> 'text',
+	RULE_IS_NOT_LIKE	=> 'text',
+	RULE_IS				=> 'text',
+	RULE_IS_NOT			=> 'text',
+	RULE_BEGINS_WITH	=> 'text',
+	RULE_ENDS_WITH		=> 'text',
+	RULE_IS_USER		=> 'user',
+	RULE_IS_GROUP		=> 'group'
+);
+
+// Get all folder
+function get_folder($user_id, &$folder, $folder_id = false)
+{
+	global $_CLASS;
+
+	if (!is_array($folder))
+	{
+		$folder = array();
+	}
+
+	// Get folder informations
+	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+		WHERE user_id = $user_id
+			AND folder_id <> " . PRIVMSGS_NO_BOX . '
+		GROUP BY folder_id';
+	$result = $_CLASS['core_db']->query($sql);
+
+	$num_messages = $num_unread = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$num_messages[(int) $row['folder_id']] = $row['num_messages'];
+		$num_unread[(int) $row['folder_id']] = $row['num_unread'];
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	// Make sure the default boxes are defined
+	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
+	foreach ($folder_array as $default_folder)
+	{
+		if (!isset($num_messages[$default_folder]))
+		{
+			$num_messages[$default_folder] = 0;
+		}
+
+		if (!isset($num_unread[$default_folder]))
+		{
+			$num_unread[$default_folder] = 0;
+		}
+	}
+
+	// Adjust unread status for outbox
+	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
+	
+	$folder[PRIVMSGS_INBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_INBOX'], 'num_messages' => $num_messages[PRIVMSGS_INBOX], 'unread_messages' => $num_unread[PRIVMSGS_INBOX]);
+
+	// Custom Folder
+	$sql = 'SELECT folder_id, folder_name, pm_count
+		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+			WHERE user_id = $user_id";
+	$result = $_CLASS['core_db']->query($sql);
+			
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$folder[$row['folder_id']] = array('folder_name' => $row['folder_name'], 'num_messages' => $row['pm_count'], 'unread_messages' => ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	$folder[PRIVMSGS_OUTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_OUTBOX'], 'num_messages' => $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' => $num_unread[PRIVMSGS_OUTBOX]);
+	$folder[PRIVMSGS_SENTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_SENTBOX'], 'num_messages' => $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' => $num_unread[PRIVMSGS_SENTBOX]);
+
+	// Define Folder Array for template designers (and for making custom folders usable by the template too)
+	foreach ($folder as $f_id => $folder_ary)
+	{
+		$_CLASS['core_template']->assign_vars_array('folder', array(
+			'FOLDER_ID'			=> $f_id,
+			'FOLDER_NAME'		=> $folder_ary['folder_name'],
+			'NUM_MESSAGES'		=> $folder_ary['num_messages'],
+			'UNREAD_MESSAGES'	=> $folder_ary['unread_messages'],
+
+			'S_CUR_FOLDER'		=> ($f_id == $folder_id) ? true : false,
+			'S_UNREAD_MESSAGES'	=> ($folder_ary['unread_messages']) ? true : false,
+			'S_CUSTOM_FOLDER'	=> ($f_id > 0) ? true : false)
+		);
+	}
+
+	return;
+}
+
+// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
+function clean_sentbox($num_sentbox_messages)
+{
+	global $_CLASS, $config;
+
+	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
+	
+	// Check Message Limit - 
+	if ($message_limit && $num_sentbox_messages > $message_limit)
+	{
+		// Delete old messages
+		$sql = 'SELECT t.msg_id
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p
+			WHERE t.msg_id = p.msg_id
+				AND t.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+				AND t.folder_id = ' . PRIVMSGS_SENTBOX . '
+			ORDER BY p.message_time ASC';
+		$result = $_CLASS['core_db']->query_limit($sql, ($num_sentbox_messages - $message_limit));
+
+		$delete_ids = array();
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$delete_ids[] = $row['msg_id'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		$_CLASS['core_db']->transaction();
+
+		delete_pm($_CLASS['core_user']->data['user_id'], $delete_ids, PRIVMSGS_SENTBOX);
+
+		$_CLASS['core_db']->transaction('commit');
+	}
+}
+
+// Check Rule against Message Informations
+function check_rule(&$rules, &$rule_row, &$message_row, $user_id)
+{
+	global $_CLASS, $config;
+
+	if (!isset($rules[$rule_row['rule_check']][$rule_row['rule_connection']]))
+	{
+		return false;
+	}
+
+	$check_ary = $rules[$rule_row['rule_check']][$rule_row['rule_connection']];
+
+	// Replace Check Literals
+	$evaluate = $check_ary['function'];
+	$evaluate = preg_replace('/{(CHECK[0-9])}/', '$message_row[$check_ary[strtolower("\1")]]', $evaluate);
+
+	// Replace Rule Literals
+	$evaluate = preg_replace('/{(STRING|USER_ID|GROUP_ID)}/', '$rule_row["rule_" . strtolower("\1")]', $evaluate);
+
+	// Eval Statement
+	$result = false;
+	eval('$result = (' . $evaluate . ') ? true : false;');
+		
+	if (!$result)
+	{
+		return false;
+	}
+
+	switch ($rule_row['rule_action'])
+	{
+		case ACTION_PLACE_INTO_FOLDER:
+			return array('action' => $rule_row['rule_action'], 'folder_id' => $rule_row['rule_folder_id']);
+			break;
+		case ACTION_MARK_AS_READ:
+		case ACTION_MARK_AS_IMPORTANT:
+		case ACTION_DELETE_MESSAGE:
+			return array('action' => $rule_row['rule_action'], 'unread' => $row['unread'], 'important' => $row['important']);
+			break;
+		default:
+			return false;
+	}
+
+	return false;
+}
+
+// Place new messages into appropiate folder
+function place_pm_into_folder(&$global_privmsgs_rules, $release = false)
+{
+	global $_CLASS, $config;
+
+	if (!$_CLASS['core_user']->data['user_new_privmsg'])
+	{
+		return;
+	}
+$_CLASS['core_user']->data['user_message_rules'] = 0;
+$_CLASS['core_user']->data['user_full_folder'] = FULL_FOLDER_NONE;
+
+	$user_new_privmsg = (int) $_CLASS['core_user']->data['user_new_privmsg'];
+	$user_message_rules = (int) $_CLASS['core_user']->data['user_message_rules'];
+	$user_id = (int) $_CLASS['core_user']->data['user_id'];
+
+	$user_rules = $zebra = array();
+
+	if ($user_message_rules)
+	{
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . "
+			WHERE user_id = $user_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$user_rules[] = $row;
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		if (!empty($user_rules))
+		{
+			$sql = 'SELECT zebra_id, friend, foe
+				FROM ' . ZEBRA_TABLE . "
+				WHERE user_id = $user_id";
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$zebra[$row['zebra_id']] = $row;
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+	}
+
+// I don't like no box
+	/*
+	if ($release)
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_NO_BOX . '
+			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
+				AND user_id = $user_id";
+		$_CLASS['core_db']->query($sql);
+	}
+	*/
+
+	// Get those messages not yet placed into any box
+	// NOTE: Expand Group Information to all groups the user/author is in? 
+	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . USERS_TABLE . " u
+		WHERE t.user_id = $user_id
+			AND p.author_id = u.user_id
+			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
+			AND t.msg_id = p.msg_id';
+	$result = $_CLASS['core_db']->query($sql);
+
+	$action_ary = $move_into_folder = array();
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$row['to']		= explode(':', $row['to_address']);
+		$row['bcc']		= explode(':', $row['bcc_address']);
+		$row['friend']	= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['friend'] : 0;
+		$row['foe']		= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['foe'] : 0;
+		$row['user_in_group'] = $_CLASS['core_user']->data['user_group'];
+		
+		// Check Rule - this should be very quick since we have all informations we need
+		$is_match = false;
+
+		foreach ($user_rules as $rule_row)
+		{
+			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
+			{
+				$is_match = true;
+				$action_ary[$row['msg_id']][] = $action;
+			}
+		}
+	
+		if (!$is_match)
+		{
+			$action_ary[$row['msg_id']][] = array('action' => false);
+			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
+		}
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	// We place actions into arrays, to save queries.
+	$num_new = $num_unread = 0;
+	$sql = $unread_ids = $delete_ids = $important_ids = array();
+
+	foreach ($action_ary as $msg_id => $msg_ary)
+	{
+		// It is allowed to execute actions more than once, except placing messages into folder
+		$folder_action = false;
+
+		foreach ($msg_ary as $pos => $rule_ary)
+		{
+			if ($folder_action && $rule_ary['action'] == ACTION_PLACE_INTO_FOLDER)
+			{
+				continue;
+			}
+
+			switch ($rule_ary['action'])
+			{
+				case ACTION_PLACE_INTO_FOLDER:
+					$folder_action = true;
+					$_folder_id = (int) $rule_ary['folder_id'];
+					$move_into_folder[$_folder_id][] = $msg_id;
+					$num_new++;
+				break;
+
+				case ACTION_MARK_AS_READ:
+					if ($rule_ary['unread'])
+					{
+						$unread_ids[] = $msg_id;
+					}
+					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+				break;
+
+				case ACTION_DELETE_MESSAGE:
+					$delete_ids[] = $msg_id;
+				break;
+
+				case ACTION_MARK_AS_IMPORTANT:
+					if (!$rule_ary['important'])
+					{
+						$important_ids[] = $msg_id;
+					}
+					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+				break;
+			}
+		}
+	}
+
+	$num_new += count(array_unique($delete_ids));
+	$num_unread += count(array_unique($delete_ids));
+	$num_unread += count(array_unique($unread_ids));
+
+	// Do not change the order of processing
+	// The number of queries needed to be executed here highly depends on the defined rules and are
+	// only gone through if new messages arrive.
+	$num_not_moved = 0;
+
+	$_CLASS['core_db']->transaction();
+
+	// Delete messages
+	if (!empty($delete_ids))
+	{
+		delete_pm($user_id, $delete_ids, PRIVMSGS_NO_BOX);
+	}
+
+	// Set messages to Unread
+	if (!empty($unread_ids))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET unread = 0
+			WHERE msg_id IN (' . implode(', ', $unread_ids) . ")
+				AND user_id = $user_id
+				AND folder_id = " . PRIVMSGS_NO_BOX;
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// mark messages as important
+	if (!empty($important_ids))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			SET marked = 1
+			WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
+				AND user_id = $user_id
+				AND msg_id IN (" . implode(', ', $important_ids) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Move into folder
+	$folder = array();
+
+	if (!empty($move_into_folder))
+	{
+		// Determine Full Folder Action - we need the move to folder id later eventually
+		$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
+
+		$sql = 'SELECT folder_id, pm_count 
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action >= 0) ? ', ' . $full_folder_action : '') . ")
+				AND user_id = $user_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
+		{
+			$sql = 'SELECT COUNT(*) as num_messages
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+				WHERE user_id = $user_id
+					AND folder_id = " . PRIVMSGS_INBOX;
+
+			$result = $_CLASS['core_db']->query_limit($sql);
+			list($count) = $_CLASS['core_db']->fetch_row_num($result);
+			$_CLASS['core_db']->free_result($result);	
+
+			$folder[PRIVMSGS_INBOX] = (int) $count;
+		}
+	}
+
+	// Here we have ideally only one folder to move into
+	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $_CLASS['core_user']->data['user_message_limit'] : $config['pm_max_msgs'];
+
+	foreach ($move_into_folder as $folder_id => $msg_ary)
+	{
+		$dest_folder = $folder_id;
+		$full_folder_action = FULL_FOLDER_NONE;
+
+		// Check Message Limit - we calculate with the complete array, most of the time it is one message
+		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
+		if ($message_limit && $folder[$folder_id] && ($folder[$folder_id] + count($msg_ary)) > $message_limit)
+		{
+			$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
+
+			// If destination folder itself is full...
+			if ($full_folder_action >= 0 && ($folder[$full_folder_action] + count($msg_ary)) > $message_limit)
+			{
+				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
+			}
+
+			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
+			if ($full_folder_action >= 0)
+			{
+				$dest_folder = $full_folder_action;
+			}
+			elseif ($full_folder_action == FULL_FOLDER_DELETE)
+			{
+				// Delete some messages ;)
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
+					WHERE t.msg_id = p.msg_id
+						AND t.user_id = $user_id
+						AND t.folder_id = $dest_folder
+					ORDER BY p.message_time ASC";
+				$result = $_CLASS['core_db']->query_limit($sql, (($folder[$dest_folder] + count($msg_ary)) - $message_limit));
+
+				$delete_ids = array();
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$delete_ids[] = $row['msg_id'];
+				}
+				$_CLASS['core_db']->free_result($result);
+				delete_pm($user_id, $delete_ids, $dest_folder);
+			}
+		}
+
+		if ($full_folder_action == FULL_FOLDER_HOLD)
+		{
+			$num_not_moved += count($msg_ary);
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
+				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
+					AND user_id = $user_id
+					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+		else
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
+				SET folder_id = $dest_folder, msg_new = 0
+				WHERE folder_id = " . PRIVMSGS_NO_BOX . "
+					AND user_id = $user_id
+					AND msg_new = 1
+					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']->query($sql);
+
+			if ($dest_folder != PRIVMSGS_INBOX)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->affected_rows() . "
+					WHERE folder_id = $dest_folder
+						AND user_id = $user_id";
+				$_CLASS['core_db']->query($sql);
+			}
+			else
+			{
+				$num_new += $_CLASS['core_db']->affected_rows();
+			}
+		}
+	}
+
+	if (!empty($action_ary))
+	{
+		// Move from OUTBOX to SENTBOX
+		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_SENTBOX . '
+			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql) ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
+
+		$_CLASS['core_user']->data['user_new_privmsg'] -= $num_new;
+		$_CLASS['core_user']->data['user_unread_privmsg'] -= $num_unread;
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	return $num_not_moved;
+}
+
+// Move PM from one to another folder
+function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
+{
+	global $_CLASS;
+	
+	if (!is_array($move_msg_ids))
+	{
+		$move_msg_ids = array($move_msg_ids);
+	}
+	
+	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
+	{
+		return 0;
+	}
+	
+	// We have to check the destination folder ;)
+	if ($dest_folder !== PRIVMSGS_INBOX)
+	{
+		$sql = 'SELECT folder_id, folder_name, pm_count
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+			WHERE folder_id = $dest_folder
+				AND user_id = $user_id";
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$row)
+		{
+			trigger_error('NOT_AUTHORIZED');
+		}
+// is message limit per folder ?
+		if ($row['pm_count'] + count($move_msg_ids) > $message_limit)
+		{
+			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '<br /><br />';
+			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'">', '</a>', $row['folder_name']);
+
+			trigger_error($message);
+		}
+	}
+	else
+	{
+		$sql = 'SELECT COUNT(*) as num_messages
+			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			WHERE folder_id = ' . PRIVMSGS_INBOX . "
+				AND user_id = $user_id";
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) > $message_limit)
+		{
+			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']->lang['PM_INBOX']) . '<br /><br />';
+			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'">', '</a>', $_CLASS['core_user']->lang['PM_INBOX']);
+			trigger_error($message);
+		}
+	}
+
+	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
+		SET folder_id = $dest_folder
+		WHERE folder_id = $cur_folder_id
+			AND user_id = $user_id
+			AND msg_id IN (" . implode(', ', $move_msg_ids) . ')';
+
+	$_CLASS['core_db']->query($sql);
+	$num_moved = $_CLASS['core_db']->affected_rows();
+
+	// Update pm counts
+	if ($num_moved)
+	{
+// We should maybe add moving of atleast sentbox messages, maybe
+		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
+		if ($cur_folder_id !== PRIVMSGS_INBOX)
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+				SET pm_count = pm_count - $num_moved
+				WHERE folder_id = $cur_folder_id
+					AND user_id = $user_id";
+			$_CLASS['core_db']->query($sql);
+		}
+
+		if ($dest_folder !== PRIVMSGS_INBOX)
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+				SET pm_count = pm_count + $num_moved
+				WHERE folder_id = $dest_folder
+					AND user_id = $user_id";
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+
+	return $num_moved;
+}
+
+function set_read_status($read, $msg_id, $user_id, $folder_id)
+{
+	global $_CLASS;
+
+	if (empty($msg_id))
+	{
+		return;
+	}
+
+	$read = ($read) ? 0 : 1;
+
+	$sql_msg = is_array($msg_id) ? 'IN ('.implode(', ', $msg_id).')' : '= '.(int) $msg_id;
+
+	$_CLASS['core_db']->transaction();
+
+	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
+		SET unread = $read
+		WHERE msg_id $sql_msg
+			AND user_id = $user_id
+			AND folder_id = $folder_id";
+	$_CLASS['core_db']->query($sql);
+	
+	$count = $_CLASS['core_db']->affected_rows();
+
+	if ($count)
+	{
+		$sql = 'UPDATE ' . USERS_TABLE . ' 
+			SET user_unread_privmsg = user_unread_privmsg '.(($read) ? '+ ' : '- '). " $count
+			WHERE user_id = $user_id";
+		$_CLASS['core_db']->query($sql);
+	}
+	
+	$_CLASS['core_db']->transaction('commit');
+}
+
+// Handle all actions possible with marked messages
+function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
+{
+	global $_CLASS;
+
+	if (empty($msg_ids))
+	{
+		return;
+	}
+
+	switch ($mark_action)
+	{
+		case 'mark_important':
+
+			$mark_list = array();
+
+			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+				WHERE folder_id = $cur_folder_id
+					AND user_id = $user_id
+					AND msg_id IN (" . implode(', ', $msg_ids) . ')';
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$row['marked'] = ($row['marked']) ? 0 : 1;
+				$mark_list[$row['marked']][] = $row['msg_id'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			if (empty($mark_list))
+			{
+				break;
+			}
+
+			$_CLASS['core_db']->transaction();
+
+			foreach ($mark_list as $mark => $ids)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
+					SET marked = $mark
+					WHERE msg_id IN (" . implode(', ', $ids) . ')';
+				$_CLASS['core_db']->query($sql);
+			}
+
+			$_CLASS['core_db']->transaction('commit');
+		break;
+
+		case 'delete_marked':
+			$hidden_fields = array('marked_msg_id' => $msg_ids, 'cur_folder_id' => $cur_folder_id, 'mark_option' => 'delete_marked', 'submit_mark' => true);
+
+			if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
+			{
+				$_CLASS['core_db']->transaction();
+
+				delete_pm($user_id, $msg_ids, $cur_folder_id);
+
+				$_CLASS['core_db']->transaction('commit');
+
+				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
+				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
+				$_CLASS['core_display']->meta_refresh(3, $redirect);
+				
+				trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FOLDER'], '<a href="' . $redirect . '">', '</a>'));
+			}
+		break;
+
+		/*
+		case 'export_as_xml':
+		case 'export_as_csv':
+		case 'export_as_txt':
+			$export_as = str_replace('export_as_', '', $mark_action);
+		break;
+		*/
+
+		default:
+			return false;
+		break;
+	}
+
+	return true;
+}
+
+// Delete PM(s)
+function delete_pm($user_id, $msg_ids, $folder_id)
+{
+	global $_CLASS;
+
+	$user_id	= (int) $user_id;
+	$folder_id	= (int) $folder_id;
+
+	if (!$user_id)
+	{
+		return false;
+	}
+
+	if (!is_array($msg_ids))
+	{
+		if (!$msg_ids)
+		{
+			return false;
+		}
+
+		$msg_ids = array($msg_ids);
+	}
+
+	if (empty($msg_ids))
+	{
+		return false;
+	}
+
+	// Get PM Informations for later deleting
+	$sql = 'SELECT msg_id, unread, msg_new
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . ")
+			AND folder_id = $folder_id
+			AND user_id = $user_id";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$delete_rows = array();
+	$num_unread = $num_new = $num_deleted = 0;
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$num_unread += ($row['unread']) ? 1 : 0;
+		$num_new += ($row['msg_new']) ? 1 : 0;
+
+		$delete_rows[$row['msg_id']] = 1;
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	unset($msg_ids);
+
+	if (empty($delete_rows))
+	{
+		return false;
+	}
+
+	// if no one has read the message yet (meaning it is in users outbox)
+	// then mark the message as deleted...
+	if ($folder_id === PRIVMSGS_OUTBOX)
+	{
+		// Remove PM from Outbox
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+			WHERE user_id = $user_id AND folder_id = " . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		// Update PM Information for safety
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . " SET message_text = ''
+			WHERE msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		// Set delete flag for those intended to receive the PM
+		// We do not remove the message actually, to retain some basic informations (sent time for example)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+			SET deleted = 1
+			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
+	}
+	else
+	{
+		// Delete Private Message Informations
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+			WHERE user_id = $user_id
+				AND folder_id = $folder_id
+				AND msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
+		$_CLASS['core_db']->query($sql);
+		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
+	}
+
+	// if folder id is user defined folder then decrease pm_count
+	if (!in_array($folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX, PRIVMSGS_NO_BOX)))
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . " 
+			SET pm_count = pm_count - $num_deleted 
+			WHERE folder_id = $folder_id";
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql != '') ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+		
+		$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
+	}
+	
+	// Now we have to check which messages we can delete completely	
+	$sql = 'SELECT msg_id 
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
+		WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		unset($delete_rows[$row['msg_id']]);
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	$delete_ids = implode(', ', array_keys($delete_rows));
+
+	if ($delete_ids)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_TABLE . '
+			WHERE msg_id IN (' . $delete_ids . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+}
+
+// Rebuild message header
+function rebuild_header($check_ary)
+{
+	$address = array();
+
+	foreach ($check_ary as $check_type => $address_field)
+	{
+		// Split Addresses into users and groups
+		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+
+		$u = $g = array();
+		foreach ($match[1] as $id => $type)
+		{
+			${$type}[] = (int) $match[2][$id];
+		}
+
+		foreach (array('u', 'g') as $type)
+		{
+			if (sizeof($$type))
+			{
+				foreach ($$type as $id)
+				{
+					$address[$type][$id] = $check_type;
+				}
+			}
+		}
+	}
+
+	return $address;
+}
+
+// Print out/Assign recipient informations
+function write_pm_addresses($check_ary, $author_id, $plaintext = false)
+{
+	global $_CLASS;
+
+	$addresses = array();
+	
+	foreach ($check_ary as $check_type => $address_field)
+	{
+		// Split Addresses into users and groups
+		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+
+		$u = $g = array();
+		foreach ($match[1] as $id => $type)
+		{
+			${$type}[] = (int) $match[2][$id];
+		}
+
+		$address = array();
+		if (sizeof($u))
+		{
+			$sql = 'SELECT user_id, username, user_colour 
+				FROM ' . USERS_TABLE . '
+				WHERE user_id IN (' . implode(', ', $u) . ')
+					AND user_type = ' . USER_NORMAL;
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
+				{
+					if ($plaintext)
+					{
+						$address[] = $row['username'];
+					}
+					else
+					{
+						$address['user'][$row['user_id']] = array('name' => $row['username'], 'colour' => $row['user_colour']);
+					}
+				}
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		if (sizeof($g))
+		{
+			if ($plaintext)
+			{
+				$sql = 'SELECT group_name
+					FROM ' . GROUPS_TABLE . ' 
+						WHERE group_id IN (' . implode(', ', $g) . ')';
+				$result = $_CLASS['core_db']->query($sql);
+		
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
+					{
+						$address[] = $row['group_name'];
+					}
+				}
+				$_CLASS['core_db']->free_result($result);
+			}
+			else
+			{
+				$sql = 'SELECT g.group_id, g.group_name, g.group_colour, ug.user_id
+					FROM ' . GROUPS_TABLE . ' g, ' . USER_GROUP_TABLE . ' ug
+						WHERE g.group_id IN (' . implode(', ', $g) . ')
+						AND g.group_id = ug.group_id
+						AND ug.user_pending = 0';
+				$result = $_CLASS['core_db']->query($sql);
+		
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					if (!isset($address['group'][$row['group_id']]))
+					{
+						if ($check_type == 'to' || $author_id == $_CLASS['core_user']->data['user_id'] || $row['user_id'] == $_CLASS['core_user']->data['user_id'])
+						{
+							$address['group'][$row['group_id']] = array('name' => $row['group_name'], 'colour' => $row['group_colour']);
+						}
+					}
+	
+					if (isset($address['user'][$row['user_id']]))
+					{
+						$address['user'][$row['user_id']]['in_group'] = $row['group_id'];
+					}
+				}
+				$_CLASS['core_db']->free_result($result);
+			}
+		}
+
+		if (sizeof($address) && !$plaintext)
+		{
+			$_CLASS['core_template']->assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
+
+			foreach ($address as $type => $adr_ary)
+			{
+				foreach ($adr_ary as $id => $row)
+				{
+					$_CLASS['core_template']->assign_vars_array($check_type . '_recipient', array(
+						'NAME'		=> $row['name'],
+						'IS_GROUP'	=> ($type == 'group'),
+						'IS_USER'	=> ($type == 'user'),
+						'COLOUR'	=> ($row['colour']) ? $row['colour'] : '',
+						'UG_ID'		=> $id,
+						'U_VIEW'	=> ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
+					);
+				}
+			}
+		}
+
+		$addresses[$check_type] = $address;
+	}
+
+	return $addresses;
+}
+
+// Get folder status
+function get_folder_status($folder_id, $folder)
+{
+	global $_CLASS, $config;
+
+	if (isset($folder[$folder_id]))
+	{
+		$folder = $folder[$folder_id];
+	}
+	else
+	{
+		return false;
+	}
+
+	$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
+
+	$return = array(
+		'folder_name'	=> $folder['folder_name'], 
+		'cur'			=> $folder['num_messages'],
+		'remaining'		=> $message_limit - $folder['num_messages'],
+		'max'			=> $message_limit,
+		'percent'		=> ($message_limit) ? round(($folder['num_messages'] / $message_limit) * 100) : 100
+	);
+
+	$return['message'] = sprintf($_CLASS['core_user']->lang['FOLDER_STATUS_MSG'], $return['percent'], $return['cur'], $return['max']);
+
+	return $return;
+}
+
+//
+// COMPOSE MESSAGES
+//
+
+// Submit PM
+function submit_pm($mode, $subject, &$data, $update_message, $put_in_outbox = true)
+{
+	global $_CLASS, $config;
+
+	// We do not handle erasing posts here
+	if ($mode == 'delete')
+	{
+		return;
+	}
+
+	// Collect some basic informations about which tables and which rows to update/insert
+	$sql_data = array();
+	$root_level = 0;
+
+	// Recipient Informations
+	$recipients = $to = $bcc = array();
+
+	if ($mode != 'edit')
+	{
+		// Build Recipient List
+		// u|g => array($user_id => 'to'|'bcc')
+		foreach (array('u', 'g') as $ug_type)
+		{
+			if (!empty($data['address_list'][$ug_type]))
+			{
+				foreach ($data['address_list'][$ug_type] as $id => $field)
+				{
+					$field = ($field == 'to') ? 'to' : 'bcc';
+
+					if ($ug_type == 'u')
+					{
+						$recipients[$id] = $field;
+					}
+
+					${$field}[] = $ug_type . '_' . (int) $id;
+				}
+			}
+		}
+
+		if (!empty($data['address_list']['g']))
+		{
+			$sql = 'SELECT group_id, user_id
+				FROM ' . USER_GROUP_TABLE . '
+				WHERE group_id IN (' . implode(', ', array_keys($data['address_list']['g'])) . ')
+					AND user_pending = 0';
+			$result = $_CLASS['core_db']->query($sql);
+	
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
+				$recipients[$row['user_id']] = $field;
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		if (empty($recipients))
+		{
+			trigger_error('NO_RECIPIENT');
+		}
+	}
+
+	$sql = '';
+
+	switch ($mode)
+	{
+		case 'reply':
+		case 'quote':
+			$root_level = ($data['reply_from_root_level']) ? $data['reply_from_root_level'] : $data['reply_from_msg_id']; 
+
+			// Set message_replied switch for this user
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
+				SET replied = 1
+				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+					AND msg_id = ' . $data['reply_from_msg_id'];
+
+		case 'forward':
+		case 'post':
+			$sql_data = array(
+				'root_level'		=> $root_level,
+				'author_id'			=> (int) $_CLASS['core_user']->data['user_id'],
+				'icon_id'			=> $data['icon_id'], 
+				'author_ip' 		=> $_CLASS['core_user']->ip,
+				'message_time'		=> $_CLASS['core_user']->time,
+				'enable_bbcode' 	=> $data['enable_bbcode'],
+				'enable_html' 		=> $data['enable_html'],
+				'enable_smilies' 	=> $data['enable_smilies'],
+				'enable_magic_url' 	=> $data['enable_urls'],
+				'enable_sig' 		=> $data['enable_sig'],
+				'message_subject'	=> $subject,
+				'message_text' 		=> $data['message'],
+				'message_checksum'	=> $data['message_md5'],
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
+				'bbcode_uid'		=> $data['bbcode_uid'],
+				'to_address'		=> implode(':', $to),
+				'bcc_address'		=> implode(':', $bcc)
+			);
+		break;
+
+		case 'edit':
+			$sql_data = array(
+				'icon_id'			=> $data['icon_id'],
+				'message_edit_time'	=> $_CLASS['core_user']->time,
+				'enable_bbcode' 	=> $data['enable_bbcode'],
+				'enable_html' 		=> $data['enable_html'],
+				'enable_smilies' 	=> $data['enable_smilies'],
+				'enable_magic_url' 	=> $data['enable_urls'],
+				'enable_sig' 		=> $data['enable_sig'],
+				'message_subject'	=> $subject,
+				'message_text' 		=> $data['message'],
+				'message_checksum'	=> $data['message_md5'],
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
+				'bbcode_uid'		=> $data['bbcode_uid']
+			);
+		break;
+	}
+
+	$_CLASS['core_db']->transaction();
+
+	if (!empty($sql_data))
+	{
+		if ($mode === 'post' || $mode === 'reply' || $mode === 'quote' || $mode === 'forward')
+		{
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_data));
+			$data['msg_id'] = $_CLASS['core_db']->insert_id(FORUMS_PRIVMSGS_TABLE, 'msg_id');
+		}
+		elseif ($mode === 'edit')
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . ' 
+				SET message_edit_count = message_edit_count + 1, ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data) . ' 
+				WHERE msg_id = ' . $data['msg_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+	
+	if ($mode !== 'edit')
+	{
+		if ($sql)
+		{
+			$_CLASS['core_db']->query($sql);
+		}
+
+		foreach ($recipients as $user_id => $type)
+		{
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+				'msg_id'	=> $data['msg_id'],
+				'user_id'	=> $user_id,
+				'author_id'	=> $_CLASS['core_user']->data['user_id'],
+				'folder_id'	=> PRIVMSGS_NO_BOX,
+				'msg_new'	=> 1,
+				'unread'	=> 1,
+				'forwarded'	=> ($mode == 'forward') ? 1 : 0)
+			));
+		}
+
+		$sql = 'UPDATE ' . USERS_TABLE . ' 
+			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
+			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		// Put PM into outbox
+		if ($put_in_outbox)
+		{
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+				'msg_id'	=> (int) $data['msg_id'],
+				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
+				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
+				'folder_id'	=> PRIVMSGS_OUTBOX,
+				'msg_new'	=> 0,
+				'unread'	=> 0,
+				'forwarded'	=> ($mode == 'forward') ? 1 : 0))
+			);
+		}
+	}
+
+	// Set user last post time
+	if ($mode == 'reply' || $mode == 'quote' || $mode == 'forward' || $mode == 'post')
+	{
+		$sql = 'UPDATE ' . USERS_TABLE . "
+			SET user_last_post_time = {$_CLASS['core_user']->time}
+			WHERE user_id = " . $_CLASS['core_user']->data['user_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Submit Attachments
+	if (!empty($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
+	{
+		$space_taken = $files_added = 0;
+
+		foreach ($data['attachment_data'] as $pos => $attach_row)
+		{
+			if ($attach_row['attach_id'])
+			{
+				// update entry in db if attachment already stored in db and filespace
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . " 
+					SET comment = '" . $_CLASS['core_db']->sql_escape($attach_row['comment']) . "' 
+					WHERE attach_id = " . (int) $attach_row['attach_id'];
+				$_CLASS['core_db']->query($sql);
+			}
+			else
+			{
+				// insert attachment into db 
+				$attach_sql = array(
+					'post_msg_id'		=> $data['msg_id'],
+					'download_count'	=> 0,
+					'topic_id'			=> 0,
+					'in_message'		=> 1,
+					'poster_id'			=> $_CLASS['core_user']->data['user_id'],
+					'physical_filename'	=> basename($attach_row['physical_filename']),
+					'real_filename'		=> basename($attach_row['real_filename']),
+					'comment'			=> $attach_row['comment'],
+					'extension'			=> $attach_row['extension'],
+					'mimetype'			=> $attach_row['mimetype'],
+					'filesize'			=> $attach_row['filesize'],
+					'filetime'			=> $attach_row['filetime'],
+					'thumbnail'			=> $attach_row['thumbnail']
+				);
+
+				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql));
+
+				$space_taken += $attach_row['filesize'];
+
+				$files_added++;
+			}
+		}
+		
+		if (!empty($data['attachment_data']))
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TABLE . '
+				SET message_attachment = 1
+				WHERE msg_id = ' . $data['msg_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+
+		if ($space_taken && $files_added)
+		{
+			set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
+			set_config('num_files', $config['num_files'] + $files_added, true);
+		}
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	// Delete draft if post was loaded...
+	$draft_id = request_var('draft_loaded', 0);
+
+	if ($draft_id)
+	{
+		$sql = 'DELETE FROM ' . DRAFTS_TABLE . " 
+			WHERE draft_id = $draft_id 
+				AND user_id = " . $_CLASS['core_user']->data['user_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Send Notifications
+	if ($mode !== 'edit')
+	{
+		pm_notification($mode, $_CLASS['core_user']->data['username'], $recipients, $subject, $data['message']);
+	}
+
+	return $data['msg_id'];
+}
+
+// PM Notification
+function pm_notification($mode, $author, $recipients, $subject, $message)
+{
+	global $_CLASS, $config;
+return;
+	$subject = censor_text($subject);
+	
+	// Get banned User ID's
+	$sql = 'SELECT ban_userid 
+		FROM ' . BANLIST_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
+
+	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
+	
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		if (isset($row['ban_userid']))
+		{
+			unset($recipients[$row['ban_userid']]);
+		}
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	if (!sizeof($recipients))
+	{
+		return;
+	}
+
+	$recipient_list = implode(', ', array_keys($recipients));
+
+	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
+		FROM ' . USERS_TABLE . "
+		WHERE user_id IN ($recipient_list)";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$msg_list_ary = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		if ($row['user_notify_pm'] == 1 && trim($row['user_email']))
+		{
+			$msg_list_ary[] = array(
+				'method'	=> $row['user_notify_type'],
+				'email'		=> $row['user_email'],
+				'jabber'	=> $row['user_jabber'],
+				'name'		=> $row['username'],
+				'lang'		=> $row['user_lang']
+			);
+		}
+	}
+	$_CLASS['core_db']->free_result($result);
+	
+	if (!sizeof($msg_list_ary))
+	{
+		return;
+	}
+
+	require_once('includes/forums/functions_messenger.php');
+	$messenger = new messenger();
+
+	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
+
+	foreach ($msg_list_ary as $pos => $addr)
+	{
+		$messenger->template('privmsg_notify', $addr['lang']);
+
+		$messenger->replyto($config['board_email']);
+		$messenger->to($addr['email'], $addr['name']);
+		$messenger->im($addr['jabber'], $addr['name']);
+
+		$messenger->assign_vars(array(
+			'EMAIL_SIG'		=> $email_sig,
+			'SITENAME'		=> $config['sitename'],
+			'SUBJECT'		=> $subject,
+			'AUTHOR_NAME'	=> $author,
+			'USERNAME'		=> $addr['name'],
+
+			'U_INBOX'		=> generate_link('Control_Panel&amp;i=pm&mode=unread', array('full' => true, 'sid' => true)))
+		);
+
+		$messenger->send($addr['method']);
+		$messenger->reset();
+	}
+	unset($msg_list_ary);
+
+	if ($messenger->queue)
+	{
+		$messenger->save_queue();
+	}
+
+	unset($messenger);
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -33,111 +33,6 @@
 // 
 // -------------------------------------------------------------
 
-global $_CLASS;
-
-$action = request_var('action', '');
-$quickmod = request_var('quickmod', '');
-
-switch ($mode)
-{
-	case 'lock':
-	case 'unlock':
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		lock_unlock($mode, $topic_ids);
-	break;
-
-	case 'lock_post':
-	case 'unlock_post':
-		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		lock_unlock($mode, $post_ids);
-	break;
-
-	case 'make_announce':
-	case 'make_sticky':
-	case 'make_global':
-	case 'make_normal':
-		
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		change_topic_type($mode, $topic_ids);
-	break;
-
-	case 'move':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_move_topic($topic_ids);
-	break;
-
-	case 'fork':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_fork_topic($topic_ids);
-	break;
-
-	case 'delete_topic':
-		$_CLASS['core_user']->add_lang('viewtopic');
-
-		$topic_ids = (!$quickmod) ? array_unique(request_var('topic_id_list', array(0))) : array(request_var('t', 0));
-
-		if (empty($topic_ids))
-		{
-			trigger_error('NO_TOPIC_SELECTED');
-		}
-
-		mcp_delete_topic($topic_ids);
-	break;
-
-	case 'delete_post':
-		$_CLASS['core_user']->add_lang('posting');
-
-		$post_ids = (!$quickmod) ? array_unique(request_var('post_id_list', array(0))) : array(request_var('p', 0));
-
-		if (empty($post_ids))
-		{
-			trigger_error('NO_POST_SELECTED');
-		}
-
-		mcp_delete_post($post_ids);
-	break;
-
-	default:
-		trigger_error("Unknown mode: $mode");
-	break;
-}
-
-trigger_error('I need to put something here');
-
 // Lock/Unlock Topic/Post
 function lock_unlock($mode, $ids)
 {
@@ -209,7 +104,7 @@
 {
 	global $db, $_CLASS;
 
-	if (!($forum_id = check_ids($topic_ids, TOPICS_TABLE, 'topic_id', 'm_')))
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
 	{
 		return;
 	}
@@ -219,64 +114,68 @@
 		case 'make_announce':
 			$new_topic_type = POST_ANNOUNCE;
 			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_ANNOUNCEMENT' : 'MCP_MAKE_ANNOUNCEMENTS';
+		break;
+
 		case 'make_global':
 			$new_topic_type = POST_GLOBAL;
 			$check_acl = 'f_announce';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_GLOBAL' : 'MCP_MAKE_GLOBALS';
+		break;
+
 		case 'make_sticky':
 			$new_topic_type = POST_STICKY;
 			$check_acl = 'f_sticky';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_STICKY' : 'MCP_MAKE_STICKIES';
+		break;
+
 		default:
 			$new_topic_type = POST_NORMAL;
 			$check_acl = '';
-			$l_new_type = (sizeof($topic_ids) == 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
-			break;
+			$l_new_type = (count($topic_ids) === 1) ? 'MCP_MAKE_NORMAL' : 'MCP_MAKE_NORMALS';
+		break;
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$hidden_fields = build_hidden_fields(array(
 		'topic_id_list'	=> $topic_ids,
-		'f'				=> $forum_id,
 		'mode'			=> $mode,
-		'redirect'		=> $redirect)
-	);
+		'redirect'		=> $redirect
+	));
 	$success_msg = '';
 
-	if (confirm_box(true))
+	if (display_confirmation($_CLASS['core_user']->get_lang($l_new_type), $hidden_fields))
 	{
-		if ($new_topic_type != POST_GLOBAL)
+		if ($new_topic_type !== POST_GLOBAL)
 		{
-			$sql = 'UPDATE ' . TOPICS_TABLE . "
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
 				SET topic_type = $new_topic_type
 				WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
 					AND forum_id <> 0';
-			$db->query($sql);
+			$_CLASS['core_db']->query($sql);
 
-			// Reset forum id if a global topic is within the array
+// do select first
+			/*
 			if ($forum_id)
 			{
 				$sql = 'UPDATE ' . TOPICS_TABLE . "
 					SET topic_type = $new_topic_type, forum_id = $forum_id
 						WHERE topic_id IN (" . implode(', ', $topic_ids) . ')
 						AND forum_id = 0';
-				$db->query($sql);
+				$_CLASS['core_db']->query($sql);
 			}
+			*/
 		}
 		else
 		{
 			$sql = 'UPDATE ' . TOPICS_TABLE . "
 				SET topic_type = $new_topic_type, forum_id = 0
 				WHERE topic_id IN (" . implode(', ', $topic_ids) . ")";
-			$db->query($sql);
+			$_CLASS['core_db']->query($sql);
 		}
 
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
+		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_TYPE_CHANGED' : 'TOPICS_TYPE_CHANGED';
 
 		$data = get_topic_data($topic_ids);
 
@@ -285,12 +184,8 @@
 			add_log('mod', $forum_id, $topic_id, 'LOG_TOPIC_TYPE_CHANGED', $row['topic_title']);
 		}
 	}
-	else
-	{
-		confirm_box(false, $l_new_type, $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link($redirect);
 
 	if (!$success_msg)
 	{
@@ -431,7 +326,7 @@
 		// Now sync forums
 		sync('forum', 'forum_id', $forum_ids);
 
-		$success_msg = (sizeof($topic_ids) == 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
+		$success_msg = (count($topic_ids) === 1) ? 'TOPIC_MOVED_SUCCESS' : 'TOPICS_MOVED_SUCCESS';
 	}
 
 	$redirect = generate_link($redirect);
@@ -456,7 +351,7 @@
 // Delete Topics
 function mcp_delete_topic($topic_ids)
 {
-	global $_CLASS, $db;
+	global $_CLASS;
 
 	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_delete'))
 	{
@@ -486,8 +381,6 @@
 		}
 
 		$return = delete_topics('topic_id', $topic_ids, true);
-
-		// TODO: Adjust total post count...
 	}
 
 	$redirect = generate_link($redirect);
@@ -499,7 +392,7 @@
 	else
 	{
 		$_CLASS['core_display']->meta_refresh(3, $redirect);
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'. $redirect . '">', '</a>'));
 	}
 }
 
@@ -508,33 +401,35 @@
 {
 	global $_CLASS, $db;
 
-	if (!($forum_id = check_ids($post_ids, POSTS_TABLE, 'post_id', 'm_delete')))
+	if (!check_ids($post_ids, FORUMS_POSTS_TABLE, 'post_id', 'm_delete'))
 	{
 		return;
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$s_hidden_fields = build_hidden_fields(array(
+	$hidden_fields = build_hidden_fields(array(
 		'post_id_list'	=> $post_ids,
-		'f'				=> $forum_id,
 		'mode'			=> 'delete_post',
-		'redirect'		=> $redirect)
-	);
+		'redirect'		=> $redirect
+	));
+
 	$success_msg = '';
+	$message = $_CLASS['core_user']->get_lang((count($post_ids) === 1) ? 'DELETE_POST' : 'DELETE_POSTS');
 
-	if (confirm_box(true))
+	if (display_confirmation($message, $hidden_fields))
 	{
 		// Count the number of topics that are affected
 		// I did not use COUNT(DISTINCT ...) because I remember having problems
 		// with it on older versions of MySQL -- Ashe
 
 		$sql = 'SELECT DISTINCT topic_id
-			FROM ' . POSTS_TABLE . '
+			FROM ' . FORUMS_POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 		$result = $db->query($sql);
 
 		$topic_id_list = array();
+
 		while ($row = $db->sql_fetchrow($result))
 		{
 			$topic_id_list[] = $row['topic_id'];
@@ -596,12 +491,8 @@
 			}
 		}
 	}
-	else
-	{
-		confirm_box(false, (sizeof($post_ids) == 1) ? 'DELETE_POST' : 'DELETE_POSTS', $s_hidden_fields);
-	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = generate_link('Forums');
 
 	if (!$success_msg)
 	{
@@ -624,7 +515,7 @@
 		return;
 	}
 
-	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 	$to_forum_id = get_variable('to_forum_id', 'POST', 0, 'int');
 
 	$additional_msg = $success_msg = '';
@@ -846,7 +737,7 @@
 	else
 	{
 		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id));
-		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $to_forum_id) . '">', '</a>');
+		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href="'. $redirect . '">', '</a>');
 
 		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);
 	}

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -155,7 +155,7 @@
 	
 	function check_bbcode($bbcode, &$in)
 	{
-		$in = trim($in);
+		$in = str_replace("\r\n", "\n", str_replace('\"', '"', trim($in)));
 
 		if (!$in)
 		{

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/functions.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -26,6 +26,7 @@
 {
 	//Code Copyright 2004 phpBB Group - http://www.phpbb.com/
 	return preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email);
+	//preg_match('#^.*?@(.*?\.)?[a-z0-9\-]+\.[a-z]{2,4}$#i', $email)
 }
 
 function check_bot_status($browser, $ip)
@@ -195,6 +196,11 @@
 
 function check_theme($theme)
 {
+	if (mb_strpos($theme, '.') !== false)
+	{
+		return false;
+	}
+
 	return file_exists(SITE_FILE_ROOT.'themes/'.$theme.'/index.php');
 }
 
@@ -330,7 +336,7 @@
 		{
 		 	case 'int':
 		 	case 'integer':
-				$variable = is_numeric($variable) ? (int) $variable : $default;
+				return is_numeric($variable) ? (int) $variable : $default;
 			break;
 
 			case 'array':
@@ -344,14 +350,33 @@
 				{
 					$variable[$key] = strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $value), "\n")));
 				}
+
+				return $variable;
 			break;
+			
+			case 'array:int':
+			case 'array:integer':
+				if (!is_array($variable))
+				{
+					return $default;
+				}
 
+// need to add a function here to loop multi... arrays
+				foreach ($variable as $key => $value)
+				{
+					if (is_numeric($value))
+					{
+						$variable[$key] = (int) $value;
+					}
+				}
+
+				return $variable;
+			break;
+
 			default:
-				$variable = strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $variable), "\n")));
+				return strip_slashes(trim(modify_lines(str_replace('\xFF', ' ', $variable), "\n")));
 			break;
 		}
-
-		return $variable;
 	}
 }
 
@@ -728,7 +753,14 @@
 {
 	$url = ($url) ? str_replace('&amp;', '&', $url) : generate_link();
 
-	header('Location: ' . $url);
+	if (preg_match('#Microsoft|WebSTAR|Xitami#', $_SERVER['SERVER_SOFTWARE']))
+	{
+		header('Refresh: 0; url=' . $url);
+	}
+	else
+	{
+		header('Location: ' . $url);
+	}
 
 	header('P3P: CP="CAO DSP COR CURa ADMa DEVa OUR IND PHY ONL UNI COM NAV INT DEM PRE"');
 	header('Cache-Control: private, pre-check=0, post-check=0, max-age=0');
@@ -754,12 +786,19 @@
 {
 }
 
-function select_theme($default = false)
+function select_theme($default = false, $system = false)
 {
 	global $_CLASS;
 
-	if (!$default)
+	$select = '';
+
+	if ($system)
 	{
+		$selected = (!$default) ? ' selected="selected"' : '';
+		$select .= "<option value=\"\" $selected> - Site Default - </option>\n";
+	}
+	elseif (!$default)
+	{
 		$default = $_CLASS['core_display']->theme_name;
 	}
 
@@ -768,7 +807,7 @@
 	
 	while ($file = readdir($handle))
 	{
-		if (!mb_strpos($file, '.'))
+		if (mb_strpos($file, '.') === false)
 		{
 			if (file_exists(SITE_FILE_ROOT."themes/$file/index.php"))
 			{
@@ -780,7 +819,6 @@
 	closedir($handle);
 	
 	$count = count($theme_array);
-	$select = '';
 
 	for ($i = 0; $i < $count; $i++)
 	{
@@ -797,20 +835,27 @@
 			'1', '2', '3','3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7', '8', '9.5', '10', '11', '12');
 }
 
-function select_tz($default = false)
+function select_tz($default = false, $system = false)
 {
 	global $_CLASS;
 
+	$select = '';
+
+	if ($system)
+	{
+		$selected = (!$default) ? ' selected="selected"' : '';
+		$select .= "<option value=\"\" $selected> - Site Default - </option>\n";
+	}
+	/*
+	elseif (!$default)
+	{
+		$default = $_CORE_CONFIG['global']['default_timezone'] / 3600;
+	}
+	*/
+
 	$tz_array = tz_array();
+	$count = count($tz_array);
 
-	$count = count($tz_array);
-	$select = '';
-	
-	/*if (!$default)
-	{
-		$default = $_CORE_CONFIG['global']['default_timezone'];
-	}*/
-	
 	for ($i = 0; $i < $count; $i++)
 	{
 		$selected = ($tz_array[$i] == $default) ? ' selected="selected"' : '';

Modified: cms/trunk/includes/templates/confirmation.html
===================================================================
--- cms/trunk/includes/templates/confirmation.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/confirmation.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <form action="{ $CONFIRM_ACTION }" method="post">
 	<table class="tablebg" border="0" cellpadding="0" cellspacing="1" width="100%">
@@ -19,6 +19,6 @@
 	</table>
 </form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/members_list/email_notify.txt
===================================================================
--- cms/trunk/includes/templates/en/email/members_list/email_notify.txt	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/en/email/members_list/email_notify.txt	2005-09-27 23:57:50 UTC (rev 143)
@@ -0,0 +1,15 @@
+Hello { $TO_USERNAME },
+
+This email was sent from "{ $SITENAME }" by { $FROM_USERNAME } who thought you may be interested in the following topic:
+
+{ $TOPIC_NAME } 
+
+You can find it at:
+
+{ $U_TOPIC } 
+
+A message from { $USERNAME } may also be included below. Please note that this message has not been seen or approved by the board administrators. If you wish to complain about having received this email please contact the board administrator { $CONTACT_EMAIL }. Please quote the the message headers when contacting this address.
+
+----------
+
+{ $MESSAGE } 
\ No newline at end of file

Added: cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt
===================================================================
--- cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/en/email/members_list/profile_send_email.txt	2005-09-27 23:57:50 UTC (rev 143)
@@ -0,0 +1,12 @@
+Hello { $TO_USERNAME },
+
+The following is an email sent to you by { $FROM_USERNAME } via your account on { $SITENAME }. If this message is spam, contains abusive or other comments you find offensive please contact the webmaster of the board at the following address:
+
+{ $BOARD_EMAIL } 
+
+Include this full email (particularly the headers). Please note that the reply address to this email has been set to that of { $FROM_USERNAME }.
+
+Message sent to you follows
+~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+{ $MESSAGE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/login_body.html
===================================================================
--- cms/trunk/includes/templates/login_body.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/login_body.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <form action="{ $S_LOGIN_ACTION }" method="post">
 
@@ -75,6 +75,6 @@
 	</tr>
 </table></form>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Contact/index.html
===================================================================
--- cms/trunk/includes/templates/modules/Contact/index.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Contact/index.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,6 +1,6 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <form method="post" action="{ $ACTION }" >
     <table width="100%">
@@ -41,6 +41,6 @@
 </table>
 <!-- ENDIF -->
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_attachments.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -14,52 +14,53 @@
 //-->
 </script>
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th nowrap="nowrap">#</th>
-		<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_FILENAME }">{ $L_FILENAME }</a></th>
-		<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_POST_TIME }">{ $L_POST_TIME }</a></th>
-		<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_FILESIZE }">{ $L_FILESIZE }</a></th>
-		<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_DOWNLOADS }">{ $L_DOWNLOADS }</a></th>
-		<th width="2%" nowrap="nowrap">{ $L_DELETE }</th>
-	</tr>
-	<!-- IF { $TOTAL_ATTACHMENTS } -->
-	<tr>
-		<td class="row3" colspan="6">
-			<table width="100%" cellspacing="1">
-			<tr>
-				<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-				<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_ATTACHMENTS } ]&nbsp;</td>
-				<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-			</tr>
-			</table>
-		</td>
-	</tr>
-	<!-- ENDIF -->
-	
-	<!-- LOOP $attachrow -->
-		<!-- IF { $attachrow:#LOOP_INDEX } % 2 -->
-		<tr class="row2">
-		<!-- ELSE -->
-		<tr class="row1">
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th nowrap="nowrap">#</th>
+			<th nowrap="nowrap" width="15%"><a class="th" href="{ $U_SORT_FILENAME }">{ $L_FILENAME }</a></th>
+			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_POST_TIME }">{ $L_POST_TIME }</a></th>
+			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_FILESIZE }">{ $L_FILESIZE }</a></th>
+			<th nowrap="nowrap" width="5%"><a class="th" href="{ $U_SORT_DOWNLOADS }">{ $L_DOWNLOADS }</a></th>
+			<th width="2%" nowrap="nowrap">{ $L_DELETE }</th>
+		</tr>
+		<!-- IF { $TOTAL_ATTACHMENTS } -->
+		<tr>
+			<td class="row3" colspan="6">
+				<table width="100%" cellspacing="1">
+				<tr>
+					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
+					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_ATTACHMENTS } ]&nbsp;</td>
+					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+				</tr>
+				</table>
+			</td>
+		</tr>
 		<!-- ENDIF -->
-
-		<td class="genmed" style="padding: 4px;" align="center" width="2%">&nbsp;{ $attachrow:ROW_NUMBER }&nbsp;</td>
-		<td style="padding: 4px;"><a class="gen" href="{ $attachrow:U_VIEW_ATTACHMENT }" target="file">{ $attachrow:FILENAME }</a><br /><span class="gensmall"><!-- IF { $attachrow:S_IN_MESSAGE } --><b>{ $L_PM }: </b><!-- ELSE --><b>{ $L_TOPIC }: </b><!-- ENDIF --><a href="{ $attachrow:U_VIEW_TOPIC }">{ $attachrow:TOPIC_TITLE }</a></span></td>
-		<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">&nbsp;{ $attachrow:POST_TIME }&nbsp;</td>
-		<td class="genmed" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">{ $attachrow:SIZE }</td>
-		<td class="genmed" style="padding: 4px;" align="center">{ $attachrow:DOWNLOAD_COUNT }</td>
-		<td style="padding: 4px;" align="center" valign="middle"><input type="checkbox" name="attachment[{ $attachrow:ATTACH_ID }]" value="1" /></td>
-	</tr>
-	<!-- ENDLOOP -->
+		
+		<!-- LOOP $attachrow -->
+			<!-- IF { $attachrow:#LOOP_INDEX } % 2 -->
+			<tr class="row2">
+			<!-- ELSE -->
+			<tr class="row1">
+			<!-- ENDIF -->
 	
-	<tr> 
-		<td class="cat" colspan="6"><div style="float:left"><span class="gensmall">{ $L_SORT_BY }: </span><select name="sk">{$S_SORT_OPTIONS}</select> <select name="sd">{ $S_ORDER_SELECT }</select>&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_SORT }" /></div><div style="float:right"><input class="btnlite" type="submit" name="delete" value="{ $L_DELETE_MARKED }" />&nbsp;</div></td>
-	</tr>
-</table>
-
-<div style="float:right"><b class="gensmall"><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
-
+			<td class="genmed" style="padding: 4px;" align="center" width="2%">&nbsp;{ $attachrow:ROW_NUMBER }&nbsp;</td>
+			<td style="padding: 4px;"><a class="gen" href="{ $attachrow:U_VIEW_ATTACHMENT }" target="file">{ $attachrow:FILENAME }</a><br /><span class="gensmall"><!-- IF { $attachrow:S_IN_MESSAGE } --><b>{ $L_PM }: </b><!-- ELSE --><b>{ $L_TOPIC }: </b><!-- ENDIF --><a href="{ $attachrow:U_VIEW_TOPIC }">{ $attachrow:TOPIC_TITLE }</a></span></td>
+			<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">&nbsp;{ $attachrow:POST_TIME }&nbsp;</td>
+			<td class="genmed" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">{ $attachrow:SIZE }</td>
+			<td class="genmed" style="padding: 4px;" align="center">{ $attachrow:DOWNLOAD_COUNT }</td>
+			<td style="padding: 4px;" align="center" valign="middle"><input type="checkbox" name="attachment[{ $attachrow:ATTACH_ID }]" value="1" /></td>
+		</tr>
+		<!-- ENDLOOP -->
+		
+		<tr> 
+			<td class="cat" colspan="6"><div style="float:left"><span class="gensmall">{ $L_SORT_BY }: </span><select name="sk">{$S_SORT_OPTIONS}</select> <select name="sd">{ $S_ORDER_SELECT }</select>&nbsp;<input class="button" type="submit" name="sort" value="{ $L_SORT }" /></div><div style="float:right"><input class="button" type="submit" name="delete" value="{ $L_DELETE_MARKED }" />&nbsp;</div></td>
+		</tr>
+	</table>
+	<br />
+	<div style="float:right"><b class="gensmall"><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
+</form>
 <!-- ELSE -->
 
 <table class="tablebg" width="100%" cellspacing="1">

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,7 +1,3 @@
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
-<!-- IF { $S_DISPLAY_FORM } -->
-</form>
-<!-- ENDIF -->
-
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_groups_membership.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,68 +1,69 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2">{ $L_USERGROUPS }</th>
-	</tr>
-	<tr>
-		<td class="row3" colspan="2"><span class="genmed">{ $L_GROUPS_EXPLAIN }</span></td>
-	</tr>
-
-	<tr>
-		<th colspan="1">{ $L_GROUP_DETAILS }</td>
-		<th>{ $L_MARK }</td>
-	</tr>
-
-	<!-- IF isset({ $leader }) -->
-	<tr>
-		<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_LEADER }</b></td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- LOOP $leader -->
-	<tr>
-		<td class="row1"><b class="genmed"><a href="{ $leader:U_VIEW_GROUP }">{ $leader:GROUP_NAME }</a></b><!-- IF { $leader:GROUP_DESC } --><p class="forumdesc">{ $leader:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $leader:GROUP_ID }" /><!-- ENDIF --></td>
-	</tr>
-	<!-- ENDLOOP -->
-
-	<!-- IF isset({ $member }) -->
-	<tr>
-		<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_MEMBER }</b></td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- LOOP $member -->
-	<tr>
-		<td class="row1"><b class="genmed"><a href="{ $member:U_VIEW_GROUP }">{ $member:GROUP_NAME }</a></b><!-- IF { $member:GROUP_DESC } --><p class="forumdesc">{ $member:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $member:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
-	</tr>
-	<!-- ENDLOOP -->
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2">{ $L_USERGROUPS }</th>
+		</tr>
+		<tr>
+			<td class="row3" colspan="2"><span class="genmed">{ $L_GROUPS_EXPLAIN }</span></td>
+		</tr>
+		<tr>
+			<th colspan="1">{ $L_GROUP_DETAILS }</th>
+			<th>{ $L_MARK }</th>
+		</tr>
 	
-	<!-- IF isset({ $pending }) -->
-	<tr>
-		<td class="row3" colspan="2"><b class="gensmall">{$L_GROUP_PENDING}</b></td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- LOOP $pending -->
-	<tr>
-		<td class="row1"><b class="genmed"><a href="{ $pending:U_VIEW_GROUP }">{ $pending:GROUP_NAME }</a></b><!-- IF { $pending:GROUP_DESC } --><p class="forumdesc">{ $pending:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $pending:GROUP_ID }" /><!-- ENDIF --></td>
-	</tr>
-	<!-- ENDLOOP -->
+		<!-- IF isset({ $leader }) -->
+		<tr>
+			<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_LEADER }</b></td>
+		</tr>
+		<!-- LOOP $leader -->
+		<tr>
+			<td class="row1"><b class="genmed"><a href="{ $leader:U_VIEW_GROUP }">{ $leader:GROUP_NAME }</a></b><!-- IF { $leader:GROUP_DESC } --><p class="forumdesc">{ $leader:GROUP_DESC }</p><!-- ENDIF --></td>
+			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $leader:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $leader:GROUP_ID }" /><!-- ENDIF --></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<!-- ENDIF -->
 	
-	<!-- IF isset({ $nonmember }) -->
-	<tr>
-		<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_NONMEMBER}</b></td>
-	</tr>
-	<!-- ENDIF -->
-	<!-- LOOP $nonmember -->
-	<tr>
-		<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
-		<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $nonmember:GROUP_ID }" /><!-- ENDIF --></td>
-	</tr>
-	<!-- ENDLOOP -->
-	<tr>
-		<td class="cat" colspan="3"></div><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="apply">Apply marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="btnmain" type="submit" name="submit" value="{$L_SUBMIT}" />&nbsp;</div></td>
-	</tr>
-</table>
+		<!-- IF isset({ $member }) -->
+		<tr>
+			<td class="row3" colspan="2"><b class="gensmall">{ $L_GROUP_MEMBER }</b></td>
+		</tr>
+		<!-- LOOP $member -->
+		<tr>
+			<td class="row1"><b class="genmed"><a href="{ $member:U_VIEW_GROUP }">{ $member:GROUP_NAME }</a></b><!-- IF { $member:GROUP_DESC } --><p class="forumdesc">{ $member:GROUP_DESC }</p><!-- ENDIF --></td>
+			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $member:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $member:GROUP_ID }" /><!-- ENDIF --></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<!-- ENDIF -->
+	
+		<!-- IF isset({ $pending }) -->
+		<tr>
+			<td class="row3" colspan="2"><b class="gensmall">{$L_GROUP_PENDING}</b></td>
+		</tr>
+		<!-- LOOP $pending -->
+		<tr>
+			<td class="row1"><b class="genmed"><a href="{ $pending:U_VIEW_GROUP }">{ $pending:GROUP_NAME }</a></b><!-- IF { $pending:GROUP_DESC } --><p class="forumdesc">{ $pending:GROUP_DESC }</p><!-- ENDIF --></td>
+			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $pending:GROUP_RESIGN } --><input type="checkbox" name="group_id[]" value="{ $pending:GROUP_ID }" /><!-- ENDIF --></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<!-- ENDIF -->
+	
+		<!-- IF isset({ $nonmember }) -->
+		<tr>
+			<td class="row3" colspan="3"><b class="gensmall">{$L_GROUP_NONMEMBER}</b></td>
+		</tr>
+		<!-- LOOP $nonmember -->
+		<tr>
+			<td class="row1"><b class="genmed"><a href="{$nonmember:U_VIEW_GROUP}">{ $nonmember:GROUP_NAME }</a></b><!-- IF { $nonmember:GROUP_DESC } --><p class="forumdesc">{ $nonmember:GROUP_DESC }</p><!-- ENDIF --></td>
+			<td class="row1" width="6%" align="center" nowrap="nowrap"><!-- IF { $nonmember:GROUP_APPLY } --><input type="checkbox" name="group_id[]" value="{ $nonmember:GROUP_ID }" /><!-- ENDIF --></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<!-- ENDIF -->
+		<tr>
+			<td class="cat" colspan="3"><div style="float:right"><span class="genmed">Select: </span><select name="mode"><option value="apply">Apply marked</option><option value="resign">Resign marked</option><option value="demote">Demote marked</option></select>&nbsp;<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;</div></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,7 +1,3 @@
 <!-- DISPLAY_HEADER -->
 
-<!-- IF { $S_DISPLAY_FORM } -->
-<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
-<!-- ENDIF -->
-
-{ $A_TABLE_OPEN }
\ No newline at end of file
+{ $THEME_TABLE_OPEN }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_message_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -20,23 +20,32 @@
 
 <table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
 	<tr>
-		<td class="row1"><table border="0" cellspacing="0" cellpadding="0" width="100%"><tr><td align="left">
-		<!-- IF { $TOTAL_MESSAGES } -->
-			<table width="100%" cellspacing="1">
+		<td class="row1">
+			<table border="0" cellspacing="0" cellpadding="0" width="100%">
 				<tr>
-					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;</td>
-					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+					<td align="left">
+					<!-- IF { $TOTAL_MESSAGES } -->
+						<table width="100%" cellspacing="1">
+							<tr>
+								<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
+								<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_MESSAGES } ]&nbsp;</td>
+								<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+							</tr>
+						</table>
+					<!-- ENDIF -->
+					<!-- IF { $S_VIEW_MESSAGE } -->
+					<span class="gensmall">
+					<!-- IF { $S_DISPLAY_HISTORY } --><a href="{ $U_VIEW_PREVIOUS_HISTORY }">{ $L_VIEW_PREVIOUS_HISTORY }</a> | <a href="{ $U_VIEW_NEXT_HISTORY }">{ $L_VIEW_NEXT_HISTORY }</a> | <!-- ENDIF --><a href="{ $U_PREVIOUS_PM }">{ $L_VIEW_PREVIOUS_PM }</a> | <a href="{ $U_NEXT_PM }">{ $L_VIEW_NEXT_PM }</a>&nbsp;
+					</span>
+					<!-- ENDIF -->
+					</td>
+					<td align="right" nowrap="nowrap">
+						<form name="choosefolder" method="post" action="{ $S_FOLDER_ACTION }" style="margin:0px">
+							<select name="f">{ $S_FOLDER_OPTIONS }</select>&nbsp;<input class="bottom" type="submit" name="folder" value="{ $L_GO }" />
+						</form>
+					</td>
 				</tr>
 			</table>
-		<!-- ENDIF -->
-		<!-- IF { $S_VIEW_MESSAGE } -->
-		<span class="gensmall">
-		<!-- IF { $S_DISPLAY_HISTORY } --><a href="{ $U_VIEW_PREVIOUS_HISTORY }">{ $L_VIEW_PREVIOUS_HISTORY }</a> | <a href="{ $U_VIEW_NEXT_HISTORY }">{ $L_VIEW_NEXT_HISTORY }</a> | <!-- ENDIF --><a href="{ $U_PREVIOUS_PM }">{ $L_VIEW_PREVIOUS_PM }</a> | <a href="{ $U_NEXT_PM }">{ $L_VIEW_NEXT_PM }</a>&nbsp;
-		</span>
-		<!-- ENDIF -->
-		</td><td align="right" nowrap="nowrap"><form name="choosefolder" method="post" action="{ $S_FOLDER_ACTION }" style="margin:0px">
-			<select name="f">{ $S_FOLDER_OPTIONS }</select>&nbsp;<input class="bottom" type="submit" name="folder" value="{ $L_GO }" /></form>
-		</td></tr></table></td>
+		</td>
 	</tr>
 </table>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_options.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -24,21 +24,21 @@
 	<tr>
 		<td class="row1" width="50" align="left" valign="top"><b class="gen">{ $L_IF }:</b></td>
 		<td class="row2" align="center" valign="top"><!-- IF { $S_CHECK_SELECT } --><select name="check_option">{ $S_CHECK_OPTIONS }</select><!-- ELSE --><b class="gen">{ $CHECK_CURRENT }</b><input type="hidden" name="check_option" value="{ $CHECK_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_CHECK_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_CHECK_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 	</tr>
 	<!-- ENDIF -->
 	<!-- IF { $S_RULE_DEFINED } -->
 	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="back[rule]" value="{ $L_PREVIOUS }" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="back[rule]" value="{ $L_PREVIOUS }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 		<td class="row2" align="center" valign="top"><!-- IF { $S_RULE_SELECT } --><select name="rule_option">{ $S_RULE_OPTIONS }</select><!-- ELSE --><b class="gen">{ $RULE_CURRENT }</b><input type="hidden" name="rule_option" value="{ $RULE_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_RULE_SELECT } --><input type="submit" name="next" value="{ $L_NEXT }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 	</tr>
 	<!-- ENDIF -->
 	
 	<!-- IF { $S_COND_DEFINED } -->
 	<!-- IF { $S_COND_SELECT } || { $COND_CURRENT } -->
 	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="back[cond]" value="{ $L_PREVIOUS }" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="back[cond]" value="{ $L_PREVIOUS }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 		<td class="row2" align="center" valign="top">
 		<!-- IF { $S_COND_SELECT } -->
 			<!-- IF { $S_TEXT_CONDITION } -->
@@ -53,7 +53,7 @@
 				<input type="hidden" name="rule_string" value="{ $CURRENT_STRING }" /><input type="hidden" name="rule_user_id" value="{ $CURRENT_USER_ID }" /><input type="hidden" name="rule_group_id" value="{ $CURRENT_GROUP_ID }" />
 		<!-- ENDIF -->
 		</td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="next" value="{$L_NEXT}" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_COND_SELECT } --><input type="submit" name="next" value="{$L_NEXT}" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 	</tr>
 	<!-- ENDIF -->
 	<input type="hidden" name="cond_option" value="{ $COND_OPTION }" />
@@ -62,9 +62,9 @@
 
 	<!-- IF { $S_ACTION_DEFINED } -->
 	<tr>
-		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="back[action]" value="{$L_PREVIOUS}" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="left" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="back[action]" value="{$L_PREVIOUS}" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 		<td class="row2" align="center" valign="top"><!-- IF { $S_ACTION_SELECT } --><select name="action_option">{ $S_ACTION_OPTIONS }</select><!-- ELSE --><b class="gen">{ $ACTION_CURRENT }</b><input type="hidden" name="action_option" value="{ $ACTION_OPTION }" /><!-- ENDIF --></td>
-		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="add_rule" value="{ $L_ADD_RULE }" class="bottom" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
+		<td class="row1" width="50" align="right" valign="top"><!-- IF { $S_ACTION_SELECT } --><input type="submit" name="add_rule" value="{ $L_ADD_RULE }" class="button" /><!-- ELSE -->&nbsp;<!-- ENDIF --></td>
 	</tr>
 	<!-- ENDIF -->
 </table>
@@ -82,7 +82,7 @@
 		<td class="row1" width="120"><span class="gen">{ $rule:RULE }</span></td>
 		<td class="row2" width="120"><span class="gen"><!-- IF { $rule:STRING } -->{ $rule:STRING} <!-- ENDIF --></span></td>
 		<td class="row1"><span class="gen">{ $rule:ACTION }<!-- IF { $rule:FOLDER }  --> { $rule:FOLDER }<!-- ENDIF --></span></td>
-		<td class="row2" width="25"><input type="submit" name="delete_rule[{ $rule:RULE_ID }]" value="{ $L_DELETE_RULE }" class="bottom" /></td>
+		<td class="row2" width="25"><input type="submit" name="delete_rule[{ $rule:RULE_ID }]" value="{ $L_DELETE_RULE }" class="button" /></td>
 	</tr>
 	<!-- LOOPELSE -->
 	<tr>
@@ -107,7 +107,7 @@
 		<td class="row1"><input type="text" class="post" name="foldername" size="30" maxlength="30" /></td>
 	</tr>
 	<tr>
-		<td class="row1" align="right" colspan="2"><input class="bottom" style="width:150px" type="submit" name="addfolder" value="{ $L_ADD }" /></td>
+		<td class="row1" align="right" colspan="2"><input class="button" style="width:150px" type="submit" name="addfolder" value="{ $L_ADD }" /></td>
 	</tr>
 	<!-- ENDIF -->
 </table>
@@ -115,13 +115,32 @@
 <div style="padding: 2px;"></div>
 
 <!-- IF { $S_FOLDER_OPTIONS } -->
+<table class="tablebg" width="100%" cellspacing="1">
+	<tr>
+		<th colspan="2">{ $L_RENAME_FOLDER }</th>
+	</tr>
+	<tr>
+		<td class="row1" width="200"><b class="gen">{ $L_RENAME_FOLDER }: </b></td>
+		<td class="row1"><select name="rename_folder_id">{ $S_FOLDER_OPTIONS }</select></td>
+	</tr>
+	<tr>
+		<td class="row1" width="200"><b class="gen">{ $L_NEW_FOLDER_NAME }: </b></td>
+		<td class="row1"><input type="text" class="post" name="new_folder_name" size="30" maxlength="30" /></td>
+	</tr>
+	<tr>
+		<td class="row1" align="right" colspan="2"><input class="button" style="width:150px" type="submit" name="rename_folder" value="{ $L_RENAME }" /></td>
+	</tr>
+</table>
+
+<div style="padding: 2px;"></div>
+
 <table class="tablebg" width="100%" cellspacing="1">
 	<tr>
 		<th colspan="3">{ $L_REMOVE_FOLDER }</th>
 	</tr>
 	<tr>
 		<td class="row1" width="200"><b class="gen">{ $L_REMOVE_FOLDER }: </b></td>
-		<td class="row1"><select name="removefolder">{ $S_FOLDER_OPTIONS }</select></td>
+		<td class="row1"><select name="remove_folder_id">{ $S_FOLDER_OPTIONS }</select></td>
 		<td class="row1"><b class="genmed">{ $L_AND }</b></td>
 	</tr>
 	<tr>
@@ -134,9 +153,8 @@
 	</tr>
 	<tr>
 		<td class="row2" width="200">&nbsp;</td>
-		<td class="row2" colspan="2" align="right"><input class="bottom" style="width:150px" type="submit" name="remove" value="{ $L_REMOVE }" /></td>
+		<td class="row2" colspan="2" align="right"><input class="button" style="width:150px" type="submit" name="remove_folder" value="{ $L_REMOVE }" /></td>
 	</tr>
-
 </table>
 
 <div style="padding: 2px;"></div>
@@ -163,7 +181,7 @@
 		<td class="row2"><span class="genmed">{ $DEFAULT_ACTION }</span></td>
 	</tr>
 	<tr>
-		<td class="row1" colspan="2" align="right"><input class="bottom" style="width:150px" type="submit" name="fullfolder" value="{ $L_CHANGE }" /></td>
+		<td class="row1" colspan="2" align="right"><input class="button" style="width:150px" type="submit" name="fullfolder" value="{ $L_CHANGE }" /></td>
 	</tr>
 </table>
 

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_personal.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,74 +1,75 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_SHOW_EMAIL }:</b></td>
-		<td class="row2"><input type="radio" name="viewemail" value="1" { $VIEW_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="viewemail" value="0" { $VIEW_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_ADMIN_EMAIL }:</b></td>
-		<td class="row2"><input type="radio" name="massemail" value="1" { $ADMIN_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="massemail" value="0" { $ADMIN_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_ALLOW_PM }:</b><br /><span class="gensmall">{ $L_ALLOW_PM_EXPLAIN }</span></td>
-		<td class="row2"><input type="radio" name="allowpm" value="1" { $ALLOW_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="allowpm" value="0" { $ALLOW_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<!-- IF { $S_CAN_HIDE_ONLINE } -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_HIDE_ONLINE }:</b></td>
-		<td class="row2"><input type="radio" name="hideonline" value="1" { $HIDE_ONLINE_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="hideonline" value="0" { $HIDE_ONLINE_NO } /><span class="genmed">{$L_NO }</span></td>
-	</tr>
-	<!-- ENDIF --><!-- IF { $S_SELECT_NOTIFY } -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_METHOD }:</b><br /><span class="gensmall">{ $L_NOTIFY_METHOD_EXPLAIN }</span></td>
-		<td class="row2"><input type="radio" name="notifymethod" value="0" { $NOTIFY_EMAIL } /><span class="genmed">{ $L_NOTIFY_METHOD_EMAIL }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="1" { $NOTIFY_IM } /><span class="genmed">{ $L_NOTIFY_METHOD_IM }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="2"{$NOTIFY_BOTH} /><span class="genmed">{$L_NOTIFY_METHOD_BOTH}</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_ON_PM }:</b></td>
-		<td class="row2"><input type="radio" name="notifypm" value="1" { $NOTIFY_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="notifypm" value="0" { $NOTIFY_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{$L_POPUP_ON_PM}:</b></td>
-		<td class="row2"><input type="radio" name="popuppm" value="1" { $POPUP_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="popuppm" value="0" { $POPUP_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_REPORT_PM_NOTIFY }:</b><br /><span class="gensmall">{ $L_REPORT_PM_NOTIFY_EXPLAIN }</span></td>
-		<td class="row2"><input type="radio" name="report_pm_notify" value="1" { $REPORT_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="report_pm_notify" value="0"{$REPORT_PM_NO} /><span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_LANGUAGE }:</b></td>
-		<td class="row2"><select name="lang">{ $S_LANG_OPTIONS }</select></td>
-	</tr>
-	<!-- IF { $S_THEME_OPTIONS } -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_THEME }:</b></td>
-		<td class="row2"><select name="theme">{ $S_THEME_OPTIONS }</select></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_TIMEZONE }:</b></td>
-		<td class="row2"><select name="tz">{ $S_TZ_OPTIONS }</select></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DST }:</b></td>
-		<td class="row2"><input type="radio" name="dst" value="1"{ $DST_YES } /> <span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="dst" value="0"{ $DST_NO } /> <span class="genmed">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DATE_FORMAT }:</b><br /><span class="gensmall">{ $L_BOARD_DATE_FORMAT_EXPLAIN }</span></td>
-		<td class="row2"><input type="text" name="dateformat" value="{ $DATE_FORMAT }" maxlength="14" class="post" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
-
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_SHOW_EMAIL }:</b></td>
+			<td class="row2"><input type="radio" name="viewemail" value="1" { $VIEW_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="viewemail" value="0" { $VIEW_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_ADMIN_EMAIL }:</b></td>
+			<td class="row2"><input type="radio" name="massemail" value="1" { $ADMIN_EMAIL_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="massemail" value="0" { $ADMIN_EMAIL_NO } /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_ALLOW_PM }:</b><br /><span class="gensmall">{ $L_ALLOW_PM_EXPLAIN }</span></td>
+			<td class="row2"><input type="radio" name="allowpm" value="1" { $ALLOW_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="allowpm" value="0" { $ALLOW_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<!-- IF { $S_CAN_HIDE_ONLINE } -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_HIDE_ONLINE }:</b></td>
+			<td class="row2"><input type="radio" name="hideonline" value="1" { $HIDE_ONLINE_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="hideonline" value="0" { $HIDE_ONLINE_NO } /><span class="genmed">{$L_NO }</span></td>
+		</tr>
+		<!-- ENDIF --><!-- IF { $S_SELECT_NOTIFY } -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_METHOD }:</b><br /><span class="gensmall">{ $L_NOTIFY_METHOD_EXPLAIN }</span></td>
+			<td class="row2"><input type="radio" name="notifymethod" value="0" { $NOTIFY_EMAIL } /><span class="genmed">{ $L_NOTIFY_METHOD_EMAIL }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="1" { $NOTIFY_IM } /><span class="genmed">{ $L_NOTIFY_METHOD_IM }</span>&nbsp;&nbsp;<input type="radio" name="notifymethod" value="2"{$NOTIFY_BOTH} /><span class="genmed">{$L_NOTIFY_METHOD_BOTH}</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_NOTIFY_ON_PM }:</b></td>
+			<td class="row2"><input type="radio" name="notifypm" value="1" { $NOTIFY_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="notifypm" value="0" { $NOTIFY_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{$L_POPUP_ON_PM}:</b></td>
+			<td class="row2"><input type="radio" name="popuppm" value="1" { $POPUP_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="popuppm" value="0" { $POPUP_PM_NO } /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_REPORT_PM_NOTIFY }:</b><br /><span class="gensmall">{ $L_REPORT_PM_NOTIFY_EXPLAIN }</span></td>
+			<td class="row2"><input type="radio" name="report_pm_notify" value="1" { $REPORT_PM_YES } /><span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="report_pm_notify" value="0"{$REPORT_PM_NO} /><span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_LANGUAGE }:</b></td>
+			<td class="row2"><select name="lang">{ $S_LANG_OPTIONS }</select></td>
+		</tr>
+		<!-- IF { $S_THEME_OPTIONS } -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_THEME }:</b></td>
+			<td class="row2"><select name="theme">{ $S_THEME_OPTIONS }</select></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_TIMEZONE }:</b></td>
+			<td class="row2"><select name="tz">{ $S_TZ_OPTIONS }</select></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DST }:</b></td>
+			<td class="row2"><input type="radio" name="dst" value="1"{ $DST_YES } /> <span class="genmed">{ $L_YES }</span>&nbsp;&nbsp;<input type="radio" name="dst" value="0"{ $DST_NO } /> <span class="genmed">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_BOARD_DATE_FORMAT }:</b><br /><span class="gensmall">{ $L_BOARD_DATE_FORMAT_EXPLAIN }</span></td>
+			<td class="row2"><input type="text" name="dateformat" value="{ $DATE_FORMAT }" maxlength="14" class="post" /></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_post.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,37 +1,39 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_BBCODE }:</b></td>
-		<td class="row2"><input type="radio" name="bbcode" value="1" { $DEFAULT_BBCODE_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="bbcode" value="0" { $DEFAULT_BBCODE_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_HTML }:</b></td>
-		<td class="row2"><input type="radio" name="html" value="1" { $DEFAULT_HTML_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="html" value="0" { $DEFAULT_HTML_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_SMILIES }:</b></td>
-		<td class="row2"><input type="radio" name="smilies" value="1" { $DEFAULT_SMILIES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $DEFAULT_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_ADD_SIG }:</b></td>
-		<td class="row2"><input type="radio" name="sig" value="1" { $DEFAULT_SIG_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sig" value="0" { $DEFAULT_SIG_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_NOTIFY }:</b></td>
-		<td class="row2"><input type="radio" name="notify" value="1" { $DEFAULT_NOTIFY_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="notify" value="0" { $DEFAULT_NOTIFY_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_BBCODE }:</b></td>
+			<td class="row2"><input type="radio" name="bbcode" value="1" { $DEFAULT_BBCODE_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="bbcode" value="0" { $DEFAULT_BBCODE_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_HTML }:</b></td>
+			<td class="row2"><input type="radio" name="html" value="1" { $DEFAULT_HTML_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="html" value="0" { $DEFAULT_HTML_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_SMILIES }:</b></td>
+			<td class="row2"><input type="radio" name="smilies" value="1" { $DEFAULT_SMILIES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $DEFAULT_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_ADD_SIG }:</b></td>
+			<td class="row2"><input type="radio" name="sig" value="1" { $DEFAULT_SIG_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sig" value="0" { $DEFAULT_SIG_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_DEFAULT_NOTIFY }:</b></td>
+			<td class="row2"><input type="radio" name="notify" value="1" { $DEFAULT_NOTIFY_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="notify" value="0" { $DEFAULT_NOTIFY_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_prefs_view.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,73 +1,75 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_IMAGES }:</b></td>
-		<td class="row2"><input type="radio" name="images" value="1" { $VIEW_IMAGES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="images" value="0" { $VIEW_IMAGES_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_FLASH }:</b></td>
-		<td class="row2"><input type="radio" name="flash" value="1" { $VIEW_FLASH_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="flash" value="0" { $VIEW_FLASH_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SMILIES }:</b></td>
-		<td class="row2"><input type="radio" name="smilies" value="1" { $VIEW_SMILIES_YES} /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $VIEW_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SIGS }:</b></td>
-		<td class="row2"><input type="radio" name="sigs" value="1" { $VIEW_SIGS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sigs" value="0" { $VIEW_SIGS_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_AVATARS }:</b></td>
-		<td class="row2"><input type="radio" name="avatars" value="1" { $VIEW_AVATARS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="avatars" value="0" { $VIEW_AVATARS_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<!-- IF { $S_CHANGE_CENSORS } -->
-	<tr>
-		<td class="row1" width="50%"><b class="genmed">{ $L_DISABLE_CENSORS }:</b></td>
-		<td class="row2"><input type="radio" name="wordcensor" value="1" { $DISABLE_CENSORS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="wordcensor" value="0" { $DISABLE_CENSORS_NO } /><span class="gen">{ $L_NO }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td colspan="2" class="spacer"></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DAYS }:</b></td>
-		<td class="row2">{ $S_TOPIC_SORT_DAYS }</td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_KEY }:</b></td>
-		<td class="row2">{ $S_TOPIC_SORT_KEY }</td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DIR }:</b></td>
-		<td class="row2">{ $S_TOPIC_SORT_DIR }</td>
-	</tr>
-	<tr>
-		<td colspan="2" class="spacer"></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DAYS }:</b></td>
-		<td class="row2">{ $S_POST_SORT_DAYS }</td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_KEY }:</b></td>
-		<td class="row2">{ $S_POST_SORT_KEY }</td>
-	</tr>
-	<tr> 
-		<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DIR }:</b></td>
-		<td class="row2">{ $S_POST_SORT_DIR }</td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_IMAGES }:</b></td>
+			<td class="row2"><input type="radio" name="images" value="1" { $VIEW_IMAGES_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="images" value="0" { $VIEW_IMAGES_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_FLASH }:</b></td>
+			<td class="row2"><input type="radio" name="flash" value="1" { $VIEW_FLASH_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="flash" value="0" { $VIEW_FLASH_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SMILIES }:</b></td>
+			<td class="row2"><input type="radio" name="smilies" value="1" { $VIEW_SMILIES_YES} /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="smilies" value="0" { $VIEW_SMILIES_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_SIGS }:</b></td>
+			<td class="row2"><input type="radio" name="sigs" value="1" { $VIEW_SIGS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="sigs" value="0" { $VIEW_SIGS_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_AVATARS }:</b></td>
+			<td class="row2"><input type="radio" name="avatars" value="1" { $VIEW_AVATARS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="avatars" value="0" { $VIEW_AVATARS_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<!-- IF { $S_CHANGE_CENSORS } -->
+		<tr>
+			<td class="row1" width="50%"><b class="genmed">{ $L_DISABLE_CENSORS }:</b></td>
+			<td class="row2"><input type="radio" name="wordcensor" value="1" { $DISABLE_CENSORS_YES } /><span class="gen">{ $L_YES }</span>&nbsp; &nbsp;<input type="radio" name="wordcensor" value="0" { $DISABLE_CENSORS_NO } /><span class="gen">{ $L_NO }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td colspan="2" class="spacer"></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DAYS }:</b></td>
+			<td class="row2">{ $S_TOPIC_SORT_DAYS }</td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_KEY }:</b></td>
+			<td class="row2">{ $S_TOPIC_SORT_KEY }</td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_TOPICS_DIR }:</b></td>
+			<td class="row2">{ $S_TOPIC_SORT_DIR }</td>
+		</tr>
+		<tr>
+			<td colspan="2" class="spacer"></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DAYS }:</b></td>
+			<td class="row2">{ $S_POST_SORT_DAYS }</td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_KEY }:</b></td>
+			<td class="row2">{ $S_POST_SORT_KEY }</td>
+		</tr>
+		<tr> 
+			<td class="row1" width="50%"><b class="genmed">{ $L_VIEW_POSTS_DIR }:</b></td>
+			<td class="row2">{ $S_POST_SORT_DIR }</td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_avatar.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,68 +1,70 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_IMAGE }: </b><br /><span class="gensmall">{ $L_AVATAR_EXPLAIN }</span></td>
-		<td class="row2" align="center"><br /><!-- IF { $AVATAR } -->{$AVATAR}<!-- ELSE --><img src="{ $T_THEME_PATH }/images/no_avatar.gif" alt="" /><!-- ENDIF --><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall">{ $L_DELETE_AVATAR }</span></td>
-	</tr>
-<!-- IF !isset({ $S_DISPLAY_GALLERY }) -->
-	<!-- IF { $S_CAN_UPLOAD } -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_FILE }: </b></td>
-		<td class="row2"><input type="hidden" name="MAX_FILE_SIZE" value="{ $AVATAR_SIZE }" /><input class="post" type="file" name="uploadfile" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_URL }: </b><br /><span class="gensmall">{ $L_UPLOAD_AVATAR_URL_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" type="text" name="uploadurl" size="40" value="" /></td>
-	</tr>
-	<!-- ENDIF --><!-- IF { $S_LINK_AVATAR } -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_AVATAR }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_AVATAR_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" type="text" name="remotelink" size="40" value="" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_SIZE }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_SIZE_EXPLAIN }</span></td>
-		<td class="row2"><input class="post" type="text" name="width" size="3" value="{ $WIDTH }" /> <span class="gen">px X </span> <input class="post" type="text" name="height" size="3" value="{ $HEIGHT }" /> <span class="gen">px</span></td>
-	</tr>
-	<!-- ENDIF --><!-- IF { $S_GALLERY_AVATAR } -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_AVATAR_GALLERY }: </b></td>
-		<td class="row2"><input class="btnlite" type="submit" name="display_gallery" value="{ $L_DISPLAY_GALLERY }" /></td>
-	</tr>
-	<!-- ENDIF -->
-<!-- ELSE -->
-	<tr> 
-		<th colspan="2">{ $L_AVATAR_GALLERY }</th>
-	</tr>
-	<tr> 
-		<td class="cat" colspan="2" align="center" valign="middle"><span class="genmed">{ $L_AVATAR_CATEGORY }: </span><select name="category">{$S_CAT_OPTIONS}</select>&nbsp; <span class="genmed">{$L_AVATAR_PAGE}: </span><select name="page">{$S_PAGE_OPTIONS}</select>&nbsp;<input class="btnlite" type="submit" value="{$L_GO}" name="display_gallery" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2" align="center">
-		<table cellspacing="1" cellpadding="4" border="0" width="100%">
-			<!-- LOOP $avatar --><!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --></tr><tr><!-- ENDIF -->
-				<td align="center"><img src="{ $avatar:AVATAR_IMAGE }" alt="{ $avatar:AVATAR_NAME }" title="{ $avatar:AVATAR_NAME }" /><br/>
-				<input type="radio" name="avatarselect" value="{ $avatar:AVATAR_FILE }" /></td>
-			<!-- LOOPELSE -->
-			<tr>
-				<td align="center"><b class="gen">{ $L_NO_GALLERY_AVATAR }</b></td>
-			<!-- ENDLOOP -->
-			</tr>
-		</table>
-		</td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<!-- IF isset({ $S_DISPLAY_GALLERY }) --><input class="button" type="submit" name="cancel" value="{ $L_CANCEL }" /><!-- ELSE --><input class="button" type="reset" value="{ $L_RESET }" name="reset" /><!-- ENDIF --></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }" <!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_IMAGE }: </b><br /><span class="gensmall">{ $L_AVATAR_EXPLAIN }</span></td>
+			<td class="row2" align="center"><br /><!-- IF { $AVATAR } -->{ $AVATAR }<!-- ELSE --><img src="{ $THEME_PATH }/images/no_avatar.gif" alt="" /><!-- ENDIF --><br /><br /><input type="checkbox" name="delete" />&nbsp;<span class="gensmall">{ $L_DELETE_AVATAR }</span></td>
+		</tr>
+	<!-- IF !isset({ $S_DISPLAY_GALLERY }) -->
+		<!-- IF { $S_CAN_UPLOAD } -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_FILE }: </b></td>
+			<td class="row2"><input type="hidden" name="MAX_FILE_SIZE" value="{ $AVATAR_SIZE }" /><input class="post" type="file" name="uploadfile" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UPLOAD_AVATAR_URL }: </b><br /><span class="gensmall">{ $L_UPLOAD_AVATAR_URL_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" type="text" name="uploadurl" size="40" value="" /></td>
+		</tr>
+		<!-- ENDIF --><!-- IF { $S_LINK_AVATAR } -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_AVATAR }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_AVATAR_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" type="text" name="remotelink" size="40" value="" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_LINK_REMOTE_SIZE }: </b><br /><span class="gensmall">{ $L_LINK_REMOTE_SIZE_EXPLAIN }</span></td>
+			<td class="row2"><input class="post" type="text" name="width" size="3" value="{ $WIDTH }" /> <span class="gen">px X </span> <input class="post" type="text" name="height" size="3" value="{ $HEIGHT }" /> <span class="gen">px</span></td>
+		</tr>
+		<!-- ENDIF --><!-- IF { $S_GALLERY_AVATAR } -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_AVATAR_GALLERY }: </b></td>
+			<td class="row2"><input class="button" type="submit" name="display_gallery" value="{ $L_DISPLAY_GALLERY }" /></td>
+		</tr>
+		<!-- ENDIF -->
+	<!-- ELSE -->
+		<tr> 
+			<th colspan="2">{ $L_AVATAR_GALLERY }</th>
+		</tr>
+		<tr> 
+			<td class="cat" colspan="2" align="center" valign="middle"><span class="genmed">{ $L_AVATAR_CATEGORY }: </span><select name="category">{$S_CAT_OPTIONS}</select>&nbsp; <span class="genmed">{ $L_AVATAR_PAGE }: </span><select name="page">{ $S_PAGE_OPTIONS }</select>&nbsp;<input class="button" type="submit" value="{ $L_GO }" name="display_gallery" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" colspan="2" align="center">
+			<table cellspacing="1" cellpadding="4" border="0" width="100%">
+				<!-- LOOP $avatar --><!-- IF ({ $avatar:#LOOP_INDEX } % 8) == 0 --></tr><tr><!-- ENDIF -->
+					<td align="center"><img src="{ $avatar:AVATAR_IMAGE }" alt="{ $avatar:AVATAR_NAME }" title="{ $avatar:AVATAR_NAME }" /><br/>
+					<input type="radio" name="avatarselect" value="{ $avatar:AVATAR_FILE }" /></td>
+				<!-- LOOPELSE -->
+				<tr>
+					<td align="center"><b class="gen">{ $L_NO_GALLERY_AVATAR }</b></td>
+				<!-- ENDLOOP -->
+				</tr>
+			</table>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<!-- IF isset({ $S_DISPLAY_GALLERY }) --><input class="button" type="submit" name="cancel" value="{ $L_CANCEL }" /><!-- ELSE --><input class="button" type="reset" value="{ $L_RESET }" name="reset" /><!-- ENDIF --></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_profile_info.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,60 +1,62 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
+
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }" <!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row3" colspan="2"><span class="gensmall">{ $L_PROFILE_INFO_NOTICE }</span></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_ICQ }: </b></td>
+			<td class="row2"><input class="post" type="text" name="icq" size="30" maxlength="15" value="{ $ICQ }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_AIM }: </b></td>
+			<td class="row2"><input class="post" type="text" name="aim" size="30" maxlength="255" value="{ $AIM }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_MSNM }: </b></td>
+			<td class="row2"><input class="post" type="text" name="msn" size="30" maxlength="255" value="{ $MSN }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_YIM }: </b></td>
+			<td class="row2"><input class="post" type="text" name="yim" size="30" maxlength="255" value="{ $YIM }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_UCP_JABBER }: </b></td>
+			<td class="row2"><input class="post" type="text" name="jabber" size="30" maxlength="255" value="{ $JABBER }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_WEBSITE }: </b></td>
+			<td class="row2"><input class="post" type="text" name="website" size="30" maxlength="255" value="{ $WEBSITE }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_LOCATION }: </b></td>
+			<td class="row2"><input class="post" type="text" name="location" size="30" maxlength="100" value="{ $LOCATION }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_OCCUPATION }: </b></td>
+			<td class="row2"><textarea class="post" name="occupation" rows="3" cols="30">{ $OCCUPATION }</textarea></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_INTERESTS }: </b></td>
+			<td class="row2"><textarea class="post" name="interests" rows="3" cols="30">{ $INTERESTS }</textarea></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_BIRTHDAY }: </b><br /><span class="gensmall">{ $L_BIRTHDAY_EXPLAIN }</span></td>
+			<td class="row2"><span class="genmed">{ $L_DAY }:</span> <select name="bday_day">{ $S_BIRTHDAY_DAY_OPTIONS }</select> <span class="genmed">{ $L_MONTH }:</span> <select name="bday_month">{ $S_BIRTHDAY_MONTH_OPTIONS }</select> <span class="genmed">{ $L_YEAR }:</span> <select name="bday_year">{ $S_BIRTHDAY_YEAR_OPTIONS }</select></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row3" colspan="2"><span class="gensmall">{ $L_PROFILE_INFO_NOTICE }</span></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UCP_ICQ }: </b></td>
-		<td class="row2"><input class="post" type="text" name="icq" size="30" maxlength="15" value="{ $ICQ }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UCP_AIM }: </b></td>
-		<td class="row2"><input class="post" type="text" name="aim" size="30" maxlength="255" value="{ $AIM }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UCP_MSNM }: </b></td>
-		<td class="row2"><input class="post" type="text" name="msn" size="30" maxlength="255" value="{ $MSN }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UCP_YIM }: </b></td>
-		<td class="row2"><input class="post" type="text" name="yim" size="30" maxlength="255" value="{ $YIM }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_UCP_JABBER }: </b></td>
-		<td class="row2"><input class="post" type="text" name="jabber" size="30" maxlength="255" value="{ $JABBER }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_WEBSITE }: </b></td>
-		<td class="row2"><input class="post" type="text" name="website" size="30" maxlength="255" value="{ $WEBSITE }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_LOCATION }: </b></td>
-		<td class="row2"><input class="post" type="text" name="location" size="30" maxlength="100" value="{ $LOCATION }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_OCCUPATION }: </b></td>
-		<td class="row2"><textarea class="post" name="occupation" rows="3" cols="30">{ $OCCUPATION }</textarea></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_INTERESTS }: </b></td>
-		<td class="row2"><textarea class="post" name="interests" rows="3" cols="30">{ $INTERESTS }</textarea></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_BIRTHDAY }: </b><br /><span class="gensmall">{ $L_BIRTHDAY_EXPLAIN }</span></td>
-		<td class="row2"><span class="genmed">{ $L_DAY }:</span> <select name="bday_day">{ $S_BIRTHDAY_DAY_OPTIONS }</select> <span class="genmed">{ $L_MONTH }:</span> <select name="bday_month">{ $S_BIRTHDAY_MONTH_OPTIONS }</select> <span class="genmed">{ $L_YEAR }:</span> <select name="bday_year">{ $S_BIRTHDAY_YEAR_OPTIONS }</select></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
-
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_reg_details.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,47 +1,49 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<!-- IF { $S_FORCE_PASSWORD } -->
-		<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_UCP_PROFILE_REG_WELCOME }</span></td>
-	</tr>
-	<!-- ENDIF --><!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_USERNAME }: </b><br /><span class="gensmall">{ $L_USERNAME_EXPLAIN }</span></td>
-		<td class="row2"><!-- IF { $S_CHANGE_USERNAME } --><input type="text" class="post" name="username" size="30" maxlength="30" value="{ $USERNAME }" /><!-- ELSE --><b class="gen">{ $USERNAME }</b><!-- ENDIF --></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b></td>
-		<td class="row2"><!-- IF { $S_CHANGE_EMAIL } --><input type="text" class="post" name="email" size="30" maxlength="60" value="{ $EMAIL }" /><!-- ELSE --><b class="gen">{ $EMAIL }</b><!-- ENDIF --></td>
-	</tr>
-	<!-- IF { $S_CHANGE_EMAIL } -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{$L_CONFIRM_EMAIL}: </b><br /><span class="gensmall">{ $L_CONFIRM_EMAIL_EXPLAIN }</span></td>
-		<td class="row2"><input type="text" class="post" name="email_confirm" size="30" maxlength="60" value="{ $CONFIRM_EMAIL }" /></td>
-	</tr>
-	<!-- ENDIF --><!-- IF { $S_CHANGE_PASSWORD } -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_CHANGE_PASSWORD }: </b><br /><span class="gensmall">{ $L_CHANGE_PASSWORD_EXPLAIN }</span></td>
-		<td class="row2"><input type="password" class="post" name="new_password" size="30" maxlength="255" value="{ $NEW_PASSWORD }" /></td>
-	</tr>
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b><br /><span class="gensmall">{ $L_CONFIRM_PASSWORD_EXPLAIN }</span></td>
-		<td class="row2"><input type="password" class="post" name="password_confirm" size="30" maxlength="255" value="{ $PASSWORD_CONFIRM }" /></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr> 
-		<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_PASSWORD }: </b><br /><span class="gensmall">{ $L_CURRENT_PASSWORD_EXPLAIN }</span></td>
-		<td class="row2"><input type="password" class="post" name="cur_password" size="30" maxlength="255" value="{ $CUR_PASSWORD }" /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<!-- IF { $S_FORCE_PASSWORD } -->
+			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_UCP_PROFILE_REG_WELCOME }</span></td>
+		</tr>
+		<!-- ENDIF --><!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_USERNAME }: </b><br /><span class="gensmall">{ $L_USERNAME_EXPLAIN }</span></td>
+			<td class="row2"><!-- IF { $S_CHANGE_USERNAME } --><input type="text" class="post" name="username" size="30" maxlength="30" value="{ $USERNAME }" /><!-- ELSE --><b class="gen">{ $USERNAME }</b><!-- ENDIF --></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_EMAIL_ADDRESS }: </b></td>
+			<td class="row2"><!-- IF { $S_CHANGE_EMAIL } --><input type="text" class="post" name="email" size="30" maxlength="60" value="{ $EMAIL }" /><!-- ELSE --><b class="gen">{ $EMAIL }</b><!-- ENDIF --></td>
+		</tr>
+		<!-- IF { $S_CHANGE_EMAIL } -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{$L_CONFIRM_EMAIL}: </b><br /><span class="gensmall">{ $L_CONFIRM_EMAIL_EXPLAIN }</span></td>
+			<td class="row2"><input type="text" class="post" name="email_confirm" size="30" maxlength="60" value="{ $CONFIRM_EMAIL }" /></td>
+		</tr>
+		<!-- ENDIF --><!-- IF { $S_CHANGE_PASSWORD } -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_CHANGE_PASSWORD }: </b><br /><span class="gensmall">{ $L_CHANGE_PASSWORD_EXPLAIN }</span></td>
+			<td class="row2"><input type="password" class="post" name="new_password" size="30" maxlength="255" value="{ $NEW_PASSWORD }" /></td>
+		</tr>
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_CONFIRM_PASSWORD }: </b><br /><span class="gensmall">{ $L_CONFIRM_PASSWORD_EXPLAIN }</span></td>
+			<td class="row2"><input type="password" class="post" name="password_confirm" size="30" maxlength="255" value="{ $PASSWORD_CONFIRM }" /></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr> 
+			<td class="row1" width="35%"><b class="genmed">{ $L_CURRENT_PASSWORD }: </b><br /><span class="gensmall">{ $L_CURRENT_PASSWORD_EXPLAIN }</span></td>
+			<td class="row2"><input type="password" class="post" name="cur_password" size="30" maxlength="255" value="{ $CUR_PASSWORD }" /></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_profile_signature.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -43,134 +43,135 @@
 </script>
 <script language="javascript" type="text/javascript" src="javascript/editor.js"></script>
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2">{ $L_TITLE }</th>
-	</tr>
-
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="genmed error">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-
-	<tr> 
-		<td class="row1" width="22%" valign="top">
-		<b class="genmed">{ $L_SIGNATURE }: </b><br /><span class="gensmall">{ $L_SIGNATURE_EXPLAIN }</span><br/><br/>
-		<table width="80%" cellspacing="5" cellpadding="0" border="0" align="center">
-			<tr>
-				<td class="gensmall" align="center"><b>{ $L_SMILIES }</b></td>
-			</tr>
-			<tr>
-				<td align="center"><!-- LOOP $smiley --><a href="javascript:smiley('{ $smiley:SMILEY_CODE }')"><img src="{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }" width="{ $smiley:SMILEY_WIDTH }" height="{ $smiley:SMILEY_HEIGHT }" border="0" alt="{ $smiley:SMILEY_DESC }" title="{ $smiley:SMILEY_DESC }" onclick="smiley('{ $smiley:SMILEY_CODE }');return false" hspace="2" vspace="2" /></a> <!-- ENDLOOP --></td>
-			</tr>
-
-			<!-- IF { $S_SHOW_SMILEY_LINK } -->
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2">{ $L_TITLE }</th>
+		</tr>
+	
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="genmed error">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+	
+		<tr> 
+			<td class="row1" width="22%" valign="top">
+			<b class="genmed">{ $L_SIGNATURE }: </b><br /><span class="gensmall">{ $L_SIGNATURE_EXPLAIN }</span><br/><br/>
+			<table width="80%" cellspacing="5" cellpadding="0" border="0" align="center">
 				<tr>
-					<td align="center"><a class="nav" href="{ $U_MORE_SMILIES }" onclick="window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;" target="_phpbbsmilies">{ $L_MORE_SMILIES} </a></td>
+					<td class="gensmall" align="center"><b>{ $L_SMILIES }</b></td>
 				</tr>
-			<!-- ENDIF -->
-
-		</table>
-		</td>
-		<td class="row2">
-		<table cellspacing="0" cellpadding="2" border="0">
-			<tr align="center" valign="middle">
-				<td><input class="btnbbcode" type="button" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
-				<td><input class="btnbbcode" type="button" accesskey="w" name="addbbcode18" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(18)" onmouseover="helpline('w')" /></td>
-			</tr>
-			<tr>
-				<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
+				<tr>
+					<td align="center"><!-- LOOP $smiley --><a href="javascript:smiley('{ $smiley:SMILEY_CODE }')"><img src="{ $T_SMILIES_PATH }{ $smiley:SMILEY_IMG }" width="{ $smiley:SMILEY_WIDTH }" height="{ $smiley:SMILEY_HEIGHT }" border="0" alt="{ $smiley:SMILEY_DESC }" title="{ $smiley:SMILEY_DESC }" onclick="smiley('{ $smiley:SMILEY_CODE }');return false" hspace="2" vspace="2" /></a> <!-- ENDLOOP --></td>
+				</tr>
+	
+				<!-- IF { $S_SHOW_SMILEY_LINK } -->
 					<tr>
-						<td><span class="genmed"> &nbsp;{ $L_FONT_SIZE }:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
-							<option value="7">{ $L_FONT_TINY }</option>
-							<option value="9">{ $L_FONT_SMALL }</option>
-							<option value="12" selected="selected">{ $L_FONT_NORMAL }</option>
-							<option value="18">{ $L_FONT_LARGE }</option>
-							<option  value="24">{ $L_FONT_HUGE }</option>
-						</select></td>
-						<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')">{ $L_CLOSE_TAGS }</a></td>
+						<td align="center"><a class="nav" href="{ $U_MORE_SMILIES }" onclick="window.open('{ $U_MORE_SMILIES }', '_phpbbsmilies', 'HEIGHT=350,resizable=yes,scrollbars=yes,WIDTH=300');return false;" target="_phpbbsmilies">{ $L_MORE_SMILIES} </a></td>
 					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td colspan="9"><input class="helpline" type="text" name="helpbox" size="45" maxlength="100" style="width:100%" value="{$L_STYLES_TIP}" /></td>
-			</tr>
-			<tr>
-				<td colspan="9"><textarea class="post" name="signature" rows="10" cols="70" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">{$SIGNATURE}</textarea></td>
-			</tr>
-			<tr>
-				<td colspan="9"><table cellspacing="0" cellpadding="0" border="0" width="100%">
-					<tr>
-						<td bgcolor="black"><script language="javascript" type="text/javascript"><!--
-
-						colorPalette('h', 17, 5)
-
-						//--></script></td>
-					</tr>
-				</table></td>
-			</tr>
-		</table></td>
-	</tr>
-	<tr>
-		<td class="row1" valign="top"><b class="genmed">{ $L_OPTIONS }</b><br /><table cellspacing="2" cellpadding="0" border="0">
-			<tr>
-				<td class="gensmall">{ $HTML_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $BBCODE_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $IMG_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $FLASH_STATUS }</td>
-			</tr>
-			<tr>
-				<td class="gensmall">{ $SMILIES_STATUS }</td>
-			</tr>
-		</table></td>
-		<td class="row2" valign="top"><table cellspacing="0" cellpadding="1" border="0">
-			<!-- IF { $S_HTML_ALLOWED } -->
-			<tr>
-				<td><input type="checkbox" name="disable_html" { $S_HTML_CHECKED } /></td>
-				<td class="gen">{ $L_DISABLE_HTML }</td>
-			</tr>
-			<!-- ENDIF --><!-- IF { $S_BBCODE_ALLOWED } -->
-			<tr>
-				<td><input type="checkbox" name="disable_bbcode" { $S_BBCODE_CHECKED } /></td>
-				<td class="gen">{ $L_DISABLE_BBCODE }</td>
-			</tr>
-			<!-- ENDIF --><!-- IF { $S_SMILIES_ALLOWED } -->
-			<tr>
-				<td><input type="checkbox" name="disable_smilies" { $S_SMILIES_CHECKED } /></td>
-				<td class="gen">{ $L_DISABLE_SMILIES }</td>
-			</tr>
-			<!-- ENDIF -->
-			<tr>
-				<td><input type="checkbox" name="disable_magic_url" { $S_MAGIC_URL_CHECKED } /></td>
-				<td class="gen">{ $L_DISABLE_MAGIC_URL }</td>
-			</tr>
-		</table></td>
-	</tr>
-	<!-- IF { $SIGNATURE_PREVIEW } -->
-	<tr>
-		<th colspan="2" valign="middle">{ $L_SIGNATURE_PREVIEW }</th>
-	</tr>
-	<tr> 
-		<td class="row1" colspan="2"><div class="postdetails" style="padding: 6px;">{ $SIGNATURE_PREVIEW }</div></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="preview" value="{ $L_PREVIEW }" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
-
+				<!-- ENDIF -->
+	
+			</table>
+			</td>
+			<td class="row2">
+			<table cellspacing="0" cellpadding="2" border="0">
+				<tr align="center" valign="middle">
+					<td><input class="btnbbcode" type="button" accesskey="b" name="addbbcode0" value=" B " style="font-weight:bold; width: 30px" onclick="bbstyle(0)" onmouseover="helpline('b')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="i" name="addbbcode2" value=" i " style="font-style:italic; width: 30px" onclick="bbstyle(2)" onmouseover="helpline('i')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="u" name="addbbcode4" value=" u " style="text-decoration: underline; width: 30px" onclick="bbstyle(4)" onmouseover="helpline('u')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="q" name="addbbcode6" value="Quote" style="width: 50px" onclick="bbstyle(6)" onmouseover="helpline('q')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="c" name="addbbcode8" value="Code" style="width: 40px" onclick="bbstyle(8)" onmouseover="helpline('c')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="l" name="addbbcode10" value="List" style="width: 40px" onclick="bbstyle(10)" onmouseover="helpline('l')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="o" name="addbbcode12" value="List=" style="width: 40px" onclick="bbstyle(12)" onmouseover="helpline('o')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="p" name="addbbcode14" value="Img" style="width: 40px"  onclick="bbstyle(14)" onmouseover="helpline('p')" /></td>
+					<td><input class="btnbbcode" type="button" accesskey="w" name="addbbcode18" value="URL" style="text-decoration: underline; width: 40px" onclick="bbstyle(18)" onmouseover="helpline('w')" /></td>
+				</tr>
+				<tr>
+					<td colspan="9"><table width="100%" cellspacing="0" cellpadding="0" border="0">
+						<tr>
+							<td><span class="genmed"> &nbsp;{ $L_FONT_SIZE }:</span> <select name="addbbcode20" onchange="bbfontstyle('[size=' + this.form.addbbcode20.options[this.form.addbbcode20.selectedIndex].value + ']', '[/size]');this.form.addbbcode20.selectedIndex = 2;" onmouseover="helpline('f')">
+								<option value="7">{ $L_FONT_TINY }</option>
+								<option value="9">{ $L_FONT_SMALL }</option>
+								<option value="12" selected="selected">{ $L_FONT_NORMAL }</option>
+								<option value="18">{ $L_FONT_LARGE }</option>
+								<option  value="24">{ $L_FONT_HUGE }</option>
+							</select></td>
+							<td class="gensmall" nowrap="nowrap" align="right"><a href="javascript:bbstyle(-1)" onmouseover="helpline('a')">{ $L_CLOSE_TAGS }</a></td>
+						</tr>
+					</table></td>
+				</tr>
+				<tr>
+					<td colspan="9"><input class="helpline" type="text" name="helpbox" size="45" maxlength="100" style="width:100%" value="{$L_STYLES_TIP}" /></td>
+				</tr>
+				<tr>
+					<td colspan="9"><textarea class="post" name="signature" rows="10" cols="70" onselect="storeCaret(this);" onclick="storeCaret(this);" onkeyup="storeCaret(this);">{$SIGNATURE}</textarea></td>
+				</tr>
+				<tr>
+					<td colspan="9"><table cellspacing="0" cellpadding="0" border="0" width="100%">
+						<tr>
+							<td bgcolor="black"><script language="javascript" type="text/javascript"><!--
+	
+							colorPalette('h', 17, 5)
+	
+							//--></script></td>
+						</tr>
+					</table></td>
+				</tr>
+			</table></td>
+		</tr>
+		<tr>
+			<td class="row1" valign="top"><b class="genmed">{ $L_OPTIONS }</b><br /><table cellspacing="2" cellpadding="0" border="0">
+				<tr>
+					<td class="gensmall">{ $HTML_STATUS }</td>
+				</tr>
+				<tr>
+					<td class="gensmall">{ $BBCODE_STATUS }</td>
+				</tr>
+				<tr>
+					<td class="gensmall">{ $IMG_STATUS }</td>
+				</tr>
+				<tr>
+					<td class="gensmall">{ $FLASH_STATUS }</td>
+				</tr>
+				<tr>
+					<td class="gensmall">{ $SMILIES_STATUS }</td>
+				</tr>
+			</table></td>
+			<td class="row2" valign="top"><table cellspacing="0" cellpadding="1" border="0">
+				<!-- IF { $S_HTML_ALLOWED } -->
+				<tr>
+					<td><input type="checkbox" name="disable_html" { $S_HTML_CHECKED } /></td>
+					<td class="gen">{ $L_DISABLE_HTML }</td>
+				</tr>
+				<!-- ENDIF --><!-- IF { $S_BBCODE_ALLOWED } -->
+				<tr>
+					<td><input type="checkbox" name="disable_bbcode" { $S_BBCODE_CHECKED } /></td>
+					<td class="gen">{ $L_DISABLE_BBCODE }</td>
+				</tr>
+				<!-- ENDIF --><!-- IF { $S_SMILIES_ALLOWED } -->
+				<tr>
+					<td><input type="checkbox" name="disable_smilies" { $S_SMILIES_CHECKED } /></td>
+					<td class="gen">{ $L_DISABLE_SMILIES }</td>
+				</tr>
+				<!-- ENDIF -->
+				<tr>
+					<td><input type="checkbox" name="disable_magic_url" { $S_MAGIC_URL_CHECKED } /></td>
+					<td class="gen">{ $L_DISABLE_MAGIC_URL }</td>
+				</tr>
+			</table></td>
+		</tr>
+		<!-- IF { $SIGNATURE_PREVIEW } -->
+		<tr>
+			<th colspan="2" valign="middle">{ $L_SIGNATURE_PREVIEW }</th>
+		</tr>
+		<tr> 
+			<td class="row1" colspan="2"><div class="postdetails" style="padding: 6px;">{ $SIGNATURE_PREVIEW }</div></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="preview" value="{ $L_PREVIEW }" />&nbsp;&nbsp;<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_foes.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,28 +1,30 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{ $L_TITLE }</th>
-	</tr>
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FOES_EXPLAIN }</span></td>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FOES }:</b><br /><span class="gensmall">{ $L_YOUR_FOES_EXPLAIN }</span></td>
-		<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FOES }</b><!-- ENDIF --></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{ $L_ADD_FOES }:</b><br /><span class="gensmall">{ $L_ADD_FOES_EXPLAIN } [ <a href="{ $U_SEARCH_USER }" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=780');return false">{ $L_FIND_USERNAME }</a> ]</span></td>
-		<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{ $L_TITLE }</th>
+		</tr>
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FOES_EXPLAIN }</span></td>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FOES }:</b><br /><span class="gensmall">{ $L_YOUR_FOES_EXPLAIN }</span></td>
+			<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FOES }</b><!-- ENDIF --></td>
+		</tr>
+		<tr>
+			<td class="row1"><b class="genmed">{ $L_ADD_FOES }:</b><br /><span class="gensmall">{ $L_ADD_FOES_EXPLAIN } [ <a href="{ $U_SEARCH_USER }" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=780');return false">{ $L_FIND_USERNAME }</a> ]</span></td>
+			<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_zebra_friends.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,28 +1,30 @@
 <!-- INCLUDE modules/Control_Panel/ucp_header.html -->
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="2" valign="middle">{$L_TITLE}</th>
-	</tr>
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FRIENDS_EXPLAIN }</span></td>
-	</tr>
-	<!-- IF { $ERROR } -->
-	<tr>
-		<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
-	</tr>
-	<!-- ENDIF -->
-	<tr>
-		<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FRIENDS }:</b><br /><span class="gensmall">{ $L_YOUR_FRIENDS_EXPLAIN }</span></td>
-		<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FRIENDS }</b><!-- ENDIF --></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{ $L_ADD_FRIENDS }:</b><br /><span class="gensmall">{ $L_ADD_FRIENDS_EXPLAIN } [ <a href="{ $U_SEARCH_USER}" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false">{$L_FIND_USERNAME}</a> ]</span></td>
-		<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="btnmain" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" name="reset" /></td>
-	</tr>
-</table>
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="2" valign="middle">{$L_TITLE}</th>
+		</tr>
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall">{ $L_FRIENDS_EXPLAIN }</span></td>
+		</tr>
+		<!-- IF { $ERROR } -->
+		<tr>
+			<td class="row3" colspan="2" align="center"><span class="gensmall" style="color:red">{ $ERROR }</span></td>
+		</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td class="row1" width="40%"><b class="genmed">{ $L_YOUR_FRIENDS }:</b><br /><span class="gensmall">{ $L_YOUR_FRIENDS_EXPLAIN }</span></td>
+			<td class="row2" align="center"><!-- IF { $S_USERNAME_OPTIONS } --><select name="usernames[]" multiple="multiple" size="5">{ $S_USERNAME_OPTIONS }</select><!-- ELSE --><b class="genmed">{ $L_NO_FRIENDS }</b><!-- ENDIF --></td>
+		</tr>
+		<tr>
+			<td class="row1"><b class="genmed">{ $L_ADD_FRIENDS }:</b><br /><span class="gensmall">{ $L_ADD_FRIENDS_EXPLAIN } [ <a href="{ $U_SEARCH_USER}" onclick="window.open('{ $U_SEARCH_USER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false">{$L_FIND_USERNAME}</a> ]</span></td>
+			<td class="row2" align="center"><textarea name="add" rows="5" cols="30">{ $USERNAMES }</textarea><br /></td>
+		</tr>
+		<tr>
+			<td class="cat" colspan="2" align="center">{ $S_HIDDEN_FIELDS }<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" name="reset" /></td>
+		</tr>
+	</table>
+</form>
 
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/overall_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/overall_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Forums/overall_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -14,4 +14,4 @@
 <!-- IF { $U_ACP } --><span class="gensmall">[ <a href="{ $U_ACP }">{ $L_ACP }</a> ]</span><br /><br /><!-- ENDIF -->
 Based on <a href="http://www.phpbb.com/" target="phpbb">phpBB</a></div>
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $THEME_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/overall_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,4 +1,4 @@
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table width="100%" cellspacing="0">
 	<tr>
@@ -12,7 +12,9 @@
 		<!-- IF { $S_USER_LOGGED_IN } -->&nbsp; &nbsp;<a href="{ $U_PROFILE }"><img src="{ $T_IMAGE_PATH }icon_mini_profile.gif" width="12" height="13" border="0" alt="{ $L_PROFILE }" /> { $L_PROFILE }</a><!-- ENDIF --></td>
 	</tr>
 </table>
+
 <br/>
+
 <table width="100%" cellspacing="0">
 	<tr>
 		<td class="gensmall"><!-- IF { $S_USER_LOGGED_IN } -->{$LAST_VISIT_DATE}<!-- ENDIF --></td>

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_body.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -83,10 +83,6 @@
 			<!-- IF { $leader_row:U_PM } --><td class="gen" align="center"><a href="{ $leader_row:U_PM }">{ $PM_IMG }</a></td><!-- ENDIF -->
 			<td class="gen" align="center"><!-- IF { $leader_row:U_EMAIL } --><a href="{ $leader_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF --></td>
 			<td class="gen" align="center"><!-- IF { $leader_row:U_WWW } --><a href="{ $leader_row:U_WWW }" target="_blank">{ $WWW_IMG }</a><!-- ENDIF --></td>
-			<!-- IF isset({ $leader_row:S_PROFILE_FIELD1 }) -->
-			<!-- Use a construct like this to include admin defined profile fields. Replace FIELD1 with the name of your field. -->
-			<td class="gen" align="center">{$leader_row:PROFILE_FIELD1_VALUE}</td>
-			<!-- ENDIF -->
 			<!-- IF { $S_SEARCH_USER } --><td align="center"><input type="checkbox" name="user" value="{$leader_row:USERNAME}" /></td><!-- ENDIF -->
 
 		</tr>
@@ -113,12 +109,7 @@
 			<td class="gen" align="center"><a href="{ $member_row:U_PM }">{ $PM_IMG }</a></td><!-- ENDIF -->
 			<td class="gen" align="center"><!-- IF { $member_row:U_EMAIL } --><a href="{ $member_row:U_EMAIL }">{ $EMAIL_IMG }</a><!-- ENDIF --></td>
 			<td class="gen" align="center"><!-- IF { $member_row:U_WWW } --><a href="{ $member_row:U_WWW }" target="_blank">{ $WWW_IMG }</a><!-- ENDIF --></td>
-			<!-- IF isset({ $member_row:S_PROFILE_FIELD1 }) -->
-			<!-- Use a construct like this to include admin defined profile fields. Replace FIELD1 with the name of your field. -->
-			<td class="gen" align="center">{ $member_row:PROFILE_FIELD1_VALUE }</td>
-			<!-- ENDIF -->
 			<!-- IF { $S_SEARCH_USER } --><td align="center"><input type="checkbox" name="user" value="{ $member_row:USERNAME }" /></td><!-- ENDIF -->
-
 		</tr>
 		<!-- LOOPELSE -->
 		<tr>

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_footer.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -13,4 +13,4 @@
 <div style="text-align: center;" class="copyright">
 Based on <a href="http://www.phpbb.com/" target="phpbb">phpBB</a></div>
 
-{ $A_TABLE_CLOSE }
\ No newline at end of file
+{ $THEME_TABLE_CLOSE }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Members_List/memberlist_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Members_List/memberlist_header.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Members_List/memberlist_header.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -16,4 +16,4 @@
 //-->
 </script>
 
-{ $A_TABLE_OPEN }
\ No newline at end of file
+{ $THEME_TABLE_OPEN }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Quick_Message/index.html
===================================================================
--- cms/trunk/includes/templates/modules/Quick_Message/index.html	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/templates/modules/Quick_Message/index.html	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,12 +1,12 @@
 <!-- DISPLAY_HEADER -->
 
-{ $A_TABLE_OPEN }
+{ $THEME_TABLE_OPEN }
 
 <table class="tablebg" width="100%" cellpadding="1" cellspacing="1">
 	<tbody>
 		<tr>
 			<th width="20%">{ $L_POSTER }</th>
-			<th width="80%" colspan="2">{ $L_MESSAGE }</th>
+			<th width="80%">{ $L_MESSAGE }</th>
 		</tr>
 		<tr>
 			<td class="spacer" colspan="2" height="7"></td>
@@ -40,18 +40,12 @@
 					{ $L_NO_POST }
 				</td>
 			</tr>
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $quick_message -->
 
-		<!-- IF { $Q_MESSAGE_PAGINATION } -->
-		<tr class="row2">
-			<td style="padding: 5px;" valign="middle" colspan="2">
-				<div style="padding-right: 5px; text-align: right;">{ $Q_MESSAGE_PAGINATION }</div>
-			</td>
-		</tr>
-		<!-- ENDIF -->
+
 	</tbody>
 </table>
 
-{ $A_TABLE_CLOSE }
+{ $THEME_TABLE_CLOSE }
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/includes/user.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -34,8 +34,7 @@
 	var $img = array();
 
 	var $time_format;
-	var $timezone;
-	var $dst;
+	var $time_offset;
 
 	var $is_admin;
 	var $is_bot;
@@ -99,10 +98,10 @@
 		// user and gmt
 		if ($conversion == 'gmt')
 		{
-			return ($time - $this->timezone - $this->dst);
+			return ($time - $this->time_offset);
 		}
 
-		return $time + $this->timezone + $this->dst;
+		return $time + $this->time_offset;
 	}
 
 	function login($id = ANONYMOUS, $admin_login = false, $hidden = false, $auto_log = false)
@@ -266,8 +265,13 @@
 		$this->lang_path = SITE_FILE_ROOT.'language/' . $this->lang_name . '/';
 
 		$this->time_format = ($this->data['user_time_format']) ? $this->data['user_time_format'] : $_CORE_CONFIG['global']['default_dateformat'];
-		$this->timezone = ($this->data['user_timezone']) ? $this->data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
+		$this->time_offset = ($this->data['user_timezone']) ? $this->data['user_timezone'] : $_CORE_CONFIG['global']['default_timezone'];
 
+		if ($this->data['user_dst'])
+		{
+			$this->time_offset += 3600;
+		}
+
 		require($this->lang_path . 'common.php');
 	}
 

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/install/build_tables.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -593,8 +593,8 @@
 $_CLASS['core_db']->add_table_field_char('topic_title', 50);
 $_CLASS['core_db']->add_table_field_int('topic_poster', array('max' => 16000000));
 field_unix_time('topic_time');
-$_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000, 'null' => true));  
+$_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000));  
 $_CLASS['core_db']->add_table_field_int('topic_status', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_type', array('max' => 1));
 
@@ -602,14 +602,14 @@
 $_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000, 'null' => true));
 
-$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 
 $_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1, 'null' => true)); 
 field_unix_time('topic_time_limit', true);
-$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
 $_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50, true);
@@ -899,7 +899,7 @@
 $_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('folder_name', 40);
-$_CLASS['core_db']->add_table_field_int('pm_count', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('pm_count', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('folder_id', 'primary');
 $_CLASS['core_db']->add_table_index('user_id');

Modified: cms/trunk/javascript/common.js
===================================================================
--- cms/trunk/javascript/common.js	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/javascript/common.js	2005-09-27 23:57:50 UTC (rev 143)
@@ -1,5 +1,8 @@
 // By Ryan Marshall ( viperal1 at gmail.com )
 
+var is_ie		= (navigator.appName == 'Microsoft Internet Explorer');
+var is_gecko	= (navigator.userAgent.indexOf('Gecko') != -1)
+
 function get_cookie(cookie_name)
 {
 	var cookie_prefix = cookie_name + "=";

Modified: cms/trunk/javascript/menu.js
===================================================================
--- cms/trunk/javascript/menu.js	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/javascript/menu.js	2005-09-27 23:57:50 UTC (rev 143)
@@ -9,14 +9,18 @@
 *	
 */
 
-// Move this to like a global javascript file
-var is_ie		= (navigator.appName == "Microsoft Internet Explorer");
-var is_gecko	= (navigator.userAgent.indexOf('Gecko') != -1)
-
 var slider_id = new Array();
 var slider_height = new Array();
 var active_menu = false;
+var menu_time_out = false;
 
+/*
+document.onclick		= function (e)
+{
+	menu_hide();
+}
+*/
+
 function get_offsets(element)
 {
 	var offsets = new Array();
@@ -43,9 +47,10 @@
 		return;
 	}
 
+	/*
 	object.onclick = function()
 	{
-		/* Open or close the menu */
+		// Open or close the menu 
 		if (menu.style.display == 'none')
 		{
 			menu_show(object_name);
@@ -57,41 +62,71 @@
 
 		return false;
 	}
-	
-/*
-	need to read more to get these working :-(
+	*/
 
-	object.onmouseover = function()
+// Clean this section up
+	menu.onmouseover = function(e)
 	{
-		//menu_show(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
 	}
-	
-	object.onmouseout = function(e)
-	{
-		menu_hide(object_name);
-	}
 
 	menu.onmouseout = function(e)
 	{
-		menu_hide(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_time_out = window.setTimeout('menu_hide()', 200);
 	}
 
-	menu.onmouseover = function(e)
+	object.onmouseover = function(e)
 	{
-		this.onmouseout = function(e)
+		if (e)
 		{
-			menu_hide(object_name);
+			e.preventDefault();
+			e.stopPropagation();
 		}
-
-		e.preventDefault();
-		e.stopPropagation();
+		
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_show(object_name);
 	}
 
-	menu.onmouseout = function()
+	menu.onmouseout = function(e)
 	{
-		menu_hide(object_name);
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		if (menu_time_out)
+		{
+			clearTimeout(menu_time_out);
+			menu_time_out = false;
+		}
+		menu_time_out = window.setTimeout('menu_hide()', 100);
 	}
-*/
 
 	menu.style.display	= 'none';
 	menu.style.position	= is_gecko ? 'fixed' : 'absolute';
@@ -101,6 +136,17 @@
 
 function menu_show(object_name)
 {
+	// If a menu is open, lets close it
+	if (active_menu)
+	{
+		if (active_menu == object_name)
+		{
+			return;
+		}
+
+		menu_hide(active_menu);
+	}
+
 	var menu		= document.getElementById(object_name + '_menu');
 	var object		= document.getElementById(object_name);
 
@@ -109,12 +155,6 @@
 		return;
 	}
 
-	// If a menu is open, lets close it
-	if (active_menu)
-	{
-		menu_hide(active_menu);
-	}
-
 	active_menu = object_name;
 
 	// best to do this everytime, incase the windows is resized
@@ -148,6 +188,11 @@
 {
 	if (!object_name)
 	{
+		if (!active_menu)
+		{
+			return
+		}
+
 		object_name = active_menu;
 	}
 

Modified: cms/trunk/modules/Control_Panel/index.php
===================================================================
--- cms/trunk/modules/Control_Panel/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -17,7 +17,8 @@
 }
 
 require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =& $_CLASS['forums_auth'];
 
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang();
@@ -33,7 +34,7 @@
 
 //define the undefineds
 $_CLASS['core_template']->assign_array(array(
-	'S_DISPLAY_FORM'		=> true,
+	'S_DISPLAY_FORM'		=> false,
 	'S_SHOW_PM_BOX'			=> false,
 	'S_SHOW_COLOUR_LEGEND'	=> false,
 	'USERNAME'				=> '',

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_attachments.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -42,6 +42,7 @@
 				$refresh_url = generate_link('Control_Panel&amp;i='.$id);
 				$_CLASS['core_display']->meta_refresh(3, $refresh_url);
 				$message = ((sizeof($delete_ids) == 1) ? $_CLASS['core_user']->lang['ATTACHMENT_DELETED'] : $_CLASS['core_user']->lang['ATTACHMENTS_DELETED']) . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $refresh_url . '">', '</a>');
+
 				trigger_error($message);
 			}
 		}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -185,12 +185,10 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$_CLASS['core_template']->assign_array(array(
-			'S_DISPLAY_FORM', true,
-			'S_UCP_ACTION' => ''
-		));
+		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 
 		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
+		
 	}
 }
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -68,7 +68,7 @@
 
 		// Folder directly specified?
 		$folder_specified = get_variable('folder', 'REQUEST');
-		
+
 		if ($folder_specified)
 		{
 			if (is_numeric($folder_specified))
@@ -148,14 +148,16 @@
 
 				$_CLASS['core_db']->free_result($result);
 				
-				(int) $_CLASS['core_user']->data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+				(int) $_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 				
 				get_folder($_CLASS['core_user']->data['user_id'], $folder);
 
 				require(SITE_FILE_ROOT.'modules/Control_Panel/ucp/ucp_pm_options.php');
 				message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
-				break;
 
+				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_pm_options.html');
+			break;
+
 			case 'drafts':
 				get_folder($_CLASS['core_user']->data['user_id'], $folder);
 			
@@ -182,7 +184,7 @@
 				list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
 				$_CLASS['core_db']->free_result($result);
 
-				$_CLASS['core_user']->data['message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
+				$_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 
 				if ($folder_specified)
 				{
@@ -199,7 +201,7 @@
 				{
 					$folder_id = PRIVMSGS_INBOX;
 				}
-					
+
 				$msg_id = get_variable('p', 'REQUEST', 0, 'int');
 				$view	= get_variable('view', 'REQUEST');
 				
@@ -217,7 +219,7 @@
 					$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
 					$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
 
-					if (move_pm($_CLASS['core_user']->data['user_id'], $_CLASS['core_user']->data['message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
+					if (move_pm($_CLASS['core_user']->data['user_id'], $_CLASS['core_user']->data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
 					{
 						// Return to folder view if single message moved
 						if ($action == 'view_message')
@@ -324,9 +326,9 @@
 						set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']->data['user_id'], $folder_id);
 					}
 				}
-				
+
 				get_folder($_CLASS['core_user']->data['user_id'], $folder, $folder_id);
-			
+	
 				$s_folder_options = $s_to_folder_options = '';
 				foreach ($folder as $f_id => $folder_ary)
 				{
@@ -337,7 +339,7 @@
 				}
 
 				clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
-	
+
 				// Header for message view - folder and so on
 				$folder_status = get_folder_status($folder_id, $folder);
 				$url = 'Control_Panel&amp;i='.$id;
@@ -380,7 +382,7 @@
 					$_CLASS['core_display']->display(false,  'modules/Control_Panel/ucp_pm_viewfolder.html');
 
 				}
-				else if ($action == 'view_message')
+				elseif ($action == 'view_message')
 				{
 					$_CLASS['core_template']->assign_array(array(
 						'S_VIEW_MESSAGE'=> true,

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_options.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -24,8 +24,8 @@
 		'NONE_CONDITION'			=> false,
 		'S_ACTION_DEFINED'			=> false,
 		'NOTIFICATION_MESSAGE'		=> false,
-		'rule'						=> false)
-	);
+		'rule'						=> false
+	));
 
 	// Change "full folder" setting - what to do if folder is full
 	if (isset($_POST['fullfolder']))
@@ -37,15 +37,19 @@
 		{
 			case 1:
 				$set_folder_id = FULL_FOLDER_DELETE;
-				break;
+			break;
+
 			case 2:
 				$set_folder_id = request_var('full_move_to', PRIVMSGS_INBOX);
-				break;
+			break;
+
 			case 3:
 				$set_folder_id = FULL_FOLDER_HOLD;
-				break;
+			break;
+
 			default:
 				$full_action = 0;
+			break;
 		}
 
 		if ($full_action)
@@ -71,32 +75,38 @@
 		if ($folder_name)
 		{
 			$sql = 'SELECT folder_name 
-				FROM ' . PRIVMSGS_FOLDER_TABLE . "
-				WHERE folder_name = '" . $_CLASS['core_db']->sql_escape($folder_name) . "'
+				FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+				WHERE folder_name = '" . $_CLASS['core_db']->escape($folder_name) . "'
 					AND user_id = " . $_CLASS['core_user']->data['user_id'];
 			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-			if ($_CLASS['core_db']->fetch_row_assoc($result))
+			if ($row)
 			{
 				trigger_error(sprintf($_CLASS['core_user']->lang['FOLDER_NAME_EXIST'], $folder_name));
 			}
-			$_CLASS['core_db']->free_result($result);
 
-			$sql = 'SELECT COUNT(folder_id) as num_folder
-				FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			$sql = 'SELECT COUNT(*) as num_folder
+				FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 			$result = $_CLASS['core_db']->query($sql);
-			
-			if ($_CLASS['core_db']->sql_fetchfield('num_folder', 0, $result) >= $config['pm_max_boxes'])
+			list($count) = $_CLASS['core_db']->fetch_row_num($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($count >= $config['pm_max_boxes'])
 			{
 				trigger_error('MAX_FOLDER_REACHED');
 			}
-			$_CLASS['core_db']->free_result($result);
 
-			$sql = 'INSERT INTO ' . PRIVMSGS_FOLDER_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'user_id' => (int) $_CLASS['core_user']->data['user_id'], 'folder_name' => $folder_name));
-			$_CLASS['core_db']->query($sql);
+			$sql_array = array(
+				'user_id' => (int) $_CLASS['core_user']->data['user_id'],
+				'folder_name' => $folder_name,
+				'pm_count' => 0
+			);
 
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_FOLDER_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
+
 			$message = $_CLASS['core_user']->lang['FOLDER_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $redirect_url . '">', '</a>');
 			$_CLASS['core_display']->meta_refresh(3, $redirect_url);
 			trigger_error($message);
@@ -117,7 +127,7 @@
 
 		// Select custom folder
 		$sql = 'SELECT folder_name, pm_count
-			FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 				AND folder_id = $rename_folder_id";
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -129,8 +139,21 @@
 			trigger_error('CANNOT_RENAME_FOLDER');
 		}
 
-		$sql = 'UPDATE ' . PRIVMSGS_FOLDER_TABLE . " 
-			SET folder_name = '" . $_CLASS['core_db']->sql_escape($new_folder_name) . "'
+		$sql = 'SELECT folder_name 
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
+			WHERE folder_name = '" . $_CLASS['core_db']->escape($new_folder_name) . "'
+				AND user_id = " . $_CLASS['core_user']->data['user_id'];
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if ($row)
+		{
+			trigger_error(sprintf($_CLASS['core_user']->lang['FOLDER_NAME_EXIST'], $new_folder_name));
+		}
+
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . " 
+			SET folder_name = '" . $_CLASS['core_db']->escape($new_folder_name) . "'
 			WHERE folder_id = $rename_folder_id
 				AND user_id = ".$_CLASS['core_user']->data['user_id'];
 		$_CLASS['core_db']->query($sql);
@@ -150,17 +173,17 @@
 		$move_to = request_var('move_to', PRIVMSGS_INBOX);
 
 		// Move to same folder?
-		if ($remove_action == 1 && $remove_folder_id == $move_to)
+		if ($remove_action == 1 && $remove_folder_id === $move_to)
 		{
 			trigger_error('CANNOT_MOVE_TO_SAME_FOLDER');
 		}
-		
+
 		// Select custom folder
 		$sql = 'SELECT folder_name, pm_count
-			FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 				AND folder_id = $remove_folder_id";
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$result = $_CLASS['core_db']->query($sql);
 		$folder_row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
@@ -169,17 +192,19 @@
 			trigger_error('CANNOT_REMOVE_FOLDER');
 		}
 
-		$s_hidden_fields = '<input type="hidden" name="remove_folder_id" value="' . $remove_folder_id . '" />';
-		$s_hidden_fields .= '<input type="hidden" name="remove_action" value="' . $remove_action . '" />';
-		$s_hidden_fields .= '<input type="hidden" name="move_to" value="' . $move_to . '" />';
-		$s_hidden_fields .= '<input type="hidden" name="remove_folder" value="1" />';
+		$hidden_fields = array(
+			'remove_folder_id'	=> $remove_folder_id,
+			'remove_folder'		=> 1,
+			'remove_action'		=> $remove_action,
+			'move_to'			=> $move_to,
+		);
 
 		// Do we need to confirm?
-		if (confirm_box(true))
+		if (display_confirmation($_CLASS['core_user']->get_lang('REMOVE_FOLDER'), generate_hidden_fields($hidden_fields)))
 		{
 			// Gather message ids
 			$sql = 'SELECT msg_id 
-				FROM ' . PRIVMSGS_TO_TABLE . '
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND folder_id = $remove_folder_id";
 			$result = $_CLASS['core_db']->query($sql);
@@ -196,7 +221,7 @@
 			{
 				// Move Messages
 				case 1:
-					$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
+					$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $_CLASS['core_user']->data['user_message_limit'] : $config['pm_max_msgs'];
 					$num_moved = move_pm($_CLASS['core_user']->data['user_id'], $message_limit, $msg_ids, $move_to, $remove_folder_id);
 					
 					// Something went wrong, only partially moved?
@@ -204,16 +229,16 @@
 					{
 						trigger_error(sprintf($_CLASS['core_user']->lang['MOVE_PM_ERROR'], $num_moved, $folder_row['pm_count']));
 					}
-					break;
+				break;
 
 				// Remove Messages
 				case 2:
 					delete_pm($_CLASS['core_user']->data['user_id'], $msg_ids, $remove_folder_id);
-					break;
+				break;
 			}
 
 			// Remove folder
-			$sql = 'DELETE FROM ' . PRIVMSGS_FOLDER_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 				WHERE user_id = '.$_CLASS['core_user']->data['user_id']."
 					AND folder_id = $remove_folder_id";
 			$_CLASS['core_db']->query($sql);
@@ -236,10 +261,6 @@
 			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $meta_info . '">', '</a>');
 			trigger_error($message);
 		}
-		else
-		{
-			confirm_box(false, 'REMOVE_FOLDER', $s_hidden_fields);
-		}
 	}
 
 	// Add Rule
@@ -278,17 +299,18 @@
 		);
 
 		$sql = 'SELECT rule_id 
-			FROM ' . PRIVMSGS_RULES_TABLE . '
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 			WHERE ' . $_CLASS['core_db']->sql_build_array('SELECT', $rule_ary);
-		$result = $_CLASS['core_db']->query($sql);
+		$result = $_CLASS['core_db']->query($sql, 1);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
-		if ($_CLASS['core_db']->fetch_row_assoc($result))
+		if ($row)
 		{
 			trigger_error('RULE_ALREADY_DEFINED');
 		}
-		$_CLASS['core_db']->free_result($result);
 		
-		$sql = 'INSERT INTO ' . PRIVMSGS_RULES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $rule_ary);
+		$sql = 'INSERT INTO ' . FORUMS_PRIVMSGS_RULES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $rule_ary);
 		$_CLASS['core_db']->query($sql);
 
 		$message = $_CLASS['core_user']->lang['RULE_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $redirect_url . '">', '</a>');
@@ -312,7 +334,7 @@
 		// Do we need to confirm ?
 		if (confirm_box(true))
 		{
-			$sql = 'DELETE FROM ' . PRIVMSGS_RULES_TABLE . '
+			$sql = 'DELETE FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND rule_id = $delete_id";
 			$_CLASS['core_db']->query($sql);
@@ -331,10 +353,10 @@
 	}
 	
 	$folder = array();
-	$message_limit = (!$_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
+	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $config['pm_max_msgs'] : $_CLASS['core_user']->data['user_message_limit'];
 
-	$sql = 'SELECT COUNT(msg_id) as num_messages
-		FROM ' . PRIVMSGS_TO_TABLE . '
+	$sql = 'SELECT COUNT(*) as num_messages
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 			AND folder_id = ' . PRIVMSGS_INBOX;
 	$result = $_CLASS['core_db']->query($sql);
@@ -342,12 +364,12 @@
 	$_CLASS['core_db']->free_result($result);
 	
 	$folder[PRIVMSGS_INBOX] = array(
-		'folder_name'	=> $_CLASS['core_user']->lang['PM_INBOX'], 
+		'folder_name'	=> $_CLASS['core_user']->get_lang('PM_INBOX'),
 		'message_status'=> sprintf($_CLASS['core_user']->lang['FOLDER_MESSAGE_STATUS'], $num_messages, $message_limit)
 	);
 
 	$sql = 'SELECT folder_id, folder_name, pm_count 
-		FROM ' . PRIVMSGS_FOLDER_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 	$result = $_CLASS['core_db']->query($sql);
 
@@ -355,6 +377,7 @@
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$num_user_folder++;
+
 		$folder[$row['folder_id']] = array(
 			'folder_name'	=> $row['folder_name'], 
 			'message_status'=> sprintf($_CLASS['core_user']->lang['FOLDER_MESSAGE_STATUS'], $row['pm_count'], $message_limit)
@@ -363,7 +386,9 @@
 	$_CLASS['core_db']->free_result($result);
 
 	$s_full_folder_options = $s_to_folder_options = $s_folder_options = '';
-	
+// temp
+$_CLASS['core_user']->data['user_full_folder'] = FULL_FOLDER_NONE;
+
 	if ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE)
 	{
 		// -3 here to let the correct folder id be selected
@@ -378,7 +403,7 @@
 	{
 		$s_full_folder_options .= '<option value="' . $folder_id . '"' . (($_CLASS['core_user']->data['user_full_folder'] == $folder_id) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')</option>';
 		//$s_to_folder_options .= '<option value="' . $folder_id . '"' . (($to_folder_id == $folder_id) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')</option>';
-		$s_to_folder_options .= '<option value="' . $folder_id . '>' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')</option>';
+		$s_to_folder_options .= '<option value="' . $folder_id . '">' . $folder_ary['folder_name'] . ' (' . $folder_ary['message_status'] . ')</option>';
 	
 		if ($folder_id != PRIVMSGS_INBOX)
 		{
@@ -415,8 +440,8 @@
 
 		'DEFAULT_ACTION'		=> ($config['full_folder_action'] == 1) ? $_CLASS['core_user']->lang['DELETE_OLDEST_MESSAGES'] : $_CLASS['core_user']->lang['HOLD_NEW_MESSAGES'],
 			
-		'U_FIND_USERNAME'		=> generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=rule_string'))
-	);
+		'U_FIND_USERNAME'		=> generate_link('Members_List&amp;mode=searchuser&amp;form=ucp&amp;field=rule_string')
+	));
 
 	$rule_lang = $action_lang = $check_lang = array();
 
@@ -434,21 +459,21 @@
 	$action_option	= request_var('action_option', '');
 	$back = (isset($_REQUEST['back'])) ? request_var('back', '') : array();
 
-	if (sizeof($back))
+	if (!empty($back))
 	{
 		if ($action_option)
 		{
 			$action_option = '';
 		}
-		else if ($cond_option)
+		elseif ($cond_option)
 		{
 			$cond_option = '';
 		}
-		else if ($rule_option)
+		elseif ($rule_option)
 		{
 			$rule_option = 0;
 		}
-		else if ($check_option)
+		elseif ($check_option)
 		{
 			$check_option = 0;
 		}
@@ -582,16 +607,17 @@
 	
 	$_CLASS['core_template']->assign_array(array(
 		'S_COND_DEFINED'	=> true,
-		'S_COND_SELECT'		=> (!$hardcoded && isset($global_rule_conditions[$rule_option])) ? true : false)
-	);
+		'S_COND_SELECT'		=> (!$hardcoded && isset($global_rule_conditions[$rule_option]))
+	));
 
 	// Define COND_OPTION
-	if (!isset($global_rule_conditions[$rule_option]))
+	if (empty($global_rule_conditions[$rule_option]))
 	{
 		$_CLASS['core_template']->assign_array(array(
 			'COND_OPTION'	=> 'none',
-			'COND_CURRENT'	=> false)
-		);
+			'COND_CURRENT'	=> false
+		));
+
 		return;
 	}
 	
@@ -612,36 +638,47 @@
 			);
 
 			$current_value = $rule_string;
-			break;
+		break;
 
 		case 'user':
 			$rule_user_id = request_var('rule_user_id', 0);
 			$rule_string = request_var('rule_string', '');
 
-			if ($rule_string && !$rule_user_id)
+			if ($rule_string)
 			{
 				$sql = 'SELECT user_id
 					FROM ' . USERS_TABLE . "
-					WHERE username = '" . $_CLASS['core_db']->sql_escape($rule_string) . "'";
-				$result = $_CLASS['core_db']->query($sql);
-				
-				if (!($rule_user_id = $_CLASS['core_db']->sql_fetchfield('user_id', 0, $result)))
+					WHERE username = '" . $_CLASS['core_db']->escape($rule_string) . "'";
+				$result = $_CLASS['core_db']->query_limit($sql, 1);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+	
+				if (!$row)
 				{
 					$rule_string = '';
 				}
-				$_CLASS['core_db']->free_result($result);
+				else
+				{
+					$rule_user_id = (int) $row['user_id'];
+				}
 			}
-			else if (!$rule_string && $rule_user_id)
+			elseif ($rule_user_id)
 			{
 				$sql = 'SELECT username
 					FROM ' . USERS_TABLE . "
 					WHERE user_id = $rule_user_id";
 				$result = $_CLASS['core_db']->query($sql);
-				
-				if (!($rule_string = $_CLASS['core_db']->sql_fetchfield('username', 0, $result)))
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+
+				if (!$row)
 				{
 					$rule_user_id = 0;
 				}
+				else
+				{
+					$rule_string = $row['username'];
+				}
 				$_CLASS['core_db']->free_result($result);
 			}
 
@@ -649,11 +686,11 @@
 				'S_USER_CONDITION'	=> true,
 				'CURRENT_STRING'	=> $rule_string,
 				'CURRENT_USER_ID'	=> $rule_user_id,
-				'CURRENT_GROUP_ID'	=> 0)
-			);
+				'CURRENT_GROUP_ID'	=> 0
+			));
 
 			$current_value = $rule_string;
-			break;
+		break;
 
 		case 'group':
 			$rule_group_id = request_var('rule_group_id', 0);
@@ -663,21 +700,27 @@
 				'S_GROUP_CONDITION'	=> true,
 				'CURRENT_STRING'	=> $rule_string,
 				'CURRENT_USER_ID'	=> 0,
-				'CURRENT_GROUP_ID'	=> $rule_group_id)
-			);
+				'CURRENT_GROUP_ID'	=> $rule_group_id
+			));
 
 			$current_value = $rule_string;
 
-			break;
+		break;
 
 		default:
+			$_CLASS['core_template']->assign_array(array(
+				'COND_OPTION'	=> 'none',
+				'COND_CURRENT'	=> false
+			));
+
 			return;
+		break;
 	}
 
 	$_CLASS['core_template']->assign_array(array(
 		'COND_OPTION'	=> $condition,
-		'COND_CURRENT'	=> $current_value)
-	);
+		'COND_CURRENT'	=> $current_value
+	));
 }
 
 function show_defined_rules($user_id, $check_lang, $rule_lang, $action_lang, $folder)
@@ -685,7 +728,7 @@
 	global $_CLASS;
 
 	$sql = 'SELECT *
-		FROM ' . PRIVMSGS_RULES_TABLE . '
+		FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . '
 		WHERE user_id = ' . $user_id;
 	$result = $_CLASS['core_db']->query($sql);
 	

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_viewfolder.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -22,9 +22,7 @@
 {
 	global $_CLASS, $config;
 	
-	// Grab icons
-	$icons = array();
-	obtain_icons($icons);
+	$icons = obtain_icons();
 
 	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
 	
@@ -68,7 +66,7 @@
 	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']->data['user_id'], "Control_Panel&amp;i=$id", $type);
 
 	// Okay, lets dump out the page ...
-	if (sizeof($folder_info['pm_list']))
+	if (!empty($folder_info['pm_list']))
 	{
 		// Build Recipient List if in outbox/sentbox - max two additional queries
 		$recipient_list = $address_list = $address = array();
@@ -190,7 +188,7 @@
 
 	$start		= request_var('start', 0);
 
-	//$sort_days	= request_var('st', ((!empty($_CLASS['core_user']->data['user_post_show_days'])) ? $_CLASS['core_user']->data['user_post_show_days'] : 0));
+	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']->data['user_post_show_days'])) ? $_CLASS['core_user']->data['user_post_show_days'] : 0));
 	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']->data['user_post_sortby_type'])) ? $_CLASS['core_user']->data['user_post_sortby_type'] : 't'));
 	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']->data['user_post_sortby_dir'])) ? $_CLASS['core_user']->data['user_post_sortby_dir'] : 'd'));
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -27,52 +27,38 @@
 
 				if ($submit)
 				{
-					$var_ary = array(
-						'dateformat'		=> (string) $_CORE_CONFIG['global']['default_dateformat'], 
-						'lang'				=> (string) $_CORE_CONFIG['global']['default_lang'], 
-						'tz'				=> (float) $_CORE_CONFIG['global']['default_timezone'] / 3600,
-						'theme'				=> (string) $_CORE_CONFIG['global']['default_theme'], 
-						'dst'				=> (bool) $_CORE_CONFIG['global']['default_dst'], 
-						'viewemail'			=> false, 
-						'massemail'			=> true, 
-						'hideonline'		=> false, 
-						'notifymethod'		=> 0, 
-						'notifypm'			=> true, 
-						'popuppm'			=> false, 
-						'allowpm'			=> true,
-						'report_pm_notify'	=> false
-					);
+					$time_format	= get_variable('time_format', 'REQUEST', null);
+					$lang			= get_variable('lang', 'REQUEST', null);
+					$tz				= get_variable('tz', 'REQUEST', null);
+					$dst			= get_variable('dst', 'REQUEST', null);
 
-					foreach ($var_ary as $var => $default)
-					{
-						$data[$var] = request_var($var, $default);
-					}
+					$theme 		= get_variable('theme', 'REQUEST', null);
+	
+					$viewemail		= (bool) get_variable('viewemail', 'REQUEST', true, 'interger');
+					$massemail		= (bool) get_variable('massemail', 'REQUEST', false, 'interger');
+					$hideonline	= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
+					$notifypm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
 
-					$var_ary = array(
-						'lang'			=> array('match', false, '#^[a-z_]{2,}$#i'),
-						'tz'			=> array('num', false, -13, 13),
-					);
+					$popuppm	= (bool) get_variable('popuppm', 'REQUEST', true, 'interger');
+					$allowpm	= (bool) get_variable('allowpm', 'REQUEST', true, 'interger');
+				//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
 
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if (!sizeof($error))
+					if (empty($error))
 					{
 						$_CLASS['core_user']->optionset('popuppm', $popuppm);
-						$_CLASS['core_user']->optionset('report_pm_notify', $report_pm_notify);
+						//$_CLASS['core_user']->optionset('report_pm_notify', $report_pm_notify);
 						
 						$sql_ary = array(
 							'user_allow_pm'			=> $allowpm, 
 							'user_allow_viewemail'	=> $viewemail, 
 							'user_allow_massemail'	=> $massemail, 
-							'user_allow_viewonline'	=> ($_CLASS['auth']->acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']->data['user_allow_viewonline'], 
-							'user_notify_type'		=> $notifymethod, 
+							'user_allow_viewonline'	=> ($_CLASS['forums_auth']->acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']->data['user_allow_viewonline'], 
+							//'user_notify_type'		=> $notifymethod, 
 							//'user_notify_pm'		=> $notifypm,
 							'user_data'				=> serialize($_CLASS['core_user']->data['user_data']), 
 
 							'user_dst'				=> $dst,
-							'user_time_format'		=> $dateformat,
+							'user_time_format'		=> $time_format,
 							'user_lang'				=> $lang,
 							'user_timezone'			=> $tz * 3600,
 							'user_theme'			=> $theme,
@@ -153,8 +139,8 @@
 					'DATE_FORMAT'		=> $dateformat, 
 
 					'S_LANG_OPTIONS'	=> select_language($lang), 
-					'S_THEME_OPTIONS'	=> select_theme($theme),
-					'S_TZ_OPTIONS'		=> select_tz($tz),
+					'S_THEME_OPTIONS'	=> select_theme($theme, true),
+					'S_TZ_OPTIONS'		=> select_tz($tz, true),
 					'S_CAN_HIDE_ONLINE'	=> true, 
 					'S_SELECT_NOTIFY'	=> ($config['jab_enable'] && $_CLASS['core_user']->data['user_jabber'] && @extension_loaded('xml')) ? true : false)
 				);
@@ -164,47 +150,30 @@
 
 				if ($submit)
 				{
-					$var_ary = array(
-						'topic_sk'	=> (string) 't',
-						'topic_sd'	=> (string) 'd',
-						'topic_st'	=> 0,
+					$topic_sk 	= get_variable('topic_sk', 'REQUEST', 't');
+					$topic_sd	= get_variable('topic_sd', 'REQUEST', 'd');
+					$topic_st	= get_variable('topic_st', 'REQUEST', 0, 'interger');
+					
+					$post_sk 	= get_variable('post_sk', 'REQUEST', 't');
+					$post_sd	= get_variable('post_sd', 'REQUEST', 'd');
+					$post_st	= get_variable('post_st', 'REQUEST', 0, 'interger');
+	
+					$images		= (bool) get_variable('images', 'REQUEST', true, 'interger');
+					$flash		= (bool) get_variable('flash', 'REQUEST', false, 'interger');
+					$smilies	= (bool) get_variable('smilies', 'REQUEST', true, 'interger');
+					$sigs		= (bool) get_variable('sigs', 'REQUEST', true, 'interger');
+					$avatars	= (bool) get_variable('avatars', 'REQUEST', true, 'interger');
+					$wordcensor	= (bool) get_variable('wordcensor', 'REQUEST', true, 'interger');
 
-						'post_sk'	=> (string) 't',
-						'post_sd'	=> (string) 'a',
-						'post_st'	=> 0,
-
-						'images'	=> true, 
-						'flash'		=> false, 
-						'smilies'	=> true, 
-						'sigs'		=> true, 
-						'avatars'	=> true, 
-						'wordcensor'=> false, 
-					);
-
-					foreach ($var_ary as $var => $default)
+					if (empty($error))
 					{
-						$data[$var] = request_var($var, $default);
-					}
-
-					$var_ary = array(
-						'topic_sk'	=> array('string', false, 1, 1),
-						'topic_sd'	=> array('string', false, 1, 1),
-						'post_sk'	=> array('string', false, 1, 1),
-						'post_sd'	=> array('string', false, 1, 1),
-					);
-
-					$error = validate_data($data, $var_ary);
-					extract($data);
-					unset($data);
-
-					if (!sizeof($error))
-					{
 						$_CLASS['core_user']->optionset('viewimg', $images);
 						$_CLASS['core_user']->optionset('viewflash', $flash);
 						$_CLASS['core_user']->optionset('viewsmilies', $smilies);
 						$_CLASS['core_user']->optionset('viewsigs', $sigs);
 						$_CLASS['core_user']->optionset('viewavatars', $avatars);
-						if ($_CLASS['auth']->acl_get('u_chgcensors'))
+
+						if ($_CLASS['forums_auth']->acl_get('u_chgcensors'))
 						{
 							$_CLASS['core_user']->optionset('viewcensors', $wordcensor);
 						}
@@ -229,18 +198,15 @@
 						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
 						trigger_error($message);
 					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				$topic_sk = (isset($topic_sk)) ? $topic_sk : ((!empty($_CLASS['core_user']->data['user_tpic_sortby_type'])) ? $_CLASS['core_user']->data['user_topic_sortby_type'] : 't');
-				$post_sk = (isset($post_sk)) ? $post_sk : ((!empty($_CLASS['core_user']->data['user_post_sortby_type'])) ? $_CLASS['core_user']->data['user_post_sortby_type'] : 't');
+				$topic_sd = empty($_CLASS['core_user']->data['user_topic_sortby_dir']) ? 'd' : $_CLASS['core_user']->data['user_topic_sortby_dir'];
+				$topic_sk = empty($_CLASS['core_user']->data['user_tpic_sortby_type']) ? 't' : $_CLASS['core_user']->data['user_topic_sortby_type'];
+				$topic_st = empty($_CLASS['core_user']->data['user_topic_show_days']) ? 0 : $_CLASS['core_user']->data['user_topic_show_days'];
 
-				$topic_sd = (isset($topic_sd)) ? $topic_sd : ((!empty($_CLASS['core_user']->data['user_topic_sortby_dir'])) ? $_CLASS['core_user']->data['user_topic_sortby_dir'] : 'd');
-				$post_sd = (isset($post_sd)) ? $post_sd : ((!empty($_CLASS['core_user']->data['user_post_sortby_dir'])) ? $_CLASS['core_user']->data['user_post_sortby_dir'] : 'd');
-				
-				$topic_st = (isset($topic_st)) ? $topic_st : ((!empty($_CLASS['core_user']->data['user_topic_show_days'])) ? $_CLASS['core_user']->data['user_topic_show_days'] : 0);
-				$post_st = (isset($post_st)) ? $post_st : ((!empty($_CLASS['core_user']->data['user_post_show_days'])) ? $_CLASS['core_user']->data['user_post_show_days'] : 0);
+				$post_sd = empty($_CLASS['core_user']->data['user_post_sortby_dir']) ? 'd' : $_CLASS['core_user']->data['user_post_sortby_dir'];
+				$post_sk = empty($_CLASS['core_user']->data['user_post_sortby_type']) ? 't' : $_CLASS['core_user']->data['user_post_sortby_type'];
+				$post_st = empty($_CLASS['core_user']->data['user_post_show_days']) ? 0 : $_CLASS['core_user']->data['user_post_show_days'];
 
 				$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
 				
@@ -282,28 +248,29 @@
 					}
 					${'s_sort_' . $sort_option . '_dir'} .= '</select>';
 				}
-				
-				$images = (isset($images)) ? $images : $_CLASS['core_user']->optionget('viewimg');
+
+				$images 	= $_CLASS['core_user']->optionget('viewimg');
+				$flash		= $_CLASS['core_user']->optionget('viewflash');
+				$smilies	= $_CLASS['core_user']->optionget('viewsmilies');
+				$sigs		= $_CLASS['core_user']->optionget('viewsigs');
+				$avatars	= $_CLASS['core_user']->optionget('viewavatars');
+				$wordcensor = $_CLASS['core_user']->optionget('viewcensors');
+
 				$images_yes = ($images) ? ' checked="checked"' : '';
 				$images_no = (!$images) ? ' checked="checked"' : '';
-				$flash = (isset($flash)) ? $flash : $_CLASS['core_user']->optionget('viewflash');
 				$flash_yes = ($flash) ? ' checked="checked"' : '';
 				$flash_no = (!$flash) ? ' checked="checked"' : '';
-				$smilies = (isset($smilies)) ? $smilies : $_CLASS['core_user']->optionget('viewsmilies');
 				$smilies_yes = ($smilies) ? ' checked="checked"' : '';
 				$smilies_no = (!$smilies) ? ' checked="checked"' : '';
-				$sigs = (isset($sigs)) ? $sigs : $_CLASS['core_user']->optionget('viewsigs');
 				$sigs_yes = ($sigs) ? ' checked="checked"' : '';
 				$sigs_no = (!$sigs) ? ' checked="checked"' : '';
-				$avatars = (isset($avatars)) ? $avatars : $_CLASS['core_user']->optionget('viewavatars');
 				$avatars_yes = ($avatars) ? ' checked="checked"' : '';
 				$avatars_no = (!$avatars) ? ' checked="checked"' : '';
-				$wordcensor = (isset($wordcensor)) ? $wordcensor : $_CLASS['core_user']->optionget('viewcensors');
 				$wordcensor_yes = ($wordcensor) ? ' checked="checked"' : '';
 				$wordcensor_no = (!$wordcensor) ? ' checked="checked"' : '';
 
 				$_CLASS['core_template']->assign_array(array( 
-					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
+					'ERROR'				=> empty($error) ? '' : implode('<br />', $error),
 					
 					'VIEW_IMAGES_YES'		=> $images_yes, 
 					'VIEW_IMAGES_NO'		=> $images_no, 
@@ -318,78 +285,64 @@
 					'DISABLE_CENSORS_YES'	=> $wordcensor_yes, 
 					'DISABLE_CENSORS_NO'	=> $wordcensor_no,
 
-					'S_CHANGE_CENSORS'		=> ($_CLASS['auth']->acl_get('u_chgcensors')) ? true : false, 
+					'S_CHANGE_CENSORS'		=> $_CLASS['forums_auth']->acl_get('u_chgcensors'), 
 
 					'S_TOPIC_SORT_DAYS'		=> $s_limit_topic_days,
 					'S_TOPIC_SORT_KEY'		=> $s_sort_topic_key,
 					'S_TOPIC_SORT_DIR'		=> $s_sort_topic_dir,
 					'S_POST_SORT_DAYS'		=> $s_limit_post_days,
 					'S_POST_SORT_KEY'		=> $s_sort_post_key,
-					'S_POST_SORT_DIR'		=> $s_sort_post_dir)
-				);
-				
-				break;
+					'S_POST_SORT_DIR'		=> $s_sort_post_dir
+				));
+			break;
 
 			case 'post':
-
 				if ($submit)
 				{
-					$var_ary = array(
-						'bbcode'	=> true, 
-						'html'		=> false, 
-						'smilies'	=> true,
-						'sig'		=> true, 
-						'notify'	=> false, 
-					);
+					$bbcode 	= (bool) get_variable('bbcode', 'REQUEST', true, 'interger');
+					$html		= (bool) get_variable('html', 'REQUEST', false, 'interger');
+					$smilies	= (bool) get_variable('smilies', 'REQUEST', true, 'interger');
+					$sig		= (bool) get_variable('sig', 'REQUEST', true, 'interger');
+					$notify		= (bool) get_variable('notify', 'REQUEST', false, 'interger');
 
-					foreach ($var_ary as $var => $default)
-					{
-						$$var = request_var($var, $default);
-					}
-
 					$_CLASS['core_user']->optionset('bbcode', $bbcode);
 					$_CLASS['core_user']->optionset('html', $html);
 					$_CLASS['core_user']->optionset('smilies', $smilies);
 					$_CLASS['core_user']->optionset('attachsig', $sig);
 
-					if (!sizeof($error))
-					{
-						$sql_ary = array(
-							'user_data'		=> serialize($_CLASS['core_user']->data['user_data']),
-							'user_notify'	=> $notify,
-						);
+					$sql_ary = array(
+						'user_data'		=> serialize($_CLASS['core_user']->data['user_data']),
+						'user_notify'	=> $notify,
+					);
 
-						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
-							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
-						$_CLASS['core_db']->sql_query($sql);
+					$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+								WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
+					$_CLASS['core_db']->sql_query($sql);
 
-						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
-						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
-						trigger_error($message);
-					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
+					$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
+					$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
+					trigger_error($message);
 				}
-				
-				$bbcode = (isset($bbcode)) ? $bbcode : $_CLASS['core_user']->optionget('bbcode');
+
+				$bbcode = $_CLASS['core_user']->optionget('bbcode');
+				$html = $_CLASS['core_user']->optionget('html');
+				$smilies = $_CLASS['core_user']->optionget('smilies');
+				$notify = $_CLASS['core_user']->data['user_notify'];
+
 				$bbcode_yes = ($bbcode) ? ' checked="checked"' : '';
-				$bbcode_no = (!$bbcode) ? ' checked="checked"' : '';
-				$html = (isset($html)) ? $html : $_CLASS['core_user']->optionget('html');
+				$bbcode_no = (!$bbcode) ? ' checked="checked"' : '';		
 				$html_yes = ($html) ? ' checked="checked"' : '';
 				$html_no = (!$html) ? ' checked="checked"' : '';
-				$smilies = (isset($smilies)) ? $smilies : $_CLASS['core_user']->optionget('smilies');
 				$smilies_yes = ($smilies) ? ' checked="checked"' : '';
 				$smilies_no = (!$smilies) ? ' checked="checked"' : '';
-				$sig = (isset($sig)) ? $sig : $_CLASS['core_user']->optionget('attachsig');
+				$sig = $_CLASS['core_user']->optionget('attachsig');
 				$sig_yes = ($sig) ? ' checked="checked"' : '';
 				$sig_no = (!$sig) ? ' checked="checked"' : '';
-				$notify = (isset($notify)) ? $notify : $_CLASS['core_user']->data['user_notify'];
 				$notify_yes = ($notify) ? ' checked="checked"' : '';
 				$notify_no = (!$notify) ? ' checked="checked"' : '';
 
-				$_CLASS['core_template']->assign_array(array( 
-					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
+				$_CLASS['core_template']->assign_array(array(
+					'ERROR'				=> empty($error) ? '' :  implode('<br />', $error),
 
 					'DEFAULT_BBCODE_YES'	=> $bbcode_yes, 
 					'DEFAULT_BBCODE_NO'		=> $bbcode_no, 
@@ -400,18 +353,20 @@
 					'DEFAULT_SIG_YES'		=> $sig_yes, 
 					'DEFAULT_SIG_NO'		=> $sig_no, 
 					'DEFAULT_NOTIFY_YES'	=> $notify_yes, 
-					'DEFAULT_NOTIFY_NO'		=> $notify_no,)
-				);
-				break;
+					'DEFAULT_NOTIFY_NO'		=> $notify_no,
+				));
+			break;
+			
+			default:
+				die;
+			break;
 		}
 
 		$_CLASS['core_template']->assign_array(array( 
 			'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PREFS_' . strtoupper($mode)],
-			'S_PRIVMSGS'		=> false,
-
 			'S_HIDDEN_FIELDS'	=> $s_hidden_fields,
-			'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"))
-		);
+			'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode")
+		));
 
 		$this->display($_CLASS['core_user']->lang['UCP_PROFILE'], 'ucp_prefs_' . $mode . '.html');
 	}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_profile.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_profile.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -30,7 +30,7 @@
 		$preview	= isset($_POST['preview']);
 		$submit		= isset($_POST['submit']);
 
-		$module_link	= generate_link("Control_Panel&amp;i=$id&amp;mode=$mode");
+		$module_link = generate_link("Control_Panel&amp;i=$id&amp;mode=$mode");
 
 		$error = $data = array();
 		$s_hidden_fields = '';
@@ -478,8 +478,8 @@
 		$_CLASS['core_template']->assign_array(array(
 			'L_TITLE'					=> $_CLASS['core_user']->lang['UCP_PROFILE_' . strtoupper($mode)],
 			'S_HIDDEN_FIELDS'			=> $s_hidden_fields,
-			'S_UCP_ACTION'				=> $module_link)
-		);
+			'S_UCP_ACTION'				=> $module_link
+		));
 
 		$this->display($_CLASS['core_user']->lang['UCP_PROFILE'], 'ucp_profile_' . $mode . '.html');
 	}

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_register.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_register.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -29,7 +29,7 @@
 		
 		$coppa		= isset($_REQUEST['coppa']) ? (int) $_REQUEST['coppa'] : null;
 		$submit		= isset($_POST['submit']);
-$_CORE_CONFIG['user']['activation'] = USER_ACTIVATION_SELF;
+
 		if ($_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_DISABLE
 			|| ($coppa || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_SELF || $_CORE_CONFIG['user']['activation'] == USER_ACTIVATION_ADMIN)
 			&& !$_CORE_CONFIG['email']['email_enable'])

Modified: cms/trunk/modules/Forums/admin/index.php
===================================================================
--- cms/trunk/modules/Forums/admin/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/admin/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -49,7 +49,9 @@
 
 $_CLASS['core_blocks']->add_block($data);
 
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =& $_CLASS['forums_auth'];
+
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
 require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 

Modified: cms/trunk/modules/Forums/ajax.php
===================================================================
--- cms/trunk/modules/Forums/ajax.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/ajax.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -29,9 +29,9 @@
 header('Content-Type: text/html');
 
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
-$_CLASS['auth']->acl($_CLASS['core_user']->data);
+$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
 
 Switch (get_variable('mode', 'POST', false))
 {
@@ -39,7 +39,7 @@
 		$forum_id = get_variable('id', 'POST', false, 'int');
 		$title = get_variable('title', 'POST', false);
 		
-		if (!$forum_id || !$title || !$_CLASS['auth']->acl_get('a_forum'))
+		if (!$forum_id || !$title || !$_CLASS['forums_auth']->acl_get('a_forum'))
 		{
 			die;
 		}
@@ -66,7 +66,7 @@
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		if (!$row || !$_CLASS['auth']->acl_get('m_edit', $row['forum_id']))
+		if (!$row || !$_CLASS['forums_auth']->acl_get('m_edit', $row['forum_id']))
 		{
 			die;
 		}
@@ -93,7 +93,7 @@
 		$row = $_CLASS['core_db']->fetch_row_assoc($result);
 		$_CLASS['core_db']->free_result($result);
 
-		if (!$row || !$_CLASS['auth']->acl_get('m_lock', $row['forum_id']))
+		if (!$row || !$_CLASS['forums_auth']->acl_get('m_lock', $row['forum_id']))
 		{
 			die;
 		}
@@ -113,7 +113,7 @@
 		$forum_id = get_variable('id', 'POST', false, 'int');
 		$lock = get_variable('lock', 'POST', 0, 'int');
 
-		if (!$forum_id || !$_CLASS['auth']->acl_get('a_forum', $forum_id))
+		if (!$forum_id || !$_CLASS['forums_auth']->acl_get('a_forum', $forum_id))
 		{
 			die;
 		}

Modified: cms/trunk/modules/Forums/index.php
===================================================================
--- cms/trunk/modules/Forums/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -33,8 +33,10 @@
 unset($approved_files);
 
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
-load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'auth');
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 
+$_CLASS['auth'] =& $_CLASS['forums_auth'];
+
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
 
 $_CLASS['core_user']->user_setup();

Modified: cms/trunk/modules/Forums/mcp.php
===================================================================
--- cms/trunk/modules/Forums/mcp.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/mcp.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -212,7 +212,7 @@
 {
 	$_REQUEST['action'] = $action = $mode;
 	$mode = 'topic_view';
-	$quickmod = false;
+	$quick_mod = false;
 }
 
 // Forum view modes
@@ -220,7 +220,7 @@
 {
 	$_REQUEST['action'] = $action = $mode;
 	$mode = 'forum_view';
-	$quickmod = false;
+	$quick_mod = false;
 }
 
 if (!$quick_mod)
@@ -228,16 +228,19 @@
 	switch ($mode)
 	{
 		case 'front':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			script_close(false);
 			//$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_front.html');
 		break;
 
 		case 'forum_view':
 			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_forum.php');
+			script_close(false);
 		break;
 		
 		case 'topic_view':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+			script_close(false);
 		break;
 			
 		case 'post_details':
@@ -245,41 +248,145 @@
 			
 			mcp_post_details($id, $mode, $action, $url);
 			
-			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_post.html');
+			$this->display($_CLASS['core_user']->lang['MCP'], 'mcp_post.html');
+			script_close(false);
 		break;
-
-		default:
-			require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
-		break;
 	}
 
-	script_close(false);
+	//script_close(false);
 }
 
+require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+	
 switch ($mode)
 {
 	case 'lock':
 	case 'unlock':
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		lock_unlock($mode, $topic_ids);
+	break;
+
 	case 'lock_post':
 	case 'unlock_post':
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		lock_unlock($mode, $post_ids);
+	break;
+
+	case 'make_announce':
 	case 'make_sticky':
-	case 'make_announce':
 	case 'make_global':
 	case 'make_normal':
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		change_topic_type($mode, $topic_ids);
+	break;
+
+	case 'move':
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_move_topic($topic_ids);
+	break;
+
 	case 'fork':
-	case 'move':
-	case 'delete_post':
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_fork_topic($topic_ids);
+	break;
+
 	case 'delete_topic':
-		require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
+		$_CLASS['core_user']->add_lang('viewtopic');
+
+		$topic_ids = get_topic_ids($quick_mod);
+
+		if (empty($topic_ids))
+		{
+			trigger_error('NO_TOPIC_SELECTED');
+		}
+
+		mcp_delete_topic($topic_ids);
 	break;
 
+	case 'delete_post':
+		$_CLASS['core_user']->add_lang('posting');
+
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		mcp_delete_post($post_ids);
+	break;
+
 	default:
-		trigger_error("$mode not allowed as quickmod");
+		trigger_error("Unknown mode: $mode");
 	break;
 }
 
 script_close(false);
 
+function get_topic_ids($quick_mod)
+{
+	$topic_ids = array_unique(get_variable('topic_id_list', 'POST', array(), 'array:int'));
+
+	if (empty($topic_ids))
+	{
+		if ($topic_ids = get_variable('t', 'REQUEST', false, 'int'))
+		{
+			$topic_ids = array($topic_ids);
+		}
+	}
+
+	return $topic_ids;
+}
+
+function get_post_ids($quick_mod)
+{
+	$post_ids = array_unique(get_variable('post_id_list', 'POST', array(), 'array:int'));
+
+	if (empty($post_ids))
+	{
+		if ($post_ids = get_variable('p', 'REQUEST', false, 'int'))
+		{
+			$post_ids = array($post_ids);
+		}
+	}
+
+	return $post_ids;
+}
+
 // Get simple topic data
 function get_topic_data($topic_ids, $acl_list = false)
 {
@@ -377,7 +484,7 @@
 	global $_CLASS;
 
 	$sort_days = request_var('sort_days', 0);
-	$min_time = ($sort_days) ? time() - ($sort_days * 86400) : 0;
+	$min_time = ($sort_days) ? $_CLASS['core_user']->time - ($sort_days * 86400) : 0;
 
 	switch ($mode)
 	{

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/posting.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -1542,7 +1542,7 @@
 				'poll_max_options'			=> isset($poll['poll_options']) ? $poll['poll_max_options'] : 1,
 				'poll_length'				=> isset($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
 				'poll_vote_change'			=> isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
-				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0) : $data['topic_attachment']
+				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0) : (int) $data['topic_attachment']
 			);
 			break;
 	}
@@ -1743,9 +1743,7 @@
 					'thumbnail'			=> $attach_row['thumbnail']
 				);
 
-				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
-					$_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
-				$_CLASS['core_db']->query($sql);
+				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql));
 
 				$space_taken += $attach_row['filesize'];
 				$files_added++;
@@ -1855,13 +1853,21 @@
 	// Topic Notification
 	if (!$data['notify_set'] && $data['notify'])
 	{
-		$sql = 'INSERT INTO ' . FORUMS_TOPICS_WATCH_TABLE . ' (user_id, topic_id)
-			VALUES (' . $_CLASS['core_user']->data['user_id'] . ', ' . $data['topic_id'] . ')';
-		$_CLASS['core_db']->query($sql);
+		$notify_sql = array(
+			'user_id'		=> $_CLASS['core_user']->data['user_id'],
+			'forum_id'		=> $data['forum_id'],
+			'topic_id'		=> $data['topic_id'],
+			'notify_type'	=> $poster_id,
+			'notify_status'	=> 0,
+		);
+				
+		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $notify_sql));
+
+		unset($notify_sql);
 	}
 	else if ($data['notify_set'] && !$data['notify'])
 	{
-		$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
+		$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
 			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 				AND topic_id = ' . $data['topic_id'];
 		$_CLASS['core_db']->query($sql);

Modified: cms/trunk/modules/Forums/search.php
===================================================================
--- cms/trunk/modules/Forums/search.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/search.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -194,7 +194,7 @@
 
 				$last_post_time = ($_CLASS['core_user']->time - ($sort_days * 24 * 3600));
 
-				$sql = 'SELECT DISTINCT t.topic_id
+				$sql = 'SELECT DISTINCT t.topic_id, t.topic_last_post_time
 					FROM ' . FORUMS_POSTS_TABLE . ' p
 					LEFT JOIN ' . FORUMS_TOPICS_TABLE . " t ON (t.topic_approved = 1 AND p.topic_id = t.topic_id)
 					WHERE p.post_time > $last_post_time
@@ -773,13 +773,13 @@
 			{
 				$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
 	
-				$folder_img = $folder_alt = $topic_type = '';
-				topic_status($row, $replies, $_CLASS['core_user']->time, $folder_img, $folder_alt, $topic_type);
+				$folder_img = $unread_topic = $folder_alt = $topic_type = '';
+				topic_status($row, $replies, $_CLASS['core_user']->time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
 				$pagination = generate_pagination($view_topic_url, $replies, $config['posts_per_page'], 0);
 
 				$tpl_ary = array(
-					'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+					'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
 					'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 					'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 					'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),

Modified: cms/trunk/modules/Forums/viewtopic.php
===================================================================
--- cms/trunk/modules/Forums/viewtopic.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Forums/viewtopic.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -183,7 +183,7 @@
 }
 
 //Check for read permission
-if (!$_CLASS['auth']->acl_get('f_read', $forum_id) && !$_CLASS['auth']->acl_get('m_', $forum_id))
+if (!$_CLASS['auth']->acl_get('f_read', $forum_id))// && !$_CLASS['auth']->acl_get('m_', $forum_id)
 {
 	if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
 	{

Modified: cms/trunk/modules/Members_List/index.php
===================================================================
--- cms/trunk/modules/Members_List/index.php	2005-09-22 16:51:53 UTC (rev 142)
+++ cms/trunk/modules/Members_List/index.php	2005-09-27 23:57:50 UTC (rev 143)
@@ -28,7 +28,8 @@
 }
 
 require_once($site_file_root.'includes/forums/functions.php');
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
+load_class($site_file_root.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['auth'] =& $_CLASS['forums_auth'];
 
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
 
@@ -46,10 +47,9 @@
 $action		= request_var('action', '');
 $user_id	= request_var('u', ANONYMOUS);
 $group_id	= request_var('g', 0);
-$topic_id	= request_var('t', 0);
 
 $start		= request_var('start', 0);
-$submit		= (isset($_POST['submit'])) ? true : false;
+$submit		= isset($_POST['submit']);
 
 $sort_key	= request_var('sk', 'c');
 $sort_dir	= request_var('sd', 'a');
@@ -400,7 +400,7 @@
 		}
 
 		// Do the relevant calculations
-		$memberdays = max(1, round((time() - $member['user_reg_date']) / 86400));
+		$memberdays = max(1, round(($_CLASS['core_user']->time - $member['user_reg_date']) / 86400));
 		$posts_per_day = $member['user_posts'] / $memberdays;
 		$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
@@ -502,15 +502,16 @@
 		
 		$_CLASS['core_template']->assign_array(array(
 			'MESSAGE' => false,
-			'SUBJECT' => false)
-		);
+			'SUBJECT' => false
+		));
 		
 		if (!$_CORE_CONFIG['email']['email_enable'])
 		{
 			trigger_error('EMAIL_DISABLED');
 		}
 
-		if (($user_id == ANONYMOUS || !$config['board_email_form']) && !$topic_id)
+		// do soemthing better than this
+		if (($user_id === ANONYMOUS || !$config['board_email_form']) && !$topic_id)
 		{
 			trigger_error('NO_EMAIL');
 		}
@@ -521,18 +522,21 @@
 		}
 
 		// Are we trying to abuse the facility?
-		if (time() - $_CLASS['core_user']->data['user_emailtime'] < $config['flood_interval'])
+		/*
+		if (($_CLASS['core_user']->time - $_CLASS['core_user']->data['user_last_email']) < $config['flood_interval'])
 		{
 			trigger_error('FLOOD_EMAIL_LIMIT');
 		}
+		*/
 
-		$name		= strip_tags(request_var('name', ''));
-		$email		= strip_tags(request_var('email', ''));
-		$email_lang = request_var('lang', '');
-		$subject	= request_var('subject', '');
-		$message	= request_var('message', '');
-		$cc			= (!empty($_POST['cc_email'])) ? true : false;
+		$name		= strip_tags(get_variable('name', 'POST'));
+		$email		= strip_tags(get_variable('email', 'POST'));
+		$subject	= get_variable('subject', 'POST');
+		$message	= get_variable('message', 'POST');
+		$cc			= !empty($_POST['cc_email']);
+		$topic_id	= get_variable('t', 'REQUEST', false, 'int');
 
+
 		// Are we sending an email to a user on this board? Or are we sending a
 		// topic heads-up message?
 		if (!$topic_id)
@@ -543,13 +547,14 @@
 				WHERE user_id = $user_id
 					AND user_type = ". USER_NORMAL . ' AND user_status = ' . STATUS_ACTIVE;
 			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-			if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+			if (!$row)
 			{
 				trigger_error('NO_USER');
 			}
-			$_CLASS['core_db']->free_result($result);
-
+			
 			// Can we send email to this user?
 			if (!$row['user_allow_viewemail'] && !$_CLASS['auth']->acl_get('a_user'))
 			{
@@ -562,26 +567,22 @@
 				FROM ' . FORUMS_TOPICS_TABLE . "
 				WHERE topic_id = $topic_id";
 			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-			if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+			if (!$row)
 			{
 				trigger_error('NO_TOPIC');
 			}
-			$_CLASS['core_db']->free_result($result);
 
 			if (!$_CLASS['auth']->acl_get('f_read', $row['forum_id']))
 			{
 				trigger_error('NO_FORUM_READ');
 			}
-
-			if (!$_CLASS['auth']->acl_get('f_email', $row['forum_id']))
-			{
-				trigger_error('NO_EMAIL');
-			}
 		}
 
-		// User has submitted a message, handle it
 		$error = array();
+
 		if ($submit)
 		{
 			if (!$topic_id)
@@ -598,7 +599,7 @@
 			}
 			else
 			{
-				if (!$email || !preg_match('#^.*?@(.*?\.)?[a-z0-9\-]+\.[a-z]{2,4}$#i', $email))
+				if (!$email || !check_email($email))
 				{
 					$error[] = $_CLASS['core_user']->lang['EMPTY_ADDRESS_EMAIL'];
 				}
@@ -609,56 +610,66 @@
 				}
 			}
 
-			if (!sizeof($error))
+			if (empty($error))
 			{
+				/*
 				$sql = 'UPDATE ' . USERS_TABLE . '
-					SET user_emailtime = ' . gmtime() . '
+					SET user_last_email = ' . $_CLASS['core_user']->time . '
 					WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 				$result = $_CLASS['core_db']->query($sql);
+				*/
 
 				// Add class loader
-				require_once($site_file_root.'includes/forums/functions_messenger.php');
 
-				$email_tpl	= (!$topic_id) ? 'profile_send_email' : 'email_notify';
-				$email_lang = (!$topic_id) ? $row['user_lang'] : $email_lang;
-				$email		= (!$topic_id) ? $row['user_email'] : $email;
+				require_once(SITE_FILE_ROOT.'includes/mailer.php');
+			
+				$mailer = new core_mailer;
 
-				$messenger = new messenger();
+				if ($topic_id)
+				{
+					$template	= 'email_notify.txt';
+					$email		= $email;
+					$subject	= $row['topic_title'];
+				}
+				else
+				{
+					$template	= 'profile_send_email.txt';
+					$email		= $row['user_email'];
+					$name 		= $row['username'];
+					$subject .= 'Email a friend';
+				}
 
-				$messenger->template($email_tpl, $email_lang);
-				$messenger->subject($subject);
 
-				$messenger->replyto($_CLASS['core_user']->data['user_email']);
-				$messenger->to($email, $row['username']);
+				$mailer->to($email, $name);
+				$mailer->reply_to($_CLASS['core_user']->data['user_email'], $_CLASS['core_user']->data['username']);
 
-				if (!$topic_id)
-				{
-					$messenger->im($row['user_jabber'], $row['username']);
-				}
-
+				$mailer->subject($subject);
+			
 				if ($cc)
 				{
-					$messenger->cc($_CLASS['core_user']->data['user_email'], $_CLASS['core_user']->data['username']);
+					$mailer->cc($_CLASS['core_user']->data['user_email'], $_CLASS['core_user']->data['username']);
 				}
 
-				$messenger->headers('X-AntiAbuse: Board servername - ' . $config['server_name']);
-				$messenger->headers('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
-				$messenger->headers('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
-				$messenger->headers('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
 
-				$messenger->assign_vars(array(
-					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
+				//$mailer->extra_header('X-AntiAbuse: Board servername - ' . $config['server_name']);
+				$mailer->extra_header('X-AntiAbuse: User_id - ' . $_CLASS['core_user']->data['user_id']);
+				$mailer->extra_header('X-AntiAbuse: Username - ' . $_CLASS['core_user']->data['username']);
+				$mailer->extra_header('X-AntiAbuse: User IP - ' . $_CLASS['core_user']->ip);
+
+				$_CLASS['core_template']->assign_array(array(
+					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 					'BOARD_EMAIL'	=> $config['board_contact'],
 					'FROM_USERNAME' => stripslashes($_CLASS['core_user']->data['username']),
-					'TO_USERNAME'   => ($topic_id) ? stripslashes($name) : stripslashes($row['username']),
+					'TO_USERNAME'   => ($topic_id) ? $name : $row['username'],
 					'MESSAGE'		=> $message,
 					'TOPIC_NAME'	=> ($topic_id) ? strtr($row['topic_title'], array_flip(get_html_translation_table(HTML_ENTITIES))) : '',
 
 					'U_TOPIC'	=> ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . "&t=$topic_id", true, true, false) : '')
 				);
 
-				$messenger->send($row['user_notify_type']);
-				$messenger->save_queue();
+				$mailer->message = trim($_CLASS['core_template']->display('email/members_list/'.$template, true));
+				echo $mailer->message; die;
+				$mailer->send();
 
 				$_CLASS['core_display']->meta_refresh(3, generate_link());
 				$message = (!$topic_id) ? sprintf($_CLASS['core_user']->lang['RETURN_INDEX'],  '<a href="' . generate_link() . '">', '</a>') : sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'],  '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=" . $row['topic_id']) . '">', '</a>');
@@ -994,7 +1005,7 @@
 
 		$sql = 'SELECT session_user_id, MAX(session_time) AS session_time
 			FROM ' . SESSIONS_TABLE . '
-			WHERE session_time >= ' . (time() - $_CORE_CONFIG['server']['session_length']) . '
+			WHERE session_time >= ' . ($_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length']) . '
 				AND session_user_id <> ' . ANONYMOUS . '
 			GROUP BY session_user_id';
 		$result = $_CLASS['core_db']->query($sql);



From viperal at berlios.de  Wed Sep 28 03:06:18 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 03:06:18 +0200
Subject: [Viperals-svncheckins] r144 - in cms/trunk: . blocks includes/forums modules/Forums themes/viperal themes/viperal/template
Message-ID: <200509280106.j8S16IFv003740@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 03:06:13 +0200 (Wed, 28 Sep 2005)
New Revision: 144

Added:
   cms/trunk/blocks/block-latest-forums.php
Modified:
   cms/trunk/includes/forums/auth.php
   cms/trunk/installer.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/themes/viperal/index.php
   cms/trunk/themes/viperal/template/header.html
Log:


Added: cms/trunk/blocks/block-latest-forums.php
===================================================================
--- cms/trunk/blocks/block-latest-forums.php	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/blocks/block-latest-forums.php	2005-09-28 01:06:13 UTC (rev 144)
@@ -0,0 +1,88 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (!defined('VIPERAL'))
+{
+    die;
+}
+
+global $_CLASS;
+
+load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
+$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
+$auth_read = $_CLASS['forums_auth']->acl_getf('f_read');
+
+if (!$auth_read)
+{
+	return;
+}
+
+$latest_active_topics = 12;
+
+$sql = 'SELECT forum_id, topic_last_post_id ,topic_title, topic_last_poster_name, topic_last_poster_id, topic_last_post_time
+			FROM ' . FORUMS_TOPICS_TABLE . ' WHERE forum_id IN ('. implode(', ', array_keys($auth_read)) .') 
+				AND topic_moved_id = 0 AND topic_approved = 1
+				ORDER BY topic_last_post_time DESC';
+
+$result = $_CLASS['core_db']->query_limit($sql, $latest_active_topics);
+$row = $_CLASS['core_db']->fetch_row_assoc($result);
+
+if (!$row)
+{
+	$_CLASS['core_db']->free_result($result);
+
+	return;
+}
+
+$counter = 0;
+$num = 1;
+
+$this->content = '<table width="100%" border="0" cellpadding="4"><tr>';
+do {
+
+	if ($counter == 3)
+	{
+		$this->content .= '</tr><tr>';
+
+		$counter = 0;
+	}
+
+	$row['topic_title'] = (strlen($row['topic_title']) <  25) ? $row['topic_title'] : substr($row['topic_title'], 0, 25) . '...';
+
+	$this->content .= '<td width="33%">'
+    .'<span style="font-size: 140%; font-weight: bold;" >'.$num.'</span>&nbsp;'
+    .'<a style="font-weight: bold;" href="'.generate_link('Forums&amp;file=viewtopic&amp;f='.$row['forum_id'].'&amp;p='.$row['topic_last_post_id'].'#'.$row['topic_last_post_id'])
+    .'" >'.$row['topic_title'].'</a><br />'
+    .'<i>Last post by <a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']).'">'. $row['topic_last_poster_name'] .'</a>'
+    .'<br/> on '.$_CLASS['core_user']->format_date($row['topic_last_post_time']).'</i><br /><br /></td>';
+	
+	$counter ++;
+	$num ++;
+}
+while($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+$_CLASS['core_db']->free_result($result);
+
+$this->content .= '</tr></table>';
+
+?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/includes/forums/auth.php	2005-09-28 01:06:13 UTC (rev 144)
@@ -267,12 +267,13 @@
 	
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$groups[] = $row['group_id'];
+				$groups[$row['group_id']] = true;
 				$group_members[$row['group_id']][] = $row['user_id'];
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			$sql_user = empty($groups) ? ' AND a.' . $sql_user :  'AND (a.'.$sql_user.' OR a.group_id IN ('.implode(', ', $groups).'))';
+			$sql_user = empty($groups) ? ' AND a.' . $sql_user :  'AND (a.'.$sql_user.' OR a.group_id IN ('.implode(', ', array_keys($groups)).'))';
+			unset($groups);
 		}
 
 		// Sort by group_id since we want user setting to over right grp..  specific > broad
@@ -293,7 +294,7 @@
 
 			if ($row['group_id'])
 			{
-				$group_id_array[$row['group_id']] = $row;
+				$group_id_array[$row['group_id']][] = $row;
 
 				continue;
 			}
@@ -316,7 +317,7 @@
 				$_CLASS['core_db']->free_result($result);
 			}
 
-			foreach ($group_id_array as $group_id => $row)
+			foreach ($group_id_array as $group_id => $rows)
 			{
 				if (empty($group_members[$group_id]))
 				{
@@ -325,7 +326,10 @@
 
 				foreach ($group_members[$group_id] as $user_id)
 				{
-					$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+					foreach($rows as $row)
+					{
+						$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+					}
 				}
 			}
 		}

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/installer.php	2005-09-28 01:06:13 UTC (rev 144)
@@ -22,7 +22,7 @@
 */
 define('VIPERAL', 'INSTALLER');
 
-error_reporting(E_ALL);
+error_reporting(0);
 
 define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 
@@ -465,7 +465,7 @@
 	$_CLASS['core_template']->assign_array(array(
 		'error'				=> false,
 		'magic_quotes_gpc'	=> ((bool) ini_get('magic_quotes_gpc') === false),
-		'output_buffering'	=> ((int) ini_get('output_buffering') > 0),
+		'output_buffering'	=> ((int) ini_get('output_buffering') === 0),
 		'register_globals'	=> ((bool) ini_get('register_globals') === false),
 		'safe_mode'			=> ((bool) ini_get('safe_mode') === false),
 

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/modules/Forums/posting.php	2005-09-28 01:06:13 UTC (rev 144)
@@ -1491,6 +1491,7 @@
 				'topic_replies_real'	=> 0,
 				'topic_replies'			=> 0,
 				'topic_views'			=> 0,
+				'topic_moved_id'		=> 0
 			);
 
 			if (isset($poll['poll_options']) && !empty($poll['poll_options']))
@@ -1544,7 +1545,7 @@
 				'poll_vote_change'			=> isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
 				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0) : (int) $data['topic_attachment']
 			);
-			break;
+		break;
 	}
 
 	$_CLASS['core_db']->transaction();

Modified: cms/trunk/themes/viperal/index.php
===================================================================
--- cms/trunk/themes/viperal/index.php	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/themes/viperal/index.php	2005-09-28 01:06:13 UTC (rev 144)
@@ -37,9 +37,10 @@
 		$this->table_close	= '</div></div></div>';
 		
 		$_CLASS['core_template']->assign_array(array(
-			'A_TABLE_OPEN'	=> $this->table_open,
-			'A_TABLE_CLOSE'	=> $this->table_close,
-			'A_STYLESHEET'	=> 'themes/viperal/style/style.css',
+			'THEME_TABLE_OPEN'	=> $this->table_open,
+			'THEME_TABLE_CLOSE'	=> $this->table_close,
+			'THEME_STYLESHEET'	=> 'themes/viperal/style/style.css',
+			'THEME_PATH'		=> 'themes/viperal',
 		));
 	}
 

Modified: cms/trunk/themes/viperal/template/header.html
===================================================================
--- cms/trunk/themes/viperal/template/header.html	2005-09-27 23:57:50 UTC (rev 143)
+++ cms/trunk/themes/viperal/template/header.html	2005-09-28 01:06:13 UTC (rev 144)
@@ -7,7 +7,7 @@
 <meta name="copyright" content="Copyright { $SITE_NAME } { $SITE_URL }" />
 <meta name="robots" content="index, follow" />
 { $HEADER_META }
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
 { $HEADER_REGULAR }
 { $HEADER_JS }
 <script type="text/javascript" src="javascript/collapse.js"></script>



From viperal at berlios.de  Wed Sep 28 21:24:29 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 21:24:29 +0200
Subject: [Viperals-svncheckins] r145 - in cms/trunk: . blocks includes includes/display includes/forums includes/forums/admin includes/templates/modules/Forums javascript modules/Forums modules/Members_List modules/articles/admin themes/viperal/template themes_admin/viperal_admin/template
Message-ID: <200509281924.j8SJOTHL030873@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 21:24:26 +0200 (Wed, 28 Sep 2005)
New Revision: 145

Added:
   cms/trunk/includes/templates/modules/Forums/menus.html
Modified:
   cms/trunk/blocks/block-User.php
   cms/trunk/config.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/admin/admin_search.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/mailer.php
   cms/trunk/includes/templates/modules/Forums/index_body.html
   cms/trunk/includes/templates/modules/Forums/overall_header.html
   cms/trunk/installer.php
   cms/trunk/javascript/menu.js
   cms/trunk/modules/Forums/download.php
   cms/trunk/modules/Forums/main.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/Members_List/index.php
   cms/trunk/modules/articles/admin/index.php
   cms/trunk/themes/viperal/template/footer.html
   cms/trunk/themes_admin/viperal_admin/template/header.html
Log:


Modified: cms/trunk/blocks/block-User.php
===================================================================
--- cms/trunk/blocks/block-User.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/blocks/block-User.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -83,15 +83,30 @@
 $online['guest'] = $online['user'] = $online['hidden'] = $online['total'] = 0;
 $prev_ip = $prev_id = array();
 
+/*
+enable this is you know what your doing
+
 $session_users = session_users();
 
 foreach ($session_users as $row)
+*/
+
+$sql = 'SELECT session_hidden, session_ip, session_page, session_url, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
+			FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
+				WHERE s.session_time > ' . ($_CLASS['core_user']->time - (int) $_CORE_CONFIG['server']['session_length']) .'
+				AND u.user_id = s.session_user_id';
+$result = $_CLASS['core_db']->query($sql);
+
+$update = false;
+
+while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	if ($row['user_id'] != ANONYMOUS && !in_array($row['user_id'], $prev_ip))
   	{
 		if (!$_CLASS['core_user']->is_admin && (!$row['user_allow_viewonline'] || $row['session_hidden']))
 		{
 			$online['hidden']++;
+
 			continue;
 		}
 		else
@@ -131,7 +146,7 @@
 	
 	if ($row['user_id'] != ANONYMOUS)
 	{
-		$link = (($row['user_type'] & USER_BOT) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
+		$link = (($row['user_type'] == USER_BOT) ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']).'">'.$row['username'].'</a>' : $row['username']).' &gt;';
 		$who_where['user'] .= $online['user'] .': '.$link.' <a href="'.$row['session_url'].'">'.$row['session_page'].'</a><br />';
 	}
 	else

Modified: cms/trunk/config.php
===================================================================
--- cms/trunk/config.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/config.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -0,0 +1,26 @@
+<?php
+
+$site_db['type'] = 'postgres';
+$site_db['persistent'] = false;
+$site_db['server'] = 'localhost';
+$site_db['port'] = '';
+$site_db['database'] = 'trunck';
+$site_db['username'] = 'postgres';
+$site_db['password'] = 'viper83';
+
+$table_prefix	= 'cms_';
+$user_prefix	= 'cms_';
+
+$acm_type		= 'file';
+
+if (!defined('INDEX_PAGE'))
+{
+	define('INDEX_PAGE', 'index.php');
+}
+
+if (!defined('ADMIN_PAGE'))
+{
+	define('ADMIN_PAGE', 'admin.php');
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/display/display.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -24,6 +24,8 @@
 class core_display
 {
 	var $header = array('js' => array(), 'regular' => array(), 'meta' => array());
+	var $footer = '';
+
 	var $displayed = array('header'=> false, 'footer'=> false);
 	var $message = '';
 
@@ -188,6 +190,7 @@
 			'HEADER_META'		=>	empty($this->header['meta']) ? '' : implode("\n", $this->header['meta']),
 			'HEADER_REGULAR'	=>	empty($this->header['regular']) ? '' : implode("\n", $this->header['regular']),
 			'HEADER_JS' 		=>	empty($this->header['js']) ? '' : implode("\n", $this->header['js']),
+			'FOOTER_CONTENT'	=> $this->footer,
 		));
 
 		$_CLASS['core_blocks']->display(BLOCK_MESSAGE_TOP);

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -118,7 +118,7 @@
 
 			if ($forum_data['forum_rules'])
 			{
-				require_once($site_file_root.'includes/forums/message_parser.php');
+				require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
 
 				$allow_bbcode = request_var('parse_bbcode', false);
 				$allow_smilies = request_var('parse_smilies', false);
@@ -234,8 +234,8 @@
 
 		if ($forum_rules)
 		{
-			require_once($site_file_root.'includes/forums/functions_posting.php');
-			require_once($site_file_root.'includes/forums/message_parser.php');
+			require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+			require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
 			
 			$message_parser = new parse_message($forum_rules);
 			if (isset($forum_rules_bbcode_uid))
@@ -884,6 +884,7 @@
 <?php
 
 }
+$_CLASS['core_db']->free_result($result);
 
 ?>
 	<tr>
@@ -1412,8 +1413,8 @@
 
 function delete_forum_content($forum_id)
 {
-	global $_CLASS, $site_file_root;
-	require_once($site_file_root.'includes/forums/functions_posting.php');
+	global $_CLASS;
+	require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
 
 	$_CLASS['core_db']->transaction();
 

Modified: cms/trunk/includes/forums/admin/admin_search.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_search.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/forums/admin/admin_search.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -1,167 +1,130 @@
-<?php
-/***************************************************************************
- *                             admin_search.php
- *                            -------------------
- *   begin                : Saturday, Feb 13, 2001
- *   copyright            : (C) 2001 The phpBB Group
- *   email                : support at phpbb.com
- *
- *   $Id: admin_search.php,v 1.7 2004/10/19 19:21:44 acydburn Exp $
- *
- ***************************************************************************/
-
-/***************************************************************************
- *
- *   This program is free software; you can redistribute it and/or modify
- *   it under the terms of the GNU General Public License as published by
- *   the Free Software Foundation; either version 2 of the License, or
- *   (at your option) any later version.
- *
- ***************************************************************************/
-
-include($site_file_root . 'includes/forums/message_parser.'.$phpEx);
-
-// Check permissions
-if (!$_CLASS['auth']->acl_get('a_search'))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-// Start indexing
-if (isset($_POST['start']) || isset($_GET['batchstart']))
-{
-	$batchsize = 5000; // Process this many posts per batch
-	$batchcount = request_var('batchcount', 1);
-	$batchstart = request_var('batchstart', 0);
-	$loopcount = 0;
-
-	$fulltext = new fulltext_search();
-
-	// Search re-indexing is tough on the server ... so we'll check the load
-	// each loop and if we're on a 1min load of 3 or more we'll re-load the page
-	// and try again. No idea how well this will work in practice so we'll see ...
-	if (file_exists('/proc/loadavg'))
-	{
-		if ($load = @file('/proc/loadavg'))
-		{
-			list($load) = explode(' ', $load[0]);
-
-			if ($load > 3)
-			{
-				redirect(adminlink('forums&amp;file=admin_search&batchstart='.$batchstart.'&batchcount='.$batchcount), 3);
-			}
-		}
-	}
-
-	if (!$batchstart)
-	{
-		// Take board offline
-		set_config('board_disable', 1);
-
-		// Empty existing tables
-		$db->sql_query("TRUNCATE " . SEARCH_TABLE);
-		$db->sql_query("TRUNCATE " . SEARCH_WORD_TABLE);
-		$db->sql_query("TRUNCATE " . SEARCH_MATCH_TABLE);
-	}
-
-	// Fetch a batch of posts_text entries
-	$sql = "SELECT COUNT(*) AS total, MAX(post_id) AS max_post_id, MIN(post_id) AS min_post_id
-		FROM " . POSTS_TABLE;
-	$result = $db->sql_query($sql);
-
-	$row = $db->sql_fetchrow($result);
-	$totalposts = $row['total'];
-	$max_post_id = $row['max_post_id'];
-
-	$batchstart = (!$batchstart) ? $row['min_post_id'] : $batchstart;
-	$batchend = $batchstart + $batchsize;
-
-	$db->sql_freeresult($result);
-
-	$sql = "SELECT *
-		FROM " . POSTS_TABLE . "
-		WHERE post_id
-			BETWEEN $batchstart
-				AND $batchend";
-	$result = $db->sql_query($sql);
-
-	if ($row = $db->sql_fetchrow($result))
-	{
-		do
-		{
-			$fulltext->add('admin', $row['post_id'], $row['post_text'], $row['post_subject']);
-		}
-		while ($row = $db->sql_fetchrow($result));
-	}
-
-	$db->sql_freeresult($result);
-
-	$batchcount++;
-
-	if (($batchstart + $batchsize) < $max_post_id)
-	{
-		redirect(adminlink('forums&amp;file=admin_search&batchstart=' . ($batchstart + $batchsize) . '&batchcount='.$batchcount), 3);
-	}
-	else
-	{
-		set_config('board_disable', 0);
-
-		// search tidy
-		$fulltext->search_tidy();
-
-		adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_COMPLETE']; ?></p>
-
-<?php
-
-		adm_page_footer();
-
-	}
-
-	exit;
-
-}
-else if (isset($_POST['cancel']))
-{
-	set_config('board_disable', 0);
-	adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_CANCEL']; ?></p>
-
-<?php
-
-	adm_page_footer();
-
-}
-else
-{
-	adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_EXPLAIN']; ?></p>
-
-<form method="post" action="<?php echo adminlink('forums&amp;file=admin_search'); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
-	<tr>
-		<td class="cat" height="28" align="center">&nbsp;<input type="submit" name="start" value="<?php echo $_CLASS['core_user']->lang['START']; ?>" class="btnmain" /> &nbsp; <input type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" class="btnmain" />&nbsp;</td>
-	</tr>
-</table></form>
-
-<?php
-
-	adm_page_footer();
-
-}
-
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+// Check permissions
+if (!$_CLASS['auth']->acl_get('a_search'))
+{
+	trigger_error('NO_ADMIN');
+}
+
+// Start indexing
+if (isset($_POST['start']) || isset($_GET['position']))
+{
+	$limit = 5000; // Process this many posts per batch
+	$start = get_variable('position', 'REQUEST', 0, 'int');
+
+	$count = 0;
+
+	if (!$start)
+	{
+		// Empty existing tables
+		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
+		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
+		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
+	}
+
+	// Fetch a batch of posts_text entries
+	$result = $_CLASS['core_db']->query('SELECT COUNT(*) AS total FROM ' . FORUMS_POSTS_TABLE);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if ($total_posts = $row['total'])
+	{
+		require_once(SITE_FILE_ROOT . 'includes/forums/message_parser.php');
+		$fulltext = new fulltext_search();
+
+		$sql = 'SELECT post_id, post_subject, post_text
+			FROM ' . FORUMS_POSTS_TABLE . '
+			ORDER BY post_id';
+		$result = $_CLASS['core_db']->query_limit($sql, $limit, $start);
+	
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$fulltext->add('admin', $row['post_id'], $row['post_text'], $row['post_subject']);
+			$count++;
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	if (($start + $count) < $total_posts)
+	{
+		redirect(generate_link('forums&amp;file=admin_search&position=' . ($start + $count), array('admin' => true)), 3);
+	}
+	else
+	{
+		// search tidy
+		$fulltext->search_tidy();
+		$_CLASS['core_db']->optimize_tables();
+
+		adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
+
+?>
+
+<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
+
+<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_COMPLETE']; ?></p>
+
+<?php
+
+		adm_page_footer();
+
+	}
+
+	die;
+}
+else if (isset($_POST['cancel']))
+{
+	adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
+
+?>
+
+<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
+
+<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_CANCEL']; ?></p>
+
+<?php
+
+	adm_page_footer();
+	die;
+
+}
+
+adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
+
+?>
+
+<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
+
+<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_EXPLAIN']; ?></p>
+
+<form method="post" action="<?php echo generate_link('forums&amp;file=admin_search', array('admin' => true)); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
+	<tr>
+		<td class="cat" height="28" align="center">&nbsp;<input type="submit" name="start" value="<?php echo $_CLASS['core_user']->lang['START']; ?>" class="btnmain" /> &nbsp; <input type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" class="btnmain" />&nbsp;</td>
+	</tr>
+</table></form>
+
+<?php
+
+adm_page_footer();
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/forums/functions.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -1125,7 +1125,7 @@
 // Check if extension is allowed to be posted within forum X (forum_id 0 == private messaging)
 function extension_allowed($forum_id, $extension, &$extensions)
 {
-	if (!is_array($extensions))
+	if (empty($extensions) || !is_array($extensions))
 	{
 		$extensions = obtain_attach_extensions();
 	}

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/forums/message_parser.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -1371,32 +1371,33 @@
 			$new_words = array_diff($unique_add_words, array_keys($word_ids));
 			unset($unique_add_words);
 			
-			if (sizeof($new_words))
+			if (!empty($new_words))
 			{
 				switch ($_CLASS['core_db']->db_layer)
 				{
-					case 'mysql':
-						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text)
-							VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\'$1\')',  $new_words));
+					case 'mysql3':
+						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text, word_common)
+							VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\'$1\', 0)',  $new_words));
 						$_CLASS['core_db']->query($sql);
-						break;
+					break;
 
-					case 'mysql4':
+					case 'mysql':
 					case 'mysqli':
 					case 'mssql':
 					case 'sqlite':
-						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text) ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', "SELECT '\$1'",  $new_words));
+					case 'sqlite_pdo':
+						$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . ' (word_text, word_common) ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', "SELECT '\$1', 0",  $new_words));
 						$_CLASS['core_db']->query($sql);
-						break;
+					break;
 
 					default:
 						foreach ($new_words as $word)
 						{
-							$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . " (word_text)
-								VALUES ('$word')";
+							$sql = 'INSERT INTO ' . FORUMS_SEARCH_WORD_TABLE . " (word_text, word_common)
+								VALUES ('$word', 0)";
 							$_CLASS['core_db']->query($sql);
 						}
-						break;
+					break;
 				}
 			}
 			unset($new_words);
@@ -1406,7 +1407,7 @@
 		{
 			$title_match = ($word_in == 'title') ? 1 : 0;
 
-			if (sizeof($word_ary))
+			if (!empty($word_ary))
 			{
 				$sql_in = array();
 				foreach ($word_ary as $word)
@@ -1427,7 +1428,7 @@
 		{
 			$title_match = ($word_in == 'title') ? 1 : 0;
 
-			if (sizeof($word_ary))
+			if (!empty($word_ary))
 			{
 				$sql = 'INSERT INTO ' . FORUMS_SEARCH_MATCH_TABLE . " (post_id, word_id, title_match) 
 					SELECT $post_id, word_id, $title_match 
@@ -1478,6 +1479,7 @@
 			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$sql_in = array();
+
 				do
 				{
 					$sql_in[] = $row['word_id'];
@@ -1502,9 +1504,9 @@
 		// Remove words with no matches ... this is a potentially nasty query
 		$sql = 'SELECT w.word_id
 			FROM ' . FORUMS_SEARCH_WORD_TABLE . ' w
-			LEFT JOIN ' . FORUMS_SEARCH_MATCH_TABLE . ' m ON w.word_id = m.word_id
+			LEFT JOIN ' . FORUMS_SEARCH_MATCH_TABLE . ' m ON (w.word_id = m.word_id)
 				WHERE w.word_common = 0 AND m.word_id IS NULL
-			GROUP BY m.word_id';
+			GROUP BY w.word_id';
 		$result = $_CLASS['core_db']->query($sql);
 
 		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -1523,7 +1525,7 @@
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		set_config('search_last_gc', time());
+		set_config('search_last_gc', gmtime());
 	}
 }
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/functions.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -713,15 +713,15 @@
 
 	$loaded = array();
 
-	$sql = 'SELECT s.*, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
+	$sql = 'SELECT session_hidden, session_ip, session_page, session_url, u.username, u.user_id, u.user_type, u.user_allow_viewonline, u.user_colour
 				FROM ' . SESSIONS_TABLE . ' s, '.USERS_TABLE.' u
-					WHERE s.session_time >= ' . (gmtime() - (int) $_CORE_CONFIG['server']['session_length']) .'
+					WHERE s.session_time >= ' . ($_CLASS['core_user']->time - (int) $_CORE_CONFIG['server']['session_length']) .'
 				AND u.user_id = s.session_user_id';
 	$result = $_CLASS['core_db']->query($sql);
 
 	$update = false;
 
-	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		// update current user info with current page and url as it is done at the end of script.
 		if (!$update && (($row['user_id'] != ANONYMOUS && $row['user_id'] == $_CLASS['core_user']->data['user_id']) || ($row['user_id'] == ANONYMOUS && $row['session_ip'] == $_CLASS['core_user']->ip)))

Modified: cms/trunk/includes/mailer.php
===================================================================
--- cms/trunk/includes/mailer.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/mailer.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -95,6 +95,7 @@
 		foreach ($address as $array)
 		{
 			$array['name'] = trim($array['name']);
+
 			$formatted[] = ($array['name'] && $this->named_addresses) ?  '"' . mail_encode($array['name'], $this->encoding) . '" <' . $array['address'] . '>' : $array['address'];
 		}
 		return implode(', ', $formatted);
@@ -116,11 +117,12 @@
 			$$type = $this->format_address($address);
 		}
 
-		$_CORE_CONFIG['email']['site_mail'] = trim($_CORE_CONFIG['email']['site_mail']);
+		$_CORE_CONFIG['email']['site_email'] = trim($_CORE_CONFIG['email']['site_email']);
 
 		if (!$from)
 		{
-			$from = '<' . $_CORE_CONFIG['email']['site_mail'] . '>';
+			// modify_lines ?
+			$from = '<' . $_CORE_CONFIG['email']['site_email'] . '>';
 		}
 
 		$headers[] = "From: $from";
@@ -209,7 +211,7 @@
 		}
 
 		if (function_exists($_CORE_CONFIG['email']['email_function_name']))
-		{//mb_send_mail
+		{
 			$result = $_CORE_CONFIG['email']['email_function_name']($to, $this->subject, $message, implode("\n", $headers));
 
 			if (!$result)
@@ -253,9 +255,6 @@
 	{
 		$port = ((int) $port) ? (int) $port : 25;
 
-		//$host = 'tls://smtp.gmail.com';
-		//$port = 465;
-
 		$this->connection = fsockopen($host, $port, $errno, $errstr, 5);
 
 		if (!$this->connection || !$this->check_response(220))
@@ -371,6 +370,7 @@
 		{
 			$name = false;
 
+			//print_r($email);
 			if (is_array($email))
 			{
 				$name = $email['name'];
@@ -433,7 +433,7 @@
 		}
 
 		$this->response = trim($this->response);
-		echo $this->response.'<br/>';
+		//echo $this->response.'<br/>';
 
 		if ($code && substr($this->response, 0, 3) != $code)
 		{

Modified: cms/trunk/includes/templates/modules/Forums/index_body.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/templates/modules/Forums/index_body.html	2005-09-28 19:24:26 UTC (rev 145)
@@ -133,6 +133,25 @@
 	</tr>
 </table>
 
+<br clear="all" />
+
+<a name="forums_options"></a>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
+	<tr>
+		<td class="cat" colspan="2"><h4>{ $L_OPTIONS }</h4></td>
+	</tr>
+	<tr>
+		<td class="row1"><img src="{ $T_IMAGE_PATH }whosonline.gif" alt="{ $L_WHO_IS_ONLINE }" /></td>
+		<td class="row1" width="100%" valign="middle">
+			<a href="{ $U_SEARCH_UNANSWERED }">{ $L_SEARCH_UNANSWERED }</a> | <a href="{ $U_SEARCH_ACTIVE_TOPICS}">{ $L_SEARCH_ACTIVE_TOPICS }</a>
+			<!-- IF { $S_USER_LOGGED_IN } -->
+				| <a href="{ $U_SEARCH_NEW }">{ $L_SEARCH_NEW }</a> | <a href="{ $U_SEARCH_SELF }">{ $L_SEARCH_SELF }</a>
+			<!-- ENDIF -->
+		</td>
+	</tr>
+</table>
+
 <!-- IF !{ $S_USER_LOGGED_IN } -->
 <br clear="all" />
 
@@ -145,7 +164,7 @@
 		<span class="gensmall">{ $L_USERNAME }:</span> <input class="post" type="text" name="username" size="10" />&nbsp;
 		 <span class="gensmall">{ $L_PASSWORD }:</span>
 		 <input class="post" type="password" name="password" size="10" />&nbsp; <span class="gensmall">{ $L_LOG_ME_IN }</span> <input class="text" type="checkbox" name="autologin" />&nbsp;
-		 <input type="submit" class="btnmain" name="login" value="{ $L_LOGIN }" /></td>
+		 <input type="submit" class="button" name="login" value="{ $L_LOGIN }" /></td>
 	</tr>
 </table></form>
 <!-- ENDIF -->

Added: cms/trunk/includes/templates/modules/Forums/menus.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/menus.html	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/templates/modules/Forums/menus.html	2005-09-28 19:24:26 UTC (rev 145)
@@ -0,0 +1,44 @@
+<div id="forums_option_menu" style="display: none;">
+	<table class="tablebg" border="0" cellpadding="4" cellspacing="1">
+		<tbody>
+			<tr>
+				<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'"  onclick="location.href='{ $U_SEARCH_UNANSWERED }'" nowrap="nowrap"><a href="{ $U_SEARCH_UNANSWERED }" title="">{ $L_SEARCH_UNANSWERED }</a></td>
+			</tr>
+			<tr>
+				<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'"  onclick="location.href='{ $U_SEARCH_ACTIVE_TOPICS}'" nowrap="nowrap"><a href="{ $U_SEARCH_ACTIVE_TOPICS}" title="">{ $L_SEARCH_ACTIVE_TOPICS }</a></td>
+			</tr>
+			<!-- IF { $S_USER_LOGGED_IN } -->
+			<tr>
+				<td class="row2" height="6" nowrap="nowrap"></td>
+			</tr>
+			<tr>
+				<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'"  onclick="location.href='{ $U_SEARCH_ACTIVE_TOPICS}'" nowrap="nowrap"><a href="{ $U_SEARCH_ACTIVE_TOPICS}" title="">{ $L_SEARCH_NEW }</a></td>
+			</tr>
+			<tr>
+				<td class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'"  onclick="location.href='{ $U_SEARCH_SELF }'" nowrap="nowrap"><a href="{ $U_SEARCH_SELF }" title="">{ $L_SEARCH_SELF }</a></td>
+			</tr>
+			<!-- ENDIF -->
+		</tbody>
+	</table>
+</div>
+
+<script type="text/javascript">menu_init_forums('forums_option');</script>
+
+<div id="forums_search_menu" style="display: none;">
+	<form action="{ $U_SEARCH }" method="post">
+		<table class="tablebg" border="0" cellpadding="4" cellspacing="1">
+			<tbody>
+				<tr>
+					<td class="row1">
+						<input type="text" class="post" name="search_keywords" size="20" /><input class="button" value="Go" type="submit"><br>
+					</td>
+				</tr>
+				<tr>
+					<td class="row2" height="6" nowrap="nowrap"></td>
+				</tr>
+			</tbody>
+		</table>
+	</form>
+</div>
+
+<script type="text/javascript">menu_init_forums('forums_search');</script>
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Forums/overall_header.html
===================================================================
--- cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/includes/templates/modules/Forums/overall_header.html	2005-09-28 19:24:26 UTC (rev 145)
@@ -1,3 +1,5 @@
+<script type="text/javascript" src="javascript/menu.js"></script>
+
 { $THEME_TABLE_OPEN }
 
 <table width="100%" cellspacing="0">
@@ -26,22 +28,24 @@
 
 <table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
 	<tr>
-			<td class="row1">
-				<b>{ $L_OPTIONS }: </b><a href="{ $U_SEARCH_UNANSWERED }">{ $L_SEARCH_UNANSWERED }</a> | <a href="{ $U_SEARCH_ACTIVE_TOPICS}">{ $L_SEARCH_ACTIVE_TOPICS }</a>
-					<!-- IF { $S_USER_LOGGED_IN } -->
-						| <a href="{ $U_SEARCH_NEW }">{ $L_SEARCH_NEW }</a> | <a href="{ $U_SEARCH_SELF }">{ $L_SEARCH_SELF }</a></span>
-					<!-- ENDIF -->
-			</td>
-		</tr>
+		<td class="row1">
+			{ $S_TIMEZONE }
+		</td>
+		<td class="row1" style="width: 100px; text-align: center;" id="forums_search" nowrap="nowrap">
+			<a href="{ $U_SEARCH }"><b>{ $L_SEARCH }</b></a>
+		</td>
+		<td class="row1" style="width: 100px; text-align: center;" id="forums_option" nowrap="nowrap">
+			<a href="#forums_options"><b>{ $L_OPTIONS }</b></a>
+		</td>
+	</tr>
 	<tr>
-		<td class="row1">
+		<td colspan="3" class="row1">
 			<p class="breadcrumbs"><a href="{ $U_INDEX }">{ $L_INDEX }</a>
 			<!-- IF isset({ $navlinks }) -->
 				<!-- LOOP $navlinks -->
 				&#187; <a href="{ $navlinks:U_VIEW_FORUM }">{ $navlinks:FORUM_NAME }</a>
 				<!-- ENDLOOP -->
 			<!-- ENDIF --></p>
-			<p class="datetime">{ $S_TIMEZONE }</p>
 		</td>
 	</tr>
 </table>

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/installer.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -22,7 +22,7 @@
 */
 define('VIPERAL', 'INSTALLER');
 
-error_reporting(0);
+error_reporting(E_ALL);
 
 define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 
@@ -176,6 +176,9 @@
 		set_core_config('server', 'site_domain', $site_domain, false);
 		set_core_config('server', 'site_path', $site_path, false);
 		set_core_config('server', 'site_port', $site_port, false);
+
+		set_core_config('email', 'site_email', $email, false);
+
 		set_core_config('server', 'cookie_domain', $cookie_domain, false);
 		set_core_config('server', 'cookie_path', $cookie_path, false);
 		set_core_config('server', 'cookie_name', $cookie_name, false);
@@ -392,7 +395,7 @@
 				$error[] = 'Failed to write to your config.php file<br/>Please upload the content listed in the "Config.php Content" Section';
 			}
 
-			$path = dirname(getenv('SCRIPT_NAME'));
+			$path = str_replace('\\','/', dirname(getenv('SCRIPT_NAME')));
 
 			if (substr($path, -1) != '/')
 			{

Modified: cms/trunk/javascript/menu.js
===================================================================
--- cms/trunk/javascript/menu.js	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/javascript/menu.js	2005-09-28 19:24:26 UTC (rev 145)
@@ -129,11 +129,56 @@
 	}
 
 	menu.style.display	= 'none';
-	menu.style.position	= is_gecko ? 'fixed' : 'absolute';
+	menu.style.position	= 'absolute';
+	/*menu.style.position	= (is_gecko) ? 'fixed' : 'absolute';*/
+
 	menu.style.zIndex = 1;
 	object.style.cursor = 'pointer';
 }
 
+function menu_init_forums(object_name)
+{
+	var menu		= document.getElementById(object_name + '_menu');
+	var object		= document.getElementById(object_name);
+
+	if (menu == null || object == null)
+	{
+		return;
+	}
+
+	object.onclick = function()
+	{
+		// Open or close the menu 
+		if (menu.style.display == 'none')
+		{
+			menu_show(object_name);
+		}
+		else
+		{
+			menu_hide(object_name);
+		}
+
+		return false;
+	}
+	
+	object.onmouseover = function(e)
+	{
+		if (e)
+		{
+			e.preventDefault();
+			e.stopPropagation();
+		}
+
+		menu_show(object_name);
+	}
+
+	menu.style.display	= 'none';
+	menu.style.position	= 'absolute';
+
+	menu.style.zIndex = 1;
+	object.style.cursor = 'pointer';
+}
+
 function menu_show(object_name)
 {
 	// If a menu is open, lets close it
@@ -163,11 +208,11 @@
 	menu.style.clip = 'rect(auto, auto, 0px, auto)';
 	menu.style.display	= '';
 
-	if (!is_gecko)
+	/*if (!is_gecko || true)
 	{
 		var window_offset = (window.pageYOffset) ? window.pageYOffset : (document.body.scrollTop) ? document.body.scrollTop : document.documentElement.scrollTop;
 		object_offsets['top']	= Number(window_offset) + object_offsets['top'];
-	}
+	}*/
 
 	if ((object_offsets['left'] + menu.offsetWidth) > document.body.clientWidth)
 	{
@@ -218,7 +263,7 @@
 	if (slider_height[identifier] >= height)
 	{
 		area.style.clip = '';
-		
+
 		stop_slide(identifier);
 	}
 	else

Modified: cms/trunk/modules/Forums/download.php
===================================================================
--- cms/trunk/modules/Forums/download.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/modules/Forums/download.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -62,17 +62,19 @@
 }
 
 $row = array();
+
 if (!$attachment['in_message'])
 {
 	$sql = 'SELECT p.forum_id, f.forum_password, f.parent_id
 		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
 		WHERE p.post_id = ' . $attachment['post_msg_id'] . '
 			AND p.forum_id = f.forum_id';
+
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	if ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']))
+	if ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $row['forum_id']))
 	{
 		if ($row['forum_password'])
 		{
@@ -82,7 +84,7 @@
 	}
 	else
 	{
-		//trigger_error('SORRY_AUTH_VIEW_ATTACH');
+		trigger_error('SORRY_AUTH_VIEW_ATTACH');
 	}
 }
 else
@@ -96,7 +98,8 @@
 }
 
 // disallowed ?
-$extensions = array();
+$extensions = obtain_attach_extensions();
+
 if (!extension_allowed($row['forum_id'], $attachment['extension'], $extensions))
 {
 	trigger_error(sprintf($_CLASS['core_user']->lang['EXTENSION_DISABLED_AFTER_POSTING'], $attachment['extension']));

Modified: cms/trunk/modules/Forums/main.php
===================================================================
--- cms/trunk/modules/Forums/main.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/modules/Forums/main.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -96,7 +96,7 @@
 	'TOTAL_POSTS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_post_s), $config['num_posts']),
 	'TOTAL_TOPICS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_topic_s), $config['num_topics']),
 	'TOTAL_USERS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_user_s), $config['num_users']),
-	'NEWEST_USER'	=> sprintf($_CLASS['core_user']->get_lang('NEWEST_USER'), '<a href="'. generate_link('Members_List&amp;mode=viewprofile&amp;u='.$config['newest_user_id']) . '">', $config['newest_username'], '</a>'), 
+	'NEWEST_USER'	=> sprintf($_CLASS['core_user']->get_lang('NEWEST_USER'), '<a href="'. generate_link('Members_List&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">', $_CORE_CONFIG['user']['newest_username'], '</a>'), 
 	'LEGEND'		=> $legend, 
 	'BIRTHDAY_LIST'	=> $birthday_list, 
 
@@ -112,6 +112,8 @@
 
 page_header();
 
-$_CLASS['core_template']->display('modules/Forums/index_body.html');
+$_CLASS['core_display']->footer .= $_CLASS['core_template']->display('modules/Forums/menus.html', true);
 
+$_CLASS['core_display']->display(false, 'modules/Forums/index_body.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -555,10 +555,13 @@
 	markread('forum', $forum_id, false, $mark_forum_read);
 }
 
+
 page_header();
 
 make_jumpbox(generate_link('Forums&amp;file=viewforum'), $forum_id);
 
-$_CLASS['core_template']->display('modules/Forums/viewforum_body.html');
+$_CLASS['core_display']->footer .= $_CLASS['core_template']->display('modules/Forums/menus.html', true);
 
+$_CLASS['core_display']->display(false, 'modules/Forums/viewforum_body.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/Members_List/index.php
===================================================================
--- cms/trunk/modules/Members_List/index.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/modules/Members_List/index.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -619,8 +619,6 @@
 				$result = $_CLASS['core_db']->query($sql);
 				*/
 
-				// Add class loader
-
 				require_once(SITE_FILE_ROOT.'includes/mailer.php');
 			
 				$mailer = new core_mailer;
@@ -659,16 +657,14 @@
 				$_CLASS['core_template']->assign_array(array(
 					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 					'BOARD_EMAIL'	=> $config['board_contact'],
-					'FROM_USERNAME' => stripslashes($_CLASS['core_user']->data['username']),
+					'FROM_USERNAME' => $_CLASS['core_user']->data['username'],
 					'TO_USERNAME'   => ($topic_id) ? $name : $row['username'],
 					'MESSAGE'		=> $message,
 					'TOPIC_NAME'	=> ($topic_id) ? strtr($row['topic_title'], array_flip(get_html_translation_table(HTML_ENTITIES))) : '',
-
-					'U_TOPIC'	=> ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . "&t=$topic_id", true, true, false) : '')
+					'U_TOPIC'		=> ($topic_id) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id'] . "&t=$topic_id", array('full' => true, 'sid' => false)) : '')
 				);
 
 				$mailer->message = trim($_CLASS['core_template']->display('email/members_list/'.$template, true));
-				echo $mailer->message; die;
 				$mailer->send();
 
 				$_CLASS['core_display']->meta_refresh(3, generate_link());
@@ -688,21 +684,20 @@
 				'S_LANG_OPTIONS'=> ($topic_id) ? language_select($email_lang) : '')
 			);
 		}
+
 		$_CLASS['core_template']->assign_array(array(
-			'USERNAME'		=> (!$topic_id) ? addslashes($row['username']) : '',
-			'ERROR_MESSAGE'	=> (sizeof($error)) ? implode('<br />', $error) : '',
+			'USERNAME'		=> (!$topic_id) ? $row['username'] : '',
+			'ERROR_MESSAGE'	=> empty($error) ? '' : implode('<br />', $error),
 
 			'L_EMAIL_BODY_EXPLAIN'	=> $_CLASS['core_user']->get_lang((!$topic_id) ? 'EMAIL_BODY_EXPLAIN' : 'EMAIL_TOPIC_EXPLAIN'),
 
 			'S_POST_ACTION' => (!$topic_id) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id, array('full' => true)) : generate_link("Members_List&amp;mode=email&amp;f={$row['forum_id']}&amp;t=$topic_id", array('full' => true)),
-			'S_SEND_USER'	=> (!$topic_id) ? true : false,
-			));
-		break;
+			'S_SEND_USER'	=> (!$topic_id),
+		));
+	break;
 
 	case 'group':
-	
 		$_CLASS['core_user']->add_lang('groups', 'Forums');
-		
 	default:
 		// The basic memberlist
 		$page_title = $_CLASS['core_user']->lang['MEMBERLIST'];

Modified: cms/trunk/modules/articles/admin/index.php
===================================================================
--- cms/trunk/modules/articles/admin/index.php	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/modules/articles/admin/index.php	2005-09-28 19:24:26 UTC (rev 145)
@@ -63,7 +63,7 @@
 				if (display_confirmation())
 				{
 					$_CLASS['core_db']->query('DELETE from ' . ARTICLES_TABLE . ' where articles_id = '.$id);
-					$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_order > ' . $article['articles_order']);
+					$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_order > ' . $article['articles_order']);
 				}
 			break;
 
@@ -130,8 +130,8 @@
 			
 						if ($articles['articles_order'] < $max_order)
 						{
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type = '.$articles['articles_type'].' AND articles_order='.($articles['articles_order'] + 1));
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.($articles['articles_order'] + 1).' WHERE articles_id ='. $id);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type = '.$articles['articles_type'].' AND articles_order='.($articles['articles_order'] + 1));
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.($articles['articles_order'] + 1).' WHERE articles_id ='. $id);
 			
 							$_CLASS['core_cache']->destroy('articless');
 						}
@@ -144,8 +144,8 @@
 			
 						if ($articles['articles_order'] < $max_order)
 						{
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type='.$articles['articles_type'].' AND articles_order > '.$articles['articles_order']);
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.$max_order.' WHERE articles_id = '.$id);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order-1 WHERE articles_type='.$articles['articles_type'].' AND articles_order > '.$articles['articles_order']);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = '.$max_order.' WHERE articles_id = '.$id);
 			
 							$_CLASS['core_cache']->destroy('articless');
 						}
@@ -154,8 +154,8 @@
 					case 'up':
 						if ($articles['articles_order'] && $articles['articles_order'] != 1)
 						{
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order = '.($articles['articles_order'] - 1));
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order='.($articles['articles_order'] -1 ).' WHERE articles_id ='. $id);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order = '.($articles['articles_order'] - 1));
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order='.($articles['articles_order'] - 1 ).' WHERE articles_id ='. $id);
 			
 							$_CLASS['core_cache']->destroy('articless');
 						}
@@ -165,8 +165,8 @@
 
 						if ($articles['articles_order'] != 1)
 						{
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order < '.$articles['articles_order']);
-							$result = $_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = 1 WHERE articles_id = '.$id);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$articles['articles_type'].' AND articles_order < '.$articles['articles_order']);
+							$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = 1 WHERE articles_id = '.$id);
 			
 							$_CLASS['core_cache']->destroy('articless');
 						}
@@ -374,11 +374,7 @@
 			return articles_edit(false, $data, $error);
 		}
 
-		$result = $_CLASS['core_db']->query('SELECT MAX(articles_order) as articles_order FROM ' . ARTICLES_TABLE);
-		list($max_order) = $_CLASS['core_db']->fetch_row_num($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$data['articles_order'] = (int) $max_order + 1;
+		$data['articles_order'] = (int) 0;
 		$data['articles_posted'] = (int) $_CLASS['core_user']->time;
 		$data['articles_type'] = 1;
 
@@ -386,11 +382,16 @@
 		$data['poster_ip'] = $_CLASS['core_user']->ip;
 		$data['poster_name'] = $_CLASS['core_user']->data['username'];
 
+		$_CLASS['core_db']->transaction();
+
 		$_CLASS['core_db']->query('INSERT INTO ' . ARTICLES_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data));
+		$_CLASS['core_db']->query('UPDATE ' . ARTICLES_TABLE . ' SET articles_order = articles_order+1 WHERE articles_type='.$data['articles_type']);
+
+		$_CLASS['core_db']->transaction('commit');
 	}
 
 	$_CLASS['core_display']->meta_refresh('3', generate_link('articles', array('admin' => true)));
-	trigger_error(sprintf($_CLASS['core_user']->lang['SAVED'], generate_link('articles', array('admin' => true))));	
+	trigger_error(sprintf($_CLASS['core_user']->get_lang('SAVED'), generate_link('articles', array('admin' => true))));	
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/themes/viperal/template/footer.html
===================================================================
--- cms/trunk/themes/viperal/template/footer.html	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/themes/viperal/template/footer.html	2005-09-28 19:24:26 UTC (rev 145)
@@ -30,7 +30,7 @@
 	</div>
 	
 	<!-- INCLUDE blockright.html -->
-
+	{ $FOOTER_CONTENT }
 	<div class="footer">
 		<br />
 		<div align="center" class="footmsg">{ $THEME_FOOTER }</div>

Modified: cms/trunk/themes_admin/viperal_admin/template/header.html
===================================================================
--- cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-28 01:06:13 UTC (rev 144)
+++ cms/trunk/themes_admin/viperal_admin/template/header.html	2005-09-28 19:24:26 UTC (rev 145)
@@ -29,8 +29,7 @@
 
 <a name="Top"></a>
 
-<div style="position:fixed; top: -1px;left: -1px;z-index: 1;">
-
+<!-- IF isset({ $MENU_MAIN_ITEMS }) -->
 <table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
 	<tr>
 		<td nowrap="nowrap" class="row2"><a href="{ $LINK_HOME }">{ $L_SITE_INDEX }</a></td>
@@ -39,14 +38,7 @@
 		<td width="100%" class="row2"></td>
 	</tr>
 </table>
-
-</div>
-
-<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
-	<tr>
-		<td height="20" class="row2"></td>
-	</tr>
-</table>
+<!-- ENDIF -->
 { $MENU_MAIN }
 
 <!-- include blockleft.html -->



From viperal at berlios.de  Wed Sep 28 21:27:26 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 21:27:26 +0200
Subject: [Viperals-svncheckins] r146 - cms/branches
Message-ID: <200509281927.j8SJRQ5f031280@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 21:27:25 +0200 (Wed, 28 Sep 2005)
New Revision: 146

Added:
   cms/branches/1.0alpha2/
Log:
Branch off 1.0alpha2

Copied: cms/branches/1.0alpha2 (from rev 145, cms/trunk)



From viperal at berlios.de  Wed Sep 28 21:44:51 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 21:44:51 +0200
Subject: [Viperals-svncheckins] r147 - in cms/trunk: . includes/forums
Message-ID: <200509281944.j8SJipKS032529@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 21:44:51 +0200 (Wed, 28 Sep 2005)
New Revision: 147

Removed:
   cms/trunk/includes/forums/functions_messenger.php
Modified:
   cms/trunk/config.php
Log:


Modified: cms/trunk/config.php
===================================================================
--- cms/trunk/config.php	2005-09-28 19:27:25 UTC (rev 146)
+++ cms/trunk/config.php	2005-09-28 19:44:51 UTC (rev 147)
@@ -1,26 +0,0 @@
-<?php
-
-$site_db['type'] = 'postgres';
-$site_db['persistent'] = false;
-$site_db['server'] = 'localhost';
-$site_db['port'] = '';
-$site_db['database'] = 'trunck';
-$site_db['username'] = 'postgres';
-$site_db['password'] = 'viper83';
-
-$table_prefix	= 'cms_';
-$user_prefix	= 'cms_';
-
-$acm_type		= 'file';
-
-if (!defined('INDEX_PAGE'))
-{
-	define('INDEX_PAGE', 'index.php');
-}
-
-if (!defined('ADMIN_PAGE'))
-{
-	define('ADMIN_PAGE', 'admin.php');
-}
-
-?>
\ No newline at end of file

Deleted: cms/trunk/includes/forums/functions_messenger.php
===================================================================
--- cms/trunk/includes/forums/functions_messenger.php	2005-09-28 19:27:25 UTC (rev 146)
+++ cms/trunk/includes/forums/functions_messenger.php	2005-09-28 19:44:51 UTC (rev 147)
@@ -1,1227 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_messenger.php,v 1.20 2004/09/05 09:54:47 acydburn Exp $
-//
-// FILENAME  : functions_messenger.php 
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-//jab_package_size  missing in $config
-
-class messenger
-{
-	var $vars, $msg, $extra_headers, $replyto, $from, $subject, $necoding;
-	var $addresses = array();
-
-	var $mail_priority = MAIL_NORMAL_PRIORITY;
-	var $use_queue = true;
-	var $tpl_msg = array();
-
-	function messenger($use_queue = true)
-	{
-		global $config;
-
-		if (preg_match('#^[c-z]:\\\#i', getenv('PATH')) && !$config['smtp_delivery'] && phpversion() < '4.3')
-		{
-			// We are running on windows, force delivery to use our smtp functions since php's are broken by default
-			$config['smtp_delivery'] = 1;
-			$config['smtp_host'] = @ini_get('SMTP');
-		}
-
-		$this->use_queue = $use_queue;
-		$this->subject = '';
-	}
-
-	// Resets all the data (address, template file, etc etc) to default
-	function reset()
-	{
-		$this->addresses = array();
-		$this->vars = $this->msg = $this->extra_headers = $this->replyto = $this->from = $this->encoding = '';
-		$this->mail_priority = MAIL_NORMAL_PRIORITY;
-	}
-
-	// Sets an email address to send to
-	function to($address, $realname = '')
-	{
-		$pos = isset($this->addresses['to']) ? sizeof($this->addresses['to']) : 0;
-		$this->addresses['to'][$pos]['email'] = trim($address);
-		$this->addresses['to'][$pos]['name'] = trim($realname);
-	}
-
-	function cc($address, $realname = '')
-	{
-		$pos = isset($this->addresses['cc']) ? sizeof($this->addresses['cc']) : 0;
-		$this->addresses['cc'][$pos]['email'] = trim($address);
-		$this->addresses['cc'][$pos]['name'] = trim($realname);
-	}
-
-	function bcc($address, $realname = '')
-	{
-		$pos = isset($this->addresses['bcc']) ? sizeof($this->addresses['bcc']) : 0;
-		$this->addresses['bcc'][$pos]['email'] = trim($address);
-		$this->addresses['bcc'][$pos]['name'] = trim($realname);
-	}
-
-	function im($address, $realname = '')
-	{
-		$pos = isset($this->addresses['im']) ? sizeof($this->addresses['im']) : 0;
-		$this->addresses['im'][$pos]['uid'] = trim($address);
-		$this->addresses['im'][$pos]['name'] = trim($realname);
-	}
-
-	function replyto($address)
-	{
-		$this->replyto = trim($address);
-	}
-
-	function from($address)
-	{
-		$this->from = trim($address);
-	}
-
-	// set up subject for mail
-	function subject($subject = '')
-	{
-		$this->subject = trim($subject);
-	}
-
-	// set up extra mail headers
-	function headers($headers)
-	{
-		$this->extra_headers .= trim($headers) . "\n";
-	}
-
-	function set_mail_priority($priority = MAIL_NORMAL_PRIORITY)
-	{
-		$this->mail_priority = $priority;
-	}
-
-	function template($template_file, $template_lang = '')
-	{
-		global $config, $site_file_root;
-		// temp //
-		$template_lang = 'en';
-		// temp //
-		if (!trim($template_file))
-		{
-			trigger_error('No template file set', E_USER_ERROR);
-		}
-
-		if (!trim($template_lang))
-		{
-			$template_lang = $config['default_lang'];
-		}
-
-		if (empty($this->tpl_msg[$template_lang . $template_file]))
-		{
-			$tpl_file = $site_file_root."modules/Forums/language/$template_lang/email/$template_file.txt";
-			if (!file_exists($tpl_file))
-			{
-				$tpl_file = $site_file_root."modules/Forums/language/en/email/$template_file.txt";
-
-				if (!file_exists($tpl_file))
-				{
-					trigger_error("Could not find email template file [ $template_file ]", E_USER_ERROR);
-				}
-			}
-
-			if (!($fd = @fopen($tpl_file, 'r')))
-			{
-				trigger_error("Failed opening email template file [ $template_file ]", E_USER_ERROR);
-			}
-
-			$this->tpl_msg[$template_lang . $template_file] = fread($fd, filesize($tpl_file));
-			fclose($fd);
-		}
-
-		$this->msg = $this->tpl_msg[$template_lang . $template_file];
-
-		return true;
-	}
-
-	// assign variables
-	function assign_vars($vars)
-	{
-		$this->vars = (empty($this->vars)) ? $vars : $this->vars . $vars;
-	}
-
-	// Send the mail out to the recipients set previously in var $this->address
-	function send($method = NOTIFY_EMAIL, $break = false)
-	{
-		global $config, $_CLASS;
-
-		// Escape all quotes, else the eval will fail.
-		$this->msg = str_replace ("'", "\'", $this->msg);
-		$this->msg = preg_replace('#\{([a-z0-9\-_]*?)\}#is', "' . $\\1 . '", $this->msg);
-
-		// Set vars
-		foreach ($this->vars as $key => $val)
-		{
-			$$key = $val;
-		}
-
-		eval("\$this->msg = '$this->msg';");
-
-		// Clear vars
-		foreach ($this->vars as $key => $val)
-		{
-			unset($$key);
-		}
-
-		// We now try and pull a subject from the email body ... if it exists,
-		// do this here because the subject may contain a variable
-		$drop_header = '';
-		$match = array();
-		if (preg_match('#^(Subject:(.*?))$#m', $this->msg, $match))
-		{
-			$this->subject = (trim($match[2]) != '') ? trim($match[2]) : (($this->subject != '') ? $this->subject : $_CLASS['core_user']->lang['NO_SUBJECT']);
-			$drop_header .= '[\r\n]*?' . preg_quote($match[1], '#');
-		}
-		else
-		{
-			$this->subject = (($this->subject != '') ? $this->subject : $_CLASS['core_user']->lang['NO_SUBJECT']);
-		}
-
-		if (preg_match('#^(Charset:(.*?))$#m', $this->msg, $match))
-		{
-			$this->encoding = (trim($match[2]) != '') ? trim($match[2]) : trim($_CLASS['core_user']->lang['ENCODING']);
-			$drop_header .= '[\r\n]*?' . preg_quote($match[1], '#');
-		}
-		else
-		{
-			$this->encoding = trim($_CLASS['core_user']->lang['ENCODING']);
-		}
-
-		if ($drop_header)
-		{
-			$this->msg = trim(preg_replace('#' . $drop_header . '#s', '', $this->msg));
-		}
-
-		if ($break)
-		{
-			return;
-		}
-
-		switch ($method)
-		{
-			case NOTIFY_EMAIL:
-				$result = $this->msg_email();
-				break;
-			case NOTIFY_IM:
-				$result = $this->msg_jabber();
-				break;
-			case NOTIFY_BOTH:
-				$result = $this->msg_email();
-				$this->msg_jabber();
-				break;
-		}
-
-		$this->reset();
-		return $result;
-	}
-
-	function error($type, $msg)
-	{
-		global $_CLASS, $site_file_root;
-
-		require_once($site_file_root.'includes/forums/functions_admin.php');
-		add_log('critical', 'LOG_' . $type . '_ERROR', $msg);
-	}
-
-	//
-	// Messenger methods
-	//
-	function save_queue()
-	{
-		global $config;
-
-		if ($config['email_package_size'] && $this->use_queue)
-		{
-			$this->queue->save();
-		}
-	}
-	
-	function msg_email()
-	{
-		global $config, $_CLASS;
-
-		if (empty($config['email_enable']))
-		{
-			return false;
-		}
-
-		$use_queue = false;
-		if ($config['email_package_size'] && $this->use_queue)
-		{
-			if (empty($this->queue))
-			{
-				$this->queue = new queue();
-				$this->queue->init('email', $config['email_package_size']);
-			}
-			$use_queue = true;
-		}
-
-		$to = $cc = $bcc = '';
-		// Build to, cc and bcc strings
-		foreach ($this->addresses as $type => $address_ary)
-		{
-			if ($type == 'im')
-			{
-				continue;
-			}
-			
-			foreach ($address_ary as $which_ary)
-			{
-				$$type .= (($$type != '') ? ', ' : '') . (($which_ary['name'] != '') ?  '"' . mail_encode($which_ary['name'], $this->encoding) . '" <' . $which_ary['email'] . '>' : $which_ary['email']);
-			}
-		}
-
-		if (empty($this->replyto))
-		{
-			$this->replyto = '<' . $config['board_email'] . '>';
-		}
-
-		if (empty($this->from))
-		{
-			$this->from = '<' . $config['board_email'] . '>';
-		}
-
-		// Build header
-		$headers = 'From: ' . $this->from . "\n";
-		$headers .= ($cc != '') ? "Cc: $cc\n" : '';
-		$headers .= ($bcc != '') ? "Bcc: $bcc\n" : ''; 
-		$headers .= 'Reply-to: ' . $this->replyto . "\n";
-		$headers .= 'Return-Path: <' . $config['board_email'] . ">\n";
-		$headers .= 'Sender: <' . $config['board_email'] . ">\n";
-		$headers .= "MIME-Version: 1.0\n";
-		$headers .= 'Message-ID: <' . md5(uniqid(time())) . "@" . $config['server_name'] . ">\n";
-		$headers .= 'Date: ' . gmdate('D, d M Y H:i:s T', time()) . "\n";
-		$headers .= "Content-type: text/plain; charset={$this->encoding}\n";
-		$headers .= "Content-transfer-encoding: 8bit\n";
-		$headers .= "X-Priority: {$this->mail_priority}\n";
-		$headers .= 'X-MSMail-Priority: ' . (($this->mail_priority == MAIL_LOW_PRIORITY) ? 'Low' : (($this->mail_priority == MAIL_NORMAL_PRIORITY) ? 'Normal' : 'High')) . "\n";
-		$headers .= "X-Mailer: PhpBB\n";
-		$headers .= "X-MimeOLE: phpBB\n";
-		$headers .= "X-phpBB-Origin: phpbb://" . str_replace(array('http://', 'https://'), array('', ''), generate_board_url()) . "\n";
-		$headers .= ($this->extra_headers != '') ? $this->extra_headers : '';
-
-		// Send message ... removed $this->encode() from subject for time being
-		if (!$use_queue)
-		{
-			$mail_to = ($to == '') ? 'Undisclosed-Recipient:;' : $to;
-			$err_msg = '';
-
-			$result = ($config['smtp_delivery']) ? smtpmail($this->addresses, $this->subject, wordwrap($this->msg), $err_msg, $this->encoding, $headers) : @$config['email_function_name']($mail_to, $this->subject, implode("\n", preg_split("/\r?\n/", wordwrap($this->msg))), $headers);
-
-			if (!$result)
-			{
-				$message = '<u>EMAIL ERROR</u> [ ' . (($config['smtp_delivery']) ? 'SMTP' : 'PHP') . ' ]<br /><br />' . $err_msg . '<br /><br /><u>CALLING PAGE</u><br /><br />'  . ((!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : $_ENV['PHP_SELF']) . '<br />';
-				
-				$this->error('EMAIL', $message);
-				return false;
-			}
-		}
-		else
-		{
-			$this->queue->put('email', array(
-				'to'			=> $to,
-				'addresses'		=> $this->addresses,
-				'subject'		=> $this->subject,
-				'msg'			=> $this->msg,
-				'encoding'		=> $this->encoding,
-				'headers'		=> $headers)
-			);
-		}
-
-		return true;
-	}
-
-	function msg_jabber()
-	{
-		global $config, $site_file_root, $_CLASS;
-
-		if (empty($config['jab_enable']) || empty($config['jab_host']) || empty($config['jab_username']) || empty($config['jab_password']))
-		{
-			return false;
-		}
-
-		$use_queue = false;
-		if ($config['jab_package_size'] && $this->use_queue)
-		{
-			if (empty($this->queue))
-			{
-				$this->queue = new queue();
-				$this->queue->init('jabber', $config['jab_package_size']);
-			}
-			$use_queue = true;
-		}
-
-		$addresses = array();
-		foreach ($this->addresses['im'] as $type => $uid_ary)
-		{
-			$addresses[] = $uid_ary['uid'];
-		}
-		$addresses = array_unique($addresses);
-
-		if (!$use_queue)
-		{
-			require_once($site_file_root.'includes/forums/functions_jabber.php');
-			$this->jabber = new jabber;
-
-			$this->jabber->server	= $config['jab_host'];
-			$this->jabber->port		= ($config['jab_port']) ? $config['jab_port'] : 5222;
-			$this->jabber->username = $config['jab_username'];
-			$this->jabber->password = $config['jab_password'];
-			$this->jabber->resource = ($config['jab_resource']) ? $config['jab_resource'] : '';
-
-			if (!$this->jabber->connect())
-			{
-				$this->error('JABBER', 'Could not connect to Jabber server');
-				return false;
-			}
-
-			if (!$this->jabber->send_auth())
-			{
-				$this->error('JABBER', 'Could not authorise on Jabber server');
-				return false;
-			}
-			$this->jabber->send_presence(NULL, NULL, 'online');
-
-			foreach ($addresses as $address)
-			{
-				$this->jabber->send_message($address, 'normal', NULL, array('body' => $this->msg));
-			}
-
-			sleep(1);
-			$this->jabber->disconnect();
-		}
-		else
-		{
-			$this->queue->put('jabber', array(
-				'addresses'		=> $addresses,
-				'subject'		=> htmlentities($this->subject),
-				'msg'			=> htmlentities($this->msg))
-			);
-		}
-		unset($addresses);
-		return true;
-	}
-}
-
-// At the moment it is only handling the email queue
-class queue
-{
-	var $data = array();
-	var $queue_data = array();
-	var $package_size = 0;
-	var $cache_file = '';
-
-	function queue()
-	{
-		global $site_file_root;
-
-		$this->data = array();
-		$this->cache_file = $site_file_root . 'cache/queue.php';
-	}
-	
-	function init($object, $package_size)
-	{
-		$this->data[$object] = array();
-		$this->data[$object]['package_size'] = $package_size;
-		$this->data[$object]['data'] = array();
-	}
-
-	function put($object, $scope)
-	{
-		$this->data[$object]['data'][] = $scope;
-	}
-
-	// Using lock file...
-	function process()
-	{
-		global $site_file_root, $config;
-
-		set_config('last_queue_run', time(), true);
-
-		// Delete stale lock file
-		if (file_exists($this->cache_file . '.lock') && !file_exists($this->cache_file))
-		{
-			@unlink($this->cache_file . '.lock');
-			return;
-		}
-
-		if (!file_exists($this->cache_file) || (file_exists($this->cache_file . '.lock') && filemtime($this->cache_file) > time() - $config['queue_interval']))
-		{
-			return;
-		}
-
-		$fp = @fopen($this->cache_file . '.lock', 'wb');
-		fclose($fp);
-
-		include($this->cache_file);
-
-		foreach ($this->queue_data as $object => $data_ary)
-		{
-			@set_time_limit(60);
-
-			$package_size = $data_ary['package_size'];
-			$num_items = (sizeof($data_ary['data']) < $package_size) ? sizeof($data_ary['data']) : $package_size;
-
-			switch ($object)
-			{
-				case 'email':
-					// Delete the email queued objects if mailing is disabled
-					if (!$config['email_enable'])
-					{
-						unset($this->queue_data['email']);
-						continue 2;
-					}
-					break;
-
-				case 'jabber':
-					if (!$config['jab_enable'])
-					{
-						unset($this->queue_data['jabber']);
-						continue 2;
-					}
-
-					require_once($site_file_root.'includes/forums/functions_jabber.php');
-					$this->jabber = new jabber;
-
-					$this->jabber->server	= $config['jab_host'];
-					$this->jabber->port		= ($config['jab_port']) ? $config['jab_port'] : 5222;
-					$this->jabber->username = $config['jab_username'];
-					$this->jabber->password = $config['jab_password'];
-					$this->jabber->resource = ($config['jab_resource']) ? $config['jab_resource'] : '';
-
-					if (!$this->jabber->connect())
-					{
-						messenger::error('JABBER', 'Could not connect to Jabber server');
-						continue 2;
-					}
-
-					if (!$this->jabber->send_auth())
-					{
-						messenger::error('JABBER', 'Could not authorise on Jabber server');
-						continue 2;
-					}
-					$this->jabber->send_presence(NULL, NULL, 'online');
-					break;
-
-				default:
-					return;
-			}
-
-			for ($i = 0; $i < $num_items; $i++)
-			{
-				extract(array_shift($this->queue_data[$object]['data']));
-
-				switch ($object)
-				{
-					case 'email':
-						$err_msg = '';
-						$to = (!$to) ? 'Undisclosed-Recipient:;' : $to;
-
-						$result = ($config['smtp_delivery']) ? smtpmail($addresses, $subject, wordwrap($msg), $err_msg, $encoding, $headers) : @$config['email_function_name']($to, $subject, implode("\n", preg_split("/\r?\n/", wordwrap($msg))), $headers);
-
-						if (!$result)
-						{
-							@unlink($this->cache_file . '.lock');
-
-							$message = 'Method: [ ' . (($config['smtp_delivery']) ? 'SMTP' : 'PHP') . ' ]<br /><br />' . $err_msg . '<br /><br /><u>CALLING PAGE</u><br /><br />'  . ((!empty($_SERVER['PHP_SELF'])) ? $_SERVER['PHP_SELF'] : $_ENV['PHP_SELF']);
-							messenger::error('MAIL', $message);
-							continue 3;
-						}
-						break;
-
-					case 'jabber':
-						foreach ($addresses as $address)
-						{
-							$this->jabber->send_message($address, 'normal', NULL, array('body' => $msg));
-						}
-						break;
-				}
-			}
-
-			// No more data for this object? Unset it
-			if (!sizeof($this->queue_data[$object]['data']))
-			{
-				unset($this->queue_data[$object]);
-			}
-
-			// Post-object processing
-			switch ($object)
-			{
-				case 'jabber':
-					// Hang about a couple of secs to ensure the messages are
-					// handled, then disconnect
-					sleep(1);
-					$this->jabber->disconnect();
-					break;
-			}
-		}
-	
-		if (!sizeof($this->queue_data))
-		{
-			@unlink($this->cache_file);
-		}
-		else
-		{
-			$file = '<?php $this->queue_data=' . $this->format_array($this->queue_data) . '; ?>';
-
-			if ($fp = @fopen($this->cache_file, 'w'))
-			{
-				@flock($fp, LOCK_EX);
-				fwrite($fp, $file);
-				@flock($fp, LOCK_UN);
-				fclose($fp);
-			}
-		}
-
-		@unlink($this->cache_file . '.lock');
-	}
-
-	function save()
-	{
-		if (!sizeof($this->data))
-		{
-			return;
-		}
-		
-		if (file_exists($this->cache_file))
-		{
-			include($this->cache_file);
-			
-			foreach ($this->queue_data as $object => $data_ary)
-			{
-				if (isset($this->data[$object]) && sizeof($this->data[$object]))
-				{
-					$this->data[$object]['data'] = array_merge($data_ary['data'], $this->data[$object]['data']);
-				}
-				else
-				{
-					$this->data[$object]['data'] = $data_ary['data'];
-				}
-			}
-		}
-		
-		$file = '<?php $this->queue_data = ' . $this->format_array($this->data) . '; ?>';
-
-		if ($fp = fopen($this->cache_file, 'w'))
-		{
-			@flock($fp, LOCK_EX);
-			fwrite($fp, $file);
-			@flock($fp, LOCK_UN);
-			fclose($fp);
-		}
-	}
-
-	function format_array($array)
-	{
-		$lines = array();
-		foreach ($array as $k => $v)
-		{
-			if (is_array($v))
-			{
-				$lines[] = "'$k'=>" . $this->format_array($v);
-			}
-			elseif (is_int($v))
-			{
-				$lines[] = "'$k'=>$v";
-			}
-			elseif (is_bool($v))
-			{
-				$lines[] = "'$k'=>" . (($v) ? 'TRUE' : 'FALSE');
-			}
-			else
-			{
-				$lines[] = "'$k'=>'" . str_replace("'", "\'", str_replace('\\', '\\\\', $v)) . "'";
-			}
-		}
-
-		return 'array(' . implode(',', $lines) . ')';
-	}
-
-}
-
-// Replacement or substitute for PHP's mail command
-function smtpmail($addresses, $subject, $message, &$err_msg, $encoding, $headers = '')
-{
-	global $config, $_CLASS;
-
-	// Fix any bare linefeeds in the message to make it RFC821 Compliant.
-	$message = preg_replace("#(?<!\r)\n#si", "\r\n", $message);
-
-	if ($headers != '')
-	{
-		if (is_array($headers))
-		{
-			$headers = (sizeof($headers) > 1) ? join("\n", $headers) : $headers[0];
-		}
-		$headers = chop($headers);
-
-		// Make sure there are no bare linefeeds in the headers
-		$headers = preg_replace('#(?<!\r)\n#si', "\r\n", $headers);
-
-		// Ok this is rather confusing all things considered,
-		// but we have to grab bcc and cc headers and treat them differently
-		// Something we really didn't take into consideration originally
-		$header_array = explode("\r\n", $headers);
-		$headers = '';
-		
-		foreach ($header_array as $header)
-		{
-			if (preg_match('#^cc:#si', $header) || preg_match('#^bcc:#si', $header))
-			{
-				$header = '';
-			}
-			$headers .= ($header != '') ? $header . "\r\n" : '';
-		}
-
-		$headers = chop($headers);
-	}
-
-	if (trim($subject) == '')
-	{
-		$err_msg = 'No email Subject specified';
-		return false;
-	}
-
-	if (trim($message) == '')
-	{
-		$err_msg = 'Email message was blank';
-		return false;
-	}
-
-	$mail_rcpt = $mail_to = $mail_cc = array();
-
-	// Build correct addresses for RCPT TO command and the client side display (TO, CC)
-	foreach ($addresses['to'] as $which_ary)
-	{
-		$mail_to[] = ($which_ary['name'] != '') ? mail_encode(trim($which_ary['name']), $encoding) . ' <' . trim($which_ary['email']) . '>' : '<' . trim($which_ary['email']) . '>';
-		$mail_rcpt['to'][] = '<' . trim($which_ary['email']) . '>';
-	}
-
-	if (isset($addresses['bcc']) && sizeof($addresses['bcc']))
-	{
-		foreach ($addresses['bcc'] as $which_ary)
-		{
-			$mail_rcpt['bcc'][] = '<' . trim($which_ary['email']) . '>';
-		}
-	}
-
-	if (isset($addresses['cc']) && sizeof($addresses['cc']))
-	{
-		foreach ($addresses['cc'] as $which_ary)
-		{
-			$mail_cc[] = ($which_ary['name'] != '') ? mail_encode(trim($which_ary['name']), $encoding) . ' <' . trim($which_ary['email']) . '>' : '<' . trim($which_ary['email']) . '>';
-			$mail_rcpt['cc'][] = '<' . trim($which_ary['email']) . '>';
-		}
-	}
-
-	$smtp = new smtp_class;
-
-	// Ok we have error checked as much as we can to this point let's get on
-	// it already.
-	if (!$smtp->socket = fsockopen($config['smtp_host'], $config['smtp_port'], $errno, $errstr, 20))
-	{
-		$err_msg = "Could not connect to smtp host : $errno : $errstr";
-		return false;
-	}
-
-	// Wait for reply
-	if ($err_msg = $smtp->server_parse('220', __LINE__))
-	{
-		$smtp->close_session();
-		return false;
-	}
-
-	// Let me in. This function handles the complete authentication process
-	if ($err_msg = $smtp->log_into_server($config['smtp_host'], $config['smtp_username'], $config['smtp_password'], $config['smtp_auth_method']))
-	{
-		$smtp->close_session();
-		return false;
-	}
-
-	// From this point onward most server response codes should be 250
-	// Specify who the mail is from....
-	$smtp->server_send('MAIL FROM:<' . $config['board_email'] . '>');
-	if ($err_msg = $smtp->server_parse('250', __LINE__))
-	{
-		$smtp->close_session();
-		return false;
-	}
-
-	// Specify each user to send to and build to header.
-	$to_header = implode(', ', $mail_to);
-	$cc_header = implode(', ', $mail_cc);
-
-	// Now tell the MTA to send the Message to the following people... [TO, BCC, CC]
-	$rcpt = false;
-	foreach ($mail_rcpt as $type => $mail_to_addresses)
-	{
-		foreach ($mail_to_addresses as $mail_to_address)
-		{
-			// Add an additional bit of error checking to the To field.
-			if (preg_match('#[^ ]+\@[^ ]+#', $mail_to_address))
-			{
-				$smtp->server_send("RCPT TO:$mail_to_address");
-				if ($err_msg = $smtp->server_parse('250', __LINE__))
-				{
-					// We continue... if users are not resolved we do not care
-					if ($smtp->numeric_response_code != 550)
-					{
-						$smtp->close_session();
-						return false;
-					}
-				}
-				else
-				{
-					$rcpt = true;
-				}
-			}
-		}
-	}
-
-	// We try to send messages even if a few people do not seem to have valid email addresses, but if no one has, we have to exit here.
-	if (!$rcpt)
-	{
-		$err_msg .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['INVALID_EMAIL_LOG'], htmlspecialchars($mail_to_address));
-		$smtp->close_session();
-		return false;
-	}
-
-	// Ok now we tell the server we are ready to start sending data
-	$smtp->server_send('DATA');
-
-	// This is the last response code we look for until the end of the message.
-	if ($err_msg = $smtp->server_parse('354', __LINE__))
-	{
-		$smtp->close_session();
-		return false;
-	}
-
-	// Send the Subject Line...
-	$smtp->server_send("Subject: $subject");
-
-	// Now the To Header.
-	$to_header = ($to_header == '') ? 'Undisclosed-Recipients:;' : $to_header;
-	$smtp->server_send("To: $to_header");
-
-	// Now the CC Header.
-	if ($cc_header != '')
-	{
-		$smtp->server_send("CC: $cc_header");
-	}
-
-	// Now any custom headers....
-	$smtp->server_send("$headers\r\n");
-
-	// Ok now we are ready for the message...
-	$smtp->server_send($message);
-
-	// Ok the all the ingredients are mixed in let's cook this puppy...
-	$smtp->server_send('.');
-	if ($err_msg = $smtp->server_parse('250', __LINE__))
-	{
-		$smtp->close_session();
-		return false;
-	}
-
-	// Now tell the server we are done and close the socket...
-	$smtp->server_send('QUIT');
-	$smtp->close_session();
-
-	return true;
-}
-
-// SMTP Class
-// Auth Mechanisms originally taken from the AUTH Modules found within the PHP Extension and Application Repository (PEAR)
-// See docs/AUTHORS for more details
-class smtp_class
-{
-	var $server_response = '';
-	var $socket = 0;
-	var $responses = array();
-	var $commands = array();
-	var $numeric_response_code = 0;
-
-	// Send command to smtp server
-	function server_send($command)
-	{
-		fputs($this->socket, $command . "\r\n");
-
-		// We could put additional code here
-	}
-	
-	// We use the line to give the support people an indication at which command the error occurred
-	function server_parse($response, $line)
-	{
-		$this->server_response = '';
-		$this->responses = array();
-		$this->numeric_response_code = 0;
-
-		while (substr($this->server_response, 3, 1) != ' ')
-		{
-			if (!($this->server_response = fgets($this->socket, 256)))
-			{
-				return 'Could not get mail server response codes';
-			}
-			$this->responses[] = substr(rtrim($this->server_response), 4);
-			$this->numeric_response_code = (int) substr($this->server_response, 0, 3);
-		}
-
-		if (!(substr($this->server_response, 0, 3) == $response))
-		{
-			$this->numeric_response_code = (int) substr($this->server_response, 0, 3);
-			return "Ran into problems sending Mail at <b>Line $line</b>. Response: $this->server_response";
-		}
-
-		return 0;
-	}
-
-	function close_session()
-	{
-		fclose($this->socket);
-	}
-	
-	// Log into server and get possible auth codes if neccessary
-	function log_into_server($hostname, $username, $password, $default_auth_method)
-	{
-		$err_msg = '';
-
-		// If we are authenticating through pop-before-smtp, we
-		// have to login ones before we get authenticated
-		if ($default_auth_method == 'POP-BEFORE-SMTP' && $username && $password)
-		{
-			$result = $this->pop_before_smtp($hostname, $username, $password);
-			$username = $password = $default_auth_method = '';
-		}
-
-		// Try EHLO first
-		$this->server_send("EHLO [$hostname]");
-		if ($err_msg = $this->server_parse('250', __LINE__))
-		{
-			// a 503 response code means that we're already authenticated
-			if ($this->numeric_response_code == 503)
-			{
-				return false;
-			}
-
-			// If EHLO fails, we try HELO			
-			$this->server_send("HELO [$hostname]");
-			if ($err_msg = $this->server_parse('250', __LINE__))
-			{
-				return ($this->numeric_response_code == 503) ? false : $err_msg;
-			}
-		}
-
-		foreach ($this->responses as $response)
-		{
-			$response = explode(' ', $response);
-			$response_code = $response[0];
-			unset($response[0]);
-			$this->commands[$response_code] = implode(' ', $response);
-		}
-
-		// If we are not authenticated yet, something might be wrong if no username and passwd passed
-		if (!$username || !$password)
-		{
-			return false;
-		}
-		
-		if (!isset($this->commands['AUTH']))
-		{
-			return 'SMTP server does not support authentication';
-		}
-
-		// Get best authentication method
-		$available_methods = explode(' ', $this->commands['AUTH']);
-
-		// Define the auth ordering if the default auth method was not found
-		$auth_methods = array('PLAIN', 'LOGIN', 'CRAM-MD5');
-		if (function_exists('posix_uname'))
-		{
-			$auth_methods[] = 'DIGEST-MD5';
-		}
-
-		$method = '';
-
-		if (in_array($default_auth_method, $available_methods))
-		{
-			$method = $default_auth_method;
-		}
-		else
-		{
-			foreach ($auth_methods as $_method)
-			{
-				if (in_array($_method, $available_methods))
-				{
-					$method = $_method;
-					break;
-				}
-			}
-		}
-
-		if (!$method)
-		{
-			return 'No supported authentication methods';
-		}
-
-		$method = strtolower(str_replace('-', '_', $method));
-		return $this->$method($username, $password);
-	}
-
-	function pop_before_smtp($hostname, $username, $password)
-	{
-		$old_socket = $this->socket;
-		
-		if (!$this->socket = fsockopen($hostname, 110, $errno, $errstr, 20))
-		{
-			$this->socket = $old_socket;
-			return "Could not connect to smtp host : $errno : $errstr";
-		}
-		
-		$this->server_parse('0', __LINE__);
-		if (substr($this->server_response, 0, 3) == '+OK')
-		{
-			fputs($this->socket, "USER $username\r\n");
-			fputs($this->socket, "PASS $password\r\n");
-		}
-		else
-		{
-			$this->socket = $old_socket;
-			return $this->responses[0];
-		}
-
-		$this->server_send('QUIT');
-		$this->server_parse('0', __LINE__);
-		fclose($this->socket);
-
-		$this->socket = $old_socket;
-
-		return false;
-	}
-	
-	function plain($username, $password)
-	{
-		$this->server_send('AUTH PLAIN');
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return ($this->numeric_response_code == 503) ? false : $err_msg;
-		}
-
-		$base64_method_plain = base64_encode("\0" . $username . "\0" . $password);
-		$this->server_send($base64_method_plain);
-		if ($err_msg = $this->server_parse('235', __LINE__))
-		{
-			return $err_msg;
-		}
-
-		return false;
-	}
-
-	function login($username, $password)
-	{
-		$this->server_send('AUTH LOGIN');
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return ($this->numeric_response_code == 503) ? false : $err_msg;
-		}
-
-		$this->server_send(base64_encode($username));
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return $err_msg;
-		}
-
-		$this->server_send(base64_encode($password));
-		if ($err_msg = $this->server_parse('235', __LINE__))
-		{
-			return $err_msg;
-		}
-
-		return false;
-	}
-
-	// The last two authentication mechanisms are a little bit tricky...
-	function cram_md5($username, $password)
-	{
-		$this->server_send('AUTH CRAM-MD5');
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return ($this->numeric_response_code == 503) ? false : $err_msg;
-		}
-
-		$md5_challenge = base64_decode($this->responses[0]);
-		$password = (strlen($password) > 64) ? pack('H32', md5($password)) : ((strlen($password) < 64) ? str_pad($password, 64, chr(0)) : $password);
-		$md5_digest = md5((substr($password, 0, 64) ^ str_repeat(chr(0x5C), 64)) . (pack('H32', md5((substr($password, 0, 64) ^ str_repeat(chr(0x36), 64)) . $md5_challenge))));
-
-		$base64_method_cram_md5 = base64_encode($username . ' ' . $md5_digest);
-
-		$this->server_send($base64_method_cram_md5);
-		if ($err_msg = $this->server_parse('235', __LINE__))
-		{
-			return $err_msg;
-		}
-
-		return false;
-	}
-
-	// A real pain in the ***
-	function digest_md5($username, $password)
-	{
-		global $config;
-
-		$this->server_send('AUTH DIGEST-MD5');
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return ($this->numeric_response_code == 503) ? false : $err_msg;
-		}
-
-		$md5_challenge = base64_decode($this->responses[0]);
-		
-		// Parse the md5 challenge - from AUTH_SASL (PEAR)
-		$tokens = array();
-		while (preg_match('/^([a-z-]+)=("[^"]+(?<!\\\)"|[^,]+)/i', $md5_challenge, $matches))
-		{
-			// Ignore these as per rfc2831
-			if ($matches[1] == 'opaque' || $matches[1] == 'domain')
-			{
-				$md5_challenge = substr($md5_challenge, strlen($matches[0]) + 1);
-				continue;
-			}
-
-			// Allowed multiple "realm" and "auth-param"
-			if (!empty($tokens[$matches[1]]) && ($matches[1] == 'realm' || $matches[1] == 'auth-param'))
-			{
-				if (is_array($tokens[$matches[1]]))
-				{
-					$tokens[$matches[1]][] = preg_replace('/^"(.*)"$/', '\\1', $matches[2]);
-				}
-				else
-				{
-					$tokens[$matches[1]] = array($tokens[$matches[1]], preg_replace('/^"(.*)"$/', '\\1', $matches[2]));
-				}
-			} 
-			else if (!empty($tokens[$matches[1]])) // Any other multiple instance = failure
-			{
-				$tokens = array();
-				break;
-			}
-			else
-			{
-				$tokens[$matches[1]] = preg_replace('/^"(.*)"$/', '\\1', $matches[2]);
-			}
-
-			// Remove the just parsed directive from the challenge
-			$md5_challenge = substr($md5_challenge, strlen($matches[0]) + 1);
-		}
-
-		// Realm
-		if (empty($tokens['realm']))
-		{
-			$uname = posix_uname();
-			$tokens['realm'] = $uname['nodename'];
-		}
-        
-		// Maxbuf
-		if (empty($tokens['maxbuf']))
-		{
-			$tokens['maxbuf'] = 65536;
-		}
-
-		// Required: nonce, algorithm
-		if (empty($tokens['nonce']) || empty($tokens['algorithm']))
-		{
-			$tokens = array();
-		}
-		$md5_challenge = $tokens;
-
-		if (!empty($md5_challenge))
-		{
-			$str = '';
-			mt_srand( (double) microtime() * 10000000);
-			for ($i = 0; $i < 32; $i++)
-			{
-				$str .= chr(mt_rand(0, 255));
-			}
-			$cnonce = base64_encode($str);
-
-			$digest_uri = 'smtp/' . $config['smtp_host'];
-
-			$auth_1 = sprintf('%s:%s:%s', pack('H32', md5(sprintf('%s:%s:%s', $username, $md5_challenge['realm'], $password))), $md5_challenge['nonce'], $cnonce);
-			$auth_2 = 'AUTHENTICATE:' . $digest_uri;
-			$response_value = md5(sprintf('%s:%s:00000001:%s:auth:%s', md5($auth_1), $md5_challenge['nonce'], $cnonce, md5($auth_2)));
-
-			$input_string = sprintf('username="%s",realm="%s",nonce="%s",cnonce="%s",nc="00000001",qop=auth,digest-uri="%s",response=%s,%d', $username, $md5_challenge['realm'], $md5_challenge['nonce'], $cnonce, $digest_uri, $response_value, $md5_challenge['maxbuf']);
-		}
-		else
-		{
-			return 'Invalid digest challenge';
-		}
-		
-		$base64_method_digest_md5 = base64_encode($input_string);
-		$this->server_send($base64_method_digest_md5);
-		if ($err_msg = $this->server_parse('334', __LINE__))
-		{
-			return $err_msg;
-		}
-
-		$this->server_send(' ');
-		if ($err_msg = $this->server_parse('235', __LINE__))
-		{
-			return $err_msg;
-		}
-		
-		return false;
-	}
-}
-
-// Encodes the given string for proper display for this encoding ... nabbed 
-// from php.net and modified. There is an alternative encoding method which 
-// may produce less output but it's questionable as to its worth in this 
-// scenario IMO
-/*
-function mail_encode($str, $encoding)
-{
-	if ($encoding == '')
-	{
-		return $str;
-	}
-
-	// define start delimimter, end delimiter and spacer
-	$end = "?=";
-	$start = "=?$encoding?B?";
-	$spacer = "$end\r\n $start";
-
-	// determine length of encoded text within chunks and ensure length is even
-	$length = 75 - strlen($start) - strlen($end);
-	$length = floor($length / 2) * 2;
-
-	// encode the string and split it into chunks with spacers after each chunk
-	$str = chunk_split(base64_encode($str), $length, $spacer);
-
-	// remove trailing spacer and add start and end delimiters
-	$str = preg_replace('#' . preg_quote($spacer) . '$#', '', $str);
-
-	return $start . $str . $end;
-}*/
-
-?>
\ No newline at end of file



From viperal at berlios.de  Wed Sep 28 21:45:45 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Wed, 28 Sep 2005 21:45:45 +0200
Subject: [Viperals-svncheckins] r148 - in cms/branches/1.0alpha2: . includes includes/templates/modules
Message-ID: <200509281945.j8SJjj3A032637@sheep.berlios.de>

Author: viperal
Date: 2005-09-28 21:45:45 +0200 (Wed, 28 Sep 2005)
New Revision: 148

Removed:
   cms/branches/1.0alpha2/includes/nusoap/
   cms/branches/1.0alpha2/includes/templates/modules/google_search/
Modified:
   cms/branches/1.0alpha2/config.php
Log:


Modified: cms/branches/1.0alpha2/config.php
===================================================================
--- cms/branches/1.0alpha2/config.php	2005-09-28 19:44:51 UTC (rev 147)
+++ cms/branches/1.0alpha2/config.php	2005-09-28 19:45:45 UTC (rev 148)
@@ -1,26 +0,0 @@
-<?php
-
-$site_db['type'] = 'postgres';
-$site_db['persistent'] = false;
-$site_db['server'] = 'localhost';
-$site_db['port'] = '';
-$site_db['database'] = 'trunck';
-$site_db['username'] = 'postgres';
-$site_db['password'] = 'viper83';
-
-$table_prefix	= 'cms_';
-$user_prefix	= 'cms_';
-
-$acm_type		= 'file';
-
-if (!defined('INDEX_PAGE'))
-{
-	define('INDEX_PAGE', 'index.php');
-}
-
-if (!defined('ADMIN_PAGE'))
-{
-	define('ADMIN_PAGE', 'admin.php');
-}
-
-?>
\ No newline at end of file



From viperal at berlios.de  Thu Sep 29 23:14:40 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Thu, 29 Sep 2005 23:14:40 +0200
Subject: [Viperals-svncheckins] r149 - in cms/trunk: . admin includes includes/forums includes/forums/admin includes/templates/admin/system install modules/Forums modules/Quick_Message modules/articles
Message-ID: <200509292114.j8TLEepG007176@sheep.berlios.de>

Author: viperal
Date: 2005-09-29 23:14:37 +0200 (Thu, 29 Sep 2005)
New Revision: 149

Modified:
   cms/trunk/admin/system.php
   cms/trunk/core.php
   cms/trunk/includes/forums/admin/admin_permissions.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/mailer.php
   cms/trunk/includes/templates/admin/system/index.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/modules/Forums/posting.php
   cms/trunk/modules/Forums/search.php
   cms/trunk/modules/Quick_Message/configurator.php
   cms/trunk/modules/articles/configurator.php
Log:
Added type casting to core config values
Update mailer class
Other changes

Modified: cms/trunk/admin/system.php
===================================================================
--- cms/trunk/admin/system.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/admin/system.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -21,9 +21,6 @@
 $Id$
 */
 
-
-// Need to redo this, do all check before the saving
-
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -46,36 +43,150 @@
 	'SYSTEM_MODE'	=> $mode,
 ));
 
-$save = (isset($_POST['submit'])) ? true : false;
+$save = isset($_POST['submit']);
 
 switch ($mode)
 {
 	case 'site':
-		admin_site($save);
-	break;
+		if ($save)
+		{
+			$data = array(
+				'global'	=> array(
+					'default_theme'		=> get_variable('default_theme', 'POST', ''),
+					'link_optimization' => get_variable('link_optimization', 'POST', 0, 'int'),
+					'site_name'			=> get_variable('site_name', 'POST', ''),
+					'site_url'			=> get_variable('site_url', 'POST', ''),
+					'foot1'				=> get_variable('foot1', 'POST', ''),
+					'foot2'				=> get_variable('foot2', 'POST', ''),
+				),
+				'email'	=> array(
+					'email_enable'			=> get_variable('email_enable', 'POST') ? 1 : 0,
+					'email_function_name'	=> get_variable('email_function_name', 'POST', ''),
+					'smtp'					=> get_variable('smtp', 'POST', 0, 'int'),
+					'smtp_host'				=> get_variable('smtp_host', 'POST', ''),
+					'smtp_port'				=> get_variable('smtp_port', 'POST', '', 'int'),
+					'smtp_username'			=> get_variable('smtp_username', 'POST', ''),
+					'smtp_password'			=> get_variable('smtp_password', 'POST', ''),
+					'site_email'			=> get_variable('site_email', 'POST', ''),
+				)
+			);
+			
+			setting_save($data);
 
-	case 'users':
-		//admin_users($save);
+			unset($data);
+		}
+	
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$_CLASS['core_template']->assign_array(array(
+			'A_OPTION'		=> 'site',
+			'ACTION'		=> generate_link('system', array('admin' => true)),
+			
+			'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
+	
+			'SELECT_THEME' 		=> select_theme($_CORE_CONFIG['global']['default_theme']),
+			'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
+	
+			'EMAIL_ENABLE'		=> $_CORE_CONFIG['email']['email_enable'],
+			'EMAIL_FUNCTION_NAME'=> $_CORE_CONFIG['email']['email_function_name'],
+			'SMTP'				=> $_CORE_CONFIG['email']['smtp'],
+			'SMTP_HOST'			=> $_CORE_CONFIG['email']['smtp_host'],
+			'SMTP_PORT'			=> $_CORE_CONFIG['email']['smtp_port'],
+			'SMTP_USERNAME'		=> $_CORE_CONFIG['email']['smtp_username'],
+			'SMTP_PASSWORD'		=> $_CORE_CONFIG['email']['smtp_password'],
+			'SITE_EMAIL'		=> $_CORE_CONFIG['email']['site_email'],
+	
+			'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
+			'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
+		));
+	
+		$_CLASS['core_template']->display('admin/system/index.html');
 	break;
 
 	case 'system':
-		admin_system($save);
+		if ($save)
+		{
+			if (!empty($_POST['maintenance_start']))
+			{
+				$expires = strtotime($_POST['maintenance_start']);
+				$_POST['maintenance_start'] = (!$expires || $expires === -1) ? 0 : $expires;
+			}
+	
+			$data = array(
+				'maintenance' => array(
+						'active' 	=> get_variable('maintenance', 'POST') ? 1 : 0,
+						'text'		=> get_variable('maintenance_text', 'POST', ''),
+						'start' 	=> get_variable('maintenance_start', 'POST', 0, 'int'),
+				),
+				'server' => array(
+					'cookie_domain' => get_variable('cookie_domain', 'POST', ''),
+					'cookie_name' 	=> get_variable('cookie_name', 'POST', ''),
+					'cookie_path' 	=> get_variable('cookie_path', 'POST', ''),
+					'error_options'	=> get_variable('error_options', 'POST', 0, 'int'),
+					'site_domain'	=> get_variable('site_domain', 'POST', ''),
+					'site_port' 	=> get_variable('site_port', 'POST', ''),
+					'site_path' 	=> get_variable('site_path', 'POST', ''),
+					'site_secure'	=> get_variable('site_secure', 'POST', 0, 'int'),
+					'ip_check' 		=> get_variable('ip_check', 'POST', 0, 'int'),
+					'limit_load' 	=> get_variable('limit_load', 'POST', 0, 'int'),
+					'limit_sessions'	=> get_variable('limit_sessions', 'POST', 0, 'int'),
+					'session_length'	=> get_variable('session_length', 'POST', 600, 'int'),
+				)
+			);
+	
+			setting_save($data);
+	
+			unset($data);
+		}
+		
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$path = str_replace('\\','/', dirname(getenv('SCRIPT_NAME')));
+		
+		if (substr($path, -1) !== '/')
+		{
+			$path .= '/';
+		}
+	
+		$domain = empty($_SERVER['SERVER_NAME']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME'];
+	
+		$_CLASS['core_template']->assign_array(array(
+			'A_OPTION' 			=> 'system',
+			'ACTION'			=> generate_link('system&amp;mode=system', array('admin' => true)),
+			
+			'COOKIE_DOMAIN' => $_CORE_CONFIG['server']['cookie_domain'],
+			'COOKIE_NAME' 	=> $_CORE_CONFIG['server']['cookie_name'],
+			'COOKIE_PATH' 	=> $_CORE_CONFIG['server']['cookie_path'],
+			'ERROR'			=> $_CORE_CONFIG['server']['error_options'],
+			'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
+			'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
+			'MAINTENANCE_START' => is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']->format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
+			'IP_CHECK'			=> $_CORE_CONFIG['server']['ip_check'],
+			'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
+			'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],
+			'SITE_PORT'			=> $_CORE_CONFIG['server']['site_port'],
+			'SITE_SECURE'		=> $_CORE_CONFIG['server']['site_secure'],
+			'LIMIT_LOAD'		=> $_CORE_CONFIG['server']['limit_load'],
+			'LIMIT_SESSIONS'	=> $_CORE_CONFIG['server']['limit_sessions'],
+			'SESSION_LENGTH'	=> $_CORE_CONFIG['server']['session_length'],
+			
+		));
+	
+		$_CLASS['core_template']->display('admin/system/index.html');
 	break;
 }
 
-function admin_save($data)
+function setting_save($data)
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
 	foreach ($data AS $section => $option)
     {
-		foreach ($option AS $db_name => $data_op)
+		foreach ($option AS $name => $value)
 		{
-			$value = get_variable($data_op['post_name'], 'POST', false);
-
-			if ($value != $_CORE_CONFIG[$section][$db_name])
+			if (isset($_CORE_CONFIG[$section][$name]) && $value != $_CORE_CONFIG[$section][$name])
 			{
-				set_core_config($section, $db_name, $value, false);
+				set_core_config($section, $name, $value, false);
 			}
 		}
     }
@@ -83,102 +194,4 @@
 	$_CLASS['core_cache']->destroy('core_config');
 }
 
-function admin_site($save)
-{
-	if ($save)
-	{
-		$data = array('global'	=> array(
-			'default_theme'		=> array('post_name' => 'default_theme'),
-			'link_optimization' => array('post_name' => 'link_optimization'),
-			'site_name'			=> array('post_name' => 'site_name'),
-			'site_url'			=> array('post_name' => 'site_url'),
-			'start_date'		=> array('post_name' => 'start_date'),
-			'foot1'				=> array('post_name' => 'foot1'),
-			'foot2'				=> array('post_name' => 'foot2'),
-		));
-		admin_save($data);
-	}
-
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']->assign_array(array(
-		'A_OPTION'		=> 'site',
-		'ACTION'		=> generate_link('system', array('admin' => true)),
-		
-		'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
-
-		'SELECT_THEME' 		=> select_theme($_CORE_CONFIG['global']['default_theme']),
-		'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
-		'SITE_URL'			=> $_CORE_CONFIG['global']['site_url'],
-		'START_DATE'		=> $_CORE_CONFIG['global']['start_date'],
-
-		'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
-		'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
-		
-	));
-
-	$_CLASS['core_template']->display('admin/system/index.html');
-}
-
-function admin_system($save)
-{
-	if ($save)
-	{
-		if (!empty($_POST['maintenance_start']))
-		{
-			$expires = strtotime($_POST['maintenance_start']);
-			$_POST['maintenance_start'] = (!$expires || $expires == -1) ? '' : $expires;
-		}
-
-		$data = array(
-			'maintenance' => array(
-					'active' => array('post_name' => 'maintenance'),
-					'text' => array('post_name' => 'maintenance_text'),
-					'start' => array('post_name' => 'maintenance_start'),
-			),
-			'server' => array(
-				'cookie_domain' => array('post_name' => 'cookie_domain'),
-				'cookie_name' 	=> array('post_name' => 'cookie_name'),
-				'cookie_path' 	=> array('post_name' => 'cookie_path'),
-				'error_options'	=> array('post_name' => 'error_options'),
-				'site_domain'	=> array('post_name' => 'site_domain'),
-				'site_port' 	=> array('post_name' => 'site_port'),
-				'site_path' 	=> array('post_name' => 'site_path'),
-				'site_secure'	=> array('post_name' => 'site_secure'),
-				'ip_check' 		=> array('post_name' => 'ip_check'),
-				'limit_load' 	=> array('post_name' => 'limit_load'),
-				'limit_sessions'	=> array('post_name' => 'limit_sessions'),
-				'session_length'	=> array('post_name' => 'session_length'),
-			)
-		);
-		admin_save($data);
-	}
-	
-	global $_CLASS, $_CORE_CONFIG;
-   
-    $_CLASS['core_template']->assign_array(array(
-		'A_OPTION' 			=> 'system',
-		'ACTION'			=> generate_link('system&amp;mode=system', array('admin' => true)),
-		
-		'COOKIE_DOMAIN' => $_CORE_CONFIG['server']['cookie_domain'],
-		'COOKIE_NAME' 	=> $_CORE_CONFIG['server']['cookie_name'],
-		'COOKIE_PATH' 	=> $_CORE_CONFIG['server']['cookie_path'],
-		'ERROR'			=> $_CORE_CONFIG['server']['error_options'],
-		'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
-		'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
-		'MAINTENANCE_START' => is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']->format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
-		'IP_CHECK'			=> $_CORE_CONFIG['server']['ip_check'],
-		'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
-		'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],
-		'SITE_PORT'			=> $_CORE_CONFIG['server']['site_port'],
-		'SITE_SECURE'		=> $_CORE_CONFIG['server']['site_secure'],
-		'LIMIT_LOAD'		=> $_CORE_CONFIG['server']['limit_load'],
-		'LIMIT_SESSIONS'	=> $_CORE_CONFIG['server']['limit_sessions'],
-		'SESSION_LENGTH'	=> $_CORE_CONFIG['server']['session_length'],
-		
-	));
-
-	$_CLASS['core_template']->display('admin/system/index.html');
-}
-
 ?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/core.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -138,10 +138,13 @@
 	
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
+		settype($row['config_value'], $row['config_type']);
+
 		if ($row['config_cache'])
 		{
 			$cache[$row['config_section']][$row['config_name']] = $row['config_value'];
 		}
+
 		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
 	}
 	$_CLASS['core_db']->free_result($result);
@@ -166,6 +169,8 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
+		settype($row['config_value'], $row['config_type']);
+
 		$_CORE_CONFIG[$row['config_section']][$row['config_name']] = $row['config_value'];
 	}
 	$_CLASS['core_db']->free_result($result);

Modified: cms/trunk/includes/forums/admin/admin_permissions.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/admin/admin_permissions.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -1,1304 +1,1303 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
-//
-// FILENAME  : admin_permissions.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// values need checks
-
-
-// Grab and set some basic parameters
-//
-// 'mode' determines what we're altering; administrators, users, deps, etc.
-// 'submit' is used to determine what we're doing ... special format
-$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
-
-// What mode are we running? So we can output the correct title, explanation
-// and set the sql_option_mode/acl check
-switch ($mode)
-{
-	case 'forum':
-		$l_title = $_CLASS['core_user']->lang['PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_auth';
-		$sql_option_mode = 'f';
-		break;
-
-	case 'mod':
-		$l_title = $_CLASS['core_user']->lang['MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'supermod':
-		$l_title = $_CLASS['core_user']->lang['SUPER_MODERATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
-		$which_acl = 'a_authmods';
-		$sql_option_mode = 'm';
-		break;
-
-	case 'admin':
-		$l_title = $_CLASS['core_user']->lang['ADMINISTRATORS'];
-		$l_title_explain = $_CLASS['core_user']->lang['ADMINISTRATORS_EXPLAIN'];
-		$which_acl = 'a_authadmins';
-		$sql_option_mode = 'a';
-		break;
-
-	case 'user':
-		$l_title = $_CLASS['core_user']->lang['USER_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['USER_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authusers';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'group':
-		$l_title = $_CLASS['core_user']->lang['GROUP_PERMISSIONS'];
-		$l_title_explain = $_CLASS['core_user']->lang['GROUP_PERMISSIONS_EXPLAIN'];
-		$which_acl = 'a_authgroups';
-		$sql_option_mode = 'u';
-		break;
-
-	case 'deps':
-		$l_title = $_CLASS['core_user']->lang['DEPENDENCIES'];
-		$l_title_explain = $_CLASS['core_user']->lang['DEPENDENCIES_EXPLAIN'];
-		$which_acl = 'a_authdeps';
-		break;
-}
-
-// Permission check
-if (!$_CLASS['auth']->acl_get($which_acl))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
-$which_mode = (!empty($submode) && $submode != $mode) ? $submode : $mode;
-$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
-$submit		= (sizeof($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
-
-// Submitted setting data
-//
-// 'auth_settings' contains the submitted option settings assigned to options, should be an 
-//   associative array with integer values
-$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
-
-
-// Forum, User or Group information
-//
-// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
-// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
-// 'forum_id' contains the list of forums, 0 is used for "All forums", can be array or scalar
-$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
-$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
-
-if (isset($_REQUEST['f']))
-{
-	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
-}
-
-if (!isset($forum_id[$which_mode]))
-{
-	$forum_id[$which_mode][] = 0;
-}
-
-$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
-
-// Generate list of forum id's
-$s_forum_id = '';
-
-foreach ($forum_id as $forum_submode => $forum_submode_ids)
-{
-	foreach ($forum_submode_ids as $submode_forum_id)
-	{
-		$s_forum_id .= '<input type="hidden" name="f[' . $forum_submode . '][]" value="' . $submode_forum_id . '" />';
-	}
-}
-unset($forum_submode_ids);
-unset($forum_submode);
-unset($submode_forum_id);
-
-
-// Instantiate a new auth admin object in readiness
-$auth_admin = new auth_admin();
-
-// Are we setting deps? If we are we need to re-run the mode match above for the
-// relevant 'new' mode
-if (!empty($submode))
-{
-	switch ($submode)
-	{
-		case 'forum':
-			$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
-			$which_acl = 'a_auth';
-			$sql_option_mode = 'f';
-			break;
-
-		case 'mod':
-			$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-
-		case 'supermod':
-			$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
-			$which_acl = 'a_authmods';
-			$sql_option_mode = 'm';
-			break;
-	}
-
-	// Permission check
-	if (!$_CLASS['auth']->acl_get($which_acl))
-	{
-		trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-	}
-}
-
-
-// Does user want to update anything? Check here to find out 
-// and act appropriately
-switch ($submit)
-{
-	case 'update':
-
-		if (sizeof($auth_settings))
-		{
-			// Admin wants subforums to inherit permissions ... so add these
-			// forums to the list ... since inheritance is only available for
-			// forum and moderator primary modes we deal with '$forum_id[$mode]'
-			if (!empty($_POST['inherit']))
-			{
-				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
-			}
-
-			// Update the permission set ... we loop through each auth setting array
-			foreach ($auth_settings as $auth_submode => $auth_setting)
-			{
-				// Are any entries * ? If so we need to remove them since they
-				// are options the user wishes to ignore
-
-				if (in_array('*', $auth_setting))
-				{
-					foreach ($auth_setting as $option => $setting)
-					{
-						if ($setting == '*')
-						{
-							unset($auth_setting[$option]);
-						}
-					}
-				}
-
-				if (!empty($auth_setting))
-				{
-					// Loop through all user/group ids
-					foreach ($ug_data as $id)
-					{
-						$auth_admin->acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
-					}
-				}
-			}
-
-			// Do we need to recache the moderator lists? We do if the mode
-			// was mod or auth_settings['mod'] is a non-zero size array
-			if ($mode == 'mod' || !empty($auth_settings['mod']))
-			{
-				cache_moderators();
-			}
-
-			// Remove users who are now moderators or admins from everyones foes
-			// list
-			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
-			{
-				update_foes();
-			}
-
-			// Logging ... first grab user or groupnames ...
-			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-			$result = $_CLASS['core_db']->query($sql);
-
-			$l_ug_list = '';
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$auth_submode = array_keys($auth_settings);
-			foreach ($auth_submode as $sub_mode)
-			{
-				if (!in_array(0, $forum_id[$sub_mode]))
-				{
-					// Grab the forum details if non-zero forum_id
-					$sql = 'SELECT forum_name  
-						FROM ' . FORUMS_FORUMS_TABLE . "
-						WHERE forum_id IN ($sql_forum_id)";
-					$result = $_CLASS['core_db']->query($sql);
-
-					$l_forum_list = '';
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-					}
-					$_CLASS['core_db']->free_result($result);
-
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
-				}
-				else
-				{
-					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
-				}
-			}
-			unset($l_ug_list);
-		}
-		unset($auth_submode);
-		unset($auth_setting);
-
-		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
-		break;
-
-	case 'delete':
-
-		$sql = "SELECT auth_option_id
-			FROM " . FORUMS_ACL_OPTIONS_TABLE . "
-			WHERE auth_option LIKE '{$sql_option_mode}_%'";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$option_id_ary = array();
-			do
-			{
-				$option_id_ary[] = $row['auth_option_id'];
-			}
-			while($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-			foreach ($ug_data as $id)
-			{
-				$auth_admin->acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
-			}
-			unset($option_id_ary);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-
-		// Do we need to recache the moderator lists? We do if the mode
-		// was mod or auth_settings['mod'] is a non-zero size array
-		if ($mode == 'mod' || (isset($auth_settings['mod']) && sizeof($auth_settings['mod'])))
-		{
-			cache_moderators();
-		}
-
-		// Logging ... first grab user or groupnames ...
-		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
-		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$l_ug_list = '';
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-
-		// Grab the forum details if non-zero forum_id
-		if (!in_array(0, $forum_id[$which_mode]))
-		{
-			$sql = 'SELECT forum_name  
-				FROM ' . FORUMS_FORUMS_TABLE . "
-				WHERE forum_id IN ($sql_forum_id)";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$l_forum_list = '';
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
-		}
-		else
-		{
-			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
-		}
-
-		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
-		break;
-
-	case 'presetsave':
-
-		$holding_ary = array();
-	
-		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
-
-		foreach ($auth_setting as $option => $setting)
-		{
-			switch ($setting)
-			{
-				case ACL_YES:
-					$holding_ary['yes'][] = $option;
-					break;
-
-				case ACL_NO:
-					$holding_ary['no'][] = $option;
-					break;
-
-				case ACL_UNSET:
-					$holding_ary['unset'][] = $option;
-					break;
-			}
-		}
-
-		$sql = array(
-			'preset_user_id'=> intval($_CLASS['core_user']->data['user_id']),
-			'preset_type'	=> $sql_option_mode,
-			'preset_data'	=> serialize($holding_ary)
-		);
-
-		if (!empty($_POST['presetname']))
-		{	
-			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
-		}
-		
-		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
-		{
-			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . intval($_POST['presetoption']);
-			$_CLASS['core_db']->query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
-		}
-		unset($sql, $option, $setting, $auth_setting);
-
-		break;
-
-	case 'presetdel':
-
-		if (!empty($_POST['presetoption']))
-		{
-			$sql = "SELECT preset_name 
-				FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . (int) $_POST['presetoption'];
-			$result = $_CLASS['core_db']->query($sql);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			$sql = "DELETE FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-				WHERE preset_id = " . (int) $_POST['presetoption'];
-			$_CLASS['core_db']->query($sql);
-
-			add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
-			unset($row);
-		}
-		break;
-}
-// End update
-
-
-// Output page header
-adm_page_header($l_title);
-
-
-// First potential form ... this is for selecting forums, users
-// or groups. 
-if (in_array($mode, array('user', 'group', 'forum', 'mod')) && empty($submit))
-{
-
-?>
-
-<h1><?php echo $l_title; ?></h1>
-
-<p><?php echo $l_title_explain ?></p>
-
-<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-<?php
-
-	// Mode specific markup
-	switch ($mode)
-	{
-		case 'forum':
-		case 'mod':
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="f[<?php echo $mode; ?>][]" multiple="true" size="7"><?php 
-	
-			echo make_forum_select(false, false, false);
-			
-?></select>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_usergroups" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="forum" /><input type="hidden" name="action" value="usergroups" /></td>
-	</tr>
-<?php
-		
-			break;
-
-		case 'user':
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_USER']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center">&nbsp;<textarea cols="40" rows="4" name="ug_data[]"></textarea>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /></td>
-	</tr>
-<?php
-
-			break;
-
-		case 'group':
-			// Generate list of groups
-
-?>
-	<tr>
-		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="ug_data[]" multiple="true" size="7"><?php 
-
-			$sql = "SELECT group_id, group_name, group_type   
-				FROM " . GROUPS_TABLE . " 
-				ORDER BY group_type DESC";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$group_options = '';
-			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				do
-				{
-					echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-				}
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-			}
-			$_CLASS['core_db']->free_result($result);
-			
-?></select>&nbsp;</td>
-	</tr>
-	<tr>
-		<td class="cat" align="center"><input type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /></td>
-	</tr>
-<?php
-
-		break;
-
-	}
-
-?>
-</table></form>
-
-<?php
-
-}
-// End user, group or forum selection
-
-
-// Second possible form, this lists the currently enabled
-// users/groups for the given mode
-if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') && empty($submode) && in_array($mode, array('admin', 'supermod'))))
-{
-
-?>
-
-<h1><?php echo $l_title; ?></h1>
-
-<p><?php echo $l_title_explain; ?></p>
-
-<table width="100%" cellspacing="0" cellpadding="0" border="0">
-	<tr>
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['MANAGE_USERS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php
-			
-	$sql = "SELECT u.user_id, u.username
-		FROM " . USERS_TABLE . " u, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
-		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
-			AND a.auth_option_id = o.auth_option_id
-			AND a.forum_id IN ($sql_forum_id)
-			AND u.user_id = a.user_id
-		ORDER BY u.username, u.user_reg_date ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$users = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-		
-?></select></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-
-		<td align="center"><form method="post" name="admingroups" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-		<tr>
-			<th><?php echo $_CLASS['core_user']->lang['MANAGE_GROUPS']; ?></th>
-		</tr>
-		<tr>
-			<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php 
-	
-	$sql = "SELECT DISTINCT g.group_id, g.group_name, g.group_type 
-		FROM " . GROUPS_TABLE . " g, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
-		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
-			AND a.forum_id IN ($sql_forum_id)
-			AND a.auth_option_id = o.auth_option_id
-			AND g.group_id = a.group_id
-		ORDER BY g.group_type DESC, g.group_name ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$groups = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-
-?></select></td>
-		</tr>
-		<tr>
-			<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
-		</tr>
-	</table></form></td>
-
-	</tr>
-	<tr>
-
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" align="center"><textarea style="height:60px" cols="40" rows="4" name="ug_data[]"></textarea></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&amp;field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-
-		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th><?php echo $_CLASS['core_user']->lang['ADD_GROUPS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" style="height: 100%" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple"  size="5"><?php 
-			
-	$sql = "SELECT group_id, group_name, group_type 
-		FROM " . GROUPS_TABLE . "
-		ORDER BY group_type DESC, group_name";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$group_list = '';
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
-	}
-	$_CLASS['core_db']->free_result($result);
-		
-?></select></td>
-			</tr>
-			<tr>
-				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
-			</tr>
-		</table></form></td>
-	</tr>
-</table>
-
-<?php
-
-}
-// End user and group acl selections
-
-
-
-
-
-
-// Third possible form, this is the major section of this script. It
-// handles the entry of permission options for all situations
-if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
-{
-
-	// Did the user specify any users or groups?
-	if (empty($ug_data))
-	{
-		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
-		trigger_error($_CLASS['core_user']->lang[$l_message]);
-	}
-
-
-	$forum_list = '';
-	// Grab the forum details if non-zero forum_id
-	if (!in_array(0, $forum_id[$which_mode]))
-	{
-		$sql = 'SELECT forum_id, forum_name, parent_id  
-			FROM ' . FORUMS_FORUMS_TABLE . "
-			WHERE forum_id IN ($sql_forum_id)";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
-		}
-
-		// If we have more than one forum we want a list of all their names
-		// so loop through all results. We don't need all the data though 
-		// since cascading/inheritance is only applicable if a single forum
-		// was selected
-		$forum_data = $row;
-
-		do
-		{
-			$forum_list .= (($forum_list != '') ? ', ' : '') . '<b>' . $row['forum_name'] . '</b>';
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-		$_CLASS['core_db']->free_result($result);
-	}
-
-
-	// Grab relevant user or group information
-	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
-// need some work ( array_mapping()) blaa blaa
-	switch ($ug_type)
-	{
-		case 'user':
-			$l_no_error = $_CLASS['core_user']->lang['NO_USER'];
-			$sql = 'SELECT user_id AS id, username AS name 
-				FROM ' . USERS_TABLE . ' 
-				WHERE ';
-			$sql .= ($submit == 'add_options') ? " username IN ('" . implode("', '", $_CLASS['core_db']->escape_array(array_unique(explode("\n", modify_lines($ug_data[0], "\n"))))) . "')" : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
-		break;
-
-		case 'group':
-			$l_no_error = $_CLASS['core_user']->lang['NO_GROUP'];
-			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
-				FROM ' . GROUPS_TABLE . '
-				WHERE group_id';
-			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
-		break;
-	}
-	$result = $_CLASS['core_db']->query($sql);
-
-	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		trigger_error($l_no_error);
-	}
-	unset($l_no_error);
-
-	// Store the user_ids and names for later use
-	do 
-	{
-		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<b class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] : '<b>' . $row['name']) . '</b>';
-		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
-		$ug_hidden .= '<input type="hidden" name="ug_data[]" value="' . $row['id'] . '" />';
-	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	$_CLASS['core_db']->free_result($result);
-
-
-	// Grab the list of options ... if we're in deps mode we want all options, 
-	// else we skip the master options
-	$sql_limit_option = ($mode == 'deps') ? '' : "AND auth_option <> '" . $sql_option_mode . "_'";
-	$sql = "SELECT auth_option_id, auth_option
-		FROM " . FORUMS_ACL_OPTIONS_TABLE . "
-		WHERE auth_option LIKE '" . $sql_option_mode . "_%' 
-			$sql_limit_option";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$auth_options = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$auth_presets_compare[] = $row['auth_option'];
-		$auth_options[] = $row;
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	unset($sql_limit_option);
-
-
-	// Now we'll build a list of preset options ...
-	$preset_options = $preset_js = $preset_update_options = '';
-
-	// Do we have a parent forum? If so offer option to inherit from that
-	if ($forum_data['parent_id'] != 0)
-	{
-		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-		 
-		$sql = "SELECT o.auth_option, a.auth_setting
-					FROM " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o 
-					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
-						AND a.auth_option_id = o.auth_option_id AND a.forum_id = " . $forum_data['parent_id'] . '
-						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)";
-
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			do
-			{
-				switch ($row['auth_setting'])
-				{
-					case ACL_YES:
-						$holding['yes'][] = $row['auth_option'];
-					break;
-
-					case ACL_NO:
-						$holding['no'][] = $row['auth_option'];
-					break;
-				}
-			}
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_options .= '<option value="preset_0">' . $_CLASS['core_user']->lang['INHERIT_PARENT'] . '</option>';
-			$preset_js .= "\tpresets['preset_0'] = new Array();" . "\n";
-			$preset_js .= "\tpresets['preset_0'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
-
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
-
-	// Look for custom presets
-	$sql = "SELECT preset_id, preset_name, preset_data  
-		FROM " . FORUMS_ACL_PRESETS_TABLE . " 
-		WHERE preset_type = '" . (($mode == 'deps') ? 'f' : $sql_option_mode) . "' 
-		ORDER BY preset_id ASC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		do
-		{
-			$preset_update_options .= '<option value="' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
-			$preset_options .= '<option value="preset_' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
-
-			$holding = unserialize($row['preset_data']);
-			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
-
-			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new Array();" . "\n";
-			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	unset($holding, $auth_presets_compare);
-
-
-	// If we aren't looking @ deps then we try and grab existing sessions for
-	// the given forum and user/group
-	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
-	{
-		if ($which_mode == $mode)
-		{
-			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
-					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o 
-					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
-						AND a.auth_option_id = o.auth_option_id 
-						AND a.forum_id IN ($sql_forum_id) 
-						AND a.".(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)
-					GROUP BY o.auth_option";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$auth_settings[$which_mode] = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-		else
-		{
-			// We're looking at a view ... so we'll set all options to unset
-			// We could be a little more clever here but the "safe side" looks
-			// better right now
-			$auth_settings[$which_mode] = array();
-			foreach ($auth_options as $option)
-			{
-				$auth_settings[$which_mode][$option['auth_option']] = '*';
-			}
-			unset($option);
-		}
-	}
-
-	$view_options = '';
-	// Should we display a dropdown for views?
-	if (in_array($mode, array('admin', 'supermod', 'mod')))
-	{
-		$view_options .= '<option value="">' . $_CLASS['core_user']->lang['SELECT_VIEW'] . '</option>';
-		$view_ary = array(
-			'admin'		=> array('admin' => 'a_', 'forum' => 'a_auth', 'supermod' => 'a_authmods', 'mod' => 'a_authmods'),
-			'supermod'	=> array('supermod' => 'a_authmods', 'mod' => 'a_authmods', 'forum' => 'a_auth'), 
-			'mod'		=> array('mod' => 'a_authmods', 'forum' => 'a_auth')
-		);
-
-		foreach ($view_ary[$mode] as $which_submode => $which_acl)
-		{
-			if ($_CLASS['auth']->acl_get($which_acl))
-			{
-				$view_options .= '<option value="' . $which_submode . '"' . (($which_submode == $which_mode) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ACL_VIEW_' . strtoupper($which_submode)] . '</option>';
-			}
-
-		}
-		unset($view_ary);
-	}
-
-	$settings_hidden = '';
-	// Output original settings ... needed when we jump views
-	foreach ($auth_settings as $auth_submode => $auth_submode_settings)
-	{
-		if ($auth_submode != $which_mode)
-		{
-			foreach ($auth_submode_settings as $submode_option => $submode_setting)
-			{
-				$settings_hidden .= ($submode_setting != '*') ? '<input type="hidden" name="settings[' . $auth_submode . '][' . $submode_option . ']" value="' . $submode_setting . '" />' : '';
-			}
-		}
-	}
-	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
-
-?>
-
-<script language="Javascript" type="text/javascript">
-<!--
-
-	var presets = new Array();
-<?php
-
-	echo $preset_js;
-
-?>
-
-	function preset_obj(yes, no, unset)
-	{
-		this.yes = yes;
-		this.no = no;
-		this.unset = unset;
-	}
-
-	function use_preset(option)
-	{
-		if (option)
-		{
-			document.acl.set.selectedIndex = 0;
-			for (i = 0; i < document.acl.length; i++)
-			{
-				var elem = document.acl.elements[i];
-				if (elem.name.indexOf('settings') == 0)
-				{
-					switch (option)
-					{
-						case 'all_yes':
-							if (elem.value == <?php echo ACL_YES; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_no':
-							if (elem.value == <?php echo ACL_NO; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_unset':
-							if (elem.value == <?php echo ACL_UNSET; ?>)
-								elem.checked = true;
-							break;
-
-						case 'all_ignore':
-							if (elem.value == '*')
-								elem.checked = true;
-							break;
-
-						default:
-							option_start = elem.name.search(/\[(\w+?)\]$/);
-							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
-
-							if (presets[option].yes.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_YES; ?>)
-								elem.checked = true;
-							else if (presets[option].no.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_NO; ?>)
-								elem.checked = true;
-							else if (presets[option].unset.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_UNSET; ?>)
-								elem.checked = true;
-							break;
-					}
-				}
-			}
-		}
-	}
-
-	function marklist(match, status)
-	{
-		for (i = 0; i < document.acl.length; i++)
-		{
-			if (document.acl.elements[i].name.indexOf(match) == 0)
-				document.acl.elements[i].checked = status;
-		}
-	}
-
-	function open_win(url, width, height)
-	{
-		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
-		if (window.focus)
-			aclwin.focus();
-	}
-//-->
-</script>
-
-<p><?php echo $_CLASS['core_user']->lang['ACL_EXPLAIN']; ?></p>
-
-<h1><?php echo $l_title; ?></h1>
-
-<?php
-
-	// Do we have a list of forums? If so, output them ... but only
-	// if we're looking at the primary view or mode ... submodes
-	// output their own list of forums as and where applicable so this
-	// is unnecessary
-	if ($forum_list != '' && $which_mode == $mode)
-	{
-		$l_selected_forums = (sizeof($forum_id[$which_mode]) == 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
-
-		echo '<p>' . $_CLASS['core_user']->lang[$l_selected_forums] . ': ' . $forum_list . '</p>';
-
-		unset($forum_list);
-		unset($l_selected_forums);
-	}
-
-	// Now output the list of users or groups ... these will always exist
-	$l_selected_users = ($ug_type == 'user') ? ((sizeof($ug_data) == 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((sizeof($ug_data) == 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
-
-	echo '<p>' . $_CLASS['core_user']->lang[$l_selected_users] . ': ' . $l_ug_list . '</p>';
-
-	unset($l_selected_users);
-	unset($ug_data);
-
-?>
-
-<p><?php echo $l_title_explain; ?></p>
-
-<?php
-
-	if ($settings_hidden != '')
-	{
-
-?>
-
-<h2 style="color:red"><?php echo $_CLASS['core_user']->lang['WARNING']; ?></h2>
-
-<p><?php echo $_CLASS['core_user']->lang['WARNING_EXPLAIN']; ?></p>
-
-<?php
-
-	}
-
-?>
-
-<form method="post" name="acl" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' => true)); ?>"><table cellspacing="2" cellpadding="0" border="0" align="center">
-<?php
-
-	// This is the main listing of options
-
-	// We output this for both deps and when update is requested where
-	// deps exist
-	if (($mode == 'admin' || $mode == 'supermod') && in_array($submode, array('forum', 'mod')))
-	{
-
-?>
-	<tr>
-		<td colspan="2" align="right"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0">
-			<tr>
-				<th colspan="2"><?php echo $_CLASS['core_user']->lang['SELECT_FORUM']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="2"><?php echo $_CLASS['core_user']->lang['WILL_SET_OPTIONS']; ?>:</th>
-			</tr>
-			<tr>
-				<td class="row2"><select style="width:100%" name="f[<?php echo $which_mode; ?>][]" multiple="7"><?php 
-		
-		echo make_forum_select($forum_id[$which_mode], false, true); 
-		
-?></select></td>
-			</tr>
-		</table><br /></td>
-	</tr>
-<?php
-
-	}
-	// End deps output
-
-?>
-	<tr>
-		<td align="left"><?php
-	
-	if ($view_options != '')
-	{
-	
-?><select name="submode" onchange="if (this.options[this.selectedIndex].value != '') this.form.submit();"><?php echo $view_options; ?></select><?php
-	
-	}
-	
-?></td>
-		<td align="right"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?>: <select name="set" onchange="use_preset(this.options[this.selectedIndex].value);"><option class="sep"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><option value="all_yes"><?php echo $_CLASS['core_user']->lang['ALL_YES']; ?></option><option value="all_no"><?php echo $_CLASS['core_user']->lang['ALL_NO']; ?></option><option value="all_unset"><?php echo $_CLASS['core_user']->lang['ALL_UNSET']; ?></option><?php 
-
-	$colspan = 4;
-	if ($which_mode != $mode)
-	{
-		$colspan = 5;
-		echo '<option value="all_ignore">' . $_CLASS['core_user']->lang['ALL_IGNORE'] . '</option>';
-	}
-
-	// Output user preset options ... if any
-	echo ($preset_options) ? '<option class="sep">' . $_CLASS['core_user']->lang['USER_PRESETS'] . ' -&gt;' . '</option>' . $preset_options : ''; 
-
-?></select></td>
-	</tr>
-	<tr>
-		<td colspan="2"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th>&nbsp;<?php echo $_CLASS['core_user']->lang['OPTION']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['YES']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['UNSET']; ?>&nbsp;</th>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['NO']; ?>&nbsp;</th>
-<?php
-
-	if ($which_mode != $mode)
-	{
-
-?>
-				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['IGNORE']; ?>&nbsp;</th>
-<?php
-
-	}
-
-?>
-			</tr>
-<?php
-
-	$row_class = 'row2';
-	for ($i = 0; $i < sizeof($auth_options); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-		// Try and output correct language strings, else output prettyfied auth_option
-		$l_auth_option = (!empty($_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
-		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
-
-		
-		// Which option should we select?
-		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked="checked"' : '';
-		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked="checked"' : '';
-		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked="checked"' : '';
-
-?>
-			<tr>
-				<td class="<?php echo $row_class; ?>" nowrap="nowrap"><?php echo $l_auth_option; ?>&nbsp;</td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_YES; ?>"<?php echo $selected_yes; ?> /></td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_UNSET; ?>"<?php echo $selected_unset; ?> /></td>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_NO; ?>"<?php echo $selected_no; ?> /></td>
-<?php
-
-		if ($which_mode != $mode)
-		{
-			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked="checked"' : '';
-
-?>
-				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="*"<?php echo $selected_ignore; ?> /></td>
-<?php
-
-		}
-
-?>
-			</tr>
-<?php
-
-	}
-
-
-	// If we're setting forum or moderator options and a single forum has
-	// been selected then look to see if any subforums exist. If they do
-	// give user the option of cascading permissions to them
-	if (($mode == 'forum' || $mode == 'mod') && empty($submode) && sizeof($forum_id[$which_mode]) == 1)
-	{
-		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
-
-		if (!empty($children))
-		{
-
-?>
-			<tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="<?php echo $colspan; ?>"><table width="100%" cellspacing="1" cellpadding="0" border="0">
-					<tr>
-						<td class="gensmall" colspan="4" height="16" align="center"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS_EXPLAIN']; ?></td>
-					</tr>
-<?php
-
-			foreach ($children as $row)
-			{
-
-?>
-					<tr>
-						<td><input type="checkbox" name="inherit[]" value="<?php echo $row['forum_id']; ?>" /> <?php echo $row['forum_name']; ?></td>
-					</tr>
-<?php
-
-			}
-
-?>
-					<tr>
-						<td height="16" align="center"><a class="gensmall" href="javascript:marklist('inherit', true);"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('inherit', false);" class="gensmall"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></td>
-					</tr>
-				</table></td>
-			</tr>
-<?php
-
-		}
-	}
-
-	// Display event/cron radio buttons
-	if ($_CLASS['auth']->acl_gets('a_events', 'a_cron') && $mode != 'deps' && $submit != 'update')
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-			<!-- tr>
-				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['RUN_HOW']; ?></th>
-			</tr>
-			<tr>
-				<td class="<?php echo $row_class; ?>" colspan="4" align="center"><input type="radio" name="runas" value="now" checked="checked" /> <?php echo $_CLASS['core_user']->lang['RUN_AS_NOW']; ?><?php 
-	
-			if ($_CLASS['auth']->acl_get('a_events'))
-			{ 
-
-?> &nbsp;<input type="radio" name="runas" value="evt" /> <?php 
-	
-				echo $_CLASS['core_user']->lang['RUN_AS_EVT'];  
-			}
-			
-			if ($_CLASS['auth']->acl_get('a_cron'))
-			{
-
-?> &nbsp;<input type="radio" name="runas" value="crn" /> <?php 
-	
-				echo $_CLASS['core_user']->lang['RUN_AS_CRN']; 
-				
-			}
-
-?></td>
-			</tr -->
-<?php
-
-	}
-
-?>
-			<tr>
-				<td class="cat" colspan="<?php echo $colspan; ?>" align="center"><input class="btnmain" type="submit" name="submit_update" value="<?php echo $_CLASS['core_user']->lang['UPDATE']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="submit_cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" /><input type="hidden" name="ug_type" value="<?php echo $ug_type; ?>" /><?php echo $ug_hidden; ?><?php 
-
-	// Output forum id data
-	echo $s_forum_id;
-
-	// Output settings generated from other views
-	echo $settings_hidden;
-	unset($settings_hidden);
-	
-?></td>
-			</tr>
-		</table>
-
-		<br clear="all" />
-
-		<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-			<tr>
-				<th colspan="4"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?></th>
-			</tr>
-			<tr>
-				<td class="row1" colspan="4"><table width="100%" cellspacing="1" cellpadding="0" border="0">
-					<tr>
-						<td colspan="2" height="16"><span class="gensmall"><?php echo $_CLASS['core_user']->lang['PRESETS_EXPLAIN']; ?></span></td>
-					</tr>
-					<tr>
-						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['SELECT_PRESET']; ?>: </td>
-						<td><select name="presetoption"><option class="sep" value="-1"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><?php 
-
-	echo $preset_update_options;
-			
-		?></select></td>
-					</tr>
-					<tr>
-						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['PRESET_NAME']; ?>: </td>
-						<td><input type="text" name="presetname" maxlength="25" /> </td>
-					</tr>
-				</table></td>
-			</tr>
-			<tr>
-				<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" name="submit_presetsave" value="<?php echo $_CLASS['core_user']->lang['SAVE']; ?>" /> &nbsp;<input class="btnlite" type="submit" name="submit_presetdel" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /></td>
-			</tr>
-		</table></td>
-	</tr>
-</table></form>
-
-<?php
-
-}
-
-// Output page footer
-adm_page_footer();
-
-// ---------
-// FUNCTIONS
-//
-function update_foes()
-{
-	global $_CLASS;
-
-	$perms = array();
-	foreach ($_CLASS['auth']->acl_get_list(false, array('a_', 'm_'), false) as $forum_id => $forum_ary)
-	{
-		foreach ($forum_ary as $auth_option => $user_ary)
-		{
-			$perms += $user_ary;
-		}
-	}
-
-	if (sizeof($perms))
-	{
-		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
-			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-	unset($perms);
-}
-//
-// FUNCTIONS
-// ---------
-
+<?php
+// -------------------------------------------------------------
+//
+// $Id: admin_permissions.php,v 1.22 2004/05/26 18:55:25 acydburn Exp $
+//
+// FILENAME  : admin_permissions.php
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : ? 2001, 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// values need checks
+
+
+// Grab and set some basic parameters
+//
+// 'mode' determines what we're altering; administrators, users, deps, etc.
+// 'submit' is used to determine what we're doing ... special format
+$mode		= (isset($_REQUEST['mode'])) ? htmlspecialchars($_REQUEST['mode']) : '';
+
+// What mode are we running? So we can output the correct title, explanation
+// and set the sql_option_mode/acl check
+switch ($mode)
+{
+	case 'forum':
+		$l_title = $_CLASS['core_user']->lang['PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_auth';
+		$sql_option_mode = 'f';
+		break;
+
+	case 'mod':
+		$l_title = $_CLASS['core_user']->lang['MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'supermod':
+		$l_title = $_CLASS['core_user']->lang['SUPER_MODERATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
+		$which_acl = 'a_authmods';
+		$sql_option_mode = 'm';
+		break;
+
+	case 'admin':
+		$l_title = $_CLASS['core_user']->lang['ADMINISTRATORS'];
+		$l_title_explain = $_CLASS['core_user']->lang['ADMINISTRATORS_EXPLAIN'];
+		$which_acl = 'a_authadmins';
+		$sql_option_mode = 'a';
+		break;
+
+	case 'user':
+		$l_title = $_CLASS['core_user']->lang['USER_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['USER_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authusers';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'group':
+		$l_title = $_CLASS['core_user']->lang['GROUP_PERMISSIONS'];
+		$l_title_explain = $_CLASS['core_user']->lang['GROUP_PERMISSIONS_EXPLAIN'];
+		$which_acl = 'a_authgroups';
+		$sql_option_mode = 'u';
+		break;
+
+	case 'deps':
+		$l_title = $_CLASS['core_user']->lang['DEPENDENCIES'];
+		$l_title_explain = $_CLASS['core_user']->lang['DEPENDENCIES_EXPLAIN'];
+		$which_acl = 'a_authdeps';
+		break;
+}
+
+// Permission check
+if (!$_CLASS['auth']->acl_get($which_acl))
+{
+	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+}
+
+$submode	= (isset($_REQUEST['submode'])) ? htmlspecialchars($_REQUEST['submode']) : '';
+$which_mode = (!empty($submode) && $submode != $mode) ? $submode : $mode;
+$submit		= array_values(preg_grep('#^submit_(.*)$#i', array_keys($_REQUEST)));
+$submit		= (count($submit)) ? substr($submit[0], strpos($submit[0], '_') + 1) : '';
+
+// Submitted setting data
+//
+// 'auth_settings' contains the submitted option settings assigned to options, should be an 
+//   associative array with integer values
+$auth_settings = (isset($_POST['settings'])) ? $_POST['settings'] : '';
+
+
+// Forum, User or Group information
+//
+// 'ug_type' is either user or groups used mainly for forum/admin/mod permissions
+// 'ug_data' contains the list of usernames, user_id's or group_ids for the 'ug_type'
+// 'forum_id' contains the list of forums, 0 is used for "All forums", can be array or scalar
+$ug_type = (isset($_REQUEST['ug_type'])) ? htmlspecialchars($_REQUEST['ug_type']) : '';
+$ug_data = (isset($_POST['ug_data'])) ? $_POST['ug_data'] : '';
+
+if (isset($_REQUEST['f']))
+{
+	$forum_id = (is_array($_REQUEST['f'])) ? $_REQUEST['f'] : intval($_REQUEST['f']);
+}
+
+if (!isset($forum_id[$which_mode]))
+{
+	$forum_id[$which_mode][] = 0;
+}
+
+$sql_forum_id = implode(', ', array_map('intval', $forum_id[$which_mode]));
+
+// Generate list of forum id's
+$s_forum_id = '';
+
+foreach ($forum_id as $forum_submode => $forum_submode_ids)
+{
+	foreach ($forum_submode_ids as $submode_forum_id)
+	{
+		$s_forum_id .= '<input type="hidden" name="f[' . $forum_submode . '][]" value="' . $submode_forum_id . '" />';
+	}
+}
+unset($forum_submode_ids);
+unset($forum_submode);
+unset($submode_forum_id);
+
+
+// Instantiate a new auth admin object in readiness
+$auth_admin = new auth_admin();
+
+// Are we setting deps? If we are we need to re-run the mode match above for the
+// relevant 'new' mode
+if (!empty($submode))
+{
+	switch ($submode)
+	{
+		case 'forum':
+			$l_title_explain = $_CLASS['core_user']->lang['PERMISSIONS_EXPLAIN'];
+			$which_acl = 'a_auth';
+			$sql_option_mode = 'f';
+			break;
+
+		case 'mod':
+			$l_title_explain = $_CLASS['core_user']->lang['MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+
+		case 'supermod':
+			$l_title_explain = $_CLASS['core_user']->lang['SUPER_MODERATORS_EXPLAIN'];
+			$which_acl = 'a_authmods';
+			$sql_option_mode = 'm';
+			break;
+	}
+
+	// Permission check
+	if (!$_CLASS['auth']->acl_get($which_acl))
+	{
+		trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+	}
+}
+
+
+// Does user want to update anything? Check here to find out 
+// and act appropriately
+switch ($submit)
+{
+	case 'update':
+		if (!empty($auth_settings))
+		{
+			// Admin wants subforums to inherit permissions ... so add these
+			// forums to the list ... since inheritance is only available for
+			// forum and moderator primary modes we deal with '$forum_id[$mode]'
+			if (!empty($_POST['inherit']))
+			{
+				$forum_id[$mode] = array_merge($forum_id[$mode], array_map('intval', $_POST['inherit']));
+			}
+
+			// Update the permission set ... we loop through each auth setting array
+			foreach ($auth_settings as $auth_submode => $auth_setting)
+			{
+				// Are any entries * ? If so we need to remove them since they
+				// are options the user wishes to ignore
+
+				if (in_array('*', $auth_setting))
+				{
+					foreach ($auth_setting as $option => $setting)
+					{
+						if ($setting == '*')
+						{
+							unset($auth_setting[$option]);
+						}
+					}
+				}
+
+				if (!empty($auth_setting))
+				{
+					// Loop through all user/group ids
+					foreach ($ug_data as $id)
+					{
+						$auth_admin->acl_set($ug_type, $forum_id[$auth_submode], $id, $auth_setting);
+					}
+				}
+			}
+
+			// Do we need to recache the moderator lists? We do if the mode
+			// was mod or auth_settings['mod'] is a non-zero size array
+			if ($mode == 'mod' || !empty($auth_settings['mod']))
+			{
+				cache_moderators();
+			}
+
+			// Remove users who are now moderators or admins from everyones foes
+			// list
+			if ($mode == 'mod' || !empty($auth_settings['mod']) || $mode == 'admin' || !empty($auth_settings['admin']))
+			{
+				update_foes();
+			}
+
+			// Logging ... first grab user or groupnames ...
+			$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+			$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+			$result = $_CLASS['core_db']->query($sql);
+
+			$l_ug_list = '';
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . (($row['group_type'] == GROUP_SYSTEM) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$auth_submode = array_keys($auth_settings);
+			foreach ($auth_submode as $sub_mode)
+			{
+				if (!in_array(0, $forum_id[$sub_mode]))
+				{
+					// Grab the forum details if non-zero forum_id
+					$sql = 'SELECT forum_name  
+						FROM ' . FORUMS_FORUMS_TABLE . "
+						WHERE forum_id IN ($sql_forum_id)";
+					$result = $_CLASS['core_db']->query($sql);
+
+					$l_forum_list = '';
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_forum_list, $l_ug_list);
+				}
+				else
+				{
+					add_log('admin', 'LOG_ACL_' . strtoupper($sub_mode) . '_ADD', $l_ug_list);
+				}
+			}
+			unset($l_ug_list);
+		}
+		unset($auth_submode);
+		unset($auth_setting);
+
+		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
+	break;
+
+	case 'delete':
+		$sql = "SELECT auth_option_id
+			FROM " . FORUMS_ACL_OPTIONS_TABLE . "
+			WHERE auth_option LIKE '{$sql_option_mode}_%'";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$option_id_ary = array();
+			do
+			{
+				$option_id_ary[] = $row['auth_option_id'];
+			}
+			while($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+			foreach ($ug_data as $id)
+			{
+				$auth_admin->acl_delete($ug_type, $forum_id[$mode], $id, $option_id_ary);
+			}
+			unset($option_id_ary);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+
+		// Do we need to recache the moderator lists? We do if the mode
+		// was mod or auth_settings['mod'] is a non-zero size array
+		if ($mode == 'mod' || (isset($auth_settings['mod']) && !empty($auth_settings['mod'])))
+		{
+			cache_moderators();
+		}
+
+		// Logging ... first grab user or groupnames ...
+		$sql = ($ug_type == 'group') ? 'SELECT group_name as name, group_type FROM ' . GROUPS_TABLE . ' WHERE group_id' : 'SELECT username as name FROM ' . USERS_TABLE . ' WHERE user_id';
+		$sql .=  ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+
+		$l_ug_list = '';
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<span class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] . '</span>' : $row['name']);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+
+		// Grab the forum details if non-zero forum_id
+		if (!in_array(0, $forum_id[$which_mode]))
+		{
+			$sql = 'SELECT forum_name  
+				FROM ' . FORUMS_FORUMS_TABLE . "
+				WHERE forum_id IN ($sql_forum_id)";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$l_forum_list = '';
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$l_forum_list .= (($l_forum_list != '') ? ', ' : '') . $row['forum_name'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_forum_list, $l_ug_list);
+		}
+		else
+		{
+			add_log('admin', 'LOG_ACL_' . strtoupper($which_mode) . '_DEL', $l_ug_list);
+		}
+
+		trigger_error($_CLASS['core_user']->lang['AUTH_UPDATED']);
+	break;
+
+	case 'presetsave':
+		$holding_ary = array();
+	
+		$auth_setting = $auth_settings[(!empty($submode) ? $submode : $mode)];
+
+		foreach ($auth_setting as $option => $setting)
+		{
+			switch ($setting)
+			{
+				case ACL_YES:
+					$holding_ary['yes'][] = $option;
+				break;
+
+				case ACL_NO:
+					$holding_ary['no'][] = $option;
+				break;
+
+				case ACL_UNSET:
+					$holding_ary['unset'][] = $option;
+				break;
+			}
+		}
+
+		$sql = array(
+			'preset_user_id'=> (int) $_CLASS['core_user']->data['user_id'],
+			'preset_type'	=> $sql_option_mode,
+			'preset_data'	=> serialize($holding_ary)
+		);
+
+		if (!empty($_POST['presetname']))
+		{	
+			$sql['preset_name'] = htmlspecialchars($_POST['presetname'], ENT_QUOTES);
+		}
+		
+		if (!empty($sql['preset_name']) || $_POST['presetoption'] != -1)
+		{
+			$sql = ($_POST['presetoption'] == -1) ? 'INSERT INTO ' . FORUMS_ACL_PRESETS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql) : 'UPDATE ' . FORUMS_ACL_PRESETS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql) . ' WHERE preset_id =' . (int) $_POST['presetoption'];
+			$_CLASS['core_db']->query($sql);
+
+			add_log('admin', 'LOG_ACL_PRESET_ADD', $sql['preset_name']);
+		}
+		unset($sql, $option, $setting, $auth_setting);
+	break;
+
+	case 'presetdel':
+		if (!empty($_POST['presetoption']))
+		{
+			$sql = "SELECT preset_name 
+				FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+				WHERE preset_id = " . (int) $_POST['presetoption'];
+			$result = $_CLASS['core_db']->query($sql);
+
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($row)
+			{
+				$sql = "DELETE FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+					WHERE preset_id = " . (int) $_POST['presetoption'];
+				$_CLASS['core_db']->query($sql);
+	
+				add_log('admin', 'LOG_ACL_PRESET_DEL', $row['preset_name']);
+			}
+			unset($row);
+		}
+	break;
+}
+// End update
+
+
+// Output page header
+adm_page_header($l_title);
+
+
+// First potential form ... this is for selecting forums, users
+// or groups. 
+if (in_array($mode, array('user', 'group', 'forum', 'mod')) && empty($submit))
+{
+
+?>
+
+<h1><?php echo $l_title; ?></h1>
+
+<p><?php echo $l_title_explain ?></p>
+
+<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+<?php
+
+	// Mode specific markup
+	switch ($mode)
+	{
+		case 'forum':
+		case 'mod':
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="f[<?php echo $mode; ?>][]" multiple="true" size="7"><?php 
+	
+			echo make_forum_select(false, false, false);
+			
+?></select>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_usergroups" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_FORUM']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="forum" /><input type="hidden" name="action" value="usergroups" /></td>
+	</tr>
+<?php
+		
+			break;
+
+		case 'user':
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_USER']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center">&nbsp;<textarea cols="40" rows="4" name="ug_data[]"></textarea>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /></td>
+	</tr>
+<?php
+
+			break;
+
+		case 'group':
+			// Generate list of groups
+
+?>
+	<tr>
+		<th align="center"><?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?></th>
+	</tr>
+	<tr>
+		<td class="row1" align="center" valign="middle">&nbsp;<select style="width:280px" name="ug_data[]" multiple="true" size="7"><?php 
+
+			$sql = "SELECT group_id, group_name, group_type   
+				FROM " . GROUPS_TABLE . " 
+				ORDER BY group_type DESC";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$group_options = '';
+			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				do
+				{
+					echo '<option' . (($row['group_type'] == GROUP_SPECIAL) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (($row['group_type'] == GROUP_SPECIAL) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+				}
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+			}
+			$_CLASS['core_db']->free_result($result);
+			
+?></select>&nbsp;</td>
+	</tr>
+	<tr>
+		<td class="cat" align="center"><input type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['LOOK_UP_GROUP']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /></td>
+	</tr>
+<?php
+
+		break;
+
+	}
+
+?>
+</table></form>
+
+<?php
+
+}
+// End user, group or forum selection
+
+
+// Second possible form, this lists the currently enabled
+// users/groups for the given mode
+if ((in_array($submit, array('usergroups', 'delete', 'cancel'))) || (!strstr($submit, 'options') && empty($submode) && in_array($mode, array('admin', 'supermod'))))
+{
+
+?>
+
+<h1><?php echo $l_title; ?></h1>
+
+<p><?php echo $l_title_explain; ?></p>
+
+<table width="100%" cellspacing="0" cellpadding="0" border="0">
+	<tr>
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['MANAGE_USERS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php
+			
+	$sql = "SELECT u.user_id, u.username
+		FROM " . USERS_TABLE . " u, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
+		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
+			AND a.auth_option_id = o.auth_option_id
+			AND a.forum_id IN ($sql_forum_id)
+			AND u.user_id = a.user_id
+		ORDER BY u.username, u.user_reg_date ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$users = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+		
+?></select></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+
+		<td align="center"><form method="post" name="admingroups" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+		<tr>
+			<th><?php echo $_CLASS['core_user']->lang['MANAGE_GROUPS']; ?></th>
+		</tr>
+		<tr>
+			<td class="row1" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple" size="5"><?php 
+	
+	$sql = "SELECT DISTINCT g.group_id, g.group_name, g.group_type 
+		FROM " . GROUPS_TABLE . " g, " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o
+		WHERE o.auth_option LIKE '" . $sql_option_mode . "_%'
+			AND a.forum_id IN ($sql_forum_id)
+			AND a.auth_option_id = o.auth_option_id
+			AND g.group_id = a.group_id
+		ORDER BY g.group_type DESC, g.group_name ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$groups = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' class="blue"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+
+?></select></td>
+		</tr>
+		<tr>
+			<td class="cat" align="center"><input class="btnlite" type="submit" name="submit_delete" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /> &nbsp; <input class="btnlite" type="submit" name="submit_edit_options" value="<?php echo $_CLASS['core_user']->lang['SET_OPTIONS']; ?>" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
+		</tr>
+	</table></form></td>
+
+	</tr>
+	<tr>
+
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['ADD_USERS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" align="center"><textarea style="height:60px" cols="40" rows="4" name="ug_data[]"></textarea></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" />&nbsp; <input type="submit" value="<?php echo $_CLASS['core_user']->lang['FIND_USERNAME']; ?>" class="btnlite" onclick="window.open('<?php echo generate_link('Members_List&mode=searchuser&form=2&amp;field=entries'); ?>', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;" /><input type="hidden" name="ug_type" value="user" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+
+		<td><form method="post" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode, array('admin' => true)); ?>"><table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th><?php echo $_CLASS['core_user']->lang['ADD_GROUPS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" style="height: 100%" align="center"><select style="width:280px" name="ug_data[]" multiple="multiple"  size="5"><?php 
+			
+	$sql = "SELECT group_id, group_name, group_type 
+		FROM " . GROUPS_TABLE . "
+		ORDER BY group_type DESC, group_name";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$group_list = '';
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		echo '<option' . (($row['group_type'] == GROUP_SYSTEM) ? ' style="color: #006699;"' : '') . ' value="' . $row['group_id'] . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</option>';
+	}
+	$_CLASS['core_db']->free_result($result);
+		
+?></select></td>
+			</tr>
+			<tr>
+				<td class="cat" align="center"> <input type="submit" name="submit_add_options" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" class="btnmain" />&nbsp; <input type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" class="btnlite" /><input type="hidden" name="ug_type" value="group" /><?php echo $s_forum_id; ?></td>
+			</tr>
+		</table></form></td>
+	</tr>
+</table>
+
+<?php
+
+}
+// End user and group acl selections
+
+
+
+
+
+
+// Third possible form, this is the major section of this script. It
+// handles the entry of permission options for all situations
+if (in_array($submit, array('add_options', 'edit_options', 'presetsave', 'presetdel', 'update')) || !empty($submode))
+{
+
+	// Did the user specify any users or groups?
+	if (empty($ug_data))
+	{
+		$l_message = ($ug_type == 'user') ? 'NO_USER' : 'NO_GROUP';
+		trigger_error($_CLASS['core_user']->lang[$l_message]);
+	}
+
+
+	$forum_list = '';
+	// Grab the forum details if non-zero forum_id
+	if (!in_array(0, $forum_id[$which_mode]))
+	{
+		$sql = 'SELECT forum_id, forum_name, parent_id  
+			FROM ' . FORUMS_FORUMS_TABLE . "
+			WHERE forum_id IN ($sql_forum_id)";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
+		}
+
+		// If we have more than one forum we want a list of all their names
+		// so loop through all results. We don't need all the data though 
+		// since cascading/inheritance is only applicable if a single forum
+		// was selected
+		$forum_data = $row;
+
+		do
+		{
+			$forum_list .= (($forum_list != '') ? ', ' : '') . '<b>' . $row['forum_name'] . '</b>';
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+		$_CLASS['core_db']->free_result($result);
+	}
+
+
+	// Grab relevant user or group information
+	$ug_ids = $l_ug_list = $ug_hidden = $l_no_error = '';
+// need some work ( array_mapping()) blaa blaa
+	switch ($ug_type)
+	{
+		case 'user':
+			$l_no_error = $_CLASS['core_user']->lang['NO_USER'];
+			$sql = 'SELECT user_id AS id, username AS name 
+				FROM ' . USERS_TABLE . ' 
+				WHERE ';
+			$sql .= ($submit == 'add_options') ? " username IN ('" . implode("', '", $_CLASS['core_db']->escape_array(array_unique(explode("\n", modify_lines($ug_data[0], "\n"))))) . "')" : ' user_id ' . ((is_array($ug_data)) ? 'IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : '= ' . (int) $ug_data);
+		break;
+
+		case 'group':
+			$l_no_error = $_CLASS['core_user']->lang['NO_GROUP'];
+			$sql = 'SELECT group_id AS id, group_name AS name, group_type  
+				FROM ' . GROUPS_TABLE . '
+				WHERE group_id';
+			$sql .= (is_array($ug_data)) ? ' IN (' . implode(', ', array_map('intval', $ug_data)) . ')' : ' = ' . (int) $ug_data;
+		break;
+	}
+	$result = $_CLASS['core_db']->query($sql);
+
+	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		trigger_error($l_no_error);
+	}
+	unset($l_no_error);
+
+	// Store the user_ids and names for later use
+	do 
+	{
+		$l_ug_list .= (($l_ug_list != '') ? ', ' : '') . ((isset($row['group_type']) && $row['group_type'] == GROUP_SPECIAL) ? '<b class="blue">' . $_CLASS['core_user']->lang['G_' . $row['name']] : '<b>' . $row['name']) . '</b>';
+		$ug_ids .= (($ug_ids != '') ? ', ' : '') . $row['id'];
+		$ug_hidden .= '<input type="hidden" name="ug_data[]" value="' . $row['id'] . '" />';
+	}
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	$_CLASS['core_db']->free_result($result);
+
+
+	// Grab the list of options ... if we're in deps mode we want all options, 
+	// else we skip the master options
+	$sql_limit_option = ($mode == 'deps') ? '' : "AND auth_option <> '" . $sql_option_mode . "_'";
+	$sql = "SELECT auth_option_id, auth_option
+		FROM " . FORUMS_ACL_OPTIONS_TABLE . "
+		WHERE auth_option LIKE '" . $sql_option_mode . "_%' 
+			$sql_limit_option";
+	$result = $_CLASS['core_db']->query($sql);
+
+	$auth_options = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$auth_presets_compare[] = $row['auth_option'];
+		$auth_options[] = $row;
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	unset($sql_limit_option);
+
+
+	// Now we'll build a list of preset options ...
+	$preset_options = $preset_js = $preset_update_options = '';
+
+	// Do we have a parent forum? If so offer option to inherit from that
+	if ($forum_data['parent_id'] != 0)
+	{
+		$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+		 
+		$sql = "SELECT o.auth_option, a.auth_setting
+					FROM " . FORUMS_ACL_TABLE . " a, " . FORUMS_ACL_OPTIONS_TABLE . " o 
+					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
+						AND a.auth_option_id = o.auth_option_id AND a.forum_id = " . $forum_data['parent_id'] . '
+						AND a.'.(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)";
+
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			do
+			{
+				switch ($row['auth_setting'])
+				{
+					case ACL_YES:
+						$holding['yes'][] = $row['auth_option'];
+					break;
+
+					case ACL_NO:
+						$holding['no'][] = $row['auth_option'];
+					break;
+				}
+			}
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_options .= '<option value="preset_0">' . $_CLASS['core_user']->lang['INHERIT_PARENT'] . '</option>';
+			$preset_js .= "\tpresets['preset_0'] = new Array();" . "\n";
+			$preset_js .= "\tpresets['preset_0'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
+
+		}
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	$holding['yes'] = $holding['no'] = $holding['unset'] = '';
+
+	// Look for custom presets
+	$sql = "SELECT preset_id, preset_name, preset_data  
+		FROM " . FORUMS_ACL_PRESETS_TABLE . " 
+		WHERE preset_type = '" . (($mode == 'deps') ? 'f' : $sql_option_mode) . "' 
+		ORDER BY preset_id ASC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		do
+		{
+			$preset_update_options .= '<option value="' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
+			$preset_options .= '<option value="preset_' . $row['preset_id'] . '">' . $row['preset_name'] . '</option>';
+
+			$holding = unserialize($row['preset_data']);
+			$holding['unset'] = array_diff($auth_presets_compare, $holding['yes'], $holding['no']);
+
+			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new Array();" . "\n";
+			$preset_js .= "\tpresets['preset_" . $row['preset_id'] . "'] = new preset_obj('" . implode(', ', $holding['yes']) . "', '" . implode(', ', $holding['no']) . "', '" . implode(', ', $holding['unset']) . "');\n";
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	unset($holding, $auth_presets_compare);
+
+
+	// If we aren't looking @ deps then we try and grab existing sessions for
+	// the given forum and user/group
+	if (!is_array($auth_settings) || empty($auth_settings[$which_mode]))
+	{
+		if ($which_mode == $mode)
+		{
+			$sql = 'SELECT o.auth_option, MIN(a.auth_setting) AS min_auth_setting 
+					FROM '. FORUMS_ACL_TABLE .' a, ' . FORUMS_ACL_OPTIONS_TABLE . " o 
+					WHERE o.auth_option LIKE '" . $sql_option_mode . "_%' 
+						AND a.auth_option_id = o.auth_option_id 
+						AND a.forum_id IN ($sql_forum_id) 
+						AND a.".(($ug_type == 'group') ? 'group_id' : 'user_id')." IN ($ug_ids)
+					GROUP BY o.auth_option";
+			$result = $_CLASS['core_db']->query($sql);
+
+			$auth_settings[$which_mode] = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$auth_settings[$which_mode][$row['auth_option']] = $row['min_auth_setting'];
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+		else
+		{
+			// We're looking at a view ... so we'll set all options to unset
+			// We could be a little more clever here but the "safe side" looks
+			// better right now
+			$auth_settings[$which_mode] = array();
+			foreach ($auth_options as $option)
+			{
+				$auth_settings[$which_mode][$option['auth_option']] = '*';
+			}
+			unset($option);
+		}
+	}
+
+	$view_options = '';
+	// Should we display a dropdown for views?
+	if (in_array($mode, array('admin', 'supermod', 'mod')))
+	{
+		$view_options .= '<option value="">' . $_CLASS['core_user']->lang['SELECT_VIEW'] . '</option>';
+		$view_ary = array(
+			'admin'		=> array('admin' => 'a_', 'forum' => 'a_auth', 'supermod' => 'a_authmods', 'mod' => 'a_authmods'),
+			'supermod'	=> array('supermod' => 'a_authmods', 'mod' => 'a_authmods', 'forum' => 'a_auth'), 
+			'mod'		=> array('mod' => 'a_authmods', 'forum' => 'a_auth')
+		);
+
+		foreach ($view_ary[$mode] as $which_submode => $which_acl)
+		{
+			if ($_CLASS['auth']->acl_get($which_acl))
+			{
+				$view_options .= '<option value="' . $which_submode . '"' . (($which_submode == $which_mode) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ACL_VIEW_' . strtoupper($which_submode)] . '</option>';
+			}
+
+		}
+		unset($view_ary);
+	}
+
+	$settings_hidden = '';
+	// Output original settings ... needed when we jump views
+	foreach ($auth_settings as $auth_submode => $auth_submode_settings)
+	{
+		if ($auth_submode != $which_mode)
+		{
+			foreach ($auth_submode_settings as $submode_option => $submode_setting)
+			{
+				$settings_hidden .= ($submode_setting != '*') ? '<input type="hidden" name="settings[' . $auth_submode . '][' . $submode_option . ']" value="' . $submode_setting . '" />' : '';
+			}
+		}
+	}
+	unset($auth_submode, $auth_submode_settings, $auth_submode_option, $auth_submode_setting);
+
+?>
+
+<script language="Javascript" type="text/javascript">
+<!--
+
+	var presets = new Array();
+<?php
+
+	echo $preset_js;
+
+?>
+
+	function preset_obj(yes, no, unset)
+	{
+		this.yes = yes;
+		this.no = no;
+		this.unset = unset;
+	}
+
+	function use_preset(option)
+	{
+		if (option)
+		{
+			document.acl.set.selectedIndex = 0;
+			for (i = 0; i < document.acl.length; i++)
+			{
+				var elem = document.acl.elements[i];
+				if (elem.name.indexOf('settings') == 0)
+				{
+					switch (option)
+					{
+						case 'all_yes':
+							if (elem.value == <?php echo ACL_YES; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_no':
+							if (elem.value == <?php echo ACL_NO; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_unset':
+							if (elem.value == <?php echo ACL_UNSET; ?>)
+								elem.checked = true;
+							break;
+
+						case 'all_ignore':
+							if (elem.value == '*')
+								elem.checked = true;
+							break;
+
+						default:
+							option_start = elem.name.search(/\[(\w+?)\]$/);
+							option_name = elem.name.substr(option_start + 1, elem.name.length - option_start - 2);
+
+							if (presets[option].yes.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_YES; ?>)
+								elem.checked = true;
+							else if (presets[option].no.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_NO; ?>)
+								elem.checked = true;
+							else if (presets[option].unset.indexOf(option_name + ',') != -1 && elem.value == <?php echo ACL_UNSET; ?>)
+								elem.checked = true;
+							break;
+					}
+				}
+			}
+		}
+	}
+
+	function marklist(match, status)
+	{
+		for (i = 0; i < document.acl.length; i++)
+		{
+			if (document.acl.elements[i].name.indexOf(match) == 0)
+				document.acl.elements[i].checked = status;
+		}
+	}
+
+	function open_win(url, width, height)
+	{
+		aclwin = window.open(url, '_phpbbacl', 'HEIGHT=' + height + ',resizable=yes, scrollbars=yes,WIDTH=' + width);
+		if (window.focus)
+			aclwin.focus();
+	}
+//-->
+</script>
+
+<p><?php echo $_CLASS['core_user']->lang['ACL_EXPLAIN']; ?></p>
+
+<h1><?php echo $l_title; ?></h1>
+
+<?php
+
+	// Do we have a list of forums? If so, output them ... but only
+	// if we're looking at the primary view or mode ... submodes
+	// output their own list of forums as and where applicable so this
+	// is unnecessary
+	if ($forum_list != '' && $which_mode == $mode)
+	{
+		$l_selected_forums = (count($forum_id[$which_mode]) === 1) ? 'SELECTED_FORUM' : 'SELECTED_FORUMS';
+
+		echo '<p>' . $_CLASS['core_user']->lang[$l_selected_forums] . ': ' . $forum_list . '</p>';
+
+		unset($forum_list);
+		unset($l_selected_forums);
+	}
+
+	// Now output the list of users or groups ... these will always exist
+	$l_selected_users = ($ug_type == 'user') ? ((count($ug_data) === 1) ? 'SELECTED_USER' : 'SELECTED_USERS') : ((count($ug_data) === 1) ? 'SELECTED_GROUP' : 'SELECTED_GROUPS'); 
+
+	echo '<p>' . $_CLASS['core_user']->lang[$l_selected_users] . ': ' . $l_ug_list . '</p>';
+
+	unset($l_selected_users);
+	unset($ug_data);
+
+?>
+
+<p><?php echo $l_title_explain; ?></p>
+
+<?php
+
+	if ($settings_hidden != '')
+	{
+
+?>
+
+<h2 style="color:red"><?php echo $_CLASS['core_user']->lang['WARNING']; ?></h2>
+
+<p><?php echo $_CLASS['core_user']->lang['WARNING_EXPLAIN']; ?></p>
+
+<?php
+
+	}
+
+?>
+
+<form method="post" name="acl" action="<?php echo generate_link('Forums&amp;file=admin_permissions&amp;mode='.$mode.'&amp;submode='.$submode, array('admin' => true)); ?>"><table cellspacing="2" cellpadding="0" border="0" align="center">
+<?php
+
+	// This is the main listing of options
+
+	// We output this for both deps and when update is requested where
+	// deps exist
+	if (($mode == 'admin' || $mode == 'supermod') && in_array($submode, array('forum', 'mod')))
+	{
+
+?>
+	<tr>
+		<td colspan="2" align="right"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0">
+			<tr>
+				<th colspan="2"><?php echo $_CLASS['core_user']->lang['SELECT_FORUM']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="2"><?php echo $_CLASS['core_user']->lang['WILL_SET_OPTIONS']; ?>:</th>
+			</tr>
+			<tr>
+				<td class="row2"><select style="width:100%" name="f[<?php echo $which_mode; ?>][]" multiple="7"><?php 
+		
+		echo make_forum_select($forum_id[$which_mode], false, true); 
+		
+?></select></td>
+			</tr>
+		</table><br /></td>
+	</tr>
+<?php
+
+	}
+	// End deps output
+
+?>
+	<tr>
+		<td align="left"><?php
+	
+	if ($view_options != '')
+	{
+	
+?><select name="submode" onchange="if (this.options[this.selectedIndex].value != '') this.form.submit();"><?php echo $view_options; ?></select><?php
+	
+	}
+	
+?></td>
+		<td align="right"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?>: <select name="set" onchange="use_preset(this.options[this.selectedIndex].value);"><option class="sep"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><option value="all_yes"><?php echo $_CLASS['core_user']->lang['ALL_YES']; ?></option><option value="all_no"><?php echo $_CLASS['core_user']->lang['ALL_NO']; ?></option><option value="all_unset"><?php echo $_CLASS['core_user']->lang['ALL_UNSET']; ?></option><?php 
+
+	$colspan = 4;
+	if ($which_mode != $mode)
+	{
+		$colspan = 5;
+		echo '<option value="all_ignore">' . $_CLASS['core_user']->lang['ALL_IGNORE'] . '</option>';
+	}
+
+	// Output user preset options ... if any
+	echo ($preset_options) ? '<option class="sep">' . $_CLASS['core_user']->lang['USER_PRESETS'] . ' -&gt;' . '</option>' . $preset_options : ''; 
+
+?></select></td>
+	</tr>
+	<tr>
+		<td colspan="2"><table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th>&nbsp;<?php echo $_CLASS['core_user']->lang['OPTION']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['YES']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['UNSET']; ?>&nbsp;</th>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['NO']; ?>&nbsp;</th>
+<?php
+
+	if ($which_mode != $mode)
+	{
+
+?>
+				<th width="50">&nbsp;<?php echo $_CLASS['core_user']->lang['IGNORE']; ?>&nbsp;</th>
+<?php
+
+	}
+
+?>
+			</tr>
+<?php
+
+	$row_class = 'row2';
+
+	$count = count($auth_options);
+	for ($i = 0; $i < $count; $i++)
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+		// Try and output correct language strings, else output prettyfied auth_option
+		$l_auth_option = (!empty($_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']])) ? $_CLASS['core_user']->lang['acl_' . $auth_options[$i]['auth_option']] : ucfirst(preg_replace('#.*?_#', '', $auth_options[$i]['auth_option']));
+		$s_auth_option = '[' . $which_mode . '][' . $auth_options[$i]['auth_option'] . ']';
+		
+		// Which option should we select?
+		$selected_yes = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_YES) ? ' checked="checked"' : '';
+		$selected_no = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_NO) ? ' checked="checked"' : '';
+		$selected_unset = (!isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) || $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == ACL_UNSET) ? ' checked="checked"' : '';
+
+?>
+			<tr>
+				<td class="<?php echo $row_class; ?>" nowrap="nowrap"><?php echo $l_auth_option; ?>&nbsp;</td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_YES; ?>"<?php echo $selected_yes; ?> /></td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_UNSET; ?>"<?php echo $selected_unset; ?> /></td>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="<?php echo ACL_NO; ?>"<?php echo $selected_no; ?> /></td>
+<?php
+
+		if ($which_mode != $mode)
+		{
+			$selected_ignore = (isset($auth_settings[$which_mode][$auth_options[$i]['auth_option']]) && $auth_settings[$which_mode][$auth_options[$i]['auth_option']] == '*') ? ' checked="checked"' : '';
+
+?>
+				<td class="<?php echo $row_class; ?>" align="center"><input type="radio" name="settings<?php echo $s_auth_option ;?>" value="*"<?php echo $selected_ignore; ?> /></td>
+<?php
+
+		}
+
+?>
+			</tr>
+<?php
+
+	}
+
+
+	// If we're setting forum or moderator options and a single forum has
+	// been selected then look to see if any subforums exist. If they do
+	// give user the option of cascading permissions to them
+	if (($mode == 'forum' || $mode == 'mod') && empty($submode) && count($forum_id[$which_mode]) === 1)
+	{
+		$children = get_forum_branch($forum_id[$which_mode][0], 'children', 'descending', false);
+
+		if (!empty($children))
+		{
+
+?>
+			<tr>
+				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="<?php echo $colspan; ?>"><table width="100%" cellspacing="1" cellpadding="0" border="0">
+					<tr>
+						<td class="gensmall" colspan="4" height="16" align="center"><?php echo $_CLASS['core_user']->lang['ACL_SUBFORUMS_EXPLAIN']; ?></td>
+					</tr>
+<?php
+
+			foreach ($children as $row)
+			{
+
+?>
+					<tr>
+						<td><input type="checkbox" name="inherit[]" value="<?php echo $row['forum_id']; ?>" /> <?php echo $row['forum_name']; ?></td>
+					</tr>
+<?php
+
+			}
+
+?>
+					<tr>
+						<td height="16" align="center"><a class="gensmall" href="javascript:marklist('inherit', true);"><?php echo $_CLASS['core_user']->lang['MARK_ALL']; ?></a> :: <a href="javascript:marklist('inherit', false);" class="gensmall"><?php echo $_CLASS['core_user']->lang['UNMARK_ALL']; ?></a></td>
+					</tr>
+				</table></td>
+			</tr>
+<?php
+
+		}
+	}
+
+	// Display event/cron radio buttons
+	if ($_CLASS['auth']->acl_gets('a_events', 'a_cron') && $mode != 'deps' && $submit != 'update')
+	{
+		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
+
+?>
+			<!-- tr>
+				<th colspan="<?php echo $colspan; ?>"><?php echo $_CLASS['core_user']->lang['RUN_HOW']; ?></th>
+			</tr>
+			<tr>
+				<td class="<?php echo $row_class; ?>" colspan="4" align="center"><input type="radio" name="runas" value="now" checked="checked" /> <?php echo $_CLASS['core_user']->lang['RUN_AS_NOW']; ?><?php 
+	
+			if ($_CLASS['auth']->acl_get('a_events'))
+			{ 
+
+?> &nbsp;<input type="radio" name="runas" value="evt" /> <?php 
+	
+				echo $_CLASS['core_user']->lang['RUN_AS_EVT'];  
+			}
+			
+			if ($_CLASS['auth']->acl_get('a_cron'))
+			{
+
+?> &nbsp;<input type="radio" name="runas" value="crn" /> <?php 
+	
+				echo $_CLASS['core_user']->lang['RUN_AS_CRN']; 
+				
+			}
+
+?></td>
+			</tr -->
+<?php
+
+	}
+
+?>
+			<tr>
+				<td class="cat" colspan="<?php echo $colspan; ?>" align="center"><input class="btnmain" type="submit" name="submit_update" value="<?php echo $_CLASS['core_user']->lang['UPDATE']; ?>" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="submit_cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" /><input type="hidden" name="ug_type" value="<?php echo $ug_type; ?>" /><?php echo $ug_hidden; ?><?php 
+
+	// Output forum id data
+	echo $s_forum_id;
+
+	// Output settings generated from other views
+	echo $settings_hidden;
+	unset($settings_hidden);
+	
+?></td>
+			</tr>
+		</table>
+
+		<br clear="all" />
+
+		<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<tr>
+				<th colspan="4"><?php echo $_CLASS['core_user']->lang['PRESETS']; ?></th>
+			</tr>
+			<tr>
+				<td class="row1" colspan="4"><table width="100%" cellspacing="1" cellpadding="0" border="0">
+					<tr>
+						<td colspan="2" height="16"><span class="gensmall"><?php echo $_CLASS['core_user']->lang['PRESETS_EXPLAIN']; ?></span></td>
+					</tr>
+					<tr>
+						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['SELECT_PRESET']; ?>: </td>
+						<td><select name="presetoption"><option class="sep" value="-1"><?php echo $_CLASS['core_user']->lang['SELECT'] . ' -&gt;'; ?></option><?php 
+
+	echo $preset_update_options;
+			
+		?></select></td>
+					</tr>
+					<tr>
+						<td nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['PRESET_NAME']; ?>: </td>
+						<td><input type="text" name="presetname" maxlength="25" /> </td>
+					</tr>
+				</table></td>
+			</tr>
+			<tr>
+				<td class="cat" colspan="4" align="center"><input class="btnlite" type="submit" name="submit_presetsave" value="<?php echo $_CLASS['core_user']->lang['SAVE']; ?>" /> &nbsp;<input class="btnlite" type="submit" name="submit_presetdel" value="<?php echo $_CLASS['core_user']->lang['DELETE']; ?>" /></td>
+			</tr>
+		</table></td>
+	</tr>
+</table></form>
+
+<?php
+
+}
+
+// Output page footer
+adm_page_footer();
+
+// ---------
+// FUNCTIONS
+//
+function update_foes()
+{
+	global $_CLASS;
+
+	$perms = array();
+	foreach ($_CLASS['auth']->acl_get_list(false, array('a_', 'm_'), false) as $forum_id => $forum_ary)
+	{
+		foreach ($forum_ary as $auth_option => $user_ary)
+		{
+			$perms += $user_ary;
+		}
+	}
+
+	if (!empty($perms))
+	{
+		$sql = 'DELETE FROM ' . ZEBRA_TABLE . ' 
+			WHERE zebra_id IN (' . implode(', ', $perms) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+	unset($perms);
+}
+//
+// FUNCTIONS
+// ---------
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/functions_posting.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -826,7 +826,7 @@
 		$topic_title = $subject;
 
 		$notify_type = 'topic';
-		$template = 'notify_topic'; //forum_notify
+		$template = 'notify_topic'; //notify_forum
 		$where = "(w.forum_id = $forum_id OR w.topic_id = $topic_id)";
 	}
 	else
@@ -857,11 +857,11 @@
 		$ignore_array[$user['user_id']] = $user['user_id'];
 
 		$holding[$user['user_id']] = $user;
-		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' && $user['forum_id']) ? 'forum_notify' : $template;
+		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' && $user['forum_id']) ? 'notify_forum' : $template;
 		
 		if ($notify_type == 'topic' && $user['forum_id'])
 		{
-			$holding[$user['user_id']]['template'] = 'forum_notify';
+			$holding[$user['user_id']]['template'] = 'notify_forum';
 			$holding[$user['user_id']]['update'] = 'forum';
 		}
 		else

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -967,7 +967,7 @@
 
 		foreach (array('u', 'g') as $type)
 		{
-			if (sizeof($$type))
+			if (!empty($$type))
 			{
 				foreach ($$type as $id)
 				{
@@ -999,7 +999,7 @@
 		}
 
 		$address = array();
-		if (sizeof($u))
+		if (!empty($u))
 		{
 			$sql = 'SELECT user_id, username, user_colour 
 				FROM ' . USERS_TABLE . '
@@ -1024,7 +1024,7 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 
-		if (sizeof($g))
+		if (!empty($g))
 		{
 			if ($plaintext)
 			{
@@ -1070,7 +1070,7 @@
 			}
 		}
 
-		if (sizeof($address) && !$plaintext)
+		if (!empty($address) && !$plaintext)
 		{
 			$_CLASS['core_template']->assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
 
@@ -1185,6 +1185,9 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 
+		$recipients = array_unique($recipients);
+		unset($recipients[ANONYMOUS]);
+
 		if (empty($recipients))
 		{
 			trigger_error('NO_RECIPIENT');
@@ -1221,7 +1224,7 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
 				'to_address'		=> implode(':', $to),
@@ -1241,7 +1244,7 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid']
 			);
@@ -1388,6 +1391,8 @@
 	// Send Notifications
 	if ($mode !== 'edit')
 	{
+	//unset($recipients[$_CLASS['core_user']->data['user_id']]);
+
 		pm_notification($mode, $_CLASS['core_user']->data['username'], $recipients, $subject, $data['message']);
 	}
 
@@ -1397,93 +1402,66 @@
 // PM Notification
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
-	global $_CLASS, $config;
-return;
-	$subject = censor_text($subject);
-	
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
+	global $_CLASS, $_CORE_CONFIG, $config;
 
-	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if (empty($recipients))
 	{
-		if (isset($row['ban_userid']))
-		{
-			unset($recipients[$row['ban_userid']]);
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	if (!sizeof($recipients))
-	{
 		return;
 	}
 
-	$recipient_list = implode(', ', array_keys($recipients));
+	$subject = censor_text($subject);
 
-	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
+	$recipient_list = implode(', ', array_unique(array_keys($recipients)));
+
+	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type
 		FROM ' . USERS_TABLE . "
 		WHERE user_id IN ($recipient_list)";
 	$result = $_CLASS['core_db']->query($sql);
 
-	$msg_list_ary = array();
+	$user_list = array();
+// add lang support
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		if ($row['user_notify_pm'] == 1 && trim($row['user_email']))
+		if ($row['user_notify_pm'])
 		{
-			$msg_list_ary[] = array(
-				'method'	=> $row['user_notify_type'],
-				'email'		=> $row['user_email'],
-				'jabber'	=> $row['user_jabber'],
-				'name'		=> $row['username'],
-				'lang'		=> $row['user_lang']
-			);
+			$user_list[] = $row;
 		}
 	}
 	$_CLASS['core_db']->free_result($result);
 	
-	if (!sizeof($msg_list_ary))
+	if (empty($user_list))
 	{
 		return;
 	}
 
-	require_once('includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-	foreach ($msg_list_ary as $pos => $addr)
+	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	$mailer = new core_mailer;
+
+	$count = count($user_list);
+	for ($i = 0; $i < $count; $i++)
 	{
-		$messenger->template('privmsg_notify', $addr['lang']);
+		$mailer->to($user_list[$i]['user_email'], $user_list[$i]['username']);
+	}
 
-		$messenger->replyto($config['board_email']);
-		$messenger->to($addr['email'], $addr['name']);
-		$messenger->im($addr['jabber'], $addr['name']);
+	$mailer->subject('New Private Message has arrived');
 
-		$messenger->assign_vars(array(
-			'EMAIL_SIG'		=> $email_sig,
-			'SITENAME'		=> $config['sitename'],
-			'SUBJECT'		=> $subject,
-			'AUTHOR_NAME'	=> $author,
-			'USERNAME'		=> $addr['name'],
+	$_CLASS['core_template']->assign_array(array(
+		'EMAIL_SIG'		=> $email_sig,
+		'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
+		'SUBJECT'		=> $subject,
+		'AUTHOR_NAME'	=> $author,
 
-			'U_INBOX'		=> generate_link('Control_Panel&amp;i=pm&mode=unread', array('full' => true, 'sid' => true)))
-		);
+		'LINK_INBOX'		=> generate_link('Control_Panel&i=pm&mode=unread', array('full' => true, 'sid' => true))
+	));
 
-		$messenger->send($addr['method']);
-		$messenger->reset();
-	}
-	unset($msg_list_ary);
+	$mailer->message = trim($_CLASS['core_template']->display('email/control_panel/pm_notify.txt', true));
 
-	if ($messenger->queue)
+	if (!$mailer->send())
 	{
-		$messenger->save_queue();
+		//echo $mailer->error;
 	}
-
-	unset($messenger);
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/functions.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -605,7 +605,7 @@
 	$_CLASS['core_auth']->do_login($login_options, $template);
 }
 
-function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $cache = true)
+function set_core_config($section, $name, $value, $clear_cache = true, $auto_add = false, $type = 'string', $cache = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -620,6 +620,7 @@
 			'config_section'=> (string) $section,
 			'config_name'	=> (string) $name,
 			'config_value'	=> (string) $value,
+			'config_type'	=> (string) $type,
 			'config_cache'	=> (int) $cache,
 		);
 

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/functions_user.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -140,7 +140,7 @@
 	return $user_id;
 }
 
-function user_add(&$data)
+function user_add(&$data, $group_add = true)
 {
 	global $_CLASS, $_CORE_CONFIG;
 
@@ -151,6 +151,9 @@
 		'user_new_privmsg'		=> 0,
 		'user_allow_pm'			=> 1,
 		'user_allow_email'		=> 1,
+		'user_posts'			=> 0,
+		'user_new_privmsg'		=> 0,
+		'user_unread_privmsg'	=> 0,
 	);
 
 	$default_data['user_data'] = serialize(array(
@@ -178,13 +181,16 @@
 
 	$data['user_id'] = $_CLASS['core_db']->insert_id(USERS_TABLE, 'user_id');
 
-	$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-		'group_id'		=> (int) $data['user_group'],
-		'user_id'		=> (int) $data['user_id'],
-		'member_status'	=> $data['user_status']
-	));
-	
-	$_CLASS['core_db']->query($sql);
+	if ($group_add)
+	{
+		$sql = 'INSERT INTO ' . USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+			'group_id'		=> (int) $data['user_group'],
+			'user_id'		=> (int) $data['user_id'],
+			'member_status'	=> $data['user_status']
+		));
+		
+		$_CLASS['core_db']->query($sql);
+	}
 
 	$_CLASS['core_db']->transaction('commit');
 }

Modified: cms/trunk/includes/mailer.php
===================================================================
--- cms/trunk/includes/mailer.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/mailer.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -43,40 +43,40 @@
 	function to($address, $name = '')
 	{
 		$this->address_arrays['to'][] = array(
-				'address'	=> $address,
-				'name'		=> $name
+				'address'	=> trim($address),
+				'name'		=> trim($name)
 			);
 	}
 
 	function cc($address, $name = '')
 	{
 		$this->address_arrays['cc'][] = array(
-				'address'	=> $address,
-				'name'		=> $name
+				'address'	=> trim($address),
+				'name'		=> trim($name)
 			);
 	}
 
 	function bcc($address, $name = '')
 	{
 		$this->address_arrays['bcc'][] = array(
-				'address'	=> $address,
-				'name'		=> $name
+				'address'	=> trim($address),
+				'name'		=> trim($name)
 			);
 	}
 
 	function reply_to($address, $name = '')
 	{
 		$this->address_arrays['reply_to'] = array(
-			'address'	=> $address,
-			'name'		=> $name
+			'address'	=> trim($address),
+			'name'		=> trim($name)
 		);
 	}
 
 	function from($address, $name = '')
 	{
 		$this->address_arrays['from'] = array(
-			'address'	=> $address,
-			'name'		=> $name
+			'address'	=> trim($address),
+			'name'		=> trim($name)
 		);
 	}
 
@@ -92,12 +92,19 @@
 
 	function format_address($address)
 	{
+		if (isset($address['address']))
+		{
+			echo ($address['name'] && $this->named_addresses) ?  '"' . mail_encode($address['name'], $this->encoding) . '" <' . $address['address'] . '>' : $address['address'];
+			return ($address['name'] && $this->named_addresses) ?  '"' . mail_encode($address['name'], $this->encoding) . '" <' . $address['address'] . '>' : $address['address'];
+		}
+
+		$formatted = array();
+
 		foreach ($address as $array)
 		{
-			$array['name'] = trim($array['name']);
-
 			$formatted[] = ($array['name'] && $this->named_addresses) ?  '"' . mail_encode($array['name'], $this->encoding) . '" <' . $array['address'] . '>' : $array['address'];
 		}
+
 		return implode(', ', $formatted);
 	}
 
@@ -105,31 +112,30 @@
 	{
 		global $_CLASS, $_CORE_CONFIG;
 
-		$to = $cc = $bcc = $reply_to = $from = false;
-
-		foreach ($this->address_arrays as $type => $address)
+		if (empty($this->address_arrays['from']))
 		{
-			if (empty($address))
-			{
-				continue;
-			}
-
-			$$type = $this->format_address($address);
+			$this->from($_CORE_CONFIG['email']['site_email'], $_CORE_CONFIG['global']['site_name']);
 		}
 
-		$_CORE_CONFIG['email']['site_email'] = trim($_CORE_CONFIG['email']['site_email']);
+		$headers[] = 'Message-ID: <' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . "@" . $_CORE_CONFIG['global']['site_name'] . ">";
 
-		if (!$from)
+		if (!$_CORE_CONFIG['email']['smtp'])
 		{
-			// modify_lines ?
-			$from = '<' . $_CORE_CONFIG['email']['site_email'] . '>';
-		}
+			$to = $cc = $bcc = $reply_to = $from = false;
 
-		$headers[] = "From: $from";
-		$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s T');
+			foreach ($this->address_arrays as $type => $address)
+			{
+				if (empty($address))
+				{
+					continue;
+				}
+	
+				$$type = $this->format_address($address);
+			}
 
-		if (!$_CORE_CONFIG['email']['smtp'])
-		{
+			$headers[] = "From: $from";
+			$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s', gmtime()). ' -0000 (GMT)';
+
 			if ($cc)
 			{
 				$headers[] = "Cc: $cc";
@@ -139,17 +145,20 @@
 			{
 				$headers[] = "Bcc: $bcc";
 			}
+
+			if ($reply_to)
+			{
+				$headers[] = "Reply-to: $reply_to";
+			}
 		}
-
-		if ($reply_to)
+		else
 		{
-			$headers[] = "Reply-to: $reply_to";
+			$headers[] = 'Date: ' . gmdate('D, d M Y H:i:s', gmtime()). ' -0000 (GMT)';
 		}
 
 		$headers[] = 'Return-Path: <' . $_CORE_CONFIG['email']['site_mail'] . ">";
 		$headers[] = 'Sender: <' . $_CORE_CONFIG['email']['site_mail'] . ">";
 		$headers[] = "MIME-Version: 1.0";
-		$headers[] = 'Message-ID: <' . ((function_exists('sha1')) ? sha1(uniqid(mt_rand(), true)) : md5(uniqid(mt_rand(), true))) . "@" . $_CORE_CONFIG['global']['site_name'] . ">";
 
 		if ($this->html)
 		{
@@ -159,10 +168,10 @@
 			$headers[] = 'Content-Type: multipart/alternative;';
 			$headers[] = "\tboundary=\"$text_boundary\"";
 
-			$message .= 'This is a multi-part message in MIME format, Please use a MIME-compatible client';
+			$message = "\n".'This is a multi-part message in MIME format, Please use a MIME-compatible client';
 
 			// Plain text
-			$message .= "\n\n$text_boundary\n";
+			$message .= "\n$text_boundary\n";
 			$message .= 'Content-Type: text/plain; charset='.$this->encoding."\n"; //format=
 			$message .= "Content-Transfer-Encoding: 8bit\n\n";
 			$message .= html_entity_decode(strip_tags(preg_replace('#<br */?>#i', "\n", modify_lines($this->message))), ENT_QUOTES);
@@ -199,6 +208,7 @@
 			$smtp->subject = $this->subject;
 			$smtp->headers = $headers;
 			$smtp->message = $message;
+			$smtp->from = $this->address_arrays['from'];
 			$smtp->recipients = array_merge($this->address_arrays['to'], $this->address_arrays['cc'] , $this->address_arrays['bcc']);
 
 			if (!$smtp->send_mail())
@@ -243,6 +253,9 @@
 	var $port;
 	var $error;
 
+	var $encoding = 'UTF-8';
+	var $named_addresses = true;
+
 	/*
 		PHP5 destructor
 	*/
@@ -351,11 +364,22 @@
 		return true;
 	}
 
+	function format_address($address, $header = false)
+	{
+		if ($header)
+		{
+			return ($address['name'] && $this->named_addresses) ?  '"' . mail_encode($address['name'], $this->encoding) . '" <' . $address['address'] . '>' : $address['address'];
+		}
+		
+		//return ($address['name'] && $this->named_addresses) ?  '<' . $address['address'] . '> '.$address['name'] : '<' . $address['address'] . '>';
+		return '<' . $address['address'] . '>';
+	}
+
 	function send_mail()
 	{
 		global $_CORE_CONFIG;
 
-		fwrite($this->connection, 'MAIL FROM: <'.$_CORE_CONFIG['email']['site_mail'].'>'."\r\n");
+		fwrite($this->connection, 'MAIL FROM: '.$this->format_address($this->from)."\r\n");
 
 		if (!$this->check_response(250))
 		{
@@ -368,22 +392,11 @@
 		// Let tell the server who to send this to.
 		foreach ($this->recipients as $email)
 		{
-			$name = false;
+			fwrite($this->connection, 'RCPT TO: '.$this->format_address($email)."\r\n");
 
-			//print_r($email);
-			if (is_array($email))
-			{
-				$name = $email['name'];
-				$email = $email['address'];
-			}
-
-			$email = trim($email);
-
-			fwrite($this->connection, 'RCPT TO: <'.$email.">\r\n");
-
 			if ($this->check_response(250))
 			{
-				$to_header[] = ($name) ? "$name <$email>" : "<$email>";
+				$to_header[] = $this->format_address($email, true);
 			}
 		}
 
@@ -391,6 +404,7 @@
 		if (empty($to_header))
 		{
 			$this->error = 'Nothing to send';
+
 			$this->disconnect();
 			return false;
 		}
@@ -404,6 +418,7 @@
 			return false;
 		}
 
+		fwrite($this->connection, 'From: '.$this->format_address($this->from, true)."\r\n");
 		fwrite($this->connection, 'Subject: '.$this->subject."\r\n");
 		fwrite($this->connection, 'To: '.implode(', ', $to_header)."\r\n");
 		fwrite($this->connection, implode("\r\n", $this->headers)."\r\n\r\n");

Modified: cms/trunk/includes/templates/admin/system/index.html
===================================================================
--- cms/trunk/includes/templates/admin/system/index.html	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/includes/templates/admin/system/index.html	2005-09-29 21:14:37 UTC (rev 149)
@@ -37,14 +37,6 @@
 			<td class="row2"><input class="post" size="40" maxlength="255" name="site_name" value="{ $SITE_NAME }" type="text"></td>
 		</tr>
 		<tr>
-			<td class="row1" width="50%"><b>{ $L_SITE_URL }: </b></td>
-			<td class="row2"><input class="post" size="40" maxlength="255" name="site_url" value="{ $SITE_URL }" type="text"></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_START_DATE }: </b></td>
-			<td class="row2"><input class="post" size="40" maxlength="255" name="startdate" value="{ $START_DATE }" type="text"></td>
-		</tr>
-		<tr>
 			<td class="row1" width="50%"><b>{ $L_LINK_OPTIMIZATION }: </b></td>
 			<td class="row2"><input name="link_optimization" value="1" <!-- IF { $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="link_optimization" value="0" <!-- IF !{ $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
 		</tr>
@@ -58,11 +50,53 @@
 			</td>
 		</tr>
 		<tr>
-		<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
+			<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
 			<td class="row2">
-			<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
-			<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
+				<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
+				<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
+			</td>
 		</tr>
+		<tr>
+			<th colspan="2">{ $L_EMAIL }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_EMAIL_ENABLE }: </b></td>
+			<td class="row2"><input name="email_enable" value="1" <!-- IF { $EMAIL_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="email_enable" value="0" <!-- IF !{ $EMAIL_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_MAIL_MODE }: </b></td>
+			<td class="row2"><input name="smtp" value="1" <!-- IF { $SMTP } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_SMTP }&nbsp;&nbsp;<input name="smtp" value="0" <!-- IF !{ $SMTP } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_FUNCTION }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SITE_EMAIL }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="site_email" value="{ $SITE_EMAIL }" type="text"></td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row2"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_EMAIL_FUNCTION_NAME }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="email_function_name" value="{ $EMAIL_FUNCTION_NAME }" type="text"></td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row2"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_SERVER }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_host" value="{ $SMTP_HOST }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_PORT }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_port" value="{ $SMTP_PORT }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_USERNAME }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_username" value="{ $SMTP_USERNAME }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_PASSWORD }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_password" value="{ $SMTP_PASSWORD }" type="text"></td>
+		</tr>
 	<!-- ELSEIF { $SYSTEM_MODE } == 'system' -->
 		<tr>
 			<th colspan="2">{ $L_MAINTENANCE }</th>
@@ -74,9 +108,8 @@
 		<tr>
 			<td class="row1" width="50%"><b>{ $L_MAINTENANCE_START }: </b></td>
 			<td class="row2">
-			<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
-				<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
-				
+				<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
+				<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger" />
 			</td>
 		</tr>
 		<tr>
@@ -110,8 +143,7 @@
 
 		<tr>
 			<td class="row1" width="50%"><b>Session IP validation: </b><br><span class="gensmall">Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.</span></td>
-			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
-	
+			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF !{ $IP_CHECK } --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
 		</tr>
 		<tr>
 			<td class="row1" width="50%"><b>Limit system load: </b><br><span class="gensmall">If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.</span></td>

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/install/build_data.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -27,63 +27,63 @@
 
 //$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (id, title, type, content, position, weight, active, file) VALUES (1, 'Control Panel', , 'block-Control_Panel.php')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'site_name', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'start_date', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_theme', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'foot2', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'contact', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '<a href=\"feed.php?feed=rss1\" title=\"RSS 1.0 / RDF Feed\"><img alt=\"RSS 1.0 / RDF\" src=\"images/rss10_logo.gif\" /></a> <a href=\"feed.php?feed=rss2\" title=\"RSS 2.0 Feed\"><img alt=\"RSS 2.0\" src=\"images/rss20_logo.gif\" /></a> <a href=\"feed.php?feed=rss\" title=\"RSS 0.91 Feed\"><img alt=\"RSS 0.9\" src=\"images/rss090_logo.gif\" /></a>', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dst', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'only_registered', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_timezone', '-5', 'float', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'link_optimization', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'index_page', 'contact', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'active', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'start', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'active', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '<p align=\"center\"><b>Sorry we are currently updating this site.<br>\nPlease try again later</b></p>\n<p align=\"center\"><b>Viperal</b>\n</p>', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'allow_html_email', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'email_function_name', 'mail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_host', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_port', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_username', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('email', 'smtp_password', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'allow_html_email', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_enable', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_function_name', 'mail', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp', 0, 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_host', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_port', '', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_username', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_password', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'site_email', 'none at none.com', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_chars', '.*', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'enable_confirm', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_enable', '1', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_fax', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'coppa_mail', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_name_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_reg_attempts', '10', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_name_chars', '50', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'min_pass_chars', '5', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'max_pass_chars', '25', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_email_reuse', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'allow_name_change', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_username', 'admin', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'newest_user_id', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'activation', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'total_users', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('user', 'password_encoding', 'md5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_chars', '.*', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'enable_confirm', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_enable', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_fax', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_mail', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_name_chars', '5', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_reg_attempts', '10', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_name_chars', '50', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_pass_chars', '5', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_pass_chars', '25', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_email_reuse', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_change', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_username', 'admin', 'string', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_user_id', '2', 'int', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'activation', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'total_users', '1', 'int', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'password_encoding', 'md5', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_name', 'viperal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'cookie_path', '/', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_load', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'limit_sessions', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'ip_check', '4', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'session_length', '3600', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'error_options', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_secure', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_domain', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_path', '', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('server', 'site_port', '', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'path', '/', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_domain', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_name', 'viperal', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_path', '/', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_load', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_sessions', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'ip_check', '4', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'session_length', '3600', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'error_options', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_secure', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_domain', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_path', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_port', '', 'int', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
@@ -176,14 +176,14 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
@@ -307,20 +307,13 @@
 // ADMINISTRATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option IN ('f_poll', 'f_announce', 'f_sticky', 'f_attach', 'f_html')");
 
 // SUPER MODERATOR group
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
 
 # REGISTERED/REGISTERED COPPA groups - common forum rights
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname')");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
-
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname')");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 1, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_subscribe');
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 5, 2, auth_option_id, 1 FROM phpbb_auth_options WHERE auth_option IN ('f_', 'f_list', 'f_read', 'f_post', 'f_reply', 'f_quote', 'f_edit', 'f_delete', 'f_vote', 'f_votechg', 'f_download', 'f_bbsmiley_code', 'f_smilies', 'f_img', 'f_flash', 'f_sigs', 'f_search', 'f_email', 'f_print', 'f_postcount', 'f_report', 'f_subscribe');
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
@@ -348,7 +341,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");// maybe keep
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
@@ -360,7 +353,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_track', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
@@ -374,33 +366,17 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_startdate', ".gmtime().", 0)");
-
-// to be removed
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_function_name', 'mail', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_package_size', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_delivery', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_host', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_port', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_auth_method', 'PLAIN', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_username', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smtp_password', '', 0)");
-////
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_enable', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_host', 'jabber.org', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_port', '5222', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_username', 'viperal_site', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_password', '19site83', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('jab_resource', '', 0)");
-
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
+//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_start_date', ".gmtime().", 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
@@ -439,21 +415,20 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '2', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '1117686190', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_user_id', '334', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('newest_username', 'Grendal', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '0', 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_karma', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
@@ -462,7 +437,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('database_last_gc', '0', 1)");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'MAIN', 'main', 1, 1, 'front\r\nsubscribed\r\nbookmarks,cfg_allow_bookmarks\r\ndrafts', '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'PM', 'pm', 2, 1, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions', 'cfg_allow_privmsg')");
@@ -472,8 +446,6 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'ATTACHMENTS', 'attachments', 6, 1, '', 'acl_u_attach && cfg_allow_attachments')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'GROUPS', 'groups', 7, 1, '', '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('ucp', 'CALENDER', 'calender', 3, 1, 'month_view\r\nday_view\r\nadd_event', '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'MAIN', 'main', 1, 1, 'front\r\nforum_view\r\ntopic_view\r\npost_details', 'acl_m_')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_modules (module_type, module_title, module_filename, module_order, module_enabled, module_subs, module_acl) VALUES ('mcp', 'QUEUE', 'queue', 2, 1, 'unapproved_topics\r\nunapproved_posts\r\nreports', 'acl_m_approve')");
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/install/build_tables.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -81,6 +81,7 @@
 $_CLASS['core_db']->add_table_field_char('config_section', 20);
 $_CLASS['core_db']->add_table_field_char('config_name', 20);
 $_CLASS['core_db']->add_table_field_text('config_value', 60000);
+$_CLASS['core_db']->add_table_field_char('config_type', 7);
 $_CLASS['core_db']->add_table_field_int('config_cache', array('max' => 1, 'null' => true));
 
 $_CLASS['core_db']->add_table_index(array('config_section', 'config_name'), 'primary');
@@ -257,8 +258,8 @@
 $_CLASS['core_db']->add_table_field_int('user_allow_viewemail', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('user_allow_massemail', array('max' => 1));
 
-$_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('user_unread_privmsg', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_new_privmsg', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_unread_privmsg', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_text('user_sig', 60000, true);
 $_CLASS['core_db']->add_table_field_char('user_from', 100, true);
@@ -279,7 +280,7 @@
 ///
 
 $_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1, 'null' => true));
-//$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 10, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('user_notify_type', array('max' => 10, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_int('user_allow_pm', array('max' => 1));
@@ -296,7 +297,7 @@
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_type', 1, true);
 $_CLASS['core_db']->add_table_field_char('user_post_sortby_dir', 1, true);
 
-$_CLASS['core_db']->add_table_field_int('user_posts', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_posts', array('max' => 16000000));
 field_unix_time('user_last_post_time', true);
 
 $_CLASS['core_db']->add_table_field_text('user_permissions', 60000, true); // phpBBs rename user_forums_permissions
@@ -385,7 +386,7 @@
 */
 $_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_presets');
 
-$_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000));
+$_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('preset_user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('preset_name', 50);
 $_CLASS['core_db']->add_table_field_char('preset_type', 2);
@@ -794,7 +795,7 @@
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000));
 $_CLASS['core_db']->add_table_field_int('title_match', array('max' => 1));
 
-$_CLASS['core_db']->add_table_index('word_id', 'primary');
+$_CLASS['core_db']->add_table_index('word_id');
 
 $_CLASS['core_db']->table_create('commit');
 

Modified: cms/trunk/modules/Forums/posting.php
===================================================================
--- cms/trunk/modules/Forums/posting.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Forums/posting.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -1231,11 +1231,12 @@
 	{
 		// Try to delete topic, we may had an previous error causing inconsistency
 		/*
-		if ($post_mode = 'delete_topic')
+		if ($post_mode === 'delete_topic')
 		{
 			delete_topics('topic_id', array($topic_id), false);
 		}
 		*/
+
 		trigger_error('ALREADY_DELETED');
 	}
 
@@ -1259,7 +1260,7 @@
 
 			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-			break;
+		break;
 
 		case 'delete_first_post':
 			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
@@ -1281,7 +1282,7 @@
 			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$next_post_id = (int) $row['post_id'];
-			break;
+		break;
 			
 		case 'delete_last_post':
 			if ($data['topic_type'] != POST_GLOBAL)
@@ -1311,7 +1312,7 @@
 	
 				$next_post_id = (int) $row['last_post_id'];
 			}
-			break;
+		break;
 			
 		case 'delete':
 			$sql = 'SELECT post_id
@@ -1332,6 +1333,7 @@
 
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 			$next_post_id = (int) $row['post_id'];
+		break;
 	}
 				
 	$sql_data[USERS_TABLE] = ($_CLASS['auth']->acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';

Modified: cms/trunk/modules/Forums/search.php
===================================================================
--- cms/trunk/modules/Forums/search.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Forums/search.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -47,7 +47,8 @@
 $_CLASS['core_user']->add_img();
 
 // Is user able to search? Has search been disabled?
-if ($_CLASS['core_user']->is_bot || !$_CLASS['auth']->acl_get('u_search') || !$config['load_search'])
+//!$_CLASS['auth']->acl_get('u_search') 
+if ($_CLASS['core_user']->is_bot || !$config['load_search'])
 {
 	trigger_error('NO_SEARCH');
 }

Modified: cms/trunk/modules/Quick_Message/configurator.php
===================================================================
--- cms/trunk/modules/Quick_Message/configurator.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/Quick_Message/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -54,11 +54,11 @@
 		$_CLASS['core_db']->table_create('commit');
 		
 		// use set config ?
-		set_core_config('quick_message', 'anonymous_posting', 2, false, true);
-		set_core_config('quick_message', 'delete_time', 300, false, true);
-		set_core_config('quick_message', 'height', 200, false, true);
-		set_core_config('quick_message', 'last_post_check', 150, false, true);
-		set_core_config('quick_message', 'length_max', 150, false, true);
+		set_core_config('quick_message', 'anonymous_posting', 2, false, true, 'int');
+		set_core_config('quick_message', 'delete_time', 300, false, true, 'int');
+		set_core_config('quick_message', 'height', 200, false, true, 'int');
+		set_core_config('quick_message', 'last_post_check', 150, false, true, 'int');
+		set_core_config('quick_message', 'length_max', 150, false, true, 'int');
 
 		$_CLASS['core_cache']->destroy('core_config');
 
@@ -85,6 +85,8 @@
 		$_CLASS['core_db']->query('DELETE FROM ' . CORE_CONFIG_TABLE . " WHERE config_section = 'quick_message'");
 
 		$_CLASS['core_db']->report_error(true);
+		
+		return true;
 	}
 }
 

Modified: cms/trunk/modules/articles/configurator.php
===================================================================
--- cms/trunk/modules/articles/configurator.php	2005-09-28 19:45:45 UTC (rev 148)
+++ cms/trunk/modules/articles/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
@@ -97,6 +97,8 @@
 		$_CLASS['core_db']->query('DROP TABLE ' . ARTICLES_TABLE);
 
 		$_CLASS['core_db']->report_error(true);
+		
+		return true;
 	}
 }
 



From viperal at berlios.de  Fri Sep 30 06:31:04 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 30 Sep 2005 06:31:04 +0200
Subject: [Viperals-svncheckins] r150 - in cms/branches/1.0alpha2: . images images/modules images/modules/forums images/modules/forums/adm images/modules/forums/adm/images includes/db includes/display includes/forums includes/forums/admin includes/templates/modules/Control_Panel install modules/Control_Panel/ucp modules/Forums modules/Quick_Message modules/articles
Message-ID: <200509300431.j8U4V4X9000941@sheep.berlios.de>

Author: viperal
Date: 2005-09-30 06:30:29 +0200 (Fri, 30 Sep 2005)
New Revision: 150

Added:
   cms/branches/1.0alpha2/images/modules/
   cms/branches/1.0alpha2/images/modules/forums/
   cms/branches/1.0alpha2/images/modules/forums/adm/
   cms/branches/1.0alpha2/images/modules/forums/adm/images/
   cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic1.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic3.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/header_bg.jpg
   cms/branches/1.0alpha2/images/modules/forums/adm/images/header_left.jpg
   cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_link.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_lock.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_subfolder.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/no_avatar.gif
   cms/branches/1.0alpha2/images/modules/forums/adm/images/no_image.png
Removed:
   cms/branches/1.0alpha2/includes/forums/functions_user.php
Modified:
   cms/branches/1.0alpha2/.htaccess
   cms/branches/1.0alpha2/admin.php
   cms/branches/1.0alpha2/includes/db/sqlite.php
   cms/branches/1.0alpha2/includes/db/sqlite_pdo.php
   cms/branches/1.0alpha2/includes/display/display.php
   cms/branches/1.0alpha2/includes/forums/admin/admin_search.php
   cms/branches/1.0alpha2/includes/forums/functions_posting.php
   cms/branches/1.0alpha2/includes/forums/functions_privmsgs.php
   cms/branches/1.0alpha2/includes/templates/modules/Control_Panel/ucp_pm_popup.html
   cms/branches/1.0alpha2/install/build_data.php
   cms/branches/1.0alpha2/install/build_tables.php
   cms/branches/1.0alpha2/installer.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm_compose.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_prefs.php
   cms/branches/1.0alpha2/modules/Forums/posting.php
   cms/branches/1.0alpha2/modules/Forums/search.php
   cms/branches/1.0alpha2/modules/Quick_Message/configurator.php
   cms/branches/1.0alpha2/modules/articles/configurator.php
Log:


Modified: cms/branches/1.0alpha2/.htaccess
===================================================================
--- cms/branches/1.0alpha2/.htaccess	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/.htaccess	2005-09-30 04:30:29 UTC (rev 150)
@@ -7,7 +7,10 @@
 allow from all
 </LimitExcept>
 
-ErrorDocument 403 error.php?error=403
-ErrorDocument 404 error.php?error=404
+ErrorDocument 400 error.php
+ErrorDocument 401 error.php
+ErrorDocument 403 error.php
+ErrorDocument 404 error.php
+ErrorDocument 500 error.php
 
 Options -Indexes
\ No newline at end of file

Modified: cms/branches/1.0alpha2/admin.php
===================================================================
--- cms/branches/1.0alpha2/admin.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/admin.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -22,7 +22,7 @@
 
 //$_CLASS['core_user']->add_lang('admin/common.php');
 
-$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'];
+$_CORE_MODULE['module_title'] = $_CLASS['core_user']->get_lang('ADMIN');
 $_CORE_MODULE['module_sides'] = BLOCK_ALL;
 $_CLASS['core_blocks']->blocks_loaded = true;
 
@@ -86,7 +86,7 @@
 	}
 }
 
-$_CORE_MODULE['module_title'] = $_CLASS['core_user']->lang['ADMIN'].' &gt; '.$_CORE_MODULE['module_title'];
+$_CORE_MODULE['module_title'] = $_CLASS['core_user']->get_lang('ADMIN').' &gt; '.$_CORE_MODULE['module_title'];
 $_CORE_MODULE['module_sides'] = BLOCK_ALL;
 	
 require(SITE_FILE_ROOT.'admin/menu.php');

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/header_bg.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/header_bg.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/header_left.jpg
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/header_left.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_link.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_link.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_subfolder.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/icon_subfolder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/branches/1.0alpha2/images/modules/forums/adm/images/no_image.png
===================================================================
(Binary files differ)


Property changes on: cms/branches/1.0alpha2/images/modules/forums/adm/images/no_image.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/branches/1.0alpha2/includes/db/sqlite.php
===================================================================
--- cms/branches/1.0alpha2/includes/db/sqlite.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/db/sqlite.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -65,6 +65,11 @@
 			return $this->link_identifier;
 		}
 		
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		if (!$error)
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';

Modified: cms/branches/1.0alpha2/includes/db/sqlite_pdo.php
===================================================================
--- cms/branches/1.0alpha2/includes/db/sqlite_pdo.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/db/sqlite_pdo.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -55,6 +55,11 @@
 		}
 		catch (PDOException $e)
 		{
+			if (!$this->report_error)
+			{
+				return false;
+			}
+
 			trigger_error('Connection failed: ' . $e->getMessage());
 		}
 

Modified: cms/branches/1.0alpha2/includes/display/display.php
===================================================================
--- cms/branches/1.0alpha2/includes/display/display.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/display/display.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -49,12 +49,14 @@
 
 		if ($module['module_status'] != STATUS_ACTIVE)
 		{
-			if (!$_CLASS['core_auth']->admin_auth('modules'))
+			if ($module['module_status'] == STATUS_DISABLED && $_CLASS['core_auth']->admin_auth('modules'))
 			{
+				$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
+			}
+			else
+			{
 				return '_MODULE_NOT_ACTIVE';
 			}
-
-			$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
 		}
 
 		//authization check here

Modified: cms/branches/1.0alpha2/includes/forums/admin/admin_search.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/admin/admin_search.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/forums/admin/admin_search.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -37,10 +37,21 @@
 
 	if (!$start)
 	{
-		// Empty existing tables
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
-		$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
+		switch ($_CLASS['core_db']->db_layer)
+		{
+			case 'sqlite':
+			case 'sqlite_pdo':
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_TABLE);
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_WORD_TABLE);
+				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_SEARCH_MATCH_TABLE);
+			break;
+			
+			default:
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_TABLE);
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_WORD_TABLE);
+				$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_SEARCH_MATCH_TABLE);
+			break;
+		}
 	}
 
 	// Fetch a batch of posts_text entries
@@ -64,32 +75,31 @@
 			$count++;
 		}
 		$_CLASS['core_db']->free_result($result);
-	}
 
-	if (($start + $count) < $total_posts)
-	{
-		redirect(generate_link('forums&amp;file=admin_search&position=' . ($start + $count), array('admin' => true)), 3);
+		if (($start + $count) < $total_posts)
+		{
+			redirect(generate_link('Forums&amp;file=admin_search&position=' . ($start + $count), array('admin' => true)), 3);
+		}
+		else
+		{
+			// search tidy
+			$fulltext->search_tidy();
+			$_CLASS['core_db']->optimize_tables();
+		}
 	}
-	else
-	{
-		// search tidy
-		$fulltext->search_tidy();
-		$_CLASS['core_db']->optimize_tables();
 
-		adm_page_header($_CLASS['core_user']->lang['SEARCH_INDEX']);
+	adm_page_header($_CLASS['core_user']->get_lang('SEARCH_INDEX'));
 
 ?>
 
-<h1><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX']; ?></h1>
+<h1><?php echo $_CLASS['core_user']->get_lang('SEARCH_INDEX'); ?></h1>
 
-<p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_COMPLETE']; ?></p>
+<p><?php echo $_CLASS['core_user']->get_lang('SEARCH_INDEX_COMPLETE'); ?></p>
 
 <?php
 
-		adm_page_footer();
+	adm_page_footer();
 
-	}
-
 	die;
 }
 else if (isset($_POST['cancel']))
@@ -117,7 +127,7 @@
 
 <p><?php echo $_CLASS['core_user']->lang['SEARCH_INDEX_EXPLAIN']; ?></p>
 
-<form method="post" action="<?php echo generate_link('forums&amp;file=admin_search', array('admin' => true)); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
+<form method="post" action="<?php echo generate_link('Forums&amp;file=admin_search', array('admin' => true)); ?>"><table cellspacing="1" cellpadding="4" border="0" align="center" bgcolor="#98AAB1">
 	<tr>
 		<td class="cat" height="28" align="center">&nbsp;<input type="submit" name="start" value="<?php echo $_CLASS['core_user']->lang['START']; ?>" class="btnmain" /> &nbsp; <input type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['CANCEL']; ?>" class="btnmain" />&nbsp;</td>
 	</tr>

Modified: cms/branches/1.0alpha2/includes/forums/functions_posting.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_posting.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/forums/functions_posting.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -826,7 +826,7 @@
 		$topic_title = $subject;
 
 		$notify_type = 'topic';
-		$template = 'notify_topic'; //forum_notify
+		$template = 'notify_topic'; //notify_forum
 		$where = "(w.forum_id = $forum_id OR w.topic_id = $topic_id)";
 	}
 	else
@@ -857,11 +857,11 @@
 		$ignore_array[$user['user_id']] = $user['user_id'];
 
 		$holding[$user['user_id']] = $user;
-		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' && $user['forum_id']) ? 'forum_notify' : $template;
+		$holding[$user['user_id']]['template'] = ($notify_type == 'topic' && $user['forum_id']) ? 'notify_forum' : $template;
 		
 		if ($notify_type == 'topic' && $user['forum_id'])
 		{
-			$holding[$user['user_id']]['template'] = 'forum_notify';
+			$holding[$user['user_id']]['template'] = 'notify_forum';
 			$holding[$user['user_id']]['update'] = 'forum';
 		}
 		else

Modified: cms/branches/1.0alpha2/includes/forums/functions_privmsgs.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_privmsgs.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/forums/functions_privmsgs.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -967,7 +967,7 @@
 
 		foreach (array('u', 'g') as $type)
 		{
-			if (sizeof($$type))
+			if (!empty($$type))
 			{
 				foreach ($$type as $id)
 				{
@@ -999,7 +999,7 @@
 		}
 
 		$address = array();
-		if (sizeof($u))
+		if (!empty($u))
 		{
 			$sql = 'SELECT user_id, username, user_colour 
 				FROM ' . USERS_TABLE . '
@@ -1024,7 +1024,7 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 
-		if (sizeof($g))
+		if (!empty($g))
 		{
 			if ($plaintext)
 			{
@@ -1070,7 +1070,7 @@
 			}
 		}
 
-		if (sizeof($address) && !$plaintext)
+		if (!empty($address) && !$plaintext)
 		{
 			$_CLASS['core_template']->assign('S_' . strtoupper($check_type) . '_RECIPIENT', true);
 
@@ -1185,6 +1185,9 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 
+		$recipients = array_unique($recipients);
+		unset($recipients[ANONYMOUS]);
+
 		if (empty($recipients))
 		{
 			trigger_error('NO_RECIPIENT');
@@ -1221,7 +1224,7 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
 				'to_address'		=> implode(':', $to),
@@ -1241,7 +1244,7 @@
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
 				'message_checksum'	=> $data['message_md5'],
-				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid']
 			);
@@ -1388,6 +1391,8 @@
 	// Send Notifications
 	if ($mode !== 'edit')
 	{
+	//unset($recipients[$_CLASS['core_user']->data['user_id']]);
+
 		pm_notification($mode, $_CLASS['core_user']->data['username'], $recipients, $subject, $data['message']);
 	}
 
@@ -1397,93 +1402,66 @@
 // PM Notification
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
-	global $_CLASS, $config;
-return;
-	$subject = censor_text($subject);
-	
-	// Get banned User ID's
-	$sql = 'SELECT ban_userid 
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
+	global $_CLASS, $_CORE_CONFIG, $config;
 
-	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
-	
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if (empty($recipients))
 	{
-		if (isset($row['ban_userid']))
-		{
-			unset($recipients[$row['ban_userid']]);
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	if (!sizeof($recipients))
-	{
 		return;
 	}
 
-	$recipient_list = implode(', ', array_keys($recipients));
+	$subject = censor_text($subject);
 
-	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type, user_jabber
+	$recipient_list = implode(', ', array_unique(array_keys($recipients)));
+
+	$sql = 'SELECT user_id, username, user_email, user_lang, user_notify_pm, user_notify_type
 		FROM ' . USERS_TABLE . "
 		WHERE user_id IN ($recipient_list)";
 	$result = $_CLASS['core_db']->query($sql);
 
-	$msg_list_ary = array();
+	$user_list = array();
+// add lang support
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		if ($row['user_notify_pm'] == 1 && trim($row['user_email']))
+		if ($row['user_notify_pm'])
 		{
-			$msg_list_ary[] = array(
-				'method'	=> $row['user_notify_type'],
-				'email'		=> $row['user_email'],
-				'jabber'	=> $row['user_jabber'],
-				'name'		=> $row['username'],
-				'lang'		=> $row['user_lang']
-			);
+			$user_list[] = $row;
 		}
 	}
 	$_CLASS['core_db']->free_result($result);
 	
-	if (!sizeof($msg_list_ary))
+	if (empty($user_list))
 	{
 		return;
 	}
 
-	require_once('includes/forums/functions_messenger.php');
-	$messenger = new messenger();
-
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-	foreach ($msg_list_ary as $pos => $addr)
+	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	$mailer = new core_mailer;
+
+	$count = count($user_list);
+	for ($i = 0; $i < $count; $i++)
 	{
-		$messenger->template('privmsg_notify', $addr['lang']);
+		$mailer->to($user_list[$i]['user_email'], $user_list[$i]['username']);
+	}
 
-		$messenger->replyto($config['board_email']);
-		$messenger->to($addr['email'], $addr['name']);
-		$messenger->im($addr['jabber'], $addr['name']);
+	$mailer->subject('New Private Message has arrived');
 
-		$messenger->assign_vars(array(
-			'EMAIL_SIG'		=> $email_sig,
-			'SITENAME'		=> $config['sitename'],
-			'SUBJECT'		=> $subject,
-			'AUTHOR_NAME'	=> $author,
-			'USERNAME'		=> $addr['name'],
+	$_CLASS['core_template']->assign_array(array(
+		'EMAIL_SIG'		=> $email_sig,
+		'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
+		'SUBJECT'		=> $subject,
+		'AUTHOR_NAME'	=> $author,
 
-			'U_INBOX'		=> generate_link('Control_Panel&amp;i=pm&mode=unread', array('full' => true, 'sid' => true)))
-		);
+		'LINK_INBOX'		=> generate_link('Control_Panel&i=pm&mode=unread', array('full' => true, 'sid' => true))
+	));
 
-		$messenger->send($addr['method']);
-		$messenger->reset();
-	}
-	unset($msg_list_ary);
+	$mailer->message = trim($_CLASS['core_template']->display('email/control_panel/pm_notify.txt', true));
 
-	if ($messenger->queue)
+	if (!$mailer->send())
 	{
-		$messenger->save_queue();
+		//echo $mailer->error;
 	}
-
-	unset($messenger);
 }
 
 ?>
\ No newline at end of file

Deleted: cms/branches/1.0alpha2/includes/forums/functions_user.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/functions_user.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/forums/functions_user.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -1,1667 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: functions_user.php,v 1.37 2004/05/02 13:05:38 acydburn Exp $
-//
-// FILENAME  : functions_user.php
-// STARTED   : Sat Dec 16, 2000
-// COPYRIGHT : ? 2001, 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-//
-// User functions
-//
-
-// Obtain user_ids from usernames or vice versa. Returns false on
-// success else the error string
-function user_get_id_name(&$user_id_ary, &$username_ary)
-{
-	global $_CLASS;
-
-	// Are both arrays already filled? Yep, return else
-	// are neither array filled? 
-	if ($user_id_ary && $username_ary)
-	{
-		return;
-	}
-	else if (!$user_id_ary && !$username_ary)
-	{
-		return 'NO_USERS';
-	}
-
-	$which_ary = ($user_id_ary) ? 'user_id_ary' : 'username_ary';
-
-	if ($$which_ary  && !is_array($$which_ary))
-	{
-		$$which_ary = array($$which_ary);
-	}
-
-	$sql_in = ($which_ary == 'user_id_ary') ? array_map('intval', $$which_ary) : preg_replace('#^[\s]*(.*?)[\s]*$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $$which_ary);
-	unset($$which_ary);
-
-	// Grab the user id/username records
-	$sql_where = ($which_ary == 'user_id_ary') ? 'user_id' : 'username';
-	$sql = 'SELECT user_id, username 
-		FROM ' . USERS_TABLE . " 
-		WHERE $sql_where IN (" . implode(', ', $sql_in) . ')';
-	$result = $_CLASS['core_db']->query($sql);
-
-	if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-	{
-		return 'NO_USERS';
-	}
-
-	$id_ary = $username_ary = array();
-	do
-	{
-		$username_ary[$row['user_id']] = $row['username'];
-		$user_id_ary[] = $row['user_id'];
-	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	$_CLASS['core_db']->free_result($result);
-
-	return false;
-}
-
-// Updates a username across all relevant tables/fields
-function user_update_name($old_name, $new_name)
-{
-	global $config, $_CLASS;
-
-	$update_ary = array(
-		FORUMS_TABLE	=> array('forum_last_poster_name'), 
-		MODERATOR_TABLE	=> array('username'), 
-		POSTS_TABLE		=> array('post_username'), 
-		TOPICS_TABLE	=> array('topic_first_poster_name', 'topic_last_poster_name'),
-	);
-
-	foreach ($update_ary as $table => $field_ary)
-	{
-		foreach ($field_ary as $field)
-		{
-			$sql = "UPDATE $table 
-				SET $field = '$new_name' 
-				WHERE $field = '$old_name'";
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-
-	if ($config['newest_username'] == $old_name)
-	{
-		set_config('newest_username', $new_name);
-	}
-}
-
-function user_delete($mode, $user_id)
-{
-	global $config, $_CLASS;
-	
-	$_CLASS['core_db']->sql_transaction();
-
-	switch ($mode)
-	{
-		case 'retain':
-			$sql = 'UPDATE ' . FORUMS_TABLE . '
-				SET forum_last_poster_id = ' . ANONYMOUS . " 
-				WHERE forum_last_poster_id = $user_id";
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . POSTS_TABLE . '
-				SET poster_id = ' . ANONYMOUS . " 
-				WHERE poster_id = $user_id";
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
-				SET topic_poster = ' . ANONYMOUS . "
-				WHERE topic_poster = $user_id";
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . TOPICS_TABLE . '
-				SET topic_last_poster_id = ' . ANONYMOUS . "
-				WHERE topic_last_poster_id = $user_id";
-			$_CLASS['core_db']->query($sql);
-			break;
-
-		case 'remove':
-
-			if (!function_exists('delete_posts'))
-			{
-				global $site_file_root;
-
-				include($site_file_root.'includes/forums/functions_admin.php');
-			}
-
-			$sql = 'SELECT topic_id, COUNT(post_id) AS total_posts 
-				FROM ' . POSTS_TABLE . " 
-				WHERE poster_id = $user_id
-				GROUP BY topic_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			$topic_id_ary = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$topic_id_ary[$row['topic_id']] = $row['total_posts'];
-			}
-			$_CLASS['core_db']->free_result($result);
-			
-			if (!count($topic_id_ary))
-			{
-				break;
-			}
-
-			$sql = 'SELECT topic_id, topic_replies, topic_replies_real 
-				FROM ' . TOPICS_TABLE . ' 
-				WHERE topic_id IN (' . implode(', ', array_keys($topic_id_ary)) . ')';
-			$result = $_CLASS['core_db']->query($sql);
-
-			$del_topic_ary = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				if (max($row['topic_replies'], $row['topic_replies_real']) + 1 == $topic_id_ary[$row['topic_id']])
-				{
-					$del_topic_ary[] = $row['topic_id'];
-				}
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			if (sizeof($del_topic_ary))
-			{
-				$sql = 'DELETE FROM ' . TOPICS_TABLE . ' 
-					WHERE topic_id IN (' . implode(', ', $del_topic_ary) . ')';
-				$_CLASS['core_db']->query($sql);
-			}
-
-			// Delete posts, attachments, etc.
-			delete_posts('poster_id', $user_id);
-
-			break;
-	}
-
-	$table_ary = array(USERS_TABLE, USER_GROUP_TABLE, TOPICS_WATCH_TABLE, FORUMS_WATCH_TABLE, ACL_USERS_TABLE, TOPICS_TRACK_TABLE, FORUMS_TRACK_TABLE);
-
-	foreach ($table_ary as $table)
-	{
-		$sql = "DELETE FROM $table 
-			WHERE user_id = $user_id";
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Reset newest user info if appropriate
-	if ($config['newest_user_id'] == $user_id)
-	{
-		$sql = 'SELECT user_id, username 
-			FROM ' . USERS_TABLE . '
-			WHERE user_type IN (' . USER_NORMAL . ', ' . USER_FOUNDER . ')
-			ORDER BY user_id DESC
-			LIMIT 1';
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			set_config('newest_user_id', $row['user_id']);
-			set_config('newest_username', $row['username']);
-		}
-		$_CLASS['core_db']->freeresult($result);
-	}
-
-	set_config('num_users', $config['num_users'] - 1, TRUE);
-
-	$_CLASS['core_db']->sql_transaction('commit');
-
-	return false;
-}
-
-// Flips user_type from active to inactive and vice versa, handles
-// group membership updates
-function user_active_flip($user_id, $user_type, $user_actkey = false, $username = false)
-{
-	global $_CLASS;
-
-	$sql = 'SELECT group_id, group_name 
-		FROM ' . GROUPS_TABLE . " 
-		WHERE group_name IN ('REGISTERED', 'REGISTERED_COPPA', 'INACTIVE', 'INACTIVE_COPPA')";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$group_id_ary = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$group_id_ary[$row['group_name']] = $row['group_id'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql = 'SELECT group_id 
-		FROM ' . USER_GROUP_TABLE . " 
-		WHERE user_id = $user_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($group_name = array_search($row['group_id'], $group_id_ary))
-		{
-			break;
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$current_group = ($user_type == USER_NORMAL) ? 'REGISTERED' : 'INACTIVE';
-	$switch_group = ($user_type == USER_NORMAL) ? 'INACTIVE' : 'REGISTERED';
-
-	$new_group_id = $group_id_ary[str_replace($current_group, $switch_group, $group_name)];
-
-	$sql = 'UPDATE ' . USER_GROUP_TABLE . " 
-		SET group_id = $new_group_id 
-		WHERE user_id = $user_id
-			AND group_id = " . $group_id_ary[$group_name];
-	$_CLASS['core_db']->query($sql);
-
-	$sql_ary = array(
-		'user_type'		=> ($user_type == USER_NORMAL) ? USER_INACTIVE : USER_NORMAL
-	);
-
-	if ($group_id == $group_id_ary[$group_name])
-	{
-		$sql_ary['group_id'] = $new_group_id;
-	}
-
-	if ($user_actkey !== false)
-	{
-		$sql_ary['user_actkey'] = $user_actkey;
-	}
-
-	$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . "
-		WHERE user_id = $user_id";
-	$_CLASS['core_db']->query($sql);
-
-	$_CLASS['auth']->acl_clear_prefetch($user_id);
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	if (!$username)
-	{
-		$sql = 'SELECT username
-			FROM ' . USERS_TABLE . " 
-			WHERE user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
-		
-		extract($_CLASS['core_db']->fetch_row_assoc($result));
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	$log = ($user_type == USER_NORMAL) ? 'LOG_USER_INACTIVE' : 'LOG_USER_ACTIVE';
-	add_log('admin', $log, $username);
-
-	return false;
-}
-
-function user_ban($mode, $ban, $ban_len, $ban_len_other, $ban_exclude, $ban_reason)
-{
-	global $_CLASS;
-
-	// Delete stale bans
-	$sql = "DELETE FROM " . BANLIST_TABLE . "
-		WHERE ban_end < " . time() . "
-			AND ban_end <> 0";
-	$_CLASS['core_db']->query($sql);
-
-	$ban_list = (!is_array($ban)) ? array_unique(explode("\n", $ban)) : $ban;
-	$ban_list_log = implode(', ', $ban_list);
-
-	$current_time = time();
-
-	if ($ban_len)
-	{
-		if ($ban_len != -1 || !$ban_len_other)
-		{
-			$ban_end = max($current_time, $current_time + ($ban_len) * 60);
-		}
-		else
-		{
-			$ban_other = explode('-', $ban_len_other);
-			$ban_end = max($current_time, gmmktime(0, 0, 0, $ban_other[1], $ban_other[2], $ban_other[0]));
-		}
-	}
-	else
-	{
-		$ban_end = 0;
-	}
-
-	$banlist = array();
-
-	switch ($mode)
-	{
-		case 'user':
-			$type = 'ban_userid';
-
-			if (in_array('*', $ban_list))
-			{
-				$banlist[] = '*';
-			}
-			else
-			{
-				$sql = 'SELECT user_id
-					FROM ' . USERS_TABLE . '
-					WHERE username IN (' . implode(', ', array_diff(preg_replace('#^[\s]*(.*?)[\s]*$#', "'\\1'", $ban_list), array("''"))) . ')';
-				$result = $_CLASS['core_db']->query($sql);
-
-				if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					do
-					{
-						$banlist[] = $row['user_id'];
-					}
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-				}
-			}
-			break;
-
-		case 'ip':
-			$type = 'ban_ip';
-
-			foreach ($ban_list as $ban_item)
-			{
-				if (preg_match('#^([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})[ ]*\-[ ]*([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$#', trim($ban_item), $ip_range_explode))
-				{
-					// Don't ask about all this, just don't ask ... !
-					$ip_1_counter = $ip_range_explode[1];
-					$ip_1_end = $ip_range_explode[5];
-
-					while ($ip_1_counter <= $ip_1_end)
-					{
-						$ip_2_counter = ($ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[2] : 0;
-						$ip_2_end = ($ip_1_counter < $ip_1_end) ? 254 : $ip_range_explode[6];
-
-						if($ip_2_counter == 0 && $ip_2_end == 254)
-						{
-							$ip_2_counter = 256;
-							$ip_2_fragment = 256;
-
-							$banlist[] = "'$ip_1_counter.*'";
-						}
-
-						while ($ip_2_counter <= $ip_2_end)
-						{
-							$ip_3_counter = ($ip_2_counter == $ip_range_explode[2] && $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[3] : 0;
-							$ip_3_end = ($ip_2_counter < $ip_2_end || $ip_1_counter < $ip_1_end) ? 254 : $ip_range_explode[7];
-
-							if ($ip_3_counter == 0 && $ip_3_end == 254)
-							{
-								$ip_3_counter = 256;
-								$ip_3_fragment = 256;
-
-								$banlist[] = "'$ip_1_counter.$ip_2_counter.*'";
-							}
-
-							while ($ip_3_counter <= $ip_3_end)
-							{
-								$ip_4_counter = ($ip_3_counter == $ip_range_explode[3] && $ip_2_counter == $ip_range_explode[2] && $ip_1_counter == $ip_range_explode[1]) ? $ip_range_explode[4] : 0;
-								$ip_4_end = ($ip_3_counter < $ip_3_end || $ip_2_counter < $ip_2_end) ? 254 : $ip_range_explode[8];
-
-								if ($ip_4_counter == 0 && $ip_4_end == 254)
-								{
-									$ip_4_counter = 256;
-									$ip_4_fragment = 256;
-
-									$banlist[] = "'$ip_1_counter.$ip_2_counter.$ip_3_counter.*'";
-								}
-
-								while ($ip_4_counter <= $ip_4_end)
-								{
-									$banlist[] = "'$ip_1_counter.$ip_2_counter.$ip_3_counter.$ip_4_counter'";
-									$ip_4_counter++;
-								}
-								$ip_3_counter++;
-							}
-							$ip_2_counter++;
-						}
-						$ip_1_counter++;
-					}
-				}
-				else if (preg_match('#^([\w\-_]\.?){2,}$#is', trim($ban_item)))
-				{
-					$ip_ary = gethostbynamel(trim($ban_item));
-
-					foreach ($ip_ary as $ip)
-					{
-						if (!empty($ip))
-						{
-							$banlist[] = "'" . $ip . "'";
-						}
-					}
-				}
-				else if (preg_match('#^([0-9]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})\.([0-9\*]{1,3})$#', trim($ban_item)) || preg_match('#^[a-f0-9:]+\*?$#i', trim($ban_item)))
-				{
-					$banlist[] = "'" . trim($ban_item) . "'";
-				}
-				else if (preg_match('#^\*$#', trim($ban_item)))
-				{
-					$banlist[] = "'*'";
-				}
-			}
-			break;
-
-		case 'email':
-			$type = 'ban_email';
-
-			foreach ($ban_list as $ban_item)
-			{
-				if (preg_match('#^.*?@*|(([a-z0-9\-]+\.)+([a-z]{2,3}))$#i', trim($ban_item)))
-				{
-					$banlist[] = "'" . trim($ban_item) . "'";
-				}
-			}
-			break;
-	}
-
-	$sql = "SELECT $type
-		FROM " . BANLIST_TABLE . "
-		WHERE $type <> '' 
-			AND ban_exclude = $ban_exclude";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$banlist_tmp = array();
-		do
-		{
-			switch ($mode)
-			{
-				case 'user':
-					$banlist_tmp[] = $row['ban_userid'];
-					break;
-
-				case 'ip':
-					$banlist_tmp[] = "'" . $row['ban_ip'] . "'";
-					break;
-
-				case 'email':
-					$banlist_tmp[] = "'" . $row['ban_email'] . "'";
-					break;
-			}
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-		$banlist = array_unique(array_diff($banlist, $banlist_tmp));
-		unset($banlist_tmp);
-	}
-
-	if (sizeof($banlist))
-	{
-		$sql = '';
-		foreach ($banlist as $ban_entry)
-		{
-			switch (SQL_LAYER)
-			{
-				case 'mysql':
-					$sql .= (($sql != '') ? ', ' : '') . "($ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason')";
-					break;
-					
-				case 'mysql4':
-				case 'mysqli':
-				case 'mssql':
-				case 'sqlite':
-					$sql .= (($sql != '') ? ' UNION ALL ' : '') . " SELECT $ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason'";
-					break;
-
-				default:
-					$sql = 'INSERT INTO ' . BANLIST_TABLE . " ($type, ban_start, ban_end, ban_exclude, ban_reason)
-						VALUES ($ban_entry, $current_time, $ban_end, $ban_exclude, '$ban_reason')";
-					$_CLASS['core_db']->query($sql);
-			}
-		}
-
-		if ($sql)
-		{
-			$sql = 'INSERT INTO ' . BANLIST_TABLE . " ($type, ban_start, ban_end, ban_exclude, ban_reason)
-				VALUES $sql";
-			$_CLASS['core_db']->query($sql);
-		}
-
-		if (!$ban_exclude)
-		{
-			$sql = '';
-			switch ($mode)
-			{
-				case 'user':
-					$sql = 'WHERE session_user_id IN (' . implode(', ', $banlist) . ')';
-					break;
-
-				case 'ip':
-					$sql = 'WHERE session_ip IN (' . implode(', ', $banlist) . ')';
-					break;
-
-				case 'email':
-					$sql = 'SELECT user_id
-						FROM ' . USERS_TABLE . '
-						WHERE user_email IN (' . implode(', ', $banlist) . ')';
-					$result = $_CLASS['core_db']->query($sql);
-
-					$sql_in = array();
-					if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						do
-						{
-							$sql_in[] = $row['user_id'];
-						}
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-						$sql = 'WHERE session_user_id IN (' . str_replace('*', '%', implode(', ', $sql_in)) . ")";
-					}
-					break;
-			}
-
-			if ($sql)
-			{
-				$sql = 'DELETE FROM ' . SESSIONS_TABLE . "
-					$sql";
-				$_CLASS['core_db']->query($sql);
-			}
-		}
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		// Update log
-		$log_entry = ($ban_exclude) ? 'LOG_BAN_EXCLUDE_' : 'LOG_BAN_';
-		add_log('admin', $log_entry . strtoupper($mode), $ban_reason, $ban_list_log);
-	}
-
-	return false;
-}
-
-function user_unban($mode, $ban)
-{
-	global $_CLASS;
-
-	// Delete stale bans
-	$sql = "DELETE FROM " . BANLIST_TABLE . "
-		WHERE ban_end < " . time() . "
-			AND ban_end <> 0";
-	$_CLASS['core_db']->query($sql);
-
-	$unban_sql = implode(', ', $ban);
-
-	if ($unban_sql)
-	{
-		$l_unban_list = '';
-		// Grab details of bans for logging information later
-		switch ($mode)
-		{
-			case 'user':
-				$sql = 'SELECT u.username AS unban_info
-					FROM ' . USERS_TABLE . ' u, ' . BANLIST_TABLE . " b 
-					WHERE b.ban_id IN ($unban_sql) 
-						AND u.user_id = b.ban_userid";
-				break;
-
-			case 'email':
-				$sql = 'SELECT ban_email AS unban_info 
-					FROM ' . BANLIST_TABLE . "
-					WHERE ban_id IN ($unban_sql)";
-				break;
-
-			case 'ip':
-				$sql = 'SELECT ban_ip AS unban_info 
-					FROM ' . BANLIST_TABLE . "
-					WHERE ban_id IN ($unban_sql)";
-				break;
-		}
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$l_unban_list .= (($l_unban_list != '') ? ', ' : '') . $row['unban_info'];
-		}
-
-		$sql = 'DELETE FROM ' . BANLIST_TABLE . "
-			WHERE ban_id IN ($unban_sql)";
-		$_CLASS['core_db']->query($sql);
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		add_log('admin', 'LOG_UNBAN_' . strtoupper($mode), $l_unban_list);
-	}
-
-	return false;
-
-}
-
-// Whois facility
-function user_ipwhois($ip)
-{
-	$ipwhois = '';
-
-	$match = array(
-		'#RIPE\.NET#is'				=> 'whois.ripe.net',
-		'#whois\.apnic\.net#is'		=> 'whois.apnic.net',
-		'#nic\.ad\.jp#is'			=> 'whois.nic.ad.jp',
-		'#whois\.registro\.br#is'	=> 'whois.registro.br'
-	);
-
-	if (($fsk = @fsockopen('whois.arin.net', 43)))
-	{
-		fputs($fsk, "$ip\n");
-		while (!feof($fsk))
-		{
-			$ipwhois .= fgets($fsk, 1024);
-		}
-		@fclose($fsk);
-	}
-
-	foreach (array_keys($match) as $server)
-	{
-		if (preg_match($server, $ipwhois))
-		{
-			$ipwhois = '';
-			if (($fsk = @fsockopen($match[$server], 43)))
-			{
-				fputs($fsk, "$ip\n");
-				while (!feof($fsk))
-				{
-					$ipwhois .= fgets($fsk, 1024);
-				}
-				@fclose($fsk);
-			}
-			break;
-		}
-	}
-
-	return $ipwhois;
-}
-//
-// Data validation ... used primarily but not exclusively by
-// ucp modules
-//
-
-// "Master" function for validating a range of data types
-function validate_data($data, $val_ary)
-{
-	$error = array();
-
-	foreach ($val_ary as $var => $val_seq)
-	{
-		if (!is_array($val_seq[0]))
-		{
-			$val_seq = array($val_seq);
-		}
-
-		foreach ($val_seq as $validate)
-		{
-			$function = array_shift($validate);
-			array_unshift($validate, $data[$var]);
-
-			if ($result = call_user_func_array('validate_' . $function, $validate))
-			{
-				$error[] = $result . '_' . strtoupper($var);
-			}
-		}
-	}
-
-	return $error;
-}
-
-function validate_string($string, $optional = false, $min = 0, $max = 0)
-{
-	if (empty($string) && $optional)
-	{
-		return false;
-	}
-
-	if ($min && strlen($string) < $min)
-	{
-		return 'TOO_SHORT';
-	}
-	else if ($max && strlen($string) > $max)
-	{
-		return 'TOO_LONG';
-	}
-
-	return false;
-}
-
-function validate_num($num, $optional = false, $min = 0, $max = 1E99)
-{
-	if (empty($num) && $optional)
-	{
-		return false;
-	}
-
-	if ($num < $min)
-	{
-		return 'TOO_SMALL';
-	}
-	else if ($num > $max) 
-	{
-		return 'TOO_LARGE';
-	}
-
-	return false;
-}
-
-function validate_match($string, $optional = false, $match)
-{
-	if (empty($string) && $optional)
-	{
-		return false;
-	}
-
-	if (!preg_match($match, $string))
-	{
-		return 'WRONG_DATA';
-	}
-	return false;
-}
-
-// Check to see if the username has been taken, or if it is disallowed.
-// Also checks if it includes the " character, which we don't allow in usernames.
-// Used for registering, changing names, and posting anonymously with a username
-function validate_username($username)
-{
-	global $_CORE_CONFIG, $_CLASS;
-
-	if (strtolower($_CLASS['core_user']->data['username']) == strtolower($username))
-	{
-		return false;
-	}
-
-	if (!preg_match('#^' . str_replace('\\\\', '\\', $_CORE_CONFIG['user']['allow_name_chars']) . '$#i', $username))
-	{
-		return 'INVALID_CHARS';
-	}
-
-	$sql = 'SELECT username
-		FROM ' . USERS_TABLE . "
-		WHERE LOWER(username) = '" . strtolower($_CLASS['core_db']->escape($username)) . "'";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		return 'USERNAME_TAKEN';
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql = 'SELECT group_name
-		FROM ' . GROUPS_TABLE . "
-		WHERE LOWER(group_name) = '" . strtolower($_CLASS['core_db']->escape($username)) . "'";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		return 'USERNAME_TAKEN';
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql = 'SELECT disallow_username
-		FROM ' . DISALLOW_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (preg_match('#' . str_replace('*', '.*?', preg_quote($row['disallow_username'], '#')) . '#i', $username))
-		{
-			return 'USERNAME_DISALLOWED';
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql = 'SELECT word
-		FROM  ' . WORDS_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (preg_match('#(' . str_replace('\*', '.*?', preg_quote($row['word'], '#')) . ')#i', $username))
-		{
-			return 'USERNAME_DISALLOWED';
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	return false;
-}
-
-// TODO?
-// Ability to limit types of email address ... not by banning, seperate table
-// capability to require (or deny) use of certain addresses when user is
-// registering from certain IP's/hosts
-
-// Check to see if email address is banned or already present in the DB
-function validate_email($email)
-{
-	global $_CORE_CONFIG, $_CLASS;
-
-	if (strtolower($_CLASS['core_user']->data['user_email']) == strtolower($email))
-	{
-		return false;
-	}
-
-	if (!preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email))
-	{
-		return 'EMAIL_INVALID';
-	}
-
-	$sql = 'SELECT ban_email
-		FROM ' . BANLIST_TABLE;
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (preg_match('#^' . str_replace('*', '.*?', $row['ban_email']) . '$#i', $email))
-		{
-			return 'EMAIL_BANNED';
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	if (!$_CORE_CONFIG['user']['allow_emailreuse'])
-	{
-		$sql = 'SELECT user_email_hash
-			FROM ' . USERS_TABLE . "
-			WHERE user_email_hash = " . crc32(strtolower($email)) . strlen($email);
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			return 'EMAIL_TAKEN';
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	return false;
-}
-
-//
-// Avatar functions
-//
-
-function avatar_delete($id)
-{
-	global $config, $_CORE_CONFIG;
-
-	if (file_exists($config['avatar_path'] . '/' . $id))
-	{
-		@unlink($config['avatar_path'] . '/' . $id);
-	}
-
-	return false;
- }
-
-function avatar_remote($data, &$error)
-{
-	global $config, $_CLASS;
-
-	if (!preg_match('#^(http|https|ftp)://#i', $data['remotelink']))
-	{
-		$data['remotelink'] = 'http://' . $data['remotelink'];
-	}
-
-	if (!preg_match('#^(http|https|ftp)://(.*?\.)*?[a-z0-9\-]+?\.[a-z]{2,4}:?([0-9]*?).*?\.(gif|jpg|jpeg|png)$#i', $data['remotelink']))
-	{
-		$error[] = $_CLASS['core_user']->lang['AVATAR_URL_INVALID'];
-		return false;
-	}
-
-	if ((!($data['width'] || $data['height']) || $data['remotelink'] != $_CLASS['core_user']->data['user_avatar']) && ($config['avatar_max_width'] || $config['avatar_max_height']))
-	{
-		list($width, $height) = @getimagesize($data['remotelink']);
-
-		if (!$width || !$height)
-		{
-			$error[] = $_CLASS['core_user']->lang['AVATAR_NO_SIZE'];
-			return false;
-		}
-		else if ($width > $config['avatar_max_width'] || $height > $config['avatar_max_height'])
-		{
-			$error[] = sprintf($_CLASS['core_user']->lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
-			return false;
-		}
-	}
-	else if ($data['width'] > $config['avatar_max_width'] || $data['height'] > $config['avatar_max_height'])
-	{
-		$error[] = sprintf($_CLASS['core_user']->lang['AVATAR_WRONG_SIZE'], $config['avatar_max_width'], $config['avatar_max_height']);
-		return false;
-	}
-
-	return array(AVATAR_REMOTE, $data['remotelink'], $width, $height);
-}
-
-function avatar_upload($data, &$error)
-{
-	global $site_file_root, $config, $_CLASS;
-
-	// Init upload class
-	include_once($site_file_root.'includes/forums/functions_upload.php');
-	
-	$upload = new fileupload('AVATAR_', array('jpg', 'jpeg', 'gif', 'png'), $config['avatar_filesize'], $config['avatar_min_width'], $config['avatar_min_height'], $config['avatar_max_width'], $config['avatar_max_height']);
-							
-	if (!empty($_FILES['uploadfile']['name']))
-	{
-		$file = $upload->form_upload('uploadfile');
-	}
-	else
-	{
-		$file = $upload->remote_upload($data['uploadurl']);
-	}
-
-	$file->clean_filename('real', $_CLASS['core_user']->data['user_id'] . '_');
-	$file->move_file($config['avatar_path']);
-
-	if (sizeof($file->error))
-	{
-		$file->remove();
-		$error = array_merge($error, $file->error);
-	}
-	
-	return array(AVATAR_UPLOAD, $file->get('realname'), $file->get('width'), $file->get('height'));
-}
-
-//
-// Usergroup functions
-//
-
-// Add or edit a group. If we're editing a group we only update user
-// parameters such as rank, etc. if they are changed
-function group_create($group_id, $type, $name, $desc)
-{
-	global $config, $_CLASS, $file_upload;
-
-	$error = array();
-
-	// Check data
-	if (!strlen($name) || strlen($name) > 40)
-	{
-		$error[] = (!strlen($name)) ? $_CLASS['core_user']->lang['GROUP_ERR_USERNAME'] : $_CLASS['core_user']->lang['GROUP_ERR_USER_LONG'];
-	}
-
-	if (strlen($desc) > 255)
-	{
-		$error[] = $_CLASS['core_user']->lang['GROUP_ERR_DESC_LONG'];
-	}
-
-	if (!in_array($type, array(GROUP_OPEN, GROUP_CLOSED, GROUP_HIDDEN, GROUP_SPECIAL, GROUP_FREE)))
-	{
-		$error[] = $_CLASS['core_user']->lang['GROUP_ERR_TYPE'];
-	}
-
-	if (!sizeof($error))
-	{
-		$sql_ary = array(
-			'group_name'			=> (string) $name,
-			'group_description'		=> (string) $desc,
-			'group_type'			=> (int) $type,
-		);
-
-		$attribute_ary = array('group_colour' => 'string', 'group_rank' => 'int', 'group_avatar' => 'string', 'group_avatar_type' => 'int', 'group_avatar_width' => 'int', 'group_avatar_height' => 'int', 'group_receive_pm' => 'int', 'group_message_limit' => 'int');
-
-		$i = 4;
-		foreach ($attribute_ary as $attribute => $type)
-		{
-			if (func_num_args() > $i && ($value = func_get_arg($i)) !== false)
-			{
-				settype($value, $type);
-
-				$sql_ary[$attribute] = $$attribute = $value;
-			}
-			$i++;
-		}
-		
-		$group_only_ary = array('group_receive_pm' => 'int', 'group_message_limit' => 'int');
-
-		foreach ($group_only_ary as $attribute => $type)
-		{
-			if (func_num_args() > $i && ($value = func_get_arg($i)) !== false)
-			{
-				settype($value, $type);
-
-				$sql_ary[$attribute] = $value;
-			}
-			$i++;
-		}
-		
-		$sql = ($group_id) ? 'UPDATE ' . GROUPS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . "	WHERE group_id = $group_id" : 'INSERT INTO ' . GROUPS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary);
-		$_CLASS['core_db']->query($sql);
-
-		$sql_ary = array();
-		foreach ($attribute_ary as $attribute => $type)
-		{
-			if (isset($$attribute))
-			{
-				$sql_ary[str_replace('group', 'user', $attribute)] = $$attribute;
-			}
-		}
-
-		if (sizeof($sql_ary))
-		{
-			$sql = 'UPDATE ' . USERS_TABLE . ' SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . "
-				WHERE group_id = $group_id";
-			$_CLASS['core_db']->query($sql);
-		}
-
-		if (!function_exists('add_log'))
-		{
-			global $site_file_root;
-
-			include($site_file_root.'includes/forums/functions_admin.php');
-		}
-
-		$log = ($group_id) ? 'LOG_GROUP_UPDATED' : 'LOG_GROUP_CREATED';
-		add_log('admin', $log, $name);
-	}
-
-	return (sizeof($error)) ? $error : false;
-}
-
-function group_delete($group_id, $group_name = false)
-{
-	global $_CLASS;
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . " 
-			WHERE group_id = $group_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error("Could not obtain name of group $group_id", E_USER_ERROR);
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	$start = 0;
-
-	do
-	{
-		$user_id_ary = $username_ary = array();
-
-		// Batch query for group members, call group_user_del
-		$sql = 'SELECT u.user_id, u.username
-			FROM ' . USER_GROUP_TABLE . ' ug, ' . USERS_TABLE . " u
-			WHERE ug.group_id = $group_id
-				AND u.user_id = ug.user_id 
-			LIMIT $start, 200";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			do
-			{
-				$user_id_ary[] = $row['user_id'];
-				$username_ary[] = $row['username'];
-
-				$start++;
-			}
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-
-			group_user_del($group_id, $user_id_ary, $username_ary, $group_name);
-		}
-		else
-		{
-			$start = 0;
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-	while ($start);
-	
-	// Delete group
-	$sql = 'DELETE FROM ' . GROUPS_TABLE . " 
-		WHERE group_id = $group_id";
-	$_CLASS['core_db']->query($sql);
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	add_log('admin', 'LOG_GROUP_DELETE', $group_name);
-
-	return false;
-}
-
-function group_user_add($group_id, $user_id_ary = false, $username_ary = false, $group_name = false, $default = false, $leader = 0)
-{
-	global $_CLASS;
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	// Remove users who are already members of this group
-	$sql = 'SELECT user_id, group_leader  
-		FROM ' . USER_GROUP_TABLE . '   
-		WHERE user_id IN (' . implode(', ', $user_id_ary) . ") 
-			AND group_id = $group_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$add_id_ary = $update_id_ary = array();
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		do
-		{
-			$add_id_ary[] = $row['user_id'];
-
-			if ($leader && !$row['group_leader'])
-			{
-				$update_id_ary[] = $row['user_id'];
-			}
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// Do all the users exist in this group?
-	$add_id_ary = array_diff($user_id_ary, $add_id_ary);
-	unset($id_ary);
-
-	// If we have no users 
-	if (!sizeof($add_id_ary) && !sizeof($update_id_ary))
-	{
-		return 'GROUP_USERS_EXIST';
-	}
-
-	if (sizeof($add_id_ary))
-	{
-		// Insert the new users 
-		switch (SQL_LAYER)
-		{
-			case 'mysql':
-			case 'mysql4':
-			case 'mysqli':
-			case 'mssql':
-			case 'sqlite':
-
-				$sql = 'INSERT INTO ' . USER_GROUP_TABLE . " (user_id, group_id, group_leader) 
-					VALUES " . implode(', ', preg_replace('#^([0-9]+)$#', "(\\1, $group_id, $leader)",  $add_id_ary));
-				$_CLASS['core_db']->query($sql);
-				break;
-			
-			default:
-				foreach ($add_id_ary as $user_id)
-				{
-					$sql = 'INSERT INTO ' . USER_GROUP_TABLE . " (user_id, group_id, group_leader)
-						VALUES ($user_id, $group_id, $leader)";
-					$_CLASS['core_db']->query($sql);
-				}
-				break;
-		}
-	}
-
-	$usernames = array();
-	if (sizeof($update_id_ary))
-	{
-		$sql = 'UPDATE ' . USER_GROUP_TABLE . ' 
-			SET group_leader = 1 
-			WHERE user_id IN (' . implode(', ', $update_id_ary) . ")
-				AND group_id = $group_id";
-		$_CLASS['core_db']->query($sql);
-
-		foreach ($update_id_ary as $id)
-		{
-			$usernames[] = $username_ary[$id];
-		}
-	}
-	else
-	{
-		foreach ($add_id_ary as $id)
-		{
-			$usernames[] = $username_ary[$id];
-		}
-	}
-
-	if ($default)
-	{
-		$attribute_ary = array('group_colour' => 'string', 'group_rank' => 'int', 'group_avatar' => 'string', 'group_avatar_type' => 'int', 'group_avatar_width' => 'int', 'group_avatar_height' => 'int');
-	
-		// Were group attributes passed to the function? If not we need to obtain them
-		if (func_num_args() > 6)
-		{
-			$i = 6;
-			foreach ($attribute_ary as $attribute => $type)
-			{
-				if (func_num_args() > $i && ($value = func_get_arg($i)) !== false)
-				{
-					settype($value, $type);
-
-					$sql_ary[$attribute] = $$attribute = $value;
-				}
-				$i++;
-			}
-		}
-		else
-		{
-			$sql = 'SELECT group_colour, group_rank, group_avatar, group_avatar_type, group_avatar_width, group_avatar_height  
-				FROM ' . GROUPS_TABLE . " 
-				WHERE group_id = $group_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-			{
-				trigger_error("Could not obtain group attributes for group_id $group_id", E_USER_ERROR);
-			}
-
-			if (!$group_avatar_width)
-			{
-				unset($group_avatar_width);
-			}
-			if (!$group_avatar_height)
-			{
-				unset($group_avatar_height);
-			}
-		}
-
-		$sql_set = '';
-		foreach ($attribute_ary as $attribute => $type)
-		{
-			if (isset($$attribute))
-			{
-				$field = str_replace('group_', 'user_', $attribute);
-
-				switch ($type)
-				{
-					case 'int':
-						$sql_set .= ", $field = " . (int) $$attribute;
-						break;
-					case 'double':
-						$sql_set .= ", $field = " . (double) $$attribute;
-						break;
-					case 'string':
-						$sql_set .= ", $field = '" . (string) $_CLASS['core_db']->escape($$attribute) . "'";
-						break;
-				}
-			}
-		}
-
-		$sql = 'UPDATE ' . USERS_TABLE . "
-			SET group_id = $group_id$sql_set  
-			WHERE user_id IN (" . implode(', ', $user_id_ary) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']->acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . " 
-			WHERE group_id = $group_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error("Could not obtain name of group $group_id", E_USER_ERROR);
-		}
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	$log = ($leader) ? 'LOG_MODS_ADDED' : 'LOG_USERS_ADDED';
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-// Remove a user/s from a given group. When we remove users we update their
-// default group_id. We do this by examining which "special" groups they belong
-// to. The selection is made based on a reasonable priority system
-function group_user_del($group_id, $user_id_ary = false, $username_ary = false, $group_name = false)
-{
-	global $_CLASS;
-
-	$group_order = array('ADMINISTRATORS', 'SUPER_MODERATORS', 'REGISTERED_COPPA', 'REGISTERED', 'BOTS', 'GUESTS');
-
-	$attribute_ary = array('group_colour' => 'string', 'group_rank' => 'int', 'group_avatar' => 'string', 'group_avatar_type' => 'int', 'group_avatar_width' => 'int', 'group_avatar_height' => 'int');
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	$sql = 'SELECT * 
-		FROM ' . GROUPS_TABLE . ' 
-		WHERE group_name IN (' . implode(', ', preg_replace('#^(.*)$#', "'\\1'", $group_order)) . ')';
-	$result = $_CLASS['core_db']->query($sql);
-
-	$group_order_id = $special_group_data = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$group_order_id[$row['group_name']] = $row['group_id'];
-
-		$special_group_data[$row['group_id']]['group_colour']			= $row['group_colour'];
-		$special_group_data[$row['group_id']]['group_rank']				= $row['group_rank'];
-		$special_group_data[$row['group_id']]['group_avatar']			= $row['group_avatar'];
-		$special_group_data[$row['group_id']]['group_avatar_type']		= $row['group_avatar_type'];
-		$special_group_data[$row['group_id']]['group_avatar_width']		= $row['group_avatar_width'];
-		$special_group_data[$row['group_id']]['group_avatar_height']	= $row['group_avatar_height'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// What special group memberships exist for these users?
-	$sql = 'SELECT g.group_id, g.group_name, ug.user_id 
-		FROM ' . USER_GROUP_TABLE . ' ug, ' . GROUPS_TABLE . ' g 
-		WHERE ug.user_id IN (' . implode(', ', $user_id_ary) . ") 
-			AND g.group_id = ug.group_id
-			AND g.group_id <> $group_id 
-			AND g.group_type = " . GROUP_SPECIAL . '
-		ORDER BY ug.user_id, g.group_id';
-	$result = $_CLASS['core_db']->query($sql);
-
-	$temp_ary = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if (!isset($temp_ary[$row['user_id']]) || array_search($row['group_name'], $group_order) < $temp_ary[$row['user_id']])
-		{
-			$temp_ary[$row['user_id']] = $row['group_id'];
-		}
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	$sql_where_ary = array();
-	foreach ($temp_ary as $uid => $gid)
-	{
-		$sql_where_ary[$gid][] = $uid;
-	}
-	unset($temp_ary);
-
-	foreach ($special_group_data as $gid => $default_data_ary)
-	{
-		if ($sql_where = implode(', ', $sql_where_ary[$gid]))
-		{
-			$sql_set = '';
-			foreach ($special_group_data[$gid] as $attribute => $value)
-			{
-				$field = str_replace('group_', 'user_', $attribute);
-
-				switch ($attribute_ary[$attribute])
-				{
-					case 'int':
-						$sql_set .= ", $field = " . (int) $value;
-						break;
-					case 'double':
-						$sql_set .= ", $field = " . (double) $value;
-						break;
-					case 'string':
-						$sql_set .= ", $field = '" . $_CLASS['core_db']->escape($value) . "'";
-						break;
-				}
-			}
-
-			// Set new default
-			$sql = 'UPDATE ' . USERS_TABLE . " 
-				SET group_id = $gid$sql_set 
-				WHERE user_id IN (" . implode(', ', $sql_where_ary[$gid]) . ')';
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-	unset($special_group_data);
-
-	$sql = 'DELETE FROM ' . USER_GROUP_TABLE . " 
-		WHERE group_id = $group_id
-			AND user_id IN (" . implode(', ', $user_id_ary) . ')';
-	$_CLASS['core_db']->query($sql);
-	unset($default_ary);
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']->acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . " 
-			WHERE group_id = $group_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error("Could not obtain name of group $group_id", E_USER_ERROR);
-		}
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	$log = 'LOG_GROUP_REMOVE';
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-// This is used to promote (to leader), demote or set as default a member/s
-function group_user_attributes($action, $group_id, $user_id_ary = false, $username_ary = false, $group_name = false)
-{
-	global $_CLASS;
-
-	// We need both username and user_id info
-	user_get_id_name($user_id_ary, $username_ary);
-
-	switch ($action)
-	{
-		case 'demote':
-		case 'promote':
-			$sql = 'UPDATE ' . USER_GROUP_TABLE . '
-				SET group_leader = ' . (($action == 'promote') ? 1 : 0) . "  
-				WHERE group_id = $group_id
-					AND user_id IN (" . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-
-			$log = ($action == 'promote') ? 'LOG_GROUP_PROMOTED' : 'LOG_GROUP_DEMOTED';
-			break;
-
-		case 'approve':
-			$sql = 'UPDATE ' . USER_GROUP_TABLE . " 
-				SET user_pending = 0 
-				WHERE group_id = $group_id 
-					AND user_id IN (" . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-
-			$log = 'LOG_GROUP_APPROVE';
-			break;
-
-		case 'default':
-			$attribute_ary = array('group_colour' => 'string', 'group_rank' => 'int', 'group_avatar' => 'string', 'group_avatar_type' => 'int', 'group_avatar_width' => 'int', 'group_avatar_height' => 'int');
-
-			// Were group attributes passed to the function? If not we need
-			// to obtain them
-			if (func_num_args() > 5)
-			{
-				$i = 5;
-				foreach ($attribute_ary as $attribute => $type)
-				{
-					if (func_num_args() > $i && ($value = func_get_arg($i)) !== false)
-					{
-						settype($value, $type);
-
-						$sql_ary[$attribute] = $$attribute = $value;
-					}
-					$i++;
-				}
-			}
-			else
-			{
-				$sql = 'SELECT group_colour, group_rank, group_avatar, group_avatar_type, group_avatar_width, group_avatar_height 
-					FROM ' . GROUPS_TABLE . " 
-					WHERE group_id = $group_id";
-				$result = $_CLASS['core_db']->query($sql);
-
-				if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-				{
-					return 'NO_GROUP';
-				}
-				$_CLASS['core_db']->free_result($result);
-
-				if (!$group_avatar_width)
-				{
-					unset($group_avatar_width);
-				}
-				if (!$group_avatar_height)
-				{
-					unset($group_avatar_height);
-				}
-			}
-
-			// FAILURE HERE when grabbing data from DB and checking "isset" ... will
-			// be true for all similar functionality
-
-			$sql_set = '';
-			foreach ($attribute_ary as $attribute => $type)
-			{
-				if (isset($$attribute))
-				{
-					$field = str_replace('group_', 'user_', $attribute);
-
-					switch ($type)
-					{
-						case 'int':
-							$sql_set .= ", $field = " . (int) $$attribute;
-							break;
-						case 'double':
-							$sql_set .= ", $field = " . (double) $$attribute;
-							break;
-						case 'string':
-							$sql_set .= ", $field = '" . (string) $_CLASS['core_db']->escape($$attribute) . "'";
-							break;
-					}
-				}
-			}
-
-			$sql = 'UPDATE ' . USERS_TABLE . "
-				SET group_id = $group_id$sql_set  
-				WHERE user_id IN (" . implode(', ', $user_id_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-
-			$log = 'LOG_GROUP_DEFAULTS';
-			break;
-	}
-
-	if (!function_exists('add_log'))
-	{
-		global $site_file_root;
-
-		include($site_file_root.'includes/forums/functions_admin.php');
-	}
-
-	// Clear permissions cache of relevant users
-	$_CLASS['auth']->acl_clear_prefetch($user_id_ary);
-
-	if (!$group_name)
-	{
-		$sql = 'SELECT group_name
-			FROM ' . GROUPS_TABLE . " 
-			WHERE group_id = $group_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!extract($_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error("Could not obtain name of group $group_id", E_USER_ERROR);
-		}
-	}
-
-	add_log('admin', $log, $group_name, implode(', ', $username_ary));
-
-	unset($username_ary);
-	unset($user_id_ary);
-
-	return false;
-}
-
-/**
-* Obtain either the members of a specified group, the groups the specified user is subscribed to
-* or checking if a specified user is in a specified group
-*
-* Note: Extend select statement as needed
-* Note2: Never use this more than once... first group your users/groups
-*/
-function group_memberships($group_id_ary = false, $user_id_ary = false, $return_bool = false)
-{
-	global $_CLASS;
-
-	if (!$group_id_ary && !$user_id_ary)
-	{
-		return true;
-	}
-
-	$sql = 'SELECT group_id, user_id, user_status
-		FROM ' . USER_GROUP_TABLE . '
-		WHERE ';
-
-	if ($group_id_ary && $user_id_ary)
-	{
-		$sql .= " group_id " . ((is_array($group_id_ary)) ? ' IN (' . implode(', ', $group_id_ary) . ')' : " = $group_id_ary") . "
-				AND user_id " . ((is_array($user_id_ary)) ? ' IN (' . implode(', ', $user_id_ary) . ')' : " = $user_id_ary");
-	}
-	else if ($group_id)
-	{
-		$sql .= " group_id " . ((is_array($group_id_ary)) ? ' IN (' . implode(', ', $group_id_ary) . ')' : " = $group_id_ary");
-	}
-	else if ($user_id_ary)
-	{
-		$sql .= " user_id " . ((is_array($user_id_ary)) ? ' IN (' . implode(', ', $user_id_ary) . ')' : " = $user_id_ary");
-	}
-	
-	$result = ($return_bool) ? $_CLASS['core_db']->query_limit($sql, 1) : $_CLASS['core_db']->query($sql);
-	
-	$row = $_CLASS['core_db']->fetch_row_assoc($result);
-
-	if ($return_bool)
-	{
-		$_CLASS['core_db']->free_result($result);
-		return ($row) ? true : false;
-	}
-
-	$result = array();
-
-	do
-	{
-		$result[] = $row;
-	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	
-	return $result;
-}
-
-?>
\ No newline at end of file

Modified: cms/branches/1.0alpha2/includes/templates/modules/Control_Panel/ucp_pm_popup.html
===================================================================
--- cms/branches/1.0alpha2/includes/templates/modules/Control_Panel/ucp_pm_popup.html	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/includes/templates/modules/Control_Panel/ucp_pm_popup.html	2005-09-30 04:30:29 UTC (rev 150)
@@ -1,7 +1,8 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
 <head>
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+	<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+	<meta http-equiv="expires" content="0" />
+	<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
 </head>
 <html>
 	<body>
@@ -16,26 +17,29 @@
 	//-->
 	</script>
 
-	{ $A_TABLE_OPEN }
+	{ $THEME_TABLE_OPEN }
+
 	<table width="100%" border="0" cellspacing="0" cellpadding="10">
-	<tr>
-		<td>
-			<table width="100%" border="0" cellspacing="1" cellpadding="4" class="tablebg">
-			<tr class="row1">
-				<td valign="top" align="center">
-					<br /><span class="gen">
-					<!-- IF { $S_NOT_LOGGED_IN } -->
-						{ $L_LOGIN_CHECK_PM }
-					<!-- ELSE -->
-						{ $MESSAGE }<br /><br />{ $CLICK_TO_VIEW }
-					<!-- ENDIF -->
-					</span>
-					<br /><br /><span class="genmed"><a href="javascript:window.close();">{ $L_CLOSE_WINDOW }</a></span><br /><br /></td>
-			</tr>
-			</table>
-		</td>
-	</tr>
+		<tr>
+			<td>
+				<table width="100%" border="0" cellspacing="1" cellpadding="4" class="tablebg">
+				<tr class="row1">
+					<td valign="top" align="center">
+						<br /><span class="gen">
+						<!-- IF { $S_NOT_LOGGED_IN } -->
+							{ $L_LOGIN_CHECK_PM }
+						<!-- ELSE -->
+							{ $MESSAGE }<br /><br />{ $CLICK_TO_VIEW }
+						<!-- ENDIF -->
+						</span>
+						<br /><br /><span class="genmed"><a href="javascript:window.close();">{ $L_CLOSE_WINDOW }</a></span><br /><br /></td>
+				</tr>
+				</table>
+			</td>
+		</tr>
 	</table>
-	{ $A_TABLE_CLOSE }
+	
+	{ $THEME_TABLE_CLOSE }
+
 	</body>
 </html>
\ No newline at end of file

Modified: cms/branches/1.0alpha2/install/build_data.php
===================================================================
--- cms/branches/1.0alpha2/install/build_data.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/install/build_data.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -35,7 +35,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_lang', 'en', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dst', '0', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'only_registered', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 1)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_dateformat', 'M d, Y g:i a', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'default_timezone', '-5', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'link_optimization', '1', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_cache) VALUES ('global', 'index_page', 'contact', 1)");
@@ -176,14 +176,14 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data')");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 
 // Forums
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");

Modified: cms/branches/1.0alpha2/install/build_tables.php
===================================================================
--- cms/branches/1.0alpha2/install/build_tables.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/install/build_tables.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -279,14 +279,14 @@
 ///
 
 $_CLASS['core_db']->add_table_field_int('user_notify', array('max' => 1, 'null' => true));
-//$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('user_notify_pm', array('max' => 10, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('user_notify_type', array('max' => 10, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_int('user_allow_pm', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('user_allow_email', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_char('user_sig_bbcode_uid', 5, true);
-$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 1600, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 16000000, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_int('user_topic_show_days', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('user_topic_sortby_type', 1, true);
@@ -505,7 +505,7 @@
 $_CLASS['core_db']->add_table_field_text('forum_rules', 20000, true);
 $_CLASS['core_db']->add_table_field_char('forum_rules_link', 200, true);
 $_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50, true);
-$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 1000000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5, true);
 $_CLASS['core_db']->add_table_field_char('forum_link', 200, true);
 $_CLASS['core_db']->add_table_field_char('forum_password', 40, true);
@@ -876,7 +876,7 @@
 $_CLASS['core_db']->add_table_field_int('message_edit_user', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('message_checksum', 11);
 $_CLASS['core_db']->add_table_field_int('message_attachment', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', 1000000000);
+$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 5);
 field_unix_time('message_edit_time', true);
 $_CLASS['core_db']->add_table_field_int('message_edit_count', array('max' => 200, 'null' => true));
@@ -968,7 +968,7 @@
 $_CLASS['core_db']->add_table_field_text('search_array', 16000000);
 
 $_CLASS['core_db']->add_table_index('search_id', 'primary');
-$_CLASS['core_db']->add_table_index('session_id', 'primary');
+$_CLASS['core_db']->add_table_index('session_id');
 
 $_CLASS['core_db']->table_create('commit');
 

Modified: cms/branches/1.0alpha2/installer.php
===================================================================
--- cms/branches/1.0alpha2/installer.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/installer.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -22,7 +22,7 @@
 */
 define('VIPERAL', 'INSTALLER');
 
-error_reporting(E_ALL);
+error_reporting(0);
 
 define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -1,5 +1,26 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_calender extends module  
 {
 	function ucp_calender($id, $mode)

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -137,75 +137,16 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-/// 
 				$num_real_posts = $_CLASS['core_user']->data['user_posts'];
 				$active_f_row = $active_t_row = array();
 
-				$_CLASS['auth']->acl_getf('f_read');
-/*
-				if ($post_count_ary = $_CLASS['auth']->acl_getf('f_postcount'))
-				{
-					$forum_ary = array();
-					foreach ($post_count_ary as $forum_id => $allowed)
-					{
-						if ($allowed['f_read'] && $allowed['f_postcount'])
-						{
-							$forum_ary[] = $forum_id;
-						}
-					}
-	
-					$post_count_sql = (sizeof($forum_ary)) ? 'AND f.forum_id IN (' . implode(', ', $forum_ary) . ')' : '';
-					unset($forum_ary, $post_count_ary);
-	
-					if ($post_count_sql)
-					{
-						// NOTE: The following three queries could be a problem for big boards
-						
-						// Grab all the relevant data
-						$sql = 'SELECT COUNT(p.post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND f.forum_id = p.forum_id 
-								$post_count_sql";
-						$result = $_CLASS['core_db']->query($sql);
-						list($num_posts) = $_CLASS['core_db']->fetch_row_num($result);
-						$_CLASS['core_db']->free_result($result);
-	
-						$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $num_posts);
-	
-						$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND f.forum_id = p.forum_id 
-								$post_count_sql
-							GROUP BY f.forum_id, f.forum_name  
-							ORDER BY num_posts DESC"; 
-						$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-						$active_f_row = $_CLASS['core_db']->fetch_row_assoc($result);
-						$_CLASS['core_db']->free_result($result);
-	
-						$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND t.topic_id = p.topic_id  
-								AND f.forum_id = t.forum_id 
-								$post_count_sql
-							GROUP BY t.topic_id, t.topic_title  
-							ORDER BY num_posts DESC";
-						$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-						$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
-						$_CLASS['core_db']->free_result($result);
-					}
-				}
-			*/
 				// Do the relevant calculations 
 				$memberdays = max(1, round(($_CLASS['core_user']->time - $_CLASS['core_user']->data['user_reg_date']) / 86400));
 				$posts_per_day = $_CLASS['core_user']->data['user_posts'] / $memberdays;
 				$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
 				$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+
 				if (!empty($active_f_row['num_posts']))
 				{
 					$active_f_name = $active_f_row['forum_name'];
@@ -216,6 +157,7 @@
 				unset($active_f_row);
 
 				$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+
 				if (!empty($active_t_row['num_posts']))
 				{
 					$active_t_name = $active_t_row['topic_title'];
@@ -430,17 +372,24 @@
 					topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
 					$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-					$view_topic_url = "Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id";
+					$view_topic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id";
+					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['topics_per_page'], 0);
 
 					$_CLASS['core_template']->assign_vars_array('topicrow', array(
 						'FORUM_ID' 			=> $forum_id,
 						'TOPIC_ID' 			=> $topic_id,
-						'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+
+						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-						'PAGINATION' 		=> topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . "&amp;t=$topic_id"),
+
+						'PAGINATION'		=> $pagination['formated'],
+						'PAGINATION_ARRAY'	=> $pagination['array'],
+
 						'REPLIES' 			=> $replies,
 						'VIEWS' 			=> $row['topic_views'],
 						'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
@@ -452,11 +401,11 @@
 						'TOPIC_ICON_IMG'	=> (!empty($icons[$row['icon_id']])) ? '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />' : '',
 						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', sprintf($_CLASS['core_user']->lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
 
-						'S_TOPIC_TYPE'			=> $row['topic_type'],
-						'S_UNREAD_TOPIC'		=> $unread_topic,
+						'S_TOPIC_TYPE'		=> $row['topic_type'],
+						'S_UNREAD_TOPIC'	=> $unread_topic,
 
 						'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] != ANONYMOUS && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] && $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 						'U_VIEW_TOPIC'		=> generate_link($view_topic_url))
 					);
 					
@@ -597,7 +546,9 @@
 						'TOPIC_TYPE' 		=> $topic_type,
 						'FORUM_NAME'		=> $row['forum_name'],
 
-						'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm_compose.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -78,11 +78,6 @@
 		redirect($redirect);
 	}
 
-	if ($action == 'forward' && (!$config['forward_pm'] || !$_CLASS['auth']->acl_get('u_pm_forward')))
-	{
-		trigger_error('NO_AUTH_FORWARD_MESSAGE');
-	}
-
 	if ($action == 'edit' && !$_CLASS['auth']->acl_get('u_pm_edit'))
 	{
 		trigger_error('NO_AUTH_EDIT_MESSAGE');
@@ -662,9 +657,10 @@
 		}
 
 		$u = $g = array();
+
 		foreach (array('u', 'g') as $type)
 		{
-			if (isset($result[$type]) && $result[$type])
+			if (isset($result[$type]))
 			{
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result[$type]))
 				{
@@ -723,26 +719,27 @@
 	{
 		case 'post':
 			$page_title = $_CLASS['core_user']->lang['POST_NEW_PM'];
-			break;
+		break;
 
 		case 'quote':
 			$page_title = $_CLASS['core_user']->lang['POST_QUOTE_PM'];
-			break;
+		break;
 
 		case 'reply':
 			$page_title = $_CLASS['core_user']->lang['POST_REPLY_PM'];
-			break;
+		break;
 
 		case 'edit':
 			$page_title = $_CLASS['core_user']->lang['POST_EDIT_PM'];
-			break;
+		break;
 
 		case 'forward':
 			$page_title = $_CLASS['core_user']->lang['POST_FORWARD_PM'];
-			break;
+		break;
 
 		default:
 			trigger_error('NO_ACTION_MODE');
+		break;
 	}
 
 	$s_hidden_fields = '<input type="hidden" name="lastclick" value="' . $current_time . '" />';
@@ -843,7 +840,9 @@
 			require_once(SITE_FILE_ROOT.'includes/functions_user.php');
 
 			$user_id_ary = user_get_id($usernames, $difference);
-			
+
+			unset($user_id_ary[ANONYMOUS]);
+
 			if (!empty($user_id_ary))
 			{
 				foreach ($user_id_ary as $user_id)
@@ -854,7 +853,7 @@
 		}
 
 		// Add Friends if specified
-		$friend_list = (is_array($_REQUEST['add_' . $type])) ? array_map('intval', array_keys($_REQUEST['add_' . $type])) : array();
+		$friend_list = is_array($_REQUEST['add_' . $type]) ? array_map('intval', array_keys($_REQUEST['add_' . $type])) : array();
 
 		foreach ($friend_list as $user_id)
 		{

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -1,11 +1,33 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: ucp_prefs.php,v 1.15 2004/06/06 21:44:48 acydburn Exp $
 //
 // FILENAME  : ucp_prefs.php
 // STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -29,32 +51,32 @@
 				{
 					$time_format	= get_variable('time_format', 'REQUEST', null);
 					$lang			= get_variable('lang', 'REQUEST', null);
-					$tz				= get_variable('tz', 'REQUEST', null);
+					$tz				= get_variable('tz', 'REQUEST', 0);
 					$dst			= get_variable('dst', 'REQUEST', null);
 
 					$theme 		= get_variable('theme', 'REQUEST', null);
-	
+
 					$viewemail		= (bool) get_variable('viewemail', 'REQUEST', true, 'interger');
 					$massemail		= (bool) get_variable('massemail', 'REQUEST', false, 'interger');
-					$hideonline	= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
-					$notifypm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
+					$hideonline		= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
+					$notify_pm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
 
 					$popuppm	= (bool) get_variable('popuppm', 'REQUEST', true, 'interger');
 					$allowpm	= (bool) get_variable('allowpm', 'REQUEST', true, 'interger');
-				//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
+					//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
 
 					if (empty($error))
 					{
 						$_CLASS['core_user']->optionset('popuppm', $popuppm);
 						//$_CLASS['core_user']->optionset('report_pm_notify', $report_pm_notify);
 						
-						$sql_ary = array(
+						$sql_array = array(
 							'user_allow_pm'			=> $allowpm, 
 							'user_allow_viewemail'	=> $viewemail, 
 							'user_allow_massemail'	=> $massemail, 
 							'user_allow_viewonline'	=> ($_CLASS['forums_auth']->acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']->data['user_allow_viewonline'], 
 							//'user_notify_type'		=> $notifymethod, 
-							//'user_notify_pm'		=> $notifypm,
+							'user_notify_pm'		=> $notify_pm,
 							'user_data'				=> serialize($_CLASS['core_user']->data['user_data']), 
 
 							'user_dst'				=> $dst,
@@ -64,55 +86,58 @@
 							'user_theme'			=> $theme,
 						);
 
+						array_merge($_CLASS['core_user']->data, $sql_array);
+
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 						$_CLASS['core_db']->sql_query($sql);
 						
-						if ($theme != $_CLASS['core_display']->theme)
+						if ($theme !== $_CLASS['core_display']->theme_name)
 						{
 							$_CLASS['core_user']->session_data_remove('user_theme');
 						}
 						
 						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
+
 						trigger_error($message);
 					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				$viewemail = (isset($viewemail)) ? $viewemail : $_CLASS['core_user']->data['user_allow_viewemail'];
+				$allowpm = isset($allowpm) ? $allowpm : $_CLASS['core_user']->data['user_allow_pm'];
+				$dst = isset($dst) ? $dst : $_CLASS['core_user']->data['user_dst'];
+				$hideonline = isset($hideonline) ? $hideonline : !$_CLASS['core_user']->data['user_allow_viewonline'];
+				$massemail = isset($massemail) ? $massemail : $_CLASS['core_user']->data['user_allow_massemail'];
+				$notifypm = isset($notifypm) ? $notifypm : $_CLASS['core_user']->data['user_notify_pm'];
+				$popuppm = isset($popuppm) ? $popuppm : $_CLASS['core_user']->optionget('popuppm');
+				$viewemail = isset($viewemail) ? $viewemail : $_CLASS['core_user']->data['user_allow_viewemail'];
+				$report_pm_notify = isset($report_pm_notify) ? $report_pm_notify : $_CLASS['core_user']->optionget('report_pm_notify');
+				$notifymethod = isset($notifymethod) ? $notifymethod : $_CLASS['core_user']->data['user_notify_type'];
+				$dateformat = isset($dateformat) ? $dateformat : $_CLASS['core_user']->data['user_time_format'];
+				$lang = isset($lang) ? $lang : $_CLASS['core_user']->data['user_lang'];
+				$theme = isset($theme) ? $theme : $_CLASS['core_user']->data['user_theme'];
+				$tz = isset($tz) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
+
 				$view_email_yes = ($viewemail) ? ' checked="checked"' : '';
 				$view_email_no = (!$viewemail) ? ' checked="checked"' : '';
-				$massemail = (isset($massemail)) ? $massemail : $_CLASS['core_user']->data['user_allow_massemail'];
 				$mass_email_yes = ($massemail) ? ' checked="checked"' : '';
 				$mass_email_no = (!$massemail) ? ' checked="checked"' : '';
-				$allowpm = (isset($allowpm)) ? $allowpm : $_CLASS['core_user']->data['user_allow_pm'];
 				$allow_pm_yes = ($allowpm) ? ' checked="checked"' : '';
 				$allow_pm_no = (!$allowpm) ? ' checked="checked"' : '';
-				$hideonline = (isset($hideonline)) ? $hideonline : !$_CLASS['core_user']->data['user_allow_viewonline'];
 				$hide_online_yes = ($hideonline) ? ' checked="checked"' : '';
 				$hide_online_no = (!$hideonline) ? ' checked="checked"' : '';
-				$notifypm = (isset($notifypm)) ? $notifypm : '';
 				$notify_pm_yes = ($notifypm) ? ' checked="checked"' : '';
 				$notify_pm_no = (!$notifypm) ? ' checked="checked"' : '';
-				$popuppm = (isset($popuppm)) ? $popuppm : $_CLASS['core_user']->optionget('popuppm');
 				$popup_pm_yes = ($popuppm) ? ' checked="checked"' : '';
 				$popup_pm_no = (!$popuppm) ? ' checked="checked"' : '';
-				$report_pm_notify = (isset($report_pm_notify)) ? $report_pm_notify : $_CLASS['core_user']->optionget('report_pm_notify');
 				$report_pm_notify_yes = ($report_pm_notify) ? ' checked="checked"' : '';
 				$report_pm_notify_no = (!$report_pm_notify) ? ' checked="checked"' : '';
-				$dst = (isset($dst)) ? $dst : $_CLASS['core_user']->data['user_dst'];
 				$dst_yes = ($dst) ? ' checked="checked"' : '';
 				$dst_no = (!$dst) ? ' checked="checked"' : '';
 
-				$notifymethod = (isset($notifymethod)) ? $notifymethod : $_CLASS['core_user']->data['user_notify_type'];
-				$dateformat = (isset($dateformat)) ? $dateformat : $_CLASS['core_user']->data['user_time_format'];
-				$lang = (isset($lang)) ? $lang : $_CLASS['core_user']->data['user_lang'];
-				$theme = (isset($theme)) ? $theme : $_CLASS['core_user']->data['user_theme'];
-				$tz = (isset($tz)) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
 
+
 				$_CLASS['core_template']->assign_array(array( 
 					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
 

Modified: cms/branches/1.0alpha2/modules/Forums/posting.php
===================================================================
--- cms/branches/1.0alpha2/modules/Forums/posting.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Forums/posting.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -1231,11 +1231,12 @@
 	{
 		// Try to delete topic, we may had an previous error causing inconsistency
 		/*
-		if ($post_mode = 'delete_topic')
+		if ($post_mode === 'delete_topic')
 		{
 			delete_topics('topic_id', array($topic_id), false);
 		}
 		*/
+
 		trigger_error('ALREADY_DELETED');
 	}
 
@@ -1259,7 +1260,7 @@
 
 			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-			break;
+		break;
 
 		case 'delete_first_post':
 			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
@@ -1281,7 +1282,7 @@
 			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 
 			$next_post_id = (int) $row['post_id'];
-			break;
+		break;
 			
 		case 'delete_last_post':
 			if ($data['topic_type'] != POST_GLOBAL)
@@ -1311,7 +1312,7 @@
 	
 				$next_post_id = (int) $row['last_post_id'];
 			}
-			break;
+		break;
 			
 		case 'delete':
 			$sql = 'SELECT post_id
@@ -1332,6 +1333,7 @@
 
 			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
 			$next_post_id = (int) $row['post_id'];
+		break;
 	}
 				
 	$sql_data[USERS_TABLE] = ($_CLASS['auth']->acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';

Modified: cms/branches/1.0alpha2/modules/Forums/search.php
===================================================================
--- cms/branches/1.0alpha2/modules/Forums/search.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Forums/search.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -47,7 +47,8 @@
 $_CLASS['core_user']->add_img();
 
 // Is user able to search? Has search been disabled?
-if ($_CLASS['core_user']->is_bot || !$_CLASS['auth']->acl_get('u_search') || !$config['load_search'])
+//!$_CLASS['auth']->acl_get('u_search') 
+if ($_CLASS['core_user']->is_bot || !$config['load_search'])
 {
 	trigger_error('NO_SEARCH');
 }

Modified: cms/branches/1.0alpha2/modules/Quick_Message/configurator.php
===================================================================
--- cms/branches/1.0alpha2/modules/Quick_Message/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/Quick_Message/configurator.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -85,6 +85,8 @@
 		$_CLASS['core_db']->query('DELETE FROM ' . CORE_CONFIG_TABLE . " WHERE config_section = 'quick_message'");
 
 		$_CLASS['core_db']->report_error(true);
+		
+		return true;
 	}
 }
 

Modified: cms/branches/1.0alpha2/modules/articles/configurator.php
===================================================================
--- cms/branches/1.0alpha2/modules/articles/configurator.php	2005-09-29 21:14:37 UTC (rev 149)
+++ cms/branches/1.0alpha2/modules/articles/configurator.php	2005-09-30 04:30:29 UTC (rev 150)
@@ -97,6 +97,8 @@
 		$_CLASS['core_db']->query('DROP TABLE ' . ARTICLES_TABLE);
 
 		$_CLASS['core_db']->report_error(true);
+		
+		return true;
 	}
 }
 



From viperal at berlios.de  Fri Sep 30 17:46:48 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 30 Sep 2005 17:46:48 +0200
Subject: [Viperals-svncheckins] r151 - in cms/branches/1.0alpha2: . admin includes/display includes/forums includes/templates/admin/system install modules/Control_Panel/ucp modules/Forums modules/calender
Message-ID: <200509301546.j8UFkmH7024048@sheep.berlios.de>

Author: viperal
Date: 2005-09-30 17:46:45 +0200 (Fri, 30 Sep 2005)
New Revision: 151

Modified:
   cms/branches/1.0alpha2/.htaccess
   cms/branches/1.0alpha2/admin/system.php
   cms/branches/1.0alpha2/includes/display/calender.php
   cms/branches/1.0alpha2/includes/forums/message_parser.php
   cms/branches/1.0alpha2/includes/templates/admin/system/index.html
   cms/branches/1.0alpha2/install/build_data.php
   cms/branches/1.0alpha2/installer.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_groups.php
   cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php
   cms/branches/1.0alpha2/modules/Forums/viewforum.php
   cms/branches/1.0alpha2/modules/calender/index.php
Log:


Modified: cms/branches/1.0alpha2/.htaccess
===================================================================
--- cms/branches/1.0alpha2/.htaccess	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/.htaccess	2005-09-30 15:46:45 UTC (rev 151)
@@ -7,10 +7,10 @@
 allow from all
 </LimitExcept>
 
-ErrorDocument 400 error.php
-ErrorDocument 401 error.php
-ErrorDocument 403 error.php
-ErrorDocument 404 error.php
-ErrorDocument 500 error.php
+ErrorDocument 400 /error.php
+ErrorDocument 401 /error.php
+ErrorDocument 403 /error.php
+ErrorDocument 404 /error.php
+ErrorDocument 500 /error.php
 
 Options -Indexes
\ No newline at end of file

Modified: cms/branches/1.0alpha2/admin/system.php
===================================================================
--- cms/branches/1.0alpha2/admin/system.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/admin/system.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -21,9 +21,6 @@
 $Id$
 */
 
-
-// Need to redo this, do all check before the saving
-
 if (VIPERAL !== 'Admin') 
 {
 	die;
@@ -46,36 +43,150 @@
 	'SYSTEM_MODE'	=> $mode,
 ));
 
-$save = (isset($_POST['submit'])) ? true : false;
+$save = isset($_POST['submit']);
 
 switch ($mode)
 {
 	case 'site':
-		admin_site($save);
-	break;
+		if ($save)
+		{
+			$data = array(
+				'global'	=> array(
+					'default_theme'		=> get_variable('default_theme', 'POST', ''),
+					'link_optimization' => get_variable('link_optimization', 'POST', 0, 'int'),
+					'site_name'			=> get_variable('site_name', 'POST', ''),
+					'site_url'			=> get_variable('site_url', 'POST', ''),
+					'foot1'				=> get_variable('foot1', 'POST', ''),
+					'foot2'				=> get_variable('foot2', 'POST', ''),
+				),
+				'email'	=> array(
+					'email_enable'			=> get_variable('email_enable', 'POST') ? 1 : 0,
+					'email_function_name'	=> get_variable('email_function_name', 'POST', ''),
+					'smtp'					=> get_variable('smtp', 'POST', 0, 'int'),
+					'smtp_host'				=> get_variable('smtp_host', 'POST', ''),
+					'smtp_port'				=> get_variable('smtp_port', 'POST', '', 'int'),
+					'smtp_username'			=> get_variable('smtp_username', 'POST', ''),
+					'smtp_password'			=> get_variable('smtp_password', 'POST', ''),
+					'site_email'			=> get_variable('site_email', 'POST', ''),
+				)
+			);
+			
+			setting_save($data);
 
-	case 'users':
-		//admin_users($save);
+			unset($data);
+		}
+	
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$_CLASS['core_template']->assign_array(array(
+			'A_OPTION'		=> 'site',
+			'ACTION'		=> generate_link('system', array('admin' => true)),
+			
+			'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
+	
+			'SELECT_THEME' 		=> select_theme($_CORE_CONFIG['global']['default_theme']),
+			'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
+	
+			'EMAIL_ENABLE'		=> $_CORE_CONFIG['email']['email_enable'],
+			'EMAIL_FUNCTION_NAME'=> $_CORE_CONFIG['email']['email_function_name'],
+			'SMTP'				=> $_CORE_CONFIG['email']['smtp'],
+			'SMTP_HOST'			=> $_CORE_CONFIG['email']['smtp_host'],
+			'SMTP_PORT'			=> $_CORE_CONFIG['email']['smtp_port'],
+			'SMTP_USERNAME'		=> $_CORE_CONFIG['email']['smtp_username'],
+			'SMTP_PASSWORD'		=> $_CORE_CONFIG['email']['smtp_password'],
+			'SITE_EMAIL'		=> $_CORE_CONFIG['email']['site_email'],
+	
+			'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
+			'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
+		));
+	
+		$_CLASS['core_template']->display('admin/system/index.html');
 	break;
 
 	case 'system':
-		admin_system($save);
+		if ($save)
+		{
+			if (!empty($_POST['maintenance_start']))
+			{
+				$expires = strtotime($_POST['maintenance_start']);
+				$_POST['maintenance_start'] = (!$expires || $expires === -1) ? 0 : $expires;
+			}
+	
+			$data = array(
+				'maintenance' => array(
+						'active' 	=> get_variable('maintenance', 'POST') ? 1 : 0,
+						'text'		=> get_variable('maintenance_text', 'POST', ''),
+						'start' 	=> get_variable('maintenance_start', 'POST', 0, 'int'),
+				),
+				'server' => array(
+					'cookie_domain' => get_variable('cookie_domain', 'POST', ''),
+					'cookie_name' 	=> get_variable('cookie_name', 'POST', ''),
+					'cookie_path' 	=> get_variable('cookie_path', 'POST', ''),
+					'error_options'	=> get_variable('error_options', 'POST', 0, 'int'),
+					'site_domain'	=> get_variable('site_domain', 'POST', ''),
+					'site_port' 	=> get_variable('site_port', 'POST', ''),
+					'site_path' 	=> get_variable('site_path', 'POST', ''),
+					'site_secure'	=> get_variable('site_secure', 'POST', 0, 'int'),
+					'ip_check' 		=> get_variable('ip_check', 'POST', 0, 'int'),
+					'limit_load' 	=> get_variable('limit_load', 'POST', 0, 'int'),
+					'limit_sessions'	=> get_variable('limit_sessions', 'POST', 0, 'int'),
+					'session_length'	=> get_variable('session_length', 'POST', 600, 'int'),
+				)
+			);
+	
+			setting_save($data);
+	
+			unset($data);
+		}
+		
+		global $_CLASS, $_CORE_CONFIG;
+	
+		$path = str_replace('\\','/', dirname(getenv('SCRIPT_NAME')));
+		
+		if (substr($path, -1) !== '/')
+		{
+			$path .= '/';
+		}
+	
+		$domain = empty($_SERVER['SERVER_NAME']) ? $_SERVER['HTTP_HOST'] : $_SERVER['SERVER_NAME'];
+	
+		$_CLASS['core_template']->assign_array(array(
+			'A_OPTION' 			=> 'system',
+			'ACTION'			=> generate_link('system&amp;mode=system', array('admin' => true)),
+			
+			'COOKIE_DOMAIN' => $_CORE_CONFIG['server']['cookie_domain'],
+			'COOKIE_NAME' 	=> $_CORE_CONFIG['server']['cookie_name'],
+			'COOKIE_PATH' 	=> $_CORE_CONFIG['server']['cookie_path'],
+			'ERROR'			=> $_CORE_CONFIG['server']['error_options'],
+			'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
+			'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
+			'MAINTENANCE_START' => is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']->format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
+			'IP_CHECK'			=> $_CORE_CONFIG['server']['ip_check'],
+			'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
+			'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],
+			'SITE_PORT'			=> $_CORE_CONFIG['server']['site_port'],
+			'SITE_SECURE'		=> $_CORE_CONFIG['server']['site_secure'],
+			'LIMIT_LOAD'		=> $_CORE_CONFIG['server']['limit_load'],
+			'LIMIT_SESSIONS'	=> $_CORE_CONFIG['server']['limit_sessions'],
+			'SESSION_LENGTH'	=> $_CORE_CONFIG['server']['session_length'],
+			
+		));
+	
+		$_CLASS['core_template']->display('admin/system/index.html');
 	break;
 }
 
-function admin_save($data)
+function setting_save($data)
 {
 	global $_CLASS, $_CORE_CONFIG;
 	
 	foreach ($data AS $section => $option)
     {
-		foreach ($option AS $db_name => $data_op)
+		foreach ($option AS $name => $value)
 		{
-			$value = get_variable($data_op['post_name'], 'POST', false);
-
-			if ($value != $_CORE_CONFIG[$section][$db_name])
+			if (isset($_CORE_CONFIG[$section][$name]) && $value != $_CORE_CONFIG[$section][$name])
 			{
-				set_core_config($section, $db_name, $value, false);
+				set_core_config($section, $name, $value, false);
 			}
 		}
     }
@@ -83,102 +194,4 @@
 	$_CLASS['core_cache']->destroy('core_config');
 }
 
-function admin_site($save)
-{
-	if ($save)
-	{
-		$data = array('global'	=> array(
-			'default_theme'		=> array('post_name' => 'default_theme'),
-			'link_optimization' => array('post_name' => 'link_optimization'),
-			'site_name'			=> array('post_name' => 'site_name'),
-			'site_url'			=> array('post_name' => 'site_url'),
-			'start_date'		=> array('post_name' => 'start_date'),
-			'foot1'				=> array('post_name' => 'foot1'),
-			'foot2'				=> array('post_name' => 'foot2'),
-		));
-		admin_save($data);
-	}
-
-	global $_CLASS, $_CORE_CONFIG;
-
-	$_CLASS['core_template']->assign_array(array(
-		'A_OPTION'		=> 'site',
-		'ACTION'		=> generate_link('system', array('admin' => true)),
-		
-		'LINK_OPTIMIZATION' => $_CORE_CONFIG['global']['link_optimization'],
-
-		'SELECT_THEME' 		=> select_theme($_CORE_CONFIG['global']['default_theme']),
-		'SITE_NAME'			=> $_CORE_CONFIG['global']['site_name'],
-		'SITE_URL'			=> $_CORE_CONFIG['global']['site_url'],
-		'START_DATE'		=> $_CORE_CONFIG['global']['start_date'],
-
-		'FOOTER_FIRST' 		=> $_CORE_CONFIG['global']['foot1'],
-		'FOOTER_SECOND' 	=> $_CORE_CONFIG['global']['foot2'],
-		
-	));
-
-	$_CLASS['core_template']->display('admin/system/index.html');
-}
-
-function admin_system($save)
-{
-	if ($save)
-	{
-		if (!empty($_POST['maintenance_start']))
-		{
-			$expires = strtotime($_POST['maintenance_start']);
-			$_POST['maintenance_start'] = (!$expires || $expires == -1) ? '' : $expires;
-		}
-
-		$data = array(
-			'maintenance' => array(
-					'active' => array('post_name' => 'maintenance'),
-					'text' => array('post_name' => 'maintenance_text'),
-					'start' => array('post_name' => 'maintenance_start'),
-			),
-			'server' => array(
-				'cookie_domain' => array('post_name' => 'cookie_domain'),
-				'cookie_name' 	=> array('post_name' => 'cookie_name'),
-				'cookie_path' 	=> array('post_name' => 'cookie_path'),
-				'error_options'	=> array('post_name' => 'error_options'),
-				'site_domain'	=> array('post_name' => 'site_domain'),
-				'site_port' 	=> array('post_name' => 'site_port'),
-				'site_path' 	=> array('post_name' => 'site_path'),
-				'site_secure'	=> array('post_name' => 'site_secure'),
-				'ip_check' 		=> array('post_name' => 'ip_check'),
-				'limit_load' 	=> array('post_name' => 'limit_load'),
-				'limit_sessions'	=> array('post_name' => 'limit_sessions'),
-				'session_length'	=> array('post_name' => 'session_length'),
-			)
-		);
-		admin_save($data);
-	}
-	
-	global $_CLASS, $_CORE_CONFIG;
-   
-    $_CLASS['core_template']->assign_array(array(
-		'A_OPTION' 			=> 'system',
-		'ACTION'			=> generate_link('system&amp;mode=system', array('admin' => true)),
-		
-		'COOKIE_DOMAIN' => $_CORE_CONFIG['server']['cookie_domain'],
-		'COOKIE_NAME' 	=> $_CORE_CONFIG['server']['cookie_name'],
-		'COOKIE_PATH' 	=> $_CORE_CONFIG['server']['cookie_path'],
-		'ERROR'			=> $_CORE_CONFIG['server']['error_options'],
-		'MAINTENANCE' 		=> $_CORE_CONFIG['maintenance']['active'],
-		'MAINTENANCE_MSG' 	=> $_CORE_CONFIG['maintenance']['text'],
-		'MAINTENANCE_START' => is_numeric($_CORE_CONFIG['maintenance']['start']) ? $_CLASS['core_user']->format_date($_CORE_CONFIG['maintenance']['start'], 'M d, Y h:i a') : '',
-		'IP_CHECK'			=> $_CORE_CONFIG['server']['ip_check'],
-		'SITE_DOMAIN'		=> $_CORE_CONFIG['server']['site_domain'],
-		'SITE_PATH'			=> $_CORE_CONFIG['server']['site_path'],
-		'SITE_PORT'			=> $_CORE_CONFIG['server']['site_port'],
-		'SITE_SECURE'		=> $_CORE_CONFIG['server']['site_secure'],
-		'LIMIT_LOAD'		=> $_CORE_CONFIG['server']['limit_load'],
-		'LIMIT_SESSIONS'	=> $_CORE_CONFIG['server']['limit_sessions'],
-		'SESSION_LENGTH'	=> $_CORE_CONFIG['server']['session_length'],
-		
-	));
-
-	$_CLASS['core_template']->display('admin/system/index.html');
-}
-
 ?>
\ No newline at end of file

Modified: cms/branches/1.0alpha2/includes/display/calender.php
===================================================================
--- cms/branches/1.0alpha2/includes/display/calender.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/includes/display/calender.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -192,7 +192,7 @@
 		}
 		
 		$date = explode(':', date('n:d:y', $time));
-		
+
 		$day['start'] = mktime(0, 0, 0, $date[0], $date[1], $date[2]) + 60;
 		$day['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 
@@ -249,7 +249,7 @@
 			$time = mktime(12, 0, 0, $this->month, $this->day, $this->year);
 		}
 		
-		$date = explode(',', date('n,t,Y', $time));
+		$date = explode(':', date('n:t:Y', $time));
 		$month['start'] = mktime(0, 0, 0, $date[0], 1, $date[2]);
 		$month['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 

Modified: cms/branches/1.0alpha2/includes/forums/message_parser.php
===================================================================
--- cms/branches/1.0alpha2/includes/forums/message_parser.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/includes/forums/message_parser.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -1430,11 +1430,15 @@
 
 			if (!empty($word_ary))
 			{
+				$_CLASS['core_db']->report_error(false);
+
 				$sql = 'INSERT INTO ' . FORUMS_SEARCH_MATCH_TABLE . " (post_id, word_id, title_match) 
 					SELECT $post_id, word_id, $title_match 
 					FROM " . FORUMS_SEARCH_WORD_TABLE . ' 
 					WHERE word_text IN (' . implode(', ', preg_replace('#^(.*)$#', '\'$1\'', $word_ary)) . ')';
 				$_CLASS['core_db']->query($sql);
+
+				$_CLASS['core_db']->report_error(true);
 			}
 		}
 

Modified: cms/branches/1.0alpha2/includes/templates/admin/system/index.html
===================================================================
--- cms/branches/1.0alpha2/includes/templates/admin/system/index.html	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/includes/templates/admin/system/index.html	2005-09-30 15:46:45 UTC (rev 151)
@@ -37,14 +37,6 @@
 			<td class="row2"><input class="post" size="40" maxlength="255" name="site_name" value="{ $SITE_NAME }" type="text"></td>
 		</tr>
 		<tr>
-			<td class="row1" width="50%"><b>{ $L_SITE_URL }: </b></td>
-			<td class="row2"><input class="post" size="40" maxlength="255" name="site_url" value="{ $SITE_URL }" type="text"></td>
-		</tr>
-		<tr>
-			<td class="row1" width="50%"><b>{ $L_START_DATE }: </b></td>
-			<td class="row2"><input class="post" size="40" maxlength="255" name="startdate" value="{ $START_DATE }" type="text"></td>
-		</tr>
-		<tr>
 			<td class="row1" width="50%"><b>{ $L_LINK_OPTIMIZATION }: </b></td>
 			<td class="row2"><input name="link_optimization" value="1" <!-- IF { $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="link_optimization" value="0" <!-- IF !{ $LINK_OPTIMIZATION } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
 		</tr>
@@ -58,11 +50,53 @@
 			</td>
 		</tr>
 		<tr>
-		<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
+			<td class="row1" width="50%" valign="top"><b>{ $L_FOOTER_MESSAGE }: </b></td>
 			<td class="row2">
-			<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
-			<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
+				<textarea name="foot1" rows="5" cols="40">{ $FOOTER_FIRST }</textarea><br /><br />
+				<textarea name="foot2" rows="5" cols="40">{ $FOOTER_SECOND }</textarea>
+			</td>
 		</tr>
+		<tr>
+			<th colspan="2">{ $L_EMAIL }</th>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_EMAIL_ENABLE }: </b></td>
+			<td class="row2"><input name="email_enable" value="1" <!-- IF { $EMAIL_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_YES }&nbsp;&nbsp;<input name="email_enable" value="0" <!-- IF !{ $EMAIL_ENABLE } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_NO }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_MAIL_MODE }: </b></td>
+			<td class="row2"><input name="smtp" value="1" <!-- IF { $SMTP } --> checked="checked" <!-- ENDIF --> type="radio"> { $L_SMTP }&nbsp;&nbsp;<input name="smtp" value="0" <!-- IF !{ $SMTP } --> checked="checked" <!-- ENDIF --> type="radio">{ $L_FUNCTION }</td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SITE_EMAIL }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="site_email" value="{ $SITE_EMAIL }" type="text"></td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row2"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_EMAIL_FUNCTION_NAME }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="email_function_name" value="{ $EMAIL_FUNCTION_NAME }" type="text"></td>
+		</tr>
+		<tr>
+			<td colspan="2" class="row2"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_SERVER }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_host" value="{ $SMTP_HOST }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_PORT }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_port" value="{ $SMTP_PORT }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_USERNAME }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_username" value="{ $SMTP_USERNAME }" type="text"></td>
+		</tr>
+		<tr>
+			<td class="row1" width="50%"><b>{ $L_SMTP_PASSWORD }: </b></td>
+			<td class="row2"><input class="post" size="40" maxlength="255" name="smtp_password" value="{ $SMTP_PASSWORD }" type="text"></td>
+		</tr>
 	<!-- ELSEIF { $SYSTEM_MODE } == 'system' -->
 		<tr>
 			<th colspan="2">{ $L_MAINTENANCE }</th>
@@ -74,9 +108,8 @@
 		<tr>
 			<td class="row1" width="50%"><b>{ $L_MAINTENANCE_START }: </b></td>
 			<td class="row2">
-			<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
-				<img src="java/jscalendar/calendar.png" style="cursor: pointer;" id="time_trigger" />
-				
+				<input class="post" size="40" maxlength="255" id="maintenance_start" name="maintenance_start" value="{ $MAINTENANCE_START }" type="text">
+				<img src="images/calender_small.png" style="cursor: pointer;" id="time_trigger" />
 			</td>
 		</tr>
 		<tr>
@@ -110,8 +143,7 @@
 
 		<tr>
 			<td class="row1" width="50%"><b>Session IP validation: </b><br><span class="gensmall">Determines how much of the users IP is used to validate a session; All compares the complete address, A.B.C the first x.x.x, A.B the first x.x, None disables checking.</span></td>
-			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF { $IP_CHECK } --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
-	
+			<td class="row2"><input name="ip_check" value="4" <!-- IF { $IP_CHECK } == 4  -->checked="checked" <!-- ENDIF -->type="radio"> All&nbsp;&nbsp;<input name="ip_check" value="3" <!-- IF { $IP_CHECK } == 3 -->checked="checked" <!-- ENDIF --> type="radio"> A.B.C&nbsp;&nbsp;<input name="ip_check" value="2" <!-- IF { $IP_CHECK } == 2 --> checked="checked" <!-- ENDIF --> type="radio"> A.B&nbsp;&nbsp;<input name="ip_check" value="0" <!-- IF !{ $IP_CHECK } --> checked="checked" <!-- ENDIF --> type="radio"> None&nbsp;&nbsp;</td>
 		</tr>
 		<tr>
 			<td class="row1" width="50%"><b>Limit system load: </b><br><span class="gensmall">If the 1 minute system load exceeds this value the board will go offline, 1.0 equals ~100% utilisation of one processor. This only functions on UNIX based servers.</span></td>

Modified: cms/branches/1.0alpha2/install/build_data.php
===================================================================
--- cms/branches/1.0alpha2/install/build_data.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/install/build_data.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -129,7 +129,7 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
@@ -176,7 +176,7 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");

Modified: cms/branches/1.0alpha2/installer.php
===================================================================
--- cms/branches/1.0alpha2/installer.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/installer.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -23,6 +23,7 @@
 define('VIPERAL', 'INSTALLER');
 
 error_reporting(0);
+//error_reporting(E_ALL);
 
 define('SITE_FILE_ROOT', str_replace('\\','/', dirname(getenv('SCRIPT_FILENAME'))).'/');
 

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_calender.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -23,6 +23,8 @@
 
 class ucp_calender extends module  
 {
+	var $error = array();
+
 	function ucp_calender($id, $mode)
 	{
 		global $_CLASS, $table_prefix, $site_file_root;
@@ -42,7 +44,7 @@
 		$_CLASS['calender']->table = CALENDER_TABLE;
 		$_CLASS['calender']->set_date($day, $month, $year);
 		
-		if (isset($_GET['mode']) && $_GET['mode'] == 'details')
+		if (isset($_GET['mode']) && $_GET['mode'] === 'details')
 		{
 			$mode = 'details';
 		}
@@ -81,15 +83,14 @@
 			case 'add_event':
 				if (isset($_POST['submit']))
 				{
-					if ($this->add_event() === false)
+					if ($this->add_event() !== false)
 					{
-						echo implode('<br/>', $this->error);
-					}
-					
-					break;
+						trigger_error('EVENT_ADDED');
+					}			
 				}
 
 				$_CLASS['core_template']->assign_array(array(
+					'ERROR'			=> empty($this->error) ? '' : implode('<br/>', $this->error),
 					'S_UCP_ACTION'	=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"),
 				));
 
@@ -112,9 +113,8 @@
 				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_details.html');
 			break;
 			
-			case 'month_view':
+			//case 'month_view':
 			default:
-				
 				$_CLASS['calender']->get_events_month($link);
 				$_CLASS['calender']->month_view($link);
 
@@ -150,47 +150,50 @@
 		global $_CLASS;
 
 		$data_array = array(
-			'calender_title'	=> get_variable('title', 'POST', false),
-			'calender_text'		=> get_variable('description', 'POST', false),
-			'calender_notes'	=> get_variable('note', 'POST', false),
+			'calender_title'	=> mb_strtolower(htmlentities(get_variable('title', 'POST', ''), ENT_QUOTES, 'UTF-8')),
+			'calender_text'		=> strip_tags(get_variable('description', 'POST', false)),
+			'calender_notes'	=> strip_tags(get_variable('note', 'POST', false)),
 			'calender_starts'	=> get_variable('start', 'POST', false),
 			'calender_expires'	=> get_variable('end', 'POST', false),
 			//'recur'			=> false,
 		);
 
-		$error = array();
+		$this->error = array();
 
+		if (empty($data_array['calender_title']))
+		{
+			$this->error[] = $_CLASS['core_user']->get_lang('NO_TITLE');
+		}
+
 		$start_time = strtotime($data_array['calender_starts']);
 
 		if (!$start_time || $start_time === -1)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_START_TIME');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_START_TIME');
 		}
 
 		$end_time = strtotime($data_array['calender_expires']);
 
 		if (!$end_time || $end_time === -1)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_END_TIME');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_END_TIME');
 		}
 		
-		if (!$error && $start_time > $end_time)
+		if (empty($this->error) && $start_time > $end_time)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_');
 		}
 
-		if (!empty($error))
+		if (!empty($this->error))
 		{
-			$this->error = $error;
-
 			return false;
 		}
 
 		//$duration = $start_time - $end_time;
 		//$start_time = $date = implode(''. explode(':', date('H:i', $start_time)));;
 
-		$data_array['calender_starts'] = $start_time;
-		$data_array['calender_expires'] = $end_time;
+		$data_array['calender_starts'] = $_CLASS['core_user']->time_convert($start_time, 'gmt');
+		$data_array['calender_expires'] = $_CLASS['core_user']->time_convert($end_time, 'gmt');
 		
 		$_CLASS['core_db']->query('INSERT INTO ' . CALENDER_TABLE .' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data_array));
 

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_groups.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_groups.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -35,7 +35,7 @@
 		{
 			if (is_array($_POST['group_id']))
 			{
-				$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
+				$group_id = array_unique(get_variable('group_id', 'REQUEST', array(), 'array:int'));
 			}
 			else
 			{
@@ -59,11 +59,6 @@
 			switch ($_POST['mode'])
 			{
 				case 'resign':
-// need to get member status and add other group types ( pending members can resign from all )
-					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
-								WHERE group_type IN (' . GROUP_SYSTEM .', '.GROUP_SPECIAL.')
-								AND group_id IN ('. implode(', ', $group_id) .')';
-								
 					$sql = 'SELECT m.member_status, g.group_id, g.group_type
 								FROM ' . USER_GROUP_TABLE . ' m, ' . GROUPS_TABLE . ' g 
 								WHERE m.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
@@ -72,7 +67,6 @@
 					$result = $_CLASS['core_db']->query($sql);
 
 					$unset = array();
-
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
 						if ($row['group_type'] == GROUP_SYSTEM && $row['group_type'] == GROUP_SPECIAL && $row['member_status'] != STATUS_PENDING)
@@ -85,18 +79,20 @@
 					$group_id = array_diff($group_id, $unset);
 					unset($unset);
 
-					groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
+					if (!empty($group_id))
+					{
+						groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
+					}
 				break;
 
 				case 'apply':
 					$sql = 'SELECT group_id FROM ' . USER_GROUP_TABLE . '
 						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 						AND group_id IN ('. implode(', ', $group_id) .')';
-	
+
 					$result = $_CLASS['core_db']->query($sql);
 
 					$unset = array();
-
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
 						$unset[] = $row['group_id'];
@@ -188,7 +184,6 @@
 		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 
 		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
-		
 	}
 }
 

Modified: cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/modules/Control_Panel/ucp/ucp_main.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -29,7 +29,6 @@
 		switch ($mode)
 		{
 			case 'front':
-
 				$_CLASS['core_user']->add_lang(false,'Members_List');
 
 				if ($config['load_db_lastread'] || $config['load_db_track'])
@@ -194,36 +193,34 @@
 				break;
 
 			case 'subscribed':
-
 				require($site_file_root.'includes/forums/functions_display.php');
-				//$_CLASS['core_user']->add_lang('viewforum');
 
-				$unwatch = (isset($_POST['unwatch'])) ? true : false;
+				$unwatch = isset($_POST['unwatch']);
 				
 				if ($unwatch)
 				{
-					$forums = (isset($_POST['f'])) ? implode(', ', array_map('intval', array_keys($_POST['f']))) : false;
-					$topics = (isset($_POST['t'])) ? implode(', ', array_map('intval', array_keys($_POST['t']))) : false;
+					$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
+					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 
-					if ($forums || $topics)
+					if (!empty($forums) || !empty($topics))
 					{
 						$l_unwatch = '';
 
-						if ($forums)
+						if (!empty($forums))
 						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-								WHERE forum_id IN ($forums) AND topic_id = 0
-									AND user_id = " .$_CLASS['core_user']->data['user_id'];
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+								WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
+									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
 							$l_unwatch .= '_FORUMS';
 						}
 
-						if ($topics)
+						if (!empty($topics))
 						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-								WHERE topic_id IN ($topics)
-									AND user_id = " .$_CLASS['core_user']->data['user_id'];
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+								WHERE topic_id IN ('.implode(', ', $topics) .')
+									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
 							$l_unwatch .= '_TOPICS';
@@ -238,7 +235,8 @@
 
 				if ($config['load_db_lastread'])
 				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND ft.forum_id = f.forum_id)';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+									AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
 					$lastread_select = ', ft.mark_time ';
 				}
 				else
@@ -246,38 +244,44 @@
 					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
 					$lastread_select = '';
 
-					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+					$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+
+					if (!is_array($tracking))
+					{
+						$tracking = array();
+					}
 				}
 
 				$sql = "SELECT f.*$lastread_select 
 					FROM $sql_from, " . FORUMS_WATCH_TABLE . ' fw
 					WHERE fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-						AND f.forum_id = fw.forum_id 
+						 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
 					ORDER BY left_id';
 
 				$result = $_CLASS['core_db']->query($sql);
-				$topics_count = $_CLASS['core_db']->num_rows($result);
+				//$topics_count = $_CLASS['core_db']->num_rows($result);
 
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$forum_id = $row['forum_id'];
+					$forum_id = (int) $row['forum_id'];
 
 					$unread_forum = false;
 					
 					if ($config['load_db_lastread'])
 					{
-						$forum_check = $row['mark_time'];
+						$mark_time_forum = $row['mark_time'];
 					}
 					else
 					{
-						$forum_check = isset($tracking_topics[$forum_id][0]) ? $tracking_topics[$forum_id][0] : 0;
+						$forum_id36 = base_convert($forum_id, 10, 36);
+						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 					}
 
-					if ($forum_check < $row['forum_last_post_time'])
+					if ($mark_time_forum < $row['forum_last_post_time'])
 					{
 						$unread_forum = true;
 					}
-	
+
 					// Which folder should we display?
 					if ($row['forum_status'] == ITEM_LOCKED)
 					{
@@ -321,45 +325,62 @@
 				$_CLASS['core_db']->free_result($result);
 
 				// Subscribed Topics
-				$start = request_var('start', 0);
+				$start = get_variable('start', 'REQUEST', 0, 'int');
 
-				if ($topics_count)
+				if ($config['load_db_lastread'])
 				{
-					$_CLASS['core_template']->assign_array(array(
-						'PAGINATION'	=> generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start),
-						'PAGE_NUMBER'	=> on_page($topics_count, $config['topics_per_page'], $start),
-						'TOTAL_TOPICS'	=> ($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
-					);
+					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+					$sql_t_select = ', tt.mark_time';
 				}
-// Fix this up
-				$sql_from = ($config['load_db_lastread']) ? FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : TOPICS_TABLE . ' t';
-				$sql_t_select = ($config['load_db_lastread']) ? ', tt.mark_time' : '';
-//
+				else
+				{
+					$sql_from = FORUMS_TOPICS_TABLE . ' t';
+					$sql_t_select = '';
+				}
+
 				$sql = "SELECT t.* $sql_t_select 
 					FROM ". FORUMS_WATCH_TABLE . " tw, $sql_from 
 					WHERE tw.user_id = " . $_CLASS['core_user']->data['user_id'] . '
 						AND t.topic_id = tw.topic_id 
 					ORDER BY t.topic_last_post_time DESC';
+
 				$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+				$topics_count = $_CLASS['core_db']->num_rows($result);
+	
+				if ($topics_count)
+				{
+					$pagination = generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start);
 
+					$_CLASS['core_template']->assign_array(array(
+						'PAGINATION'		=> $pagination['formated'],
+						'PAGINATION_ARRAY'	=> $pagination['array'],
+						'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
+						'TOTAL_TOPICS'		=> ($topics_count === 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
+					);
+				}
+				else
+				{
+					$_CLASS['core_template']->assign('TOTAL_TOPICS', false);
+				}
+
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					$topic_id = $row['topic_id'];
 					$forum_id = $row['forum_id'];
 					
-					if ($config['load_db_lastread'])
+					if (!$config['load_db_lastread'])
 					{
 						$topic_id36 = base_convert($topic_id, 10, 36);
-						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : $forum_id;
-						$mark_time_topic = (isset($tracking_topics[$forum_id36][$topic_id36])) ? base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
+						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
 
-						$mark_time_forum = (isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+						$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 
 						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
 					}
 
 					// Replies
-					$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
+					$replies = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
 
 					if ($row['topic_status'] == ITEM_MOVED)
 					{
@@ -372,8 +393,8 @@
 					topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
 					$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-					$view_topic_url = "Forums&amp;file=viewtopic&amp;t=$topic_id";
-					$pagination = generate_pagination('Forums&amp;file=viewtopic&amp;t='.$topic_id, $replies, $config['topics_per_page'], 0);
+					$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
+					$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
 
 					$_CLASS['core_template']->assign_vars_array('topicrow', array(
 						'FORUM_ID' 			=> $forum_id,
@@ -398,7 +419,7 @@
 						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 						'NEWEST_POST_IMG' 	=> $newest_post_img,
 						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-						'TOPIC_ICON_IMG'	=> (!empty($icons[$row['icon_id']])) ? '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />' : '',
+						'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />',
 						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', sprintf($_CLASS['core_user']->lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
 
 						'S_TOPIC_TYPE'		=> $row['topic_type'],
@@ -414,13 +435,6 @@
 			break;
 
 			case 'bookmarks':
-				
-				if (!$config['allow_bookmarks'])
-				{
-					$_CLASS['core_template']->assign('S_BOOKMARKS_DISABLED', true);
-					break;
-				}
-				
 				require($site_file_root.'includes/forums/functions_display.php');
 
 				$move_up = request_var('move_up', 0);
@@ -449,28 +463,25 @@
 				
 				if (isset($_POST['unbookmark']))
 				{
-					$s_hidden_fields = '<input type="hidden" name="unbookmark" value="1" />';
-					$topics = (isset($_POST['t'])) ? array_map('intval', array_keys($_POST['t'])) : array();
-					$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 					
 					if (empty($topics))
 					{
 						trigger_error('NO_BOOKMARKS_SELECTED');
 					}
-					
-					foreach ($topics as $topic_id)
-					{
-						$s_hidden_fields .= '<input type="hidden" name="t[' . $topic_id . ']" value="1" />';
-					}
 
-					if (confirm_box(true))
+					$hidden_fields = array(
+						'unbookmark' => 1,
+						't' => $topics
+					);
+
+					if (display_confirmation($_CLASS['core_user']->get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
 					{
 						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 								AND topic_id IN (' . implode(', ', $topics) . ')';
 						$_CLASS['core_db']->query($sql);
 
-						// Re-Order bookmarks (possible with one query? This query massaker is not really acceptable...)
 						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 							ORDER BY order_id ASC';
@@ -487,14 +498,12 @@
 						}
 						$_CLASS['core_db']->free_result($result);
 
+						$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+
 						$_CLASS['core_display']->meta_refresh(3, $url);
 						$message = $_CLASS['core_user']->lang['BOOKMARKS_REMOVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $url . '">', '</a>');
 						trigger_error($message);
 					}
-					else
-					{
-						confirm_box(false, 'REMOVE_SELECTED_BOOKMARKS', $s_hidden_fields);
-					}
 				}
 
 				// We grab deleted topics here too...

Modified: cms/branches/1.0alpha2/modules/Forums/viewforum.php
===================================================================
--- cms/branches/1.0alpha2/modules/Forums/viewforum.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/modules/Forums/viewforum.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -288,7 +288,7 @@
 	'TOTAL_TOPICS'		=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
 	'MODERATORS'		=> empty($moderators[$forum_id]) ? '' : implode(', ', $moderators[$forum_id]),
 
-	'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
+	'POST_IMG' 			=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
 
 	'MOD_TOPIC_LOCK'	=>	$_CLASS['auth']->acl_get('m_lock', $forum_id),
 	'MOD_TOPIC_TITLE'	=>	$_CLASS['auth']->acl_get('m_', $forum_id),

Modified: cms/branches/1.0alpha2/modules/calender/index.php
===================================================================
--- cms/branches/1.0alpha2/modules/calender/index.php	2005-09-30 04:30:29 UTC (rev 150)
+++ cms/branches/1.0alpha2/modules/calender/index.php	2005-09-30 15:46:45 UTC (rev 151)
@@ -75,7 +75,7 @@
 			'NEXT_DAY_LINK'			=> $next_day,
 		));
 
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_day.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_day.html');
 	break;
 		
 	case 'details':
@@ -91,7 +91,7 @@
 			'CAL_END_TIME'		=> $_CLASS['core_user']->format_date($data['end_time']),
 		));
 	
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_details.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_details.html');
 
 	break;
 	
@@ -122,7 +122,7 @@
 			'NEXT_MONTH'			=> generate_link($link.'&amp;mode=month_view&amp;year='.$month_flanks['next_month']['year'].'&amp;month='.$month_flanks['next_month']['month']),
 		));
 
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_main.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_main.html');
 
 	break;	
 }



From viperal at berlios.de  Fri Sep 30 17:58:37 2005
From: viperal at berlios.de (Ryan Marshall at BerliOS)
Date: Fri, 30 Sep 2005 17:58:37 +0200
Subject: [Viperals-svncheckins] r152 - in cms/trunk: includes/db includes/display includes/templates/en/email includes/templates/en/email/control_panel includes/templates/modules/Control_Panel install javascript modules/Control_Panel/ucp modules/Forums modules/calender
Message-ID: <200509301558.j8UFwbu1025193@sheep.berlios.de>

Author: viperal
Date: 2005-09-30 17:58:35 +0200 (Fri, 30 Sep 2005)
New Revision: 152

Added:
   cms/trunk/includes/templates/en/email/control_panel/
   cms/trunk/includes/templates/en/email/control_panel/index.htm
   cms/trunk/includes/templates/en/email/control_panel/pm_notify.txt
Removed:
   cms/trunk/includes/db/mssql.php
Modified:
   cms/trunk/includes/db/sqlite.php
   cms/trunk/includes/db/sqlite_pdo.php
   cms/trunk/includes/display/calender.php
   cms/trunk/includes/display/display.php
   cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_add.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_main_bookmarks.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_main_subscribed.html
   cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_popup.html
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/javascript/editor.js
   cms/trunk/modules/Control_Panel/ucp/ucp_calender.php
   cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
   cms/trunk/modules/Control_Panel/ucp/ucp_main.php
   cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
   cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
   cms/trunk/modules/Forums/viewforum.php
   cms/trunk/modules/calender/configurator.php
   cms/trunk/modules/calender/index.php
Log:


Deleted: cms/trunk/includes/db/mssql.php
===================================================================
--- cms/trunk/includes/db/mssql.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/db/mssql.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -1,693 +0,0 @@
-<?php
-/*
-||**************************************************************||
-||  Viperal CMS ?? :												||
-||**************************************************************||
-||																||
-||	Copyright (C) 2004, 2005									||
-||  By Ryan Marshall ( Viperal )								||
-||																||
-||  Email: viperal1 at gmail.com									||
-||  Site: http://www.viperal.com								||
-||																||
-||**************************************************************||
-||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
-||**************************************************************||
-||  Viperal CMS is released under the terms and conditions		||
-||  of the GNU General Public License version 2					||
-||																||
-||**************************************************************||
-
-$Id$
-*/
-
-class db_mssql
-{
-	var $link_identifier = false;
-	var $db_layer = 'mssql';
-
-	var $last_result;
-	var $return_on_error;
-	var $in_transaction;
-
-	var $queries_time = 0;
-	var $num_queries = 0;
-
-	var	$query_list = array();
-	var $query_details = array();
-	var $open_queries = array();
-
-	var $_indexs = array();
-	var $_fields = array();
-	var $_table_name = false;
-	
-	var $_limit_last_key = 0;
-	var $_limit_result = array();
-
-	function connect($db)
-	{		
-		if ($db['port'])
-		{
-			$db['server'] .= ':' . $port;
-		}
-
-		if ($this->link_identifier)
-		{
-			$this->disconnect();
-		}
-
-		$this->link_identifier = ($db['persistent']) ? mssql_pconnect($db['server'], $db['username'], $db['password']) : mssql_connect($db['server'], $db['username'], $db['password']);
-
-		if ($this->link_identifier)
-		{
-			if (mssql_select_db($db['database']))
-			{
-				return $this->link_identifier;
-			}
-
-			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB2</center>';
-		}
-
-		if (!$error)
-		{
-			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';
-		}
-
-		$this->disconnect();
-
-		trigger_error($error, E_USER_ERROR);
-	}
-
-	function disconnect()
-	{
-		if (!$this->link_identifier)
-		{
-			return;
-		}
-
-		@mssql_close($this->link_identifier);
-		$this->link_identifier = false;
-	}
-
-	function sql_return_on_error($fail = false)
-	{
-		$this->return_on_error = $fail;
-	}
-
-	function transaction($option = 'start')
-	{
-		if (!$this->link_identifier)
-		{
-			return;
-		}
-
-		$result = false;
-
-		switch ($option)
-		{
-			case 'start':
-				if ($this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('BEGIN  TRANSACTION', $this->link_identifier);
-				$this->in_transaction = true;
-			break;
-
-			case 'commit':
-			
-				if (!$this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('COMMIT', $this->link_identifier);
-				
-				if (!$result)
-				{
-					mysql_query('ROLLBACK', $this->link_identifier);
-				}
-				
-				$this->in_transaction = false;
-			break;
-
-			case 'rollback':
-				if (!$this->in_transaction)
-				{
-					break;
-				}
-
-				$result = mysql_query('ROLLBACK', $this->link_identifier);
-				$this->in_transaction = false;
-			break;
-		}
-
-		return $result;
-	}
-
-	function query($query = false,  $backtrace = false)
-	{
-		if (!$query || !$this->link_identifier) 
-		{ 
-			return false; 
-		}
-
-		global $_CLASS, $site_file_root;
-			
-		$this->num_queries++;
-		$this->last_query = $query;
-
-		if (!$backtrace)
-		{
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-		}
-
-		$this->_debug('start', $backtrace);
-		$this->last_result = $this->sql_query($query);
-		$this->_debug('stop', $backtrace);
-
-		if ($this->last_result === false)
-		{
-			$this->_error($query, $backtrace);
-		}
-		elseif (strpos($query, 'SELECT') !== false)
-		{
-			$this->open_queries[(int) $this->last_result] = $this->last_result;
-		}
-
-		return $this->last_result;
-	}
-
-	function sql_query($query = false)
-	{
-		return mssql_query($query, $this->link_identifier);
-	}
-
-	function query_limit($query = false, $total = false, $offset = 0, $backtrace = false) 
-	{
-		if (!$query || !$total || !$this->link_identifier) 
-		{
-			// no need to check for query or link_id, it's checked in db::query()
-			return $this->query($query);; 
-		}
-
-		global $site_file_root;
-
-		if (!$backtrace)
-		{
-			$debug_backtrace = debug_backtrace();
-			$backtrace = array();
-			// remove the root directorys
-			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
-
-			$backtrace['line'] = $debug_backtrace[0]['line'];
-		}
-
-		$query = substr(trim($query));
-		
-		if (!$offset)
-		{
-			return $this->query("SELECT TOP($total) $query");
-		}
-		
-		/*
-			Welcome to hell
-
-			We'll do two query and get the diffence in php to make sure things work right
-			Other why needs us to know the a unique feild/key or primary key
-		*/
-		
-		// here we go, get the all data up to the offset row. offset row = total need + offset
-		$result = $this->query('SELECT TOP('.$total + $offset.") $query");
-
-		// need to test dataseek, if it resets after the a fetch do mssql_next_result loop
-		if (!$result || !mssql_data_seek($offset))
-		{
-			$this->free_result($result);
-
-			return false;
-		}
-
-		/*
-			change mssql_data_seek to mssql_num_rows < $offset above if this is used
-			for ($i = 1; $i <= $offset; $i++)
-			{
-				mssql_next_result($result);
-			}
-		*/
-
-		// we fetch array so both assoc and num can be used, May change later on
-
-		$this->_limit_last_key ++;
-		$result_id = 'LIMIT_'.$this->_limit_last_key;
-		
-		while ($row = mssql_fetch_array($result))
-		{
-			$this->_limit_result[$result_id][] = $row;
-		}
-
-		return $result_id;
-	}
-
-	/*
-		Boy do I like this but it phpBB's, may have to do something similar
-	*/
-	function sql_build_array($query, $assoc_ary = false)
-	{
-		if (!is_array($assoc_ary))
-		{
-			return false;
-		}
-
-		$fields = array();
-		$values = array();
-
-		if ($query == 'INSERT')
-		{
-			foreach ($assoc_ary as $key => $var)
-			{
-				$fields[] = $key;
-
-				if (is_null($var))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_string($var))
-				{
-					$values[] = "'" . $this->escape($var) . "'";
-				}
-				else
-				{
-					$values[] = (is_bool($var)) ? intval($var) : $var;
-				}
-			}
-
-			$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		else if ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($assoc_ary as $key => $var)
-			{
-				if (is_null($var))
-				{
-					$values[] = "$key = NULL";
-				}
-				elseif (is_string($var))
-				{
-					$values[] = "$key = '" . $this->escape($var) . "'";
-				}
-				else
-				{
-					$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
-				}
-			}
-			$query = implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
-		}
-
-		return $query;
-	}
-
-	function num_rows($result = false)
-	{
-		if (!$result || !$this->link_identifier) 
-		{ 
-			return 0; 
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			return (empty($this->_limit_result[$result]) ? 0 : count($this->_limit_result[$result]));
-		}
-
-		return mssql_num_rows($result);
-	}
-
-	function affected_rows()
-	{
-		if (!$this->link_identifier)
-		{ 
-			return 0; 
-		}
-
-		$num = mssql_rows_affected($this->link_identifier);
-
-		// not sure what it returns one fail, test maybe ?
-		return (!$num || $num == -1) ? 0 : $num;
-	}
-
-	function fetch_row_assoc($result = false)
-	{
-		global $_CLASS;
-
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_assoc($result);
-	}
-
-	function fetch_row_num($result = false)
-	{
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_row($result);
-	}
-
-	function fetch_row_both($result = false)
-	{
-		if (!$result || !$this->link_identifier)
-		{
-			return false;
-		}
-
-		if (strpos($result, 'LIMIT_') === 0)
-		{
-			if (empty($this->_limit_result[$result]) || !($value = each($this->_limit_result[$result])))
-			{
-				return false;
-			}
-			return $value['value'];
-		}
-
-		return @mssql_fetch_array($result);
-	}
-	
-	function insert_id()
-	{
-		if (!$this->link_identifier)
-		{
-			return false;
-		}
-		
-		//@@IDENTITY
-		if ($result = mssql_query('SELECT SCOPE_IDENTITY() AS Identity', $this->db_connect_id))
-		{
-			$row = mssql_fetch_assoc($result);
-			mssql_free_result($result);
-		}
-
-		return (isset($row['Identity']) && !is_null($row['Identity'])) ? $row['Identity'] : false;
-	}
-
-	function free_result($result = false)
-	{
-		if ($result && strpos($result, 'LIMIT_') === 0)
-		{
-			if (isset($this->_limit_result[$result]))
-			{
-				unset($this->_limit_result[$result]);
-			}
-			return;
-		}
-
-		if (!$result || !isset($this->open_queries[(int) $result]) || !$this->link_identifier) 
-		{ 
-			return; 
-		}
-
-		unset($this->open_queries[(int) $result]);
-
-		@mssql_free_result($result);
-	}
-
-	function escape($text)
-	{
-		return str_replace("'", "''", str_replace('\\', '\\\\', $text));
-	}
-
-	function escape_array($value)
-	{
-		return preg_replace('#(.*?)#e', "\$this->escape('\\1')", $value);
-	}
-		
-	function optimize_tables()
-	{
-
-	}
-
-	function version()
-	{
-		//add later, more important things to do
-		//@@VERSION
-	}
-
-	function _error($sql = '', $backtrace)
-	{
-		if ($this->return_on_error)
-		{
-			return;
-		}
-
-		// should we use the long error getting why ?
-		$message = '<u>SQL ERROR</u><br /><br />' . @mssql_get_last_message() . '<br /><br />File:<br/><br/>'.$backtrace['file'].'<br /><br />Line:<br /><br />'.$backtrace['line'].'<br /><br /><u>CALLING PAGE</u><br /><br />'.(($sql) ? '<br /><br /><u>SQL</u><br /><br />' . $sql : '') . '<br />';
-
-		if ($this->in_transaction)
-		{
-			$this->transaction('rollback');
-		}
-		
-		trigger_error($message, E_USER_ERROR);
-	}
-
-	function _debug($mode, $backtrace)
-	{
-		global $_CLASS, $_CORE_CONFIG;
-		static $start_time;
-
-		if (!$this->link_identifier) 
-		{ 
-			return false; 
-		}
-
-		switch ($mode)
-		{
-			case 'start':
-				$this->query_details[$this->num_queries][] = '';
-
-				$start_time = explode(' ', microtime());
-				$start_time = $start_time[0] + $start_time[1];
-			break;
-
-			case 'stop':
-				global $site_file_root;
-
-				$end_time = explode(' ', microtime());
-				$end_time = $end_time[0] + $end_time[1];
-				$this->queries_time += $end_time - $start_time;
-
-				if (empty($_CORE_CONFIG['global']['error']) || $_CORE_CONFIG['global']['error'] == ERROR_DEBUGGER)
-				{
-					if ($this->last_result !== false)
-					{
-						$affected = false;
-
-						if (preg_match('/^(UPDATE|DELETE|REPLACE)/', $this->last_query))
-						{
-							$affected = $this->affected_rows($this->last_result);
-						}
-						
-						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'affected' => $affected, 'time' => ($end_time - $start_time));
-					}
-					else
-					{
-						// should we use the long error getting why ?
-						$this->query_list[$this->num_queries] = array('query' => $this->last_query, 'file' => $backtrace['file'], 'line'=> $backtrace['line'], 'error'=> 1, 'errorcode' => mssql_get_last_message());
-					}
-				}
-			break;
-		}
-	}
-
-	/*
-		Table creation
-	*/
-	function table_create($option, $name = false)
-	{
-		switch ($option)
-		{
-			case 'start':
-				$this->_table_name = $name;
-				$this->_fields = $this->_indexs = array();
-			break;
-
-			case 'commit':
-			case 'return':
-				if (!$this->_table_name)
-				{
-					return;
-				}
-
-				$fields = implode(", \n", $this->_fields);
-				if ($indexs = implode(", \n", $this->_indexs))
-				{
-					$fields .= ", \n";
-				}
-				
-				//#MyTempTable -- local temp tables
-				//##MyTempTable -- Global temp tables
-
-				$table = 'CREATE TABLE ['.$this->_table_name."] ( \n" .$fields. $indexs ." \n ) ENGINE=InnoDB;";
-				// Let users choose transaction safe InnoDB or MyISAM
-				// ENGINE=MyISAM
-				if ($option == 'return')
-				{
-					return $table;
-				}
-
-				$this->sql_query($table);
-
-			case 'cancel':
-				$this->_table_name = false;
-				$this->_fields = $this->_indexs = array();
-			break;
-		}
-	}
-
-//$name, $number_min, $number_max = false, $default = 0, $auto_increment = false
-	function add_table_field_int($name, $setting_sent)
-	{
-		$setting = array('default' => 0, 'min' => 0, 'max' => 0, 'auto_increment' => false, 'null' => false);
-		$setting = array_merge($setting, $setting_sent);
-
-		$length = max(strlen($setting['min']), strlen($setting['max']));
-
-		if ($setting['min'] >= -0 && $setting['max'] <= 255)
-		{
-			// TINYINT UNSIGNED ( 0 to 255 )
-			$this->_fields[$name] =  "`$name` TINYINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -128 && $setting['max'] <= 128)
-		{
-			// TINYINT ( -128 to 127 )
-			$this->_fields[$name] =  "`$name` TINYINT($length) DEFAULT";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 65535)
-		{
-			// SMALLINT UNSIGNED ( 0 to 65,535 )
-			$this->_fields[$name] =  "`$name` SMALLINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -32768 && $setting['max'] <= 32767)
-		{
-			// SMALLINT ( -32,768 to 32,767 )
-			$this->_fields[$name] =  "`$name` SMALLINT($length)";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 16777215)
-		{
-			// MEDIUMINT UNSIGNED ( 0 to 16,777,215 )
-			$this->_fields[$name] =  "`$name` MEDIUMINT($length) UNSIGNED";
-		}
-		elseif ($setting['min'] >= -8388608 && $setting['max'] <= 8388607)
-		{
-			// MEDIUMINT ( -8,388,608 to 8,388,607 )
-			$this->_fields[$name] =  "`$name` MEDIUMINT($length)";
-		}
-		elseif ($setting['min'] >= -2147483647 && $setting['max'] <= 2147483647)
-		{
-			// INT ( -2,147,483,647 to 2,147,483,647 )
-			$this->_fields[$name] =  "`$name` INT($length)";
-		}
-		elseif ($setting['min'] >= 0 && $setting['max'] <= 4294967295) // we'll do this last
-		{
-			// INT UNSIGNED ( 0 to 4,294,967,295 )
-			$this->_fields[$name] =  "`$name` INT($length) UNSIGNED";
-		}
-
-		if ($auto_increment)
-		{
-			$this->_fields[$name] .= ' auto_increment';
-		}
-		else
-		{
-			$this->_fields[$name] .= ($setting['null']) ? " NULL" : " NOT NULL";
-			$this->_fields[$name] .= " DEFAULT '".(int) $default."'";
-		}
-	}
-
-	function add_table_field_text($name, $characters = 60000, $null = false)
-	{
-		if ($characters <= 255)
-		{
-			// TINYTEXT 1 to 255 Characters
-			$this->_fields[$name] =  "`$name` TINYTEXT";
-		}
-		elseif ($characters <= 65535)
-		{
-			// TEXT 1 to 65535 Characters
-			$this->_fields[$name] =  "`$name` TEXT";
-		}
-		elseif ($characters <= 16777215)
-		{
-			// MEDIUMTEXT 1 to 16,777,215 Characters
-			$this->_fields[$name] =  "`$name` MEDIUMTEXT";
-		}
-		elseif ($characters <= 4294967295)
-		{
-			// LONGTEXT 1 to 4,294,967,295 Characters
-			$this->_fields[$name] =  "`$name` LONGTEXT";
-		}
-
-		$this->_fields[$name] .= ($null) ? " NULL" : " NOT NULL";
-	}
-
-	function add_table_field_char($name, $characters, $default = '', $padded = false)
-	{
-
-		$this->_fields[$name] = ($padded) ? "`$name` CHAR($characters)" :  "`$name` VARCHAR($characters)";
-		$this->_fields[$name] .= (is_null($default)) ? " NULL" : " NOT NULL DEFAULT '$default'";
-	}
-
-	function add_table_index($field, $type  = 'index', $index_name = false)
-	{
-		$index_name = ($index_name) ? $index_name : $field;
-
-		if (empty($this->_fields[$field]))
-		{
-			return;
-		}
-
-		switch ($type)
-		{
-			case 'index':
-			case 'unique':
-				$this->_indexs[$index_name] = (($type == 'UNIQUE') ? 'UNIQUE ' : '') . "KEY `$index_name` (`$field`)";
-			break;
-
-			case 'primary':
-				$this->_indexs['primary'] = "PRIMARY KEY (`$field`)";
-			break;
-		}
-	}
-}
-
-?>
\ No newline at end of file

Modified: cms/trunk/includes/db/sqlite.php
===================================================================
--- cms/trunk/includes/db/sqlite.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/db/sqlite.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -65,6 +65,11 @@
 			return $this->link_identifier;
 		}
 		
+		if (!$this->report_error)
+		{
+			return false;
+		}
+
 		if (!$error)
 		{
 			$error = '<center>There is currently a problem with the site<br/>Please try again later<br /><br />Error Code: DB1</center>';

Modified: cms/trunk/includes/db/sqlite_pdo.php
===================================================================
--- cms/trunk/includes/db/sqlite_pdo.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/db/sqlite_pdo.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -55,6 +55,11 @@
 		}
 		catch (PDOException $e)
 		{
+			if (!$this->report_error)
+			{
+				return false;
+			}
+
 			trigger_error('Connection failed: ' . $e->getMessage());
 		}
 

Modified: cms/trunk/includes/display/calender.php
===================================================================
--- cms/trunk/includes/display/calender.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/display/calender.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -192,7 +192,7 @@
 		}
 		
 		$date = explode(':', date('n:d:y', $time));
-		
+
 		$day['start'] = mktime(0, 0, 0, $date[0], $date[1], $date[2]) + 60;
 		$day['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 
@@ -249,7 +249,7 @@
 			$time = mktime(12, 0, 0, $this->month, $this->day, $this->year);
 		}
 		
-		$date = explode(',', date('n,t,Y', $time));
+		$date = explode(':', date('n:t:Y', $time));
 		$month['start'] = mktime(0, 0, 0, $date[0], 1, $date[2]);
 		$month['end'] = mktime(24, 0, 0, $date[0], $date[1], $date[2]) - 1;
 

Modified: cms/trunk/includes/display/display.php
===================================================================
--- cms/trunk/includes/display/display.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/display/display.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -49,12 +49,14 @@
 
 		if ($module['module_status'] != STATUS_ACTIVE)
 		{
-			if (!$_CLASS['core_auth']->admin_auth('modules'))
+			if ($module['module_status'] == STATUS_DISABLE && $_CLASS['core_auth']->admin_auth('modules'))
 			{
+				$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
+			}
+			else
+			{
 				return '_MODULE_NOT_ACTIVE';
 			}
-
-			$_CLASS['core_display']->message = '<b>Module '.$module['module_name'].' Isn\'t Active</b><br />';
 		}
 
 		//authization check here

Added: cms/trunk/includes/templates/en/email/control_panel/index.htm
===================================================================
--- cms/trunk/includes/templates/en/email/control_panel/index.htm	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/en/email/control_panel/index.htm	2005-09-30 15:58:35 UTC (rev 152)
@@ -0,0 +1,10 @@
+<html>
+<head>
+<title></title>
+<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
+</head>
+
+<body bgcolor="#FFFFFF" text="#000000">
+
+</body>
+</html>

Added: cms/trunk/includes/templates/en/email/control_panel/pm_notify.txt
===================================================================
--- cms/trunk/includes/templates/en/email/control_panel/pm_notify.txt	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/en/email/control_panel/pm_notify.txt	2005-09-30 15:58:35 UTC (rev 152)
@@ -0,0 +1,13 @@
+Hello,
+
+You have received a new private message from "{ $AUTHOR_NAME }" to your account on "{ $SITENAME }" with the following subject:
+
+{ $SUBJECT } 
+
+You can view your new message by clicking on the following link:
+
+{ $LINK_INBOX } 
+
+You have requested that you be notified on this event, remember that you can always choose not to be notified of new messages by changing the appropriate setting in your profile.
+
+{ $EMAIL_SIG }
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_add.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_add.html	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_calender_add.html	2005-09-30 15:58:35 UTC (rev 152)
@@ -28,80 +28,89 @@
 }
 
 </script>
-
-<table width="100%" cellpadding="3" cellspacing="0">
-	<tr>
-		<td width="60%" valign="top">
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th colspan="2">{ $L_BASIC_INFO }</th>
-				</tr>
-				<tr> 
-					<td class="row2" align="center" colspan="3">
-						<font class="error">No Content check yet, so don't hack plz</font>
-					</td>
-				</tr>
-				<tr>
-					<td class="row1" width="30%">{ $L_TITLE }</td>
-					<td class="row1"><input class="post" name="title" value="" size="39" type="text">
-				</tr>
-				<tr>
-					<td valign="top" class="row1" width="30%">{ $L_DESCRIPTION }<br/><a id="preview_fast" href="#" onclick="fast_preview()">{ $L_PREVIEW }</a></td>
-					<td class="row1">
-						<div id="message_preview" style="display: none; padding:5"></div>
-						<textarea name="description" id="description" rows="5" cols="35" style="display: ;" wrap="virtual" size="40"></textarea>
-					</td>
-				</tr>	
-				<tr>
-					<th colspan="2"></th>
-				</tr>
-				<tr>
-					<td class="row1" width="30%">{ $L_START }</td>
-					<td class="row1"><input class="post" id="start" name="start" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="start_trigger" /></td>
-
-				</tr>
-				<tr>
-					<td class="row1" width="30%">{ $L_END }</td>
-					<td class="row1"><input class="post" id="end" name="end" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="end_trigger" /></td>
-
-				</tr>
-				<tr>
-					<td class="cat" align="center"><input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;</td>
-					<td class="cat" align="center"></td>
-				</tr>
-			</table>
-		</td>
-		<td width="40%" valign="top">
+
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table width="100%" cellpadding="3" cellspacing="0">
+		<tr>
+			<td width="60%" valign="top">
+				<table class="tablebg" width="100%" cellspacing="1">
+					<!-- IF { $ERROR } -->
+					<tr>
+						<td class="row1" colspan="2" align="center"><span class="genmed" style="color:red">{ $ERROR }</span></td>
+					</tr>
+					<!-- ENDIF -->
+					<tr>
+						<th colspan="2">{ $L_BASIC_INFO }</th>
+					</tr>
+					<tr> 
+						<td class="row2" align="center" colspan="3">
+							<font class="error">No Content check yet, so don't hack plz</font>
+						</td>
+					</tr>
+					<tr>
+						<td class="row1" width="30%">{ $L_TITLE }</td>
+						<td class="row1"><input class="post" name="title" value="" size="39" type="text" /></td>
+					</tr>
+					<tr>
+						<td valign="top" class="row1" width="30%">{ $L_DESCRIPTION }<br/><a id="preview_fast" href="#" onclick="fast_preview(); return false;">{ $L_PREVIEW }</a></td>
+						<td class="row1">
+							<div id="message_preview" style="display: none; padding:5"></div>
+							<textarea name="description" id="description" rows="5" cols="35" style="display: ;" wrap="virtual" size="40"></textarea>
+						</td>
+					</tr>	
+					<tr>
+						<th colspan="2"></th>
+					</tr>
+					<tr>
+						<td class="row1" width="30%">{ $L_START }</td>
+						<td class="row1"><input class="post" id="start" name="start" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="start_trigger" /></td>
 	
-			<table class="tablebg" width="100%" cellspacing="1">
-				<tr>
-					<th>{ $L_BASIC_INFO }</th>
-				</tr>
-				<tr>
-					<td class="row1">{ $L_BASIC_INFO }</td>
-				</tr>
-				<tr>
-					<td align="center" class="row1"><a href="#" onclick="if (document.getElementById('options_recu').style.display)
-																		{
-																			document.getElementById('options_recu').style.display = '';
-																			this.innerHTML = '{ $L_HIDE_RECURRENCE }';
-																		}
-																		else
-																		{
-																			document.getElementById('options_recu').style.display = 'none';
-																			this.innerHTML = '{ $L_SHOW_RECURRENCE }';
-																		}">
-					{ $L_SHOW_RECURRENCE }</a></th>
-				</tr>
-				
-				<tr id="options_recu" style="display: none;">
-					<td class="row1">Recurre Every: <input class="post" name="title" value="" size="5" type="text"><span class="genmed"></span><select name="recurrence_rate"><option value="86400">Days</option><option value="86400">1</option></select></td>
-				</tr>
-				
-			</table>
-		</td>
-	</tr>
-</table>
+					</tr>
+					<tr>
+						<td class="row1" width="30%">{ $L_END }</td>
+						<td class="row1"><input class="post" id="end" name="end" value="" size="35" type="text" /> <img src="images/calender_small.png" style="cursor: pointer;"  id="end_trigger" /></td>
+	
+					</tr>
+					<tr>
+						<td class="cat" align="center"><input class="btnmain" name="submit" value="Submit" type="submit">&nbsp;</td>
+						<td class="cat" align="center"></td>
+					</tr>
+				</table>
+			</td>
+			<td width="40%" valign="top">
+		
+				<table class="tablebg" width="100%" cellspacing="1">
+					<tr>
+						<th>{ $L_BASIC_INFO }</th>
+					</tr>
+					<tr>
+						<td class="row1">{ $L_BASIC_INFO }</td>
+					</tr>
+					<tr>
+						<td align="center" class="row1"><a href="#" onclick="if (document.getElementById('options_recu').style.display)
+																			{
+																				document.getElementById('options_recu').style.display = '';
+																				this.innerHTML = '{ $L_HIDE_RECURRENCE }';
+																			}
+																			else
+																			{
+																				document.getElementById('options_recu').style.display = 'none';
+																				this.innerHTML = '{ $L_SHOW_RECURRENCE }';
+																			}
+																			
+																			return false;">
+						{ $L_SHOW_RECURRENCE }</a></th>
+					</tr>
+					
+					<tr id="options_recu" style="display: none;">
+						<td class="row1">Recurre Every: <input class="post" name="recurrence_rate" value="1" size="5" type="text"><span class="genmed"></span><select name="recurrence_type"><option value="86400">Days</option><option value="86400">Weeks</option><option value="month">Month</option></select></td>
+					</tr>
+					
+				</table>
+			</td>
+		</tr>
+	</table>
+<form>
 
 <script type="text/javascript">
   Calendar.setup(

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_main_bookmarks.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_bookmarks.html	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_main_bookmarks.html	2005-09-30 15:58:35 UTC (rev 152)
@@ -14,88 +14,90 @@
 
 //-->
 </script>
-
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="5">{ $L_UCP }</th>
-	</tr>
-	<tr>
-		<td class="row1" colspan="5" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
-	</tr>
+
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="5">{ $L_UCP }</th>
+		</tr>
+		<tr>
+			<td class="row1" colspan="5" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
+		</tr>
+		
+		<!-- IF { $S_BOOKMARKS_DISABLED } -->
+		<tr class="row1">
+			<td colspan="5" align="center"><b class="genmed">{ $L_BOOKMARKS_DISABLED }</b></td>
+		</tr>
+		<!-- ELSE -->
+		<tr>
+			<th colspan="5">{ $L_BOOKMARKS_FORUMS }</th>
+		</tr>
 	
-	<!-- IF { $S_BOOKMARKS_DISABLED } -->
-	<tr class="row1">
-		<td colspan="5" align="center"><b class="genmed">{ $L_BOOKMARKS_DISABLED }</b></td>
-	</tr>
-	<!-- ELSE -->
-	<tr>
-		<th colspan="5">{ $L_BOOKMARKS_FORUMS }</th>
-	</tr>
-
-	<!-- LOOP $forummarks -->
-
-	<!-- IF { $forummarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-		<td style="padding: 4px;" width="20px" align="center" valign="middle">{ $forummarks:TOPIC_FOLDER_IMG }</td>
-	<!-- IF { $forummarks:S_DELETED_TOPIC } -->
-		<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{ $L_DELETED_TOPIC }</td>
-	<!-- ELSE -->
-		<td style="padding: 4px;" width="100%" valign="top">
-		<p class="topictitle">{ $forummarks:ATTACH_ICON_IMG } <a href="{ $forummarks:U_VIEW_TOPIC }">{ $forummarks:TOPIC_TITLE }</a></p><br />
-		<span class="gensmall"><b>{ $L_FORUM }: </b><a href="{ $forummarks:U_VIEW_FORUM }">{ $forummarks:FORUM_NAME }</a></span>
-		<!-- IF { $forummarks:PAGINATION } -->
-			<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $forummarks:PAGINATION } ] </p>
+		<!-- LOOP $forummarks -->
+	
+		<!-- IF { $forummarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+			<td style="padding: 4px;" width="20px" align="center" valign="middle">{ $forummarks:TOPIC_FOLDER_IMG }</td>
+		<!-- IF { $forummarks:S_DELETED_TOPIC } -->
+			<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{ $L_DELETED_TOPIC }</td>
+		<!-- ELSE -->
+			<td style="padding: 4px;" width="100%" valign="top">
+			<p class="topictitle">{ $forummarks:ATTACH_ICON_IMG } <a href="{ $forummarks:U_VIEW_TOPIC }">{ $forummarks:TOPIC_TITLE }</a></p><br />
+			<span class="gensmall"><b>{ $L_FORUM }: </b><a href="{ $forummarks:U_VIEW_FORUM }">{ $forummarks:FORUM_NAME }</a></span>
+			<!-- IF { $forummarks:PAGINATION } -->
+				<p class="gensmall"> [ { $GOTO_PAGE_IMG }{ $L_GOTO_PAGE }: { $forummarks:PAGINATION } ] </p>
+			<!-- ENDIF -->
+		</td>
+		<td style="padding: 4px;" align="center" valign="top" nowrap="nowrap">
+			<p class="topicdetails">{ $forummarks:LAST_POST_TIME }</p>
+			<p class="topicdetails"><!-- IF { $forummarks:U_LAST_POST_AUTHOR } --><a href="{ $forummarks:U_LAST_POST_AUTHOR }">{ $forummarks:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forummarks:LAST_POST_AUTHOR }<!-- ENDIF -->
+				<a href="{ $forummarks:U_LAST_POST }">{ $forummarks:LAST_POST_IMG }</a>
+			</p>
+		</td>
 		<!-- ENDIF -->
-	</td>
-	<td style="padding: 4px;" align="left" valign="top" nowrap="nowrap">
-		<p class="topicdetails">{ $forummarks:LAST_POST_TIME }</p>
-		<p class="topicdetails"><!-- IF { $forummarks:U_LAST_POST_AUTHOR } --><a href="{ $forummarks:U_LAST_POST_AUTHOR }">{ $forummarks:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forummarks:LAST_POST_AUTHOR }<!-- ENDIF -->
-			<a href="{ $forummarks:U_LAST_POST }">{ $forummarks:LAST_POST_IMG }</a>
-		</p>
-	</td>
-	<!-- ENDIF -->
-		<!-- IF { $forummarks:U_MOVE_UP } || { $forummarks:U_MOVE_DOWN } -->
-		<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
-			<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
-			<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
+			<!-- IF { $forummarks:U_MOVE_UP } || { $forummarks:U_MOVE_DOWN } -->
+			<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
+				<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
+				<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
+			<!-- ENDIF -->
+			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $forummarks:TOPIC_ID }" /> </td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row1">
+			<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<th colspan="5">{ $L_BOOKMARKS_SITE }</th>
+		</tr>
+	
+		<!-- LOOP $sitemarks -->
+	
+		<!-- IF { $sitemarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+			<td style="padding: 4px;" width="20" align="center" valign="middle">{$forummarks[sitemarksloop].TOPIC_FOLDER_IMG}</td>
+		<!-- IF { $forummarks[sitemarksloop].S_DELETED_TOPIC } -->
+			<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{$L_DELETED_TOPIC}</td>
+		<!-- ELSE -->
+			<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{$forummarks:U_VIEW_TOPIC}">{$forummarks:TOPIC_TITLE}</a></p><br /><span class="gensmall">{$L_FORUM}: <a href="{$forummarks:U_VIEW_FORUM}">{$forummarks:FORUM_NAME}</a></span></td>
+			<td class="postdetails" style="padding: 4px;" align="center" valign="top" nowrap="nowrap">{$L_POSTED}:<br />{$forummarks[sitemarksloop].POSTED_AT}</td>
 		<!-- ENDIF -->
-		<td style="padding: 4px;"> <input type="checkbox" name="t[{$forummarks:TOPIC_ID}]" /> </td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr class="row1">
-		<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
-	<tr>
-		<th colspan="5">{ $L_BOOKMARKS_SITE }</th>
-	</tr>
-
-	<!-- LOOP $sitemarks -->
-
-	<!-- IF { $sitemarks:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-		<td style="padding: 4px;" width="20" align="center" valign="middle">{$forummarks[sitemarksloop].TOPIC_FOLDER_IMG}</td>
-	<!-- IF { $forummarks[sitemarksloop].S_DELETED_TOPIC } -->
-		<td class="postdetails" style="padding: 4px" width="100%" colspan="2">{$L_DELETED_TOPIC}</td>
-	<!-- ELSE -->
-		<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{$forummarks:U_VIEW_TOPIC}">{$forummarks:TOPIC_TITLE}</a></p><br /><span class="gensmall">{$L_FORUM}: <a href="{$forummarks:U_VIEW_FORUM}">{$forummarks:FORUM_NAME}</a></span></td>
-		<td class="postdetails" style="padding: 4px;" align="center" valign="top" nowrap="nowrap">{$L_POSTED}:<br />{$forummarks[sitemarksloop].POSTED_AT}</td>
-	<!-- ENDIF -->
-		<!-- IF { $forummarks[sitemarksloop].U_MOVE_UP } || { $forummarks[sitemarksloop].U_MOVE_DOWN } -->
-		<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
-			<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
-			<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
+			<!-- IF { $forummarks[sitemarksloop].U_MOVE_UP } || { $forummarks[sitemarksloop].U_MOVE_DOWN } -->
+			<td class="postdetails" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap">
+				<!-- IF { $forummarks:U_MOVE_UP } --><a href="{ $forummarks:U_MOVE_UP }">{ $L_MOVE_UP }</a><!-- ENDIF --><!-- IF { $forummarks:U_MOVE_UP } && { $forummarks:U_MOVE_DOWN } --> | <!-- ENDIF -->
+				<!-- IF { $forummarks:U_MOVE_DOWN } --><a href="{ $forummarks:U_MOVE_DOWN }">{ $L_MOVE_DOWN }</a><!-- ENDIF --></td>
+			<!-- ENDIF -->
+			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $forummarks:TOPIC_ID }"/> </td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row1">
+			<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
+		</tr>
+		<!-- ENDLOOP -->
+		<tr>
+			<td class="cat" colspan="5" align="right"><input class="button" type="submit" name="unbookmark" value="{$L_REMOVE_BOOKMARK_MARKED}" />&nbsp;</td>
+		</tr>
 		<!-- ENDIF -->
-		<td style="padding: 4px;"> <input type="checkbox" name="t[{ $forummarks:TOPIC_ID }]" /> </td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr class="row1">
-		<td colspan="5" align="center"><b class="genmed">{ $L_NO_BOOKMARKS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
-	<tr>
-		<td class="cat" colspan="5" align="right"><input class="btnlite" type="submit" name="unbookmark" value="{$L_REMOVE_BOOKMARK_MARKED}" />&nbsp;</td>
-	</tr>
-	<!-- ENDIF -->
-</table>
+	</table>
+</form>
 
 <!-- IF !{ $S_BOOKMARKS } --><div class="gensmall" style="float: right; padding-top: 2px;"><b><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div><!-- ENDIF -->
 <br />

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_main_subscribed.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_main_subscribed.html	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_main_subscribed.html	2005-09-30 15:58:35 UTC (rev 152)
@@ -16,87 +16,89 @@
 //-->
 </script>
 
-<table class="tablebg" width="100%" cellspacing="1">
-	<tr>
-		<th colspan="4">{ $L_UCP }</th>
-	</tr>
-	<tr>
-		<td class="row1" colspan="4" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
-	</tr>
-	<tr>
-		<th colspan="4">{ $L_WATCHED_FORUMS }</th>
-	</tr>
-	<!-- LOOP $forumrow -->
-
-	<!-- IF { $forumrow:#LOOP_INDEX } % 2 -->
-	<tr class="row1">
-	<!-- ELSE -->
-	<tr class="row2">
-	<!-- ENDIF -->
-
-		<td style="padding: 4px;" width="20" align="center" valign="middle">{ $forumrow:FORUM_FOLDER_IMG }</td>
-		<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></p></td>
-		<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap"><!-- IF { $forumrow:LAST_POST_TIME } -->{ $forumrow:LAST_POST_TIME }<br />
-		<!-- IF { $forumrow:U_LAST_POST_AUTHOR } --><a href="{$forumrow:U_LAST_POST_AUTHOR}">{ $forumrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forumrow:LAST_POST_AUTHOR }
-		<!-- ENDIF --> <a href="{ $forumrow:U_LAST_POST }">{ $forumrow:LAST_POST_IMG }</a><!-- ELSE -->{$L_NO_POSTS}<!-- ENDIF --></td>
-		<td style="padding: 4px;"> <input type="checkbox" name="f[{ $forumrow:FORUM_ID }]" /> </td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr class="row1">
-		<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_FORUMS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
+<form name="ucp" method="post" action="{ $S_UCP_ACTION }"<!-- IF isset({ $S_FORM_ENCTYPE }) -->{ $S_FORM_ENCTYPE }<!-- ENDIF --> >
+	<table class="tablebg" width="100%" cellspacing="1">
+		<tr>
+			<th colspan="4">{ $L_UCP }</th>
+		</tr>
+		<tr>
+			<td class="row1" colspan="4" align="center"><span class="genmed">{ $L_UCP_WELCOME }</span></td>
+		</tr>
+		<tr>
+			<th colspan="4">{ $L_WATCHED_FORUMS }</th>
+		</tr>
+		<!-- LOOP $forumrow -->
 	
-	<tr>
-		<th colspan="4">{ $L_WATCHED_TOPICS }</th>
-	</tr>
+		<!-- IF { $forumrow:#LOOP_INDEX } % 2 -->
+		<tr class="row1">
+		<!-- ELSE -->
+		<tr class="row2">
+		<!-- ENDIF -->
 	
-	<!-- IF { $TOTAL_TOPICS } -->
-	<tr>
-		<td class="row3" colspan="4">
-			<table width="100%" cellspacing="1">
-			<tr>
-				<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
-				<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]&nbsp;</td>
-				<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
-			</tr>
-			</table>
-		</td>
-	</tr>
-	<!-- ENDIF -->
+			<td style="padding: 4px;" width="20" align="center" valign="middle">{ $forumrow:FORUM_FOLDER_IMG }</td>
+			<td style="padding: 4px;" width="100%"><p class="topictitle"><a href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></p></td>
+			<td class="gensmall" style="padding: 4px;" align="center" valign="middle" nowrap="nowrap"><!-- IF { $forumrow:LAST_POST_TIME } -->{ $forumrow:LAST_POST_TIME }<br />
+			<!-- IF { $forumrow:U_LAST_POST_AUTHOR } --><a href="{$forumrow:U_LAST_POST_AUTHOR}">{ $forumrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $forumrow:LAST_POST_AUTHOR }
+			<!-- ENDIF --> <a href="{ $forumrow:U_LAST_POST }">{ $forumrow:LAST_POST_IMG }</a><!-- ELSE -->{$L_NO_POSTS}<!-- ENDIF --></td>
+			<td style="padding: 4px;"> <input type="checkbox" name="f[]" value="{ $forumrow:FORUM_ID }" /> </td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row1">
+			<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_FORUMS }</b></td>
+		</tr>
+		<!-- ENDLOOP -->
+		
+		<tr>
+			<th colspan="4">{ $L_WATCHED_TOPICS }</th>
+		</tr>
+		
+		<!-- IF { $TOTAL_TOPICS } -->
+		<tr>
+			<td class="row3" colspan="4">
+				<table width="100%" cellspacing="1">
+				<tr>
+					<td class="nav" valign="middle" nowrap="nowrap">&nbsp;{ $PAGE_NUMBER }<br /></td>
+					<td class="gensmall" nowrap="nowrap">&nbsp;[ { $TOTAL_TOPICS } ]&nbsp;</td>
+					<td class="gensmall" width="100%" align="right" nowrap="nowrap"><!-- IF { $PAGINATION } --><b><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF { $NEXT_PAGE } -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --></b><!-- ENDIF --></td>
+				</tr>
+				</table>
+			</td>
+		</tr>
+		<!-- ENDIF -->
+		
+		<!-- LOOP $topicrow -->
 	
-	<!-- LOOP $topicrow -->
+		<!-- IF { $topicrow:#LOOP_INDEX } % 2 -->
+		<tr class="row1">
+		<!-- ELSE -->
+		<tr class="row2">
+		<!-- ENDIF -->
+			<td style="padding: 4px;" width="20" align="center" valign="middle">{ $topicrow:TOPIC_FOLDER_IMG }</td>
+			<td style="padding: 4px;" width="100%" valign="middle">
+				<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a></p><br />
+				<!-- IF { $topicrow:PAGINATION } -->
+					<p class="gensmall"> [ { $GOTO_PAGE_IMG } { $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
+				<!-- ENDIF -->
+			<td style="padding: 4px;" align="center" valign="top" nowrap="nowrap">
+				<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
+				<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
+					<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>
+				</p>
+			</td>
+			<td style="padding: 4px;"> <input type="checkbox" name="t[]" value="{ $topicrow:TOPIC_ID }" /> </td>
+		</tr>
+		<!-- LOOPELSE -->
+		<tr class="row1">
+			<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_TOPICS }</b></td>
+		</tr>
+		<!-- ENDLOOP -->
+	
+		<tr>
+			<td class="cat" colspan="4" align="right"><input class="button" type="submit" name="unwatch" value="{ $L_UNWATCH_MARKED }" />&nbsp;</td>
+		</tr>
+	</table>
+</form>
 
-	<!-- IF { $topicrow:#LOOP_INDEX } % 2 -->
-	<tr class="row1">
-	<!-- ELSE -->
-	<tr class="row2">
-	<!-- ENDIF -->
-		<td style="padding: 4px;" width="20" align="center" valign="middle">{ $topicrow:TOPIC_FOLDER_IMG }</td>
-		<td style="padding: 4px;" width="100%" valign="top">
-			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a></p><br />
-			<!-- IF { $topicrow:PAGINATION } -->
-				<p class="gensmall"> [ { $GOTO_PAGE_IMG } { $L_GOTO_PAGE }: { $topicrow:PAGINATION } ] </p>
-			<!-- ENDIF -->
-		<td style="padding: 4px;" align="center" valign="top" nowrap="nowrap">
-			<p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p>
-			<p class="topicdetails"><!-- IF { $topicrow:U_LAST_POST_AUTHOR } --><a href="{ $topicrow:U_LAST_POST_AUTHOR }">{ $topicrow:LAST_POST_AUTHOR }</a><!-- ELSE -->{ $topicrow:LAST_POST_AUTHOR }<!-- ENDIF -->
-				<a href="{ $topicrow:U_LAST_POST }">{ $topicrow:LAST_POST_IMG }</a>
-			</p>
-		</td>
-		<td style="padding: 4px;"> <input type="checkbox" name="t[{ $topicrow:TOPIC_ID }]" /> </td>
-	</tr>
-	<!-- LOOPELSE -->
-	<tr class="row1">
-		<td colspan="4" align="center"><b class="genmed">{ $L_NO_WATCHED_TOPICS }</b></td>
-	</tr>
-	<!-- ENDLOOP -->
-
-	<tr>
-		<td class="cat" colspan="4" align="right"><input class="btnlite" type="submit" name="unwatch" value="{ $L_UNWATCH_MARKED }" />&nbsp;</td>
-	</tr>
-</table>
-
 <div class="gensmall" style="float: right; padding-top: 2px;"><b><a href="javascript:marklist('ucp', true);">{ $L_MARK_ALL }</a> :: <a  href="javascript:marklist('ucp', false);">{ $L_UNMARK_ALL }</a></b></div>
 <br/>
 <!-- INCLUDE modules/Control_Panel/ucp_footer.html -->

Modified: cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_popup.html
===================================================================
--- cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_popup.html	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/includes/templates/modules/Control_Panel/ucp_pm_popup.html	2005-09-30 15:58:35 UTC (rev 152)
@@ -1,7 +1,8 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
 <head>
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+	<meta http-equiv="content-Type" content="text/html; charset=utf-8" />
+	<meta http-equiv="expires" content="0" />
+	<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
 </head>
 <html>
 	<body>
@@ -16,26 +17,29 @@
 	//-->
 	</script>
 
-	{ $A_TABLE_OPEN }
+	{ $THEME_TABLE_OPEN }
+
 	<table width="100%" border="0" cellspacing="0" cellpadding="10">
-	<tr>
-		<td>
-			<table width="100%" border="0" cellspacing="1" cellpadding="4" class="tablebg">
-			<tr class="row1">
-				<td valign="top" align="center">
-					<br /><span class="gen">
-					<!-- IF { $S_NOT_LOGGED_IN } -->
-						{ $L_LOGIN_CHECK_PM }
-					<!-- ELSE -->
-						{ $MESSAGE }<br /><br />{ $CLICK_TO_VIEW }
-					<!-- ENDIF -->
-					</span>
-					<br /><br /><span class="genmed"><a href="javascript:window.close();">{ $L_CLOSE_WINDOW }</a></span><br /><br /></td>
-			</tr>
-			</table>
-		</td>
-	</tr>
+		<tr>
+			<td>
+				<table width="100%" border="0" cellspacing="1" cellpadding="4" class="tablebg">
+				<tr class="row1">
+					<td valign="top" align="center">
+						<br /><span class="gen">
+						<!-- IF { $S_NOT_LOGGED_IN } -->
+							{ $L_LOGIN_CHECK_PM }
+						<!-- ELSE -->
+							{ $MESSAGE }<br /><br />{ $CLICK_TO_VIEW }
+						<!-- ENDIF -->
+						</span>
+						<br /><br /><span class="genmed"><a href="javascript:window.close();">{ $L_CLOSE_WINDOW }</a></span><br /><br /></td>
+				</tr>
+				</table>
+			</td>
+		</tr>
 	</table>
-	{ $A_TABLE_CLOSE }
+	
+	{ $THEME_TABLE_CLOSE }
+
 	</body>
 </html>
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/install/build_data.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -129,7 +129,7 @@
 
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('articles', 1, 1, 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Contact', 1, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Calender', 1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('calender', 1, 1, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Control_Panel', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Forums', 1, 2, 2)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."modules (module_name, module_type, module_status, module_sides) VALUES ('Members_List', 1, 2, 2)");
@@ -176,7 +176,7 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data')");
+$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', '', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8,66.249.64.', 'Googlebot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 $_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/install/build_tables.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -287,7 +287,7 @@
 $_CLASS['core_db']->add_table_field_int('user_allow_email', array('max' => 1));
 
 $_CLASS['core_db']->add_table_field_char('user_sig_bbcode_uid', 5, true);
-$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 1600, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('user_sig_bbcode_bitfield', array('max' => 16000000, 'null' => true));
 
 $_CLASS['core_db']->add_table_field_int('user_topic_show_days', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('user_topic_sortby_type', 1, true);
@@ -506,7 +506,7 @@
 $_CLASS['core_db']->add_table_field_text('forum_rules', 20000, true);
 $_CLASS['core_db']->add_table_field_char('forum_rules_link', 200, true);
 $_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50, true);
-$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 1000000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5, true);
 $_CLASS['core_db']->add_table_field_char('forum_link', 200, true);
 $_CLASS['core_db']->add_table_field_char('forum_password', 40, true);
@@ -877,7 +877,7 @@
 $_CLASS['core_db']->add_table_field_int('message_edit_user', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('message_checksum', 11);
 $_CLASS['core_db']->add_table_field_int('message_attachment', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', 1000000000);
+$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 5);
 field_unix_time('message_edit_time', true);
 $_CLASS['core_db']->add_table_field_int('message_edit_count', array('max' => 200, 'null' => true));
@@ -969,7 +969,7 @@
 $_CLASS['core_db']->add_table_field_text('search_array', 16000000);
 
 $_CLASS['core_db']->add_table_index('search_id', 'primary');
-$_CLASS['core_db']->add_table_index('session_id', 'primary');
+$_CLASS['core_db']->add_table_index('session_id');
 
 $_CLASS['core_db']->table_create('commit');
 

Modified: cms/trunk/javascript/editor.js
===================================================================
--- cms/trunk/javascript/editor.js	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/javascript/editor.js	2005-09-30 15:58:35 UTC (rev 152)
@@ -107,17 +107,9 @@
 
 	var message_name = 'message_' + post_id;
 	var theSelection = '';
-	var divarea = false;
 
-	if (document.all)
-	{
-		eval("divarea = document.all." + message_name + ";");
-	}
-	else
-	{
-		eval("divarea = document.getElementById('" + message_name + "');");
-	}
-
+	var divarea = document.getElementById(message_name);
+	
 	// Get text selection - not only the post content :(
 	if (window.getSelection)
 	{
@@ -132,7 +124,7 @@
 		theSelection = document.selection.createRange().text;
 	}
 
-	if (theSelection == '')
+	if (!theSelection)
 	{
 		if (document.all)
 		{

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_calender.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_calender.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_calender.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -1,7 +1,30 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
 
+$Id$
+*/
+
 class ucp_calender extends module  
 {
+	var $error = array();
+
 	function ucp_calender($id, $mode)
 	{
 		global $_CLASS, $table_prefix, $site_file_root;
@@ -21,7 +44,7 @@
 		$_CLASS['calender']->table = CALENDER_TABLE;
 		$_CLASS['calender']->set_date($day, $month, $year);
 		
-		if (isset($_GET['mode']) && $_GET['mode'] == 'details')
+		if (isset($_GET['mode']) && $_GET['mode'] === 'details')
 		{
 			$mode = 'details';
 		}
@@ -60,15 +83,14 @@
 			case 'add_event':
 				if (isset($_POST['submit']))
 				{
-					if ($this->add_event() === false)
+					if ($this->add_event() !== false)
 					{
-						echo implode('<br/>', $this->error);
-					}
-					
-					break;
+						trigger_error('EVENT_ADDED');
+					}			
 				}
 
 				$_CLASS['core_template']->assign_array(array(
+					'ERROR'			=> empty($this->error) ? '' : implode('<br/>', $this->error),
 					'S_UCP_ACTION'	=> generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"),
 				));
 
@@ -91,9 +113,8 @@
 				$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_details.html');
 			break;
 			
-			case 'month_view':
+			//case 'month_view':
 			default:
-				
 				$_CLASS['calender']->get_events_month($link);
 				$_CLASS['calender']->month_view($link);
 
@@ -129,47 +150,50 @@
 		global $_CLASS;
 
 		$data_array = array(
-			'calender_title'	=> get_variable('title', 'POST', false),
-			'calender_text'		=> get_variable('description', 'POST', false),
-			'calender_notes'	=> get_variable('note', 'POST', false),
+			'calender_title'	=> mb_strtolower(htmlentities(get_variable('title', 'POST', ''), ENT_QUOTES, 'UTF-8')),
+			'calender_text'		=> strip_tags(get_variable('description', 'POST', false)),
+			'calender_notes'	=> strip_tags(get_variable('note', 'POST', false)),
 			'calender_starts'	=> get_variable('start', 'POST', false),
 			'calender_expires'	=> get_variable('end', 'POST', false),
 			//'recur'			=> false,
 		);
 
-		$error = array();
+		$this->error = array();
 
+		if (empty($data_array['calender_title']))
+		{
+			$this->error[] = $_CLASS['core_user']->get_lang('NO_TITLE');
+		}
+
 		$start_time = strtotime($data_array['calender_starts']);
 
 		if (!$start_time || $start_time === -1)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_START_TIME');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_START_TIME');
 		}
 
 		$end_time = strtotime($data_array['calender_expires']);
 
 		if (!$end_time || $end_time === -1)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_END_TIME');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_END_TIME');
 		}
 		
-		if (!$error && $start_time > $end_time)
+		if (empty($this->error) && $start_time > $end_time)
 		{
-			$error[] = $_CLASS['core_user']->get_lang('ERROR_');
+			$this->error[] = $_CLASS['core_user']->get_lang('ERROR_');
 		}
 
-		if (!empty($error))
+		if (!empty($this->error))
 		{
-			$this->error = $error;
-
 			return false;
 		}
 
 		//$duration = $start_time - $end_time;
 		//$start_time = $date = implode(''. explode(':', date('H:i', $start_time)));;
 
-		$data_array['calender_starts'] = $start_time;
-		$data_array['calender_expires'] = $end_time;
+		$data_array['calender_starts'] = $_CLASS['core_user']->time_convert($start_time, 'gmt');
+		$data_array['calender_expires'] = $_CLASS['core_user']->time_convert($end_time, 'gmt');
 		
 		$_CLASS['core_db']->query('INSERT INTO ' . CALENDER_TABLE .' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data_array));
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_groups.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_groups.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -35,7 +35,7 @@
 		{
 			if (is_array($_POST['group_id']))
 			{
-				$group_id = array_map('intval', get_variable('group_id', 'REQUEST', false, 'array'));
+				$group_id = array_unique(get_variable('group_id', 'REQUEST', array(), 'array:int'));
 			}
 			else
 			{
@@ -59,11 +59,6 @@
 			switch ($_POST['mode'])
 			{
 				case 'resign':
-// need to get member status and add other group types ( pending members can resign from all )
-					$sql = 'SELECT group_id	FROM  ' . GROUPS_TABLE . '
-								WHERE group_type IN (' . GROUP_SYSTEM .', '.GROUP_SPECIAL.')
-								AND group_id IN ('. implode(', ', $group_id) .')';
-								
 					$sql = 'SELECT m.member_status, g.group_id, g.group_type
 								FROM ' . USER_GROUP_TABLE . ' m, ' . GROUPS_TABLE . ' g 
 								WHERE m.user_id = ' . $_CLASS['core_user']->data['user_id'] . '
@@ -72,7 +67,6 @@
 					$result = $_CLASS['core_db']->query($sql);
 
 					$unset = array();
-
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
 						if ($row['group_type'] == GROUP_SYSTEM && $row['group_type'] == GROUP_SPECIAL && $row['member_status'] != STATUS_PENDING)
@@ -85,18 +79,20 @@
 					$group_id = array_diff($group_id, $unset);
 					unset($unset);
 
-					groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
+					if (!empty($group_id))
+					{
+						groups_user_remove($group_id, $_CLASS['core_user']->data['user_id']);
+					}
 				break;
 
 				case 'apply':
 					$sql = 'SELECT group_id FROM ' . USER_GROUP_TABLE . '
 						WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 						AND group_id IN ('. implode(', ', $group_id) .')';
-	
+
 					$result = $_CLASS['core_db']->query($sql);
 
 					$unset = array();
-
 					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
 						$unset[] = $row['group_id'];
@@ -188,7 +184,6 @@
 		$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 
 		$this->display($_CLASS['core_user']->get_lang('UCP_GROUPS'), 'ucp_groups_membership.html');
-		
 	}
 }
 

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_main.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_main.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -29,7 +29,6 @@
 		switch ($mode)
 		{
 			case 'front':
-
 				$_CLASS['core_user']->add_lang(false,'Members_List');
 
 				if ($config['load_db_lastread'] || $config['load_db_track'])
@@ -137,75 +136,16 @@
 				}
 				$_CLASS['core_db']->free_result($result);
 
-/// 
 				$num_real_posts = $_CLASS['core_user']->data['user_posts'];
 				$active_f_row = $active_t_row = array();
 
-				$_CLASS['auth']->acl_getf('f_read');
-/*
-				if ($post_count_ary = $_CLASS['auth']->acl_getf('f_postcount'))
-				{
-					$forum_ary = array();
-					foreach ($post_count_ary as $forum_id => $allowed)
-					{
-						if ($allowed['f_read'] && $allowed['f_postcount'])
-						{
-							$forum_ary[] = $forum_id;
-						}
-					}
-	
-					$post_count_sql = (sizeof($forum_ary)) ? 'AND f.forum_id IN (' . implode(', ', $forum_ary) . ')' : '';
-					unset($forum_ary, $post_count_ary);
-	
-					if ($post_count_sql)
-					{
-						// NOTE: The following three queries could be a problem for big boards
-						
-						// Grab all the relevant data
-						$sql = 'SELECT COUNT(p.post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND f.forum_id = p.forum_id 
-								$post_count_sql";
-						$result = $_CLASS['core_db']->query($sql);
-						list($num_posts) = $_CLASS['core_db']->fetch_row_num($result);
-						$_CLASS['core_db']->free_result($result);
-	
-						$num_real_posts = min($_CLASS['core_user']->data['user_posts'], $num_posts);
-	
-						$sql = 'SELECT f.forum_id, f.forum_name, COUNT(post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f 
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND f.forum_id = p.forum_id 
-								$post_count_sql
-							GROUP BY f.forum_id, f.forum_name  
-							ORDER BY num_posts DESC"; 
-						$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-						$active_f_row = $_CLASS['core_db']->fetch_row_assoc($result);
-						$_CLASS['core_db']->free_result($result);
-	
-						$sql = 'SELECT t.topic_id, t.topic_title, COUNT(p.post_id) AS num_posts   
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . ' f  
-							WHERE p.poster_id = ' . $_CLASS['core_user']->data['user_id'] . " 
-								AND t.topic_id = p.topic_id  
-								AND f.forum_id = t.forum_id 
-								$post_count_sql
-							GROUP BY t.topic_id, t.topic_title  
-							ORDER BY num_posts DESC";
-						$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-						$active_t_row = $_CLASS['core_db']->fetch_row_assoc($result);
-						$_CLASS['core_db']->free_result($result);
-					}
-				}
-			*/
 				// Do the relevant calculations 
 				$memberdays = max(1, round(($_CLASS['core_user']->time - $_CLASS['core_user']->data['user_reg_date']) / 86400));
 				$posts_per_day = $_CLASS['core_user']->data['user_posts'] / $memberdays;
 				$percentage = ($config['num_posts']) ? min(100, ($num_real_posts / $config['num_posts']) * 100) : 0;
 
 				$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+
 				if (!empty($active_f_row['num_posts']))
 				{
 					$active_f_name = $active_f_row['forum_name'];
@@ -216,6 +156,7 @@
 				unset($active_f_row);
 
 				$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+
 				if (!empty($active_t_row['num_posts']))
 				{
 					$active_t_name = $active_t_row['topic_title'];
@@ -252,36 +193,34 @@
 				break;
 
 			case 'subscribed':
-
 				require($site_file_root.'includes/forums/functions_display.php');
-				//$_CLASS['core_user']->add_lang('viewforum');
 
-				$unwatch = (isset($_POST['unwatch'])) ? true : false;
+				$unwatch = isset($_POST['unwatch']);
 				
 				if ($unwatch)
 				{
-					$forums = (isset($_POST['f'])) ? implode(', ', array_map('intval', array_keys($_POST['f']))) : false;
-					$topics = (isset($_POST['t'])) ? implode(', ', array_map('intval', array_keys($_POST['t']))) : false;
+					$forums = array_unique(get_variable('f', 'POST', array(), 'array:int'));
+					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 
-					if ($forums || $topics)
+					if (!empty($forums) || !empty($topics))
 					{
 						$l_unwatch = '';
 
-						if ($forums)
+						if (!empty($forums))
 						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-								WHERE forum_id IN ($forums) AND topic_id = 0
-									AND user_id = " .$_CLASS['core_user']->data['user_id'];
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+								WHERE forum_id IN ('.implode(', ', $forums).') AND topic_id = 0
+									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
 							$l_unwatch .= '_FORUMS';
 						}
 
-						if ($topics)
+						if (!empty($topics))
 						{
-							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-								WHERE topic_id IN ($topics)
-									AND user_id = " .$_CLASS['core_user']->data['user_id'];
+							$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
+								WHERE topic_id IN ('.implode(', ', $topics) .')
+									AND user_id = ' .$_CLASS['core_user']->data['user_id'];
 							$_CLASS['core_db']->query($sql);
 
 							$l_unwatch .= '_TOPICS';
@@ -296,7 +235,8 @@
 
 				if ($config['load_db_lastread'])
 				{
-					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND ft.forum_id = f.forum_id)';
+					$sql_from = FORUMS_FORUMS_TABLE . ' f  LEFT JOIN ' . FORUMS_TRACK_TABLE . ' ft ON (ft.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
+									AND ft.forum_id = f.forum_id AND ft.topic_id = 0)';
 					$lastread_select = ', ft.mark_time ';
 				}
 				else
@@ -304,38 +244,44 @@
 					$sql_from = FORUMS_FORUMS_TABLE . ' f ';
 					$lastread_select = '';
 
-					$tracking_topics = (isset($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) ? unserialize(stripslashes($_COOKIE[$_CORE_CONFIG['server']['cookie_name'] . '_track'])) : array();
+					$tracking = @unserialize(get_variable($_CORE_CONFIG['server']['cookie_name'] . '_track', 'COOKIE'));
+
+					if (!is_array($tracking))
+					{
+						$tracking = array();
+					}
 				}
 
 				$sql = "SELECT f.*$lastread_select 
 					FROM $sql_from, " . FORUMS_WATCH_TABLE . ' fw
 					WHERE fw.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' 
-						AND f.forum_id = fw.forum_id 
+						 AND fw.topic_id = 0 AND f.forum_id = fw.forum_id
 					ORDER BY left_id';
 
 				$result = $_CLASS['core_db']->query($sql);
-				$topics_count = $_CLASS['core_db']->num_rows($result);
+				//$topics_count = $_CLASS['core_db']->num_rows($result);
 
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$forum_id = $row['forum_id'];
+					$forum_id = (int) $row['forum_id'];
 
 					$unread_forum = false;
 					
 					if ($config['load_db_lastread'])
 					{
-						$forum_check = $row['mark_time'];
+						$mark_time_forum = $row['mark_time'];
 					}
 					else
 					{
-						$forum_check = isset($tracking_topics[$forum_id][0]) ? $tracking_topics[$forum_id][0] : 0;
+						$forum_id36 = base_convert($forum_id, 10, 36);
+						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 					}
 
-					if ($forum_check < $row['forum_last_post_time'])
+					if ($mark_time_forum < $row['forum_last_post_time'])
 					{
 						$unread_forum = true;
 					}
-	
+
 					// Which folder should we display?
 					if ($row['forum_status'] == ITEM_LOCKED)
 					{
@@ -379,45 +325,62 @@
 				$_CLASS['core_db']->free_result($result);
 
 				// Subscribed Topics
-				$start = request_var('start', 0);
+				$start = get_variable('start', 'REQUEST', 0, 'int');
 
-				if ($topics_count)
+				if ($config['load_db_lastread'])
 				{
-					$_CLASS['core_template']->assign_array(array(
-						'PAGINATION'	=> generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start),
-						'PAGE_NUMBER'	=> on_page($topics_count, $config['topics_per_page'], $start),
-						'TOTAL_TOPICS'	=> ($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
-					);
+					$sql_from = FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')';
+					$sql_t_select = ', tt.mark_time';
 				}
-// Fix this up
-				$sql_from = ($config['load_db_lastread']) ? FORUMS_TOPICS_TABLE . ' t LEFT JOIN ' . FORUMS_TRACK_TABLE . ' tt ON (tt.topic_id = t.topic_id AND tt.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')' : TOPICS_TABLE . ' t';
-				$sql_t_select = ($config['load_db_lastread']) ? ', tt.mark_time' : '';
-//
+				else
+				{
+					$sql_from = FORUMS_TOPICS_TABLE . ' t';
+					$sql_t_select = '';
+				}
+
 				$sql = "SELECT t.* $sql_t_select 
 					FROM ". FORUMS_WATCH_TABLE . " tw, $sql_from 
 					WHERE tw.user_id = " . $_CLASS['core_user']->data['user_id'] . '
 						AND t.topic_id = tw.topic_id 
 					ORDER BY t.topic_last_post_time DESC';
+
 				$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+				$topics_count = $_CLASS['core_db']->num_rows($result);
+	
+				if ($topics_count)
+				{
+					$pagination = generate_pagination("Control_Panel&amp;i=$id&amp;mode=$mode", $topics_count, $config['topics_per_page'], $start);
 
+					$_CLASS['core_template']->assign_array(array(
+						'PAGINATION'		=> $pagination['formated'],
+						'PAGINATION_ARRAY'	=> $pagination['array'],
+						'PAGE_NUMBER'		=> on_page($topics_count, $config['topics_per_page'], $start),
+						'TOTAL_TOPICS'		=> ($topics_count === 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count))
+					);
+				}
+				else
+				{
+					$_CLASS['core_template']->assign('TOTAL_TOPICS', false);
+				}
+
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					$topic_id = $row['topic_id'];
 					$forum_id = $row['forum_id'];
 					
-					if ($config['load_db_lastread'])
+					if (!$config['load_db_lastread'])
 					{
 						$topic_id36 = base_convert($topic_id, 10, 36);
-						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : $forum_id;
-						$mark_time_topic = (isset($tracking_topics[$forum_id36][$topic_id36])) ? base_convert($tracking_topics[$forum_id36][$topic_id36], 36, 10) + $config['board_startdate'] : 0;
+						$forum_id36 = ($row['topic_type'] == POST_GLOBAL) ? 0 : base_convert($forum_id, 10, 36);
 
-						$mark_time_forum = (isset($tracking_topics[$forum_id][0])) ? base_convert($tracking_topics[$forum_id][0], 36, 10) + $config['board_startdate'] : 0;
+						$mark_time_topic = isset($tracking[$forum_id36][$topic_id36]) ? (int) base_convert($tracking[$forum_id36][$topic_id36], 36, 10) : 0;
+						$mark_time_forum = isset($tracking[$forum_id36][0]) ? (int) base_convert($tracking[$forum_id36][0], 36, 10) : 0;
 
 						$row['mark_time'] = max($mark_time_topic, $mark_time_forum);
 					}
 
 					// Replies
-					$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? $row['topic_replies_real'] : $row['topic_replies'];
+					$replies = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? $row['topic_replies_real'] : $row['topic_replies'];
 
 					if ($row['topic_status'] == ITEM_MOVED)
 					{
@@ -430,17 +393,24 @@
 					topic_status($row, $replies, $row['mark_time'], $unread_topic, $folder_img, $folder_alt, $topic_type);
 					$newest_post_img = ($unread_topic) ? '<a href="'. generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;view=unread#unread").'">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-					$view_topic_url = "Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id";
+					$view_topic_url = 'Forums&amp;file=viewtopic&amp;t='.$topic_id;
+					$pagination = generate_pagination($view_topic_url, $replies, $config['topics_per_page'], 0);
 
 					$_CLASS['core_template']->assign_vars_array('topicrow', array(
 						'FORUM_ID' 			=> $forum_id,
 						'TOPIC_ID' 			=> $topic_id,
-						'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+
+						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
 						'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
-						'PAGINATION' 		=> topic_generate_pagination($replies, 'Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . "&amp;t=$topic_id"),
+
+						'PAGINATION'		=> $pagination['formated'],
+						'PAGINATION_ARRAY'	=> $pagination['array'],
+
 						'REPLIES' 			=> $replies,
 						'VIEWS' 			=> $row['topic_views'],
 						'TOPIC_TITLE' 		=> censor_text($row['topic_title']),
@@ -449,14 +419,14 @@
 						'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 						'NEWEST_POST_IMG' 	=> $newest_post_img,
 						'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
-						'TOPIC_ICON_IMG'	=> (!empty($icons[$row['icon_id']])) ? '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />' : '',
+						'TOPIC_ICON_IMG'	=> empty($icons[$row['icon_id']]) ? '' : '<img src="' . $config['icons_path'] . '/' . $icons[$row['icon_id']]['img'] . '" width="' . $icons[$row['icon_id']]['width'] . '" height="' . $icons[$row['icon_id']]['height'] . '" alt="" title="" />',
 						'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $forum_id) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', sprintf($_CLASS['core_user']->lang['TOTAL_ATTACHMENTS'], $row['topic_attachment'])) : '',
 
-						'S_TOPIC_TYPE'			=> $row['topic_type'],
-						'S_UNREAD_TOPIC'		=> $unread_topic,
+						'S_TOPIC_TYPE'		=> $row['topic_type'],
+						'S_UNREAD_TOPIC'	=> $unread_topic,
 
 						'U_LAST_POST'		=> generate_link($view_topic_url .  '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),
-						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] != ANONYMOUS && $row['topic_last_poster_id']) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+						'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id'] && $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 						'U_VIEW_TOPIC'		=> generate_link($view_topic_url))
 					);
 					
@@ -465,13 +435,6 @@
 			break;
 
 			case 'bookmarks':
-				
-				if (!$config['allow_bookmarks'])
-				{
-					$_CLASS['core_template']->assign('S_BOOKMARKS_DISABLED', true);
-					break;
-				}
-				
 				require($site_file_root.'includes/forums/functions_display.php');
 
 				$move_up = request_var('move_up', 0);
@@ -500,28 +463,25 @@
 				
 				if (isset($_POST['unbookmark']))
 				{
-					$s_hidden_fields = '<input type="hidden" name="unbookmark" value="1" />';
-					$topics = (isset($_POST['t'])) ? array_map('intval', array_keys($_POST['t'])) : array();
-					$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+					$topics = array_unique(get_variable('t', 'POST', array(), 'array:int'));
 					
 					if (empty($topics))
 					{
 						trigger_error('NO_BOOKMARKS_SELECTED');
 					}
-					
-					foreach ($topics as $topic_id)
-					{
-						$s_hidden_fields .= '<input type="hidden" name="t[' . $topic_id . ']" value="1" />';
-					}
 
-					if (confirm_box(true))
+					$hidden_fields = array(
+						'unbookmark' => 1,
+						't' => $topics
+					);
+
+					if (display_confirmation($_CLASS['core_user']->get_lang('REMOVE_SELECTED_BOOKMARKS'), generate_hidden_fields($hidden_fields)))
 					{
 						$sql = 'DELETE FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 								AND topic_id IN (' . implode(', ', $topics) . ')';
 						$_CLASS['core_db']->query($sql);
 
-						// Re-Order bookmarks (possible with one query? This query massaker is not really acceptable...)
 						$sql = 'SELECT topic_id FROM ' . FORUMS_BOOKMARKS_TABLE . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 							ORDER BY order_id ASC';
@@ -538,14 +498,12 @@
 						}
 						$_CLASS['core_db']->free_result($result);
 
+						$url = generate_link('Control_Panel&amp;i=main&amp;mode=bookmarks');
+
 						$_CLASS['core_display']->meta_refresh(3, $url);
 						$message = $_CLASS['core_user']->lang['BOOKMARKS_REMOVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="' . $url . '">', '</a>');
 						trigger_error($message);
 					}
-					else
-					{
-						confirm_box(false, 'REMOVE_SELECTED_BOOKMARKS', $s_hidden_fields);
-					}
 				}
 
 				// We grab deleted topics here too...
@@ -597,7 +555,9 @@
 						'TOPIC_TYPE' 		=> $topic_type,
 						'FORUM_NAME'		=> $row['forum_name'],
 
-						'TOPIC_AUTHOR' 		=> topic_topic_author($row),
+						'TOPIC_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? (($row['topic_first_poster_name']) ? $row['topic_first_poster_name'] : $_CLASS['core_user']->get_lang('GUEST')) : $row['topic_first_poster_name'],
+						'LINK_AUTHOR' 		=> ($row['topic_poster'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['topic_poster']),
+
 						'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 						'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 						'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_pm_compose.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -78,11 +78,6 @@
 		redirect($redirect);
 	}
 
-	if ($action == 'forward' && (!$config['forward_pm'] || !$_CLASS['auth']->acl_get('u_pm_forward')))
-	{
-		trigger_error('NO_AUTH_FORWARD_MESSAGE');
-	}
-
 	if ($action == 'edit' && !$_CLASS['auth']->acl_get('u_pm_edit'))
 	{
 		trigger_error('NO_AUTH_EDIT_MESSAGE');
@@ -662,9 +657,10 @@
 		}
 
 		$u = $g = array();
+
 		foreach (array('u', 'g') as $type)
 		{
-			if (isset($result[$type]) && $result[$type])
+			if (isset($result[$type]))
 			{
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result[$type]))
 				{
@@ -723,26 +719,27 @@
 	{
 		case 'post':
 			$page_title = $_CLASS['core_user']->lang['POST_NEW_PM'];
-			break;
+		break;
 
 		case 'quote':
 			$page_title = $_CLASS['core_user']->lang['POST_QUOTE_PM'];
-			break;
+		break;
 
 		case 'reply':
 			$page_title = $_CLASS['core_user']->lang['POST_REPLY_PM'];
-			break;
+		break;
 
 		case 'edit':
 			$page_title = $_CLASS['core_user']->lang['POST_EDIT_PM'];
-			break;
+		break;
 
 		case 'forward':
 			$page_title = $_CLASS['core_user']->lang['POST_FORWARD_PM'];
-			break;
+		break;
 
 		default:
 			trigger_error('NO_ACTION_MODE');
+		break;
 	}
 
 	$s_hidden_fields = '<input type="hidden" name="lastclick" value="' . $current_time . '" />';
@@ -843,7 +840,9 @@
 			require_once(SITE_FILE_ROOT.'includes/functions_user.php');
 
 			$user_id_ary = user_get_id($usernames, $difference);
-			
+
+			unset($user_id_ary[ANONYMOUS]);
+
 			if (!empty($user_id_ary))
 			{
 				foreach ($user_id_ary as $user_id)
@@ -854,7 +853,7 @@
 		}
 
 		// Add Friends if specified
-		$friend_list = (is_array($_REQUEST['add_' . $type])) ? array_map('intval', array_keys($_REQUEST['add_' . $type])) : array();
+		$friend_list = is_array($_REQUEST['add_' . $type]) ? array_map('intval', array_keys($_REQUEST['add_' . $type])) : array();
 
 		foreach ($friend_list as $user_id)
 		{

Modified: cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php
===================================================================
--- cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Control_Panel/ucp/ucp_prefs.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -1,11 +1,33 @@
 <?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005									||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
 // -------------------------------------------------------------
 //
 // $Id: ucp_prefs.php,v 1.15 2004/06/06 21:44:48 acydburn Exp $
 //
 // FILENAME  : ucp_prefs.php
 // STARTED   : Mon May 19, 2003
-// COPYRIGHT : ? 2001, 2003 phpBB Group
+// COPYRIGHT : 2001, 2003 phpBB Group
 // WWW       : http://www.phpbb.com/
 // LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
 // 
@@ -29,32 +51,32 @@
 				{
 					$time_format	= get_variable('time_format', 'REQUEST', null);
 					$lang			= get_variable('lang', 'REQUEST', null);
-					$tz				= get_variable('tz', 'REQUEST', null);
+					$tz				= get_variable('tz', 'REQUEST', 0);
 					$dst			= get_variable('dst', 'REQUEST', null);
 
 					$theme 		= get_variable('theme', 'REQUEST', null);
-	
+
 					$viewemail		= (bool) get_variable('viewemail', 'REQUEST', true, 'interger');
 					$massemail		= (bool) get_variable('massemail', 'REQUEST', false, 'interger');
-					$hideonline	= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
-					$notifypm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
+					$hideonline		= (bool) get_variable('hideonline', 'REQUEST', true, 'interger');
+					$notify_pm		= (bool) get_variable('notifypm', 'REQUEST', true, 'interger');
 
 					$popuppm	= (bool) get_variable('popuppm', 'REQUEST', true, 'interger');
 					$allowpm	= (bool) get_variable('allowpm', 'REQUEST', true, 'interger');
-				//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
+					//$report_pm_notify	= (bool) get_variable('report_pm_notify', 'REQUEST', true, 'interger');
 
 					if (empty($error))
 					{
 						$_CLASS['core_user']->optionset('popuppm', $popuppm);
 						//$_CLASS['core_user']->optionset('report_pm_notify', $report_pm_notify);
 						
-						$sql_ary = array(
+						$sql_array = array(
 							'user_allow_pm'			=> $allowpm, 
 							'user_allow_viewemail'	=> $viewemail, 
 							'user_allow_massemail'	=> $massemail, 
 							'user_allow_viewonline'	=> ($_CLASS['forums_auth']->acl_get('u_hideonline')) ? !$hideonline : $_CLASS['core_user']->data['user_allow_viewonline'], 
 							//'user_notify_type'		=> $notifymethod, 
-							//'user_notify_pm'		=> $notifypm,
+							'user_notify_pm'		=> $notify_pm,
 							'user_data'				=> serialize($_CLASS['core_user']->data['user_data']), 
 
 							'user_dst'				=> $dst,
@@ -64,55 +86,58 @@
 							'user_theme'			=> $theme,
 						);
 
+						array_merge($_CLASS['core_user']->data, $sql_array);
+
 						$sql = 'UPDATE ' . USERS_TABLE . ' 
-							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_ary) . '
+							SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_array) . '
 							WHERE user_id = ' . $_CLASS['core_user']->data['user_id'];
 						$_CLASS['core_db']->sql_query($sql);
 						
-						if ($theme != $_CLASS['core_display']->theme)
+						if ($theme !== $_CLASS['core_display']->theme_name)
 						{
 							$_CLASS['core_user']->session_data_remove('user_theme');
 						}
 						
 						$_CLASS['core_display']->meta_refresh(3, generate_link("Control_Panel&amp;i=$id&amp;mode=$mode"));
 						$message = $_CLASS['core_user']->lang['PREFERENCES_UPDATED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link("Control_Panel&amp;i=$id&amp;mode=$mode").'">', '</a>');
+
 						trigger_error($message);
 					}
-					// Replace "error" strings with their real, localised form
-					$error = preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error);
 				}
 
-				$viewemail = (isset($viewemail)) ? $viewemail : $_CLASS['core_user']->data['user_allow_viewemail'];
+				$allowpm = isset($allowpm) ? $allowpm : $_CLASS['core_user']->data['user_allow_pm'];
+				$dst = isset($dst) ? $dst : $_CLASS['core_user']->data['user_dst'];
+				$hideonline = isset($hideonline) ? $hideonline : !$_CLASS['core_user']->data['user_allow_viewonline'];
+				$massemail = isset($massemail) ? $massemail : $_CLASS['core_user']->data['user_allow_massemail'];
+				$notifypm = isset($notifypm) ? $notifypm : $_CLASS['core_user']->data['user_notify_pm'];
+				$popuppm = isset($popuppm) ? $popuppm : $_CLASS['core_user']->optionget('popuppm');
+				$viewemail = isset($viewemail) ? $viewemail : $_CLASS['core_user']->data['user_allow_viewemail'];
+				$report_pm_notify = isset($report_pm_notify) ? $report_pm_notify : $_CLASS['core_user']->optionget('report_pm_notify');
+				$notifymethod = isset($notifymethod) ? $notifymethod : $_CLASS['core_user']->data['user_notify_type'];
+				$dateformat = isset($dateformat) ? $dateformat : $_CLASS['core_user']->data['user_time_format'];
+				$lang = isset($lang) ? $lang : $_CLASS['core_user']->data['user_lang'];
+				$theme = isset($theme) ? $theme : $_CLASS['core_user']->data['user_theme'];
+				$tz = isset($tz) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
+
 				$view_email_yes = ($viewemail) ? ' checked="checked"' : '';
 				$view_email_no = (!$viewemail) ? ' checked="checked"' : '';
-				$massemail = (isset($massemail)) ? $massemail : $_CLASS['core_user']->data['user_allow_massemail'];
 				$mass_email_yes = ($massemail) ? ' checked="checked"' : '';
 				$mass_email_no = (!$massemail) ? ' checked="checked"' : '';
-				$allowpm = (isset($allowpm)) ? $allowpm : $_CLASS['core_user']->data['user_allow_pm'];
 				$allow_pm_yes = ($allowpm) ? ' checked="checked"' : '';
 				$allow_pm_no = (!$allowpm) ? ' checked="checked"' : '';
-				$hideonline = (isset($hideonline)) ? $hideonline : !$_CLASS['core_user']->data['user_allow_viewonline'];
 				$hide_online_yes = ($hideonline) ? ' checked="checked"' : '';
 				$hide_online_no = (!$hideonline) ? ' checked="checked"' : '';
-				$notifypm = (isset($notifypm)) ? $notifypm : '';
 				$notify_pm_yes = ($notifypm) ? ' checked="checked"' : '';
 				$notify_pm_no = (!$notifypm) ? ' checked="checked"' : '';
-				$popuppm = (isset($popuppm)) ? $popuppm : $_CLASS['core_user']->optionget('popuppm');
 				$popup_pm_yes = ($popuppm) ? ' checked="checked"' : '';
 				$popup_pm_no = (!$popuppm) ? ' checked="checked"' : '';
-				$report_pm_notify = (isset($report_pm_notify)) ? $report_pm_notify : $_CLASS['core_user']->optionget('report_pm_notify');
 				$report_pm_notify_yes = ($report_pm_notify) ? ' checked="checked"' : '';
 				$report_pm_notify_no = (!$report_pm_notify) ? ' checked="checked"' : '';
-				$dst = (isset($dst)) ? $dst : $_CLASS['core_user']->data['user_dst'];
 				$dst_yes = ($dst) ? ' checked="checked"' : '';
 				$dst_no = (!$dst) ? ' checked="checked"' : '';
 
-				$notifymethod = (isset($notifymethod)) ? $notifymethod : $_CLASS['core_user']->data['user_notify_type'];
-				$dateformat = (isset($dateformat)) ? $dateformat : $_CLASS['core_user']->data['user_time_format'];
-				$lang = (isset($lang)) ? $lang : $_CLASS['core_user']->data['user_lang'];
-				$theme = (isset($theme)) ? $theme : $_CLASS['core_user']->data['user_theme'];
-				$tz = (isset($tz)) ? $tz * 3600 : $_CLASS['core_user']->data['user_timezone'] / 3600;
 
+
 				$_CLASS['core_template']->assign_array(array( 
 					'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',
 

Modified: cms/trunk/modules/Forums/viewforum.php
===================================================================
--- cms/trunk/modules/Forums/viewforum.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/Forums/viewforum.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -288,7 +288,7 @@
 	'TOTAL_TOPICS'		=> ($forum_data['forum_flags'] & 16) ? false : (($topics_count == 1) ? $_CLASS['core_user']->lang['VIEW_FORUM_TOPIC'] : sprintf($_CLASS['core_user']->lang['VIEW_FORUM_TOPICS'], $topics_count)),
 	'MODERATORS'		=> empty($moderators[$forum_id]) ? '' : implode(', ', $moderators[$forum_id]),
 
-	'POST_IMG' 				=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
+	'POST_IMG' 			=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
 
 	'MOD_TOPIC_LOCK'	=>	$_CLASS['auth']->acl_get('m_lock', $forum_id),
 	'MOD_TOPIC_TITLE'	=>	$_CLASS['auth']->acl_get('m_', $forum_id),

Modified: cms/trunk/modules/calender/configurator.php
===================================================================
--- cms/trunk/modules/calender/configurator.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/calender/configurator.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -84,6 +84,8 @@
 		$_CLASS['core_db']->query('DROP TABLE ' . CALENDER_TABLE);
 
 		$_CLASS['core_db']->report_error(true);
+		
+		return true;
 	}
 }
 

Modified: cms/trunk/modules/calender/index.php
===================================================================
--- cms/trunk/modules/calender/index.php	2005-09-30 15:46:45 UTC (rev 151)
+++ cms/trunk/modules/calender/index.php	2005-09-30 15:58:35 UTC (rev 152)
@@ -75,7 +75,7 @@
 			'NEXT_DAY_LINK'			=> $next_day,
 		));
 
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_day.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_day.html');
 	break;
 		
 	case 'details':
@@ -91,7 +91,7 @@
 			'CAL_END_TIME'		=> $_CLASS['core_user']->format_date($data['end_time']),
 		));
 	
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_details.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_details.html');
 
 	break;
 	
@@ -122,7 +122,7 @@
 			'NEXT_MONTH'			=> generate_link($link.'&amp;mode=month_view&amp;year='.$month_flanks['next_month']['year'].'&amp;month='.$month_flanks['next_month']['month']),
 		));
 
-		$_CLASS['core_display']->display(false, 'modules/calender/calender_main.html');
+		$_CLASS['core_display']->display(false, 'modules/Control_Panel/ucp_calender_main.html');
 
 	break;	
 }



