From viperal at mail.berlios.de  Fri Aug  4 15:47:49 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Fri, 4 Aug 2006 15:47:49 +0200
Subject: [Viperals-svncheckins] r179 - in cms/trunk: admin includes
	includes/db includes/forums includes/templates/admin/modules
	install modules/control_panel/modules modules/forums
	modules/forums/images modules/forums/images/en
	modules/forums/images/karma themes/viperal/template/modules
Message-ID: <200608041347.k74DlnLY003923@sheep.berlios.de>

Author: viperal
Date: 2006-08-04 15:47:39 +0200 (Fri, 04 Aug 2006)
New Revision: 179

Added:
   cms/trunk/modules/forums/images/
   cms/trunk/modules/forums/images/background.gif
   cms/trunk/modules/forums/images/cellpic.gif
   cms/trunk/modules/forums/images/cellpic1.gif
   cms/trunk/modules/forums/images/cellpic2.jpg
   cms/trunk/modules/forums/images/cellpic3.gif
   cms/trunk/modules/forums/images/created_by.jpg
   cms/trunk/modules/forums/images/en/
   cms/trunk/modules/forums/images/en/btn_aim.gif
   cms/trunk/modules/forums/images/en/btn_approve.gif
   cms/trunk/modules/forums/images/en/btn_delete.gif
   cms/trunk/modules/forums/images/en/btn_edit.gif
   cms/trunk/modules/forums/images/en/btn_email.gif
   cms/trunk/modules/forums/images/en/btn_icq.gif
   cms/trunk/modules/forums/images/en/btn_info.gif
   cms/trunk/modules/forums/images/en/btn_ip.gif
   cms/trunk/modules/forums/images/en/btn_jabber.gif
   cms/trunk/modules/forums/images/en/btn_locked.gif
   cms/trunk/modules/forums/images/en/btn_msnm.gif
   cms/trunk/modules/forums/images/en/btn_offline.gif
   cms/trunk/modules/forums/images/en/btn_online.gif
   cms/trunk/modules/forums/images/en/btn_pm.gif
   cms/trunk/modules/forums/images/en/btn_post.gif
   cms/trunk/modules/forums/images/en/btn_post_pm.gif
   cms/trunk/modules/forums/images/en/btn_profile.gif
   cms/trunk/modules/forums/images/en/btn_quote.gif
   cms/trunk/modules/forums/images/en/btn_reply.gif
   cms/trunk/modules/forums/images/en/btn_reply_pm.gif
   cms/trunk/modules/forums/images/en/btn_report.gif
   cms/trunk/modules/forums/images/en/btn_search.gif
   cms/trunk/modules/forums/images/en/btn_www.gif
   cms/trunk/modules/forums/images/en/btn_yim.gif
   cms/trunk/modules/forums/images/folder.gif
   cms/trunk/modules/forums/images/folder_announce.gif
   cms/trunk/modules/forums/images/folder_announce_new.gif
   cms/trunk/modules/forums/images/folder_announce_new_posted.gif
   cms/trunk/modules/forums/images/folder_announce_posted.gif
   cms/trunk/modules/forums/images/folder_big.gif
   cms/trunk/modules/forums/images/folder_hot.gif
   cms/trunk/modules/forums/images/folder_hot_posted.gif
   cms/trunk/modules/forums/images/folder_link_big.gif
   cms/trunk/modules/forums/images/folder_lock.gif
   cms/trunk/modules/forums/images/folder_lock_new.gif
   cms/trunk/modules/forums/images/folder_lock_new_posted.gif
   cms/trunk/modules/forums/images/folder_lock_posted.gif
   cms/trunk/modules/forums/images/folder_locked_big.gif
   cms/trunk/modules/forums/images/folder_moved.gif
   cms/trunk/modules/forums/images/folder_new.gif
   cms/trunk/modules/forums/images/folder_new_big.gif
   cms/trunk/modules/forums/images/folder_new_hot.gif
   cms/trunk/modules/forums/images/folder_new_hot_posted.gif
   cms/trunk/modules/forums/images/folder_new_posted.gif
   cms/trunk/modules/forums/images/folder_posted.gif
   cms/trunk/modules/forums/images/folder_sticky.gif
   cms/trunk/modules/forums/images/folder_sticky_new.gif
   cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
   cms/trunk/modules/forums/images/folder_sticky_posted.gif
   cms/trunk/modules/forums/images/icon_attach.gif
   cms/trunk/modules/forums/images/icon_latest_reply.gif
   cms/trunk/modules/forums/images/icon_mini_faq.gif
   cms/trunk/modules/forums/images/icon_mini_groups.gif
   cms/trunk/modules/forums/images/icon_mini_login.gif
   cms/trunk/modules/forums/images/icon_mini_members.gif
   cms/trunk/modules/forums/images/icon_mini_message.gif
   cms/trunk/modules/forums/images/icon_mini_profile.gif
   cms/trunk/modules/forums/images/icon_mini_register.gif
   cms/trunk/modules/forums/images/icon_mini_search.gif
   cms/trunk/modules/forums/images/icon_minipost.gif
   cms/trunk/modules/forums/images/icon_minipost_new.gif
   cms/trunk/modules/forums/images/icon_newest_reply.gif
   cms/trunk/modules/forums/images/icon_reported.gif
   cms/trunk/modules/forums/images/icon_unapproved.gif
   cms/trunk/modules/forums/images/index_en.php
   cms/trunk/modules/forums/images/karma/
   cms/trunk/modules/forums/images/karma/karma-1.gif
   cms/trunk/modules/forums/images/karma/karma-2.gif
   cms/trunk/modules/forums/images/karma/karma-3.gif
   cms/trunk/modules/forums/images/karma/karma-4.gif
   cms/trunk/modules/forums/images/karma/karma-5.gif
   cms/trunk/modules/forums/images/karma/karma0.gif
   cms/trunk/modules/forums/images/karma/karma1.gif
   cms/trunk/modules/forums/images/karma/karma2.gif
   cms/trunk/modules/forums/images/karma/karma3.gif
   cms/trunk/modules/forums/images/karma/karma4.gif
   cms/trunk/modules/forums/images/karma/karma5.gif
   cms/trunk/modules/forums/images/no_avatar.gif
   cms/trunk/modules/forums/images/progress_bar.gif
   cms/trunk/modules/forums/images/spacer.gif
   cms/trunk/modules/forums/images/subfolder_big.gif
   cms/trunk/modules/forums/images/subfolder_new_big.gif
   cms/trunk/modules/forums/images/topic_delete.gif
   cms/trunk/modules/forums/images/topic_lock.gif
   cms/trunk/modules/forums/images/topic_move.gif
   cms/trunk/modules/forums/images/topic_split.gif
   cms/trunk/modules/forums/images/topic_unlock.gif
   cms/trunk/modules/forums/images/vote_lcap.gif
   cms/trunk/modules/forums/images/vote_rcap.gif
   cms/trunk/modules/forums/images/voting_bar.gif
   cms/trunk/modules/forums/images/whosonline.gif
Removed:
   cms/trunk/includes/nusoap/
   cms/trunk/themes/viperal/template/modules/Forums/
Modified:
   cms/trunk/admin/menu.php
   cms/trunk/admin/modules.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/session.php
   cms/trunk/includes/templates/admin/modules/index.html
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/control_panel/modules/ucp_zebra.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Modified: cms/trunk/admin/menu.php
===================================================================
--- cms/trunk/admin/menu.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/admin/menu.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -44,13 +44,13 @@
 $menu['modules'][] = '';
 $menu['modules'][] = array('lang' => $_CLASS['core_user']->get_lang('ARTICLES'), 'link' => generate_link('articles', array('admin' => true)));
 
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('FORUMS'), 'link' => generate_link('Forums', array('admin' => true)));
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMIN_INDEX'), 'link' => generate_link('Forums', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('FORUMS'), 'link' => generate_link('forums', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMIN_INDEX'), 'link' => generate_link('forums', array('admin' => true)));
 $menu['forums'][] = '';
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE_FORUMS'), 'link' => generate_link('Forums&amp;file=admin_forums', array('admin' => true)));
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('PERMISSIONS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=forum', array('admin' => true)));
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMINISTRATORS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=admin', array('admin' => true)));
-$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MODERATORS'), 'link' => generate_link('Forums&amp;file=admin_permissions&amp;mode=mod', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MANAGE_FORUMS'), 'link' => generate_link('forums&amp;file=admin_forums', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('PERMISSIONS'), 'link' => generate_link('forums&amp;file=admin_permissions&amp;mode=forum', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('ADMINISTRATORS'), 'link' => generate_link('forums&amp;file=admin_permissions&amp;mode=admin', array('admin' => true)));
+$menu['forums'][] = array('lang' => $_CLASS['core_user']->get_lang('MODERATORS'), 'link' => generate_link('forums&amp;file=admin_permissions&amp;mode=mod', array('admin' => true)));
 
 $menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SYSTEM'), 'link' => generate_link('system', array('admin' => true)));
 $menu['system'][] = array('lang' => $_CLASS['core_user']->get_lang('SITE_SETTINGS'), 'link' => generate_link('system&amp;mode=site', array('admin' => true)));

Modified: cms/trunk/admin/modules.php
===================================================================
--- cms/trunk/admin/modules.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/admin/modules.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -273,6 +273,9 @@
 	));
 }
 
+$_CLASS['core_template']->assign_array(array(
+	'B_SEARCH'	=> generate_link('modules&amp;mode=search', array('admin' => true)),
+));
 
 $_CLASS['core_display']->display(false, 'admin/modules/index.html');
 

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/mysql.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -225,10 +225,37 @@
 		return mysql_query($query, $this->link_identifier);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table )
+		{
+			return false;
+		}
+
+		$values = $this->sql_build_array($query_type, $array);
+
+		if (!$value)
+		{
+			return false;
+		}
+
+		SWitch  ($query_type)
+		{
+			case 'MULTI_INSERT':
+			case 'INSERT':
+				return $this->query('INSERT INTO ' . $table . ' '. $values');
+			break;
+
+			case 'UPDATE':
+				return $this->query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
@@ -237,58 +264,92 @@
 
 		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch  ($query_type)
 		{
-			foreach ($array as $key => $value)
-			{
-				$_fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key => $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "'" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "'" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key => $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key => $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = "'" . $this->escape($value) . "'";
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key => $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "$key = '" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = "$key = NULL";
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "$key = '" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = "$key = NULL";
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/mysqli.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -227,10 +227,41 @@
 		return mysqli_query($this->link_identifier, $query);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table )
+		{
+			return false;
+		}
+
+		$values = $this->sql_build_array($query_type, $array);
+
+		if (!$value)
+		{
+			return false;
+		}
+
+		SWitch  ($query_type)
+		{
+			case 'MULTI_INSERT':
+			case 'INSERT':
+				return $this->query('INSERT INTO ' . $table . ' '. $values');
+				/*foreach ($array as $array2)
+				{
+					return $this->query('INSERT INTO ' . $table . ' '. $values');
+				}*/
+			break;
+
+			case 'UPDATE':
+				return $this->query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
@@ -239,58 +270,92 @@
 
 		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch (strtoupper($query_type))
 		{
-			foreach ($array as $key => $value)
-			{
-				$_fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key => $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "'" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "'" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key => $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key => $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = "'" . $this->escape($value) . "'";
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key => $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "$key = '" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = "$key = NULL";
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "$key = '" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = "$key = NULL";
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query_type == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/db/postgres.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -237,70 +237,132 @@
 		return $this->query($query, $backtrace);
 	}
 
+	function sql_query_build($query_type, $array, $table)
+	{
+		if (!is_array($array) || !$table)
+		{
+			return false;
+		}
+
+		SWitch (strtoupper($query_type))
+		{
+			case 'MULTI_INSERT':
+				foreach ($array as $array2)
+				{
+					pg_insert($this->link_identifier, $table, $array2);
+				}
+			break;
+
+			case 'INSERT':
+				return pg_insert($this->link_identifier, $table, $array);
+				//return $this->query('INSERT INTO ' . $table . ' '. $values');
+			break;
+
+			case 'UPDATE':
+				return pg_update($this->link_identifier, $table, $array);
+				//return $this->query('UPDATE ' . $table . ' SET ' . $values);
+			break;
+		}
+	}
+
 	/*
-		Boy do I like this but it phpBB's, may have to do something similar
+		Boy do I like this but it phpBB's
 	*/
-	function sql_build_array($query, $array = false)
+	function sql_build_array($query_type, $array)
 	{
 		if (!is_array($array))
 		{
 			return false;
 		}
 
-		$fields = $values = array();
+		$_fields = $values = array();
 
-		if ($query == 'INSERT')
+		SWitch  ($query_type)
 		{
-			foreach ($array as $key => $value)
-			{
-				$fields[] = $key;
-
-				if (is_numeric($value))
+			case 'INSERT':
+				foreach ($array as $key => $value)
 				{
-					$values[] = $value;
+					$_fields[] = $key;
+	
+					if (is_numeric($value))
+					{
+						$values[] = $value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "'" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = 'NULL';
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = ($value) ? 1 : 0;
+					}
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "'" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = 'NULL';
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = ($value) ? 1 : 0;
-				}
-			}
+	
+				return ' (' . implode(', ', $_fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
 
-			return ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-		}
-		elseif ($query == 'UPDATE' || $query == 'SELECT')
-		{
-			$values = array();
-			foreach ($array as $key => $value)
-			{
-				if (is_numeric($value))
+			case 'MULTI_INSERT':
+				$ary = array();
+				foreach ($array as $array2)
+				{
+					$values = array();
+					foreach ($array2 as $key => $value)
+					{
+						if (is_numeric($value))
+						{
+							$values[] = $value;
+						}
+						elseif (is_string($value))
+						{
+							$values[] = "'" . $this->escape($value) . "'";
+						}
+						elseif (is_null($value))
+						{
+							$values[] = 'NULL';
+						}
+						elseif (is_bool($value))
+						{
+							$values[] = ($value) ? 1 : 0;
+						}
+					}
+					$ary[] = '(' . implode(', ', $values) . ')';
+				}
+	
+				return ' (' . implode(', ', array_keys($array[0])) . ') VALUES ' . implode(', ', $ary);
+			break;
+
+			case 'UPDATE':
+			case 'SELECT':
+				$values = array();
+				foreach ($array as $key => $value)
 				{
-					$values[] = $key.' = '.$value;
+					if (is_numeric($value))
+					{
+						$values[] = $key.' = '.$value;
+					}
+					elseif (is_string($value))
+					{
+						$values[] = "$key = '" . $this->escape($value) . "'";
+					}
+					elseif (is_null($value))
+					{
+						$values[] = "$key = NULL";
+					}
+					elseif (is_bool($value))
+					{
+						$values[] = $key.' = '.(($value) ? 1 : 0);
+					}
+	
 				}
-				elseif (is_string($value))
-				{
-					$values[] = "$key = '" . $this->escape($value) . "'";
-				}
-				elseif (is_null($value))
-				{
-					$values[] = "$key = NULL";
-				}
-				elseif (is_bool($value))
-				{
-					$values[] = $key.' = '.(($value) ? 1 : 0);
-				}
-
-			}
-
-			return implode(($query == 'UPDATE') ? ', ' : ' AND ', $values);
+	
+				return implode(($query_type == 'UPDATE') ? ', ' : ' AND ', $values);
+			break;
 		}
+		return false;
 	}
 
 	function num_rows($result = false)

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -1322,9 +1322,6 @@
 		'T_RANKS_PATH'			=> "{$config['ranks_path']}/",
 		'T_UPLOAD_PATH'			=> "{$config['upload_path']}/",
 
-// Temp
-		'T_IMAGE_PATH'			=> "themes/viperal/template/modules/Forums/images/",
-
 		'U_ACP'				=> ($_CLASS['core_user']->is_admin && $_CLASS['forums_auth']->acl_get('a_')) ? generate_link('Forums', array('admin' => true)) : '',
 		'L_ACP'				=> $_CLASS['core_user']->lang['ACP']
 	));

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -36,10 +36,9 @@
 {
 	global $config, $_CLASS, $_CORE_CONFIG;
 
-	// Get posted/get info
 	$mark_read = request_var('mark', '');
 
-	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $mark_forums = array();
+	$forum_id_ary = $active_forum_ary = $forum_rows = $subforums = $forum_moderators = $forum_ids_moderator = $mark_forums = array();
 	$visible_forums = 0;
 
 	if (!$root_data)
@@ -69,13 +68,12 @@
 
 	$sql = "SELECT f.* $lastread_select 
 		FROM ". FORUMS_FORUMS_TABLE . " f $sql_from
-		WHERE forum_status <> ".ITEM_DELETING."
+		WHERE forum_status <> " . ITEM_DELETING . "
 		$sql_where
 		ORDER BY f.left_id";
 	$result = $_CLASS['core_db']->query($sql);
 
 	$branch_root_id = $root_data['forum_id'];
-	$forum_ids		= array($root_data['forum_id']);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
@@ -89,6 +87,14 @@
 			continue;
 		}
 
+
+
+		if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
+		{
+			// Non-postable forum with no subforums: don't display
+			continue;
+		}
+
 		if (isset($right_id))
 		{
 			if ($row['left_id'] < $right_id)
@@ -98,12 +104,6 @@
 			unset($right_id);
 		}
 
-		if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
-		{
-			// Non-postable forum with no subforums: don't display
-			continue;
-		}
-
 		if (!$_CLASS['auth']->acl_get('f_list', $row['forum_id']))
 		{
 			// if the user does not have permissions to list this forum, skip everything until next branch
@@ -114,6 +114,16 @@
 		// Display active topics from this forum?
 		if ($show_active && $row['forum_type'] == FORUM_POST && $_CLASS['auth']->acl_get('f_read', $row['forum_id']) && ($row['forum_flags'] & 16))
 		{
+			if (!isset($active_forum_ary['forum_topics']))
+			{
+				$active_forum_ary['forum_topics'] = 0;
+			}
+
+			if (!isset($active_forum_ary['forum_posts']))
+			{
+				$active_forum_ary['forum_posts'] = 0;
+			}
+
 			$active_forum_ary['forum_id'][]		= $row['forum_id'];
 			$active_forum_ary['enable_icons'][] = $row['enable_icons'];
 			$active_forum_ary['forum_topics']	+= ($_CLASS['auth']->acl_get('m_approve', $row['forum_id'])) ? $row['forum_topics_real'] : $row['forum_topics'];
@@ -131,7 +141,7 @@
 			$parent_id = $row['forum_id'];
 			$forum_rows[$row['forum_id']] = $row;
 
-			if (!$row['parent_id'] && $row['forum_type'] == FORUM_CAT && $row['parent_id'] == $root_data['forum_id'])
+			if ($row['forum_type'] == FORUM_CAT && $row['parent_id'] == $root_data['forum_id'])
 			{
 				$branch_root_id = $row['forum_id'];
 			}
@@ -150,7 +160,7 @@
 				$forum_rows[$parent_id]['forum_posts'] += $row['forum_posts'];
 			}
 
-			if (isset($forum_rows[$parent_id]) && $row['forum_last_post_time'] > $forum_rows[$parent_id]['forum_last_post_time'])
+			if ($row['forum_last_post_time'] > $forum_rows[$parent_id]['forum_last_post_time'])
 			{
 				$forum_rows[$parent_id]['forum_last_post_id'] = $row['forum_last_post_id'];
 				$forum_rows[$parent_id]['forum_last_post_time'] = $row['forum_last_post_time'];
@@ -211,6 +221,8 @@
 				'FORUM_ID'			=>	$row['forum_id'],
 				'FORUM_NAME'		=>	$row['forum_name'],
 				'FORUM_DESC'		=>	$row['forum_desc'],
+				//'FORUM_FOLDER_IMG'		=> ($row['forum_image']) ? '<img src="' . $phpbb_root_path . $row['forum_image'] . '" alt="' . $user->lang['FORUM_CAT'] . '" />' : '',
+				//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $phpbb_root_path . $row['forum_image'] : '',
 				'U_VIEWFORUM'		=>	generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
 			);
 			
@@ -226,28 +238,22 @@
 		// Generate list of subforums if we need to
 		if (isset($subforums[$forum_id]))
 		{
+			$links = array();
+
 			foreach ($subforums[$forum_id] as $subforum_id => $subforum_row)
 			{
-				$links = array();
-
 				if ($subforum_row['display'] && $subforum_row['name'])
 				{
 					$links[] = '<a href="' .generate_link('forums&amp;file=viewforum&amp;f='.$subforum_id).'">' .  $subforum_row['name'] . '</a>';
 				}
-				else
-				{
-					unset($subforums[$forum_id][$subforum_id]);
-				}
-
-				if (!empty($links))
-				{
-					$subforums_list = implode(', ', $links);
-					$l_subforums = (count($subforums[$forum_id]) === 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
-				}
-
-				unset($links);
+				unset($subforums[$forum_id][$subforum_id]);
 			}
+		
+			$subforums_list = implode(', ', $links);
+			$l_subforums = (count($links) === 1) ? $_CLASS['core_user']->lang['SUBFORUM'] . ': ' : $_CLASS['core_user']->lang['SUBFORUMS'] . ': ';
 
+			unset($links);
+	
 			$folder_image = (!empty($forum_unread[$forum_id])) ? 'sub_forum_new' : 'sub_forum';
 		}
 		else
@@ -307,6 +313,8 @@
 		$_CLASS['core_template']->assign_vars_array('forumrow', array(
 			'S_IS_CAT'			=> false, 
 			'S_IS_LINK'			=> ($row['forum_type'] == FORUM_LINK), 
+			'S_UNREAD_FORUM'	=> !empty($forum_unread[$forum_id]),
+			'S_LOCKED_FORUM'	=> ($row['forum_status'] == ITEM_LOCKED) ? true : false,
 
 			'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
 
@@ -342,7 +350,12 @@
 		'L_SUBFORUM'		=> ($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
 	));
 
-	return $active_forum_ary;
+	if ($return_moderators)
+	{
+		return array($active_forum_ary, $forum_moderators);
+	}
+
+	return array($active_forum_ary, array());
 }
 
 function topic_status(&$topic_row, $replies, $mark_time, &$unread, &$folder_img, &$folder_alt, &$topic_type)

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -166,14 +166,7 @@
 		$upload->set_allowed_extensions(array_keys($extensions['_allowed_']));
 	}
 
-	if ($local)
-	{
-		$file = $upload->local_upload($local_storage);
-	}
-	else
-	{
-		$file = $upload->form_upload($form_name);
-	}
+	$file = ($local) ? $upload->local_upload($local_storage) : $upload->form_upload($form_name);
 
 	if ($file->init_error)
 	{
@@ -215,7 +208,7 @@
 	$filedata['extension'] = $file->get('extension');
 	$filedata['physical_filename'] = $file->get('realname');
 	$filedata['real_filename'] = $file->get('uploadname');
-	$filedata['filetime'] = time();
+	$filedata['filetime'] = $_CLASS['core_user']->time;
 
 	// Check our complete quota
 	if ($config['attachment_quota'])
@@ -343,7 +336,6 @@
 	global $config;
 
 	$min_filesize = (int) $config['img_min_thumb_filesize'];
-
 	$img_filesize = (file_exists($source)) ? @filesize($source) : false;
 
 	if (!$img_filesize || $img_filesize <= $min_filesize)
@@ -367,7 +359,7 @@
 
 	$used_imagick = false;
 
-	if (file_exists($destination))
+	if (file_exists($destination) && function_exists('passthru'))
 	{
 		passthru($config['img_imagick'] . 'convert' . ((defined('PHP_OS') && preg_match('#win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' "' . str_replace('\\', '/', $source) . '" +profile "*" "' . str_replace('\\', '/', $destination) . '"');
 		if (file_exists($new_file))
@@ -408,7 +400,13 @@
 				$new_image = imagecreatetruecolor($new_width, $new_height);
 				imagecopyresampled($new_image, $image, 0, 0, 0, 0, $new_width, $new_height, $width, $height);
 			}
-			
+
+			// If we are in safe mode create the destination file prior to using the gd functions to circumvent a PHP bug
+			if (@ini_get('safe_mode') || @strtolower(ini_get('safe_mode')) === 'on')
+			{
+				@touch($destination);		
+			}
+
 			switch ($type['format'])
 			{
 				case IMG_GIF:
@@ -743,6 +741,7 @@
 
 	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
+		$_CLASS['core_db']->free_result($result);
 		return false;
 	}
 
@@ -758,7 +757,7 @@
 	// Instantiate BBCode class
 	if (!isset($bbcode) && $bbcode_bitfield)
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
 
@@ -768,14 +767,24 @@
 		$poster = $row['username'];
 
 		// Handle anon users posting with usernames
-		if ($poster_id == ANONYMOUS && $row['post_username'])
+		if ($poster_id == ANONYMOUS)
 		{
-			$poster = $row['post_username'];
+			$poster = ($row['post_username']) ? $row['post_username'] :$_CLASS['core_user']->lang['GUEST'];
 			$poster_rank = $_CLASS['core_user']->lang['GUEST'];
 		}
 
 		$post_subject = $row['post_subject'];
 		$message = $row['post_text'];
+		$decoded_message = false;
+
+		if ($show_quote_button && $_CLASS['forums_auth']->acl_get('f_reply', $forum_id))
+		{
+			$decoded_message = $message;
+			decode_message($decoded_message, $row['bbcode_uid']);
+
+			$decoded_message = censor_text($decoded_message);
+			$decoded_message = str_replace("\n", "<br />", $decoded_message);
+		}
 
 		if ($row['bbcode_bitfield'])
 		{
@@ -793,6 +802,7 @@
 			'MINI_POST_IMG' => $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
 			'POST_DATE' 	=> $_CLASS['core_user']->format_date($row['post_time']),
 			'MESSAGE' 		=> str_replace("\n", '<br />', $message), 
+			'DECODED_MESSAGE'	=> $decoded_message,
 
 			'U_POST_ID'		=> $row['post_id'],
 			'U_MINI_POST'	=> generate_link('Forums&amp;file=viewtopic&amp;p=' . $row['post_id'] . '#' . $row['post_id']),
@@ -984,4 +994,924 @@
 	$_CLASS['core_db']->transaction('commit');
 }
 
+//
+// Post handling functions
+//
+
+/**
+* Delete Post
+*/
+function delete_post($forum_id, $topic_id, $post_id, &$data)
+{
+	global $_CLASS, $config;
+
+	// Specify our post mode
+	$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'delete_topic' : (($data['topic_first_post_id'] == $post_id) ? 'delete_first_post' : (($data['topic_last_post_id'] == $post_id) ? 'delete_last_post' : 'delete'));
+	$sql_data = array();
+	$next_post_id = 0;
+
+	require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+
+	$_CLASS['core_db']->transaction();
+
+	if (!delete_posts('post_id', array($post_id), false, false))
+	{
+		// Try to delete topic, we may had an previous error causing inconsistency
+		if ($post_mode == 'delete_topic')
+		{
+			delete_topics('topic_id', array($topic_id), false);
+		}
+		trigger_error('ALREADY_DELETED');
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	// Collect the necessary information for updating the tables
+	$sql_data[FORUMS_FORUMS_TABLE] = '';
+	switch ($post_mode)
+	{
+		case 'delete_topic':
+			delete_topics('topic_id', array($topic_id), false);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
+			}
+
+			$update_sql = update_post_information('forum', $forum_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', $update_sql[$forum_id]);
+			}
+		break;
+
+		case 'delete_first_post':
+			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
+				WHERE p.topic_id = $topic_id
+					AND p.poster_id = u.user_id
+				ORDER BY p.post_time ASC";
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
+			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+
+			$next_post_id = (int) $row['post_id'];
+		break;
+
+		case 'delete_last_post':
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$update_sql = update_post_information('forum', $forum_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
+				$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', $update_sql[$forum_id]);
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+
+			$update_sql = update_post_information('topic', $topic_id, true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update_sql[$topic_id]);
+				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update_sql[$topic_id][0]);
+			}
+			else
+			{
+				$sql = 'SELECT MAX(post_id) as last_post_id
+					FROM ' . FORUMS_POSTS_TABLE . "
+					WHERE topic_id = $topic_id " .
+						((!$_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '');
+				$result = $_CLASS['core_db']->query($sql);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
+
+				$next_post_id = (int) $row['last_post_id'];
+			}
+		break;
+
+		case 'delete':
+			$sql = 'SELECT post_id
+				FROM ' . FORUMS_POSTS_TABLE . "
+				WHERE topic_id = $topic_id " .
+					((!$_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '') . '
+					AND post_time > ' . $data['post_time'] . '
+				ORDER BY post_time ASC';
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($data['topic_type'] != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
+			}
+
+			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
+			$next_post_id = (int) $row['post_id'];
+		break;
+	}
+
+	//$sql_data[CORE_USERS_TABLE] = ($_CLASS['forums_auth']->acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';
+
+	$_CLASS['core_db']->transaction();
+
+	$where_sql = array(
+		FORUMS_FORUMS_TABLE	=> "forum_id = $forum_id",
+		FORUMS_TOPICS_TABLE	=> "topic_id = $topic_id",
+		CORE_USERS_TABLE	=> 'user_id = ' . $data['poster_id']
+	);
+
+	foreach ($sql_data as $table => $update_sql)
+	{
+		if ($update_sql)
+		{
+			$_CLASS['core_db']->query("UPDATE $table SET $update_sql WHERE " . $where_sql[$table]);
+		}
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	// Adjust posted info for this user by looking for a post by him/her within this topic...
+	/*
+	if ($post_mode != 'delete_topic' && $config['load_db_track'] && $_CLASS['core_user']->is_user)
+	{
+		$sql = 'SELECT poster_id
+			FROM ' . POSTS_TABLE . '
+			WHERE topic_id = ' . $topic_id . '
+				AND poster_id = ' . $_CLASS['core_user']->data['user_id'];
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$poster_id = (int) $db->sql_fetchfield('poster_id');
+		$_CLASS['core_db']->free_result($result);
+
+		// The user is not having any more posts within this topic
+		if (!$poster_id)
+		{
+			$sql = 'DELETE FROM ' . TOPICS_POSTED_TABLE . '
+				WHERE topic_id = ' . $topic_id . '
+					AND user_id = ' . $_CLASS['core_user']->data['user_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+	*/
+
+	if ($data['post_reported'] && ($post_mode != 'delete_topic'))
+	{
+		sync('topic_reported', 'topic_id', array($topic_id));
+	}
+
+	return $next_post_id;
+}
+
+/**
+* Submit Post
+*/
+function submit_post($mode, $subject, $username, $topic_type, &$poll, &$data, $update_message = true)
+{
+	global $config, $_CORE_CONFIG, $_CLASS;
+
+	// We do not handle erasing posts here
+	if ($mode == 'delete')
+	{
+		return false;
+	}
+
+	$current_time = $_CLASS['core_user']->time;
+
+	if ($mode == 'post')
+	{
+		$post_mode = 'post';
+		$update_message = true;
+	}
+	else if ($mode != 'edit')
+	{
+		$post_mode = 'reply';
+		$update_message = true;
+	}
+	else if ($mode == 'edit')
+	{
+		$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'edit_topic' : (($data['topic_first_post_id'] == $data['post_id']) ? 'edit_first_post' : (($data['topic_last_post_id'] == $data['post_id']) ? 'edit_last_post' : 'edit'));
+	}
+
+	// Collect some basic informations about which tables and which rows to update/insert
+	$sql_data = array();
+	$poster_id = ($mode == 'edit') ? $data['poster_id'] : (int) $_CLASS['core_user']->data['user_id'];
+
+	// Collect Informations
+	switch ($post_mode)
+	{
+		case 'post':
+		case 'reply':
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+				'forum_id'			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'poster_id'			=> (int) $_CLASS['core_user']->data['user_id'],
+				'icon_id'			=> $data['icon_id'],
+				'poster_ip'			=> $_CLASS['core_user']->ip,
+				'post_time'			=> $current_time,
+				'post_approved'		=> (!$_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) && !$_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'enable_html' 		=> $data['enable_html'],
+				'enable_bbcode'		=> $data['enable_bbcode'],
+				'enable_smilies'	=> $data['enable_smilies'],
+				'enable_magic_url'	=> $data['enable_urls'],
+				'enable_sig'		=> $data['enable_sig'],
+				'post_username'		=> (!$_CLASS['core_user']->is_user) ? $username : '',
+				'post_subject'		=> $subject,
+				'post_text'			=> $data['message'],
+				'post_checksum'		=> $data['message_md5'],
+				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
+				'bbcode_uid'		=> $data['bbcode_uid'],
+				'post_postcount'	=> ($_CLASS['forums_auth']->acl_get('f_postcount', $data['forum_id'])) ? 1 : 0,
+				'post_edit_locked'	=> $data['post_edit_locked']
+			);
+		break;
+
+		case 'edit_first_post':
+		case 'edit':
+
+			if (!$_CLASS['forums_auth']->acl_get('m_edit', $data['forum_id']) || $data['post_edit_reason'])
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+					'post_edit_time'	=> $current_time
+				);
+
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+			}
+
+		// no break
+
+		case 'edit_last_post':
+		case 'edit_topic':
+
+			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') && $data['post_edit_reason'])
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
+					'post_edit_time'	=> $current_time
+				);
+
+				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
+			}
+
+			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
+			}
+
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+				'forum_id'			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'poster_id'			=> $data['poster_id'],
+				'icon_id'			=> $data['icon_id'],
+				'post_approved'		=> (!$_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) && !$_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'enable_html' 		=> $data['enable_html'],
+				'enable_bbcode'		=> $data['enable_bbcode'],
+				'enable_smilies'	=> $data['enable_smilies'],
+				'enable_magic_url'	=> $data['enable_urls'],
+				'enable_sig'		=> $data['enable_sig'],
+				'post_username'		=> ($username && $data['poster_id'] == ANONYMOUS) ? $username : '',
+				'post_subject'		=> $subject,
+				'post_edit_reason'	=> $data['post_edit_reason'],
+				'post_edit_user'	=> (int) $data['post_edit_user'],
+				'post_checksum'		=> $data['message_md5'],
+				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
+				'bbcode_uid'		=> $data['bbcode_uid'],
+				'post_edit_locked'	=> $data['post_edit_locked'])
+			);
+
+			if ($update_message)
+			{
+				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
+			}
+
+		break;
+	}
+
+	// And the topic ladies and gentlemen
+	switch ($post_mode)
+	{
+		case 'post':
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'topic_poster'				=> (int) $_CLASS['core_user']->data['user_id'],
+				'topic_time'				=> $current_time,
+				'forum_id'					=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'icon_id'					=> $data['icon_id'],
+				'topic_approved'			=> (!$_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) && !$_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'topic_title'				=> $subject,
+				'topic_first_poster_name'	=> (!$_CLASS['core_user']->is_user && $username) ? $username : (($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']->data['username'] : ''),
+				'topic_type'				=> $topic_type,
+				'topic_time_limit'			=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'topic_attachment'			=> (isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0,
+				'topic_status'				=> 0,
+				'topic_replies_real'		=> 0,
+				'topic_replies'				=> 0,
+				'topic_views'				=> 0,
+				'topic_moved_id'			=> 0
+			);
+
+			if (isset($poll['poll_options']) && !empty($poll['poll_options']))
+			{
+				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[FORUMS_TOPICS_TABLE]['sql'], array(
+					'poll_title'		=> $poll['poll_title'],
+					'poll_start'		=> ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
+					'poll_max_options'	=> $poll['poll_max_options'],
+					'poll_length'		=> ($poll['poll_length'] * 86400),
+					'poll_vote_change'	=> $poll['poll_vote_change'])
+				);
+			}
+
+			$sql_data[CORE_USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['forums_auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
+	
+			if ($topic_type != POST_GLOBAL)
+			{
+				if ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id']))
+				{
+					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+				}
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? ', forum_topics = forum_topics + 1' : '');
+			}
+		break;
+
+		case 'reply':
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . (($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? ', topic_replies = topic_replies + 1' : '');
+			$sql_data[CORE_USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['forums_auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
+
+			if (($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) && $topic_type != POST_GLOBAL)
+			{
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
+			}
+		break;
+
+		case 'edit_topic':
+		case 'edit_first_post':
+
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'forum_id'					=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
+				'icon_id'					=> $data['icon_id'],
+				'topic_approved'			=> (!$_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) && !$_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? 0 : 1,
+				'topic_title'				=> $subject,
+				'topic_first_poster_name'	=> $username,
+				'topic_type'				=> $topic_type,
+				'topic_time_limit'			=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
+				'poll_title'				=> (isset($poll['poll_options'])) ? $poll['poll_title'] : '',
+				'poll_start'				=> (isset($poll['poll_options'])) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
+				'poll_max_options'			=> (isset($poll['poll_options'])) ? $poll['poll_max_options'] : 1,
+				'poll_length'				=> (isset($poll['poll_options'])) ? ($poll['poll_length'] * 86400) : 0,
+				'poll_vote_change'			=> (isset($poll['poll_vote_change'])) ? $poll['poll_vote_change'] : 0,
+
+				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && sizeof($data['filename_data'])) ? 1 : 0) : (isset($data['topic_attachment']) ? $data['topic_attachment'] : 0)
+			);
+		break;
+	}
+
+	$_CLASS['core_db']->transaction();
+
+	// Submit new topic
+	if ($post_mode == 'post')
+	{
+		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
+			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
+		$_CLASS['core_db']->query($sql);
+
+		$data['topic_id'] = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
+
+		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+			'topic_id' => $data['topic_id'])
+		);
+		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
+	}
+
+	// Submit new post
+	if ($post_mode == 'post' || $post_mode == 'reply')
+	{
+		if ($post_mode == 'reply')
+		{
+			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
+				'topic_id' => $data['topic_id'])
+			);
+		}
+
+		$query = '';
+
+		switch ($_CLASS['core_db']->db_layer)
+		{
+			case 'mssql':
+			case 'mssql_odbc':
+				$fields = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
+				{
+					$fields[] = $key;
+
+					if (is_null($var))
+					{
+						$values[] = 'NULL';
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = "'" . $_CLASS['core_db']->escape($var) . "'";
+						}
+						else
+						{
+							$values[] = "CAST('" . $var . "' AS varbinary)";
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? intval($var) : $var;
+					}
+				}
+				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
+
+			case 'sqlite':
+				$fields = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
+				{
+					$fields[] = $key;
+
+					if (is_null($var))
+					{
+						$values[] = 'NULL';
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = "'" . $_CLASS['core_db']->escape($var) . "'";
+						}
+						else
+						{
+							$values[] = "'" . sqlite_udf_encode_binary($var) . "'";
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? intval($var) : $var;
+					}
+				}
+				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
+			break;
+
+			default:
+				$query = $_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
+			break;
+		}
+
+
+		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$query;
+		$_CLASS['core_db']->query($sql);
+		$data['post_id'] = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
+
+		if ($post_mode == 'post')
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
+				'topic_first_post_id'	=> $data['post_id'],
+				'topic_last_post_id'	=> $data['post_id'],
+				'topic_last_post_time'	=> $current_time,
+				'topic_last_poster_id'	=> (int) $_CLASS['core_user']->data['user_id'],
+				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : (($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']->data['username'] : '')
+			);
+		}
+
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
+	}
+
+	$make_global = false;
+
+	// Are we globalising or unglobalising?
+	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
+	{
+		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
+			FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_id = ' . $data['topic_id'];
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		// globalise
+		if ($row['topic_type'] != POST_GLOBAL && $topic_type == POST_GLOBAL)
+		{
+			// Decrement topic/post count
+			$make_global = true;
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
+
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
+
+			// Update forum_ids for all posts
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET forum_id = 0
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+		// unglobalise
+		else if ($row['topic_type'] == POST_GLOBAL && $topic_type != POST_GLOBAL)
+		{
+			// Increment topic/post count
+			$make_global = true;
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
+
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
+
+			// Update forum_ids for all posts
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET forum_id = ' . $data['forum_id'] . '
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+
+	// Update the topics table
+	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
+	{
+		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
+			WHERE topic_id = ' . $data['topic_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Update the posts table
+	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
+	{
+		switch ($_CLASS['core_db']->db_layer)
+		{
+			case 'mssql':
+			case 'mssql_odbc':
+				$values = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
+				{
+					if (is_null($var))
+					{
+						$values[] = "$key = NULL";
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = "$key = '" . $_CLASS['core_db']->escape($var) . "'";
+						}
+						else
+						{
+							$values[] = "$key = CAST('" . $var . "' AS varbinary)";
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
+					}
+				}
+				$query = implode(', ', $values);
+			break;
+
+			case 'sqlite':
+				$values = array();
+				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
+				{
+					if (is_null($var))
+					{
+						$values[] = "$key = NULL";
+					}
+					else if (is_string($var))
+					{
+						if ($key !== 'bbcode_bitfield')
+						{
+							$values[] = "$key = '" . $_CLASS['core_db']->escape($var) . "'";
+						}
+						else
+						{
+							$values[] = "$key ='" . sqlite_udf_encode_binary($var) . "'";
+						}
+					}
+					else
+					{
+						$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
+					}
+				}
+				$query = implode(', ', $values);
+			break;
+
+			default:
+				$query = $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']);
+			break;
+		}
+
+		$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+			SET ' . $query . '
+			WHERE post_id = ' . $data['post_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Update Poll Tables
+	if (isset($poll['poll_options']) && !empty($poll['poll_options']))
+	{
+		$cur_poll_options = array();
+
+		if ($poll['poll_start'] && $mode == 'edit')
+		{
+			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
+				WHERE topic_id = ' . $data['topic_id'] . '
+				ORDER BY poll_option_id';
+			$result = $_CLASS['core_db']->query($sql);
+
+			$cur_poll_options = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$cur_poll_options[] = $row;
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		$sql_insert_ary = array();
+		for ($i = 0, $size = sizeof($poll['poll_options']); $i < $size; $i++)
+		{
+			if (trim($poll['poll_options'][$i]))
+			{
+				if (empty($cur_poll_options[$i]))
+				{
+					$sql_insert_ary[] = array(
+						'poll_option_id'	=> (int) $i,
+						'topic_id'			=> (int) $data['topic_id'],
+						'poll_option_text'	=> (string) $poll['poll_options'][$i]
+					);
+				}
+				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
+				{
+					$sql = "UPDATE " . FORUMS_POLL_OPTIONS_TABLE . "
+						SET poll_option_text = '" . $_CLASS['core_db']->escape($poll['poll_options'][$i]) . "'
+						WHERE poll_option_id = " . $cur_poll_options[$i]['poll_option_id'] . "
+							AND topic_id = " . $data['topic_id'];
+					$_CLASS['core_db']->query($sql);
+				}
+			}
+		}
+
+		if (sizeof($sql_insert_ary))
+		{
+			switch ($_CLASS['core_db']->db_layer)
+			{
+				case 'mysql':
+				case 'mysql4':
+				case 'mysqli':
+					$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('MULTI_INSERT', $sql_insert_ary));
+				break;
+
+				default:
+					foreach ($sql_insert_ary as $ary)
+					{
+						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $ary));
+					}
+				break;
+			}
+		}
+
+		if (count($poll['poll_options']) < count($cur_poll_options))
+		{
+			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
+				WHERE poll_option_id >= ' . count($poll['poll_options']) . '
+					AND topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+
+	// Submit Attachments
+	if (sizeof($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
+	{
+		$space_taken = $files_added = 0;
+
+		foreach ($data['attachment_data'] as $pos => $attach_row)
+		{
+			if ($attach_row['attach_id'])
+			{
+				// update entry in db if attachment already stored in db and filespace
+				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
+					SET attach_comment = '" . $_CLASS['core_db']->escape($attach_row['attach_comment']) . "'
+					WHERE attach_id = " . (int) $attach_row['attach_id'];
+				$_CLASS['core_db']->query($sql);
+			}
+			else
+			{
+				// insert attachment into db
+				if (!@file_exists($config['upload_path'] . '/' . basename($attach_row['physical_filename'])))
+				{
+					continue;
+				}
+
+				$attach_sql = array(
+					'post_msg_id'		=> $data['post_id'],
+					'topic_id'			=> $data['topic_id'],
+					'in_message'		=> 0,
+					'poster_id'			=> $poster_id,
+					'physical_filename'	=> basename($attach_row['physical_filename']),
+					'real_filename'		=> basename($attach_row['real_filename']),
+					'download_count'	=> 0,
+					'attach_comment'	=> $attach_row['attach_comment'],
+					'extension'			=> $attach_row['extension'],
+					'mimetype'			=> $attach_row['mimetype'],
+					'filesize'			=> $attach_row['filesize'],
+					'filetime'			=> $attach_row['filetime'],
+					'thumbnail'			=> $attach_row['thumbnail']
+				);
+
+				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
+					$_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
+				$_CLASS['core_db']->query($sql);
+
+				$space_taken += $attach_row['filesize'];
+				$files_added++;
+			}
+		}
+
+		if (sizeof($data['attachment_data']))
+		{
+			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
+				SET post_attachment = 1
+				WHERE post_id = ' . $data['post_id'];
+			$_CLASS['core_db']->query($sql);
+
+			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+				SET topic_attachment = 1
+				WHERE topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+
+		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
+		set_config('num_files', $config['num_files'] + $files_added, true);
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
+	{
+		if ($topic_type != POST_GLOBAL)
+		{
+			$update_sql = update_post_information('forum', $data['forum_id'], true);
+			if (sizeof($update_sql))
+			{
+				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', $update_sql[$data['forum_id']]);
+			}
+		}
+
+		$update_sql = update_post_information('topic', $data['topic_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update_sql[$data['topic_id']]);
+		}
+	}
+
+	if ($make_global)
+	{
+		$update_sql = update_post_information('forum', $data['forum_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', $update_sql[$data['forum_id']]);
+		}
+	}
+
+	if ($post_mode == 'edit_topic')
+	{
+		$update_sql = update_post_information('topic', $data['topic_id'], true);
+		if (sizeof($update_sql))
+		{
+			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update_sql[$data['topic_id']]);
+		}
+	}
+
+	// Update total post count, do not consider moderated posts/topics
+	if ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id']))
+	{
+		if ($post_mode == 'post')
+		{
+			set_config('num_topics', $config['num_topics'] + 1, true);
+			set_config('num_posts', $config['num_posts'] + 1, true);
+		}
+
+		if ($post_mode == 'reply')
+		{
+			set_config('num_posts', $config['num_posts'] + 1, true);
+		}
+	}
+
+	// Update forum stats
+	$_CLASS['core_db']->transaction();
+
+	$where_sql = array(FORUMS_POSTS_TABLE => 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE => 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE => 'forum_id = ' . $data['forum_id'], CORE_USERS_TABLE => 'user_id = ' . $_CLASS['core_user']->data['user_id']);
+
+	foreach ($sql_data as $table => $update_ary)
+	{
+		if (isset($update_ary['stat']) && implode('', $update_ary['stat']))
+		{
+			$_CLASS['core_db']->query("UPDATE $table SET " . implode(', ', $update_ary['stat']) . ' WHERE ' . $where_sql[$table]);
+		}
+	}
+
+	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
+	if ($make_global)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_moved_id = ' . $data['topic_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Index message contents
+	if (false && $update_message && $data['enable_indexing'])
+	{
+		// Select the search method and do some additional checks to ensure it can actually be utilised
+		$search_type = basename($config['search_type']);
+
+		if (!file_exists($phpbb_root_path . 'includes/search/' . $search_type . '.' . $phpEx))
+		{
+			trigger_error('NO_SUCH_SEARCH_MODULE');
+		}
+
+		require("{$phpbb_root_path}includes/search/$search_type.$phpEx");
+
+		$error = false;
+		$search = new $search_type($error);
+
+		if ($error)
+		{
+			trigger_error($error);
+		}
+
+		$search->index($mode, $data['post_id'], $data['message'], $subject, $_CLASS['core_user']->lang['ENCODING'], $poster_id, ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id']);
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	// Delete draft if post was loaded...
+	$draft_id = request_var('draft_loaded', 0);
+	if ($draft_id)
+	{
+		$sql = 'DELETE FROM ' . FORUMS_DRAFTS_TABLE . "
+			WHERE draft_id = $draft_id
+				AND user_id = {$_CLASS['core_user']->data['user_id']}";
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Topic Notification, do not change if moderator is changing other users posts...
+	if ($_CLASS['core_user']->data['user_id'] == $poster_id)
+	{
+		if (!$data['notify_set'] && $data['notify'])
+		{
+			$notify_sql = array(
+				'user_id'		=> $_CLASS['core_user']->data['user_id'],
+				'forum_id'		=> $data['forum_id'],
+				'topic_id'		=> $data['topic_id'],
+				'notify_type'	=> $poster_id,
+				'notify_status'	=> 0,
+			);
+				
+			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $notify_sql));
+			unset($notify_sql);
+		}
+		else if ($data['notify_set'] && !$data['notify'])
+		{
+			$sql = 'DELETE FROM ' . FORUMS_TOPICS_WATCH_TABLE . '
+				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
+					AND topic_id = ' . $data['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+
+	if ($mode == 'post' || $mode == 'reply' || $mode == 'quote')
+	{
+		// Mark this topic as posted to
+		markread('post', $data['forum_id'], $data['topic_id'], $data['post_time']);
+	}
+
+	// Mark this topic as read
+	// We do not use post_time here, this is intended (post_time can have a date in the past if editing a message)
+	markread('topic', $data['forum_id'], $data['topic_id'], $_CLASS['core_user']->time);
+
+	// Send Notifications
+	if ($mode != 'edit' && $mode != 'delete' && ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])))
+	{
+		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
+	}
+
+	if ($mode == 'post')
+	{
+		$url = ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? generate_link('forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
+	}
+	else
+	{
+		$url = ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ?  generate_link("forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&amp;p={$data['post_id']}") . "#p{$data['post_id']}" : generate_link("forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}");
+	}
+
+	return $url;
+}
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/functions_user.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -176,20 +176,19 @@
 // add a required array here, then find feilds that are not in the data array
 	$_CLASS['core_db']->transaction();
 
-	$sql = 'INSERT INTO ' . CORE_USERS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $data);
-	$_CLASS['core_db']->query($sql);
+	$_CLASS['core_db']->sql_query_build('INSERT', $data, CORE_USERS_TABLE);
 
 	$data['user_id'] = $_CLASS['core_db']->insert_id(CORE_USERS_TABLE, 'user_id');
 
 	if ($group_add)
 	{
-		$sql = 'INSERT INTO ' . CORE_USER_GROUP_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+		$data2 = array(
 			'group_id'		=> (int) $data['user_group'],
 			'user_id'		=> (int) $data['user_id'],
 			'member_status'	=> $data['user_status']
-		));
-		
-		$_CLASS['core_db']->query($sql);
+		);
+
+		$_CLASS['core_db']->sql_query_build('INSERT', $data2, CORE_USER_GROUP_TABLE);
 	}
 
 	$_CLASS['core_db']->transaction('commit');
@@ -506,20 +505,26 @@
 
 	$_CLASS['core_db']->transaction();
 
+	$data = array();
 	foreach ($user_id as $u_id)
 	{
 		foreach ($group_id as $g_id)
 		{
-			$data = array(
+			$data[] = array(
 				'group_id'		=> (int) $g_id,
 				'user_id'		=> (int) $u_id,
 				'member_status'	=> (int) $status,
 			);
 		
-			$_CLASS['core_db']->query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']->sql_build_array('INSERT', $data));
+			//$_CLASS['core_db']->query('INSERT INTO '.USER_GROUP_TABLE.' '.$_CLASS['core_db']->sql_build_array('INSERT', $data));
 		}
 	}
 
+	if (!empty($data)) 
+	{
+		$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $data, USER_GROUP_TABLE);
+	}
+
 	$_CLASS['core_db']->transaction('commit');
 }
 

Modified: cms/trunk/includes/session.php
===================================================================
--- cms/trunk/includes/session.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/session.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -213,7 +213,7 @@
 			'session_autologin'	=> (string) $this->autologin_code,
 		);
 
-		$_CLASS['core_db']->query('INSERT INTO ' . CORE_SESSIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $session_data));
+		$_CLASS['core_db']->sql_query_build('INSERT', $session_data, CORE_SESSIONS_TABLE);
 
 		$this->new_session =  true;
 
@@ -258,7 +258,7 @@
 			'auto_login_time'		=> (int) $this->time,
 		);
 
-		$_CLASS['core_db']->query('INSERT INTO ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' '.	$_CLASS['core_db']->sql_build_array('INSERT', $data_array));
+		$_CLASS['core_db']->sql_query_build('INSERT', $data_array, CORE_SESSIONS_AUTOLOGIN_TABLE);
 
 		$this->set_cookie('ali', $this->data['user_id'], $this->time + 2592000);
 		$this->set_cookie('alc', $this->autologin_code, $this->time + 2592000);

Modified: cms/trunk/includes/templates/admin/modules/index.html
===================================================================
--- cms/trunk/includes/templates/admin/modules/index.html	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/templates/admin/modules/index.html	2006-08-04 13:47:39 UTC (rev 179)
@@ -1,7 +1,16 @@
 <!-- DISPLAY_HEADER -->
 
 { $THEME_TABLE_OPEN }
-
+<table border="0" class="tablebg" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $B_SEARCH }'; return false;"><a href="{ $B_SEARCH }">{ $L_SEARCH_FOR_MODULE }</a></td>
+			<td align="center" class="row1">&nbsp;</td>
+			<td align="center" class="row1">&nbsp;</td>
+		</tr>
+	</tbody>
+</table>
+<div style="padding: 3px"></div>
 <table class="tablebg" cellpadding="4" cellspacing="1" width="100%">
     <tbody>
 		<tr>

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/includes/user.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -285,7 +285,7 @@
 
 	function add_img($img_file = false, $module = false, $lang = false)
 	{
-		$img_file = ($img_file) ? "$img_file.php" : 'index.php';
+		//$img_file = ($img_file) ? "$img_file.php" : 'index.php';
 
 		if (!$img_file || !ereg('/', $img_file))
 		{
@@ -294,19 +294,39 @@
 			$module = ($module) ? $module : $_CLASS['core_display']->page['page_name'];
 			$lang = ($lang) ? $lang : $this->lang_name;
 
+			$img_file = ($img_file) ? $img_file.'_'.$lang.'.php' : 'index_'.$lang.'.php';
+			$img_file2 = ($img_file) ? "$img_file.php" : 'index.php';
+
 			if (file_exists($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file"))
 			{
-				include $_CLASS['core_display']->theme_path."/images/modules/$module/$img_file";
+				require_once $_CLASS['core_display']->theme_path."/images/modules/$module/$img_file";
 			}
+			elseif (file_exists(SITE_FILE_ROOT.'modules/'.$module."/images/$img_file"))
+			{
+				require_once SITE_FILE_ROOT.'modules/'.$module."/images/$img_file";
+			}
+			elseif (file_exists($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file2"))
+			{
+				require_once $_CLASS['core_display']->theme_path."/images/modules/$module/$img_file2";
+			}
+			elseif (file_exists(SITE_FILE_ROOT.'modules/'.$module."/images/$img_file2"))
+			{
+				require_once SITE_FILE_ROOT.'modules/'.$module."/images/$img_file2";
+			}
 			else
 			{
-				include SITE_FILE_ROOT.'modules/'.$module."/images/$img_file";
+				return false;
 			}
 		}
+		elseif (file_exists($img_file.'.php'))
+		{
+			require_once $img_file.'.php';
+		}
 		else
 		{
-			include $img_file.'.php';
+			return false;
 		}
+		return true;
 	}
 	
 	function get_lang($lang)
@@ -331,8 +351,7 @@
 		if (!is_array($this->img[$img]))
 		{
 			list($src, $height, $width) = explode('*', $this->img[$img]);
-			$src = '"' . str_replace('{LANG}', $this->lang_name, $src) . '"'; // remove once everything is updated
-
+			//$src = '"' . str_replace('{LANG}', $this->lang_name, $src) . '"'; // remove once everything is updated
 			$this->img[$img] = array('src' => $src, 'width' => $width, 'height' => $height);
 		}
 
@@ -359,7 +378,7 @@
 		{
 			if (mb_strpos($lang_file, '/') !== false)
 			{
-				include SITE_FILE_ROOT."language/$this->lang_name/$lang_file";
+				include SITE_FILE_ROOT."language/{$this->lang_name}/$lang_file";
 
 				return;
 			}
@@ -450,17 +469,6 @@
 
 		return '<img src=' . $img['src'] .$width . $height .' alt="' . $alt . '" title="' . $alt . '" />';
 	}
-/*
-	function optionget($key, $data = false)
-	{
-		return $this->user_data_get($key);
-	}
-
-	function optionset($key, $value, $data = false)
-	{
-		return $this->user_data_set($key, $value);
-	}
-*/
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/install/build_data.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -30,7 +30,7 @@
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_smilies', 'images/smilies', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
-$content = $_CLASS['core_db']->escape('<a href="feed.php?feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
+$content = $_CLASS['core_db']->escape('<a href="feed.php?mod=articles&feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?mod=articles&feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?mod=articles&feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '$content', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)");
 $_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)");

Modified: cms/trunk/modules/control_panel/modules/ucp_zebra.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_zebra.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/control_panel/modules/ucp_zebra.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -26,13 +26,13 @@
 {
 	if ($add_users = get_variable('add', 'REQUEST', false))
 	{
+		$add_users = array_map('trim', array_map('strtolower', explode("\n", $add_users)));
+
 		require_once SITE_FILE_ROOT.'includes/forums/functions.php';
 		load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 		
 		$_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
 
-		$add_users = explode("\n", $add_users);
-
 		$sql = 'SELECT z.*, u.username 
 			FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
 			WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
@@ -44,23 +44,50 @@
 		{
 			if ($row['friend'])
 			{
-				$friends[] = $row['username'];
+				$friends[] = strtolower($row['username']);
 			}
 			else
 			{
-				$foes[] = $row['username'];
+				$foes[] = strtolower($row['username']);
 			}
 		}
 		$_CLASS['core_db']->free_result($result);
 
-		$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']->data['username']));
-		unset($friends, $foes);
+		// remove friends from the username array
+		$n = count($add_users);
+		$add_users = array_diff($add_users, $friends);
+
+		if (count($add_users) < $n && $mode === 'foes')
+		{
+			$error[] = $_CLASS['core_user']->get_lang('NOT_ADDED_FOES_FRIENDS');
+		}
+
+		// remove foes from the username array
+		$n = count($add_users);
+		$add_users = array_diff($add_users, $foes);
+
+		if (count($add_users) < $n && $mode === 'friends')
+		{
+			$error[] = $_CLASS['core_user']->get_lang('NOT_ADDED_FRIENDS_FOES');
+		}
+
+		// remove the user himself from the username array
+		$n = sizeof($add_users);
+		$add_users = array_diff($add_users, array(strtolower($_CLASS['core_user']->data['username'])));
+
+		if (sizeof($add_users) < $n)
+		{
+			$error[] = $_CLASS['core_user']->get_lang('NOT_ADDED_' . $l_mode . '_SELF');
+		}
+	
+		//$add_users = array_diff($add_users, $friends, $foes, array($_CLASS['core_user']->data['username']));
+		unset($friends, $foes, $n);
 
 		if (!empty($add_users))
 		{
 			$sql = 'SELECT user_id, user_type, user_status
 				FROM ' . CORE_USERS_TABLE . " 
-				WHERE username IN ('" .implode("', '", $_CLASS['core_db']->escape_array($add_users))."')";
+				WHERE LOWER(username) IN ('" .implode("', '", $_CLASS['core_db']->escape_array($add_users))."')";
 			$result = $_CLASS['core_db']->query($sql);
 
 			$add_users = array();
@@ -88,7 +115,13 @@
 						}
 					}
 
-					// This may not be right ... it may yield true when perms equate to deny
+					$perms = array_unique($perms);
+
+					if (!empty($perms))
+					{
+						$error[] = $_CLASS['core_user']->get_lang('NOT_ADDED_FOES_MOD_ADMIN');
+					}
+
 					$add_users = array_diff($add_users, $perms);
 					unset($perms);
 				}
@@ -96,10 +129,18 @@
 				if (!empty($add_users))
 				{
 					$sql_mode = ($this->mode === 'friends') ? 'friend' : 'foe';
+					
+					$sql_array = array();
+					foreach ($add_users as $zebra_id)
+					{
+						$sql_array[] = array(
+							'user_id'		=> (int) $_CLASS['core_user']->data['user_id'],
+							'zebra_id'		=> (int) $zebra_id,
+							$sql_mode		=> 1
+						);
+					}
 
-					$sql = 'INSERT INTO ' . ZEBRA_TABLE . " (user_id, zebra_id, $sql_mode) 
-						VALUES " . implode(', ', preg_replace('#^([0-9]+)$#', '(' . $_CLASS['core_user']->data['user_id'] . ", \\1, 1)",  $user_id_ary));
-					$_CLASS['core_db']->query($sql);
+					$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_array, ZEBRA_TABLE);
 				}
 				else
 				{
@@ -109,7 +150,7 @@
 			}
 			else
 			{
-				$error[] = 'USER_NOT_FOUND';
+				$error[] = 'USER_NOT_FOUND_OR_INACTIVE';
 			}
 			
 			$_CLASS['core_db']->free_result($result);
@@ -131,13 +172,13 @@
 	}
 	else
 	{
-		$_CLASS['core_template']->assign('ERROR', implode('<br />', preg_replace('#^([A-Z_]+)$#e', "(!empty(\$_CLASS['core_user']->lang['\\1'])) ? \$_CLASS['core_user']->lang['\\1'] : '\\1'", $error)));
+		$_CLASS['core_template']->assign('ERROR', implode('<br />', $error));
 	}
 }
 
 $sql_and = ($this->mode === 'friends') ? 'z.friend = 1' : 'z.foe = 1';
 
-$sql = 'SELECT z.*, u.username 
+$sql = 'SELECT u.user_id, u.username 
 	FROM ' . ZEBRA_TABLE . ' z, ' . CORE_USERS_TABLE . ' u 
 	WHERE z.user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 		AND $sql_and 
@@ -147,7 +188,7 @@
 $username_options = '';
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
-	$username_options .= '<option value="' . $row['zebra_id'] . '">' . $row['username'] . '</option>';
+	$username_options .= '<option value="' . $row['user_id'] . '">' . $row['username'] . '</option>';
 }
 $_CLASS['core_db']->free_result($result);
 

Added: cms/trunk/modules/forums/images/background.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/background.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic2.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic2.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/created_by.jpg
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/created_by.jpg
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_aim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_aim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_approve.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_approve.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_email.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_email.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_icq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_icq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_info.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_info.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_ip.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_ip.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_jabber.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_jabber.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_msnm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_msnm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_offline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_offline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_online.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_online.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_post.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_post.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_post_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_post_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_quote.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_quote.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_reply_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_reply_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_report.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_report.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_www.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_www.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/btn_yim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/btn_yim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_announce_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_announce_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_link_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_link_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_lock_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_lock_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_locked_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_locked_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_moved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_moved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_hot_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_hot_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_new_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/folder_sticky_posted.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/folder_sticky_posted.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_attach.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_attach.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_latest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_latest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_faq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_faq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_groups.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_groups.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_login.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_login.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_members.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_members.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_message.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_message.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_register.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_register.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_mini_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_mini_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_minipost.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_minipost.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_minipost_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_minipost_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_newest_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_newest_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_reported.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_reported.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_unapproved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_unapproved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/index_en.php
===================================================================
--- cms/trunk/modules/forums/images/index_en.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/images/index_en.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -0,0 +1,92 @@
+<?php
+
+global $_CLASS;
+
+$_CLASS['core_template']->assign('T_IMAGE_PATH',  'modules/forums/images/');
+
+$this->img = array(
+	'bbcode_bitfield' => '6913',
+    'btn_post' => 'modules/forums/images/en/btn_post.gif*27*97',
+    'btn_post_pm' => 'modules/forums/images/en/btn_post_pm.gif*27*97',
+    'btn_reply' => 'modules/forums/images/en/btn_reply.gif*27*97',
+    'btn_reply_pm' => 'modules/forums/images/en/btn_reply_pm.gif*20*90',
+    'btn_locked' => 'modules/forums/images/en/btn_locked.gif*27*97',
+    'btn_profile' => 'modules/forums/images/en/btn_profile.gif*20*72',
+    'btn_pm' => 'modules/forums/images/en/btn_pm.gif*20*72',
+    'btn_delete' => 'modules/forums/images/en/btn_delete.gif*20*20',
+    'btn_info' => 'modules/forums/images/en/btn_info.gif*20*20',
+    'btn_quote' => 'modules/forums/images/en/btn_quote.gif*20*90',
+    'btn_search' => 'modules/forums/images/en/btn_search.gif*20*72',
+    'btn_edit' => 'modules/forums/images/en/btn_edit.gif*20*90',
+    'btn_report' => 'modules/forums/images/en/btn_report.gif*20*20',
+    'btn_email' => 'modules/forums/images/en/btn_email.gif*20*72',
+    'btn_www' => 'modules/forums/images/en/btn_www.gif*20*72',
+    'btn_icq' => 'modules/forums/images/en/btn_icq.gif*20*72',
+    'btn_aim' => 'modules/forums/images/en/btn_aim.gif*20*72',
+    'btn_yim' => 'modules/forums/images/en/btn_yim.gif*20*72',
+    'btn_msnm' => 'modules/forums/images/en/btn_msnm.gif*20*72',
+    'btn_jabber' => 'modules/forums/images/en/btn_jabber.gif*20*72',
+    'btn_online' => 'modules/forums/images/en/btn_online.gif*20*72',
+    'btn_offline' => 'modules/forums/images/en/btn_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+    'icon_unapproved' => 'modules/forums/images/icon_unapproved.gif*18*19',
+    'icon_reported' => 'modules/forums/images/icon_reported.gif*18*19',
+    'icon_attach' => 'modules/forums/images/icon_attach.gif*18*14',
+    'icon_post' => 'modules/forums/images/icon_minipost.gif*9*12',
+    'icon_post_new' => 'modules/forums/images/icon_minipost_new.gif*9*12',
+    'icon_post_latest' => 'modules/forums/images/icon_latest_reply.gif*9*18',
+    'icon_post_newest' => 'modules/forums/images/icon_newest_reply.gif*9*18',
+    'forum' => 'modules/forums/images/folder_big.gif*25*46',
+    'forum_new' => 'modules/forums/images/folder_new_big.gif*25*46',
+    'forum_locked' => 'modules/forums/images/folder_locked_big.gif*25*46',
+    'forum_link' => 'modules/forums/images/folder_link_big.gif*25*46',
+    'sub_forum' => 'modules/forums/images/subfolder_big.gif*25*46',
+    'sub_forum_new' => 'modules/forums/images/subfolder_new_big.gif*25*46',
+    'folder' => 'modules/forums/images/folder.gif*18*19',
+    'folder_moved' => 'modules/forums/images/folder_moved.gif*18*19',
+    'folder_posted' => 'modules/forums/images/folder_posted.gif*18*19',
+    'folder_new' => 'modules/forums/images/folder_new.gif*18*19',
+    'folder_new_posted' => 'modules/forums/images/folder_new_posted.gif*18*19',
+    'folder_hot' => 'modules/forums/images/folder_hot.gif*18*19',
+    'folder_hot_posted' => 'modules/forums/images/folder_hot_posted.gif*18*19',
+    'folder_hot_new' => 'modules/forums/images/folder_new_hot.gif*18*19',
+    'folder_hot_new_posted' => 'modules/forums/images/folder_new_hot_posted.gif*18*19',
+    'folder_locked' => 'modules/forums/images/folder_lock.gif*18*19',
+    'folder_locked_posted' => 'modules/forums/images/folder_lock_posted.gif*18*19',
+    'folder_locked_new' => 'modules/forums/images/folder_lock_new.gif*18*19',
+    'folder_locked_new_posted' => 'modules/forums/images/folder_lock_new_posted.gif*18*19',
+    'folder_sticky' => 'modules/forums/images/folder_sticky.gif*18*19',
+    'folder_sticky_posted' => 'modules/forums/images/folder_sticky_posted.gif*18*19',
+    'folder_sticky_new' => 'modules/forums/images/folder_sticky_new.gif*18*19',
+    'folder_sticky_new_posted' => 'modules/forums/images/folder_sticky_new_posted.gif*18*19',
+    'folder_announce' => 'modules/forums/images/folder_announce.gif*18*19',
+    'folder_announce_posted' => 'modules/forums/images/folder_announce_posted.gif*18*19',
+    'folder_announce_new' => 'modules/forums/images/folder_announce_new.gif*18*19',
+    'folder_announce_new_posted' => 'modules/forums/images/folder_announce_new_posted.gif*18*19',
+    'folder_global' => '',
+    'folder_global_posted' => '',
+    'folder_global_new' => '',
+    'folder_global_new_posted' => '',
+    'poll_left'		=> 'modules/forums/images/vote_lcap.gif*12*4',
+    'poll_center'	=> 'modules/forums/images/voting_bar.gif*12*4',
+    'poll_right'	=> 'modules/forums/images/vote_rcap.gif*12*4',
+    'attach_progress_bar' => 'modules/forums/images/progress_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'modules/forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'image_register' => 'modules/forums/images/icon_mini_register.gif',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+);
+
+?>
\ No newline at end of file

Added: cms/trunk/modules/forums/images/karma/karma-1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma-5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma-5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma0.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma0.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/karma/karma5.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/karma/karma5.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/subfolder_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/subfolder_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/subfolder_new_big.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/subfolder_new_big.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_move.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_move.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_split.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_split.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unlock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unlock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/vote_lcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/vote_lcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/vote_rcap.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/vote_rcap.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/voting_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/voting_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/whosonline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/whosonline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/posting.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -61,7 +61,7 @@
 // Was cancel pressed? If so then redirect to the appropriate page
 if ($_CLASS['core_user']->is_bot || isset($_POST['cancel']))
 {
-	$redirect = ($post_id) ? "forums&amp;file=viewtopic&p=$post_id#$post_id" : (($topic_id) ? 'Forums&amp;file=viewtopic&t='.$topic_id : (($forum_id) ? 'Forums&amp;file=viewforum&f='.$forum_id : 'Forums'));
+	$redirect = ($post_id) ? "forums&amp;file=viewtopic&p=$post_id#$post_id" : (($topic_id) ? 'forums&amp;file=viewtopic&t='.$topic_id : (($forum_id) ? 'forums&amp;file=viewforum&f='.$forum_id : 'forums'));
 	redirect(generate_link($redirect,  array('full' => true)));
 }
 
@@ -121,65 +121,200 @@
 
 $result = $_CLASS['core_db']->query($sql);
 
-$posting_data = $_CLASS['core_db']->fetch_row_assoc($result);
+$post_data = $_CLASS['core_db']->fetch_row_assoc($result);
 $_CLASS['core_db']->free_result($result);
 
-if (!$posting_data)
+if (!$post_data)
 {
 	trigger_error('NO_POST');
 }
 
-require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
-require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
-require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
-// remove
-extract($posting_data);
+// Use post_row values in favor of submitted ones...
+$forum_id	= (!empty($post_data['forum_id'])) ? (int) $post_data['forum_id'] : (int) $forum_id;
+$topic_id	= (!empty($post_data['topic_id'])) ? (int) $post_data['topic_id'] : (int) $topic_id;
+$post_id	= (!empty($post_data['post_id'])) ? (int) $post_data['post_id'] : (int) $post_id;
 
-if ($posting_data['forum_type'] == FORUM_POST && !$_CLASS['auth']->acl_get('f_' . $mode, $forum_id) && !$_CLASS['auth']->acl_get('m_'. $mode, $forum_id))
+$post_data['post_edit_locked'] = isset($post_data['post_edit_locked']) ? (int) $post_data['post_edit_locked'] : false;
+
+$_CLASS['core_user']->add_lang(array('posting', 'mcp', 'viewtopic'));
+$_CLASS['core_user']->add_img();
+
+// Is the user able to read within this forum?
+if (!$_CLASS['forums_auth']->acl_get('f_read', $forum_id))
+{
+	if ($_CLASS['core_user']->is_user)
+	{
+		trigger_error('USER_CANNOT_READ');
+	}
+
+	login_box('', $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_POST'));
+}
+
+if ($post_data['forum_password'])
 {
-	if ($_CLASS['core_user']->is_user)
+	login_forum_box(array(
+		'forum_id'		=> $forum_id, 
+		'forum_password'=> $post_data['forum_password']
+	));
+}
+
+
+// Permission to do the action asked?
+$is_authed = false;
+
+switch ($mode)
+{
+	case 'post':
+		if ($_CLASS['forums_auth']->acl_get('f_post', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'bump':
+		if ($_CLASS['forums_auth']->acl_get('f_bump', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'quote':
+	case 'reply':
+		if ($_CLASS['forums_auth']->acl_get('f_reply', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'edit':
+		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets('f_edit', 'm_edit', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+
+	case 'delete':
+		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets('f_delete', 'm_delete', $forum_id))
+		{
+			$is_authed = true;
+		}
+	break;
+}
+
+if (!$is_authed)
+{
+	if ($_CLASS['core_user']->is_user)
+	{
+		trigger_error('USER_CANNOT_' . strtoupper(($mode == 'quote') ? 'reply' : $mode));
+	}
+
+	login_box('', $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_' . strtoupper($mode)));
+}
+unset($is_authed);
+
+// Is the user able to post within this forum?
+if ($post_data['forum_type'] != FORUM_POST && in_array($mode, array('post', 'bump', 'quote', 'reply')))
+{
+	trigger_error('USER_CANNOT_FORUM_POST');
+}
+
+// Forum/Topic locked?
+if (($post_data['forum_status'] == ITEM_LOCKED || (isset($post_data['topic_status']) && $post_data['topic_status'] == ITEM_LOCKED)) && !$_CLASS['forums_auth']->acl_get('m_edit', $forum_id))
+{
+	trigger_error(($post_data['forum_status'] == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED');
+}
+
+// Can we edit this post ... if we're a moderator with rights then always yes
+// else it depends on editing times, lock status and if we're the correct user
+if ($mode == 'edit' && !$_CLASS['forums_auth']->acl_get('m_edit', $forum_id))
+{
+	if ($post_data['post_edit_locked'])
 	{
-		trigger_error('USER_CANNOT_' . strtoupper($mode));
+		trigger_error('CANNOT_EDIT_POST_LOCKED');
 	}
-	
-	login_box(array('explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_' . strtoupper($mode)]));
-}
 
-$forum_id	= (int) $posting_data['forum_id'];
-$topic_id	= (int) $topic_id;
-$post_id	= (int) $post_id;
+	if ($_CLASS['core_user']->data['user_id'] != $post_data['poster_id'])
+	{
+		trigger_error('USER_CANNOT_EDIT');
+	}
 
-$posting_data['post_edit_locked'] = isset($posting_data['post_edit_locked']) ? (int) $posting_data['post_edit_locked'] : false;
+	if ($config['edit_time'] && $post_data['post_time'] > ($current_time - $config['edit_time']))
+	{
+		trigger_error('CANNOT_EDIT_TIME');
+	}
+}
 
-$_CLASS['core_user']->add_lang(array('posting', 'mcp', 'viewtopic'));
-$_CLASS['core_user']->add_img();
+// Handle delete mode...
+if ($mode == 'delete')
+{
+	handle_post_delete($forum_id, $topic_id, $post_id, $post_data);
+	exit;
+}
 
-if ($forum_password)
+// Bump Topic
+if ($mode == 'bump')
 {
-	$forum_info = array(
-		'forum_id'		=> $forum_id, 
-		'forum_password'=> $forum_password
-	);
+	if ($bump_time = bump_topic_allowed($forum_id, $post_data['topic_bumped'], $post_data['topic_last_post_time'], $post_data['topic_poster'], $post_data['topic_last_poster_id']))
+	{
+		$_CLASS['core_db']->transaction();
 	
-	login_forum_box($forum_info);
-	unset($forum_info);
-}
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . "
+			SET post_time = $current_time
+			WHERE post_id = {$post_data['topic_last_post_id']}
+				AND topic_id = $topic_id");
+	
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . "
+			SET topic_last_post_time = $current_time,
+				topic_bumped = 1,
+				topic_bumper = " . $_CLASS['core_user']->data['user_id'] . "
+			WHERE topic_id = $topic_id");
+	
+		$_CLASS['core_db']->query('UPDATE ' . FORUMS_FORUMS_TABLE . '
+			SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . "
+			WHERE forum_id = $forum_id");
+	
+		$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . "
+			SET user_last_post_time = $current_time
+			WHERE user_id = " . $_CLASS['core_user']->data['user_id']);
+	
+		$_CLASS['core_db']->transaction('commit');
+	
+		//markread('topic', $forum_id, $topic_id, $current_time);
+	
+		add_log('mod', $forum_id, $topic_id, 'LOG_BUMP_TOPIC', $post_data['topic_title']);
+	
+		$_CLASS['core_display']->meta_refresh(3, generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id"));
+	
+		$message = $_CLASS['core_user']->lang['TOPIC_BUMPED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['VIEW_MESSAGE'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id").'">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id). '">', '</a>');
+		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="' . generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>');
 
-$post_subject = in_array($mode, array('quote', 'edit', 'delete')) ? $posting_data['post_subject'] : (isset($posting_data['topic_title']) ? $posting_data['topic_title'] : '');
-$topic_time_limit = (isset($posting_data['topic_time_limit']) && $posting_data['topic_time_limit']) ? (int) $posting_data['topic_time_limit'] / 86400 : 0;
+		trigger_error($message);
+	}
 
-$poll_length = (isset($poll_length)) ? (($poll_length) ? (int) $poll_length / 86400 : (int) $poll_length) : 0;
-$poll_start = (isset($poll_start)) ? (int) $poll_start : 0;
-$poll_options = array();
+	trigger_error('BUMP_ERROR');
+}
 
+// Determine some vars
+$post_data['quote_username']	= (!empty($post_data['username'])) ? $post_data['username'] : ((!empty($post_data['post_username'])) ? $post_data['post_username'] : '');
+$post_data['post_edit_locked']	= (isset($post_data['post_edit_locked'])) ? (int) $post_data['post_edit_locked'] : 0;
+$post_data['post_subject']		= (in_array($mode, array('quote', 'edit'))) ? $post_data['post_subject'] : ((isset($post_data['topic_title'])) ? $post_data['topic_title'] : '');
+$post_data['topic_time_limit']	= (isset($post_data['topic_time_limit'])) ? (($post_data['topic_time_limit']) ? (int) $post_data['topic_time_limit'] / 86400 : (int) $post_data['topic_time_limit']) : 0;
+$post_data['poll_length']		= (!empty($post_data['poll_length'])) ? (int) $post_data['poll_length'] / 86400 : 0;
+$post_data['poll_start']		= (!empty($post_data['poll_start'])) ? (int) $post_data['poll_start'] : 0;
+$post_data['icon_id']			= (!isset($post_data['icon_id']) || in_array($mode, array('quote', 'reply'))) ? 0 : (int) $post_data['icon_id'];
+$post_data['poll_options']		= array();
+
 if (!isset($icon_id) || in_array($mode, array('quote', 'reply')))
 {
 	$icon_id = 0;
 }
 
 // Get Poll Data
-if ($poll_start)
+if ($post_data['poll_start'])
 {
 	$sql = 'SELECT poll_option_text 
 		FROM ' . FORUMS_POLL_OPTIONS_TABLE . "
@@ -189,38 +324,39 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$poll_options[] = trim($row['poll_option_text']);
+		$post_data['poll_options'][] = trim($row['poll_option_text']);
 	}
 	$_CLASS['core_db']->free_result($result);
 }
 
-$orig_poll_options_size = count($poll_options);
+$orig_poll_options_size = count($post_data['poll_options']);
+
 $message_parser = new parse_message();
 
-if (isset($post_text))
+if (isset($post_data['post_text']))
 {
-	$message_parser->message = $post_text;
-	unset($post_text);
+	$message_parser->message = $post_data['post_text'];
+	unset($post_data['post_text']);
 }
 
-$message_parser->get_submitted_attachment_data();
 
 // Set uninitialized variables
-$uninit = array('post_attachment' => 0, 'poster_id' => 0, 'enable_magic_url' => 0, 'topic_status' => ITEM_UNLOCKED, 'topic_type' => POST_NORMAL, 'subject' => '', 'topic_title' => '', 'post_time' => 0, 'post_edit_reason' => '');
+$uninit = array('post_attachment' => 0, 'poster_id' => $_CLASS['core_user']->data['user_id'], 'enable_magic_url' => 0, 'topic_status' => 0, 'topic_type' => POST_NORMAL, 'post_subject' => '', 'topic_title' => '', 'post_time' => 0, 'post_edit_reason' => '', 'notify_set' => 0);
 
 foreach ($uninit as $var_name => $default_value)
 {
-	if (!isset($posting_data[$var_name]))
-	{
-		$posting_data[$var_name] = $default_value;
+	if (!isset($post_data[$var_name]))
+	{
+		$post_data[$var_name] = $default_value;
 	}
 }
+unset($uninit);
 
-unset($uninit, $var_name, $default_value);
+$message_parser->get_submitted_attachment_data($post_data['poster_id']);
 
-if ($posting_data['post_attachment'] && !$submit && !$refresh && !$preview && $mode == 'edit')
+if ($post_data['post_attachment'] && !$submit && !$refresh && !$preview && $mode == 'edit')
 {
-	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+	$sql = 'SELECT attach_id, physical_filename, attach_comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
 		FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
@@ -235,34 +371,34 @@
 	$_CLASS['core_db']->free_result($result);
 }
 
-if (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS)
+if (!$post_data['poster_id'] || $post_data['poster_id'] == ANONYMOUS)
 {
-	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['post_username']) : get_variable('username', 'POST', '');
+	$post_data['username'] = in_array($mode, array('quote', 'edit')) ? trim($post_data['post_username']) : get_variable('username', 'POST', '');
 }
 else
 {
-	$posting_data['username'] = in_array($mode, array('quote', 'edit', 'delete')) ? trim($posting_data['username']) : '';
+	$post_data['username'] = in_array($mode, array('quote', 'edit')) ? trim($post_data['username']) : '';
 }
 
-$enable_urls = $posting_data['enable_magic_url'];
-$enable_html = isset($enable_html) ? $enable_html : $config['allow_html'];
+$post_data['enable_urls'] = $post_data['enable_magic_url'];
+$post_data['enable_html'] = isset($enable_html) ? $enable_html : $config['allow_html'];
 
-if (!in_array($mode, array('quote', 'edit', 'delete')))
+if (!in_array($mode, array('quote', 'edit')))
 {
-	$enable_sig		= ($config['allow_sig'] && $_CLASS['core_user']->user_data_get('attachsig'));
-	$enable_smilies = ($config['allow_smilies'] && $_CLASS['core_user']->user_data_get('smilies'));
-	$enable_bbcode	= ($config['allow_bbcode'] && $_CLASS['core_user']->user_data_get('bbcode'));
-	$enable_urls	= true;
+	$post_data['enable_sig']		= ($config['allow_sig'] && $_CLASS['core_user']->user_data_get('attachsig'));
+	$post_data['enable_smilies']	= ($config['allow_smilies'] && $_CLASS['core_user']->user_data_get('smilies'));
+	$post_data['enable_bbcode']		= ($config['allow_bbcode'] && $_CLASS['core_user']->user_data_get('bbcode'));
+	$post_data['enable_urls']		= true;
 }
 
-$posting_data['enable_magic_url'] = $drafts = false;
+$post_data['enable_magic_url'] = $post_data['drafts'] = false;
 
 // User own some drafts?
-if ($_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts') && $mode != 'delete')
+if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_id
 		FROM ' . FORUMS_DRAFTS_TABLE . '
-		WHERE (forum_id = ' . $forum_id . (($topic_id) ? " OR topic_id = $topic_id" : '') . ')
+		WHERE (forum_id IN (' . $forum_id . ', 0)'. (($topic_id) ? " OR topic_id = $topic_id" : '') . ')
 			AND user_id = ' . $_CLASS['core_user']->data['user_id'] . 
 			(($draft_id) ? " AND draft_id <> $draft_id" : '');
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -274,12 +410,10 @@
 	$_CLASS['core_db']->free_result($result);
 }
 
-$check_value = (($enable_html+1) << 16) + (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
+$check_value = (($post_data['enable_bbcode']+1) << 8) + (($post_data['enable_smilies']+1) << 4) + (($post_data['enable_urls']+1) << 2) + (($post_data['enable_sig']+1) << 1);
 
 // Notify user checkbox
-$notify_set = false;
-
-if ($mode != 'post' && $_CLASS['core_user']->is_user)
+if ($mode != 'post' && $config['allow_topic_notify'] && $_CLASS['core_user']->is_user)
 {
 	$sql = 'SELECT forum_id, topic_id
 		FROM ' . FORUMS_WATCH_TABLE . "
@@ -290,52 +424,22 @@
 
 	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$notify_set = ($row['topic_id']) ? 1 : 2;
+		$post_data['notify_set'] = ($row['topic_id']) ? 1 : 2;
 	}
 	$_CLASS['core_db']->free_result($result);
 }
 
-// Forum/Topic locked?
-// what about if we want to delete/etc ?
-if (($posting_data['forum_status'] == ITEM_LOCKED || $posting_data['topic_status'] == ITEM_LOCKED) && !$_CLASS['auth']->acl_get('m_edit', $forum_id))
-{
-	$message = ($posting_data['forum_status'] == ITEM_LOCKED) ? 'FORUM_LOCKED' : 'TOPIC_LOCKED';
-	trigger_error($message);
-}
-
-// Can we edit this post ... if we're a moderator with rights then always yes
-// else it depends on editing times, lock status and if we're the correct user
-// !$preview && !$refresh && !$submit &&
-if ($mode == 'edit' && !$preview && !$refresh && !$submit && !$_CLASS['auth']->acl_get('m_edit', $forum_id))
-{
-	if ($posting_data['post_edit_locked'])
-	{
-		trigger_error('CANNOT_EDIT_POST_LOCKED');
-	}
-
-	if ($_CLASS['core_user']->data['user_id'] != $posting_data['poster_id'])
-	{
-		trigger_error('USER_CANNOT_EDIT');
-	}
-
-	if ($config['edit_time'] && $posting_data['post_time'] > ($current_time - $config['edit_time']))
-	{
-		trigger_error('CANNOT_EDIT_TIME');
-	}
-}
-
 // Do we want to edit our post ?
-
-if ($mode == 'edit')
+if ($mode == 'edit' && $post_data['bbcode_uid'])
 {
-	$message_parser->bbcode_uid = $bbcode_uid;
+	$message_parser->bbcode_uid = $post_data['bbcode_uid'];
 }
-
+/*
 // should we alow ip no user deletion ?
 // Delete triggered ?
 if ($mode == 'delete')
 {
-	if ($_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id == $topic_last_post_id && ((!$_CLASS['core_user']->is_user && $posting_data['poster_id'] == ANONYMOUS && $poster_ip && $poster_ip == $_CLASS['core_user']->ip) || ($_CLASS['core_user']->is_user && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'])))
+	if ($_CLASS['forums_auth']->acl_get('f_delete', $forum_id) && $post_id == $topic_last_post_id && ((!$_CLASS['core_user']->is_user && $post_data['poster_id'] == ANONYMOUS && $poster_ip && $poster_ip == $_CLASS['core_user']->ip) || ($_CLASS['core_user']->is_user && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'])))
 	{
 		$user_deletable = true;
 	}
@@ -345,7 +449,7 @@
 	}
 }
 
-if ($mode == 'delete' && ($user_deletable || $_CLASS['auth']->acl_get('m_delete', $forum_id)))
+if ($mode == 'delete' && ($user_deletable || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id)))
 {
 	$s_hidden_fields = '<input type="hidden" name="p" value="' . $post_id . '" /><input type="hidden" name="f" value="' . $forum_id . '" /><input type="hidden" name="mode" value="delete" />';
 
@@ -355,10 +459,10 @@
 			'topic_first_post_id'=> $topic_first_post_id,
 			'topic_last_post_id'=> $topic_last_post_id,
 			'topic_approved'	=> $topic_approved,
-			'topic_type'		=> $posting_data['topic_type'],
+			'topic_type'		=> $post_data['topic_type'],
 			'post_approved' 	=> $post_approved,
-			'post_time'			=> $posting_data['post_time'],
-			'poster_id'			=> $posting_data['poster_id']
+			'post_time'			=> $post_data['post_time'],
+			'poster_id'			=> $post_data['poster_id']
 		);
 		
 		$next_post_id = delete_post($mode, $post_id, $topic_id, $forum_id, $data);
@@ -367,10 +471,10 @@
 		{
 			if (!$user_deletable)
 			{
-				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $posting_data['topic_title']);
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $post_data['topic_title']);
 			}
 
-			$meta_info = generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id);
+			$meta_info = generate_link('forums&amp;file=viewforum&amp;f='.$forum_id);
 			$message = $_CLASS['core_user']->lang['POST_DELETED'];
 		}
 		else
@@ -380,23 +484,23 @@
 				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_POST', $post_subject);
 			}
 
-			$meta_info = generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id");
-			$message = $_CLASS['core_user']->lang['POST_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id").'">', '</a>');
+			$meta_info = generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id");
+			$message = $_CLASS['core_user']->lang['POST_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$next_post_id#$next_post_id").'">', '</a>');
 		}
 
 		$_CLASS['core_display']->meta_refresh(3, $meta_info);
-		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
+		$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
 
 		trigger_error($message);
 	}
 }
 
-if ($mode == 'delete' && $posting_data['poster_id'] != $_CLASS['core_user']->data['user_id'] && !$_CLASS['auth']->acl_get('f_delete', $forum_id))
+if ($mode == 'delete' && $post_data['poster_id'] != $_CLASS['core_user']->data['user_id'] && !$_CLASS['forums_auth']->acl_get('f_delete', $forum_id))
 {
 	trigger_error('DELETE_OWN_POSTS');
 }
 
-if ($mode == 'delete' && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $post_id != $topic_last_post_id)
+if ($mode == 'delete' && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id) && $post_id != $topic_last_post_id)
 {
 	trigger_error('CANNOT_DELETE_REPLIED');
 }
@@ -405,53 +509,21 @@
 {
 	trigger_error('USER_CANNOT_DELETE');
 }
+*/
 
-// Bump Topic
-if ($mode == 'bump' && ($bump_time = bump_topic_allowed($forum_id, $topic_bumped, $topic_last_post_time, $topic_poster, $topic_last_poster_id)))
-{
-	$_CLASS['core_db']->transaction();
+// HTML, BBCode, Smilies, Images and Flash status
+$html_status	= ($config['allow_html'] && $_CLASS['forums_auth']->acl_get('f_html', $forum_id));
+$bbcode_status	= ($config['allow_bbcode'] && $_CLASS['forums_auth']->acl_get('f_bbcode', $forum_id));
+$smilies_status	= ($config['allow_smilies'] && $_CLASS['forums_auth']->acl_get('f_smilies', $forum_id));
+$img_status		= ($_CLASS['forums_auth']->acl_get('f_img', $forum_id));
+$flash_status	= ($_CLASS['forums_auth']->acl_get('f_flash', $forum_id));
+$quote_status	= ($_CLASS['forums_auth']->acl_get('f_reply', $forum_id));
 
-	$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . "
-		SET post_time = $current_time
-		WHERE post_id = $topic_last_post_id
-			AND topic_id = $topic_id");
-
-	$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . "
-		SET topic_last_post_time = $current_time,
-			topic_bumped = 1,
-			topic_bumper = " . $_CLASS['core_user']->data['user_id'] . "
-		WHERE topic_id = $topic_id");
-
-	$_CLASS['core_db']->query('UPDATE ' . FORUMS_FORUMS_TABLE . '
-		SET ' . implode(', ', update_last_post_information('forum', $forum_id)) . "
-		WHERE forum_id = $forum_id");
-
-	$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . "
-		SET user_last_post_time = $current_time
-		WHERE user_id = " . $_CLASS['core_user']->data['user_id']);
-
-	$_CLASS['core_db']->transaction('commit');
-
-	//markread('topic', $forum_id, $topic_id, $current_time);
-
-	add_log('mod', $forum_id, $topic_id, sprintf($_CLASS['core_user']->lang['LOGM_BUMP'], $posting_data['topic_title']));
-
-	$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id"));
-
-	$message = $_CLASS['core_user']->lang['TOPIC_BUMPED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['VIEW_MESSAGE'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id&amp;p=$topic_last_post_id#$topic_last_post_id").'">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id). '">', '</a>');
-
-	trigger_error($message);
-}
-elseif ($mode == 'bump')
-{
-	trigger_error('BUMP_ERROR');
-}
-
 // Save Draft
-if ($save && $_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts'))
+if ($save && $_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_get('u_savedrafts'))
 {
 	$subject = request_var('subject', '', true);
-	$subject = (!$subject && $mode != 'post') ? $posting_data['topic_title'] : $subject;
+	$subject = (!$subject && $mode != 'post') ? $post_data['topic_title'] : $subject;
 	$message = request_var('message', '', true);
 
 	if ($subject && $message)
@@ -462,52 +534,66 @@
 			'forum_id'	=> $forum_id,
 			'save_time'	=> $current_time,
 			'draft_subject' => $subject,
-			'draft_message' => $message));
+			'draft_message' => $message
+		));
 		$_CLASS['core_db']->query($sql);
 	
-		$meta_info = ($mode == 'post') ? generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id) : generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id");
+		$meta_info = ($mode == 'post') ? generate_link('forums&amp;file=viewforum&amp;f='.$forum_id) : generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id");
 
 		$_CLASS['core_display']->meta_refresh(3, $meta_info);
 
 		$message = $_CLASS['core_user']->lang['DRAFT_SAVED'] . '<br /><br />';
 		$message .= ($mode != 'post') ? sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="' . $meta_info . '">', '</a>') . '<br /><br />' : '';
-		$message .= sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>');
+		$message .= sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>');
 
 		trigger_error($message);
 	}
+	/*		$s_hidden_fields = build_hidden_fields(array(
+				'mode'		=> $mode,
+				'save'		=> true,
+				'f'			=> $forum_id,
+				't'			=> $topic_id,
+				'subject'	=> $subject,
+				'message'	=> $message,
+				)
+			);
+
+			confirm_box(false, 'SAVE_DRAFT', $s_hidden_fields);
+		*/
+	unset($subject, $message);
 
-	unset($subject);
-	unset($message);
 }
 
 // Move to where they should be
 $_CLASS['core_template']->assign_array(array(
-		'S_DRAFT_LOADED'	=> false,
-		'S_SHOW_DRAFTS'		=> false,
-		'S_POST_REVIEW'		=> false,
-		'S_DISPLAY_PREVIEW'	=> false,
-		'S_UNGLOBALISE'		=> false,
-		'S_INLINE_ATTACHMENT_OPTIONS' => false,
-		'S_TOPIC_TYPE_ANNOUNCE' => false,
-		'S_TOPIC_TYPE_STICKY' => false,
-		'S_DISPLAY_REVIEW'	=> false,
+		'S_DRAFT_LOADED'				=> false,
+		'S_SHOW_DRAFTS'					=> false,
+		'S_POST_REVIEW'					=> false,
+		'S_DISPLAY_PREVIEW'				=> false,
+		'S_UNGLOBALISE'					=> false,
+		'S_INLINE_ATTACHMENT_OPTIONS' 	=> false,
+		'S_TOPIC_TYPE_ANNOUNCE' 		=> false,
+		'S_TOPIC_TYPE_STICKY'			 => false,
+		'S_DISPLAY_REVIEW'				=> false,
 ));
 
 // Load Draft
-if ($draft_id && $_CLASS['core_user']->is_user && $_CLASS['auth']->acl_get('u_savedrafts'))
+if ($draft_id && $_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_get('u_savedrafts'))
 {
 	$sql = 'SELECT draft_subject, draft_message 
 		FROM ' . FORUMS_DRAFTS_TABLE . " 
 		WHERE draft_id = $draft_id
 			AND user_id = " . $_CLASS['core_user']->data['user_id'];
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if ($row)
 	{
-		$_REQUEST['subject'] = $row['draft_subject'];
-		$_REQUEST['message'] = $row['draft_message'];
+		$post_data['post_subject'] = $row['draft_subject'];
+		$message_parser->message = $row['draft_message'];
 
-		$refresh = true;
+		//$refresh = true;
 		$_CLASS['core_template']->assign('S_DRAFT_LOADED', true);
 	}
 	else
@@ -516,50 +602,56 @@
 	}
 }
 
-// HTML, BBCode, Smilies, Images and Flash status
-$html_status	= ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id));
-$bbcode_status	= ($config['allow_bbcode'] && $_CLASS['auth']->acl_get('f_bbcode', $forum_id));
-$smilies_status	= ($config['allow_smilies'] && $_CLASS['auth']->acl_get('f_smilies', $forum_id));
-$img_status		= ($_CLASS['auth']->acl_get('f_img', $forum_id));
-$flash_status	= ($_CLASS['auth']->acl_get('f_flash', $forum_id));
-$quote_status	= ($_CLASS['auth']->acl_get('f_quote', $forum_id));
-
 // Load Drafts
-if ($load && $drafts)
+if ($load && $post_data['drafts'])
 {
 	load_drafts($topic_id, $forum_id);
 }
 
 if ($submit || $preview || $refresh)
 {
-	$posting_data['post_edit_reason'] = ($mode == 'edit' && isset($_POST['edit_reason']) && !empty($_POST['edit_reason']) && $_CLASS['core_user']->data['user_id'] != $posting_data['poster_id']) ? get_variable('edit_reason', 'POST', '') : '';
-	$posting_data['topic_type'] = isset($_POST['topic_type']) ? (int) $_POST['topic_type'] : (($mode != 'post') ? $posting_data['topic_type'] : POST_NORMAL);
+	$post_data['topic_cur_post_id'] = request_var('topic_cur_post_id', 0);
+	$post_data['post_subject'] = request_var('subject', '', true);
 
-	$topic_cur_post_id	= get_variable('topic_cur_post_id', 'POST', 0, 'int');
+	// If subject is all-uppercase then we make all lowercase (we do not want to be yelled at too :P)
+	// Admins/Mods might want to create all-uppercase topics, therefore we do not apply this check to them (they should know better ;))
+	if ($post_data['post_subject'] && !$_CLASS['forums_auth']->acl_gets('a_', 'm_', $forum_id))// && strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
+	{
+		//$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
+		$post_data['post_subject'] = mb_strtolower(htmlentities($post_data['post_subject'], ENT_QUOTES, 'UTF-8'));
+	}	
 
-	$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
 	$message_parser->message = request_var('message', '', true);
+
+	$post_data['username']			= request_var('username', $post_data['username']);
+	$post_data['post_edit_reason']	= (!empty($_POST['edit_reason']) && $mode == 'edit' && $_CLASS['forums_auth']->acl_get('m_edit', $forum_id)) ? request_var('edit_reason', '', true) : '';
+
+	$post_data['topic_type']		= get_variable('topic_type', 'POST', (($mode != 'post') ? (int) $post_data['topic_type'] : POST_NORMAL), 'int');
+	$post_data['topic_time_limit']	= get_variable('topic_time_limit', 'POST', (($mode != 'post') ? (int) $post_data['topic_time_limit'] : 0), 'int');
+	$post_data['icon_id']			= get_variable('icon', 'POST', 0, 'int');
+
+	$post_data['enable_bbcode']		= (!$bbcode_status || isset($_POST['disable_bbcode'])) ? false : true;
+	$post_data['enable_smilies']	= (!$smilies_status || isset($_POST['disable_smilies'])) ? false : true;
+	$post_data['enable_urls']		= !isset($_POST['disable_magic_url']);
+	$post_data['enable_sig']		= (!$config['allow_sig']) ? false : ((isset($_POST['attach_sig']) && $_CLASS['core_user']->is_user) ? true : false);
 
+	if ($config['allow_topic_notify'] && $_CLASS['core_user']->is_user)
+	{
+		$notify = isset($_POST['notify']);
+	}
+	else
+	{
+		$notify = false;
+	}
 
-	$topic_time_limit	= (isset($_POST['topic_time_limit'])) ? (int) $_POST['topic_time_limit'] : (($mode != 'post') ? $topic_time_limit : 0);
-	$icon_id			= get_variable('icon', 'POST', 0, 'int');
-
-	$enable_html 		= (!$html_status || isset($_POST['disable_html'])) ? false : true;
-	$enable_bbcode 		= (!$bbcode_status || isset($_POST['disable_bbcode'])) ? false : true;
-	$enable_smilies		= (!$smilies_status || isset($_POST['disable_smilies'])) ? false : true;
-	$enable_urls 		= isset($_POST['disable_magic_url']) ? 0 : 1;
-	$enable_sig			= (!$config['allow_sig']) ? false : (($_CLASS['core_user']->is_user && isset($_POST['attach_sig'])) ? true : false);
-
-	$notify				= isset($_POST['notify']);
 	$topic_lock			= isset($_POST['lock_topic']);
 	$post_lock			= isset($_POST['lock_post']);
-
 	$poll_delete		= isset($_POST['poll_delete']);
 	
 	// Faster than crc32
 	if ($submit)
 	{
-		$status_switch  = (($enable_html+1) << 16) + (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
+		$status_switch = (($post_data['enable_bbcode']+1) << 8) + (($post_data['enable_smilies']+1) << 4) + (($post_data['enable_urls']+1) << 2) + (($post_data['enable_sig']+1) << 1);
 		$status_switch = ($status_switch != $check_value);
 	}
 	else
@@ -568,17 +660,17 @@
 	}
 
 	// Delete Poll
-	if ($poll_delete && $mode == 'edit' && $poll_options && 
-		((!$poll_last_vote && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id)))
+	if ($poll_delete && $mode == 'edit' && count($post_data['poll_options']) && 
+		((!$post_data['poll_last_vote'] && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id)))
 	{
-		switch (SQL_LAYER)
+		switch ($_CLASS['core_db']->db_layer)
 		{
 			case 'mysql4':
 			case 'mysqli':
 				$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . ', ' . POLL_VOTES_TABLE . "
 					WHERE topic_id = $topic_id";
 				$_CLASS['core_db']->query($sql);
-				break;
+			break;
 
 			default:
 				$sql = 'DELETE FROM ' . POLL_OPTIONS_TABLE . "
@@ -588,8 +680,9 @@
 				$sql = 'DELETE FROM ' . POLL_VOTES_TABLE . "
 					WHERE topic_id = $topic_id";
 				$_CLASS['core_db']->query($sql);
+			break;
 		}
-		
+
 		$topic_sql = array(
 			'poll_title'		=> '',
 			'poll_start' 		=> 0,
@@ -604,22 +697,22 @@
 			WHERE topic_id = $topic_id";
 		$_CLASS['core_db']->query($sql);
 
-		$poll_title = $poll_option_text = '';
-		$poll_vote_change = $poll_max_options = $poll_length = 0;
+		$post_data['poll_title'] = $post_data['poll_option_text'] = '';
+		$post_data['poll_vote_change'] = $post_data['poll_max_options'] = $post_data['poll_length'] = 0;
 	}
 	else
 	{
-		$poll_title			= request_var('poll_title', '');
-		$poll_length		= request_var('poll_length', 0);
-		$poll_option_text	= request_var('poll_option_text', '');
-		$poll_max_options	= request_var('poll_max_options', 1);
-		$poll_vote_change	= ($_CLASS['auth']->acl_get('f_votechg', $forum_id) && isset($_POST['poll_vote_change'])) ? 1 : 0;
+		$post_data['poll_title']		= request_var('poll_title', '', true);
+		$post_data['poll_length']		= request_var('poll_length', 0);
+		$post_data['poll_option_text']	= request_var('poll_option_text', '', true);
+		$post_data['poll_max_options']	= request_var('poll_max_options', 1);
+		$post_data['poll_vote_change']	= ($_CLASS['forums_auth']->acl_get('f_votechg', $forum_id) && isset($_POST['poll_vote_change'])) ? 1 : 0;
 	}
 
 	// If replying/quoting and last post id has changed
 	// give user option to continue submit or return to post
 	// notify and show user the post made between his request and the final submit
-	if (($mode == 'reply' || $mode == 'quote') && $topic_cur_post_id && $topic_cur_post_id != $topic_last_post_id)
+	if (($mode == 'reply' || $mode == 'quote') && $post_data['topic_cur_post_id'] && $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
 		if (topic_review($topic_id, $forum_id, 'post_review', $topic_cur_post_id))
 		{
@@ -636,19 +729,19 @@
 	$message_md5 = md5($message_parser->message);
 
 	// Check checksum ... don't re-parse message if the same
-	$update_message = ($mode != 'edit' || $message_md5 != $post_checksum || $status_switch) ? true : false;
+	$update_message = ($mode != 'edit' || $message_md5 != $post_data['post_checksum'] || $status_switch) ? true : false;
 	
 	// Parse message
 	if ($update_message)
 	{
-		$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, $quote_status);
+		$message_parser->parse($post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies'], $img_status, $flash_status, $quote_status);
 	}
 	else
 	{
-		$message_parser->bbcode_bitfield = $bbcode_bitfield;
+		$message_parser->bbcode_bitfield = $post_data['bbcode_bitfield'];
 	}
 
-	if ($mode != 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['auth']->acl_get('f_ignoreflood', $forum_id))
+	if ($mode != 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['forums_auth']->acl_get('f_ignoreflood', $forum_id))
 	{
 		// Flood check
 		$last_post_time = 0;
@@ -664,7 +757,6 @@
 				WHERE poster_ip = '" . $_CLASS['core_user']->ip . "'
 					AND post_time > " . ($current_time - $config['flood_interval']);
 			$result = $_CLASS['core_db']->query_limit($sql, 1);
-
 			if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$last_post_time = $row['last_post_time'];
@@ -672,60 +764,80 @@
 			$_CLASS['core_db']->free_result($result);
 		}
 
-		if ($last_post_time)
+		if ($last_post_time && ($current_time - $last_post_time) < intval($config['flood_interval']))
 		{
-			if ($last_post_time && ($current_time - $last_post_time) < intval($config['flood_interval']))
-			{
-				$error[] = $_CLASS['core_user']->get_lang('FLOOD_ERROR');
-			}
+			$error[] = $_CLASS['core_user']->get_lang('FLOOD_ERROR');
 		}
 	}
 
 	// Validate username
-	if ($posting_data['username'] && (!$_CLASS['core_user']->is_user || ($mode == 'edit' && (!$posting_data['poster_id'] || $posting_data['poster_id'] == ANONYMOUS))))
+	if (($post_data['username'] && !$_CLASS['core_user']->is_user) || ($mode == 'edit' && $post_data['post_username']))
 	{
-		require_once(SITE_FILE_ROOT.'includes/functions_user.php');
-		$result = validate_username($posting_data['username']);
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
+		$result = validate_username($post_data['username']);
 
 		if ($result !== true)
 		{
 			$error[] = $_CLASS['core_user']->get_lang($result);
 		}
 	}
+	
+/*
+ ADD
+	if ($config['enable_post_confirm'] && !$_CLASS['core_user']->is_user && in_array($mode, array('quote', 'post', 'reply')))
+	{
+		$confirm_id = request_var('confirm_id', '');
+		$confirm_code = request_var('confirm_code', '');
+
+		$sql = 'SELECT code
+			FROM ' . CONFIRM_TABLE . "
+			WHERE confirm_id = '" . $db->sql_escape($confirm_id) . "'
+				AND session_id = '" . $db->sql_escape($_CLASS['core_user']->session_id) . "'
+				AND confirm_type = " . CONFIRM_POST;
+		$result = $db->sql_query($sql);
+		$confirm_row = $db->sql_fetchrow($result);
+		$db->sql_freeresult($result);
+
+		if (empty($confirm_row['code']) || strcasecmp($confirm_row['code'], $confirm_code) !== 0)
+		{
+			$error[] = $_CLASS['core_user']->get_lang('CONFIRM_CODE_WRONG');
+		}
+	}
+*/
 
 	// Parse subject
-	if (!$subject && ($mode == 'post' || ($mode == 'edit' && $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
+	if (!$post_data['post_subject'] && ($mode == 'post' || ($mode == 'edit' && $post_data['topic_first_post_id'] == $post_id)))
 	{
 		$error[] = $_CLASS['core_user']->get_lang('EMPTY_SUBJECT');
 	}
 
-	$poll_last_vote = (isset($poll_last_vote)) ? $poll_last_vote : 0;
+	$post_data['poll_last_vote'] = (isset($post_data['poll_last_vote'])) ? $post_data['poll_last_vote'] : 0;
 
-	if ($poll_option_text && 
-			($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id && (!$poll_last_vote || $_CLASS['auth']->acl_get('m_edit', $forum_id))))
-			&& $_CLASS['auth']->acl_get('f_poll', $forum_id))
+	if ($post_data['poll_option_text'] && 
+		($mode == 'post' || ($mode == 'edit' && $post_id == $post_data['topic_first_post_id'] && (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))))
+			&& $_CLASS['forums_auth']->acl_get('f_poll', $forum_id))
 	{
-		$poll = array(
-			'poll_title'		=> $poll_title,
-			'poll_length'		=> $poll_length,
-			'poll_max_options'	=> $poll_max_options,
-			'poll_option_text'	=> $poll_option_text,
-			'poll_start'		=> $poll_start,
-			'poll_last_vote'	=> $poll_last_vote,
-			'poll_vote_change'	=> $poll_vote_change,
-			'enable_html'		=> $enable_html,
-			'enable_bbcode'		=> $enable_bbcode,
-			'enable_urls'		=> $enable_urls,
-			'enable_smilies'	=> $enable_smilies,
-			'img_status'		=> $img_status
+		$poll = array(
+			'poll_title'		=> $post_data['poll_title'],
+			'poll_length'		=> $post_data['poll_length'],
+			'poll_max_options'	=> $post_data['poll_max_options'],
+			'poll_option_text'	=> $post_data['poll_option_text'],
+			'poll_start'		=> $post_data['poll_start'],
+			'poll_last_vote'	=> $post_data['poll_last_vote'],
+			'poll_vote_change'	=> $post_data['poll_vote_change'],
+			//'enable_html'		=> $post_data['enable_html'],
+			'enable_bbcode'		=> $post_data['enable_bbcode'],
+			'enable_urls'		=> $post_data['enable_urls'],
+			'enable_smilies'	=> $post_data['enable_smilies'],
+			'img_status'		=> $img_status
 		);
 
 		$message_parser->parse_poll($poll);
-	
-		$poll_options = isset($poll['poll_options']) ? $poll['poll_options'] : '';
-		$poll_title = isset($poll['poll_title']) ? $poll['poll_title'] : '';
 
-		if ($poll_last_vote && ($poll['poll_options_size'] < $orig_poll_options_size))
+		$post_data['poll_options'] = (isset($poll['poll_options'])) ? $poll['poll_options'] : '';
+		$post_data['poll_title'] = (isset($poll['poll_title'])) ? $poll['poll_title'] : '';
+
+		if ($post_data['poll_last_vote'] && ($poll['poll_options_size'] < $orig_poll_options_size))
 		{
 			$message_parser->warn_msg[] = $_CLASS['core_user']->lang['NO_DELETE_POLL_OPTIONS'];
 		}
@@ -736,9 +848,9 @@
 	}
 
 	// Check topic type
-	if ($posting_data['topic_type'] != POST_NORMAL && ($mode == 'post' || ($mode == 'edit' && $posting_data['topic_first_post_id'] == $posting_data['post_id'])))
+	if ($post_data['topic_type'] != POST_NORMAL && ($mode == 'post' || ($mode == 'edit' && $post_data['topic_first_post_id'] == $post_id)))
 	{
-		switch ($posting_data['topic_type'])
+		switch ($post_data['topic_type'])
 		{
 			case POST_GLOBAL:
 			case POST_ANNOUNCE:
@@ -754,7 +866,7 @@
 			break;	
 		}
 
-		if (!$_CLASS['auth']->acl_get($auth_option, $forum_id))
+		if (!$_CLASS['forums_auth']->acl_get($auth_option, $forum_id))
 		{
 			$error[] = $_CLASS['core_user']->lang['CANNOT_POST_' . str_replace('F_', '', strtoupper($auth_option))];
 		}
@@ -769,21 +881,24 @@
 	if (empty($error) && $submit)
 	{
 		// Check if we want to de-globalize the topic... and ask for new forum
-		if ($posting_data['topic_type'] != POST_GLOBAL)
+		if ($post_data['topic_type'] != POST_GLOBAL)
 		{
 			$sql = 'SELECT topic_type, forum_id
 				FROM ' . FORUMS_TOPICS_TABLE . "
 				WHERE topic_id = $topic_id";
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
 
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			
+			$_CLASS['core_db']->free_result($result);
+
 			if ($row && !$row['forum_id'] && $row['topic_type'] == POST_GLOBAL)
 			{
 				$to_forum_id = request_var('to_forum_id', 0);
 	
 				if (!$to_forum_id)
 				{
+					require_once  SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+	
 					$_CLASS['core_template']->assign_array(array(
 						'S_FORUM_SELECT'	=> make_forum_select(false, false, false, true, true),
 						'S_UNGLOBALISE'		=> true) 
@@ -802,21 +917,21 @@
 		if ($submit)
 		{
 			// Lock/Unlock Topic
-			$change_topic_status = $posting_data['topic_status'];
-			$perm_lock_unlock = ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster));
+			$change_topic_status = $post_data['topic_status'];
+			$perm_lock_unlock = ($_CLASS['forums_auth']->acl_get('m_lock', $forum_id) || ($_CLASS['forums_auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster));
 
-			if ($posting_data['topic_status'] == ITEM_LOCKED && !$topic_lock && $perm_lock_unlock)
+			if ($post_data['topic_status'] == ITEM_LOCKED && !$topic_lock && $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_UNLOCKED;
 			}
-			else if ($posting_data['topic_status'] == ITEM_UNLOCKED && $topic_lock && $perm_lock_unlock)
+			else if ($post_data['topic_status'] == ITEM_UNLOCKED && $topic_lock && $perm_lock_unlock)
 			{
 				$change_topic_status = ITEM_LOCKED;
 			}
 		
-			if ($change_topic_status != $posting_data['topic_status'])
+			if ($change_topic_status != $post_data['topic_status'])
 			{
-				$posting_data['topic_status'] = $change_topic_status;
+				$post_data['topic_status'] = $change_topic_status;
 
 				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
 					SET topic_status = $change_topic_status
@@ -824,49 +939,49 @@
 						AND topic_moved_id = 0";
 				$_CLASS['core_db']->query($sql);
 			
-				$user_lock = ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster) ? 'USER_' : '';
+				$user_lock = ($_CLASS['forums_auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster) ? 'USER_' : '';
 
-				//add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $posting_data['topic_title']);
+				//add_log('mod', $forum_id, $topic_id, 'LOG_' . $user_lock . (($change_topic_status == ITEM_LOCKED) ? 'LOCK' : 'UNLOCK'), $post_data['topic_title']);
 			}
 
 			// Lock/Unlock Post Edit
-			if ($mode == 'edit' && $posting_data['post_edit_locked'] == ITEM_LOCKED && !$post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
+			if ($mode == 'edit' && $post_data['post_edit_locked'] == ITEM_LOCKED && !$post_lock && $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))
 			{
-				$posting_data['post_edit_locked'] = ITEM_UNLOCKED;
+				$post_data['post_edit_locked'] = ITEM_UNLOCKED;
 			}
-			else if ($mode == 'edit' && $posting_data['post_edit_locked'] == ITEM_UNLOCKED && $post_lock && $_CLASS['auth']->acl_get('m_edit', $forum_id))
+			else if ($mode == 'edit' && $post_data['post_edit_locked'] == ITEM_UNLOCKED && $post_lock && $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))
 			{
-				$posting_data['post_edit_locked'] = ITEM_LOCKED;
+				$post_data['post_edit_locked'] = ITEM_LOCKED;
 			}
 
-			$post_data = array(
-				'topic_title'			=> (!$posting_data['topic_title']) ? $subject : $posting_data['topic_title'],
-				'topic_first_post_id'	=> (isset($topic_first_post_id)) ? (int) $topic_first_post_id : 0,
-				'topic_last_post_id'	=> (isset($topic_last_post_id)) ? (int) $topic_last_post_id : 0,
-				'topic_time_limit'		=> (int) $topic_time_limit,
-				'topic_status'			=> (int) $posting_data['topic_status'],
-				'post_id'				=> (int) $post_id,
-				'topic_id'				=> (int) $topic_id,
-				'forum_id'				=> (int) $forum_id,
-				'icon_id'				=> (int) $icon_id,
-				'poster_id'				=> (int) $posting_data['poster_id'],
-				'enable_sig'			=> (bool) $enable_sig,
-				'enable_bbcode'			=> (bool) $enable_bbcode,
-				'enable_html' 			=> (bool) $enable_html,
-				'enable_smilies'		=> (bool) $enable_smilies,
-				'enable_urls'			=> (bool) $enable_urls,
-				'enable_indexing'		=> (bool) $enable_indexing,
+			$data = array(
+				'topic_title'			=> (empty($post_data['topic_title'])) ? $post_data['post_subject'] : $post_data['topic_title'],
+				'topic_first_post_id'	=> (isset($post_data['topic_first_post_id'])) ? (int) $post_data['topic_first_post_id'] : 0,
+				'topic_last_post_id'	=> (isset($post_data['topic_last_post_id'])) ? (int) $post_data['topic_last_post_id'] : 0,
+				'topic_time_limit'		=> (int) $post_data['topic_time_limit'],
+				'topic_status'			=> (int) $post_data['topic_status'],
+				'post_id'				=> (int) $post_id,
+				'topic_id'				=> (int) $topic_id,
+				'forum_id'				=> (int) $forum_id,
+				'icon_id'				=> (int) $post_data['icon_id'],
+				'poster_id'				=> (int) $post_data['poster_id'],
+				'enable_sig'			=> (bool) $post_data['enable_sig'],
+				'enable_bbcode'			=> (bool) $post_data['enable_bbcode'],
+				'enable_html' 			=> (bool) $post_data['enable_html'],
+				'enable_smilies'		=> (bool) $post_data['enable_smilies'],
+				'enable_urls'			=> (bool) $post_data['enable_urls'],
+				'enable_indexing'		=> (bool) $post_data['enable_indexing'],
 				'message_md5'			=> (string) $message_md5,
-				'post_time'				=> ($posting_data['post_time']) ? (int) $posting_data['post_time'] : $current_time,
-				'post_checksum'			=> (isset($post_checksum)) ? (string) $post_checksum : '',
-				'post_edit_reason'		=> $posting_data['post_edit_reason'],
-				'post_edit_user'		=> ($mode == 'edit') ? $_CLASS['core_user']->data['user_id'] : ((isset($post_edit_user)) ? (int) $post_edit_user : 0),
-				'forum_parents'			=> $forum_parents,
-				'forum_name'			=> $forum_name,
-				'notify'				=> $notify,
-				'notify_set'			=> $notify_set,
-				'poster_ip'				=> (isset($poster_ip)) ? (int) $poster_ip : $_CLASS['core_user']->ip,
-				'post_edit_locked'		=> (int) $posting_data['post_edit_locked'],
+				'post_time'				=> (isset($post_data['post_time'])) ? (int) $post_data['post_time'] : $current_time,
+				'post_checksum'			=> (isset($post_data['post_checksum'])) ? (string) $post_data['post_checksum'] : '',
+				'post_edit_reason'		=> $post_data['post_edit_reason'],
+				'post_edit_user'		=> ($mode == 'edit') ? $_CLASS['core_user']->data['user_id'] : ((isset($post_data['post_edit_user'])) ? (int) $post_data['post_edit_user'] : 0),
+				'forum_parents'			=> $post_data['forum_parents'],
+				'forum_name'			=> $post_data['forum_name'],
+				'notify'				=> $notify,
+				'notify_set'			=> $post_data['notify_set'],
+				'poster_ip'				=> (isset($post_data['poster_ip'])) ? $post_data['poster_ip'] : $_CLASS['core_user']->ip,
+				'post_edit_locked'		=> (int) $post_data['post_edit_locked'],
 				'bbcode_bitfield'		=> (int) $message_parser->bbcode_bitfield,
 				'bbcode_uid'			=> $message_parser->bbcode_uid,
 				'message'				=> $message_parser->message,
@@ -875,26 +990,32 @@
 			);
 			unset($message_parser);
 			
-			submit_post($mode, $subject, $posting_data['username'], $posting_data['topic_type'], $poll, $post_data, $update_message);
+			$redirect_url = submit_post($mode, $post_data['post_subject'], $post_data['username'], $post_data['topic_type'], $poll, $data, $update_message);
+
+			$_CLASS['core_display']->meta_refresh(3, $redirect_url);
+
+			$message = (!$_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) && !$_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? (($mode == 'edit') ? 'POST_EDITED_MOD' : 'POST_STORED_MOD') : (($mode == 'edit') ? 'POST_EDITED' : 'POST_STORED');
+			$message = $_CLASS['core_user']->get_lang($message) . (($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? '<br /><br />' . sprintf($_CLASS['core_user']->get_lang('VIEW_MESSAGE'), '<a href="' . $redirect_url . '">', '</a>') : '');
+			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->get_lang('RETURN_FORUM'), '<a href="' . generate_link('forums&amp;file=viewforumf=' . $data['forum_id']) . '">', '</a>');
+			trigger_error($message);
+		
 		}
 	}	
-
-	$post_subject = $subject;
 }
 
 // Preview
 if (empty($error) && $preview)
 {
-	$posting_data['post_time'] = ($mode == 'edit') ? $posting_data['post_time'] : $current_time;
+	$post_data['post_time'] = ($mode == 'edit') ? $post_data['post_time'] : $current_time;
 
-	$preview_message = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
+	$preview_message = $message_parser->format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies'], false);
 
-	$preview_signature = ($mode == 'edit') ? $user_sig : $_CLASS['core_user']->data['user_sig'];
-	$preview_signature_uid = ($mode == 'edit') ? $user_sig_bbcode_uid : $_CLASS['core_user']->data['user_sig_bbcode_uid'];
-	$preview_signature_bitfield = ($mode == 'edit') ? $user_sig_bbcode_bitfield : $_CLASS['core_user']->data['user_sig_bbcode_bitfield'];
+	$preview_signature = ($mode == 'edit') ? $post_data['user_sig'] : $_CLASS['core_user']->data['user_sig'];
+	$preview_signature_uid = ($mode == 'edit') ? $post_data['user_sig_bbcode_uid'] : $_CLASS['core_user']->data['user_sig_bbcode_uid'];
+	$preview_signature_bitfield = ($mode == 'edit') ? $post_data['user_sig_bbcode_bitfield'] : $_CLASS['core_user']->data['user_sig_bbcode_bitfield'];
 
 	// Signature
-	if ($enable_sig && $config['allow_sig'] && $preview_signature && $_CLASS['auth']->acl_get('f_sigs', $forum_id))
+	if ($post_data['enable_sig'] && $config['allow_sig'] && $preview_signature && $_CLASS['forums_auth']->acl_get('f_sigs', $forum_id))
 	{
 		$parse_sig = new parse_message($preview_signature);
 		$parse_sig->bbcode_uid = $preview_signature_uid;
@@ -910,31 +1031,31 @@
 		$preview_signature = '';
 	}
 	
-	$preview_subject = censor_text($subject);
+	$preview_subject = censor_text($post_data['post_subject']);
 	
 	// Poll Preview
-	if (($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id && (!$poll_last_vote || $_CLASS['auth']->acl_get('m_edit', $forum_id))))
-	&& $_CLASS['auth']->acl_get('f_poll', $forum_id))
+	if (($mode == 'post' || ($mode == 'edit' && $post_id == $post_data['topic_first_post_id'] && (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))))
+	&& $_CLASS['forums_auth']->acl_get('f_poll', $forum_id))
 	{
-		$parse_poll = new parse_message($poll_title);
+		$parse_poll = new parse_message($post_data['poll_title']);
 		$parse_poll->bbcode_uid = $message_parser->bbcode_uid;
 		$parse_poll->bbcode_bitfield = $message_parser->bbcode_bitfield;
 
-		$parse_poll->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
+		$parse_poll->format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies']);
 		
 		$_CLASS['core_template']->assign_array(array(
 			'S_HAS_POLL_OPTIONS'=> !empty($poll_options),
-			'S_IS_MULTI_CHOICE'	=> ($poll_max_options > 1) ? true : false,
+			'S_IS_MULTI_CHOICE'	=> ($post_data['poll_max_options'] > 1) ? true : false,
 
 			'POLL_QUESTION'		=> $parse_poll->message,
 			
-			'L_POLL_LENGTH'		=> ($poll_length) ? sprintf($_CLASS['core_user']->lang['POLL_RUN_TILL'], $_CLASS['core_user']->format_date($poll_length + $poll_start)) : '',
-			'L_MAX_VOTES'		=> ($poll_max_options == 1) ? $_CLASS['core_user']->lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']->lang['MAX_OPTIONS_SELECT'], $poll_max_options))
+			'L_POLL_LENGTH'		=> ($post_data['poll_length']) ? sprintf($_CLASS['core_user']->get_lang('POLL_RUN_TILL'), $_CLASS['core_user']->format_date($post_data['poll_length'] + $post_data['poll_start'])) : '',
+			'L_MAX_VOTES'		=> ($post_data['poll_max_options'] == 1) ? $_CLASS['core_user']->get_lang('MAX_OPTION_SELECT') : sprintf($_CLASS['core_user']->get_lang('MAX_OPTIONS_SELECT'), $post_data['poll_max_options']))
 		);
 		
-		$parse_poll->message = implode("\n", $poll_options);
-		$parse_poll->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies);
-		$preview_poll_options = explode('<br />', $parse_poll->message);
+		$parse_poll->message = implode("\n", $post_data['poll_options']);
+		$parse_poll->format_display($post_data['enable_html'], $post_data['enable_bbcode'], $post_data['enable_urls'], $post_data['enable_smilies']);
+		$preview_poll_options = explode('<br />', $parse_poll->message);
 		unset($parse_poll);
 		
 		foreach ($preview_poll_options as $option)
@@ -984,36 +1105,35 @@
 }
 
 // Decode text for message display
-$bbcode_uid = ($mode == 'quote' && !$preview && !$refresh && empty($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
-$message_parser->decode_message($bbcode_uid);
+$post_data['bbcode_uid'] = ($mode == 'quote' && !$preview && !$refresh && !sizeof($error)) ? $post_data['bbcode_uid'] : $message_parser->bbcode_uid;
+$message_parser->decode_message($post_data['bbcode_uid']);
 
-if ($mode == 'quote' && !$preview && !$refresh)
+if ($mode == 'quote' && !$submit && !$preview && !$refresh)
 {
-	$quote_username = isset($posting_data['username']) ? $posting_data['username'] : (isset($posting_data['post_username']) ? $posting_data['post_username'] : '');
-	$message_parser->message = '[quote="' . $quote_username . '"]' . censor_text(trim($message_parser->message)) . "[/quote]\n";
+	$message_parser->message = '[quote="' . $post_data['quote_username'] . '"]' . censor_text(trim($message_parser->message)) . "[/quote]\n";
 }
 
-if (($mode == 'reply' || $mode == 'quote') && !$preview && !$refresh)
-{
-	$post_subject = ((!preg_match('/^Re:/', $post_subject)) ? 'Re: ' : '') . censor_text($post_subject);
+if (($mode == 'reply' || $mode == 'quote') && !$submit && !$preview && !$refresh)
+{
+	$post_data['post_subject'] = ((!preg_match('/^Re:/', $post_data['post_subject'])) ? 'Re: ' : '') . censor_text($post_data['post_subject']);
 }
 
 $attachment_data = $message_parser->attachment_data;
 $filename_data = $message_parser->filename_data;
-$post_text = $message_parser->message;
+$post_data['post_text'] = $message_parser->message;
 
-if (!empty($poll_options) && $poll_title)
-{
-	$message_parser->message = $poll_title;
-	$message_parser->bbcode_uid = $bbcode_uid;
-
-	$message_parser->decode_message();
-	$poll_title = $message_parser->message;
-
-	$message_parser->message = implode("\n", $poll_options);
-	$message_parser->decode_message();
-	$poll_options = explode("\n", $message_parser->message);
-}
+if (sizeof($post_data['poll_options']) && $post_data['poll_title'])
+{
+	$message_parser->message = $post_data['poll_title'];
+	$message_parser->bbcode_uid = $post_data['bbcode_uid'];
+
+	$message_parser->decode_message();
+	$post_data['poll_title'] = $message_parser->message;
+
+	$message_parser->message = implode("\n", $post_data['poll_options']);
+	$message_parser->decode_message();
+	$post_data['poll_options'] = explode("\n", $message_parser->message);
+}
 unset($message_parser);
 
 // MAIN POSTING PAGE BEGINS HERE
@@ -1030,29 +1150,32 @@
 // Do show topic type selection only in first post.
 $topic_type_toggle = false;
 
-if ($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id))
+if ($mode == 'post' || ($mode == 'edit' && $post_id == $post_data['topic_first_post_id']))
 {
-	$topic_type_toggle = posting_gen_topic_types($forum_id, $posting_data['topic_type']);
+	$topic_type_toggle = posting_gen_topic_types($forum_id, $post_data['topic_type']);
 }
 
 $s_topic_icons = false;
 
-if ($enable_icons)
+if ($post_data['enable_icons'])
 {
-	$s_topic_icons = posting_gen_topic_icons($mode, $icon_id);
+	$s_topic_icons = posting_gen_topic_icons($mode, $post_data['icon_id']);
 }
 
 
 
-$html_checked		= (isset($enable_html)) ? !$enable_html : (($config['allow_html']) ? !$_CLASS['core_user']->user_data_get('html') : 1);
-$bbcode_checked		= (isset($enable_bbcode)) ? !$enable_bbcode : (($config['allow_bbcode']) ? !$_CLASS['core_user']->user_data_get('bbcode') : 1);
-$smilies_checked	= (isset($enable_smilies)) ? !$enable_smilies : (($config['allow_smilies']) ? !$_CLASS['core_user']->user_data_get('smilies') : 1);
-$urls_checked		= (isset($enable_urls)) ? !$enable_urls : 0;
-$sig_checked		= $enable_sig;
-$notify_checked		= (isset($notify)) ? $notify : ((!$notify_set) ? (($_CLASS['core_user']->is_user) ? $_CLASS['core_user']->data['user_notify'] : 0) : 1);
-$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($posting_data['topic_status'] == ITEM_LOCKED) ? 1 : 0);
-$lock_post_checked	= isset($post_lock) ? $post_lock : $posting_data['post_edit_locked'];
+$html_checked		= (isset($post_data['enable_html'])) ? !$post_data['enable_html'] : (($config['allow_html']) ? !$_CLASS['core_user']->user_data_get('html') : 1);
+$bbcode_checked		= (isset($post_data['enable_bbcode'])) ? !$post_data['enable_bbcode'] : (($config['allow_bbcode']) ? !$_CLASS['core_user']->user_data_get('bbcode') : 1);
+$smilies_checked	= (isset($post_data['enable_smilies'])) ? !$post_data['enable_smilies'] : (($config['allow_smilies']) ? !$_CLASS['core_user']->user_data_get('smilies') : 1);
+$urls_checked		= (isset($post_data['enable_urls'])) ? !$post_data['enable_urls'] : 0;
+$sig_checked		= $post_data['enable_sig'];
 
+$lock_topic_checked	= (isset($topic_lock)) ? $topic_lock : (($post_data['topic_status'] == ITEM_LOCKED) ? 1 : 0);
+$lock_post_checked	= (isset($post_lock)) ? $post_lock : $post_data['post_edit_locked'];
+
+// If in edit mode, and the user is not the poster, we do not take the notification into account
+$notify_checked		= (isset($notify)) ? $notify : (($mode == 'post') ? $_CLASS['core_user']->data['user_notify'] : $post_data['notify_set']);
+
 // Page title & action URL, include session_id for security purpose
 $s_action = "forums&amp;file=posting&amp;mode=$mode&amp;f=$forum_id";
 $s_action .= ($topic_id) ? "&amp;t=$topic_id" : '';
@@ -1063,116 +1186,138 @@
 {
 	case 'post':
 		$page_title = $_CLASS['core_user']->lang['POST_TOPIC'];
-		break;
+	break;
 
 	case 'quote':
 	case 'reply':
 		$page_title = $_CLASS['core_user']->lang['POST_REPLY'];
-		break;
+	break;
 
 	case 'delete':
 	case 'edit':
 		$page_title = $_CLASS['core_user']->lang['EDIT_POST'];
+	break;
 }
 
-$forum_data = array(
-	'parent_id'		=> $parent_id,
-	'left_id'		=> $left_id,
-	'right_id'		=> $right_id,
-	'forum_parents'	=> $forum_parents,
-	'forum_name'	=> $forum_name,
-	'forum_id'		=> $forum_id,
-	'forum_type'	=> $posting_data['forum_type'],
-	'forum_desc'	=> $forum_desc,
-	'forum_rules'	=> $forum_rules,
-	'forum_rules_flags' => $forum_rules_flags,
-	'forum_rules_bbcode_uid' => $forum_rules_bbcode_uid,
-	'forum_rules_bbcode_bitfield' => $forum_rules_bbcode_bitfield,
-	'forum_rules_link' => $forum_rules_link
-);
-
 // Build Navigation Links
-generate_forum_nav($forum_data);
+generate_forum_nav($post_data);
 
 // Build Forum Rules
-generate_forum_rules($forum_data);
+generate_forum_rules($post_data);
+/*
+if ($config['enable_post_confirm'] && !$_CLASS['core_user']->is_user && ($mode == 'post' || $mode == 'reply' || $mode == 'quote'))
+{
+	// Show confirm image
+	$sql = 'DELETE FROM ' . CONFIRM_TABLE . "
+		WHERE session_id = '" . $db->sql_escape($_CLASS['core_user']->session_id) . "'
+			AND confirm_type = " . CONFIRM_POST;
+	$db->sql_query($sql);
+
+	// Generate code
+	$code = gen_rand_string(mt_rand(5, 8));
+	$confirm_id = md5(unique_id($_CLASS['core_user']->ip));
+
+	$sql = 'INSERT INTO ' . CONFIRM_TABLE . ' ' . $db->sql_build_array('INSERT', array(
+		'confirm_id'	=> (string) $confirm_id,
+		'session_id'	=> (string) $_CLASS['core_user']->session_id,
+		'confirm_type'	=> (int) CONFIRM_POST,
+		'code'			=> (string) $code)
+	);
+	$db->sql_query($sql);
+
+	$template->assign_vars(array(
+		'S_CONFIRM_CODE'			=> true,
+		'CONFIRM_ID'				=> $confirm_id,
+		'CONFIRM_IMAGE'				=> '<img src="' . append_sid("{$phpbb_root_path}ucp.$phpEx", 'mode=confirm&amp;id=' . $confirm_id . '&amp;type=' . CONFIRM_POST) . '" alt="" title="" />',
+		'L_POST_CONFIRM_EXPLAIN'	=> sprintf($_CLASS['core_user']->get_lang('POST_CONFIRM_EXPLAIN'), '<a href="mailto:' . htmlentities($config['board_contact']) . '">', '</a>'),
+	));
+}*/
 
-$s_hidden_fields = ($mode == 'reply' || $mode == 'quote') ? '<input type="hidden" name="topic_cur_post_id" value="' . $topic_last_post_id . '" />' : '';
-$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '<input type="hidden" name="draft_loaded" value="' . ((isset($_REQUEST['draft_loaded'])) ? intval($_REQUEST['draft_loaded']) : $draft_id) . '" />' : '';
+$s_hidden_fields = ($mode == 'reply' || $mode == 'quote') ? '<input type="hidden" name="topic_cur_post_id" value="' . $post_data['topic_last_post_id'] . '" />' : '';
+$s_hidden_fields .= '<input type="hidden" name="lastclick" value="' . $current_time . '" />';
+$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '<input type="hidden" name="draft_loaded" value="' . request_var('draft_loaded', $draft_id) . '" />' : '';
 
-$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['auth']->acl_gets(array('f_attach', 'u_attach'), $forum_id)) ? '' : ' enctype="multipart/form-data"';
+$form_enctype = (@ini_get('file_uploads') == '0' || strtolower(@ini_get('file_uploads')) == 'off' || @ini_get('file_uploads') == '0' || !$config['allow_attachments'] || !$_CLASS['forums_auth']->acl_gets(array('f_attach', 'u_attach'), $forum_id)) ? '' : ' enctype="multipart/form-data"';
 
 // Start assigning vars for main posting page ...
 $_CLASS['core_template']->assign_array(array(
 	'L_POST_A'				=> $page_title,
-	'L_ICON'				=> ($mode == 'reply' || $mode == 'quote') ? $_CLASS['core_user']->lang['POST_ICON'] : $_CLASS['core_user']->lang['TOPIC_ICON'], 
-	'L_MESSAGE_BODY_EXPLAIN'=> (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']->lang['MESSAGE_BODY_EXPLAIN'], intval($config['max_post_chars'])) : '',
+	'L_ICON'					=> ($mode == 'reply' || $mode == 'quote' || ($mode == 'edit' && $post_id != $post_data['topic_first_post_id'])) ? $_CLASS['core_user']->lang['POST_ICON'] : $_CLASS['core_user']->lang['TOPIC_ICON'],
+	'L_MESSAGE_BODY_EXPLAIN'	=> (intval($config['max_post_chars'])) ? sprintf($_CLASS['core_user']->get_lang('MESSAGE_BODY_EXPLAIN'), intval($config['max_post_chars'])) : '',
 	
-	'FORUM_NAME' 			=> $forum_name,
-	'FORUM_DESC'			=> ($forum_desc) ? strip_tags($forum_desc) : '',
-	'TOPIC_TITLE' 			=> $posting_data['topic_title'],
+	'FORUM_NAME'			=> $post_data['forum_name'],
+	'FORUM_DESC'			=> ($post_data['forum_desc']) ? strip_tags($post_data['forum_desc']) : '',
+	'TOPIC_TITLE'			=> censor_text($post_data['topic_title']),
 	'MODERATORS' 			=> empty($moderators) ? '' : implode(', ', $moderators[$forum_id]),
-	'USERNAME'				=> ((!$preview && $mode != 'quote') || $preview) ? $posting_data['username'] : '',
-	'SUBJECT'				=> $post_subject,
-	'MESSAGE'				=> $post_text,
+	'USERNAME'				=> ((!$preview && $mode != 'quote') || $preview) ? $post_data['username'] : '',
+	'SUBJECT'				=> $post_data['post_subject'],
+	'MESSAGE'				=> $post_data['post_text'],
 	'HTML_STATUS'			=> ($html_status) ? $_CLASS['core_user']->lang['HTML_IS_ON'] : $_CLASS['core_user']->lang['HTML_IS_OFF'],
-	'BBCODE_STATUS'			=> ($bbcode_status) ? sprintf($_CLASS['core_user']->lang['BBCODE_IS_ON'], '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="phpbbcode" onclick="window.open(\''.generate_link('Forums&amp;file=faq&amp;mode=bbcode')."', '_phpbbcode', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false\">", '</a>') : sprintf($_CLASS['core_user']->lang['BBCODE_IS_OFF'], '<a href="' . generate_link('Forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
+	'BBCODE_STATUS'			=> ($bbcode_status) ? sprintf($_CLASS['core_user']->lang['BBCODE_IS_ON'], '<a href="' . generate_link('forums&amp;file=faq&amp;mode=bbcode') . '" target="phpbbcode" onclick="window.open(\''.generate_link('forums&amp;file=faq&amp;mode=bbcode')."', '_phpbbcode', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false\">", '</a>') : sprintf($_CLASS['core_user']->lang['BBCODE_IS_OFF'], '<a href="' . generate_link('forums&amp;file=faq&amp;mode=bbcode') . '" target="_phpbbcode">', '</a>'),
 	'IMG_STATUS'			=> ($img_status) ? $_CLASS['core_user']->lang['IMAGES_ARE_ON'] : $_CLASS['core_user']->lang['IMAGES_ARE_OFF'],
 	'FLASH_STATUS'			=> ($flash_status) ? $_CLASS['core_user']->lang['FLASH_IS_ON'] : $_CLASS['core_user']->lang['FLASH_IS_OFF'],
 	'SMILIES_STATUS'		=> ($smilies_status) ? $_CLASS['core_user']->lang['SMILIES_ARE_ON'] : $_CLASS['core_user']->lang['SMILIES_ARE_OFF'],
 	'MINI_POST_IMG'			=> $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
-	'POST_DATE'				=> ($posting_data['post_time']) ? $_CLASS['core_user']->format_date($posting_data['post_time']) : '',
+	'POST_DATE'				=> ($post_data['post_time']) ? $_CLASS['core_user']->format_date($post_data['post_time']) : '',
 	'ERROR'					=> empty($error) ? '' : implode('<br />', $error), 
-	'TOPIC_TIME_LIMIT'		=> (int) $topic_time_limit,
-	'EDIT_REASON'			=> $posting_data['post_edit_reason'],
+	'TOPIC_TIME_LIMIT'		=> (int) $post_data['topic_time_limit'],
+	'EDIT_REASON'			=> $post_data['post_edit_reason'],
 
-	'U_VIEW_FORUM' 			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
-	'U_VIEWTOPIC' 			=> ($mode != 'post') ? generate_link("Forums&amp;file=viewtopic&amp;$forum_id&amp;t=$topic_id") : '',
+	'U_VIEW_FORUM' 			=> generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id),
+	'U_VIEWTOPIC' 			=> ($mode != 'post') ? generate_link("forums&amp;file=viewtopic&amp;$forum_id&amp;t=$topic_id") : '',
 
 	'S_EDIT_POST'			=> ($mode == 'edit'),
-	'S_EDIT_REASON'			=> ($mode == 'edit' && $_CLASS['core_user']->data['user_id'] != $posting_data['poster_id']),
-	'S_DISPLAY_USERNAME'	=> (!$_CLASS['core_user']->is_user || ($mode == 'edit' && $post_username)),
+	'S_EDIT_REASON'			=> ($mode == 'edit' && $_CLASS['core_user']->data['user_id'] != $post_data['poster_id']),
+	'S_DISPLAY_USERNAME'	=> (!$_CLASS['core_user']->is_user || ($mode == 'edit' && $post_data['post_username'])),
 	'S_SHOW_TOPIC_ICONS'	=> $s_topic_icons,
-	'S_DELETE_ALLOWED' 		=> ($mode == 'edit' && (($post_id == $topic_last_post_id && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
+	'S_DELETE_ALLOWED'		=> ($mode == 'edit' && (($post_id == $post_data['topic_last_post_id'] && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id))) ? true : false,
 	'S_HTML_ALLOWED'		=> $html_status,
 	'S_HTML_CHECKED' 		=> ($html_checked) ? ' checked="checked"' : '',
 	'S_BBCODE_ALLOWED'		=> $bbcode_status,
 	'S_BBCODE_CHECKED' 		=> ($bbcode_checked) ? ' checked="checked"' : '',
 	'S_SMILIES_ALLOWED'		=> $smilies_status,
 	'S_SMILIES_CHECKED' 	=> ($smilies_checked) ? ' checked="checked"' : '',
-	'S_SIG_ALLOWED'			=> ($_CLASS['auth']->acl_get('f_sigs', $forum_id) && $config['allow_sig'] && $_CLASS['core_user']->is_user),
+	'S_SIG_ALLOWED'			=> ($_CLASS['forums_auth']->acl_get('f_sigs', $forum_id) && $config['allow_sig'] && $_CLASS['core_user']->is_user),
 	'S_SIGNATURE_CHECKED' 	=> ($sig_checked) ? ' checked="checked"' : '',
 	'S_NOTIFY_ALLOWED'		=> ($_CLASS['core_user']->is_user),
 	'S_NOTIFY_CHECKED' 		=> ($notify_checked) ? ' checked="checked"' : '',
-	'S_LOCK_TOPIC_ALLOWED'	=> (($mode == 'edit' || $mode == 'reply' || $mode == 'quote') && ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster))),
+	'S_LOCK_TOPIC_ALLOWED'	=> (($mode == 'edit' || $mode == 'reply' || $mode == 'quote') && ($_CLASS['forums_auth']->acl_get('m_lock', $forum_id) || ($_CLASS['forums_auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_poster))),
 	'S_LOCK_TOPIC_CHECKED'	=> ($lock_topic_checked) ? ' checked="checked"' : '',
-	'S_LOCK_POST_ALLOWED'	=> ($mode == 'edit' && $_CLASS['auth']->acl_get('m_edit', $forum_id)),
+	'S_LOCK_POST_ALLOWED'	=> ($mode == 'edit' && $_CLASS['forums_auth']->acl_get('m_edit', $forum_id)),
 	'S_LOCK_POST_CHECKED'	=> ($lock_post_checked) ? ' checked="checked"' : '',
 	'S_MAGIC_URL_CHECKED' 	=> ($urls_checked) ? ' checked="checked"' : '',
 	'S_TYPE_TOGGLE'			=> $topic_type_toggle,
-	'S_SAVE_ALLOWED'		=> ($_CLASS['auth']->acl_get('u_savedrafts') && $_CLASS['core_user']->is_user),
-	'S_HAS_DRAFTS'			=> ($_CLASS['auth']->acl_get('u_savedrafts') && $_CLASS['core_user']->is_user && $drafts),
+	'S_SAVE_ALLOWED'		=> ($_CLASS['forums_auth']->acl_get('u_savedrafts') && $_CLASS['core_user']->is_user),
+	'S_HAS_DRAFTS'			=> ($_CLASS['forums_auth']->acl_get('u_savedrafts') && $_CLASS['core_user']->is_user && $post_data['drafts']),
 	'S_FORM_ENCTYPE'		=> $form_enctype,
 
+	'S_BBCODE_IMG'			=> $img_status,
+	'S_BBCODE_FLASH'		=> $flash_status,
+	'S_BBCODE_QUOTE'		=> $quote_status,
+
 	'S_POST_ACTION' 		=> $s_action,
 	'S_HIDDEN_FIELDS'		=> $s_hidden_fields)
 );
 
+// Build custom bbcodes array
+//display_custom_bbcodes();
+
 // Poll entry
-if (($mode == 'post' || ($mode == 'edit' && $post_id == $topic_first_post_id && (!$poll_last_vote || $_CLASS['auth']->acl_get('m_edit', $forum_id))))
-	&& $_CLASS['auth']->acl_get('f_poll', $forum_id))
+if (($mode == 'post' || ($mode == 'edit' && $post_id == $post_data['topic_first_post_id'] && (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))))
+	&& $_CLASS['forums_auth']->acl_get('f_poll', $forum_id))
 {
 	$_CLASS['core_template']->assign_array(array(
 		'S_SHOW_POLL_BOX'		=> true,
-		'S_POLL_VOTE_CHANGE'    => ($_CLASS['auth']->acl_get('f_votechg', $forum_id)),
-		'S_POLL_DELETE'			=> ($mode == 'edit' && $poll_options && ((!$poll_last_vote && $posting_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['auth']->acl_get('f_delete', $forum_id)) || $_CLASS['auth']->acl_get('m_delete', $forum_id))),
+		'S_POLL_VOTE_CHANGE'    => ($_CLASS['forums_auth']->acl_get('f_votechg', $forum_id)),
+		'S_POLL_DELETE'			=> ($mode == 'edit' && !empty($post_data['poll_options']) && ((!$post_data['poll_last_vote'] && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id))),
 
 		'L_POLL_OPTIONS_EXPLAIN'=> sprintf($_CLASS['core_user']->lang['POLL_OPTIONS_EXPLAIN'], $config['max_poll_options']),
-		'VOTE_CHANGE_CHECKED'   => (isset($poll_vote_change) && $poll_vote_change) ? ' checked="checked"' : '',
-		'POLL_TITLE' 			=> (isset($poll_title)) ? $poll_title : '',
-		'POLL_OPTIONS'			=> (isset($poll_options) && $poll_options) ? implode("\n", $poll_options) : '',
-		'POLL_MAX_OPTIONS'		=> (isset($poll_max_options)) ? (int) $poll_max_options : 1, 
-		'POLL_LENGTH' 			=> $poll_length)
+
+		'VOTE_CHANGE_CHECKED'	=> (!empty($post_data['poll_vote_change'])) ? ' checked="checked"' : '',
+		'POLL_TITLE'			=> (isset($post_data['poll_title'])) ? $post_data['poll_title'] : '',
+		'POLL_OPTIONS'			=> (!empty($post_data['poll_options'])) ? implode("\n", $post_data['poll_options']) : '',
+		'POLL_MAX_OPTIONS'		=> (isset($post_data['poll_max_options'])) ? (int) $post_data['poll_max_options'] : 1,
+		'POLL_LENGTH'			=> $post_data['poll_length'])
 	);
 }
 else
@@ -1185,7 +1330,7 @@
 }
 
 // Attachment entry
-if ($form_enctype)
+if ($_CLASS['forums_auth']->acl_get('f_attach', $forum_id) && $_CLASS['forums_auth']->acl_get('u_attach') && $config['allow_attachments'] && $form_enctype)
 {
 	posting_gen_attachment_entry($attachment_data, $filename_data);
 }
@@ -1211,694 +1356,76 @@
 
 $_CLASS['core_template']->display('modules/forums/posting_body.html');
 
-// ---------
-// FUNCTIONS
-//
 
-// Delete Post
-function delete_post($mode, $post_id, $topic_id, $forum_id, &$data)
-{
-	global $config, $_CLASS;
-
-	// Specify our post mode
-	$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'delete_topic' : (($data['topic_first_post_id'] == $post_id) ? 'delete_first_post' : (($data['topic_last_post_id'] == $post_id) ? 'delete_last_post' : 'delete'));
-	$sql_data = array();
-	$next_post_id = 0;
-
-	$_CLASS['core_db']->transaction();
-
-	if (!delete_posts('post_id', array($post_id), false))
-	{
-		// Try to delete topic, we may had an previous error causing inconsistency
-		/*
-		if ($post_mode === 'delete_topic')
-		{
-			delete_topics('topic_id', array($topic_id), false);
-		}
-		*/
-
-		trigger_error('ALREADY_DELETED');
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-
-	// Collect the necessary informations for updating the tables
-	$sql_data[FORUMS_FORUMS_TABLE] = '';
-
-	switch ($post_mode)
-	{
-		case 'delete_topic':
-			delete_topics('topic_id', array($topic_id), false);
-			set_config('num_topics', $config['num_topics'] - 1, true);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] .= 'forum_posts = forum_posts - 1, forum_topics_real = forum_topics_real - 1';
-				$sql_data[FORUMS_FORUMS_TABLE] .= ($data['topic_approved']) ? ', forum_topics = forum_topics - 1' : '';
-				$sql_data[FORUMS_FORUMS_TABLE] .= ', ';
-			}
-
-			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-		break;
-
-		case 'delete_first_post':
-			$sql = 'SELECT p.post_id, p.poster_id, p.post_username, u.username 
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
-				WHERE p.topic_id = $topic_id 
-					AND p.poster_id = u.user_id 
-				ORDER BY p.post_time ASC";
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_first_post_id = ' . intval($row['post_id']) . ", topic_first_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
-			$sql_data[FORUMS_TOPICS_TABLE] .= ', topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-
-			$next_post_id = (int) $row['post_id'];
-		break;
-			
-		case 'delete_last_post':
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_FORUMS_TABLE] .= ($sql_data[FORUMS_FORUMS_TABLE]) ? ', ' : '';
-			$sql_data[FORUMS_FORUMS_TABLE] .= implode(', ', update_last_post_information('forum', $forum_id));
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_bumped = 0, topic_bumper = 0, topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-
-			$update = update_last_post_information('topic', $topic_id);
-			if (!empty($update))
-			{
-				$sql_data[FORUMS_TOPICS_TABLE] .= ', ' . implode(', ', $update);
-				$next_post_id = (int) str_replace('topic_last_post_id = ', '', $update[0]);
-			}
-			else
-			{
-				$sql = 'SELECT MAX(post_id) as last_post_id
-					FROM ' . FORUMS_POSTS_TABLE . "
-					WHERE topic_id = $topic_id " .
-						((!$_CLASS['auth']->acl_get('m_approve')) ? 'AND post_approved = 1' : '');
-				$result = $_CLASS['core_db']->query($sql);
-				$row = $_CLASS['core_db']->fetch_row_assoc($result);
-				$_CLASS['core_db']->free_result($result);
-	
-				$next_post_id = (int) $row['last_post_id'];
-			}
-		break;
-			
-		case 'delete':
-			$sql = 'SELECT post_id
-				FROM ' . FORUMS_POSTS_TABLE . "
-				WHERE topic_id = $topic_id " . 
-					((!$_CLASS['auth']->acl_get('m_approve')) ? 'AND post_approved = 1' : '') . '
-					AND post_time > ' . $data['post_time'] . '
-				ORDER BY post_time ASC';
-			$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			if ($data['topic_type'] != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE] = 'forum_posts = forum_posts - 1';
-			}
-
-			$sql_data[FORUMS_TOPICS_TABLE] = 'topic_replies_real = topic_replies_real - 1' . (($data['post_approved']) ? ', topic_replies = topic_replies - 1' : '');
-			$next_post_id = (int) $row['post_id'];
-		break;
-	}
-				
-	$sql_data[CORE_USERS_TABLE] = ($_CLASS['auth']->acl_get('f_postcount', $forum_id)) ? 'user_posts = user_posts - 1' : '';
-	set_config('num_posts', $config['num_posts'] - 1, true);
-
-	$_CLASS['core_db']->transaction();
-
-	$where_sql = array(FORUMS_FORUMS_TABLE => "forum_id = $forum_id", FORUMS_TOPICS_TABLE => "topic_id = $topic_id", CORE_USERS_TABLE => 'user_id = ' . $data['poster_id']);
-
-	foreach ($sql_data as $table => $update_sql)
-	{
-		if ($update_sql)
-		{
-			$_CLASS['core_db']->query("UPDATE $table SET $update_sql WHERE " . $where_sql[$table]);
-		}
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-
-	return $next_post_id;
+/**
+* Do the various checks required for removing posts as well as removing it
+*/
+function handle_post_delete($forum_id, $topic_id, $post_id, &$post_data)
+{
+	global $_CLASS;
+
+	// If moderator removing post or user itself removing post, present a confirmation screen
+	if ($_CLASS['forums_auth']->acl_get('m_delete', $forum_id) || ($post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['core_user']->data['is_registered'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id) && $post_id == $post_data['topic_last_post_id']))
+	{
+		$s_hidden_fields = build_hidden_fields(array(
+			'p'		=> $post_id,
+			'f'		=> $forum_id,
+			'mode'	=> 'delete')
+		);
+
+		if (confirm_box(true))
+		{
+			$data = array(
+				'topic_first_post_id'	=> $post_data['topic_first_post_id'],
+				'topic_last_post_id'	=> $post_data['topic_last_post_id'],
+				'topic_approved'		=> $post_data['topic_approved'],
+				'topic_type'			=> $post_data['topic_type'],
+				'post_approved'			=> $post_data['post_approved'],
+				'post_reported'			=> $post_data['post_reported'],
+				'post_time'				=> $post_data['post_time'],
+				'poster_id'				=> $post_data['poster_id'],
+				'post_postcount'		=> $post_data['post_postcount']
+			);
+
+			$next_post_id = delete_post($forum_id, $topic_id, $post_id, $data);
+
+			if ($post_data['topic_first_post_id'] == $post_data['topic_last_post_id'])
+			{
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_TOPIC', $post_data['topic_title']);
+
+				$meta_info = generate_link('forums&amp;file=viewforumf='.$forum_id);
+				$message = $_CLASS['core_user']->lang['POST_DELETED'];
+			}
+			else
+			{
+				add_log('mod', $forum_id, $topic_id, 'LOG_DELETE_POST', $post_data['post_subject']);
+
+				$meta_info = generate_link("forums&amp;file=viewtopicf=$forum_id&amp;t=$topic_id&amp;p=$next_post_id") . "#p$next_post_id";
+				$message = $_CLASS['core_user']->lang['POST_DELETED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="' . $meta_info . '">', '</a>');
+			}
+
+			$_CLASS['core_display']->meta_refresh(3, $meta_info);
+			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="' . generate_link('forums&amp;file=viewforumf=' . $forum_id) . '">', '</a>');
+			trigger_error($message);
+		}
+		else
+		{
+			confirm_box(false, 'DELETE_MESSAGE', $s_hidden_fields);
+		}
+	}
+
+	// If we are here the user is not able to delete - present the correct error message
+	if ($post_data['poster_id'] != $_CLASS['core_user']->data['user_id'] && !$_CLASS['forums_auth']->acl_get('f_delete', $forum_id))
+	{
+		trigger_error('DELETE_OWN_POSTS');
+	}
+
+	if ($post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id) && $post_id != $post_data['topic_last_post_id'])
+	{
+		trigger_error('CANNOT_DELETE_REPLIED');
+	}
+
+	trigger_error('USER_CANNOT_DELETE');
 }
 
-// Submit Post
-function submit_post($mode, $subject, $username, $topic_type, &$poll, &$data, $update_message = true)
-{
-	global $_CLASS, $config;
-
-	// We do not handle erasing posts here
-	if ($mode == 'delete')
-	{
-		return;
-	}
-
-	$current_time = $_CLASS['core_user']->time;
-
-	if ($mode == 'post')
-	{
-		$post_mode = 'post';
-		$update_message = true;
-	}
-	else if ($mode != 'edit')
-	{
-		$post_mode = 'reply';
-		$update_message = true;
-	}
-	else if ($mode == 'edit')
-	{
-		$post_mode = ($data['topic_first_post_id'] == $data['topic_last_post_id']) ? 'edit_topic' : (($data['topic_first_post_id'] == $data['post_id']) ? 'edit_first_post' : (($data['topic_last_post_id'] == $data['post_id']) ? 'edit_last_post' : 'edit'));
-	}
-
-
-	// Collect some basic informations about which tables and which rows to update/insert
-	$sql_data = array();
-	$poster_id = ($mode == 'edit') ? $data['poster_id'] : (int) $_CLASS['core_user']->data['user_id'];
-
-	// Collect Informations
-	switch ($post_mode)
-	{
-		case 'post':
-		case 'reply':
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'poster_id' 		=> (int) $_CLASS['core_user']->data['user_id'],
-				'icon_id'			=> $data['icon_id'],
-				'poster_ip' 		=> $_CLASS['core_user']->ip,
-				'post_time'			=> $current_time,
-				'post_approved' 	=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
-				'enable_bbcode' 	=> $data['enable_bbcode'],
-				'enable_html' 		=> $data['enable_html'],
-				'enable_smilies' 	=> $data['enable_smilies'],
-				'enable_magic_url' 	=> $data['enable_urls'],
-				'enable_sig' 		=> $data['enable_sig'],
-				'post_username'		=> (!$_CLASS['core_user']->is_user) ? $username : '',
-				'post_subject'		=> $subject,
-				'post_text' 		=> $data['message'],
-				'post_checksum'		=> $data['message_md5'],
-				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
-				'bbcode_uid'		=> $data['bbcode_uid'],
-				'post_edit_locked'	=> $data['post_edit_locked']
-			);
-			break;
-
-		case 'edit_first_post':
-		case 'edit':
-			if (!$_CLASS['auth']->acl_gets('m_', 'a_') || $data['post_edit_reason'])
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-					'post_edit_time'	=> $current_time
-				);
-
-				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
-			}
-
-		case 'edit_last_post':
-		case 'edit_topic':
-
-			if (($post_mode == 'edit_last_post' || $post_mode == 'edit_topic') && $data['post_edit_reason'])
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array(
-					'post_edit_time'	=> $current_time
-				);
-
-				$sql_data[FORUMS_POSTS_TABLE]['stat'][] = 'post_edit_count = post_edit_count + 1';
-			}
-
-			if (!isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql'] = array();
-			}
-
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-				'forum_id' 			=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'poster_id' 		=> $data['poster_id'],
-				'icon_id'			=> $data['icon_id'],
-				'post_approved' 	=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
-				'enable_bbcode' 	=> $data['enable_bbcode'],
-				'enable_html' 		=> $data['enable_html'],
-				'enable_smilies' 	=> $data['enable_smilies'],
-				'enable_magic_url' 	=> $data['enable_urls'],
-				'enable_sig' 		=> $data['enable_sig'],
-				'post_username'		=> ($username && $data['poster_id'] == ANONYMOUS) ? $username : '',
-				'post_subject'		=> $subject,
-				'post_edit_reason'	=> $data['post_edit_reason'],
-				'post_edit_user'	=> (int) $data['post_edit_user'],
-				'post_checksum'		=> $data['message_md5'],
-				'post_attachment'	=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
-				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
-				'bbcode_uid'		=> $data['bbcode_uid'],
-				'post_edit_locked'	=> $data['post_edit_locked'])
-			);
-
-			if ($update_message)
-			{
-				$sql_data[FORUMS_POSTS_TABLE]['sql']['post_text'] = $data['message'];
-			}
-
-			break;
-	}
-
-	// And the topic ladies and gentlemen
-	switch ($post_mode)
-	{
-		case 'post':
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_poster'			=> (int) $_CLASS['core_user']->data['user_id'],
-				'topic_time'			=> $current_time,
-				'forum_id' 				=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'icon_id'				=> $data['icon_id'],
-				'topic_approved'		=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
-				'topic_title' 			=> $subject,
-				'topic_first_poster_name' => (!$_CLASS['core_user']->is_user && $username) ? $username : $_CLASS['core_user']->data['username'],
-				'topic_type'			=> $topic_type,
-				'topic_time_limit'		=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'topic_status'			=> $data['topic_status'],
-				'topic_attachment'		=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
-				'topic_replies_real'	=> 0,
-				'topic_replies'			=> 0,
-				'topic_views'			=> 0,
-				'topic_moved_id'		=> 0
-			);
-
-			if (isset($poll['poll_options']) && !empty($poll['poll_options']))
-			{
-				$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array_merge($sql_data[TOPICS_TABLE]['sql'], array(
-					'poll_title'		=> $poll['poll_title'],
-					'poll_start'		=> ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
-					'poll_max_options'	=> $poll['poll_max_options'],
-					'poll_length'		=> ($poll['poll_length'] * 86400),
-					'poll_vote_change'	=> $poll['poll_vote_change'])
-				);
-			}
-
-			$sql_data[CORE_USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
-
-			if ($topic_type != POST_GLOBAL)
-			{
-				if (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve'))
-				{
-					$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
-				}
-				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', forum_topics = forum_topics + 1' : '');
-			}
-		break;
-
-		case 'reply':
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = 'topic_replies_real = topic_replies_real + 1, topic_bumped = 0, topic_bumper = 0' . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? ', topic_replies = topic_replies + 1' : '');
-			$sql_data[CORE_USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
-			
-			if ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) && $topic_type != POST_GLOBAL)
-			{
-				$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + 1';
-			}
-		break;
-
-		case 'edit_topic':
-		case 'edit_first_post':
-
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'forum_id' 					=> ($topic_type == POST_GLOBAL) ? 0 : $data['forum_id'],
-				'icon_id'					=> $data['icon_id'],
-				'topic_approved'			=> ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? 0 : 1,
-				'topic_title' 				=> $subject,
-				'topic_first_poster_name'	=> $username,
-				'topic_type'				=> $topic_type,
-				'topic_time_limit'			=> ($topic_type == POST_STICKY || $topic_type == POST_ANNOUNCE) ? ($data['topic_time_limit'] * 86400) : 0,
-				'poll_title'				=> isset($poll['poll_options']) ? $poll['poll_title'] : '',
-				'poll_start'				=> isset($poll['poll_options']) ? (($poll['poll_start']) ? $poll['poll_start'] : $current_time) : 0,
-				'poll_max_options'			=> isset($poll['poll_options']) ? $poll['poll_max_options'] : 1,
-				'poll_length'				=> isset($poll['poll_options']) ? ($poll['poll_length'] * 86400) : 0,
-				'poll_vote_change'			=> isset($poll['poll_vote_change']) ? $poll['poll_vote_change'] : 0,
-				'topic_attachment'			=> ($post_mode == 'edit_topic') ? ((isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0) : (int) $data['topic_attachment']
-			);
-		break;
-	}
-
-	$_CLASS['core_db']->transaction();
-
-	// Submit new topic
-	if ($post_mode == 'post')
-	{
-		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
-			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
-		$_CLASS['core_db']->query($sql);
-
-		$data['topic_id'] = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
-
-		$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-			'topic_id' => $data['topic_id'])
-		);
-		unset($sql_data[FORUMS_TOPICS_TABLE]['sql']);
-	}
-
-	// Submit new post
-	if ($post_mode == 'post' || $post_mode == 'reply')
-	{
-		if ($post_mode == 'reply')
-		{
-			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-				'topic_id' => $data['topic_id'])
-			);
-		}
-
-		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .
-			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
-		$_CLASS['core_db']->query($sql);
-		$data['post_id'] = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
-
-		if ($post_mode == 'post')
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
-				'topic_first_post_id'	=> $data['post_id'],
-				'topic_last_post_id'	=> $data['post_id'],
-				'topic_last_post_time'	=> $current_time,
-				'topic_last_poster_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : $_CLASS['core_user']->data['username']
-			);
-		}
-
-		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
-	}
-
-	$make_global = false;
-
-	// Are we globalising or unglobalising?
-	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
-	{
-		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
-			FROM ' . FORUMS_TOPICS_TABLE . '
-			WHERE topic_id = ' . $data['topic_id'];
-		$result = $_CLASS['core_db']->query($sql);
-
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-		
-		// globalise
-		if ($row['topic_type'] != POST_GLOBAL && $topic_type == POST_GLOBAL)
-		{
-			// Decrement topic/post count
-			$make_global = true;
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
-
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts - ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real - 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics - 1' : '');
-
-			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET forum_id = 0
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-		// unglobalise
-		else if ($row['topic_type'] == POST_GLOBAL && $topic_type != POST_GLOBAL)
-		{
-			// Increment topic/post count
-			$make_global = true;
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'] = array();
-
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_posts = forum_posts + ' . ($row['topic_replies_real'] + 1);
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = 'forum_topics_real = forum_topics_real + 1' . (($row['topic_approved']) ? ', forum_topics = forum_topics + 1' : '');
-
-			// Update forum_ids for all posts
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET forum_id = ' . $data['forum_id'] . '
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-
-	// Update the topics table
-	if (isset($sql_data[FORUMS_TOPICS_TABLE]['sql']))
-	{
-		$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_TOPICS_TABLE]['sql']) . '
-			WHERE topic_id = ' . $data['topic_id']);
-	}
-
-	// Update the posts table
-	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
-	{
-		$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']) . '
-			WHERE post_id = ' . $data['post_id']);
-	}
-
-	// Update Poll Tables
-	if (isset($poll['poll_options']) && !empty($poll['poll_options']))
-	{
-		$cur_poll_options = array();
-
-		if ($poll['poll_start'] && $mode == 'edit')
-		{
-			$sql = 'SELECT * FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
-				WHERE topic_id = ' . $data['topic_id'] . '
-				ORDER BY poll_option_id';
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($cur_poll_options[] = $_CLASS['core_db']->fetch_row_assoc($result));
-			$_CLASS['core_db']->free_result($result);
-		}
-		
-		$size = count($poll['poll_options']);
-
-		for ($i = 0, $size; $i < $size; $i++)
-		{
-			if (trim($poll['poll_options'][$i]))
-			{
-				if (!$cur_poll_options[$i])
-				{
-					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . "  (poll_option_id, topic_id, poll_option_text)
-						VALUES ($i, " . $data['topic_id'] . ", '" . $_CLASS['core_db']->escape($poll['poll_options'][$i]) . "')";
-					$_CLASS['core_db']->query($sql);
-				}
-				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
-				{
-					$sql = "UPDATE " . FORUMS_POLL_OPTIONS_TABLE . "
-						SET poll_option_text = '" . $_CLASS['core_db']->escape($poll['poll_options'][$i]) . "'
-						WHERE poll_option_id = " . $cur_poll_options[$i]['poll_option_id'] . "
-							AND topic_id = " . $data['topic_id'];
-					$_CLASS['core_db']->query($sql);
-				}
-			}
-		}
-
-		if (count($poll['poll_options']) < count($cur_poll_options))
-		{
-			$sql = 'DELETE FROM ' . FORUMS_POLL_OPTIONS_TABLE . '
-				WHERE poll_option_id >= ' . count($poll['poll_options']) . '
-					AND topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-	}
-
-	// Submit Attachments
-	if (!empty($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
-	{
-		$space_taken = $files_added = 0;
-
-		foreach ($data['attachment_data'] as $pos => $attach_row)
-		{
-			if ($attach_row['attach_id'])
-			{
-				// update entry in db if attachment already stored in db and filespace
-				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
-					SET comment = '" . $_CLASS['core_db']->escape($attach_row['comment']) . "'
-					WHERE attach_id = " . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']->query($sql);
-			}
-			else
-			{
-				// insert attachment into db
-				if (!@file_exists($config['upload_path'] . '/' . basename($attach_row['physical_filename'])))
-				{
-					continue;
-				}
-				
-				$attach_sql = array(
-					'post_msg_id'		=> $data['post_id'],
-					'topic_id'			=> $data['topic_id'],
-					'in_message'		=> 0,
-					'poster_id'			=> $poster_id,
-					'physical_filename'	=> basename($attach_row['physical_filename']),
-					'real_filename'		=> basename($attach_row['real_filename']),
-					'download_count'	=> 0,
-					'comment'			=> $attach_row['comment'],
-					'extension'			=> $attach_row['extension'],
-					'mimetype'			=> $attach_row['mimetype'],
-					'filesize'			=> $attach_row['filesize'],
-					'filetime'			=> $attach_row['filetime'],
-					'thumbnail'			=> $attach_row['thumbnail']
-				);
-
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql));
-
-				$space_taken += $attach_row['filesize'];
-				$files_added++;
-			}
-		}
-
-		if (!empty($data['attachment_data']))
-		{
-			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-				SET post_attachment = 1
-				WHERE post_id = ' . $data['post_id'];
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
-				SET topic_attachment = 1
-				WHERE topic_id = ' . $data['topic_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-
-		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
-		set_config('num_files', $config['num_files'] + $files_added, true);
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-
-	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
-	{
-		if ($topic_type != POST_GLOBAL)
-		{
-			$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
-		}
-
-		$update = update_last_post_information('topic', $data['topic_id']);
-
-		if (!empty($update))
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
-		}
-	}
-
-	if ($make_global)
-	{
-		$sql_data[FORUMS_FORUMS_TABLE]['stat'][] = implode(', ', update_last_post_information('forum', $data['forum_id']));
-	}
-
-	if ($post_mode == 'edit_topic')
-	{
-		$update = update_last_post_information('topic', $data['topic_id']);
-
-		if (!empty($update))
-		{
-			$sql_data[FORUMS_TOPICS_TABLE]['stat'][] = implode(', ', $update);
-		}
-	}
-
-	// Update total post count, do not consider moderated posts/topics
-	if (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve'))
-	{
-		if ($post_mode == 'post')
-		{
-			set_config('num_topics', $config['num_topics'] + 1, true);
-			set_config('num_posts', $config['num_posts'] + 1, true);
-		}
-
-		if ($post_mode == 'reply')
-		{
-			set_config('num_posts', $config['num_posts'] + 1, true);
-		}
-	}
-
-	// Update forum stats
-	$_CLASS['core_db']->transaction();
-
-	$where_sql = array(FORUMS_POSTS_TABLE => 'post_id = ' . $data['post_id'], FORUMS_TOPICS_TABLE => 'topic_id = ' . $data['topic_id'], FORUMS_FORUMS_TABLE => 'forum_id = ' . $data['forum_id'], CORE_USERS_TABLE => 'user_id = ' . $_CLASS['core_user']->data['user_id']);
-
-	foreach ($sql_data as $table => $update_ary)
-	{
-		if (isset($update_ary['stat']) && implode('', $update_ary['stat']))
-		{
-			$_CLASS['core_db']->query("UPDATE $table SET " . implode(', ', $update_ary['stat']) . ' WHERE ' . $where_sql[$table]);
-		}
-	}
-
-	// Delete topic shadows (if any exist). We do not need a shadow topic for an global announcement
-	if ($make_global)
-	{
-		$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_TOPICS_TABLE . '
-			WHERE topic_moved_id = ' . $data['topic_id']);
-	}
-
-	// Fulltext parse
-	if ($update_message && $data['enable_indexing'])
-	{
-		$search = new fulltext_search();
-		$result = $search->add($mode, $data['post_id'], $data['message'], $subject);
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-
-	// Delete draft if post was loaded...
-	$draft_id = request_var('draft_loaded', 0);
-	if ($draft_id)
-	{
-		$_CLASS['core_db']->query('DELETE FROM ' . DRAFTS_TABLE . " WHERE draft_id = $draft_id AND user_id = " . $_CLASS['core_user']->data['user_id']);
-	}
-
-	// Topic Notification
-	if (!$data['notify_set'] && $data['notify'])
-	{
-		$notify_sql = array(
-			'user_id'		=> $_CLASS['core_user']->data['user_id'],
-			'forum_id'		=> $data['forum_id'],
-			'topic_id'		=> $data['topic_id'],
-			'notify_type'	=> $poster_id,
-			'notify_status'	=> 0,
-		);
-				
-		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $notify_sql));
-
-		unset($notify_sql);
-	}
-	else if ($data['notify_set'] && !$data['notify'])
-	{
-		$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . '
-			WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
-				AND topic_id = ' . $data['topic_id'];
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Mark this topic as read and posted to.
-	//markread('topic', $data['forum_id'], $data['topic_id'], $data['post_time']);
-
-	// Send Notifications
-	if ($mode != 'edit' && $mode != 'delete' && (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')))
-	{
-		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
-	}
-
-	if ($mode == 'post')
-	{
-		$url = (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? generate_link('Forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('Forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
-	}
-	else
-	{
-		$url = (!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ?  generate_link("Forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}&amp;p={$data['post_id']}#{$data['post_id']}") : generate_link("Forums&amp;file=viewtopic&amp;f={$data['forum_id']}&amp;t={$data['topic_id']}");
-	}
-
-	$_CLASS['core_display']->meta_refresh(3, $url);
-
-	$message = ($_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) && !$_CLASS['auth']->acl_get('m_approve')) ? (($mode == 'edit') ? 'POST_EDITED_MOD' : 'POST_STORED_MOD') : (($mode == 'edit') ? 'POST_EDITED' : 'POST_STORED');
-	$message = $_CLASS['core_user']->lang[$message] . ((!$_CLASS['auth']->acl_get('f_moderate', $data['forum_id']) || $_CLASS['auth']->acl_get('m_approve')) ? '<br /><br />' . sprintf($_CLASS['core_user']->lang['VIEW_MESSAGE'], '<a href="' . $url . '">', '</a>') : '') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $data['forum_id']) . '">', '</a>');
-	trigger_error($message);
-}
-
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -111,7 +111,7 @@
 }
 
 // Check if links are checked for permission
-if (!$_CLASS['auth']->acl_get('f_read', $forum_id))
+if (!$_CLASS['forums_auth']->acl_get('f_read', $forum_id))
 {
 	if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
 	{
@@ -146,8 +146,6 @@
 // Add Images
 $_CLASS['core_user']->add_img();
 
-
-
 // Build navigation links
 generate_forum_nav($forum_data);
 
@@ -155,15 +153,16 @@
 generate_forum_rules($forum_data);
 
 // Do we have subforums?
-$active_forum_ary = array();
+$active_forum_ary = $moderators = array();
 
 if ($forum_data['left_id'] != $forum_data['right_id'] - 1)
 {
-	$active_forum_ary = display_forums($forum_data);
+	list($active_forum_ary, $moderators) = display_forums($forum_data, $config['load_moderators'], $config['load_moderators']);
 }
 else
 {
 	$_CLASS['core_template']->assign('S_HAS_SUBFORUM', false);
+	$moderators = get_moderators($forum_id);
 }
 
 // Not postable forum or showing active topics?
@@ -183,8 +182,6 @@
 	$_CLASS['core_template']->display('modules/forums/viewforum_body.html');
 }
 
-$moderators = get_moderators($forum_id);
-
 // Handle marking posts
 if ($mark_read == 'topics')
 {
@@ -222,7 +219,7 @@
 
 */
 
-if ($_CLASS['auth']->acl_get('f_subscribe', $forum_id))
+if ($_CLASS['forums_auth']->acl_get('f_subscribe', $forum_id))
 {
 	$notify_status = isset($forum_data['notify_status']) ? $forum_data['notify_status'] : null;
 	$s_watching_forum = watch_topic_forum('forum', $_CLASS['core_user']->data['user_id'], $forum_id, 0, $notify_status);
@@ -255,7 +252,7 @@
 		WHERE forum_id = $forum_id
 			AND topic_type NOT IN (" . POST_ANNOUNCE . ', ' . POST_GLOBAL . ")
 			AND topic_last_post_time >= $min_post_time
-		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
+		" . (($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND topic_approved = 1');
 	$result = $_CLASS['core_db']->query($sql);
 	$topics_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? (int) $row['num_topics'] : 0;
 	$_CLASS['core_db']->free_result($result);
@@ -269,7 +266,7 @@
 }
 else
 {
-	if ($_CLASS['auth']->acl_get('m_approve', $forum_id))
+	if ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id))
 	{
 		$topics_count = ($forum_data['forum_topics_real']) ? $forum_data['forum_topics_real'] : 1;
 	}
@@ -296,8 +293,8 @@
 
 	'POST_IMG' 			=> ($forum_data['forum_status'] == ITEM_LOCKED) ? $_CLASS['core_user']->img('btn_locked', $post_alt) : $_CLASS['core_user']->img('btn_post', $post_alt),
 
-	'MOD_TOPIC_LOCK'	=>	$_CLASS['auth']->acl_get('m_lock', $forum_id),
-	'MOD_TOPIC_TITLE'	=>	$_CLASS['auth']->acl_get('m_', $forum_id),
+	'MOD_TOPIC_LOCK'	=>	$_CLASS['forums_auth']->acl_get('m_lock', $forum_id),
+	'MOD_TOPIC_TITLE'	=>	$_CLASS['forums_auth']->acl_get('m_', $forum_id),
 
 	'FORUM_IMG'			=>	$_CLASS['core_user']->img('forum', 'NO_NEW_POSTS'),
 	'FORUM_NEW_IMG'		=>	$_CLASS['core_user']->img('forum_new', 'NEW_POSTS'),
@@ -330,10 +327,10 @@
 	'S_WATCH_FORUM_LINK'	=> $s_watching_forum['link'],
 	'S_WATCH_FORUM_TITLE'	=> $s_watching_forum['title'],
 	'S_FORUM_ACTION' 		=> generate_link("forums&amp;file=viewforum&amp;f=$forum_id&amp;start=$start"),
-	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
+	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['forums_auth']->acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=> generate_link('forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_MCP' 			=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
+	'U_MCP' 			=> ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? generate_link("forums&amp;file=mcp&amp;f=$forum_id&amp;mode=forum_view") : '', 
 	'U_POST_NEW_TOPIC'	=> generate_link('forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id), 
 	'U_VIEW_FORUM'		=> generate_link("forums&amp;file=viewforum&amp;f=$forum_id&amp;$u_sort_param&amp;start=$start"), 
 	'U_MARK_TOPICS' 	=> generate_link("forums&amp;file=viewforum&amp;f=$forum_id&amp;mark=topics"))
@@ -343,7 +340,7 @@
 $icons = obtain_icons();
 
 // Grab all topic data
-$rowset = $announcement_list = $topic_list = array();
+$rowset = $announcement_list = $topic_list = $global_announce_list = array();
 
 $sql_from = FORUMS_TOPICS_TABLE.' t ';
 $sql_select = '';
@@ -354,7 +351,7 @@
 	$sql_select .= ', tt.mark_time';
 }
 
-$sql_approved = $_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
+$sql_approved = $_CLASS['forums_auth']->acl_get('m_approve', $forum_id) ? '' : 'AND t.topic_approved = 1';
 
 if ($forum_data['forum_type'] == FORUM_POST)
 {
@@ -370,6 +367,11 @@
 	{
 		$rowset[$row['topic_id']] = $row;
 		$announcement_list[] = $row['topic_id'];
+
+		if ($row['topic_type'] == POST_GLOBAL)
+		{
+			$global_announce_list[$row['topic_id']] = true;
+		}
 	}
 	$_CLASS['core_db']->free_result($result);
 }
@@ -410,13 +412,43 @@
 	ORDER BY t.topic_type " . ((!$store_reverse) ? 'DESC' : 'ASC') . ', ' . $sql_sort_order;
 $result = $_CLASS['core_db']->query_limit($sql, $sql_limit, $sql_start);
 
+$shadow_topic_list = array();
 while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	$rowset[$row['topic_id']] = $row;
 	$topic_list[] = $row['topic_id'];
+	
+	if ($row['topic_status'] == ITEM_MOVED)
+	{
+		$shadow_topic_list[$row['topic_moved_id']] = $row['topic_id'];
+	}
 }
 $_CLASS['core_db']->free_result($result);
 
+// If we have some shadow topics, update the rowset to reflect their topic informations
+if (!empty($shadow_topic_list))
+{
+	$sql = 'SELECT *
+		FROM ' . FORUMS_TOPICS_TABLE . '
+		WHERE topic_id IN (' . implode(', ', array_keys($shadow_topic_list)) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$orig_topic_id = $shadow_topic_list[$row['topic_id']];
+
+		// We want to retain some values
+		$row = array_merge($row, array(
+			'topic_moved_id'	=> $rowset[$orig_topic_id]['topic_moved_id'],
+			'topic_status'		=> $rowset[$orig_topic_id]['topic_status'])
+		);
+
+		$rowset[$orig_topic_id] = $row;
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+unset($shadow_topic_list);
+
 $topic_list = ($store_reverse) ? array_merge($announcement_list, array_reverse($topic_list)) : array_merge($announcement_list, $topic_list);
 unset($announcement_list);
 
@@ -478,24 +510,25 @@
 		$s_type_switch_test = ($row['topic_type'] == POST_ANNOUNCE || $row['topic_type'] == POST_GLOBAL) ? 1 : 0;
 
 		// Replies
-		$replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
+		$replies = ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? (int) $row['topic_replies_real'] : (int) $row['topic_replies'];
 
 		if ($row['topic_status'] == ITEM_MOVED)
 		{
 // currently no marking supported
 			$topic_id = $row['topic_moved_id'];
+			$mark_time = $_CLASS['core_user']->time;
 		}
 
 		// Get folder img, topic status/type related informations
 		$folder_img = $folder_alt = $topic_type = '';
-	//	$status = topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 		topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
 
+		$topic_unapproved = (!$row['topic_approved'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? true : false;
+		$posts_unapproved = ($row['topic_approved'] && $row['topic_replies'] < $row['topic_replies_real'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? true : false;
+
 		$newest_post_img = ($unread_topic) ? '<a href="' . generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=unread#unread") . '">' . $_CLASS['core_user']->img('icon_post_newest', 'VIEW_NEWEST_POST') . '</a> ' : '';
 
-		// Generate all the URIs ...
 		$view_topic_url = 'forums&amp;file=viewtopic&amp;t='.$topic_id;
-
 		$pagination = generate_pagination('forums&amp;file=viewtopic&amp;&amp;t='.$topic_id, $replies, $config['posts_per_page']);
 
 		// Send vars to template
@@ -509,7 +542,7 @@
 			'FIRST_POST_TIME' 	=> $_CLASS['core_user']->format_date($row['topic_time']),
 			'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 			'LAST_VIEW_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_view_time']),
-			'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name'] != '') ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
+			'LAST_POST_AUTHOR' 	=> ($row['topic_last_poster_name']) ? $row['topic_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'],
 
 			'PAGINATION'		=> $pagination['formated'],
 			'PAGINATION_ARRAY'	=> $pagination['array'],
@@ -523,28 +556,37 @@
 
 			'LAST_POST_IMG' 	=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'),
 			'NEWEST_POST_IMG' 	=> $newest_post_img,
+
 			'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 			//'TOPIC_FOLDER_IMG_SRC'	=> $_CLASS['core_user']->img($folder_img, $folder_alt, false, '', 'src'),
-
 			'TOPIC_ICON_IMG'        => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
 			'TOPIC_ICON_IMG_WIDTH'  => empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['width'],
 			'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' :  $icons[$row['icon_id']]['height'],
-	
-			'ATTACH_ICON_IMG'       => ($row['topic_attachment'] && $_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id)) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+			'ATTACH_ICON_IMG'       => ($row['topic_attachment'] && $_CLASS['forums_auth']->acl_gets(array('f_download', 'u_download'), $forum_id)) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+			'UNAPPROVED_IMG'		=> ($topic_unapproved || $posts_unapproved) ? $_CLASS['core_user']->img('icon_unapproved', ($topic_unapproved) ? 'TOPIC_UNAPPROVED' : 'POSTS_UNAPPROVED') : '',
 
+			'S_TOPIC_UNAPPROVED'	=> $topic_unapproved,
+			'S_POSTS_UNAPPROVED'	=> $posts_unapproved,
+			'S_HAS_POLL'			=> ($row['poll_start']),
+			'S_POST_ANNOUNCE'		=> ($row['topic_type'] == POST_ANNOUNCE),
+			'S_POST_GLOBAL'			=> ($row['topic_type'] == POST_GLOBAL),
+			'S_POST_STICKY'			=> ($row['topic_type'] == POST_STICKY),
+			'S_TOPIC_LOCKED'		=> ($row['topic_status'] == ITEM_LOCKED),
+			'S_TOPIC_MOVED'			=> ($row['topic_status'] == ITEM_MOVED),
+			
 			'S_TOPIC_TYPE'			=> $row['topic_type'], 
 			'S_UNREAD_TOPIC'		=> $unread_topic,
+			'S_TOPIC_REPORTED'		=> ($row['topic_reported'] && $_CLASS['forums_auth']->acl_get('m_report', $forum_id)),
+			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)),
 
-			'S_TOPIC_REPORTED'		=> ($row['topic_reported'] && $_CLASS['auth']->acl_get('m_report', $forum_id)),
-			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['auth']->acl_get('m_approve', $forum_id)),
+			'U_NEWEST_POST'			=> generate_link($view_topic_url . '&amp;view=unread#unread'),
+			'U_LAST_POST'			=> generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
+			'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id']&& $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
+			'U_VIEW_TOPIC'			=> generate_link($view_topic_url),
 
-			'U_LAST_POST'       => generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
-			'U_LAST_POST_AUTHOR'=> ($row['topic_last_poster_id']) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
-			'U_VIEW_TOPIC'		=> generate_link($view_topic_url),
+			'U_MCP_REPORT'			=> generate_link('forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
+			'U_MCP_QUEUE'       	=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
 
-			'U_MCP_REPORT'		=> generate_link('forums&amp;file=mcp&amp;mode=reports&amp;t='.$topic_id),
-			'U_MCP_QUEUE'       => generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;t='.$topic_id),
-
 			'S_TOPIC_TYPE_SWITCH'=> ($s_type_switch == $s_type_switch_test) ? -1 : $s_type_switch_test)
 		);
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-07-25 17:08:28 UTC (rev 178)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-04 13:47:39 UTC (rev 179)
@@ -162,13 +162,7 @@
 	}
 }
 
-$sql = 'SELECT t.topic_id, t.forum_id, t.topic_title, t.topic_attachment, t.topic_status, t.topic_approved,
-	t.topic_replies_real, t.topic_replies, t.topic_first_post_id, t.topic_last_post_id, t.topic_last_poster_id,
-	t.topic_last_post_time, t.topic_poster, t.topic_time, t.topic_time_limit, t.topic_type, t.topic_bumped, 
-	t.topic_bumper, t.poll_max_options, t.poll_start, t.poll_length, t.poll_title, t.poll_vote_change,
-	f.forum_name, f.forum_desc, f.forum_parents, f.parent_id, f.left_id, f.right_id, f.forum_status, f.forum_type,
-	f.forum_id, f.forum_password, f.forum_rules, f.forum_rules_link, f.forum_rules_flags, f.forum_rules_bbcode_uid,
-	f.forum_rules_bbcode_bitfield' . $extra_fields . '
+$sql = 'SELECT t.*, f.*' . $extra_fields . '
 		FROM ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . " t  $join_sql_table 
 		WHERE t.topic_id = $topic_id
 		AND f.forum_id = $forum_id";
@@ -193,6 +187,13 @@
 	login_box(array('explain' => $_CLASS['core_user']->lang['LOGIN_VIEWFORUM']));
 }
 
+// Forum is passworded ... check whether access has been granted to this
+// user this session, if not show login box
+if ($topic_data['forum_password'])
+{
+	login_forum_box($topic_data);
+}
+
 // Are we watching this topic?
 if (!isset($topic_data['notify_status']))
 {
@@ -245,10 +246,7 @@
 // We make this check here because the correct forum_id is determined
 $topic_replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $topic_data['topic_replies_real'] : (int) $topic_data['topic_replies'];
 
-if (!isset($topic_last_read))
-{
-	$topic_last_read = topic_last_read($topic_id, $forum_id);
-}
+$topic_last_read = topic_last_read($topic_id, $forum_id);
 
 // Check sticky/announcement time limit
 if (($topic_data['topic_type'] == POST_STICKY || $topic_data['topic_type'] == POST_ANNOUNCE) && $topic_data['topic_time_limit'] && $topic_data['topic_time'] + $topic_data['topic_time_limit'] < $_CLASS['core_user']->time)
@@ -256,8 +254,8 @@
 	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
 		SET topic_type = ' . POST_NORMAL . ', topic_time_limit = 0
 		WHERE topic_id = ' . $topic_id;
+	$_CLASS['core_db']->query($sql);
 
-	$_CLASS['core_db']->query($sql);
 	$topic_data['topic_type'] = POST_NORMAL;
 	$topic_data['topic_time_limit'] = 0;
 }
@@ -266,19 +264,13 @@
 $_CLASS['core_user']->add_lang('viewtopic');
 $_CLASS['core_user']->add_img();
 
-// Forum is passworded ... check whether access has been granted to this
-// user this session, if not show login box
-if ($topic_data['forum_password'])
-{
-	login_forum_box($topic_data);
+
+// What is start equal to?
+if ($post_id)
+{
+	$start = floor(($topic_data['prev_posts'] - 1) / $config['posts_per_page']) * $config['posts_per_page'];
 }
 
-// What is start equal to?
-/*if (!empty($post_id))
-{
-	$start = floor(($prev_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
-}*/
-
 // Post ordering options
 $limit_days = array(0 => $_CLASS['core_user']->lang['ALL_POSTS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
 
@@ -301,14 +293,15 @@
 		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
 
 	$result = $_CLASS['core_db']->query($sql);
+	$total_posts = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_posts'] : 0;
+	$_CLASS['core_db']->free_result($result);
 
+	$limit_posts_time = "AND p.post_time >= $min_post_time ";
+
 	if (isset($_POST['sort']))
 	{
 		$start = 0;
 	}
-
-	$total_posts = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_posts'] : 0;
-	$limit_posts_time = "AND p.post_time >= $min_post_time ";
 }
 else
 {
@@ -332,6 +325,12 @@
 	$highlight = urlencode($hilit_words);
 }
 
+// Make sure $start is set to the last page if it exceeds the amount
+if ($start < 0 || $start > $total_posts)
+{
+	$start = ($start < 0) ? 0 : floor(($total_posts - 1) / $config['posts_per_page']) * $config['posts_per_page'];
+}
+
 // General Viewtopic URL for return links
 $viewtopic_url = "forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : '');
 
@@ -350,15 +349,15 @@
 // Generate Forum Rules
 generate_forum_rules($topic_data);
 
-gen_forum_auth_level('topic', $forum_id);
+gen_forum_auth_level('topic', $forum_id, $topic_data['forum_status']);
 
 // Does this topic contain a poll?
-if (!empty($poll_start))
+if (!empty($topic_data['poll_start']))
 {
 	$sql = 'SELECT o.*, p.bbcode_bitfield, p.bbcode_uid
 		FROM ' . FORUMS_POLL_OPTIONS_TABLE . ' o, ' . FORUMS_POSTS_TABLE . " p
 		WHERE o.topic_id = $topic_id 
-			AND p.post_id = $topic_first_post_id
+			AND p.post_id = {$topic_data['topic_first_post_id']}
 			AND p.topic_id = o.topic_id
 		ORDER BY o.poll_option_id";
 	$result = $_CLASS['core_db']->query($sql);
@@ -397,12 +396,12 @@
 	}
 
 	$s_can_vote = (((empty($cur_voted_id) && $_CLASS['auth']->acl_get('f_vote', $forum_id)) || 
-		($_CLASS['auth']->acl_get('f_votechg', $forum_id) && $poll_vote_change)) &&
-		(($poll_length != 0 && $poll_start + $poll_length > time()) || $poll_length == 0) &&
+		($_CLASS['auth']->acl_get('f_votechg', $forum_id) && $topic_data['poll_vote_change'])) &&
+		(($topic_data['poll_length'] != 0 && $topic_data['poll_start'] + $topic_data['poll_length'] > time()) || $topic_data['poll_length'] == 0) &&
 		$topic_data['topic_status'] != ITEM_LOCKED && 
 		$topic_data['forum_status'] != ITEM_LOCKED) ? true : false;
 		
-		$s_display_results = (!$s_can_vote || ($s_can_vote && !empty($cur_voted_id)) || $view == 'viewpoll') ? true : false;
+	$s_display_results = (!$s_can_vote || ($s_can_vote && !empty($cur_voted_id)) || $view == 'viewpoll') ? true : false;
 		
 	if ($update && $s_can_vote)
 	{
@@ -417,55 +416,61 @@
 
 		foreach ($voted_id as $option)
 		{
-			if (in_array($option, $cur_voted_id))
-			{
-				continue;
+			if (in_array($option, $cur_voted_id))
+			{
+				continue;
+			}
+
+			$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . '
+				SET poll_option_total = poll_option_total + 1
+				WHERE poll_option_id = ' . (int) $option . '
+					AND topic_id = ' . (int) $topic_id;
+			$_CLASS['core_db']->query($sql);
+
+			if ($_CLASS['core_user']->is_user)
+			{
+				$sql_ary = array(
+					'topic_id'			=> (int) $topic_id,
+					'poll_option_id'	=> (int) $option,
+					'vote_user_id'		=> (int) $_CLASS['core_user']->data['user_id'],
+					'vote_user_ip'		=> (string) $_CLASS['core_user']->ip,
+				);
+
+				$sql = 'INSERT INTO  ' . POLL_VOTES_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);
+				$_CLASS['core_db']->query($sql);
 			}
-
-			$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . " 
-				SET poll_option_total = poll_option_total + 1 
-				WHERE poll_option_id = $option 
-					AND topic_id = $topic_id";
-			$_CLASS['core_db']->query($sql);
-
-			if ($_CLASS['core_user']->is_user)
-			{
-				$sql = 'INSERT INTO  ' . FORUMS_POLL_VOTES_TABLE . " (topic_id, poll_option_id, vote_user_id, vote_user_ip) 
-					VALUES ($topic_id, $option, " . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."')";
-				$_CLASS['core_db']->query($sql);
-			}
 		}
 
 		foreach ($cur_voted_id as $option)
 		{
 			if (!in_array($option, $voted_id))
 			{
-				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . " 
-					SET poll_option_total = poll_option_total - 1 
-					WHERE poll_option_id = $option 
-						AND topic_id = $topic_id";
+				$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . ' 
+					SET poll_option_total = poll_option_total - 1
+					WHERE poll_option_id = ' . (int) $option . '
+						AND topic_id = ' . (int) $topic_id;
 				$_CLASS['core_db']->query($sql);
 
 				if ($_CLASS['core_user']->is_user)
 				{
-					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . " 
-						WHERE topic_id = $topic_id
-							AND poll_option_id = $option 
-							AND vote_user_id = " . $_CLASS['core_user']->data['user_id'];
+					$sql = 'DELETE FROM ' . FORUMS_POLL_VOTES_TABLE . ' 
+						WHERE topic_id = ' . (int) $topic_id . '
+							AND poll_option_id = ' . (int) $option . '
+							AND vote_user_id = ' . (int) $_CLASS['core_user']->data['user_id'];
 					$_CLASS['core_db']->query($sql);
 				}
 			}
 		}
 
-		if ($_CLASS['core_user']->data['user_id'] == ANONYMOUS)
+		if ($_CLASS['core_user']->data['user_id'] == ANONYMOUS && !$_CLASS['core_user']->is_bot)
 		{
-			$_CLASS['core_user']->set_cookie('poll_' . $topic_id, implode(',', $voted_id), time() + 31536000);
+			$_CLASS['core_user']->set_cookie('poll_' . $topic_id, implode(',', $voted_id), $_CLASS['core_user']->time + 31536000);
 		}
 
 		$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . ' 
-			SET poll_last_vote = ' . time() . " 
-			WHERE topic_id = $topic_id";
-			//, topic_last_post_time = ' . time() . " -- for bumping topics with new votes, ignore for now
+			SET poll_last_vote = ' . $_CLASS['core_user']->time . ' 
+			WHERE topic_id =' . (int)  $topic_id;
+			//, topic_last_post_time = ' . $_CLASS['core_user']->time . " -- for bumping topics with new votes, ignore for now
 		$_CLASS['core_db']->query($sql);
 
 		$_CLASS['core_display']->meta_refresh(5, generate_link("forums&amp;file=viewtopic&amp;t=$topic_id"));
@@ -484,22 +489,32 @@
 	{
 		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
 		$poll_bbcode = new bbcode();
-		
-		$count = count($poll_info);
+	}
+	else
+	{
+		$poll_bbcode = false;
+	}
 
-		for ($i = 0; $i < $count; $i++)
-		{
-			$poll_bbcode->bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
-			$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
-			$poll_info[$i]['poll_option_text'] = str_replace("\n", '<br />', censor_text($poll_info[$i]['poll_option_text']));
+	$count = count($poll_info);
+
+	for ($i = 0; $i < $count; $i++)
+	{
+		if ($poll_bbcode !== false)
+		{
+			$poll_bbcode->bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
 		}
+		$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
+		$poll_info[$i]['poll_option_text'] = str_replace("\n", '<br />', censor_text($poll_info[$i]['poll_option_text']));
+	}
 
-		$poll_bbcode->bbcode_second_pass($poll_title, $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
-		$poll_title = smiley_text($poll_title);
-		$poll_title = str_replace("\n", '<br />', censor_text($poll_title));
+	if ($poll_bbcode !== false)
+	{
+		$poll_bbcode->bbcode_second_pass($topic_data['poll_title'], $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
+	}
+	$topic_data['poll_title'] = smiley_text($topic_data['poll_title']);
+	$topic_data['poll_title'] = str_replace("\n", '<br />', censor_text($topic_data['poll_title']));
 
-		unset($poll_bbcode);
-	}
+	unset($poll_bbcode);
 	
 	foreach ($poll_info as $poll_option)
 	{
@@ -518,18 +533,18 @@
 	}
 
 	$_CLASS['core_template']->assign_array(array(
-		'POLL_QUESTION'		=> $poll_title,
+		'POLL_QUESTION'		=> $topic_data['poll_title'],
 		'TOTAL_VOTES' 		=> $poll_total,
 		'POLL_LEFT_CAP_IMG'	=> $_CLASS['core_user']->img('poll_left'),
 		'POLL_RIGHT_CAP_IMG'=> $_CLASS['core_user']->img('poll_right'),
 
-		'L_MAX_VOTES'		=> ($poll_max_options == 1) ? $_CLASS['core_user']->lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']->lang['MAX_OPTIONS_SELECT'], $poll_max_options), 
-		'L_POLL_LENGTH'		=> ($poll_length) ? sprintf($_CLASS['core_user']->lang['POLL_RUN_TILL'], $_CLASS['core_user']->format_date($poll_length + $poll_start)) : '', 
+		'L_MAX_VOTES'		=> ($topic_data['poll_max_options'] == 1) ? $_CLASS['core_user']->lang['MAX_OPTION_SELECT'] : sprintf($_CLASS['core_user']->lang['MAX_OPTIONS_SELECT'], $topic_data['poll_max_options']), 
+		'L_POLL_LENGTH'		=> ($topic_data['poll_length']) ? sprintf($_CLASS['core_user']->lang['POLL_RUN_TILL'], $_CLASS['core_user']->format_date($topic_data['poll_length'] + $topic_data['poll_start'])) : '', 
 
 		'S_HAS_POLL'		=> true, 
 		'S_CAN_VOTE'		=> $s_can_vote, 
 		'S_DISPLAY_RESULTS'	=> $s_display_results,
-		'S_IS_MULTI_CHOICE'	=> ($poll_max_options > 1) ? true : false, 
+		'S_IS_MULTI_CHOICE'	=> ($topic_data['poll_max_options'] > 1) ? true : false,
 		'S_POLL_ACTION'		=> generate_link($viewtopic_url, false),
 
 		'U_VIEW_RESULTS'	=> generate_link($viewtopic_url . '&amp;view=viewpoll', false))
@@ -543,7 +558,7 @@
 }
 
 // If the user is trying to reach the second half of the topic, fetch it starting from the end
-$store_reverse = FALSE;
+$store_reverse = false;
 $sql_limit = $config['posts_per_page'];
 
 if ($start > $total_posts / 2)
@@ -567,7 +582,7 @@
 }
 
 // Container for user details, only process once
-$post_list = $user_cache = $id_cache = $attachments = $attach_list = $rowset = $update_count = $post_edit_list = array();
+$post_list = $user_cache = $id_cache = $attachments = $attach_list = $rowset = $update_count = $post_edit_list = array();
 $has_attachments = $display_notice = false;
 $bbcode_bitfield = $i = $i_total = 0;
 
@@ -596,7 +611,7 @@
 	trigger_error($_CLASS['core_user']->lang['NO_TOPIC']);
 }
 
-$sql = 'SELECT u.username, u.user_id, u.user_colour, u.user_posts, u.user_from, u.user_website, u.user_email, u.user_icq, u.user_aim, u.user_yim, u.user_jabber, u.user_reg_date, u.user_msnm, u.user_allow_viewemail, u.user_allow_viewonline, u.user_rank, u.user_sig, u.user_sig_bbcode_uid, u.user_sig_bbcode_bitfield, u.user_avatar, u.user_avatar_type, u.user_avatar_width, u.user_avatar_height, z.friend, z.foe, p.*
+$sql = 'SELECT u.*, z.friend, z.foe, p.*
 	FROM ' . FORUMS_POSTS_TABLE . ' p
 	LEFT JOIN ' . ZEBRA_TABLE . ' z ON (z.user_id = ' . $_CLASS['core_user']->data['user_id'] . ' AND z.zebra_id = p.poster_id), ' . CORE_USERS_TABLE . ' u
 	WHERE p.post_id IN (' . implode(', ', $post_list) . ')
@@ -604,6 +619,9 @@
 
 $result = $_CLASS['core_db']->query($sql);
 
+$today = explode('-', date('j-n-Y', $_CLASS['core_user']->time));
+$today = array('day' => (int) $today[0], 'month' => (int) $today[1], 'year' => (int) $today[2]);
+
 // Posts are stored in the $rowset array while $attach_list, $user_cache
 // and the global bbcode_bitfield are built
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -611,12 +629,13 @@
 	$poster_id = $row['poster_id'];
 	$poster	= ($poster_id == ANONYMOUS) ? ((!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST']) : $row['username'];
 
-	if ($view != 'show_all' || ($view != 'show' || $post_id != $row['post_id']))
+	if ($view != 'show' || $post_id != $row['post_id'])
 	{
 		if ($row['foe'])
 		{
 			$rowset[$row['post_id']] = array(
-				'foe'		=> true,
+				'foe'		=> true,
+				'user_id'	=> $row['user_id'],
 				'post_id'	=> $row['post_id'],
 				'poster'	=> $poster,
 			);
@@ -648,7 +667,9 @@
 		'post_edit_time'	=> $row['post_edit_time'],
 		'post_edit_reason'	=> $row['post_edit_reason'],
 		'post_edit_user'	=> $row['post_edit_user'],
-		'icon_id'			=> $row['icon_id'],
+		
+		// Make sure the icon actually exists
+		'icon_id'			=> (isset($icons[$row['icon_id']]['img'], $icons[$row['icon_id']]['height'], $icons[$row['icon_id']]['width'])) ? $row['icon_id'] : 0,
 		'post_attachment'	=> $row['post_attachment'],
 		'post_approved'		=> $row['post_approved'],
 		'post_reported'		=> $row['post_reported'],
@@ -662,12 +683,12 @@
 	);
 
 	// Define the global bbcode bitfield, will be used to load bbcodes
-	$bbcode_bitfield |= $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
 
 	// Is a signature attached? Are we going to display it?
 	if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->user_data_get('viewsigs'))
 	{
-		$bbcode_bitfield |= $row['user_sig_bbcode_bitfield'];
+		$bbcode_bitfield = $bbcode_bitfield | $row['user_sig_bbcode_bitfield'];
 	}
 
 	// Cache various user specific data ... so we don't have to recompute
@@ -688,6 +709,7 @@
 				'avatar'		=> '',
 				'rank_title'	=> '',
 				'rank_image'	=> '',
+				'rank_image_src'	=> '',
 				'sig'			=> '',
 				'posts'			=> '',
 				'profile'		=> '',
@@ -701,7 +723,10 @@
 				'yim'			=> '',
 				'jabber'		=> '',
 				'search'		=> '',
-				'username'		=> ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster
+				'username'		=> ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster,
+				'age'			=> '',
+
+				'warnings'		=> 0,
 			);
 		}
 		else
@@ -718,14 +743,23 @@
 			$user_cache[$poster_id] = array(
 				'joined'				=> $_CLASS['core_user']->format_date($row['user_reg_date'], $_CLASS['core_user']->lang['DATE_FORMAT']),
 				'posts'					=> $row['user_posts'],
+				'warnings'		=> (isset($row['user_warnings'])) ? $row['user_warnings'] : 0,
 				'from'					=> $row['user_from'],
+
 				'sig'					=> $user_sig,
 				'sig_bbcode_uid'		=> ($user_sig) ? $row['user_sig_bbcode_uid'] : '',
 				'sig_bbcode_bitfield'	=> ($user_sig) ? $row['user_sig_bbcode_bitfield'] : '',
-				'viewonline'			=> $row['user_allow_viewonline'], 
+
+				'viewonline'			=> $row['user_allow_viewonline'],
+
 				'avatar'				=> '',
-				'online'				=> false,
+				'age'					=> '',
 
+				'rank_title'		=> '',
+				'rank_image'		=> '',
+				'rank_image_src'	=> '',
+
+				'online'		=> false,
 				'profile'		=> generate_link("members_list&amp;mode=viewprofile&amp;u=$poster_id"),
 				'www'			=> $row['user_website'],
 				'aim'			=> ($row['user_aim']) ? generate_link('members_list&amp;mode=contact&amp;action=aim&amp;u='.$poster_id) : '',
@@ -757,11 +791,13 @@
 			{
 				$user_cache[$poster_id]['rank_title'] = (isset($ranks['special'][$row['user_rank']])) ? $ranks['special'][$row['user_rank']]['rank_title'] : '';
 				$user_cache[$poster_id]['rank_image'] = (!empty($ranks['special'][$row['user_rank']]['rank_image'])) ? '<img src="' . $config['ranks_path'] . '/' . $ranks['special'][$row['user_rank']]['rank_image'] . '" border="0" alt="' . $ranks['special'][$row['user_rank']]['rank_title'] . '" title="' . $ranks['special'][$row['user_rank']]['rank_title'] . '" /><br />' : '';
+				$user_cache[$poster_id]['rank_image_src'] = (!empty($ranks['special'][$row['user_rank']]['rank_image'])) ? $config['ranks_path'] . '/' . $ranks['special'][$row['user_rank']]['rank_image'] : '';
+
 			}
 			else
 			{
-				$user_cache[$poster_id]['rank_title'] = '';
-				$user_cache[$poster_id]['rank_image'] = '';
+				$user_cache[$poster_id]['rank_title'] = $user_cache[$poster_id]['rank_image'] = '';
+				$user_cache[$poster_id]['rank_image_src'] = '';
 				
 				/*
 				Well we kind of do need this
@@ -773,7 +809,7 @@
 						{
 							$user_cache[$poster_id]['rank_title'] = $rank['rank_title'];
 							$user_cache[$poster_id]['rank_image'] = (!empty($rank['rank_image'])) ? '<img src="' . $config['ranks_path'] . '/' . $rank['rank_image'] . '" border="0" alt="' . $rank['rank_title'] . '" title="' . $rank['rank_title'] . '" /><br />' : '';
-
+							$user_cache[$poster_id]['rank_image_src'] = (!empty($rank['rank_image'])) ? $config['ranks_path'] . '/' . $rank['rank_image'] : '';
 							break;
 						}
 					}
@@ -792,7 +828,8 @@
 
 			if (!empty($row['user_icq']))
 			{
-				$user_cache[$poster_id]['icq'] =  generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$poster_id);
+				//$user_cache[$poster_id]['icq'] =  generate_link('members_list&amp;mode=contact&amp;action=icq&amp;u='.$poster_id);
+				$user_cache[$poster_id]['icq'] = 'http://www.icq.com/people/webmsg.php?to=' . $row['user_icq'];
 				$user_cache[$poster_id]['icq_status_img'] = '<img src="http://web.icq.com/whitepages/online?icq=' . $row['user_icq'] . '&amp;img=5" width="18" height="18" border="0" />';
 			}
 			else
@@ -800,10 +837,21 @@
 				$user_cache[$poster_id]['icq_status_img'] = '';
 				$user_cache[$poster_id]['icq'] = '';
 			}
+			
+			if (!empty($row['user_birthday']))
+			{
+				list($bday_day, $bday_month, $bday_year) = array_map('intval', explode('-', $row['user_birthday']));
+
+				if ($bday_year)
+				{
+					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - (($today['month'] - $bday_month < 0) ? 1 : (($today['day'] - $bday_day < 0) ? 1 : 0)));
+				}
+			}
 		}
 	}
 }
 $_CLASS['core_db']->free_result($result);
+unset($today);
 
 // Generate online information for user
 if ($config['load_onlinetrack'] && !empty($id_cache))
@@ -821,6 +869,7 @@
 	{
 		$user_cache[$row['session_user_id']]['online'] = (!$row['session_hidden'] && $row['online_time'] > $online_time);
 	}
+	$_CLASS['core_db']->free_result($result);
 }
 unset($id_cache);
 
@@ -829,8 +878,6 @@
 {
 	if ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id))
 	{
-		include(SITE_FILE_ROOT.'includes/forums/functions_display.php');
-
 		$sql = 'SELECT * 
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 			WHERE post_msg_id IN (' . implode(', ', $attach_list) . ')
@@ -870,6 +917,7 @@
 						WHERE topic_id = $topic_id";
 					$_CLASS['core_db']->query($sql);
 				}
+				$_CLASS['core_db']->free_result($result);
 			}
 			else
 			{
@@ -899,7 +947,7 @@
 // Instantiate BBCode if need be
 if ($bbcode_bitfield)
 {
-	require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 
@@ -914,7 +962,6 @@
 for ($i = 0; $i < $count; ++$i)
 {
 	$row =& $rowset[$post_list[$i]];
-	$force_encoding = '';
 
 	//is poster is on the users ignore list ?
 	if (!empty($row['foe']))
@@ -939,12 +986,9 @@
 
 		$user_cache[$poster_id]['sig'] = smiley_text($user_cache[$poster_id]['sig']);
 		$user_cache[$poster_id]['sig'] = str_replace("\n", '<br />', censor_text($user_cache[$poster_id]['sig']));
-		$user_cache[$poster_id]['sig_parsed'] = TRUE;
+		$user_cache[$poster_id]['sig_parsed'] = true;
 	}
 
-	// Parse the message and subject
-	$row['post_text'] = str_replace("\n", '<br />', $row['post_text']);
-
 	// If the board has HTML off but the post has HTML on then we process it, else leave it alone
 	if ($row['enable_html'] && (!$config['allow_html'] || !$_CLASS['auth']->acl_get('f_html', $forum_id)))
 	{
@@ -974,9 +1018,7 @@
 	// Highlight active words (primarily for search)
 	if ($highlight_match)
 	{
-		// This was shamelessly 'borrowed' from volker at multiartstudio dot de
-		// via php.net's annotated manual
-		$row['post_text'] = str_replace('\"', '"', substr(preg_replace('#(\>(((?>([^><]+|(?R)))*)\<))#se', "preg_replace('#\b(" . str_replace('\\', '\\\\', addslashes($highlight_match)) . ")\b#i', '<span class=\"posthilit\">\\\\1</span>', '\\0')", '>' . $row['post_text'] . '<'), 1, -1));
+		$message = preg_replace('#(?!<.*)(?<!\w)(' . $highlight_match . ')(?!\w|[^<>]*>)#i', '<span class="posthilit">\1</span>', $message);
 	}
 
 	if ($row['enable_html'] && ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id)))
@@ -984,12 +1026,16 @@
 		// Remove Comments from post content
 		$row['post_text'] = preg_replace('#<!\-\-(.*?)\-\->#is', '', $row['post_text']);
 	}
-	
+
+	// Replace naughty words such as farty pants
+	$row['post_subject'] = censor_text($row['post_subject']);
+	$row['post_text'] = str_replace("\n", '<br />', censor_text($row['post_text']));
+
 	// Editing information
 	if (($row['post_edit_count'] && $config['display_last_edited']) || $row['post_edit_reason'])
 	{
 		// Get usernames for all following posts if not already stored
-		if (empty($post_edit_list) && $row['post_edit_reason'])
+		if (empty($post_edit_list) && ($row['post_edit_reason'] || ($row['post_edit_user'] && !isset($user_cache[$row['post_edit_user']]))))
 		{
 			// Remove all post_ids already parsed (we do not have to check them)
 			$post_storage_list = (!$store_reverse) ? array_slice($post_list, $i) : array_slice(array_reverse($post_list), $i);
@@ -999,22 +1045,35 @@
 				WHERE p.post_id IN (' . implode(', ', $post_storage_list) . ")
 					AND p.post_edit_count <> 0
 					AND p.post_edit_user <> 0
-					AND p.post_edit_reason <> ''
 					AND p.post_edit_user = u.user_id";
 			$result2 = $_CLASS['core_db']->query($sql);
 			while ($user_edit_row = $_CLASS['core_db']->fetch_row_assoc($result2))
 			{
+				$user_edit_row['username'] = ($user_edit_row['user_colour']) ? '<span style="color:#' . $user_edit_row['user_colour'] . '">' . $user_edit_row['username'] . '</span>' : $user_edit_row['username'];
 				$post_edit_list[$user_edit_row['user_id']] = $user_edit_row;
 			}
 			$_CLASS['core_db']->free_result($result2);
 			
 			unset($post_storage_list);
 		}
+
 		$l_edit_time_total = ($row['post_edit_count'] == 1) ? $_CLASS['core_user']->lang['EDITED_TIME_TOTAL'] : $_CLASS['core_user']->lang['EDITED_TIMES_TOTAL'];
 
-		$user_edit_row = ($row['post_edit_reason']) ? $post_edit_list[$row['post_edit_user']] : array();
-
-		$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : (($user_edit_row['user_colour']) ? '<span style="color:#' . $user_edit_row['user_colour'] . '">' . $user_edit_row['username'] . '</span>' : $user_edit_row['username']), $_CLASS['core_user']->format_date($row['post_edit_time']), $row['post_edit_count']);
+		if ($row['post_edit_reason'])
+		{
+			$user_edit_row = $post_edit_list[$row['post_edit_user']];
+
+			$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : $user_edit_row['username'], $_CLASS['core_user']->format_date($row['post_edit_time']), $row['post_edit_count']);
+		}
+		else
+		{
+			if ($row['post_edit_user'] && !isset($user_cache[$row['post_edit_user']]))
+			{
+				$user_cache[$row['post_edit_user']] = $post_edit_list[$row['post_edit_user']];
+			}
+
+			$l_edited_by = sprintf($l_edit_time_total, (!$row['post_edit_user']) ? $row['poster'] : $user_cache[$row['post_edit_user']]['username'], $_CLASS['core_user']->format_date($row['post_edit_time']), $row['post_edit_count']);
+		}
 	}
 	else
 	{
@@ -1022,10 +1081,11 @@
 	}
 
 	// Bump information
-	if ($topic_data['topic_bumped'] && $row['post_id'] == $topic_data['topic_last_post_id'])
+	if ($topic_data['topic_bumped'] && $row['post_id'] == $topic_data['topic_last_post_id'] && isset($user_cache[$topic_data['topic_bumper']]) )
 	{
-		// It is safe to grab the username from the user cache array, we are at the last 
-		// post and only the topic poster and last poster are allowed to bump
+		// It is safe to grab the username from the user cache array, we are at the last
+		// post and only the topic poster and last poster are allowed to bump. However, a
+		// check is still needed incase an admin bumped the topic (but didn't post in the topic)
 		$l_bumped_by = '<br /><br />' . sprintf($_CLASS['core_user']->lang['BUMPED_BY'], $user_cache[$topic_data['topic_bumper']]['username'], $_CLASS['core_user']->format_date($topic_data['topic_last_post_time']));
 	}
 	else
@@ -1048,36 +1108,39 @@
 		'POSTER_NAME' 	=> $row['poster'],
 		'POSTER_RANK' 	=> $user_cache[$poster_id]['rank_title'],
 		'RANK_IMAGE' 	=> $user_cache[$poster_id]['rank_image'],
-		'POSTER_JOINED' => $user_cache[$poster_id]['joined'],
-		'POSTER_POSTS' 	=> $user_cache[$poster_id]['posts'],
-		'POSTER_FROM' 	=> $user_cache[$poster_id]['from'],
-		'POSTER_AVATAR' => $user_cache[$poster_id]['avatar'],
+		'RANK_IMAGE_SRC'	=> $user_cache[$poster_id]['rank_image_src'],
+		'POSTER_JOINED'		=> $user_cache[$poster_id]['joined'],
+		'POSTER_POSTS'		=> $user_cache[$poster_id]['posts'],
+		'POSTER_FROM'		=> $user_cache[$poster_id]['from'],
+		'POSTER_AVATAR'		=> $user_cache[$poster_id]['avatar'],
+		'POSTER_WARNINGS'	=> $user_cache[$poster_id]['warnings'],
+		'POSTER_AGE'		=> $user_cache[$poster_id]['age'],
 		
 		'POST_DATE' 	=> $_CLASS['core_user']->format_date($row['post_time']),
-		'POST_SUBJECT' 	=> censor_text($row['post_subject']),
-		'MESSAGE' 		=> censor_text($row['post_text']),
+		'POST_SUBJECT' 	=> $row['post_subject'],
+		'MESSAGE' 		=> $row['post_text'],
 		'SIGNATURE' 	=> ($row['enable_sig']) ? $user_cache[$poster_id]['sig'] : '',
 		'EDITED_MESSAGE'=> $l_edited_by,
 		'EDIT_REASON'	=> $row['post_edit_reason'],
 		'BUMPED_MESSAGE'=> $l_bumped_by,
 
 		'MINI_POST_IMG'			=> ($unread) ? $_CLASS['core_user']->img('icon_post_new', 'NEW_POST') : $_CLASS['core_user']->img('icon_post', 'POST'),
-		'POST_ICON_IMG'			=> $icons[$row['icon_id']]['img'],
-		'POST_ICON_IMG_WIDTH'   => $icons[$row['icon_id']]['width'],
-		'POST_ICON_IMG_HEIGHT'  => $icons[$row['icon_id']]['height'],
+		'POST_ICON_IMG'			=> (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['img'] : '',
+		'POST_ICON_IMG_WIDTH'	=> (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['width'] : '',
+		'POST_ICON_IMG_HEIGHT'	=> (!empty($row['icon_id'])) ? $icons[$row['icon_id']]['height'] : '',
 		
 		'ICQ_STATUS_IMG'	=> $user_cache[$poster_id]['icq_status_img'],
-
 		'ONLINE_IMG'		=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $_CLASS['core_user']->img('btn_online', 'ONLINE') : $_CLASS['core_user']->img('btn_offline', 'OFFLINE')), 
+		'S_ONLINE'			=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? false : (($user_cache[$poster_id]['online']) ? true : false),
 
-		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_edit', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;p=" . $row['post_id']) : '',
-		'U_QUOTE' 			=> ($_CLASS['auth']->acl_get('f_quote', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=quote&amp;p=" . $row['post_id']) : '', 
-		'U_INFO'            => ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
-		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_delete', $forum_id)) ? generate_link("Forums&amp;file=posting&amp;mode=delete&amp;p=" . $row['post_id']) : '',
+		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_edit', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=edit&amp;p=" . $row['post_id']) : '',
+		'U_QUOTE' 			=> ($_CLASS['auth']->acl_get('f_quote', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=quote&amp;p=" . $row['post_id']) : '', 
+		'U_INFO'            => ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
+		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_delete', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=delete&amp;p=" . $row['post_id']) : '',
 
 		'U_PROFILE' 		=> $user_cache[$poster_id]['profile'],
 		'U_SEARCH' 			=> $user_cache[$poster_id]['search'],
-		'U_PM' 				=> ($poster_id != ANONYMOUS) ? generate_link('Control_Panel&amp;i=pm&amp;mode=compose&amp;action=quote&amp;q=1&amp;p=' . $row['post_id']) : '',
+		'U_PM' 				=> ($poster_id != ANONYMOUS) ? generate_link('control_panel&amp;i=pm&amp;mode=compose&amp;action=quote&amp;q=1&amp;p=' . $row['post_id']) : '',
 		'U_EMAIL' 			=> $user_cache[$poster_id]['email'],
 		'U_WWW' 			=> $user_cache[$poster_id]['www'],
 		'U_ICQ' 			=> $user_cache[$poster_id]['icq'],
@@ -1086,22 +1149,26 @@
 		'U_YIM' 			=> $user_cache[$poster_id]['yim'],
 		'U_JABBER'			=> $user_cache[$poster_id]['jabber'], 
 
-		'U_REPORT'			=> generate_link('Forums&amp;file=report&amp;p=' . $row['post_id']),
-		'U_MCP_REPORT'		=> ($_CLASS['auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MCP_APPROVE'		=> ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
-		'U_MCP_DETAILS'		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('Forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MINI_POST'		=> generate_link('Forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
+		'U_REPORT'			=> generate_link('forums&amp;file=report&amp;p=' . $row['post_id']),
+		'U_MCP_REPORT'		=> ($_CLASS['auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MCP_APPROVE'		=> ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
+		'U_MCP_DETAILS'		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MINI_POST'		=> generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
 		'U_NEXT_POST_ID'	=> ($i < $i_total && isset($rowset[$i + 1])) ? $rowset[$i + 1]['post_id'] : '', 
 		'U_PREV_POST_ID'	=> $prev_post_id, 
+
 		'POST_ID'           => $row['post_id'],
-		'S_IGNORE_POST' 	=> false, 
-		
+
+		//'U_NOTES'			=> ($_CLASS['auth']->acl_getf_global('m_')) ? generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $poster_id) : '',
+		//'U_WARN'			=> ($_CLASS['auth']->acl_getf_global('m_warn') && $poster_id != $_CLASS['core_user']->data['user_id']) ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_post&amp;f=' . $forum_id . '&amp;p=' . $row['post_id']) : '',
+
 		'S_POST_UNAPPROVED'	=> !$row['post_approved'],
-		'S_POST_REPORTED'	=> ($row['post_reported'] && $_CLASS['auth']->acl_get('m_', $forum_id)) ? TRUE : FALSE,
-		'S_DISPLAY_NOTICE'	=> ($display_notice && $row['post_attachment']) ? true : false, 
+		'S_POST_REPORTED'	=> ($row['post_reported'] && $_CLASS['auth']->acl_get('m_', $forum_id)),
+		'S_DISPLAY_NOTICE'	=> ($display_notice && $row['post_attachment']), 
 		'S_FRIEND'			=> $row['friend'],
 		'S_UNREAD_POST'		=> $unread,
 		'S_FIRST_UNREAD'	=> false,
+		'S_IGNORE_POST'		=> false
 	);
 
 	if ($unread && !$first_unread_makred)
@@ -1115,11 +1182,35 @@
 	
 	$prev_post_id = $row['post_id'];
 
-	unset($rowset[$i], $attachments[$row['post_id']]);
+	unset($postrow, $rowset[$i], $attachments[$row['post_id']]);
 }
 
 unset($rowset, $user_cache);
 
+
+// Update topic view and if necessary attachment view counters ... but only
+// if this is the first 'page view'
+
+//mb_strpos() should never be 0 here
+if (!mb_strpos($_CLASS['core_user']->data['session_url'], '&amp;t='.$topic_id))
+{
+	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
+		SET topic_views = topic_views + 1, topic_last_view_time = ' . $_CLASS['core_user']->time . "
+		WHERE topic_id = $topic_id";
+	$_CLASS['core_db']->query($sql);
+
+	// Update the attachment download counts
+	if (!empty($update_count))
+	{
+		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
+			SET download_count = download_count + 1 
+			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+}
+
+$allow_change_type = ($_CLASS['auth']->acl_get('m_', $forum_id) || ($_CLASS['core_user']-is_user && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? true : false;
+
 // Quick mod tools
 $topic_mod = '';
 $topic_mod .= ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '<option value="lock">' . $_CLASS['core_user']->lang['LOCK_TOPIC'] . '</option>' : '<option value="unlock">' . $_CLASS['core_user']->lang['UNLOCK_TOPIC'] . '</option>') : '';
@@ -1128,13 +1219,14 @@
 $topic_mod .= ($_CLASS['auth']->acl_get('m_split', $forum_id)) ? '<option value="split">' . $_CLASS['core_user']->lang['SPLIT_TOPIC'] . '</option>' : '';
 $topic_mod .= ($_CLASS['auth']->acl_get('m_merge', $forum_id)) ? '<option value="merge">' . $_CLASS['core_user']->lang['MERGE_TOPIC'] . '</option>' : '';
 $topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="fork">' . $_CLASS['core_user']->lang['FORK_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_gets(array('f_sticky', 'f_announce'), $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
 $topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
 
 $pagination = generate_pagination("forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
+
 $topic_data['topic_title'] = censor_text($topic_data['topic_title']);
 
 // Send vars to template
@@ -1171,10 +1263,14 @@
 	'REPORT_IMG'	=> $_CLASS['core_user']->img('btn_report', 'REPORT_POST'),
 	'REPORTED_IMG'	=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED'),
 	'UNAPPROVED_IMG'=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED'),
+	'WARN_IMG'		=> $_CLASS['core_user']->img('btn_warn', 'WARN_USER'),
+
 	
 	'S_SELECT_SORT_DIR' 	=> $s_sort_dir,
 	'S_SELECT_SORT_KEY' 	=> $s_sort_key,
 	'S_SELECT_SORT_DAYS' 	=> $s_limit_days,
+	'S_SINGLE_MODERATOR'	=> (!empty($forum_moderators[$forum_id]) && count($forum_moderators[$forum_id]) > 1) ? false : true,
+
 	'S_TOPIC_ACTION' 		=> generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;start=$start"),
 	'S_TOPIC_MOD' 			=> ($topic_mod) ? '<select name="mode">' . $topic_mod . '</select>' : '',
 	'S_MOD_ACTION' 			=> generate_link("forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1", false, false), 
@@ -1182,14 +1278,14 @@
 	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=> generate_link('forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
-	'U_TOPIC'				=> ($view == 'print') ? generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('Forums&amp;file=viewtopic&amp;t='.$topic_id),
+	'U_TOPIC'				=> ($view == 'print') ? generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id),
 	'U_VIEW_UNREAD_POST'	=> ($first_unread_makred) ? generate_link("forums&amp;file=viewtopic&amp;t=$topic_id#unread") : false,
 	'U_VIEW_TOPIC' 			=> generate_link($viewtopic_url),
 	'U_VIEW_FORUM' 			=> generate_link('forums&amp;file=viewforum&amp;f='.$forum_id),
 	'U_VIEW_OLDER_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous"),
 	'U_VIEW_NEWER_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next"),
 	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
-	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;t='.$topic_id) : '', 
+	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;t='.$topic_id) : '', 
 
 	'S_WATCH_FORUMS'		=> $topic_data['watch_topic'] ? false : true,
 	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'], 
@@ -1200,30 +1296,9 @@
 	
 	'U_POST_NEW_TOPIC' 		=> generate_link('forums&amp;file=posting&amp;mode=post&amp;f='.$forum_id),
 	'U_POST_REPLY_TOPIC' 	=> generate_link("forums&amp;file=posting&amp;mode=reply&amp;t=$topic_id"),
-	'U_BUMP_TOPIC'			=> bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id']) ? generate_link("Forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
+	'U_BUMP_TOPIC'			=> bump_topic_allowed($forum_id, $topic_data['topic_bumped'], $topic_data['topic_last_post_time'], $topic_data['topic_poster'], $topic_data['topic_last_poster_id']) ? generate_link("forums&amp;file=posting&amp;mode=bump&amp;t=$topic_id") : '')
 );
 
-// Update topic view and if necessary attachment view counters ... but only
-// if this is the first 'page view'
-
-//mb_strpos() should never be 0 here
-if (!mb_strpos($_CLASS['core_user']->data['session_url'], '&amp;t='.$topic_id))
-{
-	$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . '
-		SET topic_views = topic_views + 1, topic_last_view_time = ' . $_CLASS['core_user']->time . "
-		WHERE topic_id = $topic_id";
-	$_CLASS['core_db']->query($sql);
-
-	// Update the attachment download counts
-	if (!empty($update_count))
-	{
-		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
-			SET download_count = download_count + 1 
-			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-}
-
 // Mark topics read
 if ($update_mark)
 {



From viperal at mail.berlios.de  Sun Aug  6 22:19:49 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 6 Aug 2006 22:19:49 +0200
Subject: [Viperals-svncheckins] r180 - in cms/trunk: includes
	includes/forums includes/forums/mcp modules/forums
Message-ID: <200608062019.k76KJn6x032191@sheep.berlios.de>

Author: viperal
Date: 2006-08-06 22:19:46 +0200 (Sun, 06 Aug 2006)
New Revision: 180

Added:
   cms/trunk/includes/forums/mcp/mcp_notes.php
Modified:
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_front.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_post.php
   cms/trunk/includes/forums/mcp/mcp_queue.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/functions_user.php
   cms/trunk/modules/forums/main.php
   cms/trunk/modules/forums/mcp.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/functions.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -1119,7 +1119,7 @@
 	$l_online_users = $online_userlist = $l_online_record = $l_online_time = '';
 
 // this isn't required in most places
-	if ($config['load_online'] && $config['load_online_time'])
+	if ($config['load_online'])// && $config['load_online_time']
 	{
 		$logged_visible_online = $logged_hidden_online = $guests_online = 0;
 		$reading_sql = '';
@@ -1214,15 +1214,15 @@
 			switch (${$var_ary[0]})
 			{
 				case 0:
-					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USERS_ZERO_TOTAL'];
+					${$var_ary[1]} = $_CLASS['core_user']->get_lang($l_prefix . '_USERS_ZERO_TOTAL');
 				break;
 
 				case 1:
-					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USER_TOTAL'];
+					${$var_ary[1]} = $_CLASS['core_user']->get_lang($l_prefix . '_USER_TOTAL');
 				break;
 
 				default:
-					${$var_ary[1]} = $_CLASS['core_user']->lang[$l_prefix . '_USERS_TOTAL'];
+					${$var_ary[1]} = $_CLASS['core_user']->get_lang($l_prefix . '_USERS_TOTAL');
 				break;
 			}
 		}
@@ -1270,8 +1270,8 @@
 	// The following assigns all _common_ variables that may be used at any point
 	// in a template.
 	$_CLASS['core_template']->assign_array(array(
-		'LAST_VISIT_DATE' 			=> sprintf($_CLASS['core_user']->lang['YOU_LAST_VISIT'], $s_last_visit),
-		'CURRENT_TIME'				=> sprintf($_CLASS['core_user']->lang['CURRENT_TIME'], $_CLASS['core_user']->format_date(time(), false, true)),
+		'LAST_VISIT_DATE' 			=> sprintf($_CLASS['core_user']->get_lang('YOU_LAST_VISIT'), $s_last_visit),
+		'CURRENT_TIME'				=> sprintf($_CLASS['core_user']->get_lang('CURRENT_TIME'), $_CLASS['core_user']->format_date($_CLASS['core_user']->time, false, true)),
 		'TOTAL_USERS_ONLINE' 		=> $l_online_users,
 		'LOGGED_IN_USER_LIST' 		=> $online_userlist,
 		'RECORD_USERS' 				=> $l_online_record,

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/functions_admin.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -24,21 +24,22 @@
 // -------------------------------------------------------------
 // Fix links "defined('IN_ADMIN')"
 // Simple version of jumpbox, just lists authed forums
-function make_forum_select($select_id = false, $ignore_id = false, $ignore_acl = false, $ignore_nonpost = false, $ignore_emptycat = true)
+function make_forum_select($select_id = false, $ignore_id = false, $ignore_acl = false, $ignore_nonpost = false, $ignore_emptycat = true, $return_array = false)
 {
 	global $_CLASS;
 
 	$acl = ($ignore_acl) ? '' : array('f_list', 'a_forum', 'a_forumadd', 'a_forumdel');
 
 	// This query is identical to the jumpbox one
-	$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, left_id, right_id
+	$sql = 'SELECT forum_id, parent_id, forum_name, forum_type, forum_status, left_id, right_id
 		FROM ' . FORUMS_FORUMS_TABLE . '
 		ORDER BY left_id ASC';
 	$result = $_CLASS['core_db']->query($sql);
 
-	$right = $iteration = 0;
+	$right = 0;
 	$padding_store = array('0' => '');
-	$forum_list = $padding = '';
+	$padding = '';
+	$forum_list = ($return_array) ? array() : '';
 
 	// Sometimes it could happen that forums will be displayed here not be displayed within the index page
 	// This is the result of forums not displayed at index, having list permissions and a parent of a forum with no permissions.
@@ -78,12 +79,17 @@
 		{
 			continue;
 		}
-
-		$selected = (is_array($select_id)) ? ((in_array($row['forum_id'], $select_id)) ? ' selected="selected"' : '') : (($row['forum_id'] == $select_id) ? ' selected="selected"' : '');
-
-		$forum_list .= '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
-
-		$iteration++;
+		if ($return_array)
+		{
+			// Include some more informations...
+			$selected = (is_array($select_id)) ? ((in_array($row['forum_id'], $select_id)) ? true : false) : (($row['forum_id'] == $select_id) ? true : false);
+			$forum_list[$row['forum_id']] = array_merge(array('padding' => $padding, 'selected' => $selected), $row);
+		}
+		else
+		{
+			$selected = (is_array($select_id)) ? ((in_array($row['forum_id'], $select_id)) ? ' selected="selected"' : '') : (($row['forum_id'] == $select_id) ? ' selected="selected"' : '');
+			$forum_list .= '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
+		}
 	}
 	unset($padding_store);
 

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -315,9 +315,7 @@
 			'S_IS_LINK'			=> ($row['forum_type'] == FORUM_LINK), 
 			'S_UNREAD_FORUM'	=> !empty($forum_unread[$forum_id]),
 			'S_LOCKED_FORUM'	=> ($row['forum_status'] == ITEM_LOCKED) ? true : false,
-
-			'LAST_POST_IMG'		=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
-
+			
 			'FORUM_ID'			=> $row['forum_id'], 
 			'FORUM_FOLDER_IMG'	=> ($row['forum_image']) ? '<img src="' . $row['forum_image'] . '" alt="' . $folder_alt . '" />' : $_CLASS['core_user']->img($folder_image, $folder_alt),
 			//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $row['forum_image'] : $_CLASS['core_user']->img($folder_image, $folder_alt, false, '', 'src'),
@@ -347,6 +345,8 @@
 		'MODIFY_FORUM'		=> $_CLASS['auth']->acl_get('a_forum'),
 		'U_MARK_FORUMS'		=> generate_link('forums&amp;file=viewforum&amp;f=' . $root_data['forum_id'] . '&amp;mark=Forums'), 
 		'S_HAS_SUBFORUM'	=> ($visible_forums) ? true : false,
+		'LAST_POST_IMG'			=> $_CLASS['core_user']->img('icon_post_latest', 'VIEW_LATEST_POST'), 
+
 		'L_SUBFORUM'		=> ($visible_forums == 1) ? $_CLASS['core_user']->lang['SUBFORUM'] : $_CLASS['core_user']->lang['SUBFORUMS']
 	));
 
@@ -398,7 +398,7 @@
 				break;
 	
 				default:
-					if ($replies >= $config['hot_threshold'])
+					if ($config['hot_threshold'] && $replies >= $config['hot_threshold'])
 					{
 						$folder_img = ($unread) ? 'folder_hot_new': 'folder_hot';
 						//$status = ($unread) ? 4 : 3;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -1398,81 +1398,11 @@
 		if ($post_mode == 'reply')
 		{
 			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
-				'topic_id' => $data['topic_id'])
-			);
+				'topic_id' => $data['topic_id']
+			));
 		}
 
-		$query = '';
-
-		switch ($_CLASS['core_db']->db_layer)
-		{
-			case 'mssql':
-			case 'mssql_odbc':
-				$fields = array();
-				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
-				{
-					$fields[] = $key;
-
-					if (is_null($var))
-					{
-						$values[] = 'NULL';
-					}
-					else if (is_string($var))
-					{
-						if ($key !== 'bbcode_bitfield')
-						{
-							$values[] = "'" . $_CLASS['core_db']->escape($var) . "'";
-						}
-						else
-						{
-							$values[] = "CAST('" . $var . "' AS varbinary)";
-						}
-					}
-					else
-					{
-						$values[] = (is_bool($var)) ? intval($var) : $var;
-					}
-				}
-				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-			break;
-
-			case 'sqlite':
-				$fields = array();
-				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
-				{
-					$fields[] = $key;
-
-					if (is_null($var))
-					{
-						$values[] = 'NULL';
-					}
-					else if (is_string($var))
-					{
-						if ($key !== 'bbcode_bitfield')
-						{
-							$values[] = "'" . $_CLASS['core_db']->escape($var) . "'";
-						}
-						else
-						{
-							$values[] = "'" . sqlite_udf_encode_binary($var) . "'";
-						}
-					}
-					else
-					{
-						$values[] = (is_bool($var)) ? intval($var) : $var;
-					}
-				}
-				$query = ' (' . implode(', ', $fields) . ') VALUES (' . implode(', ', $values) . ')';
-			break;
-
-			default:
-				$query = $_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']);
-			break;
-		}
-
-
-		$sql = 'INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$query;
-		$_CLASS['core_db']->query($sql);
+		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']));
 		$data['post_id'] = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
 		if ($post_mode == 'post')
@@ -1482,8 +1412,8 @@
 				'topic_last_post_id'	=> $data['post_id'],
 				'topic_last_post_time'	=> $current_time,
 				'topic_last_poster_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : (($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']->data['username'] : '')
-			);
+				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : (($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']->data['username'] : ''
+			));
 		}
 
 		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
@@ -1547,70 +1477,8 @@
 	// Update the posts table
 	if (isset($sql_data[FORUMS_POSTS_TABLE]['sql']))
 	{
-		switch ($_CLASS['core_db']->db_layer)
-		{
-			case 'mssql':
-			case 'mssql_odbc':
-				$values = array();
-				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
-				{
-					if (is_null($var))
-					{
-						$values[] = "$key = NULL";
-					}
-					else if (is_string($var))
-					{
-						if ($key !== 'bbcode_bitfield')
-						{
-							$values[] = "$key = '" . $_CLASS['core_db']->escape($var) . "'";
-						}
-						else
-						{
-							$values[] = "$key = CAST('" . $var . "' AS varbinary)";
-						}
-					}
-					else
-					{
-						$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
-					}
-				}
-				$query = implode(', ', $values);
-			break;
-
-			case 'sqlite':
-				$values = array();
-				foreach ($sql_data[FORUMS_POSTS_TABLE]['sql'] as $key => $var)
-				{
-					if (is_null($var))
-					{
-						$values[] = "$key = NULL";
-					}
-					else if (is_string($var))
-					{
-						if ($key !== 'bbcode_bitfield')
-						{
-							$values[] = "$key = '" . $_CLASS['core_db']->escape($var) . "'";
-						}
-						else
-						{
-							$values[] = "$key ='" . sqlite_udf_encode_binary($var) . "'";
-						}
-					}
-					else
-					{
-						$values[] = (is_bool($var)) ? "$key = " . intval($var) : "$key = $var";
-					}
-				}
-				$query = implode(', ', $values);
-			break;
-
-			default:
-				$query = $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']);
-			break;
-		}
-
 		$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-			SET ' . $query . '
+			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $sql_data[FORUMS_POSTS_TABLE]['sql']) . '
 			WHERE post_id = ' . $data['post_id'];
 		$_CLASS['core_db']->query($sql);
 	}
@@ -1688,9 +1556,10 @@
 	}
 
 	// Submit Attachments
-	if (sizeof($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
+	if (count($data['attachment_data']) && $data['post_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit')))
 	{
-		$space_taken = $files_added = 0;
+		$space_taken = $files_added = $files_updated = 0;
+		$attach_sql_array = array();
 
 		foreach ($data['attachment_data'] as $pos => $attach_row)
 		{
@@ -1700,7 +1569,9 @@
 				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
 					SET attach_comment = '" . $_CLASS['core_db']->escape($attach_row['attach_comment']) . "'
 					WHERE attach_id = " . (int) $attach_row['attach_id'];
-				$_CLASS['core_db']->query($sql);
+				$_CLASS['core_db']->query($sql);
+				
+				$files_updated++;
 			}
 			else
 			{
@@ -1710,7 +1581,7 @@
 					continue;
 				}
 
-				$attach_sql = array(
+				$attach_sql_array[] = array(
 					'post_msg_id'		=> $data['post_id'],
 					'topic_id'			=> $data['topic_id'],
 					'in_message'		=> 0,
@@ -1726,17 +1597,18 @@
 					'thumbnail'			=> $attach_row['thumbnail']
 				);
 
-				$sql = 'INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' .
-					$_CLASS['core_db']->sql_build_array('INSERT', $attach_sql);
-				$_CLASS['core_db']->query($sql);
-
 				$space_taken += $attach_row['filesize'];
 				$files_added++;
 			}
 		}
-
-		if (sizeof($data['attachment_data']))
-		{
+
+		if (count($attach_sql_array))
+		{
+			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_TOPICS_TABLE);
+		}
+	
+		if ($files_updated || $files_added)
+		{
 			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
 				SET post_attachment = 1
 				WHERE post_id = ' . $data['post_id'];
@@ -1747,6 +1619,7 @@
 				WHERE topic_id = ' . $data['topic_id'];
 			$_CLASS['core_db']->query($sql);
 		}
+		unset($attach_sql_array);
 
 		set_config('upload_dir_size', $config['upload_dir_size'] + $space_taken, true);
 		set_config('num_files', $config['num_files'] + $files_added, true);

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -34,8 +34,9 @@
 // -------------------------------------------------------------
 
 $forum_id = get_variable('f', 'REQUEST', false, 'int');
+$action = get_variable('action', 'REQUEST');
 
-if (!$forum_id || !$_CLASS['auth']->acl_get('m_', $forum_id))
+if (!$forum_id || !$_CLASS['forums_auth']->acl_get('m_', $forum_id))
 {
 	trigger_error('MODULE_NOT_EXIST');
 }
@@ -50,7 +51,7 @@
 
 $forum_info = $forum_info[$forum_id];
 
-$url = 'Forums&amp;file=mcp&amp;f='.$forum_id;
+$url = 'forums&amp;file=mcp&amp;f='.$forum_id;
 $action = get_variable('action', 'REQUEST');
 		
 if ($action === 'merge_select')
@@ -60,8 +61,8 @@
 }
 
 $start = get_variable('start', 'REQUEST', false, 'int');
-$topic_id_list = array_unique(request_var('topic_id_list', array(0)));
-$post_id_list = array_unique(request_var('post_id_list', array(0)));
+$topic_id_list = array_unique(get_variable('topic_id_list', 'REQUEST',  array(), 'array:int'));
+$post_id_list = array_unique(get_variable('post_id_list', 'REQUEST',  array(), 'array:int'));
 $topic_id = get_variable('t', 'REQUEST', false, 'int');;
 
 // Resync Topics
@@ -94,7 +95,7 @@
 mcp_sorting('viewforum', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
 
 $forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
-$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
 $pagination = generate_pagination($url . "&amp;action=$action&amp;mode=$mode" . (($action == 'merge_select') ? $selected_ids : ''), $forum_topics, $topics_per_page, $start);
 
@@ -105,21 +106,23 @@
 	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', 'TOPIC_REPORTED'),
 	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', 'TOPIC_UNAPPROVED'),
 
-	'S_CAN_DELETE'			=> $_CLASS['auth']->acl_get('m_delete', $forum_id),
-	'S_CAN_MOVE'			=> $_CLASS['auth']->acl_get('m_move', $forum_id),
-	'S_CAN_FORK'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
-	'S_CAN_LOCK'			=> $_CLASS['auth']->acl_get('m_lock', $forum_id),
-	'S_CAN_SYNC'			=> $_CLASS['auth']->acl_get('m_', $forum_id),
-	'S_CAN_APPROVE'			=> $_CLASS['auth']->acl_get('m_approve', $forum_id),
+	'S_CAN_DELETE'			=> $_CLASS['forums_auth']->acl_get('m_delete', $forum_id),
+	'S_CAN_MOVE'			=> $_CLASS['forums_auth']->acl_get('m_move', $forum_id),
+	'S_CAN_FORK'			=> $_CLASS['forums_auth']->acl_get('m_', $forum_id),
+	'S_CAN_LOCK'			=> $_CLASS['forums_auth']->acl_get('m_lock', $forum_id),
+	'S_CAN_SYNC'			=> $_CLASS['forums_auth']->acl_get('m_', $forum_id),
+	'S_CAN_APPROVE'			=> $_CLASS['forums_auth']->acl_get('m_approve', $forum_id),
 
-	'U_VIEW_FORUM'			=> generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id),
+	'U_VIEW_FORUM'			=> generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id),
+	'U_VIEW_FORUM_LOGS'		=> ($_CLASS['forums_auth']->acl_gets('a_', 'm_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=logs&amp;mode=forum_logs&amp;f=' . $forum_id) : '',
+
 	'S_MCP_ACTION'			=> generate_link($url . "&amp;mode=$mode&amp;start=$start" . (($action == 'merge_select') ? $selected_ids : '')),
 
-	'PAGINATION'		=> $pagination['formated'],
-	'PAGINATION_ARRAY'	=> $pagination['array'],
+	'PAGINATION'			=> $pagination['formated'],
+	'PAGINATION_ARRAY'		=> $pagination['array'],
 	'PAGE_NUMBER'			=> on_page($forum_topics, $topics_per_page, $start),
-	'TOTAL'					=> $forum_topics)
-);
+	'TOTAL'					=> $forum_topics
+));
 
 $icons = obtain_icons();
 
@@ -128,7 +131,7 @@
 $sql = 'SELECT t.*
 	FROM ' . FORUMS_TOPICS_TABLE . " t
 	WHERE (t.forum_id = $forum_id OR t.forum_id = 0)
-		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
+		" . (($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . "
 		AND t.topic_type IN (" . POST_ANNOUNCE . ", " . POST_GLOBAL . ")
 		$limit_time_sql
 	ORDER BY $sort_order_sql";
@@ -143,7 +146,7 @@
 $sql = 'SELECT t.*
 	FROM ' . FORUMS_TOPICS_TABLE . " t
 	WHERE t.forum_id = $forum_id
-		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . '
+		" . (($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND t.topic_approved = 1') . '
 		AND t.topic_type IN (' . POST_NORMAL . ', ' . POST_STICKY . ")
 		$limit_time_sql
 	ORDER BY t.topic_type DESC, $sort_order_sql";
@@ -159,7 +162,7 @@
 {
 	$topic_title = '';
 
-	if ($_CLASS['auth']->acl_get('m_approve', $row['forum_id']))
+	if ($_CLASS['forums_auth']->acl_get('m_approve', $row['forum_id']))
 	{
 		$row['topic_replies'] = $row['topic_replies_real'];
 	}
@@ -216,39 +219,45 @@
 	}
 
 	$topic_title = censor_text($row['topic_title']);
-		
+
+	$topic_unapproved = (!$row['topic_approved'] && $_CLASS['forums_auth']->acl_gets('m_approve', $row['forum_id']));
+	$posts_unapproved = ($row['topic_approved'] && $row['topic_replies'] < $row['topic_replies_real'] && $_CLASS['forums_auth']->acl_gets('m_approve', $row['forum_id']));
+	$u_mcp_queue = ($topic_unapproved || $posts_unapproved) ? generate_link($url . '&amp;i=queue&amp;mode='.(($topic_unapproved) ? 'approve_details' : 'unapproved_posts') .'&amp;t=' . $row['topic_id'], false, false) : false;
+
 	$_CLASS['core_template']->assign_vars_array('topicrow', array(
 		'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;t={$row['topic_id']}&amp;mode=topic_view"),
 
 		'S_SELECT_TOPIC'	=> ($action == 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
 		'U_SELECT_TOPIC'	=> generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
-		'U_MCP_QUEUE'		=> generate_link($url . '&amp;i=queue&amp;mode=approve_details&amp;t=' . $row['topic_id'], false, false),
-		'U_MCP_REPORT'		=> generate_link("Forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports"),
+		'U_MCP_QUEUE'		=> $u_mcp_queue,
+		'U_MCP_REPORT'		=> generate_link("forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports"),
 
-		'ATTACH_ICON_IMG'	=> ($_CLASS['auth']->acl_gets('f_download', 'u_download', $row['forum_id']) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
+		'ATTACH_ICON_IMG'	=> ($_CLASS['forums_auth']->acl_gets('f_download', 'u_download', $row['forum_id']) && $row['topic_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 		'TOPIC_FOLDER_IMG' 	=> $_CLASS['core_user']->img($folder_img, $folder_alt),
 		//'TOPIC_FOLDER_IMG_SRC'	=> $user->img($folder_img, $folder_alt, false, '', 'src'),
 
 		'TOPIC_ICON_IMG'		=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['img'],
 		'TOPIC_ICON_IMG_WIDTH'	=> empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['width'],
 		'TOPIC_ICON_IMG_HEIGHT' => empty($icons[$row['icon_id']]) ? '' : $icons[$row['icon_id']]['height'],
-		
+		'UNAPPROVED_IMG'		=> ($topic_unapproved || $posts_unapproved) ? $_CLASS['core_user']->img('icon_unapproved', ($topic_unapproved) ? 'TOPIC_UNAPPROVED' : 'POSTS_UNAPPROVED') : '',
+
 		'TOPIC_TYPE'		=> $topic_type,
 		'TOPIC_TITLE'		=> $topic_title,
-		'REPLIES'			=> $row['topic_replies'],
+		'REPLIES'			=> ($_CLASS['forums_auth']->acl_get('m_approve', $row['forum_id'])) ? $row['topic_replies_real'] : $row['topic_replies'],
 		'LAST_POST_TIME'	=> $_CLASS['core_user']->format_date($row['topic_last_post_time']),
 		'TOPIC_ID'			=> $row['topic_id'],
 		'S_TOPIC_CHECKED'	=> ($topic_id_list && in_array($row['topic_id'], $topic_id_list)) ? 'checked="checked" ' : '',
 
-		'S_TOPIC_REPORTED'	=> ($row['topic_reported']),
-		'S_TOPIC_UNAPPROVED'=> !($row['topic_approved']),
+		'S_TOPIC_REPORTED'	=> (!empty($row['topic_reported']) && $_CLASS['forums_auth']->acl_gets('m_report', $row['forum_id'])),
+		'S_TOPIC_UNAPPROVED'=> $topic_unapproved,
+		'S_POSTS_UNAPPROVED'=> $posts_unapproved,
 		'NEWEST_POST_IMG' => false
 	));
 }
 unset($topic_rows);
 
 page_header();
-$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_forum.html');
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_forum.html');
 
 function mcp_resync_topics($topic_ids)
 {
@@ -281,6 +290,7 @@
 	{
 		add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_TOPIC_RESYNC', $row['topic_title']);
 	}
+	$_CLASS['core_db']->free_result($result);
 
 	$msg = (count($topic_ids) == 1) ? $_CLASS['core_user']->lang['TOPIC_RESYNC_SUCCESS'] : $_CLASS['core_user']->lang['TOPICS_RESYNC_SUCCESS'];
 

Modified: cms/trunk/includes/forums/mcp/mcp_front.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_front.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_front.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -42,15 +42,13 @@
 
 $forum_id = get_variable('f', 'REQUEST', false, 'int');
 
-$url = 'Forums&amp;file=mcp';
+$url = 'forums&amp;file=mcp';
 
 $forum_list_approve = get_forum_list('m_approve');
-$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', false);
+$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', !empty($forum_list_approve));
 
 if (!empty($forum_list_approve))
 {
-	$_CLASS['core_template']->assign('S_SHOW_UNAPPROVED', true);
-
 	$sql = 'SELECT post_id, forum_id
 		FROM ' . FORUMS_POSTS_TABLE . '
 		WHERE forum_id IN (0, ' . implode(', ', $forum_list_approve) . ')
@@ -99,8 +97,8 @@
 				'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
 				'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
 				'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-				'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-				'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
+				'U_FORUM'		=> ($row['forum_id']) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+				'U_TOPIC'		=> generate_link('forums&amp;file=viewtopic&amp;f=' . (($row['forum_id']) ? $row['forum_id'] : $forum_id) . '&amp;t=' . $row['topic_id']),
 				'U_AUTHOR'		=> ($row['poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['poster_id']),
 
 				'FORUM_NAME'	=> ($row['forum_id']) ? $forum_names[$row['forum_id']] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
@@ -125,7 +123,7 @@
 	}
 }
 
-/*
+
 // Latest 5 reported
 $forum_list = get_forum_list('m_reports');
 $_CLASS['core_template']->assign('S_SHOW_REPORTS', !empty($forum_list));
@@ -135,6 +133,7 @@
 	$sql = 'SELECT COUNT(r.report_id) AS total
 		FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . POSTS_TABLE . ' p
 		WHERE r.post_id = p.post_id
+			AND r.report_closed = 0
 			AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')';
 	$result = $_CLASS['core_db']->query($sql);
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -146,11 +145,12 @@
 			FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . FORUMS_REASONS_TABLE . ' rr,' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . ' u
 			LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON f.forum_id = p.forum_id
 			WHERE r.post_id = p.post_id
+				AND r.report_closed = 0
 				AND r.reason_id = rr.reason_id
 				AND p.topic_id = t.topic_id
 				AND r.user_id = u.user_id
 				AND p.forum_id IN (0, ' . implode(', ', $forum_list) . ')
-			ORDER BY p.post_id DESC';
+			ORDER BY p.post_time DESC';
 		$result = $_CLASS['core_db']->query_limit($sql, 5);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -159,8 +159,8 @@
 				'U_POST_DETAILS'=> generate_link($url . '&amp;p=' . $row['post_id'] . '&amp;mode=post_details'),
 				'U_MCP_FORUM'	=> ($row['forum_id']) ? generate_link($url . '&amp;f=' . $row['forum_id'] . '&amp;mode=forum_view') : '',
 				'U_MCP_TOPIC'	=> generate_link($url . '&amp;t=' . $row['topic_id'] . '&amp;mode=topic_view'),
-				'U_FORUM'		=> ($row['forum_id']) ? generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
-				'U_TOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
+				'U_FORUM'		=> ($row['forum_id']) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '',
+				'U_TOPIC'		=> generate_link('forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;t=' . $row['topic_id']),
 				'U_REPORTER'	=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
 
 				'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['POST_GLOBAL'],
@@ -187,16 +187,16 @@
 		);
 	}
 }
-*/
 
-$forum_list_log = get_forum_list(array('m_', 'a_general'));
+
+$forum_list = get_forum_list(array('m_', 'a_general'));
 // Add forum_id 0 for global announcements
-$forum_list_log[] = 0;
+$forum_list[] = 0;
 
 $log_count = 0;
 $log = array();
 
-view_log('mod', $log, $log_count, 5, 0, $forum_list_log);
+view_log('mod', $log, $log_count, 5, 0, $forum_list);
 
 foreach ($log as $row)
 {
@@ -205,8 +205,8 @@
 		'IP'			=> $row['ip'],
 		'TIME'			=> $_CLASS['core_user']->format_date($row['time']),
 		'ACTION'		=> $row['action'],
-		'U_VIEWTOPIC'	=> $row['viewtopic'],
-		'U_VIEWLOGS'	=> $row['viewlogs']
+		'U_VIEWTOPIC'	=> (!empty($row['viewtopic'])) ? $row['viewtopic'] : '',
+		'U_VIEWLOGS'	=> (!empty($row['viewlogs'])) ? $row['viewlogs'] : ''
 	));
 }
 
@@ -215,10 +215,12 @@
 	'S_HAS_LOGS'	=> !empty($log)
 ));
 
+unset($forum_list, $log);
+
 $_CLASS['core_template']->assign('S_MCP_ACTION', generate_link($url));
 make_jumpbox(generate_link($url . '&amp;mode=forum_view'), 0, false, 'm_');
 
 page_header();
-$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_front.html');
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_front.html');
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -53,7 +53,7 @@
 		$l_prefix = 'POST';
 	}
 	
-	if (!check_ids($ids, $table, $sql_id, 'm_lock'))
+	if (!check_ids($ids, $table, $sql_id, array('f_user_lock', 'm_lock')))
 	{// redirect maybe
 		return;
 	}
@@ -64,15 +64,15 @@
 	$hidden_fields = build_hidden_fields(array(
 		$sql_id . '_list'	=> $ids,
 		'mode'				=> $mode,
-		'redirect'			=> $redirect)
-	);
+		'redirect'			=> $redirect
+	));
 
 	$success_msg = false;
 
 	if (display_confirmation($message, $hidden_fields))
 	{
 		$sql = "UPDATE $table
-			SET $set_id = " . (($mode == 'lock' || $mode == 'lock_post') ? ITEM_LOCKED : ITEM_UNLOCKED) . "
+			SET $set_id = " . (($mode === 'lock' || $mode === 'lock_post') ? ITEM_LOCKED : ITEM_UNLOCKED) . "
 			WHERE $sql_id IN (" . implode(', ', $ids) . ")";
 		$_CLASS['core_db']->query($sql);
 
@@ -100,11 +100,11 @@
 }
 
 // Change Topic Type
-function change_topic_type($mode, $topic_ids)
+function change_topic_type($mode, $topic_ids, $forum_id)
 {
 	global $_CLASS;
 
-	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', 'm_'))
+	if (!check_ids($topic_ids, FORUMS_TOPICS_TABLE, 'topic_id', array('f_announce', 'f_sticky', 'm_')))
 	{
 		return;
 	}
@@ -155,8 +155,6 @@
 					AND forum_id <> 0';
 			$_CLASS['core_db']->query($sql);
 
-// do select first
-			/*
 			if ($forum_id)
 			{
 				$sql = 'UPDATE ' . TOPICS_TABLE . "
@@ -165,7 +163,6 @@
 						AND forum_id = 0';
 				$_CLASS['core_db']->query($sql);
 			}
-			*/
 		}
 		else
 		{
@@ -204,6 +201,7 @@
 	}
 }
 
+
 // Move Topic
 function mcp_move_topic($topic_ids)
 {
@@ -263,8 +261,8 @@
 	$_CLASS['core_template']->assign_array(array(
 		'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, $old_forums, false, true, true),
 		'S_CAN_LEAVE_SHADOW'	=> true,
-		'ADDITIONAL_MSG'		=> $additional_msg)
-	);
+		'ADDITIONAL_MSG'		=> $additional_msg
+	));
 
 	$message = $_CLASS['core_user']->get_lang('MOVE_TOPIC' . ((count($topic_ids) === 1) ? '' : 'S'));
 
@@ -281,6 +279,8 @@
 		$_CLASS['core_db']->transaction();
 
 		$forum_ids = array($to_forum_id);
+		$shadow = array();
+
 		foreach ($topic_data as $topic_id => $row)
 		{
 			// Get the list of forums to resync, add a log entry
@@ -290,11 +290,11 @@
 			// Leave a redirection if required and only if the topic is visible to users
 			if ($leave_shadow && $row['topic_approved'])
 			{
-				$shadow = array(
+				$shadow[] = array(
 					'forum_id'				=>	(int) $row['forum_id'],
 					'icon_id'				=>	(int) $row['icon_id'],
 					'topic_attachment'		=>	(int) $row['topic_attachment'],
-					'topic_approved'		=>	(int) $row['topic_approved'],
+					'topic_approved'		=>	1,
 					'topic_reported'		=>	(int) $row['topic_reported'],
 					'topic_title'			=>	(string) $row['topic_title'],
 					'topic_poster'			=>	(int) $row['topic_poster'],
@@ -321,14 +321,14 @@
 					'poll_max_options'		=>	(int) $row['poll_max_options'],
 					'poll_last_vote'		=>	(int) $row['poll_last_vote']
 				);
-
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $shadow));
 			}
 		}
-		unset($topic_data, $shadow);
 
+		$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $shadow, FORUMS_TOPICS_TABLE);
 		$_CLASS['core_db']->transaction('commit');
 
+		unset($topic_data, $shadow);
+
 		// Now sync forums
 		sync('forum', 'forum_id', $forum_ids);
 
@@ -432,46 +432,49 @@
 		$sql = 'SELECT DISTINCT topic_id
 			FROM ' . FORUMS_POSTS_TABLE . '
 			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
-		$result = $db->query($sql);
+		$result = $_CLASS['core_db']->query($sql);
 
 		$topic_id_list = array();
 
-		while ($row = $db->sql_fetchrow($result))
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
 			$topic_id_list[] = $row['topic_id'];
 		}
-		$affected_topics = sizeof($topic_id_list);
-		$db->sql_freeresult($result);
+		$_CLASS['core_db']->free_result($result);
 
+		$affected_topics = count($topic_id_list);
 		$post_data = get_post_data($post_ids);
 
 		foreach ($post_data as $id => $row)
 		{
 			add_log('mod', $row['forum_id'], $row['topic_id'], 'LOG_DELETE_POST', $row['post_subject']);
 		}
+		unset($post_data);
 
 		// Now delete the posts, topics and forums are automatically resync'ed
 		delete_posts('post_id', $post_ids);
 					
 		$sql = 'SELECT COUNT(topic_id) AS topics_left
-			FROM ' . TOPICS_TABLE . '
+			FROM ' . FORUMS_TOPICS_TABLE . '
 			WHERE topic_id IN (' . implode(', ', $topic_id_list) . ')';
-		$result = $db->query_limit($sql, 1);
 
-		$deleted_topics = ($row = $db->sql_fetchrow($result)) ? ($affected_topics - $row['topics_left']) : $affected_topics;
-		$db->sql_freeresult($result);
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
+		$deleted_topics = ($row['topics_left']) ? ($affected_topics - $row['topics_left']) : $affected_topics;
 		$topic_id = request_var('t', 0);
 
 		// Return links
 		$return_link = array();
-		if ($affected_topics == 1 && !$deleted_topics && $topic_id)
+		if ($affected_topics === 1 && !$deleted_topics && $topic_id)
 		{
-			$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
+			$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&amp;t=$topic_id").'">', '</a>');
 		}
-		$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
 
-		if (sizeof($post_ids) == 1)
+		$return_link[] = sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f='.$forum_id).'">', '</a>');
+
+		if (count($post_ids) === 1)
 		{
 			if ($deleted_topics)
 			{
@@ -498,11 +501,11 @@
 		}
 	}
 
-	$redirect = generate_link('Forums');
+	$redirect = generate_link('forums');
 
 	if (!$success_msg)
 	{
-		url_redirect($redirect);
+		redirect($redirect);
 	}
 	else
 	{
@@ -563,8 +566,8 @@
 	$_CLASS['core_template']->assign_array(array(
 		'S_FORUM_SELECT'		=> make_forum_select($to_forum_id, false, false, true, true),
 		'S_CAN_LEAVE_SHADOW'	=> false,
-		'ADDITIONAL_MSG'		=> $additional_msg)
-	);
+		'ADDITIONAL_MSG'		=> $additional_msg
+	));
 
 	$message = $_CLASS['core_user']->get_lang('FORK_TOPIC' . ((count($topic_ids) === 1) ? '' : 'S'));
 
@@ -575,7 +578,7 @@
 		$topic_data = get_topic_data($topic_ids);
 
 		$total_posts = 0;
-		$new_topic_id_list = array();
+		$new_topic_id_list = $new_topic_forum_name_list = $insert_array = array();
 
 		$_CLASS['core_db']->transaction();
 
@@ -604,16 +607,19 @@
 				'topic_last_view_time'		=> (int) $topic_row['topic_last_view_time'],
 				'topic_bumped'				=> (int) $topic_row['topic_bumped'],
 				'topic_bumper'				=> (int) $topic_row['topic_bumper'],
-				'topic_views'				=> (int) $topic_row['topic_views'],
+				'topic_views'				=> 0,
 				'poll_title'				=> (string) $topic_row['poll_title'],
 				'poll_start'				=> (int) $topic_row['poll_start'],
 				'poll_length'				=> (int) $topic_row['poll_length']
 			);
 
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+			$_CLASS['core_db']->sql_query_build('INSERT', $sql_ary, FORUMS_TOPICS_TABLE);
+			unset($sql_ary);
+
 			$new_topic_id = $_CLASS['core_db']->insert_id(FORUMS_TOPICS_TABLE, 'topic_id');
 
 			$new_topic_id_list[$topic_id] = $new_topic_id;
+			$new_topic_forum_name_list[$topic_id] = $topic_row['forum_name'];
 
 			if ($topic_row['poll_start'])
 			{
@@ -626,12 +632,16 @@
 
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$sql = 'INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' (poll_option_id, topic_id, poll_option_text, poll_option_total)
-						VALUES (' . $row['poll_option_id'] . ', ' . $new_topic_id . ", '" . $_CLASS['core_db']->escape($row['poll_option_text']) . "', 0)";
-					$_CLASS['core_db']->query($sql);
+					$insert_array[FORUMS_POLL_OPTIONS_TABLE][] = array(
+						'poll_option_id'	=> (int) $row['poll_option_id'],
+						'topic_id'			=> (int) $new_topic_id,
+						'poll_option_text'	=> (string) $row['poll_option_text'],
+						'poll_option_total'	=> 0
+					);
 				}
 				$_CLASS['core_db']->free_result($result);
 			}
+			unset($topic_data[$topic_id]);
 
 			$sql = 'SELECT *
 				FROM ' . FORUMS_POSTS_TABLE . "
@@ -642,9 +652,8 @@
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$total_posts++;
-// just change $row values for topic_id, forum_id, post_reported;
 
-				$sql_ary = array(
+				$insert_array[FORUMS_POSTS_TABLE][] = array(
 					'topic_id'			=> (int) $new_topic_id,
 					'forum_id'			=> (int) $to_forum_id,
 					'poster_id'			=> (int) $row['poster_id'],
@@ -672,11 +681,10 @@
 					'post_edit_locked'	=> (int) $row['post_edit_locked']
 				);
 
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
-
 				// Copy Attachments
 				if ($row['post_attachment'])
 				{
+					$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array_pop($insert_array[FORUMS_POSTS_TABLE])));
 					$new_post_id = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
 					$sql = 'SELECT * FROM ' . FORUMS_ATTACHMENTS_TABLE . "
@@ -687,7 +695,7 @@
 					
 					while ($attach_row = $_CLASS['core_db']->fetch_row_assoc($result))
 					{
-						$sql_ary = array(
+						$insert_array[FORUMS_ATTACHMENTS_TABLE][] = array(
 							'post_msg_id'		=> (int) $new_post_id,
 							'topic_id'			=> (int) $new_topic_id,
 							'in_message'		=> 0,
@@ -695,26 +703,39 @@
 							'physical_filename'	=> (string) basename($attach_row['physical_filename']),
 							'real_filename'		=> (string) basename($attach_row['real_filename']),
 							'download_count'	=> (int) $attach_row['download_count'],
-							'comment'			=> (string) $attach_row['comment'],
+							'attach_comment'	=> (string) $attach_row['attach_comment'],
 							'extension'			=> (string) $attach_row['extension'],
 							'mimetype'			=> (string) $attach_row['mimetype'],
 							'filesize'			=> (int) $attach_row['filesize'],
 							'filetime'			=> (int) $attach_row['filetime'],
 							'thumbnail'			=> (int) $attach_row['thumbnail']
 						);
-						
-						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 					}
 					$_CLASS['core_db']->free_result($result);
 				}
 			}
 			$_CLASS['core_db']->free_result($result);
 		}
+		unset($topic_data);
 
 		$_CLASS['core_db']->transaction('commit');
 
 		if (!empty($new_topic_id_list))
 		{
+			if (!empty($insert_array[FORUMS_POLL_OPTIONS_TABLE]))
+			{
+				$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $insert_array[FORUMS_POLL_OPTIONS_TABLE], FORUMS_POLL_OPTIONS_TABLE);
+			}
+			if (!empty($insert_array[FORUMS_POSTS_TABLE]))
+			{
+				$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $insert_array[FORUMS_POSTS_TABLE], FORUMS_POSTS_TABLE);
+			}
+			if (!empty($insert_array[FORUMS_ATTACHMENTS_TABLE]))
+			{
+				$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $insert_array[FORUMS_ATTACHMENTS_TABLE], FORUMS_ATTACHMENTS_TABLE);
+			}
+			unset($insert_array);
+			
 			// Sync new topics, parent forums and board stats
 			sync('topic', 'topic_id', $new_topic_id_list, true);
 			sync('forum', 'forum_id', $to_forum_id, true);
@@ -723,15 +744,11 @@
 	
 			foreach ($new_topic_id_list as $topic_id => $new_topic_id)
 			{
-				add_log('mod', $to_forum_id, $new_topic_id, 'LOG_FORK', $topic_row['forum_name']);
+				add_log('mod', $to_forum_id, $new_topic_id, 'LOG_FORK', $new_topic_forum_name_list[$topic_id]['forum_name']);
 			}
 			
 			$success_msg = (count($topic_ids) === 1) ? 'TOPIC_FORKED_SUCCESS' : 'TOPICS_FORKED_SUCCESS';
 		}
-		else
-		{
-			trigger_error('Something Failed');
-		}
 	}
 
 	$redirect = generate_link($redirect);
@@ -742,7 +759,7 @@
 	}
 	else
 	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link('Forums&amp;file=viewforum&amp;f='.$to_forum_id));
+		$_CLASS['core_display']->meta_refresh(3, generate_link('forums&amp;file=viewforum&amp;f='.$to_forum_id));
 		$return_link = sprintf($_CLASS['core_user']->lang['RETURN_NEW_FORUM'], '<a href="'. $redirect . '">', '</a>');
 
 		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . $return_link);

Added: cms/trunk/includes/forums/mcp/mcp_notes.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -0,0 +1,205 @@
+<?php
+/** 
+*
+* @package mcp
+* @version $Id: mcp_notes.php,v 1.26 2006/07/29 11:35:32 grahamje Exp $
+* @copyright (c) 2005 phpBB Group 
+* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
+*
+*/
+
+
+
+global $_CLASS;
+
+$action = get_variable('action', 'REQUEST');
+$mode = get_variable('mode', 'REQUEST');
+
+//$this->page_title = 'MCP_NOTES';
+
+switch ($mode)
+{
+	case 'user_notes':
+		//$_CLASS['core_user']->add_lang('acp/common.php');
+
+		mcp_notes_user_view($action);
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP_NOTES'), 'modules/forums/mcp_notes_user.html');
+	break;
+	
+	//case 'front':
+	default:
+		$_CLASS['core_template']->assign_array(array(
+			'U_FIND_MEMBER'		=> generate_link('members_list&amp;mode=search_user&amp;form=mcp&amp;field=username'),
+			'U_POST_ACTION'		=> generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes'),
+
+			'L_TITLE'			=> $_CLASS['core_user']->get_lang('MCP_NOTES')
+		));
+
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP_NOTES'), 'modules/forums/mcp_notes_front.html');
+	break;
+}
+
+/**
+* Display user notes
+*/
+function mcp_notes_user_view($action)
+{
+	global $_CLASS, $_CORE_CONFIG, $config;
+
+	$user_id = request_var('u', 0);
+	$username = request_var('username', '');
+	$start = request_var('start', 0);
+	$st	= request_var('st', 0);
+	$sk	= request_var('sk', 'b');
+	$sd	= request_var('sd', 'd');
+
+	$url = 'forums&amp;file=mcp&amp;i=notes&mode=user_notes';
+
+	$sql_where = ($user_id) ? "user_id = $user_id" : "username = '" . $db->sql_escape($username) . "'";
+
+	$sql = 'SELECT *
+		FROM ' . CORE_USERS_TABLE . "
+		WHERE $sql_where";
+	$result = $_CLASS['core_db']->query($sql);
+	$userrow = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$userrow)
+	{
+		trigger_error('NO_USER');
+	}
+
+	$user_id = $userrow['user_id'];
+
+	$deletemark = ($action === 'del_marked');
+	$deleteall	= ($action === 'del_all');
+	$marked		= get_variable('marknote', 'REQUEST', false, 'array:int');
+	$usernote	= request_var('usernote', '', true);
+
+	// Handle any actions
+	if (($deletemark || $deleteall) && $_CLASS['forums_auth']->acl_get('a_clearlogs'))
+	{
+		$where_sql = '';
+		if ($deletemark && $marked)
+		{
+			/*$sql_in = array();
+			foreach ($marked as $mark)
+			{
+				$sql_in[] = $mark;
+			}*/
+			$where_sql = ' AND log_id IN (' . implode(', ', $marked) . ')';
+			/*unset($sql_in);*/
+		}
+
+		if ($where_sql || $deleteall)
+		{
+			$sql = 'DELETE FROM ' . FORUMS_LOG_TABLE . '
+				WHERE log_type = ' . FORUMS_LOG_USERS . " 
+					AND reportee_id = $user_id
+					$where_sql";
+			$_CLASS['core_db']->query($sql);
+
+			add_log('admin', 'LOG_CLEAR_USER', $userrow['username']);
+
+			$msg = ($deletemark) ? 'MARKED_NOTES_DELETED' : 'ALL_NOTES_DELETED';
+			$redirect = generate_link($url . '&amp;u=' . $user_id);
+
+			$_CLASS['core_display']->meta_refresh(3, $redirect);
+			trigger_error($_CLASS['core_user']->lang[$msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+		}
+	}
+
+	if ($usernote && $action === 'add_feedback')
+	{
+		add_log('admin', 'LOG_USER_FEEDBACK', $userrow['username']);
+		add_log('user', $user_id, 'LOG_USER_GENERAL', $usernote);
+
+		$redirect = generate_link($url . '&amp;u=' . $user_id);
+		$_CLASS['core_display']->meta_refresh(3, $redirect);
+		trigger_error($_CLASS['core_user']->lang['USER_FEEDBACK_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
+	}
+
+	// Generate the appropriate user information for the user we are looking at
+	$rank_title = $rank_img = '';
+	//get_user_rank($userrow['user_rank'], $userrow['user_posts'], $rank_title, $rank_img);
+
+	$avatar_img = '';
+	if (!empty($userrow['user_avatar']))
+	{
+		switch ($userrow['user_avatar_type'])
+		{
+			case AVATAR_UPLOAD:
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
+			break;
+
+			case AVATAR_GALLERY:
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
+			break;
+		}
+		$avatar_img .= $userrow['user_avatar'];
+
+		$avatar_img = '<img src="' . $avatar_img . '" width="' . $userrow['user_avatar_width'] . '" height="' . $userrow['user_avatar_height'] . '" alt="" />';
+	}
+
+	$limit_days = array(0 => $_CLASS['core_user']->lang['ALL_ENTRIES'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 365 => $_CLASS['core_user']->lang['1_YEAR']);
+	$sort_by_text = array('a' => $_CLASS['core_user']->lang['SORT_USERNAME'], 'b' => $_CLASS['core_user']->lang['SORT_DATE'], 'c' => $_CLASS['core_user']->lang['SORT_IP'], 'd' => $_CLASS['core_user']->lang['SORT_ACTION']);
+	$sort_by_sql = array('a' => 'l.username', 'b' => 'l.log_time', 'c' => 'l.log_ip', 'd' => 'l.log_operation');
+
+	$s_limit_days = $s_sort_key = $s_sort_dir = $u_sort_param = '';
+	gen_sort_selects($limit_days, $sort_by_text, $st, $sk, $sd, $s_limit_days, $s_sort_key, $s_sort_dir, $u_sort_param);
+
+	// Define where and sort sql for use in displaying logs
+	$sql_where = ($st) ? ($_CLASS['core_user']->time - ($st * 86400)) : 0;
+	$sql_sort = $sort_by_sql[$sk] . ' ' . (($sd == 'd') ? 'DESC' : 'ASC');
+
+	$log_data = array();
+	$log_count = 0;
+	view_log('user', $log_data, $log_count, $config['posts_per_page'], $start, 0, 0, $user_id, $sql_where, $sql_sort);
+
+	$_CLASS['core_template']->assign('S_USER_NOTES', false);
+
+	if ($log_count)
+	{
+		$_CLASS['core_template']->assign('S_USER_NOTES', true);
+
+		foreach ($log_data as $row)
+		{
+			$_CLASS['core_template']->assign_vars_array('usernotes', array(
+				'REPORT_BY'		=> $row['username'],
+				'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
+				'ACTION'		=> $row['action'],
+				'IP'			=> $row['ip'],
+				'ID'			=> $row['id'])
+			);
+		}
+	}
+
+	$pagination = generate_pagination($url . "&amp;u=$user_id&amp;st=$st&amp;sk=$sk&amp;sd=$sd", $log_count, $config['posts_per_page'], $start);
+
+	$_CLASS['core_template']->assign_array(array(
+		'U_POST_ACTION'			=> generate_link($url . '&amp;u=' . $user_id),
+		'S_CLEAR_ALLOWED'		=> $_CLASS['forums_auth']->acl_get('a_clearlogs'),
+		'S_SELECT_SORT_DIR'		=> $s_sort_dir,
+		'S_SELECT_SORT_KEY'		=> $s_sort_key,
+		'S_SELECT_SORT_DAYS'	=> $s_limit_days,
+
+		'L_TITLE'			=> $_CLASS['core_user']->get_lang('MCP_NOTES_USER'),
+
+		'PAGE_NUMBER'		=> on_page($log_count, $config['posts_per_page'], $start),
+		'PAGINATION'		=> $pagination['formated'],
+		'PAGINATION_ARRAY'	=> $pagination['array'],
+		'TOTAL_REPORTS'		=> ($log_count == 1) ? $_CLASS['core_user']->get_lang('LIST_REPORT') : sprintf($_CLASS['core_user']->get_lang('LIST_REPORTS'), $log_count),
+
+		'USERNAME'			=> $userrow['username'],
+		'USER_COLOR'		=> (!empty($userrow['user_colour'])) ? $userrow['user_colour'] : '',
+		'RANK_TITLE'		=> $rank_title,
+		'JOINED'			=> $_CLASS['core_user']->format_date($userrow['user_reg_date']),
+		'POSTS'				=> ($userrow['user_posts']) ? $userrow['user_posts'] : 0,
+		'WARNINGS'			=> (@$userrow['user_warnings']) ? $userrow['user_warnings'] : 0,
+
+		'AVATAR_IMG'		=> $avatar_img,
+		'RANK_IMG'			=> $rank_img,
+	));
+}
+
+?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_post.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -1,355 +1,391 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-// -------------------------------------------------------------
-//
-// $Id: mcp_post.php,v 1.4 2004/07/19 20:13:16 acydburn Exp $
-//
-// FILENAME  : mcp_post.php
-// STARTED   : Thu Jul 08, 2004
-// COPYRIGHT : ? 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-
-
-$_CLASS['core_user']->add_lang('posting');
-$id = 0;
-$url = 'Forums&amp;file=mcp';
-$post_id = request_var('p', 0);
-$start	= request_var('start', 0);
-
-// Get post data
-$post_info = get_post_data(array($post_id));
-
-if (empty($post_info))
-{
-	trigger_error('POST_NOT_EXIST');
-}
-
-$post_info = $post_info[$post_id];
-
-switch ($action)
-{
-	case 'chgposter_search':
-		$username = request_var('username', '');
-
-		if ($username)
-		{
-			$users_ary = array();
-
-			if (strpos($username, '*') === false)
-			{
-				$username = "*$username*";
-			}
-			$username = str_replace('*', '%', str_replace('%', '\%', $username));
-
-			$sql = 'SELECT user_id, username
-				FROM ' . USERS_TABLE . "
-				WHERE username LIKE '" . $_CLASS['core_db']->sql_escape($username) . "'
-					AND user_type NOT IN (" . USER_INACTIVE . ', ' . USER_IGNORE . ')
-					AND user_id <> ' . $post_info['user_id'];
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$users_ary[strtolower($row['username'])] = $row;
-			}
-
-			$user_select = '';
-			ksort($users_ary);
-			foreach ($users_ary as $row)
-			{
-				$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
-			}
-		}
-
-		if (!$user_select)
-		{
-			$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->lang['NO_MATCHES_FOUND']);
-		}
-
-		$_CLASS['core_template']->assign_array(array(
-			'S_USER_SELECT'		=>	$user_select,
-			'SEARCH_USERNAME'	=>	request_var('username', ''))
-		);
-		break;
-
-	case 'chgposter':
-
-		$new_user = request_var('u', 0);
-
-		if ($new_user && $_CLASS['auth']->acl_get('m_', $post_info['forum_id']) && $new_user != $post_info['user_id'])
-		{
-			$sql = 'UPDATE ' . POSTS_TABLE . "
-				SET poster_id = $new_user
-				WHERE post_id = $post_id";
-			$_CLASS['core_db']->query($sql);
-
-			if ($post_info['topic_last_post_id'] == $post_info['post_id'] || $post_info['forum_last_post_id'] == $post_info['post_id'])
-			{
-				sync('topic', 'topic_id', $post_info['topic_id'], false, false);
-				sync('forum', 'forum_id', $post_info['forum_id'], false, false);
-			}
-			
-			// Renew post info
-			$post_info = get_post_data(array($post_id));
-
-			if (empty($post_info))
-			{
-				trigger_error('POST_NOT_EXIST');
-			}
-
-			$post_info = $post_info[$post_id];
-		}
-	break;
-		
-	case 'del_marked':
-	case 'del_all':
-	case 'add_feedback':
-		$deletemark = ($action == 'del_marked') ? true : false;
-		$deleteall	= ($action == 'del_all') ? true : false;
-		$marked		= request_var('marknote', 0);
-		$usernote	= request_var('usernote', '');
-
-		if (($deletemark || $deleteall) && $_CLASS['auth']->acl_get('a_clearlogs'))
-		{
-			$where_sql = '';
-			if ($deletemark && $marked)
-			{
-				$sql_in = array();
-				foreach ($marked as $mark)
-				{
-					$sql_in[] = $mark;
-				}
-				$where_sql = ' AND log_id IN (' . implode(', ', $sql_in) . ')';
-				unset($sql_in);
-			}
-
-			$sql = 'DELETE FROM ' . LOG_TABLE . '
-				WHERE log_type = ' . LOG_USERS . " 
-					$where_sql";
-			$_CLASS['core_db']->query($sql);
-
-			add_log('admin', 'LOG_USERS_CLEAR');
-
-			$msg = ($deletemark) ? 'MARKED_DELETED' : 'ALL_DELETED';
-			$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
-			$_CLASS['core_display']->meta_refresh(2, $redirect);
-			trigger_error($_CLASS['core_user']->lang[$msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-		}
-
-		if ($usernote && $action == 'add_feedback')
-		{
-			add_log('admin', 'LOG_USER_FEEDBACK', $post_info['username']);
-			add_log('user', $post_info['user_id'], 'LOG_USER_GENERAL', $usernote);
-
-			$redirect = generate_link("$url&amp;i=$id&amp;mode=post_details");
-			$_CLASS['core_display']->meta_refresh(2, $redirect);
-			trigger_error($_CLASS['core_user']->lang['USER_FEEDBACK_ADDED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>'));
-		}
-	break;
-}
-
-// Set some vars
-$users_ary = array();
-$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
-
-// Process message, leave it uncensored
-$message = $post_info['post_text'];
-
-if ($post_info['bbcode_bitfield'])
-{
-	global $site_file_root;
-
-	require_once($site_file_root.'includes/forums/bbcode.php');
-	$bbcode = new bbcode($post_info['bbcode_bitfield']);
-	$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
-}
-
-$_CLASS['core_template']->assign_array(array(
-	'U_MCP_ACTION'			=> generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
-	'U_POST_ACTION'			=> generate_link("$url&amp;i=$id&amp;mode=post_details"), // Use this for action parameters
-	'U_APPROVE_ACTION'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;p='.$post_id),
-
-	'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
-	'S_CAN_CHGPOSTER'		=> $_CLASS['auth']->acl_get('m_', $post_info['forum_id']),
-	'S_CAN_LOCK_POST'		=> $_CLASS['auth']->acl_get('m_lock', $post_info['forum_id']),
-	'S_CAN_DELETE_POST'		=> $_CLASS['auth']->acl_get('m_delete', $post_info['forum_id']),
-
-	'S_POST_REPORTED'		=> $post_info['post_reported'],
-	'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
-	'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
-	//'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
-	'S_SHOW_USER_NOTES'		=> true,
-	'S_CLEAR_ALLOWED'		=> ($_CLASS['auth']->acl_get('a_clearlogs')) ? true : false,
-
-	'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
-//		'U_MCP_USERNOTES'		=> generate_link('Forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
-//		'U_MCP_WARNINGS'		=> generate_link('Forums&amp;file=mcp&amp;i=warnings&amp;mode=view_user&amp;u=' . $post_info['user_id']),
-	'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
-
-	'RETURN_TOPIC'			=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;p=$post_id#$post_id").'">', '</a>'),
-	'RETURN_FORUM'			=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$post_info['forum_id']}&amp;start={$start}").'">', '</a>'),
-	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
-	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
-	'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
-	'SEARCH_IMG'			=> $_CLASS['core_user']->img('btn_search', 'SEARCH_USER_POSTS'),
-	
-	'POSTER_NAME'			=> $poster,
-	'POST_PREVIEW'			=> smiley_text($message),
-	'POST_SUBJECT'			=> $post_info['post_subject'],
-	'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
-	'POST_IP'				=> $post_info['poster_ip'],
-	'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
-	'POST_ID'				=> $post_info['post_id'])
-);
-
-// Get User Notes
-$log_data = array();
-$log_count = 0;
-
-view_log('user', $log_data, $log_count, $config['posts_per_page'], 0, 0, 0, $post_info['user_id']);
-
-if ($log_count)
-{
-	$_CLASS['core_template']->assign('S_USER_NOTES', true);
-
-	foreach ($log_data as $row)
-	{
-		$_CLASS['core_template']->assign_vars_array('usernotes', array(
-			'REPORT_BY'		=> $row['username'],
-			'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
-			'ACTION'		=> $row['action'],
-			'ID'			=> $row['id'])
-		);
-	}
-}
-
-// Get Reports
-
-/*if ($_CLASS['auth']->acl_get('m_', $post_info['forum_id']))
-{
-	$sql = 'SELECT r.*, re.*, u.user_id, u.username 
-		FROM ' . REPORTS_TABLE . ' r, ' . USERS_TABLE . ' u, ' . REASONS_TABLE . " re
-		WHERE r.post_id = $post_id
-			AND r.reason_id = re.reason_id
-			AND u.user_id = r.user_id
-		ORDER BY r.report_time DESC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$_CLASS['core_template']->assign('S_SHOW_REPORTS', true);
-
-		do
-		{
-			$_CLASS['core_template']->assign_vars_array('reports', array(
-				'REPORT_ID'		=> $row['report_id'],
-				'REASON_TITLE'	=> $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_name'])],
-				'REASON_DESC'	=> $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])],
-				'REPORTER'		=> ($row['user_id'] != ANONYMOUS) ? $row['username'] : $_CLASS['core_user']->lang['GUEST'],
-				'U_REPORTER'	=> ($row['user_id'] != ANONYMOUS) ? generate_link('Members_List&amp;mode=viewprofile&amp;u='.$row['user_id']) : '',
-				'USER_NOTIFY'	=> ($row['user_notify']) ? true : false,
-				'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']),
-				'REPORT_TEXT'	=> str_replace("\n", '<br />', trim($row['report_text'])))
-			);
-		}
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	}
-	$_CLASS['core_db']->free_result($result);
-}*/
-
-// Get IP
-if ($_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']))
-{
-	$rdns_ip_num = request_var('rdns', '');
-
-	if ($rdns_ip_num != 'all')
-	{
-		$_CLASS['core_template']->assign('U_LOOKUP_ALL', generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all'));
-	}
-
-	// Get other users who've posted under this IP
-	$sql = 'SELECT u.user_id, u.username, user_posts
-		FROM ' . USERS_TABLE . ' u, ' . FORUMS_POSTS_TABLE . " p
-		WHERE p.poster_id = u.user_id
-			AND p.poster_ip = '{$post_info['poster_ip']}'
-			AND p.poster_id <> {$post_info['user_id']}
-		ORDER BY user_posts DESC";
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		// Fill the user select list with users who have posted
-		// under this IP
-		if ($row['user_id'] != $post_info['poster_id'])
-		{
-			$users_ary[strtolower($row['username'])] = $row;
-		}
-
-		$_CLASS['core_template']->assign_vars_array('userrow', array(
-			'USERNAME'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
-			'NUM_POSTS'		=> $row['user_posts'],	
-			'L_POST_S'		=> ($row['user_posts'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
-
-			'U_PROFILE'		=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']),
-			'U_SEARCHPOSTS' => generate_link('Forums&amp;file=search&amp;search_author=' . urlencode($row['username']) . '&amp;showresults=topics'))
-		);
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// Get other IP's this user has posted under
-	$sql = 'SELECT poster_ip, COUNT(*) AS postings
-		FROM ' . FORUMS_POSTS_TABLE . '
-		WHERE poster_id = ' . $post_info['poster_id'] . '
-		GROUP BY poster_ip
-		ORDER BY postings DESC';
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$hostname = (($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') && $row['poster_ip']) ? @gethostbyaddr($row['poster_ip']) : '';
-
-		$_CLASS['core_template']->assign_vars_array('iprow', array(
-			'IP'			=> $row['poster_ip'],
-			'HOSTNAME'		=> $hostname,
-			'NUM_POSTS'		=> $row['postings'],	
-			'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
-
-			'U_LOOKUP_IP'	=> ($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') ? '' : generate_link("$url&amp;i=$id&amp;mode=post_details&amp;rdns={$row['poster_ip']}#ip"),
-			'U_WHOIS'		=> generate_link("Forums&amp;file=mcp&amp;i=$id&amp;mode=whois&amp;ip={$row['poster_ip']}"))
-		);
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	// If we were not searching for a specific username fill
-	// the user_select box with users who have posted under
-	// the same IP
-	if ($action != 'chgposter_search')
-	{
-		$user_select = '';
-		ksort($users_ary);
-		foreach ($users_ary as $row)
-		{
-			$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
-		}
-		$_CLASS['core_template']->assign('S_USER_SELECT', $user_select);
-	}
-}
-
+<?php
+//**************************************************************//
+//  Vipeal CMS:													//
+//**************************************************************//
+//																//
+//  Copyright ? 2004 by Viperal									//
+//  http://www.viperal.com										//
+//																//
+//  Viperal CMS is released under the terms and conditions		//
+//  of the GNU General Public License version 2					//
+//																//
+//**************************************************************//
+
+// -------------------------------------------------------------
+//
+// $Id: mcp_post.php,v 1.4 2004/07/19 20:13:16 acydburn Exp $
+//
+// FILENAME  : mcp_post.php
+// STARTED   : Thu Jul 08, 2004
+// COPYRIGHT : ? 2004 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+
+
+$_CLASS['core_user']->add_lang('posting');
+
+$post_id = get_variable('p', 'REQUEST', false, 'int');
+$action = get_variable('action', 'REQUEST');
+
+if (!$post_id && $action !== 'whois')
+{
+	trigger_error('POST_NOT_EXIST');
+}
+
+if ($action !== 'whois')
+{
+	// Get post data
+	$post_info = get_post_data(array($post_id));
+	
+	if (empty($post_info[$post_id]))
+	{
+		trigger_error('POST_NOT_EXIST');
+	}
+	$post_info = $post_info[$post_id];
+	
+	$url = 'forums&amp;file=mcp';
+	$start	= get_variable('start', 'REQUEST', 0, 'int');
+}
+
+switch ($action)
+{
+	case 'whois':
+		$ip = get_variable('ip', 'REQUEST');
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+		$whois = user_ipwhois($ip);
+
+		$whois = preg_replace('#(\s)([\w\-\._\+]+@[\w\-\.]+)(\s)#', '\1<a href="mailto:\2">\2</a>\3', $whois);
+		$whois = preg_replace('#(\s)(http:/{2}[^\s]*)(\s)#', '\1<a href="\2" target="_blank">\2</a>\3', $whois);
+		
+		$_CLASS['core_template']->assign_array(array(
+			'RETURN_POST'	=> sprintf($_CLASS['core_user']->get_lang('RETURN_POST'), '<a href="' . generate_link("forums&amp;file=mcp&amp;mode=$mode&amp;p=$post_id") . '">', '</a>'),
+			'WHOIS'			=> trim($whois)
+		));
+
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_whois.html');
+	break;
+
+	case 'chgposter':
+	case 'chgposter_ip':
+		if ($action == 'chgposter')
+		{
+			$username = get_variable('username', 'REQUEST', '');
+			$sql_where = ($username) ?  "username = '" . $_CLASS['core_db']->escape($username) . "'" : '';
+		}
+		else
+		{
+			$new_user_id = get_variable('u', 'REQUEST', 0, 'int');
+			$sql_where = ($new_user_id) ? 'user_id = ' . $new_user_id : '';
+		}
+
+		if ($sql_where)
+		{
+			$sql = 'SELECT *
+				FROM ' . CORE_USERS_TABLE . '
+				WHERE ' . $sql_where;
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		if (!$sql_where || !$row)
+		{
+			trigger_error('NO_USER');
+		}
+
+		if ($_CLASS['forums_auth']->acl_get('m_chgposter', $post_info['forum_id']))
+		{
+			change_poster($post_info, $row);
+		}
+	break;
+}
+
+// Set some vars
+$users_ary = array();
+$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
+
+// Process message, leave it uncensored
+$message = $post_info['post_text'];
+
+if ($post_info['bbcode_bitfield'])
+{
+	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
+
+	$bbcode = new bbcode($post_info['bbcode_bitfield']);
+	$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+}
+
+$message = smiley_text($message);
+$message = str_replace("\n", '<br />', $message);
+
+$_CLASS['core_template']->assign_array(array(
+	'U_MCP_ACTION'			=> generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
+	'U_POST_ACTION'			=> generate_link("$url&amp;mode=post_details"), // Use this for action parameters
+	'U_APPROVE_ACTION'		=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;p='.$post_info['post_id']),
+
+	'S_CAN_VIEWIP'			=> $_CLASS['forums_auth']->acl_get('m_ip', $post_info['forum_id']),
+	'S_CAN_CHGPOSTER'		=> $_CLASS['forums_auth']->acl_get('m_', $post_info['forum_id']),
+	'S_CAN_LOCK_POST'		=> $_CLASS['forums_auth']->acl_get('m_lock', $post_info['forum_id']),
+	'S_CAN_DELETE_POST'		=> $_CLASS['forums_auth']->acl_get('m_delete', $post_info['forum_id']),
+
+	'S_POST_REPORTED'		=> ($post_info['post_reported']),
+	'S_POST_UNAPPROVED'		=> (!$post_info['post_approved']),
+	'S_POST_LOCKED'			=> ($post_info['post_edit_locked']),
+	'S_USER_NOTES'			=> true,
+	'S_CLEAR_ALLOWED'		=> ($_CLASS['forums_auth']->acl_get('a_clearlogs')),
+
+	'U_EDIT'				=> ($_CLASS['forums_auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("forums&amp;file=posting&amp;mode=edit&amp;p={$post_info['post_id']}") : '',
+	'U_FIND_MEMBER'			=> generate_link('members_list&amp;mode=search_user&amp;form=mcp_chgposter&amp;field=username'),
+	'U_MCP_APPROVE'			=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;p=' . $post_info['post_id']),
+	'U_MCP_REPORT'			=> generate_link('forums&amp;file=mcp&amp;i=reports&amp;mode=report_details&amp;p=' . $post_info['post_id']),
+	'U_MCP_USER_NOTES'		=> generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
+	'U_MCP_WARN_USER'		=> $_CLASS['forums_auth']->acl_get('m_warn') ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=warn&amp;mode=warn_user&amp;u=' . $post_info['user_id']) : '',
+	'U_VIEW_POST'			=> generate_link('forums&amp;file=viewtopic&amp;p=' . $post_info['post_id'] . '#p' . $post_info['post_id']),
+	'U_VIEW_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
+	'U_VIEW_TOPIC'			=> generate_link('forums&amp;file=viewtopic&amp;t=' . $post_info['topic_id']),
+
+	'RETURN_TOPIC'			=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("forums&amp;file=viewtopic&amp;p={$post_info['post_id']}#{$post_info['post_id']}").'">', '</a>'),
+	'RETURN_FORUM'			=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("forums&amp;file=viewforum&amp;f={$post_info['forum_id']}&amp;start={$start}").'">', '</a>'),
+
+	'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
+	'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
+	'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
+	'SEARCH_IMG'			=> $_CLASS['core_user']->img('btn_search', 'SEARCH_USER_POSTS'),
+	
+	'POSTER_NAME'			=> $poster,
+	'POST_PREVIEW'			=> $message,
+	'POST_SUBJECT'			=> $post_info['post_subject'],
+	'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
+	'POST_IP'				=> $post_info['poster_ip'],
+	'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
+	'POST_ID'				=> $post_info['post_id']
+));
+
+// Get User Notes
+$log_data = array();
+$log_count = 0;
+
+view_log('user', $log_data, $log_count, $config['posts_per_page'], 0, 0, 0, $post_info['user_id']);
+
+if ($log_count)
+{
+	$_CLASS['core_template']->assign('S_USER_NOTES', true);
+
+	foreach ($log_data as $row)
+	{
+		$_CLASS['core_template']->assign_vars_array('usernotes', array(
+			'REPORT_BY'		=> $row['username'],
+			'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
+			'ACTION'		=> $row['action'],
+			'ID'			=> $row['id']
+		));
+	}
+}
+
+// Get Reports
+/*
+if ($_CLASS['forums_auth']->acl_get('m_', $post_info['forum_id']))
+{
+	$sql = 'SELECT r.*, re.*, u.user_id, u.username 
+		FROM ' . FORUMS_REPORTS_TABLE . ' r, ' . CORE_USERS_TABLE . ' u, ' . DORUMS_REPORTS_REASONS_TABLE . " re
+		WHERE r.post_id = $post_id
+			AND r.reason_id = re.reason_id
+			AND u.user_id = r.user_id
+		ORDER BY r.report_time DESC";
+	$result = $_CLASS['core_db']->query($sql);
+
+	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$_CLASS['core_template']->assign('S_SHOW_REPORTS', true);
+
+		do
+		{
+			if (isset($_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) && isset($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+			{
+				$row['reson_description'] = $user->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
+				$row['reason_title'] = $user->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+			}
+
+			$_CLASS['core_template']->assign_vars_array('reports', array(
+				'REPORT_ID'		=> $row['report_id'],
+				'REASON_TITLE'	=> $row['reason_title'],
+				'REASON_DESC'	=> $row['reason_description'],
+				'REPORTER'		=> ($row['user_id'] != ANONYMOUS) ? $row['username'] : $_CLASS['core_user']->lang['GUEST'],
+				'U_REPORTER'	=> ($row['user_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']) : '',
+				'USER_NOTIFY'	=> ($row['user_notify']),
+				'REPORT_TIME'	=> $_CLASS['core_user']->format_date($row['report_time']),
+				'REPORT_TEXT'	=> str_replace("\n", '<br />', trim($row['report_text'])))
+			);
+		}
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+	}
+	$_CLASS['core_db']->free_result($result);
+}*/
+
+// Get IP
+if ($_CLASS['forums_auth']->acl_get('m_info', $post_info['forum_id']))
+{
+	$rdns_ip_num = get_variable('rdns', 'REQUEST');
+	$users_ary = array();
+
+	$_CLASS['core_template']->assign('U_LOOKUP_ALL', ($rdns_ip_num === 'all') ? false : generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all&amp;p='.$post_info['post_id']));
+
+	// Get other users who've posted under this IP
+	$sql = 'SELECT u.user_id, u.username, COUNT(*) as postings
+		FROM ' . CORE_USERS_TABLE . ' u, ' . FORUMS_POSTS_TABLE . " p
+		WHERE p.poster_id = u.user_id
+			AND p.poster_ip = '" . $_CLASS['core_db']->escape($post_info['poster_ip']) . "'
+			AND p.poster_id <> {$post_info['user_id']}
+		GROUP BY u.user_id, u.username
+		ORDER BY postings DESC";
+
+	$result = $_CLASS['core_db']->query($sql);
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		// Fill the user select list with users who have posted
+		// under this IP
+		if ($row['user_id'] != $post_info['poster_id'])
+		{
+			$users_ary[strtolower($row['username'])] = $row;
+		}
+
+		$_CLASS['core_template']->assign_vars_array('userrow', array(
+			'USERNAME'		=> ($row['user_id'] == ANONYMOUS) ? $_CLASS['core_user']->lang['GUEST'] : $row['username'],
+			'NUM_POSTS'		=> $row['postings'],	
+			'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
+
+			'U_PROFILE'		=> ($row['user_id'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']),
+			'U_SEARCHPOSTS' => generate_link('forums&amp;file=search&amp;author=' . urlencode($row['username']) . '&amp;sr=topics')
+		));
+	}
+	$_CLASS['core_db']->free_result($result);
+	
+	$user_select = '';
+	ksort($users_ary);
+
+	foreach ($users_ary as $row)
+	{
+		$user_select .= '<option value="' . $row['user_id'] . '">' . $row['username'] . "</option>\n";
+
+	}
+	$_CLASS['core_template']->assign('S_USER_SELECT', $user_select);
+
+	unset($users_ary, $user_select);
+
+	// Get other IP's this user has posted under
+	$sql = 'SELECT poster_ip, COUNT(*) AS postings
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE poster_id = ' . $post_info['poster_id'] . '
+		GROUP BY poster_ip
+		ORDER BY postings DESC';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$hostname = (($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') && $row['poster_ip']) ? @gethostbyaddr($row['poster_ip']) : '';
+
+		$_CLASS['core_template']->assign_vars_array('iprow', array(
+			'IP'			=> $row['poster_ip'],
+			'HOSTNAME'		=> $hostname,
+			'NUM_POSTS'		=> $row['postings'],	
+			'L_POST_S'		=> ($row['postings'] == 1) ? $_CLASS['core_user']->lang['POST'] : $_CLASS['core_user']->lang['POSTS'],
+
+			'U_LOOKUP_IP'	=> ($rdns_ip_num == $row['poster_ip'] || $rdns_ip_num == 'all') ? '' : generate_link("$url&amp;mode=post_details&amp;p={$post_info['post_id']}&amp;rdns={$row['poster_ip']}#ip"),
+			'U_WHOIS'		=> generate_link("forums&amp;file=mcp&amp;mode=post_details&amp;action=whois&amp;ip={$row['poster_ip']}")
+		));
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+
 page_header();
-$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_post.html');
-
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_post.html');
+
+
+/**
+* Change a post's poster
+*/
+function change_poster(&$post_info, $userdata)
+{
+	global $_CLASS;
+
+	if (empty($userdata) || $userdata['user_id'] == $post_info['user_id'])
+	{
+		return;
+	}
+
+	$post_id = $post_info['post_id'];
+
+	$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . "
+		SET poster_id = {$userdata['user_id']}
+		WHERE post_id = $post_id";
+	$_CLASS['core_db']->query($sql);
+
+	// Resync topic/forum if needed
+	if ($post_info['topic_last_post_id'] == $post_id || $post_info['forum_last_post_id'] == $post_id || $post_info['topic_first_post_id'] == $post_id)
+	{
+		sync('topic', 'topic_id', $post_info['topic_id'], false, false);
+		sync('forum', 'forum_id', $post_info['forum_id'], false, false);
+	}
+
+	// Adjust post counts
+	if ($post_info['post_postcount'])
+	{
+		$sql = 'UPDATE ' . CORE_USERS_TABLE . '
+			SET user_posts = user_posts - 1
+			WHERE user_id = ' . $post_info['user_id'];
+		$_CLASS['core_db']->query($sql);
+
+		$sql = 'UPDATE ' . CORE_USERS_TABLE . '
+			SET user_posts = user_posts + 1
+			WHERE user_id = ' . $userdata['user_id'];
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Add posted to information for this topic for the new user
+	//markread('post', $post_info['forum_id'], $post_info['topic_id'], $_CLASS['core_user']->time, $userdata['user_id']);
+
+	// Remove the dotted topic option if the old user has no more posts within this topic
+	/*if ($config['load_db_track'] && $post_info['user_id'] != ANONYMOUS)
+	{
+		$sql = 'SELECT topic_id
+			FROM ' . FORUMS_POSTS_TABLE . '
+			WHERE topic_id = ' . $post_info['topic_id'] . '
+				AND poster_id = ' . $post_info['user_id'];
+		$result = $_CLASS['core_db']->query_limit($sql, 1);
+		$topic_id = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$topic_id = (int) $topic_id['topic_id'];
+
+		if (!$topic_id)
+		{
+			$sql = 'DELETE FROM ' . FORUMS_TOPICS_POSTED_TABLE . '
+				WHERE user_id = ' . $post_info['user_id'] . '
+					AND topic_id = ' . $post_info['topic_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}*/
+
+	// Do not change the poster_id within the attachments table, since they were still posted by the original user
+
+	$from_username = $post_info['username'];
+	$to_username = $userdata['username'];
+
+	// Renew post info
+	$post_info = get_post_data(array($post_id));
+
+	if (empty($post_info[$post_id]))
+	{
+		trigger_error($user->lang['POST_NOT_EXIST']);
+	}
+
+	$post_info = $post_info[$post_id];
+
+	// Now add log entry
+	add_log('mod', $post_info['forum_id'], $post_info['topic_id'], 'LOG_MCP_CHANGE_POSTER', $post_info['topic_title'], $from_username, $to_username);
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_queue.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -23,316 +23,339 @@
 // 
 // -------------------------------------------------------------
 
-class mcp_queue extends module
-{
 
-	function mcp_queue($id, $mode, $url)
-	{
-		global $_CLASS, $site_file_root, $config;
+global $_CLASS, $site_file_root, $config;
 
-		$forum_id = request_var('f', 0);
-		$start = request_var('start', 0);
+$forum_id = request_var('f', 0);
+$start = request_var('start', 0);
+$action = get_variable('action', 'REQUEST');
+$mode = get_variable('mode', 'REQUEST');
 
-		switch ($mode)
+
+switch ($action)
+{
+	case 'approve':
+	case 'disapprove':
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+
+		$post_id_list = array_unique(get_variable('post_id_list', 'REQUEST', array(), 'array:int'));
+
+		if (empty($post_id_list))
 		{
-			case 'approve':
-			case 'disapprove':
-				require_once($site_file_root.'includes/forums/functions_messenger.php');
-				require_once($site_file_root.'includes/forums/functions_posting.php');
+			trigger_error('NO_POST_SELECTED');
+		}
 
-				$post_id_list = request_var('post_id_list', array(0));
+		($mode === 'approve') ? approve_post($post_id_list, $mode) : disapprove_post($post_id_list, $mode);
+	break;
+}
 
-				if (!sizeof($post_id_list))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
+switch ($mode)
+{
+	case 'approve_details':
+		$_CLASS['core_user']->add_lang('posting');
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
-				if ($mode == 'approve')
-				{
-					approve_post($post_id_list);
-				}
-				else
-				{
-					disapprove_post($post_id_list);
-				}
+		$post_id = get_variable('p', 'REQUEST', false, 'int');
+		$topic_id = get_variable('t', 'REQUEST', false, 'int');
 
-				break;
-			
-			case 'approve_details':
-				
-				$_CLASS['core_user']->add_lang('posting');
-				require_once($site_file_root.'includes/forums/functions_posting.php');
+		if ($topic_id)
+		{
+			$topic_info = get_topic_data(array($topic_id), 'm_approve');
+			$post_id = isset($topic_info[$topic_id]['topic_first_post_id']) ? (int) $topic_info[$topic_id]['topic_first_post_id'] : false;
+		}
 
-				$post_id = request_var('p', 0);
-				$topic_id = request_var('t', 0);
+		$post_info = ($post_id/) ? get_post_data(array($post_id), 'm_approve') : false;
 
-				if ($topic_id)
-				{
-					$topic_info = get_topic_data(array($topic_id), 'm_approve');
-					$post_id = (int) $topic_info[$topic_id]['topic_first_post_id'];
-				}
+		if (!$post_id || empty($post_info[$post_id]))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
 
-				$post_info = get_post_data(array($post_id), 'm_approve');
+		$post_info = $post_info[$post_id];
 
-				if (!sizeof($post_info))
-				{
-					trigger_error('NO_POST_SELECTED');
-				}
+		if ($post_info['topic_first_post_id'] != $post_id && topic_review($post_info['topic_id'], $post_info['forum_id'], 'topic_review', 0, false))
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'S_TOPIC_REVIEW'	=> true,
+				'TOPIC_TITLE'		=> $post_info['topic_title'])
+			);
+		}
 
-				$post_info = $post_info[$post_id];
+		// Set some vars
+		if ($post_info['user_id'] == ANONYMOUS)
+		{
+			$post_info['username'] = ($post_info['post_username']) ? $post_info['post_username'] : $_CLASS['core_user']->lang['GUEST'];
+		}
 
-				if ($post_info['topic_first_post_id'] != $post_id && topic_review($post_info['topic_id'], $post_info['forum_id'], 'topic_review', 0, false))
-				{
-					$_CLASS['core_template']->assign_array(array(
-						'S_TOPIC_REVIEW'	=> true,
-						'TOPIC_TITLE'		=> $post_info['topic_title'])
-					);
-				}
+		$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
 
-				// Set some vars
-				$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
+		// Process message, leave it uncensored
+		$message = $post_info['post_text'];
+		if ($post_info['bbcode_bitfield'])
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 
-				// Process message, leave it uncensored
-				$message = $post_info['post_text'];
-				if ($post_info['bbcode_bitfield'])
-				{
-					require_once($site_file_root.'includes/forums/bbcode.php');
-					$bbcode = new bbcode($post_info['bbcode_bitfield']);
-					$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
-				}
-				$message = smiley_text($message);
+			$bbcode = new bbcode($post_info['bbcode_bitfield']);
+			$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+		}
+		$message = smiley_text($message);
 
-				$_CLASS['core_template']->assign_array(array(
-					'S_MCP_QUEUE'			=> true,
-					'S_APPROVE_ACTION'		=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;p=$post_id&amp;f=$forum_id"),
-					
-					'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_ip', $post_info['forum_id']),
-					'S_POST_REPORTED'		=> $post_info['post_reported'],
-					'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
-					'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
+		$_CLASS['core_template']->assign_array(array(
+			'S_MCP_QUEUE'			=> true,
+			'S_APPROVE_ACTION'		=> generate_link("forums&amp;file=mcp&amp;i=queue&amp;p=$post_id&amp;f=$forum_id"),
+			'S_CAN_VIEWIP'			=> $_CLASS['auth']->acl_get('m_info', $post_info['forum_id']),
+			'S_POST_REPORTED'		=> $post_info['post_reported'],
+			'S_POST_UNAPPROVED'		=> !$post_info['post_approved'],
+			'S_POST_LOCKED'			=> $post_info['post_edit_locked'],
 //					'S_USER_NOTES'			=> ($post_info['user_notes']) ? true : false,
-					'S_USER_WARNINGS'		=> ($post_info['user_warnings']) ? true : false,
 
-					'U_VIEW_PROFILE'		=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
-					'U_MCP_USERNOTES'		=> generate_link('Forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
-					'U_MCP_WARNINGS'		=> generate_link('Forums&amp;file=mcp&amp;i=warnings&amp;mode=view_user&amp;u=' . $post_info['user_id']),
-					'U_EDIT'				=> ($_CLASS['auth']->acl_get('m_edit', $post_info['forum_id'])) ? generate_link("Forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
+			'U_EDIT'				=> $_CLASS['auth']->acl_get('m_edit', $post_info['forum_id']) ? generate_link("forums&amp;file=posting&amp;mode=edit&amp;f={$post_info['forum_id']}&amp;p={$post_info['post_id']}") : '',
+			'U_MCP_APPROVE'			=>  generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;f=' . $post_info['forum_id'] . '&amp;p=' . $post_id),
+			'U_MCP_REPORT'			=>  generate_link('forums&amp;file=mcp&amp;i=reports&amp;mode=report_details&amp;f=' . $post_info['forum_id'] . '&amp;p=' . $post_id),
+			'U_MCP_USER_NOTES'		=>  generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
+			'U_MCP_WARN_USER'		=> $_CLASS['auth']->acl_get('m_warn') ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_user&amp;u=' . $post_info['user_id']) : '',
+			'U_VIEW_POST'			=> generate_link('forums&amp;file=viewtopic&amp;p=' . $post_info['post_id'] . '#p' . $post_info['post_id']),
+			'U_VIEW_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
+			'U_VIEW_TOPIC'			=> generate_link('forums&amp;file=viewtopic&amp;t=' . $post_info['topic_id']),
 
-					'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
-					'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
-					'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
+			'RETURN_QUEUE'			=> sprintf($_CLASS['core_user']->lang['RETURN_QUEUE'], '<a href="' . generate_link('forums&amp;file=mcp&amp;i=queue' . (($topic_id) ? '&amp;mode=unapproved_topics' : '&amp;mode=unapproved_posts')) . "&amp;start=$start\">", '</a>'),
+			'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
+			'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
+			'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
 
-					'POSTER_NAME'			=> $poster,
-					'POST_PREVIEW'			=> $message,
-					'POST_SUBJECT'			=> $post_info['post_subject'],
-					'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
-					'POST_IP'				=> $post_info['poster_ip'],
-					'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
-					'POST_ID'				=> $post_info['post_id'])
-				);
+			'POSTER_NAME'			=> $poster,
+			'POST_PREVIEW'			=> $message,
+			'POST_SUBJECT'			=> $post_info['post_subject'],
+			'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
+			'POST_IP'				=> $post_info['poster_ip'],
+			'POST_IPADDR'			=> @gethostbyaddr($post_info['poster_ip']),
+			'POST_ID'				=> $post_info['post_id']
+		));
 
-				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_post.html');
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP_QUEUE'), 'modules/forums/mcp_post.html');
+	break;
 
-				break;
+	case 'unapproved_topics':
+	case 'unapproved_posts':
+		$forum_info = array();
+		$topic_id = get_variable('t', 'REQUEST', false, 'int');
 
-			case 'unapproved_topics':
-			case 'unapproved_posts':
-				$forum_info = array();
+		if ($topic_id)
+		{
+			$topic_info = get_topic_data(array($topic_id));
+
+			if (empty($topic_info[$topic_id]))
+			{
+				trigger_error('TOPIC_NOT_EXIST');
+			}
+
+			$topic_info = $topic_info[$topic_id];
+			$forum_id = $topic_info['forum_id'];
+		}
 
-				$forum_list_approve = get_forum_list('m_approve', false, true);
+		$forum_list_approve = get_forum_list('m_approve', false, true);
 
-				if (!$forum_id)
-				{
-					$forum_list = array();
-					foreach ($forum_list_approve as $row)
-					{
-						$forum_list[] = $row['forum_id'];
-					}
-					
-					if (!$forum_list = implode(', ', $forum_list))
-					{
-						trigger_error('NOT_MODERATOR');
-					}
+		if (!$forum_id)
+		{
+			$forum_list = array();
+			foreach ($forum_list_approve as $row)
+			{
+				$forum_list[] = $row['forum_id'];
+			}
+			
+			if (!$forum_list = implode(', ', $forum_list))
+			{
+				trigger_error('NOT_MODERATOR');
+			}
 
-					$sql = 'SELECT SUM(forum_topics) as sum_forum_topics 
-						FROM ' . FORUMS_FORUMS_TABLE . "
-						WHERE forum_id IN ($forum_list)";
-					$result = $_CLASS['core_db']->query($sql);
-					$row = $_CLASS['core_db']->fetch_row_assoc($result);
-					$_CLASS['core_db']->free_result($result);
+			$sql = 'SELECT SUM(forum_topics) as sum_forum_topics 
+				FROM ' . FORUMS_FORUMS_TABLE . "
+				WHERE forum_id IN ($forum_list)";
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
 
-					$forum_info['forum_topics'] = (int) $row['sum_forum_topics'];
-				}
-				else
-				{
-					$forum_info = get_forum_data(array($forum_id), 'm_approve');
+			$forum_info['forum_topics'] = (int) $row['sum_forum_topics'];
+		}
+		else
+		{
+			$forum_info = get_forum_data(array($forum_id), 'm_approve');
 
-					if (!sizeof($forum_info))
-					{
-						trigger_error('NOT_MODERATOR');
-					}
+			if (empty($forum_info[$forum_id]))
+			{
+				trigger_error('NOT_MODERATOR');
+			}
 
-					$forum_info = $forum_info[$forum_id];
-					$forum_list = $forum_id;
-				}
+			$forum_info = $forum_info[$forum_id];
+			$forum_list = $forum_id;
+		}
 
-				$forum_options = '<option value="0"' . (($forum_id == 0) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ALL_FORUMS'] . '</option>';
-				foreach ($forum_list_approve as $row)
-				{
-					$forum_options .= '<option value="' . $row['forum_id'] . '"' . (($forum_id == $row['forum_id']) ? ' selected="selected"' : '') . '>' . $row['forum_name'] . '</option>';
-				}
+		$forum_options = '<option value="0"' . (($forum_id == 0) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['ALL_FORUMS'] . '</option>';
+		foreach ($forum_list_approve as $row)
+		{
+			$forum_options .= '<option value="' . $row['forum_id'] . '"' . (($forum_id == $row['forum_id']) ? ' selected="selected"' : '') . '>' . $row['forum_name'] . '</option>';
+		}
 
-				mcp_sorting($mode, $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
-				$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
-				$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . (time() - ($sort_days * 86400)) : '';
+		mcp_sorting($mode, $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id);
 
-				if ($mode == 'unapproved_posts')
-				{
-					$sql = 'SELECT p.post_id
-						FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . USERS_TABLE . ' u' : '') . "
-						WHERE p.forum_id IN ($forum_list)
-							AND p.post_approved = 0
-							" . (($sort_order_sql{0} == 'u') ? 'AND u.user_id = p.poster_id' : '') . "
-							AND t.topic_id = p.topic_id
-							AND t.topic_first_post_id <> p.post_id
-						ORDER BY $sort_order_sql";
-					$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
+		$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
+		$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
-					$i = 0;
-					$post_ids = array();
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$post_ids[] = $row['post_id'];
-						$row_num[$row['post_id']] = $i++;
-					}
+		if ($mode == 'unapproved_posts')
+		{
+			$sql = 'SELECT DISTINCT p.post_id
+				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . CORE_USERS_TABLE . ' u' : '') . "
+				WHERE p.forum_id IN (0, $forum_list)
+					AND p.post_approved = 0
+					" . (($sort_order_sql{0} == 'u') ? 'AND u.user_id = p.poster_id' : '') . '
+					' . (($topic_id) ? 'AND p.topic_id = ' . $topic_id : '') . "
+					AND t.topic_id = p.topic_id
+					AND t.topic_first_post_id <> p.post_id
+				ORDER BY $sort_order_sql";
+			$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
 
-					if (sizeof($post_ids))
-					{
-						$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, p.post_id, p.post_username, p.poster_id, p.post_time, u.username
-							FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . ' t, ' . USERS_TABLE . " u
-							WHERE p.post_id IN (" . implode(', ', $post_ids) . ")
-								AND t.topic_id = p.topic_id
-								AND f.forum_id = p.forum_id
-								AND u.user_id = p.poster_id";
+			$i = 0;
+			$post_ids = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$post_ids[] = $row['post_id'];
+				$row_num[$row['post_id']] = $i++;
+			}
 
-						$result = $_CLASS['core_db']->query($sql);
-						$post_data = $rowset = array();
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-						{
-							$post_data[$row['post_id']] = $row;
-						}
-						$_CLASS['core_db']->free_result($result);
+			if (!Empty($post_ids))
+			{
+				$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, p.post_id, p.post_username, p.poster_id, p.post_time, u.username
+					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_FORUMS_TABLE . ' f, ' . FORUMS_TOPICS_TABLE . ' t, ' . CORE_USERS_TABLE . " u
+					WHERE p.post_id IN (" . implode(', ', $post_ids) . ")
+						AND t.topic_id = p.topic_id
+						AND f.forum_id = p.forum_id
+						AND u.user_id = p.poster_id";
 
-						foreach ($post_ids as $post_id)
-						{
-							$rowset[] = $post_data[$post_id];
-						}
-						unset($post_data, $post_ids);
-					}
-					else
-					{
-						$rowset = array();
-					}
+				$rowset = array_flip($post_ids);
+				unset($post_ids);
+
+				$result = $_CLASS['core_db']->query($sql);
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$rowset[$row['post_id']] = $row;
 				}
-				else
+				$_CLASS['core_db']->free_result($result);
+
+
+				/*$post_data = $rowset = array();
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
-					$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, t.topic_time AS post_time, t.topic_poster AS poster_id, t.topic_first_post_id AS post_id, t.topic_first_poster_name AS username
-						FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
-						WHERE t.topic_approved = 0
-							AND t.forum_id IN ($forum_list)
-							AND f.forum_id = t.forum_id
-						ORDER BY $sort_order_sql";
-					$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
-
-					$rowset = array();
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-					{
-						$rowset[] = $row;
-					}
-					$_CLASS['core_db']->free_result($result);
+					$post_data[$row['post_id']] = $row;
 				}
+				$_CLASS['core_db']->free_result($result);
 
-				foreach ($rowset as $row)
+				foreach ($post_ids as $post_id)
 				{
-					if ($row['poster_id'] == ANONYMOUS)
-					{
-						$poster = (!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST'];
-					}
-					else
-					{
-						$poster = $row['username'];
-					}
+					$rowset[] = $post_data[$post_id];
+				}
+				unset($post_data, $post_ids);*/
+			}
+			else
+			{
+				$rowset = array();
+			}
+		}
+		else
+		{
+			$sql = 'SELECT f.forum_id, f.forum_name, t.topic_id, t.topic_title, t.topic_time AS post_time, t.topic_poster AS poster_id, t.topic_first_post_id AS post_id, t.topic_first_poster_name AS username
+				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_FORUMS_TABLE . " f
+				WHERE t.topic_approved = 0
+					AND t.forum_id IN ($forum_list)
+					AND f.forum_id = t.forum_id
+				ORDER BY $sort_order_sql";
+			$result = $_CLASS['core_db']->query_limit($sql, $config['topics_per_page'], $start);
 
-					$s_checkbox = '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" />';
+			$rowset = array();
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$rowset[] = $row;
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
 
-					$_CLASS['core_template']->assign_vars_array('postrow', array(
-						'U_VIEWFORUM'	=> generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']),
-						// Q: Why accessing the topic by a post_id instead of its topic_id?
-						// A: To prevent the post from being hidden because of wrong encoding or different charset
-						'U_VIEWTOPIC'	=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $row['forum_id'] . '&amp;p=' . $row['post_id'] . (($mode == 'unapproved_posts') ? '#' . $row['post_id'] : '')),
-						'U_VIEW_DETAILS'=> generate_link("Forums&amp;file=mcp&amp;i=queue&amp;start=$start&amp;mode=approve_details&amp;f={$forum_id}&amp;p={$row['post_id']}"),
-						'U_VIEWPROFILE'	=> ($row['poster_id'] != ANONYMOUS) ? generate_link("Members_List&amp;mode=viewprofile&amp;u={$row['poster_id']}") : '',
+		foreach ($rowset as $row)
+		{
+			if ($row['poster_id'] == ANONYMOUS)
+			{
+				$poster = (!empty($row['post_username'])) ? $row['post_username'] : $_CLASS['core_user']->lang['GUEST'];
+			}
+			else
+			{
+				$poster = $row['username'];
+			}
 
-						'FORUM_NAME'	=> $row['forum_name'],
-						'TOPIC_TITLE'	=> $row['topic_title'],
-						'POSTER'		=> $poster,
-						'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']),
-						'S_CHECKBOX'	=> $s_checkbox)
-					);
-				}
-				unset($rowset);
+			$s_checkbox = '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" />';
 
-				// Now display the page
-				$_CLASS['core_template']->assign_array(array(
-					'L_DISPLAY_ITEMS'		=> ($mode == 'unapproved_posts') ? $_CLASS['core_user']->lang['DISPLAY_POSTS'] : $_CLASS['core_user']->lang['DISPLAY_TOPICS'],
-					'S_FORUM_OPTIONS'		=> $forum_options)
-				);
+			$_CLASS['core_template']->assign_vars_array('postrow', array(
+				'U_VIEWFORUM'	=> generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']),
+				// Q: Why accessing the topic by a post_id instead of its topic_id?
+				// A: To prevent the post from being hidden because of wrong encoding or different charset
+				'U_VIEWTOPIC'	=> generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id'] . (($mode === 'unapproved_posts') ? '#' . $row['post_id'] : '')),
+				'U_VIEW_DETAILS'=> generate_link("forums&amp;file=mcp&amp;i=queue&amp;start=$start&amp;mode=approve_details&amp;p={$row['post_id']}" . (($mode === 'unapproved_topics') ? "&amp;t={$row['topic_id']}" : '')),
+				'U_VIEWPROFILE'	=> ($row['poster_id'] != ANONYMOUS) ? generate_link("members_list&amp;mode=viewprofile&amp;u={$row['poster_id']}") : '',
 
-				$this->display($_CLASS['core_user']->lang['MCP_QUEUE'], 'mcp_queue.html');
-				break;
+				'POST_ID'		=> $row['post_id'],
+				'FORUM_NAME'	=> ($row['forum_id']) ? $row['forum_name'] : $_CLASS['core_user']->lang['GLOBAL_ANNOUNCEMENT'],
+				'POST_SUBJECT'	=> $row['topic_title'],
+				'POSTER'		=> $poster,
+				'POST_TIME'		=> $_CLASS['core_user']->format_date($row['post_time']),
+			));
 		}
-	}
+		unset($rowset);
 
-	function install()
-	{
-	}
+		$pagination = generate_pagination('forums&amp;file=mcp&amp;f='.$forum_id, $total, $config['topics_per_page'], $start)
 
-	function uninstall()
-	{
-	}
+		// Now display the page
+		$_CLASS['core_template']->assign_array(array(
+			'L_DISPLAY_ITEMS'		=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['DISPLAY_POSTS'] : $_CLASS['core_user']->lang['DISPLAY_TOPICS'],
+			'L_EXPLAIN'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN'] : $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'],
+			'L_TITLE'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_POSTS'] : $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_TOPICS'],
+			'L_ONLY_TOPIC'			=> ($topic_id) ? sprintf($_CLASS['core_user']->lang['ONLY_TOPIC'], $topic_info['topic_title']) : '',
+
+			'S_FORUM_OPTIONS'		=> $forum_options,
+			'S_MCP_ACTION'			=> build_url(array('t', 'f', 'sd', 'st', 'sk')),
+			'S_TOPICS'				=> ($mode === 'unapproved_posts') ? false : true,
+
+			'PAGINATION'			=> $pagination['formated'],
+			'PAGINATION_ARRAY'		=> $pagination['array'],
+			'PAGE_NUMBER'			=> on_page($total, $config['topics_per_page'], $start),
+			'TOPIC_ID'				=> $topic_id,
+			'TOTAL'					=> $total
+		));
 
-	function module()
-	{
-		$details = array(
-			'name'			=> 'MCP - Queue',
-			'description'	=> 'Module for management of items waiting for approval', 
-			'filename'		=> 'queue',
-			'version'		=> '0.1.0', 
-			'phpbbversion'	=> '2.2.0'
-		);
-		return $details;
-	}
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP_QUEUE'), 'modules/forums/mcp_queue.html');
+	break;
 }
 
-// Approve Post/Topic
-function approve_post($post_id_list)
+
+/**
+* Approve Post/Topic
+*/
+function approve_post($post_id_list, $mode)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
+	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
 
-	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
+	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 	$success_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
+		'i'				=> 'queue',
+		'mode'			=> $mode,
 		'post_id_list'	=> $post_id_list,
 		'f'				=> $forum_id,
-		'mode'			=> 'approve',
-		'redirect'		=> $redirect)
-	);
+		'action'		=> 'approve',
+		'redirect'		=> $redirect
+	));
 
 	if (confirm_box(true))
 	{
@@ -351,7 +374,7 @@
 			$topic_id_list[$post_data['topic_id']] = 1;
 			
 			// Topic or Post. ;)
-			if ($post_data['topic_first_post_id'] == $post_id && $post_data['topic_last_post_id'] == $post_id)
+			if ($post_data['topic_first_post_id'] == $post_id)
 			{
 				if ($post_data['forum_id'])
 				{
@@ -436,7 +459,7 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-		$messenger = new messenger();
+/*		$messenger = new messenger();
 
 		// Notify Poster?
 		if ($notify_poster)
@@ -465,8 +488,8 @@
 					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
 					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']),
 
-					'U_VIEW_TOPIC'	=> generate_link("Forums&amp;file=viewtopic&amp;f=$forum_id&t={$post_data['topic_id']}&e=0"),
-					'U_VIEW_POST'	=> generate_link("Forums&amp;file=viewtopic7amp;f=$forum_id&t={$post_data['topic_id']}&p=$post_id&e=$post_id"))
+					'U_VIEW_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&t={$post_data['topic_id']}&e=0"),
+					'U_VIEW_POST'	=> generate_link("forums&amp;file=viewtopic7amp;f=$forum_id&t={$post_data['topic_id']}&p=$post_id&e=$post_id"))
 				);
 
 				$messenger->send($post_data['user_notify_type']);
@@ -474,7 +497,7 @@
 			}
 			$messenger->save_queue();
 		}
-
+*/
 		// Send out normal user notifications
 		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 		
@@ -509,10 +532,10 @@
 			'S_APPROVE'			=> true)
 		);
 
-		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
+		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'modules/forums/mcp_approve.html');
 	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)
 	{
@@ -521,53 +544,59 @@
 	else
 	{
 		$_CLASS['core_display']->meta_refresh(3, $redirect);
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_PAGE'], '<a href="' . $redirect . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
 	}
 }
 
-// Disapprove Post/Topic
+/**
+* Disapprove Post/Topic
+*/
 function disapprove_post($post_id_list)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!($forum_id = check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve')))
+	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
 
 	$redirect = request_var('redirect', $_CLASS['core_user']->data['session_page']);
-	$reason = request_var('reason', '');
+	$reason = request_var('reason', '', true);
 	$reason_id = request_var('reason_id', 0);
 	$success_msg = $additional_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
+		'i'				=> 'queue',
+		'mode'			=> $mode,
 		'post_id_list'	=> $post_id_list,
 		'f'				=> $forum_id,
 		'mode'			=> 'disapprove',
-		'redirect'		=> $redirect)
-	);
+		'redirect'		=> $redirect
+	));
 
-	$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
+	$notify_poster = isset($_REQUEST['notify_poster']);
+	$disapprove_reason = '';
 
 	if ($reason_id)
 	{
-		$sql = 'SELECT reason_name 
-			FROM ' . REASONS_TABLE . " 
+		$sql = 'SELECT reason_title, reason_description
+			FROM ' . FORUMS_REPORTS_REASONS_TABLE . " 
 			WHERE reason_id = $reason_id";
 		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)) || (!$reason && $row['reason_name'] == 'other'))
+		if (!$row || (!$reason && $row['reason_name'] === 'other'))
 		{
-			$additional_msg = 'Please give an appropiate reason for disapproval';
+			$additional_msg = $_CLASS['core_user']->lang['NO_REASON_DISAPPROVAL'];
 			unset($_POST['confirm']);
 		}
 		else
 		{
-			$disapprove_reason = ($row['reason_name'] != 'other') ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_name'])] : '';
-			$disapprove_reason .= ($reason) ? "\n\n" . $_REQUEST['reason'] : '';
+			$disapprove_reason = ($row['reason_title'] != 'other') ? ((isset($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])] : $row['reason_description']) : '';
+			$disapprove_reason .= ($reason) ? "\n\n" . $reason : '';
 			unset($reason);
 		}
-		$_CLASS['core_db']->free_result($result);
 	}
 
 	if (confirm_box(true))
@@ -609,17 +638,17 @@
 		
 		if ($forum_topics_real)
 		{
-			$sql = 'UPDATE ' . FORUMS_TABLE . "
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
 				SET forum_topics_real = forum_topics_real - $forum_topics_real
 				WHERE forum_id = $forum_id";
 			$_CLASS['core_db']->query($sql);
 		}
 
-		if (sizeof($topic_replies_real_sql))
+		if (!empty($topic_replies_real_sql))
 		{
 			foreach ($topic_replies_real_sql as $topic_id => $num_replies)
 			{
-				$sql = 'UPDATE ' . TOPICS_TABLE . "
+				$sql = 'UPDATE ' . FORUMS_TOPICS_TABLE . "
 					SET topic_replies_real = topic_replies_real - $num_replies
 					WHERE topic_id = $topic_id";
 				$_CLASS['core_db']->query($sql);
@@ -628,6 +657,11 @@
 
 		if (sizeof($post_disapprove_sql))
 		{
+			if (!function_exists('delete_posts'))
+			{
+				require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
+			}
+
 			// We do not check for permissions here, because the moderator allowed approval/disapproval should be allowed to delete the disapproved posts
 			delete_posts('post_id', $post_disapprove_sql);
 		}
@@ -637,7 +671,7 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-		$messenger = new messenger();
+		/*$messenger = new messenger();
 
 		// Notify Poster?
 		if ($notify_poster)
@@ -672,7 +706,7 @@
 				$messenger->reset();
 			}
 			$messenger->save_queue();
-		}
+		}*/
 		unset($post_info, $disapprove_reason);
 
 		if ($forum_topics_real)
@@ -686,48 +720,30 @@
 	}
 	else
 	{
-		$sql = 'SELECT * 
-			FROM ' . REASONS_TABLE . ' 
-			ORDER BY reason_priority ASC';
-		$result = $_CLASS['core_db']->query($sql);
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
+		display_reasons($reason_id);
+
+		$_CLASS['core_template']->assign_array(array(
+			'S_NOTIFY_POSTER'	=> true,
+			'S_APPROVE'			=> false,
+			'REASON'			=> $reason,
+			'ADDITIONAL_MSG'	=> $additional_msg
+		));
 
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$row['reason_name'] = strtoupper($row['reason_name']);
-
-			$reason_title = (!empty($_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['TITLE'][$row['reason_name']] : ucwords(str_replace('_', ' ', $row['reason_name']));
-
-			$reason_desc = (!empty($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']])) ? $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][$row['reason_name']] : $row['reason_desc'];
-
-			$_CLASS['core_template']->assign_vars_array('reason', array(
-				'ID'			=>	$row['reason_id'],
-				'NAME'			=>	htmlspecialchars($reason_title),
-				'DESCRIPTION'	=>	htmlspecialchars($reason_desc),
-				'S_SELECTED'	=>	($row['reason_id'] == $reason_id) ? true : false)
-			);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		$_CLASS['core_template']->assign_array(array(
-			'S_NOTIFY_POSTER'	=> true,
-			'S_APPROVE'			=> false,
-			'REASON'			=> $reason,
-			'ADDITIONAL_MSG'	=> $additional_msg)
-		);
-
 		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
 	}
 
-	$redirect = request_var('redirect', generate_link('Forums'));
+	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)
 	{
-		url_redirect($redirect);
+		redirect($redirect);
 	}
 	else
 	{
-		$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=viewforum&amp;f=$forum_id"));
-		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
+		$_CLASS['core_display']->meta_refresh(3, generate_link("forums&amp;file=viewforum&amp;f=$forum_id"));
+		trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link('forums&amp;file=viewforum&amp;f=' . $forum_id) . '">', '</a>'));
 	}
 }
 

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -53,29 +53,21 @@
 
 $topic_info = $topic_info[$topic_id];
 
-$url = 'Forums&amp;file=mcp&amp;t='.$topic_id;
+$url = 'forums&amp;file=mcp&amp;t='.$topic_id;
 
 $action = get_variable('action', 'REQUEST');
 $icon_id = get_variable('icon', 'REQUEST', false, 'int');
 $subject = get_variable('subject', 'POST');
-
 $start = get_variable('start', 'REQUEST', false, 'int');
-
 $to_topic_id = get_variable('to_topic_id', 'REQUEST', false, 'int');
 $to_forum_id = get_variable('to_forum_id', 'REQUEST', false, 'int');
+$post_id_list = array_unique(get_variable('post_id_list', 'REQUEST', array(), 'array:int'));
 
-$post_id_list = array_unique(request_var('post_id_list', array(0)));
-//echo $action;
 // Split Topic?
 if ($action === 'split_all' || $action === 'split_beyond')
 {
-	if (empty($post_id_list))
+	if ($message = split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject))
 	{
-		trigger_error('NO_POST_SELECTED');
-	}
-
-	if ($message = split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject))
-	{
 		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->get_lang($message));
 	}
 
@@ -86,21 +78,22 @@
 if ($action == 'merge_posts')
 {
 	merge_posts($topic_id, $to_topic_id);
-
 	$action = 'merge';
 }
 
-$topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
-
 if ($action === 'split' && !$subject)
 {
 	$subject = $topic_info['topic_title'];
 }
 
+$topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
+
 $where_sql = ($action === 'reports') ? 'WHERE post_reported = 1 AND ' : 'WHERE';
+
+$sort_days = $total = 0;
+$sort_by_sql = $sort_key = $sort_dir = '';
 mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $topic_info['forum_id'], $topic_id, $where_sql);
 
-$forum_topics = ($total == -1) ? $topic_info['forum_topics'] : $total;
 $limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
 if ($total == -1)
@@ -108,10 +101,10 @@
 	$total = $topic_info['topic_replies'] + 1;
 }
 
-$posts_per_page = max(0, get_variable('posts_per_page', 'POST', intval($config['posts_per_page'])));
+$posts_per_page = max(0, get_variable('posts_per_page', 'POST', intval($config['posts_per_page']), 'int'));
 
 $sql = 'SELECT u.username, u.user_colour, p.*
-	FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . ' u
+	FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . ' u
 	WHERE ' . (($action == 'reports') ? 'p.post_reported = 1 AND ' : '') . "
 		p.topic_id = {$topic_id}
 		AND p.poster_id = u.user_id
@@ -119,17 +112,18 @@
 $result = $_CLASS['core_db']->query_limit($sql, $posts_per_page, $start);
 
 $rowset = array();
-$bbcode_bitfield = 0;
+$bbcode_bitfield = '';
 
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	$rowset[] = $row;
-	$bbcode_bitfield |= $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
 }
+$_CLASS['core_db']->free_result($result);
 
 if ($bbcode_bitfield)
 {
-	require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 	$bbcode = new bbcode($bbcode_bitfield);
 }
 
@@ -140,7 +134,7 @@
 	$poster = ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster;
 
 	$message = $row['post_text'];
-	$post_subject = ($row['post_subject'] != '') ? $row['post_subject'] : $topic_info['topic_title'];
+	$post_subject = ($row['post_subject']) ? $row['post_subject'] : $topic_info['topic_title'];
 
 	// If the board has HTML off but the post has HTML
 	// on then we process it, else leave it alone
@@ -157,9 +151,6 @@
 	$message = smiley_text($message);
 	$message = str_replace("\n", '<br />', $message);
 
-	$checked = ($post_id_list && in_array(intval($row['post_id']), $post_id_list)) ? 'checked="checked" ' : '';
-	$s_checkbox = ($row['post_id'] == $topic_info['topic_first_post_id'] && $action == 'split') ? '&nbsp;' : '<input type="checkbox" name="post_id_list[]" value="' . $row['post_id'] . '" ' . $checked . '/>';
-
 	if (!$row['post_approved'])
 	{
 		$has_unapproved_posts = true;
@@ -171,26 +162,29 @@
 		'POST_SUBJECT'	=> $post_subject,
 		'MESSAGE'		=> $message,
 		'POST_ID'		=> $row['post_id'],
+		'RETURN_TOPIC'	=> sprintf($_CLASS['core_user']->get_lang('RETURN_TOPIC'), '<a href="' . generate_link('forums&amp;file=viewtopic&amp;t=' . $topic_id) . '">', '</a>'),
 
 		'MINI_POST_IMG' => ($row['post_time'] > $_CLASS['core_user']->data['user_last_visit'] && $_CLASS['core_user']->is_user) ? $_CLASS['core_user']->img('icon_post_new', $_CLASS['core_user']->lang['NEW_POST']) : $_CLASS['core_user']->img('icon_post', $_CLASS['core_user']->lang['POST']),
 		
-		'S_CHECKBOX'		=> $s_checkbox,
-		'S_POST_REPORTED'	=> ($row['post_reported']) ? true : false,
-		'S_POST_UNAPPROVED'	=> ($row['post_approved']) ? false : true,
+		'S_CHECKED'			=> ($post_id_list && in_array(intval($row['post_id']), $post_id_list)),
+		'S_POST_REPORTED'	=> ($row['post_reported']),
+		'S_POST_UNAPPROVED'	=> (!$row['post_approved']),
 					
 		'U_POST_DETAILS'	=> generate_link("$url&amp;p={$row['post_id']}&amp;mode=post_details"),
-		'U_MCP_APPROVE'		=> generate_link('Forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id']))
-	);
+		'U_MCP_APPROVE'		=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;p=' . $row['post_id']),
+		'U_MCP_REPORT'		=> generate_link('forums&amp;file=mcp&amp;i=reports&amp;mode=report_details&amp;p=' . $row['post_id'])
+	));
 
 	unset($rowset[$i]);
 }
+unset($rowset);
 
 // Display topic icons for split topic
 $s_topic_icons = false;
 
-if ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']))
+if ($_CLASS['forums_auth']->acl_get('m_split', $topic_info['forum_id']))
 {
-	require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+	require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 	$s_topic_icons = posting_gen_topic_icons('', $icon_id);
 
 	// Has the user selected a topic for merge?
@@ -198,7 +192,7 @@
 	{
 		$to_topic_info = get_topic_data(array($to_topic_id), 'm_merge');
 		
-		if (!sizeof($to_topic_info))
+		if (empty($to_topic_info[$to_topic_id]))
 		{
 			$to_topic_id = 0;
 		}
@@ -217,10 +211,10 @@
 
 $_CLASS['core_template']->assign_array(array(
 	'TOPIC_TITLE'		=> $topic_info['topic_title'],
-	'U_VIEWTOPIC'		=> generate_link('Forums&amp;file=viewtopic&amp;f=' . $topic_info['forum_id'] . '&amp;t=' . $topic_info['topic_id']),
+	'U_VIEWTOPIC'		=> generate_link('forums&amp;file=viewtopic&amp;t=' . $topic_info['topic_id']),
 
 	'TO_TOPIC_ID'		=> $to_topic_id,
-	'TO_TOPIC_INFO'		=> ($to_topic_id) ? sprintf($_CLASS['core_user']->lang['YOU_SELECTED_TOPIC'], $to_topic_id, '<a href="'.generate_link('Forums&amp;file=viewtopic&amp;f=' . $to_topic_info['forum_id'] . '&amp;t=' . $to_topic_id) . '" target="_new">' . $to_topic_info['topic_title'] . '</a>') : '',
+	'TO_TOPIC_INFO'		=> ($to_topic_id) ? sprintf($_CLASS['core_user']->lang['YOU_SELECTED_TOPIC'], $to_topic_id, '<a href="'.generate_link('forums&amp;file=viewtopic&amp;t=' . $to_topic_id) . '" target="_new">' . $to_topic_info['topic_title'] . '</a>') : '',
 
 	'SPLIT_SUBJECT'		=> $subject,
 	'POSTS_PER_PAGE'	=> $posts_per_page,
@@ -229,30 +223,32 @@
 	'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED', false, true),
 	'UNAPPROVED_IMG'	=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED', false, true),
 
-	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode".(($start) ? '&amp;start='.$start : '')),
+	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode&amp;action=$action".(($start) ? '&amp;start='.$start : '')),
 	'S_FORUM_SELECT'	=> '<select name="to_forum_id">' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '</select>',
-	'S_CAN_SPLIT'		=> ($_CLASS['auth']->acl_get('m_split', $topic_info['forum_id']) && $action != 'merge') ? true : false,
-	'S_CAN_MERGE'		=> ($_CLASS['auth']->acl_get('m_merge', $topic_info['forum_id']) && $action != 'split') ? true : false,
-	'S_CAN_DELETE'		=> ($_CLASS['auth']->acl_get('m_delete', $topic_info['forum_id'])) ? true : false,
-	'S_CAN_APPROVE'		=> ($has_unapproved_posts && $_CLASS['auth']->acl_get('m_approve', $topic_info['forum_id'])) ? true : false,
-	'S_CAN_LOCK'		=> ($_CLASS['auth']->acl_get('m_lock', $topic_info['forum_id'])) ? true : false,
-	'S_REPORT_VIEW'		=> ($action == 'reports') ? true : false,
+	'S_CAN_SPLIT'		=> $_CLASS['forums_auth']->acl_get('m_split', $topic_info['forum_id']),
+	'S_CAN_MERGE'		=> $_CLASS['forums_auth']->acl_get('m_merge', $topic_info['forum_id']),
+	'S_CAN_DELETE'		=> $_CLASS['forums_auth']->acl_get('m_delete', $topic_info['forum_id']),
+	'S_CAN_APPROVE'		=> ($has_unapproved_posts && $_CLASS['forums_auth']->acl_get('m_approve', $topic_info['forum_id'])),
+	'S_CAN_LOCK'		=> $_CLASS['forums_auth']->acl_get('m_lock', $topic_info['forum_id']),
+	'S_REPORT_VIEW'		=> ($action == 'reports'),
 
 	'S_SHOW_TOPIC_ICONS'=> $s_topic_icons,
 	'S_TOPIC_ICON'		=> $icon_id,
 
+	'U_SELECT_TOPIC'	=> generate_link("$url&amp;mode=forum_view&amp;action=merge_select"),
+
 	'RETURN_TOPIC'		=> sprintf($_CLASS['core_user']->lang['RETURN_TOPIC'], '<a href="'.generate_link("Forums&amp;file=viewtopic&amp;f={$topic_info['forum_id']}&amp;t={$topic_info['topic_id']}&amp;start=$start.").'">', '</a>'),
 	'RETURN_FORUM'		=> sprintf($_CLASS['core_user']->lang['RETURN_FORUM'], '<a href="'.generate_link("Forums&amp;file=viewforum&amp;f={$topic_info['forum_id']}&amp;start=$start").'">', '</a>'),
 
 	'PAGE_NUMBER'		=> on_page($total, $posts_per_page, $start),
-	'PAGINATION'		=> (!$posts_per_page) ? '' : generate_pagination('Forums&amp;file=mcp&amp;t=' . $topic_info['topic_id'] . "&amp;mode=$mode&amp;action=$action&amp;to_topic_id=$to_topic_id&amp;posts_per_page=$posts_per_page&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir", $total, $posts_per_page, $start),
-	'TOTAL'				=> $total)
-);
+	'PAGINATION'		=> (!$posts_per_page) ? '' : generate_pagination("forums&amp;file=mcp&amp;t={$topic_info['topic_id']}&amp;mode=$mode&amp;action=$action&amp;to_topic_id=$to_topic_id&amp;posts_per_page=$posts_per_page&amp;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir", $total, $posts_per_page, $start),
+	'TOTAL'				=> $total
+));
 
 page_header();
 make_jumpbox($url . '&amp;mode=forum_view', $topic_info['forum_id'], false, 'm_');
 
-$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/Forums/mcp_topic.html');
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_topic.html');
 
 function split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject)
 {
@@ -262,10 +258,11 @@
 		
 	if (empty($post_id_list) || !check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_split'))
 	{
-		return false;
+		return 'NO_POST_SELECTED';
 	}
 
-	$post_info = get_post_data($post_id_list);
+	$post_id = $post_id_list[0];
+	$post_info = get_post_data(array($post_id));
 
 	if (empty($post_info))
 	{
@@ -286,7 +283,7 @@
 
 	$forum_info = get_forum_data(array($to_forum_id), 'm_split');
 
-	if (empty($forum_info))
+	if (empty($forum_info[$to_forum_id]))
 	{
 		return 'NOT_MODERATOR_DESTINATION';
 	}
@@ -309,16 +306,13 @@
 		'redirect'		=> $redirect,
 		'subject'		=> $subject,
 		'to_forum_id'	=> $to_forum_id,
-		'icon'			=> request_var('icon', 0)
+		'icon'			=> get_variable('icon', 'REQUEST', false, 'int')
 	));
 
-	$message = ($mode == 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
+	$message = ($mode === 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
 
 	if (display_confirmation($_CLASS['core_user']->get_lang($message), $hidden_fields))
 	{
-		$post_id = $post_id_list[0];
-		//$post_info = $post_info[$post_id];
-
 		if ($mode === 'split_beyond')
 		{
 			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
@@ -327,7 +321,7 @@
 			if ($sort_order_sql{0} == 'u')
 			{
 				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
-					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . USERS_TABLE . " u
+					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
 					WHERE p.topic_id = $topic_id
 						AND p.poster_id = u.user_id
 						$limit_time_sql
@@ -363,6 +357,7 @@
 					$post_id_list[] = $row['post_id'];
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 		}
 
 		if (empty($post_id_list))
@@ -375,20 +370,20 @@
 		$_CLASS['core_db']->transaction();
 
 		$sql_ary = array(
-			'forum_id'				=> $to_forum_id,
-			'topic_title'			=> $subject,
-			'icon_id'				=> $icon_id,
-			'topic_approved'		=> 1,
-			'topic_poster' 			=> $topic_poster,
+			'forum_id'					=> $to_forum_id,
+			'topic_title'				=> $subject,
+			'icon_id'					=> $icon_id,
+			'topic_approved'			=> 1,
+			'topic_poster' 				=> $topic_poster,
 			'topic_first_poster_name'	=> $topic_poster_name,
-			'topic_time'			=> $_CLASS['core_user']->time,
-			'topic_status'			=> ITEM_UNLOCKED,
-			'topic_type'			=> POST_NORMAL,
-			'topic_attachment'		=> 0,
-			'topic_replies_real'	=> 0,
-			'topic_replies'			=> 0,
-			'topic_views'			=> 0,
-			'topic_moved_id'		=> 0
+			'topic_time'				=> $_CLASS['core_user']->time,
+			'topic_status'				=> ITEM_UNLOCKED,
+			'topic_type'				=> POST_NORMAL,
+			'topic_attachment'			=> 0,
+			'topic_replies_real'		=> 0,
+			'topic_replies'				=> 0,
+			'topic_views'				=> 0,
+			'topic_moved_id'			=> 0
 		);
 
 		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
@@ -468,8 +463,9 @@
 		'start'			=> $start,
 		'redirect'		=> $redirect,
 		'f'				=> $forum_id,
-		't'				=> $topic_id)
-	);
+		't'				=> $topic_id
+	));
+
 	$success_msg = $return_link = '';
 
 	if (confirm_box(true))
@@ -500,11 +496,6 @@
 
 	$redirect = request_var('redirect', generate_link('Forums'));
 
-	/*if (strpos($redirect, '?') === false)
-	{
-		$redirect = substr_replace($redirect, ".$phpEx$SID&", strpos($redirect, '&'), 1);
-	}*/
-
 	if (!$success_msg)
 	{
 		return;

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/includes/functions_user.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -747,4 +747,51 @@
 	
 	return array(AVATAR_UPLOAD, $file->get('realname'), $file->get('width'), $file->get('height'));
 }
+
+/**
+* Whois facility
+* From phpBB 3
+*/
+function user_ipwhois($ip)
+{
+	$ipwhois = '';
+
+	$match = array(
+		'#RIPE\.NET#is'				=> 'whois.ripe.net',
+		'#whois\.apnic\.net#is'		=> 'whois.apnic.net',
+		'#nic\.ad\.jp#is'			=> 'whois.nic.ad.jp',
+		'#whois\.registro\.br#is'	=> 'whois.registro.br'
+	);
+
+	if (($fsk = @fsockopen('whois.arin.net', 43)))
+	{
+		fputs($fsk, "$ip\n");
+		while (!feof($fsk))
+		{
+			$ipwhois .= fgets($fsk, 1024);
+		}
+		@fclose($fsk);
+	}
+
+	foreach (array_keys($match) as $server)
+	{
+		if (preg_match($server, $ipwhois))
+		{
+			$ipwhois = '';
+			if (($fsk = @fsockopen($match[$server], 43)))
+			{
+				fputs($fsk, "$ip\n");
+				while (!feof($fsk))
+				{
+					$ipwhois .= fgets($fsk, 1024);
+				}
+				@fclose($fsk);
+			}
+			break;
+		}
+	}
+
+	return $ipwhois;
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/main.php
===================================================================
--- cms/trunk/modules/forums/main.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/modules/forums/main.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -95,8 +95,8 @@
 	'TOTAL_POSTS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_post_s), $config['num_posts']),
 	'TOTAL_TOPICS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_topic_s), $config['num_topics']),
 	'TOTAL_USERS'	=> sprintf($_CLASS['core_user']->get_lang($l_total_user_s), $_CORE_CONFIG['user']['total_users']),
-	'NEWEST_USER'	=> sprintf($_CLASS['core_user']->get_lang('NEWEST_USER'), '<a href="'. generate_link('Members_List&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">', $_CORE_CONFIG['user']['newest_username'], '</a>'), 
-	'LEGEND'		=> $legend, 
+	'NEWEST_USER'	=> sprintf($_CLASS['core_user']->get_lang('NEWEST_USER'), '<a href="'. generate_link('members_list&amp;mode=viewprofile&amp;u='.$_CORE_CONFIG['user']['newest_user_id']) . '">', $_CORE_CONFIG['user']['newest_username'], '</a>'), 
+	'LEGEND'		=> $legend,
 	'BIRTHDAY_LIST'	=> $birthday_list, 
 
 	'FORUM_IMG'			=>	$_CLASS['core_user']->img('forum', 'NO_NEW_POSTS'),
@@ -106,7 +106,8 @@
 	'S_LOGIN_ACTION'			=> generate_link('control_panel&amp;mode=login'), 
 	'S_DISPLAY_BIRTHDAY_LIST'	=> ($config['load_birthdays']), 
 
-	'U_MARK_FORUMS'	=> generate_link('forums&amp;mark=forums')
+	'U_MARK_FORUMS'	=> generate_link('forums&amp;mark=forums'),
+	'U_MCP'			=> $_CLASS['forums_auth']->acl_get('m_') ? generate_link('forums&amp;file=mcp&amp;i=main&amp;mode=front') : ''
 ));
 unset($birthday_list, $legend);
 

Modified: cms/trunk/modules/forums/mcp.php
===================================================================
--- cms/trunk/modules/forums/mcp.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/modules/forums/mcp.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -27,101 +27,8 @@
     die;
 }
 
-require_once($site_file_root.'includes/forums/functions_admin.php');
+require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
 
-/*
-$sections = array(0 => array (
-    'module_id' => '9',
-    'module_title' => 'MAIN',
-    'module_filename' => 'main',
-    'module_subs' => 'front
-forum_view
-topic_view
-post_details',
-    'module_acl' => 'acl_m_',
-  ),
-  1 => array (
-    'module_id' => '10',
-    'module_title' => 'QUEUE',
-    'module_filename' => 'queue',
-    'module_subs' => 'unapproved_topics
-unapproved_posts
-reports',
-    'module_acl' => 'acl_m_approve',
-));
-
-foreach  ($sections as $row)
-{
-	$selected = ($row['module_filename'] == 'kk') ?  true : false;
-
-	// Get the localised lang string if available, or make up our own otherwise
-	$module_lang = 'MCP_' . $row['module_title'];
-
-	$_CLASS['core_template']->assign_vars_array('mcp_section', array(
-		'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
-		'S_SELECTED'	=> $selected, 
-		'U_TITLE'		=> generate_link()
-	));
-
-	if ($selected)
-	{
-		$module_id = $row['module_id'];
-		$module_name = $row['module_filename'];
-
-		if ($row['module_subs'])
-		{
-			$submodules_ary = explode("\n", $row['module_subs']);
-
-			foreach ($submodules_ary as $submodule_title)
-			{
-				$submodule_title = trim($submodule_title);
-
-				if (!$submodule_title)
-				{
-					continue;
-				}
-				
-			
-				// Only show those rows we are able to access
-				if (($submodule_title == 'post_details' && !$post_id) || ($submodule_title == 'topic_view' && !$topic_id) || ($submodule_title == 'forum_view' && !$forum_id))
-				{
-					continue;
-				}
-				
-
-				$suffix = ($post_id) ? "&amp;p=$post_id" : '';
-				$suffix .= ($topic_id) ? "&amp;t=$topic_id" : '';
-				$suffix .= ($forum_id) ? "&amp;f=$forum_id" : '';
-
-				$selected = ($submodule_title == 'kll') ? true : false;
-
-				// Get the localised lang string if available, or make up our own otherwise
-				$module_lang = strtoupper($module_type . '_' . $module_name . '_' . $submodule_title);
-
-				$_CLASS['core_template']->assign_vars_array("{$module_type}_subsection", array(
-					'L_TITLE'		=> (isset($_CLASS['core_user']->lang[$module_lang])) ? $_CLASS['core_user']->lang[$module_lang] : ucfirst(str_replace('_', ' ', strtolower($module_lang))),
-					'S_SELECTED'	=> $selected,
-					'ADD_ITEM'		=> $this->add_menu_item($row['module_filename'], $submodule_title),
-					'U_TITLE'		=> generate_link($module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title . $suffix))
-				);
-
-			}
-		}
-	}
-}
-
-//$_CLASS['core_blocks']->load_blocks();
-$_CLASS['core_blocks']->blocks_loaded = true;
-
-$data = array(
-	'block_title'		=> 'Forum Administration',
-	'block_position'	=> BLOCK_LEFT,
-	'block_file'		=> 'block-forums_mcp.php',
-);
-
-$_CLASS['core_blocks']->add_block($data);
-*/
-
 // Add Item to Submodule Title
 function add_menu_item($module_name, $mode)
 {
@@ -188,15 +95,23 @@
 	login_box(array('admin_login' => true, 'full_login' => false, 'explain' => $_CLASS['core_user']->lang['LOGIN_EXPLAIN_MCP']));
 }
 
-if (!$_CLASS['auth']->acl_get('m_'))
-{
-	trigger_error('YOUR_NO_MODERATOR');
-}
-
-$mode	= get_variable('mode', 'REQUEST', 'front');
+$i	= get_variable('i', 'REQUEST');
+$mode	= $i ? $i : get_variable('mode', 'REQUEST', 'front');
 $action = get_variable('action', 'REQUEST');
 $quick_mod = isset($_REQUEST['quickmod']);
 
+$post_id = get_variable('p', 'REQUEST', 0);
+$topic_id = get_variable('t', 'REQUEST', 0);
+$forum_id = get_variable('f', 'REQUEST', 0);
+$user_id = get_variable('u', 'REQUEST', 0);
+$username = get_variable('username', 'REQUEST', '');
+
+if ($mode == 'topic_logs')
+{
+	$id = 'logs';
+	$quickmod = false;
+}
+
 if ($mode === 'approve' || $mode === 'disapprove')
 {
 	$module = 'queue';
@@ -207,7 +122,13 @@
 	$mode = 'forum_view';
 }
 
-// Topic view modes
+/*
+if (!$_CLASS['forums_auth']->acl_get('m_'))
+{
+	trigger_error('YOUR_NO_MODERATOR');
+}
+*/
+
 if (in_array($mode, array('split', 'split_all', 'split_beyond', 'merge', 'merge_posts')))
 {
 	$_REQUEST['action'] = $action = $mode;
@@ -223,36 +144,118 @@
 	$quick_mod = false;
 }
 
+if ($post_id)
+{
+	// We determine the topic and forum id here, to make sure the moderator really has moderative rights on this post
+	$sql = 'SELECT topic_id, forum_id
+		FROM ' . FORUMS_POSTS_TABLE . "
+		WHERE post_id = $post_id";
+
+	$result = $_CLASS['core_db']->query($sql);
+	$_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	$topic_id = (int) $row['topic_id'];
+	$forum_id = (int) ($row['forum_id']) ? $row['forum_id'] : $forum_id;
+}
+
+if ($topic_id && !$forum_id)
+{
+	$sql = 'SELECT forum_id
+		FROM ' . FORUMS_TOPICS_TABLE . "
+		WHERE topic_id = $topic_id";
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	$forum_id = (int) $row['forum_id'];
+}
+
+// If the user doesn't have any moderator powers (globally or locally) he can't access the mcp
+if (!$_CLASS['forums_auth']->acl_get('m_'))//acl_getf_global
+{
+	// Except he is using one of the quickmod tools for users
+	$user_quickmod_actions = array(
+		'lock'			=> 'f_user_lock',
+		'unlock'		=> 'f_user_lock',
+		'make_sticky'	=> 'f_sticky',
+		'make_announce'	=> 'f_announce',
+		'make_global'	=> 'f_announce',
+		'make_normal'	=> array('f_announce', 'f_sticky')
+	);
+
+	$allow_user = false;
+	if ($quickmod && isset($user_quickmod_actions[$action]) && !$_CLASS['forums_auth']->acl_gets($user_quickmod_actions[$action], $forum_id))
+	{
+		$topic_info = get_topic_data(array($topic_id));
+		if ($topic_info[$topic_id]['topic_poster'] == $user->data['user_id'])
+		{
+			$allow_user = true;
+		}
+	}
+
+	if (!$allow_user)
+	{
+		trigger_error('NOT_AUTHORIZED');
+	}
+}
+
+$_CLASS['core_template']->assign_array(array(
+	'S_USER_LOGGED_IN'		=> true,
+	'S_DISPLAY_PM'			=> false,
+	'S_DISPLAY_SEARCH'		=> false,
+	'S_DISPLAY_MEMBERLIST'	=> false,
+	'S_DISPLAY_JUMPBOX'		=> false,
+	'S_TIMEZONE'			=> '',
+
+	'LAST_VISIT_DATE'		=> '',
+	'PAGINATION'			=> '',
+	'PAGINATION_ARRAY'		=> '',
+	'CURRENT_TIME'			=> ''
+));
+		
+// if the user cannot read the forum he tries to access then we won't allow mcp access either
+if ($forum_id && !$_CLASS['forums_auth']->acl_get('f_read', $forum_id))
+{
+	trigger_error('NOT_AUTHORIZED');
+}
+
 if (!$quick_mod)
 {
 	switch ($mode)
 	{
+		case 'main':
 		case 'front':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php');
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_front.php';
 			script_close(false);
 		break;
 
 		case 'forum_view':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_forum.php');
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_forum.php';
 			script_close(false);
 		break;
 		
 		case 'topic_view':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php');
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_topic.php';
 			script_close(false);
 		break;
 			
 		case 'post_details':
-			require(SITE_FILE_ROOT.'includes/forums/mcp/mcp_post.php');
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_post.php';
 			script_close(false);
 		break;
+		
+		case 'notes':
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_notes.php';
+			script_close(false);
+		break;
 	}
 
 	//script_close(false);
 }
 
-require_once(SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php');
-	
+require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
+
 switch ($mode)
 {
 	case 'lock':
@@ -284,13 +287,14 @@
 	case 'make_global':
 	case 'make_normal':
 		$topic_ids = get_topic_ids($quick_mod);
+		$forum_id = get_variable('f', 'REQUEST');
 
 		if (empty($topic_ids))
 		{
 			trigger_error('NO_TOPIC_SELECTED');
 		}
 
-		change_topic_type($mode, $topic_ids);
+		change_topic_type($mode, $topic_ids, $forum_id);
 	break;
 
 	case 'move':
@@ -409,6 +413,7 @@
 
 		$rowset[$row['topic_id']] = $row;
 	}
+	$_CLASS['core_db']->free_result($result);
 
 	return $rowset;
 }
@@ -422,7 +427,7 @@
 
 	$sql = 'SELECT p.*, u.*, t.*, f.*
 		FROM ' . FORUMS_POSTS_TABLE . ' p LEFT JOIN ' . FORUMS_FORUMS_TABLE . ' f ON (f.forum_id = p.forum_id),
-		' . USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
+		' . CORE_USERS_TABLE . ' u, ' . FORUMS_TOPICS_TABLE . ' t
 		WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 			AND u.user_id = p.poster_id
 			AND t.topic_id = p.topic_id';
@@ -443,6 +448,7 @@
 
 		$rowset[$row['post_id']] = $row;
 	}
+	$_CLASS['core_db']->free_result($result);
 
 	return $rowset;
 }
@@ -470,6 +476,7 @@
 
 		$rowset[$row['forum_id']] = $row;
 	}
+	$_CLASS['core_db']->free_result($result);
 
 	return $rowset;
 }
@@ -649,7 +656,7 @@
 // Should make this better
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		if (!$acl_list || $_CLASS['auth']->acl_get($acl_list, $row['forum_id']))
+		if (!$acl_list || $_CLASS['auth']->acl_gets($acl_list, $row['forum_id']))
 		{
 			$forum_ids[] = $row['forum_id'];
 			$ids[] = $row[$sql_id];
@@ -666,4 +673,5 @@
 {
 	return generate_hidden_fields($array);
 }
+
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -39,7 +39,7 @@
     die;
 }
 
-require(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
 // Start initial var setup
 $forum_id	= request_var('f', 0);

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-04 13:47:39 UTC (rev 179)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-06 20:19:46 UTC (rev 180)
@@ -110,7 +110,7 @@
 	$sql = 'SELECT topic_id, forum_id
 		FROM ' . FORUMS_TOPICS_TABLE . "
 		 WHERE forum_id = $forum_id AND topic_last_post_time $sql_condition $topic_last_post_time"
-		 . ($_CLASS['auth']->acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . "
+		 . ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id) ? '' : ' AND topic_approved = 1') . "
 		ORDER BY topic_last_post_time $sql_ordering";
 
 	$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -136,7 +136,7 @@
 }
 else
 {
-	if ($_CLASS['auth']->acl_get('m_approve', $forum_id))
+	if ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id))
 	{
 		$join_sql = (!$post_id) ? "t.topic_id = $topic_id" : "p.post_id = $post_id AND t.topic_id = p.topic_id AND p2.topic_id = p.topic_id AND p2.post_id <= $post_id";
 	}
@@ -171,13 +171,13 @@
 $topic_data = $_CLASS['core_db']->fetch_row_assoc($result);
 $_CLASS['core_db']->free_result($result);
 
-if (!$topic_data || $topic_data['forum_status'] == ITEM_DELETING || (!$topic_data['topic_approved'] && !$_CLASS['auth']->acl_get('m_approve', $forum_id)))
+if (!$topic_data || $topic_data['forum_status'] == ITEM_DELETING || (!$topic_data['topic_approved'] && !$_CLASS['forums_auth']->acl_get('m_approve', $forum_id)))
 {
 	trigger_error('NO_TOPIC');
 }
 
 //Check for read permission
-if (!$_CLASS['auth']->acl_get('f_read', $forum_id))// && !$_CLASS['auth']->acl_get('m_', $forum_id)
+if (!$_CLASS['forums_auth']->acl_get('f_read', $forum_id))// && !$_CLASS['forums_auth']->acl_get('m_', $forum_id)
 {
 	if ($_CLASS['core_user']->data['user_id'] != ANONYMOUS)
 	{
@@ -244,7 +244,7 @@
 }
 
 // We make this check here because the correct forum_id is determined
-$topic_replies = ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? (int) $topic_data['topic_replies_real'] : (int) $topic_data['topic_replies'];
+$topic_replies = ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? (int) $topic_data['topic_replies_real'] : (int) $topic_data['topic_replies'];
 
 $topic_last_read = topic_last_read($topic_id, $forum_id);
 
@@ -284,13 +284,13 @@
 // requested anything different
 if ($sort_days)
 {
-	$min_post_time = time() - ($sort_days * 86400);
+	$min_post_time = $_CLASS['core_user']->time - ($sort_days * 86400);
 
 	$sql = 'SELECT COUNT(post_id) AS num_posts
 		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE topic_id = $topic_id
 			AND post_time >= $min_post_time
-		" . (($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
+		" . (($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? '' : 'AND post_approved = 1');
 
 	$result = $_CLASS['core_db']->query($sql);
 	$total_posts = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['num_posts'] : 0;
@@ -395,9 +395,9 @@
 		}
 	}
 
-	$s_can_vote = (((empty($cur_voted_id) && $_CLASS['auth']->acl_get('f_vote', $forum_id)) || 
-		($_CLASS['auth']->acl_get('f_votechg', $forum_id) && $topic_data['poll_vote_change'])) &&
-		(($topic_data['poll_length'] != 0 && $topic_data['poll_start'] + $topic_data['poll_length'] > time()) || $topic_data['poll_length'] == 0) &&
+	$s_can_vote = (((empty($cur_voted_id) && $_CLASS['forums_auth']->acl_get('f_vote', $forum_id)) || 
+		($_CLASS['forums_auth']->acl_get('f_votechg', $forum_id) && $topic_data['poll_vote_change'])) &&
+		(($topic_data['poll_length'] != 0 && $topic_data['poll_start'] + $topic_data['poll_length'] > $_CLASS['core_user']->time) || $topic_data['poll_length'] == 0) &&
 		$topic_data['topic_status'] != ITEM_LOCKED && 
 		$topic_data['forum_status'] != ITEM_LOCKED) ? true : false;
 		
@@ -590,7 +590,7 @@
 $sql = 'SELECT p.post_id
 	FROM ' . FORUMS_POSTS_TABLE . ' p' . (($sort_by_sql[$sort_key]{0} == 'u') ? ', ' . USERS_TABLE . ' u': '') . "
 	WHERE p.topic_id = $topic_id
-		" . ((!$_CLASS['auth']->acl_get('m_approve', $forum_id)) ? 'AND p.post_approved = 1' : '') . "
+		" . ((!$_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? 'AND p.post_approved = 1' : '') . "
 		" . (($sort_by_sql[$sort_key]{0} == 'u') ? 'AND u.user_id = p.poster_id': '') . "
 		$limit_posts_time
 	ORDER BY $sql_sort_order";
@@ -766,7 +766,7 @@
 				'msn'			=> ($row['user_msnm']) ? generate_link('members_list&amp;mode=contact&amp;action=msnm&amp;u='.$poster_id) : '',
 				'yim'			=> ($row['user_yim']) ? 'http://edit.yahoo.com/config/send_webmesg?.target=' . $row['user_yim'] . '&.src=pg' : '',
 				'jabber'		=> ($row['user_jabber']) ? generate_link('members_list&amp;mode=contact&amp;action=jabber&amp;u='.$poster_id) : '',
-				'search'		=> ($_CLASS['auth']->acl_get('u_search')) ? generate_link('forums&amp;file=search&amp;search_author=' . urlencode($row['username']) .'&amp;showresults=posts') : '',
+				'search'		=> ($_CLASS['forums_auth']->acl_get('u_search')) ? generate_link('forums&amp;file=search&amp;search_author=' . urlencode($row['username']) .'&amp;showresults=posts') : '',
 				'username'		=> ($row['user_colour']) ? '<span style="color:#' . $row['user_colour'] . '">' . $poster . '</span>' : $poster
 			);
 
@@ -817,9 +817,9 @@
 				*/
 			}
 
-			if (!empty($row['user_allow_viewemail']) || $_CLASS['auth']->acl_get('a_email'))
+			if (!empty($row['user_allow_viewemail']) || $_CLASS['forums_auth']->acl_get('a_email'))
 			{
-				$user_cache[$poster_id]['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$poster_id) : (($config['board_hide_emails'] && !$_CLASS['auth']->acl_get('a_email')) ? '' : 'mailto:' . $row['user_email']);
+				$user_cache[$poster_id]['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$poster_id) : (($config['board_hide_emails'] && !$_CLASS['forums_auth']->acl_get('a_email')) ? '' : 'mailto:' . $row['user_email']);
 			}
 			else
 			{
@@ -876,7 +876,7 @@
 // Pull attachment data
 if (!empty($attach_list))
 {
-	if ($_CLASS['auth']->acl_gets(array('f_download', 'u_download'), $forum_id))
+	if ($_CLASS['forums_auth']->acl_gets(array('f_download', 'u_download'), $forum_id))
 	{
 		$sql = 'SELECT * 
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -990,7 +990,7 @@
 	}
 
 	// If the board has HTML off but the post has HTML on then we process it, else leave it alone
-	if ($row['enable_html'] && (!$config['allow_html'] || !$_CLASS['auth']->acl_get('f_html', $forum_id)))
+	if ($row['enable_html'] && (!$config['allow_html'] || !$_CLASS['forums_auth']->acl_get('f_html', $forum_id)))
 	{
 		$row['post_text'] = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $row['post_text']);
 	}
@@ -1021,7 +1021,7 @@
 		$message = preg_replace('#(?!<.*)(?<!\w)(' . $highlight_match . ')(?!\w|[^<>]*>)#i', '<span class="posthilit">\1</span>', $message);
 	}
 
-	if ($row['enable_html'] && ($config['allow_html'] && $_CLASS['auth']->acl_get('f_html', $forum_id)))
+	if ($row['enable_html'] && ($config['allow_html'] && $_CLASS['forums_auth']->acl_get('f_html', $forum_id)))
 	{
 		// Remove Comments from post content
 		$row['post_text'] = preg_replace('#<!\-\-(.*?)\-\->#is', '', $row['post_text']);
@@ -1133,10 +1133,10 @@
 		'ONLINE_IMG'		=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? '' : (($user_cache[$poster_id]['online']) ? $_CLASS['core_user']->img('btn_online', 'ONLINE') : $_CLASS['core_user']->img('btn_offline', 'OFFLINE')), 
 		'S_ONLINE'			=> ($poster_id == ANONYMOUS || !$config['load_onlinetrack']) ? false : (($user_cache[$poster_id]['online']) ? true : false),
 
-		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_edit', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=edit&amp;p=" . $row['post_id']) : '',
-		'U_QUOTE' 			=> ($_CLASS['auth']->acl_get('f_quote', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=quote&amp;p=" . $row['post_id']) : '', 
-		'U_INFO'            => ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
-		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > time() - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['auth']->acl_get('m_delete', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=delete&amp;p=" . $row['post_id']) : '',
+		'U_EDIT' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['forums_auth']->acl_get('f_edit', $forum_id) && ($row['post_time'] > $_CLASS['core_user']->time - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=edit&amp;p=" . $row['post_id']) : '',
+		'U_QUOTE' 			=> ($_CLASS['forums_auth']->acl_get('f_quote', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=quote&amp;p=" . $row['post_id']) : '', 
+		'U_INFO'            => ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id'], false, false) : '',
+		'U_DELETE' 			=> (($_CLASS['core_user']->data['user_id'] == $poster_id && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id) && $topic_data['topic_last_post_id'] == $row['post_id'] && ($row['post_time'] > $_CLASS['core_user']->time - $config['edit_time'] || !$config['edit_time'])) || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id)) ? generate_link("forums&amp;file=posting&amp;mode=delete&amp;p=" . $row['post_id']) : '',
 
 		'U_PROFILE' 		=> $user_cache[$poster_id]['profile'],
 		'U_SEARCH' 			=> $user_cache[$poster_id]['search'],
@@ -1150,20 +1150,20 @@
 		'U_JABBER'			=> $user_cache[$poster_id]['jabber'], 
 
 		'U_REPORT'			=> generate_link('forums&amp;file=report&amp;p=' . $row['post_id']),
-		'U_MCP_REPORT'		=> ($_CLASS['auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MCP_APPROVE'		=> ($_CLASS['auth']->acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
-		'U_MCP_DETAILS'		=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MCP_REPORT'		=> ($_CLASS['forums_auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
+		'U_MCP_APPROVE'		=> ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
+		'U_MCP_DETAILS'		=> ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
 		'U_MINI_POST'		=> generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
 		'U_NEXT_POST_ID'	=> ($i < $i_total && isset($rowset[$i + 1])) ? $rowset[$i + 1]['post_id'] : '', 
 		'U_PREV_POST_ID'	=> $prev_post_id, 
 
 		'POST_ID'           => $row['post_id'],
 
-		//'U_NOTES'			=> ($_CLASS['auth']->acl_getf_global('m_')) ? generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $poster_id) : '',
-		//'U_WARN'			=> ($_CLASS['auth']->acl_getf_global('m_warn') && $poster_id != $_CLASS['core_user']->data['user_id']) ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_post&amp;f=' . $forum_id . '&amp;p=' . $row['post_id']) : '',
+		//'U_NOTES'			=> ($_CLASS['forums_auth']->acl_getf_global('m_')) ? generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $poster_id) : '',
+		//'U_WARN'			=> ($_CLASS['forums_auth']->acl_getf_global('m_warn') && $poster_id != $_CLASS['core_user']->data['user_id']) ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_post&amp;f=' . $forum_id . '&amp;p=' . $row['post_id']) : '',
 
 		'S_POST_UNAPPROVED'	=> !$row['post_approved'],
-		'S_POST_REPORTED'	=> ($row['post_reported'] && $_CLASS['auth']->acl_get('m_', $forum_id)),
+		'S_POST_REPORTED'	=> ($row['post_reported'] && $_CLASS['forums_auth']->acl_get('m_', $forum_id)),
 		'S_DISPLAY_NOTICE'	=> ($display_notice && $row['post_attachment']), 
 		'S_FRIEND'			=> $row['friend'],
 		'S_UNREAD_POST'		=> $unread,
@@ -1209,21 +1209,21 @@
 	}
 }
 
-$allow_change_type = ($_CLASS['auth']->acl_get('m_', $forum_id) || ($_CLASS['core_user']-is_user && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? true : false;
+$allow_change_type = ($_CLASS['forums_auth']->acl_get('m_', $forum_id) || ($_CLASS['core_user']->is_user && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? true : false;
 
 // Quick mod tools
 $topic_mod = '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_lock', $forum_id) || ($_CLASS['auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '<option value="lock">' . $_CLASS['core_user']->lang['LOCK_TOPIC'] . '</option>' : '<option value="unlock">' . $_CLASS['core_user']->lang['UNLOCK_TOPIC'] . '</option>') : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_delete', $forum_id)) ? '<option value="delete_topic">' . $_CLASS['core_user']->lang['DELETE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_move', $forum_id)) ? '<option value="move">' . $_CLASS['core_user']->lang['MOVE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_split', $forum_id)) ? '<option value="split">' . $_CLASS['core_user']->lang['SPLIT_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_merge', $forum_id)) ? '<option value="merge">' . $_CLASS['core_user']->lang['MERGE_TOPIC'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="fork">' . $_CLASS['core_user']->lang['FORK_TOPIC'] . '</option>' : '';
-$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_gets(array('f_sticky', 'f_announce'), $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
-$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
-$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
-$topic_mod .= ($allow_change_type && $_CLASS['auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
-$topic_mod .= ($_CLASS['auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_lock', $forum_id) || ($_CLASS['forums_auth']->acl_get('f_user_lock', $forum_id) && $_CLASS['core_user']->data['user_id'] != ANONYMOUS && $_CLASS['core_user']->data['user_id'] == $topic_data['topic_poster'])) ? (($topic_data['topic_status'] == ITEM_UNLOCKED) ? '<option value="lock">' . $_CLASS['core_user']->lang['LOCK_TOPIC'] . '</option>' : '<option value="unlock">' . $_CLASS['core_user']->lang['UNLOCK_TOPIC'] . '</option>') : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_delete', $forum_id)) ? '<option value="delete_topic">' . $_CLASS['core_user']->lang['DELETE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_move', $forum_id)) ? '<option value="move">' . $_CLASS['core_user']->lang['MOVE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_split', $forum_id)) ? '<option value="split">' . $_CLASS['core_user']->lang['SPLIT_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_merge', $forum_id)) ? '<option value="merge">' . $_CLASS['core_user']->lang['MERGE_TOPIC'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? '<option value="fork">' . $_CLASS['core_user']->lang['FORK_TOPIC'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['forums_auth']->acl_gets(array('f_sticky', 'f_announce'), $forum_id) && $topic_data['topic_type'] != POST_NORMAL) ? '<option value="make_normal">' . $_CLASS['core_user']->lang['MAKE_NORMAL'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['forums_auth']->acl_get('f_sticky', $forum_id) && $topic_data['topic_type'] != POST_STICKY) ? '<option value="make_sticky">' . $_CLASS['core_user']->lang['MAKE_STICKY'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['forums_auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_ANNOUNCE) ? '<option value="make_announce">' . $_CLASS['core_user']->lang['MAKE_ANNOUNCE'] . '</option>' : '';
+$topic_mod .= ($allow_change_type && $_CLASS['forums_auth']->acl_get('f_announce', $forum_id) && $topic_data['topic_type'] != POST_GLOBAL) ? '<option value="make_global">' . $_CLASS['core_user']->lang['MAKE_GLOBAL'] . '</option>' : '';
+$topic_mod .= ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? '<option value="viewlogs">' . $_CLASS['core_user']->lang['VIEW_TOPIC_LOGS'] . '</option>' : '';
 
 $pagination = generate_pagination("forums&amp;file=viewtopic&amp;t=$topic_id&amp;$u_sort_param" . (($highlight_match) ? "&amp;hilit=$highlight" : ''), $total_posts, $config['posts_per_page'], $start);
 
@@ -1240,7 +1240,7 @@
 	'PAGINATION_ARRAY'	=> $pagination['array'],
 	'PAGE_NUMBER' 		=> on_page($total_posts, $config['posts_per_page'], $start),
 	'TOTAL_POSTS'		=> ($total_posts == 1) ? $_CLASS['core_user']->lang['VIEW_TOPIC_POST'] : sprintf($_CLASS['core_user']->lang['VIEW_TOPIC_POSTS'], $total_posts), 
-	'U_MCP' 			=> ($_CLASS['auth']->acl_get('m_', $forum_id)) ? generate_link("forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
+	'U_MCP' 			=> ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? generate_link("forums&amp;file=mcp&amp;mode=topic_view&amp;t=$topic_id&amp;start=$start&amp;$u_sort_param", false, false) : '',
 
 	'MODERATORS'	=> (isset($forum_moderators[$forum_id]) && !empty($forum_moderators[$forum_id])) ? implode(', ', $forum_moderators[$forum_id]) : '',
 
@@ -1275,7 +1275,7 @@
 	'S_TOPIC_MOD' 			=> ($topic_mod) ? '<select name="mode">' . $topic_mod . '</select>' : '',
 	'S_MOD_ACTION' 			=> generate_link("forums&amp;file=mcp&amp;t=$topic_id&amp;quickmod=1", false, false), 
 
-	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['auth']->acl_get('f_search', $forum_id)) ? true : false, 
+	'S_DISPLAY_SEARCHBOX'	=> ($_CLASS['forums_auth']->acl_get('f_search', $forum_id)) ? true : false, 
 	'S_SEARCHBOX_ACTION'	=> generate_link('forums&amp;file=search&amp;search_forum[]='.$forum_id), 
 
 	'U_TOPIC'				=> ($view == 'print') ? generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id, array('full' => true)) : generate_link('forums&amp;file=viewtopic&amp;t='.$topic_id),
@@ -1284,8 +1284,8 @@
 	'U_VIEW_FORUM' 			=> generate_link('forums&amp;file=viewforum&amp;f='.$forum_id),
 	'U_VIEW_OLDER_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=previous"),
 	'U_VIEW_NEWER_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;t=$topic_id&amp;view=next"),
-	'U_PRINT_TOPIC'			=> ($_CLASS['auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
-	'U_EMAIL_TOPIC'			=> ($_CLASS['auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;t='.$topic_id) : '', 
+	'U_PRINT_TOPIC'			=> ($_CLASS['forums_auth']->acl_get('f_print', $forum_id)) ? generate_link($viewtopic_url . '&amp;view=print') : '',
+	'U_EMAIL_TOPIC'			=> ($_CLASS['forums_auth']->acl_get('f_email', $forum_id) && $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;t='.$topic_id) : '', 
 
 	'S_WATCH_FORUMS'		=> $topic_data['watch_topic'] ? false : true,
 	'U_WATCH_TOPIC' 		=> $s_watching_topic['link'], 



From viperal at mail.berlios.de  Sun Aug  6 22:26:49 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 6 Aug 2006 22:26:49 +0200
Subject: [Viperals-svncheckins] r181 - cms/trunk/includes/db
Message-ID: <200608062026.k76KQnkQ032716@sheep.berlios.de>

Author: viperal
Date: 2006-08-06 22:26:49 +0200 (Sun, 06 Aug 2006)
New Revision: 181

Modified:
   cms/trunk/includes/db/mysqli.php
Log:


Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2006-08-06 20:19:46 UTC (rev 180)
+++ cms/trunk/includes/db/mysqli.php	2006-08-06 20:26:49 UTC (rev 181)
@@ -245,11 +245,7 @@
 		{
 			case 'MULTI_INSERT':
 			case 'INSERT':
-				return $this->query('INSERT INTO ' . $table . ' '. $values');
-				/*foreach ($array as $array2)
-				{
-					return $this->query('INSERT INTO ' . $table . ' '. $values');
-				}*/
+				return $this->query('INSERT INTO ' . $table . ' '. $values);
 			break;
 
 			case 'UPDATE':



From viperal at mail.berlios.de  Sun Aug  6 22:32:00 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 6 Aug 2006 22:32:00 +0200
Subject: [Viperals-svncheckins] r182 - in cms/trunk/includes: db
	templates/modules/forums templates/modules/members_list
Message-ID: <200608062032.k76KW0PM000612@sheep.berlios.de>

Author: viperal
Date: 2006-08-06 22:31:57 +0200 (Sun, 06 Aug 2006)
New Revision: 182

Added:
   cms/trunk/includes/templates/modules/forums/mcp_notes_front.html
   cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
   cms/trunk/includes/templates/modules/forums/mcp_whois.html
Modified:
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/templates/modules/forums/faq_body.html
   cms/trunk/includes/templates/modules/forums/index_body.html
   cms/trunk/includes/templates/modules/forums/mcp_forum.html
   cms/trunk/includes/templates/modules/forums/mcp_header.html
   cms/trunk/includes/templates/modules/forums/mcp_move.html
   cms/trunk/includes/templates/modules/forums/mcp_post.html
   cms/trunk/includes/templates/modules/forums/mcp_topic.html
   cms/trunk/includes/templates/modules/forums/viewforum_subforum.html
   cms/trunk/includes/templates/modules/members_list/memberlist_body.html
   cms/trunk/includes/templates/modules/members_list/memberlist_header.html
   cms/trunk/includes/templates/modules/members_list/memberlist_search.html
Log:


Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/db/mysqli.php	2006-08-06 20:31:57 UTC (rev 182)
@@ -236,7 +236,7 @@
 
 		$values = $this->sql_build_array($query_type, $array);
 
-		if (!$value)
+		if (!$values)
 		{
 			return false;
 		}

Modified: cms/trunk/includes/templates/modules/forums/faq_body.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/faq_body.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/faq_body.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -57,7 +57,7 @@
 </table>
 
 <br clear="all" />
-<!-- ENDLOOP -->
+<!-- ENDLOOP $faq_block -->
 
 <!-- IF { $DISPLAY_STYLESHEET_LINK } -->
 	<!-- INCLUDE modules/Forums/simple_footer.html -->

Modified: cms/trunk/includes/templates/modules/forums/index_body.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/index_body.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/index_body.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -5,6 +5,14 @@
 
 <!-- INCLUDE modules/forums/overall_header.html -->
 
+<!-- IF { $U_MCP } -->
+	<div id="pageheader">
+		<p class="linkmcp">[ <a href="{ $U_MCP }">{ $L_MCP }</a> ]</p>
+	</div>
+
+	<br clear="all" /><br />
+<!-- ENDIF -->
+
 <table class="tablebg" cellspacing="1" width="100%">
 	<tr>
 		<td class="cat" colspan="5" align="right"><a class="nav" href="{ $U_MARK_FORUMS }">{ $L_MARK_FORUMS_READ }</a>&nbsp;</td>
@@ -52,17 +60,17 @@
 		<td class="row2" align="center"><p class="gensmall">{ $forumrow:POSTS }</p></td>
 		<td class="row2" align="center" nowrap="nowrap">
 			<!-- IF { $forumrow:LAST_POST_TIME } -->
-				<p class="gensmall">{ $forumrow:LAST_POST_TIME }</p>
-				<p class="gensmall">
+				<p class="topicdetails">{ $forumrow:LAST_POST_TIME }</p>
+				<p class="topicdetails">
 				<!-- IF { $forumrow:U_LAST_POSTER } -->
 					<a href="{ $forumrow:U_LAST_POSTER }">{ $forumrow:LAST_POSTER }</a>
 				<!-- ELSE -->
 					{ $forumrow:LAST_POSTER }
 				<!-- ENDIF -->
-				<a href="{ $forumrow:U_LAST_POST }">{ $forumrow:LAST_POST_IMG }</a>
+				<a href="{ $forumrow:U_LAST_POST }">{ $LAST_POST_IMG }</a>
 				</p>
 			<!-- ELSE -->
-				<p class="gensmall">{ $L_NO_POSTS }</p>
+				<p class="topicdetails">{ $L_NO_POSTS }</p>
 			<!-- ENDIF -->
 		</td>
 	</tr>

Modified: cms/trunk/includes/templates/modules/forums/mcp_forum.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_forum.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_forum.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -2,9 +2,13 @@
 
 <!-- INCLUDE modules/forums/mcp_header.html -->
 
-<form method="post" name="mcp" action="{ $S_MCP_ACTION }"><table class="tablebg" width="100%" cellspacing="1">
+<!-- IF { $U_VIEW_FORUM_LOGS } --><a href="{ $U_VIEW_FORUM_LOGS }">{ $L_VIEW_FORUM_LOGS }</a><!-- ENDIF -->
+
+<form method="post" name="mcp" action="{ $S_MCP_ACTION }">
+
+<table class="tablebg" width="100%" cellspacing="1">
 	<tr>
-		<td class="cat" colspan="6" align="center"><span class="gensmall">{ $L_DISPLAY_TOPICS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" /></span></td>
+		<td class="cat" colspan="6" align="center"><span class="gensmall">{ $L_DISPLAY_TOPICS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="button" type="submit" name="sort" value="{ $L_GO }" /></span></td>
 	</tr>
 	<tr>
 		<th width="4%" nowrap="nowrap">&nbsp;</th>
@@ -25,17 +29,17 @@
 			<!-- IF { $topicrow:S_SELECT_TOPIC } -->
 				<span class="genmed">[ <a href="{ $topicrow:U_SELECT_TOPIC }">{ $L_SELECT }</a> ]&nbsp;</span>
 			<!-- ENDIF -->
-			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } -->
-				<a href="{ $topicrow:U_MCP_QUEUE }">{ $UNAPPROVED_IMG }</a>&nbsp;
+			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a>
+			<!-- IF { $topicrow:S_TOPIC_UNAPPROVED } || { $topicrow:S_POSTS_UNAPPROVED } -->
+				<a href="{ $topicrow:U_MCP_QUEUE }">{ $topicrow:UNAPPROVED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
 			<!-- IF { $topicrow:S_TOPIC_REPORTED } -->
 				<a href="{ $topicrow:U_MCP_REPORT }">{ $REPORTED_IMG }</a>&nbsp;
 			<!-- ENDIF -->
-			<p class="topictitle">{ $topicrow:NEWEST_POST_IMG } { $topicrow:ATTACH_ICON_IMG } <a href="{ $topicrow:U_VIEW_TOPIC }">{ $topicrow:TOPIC_TITLE }</a></p>
 		</td>
 		<td class="row1" width="50" align="center"><p class="topicdetails">{ $topicrow:REPLIES }</p></td>
 		<td class="row1" width="120" align="center"><p class="topicdetails">{ $topicrow:LAST_POST_TIME }</p></td>
-		<td class="row2" align="center"><input type="checkbox" name="topic_id_list[]" value="{ $topicrow:TOPIC_ID }" { $topicrow:S_TOPIC_CHECKED }/></td>
+		<td class="row2" align="center"><input type="checkbox" class="radio" name="topic_id_list[]" value="{ $topicrow:TOPIC_ID }" { $topicrow:S_TOPIC_CHECKED }/></td>
 
 	</tr>
 	<!-- LOOPELSE -->
@@ -63,8 +67,15 @@
 		</td>
 	</tr>
 </table>
+
 </form>
 
+<table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
+	<tr>
+		<td align="right" valign="top" nowrap="nowrap"><b class="gensmall"><a href="javascript:marklist('mcp', 'topic_id_list', true);">{ $L_MARK_ALL }</a> :: <a href="javascript:marklist('mcp', 'topic_id_list', false);">{ $L_UNMARK_ALL }</a></b></td>
+	</tr>
+</table>
+
 <!-- INCLUDE modules/forums/mcp_footer.html -->
 
 <!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/mcp_header.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_header.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_header.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -2,19 +2,45 @@
 
 <script language="javascript" type="text/javascript" defer="defer">
 <!--
-function marklist(form_name, status)
-{
-	for (i = 0; i < document.forms[form_name].length; i++)
-	{
-		document.forms[form_name].elements[i].checked = status;
-	}
+function marklist(id, name, state)
+{
+	var parent = document.getElementById(id);
+	if (!parent)
+	{
+		eval('parent = document.' + id);
+	}
+
+	if (!parent)
+	{
+		return;
+	}
+
+	var rb = parent.getElementsByTagName('input');
+	
+	for (var r = 0; r < rb.length; r++)
+	{
+		if (rb[r].name.substr(0, name.length) == name)
+		{
+			rb[r].checked = state;
+		}
+	}
 }
 //-->
 </script>
 
 <!-- IF isset({ $TOPIC_TITLE }) || isset({ $FORUM_NAME }) -->
-<h2><!-- IF isset({ $TOPIC_TITLE }) --><a class="titles" href="{ $U_VIEWTOPIC }">{ $TOPIC_TITLE }</a><!-- ELSE --><a class="titles" href="{ $U_VIEW_FORUM }" title="{ $FORUM_DESC }">{ $FORUM_NAME }</a><!-- ENDIF --></h2>
-<br clear="all" />
+	<div id="pageheader">
+		<h2><!-- IF isset({ $TOPIC_TITLE }) --><a class="titles" href="{ $U_VIEWTOPIC }">{ $TOPIC_TITLE }</a><!-- ELSE --><a class="titles" href="{ $U_VIEW_FORUM }">{ $FORUM_NAME }</a><!-- ENDIF --></h2>
+
+		<!-- IF isset({ $MODERATORS }) -->
+			<p class="moderators">{ $L_MODERATORS }: { $MODERATORS }</p>
+		<!-- ENDIF -->
+		<!-- IF isset({ $U_MCP }) -->
+			<p class="linkmcp">[ <a href="{ $U_MCP }">{ $L_MCP }</a> ]</p>
+		<!-- ENDIF -->
+	</div>
+
+	<br clear="all" />
 <!-- ENDIF -->
 
 <!-- IF isset({ $MESSAGE }) -->

Modified: cms/trunk/includes/templates/modules/forums/mcp_move.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_move.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_move.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -5,7 +5,7 @@
 <form name="confirm" action="{ $CONFIRM_ACTION }" method="post">
 	<table class="tablebg" width="100%" cellspacing="1">
 		<tr>
-			<th>{ $MESSAGE }</th>
+			<th>{ $MESSAGE_TITLE }</th>
 		</tr>
 		<tr>
 			<td class="row1" align="center">
@@ -15,10 +15,10 @@
 				<span class="gen"><br />{ $L_SELECT_DESTINATION_FORUM }&nbsp;&nbsp;<br /></span>
 					<select name="to_forum_id">{ $S_FORUM_SELECT }</select><br />
 				<!-- IF { $S_CAN_LEAVE_SHADOW } -->
-					<input type="checkbox" name="move_leave_shadow" checked="checked" /><span class="gen">{ $L_LEAVE_SHADOW }</span><br />
+					<input type="checkbox" class="radio" name="move_leave_shadow" checked="checked" /><span class="gen">{ $L_LEAVE_SHADOW }</span><br />
 				<!-- ENDIF -->
-				<br />{ $HIDDEN_FIELDS }<span class="gen">{ $MESSAGE }</span><br /><br />
-				<input class="button" name="confirm" value="Submit" type="submit" />&nbsp;&nbsp;<input class="button" value="{ $L_CANCEL }" name="cancel" type="submit" />
+				<br />{ $HIDDEN_FIELDS }<span class="gen">{ $MESSAGE_TEXT }</span><br /><br />
+				<input class="button" name="confirm" value="{ $L_YES }" type="submit" />&nbsp;&nbsp;<input class="button" value="{ $L_NO }" name="cancel" type="submit" />
 			</td>
 		</tr>
 	</table>

Added: cms/trunk/includes/templates/modules/forums/mcp_notes_front.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_notes_front.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_notes_front.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -0,0 +1,26 @@
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/forums/mcp_header.html -->
+
+<form method="post" name="mcp" action="{ $U_POST_ACTION }">
+
+<table class="tablebg" width="75%" cellspacing="1" cellpadding="4" border="0" align="center">
+<tr>
+	<th colspan="2"align="center">{ $L_SELECT_USER }</th>
+</tr>
+<tr>
+	<td class="row1" width="40%"><b class="gen">{ $L_FIND_USERNAME }: </b><br /><span class="gensmall">[ <a href="{ $U_FIND_MEMBER }" onclick="window.open('{ $U_FIND_MEMBER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;">{ $L_FIND_USERNAME }</a> ]</span></td>
+	<td class="row2"><input type="text" class="post" name="username" maxlength="50" size="20" /></td>
+</tr>
+<tr>
+	<td class="cat" colspan="2" align="center"><input type="submit" name="submituser" value="{ $L_SUBMIT }" class="button" /></td>
+</tr>
+</table>
+
+</form>
+
+<br clear="all" /><br />
+
+<!-- INCLUDE modules/forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -0,0 +1,125 @@
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/forums/mcp_header.html -->
+
+<form method="post" name="mcp" action="{ $U_POST_ACTION }">
+	
+<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
+<tr>
+	<th colspan="2" align="center">{ $USERNAME }</th>
+</tr>
+<tr> 
+	<td class="row1" align="center">
+		<table cellspacing="1" cellpadding="2" border="0">
+		<tr>
+			<td class="gen" align="center"><!-- IF { $USER_COLOR } --><b style="color: #{ $USER_COLOR }"><!-- ELSE --><b><!-- ENDIF -->{ $USERNAME }</b></td>
+		</tr>
+		<!-- IF { $RANK_TITLE } -->
+			<tr>
+				<td class="postdetails" align="center">{ $RANK_TITLE }</td>
+			</tr>
+		<!-- ENDIF -->
+		<!-- IF { $RANK_IMG } -->
+			<tr>
+				<td align="center">{ $RANK_IMG }</td>
+			</tr>
+		<!-- ENDIF -->
+		<tr>
+			<td align="center"><!-- IF { $AVATAR_IMG } -->{ $AVATAR_IMG }<!-- ELSE --><img src="{ $T_THEME_PATH }/images/no_avatar.gif" alt="" /><!-- ENDIF --></td>
+		</tr>
+		</table>
+	</td>
+	<td class="row1">
+		<table width="100%" cellspacing="1" cellpadding="2" border="0">
+		<tr> 
+			<td class="gen" align="right" nowrap="nowrap">{ $L_JOINED }: </td>
+			<td width="100%"><b class="gen">{ $JOINED }</b></td>
+		</tr>
+		<tr> 
+			<td class="gen" align="right" valign="top" nowrap="nowrap">{ $L_TOTAL_POSTS }: </td>
+			<td><b class="gen">{ $POSTS }</b></td>
+		</tr>
+		<tr> 
+			<td class="gen" align="right" valign="top" nowrap="nowrap">{ $L_WARNINGS }: </td>
+			<td><b class="gen">{ $WARNINGS }</b></td>
+		</tr>
+		</table>
+	</td>
+</tr>
+</table>
+
+<br />
+
+<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
+<tr>
+	<th colspan="5" align="center">{ $L_FEEDBACK }</th>
+</tr>
+<!-- IF { $S_USER_NOTES } -->
+
+	<tr align="center">
+		<td colspan="5" class="row3"><span class="gensmall">{ $L_DISPLAY_LOG }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }:</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="button" type="submit" value="{ $L_GO }" name="sort" /></td>
+	</tr>
+	<tr>
+		<th>{ $L_REPORT_BY }</th>
+		<th>{ $L_IP }</th>
+		<th>{ $L_TIME }</th>
+		<th>{ $L_ACTION }</th>
+		<th><!-- IF { $S_CLEAR_ALLOWED } -->{ $L_MARK }<!-- ENDIF --></th>
+	</tr>
+
+	<!-- LOOP $usernotes -->
+		<!-- IF { $usernotes:#LOOP_INDEX } % 2  --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+			<td class="gen">{ $usernotes:REPORT_BY }</td>
+			<td style="text-align: center;">{ $usernotes:IP }</td>
+			<td style="text-align: center;">{ $usernotes:REPORT_AT }</td>
+			<td class="gen">
+				{ $usernotes:ACTION }
+				<!-- IF { $usernotes:DATA } --><br />&#187; <span class="gensmall">[ { $usernotes:DATA } ]</span><!-- ENDIF -->
+			</td>
+			<td style="text-align: center;"><!-- IF { $S_CLEAR_ALLOWED } --><input type="checkbox" class="radio" name="marknote[]" value="{ $usernotes:ID }" /><!-- ENDIF --></td>
+		</tr>
+	<!-- ENDLOOP $usernotes -->
+
+	<!-- IF { $S_CLEAR_ALLOWED } -->
+		<tr>
+			<td class="cat" colspan="5" align="center"><input class="button" type="submit" name="action[del_marked]" value="{ $L_DELETE_MARKED }" />&nbsp; <input class="button" type="submit" name="action[del_all]" value="{ $L_DELETE_ALL }" /></td>
+		</tr>
+	<!-- ENDIF -->
+
+<!-- ELSE -->
+	<tr>
+		<td class="row1" colspan="2" align="center"><span class="gen">{ $L_NO_FEEDBACK }</span></td>
+	</tr>
+<!-- ENDIF -->
+</table>
+
+<br clear="all" />
+	
+<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
+<tr>
+	<th colspan="2" align="center">{ $L_ADD_FEEDBACK }</th>
+</tr>
+<tr>
+	<td class="row3" align="center" colspan="2"><span class="genmed">{ $L_ADD_FEEDBACK_EXPLAIN }</span></td>
+<tr>
+	<td colspan="2" class="row1" align="center"><textarea name="usernote" rows="10" cols="76"></textarea></td>
+</tr>
+<tr>
+	<td class="cat" colspan="2" align="center"><input class="button" type="submit" name="action[add_feedback]" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="button" type="reset" value="{ $L_RESET }" /></td>
+</tr>
+</table>
+
+<table width="100%" cellspacing="0" cellpadding="0">
+<tr>
+	<td class="pagination">{ $PAGE_NUMBER } [ { $TOTAL_REPORTS } ]</td>
+	<td align="right"><span class="pagination"><!-- IF { $PAGINATION } --><a href="javascript:jumpto();">{ $L_GOTO_PAGE }</a> <!-- IF { $PREVIOUS_PAGE } --><a href="{ $PREVIOUS_PAGE }">{ $L_PREVIOUS }</a>&nbsp;&nbsp;<!-- ENDIF -->{ $PAGINATION }<!-- IF NEXT_PAGE -->&nbsp;&nbsp;<a href="{ $NEXT_PAGE }">{ $L_NEXT }</a><!-- ENDIF --><!-- ENDIF --></span></td>
+</tr>
+</table>
+
+</form>
+
+<br clear="all" /><br />
+
+<!-- INCLUDE modules/forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/mcp_post.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_post.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_post.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -1,8 +1,48 @@
 <!-- DISPLAY_HEADER -->
 
 <!-- INCLUDE modules/forums/mcp_header.html -->
+
+<!-- IF { $S_MCP_REPORT } -->
+	<form method="post" name="mcp_report" action="{ $U_CLOSE_ACTION }">
+	
+	<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
+	<tr>
+		<th colspan="2" align="center">{ $L_REPORT_DETAILS }</th>
+	</tr>
+	<tr>
+		<td class="row1"><b class="gen">{ $L_REPORT_REASON }: </b></td>
+		<td class="row2"><span class="gen">{ $REPORT_REASON_TITLE } &raquo; { $REPORT_REASON_DESCRIPTION }</span></td>
+	</tr>
+	<tr>
+		<td class="row1" width="20%"><b class="gen">{ $L_REPORTER }: </b></td>
+		<td class="row2" width="80%"><span class="gen">{ $REPORTER_NAME } &nbsp; [ <!-- IF { $U_VIEW_REPORTER_PROFILE } --><a href="{ $U_VIEW_REPORTER_PROFILE }">{ $L_READ_PROFILE }</a><!-- ENDIF --><!-- IF { $S_USER_NOTES } --><!-- IF { $U_VIEW_REPORTER_PROFILE } --> | <!-- ENDIF --><a href="{ $U_MCP_REPORTER_NOTES }">{ $L_VIEW_NOTES }</a> | <a href="{ $U_MCP_WARN_REPORTER }">{ $L_WARN_USER }</a><!-- ENDIF --> ]</span></td>
+	</tr>
+	<tr>
+		<td class="row1"><b class="gen">{ $L_REPORTED }: </b></td>
+		<td class="row2"><span class="postdetails">{ $REPORT_DATE }</span></td>
+	</tr>
+	<!-- IF { $REPORT_TEXT } -->
+		<tr>
+			<th colspan="2" align="center">{ $L_MORE_INFO }</th>
+		</tr>
+		<tr>
+			<td class="row1" colspan="2"><div class="gen" style="overflow: auto; width: 100%; height: 80pt; border: 1px;">{ $REPORT_TEXT }</div></td>
+		</tr>
+	<!-- ENDIF -->
+	<tr>
+		<td class="cat" align="center" colspan="2"><!-- IF { $S_POST_REPORTED } --><input class="button" type="submit" value="{ $L_CLOSE_REPORT }" name="action[close]" /><!-- ELSE -->{ $L_REPORT_CLOSED }<!-- ENDIF --> &nbsp; <input class="button" type="submit" value="{ $L_DELETE_REPORT }" name="action[delete]" /></td>
+	</tr>
+	</table>
 
-<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg"><form method="post" name="mcp" action="{ $U_APPROVE_ACTION }">
+	<input type="hidden" name="post_id_list[]" value="{POST_ID}" />
+	</form>
+
+	<br clear="all"/>
+<!-- ENDIF -->
+
+<!-- IF { $S_MCP_QUEUE } --><form method="post" name="mcp_approve" action="{ $U_APPROVE_ACTION }"><!-- ELSE --><form method="post" name="mcp_report" action="{ $U_CLOSE_ACTION }"><!-- ENDIF -->
+
+<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
 <tr>
 	<th colspan="2" height="28" align="center">{ $L_POST_DETAILS }</th>
 </tr>
@@ -11,11 +51,11 @@
 </tr>
 <tr>
 	<td class="row1"><b class="gen">{ $L_POST_SUBJECT }: </b></td>
-	<td class="row2"><span class="gen">{ $POST_SUBJECT }</span></td>
+	<td class="row2"><span class="gen">{ $POST_SUBJECT }</span><!-- IF { $S_POST_UNAPPROVED } --><span class="postapprove">{ $UNAPPROVED_IMG } <a href="{ $U_MCP_APPROVE }">{ $L_POST_UNAPPROVED }</a></span> <!-- ENDIF --> <!-- IF { $S_POST_REPORTED } && !{ $S_MCP_REPORT  } --><span class="postreported">{ $REPORTED_IMG } <a href="{ $U_MCP_REPORT}">{ $L_POST_REPORTED }</a></span><!-- ENDIF --></td>
 </tr>
 <tr>
 	<td class="row1" width="20%"><b class="gen">{ $L_POSTER }: </b></td>
-	<td class="row2" width="80%"><span class="gen">{ $POSTER_NAME } &nbsp; [ <a href="{ $U_VIEW_PROFILE }">{ $L_READ_PROFILE }</a> ]</span></td>
+	<td class="row2" width="80%"><span class="gen">{ $POSTER_NAME } &nbsp; [ <!-- IF { $U_VIEW_PROFILE } --><a href="{ $U_VIEW_PROFILE }">{ $L_READ_PROFILE }</a> <!-- ENDIF --><!-- IF { $S_USER_NOTES } --><!-- IF { $U_VIEW_PROFILE } --> | <!-- ENDIF --><a href="{ $U_MCP_USER_NOTES }">{ $L_VIEW_NOTES }</a> <!-- IF { $U_MCP_WARN_USER } -->| <a href="{ $U_MCP_WARN_USER }">{ $L_WARN_USER }</a><!-- ENDIF --><!-- ENDIF --> ]</span></td>
 </tr>
 <!-- IF { $S_CAN_VIEWIP } -->
 	<tr>
@@ -33,9 +73,9 @@
 <tr>
 	<td class="row1" colspan="2"><div class="gen" style="overflow: auto; width: 100%; height: 80pt; border: 1px;">{ $POST_PREVIEW }</div><!-- IF { $U_EDIT } --><div class="gen" style="float: right;"><a href="{ $U_EDIT }">{ $EDIT_IMG }</a></div><!-- ENDIF --></td>
 </tr>
-<!-- IF { $S_POST_UNAPPROVED } -->
+<!-- IF { $S_POST_UNAPPROVED } && { $S_MCP_QUEUE } -->
 	<tr>
-		<td class="cat" align="center" colspan="2"><input class="btnmain" type="submit" value="{ $L_APPROVE }" name="mode[approve]" /> &nbsp; <input class="btnlite" type="submit" value="{ $L_DISAPPROVE }" name="mode[disapprove]" /></td>
+		<td class="cat" align="center" colspan="2"><input class="button" type="submit" value="{ $L_APPROVE }" name="mode[approve]" /> &nbsp; <input class="button" type="submit" value="{ $L_DISAPPROVE }" name="mode[disapprove]" /></td>
 	</tr>
 	<input type="hidden" name="post_id_list[]" value="{ $POST_ID }" />
 <!-- ENDIF -->
@@ -43,99 +83,45 @@
 </form>
 
 <!-- IF { $S_MCP_QUEUE } -->
+	<br clear="all" />
+
+	<!-- IF { $S_TOPIC_REVIEW } --><!-- INCLUDE modules/forums/posting_topic_review.html --><!-- ENDIF -->
+<!-- ELSEIF { $S_MCP_REPORT } -->
 	<br clear="all" />
-	<!-- IF { $S_TOPIC_REVIEW } --><!-- INCLUDE modules/Forums/posting_topic_review.html --><!-- ENDIF -->
-<!-- ELSE -->
-	<!-- IF { $S_SHOW_USER_NOTES } -->
-		<br /><a name="usernotes"></a>
-		<form method="post" name="mcp" action="{ $U_POST_ACTION }">
-		
-		<!-- IF { $S_USER_NOTES } -->
-			<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
-			<tr>
-				<th colspan="2" height="28" align="center">{ $L_FEEDBACK }</th>
-			</tr>
-			<!-- LOOP $usernotes -->
-			<!-- IF { $usernotes:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
-				<td<!-- IF !{ $S_CLEAR_ALLOWED } --> colspan="2"<!-- ENDIF -->><span class="gensmall">Report by: <b>{ $usernotes:REPORT_BY }</b> on { $usernotes:REPORT_AT }</span><hr /><span class="gen">{ $usernotes:ACTION }</span></td>
-				<!-- IF { $S_CLEAR_ALLOWED } --><td width="5%" align="center"><input type="checkbox" name="marknote[]" value="{ $usernotes:ID }" /></td><!-- ENDIF -->
-			</tr>
-			<!-- ENDLOOP -->
-			<!-- IF { $S_CLEAR_ALLOWED } -->
-			<tr>
-				<td class="cat" colspan="2" align="center"><input class="btnlite" type="submit" name="action[del_marked]" value="{ $L_DELETE_MARKED }" />&nbsp; <input class="btnlite" type="submit" name="action[del_all]" value="{ $L_DELETE_ALL }" /></td>
-			</tr>
-			<!-- ENDIF -->
-			</table>
-			<br />
-		<!-- ENDIF -->
-		
-		<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
-		<tr>
-			<th colspan="2" height="28" align="center">{ $L_ADD_FEEDBACK }</th>
-		</tr>
-		<tr>
-			<td class="row3" align="center" colspan="2"><span class="genmed">{ $L_ADD_FEEDBACK_EXPLAIN }</span></td>
-		<tr>
-			<td colspan="2" class="row1" align="center"><textarea name="usernote" rows="10" cols="76"></textarea></td>
-		</tr>
-		<tr>
-			<td class="cat" colspan="2" align="center"><input class="btnmain" type="submit" name="action[add_feedback]" value="{ $L_SUBMIT }" />&nbsp;&nbsp;<input class="btnlite" type="reset" value="{ $L_RESET }" /></td>
-		</tr>
-		</table>
 
-		</form>
-	<!-- ENDIF -->
-	
-	<!-- IF { $S_SHOW_REPORTS } -->
-		<br /><a name="reports"></a>
-
-		<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
-		<tr>
-			<th colspan="2" height="28" align="center">{ $L_REPORTS }</th>
-		</tr>
-		<!-- LOOP $reports -->
-			<tr>
-				<td class="row1"><b class="genmed">{ $reports:REPORT_TIME }</b></td>
-				<td class="row2"><span class="gen">{ $reports:REASON_TITLE } &#187; { $reports:REASON_DESC }</span></td>
-			</tr>
-			<tr>
-				<td class="row1"><b class="genmed">{ $L_REPORTER }: </b></td>
-				<td class="row2"><span class="gen"><!-- IF { $reports:U_REPORTER } --><a href="{ $reports:U_REPORTER }">{ $reports:REPORTER }</a><!-- ELSE -->{ $reports:REPORTER }<!-- ENDIF --></span></td>
-			</tr>
-			<!-- IF { $reports:REPORT_TEXT } -->
-				<tr>
-					<td class="row1" valign="top"><b class="genmed">{ $L_MORE_INFO }: </b></td>
-					<td class="row2"><span class="gen">{ $reports:REPORT_TEXT }</span></td>
-				</tr>
-			<!-- ENDIF -->
-			<tr>
-				<td colspan="2" class="spacer"></td>
-			</tr>
-		<!-- ENDLOOP -->
-		</table>
-	<!-- ENDIF -->
-
+	<!-- IF { $S_TOPIC_REVIEW } --><!-- INCLUDE modules/forums/posting_topic_review.html --><!-- ENDIF -->
+<!-- ELSE -->
 	<!-- IF { $S_CAN_LOCK_POST } || { $S_CAN_DELETE_POST } || { $S_CAN_CHGPOSTER } -->
 		<br /><a name="mod"></a>
 
 		<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
 		<tr>
-			<th colspan="2" height="28" align="center">{ $L_MOD_OPTIONS }</th>
+			<th colspan="2" align="center">{ $L_MOD_OPTIONS }</th>
 		</tr>
 		<!-- IF { $S_CAN_CHGPOSTER } -->
 			<tr>
-				<form method="post" name="mcp" action="{ $U_POST_ACTION }" { $S_FORM_ENCTYPE }>
+				<form method="post" name="mcp_chgposter" action="{ $U_POST_ACTION }">
 					<td class="row1" valign="top"><b class="gen">{ $L_CHANGE_POSTER }</b></td>
-					<td class="row2"><!-- IF { $S_USER_SELECT } --><select name="u">{ $S_USER_SELECT }</select> <input type="submit" class="btnmain" name="action[chgposter]" value="{ $L_CONFIRM }" /><br /><!-- ENDIF --> <input class="post" type="text" name="username" value="{ $SEARCH_USERNAME }" /> <input class="btnlite" type="submit" value="{ $L_SEARCH }" name="action[chgposter_search]" /></td>
+					<td class="row2"><input class="post" type="text" name="username" value="" /> <input class="button" type="submit" value="{ $L_CONFIRM }" name="action[chgposter]" /><br /><span class="gensmall">[ <a href="{ $U_FIND_MEMBER }" onclick="window.open('{ $U_FIND_MEMBER }', '_phpbbsearch', 'HEIGHT=500,resizable=yes,scrollbars=yes,WIDTH=740');return false;">{ $L_FIND_USERNAME }</a> ]</span><!-- IF { $S_USER_SELECT } --><br /><select name="u">{ $S_USER_SELECT }</select> <input type="submit" class="button" name="action[chgposter_ip]" value="{ $L_CONFIRM }" /><!-- ENDIF --></td>
 				</form>
 			</tr>
 		<!-- ENDIF -->
 		<!-- IF { $S_CAN_LOCK_POST } || { $S_CAN_DELETE_POST } -->
 			<tr>
-				<form method="post" name="mcp" action="{ $U_MCP_ACTION }"{ $S_FORM_ENCTYPE }>
+				<form method="post" name="mcp" action="{ $U_MCP_ACTION }">
 					<td class="row1" valign="top"><b class="gen">{ $L_MOD_OPTIONS }</b></td>
-					<td class="row2"><select name="mode"><!-- IF { $S_CAN_LOCK_POST } --><!-- IF { $S_POST_LOCKED } --><option value="unlock_post">{ $L_UNLOCK_POST } [{ $L_UNLOCK_POST_EXPLAIN }]</option><!-- ELSE --><option value="lock_post">{ $L_LOCK_POST } [{ $L_LOCK_POST_EXPLAIN }]</option><!-- ENDIF --><!-- ENDIF --><!-- IF { $S_CAN_DELETE_POST } --><option value="delete_post">{ $L_DELETE_POST }</option><!-- ENDIF --></select> <input class="btnmain" type="submit" value="{ $L_SUBMIT }" /></td>
+					<td class="row2"><select name="action">
+					<!-- IF { $S_CAN_LOCK_POST } -->
+						<!-- IF { $S_POST_LOCKED } -->
+						<option value="unlock_post">{ $L_UNLOCK_POST } [{ $L_UNLOCK_POST_EXPLAIN }]</option>
+						<!-- ELSE -->
+						<option value="lock_post">{ $L_LOCK_POST } [{ $L_LOCK_POST_EXPLAIN }]</option>
+						<!-- ENDIF -->
+					<!-- ENDIF -->
+					<!-- IF S_CAN_DELETE_POST -->
+						<option value="delete_post">{ $L_DELETE_POST }</option>
+					<!-- ENDIF -->
+					</select> <input class="button" type="submit" value="{ $L_SUBMIT }" /></td>
 				</form>
 			</tr>
 		<!-- ENDIF -->
@@ -147,10 +133,10 @@
 
 		<table width="100%" cellpadding="3" cellspacing="1" border="0" class="tablebg">
 		<tr>
-			<th colspan="2" height="28" align="center">{ $L_IP_INFO }</th>
+			<th colspan="2" align="center">{ $L_IP_INFO }</th>
 		</tr>
 		<tr>
-			<td colspan="2" height="28" class="cat"><b class="gen">{ $L_OTHER_USERS }</b></td>
+			<td colspan="2" class="cat"><b class="gen">{ $L_OTHER_USERS }</b></td>
 		</tr>
 		<!-- LOOP $userrow -->
 			<!-- IF { $userrow:#LOOP_INDEX } % 2 -->
@@ -158,20 +144,20 @@
 			<!-- ELSE -->
 				<tr class="row2">
 			<!-- ENDIF -->
-				<td><span class="gen"><a href="{ $userrow:U_PROFILE }">{ $userrow:USERNAME }</a> [ { $userrow:NUM_POSTS } { $userrow:L_POST_S } ]</span></td>
+				<td><span class="gen"><a href="{ $userrow:U_PROFILE }">{ $userrow:USERNAME}</a> [ { $userrow:NUM_POSTS } { $userrow:L_POST_S } ]</span></td>
 				<td align="center"><a href="{ $userrow:U_SEARCHPOSTS }">{ $SEARCH_IMG }</a></td>
 			</tr>
 		<!-- LOOPELSE -->
 			<tr class="row1">
-				<td colspan="2" align="center"><span class="gen">{ $L_NO_MATCHES_FOUND }</span></td>
+				<td colspan="2" align="center"><span class="gen">{ $L_NO_MATCHES_FOUND}</span></td>
 			</tr>
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $userrow -->
 		<tr>
-			<td height="28" class="cat"><b class="gen">{ $L_OTHER_IPS }</b></td>
+			<td class="cat"><b class="gen">{ $L_OTHER_IPS }</b></td>
 			<td class="cat" width="10%" nowrap="nowrap"><!-- IF { $U_LOOKUP_ALL } --><span class="gen">[ <a href="{ $U_LOOKUP_ALL }">{ $L_LOOKUP_ALL }</a> ]</span><!-- ENDIF --></td>
 		</tr>
 		<!-- LOOP $iprow -->
-			<!-- IF { $userrow:#iprow } % 2 -->
+			<!-- IF { $iprow:#LOOP_INDEX } % 2 -->
 				<tr class="row1">
 			<!-- ELSE -->
 				<tr class="row2">
@@ -183,7 +169,7 @@
 			<tr class="row1">
 				<td colspan="2" align="center"><span class="gen">{ $L_NO_MATCHES_FOUND }</span></td>
 			</tr>
-		<!-- ENDLOOP -->
+		<!-- ENDLOOP $iprow -->
 		</table>
 	<!-- ENDIF -->
 <!-- ENDIF -->

Modified: cms/trunk/includes/templates/modules/forums/mcp_topic.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_topic.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_topic.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -4,7 +4,7 @@
 
 <form name="mcp" method="post" action="{ $S_MCP_ACTION }">
 	<table class="tablebg" width="100%" cellspacing="1">
-		<!-- IF { $S_CAN_SPLIT } -->
+	<!-- IF { $S_CAN_SPLIT } -->
 		<tr>
 			<th colspan="3" nowrap="nowrap">{ $L_SPLIT_TOPIC }</th>
 		</tr>
@@ -29,7 +29,8 @@
 				</tr>
 			</table></td>
 		</tr>
-		<!-- ENDIF --><!-- ENDIF -->
+		<!-- ENDIF -->
+	<!-- ENDIF -->
 	
 		<!-- IF { $S_CAN_MERGE } -->
 		<tr>
@@ -40,7 +41,7 @@
 		</tr>
 		<tr>
 			<td class="row1" nowrap="nowrap"><span class="gen">{ $L_MERGE_TOPIC_ID }</span></td>
-			<td class="row2" colspan="2"><input class="post" type="text" size="6" name="to_topic_id" value="{ $TO_TOPIC_ID }" /> <input class="btnlite" type="submit" name="action[merge_select]" value="{ $L_SELECT_TOPIC }" /></td>
+			<td class="row2" colspan="2"><input class="post" type="text" size="6" name="to_topic_id" value="{ $TO_TOPIC_ID }" /> <input class="button" type="submit" name="action[merge_select]" value="{ $L_SELECT_TOPIC }" /></td>
 		</tr>
 		<!-- IF { $TO_TOPIC_INFO } -->
 		<tr>
@@ -55,12 +56,15 @@
 			<td class="row2" colspan="2"><input class="post" type="text" name="posts_per_page" size="6" value="{ $POSTS_PER_PAGE }"></td>
 		</tr>
 		<tr>
-			<td class="cat" colspan="3" height="28" align="center"><span class="gensmall">{ $L_DISPLAY_POSTS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="btnlite" type="submit" name="sort" value="{ $L_GO }" /></span></td>
+			<td class="cat" colspan="3" height="28" align="center"><span class="gensmall">{ $L_DISPLAY_POSTS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<input class="button" type="submit" name="sort" value="{ $L_GO }" /></span></td>
 		</tr>
 		<tr>
 			<th height="28" nowrap="nowrap">{ $L_AUTHOR }</th>
 			<th nowrap="nowrap">{ $L_MESSAGE }</th>
 			<th nowrap="nowrap">{ $L_SELECT }</th>
+		</tr>
+		<tr>
+			<td class="row3" colspan="3" align="center"><span class="gensmall">{ $RETURN_TOPIC }</span></td>
 		</tr>
 		<!-- LOOP $postrow -->
 			<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
@@ -76,7 +80,7 @@
 						<td class="gensmall" width="100%">{ $postrow:POST_SUBJECT }</td>
 					</tr>
 				</table></td>
-				<td rowspan="2" width="5%" align="center">{ $postrow:S_CHECKBOX }</td>
+			<td rowspan="2" width="5%" align="center"><input type="checkbox" class="radio" name="post_id_list[]" value="{ $postrow:POST_ID }"<!-- IF { $postrow:S_CHECKED } --> checked="checked"<!-- ENDIF --> /></td>
 			</tr>
 			<!-- IF { $postrow:#LOOP_INDEX } % 2 -->
 				<tr class="row1">
@@ -86,7 +90,7 @@
 				<td valign="bottom">
 					<table width="100%" cellspacing="0" cellpadding="0" border="0">
 						<tr valign="middle">
-							<td height="28" align="center"><span class="gensmall">[ <a href="{ $postrow:U_POST_DETAILS }">{$L_POST_DETAILS}</a> ]</span></td>
+							<td height="28" align="center"><span class="gensmall">[ <a href="{ $postrow:U_POST_DETAILS }">{ $L_POST_DETAILS }</a> ]</span></td>
 						</tr>
 					</table>
 				</td>
@@ -98,15 +102,10 @@
 						<td valign="bottom">
 							<table width="100%" cellspacing="0" cellpadding="0" border="0">
 								<tr valign="middle">
-									<!-- IF { $postrow:S_POST_UNAPPROVED } -->
-									<td width="5">{ $UNAPPROVED_IMG }</td>
-									<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:green"  href="{ $postrow:U_MCP_APPROVE }">{ $L_POST_UNAPPROVED }</a></b>&nbsp;&nbsp;</td>
-									<!-- ENDIF -->
-									<!-- IF { $postrow:S_POST_REPORTED } -->
-									<td width="5">{ $REPORTED_IMG }</td>
-									<td class="gensmall" nowrap="nowrap">&nbsp;<b><a style="color:red" href="{ $postrow:U_POST_DETAILS }">{ $L_POST_REPORTED }</a></b>&nbsp;</td>
-									<!-- ENDIF -->
-									<td width="100%">&nbsp;</td>
+									<td width="100%">
+										<!-- IF { $postrow:S_POST_UNAPPROVED } -->{ $UNAPPROVED_IMG } <span class="postapprove"><a href="{ $postrow:U_MCP_APPROVE }">{ $L_POST_UNAPPROVED }</a></span><!-- ENDIF -->
+										<!-- IF { $postrow:S_POST_REPORTED } -->{ $REPORTED_IMG }<span class="postreported"><a href="{ $postrow:U_MCP_REPORT }">{ $L_POST_REPORTED }</a></span><!-- ENDIF -->
+									</td>
 									<td width="10" nowrap="nowrap">{ $postrow:MINI_POST_IMG }</td>
 									<td class="gensmall" nowrap="nowrap"><b>{ $L_POSTED }:</b> { $postrow:POST_DATE }</td>
 								</tr>
@@ -125,16 +124,16 @@
 				<!-- IF { $S_CAN_APPROVE } --><option value="approve">{ $L_APPROVE_POSTS}</option><!-- ENDIF -->
 				<!-- IF { $S_CAN_LOCK } --><option value="lock_post">{ $L_LOCK_POST_POSTS } [ { $L_LOCK_POST_EXPLAIN } ]</option><option value="unlock_post">{ $L_UNLOCK_POST_POSTS }</option><!-- ENDIF -->
 				<!-- IF { $S_CAN_DELETE } --><option value="delete_post">{ $L_DELETE_POSTS }</option><!-- ENDIF -->
-				<!-- IF { $S_CAN_MERGE } --><option value="merge_posts"<!-- IF { $MODE } == 'merge' --> selected="selected"<!-- ENDIF -->>{ $L_MERGE_POSTS }</option><!-- ENDIF -->
-				<!-- IF { $S_CAN_SPLIT } --><option value="split_all"<!-- IF { $MODE } == 'split' --> selected="selected"<!-- ENDIF -->>{ $L_SPLIT_POSTS }</option><option value="split_beyond">{ $L_SPLIT_AFTER }</option><!-- ENDIF -->
-			</select>&nbsp;<input class="btnmain" type="submit" name="quick" value="{$L_SUBMIT}"></form></td>
+				<!-- IF { $S_CAN_MERGE } --><option value="merge_posts"<!-- IF { $MODE } === 'merge' --> selected="selected"<!-- ENDIF -->>{ $L_MERGE_POSTS }</option><!-- ENDIF -->
+				<!-- IF { $S_CAN_SPLIT } --><option value="split_all"<!-- IF { $MODE } === 'split' --> selected="selected"<!-- ENDIF -->>{ $L_SPLIT_POSTS }</option><option value="split_beyond">{ $L_SPLIT_AFTER }</option><!-- ENDIF -->
+			</select>&nbsp;<input class="button" type="submit" name="mcp_topic_submit" value="{$L_SUBMIT}"></form></td>
 		</tr>
 	</table>
 </form>
 
 <table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
 	<tr>
-		<td align="right" valign="top" nowrap="nowrap"><b class="gensmall"><a href="javascript:marklist('mcp', true);">{ $L_MARK_ALL }</a> :: <a href="javascript:marklist('mcp', false);">{ $L_UNMARK_ALL }</a></b></td>
+		<td align="right" valign="top" nowrap="nowrap"><b class="gensmall"><a href="javascript:marklist('mcp', '', true);">{ $L_MARK_ALL }</a> :: <a href="javascript:marklist('mcp', '', false);">{ $L_UNMARK_ALL }</a></b></td>
 	</tr>
 </table>
 

Added: cms/trunk/includes/templates/modules/forums/mcp_whois.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_whois.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/mcp_whois.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -0,0 +1,19 @@
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/forums/mcp_header.html -->
+
+<table class="tablebg" width="100%" cellspacing="1">
+<tr> 
+	<th>{ $L_WHOIS }</th>
+</tr>
+<tr>
+	<td class="row3" align="center"><span class="gensmall">{ $RETURN_POST }</span></td>
+</tr>
+<tr>
+	<td class="row1"><pre>{ $WHOIS }</pre></td>
+</tr>
+</table>
+
+<!-- INCLUDE modules/forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/viewforum_subforum.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/viewforum_subforum.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/forums/viewforum_subforum.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -14,12 +14,12 @@
 <!-- LOOP $forumrow -->
 	<!-- IF { $forumrow:S_IS_CAT } -->
 	<tr>
-		<td class="cat" colspan="2"><a class="cattitle" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></td>
+		<td class="cat" colspan="2"><h4><a href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a></h4></td>
 		<td class="catdiv" colspan="3" align="right">&nbsp;</td>
 	</tr>
 	<!-- ELSEIF { $forumrow:S_IS_LINK } -->
 	<tr>
-		<td class="row1" width="50" height="40" align="center">{ $forumrow:FORUM_FOLDER_IMG }</td>
+		<td class="row1" width="50" height="40" align="center" valign="middle">{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<td class="row1" height="40" id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF --> width="100%">
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
 			<!-- IF { $forumrow:FORUM_DESC } -->
@@ -34,27 +34,34 @@
 	</tr>
 	<!-- ELSE -->
 	<tr>
-		<td class="row1" width="50" height="40" align="center" id="forum_folder_status_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } --> onmouseover="lock_unlock_init('{ $forumrow:FORUM_ID }', 'forum', { $forumrow:FORUM_LOCKED });" <!-- ENDIF -->>{ $forumrow:FORUM_FOLDER_IMG }</td>
+		<td class="row1" width="50" height="40" align="center" valign="middle" id="forum_folder_status_{ $forumrow:FORUM_ID }" <!-- IF { $MODIFY_FORUM } --> onmouseover="lock_unlock_init('{ $forumrow:FORUM_ID }', 'forum', { $forumrow:FORUM_LOCKED });" <!-- ENDIF -->>{ $forumrow:FORUM_FOLDER_IMG }</td>
 		<td class="row1" width="100%" height="40"  id="forum_{ $forumrow:FORUM_ID }"<!-- IF { $MODIFY_FORUM } --> onmouseover="tite_edit_init('{ $forumrow:FORUM_ID }', 'forum');"<!-- ENDIF -->>
 			<a class="forumlink" id="forum_name_{ $forumrow:FORUM_ID }" href="{ $forumrow:U_VIEWFORUM }">{ $forumrow:FORUM_NAME }</a><br />
-			<!-- IF { $forumrow:FORUM_DESC } -->
-			<table cellspacing="5" cellpadding="0" border="0">
-				<tr>
-					<td><span class="gensmall">{ $forumrow:FORUM_DESC }</span></td>
-				</tr>
-			</table>
-			<!-- ENDIF --><!-- IF { $forumrow:MODERATORS } || { $forumrow:SUBFORUMS }-->
-			<span class="gensmall"><!-- IF { $forumrow:MODERATORS } --><b>{ $forumrow:L_MODERATOR_STR }:</b> { $forumrow:MODERATORS }<br /><!-- ENDIF --><!-- IF { $forumrow:SUBFORUMS } --><br /><b>{ $forumrow:L_SUBFORUM_STR }</b> { $forumrow:SUBFORUMS }<!-- ENDIF --></span>
-			<!-- ENDIF -->
+			<p class="forumdesc">{ $forumrow:FORUM_DESC }</p>
+				<!-- IF { $forumrow:MODERATORS } -->
+					<p class="forumdesc"><strong>{ $forumrow:L_MODERATOR_STR  }:</strong> { $forumrow:MODERATORS }</p>
+				<!-- ENDIF -->
+				<!-- IF { $forumrow:SUBFORUMS } -->
+					<p class="forumdesc"><strong>{ $forumrow:L_SUBFORUM_STR }</strong> { $forumrow:SUBFORUMS }</p>
+				<!-- ENDIF -->
 		</td>
 		<td class="row2" align="center"><span class="gensmall">{ $forumrow:TOPICS }</span></td>
 		<td class="row2" align="center"><span class="gensmall">{ $forumrow:POSTS }</span></td>
 		<td class="row2" align="center" nowrap="nowrap">
 			<span class="gensmall">
-				<!-- IF { $forumrow:LAST_POST_TIME } -->{ $forumrow:LAST_POST_TIME }<br />
-				<!-- IF { $forumrow:U_LAST_POSTER } --><a href="{ $forumrow:U_LAST_POSTER }">{ $forumrow:LAST_POSTER }</a><!-- ELSE -->{ $forumrow:LAST_POSTER }<!-- ENDIF -->
-				<a href="{ $forumrow:U_LAST_POST }">{ $forumrow:LAST_POST_IMG }</a><!-- ELSE -->{ $L_NO_POSTS }<!-- ENDIF -->
-				</span>
+				<!-- IF { $forumrow:LAST_POST_TIME } -->
+				<p class="topicdetails">{ $forumrow:LAST_POST_TIME }</p>
+				<p class="topicdetails">
+				<!-- IF { $forumrow:U_LAST_POSTER } -->
+					<a href="{forumrow.U_LAST_POSTER }">{ $forumrow:LAST_POSTER }</a>
+				<!-- ELSE -->
+					{ $forumrow:LAST_POSTER }
+				<!-- ENDIF -->
+				<a href="{ $forumrow:U_LAST_POST}">{ $LAST_POST_IMG }</a>
+				</p>
+			<!-- ELSE -->
+				<p class="topicdetails">{ $L_NO_POSTS }</p>
+			<!-- ENDIF -->
 		</td>
 	</tr>
 	<!-- ENDIF -->

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_body.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_body.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -1,4 +1,6 @@
-<!-- DISPLAY_HEADER -->
+<!-- IF !{ $DISPLAY_STYLESHEET_LINK } -->
+	<!-- DISPLAY_HEADER -->
+<!-- ENDIF -->
 
 <!-- INCLUDE modules/members_list/memberlist_header.html -->
 
@@ -134,4 +136,6 @@
 
 <!-- INCLUDE modules/members_list/memberlist_footer.html -->
 
-<!-- DISPLAY_FOOTER -->
\ No newline at end of file
+<!-- IF !{ $DISPLAY_STYLESHEET_LINK } -->
+	<!-- DISPLAY_FOOTER -->
+<!-- ENDIF -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_header.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_header.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_header.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -2,7 +2,7 @@
 
 <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
 <meta http-equiv="content-Type" content="text/html; charset={ $SITE_CHARSET }" />
-<link rel="stylesheet" href="{ $A_STYLESHEET }" type="text/css" />
+<link rel="stylesheet" href="{ $THEME_STYLESHEET }" type="text/css" />
 
 <!-- ENDIF -->
 

Modified: cms/trunk/includes/templates/modules/members_list/memberlist_search.html
===================================================================
--- cms/trunk/includes/templates/modules/members_list/memberlist_search.html	2006-08-06 20:26:49 UTC (rev 181)
+++ cms/trunk/includes/templates/modules/members_list/memberlist_search.html	2006-08-06 20:31:57 UTC (rev 182)
@@ -1,22 +1,29 @@
 <script language="javascript" type="text/javascript">
 <!--
-function insert_user(user)
-{
-	opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value = ( opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value.length && opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.type == "textarea" ) ? opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value + "\n" + user : user;
+function insert_user(user)
+{
+	opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value = ( opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value.length && opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.type == "textarea" ) ? opener.document.forms['{ $S_FORM_NAME }'].{ $S_FIELD_NAME }.value + "\n" + user : user;
+}
+
+function insert_marked(users)
+{
+	if (typeof(users.length) == "undefined")
+	{
+		insert_user(users.value);
+	}
+	else if (users.length > 0)
+	{
+		for (i = 0; i < users.length; i++)
+		{
+			if (users[i].checked)
+			{
+				insert_user(users[i].value);
+			}
+		}
+	}
+
+	self.close();
 }
-
-function insert_marked(users)
-{
-	for(i = 0; i < users.length; i++)
-	{
-		if ( users[i].checked )
-		{
-			insert_user(users[i].value);
-		}
-	}
-	self.close();
-}
-
 function marklist(status)
 {
 	for (i = 0; i < document.results.length; i++)



From viperal at mail.berlios.de  Sun Aug 13 04:53:40 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 13 Aug 2006 04:53:40 +0200
Subject: [Viperals-svncheckins] r183 - in cms/trunk: includes includes/db
	includes/forums includes/forums/mcp
	includes/templates/modules/forums modules/control_panel
	modules/control_panel/modules modules/forums
Message-ID: <200608130253.k7D2reNY004690@sheep.berlios.de>

Author: viperal
Date: 2006-08-13 04:53:31 +0200 (Sun, 13 Aug 2006)
New Revision: 183

Modified:
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/bbcode.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_notes.php
   cms/trunk/includes/forums/mcp/mcp_post.php
   cms/trunk/includes/forums/mcp/mcp_queue.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/templates/modules/forums/mcp_approve.html
   cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
   cms/trunk/includes/templates/modules/forums/mcp_queue.html
   cms/trunk/includes/templates/modules/forums/viewtopic_body.html
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/control_panel/modules/ucp_pm.php
   cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
   cms/trunk/modules/control_panel/modules/ucp_pm_options.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
   cms/trunk/modules/forums/mcp.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/db/postgres.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -244,6 +244,9 @@
 			return false;
 		}
 
+		$this->num_queries++;
+		$this->last_query = '';
+
 		SWitch (strtoupper($query_type))
 		{
 			case 'MULTI_INSERT':
@@ -254,13 +257,17 @@
 			break;
 
 			case 'INSERT':
-				return pg_insert($this->link_identifier, $table, $array);
-				//return $this->query('INSERT INTO ' . $table . ' '. $values');
+				//	return pg_insert($this->link_identifier, $table, $array);
+				// We can't use pg_insert if we need needed to get the insert_id
+				$this->last_query = 'INSERT INTO ' . $table . ' '. $this->sql_build_array('INSERT', $array);
+				$this->last_result = $this->query($this->last_query);
+	
+				return $this->last_result;
 			break;
 
 			case 'UPDATE':
 				return pg_update($this->link_identifier, $table, $array);
-				//return $this->query('UPDATE ' . $table . ' SET ' . $values);
+				//return $this->query('UPDATE ' . $table . ' SET ' . $array);
 			break;
 		}
 	}

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/auth.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -32,11 +32,14 @@
 // mysteriously appear elsewhere, think up your own solutions!
 class forums_auth
 {
-	var $founder = false;
 	var $acl = array();
+	var $cache = array();
 	var $option = array();
 	var $acl_options = array();
-
+
+	/**
+	* Init permissions
+	*/
 	function acl($userdata)
 	{
 		global $_CLASS;
@@ -49,6 +52,8 @@
 			$result = $_CLASS['core_db']->query($sql);
 
 			$global = $local = 0;
+			$this->acl_options = array();
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				if (!empty($row['is_global']))
@@ -74,54 +79,112 @@
 
 		foreach (explode("\n", $userdata['user_permissions']) as $f => $seq)
 		{
-			if ($seq)
-			{
-				$i = 0;
-				while ($subseq = substr($seq, $i, 6))
-				{
-					if (!isset($this->acl[$f]))
-					{
-						$this->acl[$f] = '';
-					}
-					$this->acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
-					$i += 6;
-				}
+			if ($seq)
+			{
+				$i = 0;
+
+				if (!isset($this->acl[$f]))
+				{
+					$this->acl[$f] = '';
+				}
+
+				while ($subseq = substr($seq, $i, 6))
+				{
+					// We put the original bitstring into the acl array
+					$this->acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
+					$i += 6;
+				}
 			}
 		}
 		return;
 	}
 
-	// Look up an option
+	/**
+	* Look up an option
+	* if the option is prefixed with !, then the result becomes negated
+	*
+	* If a forum id is specified the local option will be combined with a global option if one exist.
+	* If a forum id is not specified, only the global option will be checked.
+	*/
 	function acl_get($opt, $f = 0)
 	{
-		static $cache;
+		$negate = false;
+
+		if (strpos($opt, '!') === 0)
+		{
+			$negate = true;
+			$opt = substr($opt, 1);
+		}
 
-		if (!isset($cache[$f][$opt]))
+		if (!isset($this->cache[$f][$opt]))
 		{
-			$cache[$f][$opt] = false;
-			if (isset($this->acl_options['global'][$opt]))
+			// We combine the global/local option with an OR because some options are global and local.
+			// If the user has the global permission the local one is true too and vice versa
+			$this->cache[$f][$opt] = false;
+
+			// Is this option a global permission setting?
+			if (isset($this->acl_options['global'][$opt]))
 			{
 				if (isset($this->acl[0]))
 				{
-					$cache[$f][$opt] = $this->acl[0]{$this->acl_options['global'][$opt]};
+					$this->cache[$f][$opt] = $this->acl[0]{$this->acl_options['global'][$opt]};
 				}
 			}
 
-			if (isset($this->acl_options['local'][$opt]))
+			// Is this option a local permission setting?
+			// But if we check for a global option only, we won't combine the options...
+			if ($f != 0 && isset($this->acl_options['local'][$opt]))
 			{
 				if (isset($this->acl[$f]))
 				{
-					$cache[$f][$opt] |= $this->acl[$f]{$this->acl_options['local'][$opt]};
+					$this->cache[$f][$opt] |= $this->acl[$f]{$this->acl_options['local'][$opt]};
 				}
 			}
 		}
 
-		return isset($cache[$f][$opt]) ? $cache[$f][$opt] : false;
+		// Founder always has all global options set to true...
+		return ($negate) ? !$this->cache[$f][$opt] : $this->cache[$f][$opt];
 	}
 
-	function acl_getf($opt)
+	/**
+	* Get forums with the specified permission setting
+	* if the option is prefixed with !, then the result becomes nagated
+	*
+	* @param bool $clean set to true if only values needs to be returned which are set/unset
+	*/
+	function acl_getf($opt, $clean = false)
 	{
-		$cache = false;
+		$acl_f = array();
+		$negate = false;
+
+		if (strpos($opt, '!') === 0)
+		{
+			$negate = true;
+			$opt = substr($opt, 1);
+		}
+
+		// If we retrieve a list of forums not having permissions in, we need to get every forum_id
+		if ($negate)
+		{
+			if ($this->acl_forum_ids === false)
+			{
+				$sql = 'SELECT forum_id 
+					FROM ' . FORUMS_FORUMS_TABLE;
+				
+				if (sizeof($this->acl))
+				{
+					$sql .= ' WHERE forum_id NOT IN (' .  implode(', ', array_keys($this->acl)).')';
+				}
+				$result = $_CLASS['core_db']->query($sql);
+
+				$this->acl_forum_ids = array();
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$this->acl_forum_ids[] = $row['forum_id'];
+				}
+				$_CLASS['core_db']->free_result($result);
+			}
+		}
 
 		if (isset($this->acl_options['local'][$opt]))
 		{
@@ -129,23 +192,77 @@
 
 			foreach ($this->acl as $f => $bitstring)
 			{
-				if (!isset($cache[$f][$opt]))
-				{
-					$cache[$f][$opt] = false;
+				// Skip global settings
+				if (!$f)
+				{
+					continue;
+				}
 
-					$cache[$f][$opt] = $bitstring{$this->acl_options['local'][$opt]};
-
-					if (isset($this->acl_options['global'][$opt]))
-					{
-						$cache[$f][$opt] |= $this->acl[0]{$this->acl_options['global'][$opt]};
-					}
+				$allowed = (!isset($this->cache[$f][$opt])) ? $this->acl_get($opt, $f) : $this->cache[$f][$opt];
+
+				if (!$clean)
+				{
+					$acl_f[$f][$opt] = ($negate) ? !$allowed : $allowed;
+				}
+				else
+				{
+					if (($negate && !$allowed) || (!$negate && $allowed))
+					{
+						$acl_f[$f][$opt] = 1;
+					}
 				}
 			}
 		}
 
-		return $cache;
+		// If we get forum_ids not having this permission, we need to fill the remaining parts
+		if ($negate && sizeof($this->acl_forum_ids))
+		{
+			foreach ($this->acl_forum_ids as $f)
+			{
+				$acl_f[$f][$opt] = 1;
+			}
+		}
+
+		return $acl_f;
 	}
 
+	/**
+	* Get local permission state for any forum.
+	*
+	* Returns true if user has the permission in one or more forums, false if in no forum.
+	* If global option is checked it returns the global state (same as acl_get($opt))
+	* Local option has precedence...
+	*/
+	function acl_getf_global($opt)
+	{
+		$allowed = false;
+
+		if (isset($this->acl_options['local'][$opt]))
+		{
+			foreach ($this->acl as $f => $bitstring)
+			{
+				// Skip global settings
+				if (!$f)
+				{
+					continue;
+				}
+
+				$allowed = (!isset($this->cache[$f][$opt])) ? $this->acl_get($opt, $f) : $this->cache[$f][$opt];
+
+				if ($allowed)
+				{
+					break;
+				}
+			}
+		}
+		else if (isset($this->acl_options['global'][$opt]))
+		{
+			$allowed = $this->acl_get($opt);
+		}
+
+		return $allowed;
+	}
+
 	function acl_gets($opts, $f = 0)
 	{
 		$acl = 0;
@@ -176,87 +293,188 @@
 
 		$auth_ary = array();
 
-		foreach ($hold_ary as $user_id => $forum_ary)
-		{
-			foreach ($forum_ary as $forum_id => $auth_option_ary)
-			{
-				foreach ($auth_option_ary as $auth_option => $auth_setting)
-				{
-					$auth_ary[$forum_id][$auth_option][] = $user_id;
-				}
-			}
+		foreach ($hold_ary as $user_id => $forum_ary)
+		{
+			foreach ($forum_ary as $forum_id => $auth_option_ary)
+			{
+				foreach ($auth_option_ary as $auth_option => $auth_setting)
+				{
+					if ($auth_setting)
+					{
+						$auth_ary[$forum_id][$auth_option][] = $user_id;
+					}
+				}
+			}
 		}
 
 		return $auth_ary;
 	}
 
-	// Cache data
+	/**
+	* Cache data to user_permissions row
+	*/
 	function acl_cache(&$userdata)
 	{
 		global $_CLASS;
 
-		$hold_ary = $this->acl_raw_data($userdata['user_id'], false, false);
-		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
+		// Empty user_permissions
+		$userdata['user_permissions'] = '';
+
+		$hold_ary = $this->acl_raw_data($userdata['user_id'], false, false);
+
+		if (isset($hold_ary[$userdata['user_id']]))
+		{
+			$hold_ary = $hold_ary[$userdata['user_id']];
+		}
 
-		$hold_str = '';
-		if (is_array($hold_ary))
-		{
-			ksort($hold_ary);
+		$hold_str = $this->build_bitstring($hold_ary);
+
+		if ($hold_str)
+		{
+			$userdata['user_permissions'] = $hold_str;
+
+			$sql = 'UPDATE ' . USERS_TABLE . "
+				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "',
+					user_perm_from = 0
+				WHERE user_id = " . $userdata['user_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+	/**
+	* Build bitstring from permission set
+	*/
+	function build_bitstring(&$hold_ary)
+	{
+		$hold_str = '';
+
+		if (sizeof($hold_ary))
+		{
+			ksort($hold_ary);
+
+			$last_f = 0;
+
+			foreach ($hold_ary as $f => $auth_ary)
+			{
+				$ary_key = (!$f) ? 'global' : 'local';
+
+				$bitstring = array();
+				foreach ($this->acl_options[$ary_key] as $opt => $id)
+				{
+					if (isset($auth_ary[$opt]))
+					{
+						$bitstring[$id] = $auth_ary[$opt];
+
+						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
+
+						// If one option is allowed, the global permission for this option has to be allowed too
+						// example: if the user has the a_ permission this means he has one or more a_* permissions
+						if ($auth_ary[$opt] == ACL_YES && (!isset($bitstring[$this->acl_options[$ary_key][$option_key]]) || $bitstring[$this->acl_options[$ary_key][$option_key]] == ACL_NEVER))
+						{
+							$bitstring[$this->acl_options[$ary_key][$option_key]] = ACL_YES;
+						}
+					}
+					else
+					{
+						$bitstring[$id] = ACL_NEVER;
+					}
+				}
+
+				// Now this bitstring defines the permission setting for the current forum $f (or global setting)
+				$bitstring = implode('', $bitstring);
+
+				// The line number indicates the id, therefore we have to add empty lines for those ids not present
+				$hold_str .= str_repeat("\n", $f - $last_f);
+			
+				// Convert bitstring for storage - we do not use binary/bytes because PHP's string functions are not fully binary safe
+				for ($i = 0; $i < strlen($bitstring); $i += 31)
+				{
+					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
+				}
+
+				$last_f = $f;
+			}
+			unset($bitstring);
+
+			$hold_str = rtrim($hold_str);
+		}
+
+		return $hold_str;
+	}
 
-			$last_f = 0;
-			foreach ($hold_ary as $f => $auth_ary)
-			{
-				$ary_key = (!$f) ? 'global' : 'local';
+	/**
+	* Clear one or all users cached permission settings
+	*/
+	function acl_clear_prefetch($user_id = false)
+	{
+		global $_CLASS;
 
-				$bitstring = array();
-				foreach ($this->acl_options[$ary_key] as $opt => $id)
-				{
-					if (!empty($auth_ary[$opt]))
-					{
-						$bitstring[$id] = 1;
+		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : " = $user_id") : '';
 
-						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
-						if (empty($holding[$this->acl_options[$ary_key][$option_key]]))
-						{
-							$bitstring[$this->acl_options[$ary_key][$option_key]] = 1;
-						}
-					}
-					else
-					{
-						$bitstring[$id] = 0;
-					}
-				}
+		$sql = 'UPDATE ' . CORE_USERS_TABLE . "
+			SET user_permissions = ''
+			$where_sql";
+		$_CLASS['core_db']->query($sql);
 
-				$bitstring = implode('', $bitstring);
+		return;
+	}
 
-				$hold_str .= str_repeat("\n", $f - $last_f);
-
-				for ($i = 0; $i < strlen($bitstring); $i += 31)
-				{
-					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
-				}
-
-				$last_f = $f;
-			}
-			unset($bitstring);
-
-			$userdata['user_permissions'] = rtrim($hold_str);
-
-			$sql = 'UPDATE ' . CORE_USERS_TABLE . "
-				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "'
-				WHERE user_id = " . $userdata['user_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-		unset($hold_ary);
+	/**
+	* Get assigned roles
+	*/
+	function acl_role_data($user_type, $role_type, $ug_id = false, $forum_id = false)
+	{
+		global $_CLASS;
+
+		$roles = array();
+
+		$sql_id = ($user_type == 'user') ? 'user_id' : 'group_id';
+
+		$sql_ug = ($ug_id !== false) ? ((!is_array($ug_id)) ? "AND a.$sql_id = $ug_id" : 'AND ' . $db->sql_in_set("a.$sql_id", $ug_id)) : '';
+		$sql_forum = ($forum_id !== false) ? ((!is_array($forum_id)) ? "AND a.forum_id = $forum_id" : 'AND ' . $db->sql_in_set('a.forum_id', $forum_id)) : '';
+
+		// Grab assigned roles...
+		$sql = 'SELECT a.auth_role_id, a.' . $sql_id . ', a.forum_id
+			FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_ROLES_TABLE . " r
+			WHERE a.auth_role_id = r.role_id
+				AND r.role_type = '" . $_CLASS['core_db']->escape($role_type) . "'
+				$sql_ug
+				$sql_forum
+			ORDER BY r.role_order ASC";
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$roles[$row[$sql_id]][$row['forum_id']] = $row['auth_role_id'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		return $roles;
 	}
 
+	/**
+	* Get raw acl data based on user/option/forum
+	*/
 	function acl_raw_data($user_id = false, $opts = false, $forum_id = false)
 	{
 		global $_CLASS;
 
 		$sql_user = ($user_id) ? (is_array($user_id) ? 'user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
 		$sql_forum = ($forum_id) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
-		$sql_opts = ($opts) ? (is_array($opts) ? ' AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')' : "AND ao.auth_option = '".$_CLASS['core_db']->escape($opts)."'") : '';
+
+		$sql_opts = '';
+
+		if ($opts !== false)
+		{
+			if (!is_array($opts))
+			{
+				$sql_opts = (strpos($opts, '%') !== false) ? "AND ao.auth_option LIKE '" . $_CLASS['core_db']->escape($opts) . "'" : "AND ao.auth_option = '" . $_CLASS['core_db']->escape($opts) . "'";
+			}
+			else
+			{
+				$sql_opts = "AND ao.auth_option IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($opts)) . "')";
+			}
+		}
+
 		$groups = $group_id_array = $group_members = $hold_ary = array();
 
 		if ($sql_user)
@@ -337,29 +555,27 @@
 		return $hold_ary;
 	}
 
-	// Clear one or all users cached permission settings
-	function acl_clear_prefetch($user_id = false)
-	{
-		global $_CLASS;
-
-		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : " = $user_id") : '';
-
-		$sql = 'UPDATE ' . CORE_USERS_TABLE . "
-			SET user_permissions = ''
-			$where_sql";
-		$_CLASS['core_db']->query($sql);
-
-		return;
-	}
-
 	function acl_group_raw_data($group_id = false, $opts = false, $forum_id = false)
 	{
 		global $_CLASS;
 
 		$sql_group = ($group_id) ? ((!is_array($group_id)) ? "group_id = $group_id" : 'group_id IN (' . implode(', ', $group_id) . ')') : '';
 		$sql_forum = ($forum_id) ? ((!is_array($forum_id)) ? "AND a.forum_id = $forum_id" : 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')') : '';
-		$sql_opts = ($opts) ? ((!is_array($opts)) ? "AND ao.auth_option = '$opts'" : 'AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', "\"'\" . \$_CLASS['core_db']->escape('\\1') . \"'\"", $opts)) . ')') : '';
 
+		$sql_opts = '';
+
+		if ($opts !== false)
+		{
+			if (!is_array($opts))
+			{
+				$sql_opts = (strpos($opts, '%') !== false) ? "AND ao.auth_option LIKE '" . $_CLASS['core_db']->escape($opts) . "'" : "AND ao.auth_option = '" . $_CLASS['core_db']->escape($opts) . "'";
+			}
+			else
+			{
+				$sql_opts = "AND ao.auth_option IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($opts)) . "')";
+			}
+		}
+
 		$hold_ary = array();
 
 		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
@@ -381,4 +597,5 @@
 		return $hold_ary;
 	}
 }
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/bbcode.php
===================================================================
--- cms/trunk/includes/forums/bbcode.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/bbcode.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -28,15 +28,20 @@
 class bbcode
 {
 	var $bbcode_uid = '';
-	var $bbcode_bitfield = 0;
+	var $bbcode_bitfield = '';
 	var $bbcode_cache = array();
 	var $bbcode_template = array();
-	
+
 	var $bbcodes = array();
+
 	var $template_bitfield = 0;
 	var $template_filename = '';
 
-	function bbcode($bitfield = 0)
+	/**
+	* Constructor
+	* Init bbcode cache entries if bitfield is specified
+	*/
+	function bbcode($bitfield = '')
 	{
 		if ($bitfield)
 		{
@@ -45,6 +50,9 @@
 		}
 	}
 
+	/**
+	* Second pass bbcodes
+	*/
 	function bbcode_second_pass(&$message, $bbcode_uid = '', $bbcode_bitfield = false)
 	{
 		if ($bbcode_uid)
@@ -55,44 +63,50 @@
 		if ($bbcode_bitfield !== false)
 		{
 			$this->bbcode_bitfield = $bbcode_bitfield;
+
 			// Init those added with a new bbcode_bitfield (already stored codes will not get parsed again)
 			$this->bbcode_cache_init();
 		}
 
 		if (!$this->bbcode_bitfield)
 		{
-			return $message;
+			// Remove the uid from tags that have not been transformed into HTML
+			if ($this->bbcode_uid)
+			{
+				$message = str_replace(':' . $this->bbcode_uid, '', $message);
+			}
+
+			return;
 		}
 
 		$str = array('search' => array(), 'replace' => array());
 		$preg = array('search' => array(), 'replace' => array());
 
-		$bitlen = strlen(decbin($this->bbcode_bitfield));
-		for ($bbcode_id = 0; $bbcode_id < $bitlen; ++$bbcode_id)
+		$bitfield = new bitfield($this->bbcode_bitfield);
+		$bbcodes_set = $bitfield->get_all_set();
+
+		foreach ($bbcodes_set as $bbcode_id)
 		{
-			if ($this->bbcode_bitfield & (1 << $bbcode_id))
+			if (!empty($this->bbcode_cache[$bbcode_id]))
 			{
-				if (!empty($this->bbcode_cache[$bbcode_id]))
+				foreach ($this->bbcode_cache[$bbcode_id] as $type => $array)
 				{
-					foreach ($this->bbcode_cache[$bbcode_id] as $type => $array)
+					foreach ($array as $search => $replace)
 					{
-						foreach ($array as $search => $replace)
-						{
-							${$type}['search'][] = str_replace('$uid', $this->bbcode_uid, $search);
-							${$type}['replace'][] = $replace;
-						}
+						${$type}['search'][] = str_replace('$uid', $this->bbcode_uid, $search);
+						${$type}['replace'][] = $replace;
+					}
 
-						if (sizeof($str['search']))
-						{
-							$message = str_replace($str['search'], $str['replace'], $message);
-							$str = array('search' => array(), 'replace' => array());
-						}
+					if (sizeof($str['search']))
+					{
+						$message = str_replace($str['search'], $str['replace'], $message);
+						$str = array('search' => array(), 'replace' => array());
+					}
 
-						if (sizeof($preg['search']))
-						{
-							$message = preg_replace($preg['search'], $preg['replace'], $message);
-							$preg = array('search' => array(), 'replace' => array());
-						}
+					if (sizeof($preg['search']))
+					{
+						$message = preg_replace($preg['search'], $preg['replace'], $message);
+						$preg = array('search' => array(), 'replace' => array());
 					}
 				}
 			}
@@ -100,34 +114,38 @@
 
 		// Remove the uid from tags that have not been transformed into HTML
 		$message = str_replace(':' . $this->bbcode_uid, '', $message);
-
-		return $message;
 	}
 	
-	//
-	// bbcode_cache_init()
-	//
-	// requires: $this->bbcode_bitfield
-	// sets: $this->bbcode_cache with bbcode templates needed for bbcode_bitfield
-	//
+	/**
+	* Init bbcode cache
+	*
+	* requires: $this->bbcode_bitfield
+	* sets: $this->bbcode_cache with bbcode templates needed for bbcode_bitfield
+	*/
 	function bbcode_cache_init()
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
 		if (empty($this->template_filename))
 		{
 			$style = 'primary';
-			$this->template_bitfield = $_CLASS['core_user']->img['bbcode_bitfield'];
-			$this->template_filename = file_exists($site_file_root.'themes/' . $_CLASS['core_display']->theme . '/template/modules/Forums/bbcode.html') ? $site_file_root.'themes/' . $_CLASS['core_display']->theme . '/template/modules/Forums/bbcode.html' : $site_file_root.'includes/templates/modules/Forums/bbcode.html';
+			$this->template_bitfield = @$_CLASS['core_user']->img['bbcode_bitfield'];
+			$this->template_filename = file_exists(SITE_FILE_ROOT.'themes/' . $_CLASS['core_display']->theme . '/template/modules/forums/bbcode.html') ? SITE_FILE_ROOT.'themes/' . $_CLASS['core_display']->theme . '/template/modules/forums/bbcode.html' : SITE_FILE_ROOT.'includes/templates/modules/forums/bbcode.html';
+		
+			if (!@file_exists($this->template_filename))
+			{
+				trigger_error('The file ' . $this->template_filename . ' is missing.', E_USER_ERROR);
+			}
 		}
 
-		$sql = '';
-		$bbcode_ids = array();
-		$bitlen = strlen(decbin($this->bbcode_bitfield));
+		$bbcode_ids = $rowset = $sql = array();
 
-		for ($bbcode_id = 0; $bbcode_id < $bitlen; ++$bbcode_id)
+		$bitfield = new bitfield($this->bbcode_bitfield);
+		$bbcodes_set = $bitfield->get_all_set();
+
+		foreach ($bbcodes_set as $bbcode_id)
 		{
-			if (isset($this->bbcode_cache[$bbcode_id]) || !($this->bbcode_bitfield & (1 << $bbcode_id)))
+			if (isset($this->bbcode_cache[$bbcode_id]))
 			{
 				// do not try to re-cache it if it's already in
 				continue;
@@ -136,20 +154,17 @@
 
 			if ($bbcode_id > NUM_CORE_BBCODES)
 			{
-				$sql .= (($sql) ? ',' : '') . $bbcode_id;
+				$sql[] = $bbcode_id;
 			}
 		}
 
-//cache this
-		if ($sql)
+		if (!empty($sql))
 		{
-			$rowset = array();
-
 			$sql = 'SELECT *
-				FROM ' . BBCODES_TABLE . "
-				WHERE bbcode_id IN ($sql)";
+				FROM ' . BBCODES_TABLE . '
+				WHERE bbcode_id IN (' . implode(', ', $sql) . ')';
+			$result = $_CLASS['core_db']->query($sql);
 
-			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$rowset[$row['bbcode_id']] = $row;
@@ -164,136 +179,164 @@
 				case 0:
 					$this->bbcode_cache[$bbcode_id] = array(
 						'str' => array(
-							'[/quote:$uid]'	=>	$this->bbcode_tpl('quote_close', $bbcode_id)
+							'[/quote:$uid]'	=> $this->bbcode_tpl('quote_close', $bbcode_id)
 						),
 						'preg' => array(
-							'#\[quote(?:=&quot;(.*?)&quot;)?:$uid\](.)#ise' =>      "\$this->bbcode_second_pass_quote('\$1', '\$2')"
+							'#\[quote(?:=&quot;(.*?)&quot;)?:$uid\](.)#ise'	=> "\$this->bbcode_second_pass_quote('\$1', '\$2')"
 						)
 					);
 				break;
 
 				case 1:
-					$this->bbcode_cache[$bbcode_id] = array('str' => array(
-						'[b:$uid]'	=>	$this->bbcode_tpl('b_open', $bbcode_id),
-						'[/b:$uid]'	=>	$this->bbcode_tpl('b_close', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'str' => array(
+							'[b:$uid]'	=> $this->bbcode_tpl('b_open', $bbcode_id),
+							'[/b:$uid]'	=> $this->bbcode_tpl('b_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 2:
-					$this->bbcode_cache[$bbcode_id] = array('str' => array(
-						'[i:$uid]'	=>	$this->bbcode_tpl('i_open', $bbcode_id),
-						'[/i:$uid]'	=>	$this->bbcode_tpl('i_close', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'str' => array(
+							'[i:$uid]'	=> $this->bbcode_tpl('i_open', $bbcode_id),
+							'[/i:$uid]'	=> $this->bbcode_tpl('i_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 3:
-					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-						'#\[url:$uid\]((.*?))\[/url:$uid\]#s'		=>	$this->bbcode_tpl('url', $bbcode_id),
-						'#\[url=([^\[]+?):$uid\](.*?)\[/url:$uid\]#s'	=>	$this->bbcode_tpl('url', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'preg' => array(
+							'#\[url:$uid\]((.*?))\[/url:$uid\]#s'			=> $this->bbcode_tpl('url', $bbcode_id),
+							'#\[url=([^\[]+?):$uid\](.*?)\[/url:$uid\]#s'	=> $this->bbcode_tpl('url', $bbcode_id),
+						)
+					);
 				break;
 
 				case 4:
-					if ($_CLASS['core_user']->optionget('viewimg'))
+					if ($_CLASS['core_user']->user_data_get('viewimg'))
 					{
-						$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-							'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=>	$this->bbcode_tpl('img', $bbcode_id)
-						));
+						$this->bbcode_cache[$bbcode_id] = array(
+							'preg' => array(
+								'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=> $this->bbcode_tpl('img', $bbcode_id),
+							)
+						);
 					}
 					else
 					{
-						$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-							'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=>	str_replace('$2', '[ img ]', $this->bbcode_tpl('url', $bbcode_id))
-						));
+						$this->bbcode_cache[$bbcode_id] = array(
+							'preg' => array(
+								'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=> str_replace('$2', '[ img ]', $this->bbcode_tpl('url', $bbcode_id)),
+							)
+						);
 					}
 				break;
 
 				case 5:
-					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-						'#\[size=([\-\+]?[1-2]?[0-9]):$uid\](.*?)\[/size:$uid\]#s'	=>	$this->bbcode_tpl('size', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'preg' => array(
+							'#\[size=([\-\+]?[1-2]?[0-9]):$uid\](.*?)\[/size:$uid\]#s'	=> $this->bbcode_tpl('size', $bbcode_id),
+						)
+					);
 				break;
 
 				case 6:
-					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-						'!\[color=(#[0-9A-F]{6}|[a-z\-]+):$uid\](.*?)\[/color:$uid\]!s'	=>	$this->bbcode_tpl('color', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'preg' => array(
+							'!\[color=(#[0-9a-fA-F]{6}|[a-z\-]+):$uid\](.*?)\[/color:$uid\]!s'	=> $this->bbcode_tpl('color', $bbcode_id),
+						)
+					);
 				break;
 
 				case 7:
-					$this->bbcode_cache[$bbcode_id] = array('str' => array(
-						'[u:$uid]'	=>	$this->bbcode_tpl('u_open', $bbcode_id),
-						'[/u:$uid]'	=>	$this->bbcode_tpl('u_close', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'str' => array(
+							'[u:$uid]'	=> $this->bbcode_tpl('u_open', $bbcode_id),
+							'[/u:$uid]'	=> $this->bbcode_tpl('u_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 8:
-					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-						'#\[code(?:=([a-z]+))?:$uid\](.*?)\[/code:$uid\]#ise'	=>	"\$this->bbcode_second_pass_code('\$1', '\$2')"
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'preg' => array(
+							'#\[code(?:=([a-z]+))?:$uid\](.*?)\[/code:$uid\]#ise'	=> "\$this->bbcode_second_pass_code('\$1', '\$2')",
+						)
+					);
 				break;
 
 				case 9:
 					$this->bbcode_cache[$bbcode_id] = array(
 						'preg' => array(
 							'#(\[\/?(list|\*):[mou]?:?$uid\])[\n]{1}#'	=> "\$1",
-							'#(\[list=([^\[]+):$uid\])[\n]{1}#'	=> "\$1",
-							'#\[list=([^\[]+):$uid\]#e'	=>	"\$this->bbcode_list('\$1')",
+							'#(\[list=([^\[]+):$uid\])[\n]{1}#'			=> "\$1",
+							'#\[list=([^\[]+):$uid\]#e'					=> "\$this->bbcode_list('\$1')",
 						),
 						'str' => array(
-							'[list:$uid]'		=>	$this->bbcode_tpl('ulist_open_default', $bbcode_id),
-							'[/list:u:$uid]'	=>	$this->bbcode_tpl('ulist_close', $bbcode_id),
-							'[/list:o:$uid]'	=>	$this->bbcode_tpl('olist_close', $bbcode_id),
-							'[*:$uid]'			=>	$this->bbcode_tpl('listitem', $bbcode_id),
-							'[/*:$uid]'			=>	$this->bbcode_tpl('listitem_close', $bbcode_id),
-							'[/*:m:$uid]'		=>	$this->bbcode_tpl('listitem_close', $bbcode_id)
+							'[list:$uid]'		=> $this->bbcode_tpl('ulist_open_default', $bbcode_id),
+							'[/list:u:$uid]'	=> $this->bbcode_tpl('ulist_close', $bbcode_id),
+							'[/list:o:$uid]'	=> $this->bbcode_tpl('olist_close', $bbcode_id),
+							'[*:$uid]'			=> $this->bbcode_tpl('listitem', $bbcode_id),
+							'[/*:$uid]'			=> $this->bbcode_tpl('listitem_close', $bbcode_id),
+							'[/*:m:$uid]'		=> $this->bbcode_tpl('listitem_close', $bbcode_id)
 						),
 					);
 				break;
 
 				case 10:
-					$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-							'#\[email:$uid\]((.*?))\[/email:$uid\]#is'				=>	$this->bbcode_tpl('email', $bbcode_id),
-							'#\[email=([^\[]+):$uid\](.*?)\[/email:$uid\]#is'	=>	$this->bbcode_tpl('email', $bbcode_id)
-					));
+					$this->bbcode_cache[$bbcode_id] = array(
+						'preg' => array(
+							'#\[email:$uid\]((.*?))\[/email:$uid\]#is'			=> $this->bbcode_tpl('email', $bbcode_id),
+							'#\[email=([^\[]+):$uid\](.*?)\[/email:$uid\]#is'	=> $this->bbcode_tpl('email', $bbcode_id)
+						)
+					);
 				break;
 
 				case 11:
-					if ($_CLASS['core_user']->optionget('viewflash'))
+					if ($_CLASS['core_user']->user_data_get('viewflash'))
 					{
-						$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-							'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=>	$this->bbcode_tpl('flash', $bbcode_id)
-						));
+						$this->bbcode_cache[$bbcode_id] = array(
+							'preg' => array(
+								'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=> $this->bbcode_tpl('flash', $bbcode_id),
+							)
+						);
 					}
 					else
 					{
-						$this->bbcode_cache[$bbcode_id] = array('preg' => array(
-							'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=>	str_replace('$1', '$3', str_replace('$2', '[ flash ]', $this->bbcode_tpl('url', $bbcode_id)))
-						));
+						$this->bbcode_cache[$bbcode_id] = array(
+							'preg' => array(
+								'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=> str_replace('$1', '$3', str_replace('$2', '[ flash ]', $this->bbcode_tpl('url', $bbcode_id)))
+							)
+						);
 					}
 				break;
 
 				case 12:
 					$this->bbcode_cache[$bbcode_id] = array(
 						'str'	=> array(
-							'[/attachment:$uid]'	=> $this->bbcode_tpl('inline_attachment_close', $bbcode_id)),
+							'[/attachment:$uid]'	=> $this->bbcode_tpl('inline_attachment_close', $bbcode_id)
+						),
 						'preg'	=> array(
-							'#\[attachment=([0-9]+):$uid\]#'	=> $this->bbcode_tpl('inline_attachment_open', $bbcode_id))
+							'#\[attachment=([0-9]+):$uid\]#'	=> $this->bbcode_tpl('inline_attachment_open', $bbcode_id)
+						)
 					);
 				break;
 
 				default:
+					if (!isset($template_bitfield))
+					{
+						$template_bitfield = new bitfield($this->template_bitfield);
+					}
+
 					if (isset($rowset[$bbcode_id]))
 					{
-						if ($this->template_bitfield & (1 << $bbcode_id))
+						if ($template_bitfield->get($bbcode_id))
 						{
 							// The bbcode requires a custom template to be loaded
-
 							if (!$bbcode_tpl = $this->bbcode_tpl($rowset[$bbcode_id]['bbcode_tag'], $bbcode_id))
 							{
-								// For some reason, the required template seems not to be available,
-								// use the default template
-
+								// For some reason, the required template seems not to be available, use the default template
 								$bbcode_tpl = (!empty($rowset[$bbcode_id]['second_pass_replace'])) ? $rowset[$bbcode_id]['second_pass_replace'] : $rowset[$bbcode_id]['bbcode_tpl'];
 							}
 							else
@@ -301,7 +344,6 @@
 								// In order to use templates with custom bbcodes we need
 								// to replace all {VARS} to corresponding backreferences
 								// Note that backreferences are numbered from bbcode_match
-
 								if (preg_match_all('/\{(URL|EMAIL|TEXT|COLOR|NUMBER)[0-9]*\}/', $rowset[$bbcode_id]['bbcode_match'], $m))
 								{
 									foreach ($m[0] as $i => $tok)
@@ -314,17 +356,15 @@
 						else
 						{
 							// Default template
-
 							$bbcode_tpl = (!empty($rowset[$bbcode_id]['second_pass_replace'])) ? $rowset[$bbcode_id]['second_pass_replace'] : $rowset[$bbcode_id]['bbcode_tpl'];
 						}
 
 						// Replace {L_*} lang strings
-						$bbcode_tpl = preg_replace('/{L_([A-Z_]+)}/e', "(!empty(\$_CLASS['core_user']->lang['\$1'])) ? \$_CLASS['core_user']->lang['\$1'] : ucwords(strtolower(str_replace'_', ' ', '\$1')))", $bbcode_tpl);
+						$bbcode_tpl = preg_replace('/{L_([A-Z_]+)}/e', "\$_CLASS['core_user']->get_lang('\$1')", $bbcode_tpl);
 
 						if (!empty($rowset[$bbcode_id]['second_pass_replace']))
 						{
 							// The custom BBCode requires second-pass pattern replacements
-
 							$this->bbcode_cache[$bbcode_id] = array(
 								'preg' => array($rowset[$bbcode_id]['second_pass_match'] => $bbcode_tpl)
 							);
@@ -338,43 +378,47 @@
 					}
 					else
 					{
-						$this->bbcode_cache[$bbcode_id] = FALSE;
+						$this->bbcode_cache[$bbcode_id] = false;
 					}
+				break;
 			}
 		}
 	}
 
 	function bbcode_tpl($tpl_name, $bbcode_id = -1)
 	{
+		global $_CLASS;
+
 		if (empty($bbcode_hardtpl))
 		{
-			static $bbcode_hardtpl = array(
-				'b_open'	=>	'<span style="font-weight: bold">',
-				'b_close'	=>	'</span>',
-				'i_open'	=>	'<span style="font-style: italic">',
-				'i_close'	=>	'</span>',
-				'u_open'	=>	'<span style="text-decoration: underline">',
-				'u_close'	=>	'</span>',
-				'img'		=>	'<img src="$1" border="0" />',
-				'size'		=>	'<span style="font-size: $1px; line-height: normal">$2</span>',
-				'color'		=>	'<span style="color: $1">$2</span>',
-				'email'		=>	'<a href="mailto:$1">$2</a>'
+			static $bbcode_hardtpl = array();
+
+			$bbcode_hardtpl = array(
+				'b_open'	=> '<span style="font-weight: bold">',
+				'b_close'	=> '</span>',
+				'i_open'	=> '<span style="font-style: italic">',
+				'i_close'	=> '</span>',
+				'u_open'	=> '<span style="text-decoration: underline">',
+				'u_close'	=> '</span>',
+				'img'		=> '<img src="$1" alt="' . $_CLASS['core_user']->get_lang('IMAGE') . '" />',
+				'size'		=> '<span style="font-size: $1px; line-height: normal">$2</span>',
+				'color'		=> '<span style="color: $1">$2</span>',
+				'email'		=> '<a href="mailto:$1">$2</a>'
 			);
+			$template_bitfield = new bitfield($this->template_bitfield);
 		}
 
-		if ($bbcode_id != -1 && !($this->template_bitfield & (1 << $bbcode_id)))
+		if ($bbcode_id != -1 && !$template_bitfield->get($bbcode_id))
 		{
 			return (isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : FALSE;
 		}
 
 		if (empty($this->bbcode_template))
 		{
-			if (!($fp = @fopen($this->template_filename, 'rb')))
+			if (($tpl = file_get_contents($this->template_filename)) === false)
 			{
-				trigger_error('Could not load bbcode template');
+				trigger_error('Could not load bbcode template', E_USER_ERROR);
 			}
-			$tpl = fread($fp, filesize($this->template_filename));
-			@fclose($fp);
 
 			// replace \ with \\ and then ' with \'.
 			$tpl = str_replace('\\', '\\\\', $tpl);
@@ -384,30 +428,42 @@
 			$tpl = preg_replace("/\n[\n\r\s\t]*/", '', $tpl);
 
 			// Turn template blocks into PHP assignment statements for the values of $bbcode_tpl..
-			$tpl = preg_replace('#<!-- BEGIN (.*?) -->(.*?)<!-- END (.*?) -->#', "\n" . "\$this->bbcode_template['\$1'] = \$this->bbcode_tpl_replace('\$1','\$2');", $tpl);
+			$this->bbcode_template = array();
 
-			$this->bbcode_template = array();
-			eval($tpl);
+			$matches = preg_match_all('#<!-- BEGIN (.*?) -->(.*?)<!-- END (?:.*?) -->#', $tpl, $match);
+
+			for ($i = 0; $i < $matches; $i++)
+			{
+				if (empty($match[1][$i]))
+				{
+					continue;
+				}
+
+				$this->bbcode_template[$match[1][$i]] = $this->bbcode_tpl_replace($match[1][$i], $match[2][$i]);
+			}
 		}
 
-		return (isset($this->bbcode_template[$tpl_name])) ? $this->bbcode_template[$tpl_name] : ((isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : FALSE);
+		return (isset($this->bbcode_template[$tpl_name])) ? $this->bbcode_template[$tpl_name] : ((isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : false);
 	}
-	
+
+	/**
+	* Return bbcode template replacement
+	*/
 	function bbcode_tpl_replace($tpl_name, $tpl)
 	{
 		global $_CLASS;
 		
 		static $replacements = array(
-			'quote_username_open'	=>	array('{USERNAME}'	=>	'$1'),
-			'color'					=>	array('{COLOR}'		=>	'$1', '{TEXT}'			=>	'$2'),
-			'size'					=>	array('{SIZE}'		=>	'$1', '{TEXT}'			=>	'$2'),
-			'img'					=>	array('{URL}'		=>	'$1'),
-			'flash'					=>	array('{WIDTH}'		=>	'$1', '{HEIGHT}'		=>	'$2', '{URL}'	=>	'$3'),
-			'url'					=>	array('{URL}'		=>	'$1', '{DESCRIPTION}'	=>	'$2'),
-			'email'					=>	array('{EMAIL}'		=>	'$1', '{DESCRIPTION}'	=>	'$2')
+			'quote_username_open'	=> array('{USERNAME}'	=> '$1'),
+			'color'					=> array('{COLOR}'		=> '$1', '{TEXT}'			=> '$2'),
+			'size'					=> array('{SIZE}'		=> '$1', '{TEXT}'			=> '$2'),
+			'img'					=> array('{URL}'		=> '$1'),
+			'flash'					=> array('{WIDTH}'		=> '$1', '{HEIGHT}'			=> '$2', '{URL}'	=> '$3'),
+			'url'					=> array('{URL}'		=> '$1', '{DESCRIPTION}'	=> '$2'),
+			'email'					=> array('{EMAIL}'		=> '$1', '{DESCRIPTION}'	=> '$2')
 		);
 
-		$tpl = preg_replace('/{L_([A-Z_]+)}/e', "(!empty(\$_CLASS['core_user']->lang['\$1'])) ? \$_CLASS['core_user']->lang['\$1'] : ucwords(strtolower(str_replace('_', ' ', '\$1')))", $tpl);
+		$tpl = preg_replace('/{L_([A-Z_]+)}/e', "\$_CLASS['core_user']->get_lang('\$1')", $tpl);
 
 		if (!empty($replacements[$tpl_name]))
 		{
@@ -416,7 +472,10 @@
 
 		return trim($tpl);
 	}
-	
+
+	/**
+	* Second parse list bbcode
+	*/
 	function bbcode_list($type)
 	{
 		if ($type == '')
@@ -471,11 +530,15 @@
 		return str_replace('{LIST_TYPE}', $type, $this->bbcode_tpl($tpl));
 	}
 
+	/**
+	* Second parse quote tag
+	*/
 	function bbcode_second_pass_quote($username, $quote)
 	{
 		// when using the /e modifier, preg_replace slashes double-quotes but does not
 		// seem to slash anything else
 		$quote = str_replace('\"', '"', $quote);
+		$username = str_replace('\"', '"', $username);
 
 		// remove newline at the beginning
 		if ($quote{0} == "\n")
@@ -487,7 +550,10 @@
 
 		return $quote;
 	}
-	
+
+	/**
+	* Second parse code tag
+	*/
 	function bbcode_second_pass_code($type, $code)
 	{
 		// when using the /e modifier, preg_replace slashes double-quotes but does not
@@ -503,16 +569,19 @@
 					$code = substr($code, 41);
 				}
 
+			// no break;
+
 			default:
 				$code = str_replace("\t", '&nbsp; &nbsp;', $code);
 				$code = str_replace('  ', '&nbsp; ', $code);
 				$code = str_replace('  ', ' &nbsp;', $code);
 
 				// remove newline at the beginning
-				if ($code{0} == "\n")
+				if (!empty($code) && $code{0} == "\n")
 				{
 					$code = substr($code, 1);
 				}
+			break;
 		}
 
 		$code = $this->bbcode_tpl('code_open') . $code . $this->bbcode_tpl('code_close');

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -543,7 +543,7 @@
 					'notify_type' => 0
 				);
 
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' '.$_CLASS['core_db']->sql_build_array('INSERT', $sql_array));
+				$_CLASS['core_db']->sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
 			}
 
 			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
@@ -660,17 +660,20 @@
 
 				if ($sql_insert = array_diff($forum_id, $update_array))
 				{
+					$sql_array = array();
+
 					foreach ($sql_insert as $forum_id)
 					{
-						$sql_ary = array(
+						$sql_array[] = array(
 							'user_id'		=> $_CLASS['core_user']->data['user_id'],
 							'topic_id'		=> 0,
 							'forum_id'		=> $forum_id,
 							'mark_time'		=> $time
 						);
-
-						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
 					}
+	
+					$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_array, FORUMS_TRACK_TABLE);
+					unset($sql_array);
 				}
 			}
 			else
@@ -708,14 +711,15 @@
 
 				if (!$_CLASS['core_db']->query($sql) || !$_CLASS['core_db']->affected_rows())
 				{
-					$sql_ary = array(
+					$sql_array = array(
 						'user_id'		=> $_CLASS['core_user']->data['user_id'],
 						'topic_id'		=> $topic_id,
 						'forum_id'		=> $forum_id,
 						'mark_time'		=> $time
 					);
 
-					$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $sql_ary));
+					$_CLASS['core_db']->sql_query_build('INSERT', $sql_array, FORUMS_TRACK_TABLE);
+					unset($sql_array);
 				}
 			}
 			else
@@ -1327,4 +1331,217 @@
 	));
 }
 
+// Logging functions
+function add_log()
+{
+	global $_CLASS;
+
+	$args = func_get_args();
+
+	$mode			= array_shift($args);
+	$reportee_id	= ($mode === 'user') ? (int) array_shift($args) : '';
+	$forum_id		= ($mode === 'mod') ? (int) array_shift($args) : '';
+	$topic_id		= ($mode === 'mod') ? (int) array_shift($args) : '';
+	$action			= array_shift($args);
+	$data			= empty($args) ? '' : serialize($args);
+
+	$sql_array = array(
+		'user_id'		=> empty($_CLASS['core_user']->data['user_id']) ? ANONYMOUS : $_CLASS['core_user']->data['user_id'],
+		'log_ip'		=> $_CLASS['core_user']->ip,
+		'log_time'		=> $_CLASS['core_user']->time,
+		'log_operation'	=> $action,
+		'log_data'		=> $data,
+	);
+
+	switch ($mode)
+	{
+		case 'admin':
+			$sql_array['log_type'] = LOG_ADMIN;
+		break;
+		
+		case 'mod':
+			$sql_array += array(
+				'log_type'	=> LOG_MOD,
+				'forum_id'	=> $forum_id,
+				'topic_id'	=> $topic_id
+			);
+		break;
+
+		case 'user':
+			$sql_array += array(
+				'log_type'		=> LOG_USERS,
+				'reportee_id'	=> $reportee_id
+			);
+		break;
+
+		case 'critical':
+			$sql_array['log_type'] = LOG_CRITICAL;
+		break;
+		
+		default:
+			return false;
+		break;
+	}
+
+	$_CLASS['core_db']->sql_query_build('INSERT', $sql_array, FORUMS_LOG_TABLE);
+
+	return $_CLASS['core_db']->insert_id(FORUMS_LOG_TABLE, 'log_id');
+}
+
+/**
+*/
+class bitfield
+{
+	var $data;
+
+	function bitfield($bitfield = '')
+	{
+		$this->data = base64_decode($bitfield);
+	}
+
+	/**
+	*/
+	function get($n)
+	{
+		// Get the ($n / 8)th char
+		$byte = $n >> 3;
+
+		if (!isset($this->data[$byte]))
+		{
+			// Of course, if it doesn't exist then the result if FALSE
+			return false;
+		}
+
+		$c = $this->data[$byte];
+
+		// Lookup the ($n % 8)th bit of the byte
+		$bit = 7 - ($n & 7);
+		return (bool) (ord($c) & (1 << $bit));
+	}
+
+	function set($n)
+	{
+		$byte = $n >> 3;
+		$bit = 7 - ($n & 7);
+
+		if (isset($this->data[$byte]))
+		{
+			$this->data[$byte] = $this->data[$byte] | chr(1 << $bit);
+		}
+		else
+		{
+			if ($byte - strlen($this->data) > 0)
+			{
+				$this->data .= str_repeat("\0", $byte - strlen($this->data));
+			}
+			$this->data .= chr(1 << $bit);
+		}
+	}
+
+	function clear($n)
+	{
+		$byte = $n >> 3;
+
+		if (!isset($this->data[$byte]))
+		{
+			return;
+		}
+
+		$bit = 7 - ($n & 7);
+		$this->data[$byte] = $this->data[$byte] &~ chr(1 << $bit);
+	}
+
+	function get_blob()
+	{
+		return $this->data;
+	}
+
+	function get_base64()
+	{
+		return base64_encode($this->data);
+	}
+
+	function get_bin()
+	{
+		$bin = '';
+		$len = strlen($this->data);
+
+		for ($i = 0; $i < $len; ++$i)
+		{
+			$bin .= str_pad(decbin(ord($this->data[$i])), 8, '0', STR_PAD_LEFT);
+		}
+
+		return $bin;
+	}
+
+	function get_all_set()
+	{
+		return array_keys(array_filter(str_split($this->get_bin())));
+	}
+
+	function merge($bitfield)
+	{
+		$this->data = $this->data | $bitfield->get_blob();
+	}
+}
+
+/**
+* This function returns a regular expression pattern for commonly used expressions
+* Use with / as delimiter
+* mode can be: email|
+*/
+function get_preg_expression($mode)
+{
+	switch ($mode)
+	{
+		case 'email':
+			return '[a-z0-9&\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*?[a-z]+';
+		break;
+	}
+
+	return '';
+}
+
+/**
+* make_clickable function
+*
+* Replace magic urls of form http://xxx.xxx., www.xxx. and xxx at xxx.xxx.
+* Cuts down displayed size of link if over 50 chars, turns absolute links
+* into relative versions when the server/script path matches the link
+*/
+function make_clickable($text, $server_url = false)
+{
+	if ($server_url === false)
+	{
+		$server_url = generate_board_url();
+	}
+
+	static $magic_url_match;
+	static $magic_url_replace;
+
+	if (!is_array($magic_url_match))
+	{
+		$magic_url_match = $magic_url_replace = array();
+		// Be sure to not let the matches cross over. ;)
+
+		// relative urls for this board
+		$magic_url_match[] = '#(^|[\n ]|\()(' . preg_quote($server_url, '#') . ')/(([^[ \t\n\r<"\'\)&]+|&(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = "'\$1<!-- l --><a href=\"\$2/' . preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\\1', '\$3') . '\">' . preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\\1', '\$3') . '</a><!-- l -->'";
+
+		// matches a xxxx://aaaaa.bbb.cccc. ...
+		$magic_url_match[] = '#(^|[\n ]|\()([\w]+:/{2}.*?([^[ \t\n\r<"\'\)&]+|&(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = "'\$1<!-- m --><a href=\"\$2\" target=\"_blank\">' . ((strlen('\$2') > 55) ? substr(str_replace('&amp;', '&', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&', '\$2'), -10) : '\$2') . '</a><!-- m -->'";
+
+		// matches a "www.xxxx.yyyy[/zzzz]" kinda lazy URL thing
+		$magic_url_match[] = '#(^|[\n ]|\()(w{3}\.[\w\-]+\.[\w\-.\~]+(?:[^[ \t\n\r<"\'\)&]+|&(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = "'\$1<!-- w --><a href=\"http://\$2\" target=\"_blank\">' . ((strlen('\$2') > 55) ? substr(str_replace('&amp;', '&', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&', '\$2'), -10) : '\$2') . '</a><!-- w -->'";
+
+		// matches an email at domain type address at the start of a line, or after a space or after what might be a BBCode.
+		$magic_url_match[] = '/(^|[\n ]|\()(' . get_preg_expression('email') . ')/ie';
+		$magic_url_replace[] = "'\$1<!-- e --><a href=\"mailto:\$2\">' . ((strlen('\$2') > 55) ? substr('\$2', 0, 39) . ' ... ' . substr('\$2', -10) : '\$2') . '</a><!-- e -->'";
+	}
+
+	return preg_replace($magic_url_match, $magic_url_replace, $text);
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_admin.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -59,7 +59,7 @@
 
 		$right = $row['right_id'];
 
-		if ($acl && !$_CLASS['auth']->acl_gets($acl, $row['forum_id']))
+		if ($acl && !$_CLASS['forums_auth']->acl_gets($acl, $row['forum_id']))
 		{
 			continue;
 		}
@@ -91,6 +91,8 @@
 			$forum_list .= '<option value="' . $row['forum_id'] . '"' . $selected . '>' . $padding . $row['forum_name'] . '</option>';
 		}
 	}
+	$_CLASS['core_db']->free_result();
+
 	unset($padding_store);
 
 	return $forum_list;
@@ -149,7 +151,7 @@
 			continue;
 		}
 
-		if (!$acl_list || $_CLASS['auth']->acl_gets($acl_list, $row['forum_id']))
+		if (!$acl_list || $_CLASS['forums_auth']->acl_gets($acl_list, $row['forum_id']))
 		{
 			$rowset[] = ($id_only) ? $row['forum_id'] : $row;
 		}
@@ -158,7 +160,7 @@
 	return $rowset;
 }
 
-function get_forum_branch($forum_id, $type = 'all', $order = 'descending', $include_forum = TRUE)
+function get_forum_branch($forum_id, $type = 'all', $order = 'descending', $include_forum = true)
 {
 	global $_CLASS;
 
@@ -204,15 +206,20 @@
 	$matches = array();
 
 	// Remove initial / if present
-	$rootdir = (substr($rootdir, 0, 1) == '/') ? substr($rootdir, 1) : $rootdir;
+	$rootdir = (substr($rootdir, 0, 1) === '/') ? substr($rootdir, 1) : $rootdir;
 	// Add closing / if present
-	$rootdir = ($rootdir && substr($rootdir, -1) != '/') ? $rootdir . '/' : $rootdir;
+	$rootdir = ($rootdir && substr($rootdir, -1) !== '/') ? $rootdir . '/' : $rootdir;
 
 	// Remove initial / if present
-	$dir = (substr($dir, 0, 1) == '/') ? substr($dir, 1) : $dir;
+	$dir = (substr($dir, 0, 1) === '/') ? substr($dir, 1) : $dir;
 	// Add closing / if present
-	$dir = ($dir && substr($dir, -1) != '/') ? $dir . '/' : $dir;
+	$dir = ($dir && substr($dir, -1) !== '/') ? $dir . '/' : $dir;
 
+	if (!is_dir($rootdir . $dir))
+	{
+		return false;
+	}
+
 	$dh = opendir($rootdir . $dir);
 	while (($fname = readdir($dh)) !== false)
 	{
@@ -223,7 +230,7 @@
 				$matches[$dir][] = $fname;
 			}
 		}
-		else if ($fname{0} != '.' && is_dir("$rootdir$dir$fname"))
+		else if ($fname{0} !== '.' && is_dir("$rootdir$dir$fname"))
 		{
 			$matches += filelist($rootdir, "$dir$fname", $type);
 		}
@@ -238,6 +245,13 @@
 {
 	global $_CLASS;
 
+	if (empty($topic_ids))
+	{
+		return;
+	}
+
+	$_CLASS['core_db']->transaction();
+
 	$forum_ids = array($forum_id);
 	$sql_where = is_array($topic_ids) ? 'IN (' . implode(', ', $topic_ids) . ')' : '= ' . $topic_ids;
 
@@ -260,11 +274,8 @@
 		$_CLASS['core_db']->free_result($result);
 	}
 
-	$_CLASS['core_db']->transaction();
+	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE, FORUMS_DRAFTS_TABLE);
 
-	//$table_ary = array(FORUMS_FORUMS_TABLE, FORUMS_POLL_OPTIONS_TABLE, , FORUMS_TOPICS_TABLE);
-	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE);
-
 	foreach ($table_ary as $table)
 	{
 		$sql = "UPDATE $table
@@ -280,6 +291,7 @@
 	{
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
+	unset($forum_ids);
 }
 
 function move_posts($post_ids, $topic_id, $auto_sync = true)
@@ -291,37 +303,38 @@
 		$post_ids = array($post_ids);
 	}
 
-	if ($auto_sync)
-	{
-		$forum_ids = array();
-		$topic_ids = array($topic_id);
-
-		$sql = 'SELECT DISTINCT topic_id, forum_id
-			FROM ' . FORUMS_POSTS_TABLE . '
-			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$forum_ids[] = $row['forum_id'];
-			$topic_ids[] = $row['topic_id'];
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-
 	$sql = 'SELECT forum_id 
 		FROM ' . FORUMS_TOPICS_TABLE . ' 
 		WHERE topic_id = ' . $topic_id;
 	$result = $_CLASS['core_db']->query($sql);
+	$forum_row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
-	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if (!$forum_row)
 	{
 		trigger_error('NO_TOPIC');
 	}
+
+	$forum_ids = array($forum_row['forum_id']);
+	$topic_ids = array($topic_id);
+
+	$sql = 'SELECT DISTINCT topic_id, forum_id
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE post_id IN (' . implode(', ', $post_ids) . ')';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$forum_ids[] = $row['forum_id'];
+		$topic_ids[] = $row['topic_id'];
+	}
 	$_CLASS['core_db']->free_result($result);
 
+	$forum_ids = array_unique($forum_ids);
+	$topic_ids = array_unique($topic_ids);
+
 	$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-		SET forum_id = ' . $row['forum_id'] . ", topic_id = $topic_id
+		SET forum_id = ' . $forum_row['forum_id'] . ", topic_id = $topic_id
 		WHERE post_id IN (" . implode(', ', $post_ids) . ')';
 	$_CLASS['core_db']->query($sql);
 
@@ -332,17 +345,21 @@
 
 	if ($auto_sync)
 	{
-		$forum_ids[] = $row['forum_id'];
-
 		sync('reported', 'topic_id', $topic_ids);
 		sync('topic', 'topic_id', $topic_ids, true);
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
+
+	// Update posted informations
+	update_posted_info($topic_ids);
 }
 
+/**
+* Remove topic(s)
+*/
 function delete_topics($where_type, $where_ids, $auto_sync = true)
 {
-	global $_CLASS;
+	global $_CLASS, $config;
 
 	$forum_ids = $topic_ids = array();
 
@@ -357,7 +374,7 @@
 	}
 
 	$return = array(
-		'posts'	=>	delete_posts($where_type, $where_ids, false)
+		'posts'	=>	delete_posts($where_type, $where_ids, false, true)
 	);
 
 	$sql = 'SELECT topic_id, forum_id
@@ -379,8 +396,6 @@
 		return $return;
 	}
 
-	// TODO: probably some other stuff too
-
 	$sql_where = ' IN (' . implode(', ', $topic_ids) . ')';
 
 	$_CLASS['core_db']->transaction();
@@ -407,6 +422,8 @@
 		sync('topic_reported', $where_type, $where_ids);
 	}
 
+	set_config('num_topics', $config['num_topics'] - count($return['topics']), true);
+
 	return $return;
 }
 
@@ -424,9 +441,9 @@
 		return false;
 	}
 
-	$post_ids = $topic_ids = $forum_ids = array();
+	$post_ids = $topic_ids = $forum_ids = $post_counts = array();
 
-	$sql = 'SELECT post_id, topic_id, forum_id
+	$sql = 'SELECT post_id, poster_id, post_postcount, topic_id, forum_id
 		FROM ' . FORUMS_POSTS_TABLE . "
 		WHERE $where_type " . ((!is_array($where_ids)) ? "= $where_ids" : 'IN (' . implode(', ', $where_ids) . ')');
 	$result = $_CLASS['core_db']->query($sql);
@@ -434,9 +451,16 @@
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$post_ids[] = $row['post_id'];
+		$poster_ids[] = $row['poster_id'];
 		$topic_ids[] = $row['topic_id'];
 		$forum_ids[] = $row['forum_id'];
+		
+		if ($row['post_postcount'])
+		{
+			$post_counts[$row['poster_id']] = (!empty($post_counts[$row['poster_id']])) ? $post_counts[$row['poster_id']] + 1 : 1;
+		}
 	}
+	$_CLASS['core_db']->free_result();
 
 	if (empty($post_ids))
 	{
@@ -447,9 +471,8 @@
 
 	$_CLASS['core_db']->transaction();
 
-	//$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
-	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
-	
+	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE);
+
 	foreach ($table_ary as $table)
 	{
 		$sql = "DELETE FROM $table 
@@ -458,17 +481,57 @@
 	}
 	unset($table_ary);
 
+	// Adjust users post counts
+	if (!empty($post_counts))
+	{
+		foreach ($post_counts as $poster_id => $substract)
+		{
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . '
+				SET user_posts = user_posts - ' . $substract . '
+				WHERE user_id = ' . $poster_id;
+			$_CLASS['core_db']->query($sql);
+		}
+	}
+
+	// Remove the message from the search index
+	$search_type = basename($config['search_type']);
+
+	if (!file_exists(SITE_FILE_ROOT.'includes/forums/search/', $search_type,'.php'))
+	{
+		trigger_error('NO_SUCH_SEARCH_MODULE');
+	}
+
+	require_once SITE_FILE_ROOT.'includes/forums/search/'.$search_type.'.php';
+
+	$error = false;
+	$search = new $search_type($error);
+
+	if ($error)
+	{
+		trigger_error($error);
+	}
+
+	$search->index_remove($post_ids, $poster_ids, $forum_ids);
+
 	delete_attachments('post', $post_ids, false);
 
 	$_CLASS['core_db']->transaction('commit');
 
+	// Resync topics_posted table
+	if ($posted_sync)
+	{
+		update_posted_info($topic_ids);
+	}
+
 	if ($auto_sync)
 	{
-		sync('reported', 'topic_id', $topic_ids);
+		sync('topic_reported', $where_type, $where_ids);
 		sync('topic', 'topic_id', $topic_ids, true);
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
 
+	set_config('num_posts', $config['num_posts'] - sizeof($post_ids), true);
+
 	return count($post_ids);
 }
 
@@ -476,26 +539,30 @@
 // mode => (post, topic, attach, user)
 // ids => (post_ids, topic_ids, attach_ids, user_ids)
 // resync => set this to false if you are deleting posts or topics...
-function delete_attachments($mode, $ids, $resync = TRUE)
+function delete_attachments($mode, $ids, $resync = true)
 {
 	global $_CLASS, $config;
 
 	if (is_array($ids))
 	{
-		$ids = array_unique($ids);
+		$ids = array_unique(array_map('intval', $ids));
 	}
-	
+	else
+	{
+		$ids = array((int) $ids);
+	}
+
 	if (empty($ids))
 	{
 		return false;
 	}
-
+
 	$sql_id = ($mode == 'user') ? 'poster_id' : (($mode == 'post') ? 'post_msg_id' : (($mode == 'topic') ? 'topic_id' : 'attach_id'));
 
 	$post_ids = $topic_ids = $physical = array();
 
 	// Collect post and topics ids for later use
-	if ($mode == 'attach' || $mode == 'user' || ($mode == 'topic' && $resync))
+	if ($mode === 'attach' || $mode === 'user' || ($mode === 'topic' && $resync))
 	{
 		$sql = 'SELECT post_msg_id as post_id, topic_id, physical_filename, thumbnail, filesize
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -511,7 +578,7 @@
 		$_CLASS['core_db']->free_result($result);
 	}
 
-	if ($mode == 'post')
+	if ($mode === 'post')
 	{
 		$sql = 'SELECT topic_id, physical_filename, thumbnail, filesize
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -528,7 +595,8 @@
 	}
 
 	// Delete attachments
-	$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
+	$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' 
+			WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
 	$num_deleted = $_CLASS['core_db']->affected_rows();
 
 	if (!$num_deleted)
@@ -572,14 +640,14 @@
 	// Update post indicators
 	if (!empty($post_ids))
 	{
-		if ($mode == 'post' || $mode == 'topic')
+		if ($mode === 'post' || $mode === 'topic')
 		{
 			$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')');
 		}
 
-		if ($mode == 'user' || $mode == 'attach')
+		if ($mode === 'user' || $mode === 'attach')
 		{
 			$remaining = array();
 
@@ -596,6 +664,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
+	
 			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']->query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
@@ -630,14 +699,14 @@
 	if (!empty($topic_ids))
 	{
 		// Update topic indicator
-		if ($mode == 'topic')
+		if ($mode === 'topic')
 		{
 			$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . '
 				SET topic_attachment = 0
 				WHERE topic_id IN (' . implode(', ', $topic_ids) . ')');
 		}
 
-		if ($mode == 'post' || $mode == 'user' || $mode == 'attach')
+		if ($mode === 'post' || $mode === 'user' || $mode === 'attach')
 		{
 			$remaining = array();
 
@@ -653,6 +722,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			$unset_ids = array_diff($topic_ids, $remaining);
+
 			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']->query('UPDATE ' . FORUMS_TOPICS_TABLE . ' 
@@ -666,8 +736,10 @@
 }
 
 
-// FIX
-function delete_topic_shadows($max_age, $forum_id = '', $auto_sync = TRUE)
+/**
+* Remove topic shadows
+*/
+function delete_topic_shadows($max_age, $forum_id = '', $auto_sync = true)
 {
 	global $_CLASS;
 
@@ -680,7 +752,7 @@
 			$sql = 'DELETE t.*
 				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time < ' . (gmtime() - $max_age)
+					AND t.topic_time < ' . ($_CLASS['core_user']->time - $max_age)
 				. $where;
 			$_CLASS['core_db']->query($sql);
 		break;
@@ -689,7 +761,7 @@
 			$sql = 'SELECT t.topic_id
 				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time < ' . (gmtime() - $max_age)
+					AND t.topic_time < ' . ($_CLASS['core_user']->time - $max_age)
 				. $where;
 			$result = $_CLASS['core_db']->query($sql);
 			
@@ -705,15 +777,86 @@
 					WHERE topic_id IN (' . implode(',', $topic_ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
+		break;
 	}
 
 	if ($auto_sync)
 	{
 		$where_type = ($forum_id) ? 'forum_id' : '';
-		sync('forum', $where_type, $forum_id, TRUE);
+		sync('forum', $where_type, $forum_id, true);
 	}
 }
 
+/**
+* Update/Sync posted informations for topics
+*/
+function update_posted_info(&$topic_ids)
+{
+	return;
+
+	global $db, $config;
+
+	if (empty($topic_ids) || !$config['load_db_track'])
+	{
+		return;
+	}
+
+	// First of all, let us remove any posted information for these topics
+	$sql = 'DELETE FROM ' . TOPICS_POSTED_TABLE . '
+		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
+	$db->sql_query($sql);
+
+	// Now, let us collect the user/topic combos for rebuilding the information
+	$sql = 'SELECT poster_id, topic_id
+		FROM ' . POSTS_TABLE . '
+		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')
+			AND poster_id <> ' . ANONYMOUS . '
+		GROUP BY poster_id, topic_id';
+	$result = $db->sql_query($sql);
+
+	$posted = array();
+	while ($row = $db->sql_fetchrow($result))
+	{
+		// Add as key to make them unique (grouping by) and circumvent empty keys on array_unique
+		$posted[$row['poster_id']][] = $row['topic_id'];
+	}
+	$db->sql_freeresult($result);
+
+	// Now add the information...
+	$sql_ary = array();
+	foreach ($posted as $user_id => $topic_row)
+	{
+		foreach ($topic_row as $topic_id)
+		{
+			$sql_ary[] = array(
+				'user_id'		=> $user_id,
+				'topic_id'		=> $topic_id,
+				'topic_posted'	=> 1,
+			);
+		}
+	}
+	unset($posted);
+
+	if (sizeof($sql_ary))
+	{
+		switch (SQL_LAYER)
+		{
+			case 'mysql':
+			case 'mysql4':
+			case 'mysqli':
+				$db->sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $db->sql_build_array('MULTI_INSERT', $sql_ary));
+			break;
+
+			default:
+				foreach ($sql_ary as $ary)
+				{
+					$db->sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $db->sql_build_array('INSERT', $ary));
+				}
+			break;
+		}
+	}
+}
+
 // Delete File
 function phpbb_unlink($filename, $mode = 'file')
 {
@@ -724,43 +867,48 @@
 	return @unlink($filename);
 }
 
-// All-encompasing sync function
-//
-// Usage:
-// sync('topic', 'topic_id', 123);			<= resync topic #123
-// sync('topic', 'forum_id', array(2, 3));	<= resync topics from forum #2 and #3
-// sync('topic');							<= resync all topics
-// sync('topic', 'range', 'topic_id BETWEEN 1 AND 60');	<= resync a range of topics/forums (only available for 'topic' and 'forum' modes)
-//
-// Modes:
-// - topic_moved		Removes topic shadows that would be in the same forum as the topic they link to
-// - topic_approved		Resyncs the topic_approved flag according to the status of the first post
-// - post_reported		Resyncs the post_reported flag, relying on actual reports
-// - topic_reported		Resyncs the topic_reported flag, relying on post_reported flags
-// - post_attachement	Same as post_reported, thanks to a quick Search/Replace
-// - topic_attachement	Same as topic_reported, thanks to a quick Search/Replace
-//
-function sync($mode, $where_type = '', $where_ids = '', $resync_parents = FALSE, $sync_extra = FALSE)
+/**
+* All-encompasing sync function
+*
+* Exaples:
+* <code>
+* sync('topic', 'topic_id', 123);			// resync topic #123
+* sync('topic', 'forum_id', array(2, 3));	// resync topics from forum #2 and #3
+* sync('topic');							// resync all topics
+* sync('topic', 'range', 'topic_id BETWEEN 1 AND 60');	// resync a range of topics/forums (only available for 'topic' and 'forum' modes)
+* </code>
+*
+* Modes:
+* - forum				Resync complete forum
+* - topic				Resync topics
+* - topic_moved			Removes topic shadows that would be in the same forum as the topic they link to
+* - topic_approved		Resyncs the topic_approved flag according to the status of the first post
+* - post_reported		Resyncs the post_reported flag, relying on actual reports
+* - topic_reported		Resyncs the topic_reported flag, relying on post_reported flags
+* - post_attachement	Same as post_reported, but with attachment flags
+* - topic_attachement	Same as topic_reported, but with attachment flags
+*/
+function sync($mode, $where_type = '', $where_ids = '', $resync_parents = false, $sync_extra = false)
 {
 	global $_CLASS;
 
 	if (is_array($where_ids))
 	{
-		$where_ids = array_unique($where_ids);
+		$where_ids = array_unique(array_map('intval', $where_ids));
 	}
-	elseif ($where_type != 'range')
+	elseif ($where_type !== 'range')
 	{
-		$where_ids = ($where_ids) ? array($where_ids) : array();
+		$where_ids = ($where_ids) ? array((int) $where_ids) : array();
 	}
 
-	if ($mode == 'forum' || $mode == 'topic')
+	if ($mode === 'forum' || $mode === 'topic')
 	{
 		if (!$where_type)
 		{
-				$where_sql = '';
-				$where_sql_and = 'WHERE';
+			$where_sql = '';
+			$where_sql_and = 'WHERE';
 		}
-		elseif ($where_type == 'range')
+		elseif ($where_type === 'range')
 		{
 			// Only check a range of topics/forums. For instance: 'topic_id BETWEEN 1 AND 60'
 			$where_sql = 'WHERE (' . $mode{0} . ".$where_ids)";
@@ -768,13 +916,17 @@
 		}
 		else
 		{
+			// Do not sync the "global forum"
+			$where_ids = array_diff($where_ids, array(0));
+
 			if (empty($where_ids))
 			{
 				// Empty array with IDs. This means that we don't have any work to do. Just return.
 				return;
 			}
+
 			// Limit the topics/forums we are syncing, use specific topic/forum IDs.
-         // $where_type contains the field for the where clause (forum_id, topic_id)
+			// $where_type contains the field for the where clause (forum_id, topic_id)
 			$where_sql = 'WHERE ' . $mode{0} . ".$where_type IN (" . implode(', ', $where_ids) . ')';
 			$where_sql_and = $where_sql . "\n\tAND";
 		}
@@ -811,23 +963,25 @@
 							AND t1.forum_id = t2.forum_id";
 					$result = $_CLASS['core_db']->query($sql);
 
-					if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					$topic_id_ary = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 					{
-						$topic_id_ary = array();
-						do
-						{
-							$topic_id_ary[] = $row['topic_id'];
-						}
-						while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+						$topic_id_ary[] = $row['topic_id'];
+					}
+					$_CLASS['core_db']->free_result($result);
 
-						$sql = 'DELETE FROM ' . TOPICS_TABLE . '
-							WHERE topic_id IN (' . implode(', ', $topic_id_ary) . ')';
-						$_CLASS['core_db']->query($sql);
-						unset($topic_id_ary);
+					if (empty($topic_id_ary))
+					{
+						return;
 					}
-					$_CLASS['core_db']->free_result($result);					
+
+					$sql = 'DELETE FROM ' . TOPICS_TABLE . '
+						WHERE topic_id IN (' . implode(', ', $topic_id_ary) . ')';
+					$_CLASS['core_db']->query($sql);
+					unset($topic_id_ary);
+				break;	
 			}
-			break;
+		break;
 
 		case 'topic_approved':
 			switch ($_CLASS['core_db']->db_layer)
@@ -848,11 +1002,11 @@
 					$result = $_CLASS['core_db']->query($sql);
 
 					$topic_ids = array();
-					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					while ($row = $_CLASS['core_db']->fetch_row_assoc())
 					{
 						$topic_ids[] = $row['topic_id'];
 					}
-					$_CLASS['core_db']->free_result();
+					$_CLASS['core_db']->free_result($result);
 
 					if (empty($topic_ids))
 					{
@@ -874,6 +1028,7 @@
 				$where_sql
 				GROUP BY p.post_id, p.post_reported";
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$post_ids[$row['post_id']] = $row['post_id'];
@@ -882,12 +1037,12 @@
 					$post_reported[$row['post_id']] = 1;
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
-		/*	$sql = 'SELECT DISTINCT(post_id)
+			$sql = 'SELECT DISTINCT(post_id)
 				FROM ' . FORUMS_REPORTS_TABLE . '
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 			$result = $_CLASS['core_db']->query($sql);
-		*/
 
 			$post_ids = array();
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -901,6 +1056,7 @@
 					unset($post_reported[$row['post_id']]);
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			// $post_reported should be empty by now, if it's not it contains
 			// posts that are falsely flagged as reported
@@ -916,7 +1072,7 @@
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
-			break;
+		break;
 
 		case 'topic_reported':
 			if ($sync_extra)
@@ -930,10 +1086,12 @@
 				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql_and t.post_reported = 1";
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$topic_reported[$row['topic_id']] = 1;
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'SELECT t.topic_id, t.topic_reported
 				FROM ' . FORUMS_TOPICS_TABLE . " t
@@ -946,6 +1104,7 @@
 					$topic_ids[] = $row['topic_id'];
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			if (!empty($topic_ids))
 			{
@@ -964,6 +1123,7 @@
 				$where_sql
 				GROUP BY p.post_id, p.post_attachment";
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$post_ids[$row['post_id']] = $row['post_id'];
@@ -972,14 +1132,15 @@
 					$post_attachment[$row['post_id']] = 1;
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'SELECT DISTINCT(post_msg_id)
 				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 				WHERE post_msg_id IN (' . implode(', ', $post_ids) . ')
 					AND in_message = 0';
+			$result = $_CLASS['core_db']->query($sql);
 
 			$post_ids = array();
-			$result = $_CLASS['core_db']->query($sql);
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				if (!isset($post_attachment[$row['post_id']]))
@@ -991,7 +1152,8 @@
 					unset($post_attachment[$row['post_id']]);
 				}
 			}
-
+			$_CLASS['core_db']->free_result($result);
+	
 			// $post_attachment should be empty by now, if it's not it contains
 			// posts that are falsely flagged as having attachments
 			foreach ($post_attachment as $post_id => $void)
@@ -1020,15 +1182,18 @@
 				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql_and t.post_attachment = 1";
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$topic_attachment[$row['topic_id']] = 1;
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			$sql = 'SELECT t.topic_id, t.topic_attachment
 				FROM ' . FORUMS_TOPICS_TABLE . " t
 				$where_sql";
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				if ($row['topic_attachment'] ^ isset($topic_attachment[$row['topic_id']]))
@@ -1036,6 +1201,7 @@
 					$topic_ids[] = $row['topic_id'];
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			if (!empty($topic_ids))
 			{
@@ -1044,9 +1210,10 @@
 					WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
-			break;
+		break;
 
 		case 'forum':
+
 			// 1: Get the list of all forums
 			$sql = 'SELECT f.*
 				FROM ' . FORUMS_FORUMS_TABLE . " f
@@ -1073,13 +1240,20 @@
 				$forum_data[$forum_id]['last_poster_id'] = 0;
 				$forum_data[$forum_id]['last_poster_name'] = '';
 			}
+			$_CLASS['core_db']->free_result($result);
 
+			if (empty($forum_ids))
+			{
+				break;
+			}
+
 			// 2: Get topic counts for each forum
 			$sql = 'SELECT forum_id, topic_approved, COUNT(topic_id) AS forum_topics
 				FROM ' . FORUMS_TOPICS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')
 				GROUP BY forum_id, topic_approved';
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$forum_id = (int) $row['forum_id'];
@@ -1090,6 +1264,7 @@
 					$forum_data[$forum_id]['topics'] = $row['forum_topics'];
 				}
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			// 3: Get post count and last_post_id for each forum
 			$sql = 'SELECT forum_id, COUNT(post_id) AS forum_posts, MAX(post_id) AS last_post_id
@@ -1098,6 +1273,7 @@
 					AND post_approved = 1
 				GROUP BY forum_id';
 			$result = $_CLASS['core_db']->query($sql);
+
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				$forum_id = (int) $row['forum_id'];
@@ -1107,6 +1283,7 @@
 
 				$post_ids[] = $row['last_post_id'];
 			}
+			$_CLASS['core_db']->free_result($result);
 
 			// 4: Retrieve last_post infos
 			if (!empty($post_ids))
@@ -1116,6 +1293,7 @@
 					WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 						AND p.poster_id = u.user_id';
 				$result = $_CLASS['core_db']->query($sql);
+
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 				{
 					$post_info[intval($row['post_id'])] = $row;
@@ -1175,7 +1353,7 @@
 					$_CLASS['core_db']->query($sql);
 				}
 			}
-			break;
+		break;
 
 		case 'topic':
 			$topic_data = $post_ids = $approved_unapproved_ids = $resync_forums = $delete_topics = $delete_posts = array();
@@ -1206,7 +1384,7 @@
 			$_CLASS['core_db']->free_result($result);
 
 			// Use "t" as table alias because of the $where_sql clause
-         // NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.
+			// NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.
 			$sql = 'SELECT t.topic_id, t.post_approved, COUNT(t.post_id) AS total_posts, MIN(t.post_id) AS first_post_id, MAX(t.post_id) AS last_post_id
 				FROM ' . FORUMS_POSTS_TABLE . " t
 				$where_sql
@@ -1255,15 +1433,17 @@
 			// Now we delete empty topics and orphan posts
 			if (!empty($delete_posts))
 			{
-				delete_posts('topic_id', array_keys($delete_posts), FALSE);
+				delete_posts('topic_id', array_keys($delete_posts), false);
 				unset($delete_posts);
 			}
+
 			if (empty($topic_data))
 			{
 				// If we get there, topic ids were invalid or topics did not contain any posts
-				delete_topics($where_type, $where_ids, TRUE);
+				delete_topics($where_type, $where_ids, true);
 				return;
 			}
+
 			if (!empty($delete_topics))
 			{
 				$delete_topic_ids = array();
@@ -1273,7 +1453,7 @@
 					$delete_topic_ids[] = $topic_id;
 				}
 
-				delete_topics('topic_id', $delete_topic_ids, FALSE);
+				delete_topics('topic_id', $delete_topic_ids, false);
 				unset($delete_topics, $delete_topic_ids);
 			}
 
@@ -1298,6 +1478,7 @@
 					$topic_data[$topic_id]['poster'] = $row['poster_id'];
 					$topic_data[$topic_id]['first_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];
 				}
+
 				if ($row['post_id'] == $topic_data[$topic_id]['last_post_id'])
 				{
 					$topic_data[$topic_id]['last_poster_id'] = $row['poster_id'];
@@ -1328,7 +1509,7 @@
 					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_reported = 1
-					GROUP BY t.topic_id";
+					GROUP BY t.topic_id, p.post_id";
 				$result = $_CLASS['core_db']->query($sql);
 
 				$fieldnames[] = 'reported';
@@ -1344,7 +1525,7 @@
 					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . " p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_attachment = 1
-					GROUP BY t.topic_id";
+					GROUP BY t.topic_id, p.post_id";
 				$result = $_CLASS['core_db']->query($sql);
 
 				$fieldnames[] = 'attachment';
@@ -1384,33 +1565,38 @@
 			// batch processing.
 			if ($resync_parents && !empty($resync_forums) && $where_type != 'range')
 			{
-				sync('forum', 'forum_id', $resync_forums, TRUE);
+				sync('forum', 'forum_id', $resync_forums, true);
 			}
-			break;
+		break;
 	}
 }
 
+/**
+* Prune function
+*/
 function prune($forum_id, $prune_mode, $prune_date, $prune_flags = 0, $auto_sync = true)
 {
 	global $_CLASS;
 
-	$sql_forum = (is_array($forum_id)) ? ' IN (' . implode(',', $forum_id) . ')' : " = $forum_id";
+	$sql_forum = (is_array($forum_id)) ? ' IN (' . implode(', ', array_map('intval', $forum_id)) . ')' : ' = '. (int) $forum_id;
 
 	$sql_and = '';
 	if (!($prune_flags & 4))
 	{
 		$sql_and .= ' AND topic_type <> ' . POST_ANNOUNCE;
 	}
+
 	if (!($prune_flags & 8))
 	{
 		$sql_and .= ' AND topic_type <> ' . POST_STICKY;
 	}
 
-	if ($prune_mode == 'posted')
+	if ($prune_mode === 'posted')
 	{
 		$sql_and .= " AND topic_last_post_time < $prune_date";
 	}
-	if ($prune_mode == 'viewed')
+
+	if ($prune_mode === 'viewed')
 	{
 		$sql_and .= " AND topic_last_view_time < $prune_date";
 	}
@@ -1451,7 +1637,9 @@
 	return delete_topics('topic_id', $topic_list, $auto_sync);
 }
 
-// Function auto_prune(), this function now relies on passed vars
+/**
+* Function auto_prune(), this function now relies on passed vars
+*/
 function auto_prune($forum_id, $prune_mode, $prune_flags, $prune_days, $prune_freq)
 {
 	global $_CLASS;
@@ -1460,11 +1648,13 @@
 		FROM ' . FORUMS_TABLE . "
 		WHERE forum_id = $forum_id";
 	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
 
-	if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	if ($row)
 	{
-		$prune_date = time() - ($prune_days * 86400);
-		$next_prune = time() + ($prune_freq * 86400);
+		$prune_date = $_CLASS['core_user']->time - ($prune_days * 86400);
+		$next_prune = $_CLASS['core_user']->time + ($prune_freq * 86400);
 
 		prune($forum_id, $prune_mode, $prune_date, $prune_flags, true);
 
@@ -1475,13 +1665,14 @@
 
 		add_log('admin', 'LOG_AUTO_PRUNE', $row['forum_name']);
 	}
-	$_CLASS['core_db']->free_result($result);
 
 	return;
 }
 
-// remove_comments will strip the sql comment lines out of an uploaded sql file
-// specifically for mssql and postgres type files in the install....
+/**
+* remove_comments will strip the sql comment lines out of an uploaded sql file
+* specifically for mssql and postgres type files in the install....
+*/
 function remove_comments(&$output)
 {
 	$lines = explode("\n", $output);
@@ -1513,103 +1704,46 @@
 	return $output;
 }
 
-// remove_remarks will strip the sql comment lines out of an uploaded sql file
+/**
+* remove_remarks will strip the sql comment lines out of an uploaded sql file
+*/
 function remove_remarks(&$sql)
 {
-	$sql = preg_replace('/(\n){2,}/', "\n", preg_replace('/^#.*/m', "\n", $sql));
+	$sql = preg_replace('/\n{2,}/', "\n", preg_replace('/^#.*$/m', "\n", $sql));
 }
 
-// split_sql_file will split an uploaded sql file into single sql statements.
-// Note: expects trim() to have already been run on $sql.
-function split_sql_file($sql, $delimiter)
-{
-	// Split up our string into "possible" SQL statements.
-	$tokens = explode($delimiter, $sql);
-
-	// try to save mem.
-	$sql = '';
-	$output = array();
-
-	// we don't actually care about the matches preg gives us.
-	$matches = array();
-
-	// this is faster than calling count($oktens) every time thru the loop.
-	$token_count = count($tokens);
-	for ($i = 0; $i < $token_count; $i++)
-	{
-		// Don't wanna add an empty string as the last thing in the array.
-		if ($i != $token_count - 1)
-		{
-			// This is the total number of single quotes in the token.
-			$total_quotes = preg_match_all("#'#", $tokens[$i], $matches);
-			// Counts single quotes that are preceded by an odd number of backslashes,
-			// which means they're escaped quotes.
-			$escaped_quotes = preg_match_all("#(?<!\\\\)(\\\\\\\\)*\\\\'#", $tokens[$i], $matches);
-
-			$unescaped_quotes = $total_quotes - $escaped_quotes;
-
-			// If the number of unescaped quotes is even, then the delimiter did NOT occur inside a string literal.
-			if (!($unescaped_quotes % 2))
-			{
-				// It's a complete sql statement.
-				$output[] = $tokens[$i];
-				// save memory.
-				$tokens[$i] = '';
-			}
-			else
-			{
-				// incomplete sql statement. keep adding tokens until we have a complete one.
-				// $temp will hold what we have so far.
-				$temp = $tokens[$i] . $delimiter;
-				// save memory..
-				$tokens[$i] = '';
-
-				// Do we have a complete statement yet?
-				$complete_stmt = false;
-
-				for ($j = $i + 1; (!$complete_stmt && ($j < $token_count)); $j++)
-				{
-					// This is the total number of single quotes in the token.
-					$total_quotes = preg_match_all("#'#", $tokens[$j], $matches);
-					// Counts single quotes that are preceded by an odd number of backslashes,
-					// which means they're escaped quotes.
-					$escaped_quotes = preg_match_all("#(?<!\\\\)(\\\\\\\\)*\\\\'#", $tokens[$j], $matches);
-
-					$unescaped_quotes = $total_quotes - $escaped_quotes;
-
-					if (($unescaped_quotes % 2) == 1)
-					{
-						// odd number of unescaped quotes. In combination with the previous incomplete
-						// statement(s), we now have a complete statement. (2 odds always make an even)
-						$output[] = $temp . $tokens[$j];
-
-						// save memory.
-						$tokens[$j] = '';
-						$temp = '';
-
-						// exit the loop.
-						$complete_stmt = true;
-						// make sure the outer loop continues at the right point.
-						$i = $j;
-					}
-					else
-					{
-						// even number of unescaped quotes. We still don't have a complete statement.
-						// (1 odd and 1 even always make an odd)
-						$temp .= $tokens[$j] . $delimiter;
-						// save memory.
-						$tokens[$j] = '';
-					}
-				} // for..
-			} // else
-		}
-	}
-
-	return $output;
+/**
+* split_sql_file will split an uploaded sql file into single sql statements.
+* Note: expects trim() to have already been run on $sql.
+*/
+function split_sql_file($sql, $delimiter)
+{
+	$sql = str_replace("\r" , '', $sql);
+	$data = preg_split('/' . preg_quote($delimiter, '/') . '$/m', $sql);
+
+	foreach ($data as $key => $value)
+	{
+		$data[$key] = trim($value);
+	}
+
+	// The empty case
+	$end_data = end($data);
+
+	if (empty($end_data))
+	{
+		unset($data[key($data)]);
+	}
+
+	return $data;
 }
 
-// Cache moderators, called whenever permissions are changed via admin_permissions. Changes of username
-// and group names must be carried through for the moderators table
+/**
+* Cache moderators, called whenever permissions are changed via admin_permissions. Changes of username
+* and group names must be carried through for the moderators table
+*
+* @todo let the admin define if he wants to display moderators (forum-based) - display_on_index already present and checked for...
+*/
+// UPDATE UPDATE
 function cache_moderators()
 {
 	global $_CLASS;
@@ -1619,8 +1753,7 @@
 	$_CLASS['core_db']->query('TRUNCATE ' . FORUMS_MODERATOR_TABLE);
 
 	// Holding array
-	$m_sql = array();
-	$user_id_sql = '';
+	$sql_ary = array();
 
 	$sql = 'SELECT a.forum_id, u.user_id, u.username
 		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . CORE_USERS_TABLE . "  u
@@ -1632,12 +1765,18 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_u_' . $row['user_id']] = $row['forum_id'] . ', ' . $row['user_id'] . ", '" . $row['username'] . "', NULL, NULL, 1";
-		$user_id_sql .= (($user_id_sql) ? ', ' : '') . $row['user_id'];
+		$sql_ary[] = array(
+			'forum_id'			=> $row['forum_id'],
+			'user_id'			=> $row['user_id'],
+			'username'			=> $row['username'],
+			'group_id'			=> 0,
+			'group_name'		=> '',
+			'display_on_index'	=> 1
+		);
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$sql = 'SELECT a.forum_id, g.group_name, g.group_id
+	$sql = 'SELECT a.forum_id, g.group_id, g.group_name
 		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . CORE_GROUPS_TABLE . "  g
 		WHERE o.auth_option = 'm_'
 			AND a.auth_option_id = o.auth_option_id
@@ -1648,99 +1787,35 @@
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_g_' . $row['group_id']] = $row['forum_id'] . ', NULL, NULL, ' . $row['group_id'] . ", '" . $row['group_name'] . "', 1";
+		$sql_ary[] = array(
+			'forum_id'			=> $row['forum_id'],
+			'user_id'			=> 0,
+			'username'			=> '',
+			'group_id'			=> $row['group_id'],
+			'group_name'		=> $row['group_name'],
+			'display_on_index'	=> 1
+		);
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	if (!empty($m_sql))
+	if (!empty($sql_ary))
 	{
-		switch ($_CLASS['core_db']->db_layer)
-		{
-			case 'mysql3':
-				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index) 
-					VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\1)',  $m_sql));
-				$_CLASS['core_db']->query($sql);
-			break;
-
-			case 'mysql':
-			case 'mysqli':
-			case 'mssql':
-			case 'sqlite':
-			case 'sqlite_pdo':
-				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index)
-					 ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', 'SELECT \1',  $m_sql));
-				$_CLASS['core_db']->query($sql);
-			break;
-
-			default:
-				foreach ($m_sql as $k => $sql)
-				{
-					$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . " (forum_id, user_id, username, group_id, group_name, display_on_index) 
-						VALUES ($sql)";
-					$_CLASS['core_db']->query($sql);
-				}
-			break;
-		}
+		$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_ary, FORUMS_MODERATOR_TABLE);
 	}
 }
 
-// Logging functions
-function add_log()
+function view_log($mode, &$log, &$log_count, $limit = 0, $offset = 0, $forum_id = 0, $topic_id = 0, $user_id = 0, $limit_days = 0, $sort_by = 'l.log_time DESC')
 {
 	global $_CLASS;
 
-	$args = func_get_args();
+	$topic_id_list = $reportee_id_list = $is_auth = $is_mod = array();
 
-	$mode			= array_shift($args);
-	$reportee_id	= ($mode == 'user') ? (int) array_shift($args) : '';
-	$forum_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
-	$topic_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
-	$action			= array_shift($args);
-	$data			= empty($args) ? '' : $_CLASS['core_db']->escape(serialize($args));
-
 	switch ($mode)
 	{
 		case 'admin':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_ADMIN . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
-		break;
-		
-		case 'mod':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, forum_id, topic_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_MOD . ', ' . $_CLASS['core_user']->data['user_id'] . ", $forum_id, $topic_id, '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
-		break;
-
-		case 'user':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, reportee_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_USERS . ', ' . $_CLASS['core_user']->data['user_id'] . ", $reportee_id, '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
-		break;
-
-		case 'critical':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_CRITICAL . ', ' . $_CLASS['core_user']->data['user_id'] . ", '".$_CLASS['core_user']->ip."', " . gmtime() . ", '$action', '$data')";
-		break;
-		
-		default:
-			return;
-		break;
-	}
-
-	$_CLASS['core_db']->query($sql);
-	return;
-}
-
-function view_log($mode, &$log, &$log_count, $limit = 0, $offset = 0, $forum_id = 0, $topic_id = 0, $user_id = 0, $limit_days = 0, $sort_by = 'l.log_time DESC')
-{
-	global $_CLASS, $phpEx;
-
-	$topic_id_list = $is_auth = $is_mod = array();
-
-	switch ($mode)
-	{
-		case 'admin':
 			$log_type = LOG_ADMIN;
 			$sql_forum = '';
-			break;
+		break;
 		
 		case 'mod':
 			$log_type = LOG_MOD;
@@ -1757,20 +1832,26 @@
 			{
 				$sql_forum = ($forum_id) ? 'AND l.forum_id = ' . intval($forum_id) : '';
 			}
-			break;
+		break;
 
 		case 'user':
 			$log_type = LOG_USERS;
 			$sql_forum = 'AND l.reportee_id = ' . intval($user_id);
-			break;
+		break;
 		
+		case 'users':
+			$log_type = LOG_USERS;
+			$sql_forum = '';
+		break;
+
 		case 'critical':
 			$log_type = LOG_CRITICAL;
 			$sql_forum = '';
-			break;
+		break;
 		
 		default:
 			return;
+		break;
 	}
 
 	$sql = "SELECT l.*, u.username
@@ -1791,30 +1872,36 @@
 			$topic_id_list[] = $row['topic_id'];
 		}
 		
-		$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' => true)) : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']);
+		if ($row['reportee_id'])
+		{
+			$reportee_id_list[] = $row['reportee_id'];
+		}
 
-		$log[$i]['id'] = $row['log_id'];
-		$log[$i]['username'] = '<a href="' . $profile_url . '">' . $row['username'] . '</a>';
-		$log[$i]['ip'] = $row['log_ip'];
-		$log[$i]['time'] = $row['log_time'];
-		$log[$i]['forum_id'] = $row['forum_id'];
-		$log[$i]['topic_id'] = $row['topic_id'];
-		$log[$i]['viewforum'] = ($row['forum_id'] && $_CLASS['auth']->acl_get('f_read', $row['forum_id'])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '';
+		$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' => true)) : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']);
 
-		$log[$i]['action'] = (isset($_CLASS['core_user']->lang[$row['log_operation']])) ? $_CLASS['core_user']->lang[$row['log_operation']] : '{' . ucfirst(str_replace('_', ' ', $row['log_operation'])) . '}';
-		
+		$log[$i] = array(
+			'id'				=> $row['log_id'],
+			'reportee_id'		=> $row['reportee_id'],
+			'reportee_username'	=> '',
+			'user_id'			=> $row['user_id'],
+			'username'			=> '<a href="' . $profile_url . '">' . $row['username'] . '</a>',
+			'ip'				=> $row['log_ip'],
+			'time'				=> $row['log_time'],
+			'forum_id'			=> $row['forum_id'],
+			'topic_id'			=> $row['topic_id'],
+
+			'viewforum'			=> ($row['forum_id'] && $_CLASS['forums_auth']->acl_get('f_read', $row['forum_id'])) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : false,
+			'action'			=> (isset($_CLASS['core_user']->lang[$row['log_operation']])) ? $_CLASS['core_user']->lang[$row['log_operation']] : '{' . ucfirst(str_replace('_', ' ', $row['log_operation'])) . '}',
+		);
+
 		if (!empty($row['log_data']))
 		{
-			$log_data_ary = unserialize(stripslashes($row['log_data']));
+			$log_data_ary = @unserialize($row['log_data']);
 
 			if (isset($_CLASS['core_user']->lang[$row['log_operation']]))
 			{
-				foreach ($log_data_ary as $log_data)
-				{
-					$log_data = str_replace("\n", '<br />', censor_text($log_data));
-
-					$log[$i]['action'] = preg_replace('#%s#', $log_data, $log[$i]['action'], 1);
-				}
+				$log[$i]['action'] = vsprintf($log[$i]['action'], $log_data_ary);
+				$log[$i]['action'] = str_replace("\n", '<br />', censor_text($log[$i]['action']));
 			}
 			else
 			{
@@ -1839,14 +1926,30 @@
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($_CLASS['auth']->acl_get('f_read', $row['forum_id']))
+			/*if (!$row['forum_id'])
+			{
+				if ($auth->acl_getf_global('f_read'))
+				{
+					if (!$default_forum_id)
+					{
+						$sql = 'SELECT forum_id
+							FROM ' . FORUMS_TABLE . '
+							WHERE forum_type = ' . FORUM_POST;
+						$f_result = $db->sql_query_limit($sql, 1);
+						$default_forum_id = (int) $db->sql_fetchfield('forum_id', false, $f_result);
+						$db->sql_freeresult($f_result);
+					}
+
+					$is_auth[$row['topic_id']] = $default_forum_id;
+				}
+			} else*/
+			
+			if ($_CLASS['forums_auth']->acl_get('f_read', $row['forum_id']))
 			{
-				// DEBUG!! - global topic
-				$config['default_forum_id'] = 2;
-				$is_auth[$row['topic_id']] = ($row['forum_id']) ? $row['forum_id'] : $config['default_forum_id'];
+				$is_auth[$row['topic_id']] = ($row['forum_id']) ? $row['forum_id'] : false;
 			}
 
-			if ($_CLASS['auth']->acl_gets('a_', 'm_', $row['forum_id']))
+			if ($_CLASS['forums_auth']->acl_gets(array('a_', 'm_'), $row['forum_id']))
 			{
 				$is_mod[$row['topic_id']] = $row['forum_id'];
 			}
@@ -1854,11 +1957,27 @@
 
 		foreach ($log as $key => $row)
 		{
-			$log[$key]['viewtopic'] = (isset($is_auth[$row['topic_id']])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=viewtopic&amp;f=' . $is_auth[$row['topic_id']] . '&amp;t=' . $row['topic_id']) : '';
-			$log[$key]['viewlogs'] = (isset($is_mod[$row['topic_id']])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=mcp&amp;mode=topic_view&amp;action=viewlogs&amp;t=' . $row['topic_id']) : '';
+			$log[$key]['viewtopic'] = isset($is_auth[$row['topic_id']]) ? generate_link('forums&amp;file=viewtopic&amp;&amp;t=' . $row['topic_id']) : '';
+			$log[$key]['viewlogs'] = isset($is_mod[$row['topic_id']]) ? generate_link('forums&amp;file=mcp&amp;mode=topic_view&amp;action=viewlogs&amp;t=' . $row['topic_id']) : '';
 		}
 	}
 
+	if ($reportee_id_list)
+	{
+		$reportee_id_list = array_unique($reportee_id_list);
+		$reportee_names_list = array();
+
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+		$reportee_names_list = user_get_name($reportee_id_list, $null);
+		foreach ($log as $key => $row)
+		{
+			$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' => true)) : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']);
+			$log[$key]['reportee_username'] = isset($reportee_names_list[$row['reportee_id']]) ? '<a href="' . $profile_url . '&amp;u=' . $row['reportee_id'] . '">' . $reportee_names_list[$row['reportee_id']] . '</a>' : false;
+		}
+		unset($null, $reportee_names_list);
+	}
+
 	$sql = 'SELECT COUNT(l.log_id) AS total_entries
 		FROM ' . FORUMS_LOG_TABLE . " l
 		WHERE l.log_type = $log_type
@@ -1869,7 +1988,7 @@
 	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 	$_CLASS['core_db']->free_result($result);
 
-	$log_count =  $row['total_entries'];
+	$log_count = (int) $row['total_entries'];
 
 	return;
 }
@@ -2182,84 +2301,58 @@
 	}
 }
 
-// Update Post Informations (First/Last Post in topic/forum)
-// Should be used instead of sync() if only the last post informations are out of sync... faster
-function update_post_information($type, $ids)
-{
-	global $_CLASS;
-
-	if (!is_array($ids))
-	{
-		$ids = array($ids);
-	}
-
-	$update_sql = $empty_forums = array();
-
-	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . FORUMS_POSTS_TABLE . "
-		WHERE post_approved = 1
-			AND {$type}_id IN (" . implode(', ', $ids) . ")
-		GROUP BY {$type}_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$last_post_ids = array();
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		if ($type == 'forum')
-		{
-			$empty_forums[] = $row['forum_id'];
-		}
-
-		$last_post_ids[] = $row['last_post_id'];
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	if ($type == 'forum')
-	{
-		$empty_forums = array_diff($ids, $empty_forums);
-
-		foreach ($empty_forums as $void => $forum_id)
-		{
-			$update_sql[$forum_id][] = 'forum_last_post_id = 0';
-			$update_sql[$forum_id][] =	'forum_last_post_time = 0';
-			$update_sql[$forum_id][] = 'forum_last_poster_id = 0';
-			$update_sql[$forum_id][] = "forum_last_poster_name = ''";
-		}
-	}
-
-	if (!empty($last_post_ids))
-	{
-		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
-			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . ' u
-			WHERE p.poster_id = u.user_id
-				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$update_sql[$row["{$type}_id"]][] = $type . '_last_post_id = ' . (int) $row['post_id'];
-			$update_sql[$row["{$type}_id"]][] = $type . '_last_post_time = ' . (int) $row['post_time'];
-			$update_sql[$row["{$type}_id"]][] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
-			$update_sql[$row["{$type}_id"]][] = "{$type}_last_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
-		}
-		$_CLASS['core_db']->free_result($result);
-	}
-	unset($empty_forums, $ids, $last_post_ids);
-
-	if (empty($update_sql))
-	{
-		return;
-	}
-
-	$table = ($type == 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
-
-	foreach ($update_sql as $update_id => $update_sql_ary)
-	{
-		$sql = "UPDATE $table
-			SET " . implode(', ', $update_sql_ary) . "
-			WHERE {$type}_id = $update_id";
-		$_CLASS['core_db']->query($sql);
-	}
+/**
+* Retrieve contents from remotely stored file
+*/
+function get_remote_file($host, $directory, $filename, &$errstr, &$errno, $port = 80, $timeout = 10)
+{
+	global $_CLASS;
+
+	if ($fsock = @fsockopen($host, $port, $errno, $errstr, $timeout))
+	{
+		@fputs($fsock, "GET $directory/$filename HTTP/1.1\r\n");
+		@fputs($fsock, "HOST: $host\r\n");
+		@fputs($fsock, "Connection: close\r\n\r\n");
+	
+		$file_info = '';
+		$get_info = false;
+
+		while (!@feof($fsock))
+		{
+			if ($get_info)
+			{
+				$file_info .= @fread($fsock, 1024);
+			}
+			else
+			{
+				$line = @fgets($fsock, 1024);
+				if ($line == "\r\n")
+				{
+					$get_info = true;
+				}
+				else if (strpos($line, '404 Not Found') !== false)
+				{
+					$errstr = $_CLASS['core_user']->lang['FILE_NOT_FOUND'];
+					return false;
+				}
+			}
+		}
+		@fclose($fsock);
+	}
+	else
+	{
+		if ($errstr)
+		{
+			return false;
+		}
+		else
+		{
+			$errstr = 'fsock disabled';
+			return false;
+		}
+	}
+	
+	return $file_info;
 }
 
 /**
@@ -2270,13 +2363,13 @@
 {
 	global $_CLASS;
 return;
-	$remove_date = time() - (3 * 62 * 24 * 3600);
+	$remove_date = $_CLASS['core_user']->time - (3 * 62 * 24 * 3600);
 
 	$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 		WHERE mark_time < ' . $remove_date;
 	$_CLASS['core_db']->query($sql);
 
-	set_config('database_last_gc', time(), true);
+	set_config('database_last_gc', $_CLASS['core_user']->time, true);
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -358,6 +358,37 @@
 	return array($active_forum_ary, array());
 }
 
+/**
+* Display reasons
+*/
+function display_reasons($reason_id = 0)
+{
+	global $_CLASS;
+return;
+	$sql = 'SELECT * 
+		FROM ' . REPORTS_REASONS_TABLE . ' 
+		ORDER BY reason_order ASC';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
+		if (isset($_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) && isset($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		{
+			$row['reson_description'] = $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
+			$row['reason_title'] = $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+		}
+
+		$_CLASS['core_template']->assign_vars_array('reason', array(
+			'ID'			=> $row['reason_id'],
+			'TITLE'			=> $row['reason_title'],
+			'DESCRIPTION'	=> $row['reason_description'],
+			'S_SELECTED'	=> ($row['reason_id'] == $reason_id) ? true : false)
+		);
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+
 function topic_status(&$topic_row, $replies, $mark_time, &$unread, &$folder_img, &$folder_alt, &$topic_type)
 {
 	global $_CLASS, $config;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -91,47 +91,94 @@
 	}
 }
 
-// Update Last Post Informations
-function update_last_post_information($type, $id)
+/**
+* Update Post Informations (First/Last Post in topic/forum)
+* Should be used instead of sync() if only the last post informations are out of sync... faster
+*
+* @param string $type Can be forum|topic
+* @param mixed $ids topic/forum ids
+*/
+function update_post_information($type, $ids, $return_update_sql = false)
 {
 	global $_CLASS;
 
-	$update_sql = array();
+	if (!is_array($ids))
+	{
+		$ids = array($ids);
+	}
 
-	$sql = 'SELECT MAX(p.post_id) as last_post_id
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . " t
-		WHERE p.topic_id = t.topic_id
-			AND p.post_approved = 1
-			AND t.topic_approved = 1
-			AND p.{$type}_id = $id";
-			
+	$update_sql = $empty_forums = array();
+
+	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
+		FROM ' . FORUMS_POSTS_TABLE . "
+		WHERE post_approved = 1
+			AND {$type}_id IN (" . implode(', ', $ids) . ")
+		GROUP BY {$type}_id";
 	$result = $_CLASS['core_db']->query($sql);
-	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 
-	if ((int) $row['last_post_id'])
+	$last_post_ids = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$sql = 'SELECT p.post_id, p.poster_id, p.post_time, u.username, p.post_username
+		if ($type === 'forum')
+		{
+			$empty_forums[] = $row['forum_id'];
+		}
+
+		$last_post_ids[] = $row['last_post_id'];
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	if ($type === 'forum')
+	{
+		$empty_forums = array_diff($ids, $empty_forums);
+
+		foreach ($empty_forums as $void => $forum_id)
+		{
+			$update_sql[$forum_id][] = 'forum_last_post_id = 0';
+			$update_sql[$forum_id][] =	'forum_last_post_time = 0';
+			$update_sql[$forum_id][] = 'forum_last_poster_id = 0';
+			$update_sql[$forum_id][] = "forum_last_poster_name = ''";
+		}
+	}
+
+	if (!empty($last_post_ids))
+	{
+		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
 			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
-				AND p.post_id = ' . $row['last_post_id'];
+				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
 		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$update_sql[$row["{$type}_id"]][] = $type . '_last_post_id = ' . (int) $row['post_id'];
+			$update_sql[$row["{$type}_id"]][] = $type . '_last_post_time = ' . (int) $row['post_time'];
+			$update_sql[$row["{$type}_id"]][] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
+			$update_sql[$row["{$type}_id"]][] = "{$type}_last_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
+		}
 		$_CLASS['core_db']->free_result($result);
+	}
+	unset($empty_forums, $ids, $last_post_ids);
 
-		$update_sql[] = $type . '_last_post_id = ' . (int) $row['post_id'];
-		$update_sql[] =	$type . '_last_post_time = ' . (int) $row['post_time'];
-		$update_sql[] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
-		$update_sql[] = "{$type}_last_poster_name = '" . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']->escape($row['post_username']) : $_CLASS['core_db']->escape($row['username'])) . "'";
+	if (empty($update_sql))
+	{
+		return;
 	}
-	else if ($type == 'forum')
+
+	/*if ($return_update_sql)
 	{
-		$update_sql[] = 'forum_last_post_id = 0';
-		$update_sql[] =	'forum_last_post_time = 0';
-		$update_sql[] = 'forum_last_poster_id = 0';
-		$update_sql[] = "forum_last_poster_name = ''";
+		return $update_sql;
+	}*/
+
+	$table = ($type === 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
+
+	foreach ($update_sql as $update_id => $update_sql_ary)
+	{
+		$sql = "UPDATE $table
+			SET " . implode(', ', $update_sql_ary) . "
+			WHERE {$type}_id = $update_id";
+		$_CLASS['core_db']->query($sql);
 	}
-
-	return $update_sql;
 }
 
 function upload_attachment($form_name, $forum_id, $local = false, $local_storage = '', $is_message = false)
@@ -361,7 +408,7 @@
 
 	if (file_exists($destination) && function_exists('passthru'))
 	{
-		passthru($config['img_imagick'] . 'convert' . ((defined('PHP_OS') && preg_match('#win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' "' . str_replace('\\', '/', $source) . '" +profile "*" "' . str_replace('\\', '/', $destination) . '"');
+		passthru(escapeshellcmd($config['img_imagick']) . 'convert' . ((defined('PHP_OS') && preg_match('#^win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' "' . str_replace('\\', '/', $source) . '" +profile "*" "' . str_replace('\\', '/', $destination) . '"');
 		if (file_exists($new_file))
 		{
 			$used_imagick = true;
@@ -745,11 +792,11 @@
 		return false;
 	}
 
-	$bbcode_bitfield = 0;
+	$bbcode_bitfield = '';
 	do
 	{
 		$rowset[] = $row;
-		$bbcode_bitfield |= $row['bbcode_bitfield'];
+		 $bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 	}
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
 	$_CLASS['core_db']->free_result($result);
@@ -812,7 +859,7 @@
 		unset($rowset[$i]);
 	}
 
-	if ($mode == 'topic_review')
+	if ($mode === 'topic_review')
 	{
 		$_CLASS['core_template']->assign('QUOTE_IMG', $_CLASS['core_user']->img('btn_quote', $_CLASS['core_user']->lang['REPLY_WITH_QUOTE']));
 	}
@@ -1140,7 +1187,8 @@
 		{
 			$_CLASS['core_db']->query("UPDATE $table SET $update_sql WHERE " . $where_sql[$table]);
 		}
-	}
+	}
+	unset($sql_data);
 
 	$_CLASS['core_db']->transaction('commit');
 
@@ -1378,7 +1426,7 @@
 	$_CLASS['core_db']->transaction();
 
 	// Submit new topic
-	if ($post_mode == 'post')
+	if ($post_mode === 'post')
 	{
 		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
 			$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
@@ -1393,19 +1441,21 @@
 	}
 
 	// Submit new post
-	if ($post_mode == 'post' || $post_mode == 'reply')
+	if ($post_mode === 'post' || $post_mode === 'reply')
 	{
-		if ($post_mode == 'reply')
+		if ($post_mode === 'reply')
 		{
 			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 				'topic_id' => $data['topic_id']
 			));
 		}
 
-		$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$_CLASS['core_db']->sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']));
+		$_CLASS['core_db']->sql_query_build('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql'], FORUMS_POSTS_TABLE);
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
+
 		$data['post_id'] = $_CLASS['core_db']->insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
-		if ($post_mode == 'post')
+		if ($post_mode === 'post')
 		{
 			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_first_post_id'	=> $data['post_id'],
@@ -1415,14 +1465,12 @@
 				'topic_last_poster_name'=> (!$_CLASS['core_user']->is_user && $username) ? $username : (($_CLASS['core_user']->data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']->data['username'] : ''
 			));
 		}
-
-		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
 	}
 
 	$make_global = false;
 
 	// Are we globalising or unglobalising?
-	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
+	if ($post_mode === 'edit_first_post' || $post_mode === 'edit_topic')
 	{
 		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
 			FROM ' . FORUMS_TOPICS_TABLE . '
@@ -1527,23 +1575,10 @@
 			}
 		}
 
-		if (sizeof($sql_insert_ary))
+		if (!empty($sql_insert_ary))
 		{
-			switch ($_CLASS['core_db']->db_layer)
-			{
-				case 'mysql':
-				case 'mysql4':
-				case 'mysqli':
-					$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('MULTI_INSERT', $sql_insert_ary));
-				break;
-
-				default:
-					foreach ($sql_insert_ary as $ary)
-					{
-						$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $ary));
-					}
-				break;
-			}
+			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_insert_ary, FORUMS_POLL_OPTIONS_TABLE);
+			unset($sql_insert_ary);
 		}
 
 		if (count($poll['poll_options']) < count($cur_poll_options))
@@ -1605,6 +1640,7 @@
 		if (count($attach_sql_array))
 		{
 			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_TOPICS_TABLE);
+			unset($attach_sql_array);
 		}
 	
 		if ($files_updated || $files_added)
@@ -1627,7 +1663,7 @@
 
 	$_CLASS['core_db']->transaction('commit');
 
-	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
+	if ($post_mode === 'post' || $post_mode === 'reply' || $post_mode === 'edit_last_post')
 	{
 		if ($topic_type != POST_GLOBAL)
 		{
@@ -1654,7 +1690,7 @@
 		}
 	}
 
-	if ($post_mode == 'edit_topic')
+	if ($post_mode === 'edit_topic')
 	{
 		$update_sql = update_post_information('topic', $data['topic_id'], true);
 		if (sizeof($update_sql))
@@ -1666,13 +1702,13 @@
 	// Update total post count, do not consider moderated posts/topics
 	if ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id']))
 	{
-		if ($post_mode == 'post')
+		if ($post_mode === 'post')
 		{
 			set_config('num_topics', $config['num_topics'] + 1, true);
 			set_config('num_posts', $config['num_posts'] + 1, true);
 		}
 
-		if ($post_mode == 'reply')
+		if ($post_mode === 'reply')
 		{
 			set_config('num_posts', $config['num_posts'] + 1, true);
 		}
@@ -1747,8 +1783,8 @@
 				'notify_type'	=> $poster_id,
 				'notify_status'	=> 0,
 			);
-				
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $notify_sql));
+
+			$_CLASS['core_db']->sql_query_build('INSERT', $notify_sql, FORUMS_WATCH_TABLE);
 			unset($notify_sql);
 		}
 		else if ($data['notify_set'] && !$data['notify'])
@@ -1771,12 +1807,12 @@
 	markread('topic', $data['forum_id'], $data['topic_id'], $_CLASS['core_user']->time);
 
 	// Send Notifications
-	if ($mode != 'edit' && $mode != 'delete' && ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])))
+	if ($mode !== 'edit' && $mode !== 'delete' && ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])))
 	{
 		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
 	}
 
-	if ($mode == 'post')
+	if ($mode === 'post')
 	{
 		$url = ($_CLASS['forums_auth']->acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']->acl_get('m_approve', $data['forum_id'])) ? generate_link('forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
 	}

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -36,21 +36,20 @@
 		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
 */
 
-define('RULE_IS_LIKE', 1); // Is Like
-define('RULE_IS_NOT_LIKE', 2); // Is Not Like
-define('RULE_IS', 3); // Is
-define('RULE_IS_NOT', 4); // Is Not
-define('RULE_BEGINS_WITH', 5); // Begins with
-define('RULE_ENDS_WITH', 6); // Ends with
-define('RULE_IS_FRIEND', 7); // Is Friend
-define('RULE_IS_FOE', 8); // Is Foe
-define('RULE_IS_USER', 9); // Is User
-define('RULE_IS_GROUP', 10); // Is In Usergroup
-define('RULE_ANSWERED', 11); // Answered
-define('RULE_FORWARDED', 12); // Forwarded
-define('RULE_REPORTED', 13); // Reported
-define('RULE_TO_GROUP', 14); // Usergroup
-define('RULE_TO_ME', 15); // Me
+define('RULE_IS_LIKE', 1);		// Is Like
+define('RULE_IS_NOT_LIKE', 2);	// Is Not Like
+define('RULE_IS', 3);			// Is
+define('RULE_IS_NOT', 4);		// Is Not
+define('RULE_BEGINS_WITH', 5);	// Begins with
+define('RULE_ENDS_WITH', 6);	// Ends with
+define('RULE_IS_FRIEND', 7);	// Is Friend
+define('RULE_IS_FOE', 8);		// Is Foe
+define('RULE_IS_USER', 9);		// Is User
+define('RULE_IS_GROUP', 10);	// Is In Usergroup
+define('RULE_ANSWERED', 11);	// Answered
+define('RULE_FORWARDED', 12);	// Forwarded
+define('RULE_TO_GROUP', 14);	// Usergroup
+define('RULE_TO_ME', 15);		// Me
 
 define('ACTION_PLACE_INTO_FOLDER', 1);
 define('ACTION_MARK_AS_READ', 2);
@@ -63,67 +62,76 @@
 define('CHECK_STATUS', 4);
 define('CHECK_TO', 5);
 
-$global_privmsgs_rules = array(
-	CHECK_SUBJECT	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'message_subject', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'message_subject', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'message_subject', 'function' => '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=> array('check0' => 'message_subject', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_ENDS_WITH		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})')),
+/**
+* Global private message rules
+* These rules define what to do if a rule is hit
+*/
+$global_privmsgs_rules = array(
+	CHECK_SUBJECT	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'message_subject', 'function' => '!(preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'message_subject', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'message_subject', 'function' => '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=> array('check0' => 'message_subject', 'function' => 'preg_match("/^" . preg_quote({STRING}, "/") . "/i", {CHECK0})'),
+		RULE_ENDS_WITH		=> array('check0' => 'message_subject', 'function' => 'preg_match("/" . preg_quote({STRING}, "/") . "$/i", {CHECK0})'),
+	),
+
+	CHECK_SENDER	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'username', 'function' => '!(preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'username', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'username', 'function' => '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=> array('check0' => 'username', 'function' => 'preg_match("/^" . preg_quote({STRING}, "/") . "/i", {CHECK0})'),
+		RULE_ENDS_WITH		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}, "/") . "$/i", {CHECK0})'),
+		RULE_IS_FRIEND		=> array('check0' => 'friend', 'function' => '{CHECK0} == 1'),
+		RULE_IS_FOE			=> array('check0' => 'foe', 'function' => '{CHECK0} == 1'),
+		RULE_IS_USER		=> array('check0' => 'author_id', 'function' => '{CHECK0} == {USER_ID}'),
+		RULE_IS_GROUP		=> array('check0' => 'author_in_group', 'function' => 'in_array({GROUP_ID}, {CHECK0})'),
+	),
+
+	CHECK_MESSAGE	=> array(
+		RULE_IS_LIKE		=> array('check0' => 'message_text', 'function' => 'preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0})'),
+		RULE_IS_NOT_LIKE	=> array('check0' => 'message_text', 'function' => '!(preg_match("/" . preg_quote({STRING}, "/") . "/i", {CHECK0}))'),
+		RULE_IS				=> array('check0' => 'message_text', 'function' => '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=> array('check0' => 'message_text', 'function' => '{CHECK0} != {STRING}'),
+	),
+
+	CHECK_STATUS	=> array(
+		RULE_ANSWERED		=> array('check0' => 'pm_replied', 'function' => '{CHECK0} == 1'),
+		RULE_FORWARDED		=> array('check0' => 'pm_forwarded', 'function' => '{CHECK0} == 1'),
+	),
+
+	CHECK_TO		=> array(
+		RULE_TO_GROUP		=> array('check0' => 'to', 'check1' => 'bcc', 'check2' => 'user_in_group', 'function' => 'in_array("g_" . {CHECK2}, {CHECK0}) || in_array("g_" . {CHECK2}, {CHECK1})'),
+		RULE_TO_ME			=> array('check0' => 'to', 'check1' => 'bcc', 'function' => 'in_array("u_" . $user_id, {CHECK0}) || in_array("u_" . $user_id, {CHECK1})'),
+	)
+);
 
-	CHECK_SENDER	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'username', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'username', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'username', 'function' => '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=> array('check0' => 'username', 'function' => 'preg_match("/^" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_ENDS_WITH		=> array('check0' => 'username', 'function' => 'preg_match("/" . preg_quote({STRING}) . "$/i", {CHECK0})'),
-		RULE_IS_FRIEND		=> array('check0' => 'friend', 'function' => '{CHECK0} == 1'),
-		RULE_IS_FOE			=> array('check0' => 'foe', 'function' => '{CHECK0} == 1'),
-		RULE_IS_USER		=> array('check0' => 'author_id', 'function' => '{CHECK0} == {USER_ID}'),
-		RULE_IS_GROUP       => array('check0' => 'author_in_group', 'function' => 'in_array({GROUP_ID}, {CHECK0})')),
+/**
+* This is for defining which condition fields to show for which Rule
+*/
+$global_rule_conditions = array(
+	RULE_IS_LIKE		=> 'text',
+	RULE_IS_NOT_LIKE	=> 'text',
+	RULE_IS				=> 'text',
+	RULE_IS_NOT			=> 'text',
+	RULE_BEGINS_WITH	=> 'text',
+	RULE_ENDS_WITH		=> 'text',
+	RULE_IS_USER		=> 'user',
+	RULE_IS_GROUP		=> 'group'
+);
 
-	CHECK_MESSAGE	=> array(
-		RULE_IS_LIKE		=> array('check0' => 'message_text', 'function' => 'preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0})'),
-		RULE_IS_NOT_LIKE	=> array('check0' => 'message_text', 'function' => '!(preg_match("/" . preg_quote({STRING}) . "/i", {CHECK0}))'),
-		RULE_IS				=> array('check0' => 'message_text', 'function' => '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=> array('check0' => 'message_text', 'function' => '{CHECK0} != {STRING}')),
-		
-	CHECK_STATUS	=> array(
-		RULE_ANSWERED		=> array('check0' => 'replied', 'function' => '{CHECK0} == 1'),
-		RULE_FORWARDED		=> array('check0' => 'forwarded', 'function' => '{CHECK0} == 1'),
-		RULE_REPORTED		=> array('check0' => 'message_reported', 'function' => '{CHECK0} == 1')),
-		
-	CHECK_TO		=> array(
-		RULE_TO_GROUP		=> array('check0' => 'to', 'check1' => 'bcc', 'check2' => 'user_in_group', 'function' => 'in_array("g_" . {CHECK2}, {CHECK0}) || in_array("g_" . {CHECK2}, {CHECK1})'),
-		RULE_TO_ME			=> array('check0' => 'to', 'check1' => 'bcc', 'function' => 'in_array("u_" . $user_id, {CHECK0}) || in_array("u_" . $user_id, {CHECK1})'))
-);
-
-// This is for defining which condition fields to show for which Rule
-$global_rule_conditions = array(
-	RULE_IS_LIKE		=> 'text',
-	RULE_IS_NOT_LIKE	=> 'text',
-	RULE_IS				=> 'text',
-	RULE_IS_NOT			=> 'text',
-	RULE_BEGINS_WITH	=> 'text',
-	RULE_ENDS_WITH		=> 'text',
-	RULE_IS_USER		=> 'user',
-	RULE_IS_GROUP		=> 'group'
-);
-
-// Get all folder
-function get_folder($user_id, &$folder, $folder_id = false)
+/**
+* Get all folder
+*/
+function get_folder($user_id, $folder_id = false)
 {
 	global $_CLASS;
 
-	if (!is_array($folder))
-	{
-		$folder = array();
-	}
+	$folder = array();
 
 	// Get folder informations
-	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
+	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(pm_unread) as num_unread
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 		WHERE user_id = $user_id
 			AND folder_id <> " . PRIVMSGS_NO_BOX . '
@@ -138,25 +146,30 @@
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	// Make sure the default boxes are defined
-	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
-	foreach ($folder_array as $default_folder)
-	{
-		if (!isset($num_messages[$default_folder]))
-		{
-			$num_messages[$default_folder] = 0;
-		}
-
-		if (!isset($num_unread[$default_folder]))
-		{
-			$num_unread[$default_folder] = 0;
-		}
+	// Make sure the default boxes are defined
+	$available_folder = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
+
+	foreach ($available_folder as $default_folder)
+	{
+		if (!isset($num_messages[$default_folder]))
+		{
+			$num_messages[$default_folder] = 0;
+		}
+
+		if (!isset($num_unread[$default_folder]))
+		{
+			$num_unread[$default_folder] = 0;
+		}
 	}
 
 	// Adjust unread status for outbox
 	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
 	
-	$folder[PRIVMSGS_INBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_INBOX'], 'num_messages' => $num_messages[PRIVMSGS_INBOX], 'unread_messages' => $num_unread[PRIVMSGS_INBOX]);
+	$folder[PRIVMSGS_INBOX] = array(
+		'folder_name'		=> $_CLASS['core_user']->lang['PM_INBOX'],
+		'num_messages'		=> $num_messages[PRIVMSGS_INBOX],
+		'unread_messages'	=> $num_unread[PRIVMSGS_INBOX]
+	);
 
 	// Custom Folder
 	$sql = 'SELECT folder_id, folder_name, pm_count
@@ -166,32 +179,52 @@
 			
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$folder[$row['folder_id']] = array('folder_name' => $row['folder_name'], 'num_messages' => $row['pm_count'], 'unread_messages' => ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
+		$folder[$row['folder_id']] = array(
+			'folder_name'		=> $row['folder_name'],
+			'num_messages'		=> $row['pm_count'],
+			'unread_messages'	=> isset($num_unread[$row['folder_id']]) ? $num_unread[$row['folder_id']] : 0
+		);
 	}
 	$_CLASS['core_db']->free_result($result);
 
-	$folder[PRIVMSGS_OUTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_OUTBOX'], 'num_messages' => $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' => $num_unread[PRIVMSGS_OUTBOX]);
-	$folder[PRIVMSGS_SENTBOX] = array('folder_name' => $_CLASS['core_user']->lang['PM_SENTBOX'], 'num_messages' => $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' => $num_unread[PRIVMSGS_SENTBOX]);
+	$folder[PRIVMSGS_OUTBOX] = array(
+		'folder_name'		=> $_CLASS['core_user']->lang['PM_OUTBOX'],
+		'num_messages'		=> $num_messages[PRIVMSGS_OUTBOX],
+		'unread_messages'	=> $num_unread[PRIVMSGS_OUTBOX]
+	);
 
+	$folder[PRIVMSGS_SENTBOX] = array(
+		'folder_name'		=> $_CLASS['core_user']->lang['PM_SENTBOX'],
+		'num_messages'		=> $num_messages[PRIVMSGS_SENTBOX],
+		'unread_messages'	=> $num_unread[PRIVMSGS_SENTBOX]
+	);
+
 	// Define Folder Array for template designers (and for making custom folders usable by the template too)
 	foreach ($folder as $f_id => $folder_ary)
 	{
+		$folder_id_name = ($f_id == PRIVMSGS_INBOX) ? 'inbox' : (($f_id == PRIVMSGS_OUTBOX) ? 'outbox' : 'sentbox');
+
 		$_CLASS['core_template']->assign_vars_array('folder', array(
 			'FOLDER_ID'			=> $f_id,
 			'FOLDER_NAME'		=> $folder_ary['folder_name'],
 			'NUM_MESSAGES'		=> $folder_ary['num_messages'],
 			'UNREAD_MESSAGES'	=> $folder_ary['unread_messages'],
 
-			'S_CUR_FOLDER'		=> ($f_id == $folder_id) ? true : false,
-			'S_UNREAD_MESSAGES'	=> ($folder_ary['unread_messages']) ? true : false,
-			'S_CUSTOM_FOLDER'	=> ($f_id > 0) ? true : false)
-		);
+			'U_FOLDER'			=> ($f_id > 0) ? generate_link('control_panel&amp;i=pm&amp;folder=' . $f_id) : generate_link('control_panel&amp;i=pm&amp;folder=' . $folder_id_name),
+
+			'S_CUR_FOLDER'		=> ($f_id === $folder_id),
+			'S_UNREAD_MESSAGES'	=> ($folder_ary['unread_messages']),
+			'S_CUSTOM_FOLDER'	=> ($f_id > 0)
+		));
 	}
 
-	return;
+	return $folder;
 }
 
-// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
+/**
+* Delete Messages From Sentbox
+* we are doing this here because this saves us a bunch of checks and queries
+*/
 function clean_sentbox($num_sentbox_messages)
 {
 	global $_CLASS, $config;
@@ -226,7 +259,9 @@
 	}
 }
 
-// Check Rule against Message Informations
+/**
+* Check Rule against Message Informations
+*/
 function check_rule(&$rules, &$rule_row, &$message_row, $user_id)
 {
 	global $_CLASS, $config;
@@ -258,27 +293,32 @@
 	{
 		case ACTION_PLACE_INTO_FOLDER:
 			return array('action' => $rule_row['rule_action'], 'folder_id' => $rule_row['rule_folder_id']);
-			break;
+		break;
+
 		case ACTION_MARK_AS_READ:
 		case ACTION_MARK_AS_IMPORTANT:
 		case ACTION_DELETE_MESSAGE:
-			return array('action' => $rule_row['rule_action'], 'unread' => $row['unread'], 'important' => $row['important']);
-			break;
+			return array('action' => $rule_row['rule_action'], 'pm_unread' => $message_row['pm_unread'], 'pm_marked' => $message_row['pm_marked']);
+		break;
+
 		default:
 			return false;
+		break;
 	}
 
 	return false;
 }
 
-// Place new messages into appropiate folder
+/**
+* Place new messages into appropiate folder
+*/
 function place_pm_into_folder(&$global_privmsgs_rules, $release = false)
 {
 	global $_CLASS, $config;
 
 	if (!$_CLASS['core_user']->data['user_new_privmsg'])
 	{
-		return;
+		return 0;
 	}
 $_CLASS['core_user']->data['user_message_rules'] = 0;
 $_CLASS['core_user']->data['user_full_folder'] = FULL_FOLDER_NONE;
@@ -287,87 +327,130 @@
 	$user_message_rules = (int) $_CLASS['core_user']->data['user_message_rules'];
 	$user_id = (int) $_CLASS['core_user']->data['user_id'];
 
-	$user_rules = $zebra = array();
+	$action_ary = $move_into_folder = array();
 
+	if ($release)
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_NO_BOX . '
+			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
+				AND user_id = $user_id";
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Get those messages not yet placed into any box
+	$retrieve_sql = 'SELECT t.*, p.*, u.username, u.user_id, u.user_group as group_id
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
+		WHERE t.user_id = $user_id
+			AND p.author_id = u.user_id
+			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
+			AND t.msg_id = p.msg_id';
+
 	if ($user_message_rules)
 	{
-		$sql = 'SELECT * 
-			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . "
-			WHERE user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
+		$result = $_CLASS['core_db']->query($retrieve_sql);
 
 		while($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			$user_rules[] = $row;
+			$action_ary[$row['msg_id']][] = array('action' => false);
+			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
 		}
 		$_CLASS['core_db']->free_result($result);
-
-		if (!empty($user_rules))
-		{
-			$sql = 'SELECT zebra_id, friend, foe
-				FROM ' . ZEBRA_TABLE . "
-				WHERE user_id = $user_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$zebra[$row['zebra_id']] = $row;
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
 	}
-
-// I don't like no box
-	/*
-	if ($release)
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_NO_BOX . '
-			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . "
-				AND user_id = $user_id";
-		$_CLASS['core_db']->query($sql);
-	}
-*/
-
-	// Get those messages not yet placed into any box
-	// NOTE: Expand Group Information to all groups the user/author is in? 
-	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
-		WHERE t.user_id = $user_id
-			AND p.author_id = u.user_id
-			AND t.folder_id = " . PRIVMSGS_NO_BOX . '
-			AND t.msg_id = p.msg_id';
-	$result = $_CLASS['core_db']->query($sql);
-
-	$action_ary = $move_into_folder = array();
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$row['to']		= explode(':', $row['to_address']);
-		$row['bcc']		= explode(':', $row['bcc_address']);
-		$row['friend']	= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['friend'] : 0;
-		$row['foe']		= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['foe'] : 0;
-		$row['user_in_group'] = $_CLASS['core_user']->data['user_group'];
-		
-		// Check Rule - this should be very quick since we have all informations we need
-		$is_match = false;
-
-		foreach ($user_rules as $rule_row)
+	else
+	{
+		$user_rules = $zebra = $check_rows = array();
+		$user_ids = $memberships = array();
+
+		// First of all, grab all rules and retrieve friends/foes
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . "
+			WHERE user_id = $user_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
-			{
-				$is_match = true;
-				$action_ary[$row['msg_id']][] = $action;
-			}
+			$user_rules[] = $row;
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		if (sizeof($user_rules))
+		{
+			$sql = 'SELECT zebra_id, friend, foe
+				FROM ' . ZEBRA_TABLE . "
+				WHERE user_id = $user_id";
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$zebra[$row['zebra_id']] = $row;
+			}
+			$_CLASS['core_db']->free_result($result);
 		}
-	
-		if (!$is_match)
-		{
-			$action_ary[$row['msg_id']][] = array('action' => false);
-			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
-		}
+
+		// Now build a bare-bone check_row array
+		$result = $_CLASS['core_db']->query($retrieve_sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$check_rows[] = array_merge($row, array(
+				'to'				=> explode(':', $row['to_address']),
+				'bcc'				=> explode(':', $row['bcc_address']),
+				'friend'			=> (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['friend'] : 0,
+				'foe'				=> (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['foe'] : 0,
+				'user_in_group'		=> array($_CLASS['core_user']->data['user_group']),
+				'author_in_group'	=> array())
+			);
+
+			$user_ids[] = $row['user_id'];
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		// Retrieve user memberships
+		if (sizeof($user_ids))
+		{
+			$sql = 'SELECT *
+				FROM ' . CORE_GROUPS_MEMBERS_TABLE . '
+				WHERE user_id IN (' . implode(', ', $user_ids) . ')
+					AND member_status = '.STATUS_ACTIVE;
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$memberships[$row['user_id']][] = $row['group_id'];
+			}
+			$_CLASS['core_db']->free_result($result);
+		}
+
+		// Now place into the appropiate folder
+		foreach ($check_rows as $row)
+		{
+			// Add membership if set
+			if (isset($memberships[$row['author_id']]))
+			{
+				$row['author_in_group'] = $memberships[$row['user_id']];
+			}
+
+			// Check Rule - this should be very quick since we have all informations we need
+			$is_match = false;
+			foreach ($user_rules as $rule_row)
+			{
+				if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
+				{
+					$is_match = true;
+					$action_ary[$row['msg_id']][] = $action;
+				}
+			}
+
+			if (!$is_match)
+			{
+				$action_ary[$row['msg_id']][] = array('action' => false);
+				$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
+			}
+		}
+
+		unset($user_rules, $zebra, $check_rows, $user_ids, $memberships);
 	}
-	$_CLASS['core_db']->free_result($result);
 
 	// We place actions into arrays, to save queries.
 	$num_new = $num_unread = 0;
@@ -388,18 +471,24 @@
 			switch ($rule_ary['action'])
 			{
 				case ACTION_PLACE_INTO_FOLDER:
+					// Folder actions have precedence, so we will remove any other ones
 					$folder_action = true;
 					$_folder_id = (int) $rule_ary['folder_id'];
+					$move_into_folder = array();
 					$move_into_folder[$_folder_id][] = $msg_id;
 					$num_new++;
 				break;
 
 				case ACTION_MARK_AS_READ:
-					if ($rule_ary['unread'])
+					if ($rule_ary['pm_unread'])
 					{
 						$unread_ids[] = $msg_id;
 					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+
+					if (!$folder_action)
+					{
+						$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+					}
 				break;
 
 				case ACTION_DELETE_MESSAGE:
@@ -407,11 +496,15 @@
 				break;
 
 				case ACTION_MARK_AS_IMPORTANT:
-					if (!$rule_ary['important'])
+					if (!$rule_ary['pm_marked'])
 					{
 						$important_ids[] = $msg_id;
 					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+
+					if (!$folder_action)
+					{
+						$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+					}
 				break;
 			}
 		}
@@ -438,7 +531,7 @@
 	if (!empty($unread_ids))
 	{
 		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET unread = 0
+			SET pm_unread = 0
 			WHERE msg_id IN (' . implode(', ', $unread_ids) . ")
 				AND user_id = $user_id
 				AND folder_id = " . PRIVMSGS_NO_BOX;
@@ -449,7 +542,7 @@
 	if (!empty($important_ids))
 	{
 		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET marked = 1
+			SET pm_marked = !pm_marked
 			WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
 				AND user_id = $user_id
 				AND msg_id IN (" . implode(', ', $important_ids) . ')';
@@ -458,155 +551,126 @@
 
 	// Move into folder
 	$folder = array();
-
-	if (!empty($move_into_folder))
+	// Here we have ideally only one folder to move into
+	foreach ($move_into_folder as $folder_id => $msg_ary)
 	{
-		// Determine Full Folder Action - we need the move to folder id later eventually
-		$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
+		$dest_folder = $folder_id;
+		$full_folder_action = FULL_FOLDER_NONE;
 
-		$sql = 'SELECT folder_id, pm_count 
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action >= 0) ? ', ' . $full_folder_action : '') . ")
-				AND user_id = $user_id";
-		$result = $_CLASS['core_db']->query($sql);
+/////  KILLL
+$_CLASS['core_user']->data['message_limit'] = 0;
 
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		// Check Message Limit - we calculate with the complete array, most of the time it is one message
+		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
+		if ($_CLASS['core_user']->data['message_limit'] && $folder[$folder_id] && ($folder[$folder_id] + sizeof($msg_ary)) > $_CLASS['core_user']->data['message_limit'])
 		{
-			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
-		{
-			$sql = 'SELECT COUNT(*) as num_messages
-				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
-				WHERE user_id = $user_id
-					AND folder_id = " . PRIVMSGS_INBOX;
-
-			$result = $_CLASS['core_db']->query_limit($sql);
-			list($count) = $_CLASS['core_db']->fetch_row_num($result);
-			$_CLASS['core_db']->free_result($result);	
-
-			$folder[PRIVMSGS_INBOX] = (int) $count;
-		}
-	}
-
-	// Here we have ideally only one folder to move into
-	$message_limit = ($_CLASS['core_user']->data['user_message_limit']) ? $_CLASS['core_user']->data['user_message_limit'] : $config['pm_max_msgs'];
-
-	foreach ($move_into_folder as $folder_id => $msg_ary)
-	{
-		$dest_folder = $folder_id;
-		$full_folder_action = FULL_FOLDER_NONE;
-
-		// Check Message Limit - we calculate with the complete array, most of the time it is one message
-		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
-		if ($message_limit && $folder[$folder_id] && ($folder[$folder_id] + count($msg_ary)) > $message_limit)
-		{
+			// Determine Full Folder Action - we need the move to folder id later eventually
 			$full_folder_action = ($_CLASS['core_user']->data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']->data['user_full_folder'];
+	
+			if ($full_folder_action >= 0 && ($folder[$full_folder_action] + sizeof($msg_ary)) > $_CLASS['core_user']->data['message_limit'])
+			{
+				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
+			}
 
-			// If destination folder itself is full...
-			if ($full_folder_action >= 0 && ($folder[$full_folder_action] + count($msg_ary)) > $message_limit)
-			{
-				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
-			}
-
-			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
-			if ($full_folder_action >= 0)
-			{
-				$dest_folder = $full_folder_action;
-			}
-			elseif ($full_folder_action == FULL_FOLDER_DELETE)
-			{
-				// Delete some messages ;)
-				$sql = 'SELECT t.msg_id
-					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
-					WHERE t.msg_id = p.msg_id
-						AND t.user_id = $user_id
-						AND t.folder_id = $dest_folder
-					ORDER BY p.message_time ASC";
-				$result = $_CLASS['core_db']->query_limit($sql, (($folder[$dest_folder] + count($msg_ary)) - $message_limit));
-
-				$delete_ids = array();
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					$delete_ids[] = $row['msg_id'];
-				}
+			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
+			if ($full_folder_action >= 0)
+			{
+				$dest_folder = $full_folder_action;
+			}
+			else if ($full_folder_action == FULL_FOLDER_DELETE)
+			{
+				// Delete some messages ;)
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
+					WHERE t.msg_id = p.msg_id
+						AND t.user_id = $user_id
+						AND t.folder_id = $dest_folder
+					ORDER BY p.message_time ASC";
+				$result = $_CLASS['core_db']->query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $_CLASS['core_user']->data['message_limit']));
+
+				$delete_ids = array();
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					$delete_ids[] = $row['msg_id'];
+				}
 				$_CLASS['core_db']->free_result($result);
-				delete_pm($user_id, $delete_ids, $dest_folder);
-			}
+				delete_pm($user_id, $delete_ids, $dest_folder);
+			}
 		}
-
-		if ($full_folder_action == FULL_FOLDER_HOLD)
-		{
-			$num_not_moved += count($msg_ary);
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
-				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
-					AND user_id = $user_id
-					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-		}
-		else
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
-				SET folder_id = $dest_folder, msg_new = 0
-				WHERE folder_id = " . PRIVMSGS_NO_BOX . "
-					AND user_id = $user_id
-					AND msg_new = 1
-					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']->query($sql);
-
-			if ($dest_folder != PRIVMSGS_INBOX)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->affected_rows() . "
-					WHERE folder_id = $dest_folder
-						AND user_id = $user_id";
-				$_CLASS['core_db']->query($sql);
-			}
-			else
-			{
-				$num_new += $_CLASS['core_db']->affected_rows();
-			}
-		}
+		
+		// 
+		if ($full_folder_action == FULL_FOLDER_HOLD)
+		{
+			$num_not_moved += sizeof($msg_ary);
+
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
+				WHERE folder_id = ' . PRIVMSGS_NO_BOX . "
+					AND user_id = $user_id
+					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+		else
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
+				SET folder_id = $dest_folder, pm_new = 0
+				WHERE folder_id = " . PRIVMSGS_NO_BOX . "
+					AND user_id = $user_id
+					AND pm_new = 1
+					AND msg_id IN (" . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']->query($sql);
+
+			if ($dest_folder != PRIVMSGS_INBOX)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']->affected_rows() . "
+					WHERE folder_id = $dest_folder
+						AND user_id = $user_id";
+				$_CLASS['core_db']->query($sql);
+			}
+			else
+			{
+				$num_new += (int) $_CLASS['core_db']->affected_rows();
+			}
+		}
+	}
+
+	if (sizeof($action_ary))
+	{
+		// Move from OUTBOX to SENTBOX
+		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_SENTBOX . '
+			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql != '') ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+		
+		$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
+		$_CLASS['core_user']->data['user_new_privmsg'] -= $num_new;
+		$_CLASS['core_user']->data['user_unread_privmsg'] -= $num_unread;
 	}
-
-	if (!empty($action_ary))
-	{
-		// Move from OUTBOX to SENTBOX
-		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_SENTBOX . '
-			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql) ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-
-		$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . " SET $set_sql WHERE user_id = $user_id");
-
-		$_CLASS['core_user']->data['user_new_privmsg'] -= $num_new;
-		$_CLASS['core_user']->data['user_unread_privmsg'] -= $num_unread;
-	}
-
+
 	$_CLASS['core_db']->transaction('commit');
-
+
 	return $num_not_moved;
-}
+}	
+	
 
-// Move PM from one to another folder
-function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
+/**
+* Move PM from one to another folder
+*/
+function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
 {
 	global $_CLASS;
 	
@@ -615,13 +679,14 @@
 		$move_msg_ids = array($move_msg_ids);
 	}
 	
-	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
+	if (empty($move_msg_ids) && !in_array($dest_folder, array(PRIVMSGS_NO_BOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) && 
+		!in_array($cur_folder_id, array(PRIVMSGS_NO_BOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) && $cur_folder_id != $dest_folder)
 	{
 		return 0;
 	}
 	
 	// We have to check the destination folder ;)
-	if ($dest_folder !== PRIVMSGS_INBOX)
+	if ($dest_folder != PRIVMSGS_INBOX)
 	{
 		$sql = 'SELECT folder_id, folder_name, pm_count
 			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
@@ -635,11 +700,11 @@
 		{
 			trigger_error('NOT_AUTHORIZED');
 		}
-// is message limit per folder ?
+
 		if ($row['pm_count'] + count($move_msg_ids) > $message_limit)
 		{
 			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '<br /><br />';
-			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'">', '</a>', $row['folder_name']);
+			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('control_panel&amp;i=pm&amp;folder='.$row['folder_id']).'">', '</a>', $row['folder_name']);
 
 			trigger_error($message);
 		}
@@ -657,7 +722,7 @@
 		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) > $message_limit)
 		{
 			$message = sprintf($_CLASS['core_user']->lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']->lang['PM_INBOX']) . '<br /><br />';
-			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'">', '</a>', $_CLASS['core_user']->lang['PM_INBOX']);
+			$message .= sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="'.generate_link('control_panel&amp;i=pm&amp;folder=inbox').'">', '</a>', $_CLASS['core_user']->lang['PM_INBOX']);
 			trigger_error($message);
 		}
 	}
@@ -674,9 +739,7 @@
 	// Update pm counts
 	if ($num_moved)
 	{
-// We should maybe add moving of atleast sentbox messages, maybe
-		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
-		if ($cur_folder_id !== PRIVMSGS_INBOX)
+		if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
 		{
 			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . "
 				SET pm_count = pm_count - $num_moved
@@ -714,7 +777,7 @@
 	$_CLASS['core_db']->transaction();
 
 	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . " 
-		SET unread = $read
+		SET pm_unread = $read
 		WHERE msg_id $sql_msg
 			AND user_id = $user_id
 			AND folder_id = $folder_id";
@@ -733,7 +796,9 @@
 	$_CLASS['core_db']->transaction('commit');
 }
 
-// Handle all actions possible with marked messages
+/**
+* Handle all actions possible with marked messages
+*/
 function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
 {
 	global $_CLASS;
@@ -749,7 +814,7 @@
 
 			$mark_list = array();
 
-			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+			$sql = 'SELECT msg_id, pm_marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
 				WHERE folder_id = $cur_folder_id
 					AND user_id = $user_id
 					AND msg_id IN (" . implode(', ', $msg_ids) . ')';
@@ -757,8 +822,8 @@
 
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$row['marked'] = ($row['marked']) ? 0 : 1;
-				$mark_list[$row['marked']][] = $row['msg_id'];
+				$row['pm_marked'] = ($row['pm_marked']) ? 0 : 1;
+				$mark_list[$row['pm_marked']][] = $row['msg_id'];
 			}
 			$_CLASS['core_db']->free_result($result);
 
@@ -772,7 +837,7 @@
 			foreach ($mark_list as $mark => $ids)
 			{
 				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . "
-					SET marked = $mark
+					SET pm_marked = $mark
 					WHERE msg_id IN (" . implode(', ', $ids) . ')';
 				$_CLASS['core_db']->query($sql);
 			}
@@ -781,7 +846,12 @@
 		break;
 
 		case 'delete_marked':
-			$hidden_fields = array('marked_msg_id' => $msg_ids, 'cur_folder_id' => $cur_folder_id, 'mark_option' => 'delete_marked', 'submit_mark' => true);
+			$hidden_fields = array(
+				'marked_msg_id'		=> $msg_ids,
+				'cur_folder_id'		=> $cur_folder_id,
+				'mark_option'		=> 'delete_marked',
+				'submit_mark'		=> true
+			);
 
 			if (display_confirmation($_CLASS['core_user']->get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
 			{
@@ -792,7 +862,7 @@
 				$_CLASS['core_db']->transaction('commit');
 
 				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
-				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
+				$redirect = generate_link('control_panel&amp;i=pm&amp;folder='.$cur_folder_id);
 				$_CLASS['core_display']->meta_refresh(3, $redirect);
 				
 				trigger_error($_CLASS['core_user']->lang[$success_msg] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FOLDER'], '<a href="' . $redirect . '">', '</a>'));
@@ -815,7 +885,9 @@
 	return true;
 }
 
-// Delete PM(s)
+/**
+* Delete PM(s)
+*/
 function delete_pm($user_id, $msg_ids, $folder_id)
 {
 	global $_CLASS;
@@ -844,7 +916,7 @@
 	}
 
 	// Get PM Informations for later deleting
-	$sql = 'SELECT msg_id, unread, msg_new
+	$sql = 'SELECT msg_id, pm_unread, pm_new
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . ")
 			AND folder_id = $folder_id
@@ -856,8 +928,8 @@
 	
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$num_unread += ($row['unread']) ? 1 : 0;
-		$num_new += ($row['msg_new']) ? 1 : 0;
+		$num_unread += ($row['pm_unread']) ? 1 : 0;
+		$num_new += ($row['pm_new']) ? 1 : 0;
 
 		$delete_rows[$row['msg_id']] = 1;
 	}
@@ -892,7 +964,7 @@
 			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']->query($sql);
 
-		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
+		$num_deleted = $_CLASS['core_db']->affected_rows();
 	}
 	else
 	{
@@ -902,7 +974,7 @@
 				AND folder_id = $folder_id
 				AND msg_id IN (" . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']->query($sql);
-		$num_deleted = $_CLASS['core_db']->sql_affectedrows();
+		$num_deleted = $_CLASS['core_db']->affected_rows();
 	}
 
 	// if folder id is user defined folder then decrease pm_count
@@ -947,9 +1019,13 @@
 			WHERE msg_id IN (' . $delete_ids . ')';
 		$_CLASS['core_db']->query($sql);
 	}
+
+	return true;
 }
 
-// Rebuild message header
+/**
+* Rebuild message header
+*/
 function rebuild_header($check_ary)
 {
 	$address = array();
@@ -980,7 +1056,9 @@
 	return $address;
 }
 
-// Print out/Assign recipient informations
+/**
+* Print out/assign recipient informations
+*/
 function write_pm_addresses($check_ary, $author_id, $plaintext = false)
 {
 	global $_CLASS;
@@ -989,13 +1067,21 @@
 	
 	foreach ($check_ary as $check_type => $address_field)
 	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id => $type)
+		if (!is_array($address_field))
 		{
-			${$type}[] = (int) $match[2][$id];
+			// Split Addresses into users and groups
+			preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+	
+			$u = $g = array();
+			foreach ($match[1] as $id => $type)
+			{
+				${$type}[] = (int) $match[2][$id];
+			}
+		}
+		else
+		{
+			$u = $address_field['u'];
+			$g = $address_field['g'];
 		}
 
 		$address = array();
@@ -1080,11 +1166,11 @@
 				{
 					$_CLASS['core_template']->assign_vars_array($check_type . '_recipient', array(
 						'NAME'		=> $row['name'],
-						'IS_GROUP'	=> ($type == 'group'),
-						'IS_USER'	=> ($type == 'user'),
+						'IS_GROUP'	=> ($type === 'group'),
+						'IS_USER'	=> ($type === 'user'),
 						'COLOUR'	=> ($row['colour']) ? $row['colour'] : '',
 						'UG_ID'		=> $id,
-						'U_VIEW'	=> ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
+						'U_VIEW'	=> ($type === 'user') ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) : generate_link('members_list&amp;mode=group&amp;g=' . $id))
 					);
 				}
 			}
@@ -1096,7 +1182,9 @@
 	return $addresses;
 }
 
-// Get folder status
+/**
+* Get folder status
+*/
 function get_folder_status($folder_id, $folder)
 {
 	global $_CLASS, $config;
@@ -1125,17 +1213,19 @@
 	return $return;
 }
 
-//
-// COMPOSE MESSAGES
-//
-
-// Submit PM
+//
+// COMPOSE MESSAGES
+//
+
+/**
+* Submit PM
+*/
 function submit_pm($mode, $subject, &$data, $update_message, $put_in_outbox = true)
 {
 	global $_CLASS, $config;
 
 	// We do not handle erasing posts here
-	if ($mode == 'delete')
+	if ($mode === 'delete')
 	{
 		return;
 	}
@@ -1151,20 +1241,27 @@
 	{
 		// Build Recipient List
 		// u|g => array($user_id => 'to'|'bcc')
-		foreach (array('u', 'g') as $ug_type)
+		$_types = array('u', 'g');
+		foreach ($_types as $ug_type)
 		{
 			if (!empty($data['address_list'][$ug_type]))
 			{
 				foreach ($data['address_list'][$ug_type] as $id => $field)
 				{
-					$field = ($field == 'to') ? 'to' : 'bcc';
+					$id = (int) $id;
+
+					// Do not rely on the address list being "valid"
+					if (!$id)
+					{
+						continue;
+					}
 
+					$field = ($field === 'to') ? 'to' : 'bcc';
 					if ($ug_type == 'u')
 					{
 						$recipients[$id] = $field;
 					}
-
-					${$field}[] = $ug_type . '_' . (int) $id;
+					${$field}[] = $ug_type . '_' . $id;
 				}
 			}
 		}
@@ -1179,7 +1276,7 @@
 	
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
+				$field = ($data['address_list']['g'][$row['group_id']] === 'to') ? 'to' : 'bcc';
 				$recipients[$row['user_id']] = $field;
 			}
 			$_CLASS['core_db']->free_result($result);
@@ -1208,13 +1305,15 @@
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . '
 					AND msg_id = ' . $data['reply_from_msg_id'];
 
+		// no break
+
 		case 'forward':
 		case 'post':
 			$sql_data = array(
 				'root_level'		=> $root_level,
-				'author_id'			=> (int) $_CLASS['core_user']->data['user_id'],
+				'author_id'			=> $data['from_user_id'],
 				'icon_id'			=> $data['icon_id'], 
-				'author_ip' 		=> $_CLASS['core_user']->ip,
+				'author_ip' 		=> $data['from_user_ip'],
 				'message_time'		=> $_CLASS['core_user']->time,
 				'enable_bbcode' 	=> $data['enable_bbcode'],
 				'enable_html' 		=> $data['enable_html'],
@@ -1223,7 +1322,6 @@
 				'enable_sig' 		=> $data['enable_sig'],
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
-				'message_checksum'	=> $data['message_md5'],
 				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid'],
@@ -1243,7 +1341,6 @@
 				'enable_sig' 		=> $data['enable_sig'],
 				'message_subject'	=> $subject,
 				'message_text' 		=> $data['message'],
-				'message_checksum'	=> $data['message_md5'],
 				'message_attachment'=> (isset($data['filename_data']['physical_filename']) && !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=> $data['bbcode_bitfield'],
 				'bbcode_uid'		=> $data['bbcode_uid']
@@ -1275,20 +1372,28 @@
 		{
 			$_CLASS['core_db']->query($sql);
 		}
+		unset($sql);
 
+		$sql_array = array();
 		foreach ($recipients as $user_id => $type)
 		{
-			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'msg_id'	=> $data['msg_id'],
-				'user_id'	=> $user_id,
-				'author_id'	=> $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> PRIVMSGS_NO_BOX,
-				'msg_new'	=> 1,
-				'unread'	=> 1,
-				'forwarded'	=> ($mode == 'forward') ? 1 : 0)
-			));
+			$sql_array[] = array(
+				'msg_id'		=> (int) $data['msg_id'],
+				'user_id'		=> (int) $user_id,
+				'author_id'		=> (int) $data['from_user_id'],
+				'folder_id'		=> PRIVMSGS_NO_BOX,
+				'pm_new'		=> 1,
+				'pm_unread'		=> 1,
+				'pm_forwarded'	=> ($mode == 'forward') ? 1 : 0
+			);
 		}
 
+		if (!empty($sql_array))
+		{
+			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_array, FORUMS_PRIVMSGS_TO_TABLE);
+			unset($sql_array);
+		}
+
 		$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
 			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
 			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
@@ -1298,19 +1403,19 @@
 		if ($put_in_outbox)
 		{
 			$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'msg_id'	=> (int) $data['msg_id'],
-				'user_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'author_id'	=> (int) $_CLASS['core_user']->data['user_id'],
-				'folder_id'	=> (int) PRIVMSGS_OUTBOX,
-				'msg_new'	=> 0,
-				'unread'	=> 0,
-				'forwarded'	=> ($mode === 'forward') ? 1 : 0))
-			);
+				'msg_id'		=> (int) $data['msg_id'],
+				'user_id'		=> (int) $data['from_user_id'],
+				'author_id'		=> (int) $data['from_user_id'],
+				'folder_id'		=> PRIVMSGS_OUTBOX,
+				'pm_new'		=> 0,
+				'pm_unread'		=> 0,
+				'pm_forwarded'	=> ($mode == 'forward') ? 1 : 0)
+			));
 		}
 	}
 
 	// Set user last post time
-	if ($mode === 'reply' || $mode === 'quote' || $mode === 'forward' || $mode === 'post')
+	if ($mode === 'reply' || $mode === 'quote'|| $mode === 'quotepost' || $mode === 'forward' || $mode === 'post')
 	{
 		$sql = 'UPDATE ' . CORE_USERS_TABLE . "
 			SET user_last_post_time = {$_CLASS['core_user']->time}
@@ -1319,7 +1424,7 @@
 	}
 
 	// Submit Attachments
-	if (!empty($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
+	if (!empty($data['attachment_data']) && $data['msg_id'] && in_array($mode, array('post', 'reply', 'quote', 'quotepost', 'edit', 'forward')))
 	{
 		$space_taken = $files_added = 0;
 
@@ -1341,7 +1446,7 @@
 					'download_count'	=> 0,
 					'topic_id'			=> 0,
 					'in_message'		=> 1,
-					'poster_id'			=> $_CLASS['core_user']->data['user_id'],
+					'poster_id'			=> $data['from_user_id'],
 					'physical_filename'	=> basename($attach_row['physical_filename']),
 					'real_filename'		=> basename($attach_row['real_filename']),
 					'comment'			=> $attach_row['comment'],
@@ -1352,10 +1457,9 @@
 					'thumbnail'			=> $attach_row['thumbnail']
 				);
 
-				$_CLASS['core_db']->query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $attach_sql));
+				$_CLASS['core_db']->sql_query_build('INSERT', $attach_sql, FORUMS_ATTACHMENTS_TABLE);
 
 				$space_taken += $attach_row['filesize'];
-
 				$files_added++;
 			}
 		}
@@ -1393,17 +1497,21 @@
 	{
 	//unset($recipients[$_CLASS['core_user']->data['user_id']]);
 
-		pm_notification($mode, $_CLASS['core_user']->data['username'], $recipients, $subject, $data['message']);
+		pm_notification($mode, $data['from_username'], $recipients, $subject, $data['message']);
 	}
 
 	return $data['msg_id'];
 }
 
-// PM Notification
+/**
+* PM Notification
+*/
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
+	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']->data['user_id']]);
+
 	if (empty($recipients))
 	{
 		return;
@@ -1436,7 +1544,7 @@
 
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	require_once SITE_FILE_ROOT.'includes/mailer.php';
 	$mailer = new core_mailer;
 
 	$count = count($user_list);
@@ -1450,10 +1558,10 @@
 	$_CLASS['core_template']->assign_array(array(
 		'EMAIL_SIG'		=> $email_sig,
 		'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
-		'SUBJECT'		=> $subject,
-		'AUTHOR_NAME'	=> $author,
+		'SUBJECT'		=> html_entity_decode($subject),
+		'AUTHOR_NAME'	=> html_entity_decode($author),
 
-		'LINK_INBOX'		=> generate_link('Control_Panel&i=pm&mode=unread', array('full' => true, 'sid' => true))
+		'LINK_INBOX'	=> generate_link('control_panel&i=pm&mode=unread', array('full' => true, 'sid' => true))
 	));
 
 	$mailer->message = trim($_CLASS['core_template']->display('email/control_panel/pm_notify.txt', true));

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -66,7 +66,7 @@
 $topic_id = get_variable('t', 'REQUEST', false, 'int');;
 
 // Resync Topics
-if ($action == 'resync')
+if ($action === 'resync')
 {
 	if (empty($topic_id_list))
 	{
@@ -227,7 +227,7 @@
 	$_CLASS['core_template']->assign_vars_array('topicrow', array(
 		'U_VIEW_TOPIC'		=> generate_link("Forums&amp;file=mcp&amp;t={$row['topic_id']}&amp;mode=topic_view"),
 
-		'S_SELECT_TOPIC'	=> ($action == 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
+		'S_SELECT_TOPIC'	=> ($action === 'merge_select' && $row['topic_id'] != $topic_id) ? true : false,
 		'U_SELECT_TOPIC'	=> generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
 		'U_MCP_QUEUE'		=> $u_mcp_queue,
 		'U_MCP_REPORT'		=> generate_link("forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports"),

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -61,7 +61,7 @@
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);//generate_link('Forums')
 	$message = $_CLASS['core_user']->get_lang(strtoupper($mode) . '_' . $l_prefix . ((count($ids) === 1) ? '' : 'S'));
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		$sql_id . '_list'	=> $ids,
 		'mode'				=> $mode,
 		'redirect'			=> $redirect
@@ -138,7 +138,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=> $topic_ids,
 		'mode'			=> $mode,
 		'redirect'		=> $redirect
@@ -252,7 +252,7 @@
 		unset($_POST['confirm']);
 	}
 	
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=> $topic_ids,
 		'mode'			=> 'move',
 		'redirect'		=> $redirect
@@ -366,7 +366,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=> $topic_ids,
 		'mode'			=> 'delete_topic',
 		'redirect'		=> $redirect
@@ -414,7 +414,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']->data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'post_id_list'	=> $post_ids,
 		'mode'			=> 'delete_post',
 		'redirect'		=> $redirect
@@ -557,7 +557,7 @@
 		unset($_POST['confirm']);
 	}
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=> $topic_ids,
 		'mode'			=> 'fork',
 		'redirect'		=> $redirect

Modified: cms/trunk/includes/forums/mcp/mcp_notes.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -12,9 +12,13 @@
 
 global $_CLASS;
 
-$action = get_variable('action', 'REQUEST');
 $mode = get_variable('mode', 'REQUEST');
+$action = (isset($_REQUEST['action']) && is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
 //$this->page_title = 'MCP_NOTES';
 
 switch ($mode)
@@ -94,7 +98,7 @@
 		if ($where_sql || $deleteall)
 		{
 			$sql = 'DELETE FROM ' . FORUMS_LOG_TABLE . '
-				WHERE log_type = ' . FORUMS_LOG_USERS . " 
+				WHERE log_type = ' . LOG_USERS . " 
 					AND reportee_id = $user_id
 					$where_sql";
 			$_CLASS['core_db']->query($sql);
@@ -169,8 +173,8 @@
 				'REPORT_AT'		=> $_CLASS['core_user']->format_date($row['time']),
 				'ACTION'		=> $row['action'],
 				'IP'			=> $row['ip'],
-				'ID'			=> $row['id'])
-			);
+				'ID'			=> $row['id']
+			));
 		}
 	}
 

Modified: cms/trunk/includes/forums/mcp/mcp_post.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -27,8 +27,13 @@
 $_CLASS['core_user']->add_lang('posting');
 
 $post_id = get_variable('p', 'REQUEST', false, 'int');
-$action = get_variable('action', 'REQUEST');
+$action = (isset($_REQUEST['action']) && is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
+
 if (!$post_id && $action !== 'whois')
 {
 	trigger_error('POST_NOT_EXIST');
@@ -45,7 +50,7 @@
 	}
 	$post_info = $post_info[$post_id];
 	
-	$url = 'forums&amp;file=mcp';
+	$url = 'forums&amp;file=mcp&amp;p='.$post_info['post_id'];
 	$start	= get_variable('start', 'REQUEST', 0, 'int');
 }
 
@@ -122,7 +127,7 @@
 $message = str_replace("\n", '<br />', $message);
 
 $_CLASS['core_template']->assign_array(array(
-	'U_MCP_ACTION'			=> generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
+	'U_MCP_ACTION'			=> generate_link($url.'&amp;quickmod=1'), // Use this for mode paramaters
 	'U_POST_ACTION'			=> generate_link("$url&amp;mode=post_details"), // Use this for action parameters
 	'U_APPROVE_ACTION'		=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;p='.$post_info['post_id']),
 
@@ -231,7 +236,7 @@
 	$rdns_ip_num = get_variable('rdns', 'REQUEST');
 	$users_ary = array();
 
-	$_CLASS['core_template']->assign('U_LOOKUP_ALL', ($rdns_ip_num === 'all') ? false : generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all&amp;p='.$post_info['post_id']));
+	$_CLASS['core_template']->assign('U_LOOKUP_ALL', ($rdns_ip_num === 'all') ? false : generate_link($url.'&amp;mode=post_details&amp;rdns=all&amp;p='.$post_info['post_id']));
 
 	// Get other users who've posted under this IP
 	$sql = 'SELECT u.user_id, u.username, COUNT(*) as postings

Modified: cms/trunk/includes/forums/mcp/mcp_queue.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -28,9 +28,13 @@
 
 $forum_id = request_var('f', 0);
 $start = request_var('start', 0);
-$action = get_variable('action', 'REQUEST');
+$action = (isset($_REQUEST['action']) && is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 $mode = get_variable('mode', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
 
 switch ($action)
 {
@@ -45,7 +49,7 @@
 			trigger_error('NO_POST_SELECTED');
 		}
 
-		($mode === 'approve') ? approve_post($post_id_list, $mode) : disapprove_post($post_id_list, $mode);
+		($action === 'approve') ? approve_post($post_id_list, $mode) : disapprove_post($post_id_list, $mode);
 	break;
 }
 
@@ -64,7 +68,7 @@
 			$post_id = isset($topic_info[$topic_id]['topic_first_post_id']) ? (int) $topic_info[$topic_id]['topic_first_post_id'] : false;
 		}
 
-		$post_info = ($post_id/) ? get_post_data(array($post_id), 'm_approve') : false;
+		$post_info = ($post_id) ? get_post_data(array($post_id), 'm_approve') : false;
 
 		if (!$post_id || empty($post_info[$post_id]))
 		{
@@ -90,15 +94,16 @@
 		$poster = ($post_info['user_colour']) ? '<span style="color:#' . $post_info['user_colour'] . '">' . $post_info['username'] . '</span>' : $post_info['username'];
 
 		// Process message, leave it uncensored
-		$message = $post_info['post_text'];
+		$post_info['post_text'] = $post_info['post_text'];
+
 		if ($post_info['bbcode_bitfield'])
 		{
 			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 
 			$bbcode = new bbcode($post_info['bbcode_bitfield']);
-			$bbcode->bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+			$bbcode->bbcode_second_pass($post_info['post_text'], $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
 		}
-		$message = smiley_text($message);
+		$post_info['post_text'] = smiley_text($post_info['post_text']);
 
 		$_CLASS['core_template']->assign_array(array(
 			'S_MCP_QUEUE'			=> true,
@@ -118,13 +123,13 @@
 			'U_VIEW_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
 			'U_VIEW_TOPIC'			=> generate_link('forums&amp;file=viewtopic&amp;t=' . $post_info['topic_id']),
 
-			'RETURN_QUEUE'			=> sprintf($_CLASS['core_user']->lang['RETURN_QUEUE'], '<a href="' . generate_link('forums&amp;file=mcp&amp;i=queue' . (($topic_id) ? '&amp;mode=unapproved_topics' : '&amp;mode=unapproved_posts')) . "&amp;start=$start\">", '</a>'),
+			'RETURN_QUEUE'			=> sprintf($_CLASS['core_user']->get_lang('RETURN_QUEUE'), '<a href="' . generate_link('forums&amp;file=mcp&amp;i=queue' . (($topic_id) ? '&amp;mode=unapproved_topics' : '&amp;mode=unapproved_posts')) . "&amp;start=$start\">", '</a>'),
 			'REPORTED_IMG'			=> $_CLASS['core_user']->img('icon_reported', $_CLASS['core_user']->lang['POST_REPORTED']),
 			'UNAPPROVED_IMG'		=> $_CLASS['core_user']->img('icon_unapproved', $_CLASS['core_user']->lang['POST_UNAPPROVED']),
 			'EDIT_IMG'				=> $_CLASS['core_user']->img('btn_edit', $_CLASS['core_user']->lang['EDIT_POST']),
 
 			'POSTER_NAME'			=> $poster,
-			'POST_PREVIEW'			=> $message,
+			'POST_PREVIEW'			=> $post_info['post_text'],
 			'POST_SUBJECT'			=> $post_info['post_subject'],
 			'POST_DATE'				=> $_CLASS['core_user']->format_date($post_info['post_time']),
 			'POST_IP'				=> $post_info['poster_ip'],
@@ -201,7 +206,7 @@
 		$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
 		$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
-		if ($mode == 'unapproved_posts')
+		if ($mode === 'unapproved_posts')
 		{
 			$sql = 'SELECT DISTINCT p.post_id
 				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . CORE_USERS_TABLE . ' u' : '') . "
@@ -308,17 +313,17 @@
 		}
 		unset($rowset);
 
-		$pagination = generate_pagination('forums&amp;file=mcp&amp;f='.$forum_id, $total, $config['topics_per_page'], $start)
+		$pagination = generate_pagination('forums&amp;file=mcp&amp;f='.$forum_id, $total, $config['topics_per_page'], $start);
 
 		// Now display the page
 		$_CLASS['core_template']->assign_array(array(
-			'L_DISPLAY_ITEMS'		=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['DISPLAY_POSTS'] : $_CLASS['core_user']->lang['DISPLAY_TOPICS'],
-			'L_EXPLAIN'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN'] : $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'],
-			'L_TITLE'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_POSTS'] : $_CLASS['core_user']->lang['MCP_QUEUE_UNAPPROVED_TOPICS'],
+			'L_DISPLAY_ITEMS'		=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->get_lang('DISPLAY_POSTS') : $_CLASS['core_user']->get_lang('DISPLAY_TOPICS'),
+			'L_EXPLAIN'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->get_lang('MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN') : $_CLASS['core_user']->get_lang('MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'),
+			'L_TITLE'				=> ($mode === 'unapproved_posts') ? $_CLASS['core_user']->get_lang('MCP_QUEUE_UNAPPROVED_POSTS') : $_CLASS['core_user']->get_lang('MCP_QUEUE_UNAPPROVED_TOPICS'),
 			'L_ONLY_TOPIC'			=> ($topic_id) ? sprintf($_CLASS['core_user']->lang['ONLY_TOPIC'], $topic_info['topic_title']) : '',
 
 			'S_FORUM_OPTIONS'		=> $forum_options,
-			'S_MCP_ACTION'			=> build_url(array('t', 'f', 'sd', 'st', 'sk')),
+			'S_MCP_ACTION'			=> generate_link("forums&amp;file=mcp&amp;i=queue&amp;t=$topic_id&amp;f=$forum_id"),//build_url(array('t', 'f', 'sd', 'st', 'sk')),
 			'S_TOPICS'				=> ($mode === 'unapproved_posts') ? false : true,
 
 			'PAGINATION'			=> $pagination['formated'],
@@ -340,7 +345,9 @@
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
+	$forum_id = request_var('f', 0);
+
+	if (!check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
@@ -349,15 +356,20 @@
 	$success_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
-		'i'				=> 'queue',
+		'i'				=> 'queue',
+		'f'				=> $forum_id,
 		'mode'			=> $mode,
 		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
 		'action'		=> 'approve',
 		'redirect'		=> $redirect
 	));
 
-	if (confirm_box(true))
+	$_CLASS['core_template']->assign_array(array(
+		'S_NOTIFY_POSTER'	=> true,
+		'S_APPROVE'			=> true
+	));
+
+	if (display_confirmation($_CLASS['core_user']->get_lang('APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S')), $s_hidden_fields, 'modules/forums/mcp_approve.html'))
 	{
 		$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
 	
@@ -459,48 +471,55 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-/*		$messenger = new messenger();
-
 		// Notify Poster?
 		if ($notify_poster)
 		{
-			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
+			require_once SITE_FILE_ROOT.'includes/mailer.php';
+
+			$mailer = new core_mailer();
+
 			foreach ($post_info as $post_id => $post_data)
 			{
 				if ($post_data['poster_id'] == ANONYMOUS)
 				{
 					continue;
 				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_approved' : 'post_approved';
 
-				$messenger->template($email_template, $post_data['user_lang']);
+				$post_data['post_subject'] = censor_text($post_data['post_subject'], true);
+				$post_data['topic_title'] = censor_text($post_data['topic_title'], true);
 
-				$messenger->replyto($config['board_email']);
-				$messenger->to($post_data['user_email'], $post_data['username']);
-				$messenger->im($post_data['user_jabber'], $post_data['username']);
+				if ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id'])
+				{
+					$email_template = 'topic_approved.txt';
+					$subject = 'Topic Approved - '.$post_data['topic_title'];
+				}
+				else
+				{
+					$email_template = 'post_approved.txt';
+					$subject = 'Post Approved - '.$post_data['post_subject'];
+				}
 
-				$messenger->assign_vars(array(
-					'EMAIL_SIG'		=> $email_sig,
-					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
+				$mailer->to($post_data['user_email'], $post_data['username']);
+				//$mailer->reply_to($_CORE_CONFIG['email']['site_email']);
+				$mailer->subject($subject);
+				//$messenger->im($post_data['user_jabber'], $post_data['username']);
+
+				$_CLASS['core_template']->assign_array(array(
+					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 					'USERNAME'		=> $post_data['username'],
-					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']),
+					'POST_SUBJECT'	=> $post_data['post_subject'],
+					'TOPIC_TITLE'	=> $post_data['topic_title'],
 
-					'U_VIEW_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;f=$forum_id&t={$post_data['topic_id']}&e=0"),
-					'U_VIEW_POST'	=> generate_link("forums&amp;file=viewtopic7amp;f=$forum_id&t={$post_data['topic_id']}&p=$post_id&e=$post_id"))
-				);
+					'U_VIEW_TOPIC'	=> generate_link("forums&amp;file=viewtopic&amp;t={$post_data['topic_id']}&amp;e=0"),
+					'U_VIEW_POST'	=> generate_link("forums&amp;file=viewtopic&amp;p=$post_id&amp;e=$post_id")
+				));
 
-				$messenger->send($post_data['user_notify_type']);
-				$messenger->reset();
+				$mailer->message = trim($_CLASS['core_template']->display('email/forums/'.$email_template, true));
+				$mailer->send();
 			}
-			$messenger->save_queue();
 		}
-*/
+
 		// Send out normal user notifications
-		$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
 		foreach ($post_info as $post_id => $post_data)
 		{
 			if ($post_id == $post_data['topic_first_post_id'] && $post_id == $post_data['topic_last_post_id'])
@@ -525,16 +544,7 @@
 			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_APPROVED_SUCCESS' : 'POSTS_APPROVED_SUCCESS';
 		}
 	}
-	else
-	{
-		$_CLASS['core_template']->assign_array(array(
-			'S_NOTIFY_POSTER'	=> true,
-			'S_APPROVE'			=> true)
-		);
 
-		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'modules/forums/mcp_approve.html');
-	}
-
 	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)
@@ -551,11 +561,13 @@
 /**
 * Disapprove Post/Topic
 */
-function disapprove_post($post_id_list)
+function disapprove_post($post_id_list, $mode)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
+	$forum_id = request_var('f', 0);
+
+	if (!check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
@@ -566,10 +578,10 @@
 	$success_msg = $additional_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
-		'i'				=> 'queue',
+		'i'				=> 'queue',
+		'f'				=> $forum_id,
 		'mode'			=> $mode,
 		'post_id_list'	=> $post_id_list,
-		'f'				=> $forum_id,
 		'mode'			=> 'disapprove',
 		'redirect'		=> $redirect
 	));
@@ -599,7 +611,18 @@
 		}
 	}
 
-	if (confirm_box(true))
+	require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
+	$reason = display_reasons($reason_id);
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_NOTIFY_POSTER'	=> true,
+		'S_APPROVE'			=> false,
+		'REASON'			=> $reason,
+		'ADDITIONAL_MSG'	=> $additional_msg
+	));
+
+	if (display_confirmation($_CLASS['core_user']->get_lang('DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S')), $s_hidden_fields, 'modules/forums/mcp_approve.html'))
 	{
 		$post_info = get_post_data($post_id_list, 'm_approve');
 		
@@ -671,42 +694,51 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-		/*$messenger = new messenger();
-
 		// Notify Poster?
 		if ($notify_poster)
 		{
-			$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
-		
+			require_once SITE_FILE_ROOT.'includes/mailer.php';
+
+			$mailer = new core_mailer();
+
 			foreach ($post_info as $post_id => $post_data)
 			{
 				if ($post_data['poster_id'] == ANONYMOUS)
 				{
 					continue;
 				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_disapproved' : 'post_disapproved';
 
-				$messenger->template($email_template, $post_data['user_lang']);
+				$post_data['post_subject'] = censor_text($post_data['post_subject'], true);
+				$post_data['topic_title'] = censor_text($post_data['topic_title'], true);
 
-				$messenger->replyto($config['board_email']);
-				$messenger->to($post_data['user_email'], $post_data['username']);
-				$messenger->im($post_data['user_jabber'], $post_data['username']);
+				if ($post_data['post_id'] == $post_data['topic_first_post_id'] && $post_data['post_id'] == $post_data['topic_last_post_id'])
+				{
+					$email_template = 'topic_disapproved.txt';
+					$subject = 'Topic Disapproved - '.$post_data['topic_title'];
+				}
+				else
+				{
+					$email_template = 'post_disapproved.txt';
+					$subject = 'Post Disapproved - '.$post_data['post_subject'];
+				}
 
-				$messenger->assign_vars(array(
-					'EMAIL_SIG'		=> $email_sig,
-					'SITENAME'		=> $_CORE_CONFIG['global']['sitename'],
+				$mailer->to($post_data['user_email'], $post_data['username']);
+				//$mailer->reply_to($_CORE_CONFIG['email']['site_email']);
+				$mailer->subject($subject);
+				//$messenger->im($post_data['user_jabber'], $post_data['username']);
+
+				$_CLASS['core_template']->assign_array(array(
+					'SITENAME'		=> $_CORE_CONFIG['global']['site_name'],
 					'USERNAME'		=> $post_data['username'],
 					'REASON'		=> stripslashes($disapprove_reason),
-					'POST_SUBJECT'	=> censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=> censor_text($post_data['topic_title']))
-				);
+					'POST_SUBJECT'	=> $post_data['post_subject'],
+					'TOPIC_TITLE'	=> $post_data['topic_title'],
+				));
 
-				$messenger->send($post_data['user_notify_type']);
-				$messenger->reset();
+				$mailer->message = trim($_CLASS['core_template']->display('email/forums/'.$email_template, true));
+				$mailer->send();
 			}
-			$messenger->save_queue();
-		}*/
+		}
 		unset($post_info, $disapprove_reason);
 
 		if ($forum_topics_real)
@@ -718,22 +750,7 @@
 			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_DISAPPROVED_SUCCESS' : 'POSTS_DISAPPROVED_SUCCESS';
 		}
 	}
-	else
-	{
-		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
-
-		display_reasons($reason_id);
-
-		$_CLASS['core_template']->assign_array(array(
-			'S_NOTIFY_POSTER'	=> true,
-			'S_APPROVE'			=> false,
-			'REASON'			=> $reason,
-			'ADDITIONAL_MSG'	=> $additional_msg
-		));
 
-		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
-	}
-
 	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -63,27 +63,52 @@
 $to_forum_id = get_variable('to_forum_id', 'REQUEST', false, 'int');
 $post_id_list = array_unique(get_variable('post_id_list', 'REQUEST', array(), 'array:int'));
 
-// Split Topic?
-if ($action === 'split_all' || $action === 'split_beyond')
+switch ($action)
 {
-	if ($message = split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject))
-	{
-		$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->get_lang($message));
-	}
+	case 'lock_post':
+	case 'unlock_post':
+		$post_ids = get_post_ids($quick_mod);
 
-	$action = 'split';
-}
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
 
-// Merge Posts?
-if ($action == 'merge_posts')
-{
-	merge_posts($topic_id, $to_topic_id);
-	$action = 'merge';
-}
+		require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
 
-if ($action === 'split' && !$subject)
-{
-	$subject = $topic_info['topic_title'];
+		lock_unlock($action, $post_ids);
+	break;
+
+	case 'delete_post':
+		$_CLASS['core_user']->add_lang('posting');
+
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
+
+		mcp_delete_post($post_ids);
+	break;
+
+	case 'split_all':
+	case 'split_beyond':
+		if ($message = split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject))
+		{
+			$_CLASS['core_template']->assign('MESSAGE', $_CLASS['core_user']->get_lang($message));
+		}
+	
+		$action = 'split';
+		$subject = ($subject) ? $subject : $topic_info['topic_title'];
+	break;
+
+	case 'merge_posts':
+		merge_posts($topic_id, $to_topic_id);
+		$action = 'merge';
+	break;
 }
 
 $topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
@@ -117,7 +142,7 @@
 while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 {
 	$rowset[] = $row;
-	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 }
 $_CLASS['core_db']->free_result($result);
 
@@ -223,7 +248,7 @@
 	'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'POST_REPORTED', false, true),
 	'UNAPPROVED_IMG'	=> $_CLASS['core_user']->img('icon_unapproved', 'POST_UNAPPROVED', false, true),
 
-	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode&amp;action=$action".(($start) ? '&amp;start='.$start : '')),
+	'S_MCP_ACTION'		=> generate_link("$url&amp;mode=$mode".(($start) ? '&amp;start='.$start : '')),
 	'S_FORUM_SELECT'	=> '<select name="to_forum_id">' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '</select>',
 	'S_CAN_SPLIT'		=> $_CLASS['forums_auth']->acl_get('m_split', $topic_info['forum_id']),
 	'S_CAN_MERGE'		=> $_CLASS['forums_auth']->acl_get('m_merge', $topic_info['forum_id']),
@@ -250,7 +275,7 @@
 
 $_CLASS['core_display']->display($_CLASS['core_user']->get_lang('MCP'), 'modules/forums/mcp_topic.html');
 
-function split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject)
+function split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject)
 {
 	global $_CLASS;
 
@@ -268,6 +293,7 @@
 	{
 		return 'NO_POST_SELECTED';
 	}
+	$post_info = $post_info[$post_id];
 
 	$subject = trim($subject);
 
@@ -301,7 +327,7 @@
 		'post_id_list'	=> $post_id_list,
 		'mode'			=> 'topic_view',
 		'start'			=> $start,
-		'action'		=> $mode,
+		'action'		=> $action,
 		't'				=> $topic_id,
 		'redirect'		=> $redirect,
 		'subject'		=> $subject,
@@ -309,18 +335,18 @@
 		'icon'			=> get_variable('icon', 'REQUEST', false, 'int')
 	));
 
-	$message = ($mode === 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
+	$message = ($action === 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
 
 	if (display_confirmation($_CLASS['core_user']->get_lang($message), $hidden_fields))
 	{
-		if ($mode === 'split_beyond')
+		if ($action === 'split_beyond')
 		{
-			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
+			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $post_info['forum_id'], $topic_id);
 			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time >= ' . ($_CLASS['core_user']->time - ($sort_days * 86400)) : '';
 
 			if ($sort_order_sql{0} == 'u')
 			{
-				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+				$sql = 'SELECT p.post_id
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
 					WHERE p.topic_id = $topic_id
 						AND p.poster_id = u.user_id
@@ -329,7 +355,7 @@
 			}
 			else
 			{
-				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+				$sql = 'SELECT p.post_id
 					FROM ' . FORUMS_POSTS_TABLE . " p
 					WHERE p.topic_id = $topic_id
 						$limit_time_sql
@@ -344,11 +370,8 @@
 			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
 				// Start to store post_ids as soon as we see the first post that was selected
-				if ($row['post_id'] == $post_id)
+				if ($row['post_id'] === $post_id)
 				{
-					$topic_time = $row['post_time'];
-					$topic_poster = $row['poster_id'];
-					$topic_poster_name = $row['post_username'];
 					$store = true;
 				}
 
@@ -365,7 +388,7 @@
 			trigger_error('NO_POST_SELECTED');
 		}
 
-		$icon_id =  get_variable('icon', 'REQUEST', false, 'int');
+		$icon_id = get_variable('icon', 'REQUEST', 0, 'int');
 
 		$_CLASS['core_db']->transaction();
 
@@ -374,9 +397,9 @@
 			'topic_title'				=> $subject,
 			'icon_id'					=> $icon_id,
 			'topic_approved'			=> 1,
-			'topic_poster' 				=> $topic_poster,
-			'topic_first_poster_name'	=> $topic_poster_name,
-			'topic_time'				=> $_CLASS['core_user']->time,
+			'topic_poster' 				=> $post_info['poster_id'],
+			'topic_first_poster_name'	=> $post_info['post_username'],
+			'topic_time'				=> $_CLASS['core_user']->time,//$post_info['post_time']
 			'topic_status'				=> ITEM_UNLOCKED,
 			'topic_type'				=> POST_NORMAL,
 			'topic_attachment'			=> 0,

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/message_parser.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -48,9 +48,10 @@
 		}
 
 		global $_CLASS;
-		$this->bbcode_bitfield = 0;
+		$this->bbcode_bitfield = '';
+		$bitfield = new bitfield();
 
-		$size = strlen($this->message);
+		$size = mb_strlen($this->message);
 		foreach ($this->bbcodes as $bbcode_name => $bbcode_data)
 		{
 			if (isset($bbcode_data['disabled']) && $bbcode_data['disabled'])
@@ -74,16 +75,38 @@
 
 			// Because we add bbcode_uid to all tags, the message length
 			// will increase whenever a tag is found
-			$new_size = strlen($this->message);
+			$new_size = mb_strlen($this->message);
 
-			if ($size != $new_size)
+			if ($size !== $new_size)
 			{
-				$this->bbcode_bitfield |= (1 << $bbcode_data['bbcode_id']);
+				$bitfield->set($bbcode_data['bbcode_id']);
 				$size = $new_size;
 			}
 		}
+
+		$this->bbcode_bitfield = $bitfield->get_base64();
 	}
 
+	/**
+	* Prepare some bbcodes for better parsing
+	*/
+	function prepare_bbcodes()
+	{
+		// Add newline at the end and in front of each quote block to prevent parsing errors (urls, smilies, etc.)
+		if (strpos($this->message, '[quote') !== false)
+		{
+			$in = str_replace("\r\n", "\n", $this->message);
+
+			$this->message = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array("[quote\\1]\n\\2", "\\1\n[/quote]"), $this->message);
+			$this->message = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array("[quote\\1]\n\\2", "\\1\n[/quote]"), $this->message);
+		}
+
+		// Add other checks which needs to be placed before actually parsing anything (be it bbcodes, smilies, urls...)
+	}
+
+	/**
+	* Init bbcode data for later parsing
+	*/
 	function bbcode_init()
 	{
 		static $rowset;
@@ -91,33 +114,37 @@
 		// This array holds all bbcode data. BBCodes will be processed in this
 		// order, so it is important to keep [code] in first position and
 		// [quote] in second position.
-		$this->bbcodes = array(
-			'code'		=>	array('bbcode_id' => 8, 'regexp' => array('#\[code(?:=([a-z]+))?\](.+\[/code\])#ise' => "\$this->bbcode_code('\$1', '\$2')")),
-			'quote'		=>	array('bbcode_id' => 0, 'regexp' => array('#\[quote(?:=&quot;(.*?)&quot;)?\](.+)\[/quote\]#ise' => "\$this->bbcode_quote('\$0')")),
-			'attachment'=>	array('bbcode_id' => 12, 'regexp' => array('#\[attachment=([0-9]+)\](.*?)\[/attachment\]#ise' => "\$this->bbcode_attachment('\$1', '\$2')")),
-			'b'			=>	array('bbcode_id' => 1, 'regexp' => array('#\[b\](.*?)\[/b\]#ise' => "\$this->bbcode_strong('\$1')")),
-			'i'			=>	array('bbcode_id' => 2, 'regexp' => array('#\[i\](.*?)\[/i\]#ise' => "\$this->bbcode_italic('\$1')")),
-			'url'		=>	array('bbcode_id' => 3, 'regexp' => array('#\[url(=(.*))?\](.*)\[/url\]#ie' => "\$this->validate_url('\$2', '\$3')")),
-			'img'		=>	array('bbcode_id' => 4, 'regexp' => array('#\[img\](https?://)([a-z0-9\-\.,\?!%\*_:;~\\&$@/=\+]+)\[/img\]#ie' => "\$this->bbcode_img('\$1\$2')")),
-			'size'		=>	array('bbcode_id' => 5, 'regexp' => array('#\[size=([\-\+]?[1-2]?[0-9])\](.*?)\[/size\]#ise' => "\$this->bbcode_size('\$1', '\$2')")),
-			'color'		=>	array('bbcode_id' => 6, 'regexp' => array('!\[color=(#[0-9A-F]{6}|[a-z\-]+)\](.*?)\[/color\]!ise' => "\$this->bbcode_color('\$1', '\$2')")),
-			'u'			=>	array('bbcode_id' => 7, 'regexp' => array('#\[u\](.*?)\[/u\]#ise' => "\$this->bbcode_underline('\$1')")),
-			'list'		=>	array('bbcode_id' => 9, 'regexp' => array('#\[list(=[a-z|0-9|(?:disc|circle|square))]+)?\].*\[/list\]#ise' => "\$this->bbcode_parse_list('\$0')")),
-			'email'		=>	array('bbcode_id' => 10, 'regexp' => array('#\[email=?(.*?)?\](.*?)\[/email\]#ise' => "\$this->validate_email('\$1', '\$2')")),
-			'flash'		=>	array('bbcode_id' => 11, 'regexp' => array('#\[flash=([0-9]+),([0-9]+)\](.*?)\[/flash\]#ie' => "\$this->bbcode_flash('\$1', '\$2', '\$3')"))
-		);
+		$this->bbcodes = array(
+			'code'			=> array('bbcode_id' => 8,	'regexp' => array('#\[code(?:=([a-z]+))?\](.+\[/code\])#ise' => "\$this->bbcode_code('\$1', '\$2')")),
+			'quote'			=> array('bbcode_id' => 0,	'regexp' => array('#\[quote(?:=&quot;(.*?)&quot;)?\](.+)\[/quote\]#ise' => "\$this->bbcode_quote('\$0')")),
+			'attachment'	=> array('bbcode_id' => 12,	'regexp' => array('#\[attachment=([0-9]+)\](.*?)\[/attachment\]#ise' => "\$this->bbcode_attachment('\$1', '\$2')")),
+			'b'				=> array('bbcode_id' => 1,	'regexp' => array('#\[b\](.*?)\[/b\]#ise' => "\$this->bbcode_strong('\$1')")),
+			'i'				=> array('bbcode_id' => 2,	'regexp' => array('#\[i\](.*?)\[/i\]#ise' => "\$this->bbcode_italic('\$1')")),
+			'url'			=> array('bbcode_id' => 3,	'regexp' => array('#\[url(=(.*))?\](.*)\[/url\]#iUe' => "\$this->validate_url('\$2', '\$3')")),
+			'img'			=> array('bbcode_id' => 4,	'regexp' => array('#\[img\](https?://)([a-z0-9\-\.,\?!%\*_:;~\\&$@/=\+]+)\[/img\]#ie' => "\$this->bbcode_img('\$1\$2')")),
+			'size'			=> array('bbcode_id' => 5,	'regexp' => array('#\[size=([\-\+]?[1-2]?[0-9])\](.*?)\[/size\]#ise' => "\$this->bbcode_size('\$1', '\$2')")),
+			'color'			=> array('bbcode_id' => 6,	'regexp' => array('!\[color=(#[0-9A-Fa-f]{6}|[a-z\-]+)\](.*?)\[/color\]!ise' => "\$this->bbcode_color('\$1', '\$2')")),
+			'u'				=> array('bbcode_id' => 7,	'regexp' => array('#\[u\](.*?)\[/u\]#ise' => "\$this->bbcode_underline('\$1')")),
+			'list'			=> array('bbcode_id' => 9,	'regexp' => array('#\[list(=[a-z|0-9|(?:disc|circle|square))]+)?\].*\[/list\]#ise' => "\$this->bbcode_parse_list('\$0')")),
+			'email'			=> array('bbcode_id' => 10,	'regexp' => array('#\[email=?(.*?)?\](.*?)\[/email\]#ise' => "\$this->validate_email('\$1', '\$2')")),
+			'flash'			=> array('bbcode_id' => 11,	'regexp' => array('#\[flash=([0-9]+),([0-9]+)\](.*?)\[/flash\]#ie' => "\$this->bbcode_flash('\$1', '\$2', '\$3')"))
+		);
 		
-		$this->parsed_items = array('code' => 0, 'quote' => 0, 'attachment' => 0, 'b' => 0, 'i' => 0, 'url' => 0, 'img' => 0, 'size' => 0, 'color' => 0, 'u' => 0, 'list' => 0, 'email' => 0, 'flash' => 0);
+		// Zero the parsed items array
+		$this->parsed_items = array();
+
+		foreach ($this->bbcodes as $tag => $bbcode_data)
+		{
+			$this->parsed_items[$tag] = 0;
+		}
 		
-		/*
-		if (!is_array($rowset))
+		/*if (!is_array($rowset))
 		{
 			$rowset = array();
 
-			
 			global $_CLASS;
 
-			$sql = 'SELECT bbcode_id, bbcode_tag, first_pass_match, first_pass_replace
+			$sql = 'SELECT *
 				FROM ' . FORUMS_BBCODES_TABLE;
 
 			$result = $_CLASS['core_db']->query($sql);
@@ -126,26 +153,30 @@
 				$rowset[] = $row;
 			}
 			$_CLASS['core_db']->free_result($result);
-			
 		}
-		
-		foreach ($rowset as $row)
-		{
-			$this->bbcodes[$row['bbcode_tag']] = array(
-				'bbcode_id'	=>	intval($row['bbcode_id']),
-				'regexp'	=>	array($row['first_pass_match'] => str_replace('$uid', $this->bbcode_uid, $row['first_pass_replace']))
-			);
-		}
-		*/
+
+		foreach ($rowset as $row)
+		{
+			$this->bbcodes[$row['bbcode_tag']] = array(
+				'bbcode_id'	=> (int) $row['bbcode_id'],
+				'regexp'	=> array($row['first_pass_match'] => str_replace('$uid', $this->bbcode_uid, $row['first_pass_replace']))
+			);
+		}*/
 	}
-	
+
+	/**
+	* Making some pre-checks for bbcodes as well as increasing the number of parsed items
+	*/
 	function check_bbcode($bbcode, &$in)
 	{
-		$in = str_replace("\r\n", "\n", str_replace('\"', '"', trim($in)));
+		// when using the /e modifier, preg_replace slashes double-quotes but does not
+		// seem to slash anything else
+		$in = str_replace("\r\n", "\n", str_replace('\"', '"', $in));
 
-		if (!$in)
-		{
-			return false;
+		// Trimming here to make sure no empty bbcodes are parsed accidently
+		if (trim($in) == '')
+		{
+			return false;
 		}
 		
 		$this->parsed_items[$bbcode]++;
@@ -153,99 +184,191 @@
 		return true;
 	}
 
-	function bbcode_size($stx, $in)
-	{
-		if (!$this->check_bbcode('size', $in))
-		{
-			return '';
+	/**
+	* Transform some characters in valid bbcodes
+	*/
+	function bbcode_specialchars($text)
+	{
+		$str_from = array('<', '>', '[', ']', '.', ':');
+		$str_to = array('&lt;', '&gt;', '&#91;', '&#93;', '&#46;', '&#58;');
+
+		return str_replace($str_from, $str_to, $text);
+	}
+
+	/**
+	* Parse size tag
+	*/
+	function bbcode_size($stx, $in)
+	{
+		if (!$this->check_bbcode('size', $in))
+		{
+			return '';
 		}
-		
-		return '[size=' . $stx . ':' . $this->bbcode_uid . ']' . $in . '[/size:' . $this->bbcode_uid . ']';
+
+		/*global $_CLASS, $config;
+		if ($config['max_' . $this->mode . '_font_size'] && $config['max_' . $this->mode . '_font_size'] < $stx)
+		{
+			$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['MAX_FONT_SIZE_EXCEEDED'], $config['max_' . $this->mode . '_font_size']);
+		}*/
+
+		return '[size=' . $stx . ':' . $this->bbcode_uid . ']' . $in . '[/size:' . $this->bbcode_uid . ']';
 	}
 
-	function bbcode_color($stx, $in)
-	{
-		if (!$this->check_bbcode('color', $in))
-		{
-			return '';
-		}
-
-		return '[color=' . $stx . ':' . $this->bbcode_uid . ']' . $in . '[/color:' . $this->bbcode_uid . ']';
+	/**
+	* Parse color tag
+	*/
+	function bbcode_color($stx, $in)
+	{
+		if (!$this->check_bbcode('color', $in))
+		{
+			return '';
+		}
+
+		return '[color=' . $stx . ':' . $this->bbcode_uid . ']' . $in . '[/color:' . $this->bbcode_uid . ']';
 	}
-	
-	function bbcode_underline($in)
-	{
-		if (!$this->check_bbcode('u', $in))
-		{
-			return '';
-		}
 
-		return '[u:' . $this->bbcode_uid . ']' . $in . '[/u:' . $this->bbcode_uid . ']';
+	/**
+	* Parse u tag
+	*/
+	function bbcode_underline($in)
+	{
+		if (!$this->check_bbcode('u', $in))
+		{
+			return '';
+		}
+
+		return '[u:' . $this->bbcode_uid . ']' . $in . '[/u:' . $this->bbcode_uid . ']';
 	}
 
-	function bbcode_strong($in)
-	{
-		if (!$this->check_bbcode('b', $in))
-		{
-			return '';
-		}
-
-		return '[b:' . $this->bbcode_uid . ']' . $in . '[/b:' . $this->bbcode_uid . ']';
+	/**
+	* Parse b tag
+	*/
+	function bbcode_strong($in)
+	{
+		if (!$this->check_bbcode('b', $in))
+		{
+			return '';
+		}
+
+		return '[b:' . $this->bbcode_uid . ']' . $in . '[/b:' . $this->bbcode_uid . ']';
 	}
 	
-	function bbcode_italic($in)
-	{
-		if (!$this->check_bbcode('i', $in))
-		{
-			return '';
-		}
-
-		return '[i:' . $this->bbcode_uid . ']' . $in . '[/i:' . $this->bbcode_uid . ']';
+	/**
+	* Parse i tag
+	*/
+	function bbcode_italic($in)
+	{
+		if (!$this->check_bbcode('i', $in))
+		{
+			return '';
+		}
+
+		return '[i:' . $this->bbcode_uid . ']' . $in . '[/i:' . $this->bbcode_uid . ']';
 	}
 	
-	function bbcode_img($in)
-	{
-		if (!$this->check_bbcode('img', $in))
-		{
-			return '';
-		}
+	/**
+	* Parse img tag
+	*/
+	function bbcode_img($in)
+	{
+		if (!$this->check_bbcode('img', $in))
+		{
+			return '';
+		}
+
+		$in = trim($in);
 
-		return '[img:' . $this->bbcode_uid . ']' . $in . '[/img:' . $this->bbcode_uid . ']';
+		/*global $_CLASS, $config;
+
+		if ($config['max_' . $this->mode . '_img_height'] || $config['max_' . $this->mode . '_img_width'])
+		{
+			$stats = @getimagesize($in);
+
+			if ($stats === false)
+			{
+				$this->warn_msg[] = $_CLASS['core_user']->lang['UNABLE_GET_IMAGE_SIZE'];
+			}
+			else
+			{
+				if ($config['max_' . $this->mode . '_img_height'] && $config['max_' . $this->mode . '_img_height'] < $stats[1])
+				{
+					$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['MAX_IMG_HEIGHT_EXCEEDED'], $config['max_' . $this->mode . '_img_height']);
+				}
+
+				if ($config['max_' . $this->mode . '_img_width'] && $config['max_' . $this->mode . '_img_width'] < $stats[0])
+				{
+					$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['MAX_IMG_WIDTH_EXCEEDED'], $config['max_' . $this->mode . '_img_width']);
+				}
+			}
+		}*/
+
+		if ($this->path_in_domain($in))
+		{
+			return '[img]' . $in . '[/img]';
+		}
+
+		return '[img:' . $this->bbcode_uid . ']' . $this->bbcode_specialchars($in) . '[/img:' . $this->bbcode_uid . ']';
 	}
 
-	function bbcode_flash($width, $height, $in)
-	{
-		if (!$this->check_bbcode('flash', $in))
-		{
-			return '';
-		}
-	
-		return '[flash=' . $width . ',' . $height . ':' . $this->bbcode_uid . ']' . $in . '[/flash:' . $this->bbcode_uid . ']';
+	/**
+	* Parse flash tag
+	*/
+	function bbcode_flash($width, $height, $in)
+	{
+		if (!$this->check_bbcode('flash', $in))
+		{
+			return '';
+		}
+
+		$in = trim($in);
+
+		/*global $_CLASS, $config;
+		// Apply the same size checks on flash files as on images
+		if ($config['max_' . $this->mode . '_img_height'] || $config['max_' . $this->mode . '_img_width'])
+		{
+			if ($config['max_' . $this->mode . '_img_height'] && $config['max_' . $this->mode . '_img_height'] < $height)
+			{
+				$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['MAX_FLASH_HEIGHT_EXCEEDED'], $config['max_' . $this->mode . '_img_height']);
+			}
+
+			if ($config['max_' . $this->mode . '_img_width'] && $config['max_' . $this->mode . '_img_width'] < $width)
+			{
+				$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['MAX_FLASH_WIDTH_EXCEEDED'], $config['max_' . $this->mode . '_img_width']);
+			}
+		}*/
+
+		if ($this->path_in_domain($in))
+		{
+			return '[flash=' . $width . ',' . $height . ']' . $in . '[/flash]';
+		}
+
+		return '[flash=' . $width . ',' . $height . ':' . $this->bbcode_uid . ']' . $this->bbcode_specialchars($in) . '[/flash:' . $this->bbcode_uid . ']';
 	}
 	
-	// Hardcode inline attachments [ia]
-	function bbcode_attachment($stx, $in)
-	{
-		if (!$this->check_bbcode('attachment', $in))
-		{
-			return '';
-		}
+	/**
+	* Parse inline attachments [ia]
+	*/
+	function bbcode_attachment($stx, $in)
+	{
+		if (!$this->check_bbcode('attachment', $in))
+		{
+			return '';
+		}
+
+		return '[attachment=' . $stx . ':' . $this->bbcode_uid . ']<!-- ia' . $stx . ' -->' . trim($in) . '<!-- ia' . $stx . ' -->[/attachment:' . $this->bbcode_uid . ']';
+	}
 
-		return '[attachment=' . $stx . ':' . $this->bbcode_uid . ']<!-- ia' . $stx . ' -->' . $in . '<!-- ia' . $stx . ' -->[/attachment:' . $this->bbcode_uid . ']';
-	}
-
-	// Expects the argument to start right after the opening [code] tag and to end with [/code]
-	function bbcode_code($stx, $in)
-	{
-		// when using the /e modifier, preg_replace slashes double-quotes but does not
-		// seem to slash anything else
-		if (!$this->check_bbcode('list', $in))
-		{
-			return '';
+	/**
+	* Parse code tag
+	* Expects the argument to start right after the opening [code] tag and to end with [/code]
+	*/
+	function bbcode_code($stx, $in)
+	{
+		if (!$this->check_bbcode('code', $in))
+		{
+			return '';
 		}
 
-		$this->parsed_items['code']++;
-
 		// We remove the hardcoded elements from the code block here because it is not used in code blocks
 		// Having it here saves us one preg_replace per message containing [code] blocks
 		// Additionally, magic url parsing should go after parsing bbcodes, but for safety those are stripped out too...
@@ -294,71 +417,65 @@
 				case 'php':
 					$remove_tags = false;
 
-					$str_from = array('&lt;', '&gt;', '&amp;', '&quot;', '&\#039;', '&nbsp;');
-					$str_to = array('<', '>', '&', '"', "'", ' ');
+					$code = str_replace(array('&lt;', '&gt;'), array('<', '>'), $code);
 
-					$code = str_replace($str_from, $str_to, $code);
-
-					if (!preg_match('/^\<\?(.*?)\?\>/is', $code))
+					if (!preg_match('/\<\?.*?\?\>/is', $code))
 					{
 						$remove_tags = true;
 						$code = '<?php '. $code;
 					}
 
 					$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
-
 					foreach ($conf as $ini_var)
 					{
 						ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));
 					}
-					
+
+					// Because highlight_string is specialcharing the text (but we already did this before), we have to reverse this in order to get correct results
+					$code = html_entity_decode($code);
 					$code = highlight_string($code, true);
 
-					if (version_compare(PHP_VERSION, '5.0', '<'))
-					{
-						$code = str_replace('<font color="syntax', '<span class="syntax', $code);
-						$code = str_replace('<font color="', '<span style="color: ', $code);
-						$code = str_replace('</font>', '</span>', $code);
-					}
-					else
-					{
-						$code = str_replace('<span style="color: syntax', '<span class="syntax', $code);
-					}
-
-					$str_from = array('<code>', '</code>','[', ']', '.', ':', '&amp;#058;');
-					$str_to = array('', '', '&#91;', '&#93;', '&#46;', '&#58', '&#058;');
+					$str_from = array('<span style="color: ', '<font color="syntax', '</font>', '<code>', '</code>','[', ']', '.', ':');
+					$str_to = array('<span class="', '<span class="syntax', '</span>', '', '', '&#91;', '&#93;', '&#46;', '&#58;');
 
-					$code = str_replace($str_from, $str_to, $code);
 					if ($remove_tags)
 					{
-						// if theres any problems with this, find the first "php" without span remove it
-						// then find the first </span> and remove it
-						$pos = ($pos = mb_strpos($code, 'php&nbsp;')) ? $pos + 9 : mb_strpos($code, 'php ') + 40;
-						$section = mb_substr($code, 0, $pos);
-						$code = mb_substr($code, $pos);
-						$code = str_replace(array('&lt;?', '<?', 'php&nbsp;', 'php '), '', $section).$code;
-					}
-	
+						$str_from[] = '<span class="syntaxdefault">&lt;?php </span>';
+						$str_to[] = '';
+						$str_from[] = '<span class="syntaxdefault">&lt;?php&nbsp;';
+						$str_to[] = '<span class="syntaxdefault">';
+					}
+
+					$code = str_replace($str_from, $str_to, $code);
 					$code = preg_replace('#^(<span class="[a-z_]+">)\n?(.*?)\n?(</span>)$#is', '$1$2$3', $code);
+
+					if ($remove_tags)
+					{
+						$code = preg_replace('#(<span class="[a-z]+">)?\?&gt;</span>#', '', $code);
+					}
+
 					$code = preg_replace('#^<span class="[a-z]+"><span class="([a-z]+)">(.*)</span></span>#s', '<span class="$1">$2</span>', $code);
 					$code = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*</span>$#', '</span>', $code);
-			//echo $code; die;	
-					$out .= "[code=$stx:" . $this->bbcode_uid . ']' . trim($code) . '[/code:' . $this->bbcode_uid . ']';
+
+					// remove newline at the end
+					if (!empty($code) && $code{strlen($code)-1} == "\n")
+					{
+						$code = substr($code, 0, -1);
+					}
+
+					$out .= "[code=$stx:" . $this->bbcode_uid . ']' . $code . '[/code:' . $this->bbcode_uid . ']';
 				break;
 
-				default:
-					$str_from = array('<', '>', '[', ']', '.', ':');
-					$str_to = array('&lt;', '&gt;', '&#91;', '&#93;', '&#46;', '&#58');
-
-					$out .= '[code:' . $this->bbcode_uid . ']' . str_replace($str_from, $str_to, $code) . '[/code:' . $this->bbcode_uid . ']';
+				default:
+					$out .= '[code:' . $this->bbcode_uid . ']' . $this->bbcode_specialchars($code) . '[/code:' . $this->bbcode_uid . ']';
 				break;
 			}
 
-			if (preg_match('#(.*?)\[code(?:=([a-z]+))?\](.+)#is', $in, $m))
-			{
-				$out .= $m[1];
-				$stx = $m[2];
-				$in = $m[3];
+			if (preg_match('#(.*?)\[code(?:=([a-z]+))?\](.+)#is', $in, $m))
+			{
+				$out .= $m[1];
+				$stx = $m[2];
+				$in = $m[3];
 			}
 		}
 		while ($in);
@@ -366,335 +483,400 @@
 		return $out;
 	}
 
-	// Expects the argument to start with a tag
-	function bbcode_parse_list($in)
-	{
-		if (!$this->check_bbcode('list', $in))
-		{
-			return '';
-		}
-		
-		$in = str_replace('\"', '"', $in);
-		$out = '[';
+	/**
+	* Parse list bbcode
+	* Expects the argument to start with a tag
+	*/
+	function bbcode_parse_list($in)
+	{
+		if (!$this->check_bbcode('list', $in))
+		{
+			return '';
+		}
+
+		$out = '[';
+
+		// Grab item_start with no item_end
+		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])#is', '[*:' . $this->bbcode_uid . ']\1[/*:m:' . $this->bbcode_uid . ']\2', $in);
+
+		// Grab them again as backreference
+		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])(^\[\/*\])#is', '[*:' . $this->bbcode_uid . ']\1[/*:m:' . $this->bbcode_uid . ']\2', $in);
+
+		// Grab end tag following start tag
+		$in = preg_replace('#\[\/\*:m:' . $this->bbcode_uid . '\](\n|)\[\*\]#is', '[/*:m:' . $this->bbcode_uid . '][*:' . $this->bbcode_uid . ']', $in);
+
+		// Replace end tag
+		$in = preg_replace('#\[\/\*\]#i', '[/*:' . $this->bbcode_uid . ']', $in);
+
+		// $tok holds characters to stop at. Since the string starts with a '[' we'll get everything up to the first ']' which should be the opening [list] tag
+		$tok = ']';
+		$out = '[';
+
+		$in = substr($in, 1);
+		$list_end_tags = array();
+
+		do
+		{
+			$pos = strlen($in);
+			for ($i = 0; $i < strlen($tok); ++$i)
+			{
+				$tmp_pos = strpos($in, $tok{$i});
+
+				if ($tmp_pos !== false && $tmp_pos < $pos)
+				{
+					$pos = $tmp_pos;
+				}
+			}
+
+			$buffer = substr($in, 0, $pos);
+			$tok = $in{$pos};
+
+			$in = substr($in, $pos + 1);
+
+			if ($tok == ']')
+			{
+				// if $tok is ']' the buffer holds a tag
+				if ($buffer == '/list' && sizeof($list_end_tags))
+				{
+					$out .= array_pop($list_end_tags) . ']';
+					$tok = '[';
+				}
+				else if (preg_match('#list(=?(?:[0-9]|[a-z]|))#i', $buffer, $m))
+				{
+					// sub-list, add a closing tag
+					if (!$m[1] || preg_match('/^(disc|square|circle)$/i', $m[1]))
+					{
+						array_push($list_end_tags, '/list:u:' . $this->bbcode_uid);
+					}
+					else
+					{
+						array_push($list_end_tags, '/list:o:' . $this->bbcode_uid);
+					}
+					$out .= $buffer . ':' . $this->bbcode_uid . ']';
+					$tok = '[';
+				}
+				else
+				{
+					$out .= $buffer . $tok;
+					$tok = '[]';
+				}
+			}
+			else
+			{
+				// Not within a tag, just add buffer to the return string
+				$out .= $buffer . $tok;
+				$tok = ($tok == '[') ? ']' : '[]';
+			}
+		}
+		while ($in);
+
+		if (sizeof($list_end_tags))
+		{
+			$out .= '[' . implode('][', $list_end_tags) . ']';
+		}
+
+		return $out;
+	}
 
-		// Grab item_start with no item_end
-		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])#is', '[*:' . $this->bbcode_uid . ']\1[/*:m:' . $this->bbcode_uid . ']\2', $in);
-
-		// Grab them again as backreference
-		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])(^\[\/*\])#is', '[*:' . $this->bbcode_uid . ']\1[/*:m:' . $this->bbcode_uid . ']\2', $in);
-		
-		// Grab end tag following start tag
-		$in = preg_replace('#\[\/\*:m:' . $this->bbcode_uid . '\](\n|)\[\*\]#is', '[/*:m:' . $this->bbcode_uid . '][*:' . $this->bbcode_uid . ']', $in);
-		
-		// Replace end tag
-		$in = preg_replace('#\[\/\*\]#i', '[/*:' . $this->bbcode_uid . ']', $in);
-		
-		// $tok holds characters to stop at. Since the string starts with a '[' we'll get everything up to the first ']' which should be the opening [list] tag
-		$tok = ']';
-		$out = '[';
-
-
-		$in = substr($in, 1);
-		$list_end_tags = array();
-
-		do
-		{
-			$pos = strlen($in);
-			for ($i = 0; $i < strlen($tok); ++$i)
-			{
-				$tmp_pos = strpos($in, $tok{$i});
-				
-				if ($tmp_pos !== false && $tmp_pos < $pos)
-				{
-					$pos = $tmp_pos;
-				}
-			}
-
-			$buffer = substr($in, 0, $pos);
-			$tok = $in{$pos};
-
-			$in = substr($in, $pos + 1);
-
-			if ($tok == ']')
-			{
-				// if $tok is ']' the buffer holds a tag
-				if ($buffer == '/list' && sizeof($list_end_tags))
-				{
-					$out .= array_pop($list_end_tags) . ']';
-					$tok = '[';
-				}
-				elseif (preg_match('#list(=?(?:[0-9]|[a-z]|))#i', $buffer, $m))
-				{
-					// sub-list, add a closing tag
-					if (!$m[1] || preg_match('/^(disc|square|circle)$/i', $m[1]))
-					{
-						array_push($list_end_tags, '/list:u:' . $this->bbcode_uid);
-					}
-					else
-					{
-						array_push($list_end_tags, '/list:o:' . $this->bbcode_uid);
-					}
-					$out .= $buffer . ':' . $this->bbcode_uid . ']';
-					$tok = '[';
-				}
-				else
-				{
-					$out .= $buffer . $tok;
-					$tok = '[]';
-				}
-			}
-			else
-			{
-				// Not within a tag, just add buffer to the return string
-				$out .= $buffer . $tok;
-				$tok = ($tok == '[') ? ']' : '[]';
-			}
-		}
-		while ($in);
-
-		if (sizeof($list_end_tags))
-		{
-			$out .= '[' . implode('][', $list_end_tags) . ']';
-		}
-
-		return $out;
+	/**
+	* Parse quote bbcode
+	* Expects the argument to start with a tag
+	*/
+	function bbcode_quote($in)
+	{
+		global $config, $_CLASS;
+
+		$in = str_replace("\r\n", "\n", str_replace('\"', '"', trim($in)));
+
+		if (!$in)
+		{
+			return '';
+		}
+
+		$tok = ']';
+		$out = '[';
+
+		$in = substr($in, 1);
+		$close_tags = $error_ary = array();
+		$buffer = '';
+
+		do
+		{
+			$pos = strlen($in);
+			for ($i = 0; $i < strlen($tok); ++$i)
+			{
+				$tmp_pos = strpos($in, $tok{$i});
+				if ($tmp_pos !== false && $tmp_pos < $pos)
+				{
+					$pos = $tmp_pos;
+				}
+			}
+
+			$buffer .= substr($in, 0, $pos);
+			$tok = $in{$pos};
+			$in = substr($in, $pos + 1);
+
+			if ($tok == ']')
+			{
+				if ($buffer == '/quote' && sizeof($close_tags))
+				{
+					// we have found a closing tag
+					// Add space at the end of the closing tag to allow following urls/smilies to be parsed correctly
+					$out .= array_pop($close_tags) . '] ';
+					$tok = '[';
+					$buffer = '';
+				}
+				else if (preg_match('#^quote(?:=&quot;(.*?)&quot;)?$#is', $buffer, $m))
+				{
+					$this->parsed_items['quote']++;
+
+					// the buffer holds a valid opening tag
+					if ($config['max_quote_depth'] && sizeof($close_tags) >= $config['max_quote_depth'])
+					{
+						// there are too many nested quotes
+						$error_ary['quote_depth'] = sprintf($_CLASS['core_user']->lang['QUOTE_DEPTH_EXCEEDED'], $config['max_quote_depth']);
+
+						$out .= $buffer . $tok;
+						$tok = '[]';
+						$buffer = '';
+
+						continue;
+					}
+
+					array_push($close_tags, '/quote:' . $this->bbcode_uid);
+
+					if (isset($m[1]) && $m[1])
+					{
+						$username = preg_replace('#\[(?!b|i|u|color|url|email|/b|/i|/u|/color|/url|/email)#iU', '&#91;$1', $m[1]);
+						$end_tags = array();
+						$error = false;
+
+						preg_match_all('#\[((?:/)?(?:[a-z]+))#i', $username, $tags);
+						foreach ($tags[1] as $tag)
+						{
+							if ($tag{0} != '/')
+							{
+								$end_tags[] = '/' . $tag;
+							}
+							else
+							{
+								$end_tag = array_pop($end_tags);
+								if ($end_tag != $tag)
+								{
+									$error = true;
+								}
+								else
+								{
+									$error = false;
+								}
+							}
+						}
+
+						if ($error)
+						{
+							$username = str_replace('[', '&#91;', str_replace(']', '&#93;', $m[1]));
+						}
+
+						$out .= 'quote=&quot;' . $username . '&quot;:' . $this->bbcode_uid . ']';
+					}
+					else
+					{
+						$out .= 'quote:' . $this->bbcode_uid . ']';
+					}
+
+					$tok = '[';
+					$buffer = '';
+				}
+				else if (preg_match('#^quote=&quot;(.*?)#is', $buffer, $m))
+				{
+					// the buffer holds an invalid opening tag
+					$buffer .= ']';
+				}
+				else
+				{
+					$out .= $buffer . $tok;
+					$tok = '[]';
+					$buffer = '';
+				}
+			}
+			else
+			{
+				$out .= $buffer . $tok;
+				// $tok = ($tok == '[') ? ']' : '[]';
+				$tok = '[]';
+				$buffer = '';
+			}
+		}
+		while ($in);
+
+		if (sizeof($close_tags))
+		{
+			$out .= '[' . implode('][', $close_tags) . ']';
+		}
+
+		foreach ($error_ary as $error_msg)
+		{
+			$this->warn_msg[] = $error_msg;
+		}
+
+		return $out;
+	}
+
+	/**
+	* Validate email
+	*/
+	function validate_email($var1, $var2)
+	{
+		$var1 = str_replace("\r\n", "\n", str_replace('\"', '"', trim($var1)));
+		$var2 = str_replace("\r\n", "\n", str_replace('\"', '"', trim($var2)));
+
+		$txt = $var2;
+		$email = ($var1) ? $var1 : $var2;
+
+		$validated = true;
+
+		if (!preg_match('/^' . get_preg_expression('email') . '$/i', $email))
+		{
+			$validated = false;
+		}
+
+		if (!$validated)
+		{
+			return '[email' . (($var1) ? "=$var1" : '') . ']' . $var2 . '[/email]';
+		}
+
+		$this->parsed_items['email']++;
+
+		if ($var1)
+		{
+			$retval = '[email=' . $this->bbcode_specialchars($email) . ':' . $this->bbcode_uid . ']' . $txt . '[/email:' . $this->bbcode_uid . ']';
+		}
+		else
+		{
+			$retval = '[email:' . $this->bbcode_uid . ']' . $this->bbcode_specialchars($email) . '[/email:' . $this->bbcode_uid . ']';
+		}
+
+		return $retval;
 	}
 
-	// Expects the argument to start with a tag
-	function bbcode_quote($in)
-	{
-		global $config, $_CLASS;
-
-		$in = trim($in);
-		
-		if (!$in)
-		{
-			return '';
-		}
-		
-		$tok = ']';
-		$out = '[';
-		
-		// Add newline at the end and in front of each quote block to prevent parsing errors (urls, smilies, etc.)
-		$in = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array("[quote\\1]\n\\2", "\\1\n[/quote]"), $in);
-		$in = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array("[quote\\1]\n\\2", "\\1\n[/quote]"), $in);
-		
-		$in = substr(str_replace('\"', '"', $in), 1);
-		$close_tags = $error_ary = array();
-		$buffer = '';
-
-		do
-		{
-			$pos = strlen($in);
-			for ($i = 0; $i < strlen($tok); ++$i)
-			{
-				$tmp_pos = strpos($in, $tok{$i});
-				if ($tmp_pos !== false && $tmp_pos < $pos)
+	/**
+	* Validate url
+	*/
+	function validate_url($var1, $var2)
+	{
+		global $config;
+
+		$var1 = str_replace("\r\n", "\n", str_replace('\"', '"', trim($var1)));
+		$var2 = str_replace("\r\n", "\n", str_replace('\"', '"', trim($var2)));
+
+		$url = ($var1) ? $var1 : $var2;
+		$valid = false;
+
+		if (!$url || ($var1 && !$var2))
+		{
+			return '';
+		}
+
+		// Checking urls
+		if (preg_match('#' . preg_quote(generate_base_url(), '#') . '/([^ \t\n\r<"\']+)#i', $url) ||
+			preg_match('#([\w]+?://.*?[^ \t\n\r<"\']*)#i', $url) ||
+			preg_match('#(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r<"\']*)?)#i', $url))
+		{
+			$valid = true;
+		}
+
+		if ($valid)
+		{
+			$this->parsed_items['url']++;
+
+			if (!preg_match('#^[\w]+?://.*?#i', $url))
+			{
+				$url = 'http://' . $url;
+			}
+
+			// We take our test url and stick on the first bit of text we get to check if we are really at the domain. If so, lets go!
+			if (mb_strpos($url, generate_base_url()) !== false && mb_strpos($url, 'sid=') !== false)
+			{
+				//$url = preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\1', $url);
+				if (($pos = mb_strpos($url, 'sid=')) !== false)
 				{
-					$pos = $tmp_pos;
+					$url = mb_substr($url, 0, $pos - 1);
 				}
-			}
-
-			$buffer .= substr($in, 0, $pos);
-			$tok = $in{$pos};
-			$in = substr($in, $pos + 1);
-
-			if ($tok == ']')
-			{
-				if ($buffer == '/quote' && sizeof($close_tags))
-				{
-					// we have found a closing tag
-
-					$out .= array_pop($close_tags) . ']';
-					$tok = '[';
-					$buffer = '';
-				}
-				elseif (preg_match('#^quote(?:=&quot;(.*?)&quot;)?$#is', $buffer, $m))
-				{
-					$this->parsed_items['quote']++;
-					
-					// the buffer holds a valid opening tag
-					if ($config['max_quote_depth'] && sizeof($close_tags) >= $config['max_quote_depth'])
-					{
-						// there are too many nested quotes
-						$error_ary['quote_depth'] = sprintf($_CLASS['core_user']->lang['QUOTE_DEPTH_EXCEEDED'], $config['max_quote_depth']);
-
-						$out .= $buffer . $tok;
-						$tok = '[]';
-						$buffer = '';
-
-						continue;
-					}
-
-					array_push($close_tags, '/quote:' . $this->bbcode_uid);
-
-					if (isset($m[1]) && $m[1])
-					{
-						$username = preg_replace('#\[(?!b|i|u|color|url|email|/b|/i|/u|/color|/url|/email)#iU', '&#91;$1', $m[1]);
-						$end_tags = array();
-						$error = false;
-
-						preg_match_all('#\[((?:/)?(?:[a-z]+))#i', $username, $tags);
-						foreach ($tags[1] as $tag)
-						{
-							if ($tag{0} != '/')
-							{
-								$end_tags[] = '/' . $tag;
-							}
-							else
-							{
-								$end_tag = array_pop($end_tags);
-								if ($end_tag != $tag)
-								{
-									$error = true;
-								}
-								else
-								{
-									$error = false;
-								}
-							}
-						}
-						if ($error)
-						{
-							$username = str_replace('[', '&#91;', str_replace(']', '&#93;', $m[1]));
-						}
-
-						$out .= 'quote=&quot;' . $username . '&quot;:' . $this->bbcode_uid . ']';
-					}
-					else
-					{
-						$out .= 'quote:' . $this->bbcode_uid . ']';
-					}
-
-					$tok = '[';
-					$buffer = '';
-				}
-				elseif (preg_match('#^quote=&quot;(.*?)#is', $buffer, $m))
-				{
-					// the buffer holds an invalid opening tag
-					$buffer .= ']';
-				}
-				else
-				{
-					$out .= $buffer . $tok;
-					$tok = '[]';
-					$buffer = '';
-				}
-			}
-			else
-			{
-				$out .= $buffer . $tok;
-				$tok = ($tok == '[') ? ']' : '[]';
-				$buffer = '';
-			}
-		}
-		while ($in);
-
-		if (sizeof($close_tags))
-		{
-			$out .= '[' . implode('][', $close_tags) . ']';
-		}
-
-		foreach ($error_ary as $error_msg)
-		{
-			$this->warn_msg[] = $error_msg;
-		}
-
-		return $out;
+			}
+
+			return ($var1) ? '[url=' . $this->bbcode_specialchars($url) . ':' . $this->bbcode_uid . ']' . $var2 . '[/url:' . $this->bbcode_uid . ']' : '[url:' . $this->bbcode_uid . ']' . $this->bbcode_specialchars($url) . '[/url:' . $this->bbcode_uid . ']'; 
+		}
+
+		return '[url' . (($var1) ? '=' . $var1 : '') . ']' . $var2 . '[/url]';
 	}
 
-	function validate_email($var1, $var2)
-	{
-		$txt = stripslashes($var2);
-		$email = ($var1) ? stripslashes($var1) : stripslashes($var2);
-
-		$validated = true;
-
-		if (!preg_match('!([a-z0-9]+[a-z0-9\-\._]*@(?:(?:[0-9]{1,3}\.){3,5}[0-9]{1,3}|[a-z0-9]+[a-z0-9\-\._]*\.[a-z]+))!i', $email))
-		{
-			$validated = false;
-		}
-
-		if (!$validated)
-		{
-			return '[email' . (($var1) ? "=$var1" : '') . ']' . $var2 . '[/email]';
-		}
-		
-		$this->parsed_items['email']++;
-
-		if ($var1)
-		{
-			$retval = '[email=' . $email . ':' . $this->bbcode_uid . ']' . $txt . '[/email:' . $this->bbcode_uid . ']';
-		}
-		else
-		{
-			$retval = '[email:' . $this->bbcode_uid . ']' . $email . '[/email:' . $this->bbcode_uid . ']';
-		}
-
-		return $retval;
+	/**
+	* Check if url is pointing to this domain/script_path/php-file
+	*
+	* @param string $url the url to check
+	* @return true if the url is pointing to this domain/script_path/php-file, false if not
+	*
+	* @access: private
+	*/
+// Fixed
+	function path_in_domain($url)
+	{
+		global $config, $phpEx, $_CLASS;
+
+		$check_path = '';//($_CLASS['core_user']->page['root_script_path'] != '/') ? substr($_CLASS['core_user']->page['root_script_path'], 0, -1) : '/';
+
+		// Is the user trying to link to a php file in this domain and script path?
+		if (strpos($url, ".{$phpEx}") !== false && strpos($url, $check_path) !== false)
+		{
+			$server_name = (!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME');
+
+			// Forcing server vars is the only way to specify/override the protocol
+			if ($config['force_server_vars'] || !$server_name)
+			{
+				$server_name = $config['server_name'];
+			}
+
+			// Check again in correct order...
+			$pos_ext = strpos($url, ".{$phpEx}");
+			$pos_path = strpos($url, $check_path);
+			$pos_domain = strpos($url, $server_name);
+
+			if ($pos_domain !== false && $pos_path >= $pos_domain && $pos_ext >= $pos_path)
+			{
+				return true;
+			}
+		}
+
+		return false;
 	}
-
-	function validate_url($var1, $var2)
-	{
-		global $config;
-		
-		$var1 = trim($var1);
-		$var2 = trim($var2);
-		
-		$url = ($var1) ? stripslashes($var1) : stripslashes($var2);
-		$valid = false;
-
-		if (!$url || ($var1 && !$var2))
-		{
-			return '';
-		}
-		
-		// relative urls for this board
-		if (preg_match('#' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . '/([^ \t\n\r<"\']+)#i', $url) ||
-			preg_match('#([\w]+?://.*?[^ \t\n\r<"\']*)#i', $url) ||
-			preg_match('#(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r<"\']*)?)#i', $url))
-		{
-			$valid = true;
-		}
-
-		if ($valid)
-		{
-			$this->parsed_items['url']++;
-			
-			if (!preg_match('#^[\w]+?://.*?#i', $url))
-			{
-				$url = 'http://' . $url;
-			}
-
-			return ($var1) ? '[url=' . str_replace(array(']', '['), array('&#93;', '&#91;'), $url) . ':' . $this->bbcode_uid . ']' . stripslashes($var2) . '[/url:' . $this->bbcode_uid . ']' : '[url:' . $this->bbcode_uid . ']' . $url . '[/url:' . $this->bbcode_uid . ']';
-		}
-
-		return '[url' . (($var1) ? '=' . stripslashes($var1) : '') . ']' . stripslashes($var2) . '[/url]';
-	}
 }
 
-// PARSE_MESSAGE EXTENDS BBCODE 
-//
-
-// Main message parser for posting, pm, etc. takes raw message
-// and parses it for attachments, html, bbcode and smilies
-class parse_message extends bbcode_firstpass
+/**
+* Main message parser for posting, pm, etc. takes raw message
+* and parses it for attachments, bbcode and smilies
+* @package phpBB3
+*/
+class parse_message extends bbcode_firstpass
 {
-	var $attachment_data = array();
-	var $filename_data = array();
+	var $attachment_data = array();
+	var $filename_data = array();
+
+	// Helps ironing out user error
+	var $message_status = '';
+
+	var $allow_img_bbcode = true;
+	var $allow_flash_bbcode = true;
+	var $allow_quote_bbcode = true;
+
+	var $mode;
 
-	// Helps ironing out user error
-	var $message_status = '';
-
-	var $allow_img_bbcode = true;
-	var $allow_flash_bbcode = true;
-	var $allow_quote_bbcode = true;
-
-	// Init - give message here or manually
+	/**
+	* Init - give message here or manually
+	*/
 	function parse_message($message = '')
 	{
 		// Init BBCode UID
-		$this->bbcode_uid = substr(md5(time()), 0, BBCODE_UID_LEN);
+		$this->bbcode_uid = substr(md5(time()), 0, BBCODE_UID_LEN);
 
 		if ($message)
 		{
@@ -702,13 +884,17 @@
 		}
 	}
 
-	// Parse Message : public
+	/**
+	* Parse Message
+	*/
 	function parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $allow_img_bbcode = true, $allow_flash_bbcode = true, $allow_quote_bbcode = true, $update_this_message = true, $mode = 'post')
 	{
 		global $config, $_CLASS;
 		
 		$mode = ($mode != 'sig') ? 'post' : 'sig';
 
+		$this->mode = $mode;
+
 		$this->allow_img_bbcode = $allow_img_bbcode;
 		$this->allow_flash_bbcode = $allow_flash_bbcode;
 		$this->allow_quote_bbcode = $allow_quote_bbcode;
@@ -732,12 +918,12 @@
 		$replace = array("\n", '', "\n\n", "\\1&#058;");
 		$this->message = preg_replace($match, $replace, trim($this->message));
 
-		// Message length check. -1 disables this check completely, even allows empty messsages.
-		if($config['max_' . $mode . '_chars'] != -1)
+		// Message length check. -1 disables this check completely.
+		if ($config['max_' . $mode . '_chars'] != -1)
 		{
-			$msg_len = ($mode == 'post') ? strlen($this->message) : strlen(preg_replace('#\[\/?[a-z\*\+\-]+(=[\S]+)?\]#is', ' ', $this->message));
+			$msg_len = ($mode === 'post') ? strlen($this->message) : strlen(preg_replace('#\[\/?[a-z\*\+\-]+(=[\S]+)?\]#is', ' ', $this->message));
 			
-			if (!$msg_len || ($config['max_' . $mode . '_chars'] && $msg_len > $config['max_' . $mode . '_chars']))
+			if ((!$msg_len && $mode !== 'sig') || $config['max_' . $mode . '_chars'] && $msg_len > $config['max_' . $mode . '_chars'])
 			{
 				$this->warn_msg[] = (!$msg_len) ? $_CLASS['core_user']->lang['TOO_FEW_CHARS'] : $_CLASS['core_user']->lang['TOO_MANY_CHARS'];
 				return $this->warn_msg;
@@ -750,63 +936,70 @@
 			$this->html($config['allow_html_tags']);
 		}
 
-		// Parse smilies
-		if ($allow_smilies)
-		{	
-			$this->smilies(isset($config['max_' . $mode . '_smilies']) ? $config['max_' . $mode . '_smilies'] : 0);
+		// Prepare BBcode (just prepares some tags for better parsing)
+		if ($allow_bbcode && strpos($this->message, '[') !== false)
+		{
+			$this->bbcode_init();
+			$disallow = array('img', 'flash', 'quote');
+			foreach ($disallow as $bool)
+			{
+				if (!${'allow_' . $bool . '_bbcode'})
+				{
+					$this->bbcodes[$bool]['disabled'] = true;
+				}
+			}
+
+			$this->prepare_bbcodes();
 		}
-		$num_urls = 0;
-		
-		// Parse BBCode
-		if ($allow_bbcode && strpos($this->message, '[') !== false)
-		{
-			$this->bbcode_init();
+
+		// Parse smilies
+		if ($allow_smilies)
+		{
+			$this->smilies($config['max_' . $mode . '_smilies']);
+		}
 
-			$disallow = array('img', 'flash', 'quote');
-
-			foreach ($disallow as $bool)
-			{
-				if (!${'allow_' . $bool . '_bbcode'})
-				{
-					$this->bbcodes[$bool]['disabled'] = true;
-				}
-			}
-			$this->parse_bbcode();
-			
-			$num_urls += $this->parsed_items['url'];
+
+		$num_urls = 0;
+
+		// Parse BBCode
+		if ($allow_bbcode && strpos($this->message, '[') !== false)
+		{
+			$this->parse_bbcode();
+			$num_urls += $this->parsed_items['url'];
 		}
 
-		// Parse URL's
-		if ($allow_magic_url)
-		{
-			$this->magic_url();
-
-			if (isset($config['max_' . $mode . '_urls']) && $config['max_' . $mode . '_urls'])
-			{
-				$num_urls += preg_match_all('#\<!-- (l|m|w|e) --\>.*?\<!-- \1 --\>#', $this->message, $matches);
-			}
+		// Parse URL's
+		if ($allow_magic_url)
+		{
+			$this->magic_url(generate_base_url());
+	
+			if ($config['max_' . $mode . '_urls'])
+			{
+				$num_urls += preg_match_all('#\<!-- (l|m|w|e) --\>.*?\<!-- \1 --\>#', $this->message, $matches);
+			}
 		}
 		
 		// Check number of links
-//max_sig_urls
-		if (isset($config['max_' . $mode . '_urls']) && $config['max_' . $mode . '_urls'] && $num_urls > $config['max_' . $mode . '_urls'])
+		if ($config['max_' . $mode . '_urls'] && $num_urls > $config['max_' . $mode . '_urls'])
 		{
 			$this->warn_msg[] = sprintf($_CLASS['core_user']->lang['TOO_MANY_URLS'], $config['max_' . $mode . '_urls']);
 			return $this->warn_msg;
 		}
 		
-		if (!$update_this_message)
-		{
-			unset($this->message);
-			$this->message = $tmp_message;
-			return $return_message;
+		if (!$update_this_message)
+		{
+			unset($this->message);
+			$this->message = $tmp_message;
+			return $return_message;
 		}
 
 		$this->message_status = 'parsed';
-		return;
+		return false;
 	}
 
-	// Formatting text for display
+	/**
+	* Formatting text for display
+	*/
 	function format_display($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $update_this_message = true)
 	{
 		// If false, then the parsed message get returned but internal message not processed.
@@ -816,7 +1009,7 @@
 			$return_message = &$this->message;
 		}
 
-		if ($this->message_status == 'plain')
+		if ($this->message_status === 'plain')
 		{
 			// Force updating message - of course.
 			$this->parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $this->allow_img_bbcode, $this->allow_flash_bbcode, $this->allow_quote_bbcode, true);
@@ -836,18 +1029,20 @@
 		// Replace naughty words such as farty pants
 		$this->message = str_replace("\n", '<br />', censor_text($this->message));
 
-		if (!$update_this_message)
-		{
-			unset($this->message);
-			$this->message = $tmp_message;
-			return $return_message;
-		}
-
-		$this->message_status = 'display';
-		return;
+		if (!$update_this_message)
+		{
+			unset($this->message);
+			$this->message = $tmp_message;
+			return $return_message;
+		}
+
+		$this->message_status = 'display';
+		return false;
 	}	
 	
-	// Decode message to be placed back into form box
+	/**
+	* Decode message to be placed back into form box
+	*/
 	function decode_message($custom_bbcode_uid = '', $update_this_message = true)
 	{
 		// If false, then the parsed message get returned but internal message not processed.
@@ -867,6 +1062,7 @@
 		}
 
 		$this->message_status = 'plain';
+		return false;
 	}
 	
 	// Parse HTML
@@ -882,62 +1078,34 @@
 		}
 	}
 
-	// Replace magic urls of form http://xxx.xxx., www.xxx. and xxx at xxx.xxx.
-	// Cuts down displayed size of link if over 50 chars, turns absolute links
-	// into relative versions when the server/script path matches the link
-	function magic_url()
-	{
-		static $match;
-		static $replace;
-		
-		if(!is_array($match))
-		{
-			$match = $replace = array();
-			// Be sure to not let the matches cross over. ;)
-	
-			// relative urls for this board
-			$match[] = '#(^|[\n ]|\()(' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . ')/(.*?([^ \t\n\r<"\'\)]*)?)#i';
-			$replace[] = '$1<!-- l --><a href="$2/$3">$3</a><!-- l -->';
-	
-			// matches a xxxx://aaaaa.bbb.cccc. ...
-			$match[] = '#(^|[\n ]|\()([\w]+?://.*?([^ \t\n\r<"\'\)]*)?)#ie';
-			$replace[] = "'\$1<!-- m --><a href=\"\$2\" target=\"_blank\">' . ((strlen('\$2') > 55) ? substr(str_replace('&amp;', '&', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&', '\$2'), -10) : '\$2') . '</a><!-- m -->'";
-			
-			// matches a "www.xxxx.yyyy[/zzzz]" kinda lazy URL thing
-			$match[] = '#(^|[\n ]|\()(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r<"\'\)]*)?)#ie';
-			$replace[] = "'\$1<!-- w --><a href=\"http://\$2\" target=\"_blank\">' . ((strlen('\$2') > 55) ? substr(str_replace('&amp;', '&', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&', '\$2'), -10) : '\$2') . '</a><!-- w -->'";
-	
-			// matches an email at domain type address at the start of a line, or after a space.
-			$match[] = '#(^|[\n ]|\()([a-z0-9&\-_.]+?@[\w\-]+\.([\w\-\.]+\.)?[\w]+)#ie';
-			$replace[] = "'\$1<!-- e --><a href=\"mailto:\$2\">' . ((strlen('\$2') > 55) ? substr('\$2', 0, 39) . ' ... ' . substr('\$2', -10) : '\$2') . '</a><!-- e -->'";
-		}
-		
-		/* IMPORTANT NOTE (Developer inability to do advanced regular expressions) - Acyd Burn:  
-			Transforming &lt; (<) to <&amp;lt; in order to bypass the inability of preg_replace 
-			supporting multi-character sequences (POSIX - [..]). Since all message text is specialchared by
-			default a match against < will always fail, since it is a &lt; sequence within the text.
-			Replacing with <&amp;lt; and switching back thereafter produces no problems, because < will never show up with &amp;lt; in
-			the same text (due to this specialcharing). The < is put in front of &amp;lt; to let the url break gracefully.
-			I hope someone can lend me a hand here, telling me how to achive the wanted result without switching to ereg_replace.
-		*/
-		$this->message = preg_replace($match, $replace, str_replace('&lt;', '<&amp;lt;', $this->message));
-		$this->message = str_replace('<&amp;lt;', '&lt;', $this->message);
+	/**
+	* Replace magic urls of form http://xxx.xxx., www.xxx. and xxx at xxx.xxx.
+	* Cuts down displayed size of link if over 50 chars, turns absolute links
+	* into relative versions when the server/script path matches the link
+	*/
+	function magic_url($server_url)
+	{
+		// We use the global make_clickable function
+		$this->message = make_clickable($this->message, $server_url);
 	}
 
-	// Parse Smilies
+	/**
+	* Parse Smilies
+	*/
 	function smilies($max_smilies = 0)
 	{
 		global $_CLASS;
 
   	    if (is_null($smiley = $_CLASS['core_cache']->get('smiley_parse')))
   	    {
-			$result = $_CLASS['core_db']->query('SELECT * FROM ' . CORE_SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC');
+			$result = $_CLASS['core_db']->query('SELECT * 
+						FROM ' . CORE_SMILIES_TABLE .'
+						ORDER BY LENGTH(smiley_code) DESC');
 
 			$smiley = array();
-			
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 			{
-				// (assertion)
 				$smiley['match'][] = '#(?<=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
 				$smiley['replace'][] = '<!-- s' . $row['smiley_code'] . ' --><img src="{SMILIES_PATH}/' . $row['smiley_src'] . '" border="0" alt="' . $row['smiley_description'] . '" title="' . $row['smiley_description'] . '" /><!-- s' . $row['smiley_code'] . ' -->';
 			}
@@ -964,10 +1132,12 @@
 		}
 	}
 
-	// Parse Attachments
+	/**
+	* Parse Attachments
+	*/
 	function parse_attachments($form_name, $mode, $forum_id, $submit, $preview, $refresh, $is_message = false)
 	{
-		global $config, $_CLASS, $forum_id;
+		global $config, $_CLASS;
 
 		$error = array();
 
@@ -985,10 +1155,9 @@
 
 		if ($submit && in_array($mode, array('post', 'reply', 'quote', 'edit')) && $upload_file)
 		{
-			if ($num_attachments < $cfg['max_attachments'] || $_CLASS['auth']->acl_gets('m_', 'a_'))
+			if ($num_attachments < $cfg['max_attachments'] || $_CLASS['auth']->acl_gets(array('m_', 'a_'), $forum_id))
 			{
 				$filedata = upload_attachment($form_name, $forum_id, false, '', $is_message);
-				
 				$error = $filedata['error'];
 
 				if ($filedata['post_attach'] && empty($error))
@@ -1059,20 +1228,19 @@
 			{
 				if ($edit_comment)
 				{
-					$actual_comment_list = request_var('comment_list', array(''));
+					$actual_comment_list = request_var('comment_list', array(''), true);
 
 					foreach ($actual_comment_list as $index => $entry)
 					{
-						$this->attachment_data[$index]['comment'] = preg_replace('#&amp;(\#[0-9]+;)#', '&\1', $entry);
+						$this->attachment_data[$index]['comment'] = $entry;
 					}
 				}
 				
 				if (($add_file || $preview) && $upload_file)
 				{
-					if ($num_attachments < $cfg['max_attachments'] || $_CLASS['auth']->acl_gets('m_', 'a_'))
+					if ($num_attachments < $cfg['max_attachments'] || $_CLASS['auth']->acl_gets(array('m_', 'a_'), $forum_id))
 					{
 						$filedata = upload_attachment($form_name, $forum_id, false, '', $is_message);
-
 						$error = array_merge($error, $filedata['error']);
 
 						if (!sizeof($error))
@@ -1090,7 +1258,7 @@
 							);
 
 							$this->attachment_data = array_merge(array(0 => $new_entry), $this->attachment_data);
-							$this->message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', "'[attachment='.(\\1 + 1).']\\2[/attachment]'", $this->message);
+							$this->message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', "'[attachment='.(\\1 + 1).']\\2[/attachment]'", $this->message);
 							$this->filename_data['filecomment'] = '';
 						}
 					}
@@ -1108,84 +1276,162 @@
 		}
 	}
 
-	// Get Attachment Data
-	function get_submitted_attachment_data()
+	/**
+	* Get Attachment Data
+	*/
+	function get_submitted_attachment_data($check_user_id = false)
 	{
+		global $_CLASS;
+
 		$this->filename_data['filecomment'] = request_var('filecomment', '', true);
-		$this->attachment_data = (isset($_POST['attachment_data'])) ? $_POST['attachment_data'] : array();
+		$this->attachment_data = isset($_POST['attachment_data']) ? $_POST['attachment_data'] : array();
 
-		// 
-		$data_prepare = array('physical_filename' => 's', 'real_filename' => 's', 'comment' => 's', 'extension' => 's', 'mimetype' => 's',
-							'filesize' => 'i', 'filetime' => 'i', 'attach_id' => 'i', 'thumbnail' => 'i');
-		foreach ($this->attachment_data as $pos => $var_ary)
-		{
-			foreach ($data_prepare as $var => $type)
-			{
-				if ($type == 's')
-				{
-					$this->attachment_data[$pos][$var] = trim(htmlspecialchars(str_replace(array("\r\n", "\r", '\xFF'), array("\n", "\n", ' '), stripslashes($this->attachment_data[$pos][$var]))));
-				}
-				else
-				{
-					$this->attachment_data[$pos][$var] = (int) $this->attachment_data[$pos][$var];
-				}
-			}
+		$check_user_id = ($check_user_id === false) ? $_CLASS['core_user']->data['user_id'] : $check_user_id;
 
-			$this->attachment_data[$pos]['download_count'] = 0;
+		// Regenerate data array...
+		$attach_ids = $filenames = array();
+
+		foreach ($this->attachment_data as $pos => $var_ary)
+		{
+			if ($var_ary['attach_id'])
+			{
+				$attach_ids[(int) $this->attachment_data[$pos]['attach_id']] = $pos;
+			}
+			else
+			{
+				$filenames[$pos] = '';
+				set_var($filenames[$pos], $this->attachment_data[$pos]['physical_filename'], 'string');
+				$filenames[$pos] = basename($filenames[$pos]);
+			}
+		}
+
+		$this->attachment_data = array();
+
+		// Regenerate already posted attachments...
+		if (sizeof($attach_ids))
+		{
+			// Get the data from the attachments
+			$sql = 'SELECT attach_id, physical_filename, real_filename, extension, mimetype, filesize, filetime, thumbnail
+				FROM ' . ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', $attach_ids) . ')
+					AND poster_id = ' . $check_user_id;
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				if (isset($attach_ids[$row['attach_id']]))
+				{
+					$pos = $attach_ids[$row['attach_id']];
+					$this->attachment_data[$pos] = $row;
+					set_var($this->attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+
+					unset($attach_ids[$row['attach_id']]);
+				}
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			if (sizeof($attach_ids))
+			{
+				trigger_error($_CLASS['core_user']->lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+			}
+		}
+
+		// Regenerate newly uploaded attachments
+		if (sizeof($filenames))
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/functions_upload.php';
+
+			$sql = 'SELECT attach_id
+				FROM ' . ATTACHMENTS_TABLE . "
+				WHERE LOWER(physical_filename) IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array(array_map('strtolower', $filenames))) . "')";
+			$result = $_CLASS['core_db']->query_limit($sql, 1);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if ($row)
+			{
+				trigger_error($_CLASS['core_user']->lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+			}
+
+			foreach ($filenames as $pos => $physical_filename)
+			{
+				$this->attachment_data[$pos] = array(
+					'physical_filename'	=> $physical_filename,
+					'extension'			=> strtolower(filespec::get_extension(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename)),
+					'filesize'			=> filespec::get_filesize(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename),
+					'attach_id'			=> 0,
+					'thumbnail'			=> (file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/thumb_' . $physical_filename)) ? 1 : 0,
+				);
+
+				set_var($this->attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+				set_var($this->attachment_data[$pos]['real_filename'], $_POST['attachment_data'][$pos]['real_filename'], 'string', true);
+				set_var($this->attachment_data[$pos]['filetime'], $_POST['attachment_data'][$pos]['filetime'], 'int');
+
+				if (strpos($_POST['attachment_data'][$pos]['mimetype'], 'image/') !== false)
+				{
+					set_var($this->attachment_data[$pos]['mimetype'], $_POST['attachment_data'][$pos]['mimetype'], 'string');
+				}
+				else
+				{
+					$this->attachment_data[$pos]['mimetype'] = filespec::get_mimetype(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename);
+				}
+			}
 		}
 	}
 	
-	// Parse Poll
-	function parse_poll(&$poll)
-	{
-		global $_CLASS, $config;
-
-		$poll_max_options = $poll['poll_max_options'];
-
-		// Parse Poll Option text ;)
-		$tmp_message = $this->message;
-		$this->message = $poll['poll_option_text'];
-		$bbcode_bitfield = $this->bbcode_bitfield;
-
-		$poll['poll_option_text'] = $this->parse($poll['enable_html'], $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-		
-		$this->bbcode_bitfield |= $bbcode_bitfield;
-		$this->message = $tmp_message;
-
-		// Parse Poll Title
-		$tmp_message = $this->message;
-		$this->message = $poll['poll_title'];
-		$bbcode_bitfield = $this->bbcode_bitfield;
-
-		$poll['poll_title'] = $this->parse($poll['enable_html'], $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-
-		$this->bbcode_bitfield |= $bbcode_bitfield;
-		$this->message = $tmp_message;
-
-		unset($tmp_message);
-
-		$poll['poll_options'] = explode("\n", trim($poll['poll_option_text']));
-		$poll['poll_options_size'] = sizeof($poll['poll_options']);
-			
-		if (sizeof($poll['poll_options']) == 1)
-		{
-			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_FEW_POLL_OPTIONS'];
-		}
-		else if ($poll['poll_options_size'] > (int) $config['max_poll_options'])
-		{
-			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_MANY_POLL_OPTIONS'];
-		}
-		else if ($poll_max_options > $poll['poll_options_size'])
-		{
-			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_MANY_USER_OPTIONS'];
-		}
-
-		if (!$poll['poll_title'] && $poll['poll_options_size'])
-		{
-			$this->warn_msg[] = $_CLASS['core_user']->lang['NO_POLL_TITLE'];
-		}
-
-		$poll['poll_max_options'] = ($poll['poll_max_options'] < 1) ? 1 : (($poll['poll_max_options'] > $config['max_poll_options']) ? $config['max_poll_options'] : $poll['poll_max_options']);
+	/**
+	* Parse Poll
+	*/
+	function parse_poll(&$poll)
+	{
+		global $_CLASS, $config;
+
+		$poll_max_options = $poll['poll_max_options'];
+
+		// Parse Poll Option text ;)
+		$tmp_message = $this->message;
+		$this->message = $poll['poll_option_text'];
+
+
+		$poll['poll_option_text'] = $this->parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+
+
+		$this->message = $tmp_message;
+
+		// Parse Poll Title
+		$tmp_message = $this->message;
+		$this->message = $poll['poll_title'];
+
+
+		$poll['poll_title'] = $this->parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+
+
+		$this->message = $tmp_message;
+
+		unset($tmp_message);
+
+		$poll['poll_options'] = explode("\n", trim($poll['poll_option_text']));
+		$poll['poll_options_size'] = sizeof($poll['poll_options']);
+
+		if (sizeof($poll['poll_options']) == 1)
+		{
+			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_FEW_POLL_OPTIONS'];
+		}
+		else if ($poll['poll_options_size'] > (int) $config['max_poll_options'])
+		{
+			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_MANY_POLL_OPTIONS'];
+		}
+		else if ($poll_max_options > $poll['poll_options_size'])
+		{
+			$this->warn_msg[] = $_CLASS['core_user']->lang['TOO_MANY_USER_OPTIONS'];
+		}
+
+		if (!$poll['poll_title'] && $poll['poll_options_size'])
+		{
+			$this->warn_msg[] = $_CLASS['core_user']->lang['NO_POLL_TITLE'];
+		}
+
+		$poll['poll_max_options'] = ($poll['poll_max_options'] < 1) ? 1 : (($poll['poll_max_options'] > $config['max_poll_options']) ? $config['max_poll_options'] : $poll['poll_max_options']);
 	}
 }
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/functions.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -247,6 +247,11 @@
 
 	$confirmation_code = generate_string(6);
 
+	if (is_array($hidden))
+	{
+		$hidden = generate_hidden_fields($hidden);
+	}
+
 	if ($image)
 	{
 		$confirm_image = '<img src="'.generate_link('system&amp;mode=confirmation_image').'" alt="" title="" />';
@@ -371,7 +376,7 @@
 		break;
 	}
 
-	if (is_null($variable))
+	if (is_null($variable) || $variable === $default)
 	{
 		return $default;
 	}
@@ -1045,7 +1050,14 @@
 {
 	global $config, $_CLASS;
 
-	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->user_data_get('viewsmilies')) ? preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text) : str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
+	if ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']->user_data_get('viewsmilies'))
+	{
+		return preg_replace('#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#', '\1', $text);
+	}
+	else
+	{
+		return str_replace('<img src="{SMILIES_PATH}', '<img src="' . $config['smilies_path'], $text);
+	}
 }
 
 if (!function_exists('stripos'))

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/functions_user.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -259,14 +259,17 @@
 	$_CLASS['core_db']->query($sql);
 
 	// Now we disable the user in his active groups
-	//	( note disable is not uses for group removal, the entry is just deleted )
-// should also remove all pending groups
 	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_DISABLED . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')
 			AND member_status = ' . STATUS_ACTIVE;
 	$_CLASS['core_db']->query($sql);
 
+	$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
+		WHERE user_id IN (' . implode(', ', $user_id) . ")
+		AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+	$_CLASS['core_db']->query($sql);
+
 	if ($update_stats)
 	{
 		if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
@@ -282,13 +285,13 @@
 			set_core_config('user', 'newest_user_id', $row['user_id'], false);
 			set_core_config('user', 'newest_username', $row['username'], false);
 		}
-	
+
 		$total_users = $_CORE_CONFIG['user']['total_users'] - count($user_id);
 		set_core_config('user', 'total_users', $total_users, false);
-		
+
 		$_CLASS['core_cache']->destroy('core_config');
 	}
-	
+
 	$_CLASS['core_db']->transaction('commit');
 }
 
@@ -308,7 +311,12 @@
 		$sql = 'DELETE FROM ' . CORE_USERS_TABLE . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')';
 		$_CLASS['core_db']->query($sql);
-		
+
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
+			WHERE user_id IN (' . implode(', ', $user_id) . ")
+			AND auto_login_code = '" . $_CLASS['core_db']->escape($code) . "'";
+		$_CLASS['core_db']->query($sql);
+
 		return;
 	}
 
@@ -323,7 +331,7 @@
 	$_CLASS['core_db']->transaction();
 
 	$optimize_array = array();
-	$tables = array(CORE_USERS_TABLE => 'user_id', CORE_USER_GROUP_TABLE => 'user_id');
+	$tables = array(CORE_USERS_TABLE => 'user_id', CORE_SESSIONS_AUTOLOGIN_TABLE => 'user_id', CORE_USER_GROUP_TABLE => 'user_id');
 // hook here
 
 // Move this to hooks on seperation
@@ -380,19 +388,19 @@
 
 	$difference = array();
 
-	$username = is_array($username) ? $username : array($username);
+	$username = is_array($username) ? array_map('strtolower', $username) : array(strtolower($username));
 
 	$data = array('user_id' => array(), 'username' => array());
 
 	$sql = 'SELECT user_id, username
 				FROM ' . CORE_USERS_TABLE . " 
-				WHERE username IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
+				WHERE LOWER(username) IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array($username)) . "')";
 	$result = $_CLASS['core_db']->query($sql);
 
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
+		$data['user_id'][strtolower($row['username'])] = $row['user_id'];
+		$data['username'][] = strtolower($row['username']);
 	}
 	$_CLASS['core_db']->free_result($result);
 
@@ -424,7 +432,7 @@
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
+		$data['username'][$row['user_id']] = $row['username'];
 	}
 	$_CLASS['core_db']->free_result($result);
 

Modified: cms/trunk/includes/templates/modules/forums/mcp_approve.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_approve.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_approve.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -1,38 +1,39 @@
-<!-- INCLUDE overall_header.html -->
-<!-- $Id: mcp_approve.html,v 1.2 2004/07/19 20:13:17 acydburn Exp $ -->
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/forums/mcp_header.html -->
 
 <div id="pagecontent">
 
-	<form name="confirm" action="{S_CONFIRM_ACTION}" method="post">
+	<form name="confirm" action="{ $CONFIRM_ACTION }" method="post">
 	
 	<table class="tablebg" width="100%" cellspacing="1">
 	<tr>
-		<th>{MESSAGE_TITLE}</th>
+		<th>{ $MESSAGE_TITLE }</th>
 	</tr>
 	<tr>
 		<td class="row1" align="center">
-			<!-- IF ADDITIONAL_MSG -->
-				<span class="gen" style="color:red">{ADDITIONAL_MSG}</span><br />
+			<!-- IF { $ADDITIONAL_MSG } -->
+				<span class="gen" style="color:red">{ $ADDITIONAL_MSG }</span><br />
 			<!-- ENDIF -->
-			<!-- IF S_NOTIFY_POSTER -->
-				<input type="checkbox" name="notify_poster" checked="checked" /><span class="gen"><!-- IF S_APPROVE -->{L_NOTIFY_POSTER_APPROVAL}<!-- ELSE -->{L_NOTIFY_POSTER_DISAPPROVAL}<!-- ENDIF --></span><br />
+			<!-- IF { $S_NOTIFY_POSTER } -->
+				<input type="checkbox" class="radio" name="notify_poster" checked="checked" /><span class="gen"><!-- IF { $S_APPROVE } -->{ $L_NOTIFY_POSTER_APPROVAL }<!-- ELSE -->{ $L_NOTIFY_POSTER_DISAPPROVAL }<!-- ENDIF --></span><br />
 			<!-- ENDIF -->
-			<!-- IF not S_APPROVE -->
+			<!-- IF !{ $S_APPROVE } -->
 				<br />
 				<table border="0" width="90%" cellspacing="2" cellpadding="1">
 				<tr>
-					<td class="row2" width="22%"><b class="gen">{L_DISAPPROVE_REASON}:</b></td>
-					<td class="row2" width="78%"><select name="reason_id"><!-- BEGIN reason --><option value="{reason.ID}"<!-- IF reason.S_SELECTED --> selected="selected"<!-- ENDIF -->>{reason.DESCRIPTION}</option><!-- END reason --></select></td>
+					<td class="row1" width="22%"><b class="gen">{ $L_DISAPPROVE_REASON }:</b></td>
+					<td class="row1" width="78%"><select name="reason_id"><!-- LOOP $reason --><option value="{ $reason:ID }"<!-- IF { $reason:S_SELECTED } --> selected="selected"<!-- ENDIF -->>{ $reason:DESCRIPTION }</option><!-- ENDLOOP $reason --></select></td>
 				</tr>
 				<tr>
-					<td class="row2" valign="top"><span class="gen"><b>{L_MORE_INFO}:</b></span><br /><span class="gensmall">{L_CAN_LEAVE_BLANK}</span></td>
-					<td class="row2"><textarea class="post" style="width:500px" name="reason" rows="10" cols="40">{REASON}</textarea></td>
+					<td class="row1" valign="top"><span class="gen"><b>{ $L_MORE_INFO }:</b></span><br /><span class="gensmall">{ $L_CAN_LEAVE_BLANK }</span></td>
+					<td class="row1"><textarea class="post" style="width:500px" name="reason" rows="10" cols="40">{ $REASON }</textarea></td>
 				</tr>
 				</table>
 				<br />
 			<!-- ENDIF -->
-			<br />{S_HIDDEN_FIELDS}<span class="gen">{MESSAGE_TEXT}</span><br /><br />
-			<input type="submit" name="confirm" value="{YES_VALUE}" class="btnmain" />&nbsp;&nbsp;<input type="submit" name="cancel" value="{L_NO}" class="btnlite" /></span>
+			<br />{ $HIDDEN_FIELDS }<span class="gen">{ $MESSAGE }</span><br /><br />
+			<input type="submit" name="confirm" value="Submit" class="button" />&nbsp;&nbsp;<input type="submit" name="cancel" value="{ $L_CANCEL }" class="button" /></span>
 		</td>
 	</tr>
 	</table>
@@ -42,15 +43,6 @@
 
 <br clear="all" />
 
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="0">
-<tr>
-	<td class="row1">
-		<p class="breadcrumbs"><a href="{U_INDEX}">{L_INDEX}</a><!-- BEGIN navlinks --> &#187; <a href="{navlinks.U_VIEW_FORUM}">{navlinks.FORUM_NAME}</a><!-- END navlinks --></p>
-		<p class="datetime">{S_TIMEZONE}</p>
-	</td>
-</tr>
-</table>
-
-<br clear="all" />
-
-<!-- INCLUDE overall_footer.html -->
+<!-- INCLUDE modules/forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -74,7 +74,7 @@
 			<td style="text-align: center;">{ $usernotes:REPORT_AT }</td>
 			<td class="gen">
 				{ $usernotes:ACTION }
-				<!-- IF { $usernotes:DATA } --><br />&#187; <span class="gensmall">[ { $usernotes:DATA } ]</span><!-- ENDIF -->
+				<!-- IF isset({ $usernotes:DATA }) --><br />&#187; <span class="gensmall">[ { $usernotes:DATA } ]</span><!-- ENDIF -->
 			</td>
 			<td style="text-align: center;"><!-- IF { $S_CLEAR_ALLOWED } --><input type="checkbox" class="radio" name="marknote[]" value="{ $usernotes:ID }" /><!-- ENDIF --></td>
 		</tr>

Modified: cms/trunk/includes/templates/modules/forums/mcp_queue.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_queue.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_queue.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -1,41 +1,50 @@
-{ include file='modules/Forums/mcp_header.html' }
+<!-- DISPLAY_HEADER -->
+
+<!-- INCLUDE modules/forums/mcp_header.html -->
 
-<table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0"><form name="mcp" method="post" action="{$S_MCP_ACTION}">
-	<tr>
-		<th colspan="6" height="28" nowrap="nowrap">{$L_DISPLAY_OPTIONS}</th>
+<form name="mcp" id="mcp" method="post" action="{ $S_MCP_ACTION }">
+
+<table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0">
+<tr>
+	<th colspan="6" nowrap="nowrap">{ $L_DISPLAY_OPTIONS }</th>
+</tr>
+<tr>
+	<td colspan="5" class="cat" align="center"><span class="gensmall">{ $L_DISPLAY_ITEMS }:</span> { $S_SELECT_SORT_DAYS }&nbsp;<span class="gensmall">{ $L_SORT_BY }</span> { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;<span class="gensmall">{ $L_FORUM }</span> <select name="f">{ $S_FORUM_OPTIONS }</select> &nbsp; <!-- IF { $TOPIC_ID } --><input type="checkbox" class="radio" name="t" value="{ $TOPIC_ID }" checked="checked" />&nbsp; <b>{ $L_ONLY_TOPIC }</b> &nbsp; <!-- ENDIF --><input class="btnlite" type="submit" name="sort" value="{ $L_GO }" /></span></td>
+</tr>
+<tr> 
+	<th>&nbsp;<!-- IF { $S_TOPICS } -->{ $L_TOPIC }<!-- ELSE -->{ $L_POST }<!-- ENDIF -->&nbsp;</th>
+	<th>&nbsp;{ $L_AUTHOR }&nbsp;</th>
+	<th>&nbsp;{ $L_POST_TIME }&nbsp;</th>
+	<th width="5%">&nbsp;{ $L_SELECT }&nbsp;</th>
+</tr>
+<!-- LOOP $postrow -->
+	<!-- IF { $postrow:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+		<td style="padding: 4px;"><p class="topictitle"><a href="{ $postrow:U_VIEWTOPIC }">{ $postrow:POST_SUBJECT }</a></p>
+			<span class="gensmall"><!-- IF { $postrow:U_VIEWFORUM } -->{ $L_FORUM }: <a href="{ $postrow:U_VIEWFORUM }">{ $postrow:FORUM_NAME }</a><!-- ELSE -->{ $postrow:FORUM_NAME }<!-- ENDIF --></span></td>
+		<td style="padding: 4px;" align="left" valign="top" nowrap="nowrap"><span class="gen"><!-- IF { $postrow:U_VIEWPROFILE } --><a href="{ $postrow:U_VIEWPROFILE }">{ $postrow:POSTER }</a><!-- ELSE -->{ $postrow:POSTER }<!-- ENDIF --></span><br />
+			<span class="gensmall">[ <a href="{ $postrow:U_VIEW_DETAILS }">{ $L_VIEW_DETAILS }</a> ]</span></td>
+		<td class="postdetails" style="padding: 4px;" align="left" valign="top" nowrap="nowrap">{ $postrow:POST_TIME }</td>
+		<td align="center"><input type="checkbox" class="radio" name="post_id_list[]" value="{ $postrow:POST_ID }" /></td>
 	</tr>
+<!-- LOOPELSE -->
 	<tr>
-		<td colspan="5" class="cat" height="28" align="center"><span class="gensmall">{$L_DISPLAY_ITEMS}:</span> {$S_SELECT_SORT_DAYS}&nbsp;<span class="gensmall">{$L_SORT_BY}</span> {$S_SELECT_SORT_KEY} {$S_SELECT_SORT_DIR}&nbsp;<span class="gensmall">{$L_FORUM}</span> <select name="f">{$S_FORUM_OPTIONS}</select>&nbsp;<input class="btnlite" type="submit" name="sort" value="{$L_GO}" /></span></td>
+		<td class="row1" colspan="6" height="30" align="center" valign="middle"><span class="gen">{ $L_NO_POSTS }</span></td>
 	</tr>
-	<tr> 
-		<th height="28">&nbsp;{$L_TOPIC}&nbsp;</th>
-		<th>&nbsp;{$L_AUTHOR}&nbsp;</th>
-		<th>&nbsp;{$L_POST_TIME}&nbsp;</th>
-		<th width="5%">&nbsp;{$L_SELECT}&nbsp;</th>
-	</tr>
-	{section name=postrowloop loop=$postrow}
-	{ if $smarty.section.postrowloop.index is even }<tr class="row1">{ else }<tr class="row2">{ /if }
-		<td style="padding: 4px;"><p class="topictitle"><a href="{$postrow[postrowloop].U_VIEWTOPIC}">{$postrow[postrowloop].TOPIC_TITLE}</a></p><br />
-			<span class="gensmall">{$L_FORUM}: <a href="{$postrow[postrowloop].U_VIEWFORUM}">{$postrow[postrowloop].FORUM_NAME}</a></span></td>
-		<td style="padding: 4px;" align="left" valign="top" nowrap="nowrap"><span class="gen">{ if $postrow[postrowloop].U_VIEWPROFILE }<a href="{$postrow[postrowloop].U_VIEWPROFILE}">{$postrow[postrowloop].POSTER}</a>{ else }{$postrow[postrowloop].POSTER}{ /if }</span><br />
-			<span class="gensmall">[ <a href="{$postrow[postrowloop].U_VIEW_DETAILS}">{$L_VIEW_DETAILS}</a> ]</span></td>
-		<td class="postdetails" style="padding: 4px;" align="left" valign="top" nowrap="nowrap">{$postrow[postrowloop].POST_TIME}</td>
-		<td align="center">{$postrow[postrowloop].S_CHECKBOX}</td>
-	</tr>
-	{ sectionelse }
-	<tr>
-		<td class="row1" colspan="6" height="30" align="center" valign="middle"><span class="gen">{$L_NO_POSTS}</span></td>
-	</tr>
-	{ /section }
-	<tr>
-		<td class="cat" colspan="6" height="28" align="center"><input class="btnmain" type="submit" name="mode[approve]" value="{$L_APPROVE}" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="mode[disapprove]" value="{$L_DISAPPROVE}" /></td>
-	</tr>
-</form></table>
+<!-- ENDLOOP $postrow -->
+<tr>
+	<td class="cat" colspan="6" align="center"><input class="btnmain" type="submit" name="action[approve]" value="{ $L_APPROVE }" />&nbsp;&nbsp;<input class="btnlite" type="submit" name="action[disapprove]" value="{ $L_DISAPPROVE }" /></td>
+</tr>
+</table>
 
+</form>
+
 <table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
-	<tr>
-		<td align="right" valign="top" nowrap="nowrap"><b class="gensmall"><a href="javascript:marklist('mcp', true);">{$L_MARK_ALL}</a> :: <a href="javascript:marklist('mcp', false);">{$L_UNMARK_ALL}</a></b></td>
-	</tr>
+<tr>
+	<td align="right" valign="top" nowrap="nowrap"><b class="gensmall"><a href="javascript:marklist('mcp', '', true);">{ $L_MARK_ALL }</a> :: <a href="javascript:marklist('mcp', '', false);">{ $L_UNMARK_ALL }</a></b></td>
+</tr>
 </table>
 
-{ include file='modules/Forums/mcp_footer.html' }
\ No newline at end of file
+
+<!-- INCLUDE modules/forums/mcp_footer.html -->
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/viewtopic_body.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/viewtopic_body.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/viewtopic_body.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -118,7 +118,7 @@
 		<!-- IF { $postrow:S_IGNORE_POST } -->
 			<td class="gensmall" colspan="2" height="25" align="center">{ $postrow:L_IGNORE_POST }</td>
 		<!-- ELSE -->
-			<td align="center" valign="middle"><!-- IF { $postrow:S_FIRST_UNREAD } --><a name="unread"></a><!-- ELSE --><a name="{ $postrow:POST_ID }"></a><!-- ENDIF -->
+			<td align="center" valign="middle"><!-- IF { $postrow:S_FIRST_UNREAD } --><a name="unread"></a><!-- ELSE --><a name="p{ $postrow:POST_ID }"></a><!-- ENDIF -->
 			<!-- IF { $postrow:U_PROFILE } --><a href="{ $postrow:U_PROFILE }"><b class="postauthor">{ $postrow:POSTER_NAME }</b><!-- ELSE --><b class="postauthor">{ $postrow:POSTER_NAME }</b><!-- ENDIF --></td>
 			<td width="100%" height="25"><table width="100%" cellspacing="0">
 				<tr>

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/index.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -51,7 +51,7 @@
 	function process_module($type = 'page')
 	{
 		global $_CLASS;
-		
+
 		if ($this->module)
 		{
 			$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. "
@@ -129,7 +129,7 @@
 		$_CLASS['core_db']->free_result($result);
 	
 		// Output listing of friends online
-		$online_time = $_CLASS['core_user']->time = $_CORE_CONFIG['server']['session_length'];
+		$online_time = ($_CLASS['core_user']->time - $_CORE_CONFIG['server']['session_length']);
 		
 		$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
 			FROM ' . CORE_USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 

Modified: cms/trunk/modules/control_panel/modules/ucp_pm.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -11,42 +11,35 @@
 // 
 // -------------------------------------------------------------
 
-/**
-* @package ucp
-* ucp_pm
-*
-* Private Message Class
-*
-* @param int $folder display folder with the id used
-* @param inbox|outbox|sentbox display folder with the associated name
-*
-*
-*	Display Unread Messages - mode=unread
-*
-*	if the folder id with (&f=[folder_id]) is used when displaying messages, one query will be saved. If it is not used, phpBB needs to grab
-*	the folder id first in order to display the input boxes and folder names and such things. ;) phpBB always checks this against the database to make
-*	sure the user is able to view the message.
-*
-*	Composing Messages (mode=compose):
-*		To specific user (u=[user_id])
-*		To specific group (g=[group_id])
-*		Quoting a post (action=quote&q=1&p=[post_id])
-*		Quoting a PM (action=quote&p=[msg_id])
-*		Forwarding a PM (action=forward&p=[msg_id])
-*
-*
-* @todo Review of post when replying/quoting
-* @todo Report PM
-* @todo Check Permissions (compose message - to user/group)
-*
+/** 
+* Private Message Class
+*
+* @param int $folder display folder with the id used
+* @param inbox|outbox|sentbox display folder with the associated name
+*
+*
+*	Display Messages (default to inbox) - mode=view
+*	Display single message - mode=view&p=[msg_id] or &p=[msg_id] (short linkage)
+*
+*	if the folder id with (&f=[folder_id]) is used when displaying messages, one query will be saved. If it is not used, phpBB needs to grab
+*	the folder id first in order to display the input boxes and folder names and such things. ;) phpBB always checks this against the database to make
+*	sure the user is able to view the message.
+*
+*	Composing Messages (mode=compose):
+*		To specific user (u=[user_id])
+*		To specific group (g=[group_id])
+*		Quoting a post (action=quotepost&p=[post_id])
+*		Quoting a PM (action=quote&p=[msg_id])
+*		Forwarding a PM (action=forward&p=[msg_id])
+*
+* @package ucp
 */
-
 global $_CLASS, $config;
 
 $action = '';
 $mode = false;
 
-if ($_CLASS['core_user']->data['user_id'] == ANONYMOUS)
+if (!$_CLASS['core_user']->is_user)
 {
 	trigger_error('NO_MESSAGE');
 }
@@ -78,11 +71,11 @@
 		$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
 	}
 
-	$mode = 'view_messages';
+	$mode = 'view';
 }
 else
 {
-	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view') : $mode;
 }
 
 $id = 'pm';
@@ -91,7 +84,7 @@
 require_once SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php';
 
 $_CLASS['core_template']->assign_array(array( 
-	'L_TITLE'			=> $_CLASS['core_user']->lang['UCP_PM_' . strtoupper($mode)],
+	'L_TITLE'			=> $_CLASS['core_user']->get_lang('UCP_PM_' . strtoupper($mode)),
 	'S_UCP_ACTION'      => generate_link($this->link . ((isset($action)) ? "&amp;action=$action" : '')))
 );
 
@@ -100,7 +93,7 @@
 	// New private messages popup
 	case 'popup':
 	
-		$indox_link = generate_link('control_panel&i=pm&folder=inbox');
+		$indox_link = generate_link('control_panel&amp;i=pm&amp;folder=inbox');
 
 		if ($_CLASS['core_user']->data['user_new_privmsg'])
 		{
@@ -126,7 +119,7 @@
 	case 'compose':
 		$action = get_variable('action', 'REQUEST', 'post');
 
-		get_folder($_CLASS['core_user']->data['user_id'], $folder);
+		get_folder($_CLASS['core_user']->data['user_id']);
 		
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_compose.php';
 		compose_pm($id, $mode, $action);
@@ -135,19 +128,11 @@
 	break;
 	
 	case 'options':
-		/*$sql = 'SELECT group_message_limit
-			FROM ' . CORE_GROUPS_TABLE . '
-			WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
-		$result = $_CLASS['core_db']->query($sql);
-
-		list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
-		$_CLASS['core_db']->free_result($result);
-*/
 		$message_limit = 10;
 		
 		(int) $_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 		
-		get_folder($_CLASS['core_user']->data['user_id'], $folder);
+		get_folder($_CLASS['core_user']->data['user_id']);
 
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_options.php';
 		message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
@@ -156,7 +141,7 @@
 	break;
 
 	case 'drafts':
-		get_folder($_CLASS['core_user']->data['user_id'], $folder);
+		get_folder($_CLASS['core_user']->data['user_id']);
 	
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_main.php';
 		$module = new ucp_main($id, $mode);
@@ -164,16 +149,9 @@
 		exit;
 	break;
 
-	case 'unread':
-	case 'view_messages':
-		$sql = 'SELECT group_message_limit
-			FROM ' . CORE_GROUPS_TABLE . '
-			WHERE group_id = ' . $_CLASS['core_user']->data['user_group'];
-		$result = $_CLASS['core_db']->query($sql);
+	case 'view':
+		$message_limit = 10;
 
-		list($message_limit) = $_CLASS['core_db']->fetch_row_num($result);
-		$_CLASS['core_db']->free_result($result);
-
 		$_CLASS['core_user']->data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 
 		if ($folder_specified)
@@ -183,36 +161,42 @@
 		}
 		else
 		{
-			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
+			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_NO_BOX, 'int');
 			$action = get_variable('action', 'REQUEST', 'view_folder');
 		}
 
-		if ($folder_id === PRIVMSGS_NO_BOX)
-		{
-			$folder_id = PRIVMSGS_INBOX;
-		}
-
 		$msg_id = get_variable('p', 'REQUEST', 0, 'int');
 		$view	= get_variable('view', 'REQUEST');
 		
-		if ($msg_id && $action === 'view_folder')
+		if ($msg_id)
 		{
 			$action = 'view_message';
 		}
 
-// First Handle Mark actions and moving messages
+		// First Handle Mark actions and moving messages
+		$submit_mark	= isset($_POST['submit_mark']);
+		$move_pm		= isset($_POST['move_pm']);
+		$mark_option	= get_variable('mark_option', 'REQUEST', '');
+		$dest_folder	= get_variable('dest_folder', 'REQUEST', PRIVMSGS_NO_BOX);
 
+		// Is moving PM triggered through mark options?
+		if (!in_array($mark_option, array('mark_important', 'delete_marked')) && $submit_mark)
+		{
+			$move_pm = true;
+			$dest_folder = (int) $mark_option;
+			$submit_mark = false;
+		}
+
 		// Move PM
-		if (isset($_REQUEST['move_pm']))
+		if ($move_pm)
 		{
 			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
-			$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_NO_BOX, 'int');
 
 			if (move_pm($_CLASS['core_user']->data['user_id'], $_CLASS['core_user']->data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
 			{
 				// Return to folder view if single message moved
-				if ($action == 'view_message')
+				if ($action === 'view_message')
 				{
 					$msg_id		= 0;
 					$folder_id	= $cur_folder_id;
@@ -222,7 +206,7 @@
 		}
 
 		// Message Mark Options
-		if (isset($_REQUEST['submit_mark']))
+		if ($submit_mark)
 		{
 			$mark_option = get_variable('mark_option', 'POST');
 			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
@@ -232,12 +216,11 @@
 			{
 				case 'mark_read':
 				case 'mark_unread':
-						$read_status = ($mark_option === 'mark_read');
-						set_read_status($read_status, $msg_ids, $_CLASS['core_user']->data['user_id'], $cur_folder_id);
+					$read_status = ($mark_option === 'mark_read');
+					set_read_status($read_status, $msg_ids, $_CLASS['core_user']->data['user_id'], $cur_folder_id);
 				break;
 
 				default:
-					// redo this
 					handle_mark_actions($_CLASS['core_user']->data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
 				break;
 			}
@@ -248,13 +231,34 @@
 
 		if ($_CLASS['core_user']->data['user_new_privmsg'] && $action == 'view_folder')
 		{
-			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
+			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', 0));
 			$num_not_moved = $_CLASS['core_user']->data['user_new_privmsg'];
 		}
 
+		if (!$msg_id && $folder_id == PRIVMSGS_NO_BOX)
+		{
+			$folder_id = PRIVMSGS_INBOX;
+		}
+		else if ($msg_id && $folder_id == PRIVMSGS_NO_BOX)
+		{
+			$sql = 'SELECT folder_id
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . "
+				WHERE msg_id = $msg_id
+					AND user_id = " . $_CLASS['core_user']->data['user_id'];
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if (!$row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+			$folder_id = (int) $row['folder_id'];
+		}
+
 		$message_row = array();
 
-		if ($mode === 'view_messages' && $action === 'view_message' && $msg_id)
+		if ($action === 'view_message' && $msg_id)
 		{
 			// Get Message user want to see
 			if ($view === 'next' || $view === 'previous')
@@ -280,8 +284,10 @@
 						AND p.message_time $sql_condition p2.message_time
 					ORDER BY p.message_time $sql_ordering";
 				$result = $_CLASS['core_db']->query_limit($sql, 1);
+				$row = $_CLASS['core_db']->fetch_row_assoc($result);
+				$_CLASS['core_db']->free_result($result);
 
-				if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+				if (!$row)
 				{
 					$message = ($view === 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
 					trigger_error($message);
@@ -290,8 +296,6 @@
 				{
 					$msg_id = $row['msg_id'];
 				}
-
-				$_CLASS['core_db']->free_result($result);
 			}
 
 			$sql = 'SELECT t.*, p.*, u.*
@@ -311,24 +315,22 @@
 			}
 
 			// Update unread status
-			if ($message_row['unread'])
+			if ($message_row['pm_unread'])
 			{
 				set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']->data['user_id'], $folder_id);
 			}
 		}
 
-		$folder = array();
-		get_folder($_CLASS['core_user']->data['user_id'], $folder, $folder_id);
+		$folder = get_folder($_CLASS['core_user']->data['user_id'], $folder_id);
 
 		$s_folder_options = $s_to_folder_options = '';
 		foreach ($folder as $f_id => $folder_ary)
 		{
-			$option = '<option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class="blue"' : '') . ' value="' . $f_id . '"' . ((($f_id == $folder_id && $mode != 'unread') || ($f_id === 'unread' && $mode == 'unread')) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '</option>';
+			$option = '<option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class="blue"' : '') . ' value="' . $f_id . '"' . (($f_id == $folder_id) ? ' selected="selected"' : '') . '>' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '</option>';
 
 			$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX && $f_id != PRIVMSGS_SENTBOX) ? $option : '';
 			$s_folder_options .= $option;
 		}
-
 		clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
 
 		// Header for message view - folder and so on
@@ -343,7 +345,7 @@
 
 			'S_FOLDER_OPTIONS'			=> $s_folder_options,
 			'S_TO_FOLDER_OPTIONS'		=> $s_to_folder_options,
-			'S_FOLDER_ACTION'			=> generate_link($this->link_parent.'&amp;mode=view_messages&amp;action=view_folder'),
+			'S_FOLDER_ACTION'			=> generate_link($this->link_parent.'&amp;mode=view&amp;action=view_folder'),
 			'S_PM_ACTION'				=> generate_link($this->link_parent.'&amp;mode=$mode&amp;action='.$action),
 			
 			'U_INBOX'					=> generate_link($this->link_parent.'&amp;folder=inbox'),
@@ -364,7 +366,7 @@
 		
 		$_CLASS['core_template']->assign('S_VIEW_MESSAGE',  false);
 
-		if ($mode == 'unread' || $action == 'view_folder')
+		if ($action === 'view_folder')
 		{
 			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewfolder.php';
 			view_folder($this, $folder_id, $folder, (($mode === 'unread') ? 'unread' : 'folder'));
@@ -376,8 +378,8 @@
 		{
 			$_CLASS['core_template']->assign_array(array(
 				'S_VIEW_MESSAGE'=> true,
-				'MSG_ID'		=> $msg_id)
-			);
+				'MSG_ID'		=> $msg_id
+			));
 		
 			if (!$msg_id)
 			{
@@ -396,70 +398,4 @@
 	break;
 }
 
-/*
-function obtain_icons()
-{
-	global $_CLASS;
-
-	if (is_null($icons = $_CLASS['core_cache']->get('icons')))
-	{
-		$sql = 'SELECT *
-			FROM ' . FORUMS_ICONS_TABLE . ' 
-			ORDER BY icons_order';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$icons = array();
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$icons[$row['icons_id']]['img'] = $row['icons_url'];
-			$icons[$row['icons_id']]['width'] = (int) $row['icons_width'];
-			$icons[$row['icons_id']]['height'] = (int) $row['icons_height'];
-			$icons[$row['icons_id']]['display'] = (bool) $row['display_on_posting'];
-		}
-
-		$_CLASS['core_db']->free_result($result);
-
-		$_CLASS['core_cache']->put('icons', $icons);
-	}
-
-	return $icons;
-}*/
-
-/*
-function gen_sort_selects(&$limit_days, &$sort_by_text, &$sort_days, &$sort_key, &$sort_dir, &$s_limit_days, &$s_sort_key, &$s_sort_dir, &$u_sort_param)
-{
-	global $_CLASS;
-
-	$sort_dir_text = array('a' => $_CLASS['core_user']->lang['ASCENDING'], 'd' => $_CLASS['core_user']->lang['DESCENDING']);
-
-	$s_limit_days = '<select name="st">';
-	foreach ($limit_days as $day => $text)
-	{
-		$selected = ($sort_days == $day) ? ' selected="selected"' : '';
-		$s_limit_days .= '<option value="' . $day . '"' . $selected . '>' . $text . '</option>';
-	}
-	$s_limit_days .= '</select>';
-
-	$s_sort_key = '<select name="sk">';
-	foreach ($sort_by_text as $key => $text)
-	{
-		$selected = ($sort_key == $key) ? ' selected="selected"' : '';
-		$s_sort_key .= '<option value="' . $key . '"' . $selected . '>' . $text . '</option>';
-	}
-	$s_sort_key .= '</select>';
-
-	$s_sort_dir = '<select name="sd">';
-	foreach ($sort_dir_text as $key => $value)
-	{
-		$selected = ($sort_dir == $key) ? ' selected="selected"' : '';
-		$s_sort_dir .= '<option value="' . $key . '"' . $selected . '>' . $value . '</option>';
-	}
-	$s_sort_dir .= '</select>';
-
-	$u_sort_param = "st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir";
-
-	return;
-}*/
-
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -13,6 +13,7 @@
 
 // * Called from ucp_pm with mode == 'compose'
 
+global $_CLASS;
 
 load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 $_CLASS['forums_auth']->acl($_CLASS['core_user']->data);
@@ -46,7 +47,6 @@
 	$to_user_id     = get_variable('u', 'REQUEST', 0);
   	$to_group_id    = get_variable('g', 'REQUEST', 0);
 	$msg_id			= get_variable('p', 'REQUEST', 0);
-	$quote_post		= get_variable('q', 'REQUEST', 0);
 	$draft_id		= get_variable('d', 'REQUEST', 0);
 	$lastclick		= get_variable('lastclick', 'REQUEST', 0);
 	$message_text = $subject = '';
@@ -58,8 +58,7 @@
 	$preview	= isset($_POST['preview']);
 	$save		= isset($_POST['save']);
 	$load		= isset($_POST['load']);
-	$cancel		= isset($_POST['cancel']);
-	$confirm	= isset($_POST['confirm']);
+	$cancel		= (isset($_POST['cancel']) && !isset($_POST['save']));
 	$delete		= isset($_POST['delete']);
 
 	$remove_u	= isset($_REQUEST['remove_u']);
@@ -67,18 +66,17 @@
 	$add_to		= isset($_REQUEST['add_to']);
 	$add_bcc	= isset($_REQUEST['add_bcc']);
 
-	$refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || $save || $load
+	$refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || $save || $load
 		|| $remove_u || $remove_g || $add_to || $add_bcc;
 
-	$action		= ($delete && !$preview && !$refresh && $submit) ? 'delete' : $action;
+	$action		= ($delete && !$preview && !$refresh && $submit) ? 'delete' : $action;
 
 	$error = array();
-	$current_time = gmtime();
 
 	// Was cancel pressed? If so then redirect to the appropriate page
-	if ($cancel || ($current_time - $lastclick < 2 && $submit))
+	if ($cancel || ($_CLASS['core_user']->time - $lastclick < 2 && $submit))
 	{
-		$redirect = generate_link("Control_Panel&amp;i=$id&amp;mode=view_messages&amp;action=view_message" . (($msg_id) ? "&amp;p=$msg_id" : ''));
+		$redirect = generate_link("control_panel&amp;i=$id&amp;mode=view&amp;action=view_message" . (($msg_id) ? "&amp;p=$msg_id" : ''));
 		redirect($redirect);
 	}
 
@@ -104,6 +102,7 @@
 		case 'reply':
 		case 'quote':
 		case 'forward':
+		case 'quotepost':
 			if (!$msg_id)
 			{
 				trigger_error('NO_MESSAGE');
@@ -114,7 +113,7 @@
 				trigger_error('NO_AUTH_SEND_MESSAGE');
 			}
 
-			if ($quote_post)
+			if ($action == 'quotepost')
 			{
 				$sql = 'SELECT p.post_text as message_text, p.poster_id as author_id, p.post_time as message_time, p.bbcode_bitfield, p.bbcode_uid, p.enable_sig, p.enable_html, p.enable_smilies, p.enable_magic_url, t.topic_title as message_subject, u.username as quote_username
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . CORE_USERS_TABLE . " u
@@ -159,7 +158,7 @@
 				trigger_error('NO_MESSAGE');
 			}
 
-			$sql = 'SELECT msg_id, unread, new, author_id, folder_id
+			$sql = 'SELECT msg_id, pm_unread, pm_new, author_id, folder_id
 				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']->data['user_id'] . "
 					AND msg_id = $msg_id";
@@ -181,43 +180,72 @@
 	if ($sql)
 	{
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+		$post = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		
+		if (!$post)
 		{
 			trigger_error('NO_MESSAGE');
 		}
+	
+		$msg_id			= (int) $post['msg_id'];
+		$folder_id		= isset($post['folder_id']) ? $post['folder_id'] : 0;
+		$message_text	= isset($post['message_text']) ? $post['message_text'] : '';
 
-		extract($row);
-		$_CLASS['core_db']->free_result($result);
-		
-		$msg_id = (int) $msg_id;
-		$enable_urls = $enable_magic_url;
+		if (!$post['author_id'] && $msg_id)
+		{
+			trigger_error('NO_AUTHOR');
+		}
 
-		if (!$author_id && $msg_id)
-		{
-			trigger_error('NO_AUTHOR');
+		if ($action === 'quotepost')
+		{
+			// Decode text for message display
+			decode_message($message_text, $post['bbcode_uid']);
 		}
 
-		if (($action == 'reply' || $action == 'quote') && empty($address_list) && !$refresh && !$submit && !$preview)
+		if ($action !== 'delete')
 		{
-			$address_list = array('u' => array($author_id => 'to'));
+			$enable_urls = $post['enable_magic_url'];
+			$enable_sig = isset($post['enable_sig']) ? $post['enable_sig'] : 0;
+
+			$message_attachment = isset($post['message_attachement']) ? $post['message_attachement'] : 0;
+			$message_subject = $post['message_subject'];
+			$message_time = $post['message_time'];
+			$bbcode_uid = $post['bbcode_uid'];
+
+			$quote_username = isset($post['quote_username']) ? $post['quote_username'] : '';
+			$icon_id = isset($post['icon_id']) ? $post['icon_id'] : 0;
+
+			if (($action === 'reply' || $action === 'quote' || $action === 'quotepost') && empty($address_list) && !$refresh && !$submit && !$preview)
+			{
+				$address_list = array('u' => array($post['author_id'] => 'to'));
+			}
+			elseif ($action === 'edit' && empty($address_list) && !$refresh && !$submit && !$preview)
+			{
+				// Rebuild TO and BCC Header
+				$address_list = rebuild_header(array('to' => $post['to_address'], 'bcc' => $post['bcc_address']));
+			}
+
+			if ($action == 'quotepost')
+			{
+				$check_value = 0;
+			}
+			else
+			{
+				$check_value = (($post['enable_bbcode']+1) << 8) + (($post['enable_smilies']+1) << 4) + (($enable_urls+1) << 2) + (($post['enable_sig']+1) << 1);
+			}
 		}
-		elseif ($action == 'edit' && empty($address_list) && !$refresh && !$submit && !$preview)
-		{
-			// Rebuild TO and BCC Header
-			$address_list = rebuild_header(array('to' => $to_address, 'bcc' => $bcc_address));
-		}
-		$check_value = (($enable_html+1) << 16) + (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
 	}
 	else
 	{
 		$message_attachment = 0;
+		$message_text = $message_subject = '';
 
-		if ($to_user_id && $action == 'post')
+		if ($to_user_id && $action === 'post')
 		{
 			$address_list['u'][$to_user_id] = 'to';
 		}
-		else if ($to_group_id && $action == 'post')
+		else if ($to_group_id && $action === 'post')
 		{
 			$address_list['g'][$to_group_id] = 'to';
 		}
@@ -229,9 +257,9 @@
 		trigger_error('NO_AUTH_GROUP_MESSAGE');
 	}
 
-	if ($action == 'edit' && !$refresh && !$preview && !$submit)
+	if ($action === 'edit' && !$refresh && !$preview && !$submit)
 	{
-		if (!($message_time > time() - $config['pm_edit_time'] || !$config['pm_edit_time']))
+		if (!($message_time > $_CLASS['core_user']->time - ($config['pm_edit_time'] * 60) || !$config['pm_edit_time']))
 		{
 			trigger_error('CANNOT_EDIT_MESSAGE_TIME');
 		}
@@ -248,39 +276,36 @@
 
 	$message_parser = new parse_message();
 
-	$message_subject = isset($message_subject) ? $message_subject : '';
-	$message_parser->message = ($action == 'reply') ? '' : (isset($message_text) ? $message_text : '');
+	$message_parser->message = ($action == 'reply') ? '' : $message_text;
 	unset($message_text);
 
-	$s_action = "Control_Panel&amp;i=$id&amp;mode=$mode&amp;action=$action";
+	$s_action = "control_panel&amp;i=$id&amp;mode=$mode&amp;action=$action";
 	$s_action .= ($msg_id) ? "&amp;p=$msg_id" : '';
-	$s_action .= ($quote_post) ? "&amp;q=1" : '';
 
 	// Delete triggered ?
-	if ($action == 'delete')
+	if ($action === 'delete')
 	{
 		// Folder id has been determined by the SQL Statement
 		// $folder_id = request_var('f', PRIVMSGS_NO_BOX);
 
-		$s_hidden_fields = '<input type="hidden" name="p" value="' . $msg_id . '" /><input type="hidden" name="f" value="' . $folder_id . '" /><input type="hidden" name="action" value="delete" />';
+		$s_hidden_fields = array(
+			'p'			=> $msg_id,
+			'f'			=> $folder_id,
+			'action'	=> 'delete'
+		);
 
-		// Do we need to confirm ?
-		if (confirm_box(true))
+		if (display_confirmation('DELETE_MESSAGE', $s_hidden_fields))
 		{
 			delete_pm($_CLASS['core_user']->data['user_id'], $msg_id, $folder_id);
 						
 			// TODO - jump to next message in "history"?
-			$meta_info = generate_link('Control_Panel&amp;i=pm&amp;folder='.$folder_id);
+			$meta_info = generate_link('control_panel&amp;i=pm&amp;folder='.$folder_id);
 			$message = $_CLASS['core_user']->lang['MESSAGE_DELETED'];
 
-			meta_refresh(3, $meta_info);
+			$_CLASS['core_display']->meta_refresh(3, $meta_info);
 			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_FOLDER'], '<a href="' . $meta_info . '">', '</a>');
 			trigger_error($message);
 		}
-		else
-		{
-			confirm_box(false, 'DELETE_MESSAGE', $s_hidden_fields);
-		}
 	}
 
 	// Handle User/Group adding/removing
@@ -308,7 +333,7 @@
 		
 		$_CLASS['core_db']->free_result($result);
 	}
-	
+
 	if (!in_array($action, array('quote', 'edit', 'delete', 'forward')))
 	{
 		$enable_sig		= ($config['allow_sig'] && $_CLASS['forums_auth']->acl_get('u_sig') && $_CLASS['core_user']->user_data_get('attachsig'));
@@ -320,11 +345,12 @@
 	$enable_magic_url = $drafts = false;
 
 	// User own some drafts?
-	if ($_CLASS['forums_auth']->acl_get('u_savedrafts') && $action != 'delete')
+	if ($_CLASS['forums_auth']->acl_get('u_savedrafts') && $action !== 'delete')
 	{
 		$sql = 'SELECT draft_id
 			FROM ' . FORUMS_DRAFTS_TABLE . '
-			WHERE (forum_id = 0 AND topic_id = 0)
+			WHERE forum_id = 0
+				AND topic_id = 0
 				AND user_id = ' . $_CLASS['core_user']->data['user_id'] . 
 				(($draft_id) ? " AND draft_id <> $draft_id" : '');
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
@@ -336,7 +362,7 @@
 		$_CLASS['core_db']->free_result($result);
 	}
 
-	if ($action == 'edit' || $action == 'forward')
+	if ($action == 'edit')
 	{
 		$message_parser->bbcode_uid = $bbcode_uid;
 	}
@@ -359,29 +385,42 @@
 	if ($save && $_CLASS['forums_auth']->acl_get('u_savedrafts'))
 	{
 		$subject = request_var('subject', '', true);
-		$subject = (!$subject && $action != 'post') ? $_CLASS['core_user']->lang['NEW_MESSAGE'] : $subject;
+		$subject = (!$subject && $action !== 'post') ? $_CLASS['core_user']->lang['NEW_MESSAGE'] : $subject;
 		$message = request_var('message', '', true);
 
 		if ($subject && $message)
 		{
-			$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
-				'user_id'	=> $_CLASS['core_user']->data['user_id'],
-				'topic_id'	=> 0,
-				'forum_id'	=> 0,
-				'save_time'	=> $current_time,
-				'draft_subject' => $subject,
-				'draft_message' => $message));
-			$_CLASS['core_db']->query($sql);
+			$s_hidden_fields = array(
+				'mode'		=> $mode,
+				'action'	=> $action,
+				'save'		=> true,
+				'subject'	=> $subject,
+				'message'	=> $message,
+				'u'			=> $to_user_id,
+				'g'			=> $to_group_id,
+				'p'			=> $msg_id
+			);
+
+			if (display_confirmation('SAVE_DRAFT', $s_hidden_fields))
+			{
+				$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', array(
+					'user_id'	=> $_CLASS['core_user']->data['user_id'],
+					'topic_id'	=> 0,
+					'forum_id'	=> 0,
+					'save_time'	=> $_CLASS['core_user']->time,
+					'draft_subject' => $subject,
+					'draft_message' => $message
+				));
+				$_CLASS['core_db']->query($sql);
+		
+				$_CLASS['core_display']->meta_refresh(3, generate_link('control_panel&i=pm&mode='.$mode));
+				$message = $_CLASS['core_user']->lang['DRAFT_SAVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link('control_panel&amp;i=pm&amp;mode='.$mode).'">', '</a>');
 	
-			$_CLASS['core_display']->meta_refresh(3, generate_link('Control_Panel&i=pm&mode='.$mode));
-
-			$message = $_CLASS['core_user']->lang['DRAFT_SAVED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_UCP'], '<a href="'.generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode).'">', '</a>');
-
-			trigger_error($message);
+				trigger_error($message);
+			}
 		}
 
-		unset($subject);
-		unset($message);
+		unset($subject, $message);
 	}
 
 	// Load Draft
@@ -394,12 +433,14 @@
 				AND forum_id = 0
 				AND user_id = " . $_CLASS['core_user']->data['user_id'];
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
-	
-		if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		if ($row)
 		{
-			$_REQUEST['subject'] = $row['draft_subject'];
-			$_REQUEST['message'] = $row['draft_message'];
-			$refresh = true;
+			$message_parser->message = $row['draft_message'];
+			$message_subject = $row['draft_subject'];
+
 			$_CLASS['core_template']->assign('S_DRAFT_LOADED', true);
 		}
 		else
@@ -430,7 +471,7 @@
 
 		if ($submit)
 		{
-			$status_switch  = (($enable_html+1) << 16) + (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
+			$status_switch	= (($enable_bbcode+1) << 8) + (($enable_smilies+1) << 4) + (($enable_urls+1) << 2) + (($enable_sig+1) << 1);
 			$status_switch = ($status_switch != $check_value);
 		}
 		else
@@ -440,22 +481,10 @@
 
 		// Parse Attachments - before checksum is calculated
 		$message_parser->parse_attachments('fileupload', $action, 0, $submit, $preview, $refresh, true);
-		
-		// Grab md5 'checksum' of new message
-		$message_md5 = md5($message_parser->message);
 
-		// Check checksum ... don't re-parse message if the same
-		$update_message = ($action != 'edit' || $message_md5 != $post_checksum || $status_switch || $preview) ? true : false;
+		// Parse message
+		$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
 
-		if ($update_message)
-		{
-			$message_parser->parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
-		}
-		else
-		{
-			$message_parser->bbcode_bitfield = $bbcode_bitfield;
-		}
-
 		if ($action != 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['forums_auth']->acl_get('u_ignoreflood'))
 		{
 			// Flood check
@@ -463,7 +492,7 @@
 
 			if ($last_post_time)
 			{
-				if ($last_post_time && ($current_time - $last_post_time) < intval($config['flood_interval']))
+				if ($last_post_time && ($_CLASS['core_user']->time - $last_post_time) < intval($config['flood_interval']))
 				{
 					$error[] = $_CLASS['core_user']->lang['FLOOD_ERROR'];
 				}
@@ -491,6 +520,9 @@
 		{
 			$pm_data = array(
 				'msg_id'				=> (int) $msg_id,
+				'from_user_id'			=> $_CLASS['core_user']->data['user_id'],
+				'from_user_ip'			=> $_CLASS['core_user']->data['user_ip'],
+				'from_username'			=> $_CLASS['core_user']->data['username'],
 				'reply_from_root_level'	=> (isset($root_level)) ? (int) $root_level : 0,
 				'reply_from_msg_id'		=> (int) $msg_id,
 				'icon_id'				=> (int) $icon_id,
@@ -499,8 +531,7 @@
 				'enable_html' 			=> (bool) $enable_html,
 				'enable_smilies'		=> (bool) $enable_smilies,
 				'enable_urls'			=> (bool) $enable_urls,
-				'message_md5'			=> (int) $message_md5,
-				'bbcode_bitfield'		=> (int) $message_parser->bbcode_bitfield,
+				'bbcode_bitfield'		=> $message_parser->bbcode_bitfield,
 				'bbcode_uid'			=> $message_parser->bbcode_uid,
 				'message'				=> $message_parser->message,
 				'attachment_data'		=> $message_parser->attachment_data,
@@ -508,24 +539,24 @@
 				'address_list'			=> $address_list
 			);
 			unset($message_parser);
-			
+
 			// ((!$message_subject) ? $subject : $message_subject)
-			$msg_id = submit_pm($action, $subject, $pm_data, $update_message);
+			$msg_id = submit_pm($action, $subject, $pm_data, true);
 
-			$return_message_url = generate_link('Control_Panel&amp;i=pm&amp;mode=view_messages&amp;action=view_message&amp;p=' . $msg_id);
-			$return_folder_url = generate_link('Control_Panel&amp;i=pm&amp;folder=outbox');
+			$return_message_url = generate_link('control_panel&amp;i=pm&amp;mode=view&amp;p=' . $msg_id);
+			$return_folder_url = generate_link('control_panel&amp;i=pm&amp;folder=outbox');
 			$_CLASS['core_display']->meta_refresh(3, $return_message_url);
 
 			$message = $_CLASS['core_user']->lang['MESSAGE_STORED'] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['VIEW_MESSAGE'], '<a href="' . $return_message_url . '">', '</a>') . '<br /><br />' . sprintf($_CLASS['core_user']->lang['CLICK_RETURN_FOLDER'], '<a href="' . $return_folder_url . '">', '</a>', $_CLASS['core_user']->lang['PM_OUTBOX']);
 			trigger_error($message);
 		}
 
-		$message_subject = stripslashes($subject);
+		$message_subject = $subject;
 	}
 
 	if (empty($error) && $preview)
 	{
-		$post_time = ($action == 'edit') ? $post_time : $current_time;
+		$post_time = ($action === 'edit') ? $post_time : $_CLASS['core_user']->time;
 
 		$preview_message = $message_parser->format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
 
@@ -552,7 +583,7 @@
 		// Attachment Preview
 		if (!empty($message_parser->attachment_data))
 		{
-			require_once(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+			require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 			$null = array();
 					
 			$attachment_data = $message_parser->attachment_data;
@@ -586,27 +617,36 @@
 			'S_DISPLAY_PREVIEW'		=> true
 		));
 
-		unset($preview_message, $preview_subject, $preview_signature, $preview_signature);
+		unset($message_text, $preview_message, $preview_subject, $preview_signature, $preview_signature);
 	}
 
 	// Decode text for message display
-	$bbcode_uid = (($action == 'quote' || $action == 'forward') && !$preview && !$refresh && empty($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
+	$bbcode_uid = (($action === 'quote' || $action === 'forward') && !$preview && !$refresh && empty($error)) ? $bbcode_uid : $message_parser->bbcode_uid;
 
 	$message_parser->decode_message($bbcode_uid);
 
-	if ($action == 'quote' && !$preview && !$refresh)
+	if (($action === 'quote' || $action === 'quotepost') && !$preview && !$refresh)
 	{
-		$message_parser->message = '[quote="' . $quote_username . '"]' . censor_text(trim($message_parser->message)) . "[/quote]\n";
+		if ($action === 'quotepost')
+		{
+			$post_id = request_var('p', 0);
+			$message_link = "[url=" . generate_link("forums&amp;file=viewtopic&amp;p={$post_id}#p{$post_id}")."]{$message_subject}[/url]\n";
+		}
+		else 
+		{
+			$message_link = '';
+		}
+		$message_parser->message = $message_link . '[quote="' . $quote_username . '"]' . censor_text(trim($message_parser->message)) . "[/quote]\n";
 	}
 	
-	if (($action == 'reply' || $action == 'quote') && !$preview && !$refresh)
+	if (($action === 'reply' || $action === 'quote' || $action === 'quotepost') && !$preview && !$refresh)
 	{
 		$message_subject = ((!preg_match('/^Re:/', $message_subject)) ? 'Re: ' : '') . censor_text($message_subject);
 	}
 
-	if ($action == 'forward' && !$preview && !$refresh)
+	if ($action === 'forward' && !$preview && !$refresh)
 	{
-		$fwd_to_field = write_pm_addresses(array('to' => $to_address), 0, true);
+		$fwd_to_field = write_pm_addresses(array('to' => $post['to_address']), 0, true);
 
 		$forward_text = array();
 		$forward_text[] = $_CLASS['core_user']->lang['FWD_ORIGINAL_MESSAGE'];
@@ -615,7 +655,7 @@
 		$forward_text[] = sprintf($_CLASS['core_user']->lang['FWD_FROM'], $quote_username);
 		$forward_text[] = sprintf($_CLASS['core_user']->lang['FWD_TO'], implode(', ', $fwd_to_field['to']));
 
-		$message_parser->message = implode("\n", $forward_text) . "\n\n[quote=\"[url=" . generate_link("Members_List&mode=viewprofile&u={$author_id}]{$quote_username}")."[/url]\"]\n" . censor_text(trim($message_parser->message)) . "\n[/quote]";
+		$message_parser->message = implode("\n", $forward_text) . "\n\n[quote=\"[url=" . generate_link("members_list&mode=viewprofile&u={$post['author_id']}")."{$quote_username}[/url]\"]\n" . censor_text(trim($message_parser->message)) . "\n[/quote]";
 		$message_subject = ((!preg_match('/^Fwd:/', $message_subject)) ? 'Fwd: ' : '') . censor_text($message_subject);
 	}
 
@@ -646,25 +686,27 @@
 	{
 		// Get Usernames and Group Names
 		$result = array();
-		if (isset($address_list['u']) && !empty($address_list['u']))
+
+		if (!empty($address_list['u']))
 		{
 			$result['u'] = $_CLASS['core_db']->query('SELECT user_id as id, username as name, user_colour as colour 
 				FROM ' . CORE_USERS_TABLE . ' 
 				WHERE user_id IN (' . implode(', ', array_map('intval', array_keys($address_list['u']))) . ')');
 		}
 		
-		if (isset($address_list['g']) && !empty($address_list['g']))
+		if (!empty($address_list['g']))
 		{
 			$result['g'] = $_CLASS['core_db']->query('SELECT group_id as id, group_name as name, group_colour as colour 
-				FROM ' . GROUPS_TABLE . ' 
+				FROM ' . CORE_GROUPS_TABLE . ' 
 				WHERE group_receive_pm = 1 AND group_id IN (' . implode(', ', array_map('intval', array_keys($address_list['g']))) . ')');
 		}
 
 		$u = $g = array();
 
-		foreach (array('u', 'g') as $type)
+		$_types = array('u', 'g');
+		foreach ($_types as $type)
 		{
-			if (isset($result[$type]))
+			if (isset($result[$type]) && $result[$type])
 			{
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result[$type]))
 				{
@@ -692,13 +734,13 @@
 				
 				$_CLASS['core_template']->assign_vars_array($field . '_recipient', array(
 					'NAME'		=> ${$type}[$id]['name'],
-					'IS_GROUP'	=> ($type == 'g'),
-					'IS_USER'	=> ($type == 'u'),
+					'IS_GROUP'	=> ($type === 'g'),
+					'IS_USER'	=> ($type === 'u'),
 					'COLOUR'	=> (${$type}[$id]['colour']) ? ${$type}[$id]['colour'] : '',
 					'UG_ID'		=> $id,
-					'U_VIEW'	=> ($type == 'u') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id),
-					'TYPE'		=> $type)
-				);
+					'U_VIEW'	=> ($type == 'u') ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) : generate_link('members_list&amp;mode=group&amp;g=' . $id),
+					'TYPE'		=> $type
+				));
 			}
 		}
 	}
@@ -729,6 +771,10 @@
 			$page_title = $_CLASS['core_user']->lang['POST_QUOTE_PM'];
 		break;
 
+		case 'quotepost':
+			$page_title = $_CLASS['core_user']->lang['POST_PM_POST'];
+		break;
+
 		case 'reply':
 			$page_title = $_CLASS['core_user']->lang['POST_REPLY_PM'];
 		break;
@@ -746,7 +792,7 @@
 		break;
 	}
 
-	$s_hidden_fields = '<input type="hidden" name="lastclick" value="' . $current_time . '" />';
+	$s_hidden_fields = '<input type="hidden" name="lastclick" value="' . $_CLASS['core_user']->time . '" />';
 	$s_hidden_fields .= (isset($check_value)) ? '<input type="hidden" name="status_switch" value="' . $check_value . '" />' : '';
 	$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '<input type="hidden" name="draft_loaded" value="' . ((isset($_REQUEST['draft_loaded'])) ? intval($_REQUEST['draft_loaded']) : $draft_id) . '" />' : '';
 
@@ -831,7 +877,7 @@
 		}
 		
 		// Build usernames to add
-		$usernames = (isset($_REQUEST['username'])) ? array(request_var('username', '')) : array();
+		$usernames = isset($_REQUEST['username']) ? array(request_var('username', '')) : array();
 		$username_list = request_var('username_list', '');
 		if ($username_list)
 		{
@@ -841,7 +887,7 @@
 		// Reveal the correct user_ids
 		if (!empty($usernames))
 		{
-			require_once(SITE_FILE_ROOT.'includes/functions_user.php');
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
 			$user_id_ary = user_get_id($usernames, $difference);
 
@@ -864,7 +910,6 @@
 			$address_list['u'][$user_id] = $type;
 		}
 	}
-
 }
 
 // Return number of recipients

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_options.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_options.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_options.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -15,7 +15,7 @@
 {
 	global $_CLASS, $config;
 
-	$redirect_url = generate_link('Control_Panel&i=pm&mode=options');
+	$redirect_url = generate_link('control_panel&i=pm&mode=options');
 	
 	$_CLASS['core_template']->assign_array(array(
 		'ERROR_MESSAGE'				=> false,
@@ -254,7 +254,7 @@
 				$_CLASS['core_user']->data['user_full_folder'] = PRIVMSGS_INBOX;
 			}
 
-			$meta_info = generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode);
+			$meta_info = generate_link('control_panel&amp;i=pm&amp;mode='.$mode);
 			$message = $_CLASS['core_user']->lang['FOLDER_REMOVED'];
 
 			$_CLASS['core_display']->meta_refresh(3, $meta_info);
@@ -326,7 +326,7 @@
 
 		if (!$delete_id)
 		{
-			redirect(generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode));
+			redirect(generate_link('control_panel&amp;i=pm&amp;mode='.$mode));
 		}
 
 		$s_hidden_fields = '<input type="hidden" name="delete_rule[' . $delete_id . ']" value="1" />';
@@ -339,7 +339,7 @@
 					AND rule_id = $delete_id";
 			$_CLASS['core_db']->query($sql);
 
-			$meta_info = generate_link("Control_Panel$SID&amp;i=pm&amp;mode=$mode");
+			$meta_info = generate_link("control_panel$SID&amp;i=pm&amp;mode=$mode");
 			$message = $_CLASS['core_user']->lang['RULE_DELETED'];
 
 			$_CLASS['core_display']->meta_refresh(3, $meta_info);

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -11,7 +11,6 @@
 // 
 // -------------------------------------------------------------
 
-// * Called from ucp_pm with mode == 'view_messages' && action == 'view_folder'
 $_CLASS['core_template']->assign_array(array(
 	'S_SHOW_RECIPIENTS'	=> false,
 	'messagerow'		=> false,
@@ -24,15 +23,18 @@
 	
 	$limit = 10;
 	$icons = obtain_icons();
+	$submit_export = (isset($_POST['submit_export'])) ? true : false;
 
-	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
+	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']->data['user_id'], $parent_class->link_parent, $type);
+
+	$color_rows = array('marked', 'replied', 'friend', 'foe');//, 'message_reported'
 	
 	foreach ($color_rows as $var)
 	{
 		$_CLASS['core_template']->assign_vars_array('pm_colour_info', array(
 			'IMG'	=> $_CLASS['core_user']->img("pm_{$var}", ''),
 			'CLASS' => "pm_{$var}_colour",
-			'LANG'	=> $_CLASS['core_user']->lang[strtoupper($var) . '_MESSAGE'])
+			'LANG'	=> $_CLASS['core_user']->get_lang(strtoupper($var) . '_MESSAGE'))
 		);
 	}
 
@@ -44,6 +46,20 @@
 		$s_mark_options .= '<option value="' . $mark_option . '">' . $_CLASS['core_user']->get_lang(strtoupper($mark_option)) . '</option>';
 	}
 
+	// We do the folder moving options here too, for template authors to use...
+	$s_folder_move_options = '';
+	foreach ($folder as $f_id => $folder_ary)
+	{
+		if ($f_id == PRIVMSGS_OUTBOX || $f_id == PRIVMSGS_SENTBOX || $f_id == $folder_id)
+		{
+			continue;
+		}
+	
+		$s_folder_move_options .= '<option' . (($f_id != PRIVMSGS_INBOX) ? ' class="blue"' : '') . ' value="' . $f_id . '">';
+		$s_folder_move_options .= sprintf($_CLASS['core_user']->get_lang('MOVE_MARKED_TO_FOLDER'), $folder_ary['folder_name']);
+		$s_folder_move_options .= (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '</option>';
+	}
+
 	$friend = $foe = array();
 
 	// Get friends and foes
@@ -60,12 +76,10 @@
 	$_CLASS['core_db']->free_result($result);
 
 	$_CLASS['core_template']->assign_array(array(
-		'S_UNREAD'		=> ($type == 'unread'),
+		'S_UNREAD'		=> ($type === 'unread'),
 		'S_MARK_OPTIONS'=> $s_mark_options)
 	);
 
-	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']->data['user_id'], $parent_class->link_parent, $type);
-
 	// Okay, lets dump out the page ...
 	if (!empty($folder_info['pm_list']))
 	{
@@ -77,7 +91,9 @@
 			foreach ($folder_info['rowset'] as $message_id => $row)
 			{
 				$address[$message_id] = rebuild_header(array('to' => $row['to_address'], 'bcc' => $row['bcc_address']));
-				foreach (array('u', 'g') as $save)
+
+				$_save = array('u', 'g');
+				foreach ($_save as $save)
 				{
 					if (isset($address[$message_id][$save]) && sizeof($address[$message_id][$save]))
 					{
@@ -89,12 +105,13 @@
 				}
 			}
 		
-			foreach (array('u', 'g') as $ug_type)
+			$_types = array('u', 'g');
+			foreach ($_types as $ug_type)
 			{
-				if (isset($recipient_list[$ug_type]) && sizeof($recipient_list[$ug_type]))
+				if (!empty($recipient_list[$ug_type]))
 				{
 					$sql = ($ug_type === 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . CORE_USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . CORE_GROUPS_TABLE . ' WHERE group_id';
-					$sql .= ' IN (' . implode(', ', array_keys($recipient_list[$ug_type])) . ')';
+					$sql .= ' IN (' . implode(', ', array_map('intval', array_keys($recipient_list[$ug_type]))) . ')';
 	
 					$result = $_CLASS['core_db']->query($sql);
 
@@ -112,11 +129,10 @@
 				{
 					foreach ($id_ary as $ug_id => $_id)
 					{
-						$address_list[$message_id][] = (($type == 'u') ? '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u='.$ug_id).'">' : '<a href="'.generate_link('Members_List&amp;mode=group&amp;g='.$ug_id).'">') . (($recipient_list[$type][$ug_id]['colour']) ? '<span style="color:#' . $recipient_list[$type][$ug_id]['colour'] . '">' : '<span>') . $recipient_list[$type][$ug_id]['name'] . '</span></a>';
+						$address_list[$message_id][] = (($type === 'u') ? '<a href="'.generate_link('members_list&amp;mode=viewprofile&amp;u='.$ug_id).'">' : '<a href="'.generate_link('members_list&amp;mode=group&amp;g='.$ug_id).'">') . (($recipient_list[$type][$ug_id]['colour']) ? '<span style="color:#' . $recipient_list[$type][$ug_id]['colour'] . '">' : '<span>') . $recipient_list[$type][$ug_id]['name'] . '</span></a>';
 					}
 				}
 			}
-			
 			unset($recipient_list, $address);
 		}
 
@@ -124,19 +140,19 @@
 		{
 			$row =& $folder_info['rowset'][$message_id];
 
-			$folder_img = ($row['unread']) ? 'folder_new' : 'folder';
-			$folder_alt = ($row['unread']) ? 'NEW_MESSAGES' : 'NO_NEW_MESSAGES';
+			$folder_img = ($row['pm_unread']) ? 'folder_new' : 'folder';
+			$folder_alt = ($row['pm_unread']) ? 'NEW_MESSAGES' : 'NO_NEW_MESSAGES';
 
 			// Generate all URIs ...
-			$message_author = '<a href="'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '">' . $row['username'] . '</a>';
+			$message_author = '<a href="'.generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '">' . $row['username'] . '</a>';
 			$view_message_url = generate_link($parent_class->link_parent."&amp;f=$folder_id&amp;p=$message_id");
 			$remove_message_url = generate_link($parent_class->link_parent.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
 			
 			$row_indicator = '';
 			foreach ($color_rows as $var)
 			{
-				if (($var != 'friend' && $var != 'foe' && $row[$var]) || 
-					(($var == 'friend' || $var == 'foe') && isset(${$var}[$row['author_id']])))
+				if (($var !== 'friend' && $var !== 'foe' && $row['pm_' . $var]) || 
+					(($var == 'friend' || $var == 'foe') && isset(${$var}[$row['author_id']]) && ${$var}[$row['author_id']]))
 				{
 					$row_indicator = $var;
 					break;
@@ -160,23 +176,22 @@
 				'ATTACH_ICON_IMG'	=> ($row['message_attachment']) ? $_CLASS['core_user']->img('icon_attach', $_CLASS['core_user']->lang['TOTAL_ATTACHMENTS']) : '',
 				//'S_PM_REPORTED'		=> (!empty($row['message_reported'])) ? true : false,
 				'S_PM_REPORTED'		=> '',
-				'S_PM_DELETED'		=> ($row['deleted']) ? true : false,
+				'S_PM_DELETED'		=> ($row['pm_deleted']),
 				
-				'U_VIEW_PM'			=> ($row['deleted']) ? '' : $view_message_url,
-				'U_REMOVE_PM'		=> ($row['deleted']) ? $remove_message_url : '',
+				'U_VIEW_PM'			=> ($row['pm_deleted']) ? '' : $view_message_url,
+				'U_REMOVE_PM'		=> ($row['pm_deleted']) ? $remove_message_url : '',
 				
 				'RECIPIENTS'		=> ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? implode(', ', $address_list[$message_id]) : '',
 				'U_MCP_REPORT'		=> generate_link('forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
 //				'U_MCP_QUEUE'		=> "mcp.$phpEx?sid={$_CLASS['core_user']->session_id}&amp;mode=mod_queue&amp;t=$topic_id")
 			);
 		}
-		
 		unset($folder_info['rowset']);
 		
 		$_CLASS['core_template']->assign_array(array(
-			'S_SHOW_RECIPIENTS'	=> ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? true : false,
-			'S_SHOW_COLOUR_LEGEND'	=> true)
-		);
+			'S_SHOW_RECIPIENTS'		=> ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? true : false,
+			'S_SHOW_COLOUR_LEGEND'	=> true
+		));
 	}
 }
 
@@ -189,10 +204,6 @@
 	$limit = 10;
 	$start = get_variable('start', 'REQUEST', 0, 'int');
 
-	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']->data['user_post_show_days'])) ? $_CLASS['core_user']->data['user_post_show_days'] : 0));
-	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']->data['user_post_sortby_type'])) ? $_CLASS['core_user']->data['user_post_sortby_type'] : 't'));
-	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']->data['user_post_sortby_dir'])) ? $_CLASS['core_user']->data['user_post_sortby_dir'] : 'd'));
-
 	$sort_days	= get_variable('st', 'REQUEST', 0, 'int');
 	$sort_key	= get_variable('sk', 'REQUEST', 't');
 	$sort_dir	= get_variable('sd', 'REQUEST', 'd');
@@ -209,7 +220,7 @@
 
 	if ($type !== 'folder')
 	{
-		$folder_sql = ($type === 'unread') ? 't.unread = 1' : 't.msg_new = 1';
+		$folder_sql = ($type === 'unread') ? 't.pm_unread = 1' : 't.pm_new = 1';
 		$folder_id = PRIVMSGS_INBOX;
 	}
 	else
@@ -222,6 +233,11 @@
 	{
 		$min_post_time = $_CLASS['core_user']->time - ($sort_days * 86400);
 
+		if (isset($_POST['sort']))
+		{
+			$start = 0;
+		}
+
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
 			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . " p
 			WHERE $folder_sql
@@ -229,12 +245,6 @@
 				AND t.msg_id = p.msg_id
 				AND p.message_time >= $min_post_time";
 		$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-		if (isset($_POST['sort']))
-		{
-			$start = 0;
-		}
-
 		$pm_count = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['pm_count'] : 0;
 		$_CLASS['core_db']->free_result($result);
 
@@ -271,17 +281,20 @@
 		$sql_limit_time = '';
 	}
 
+	$pagination	= generate_pagination("$url&amp;mode=view&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param", $pm_count, $limit, $start);
+
 	$_CLASS['core_template']->assign_array(array(
-		'PAGINATION'		=> generate_pagination("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param", $pm_count, $limit, $start),
+		'PAGINATION'		=> $pagination['formated'],
+		'PAGINATION_ARRAY'	=> $pagination['array'],
+
 		'PAGE_NUMBER'		=> on_page($pm_count, $limit, $start),
 		'TOTAL_MESSAGES'	=> (($pm_count == 1) ? $_CLASS['core_user']->lang['VIEW_PM_MESSAGE'] : sprintf($_CLASS['core_user']->lang['VIEW_PM_MESSAGES'], $pm_count)),
 
-		//'POST_IMG'			=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']->img('btn_post_pm', 'POST_PM'),
+		//'POST_IMG'		=> (!$auth->acl_get('u_sendpm')) ? $user->img('button_topic_locked', 'PM_LOCKED') : $user->img('button_pm_new', 'POST_PM'),
 		'POST_IMG'			=> $_CLASS['core_user']->img('btn_post_pm', 'POST_PM'),
-
 		'REPORTED_IMG'		=> $_CLASS['core_user']->img('icon_reported', 'MESSAGE_REPORTED'),
 
-		//'L_NO_MESSAGES'		=> (!$_CLASS['auth']->acl_get('u_sendpm')) ? $_CLASS['core_user']->lang['POST_PM_LOCKED'] : $_CLASS['core_user']->lang['NO_MESSAGES'],
+		//'L_NO_MESSAGES'	=> (!$auth->acl_get('u_sendpm')) ? $user->lang['POST_PM_LOCKED'] : $user->lang['NO_MESSAGES'],
 		'L_NO_MESSAGES'		=> $_CLASS['core_user']->lang['NO_MESSAGES'],
 
 		'S_SELECT_SORT_DIR'		=> $s_sort_dir,
@@ -291,8 +304,7 @@
 
 		//'U_POST_NEW_TOPIC'	=> ($_CLASS['auth']->acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
 		'U_POST_NEW_TOPIC'	=> generate_link($url.'&amp;mode=compose&amp;action=post'), 
-
-		'S_PM_ACTION'		=> generate_link("$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id"))
+		'S_PM_ACTION'		=> generate_link("$url&amp;mode=view&amp;action=view_folder&amp;f=$folder_id"))
 	);
 
 	// Grab all pm data
@@ -333,7 +345,7 @@
 
 	$result = $_CLASS['core_db']->query_limit($sql, $sql_limit, $sql_start);
 
-	while($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
 		$rowset[$row['msg_id']] = $row;
 		$pm_list[] = $row['msg_id'];

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -20,20 +20,29 @@
 	global $_CLASS, $_CORE_CONFIG, $config;
 
 	$_CLASS['core_user']->add_lang('viewtopic');
+
 	$msg_id		= (int) $msg_id;
 	$folder_id	= (int) $folder_id;
 	$author_id	= (int) $message_row['author_id'];
 	
 	// Not able to view message, it was deleted by the sender
-	if ($message_row['deleted'])
+	if ($message_row['pm_deleted'])
 	{
 		trigger_error('NO_AUTH_READ_REMOVED_MESSAGE');
 	}
 	
+	// Do not allow hold messages to be seen
+	if ($folder_id == PRIVMSGS_HOLD_BOX)
+	{
+		trigger_error('NO_AUTH_READ_HOLD_MESSAGE');
+	}
+
 	// Grab icons
 	$icons = array();
 	obtain_icons($icons);
 
+	$bbcode = false;
+
 	// Instantiate BBCode if need be
 	if ($message_row['bbcode_bitfield'])
 	{
@@ -47,27 +56,26 @@
 	$user_info = get_user_informations($author_id, $message_row);
 
 	// Parse the message and subject
-	$message = $message_row['message_text'];
 
+	// Replace naughty words such as farty pants
+	$message_row['message_subject'] = censor_text($message_row['message_subject']);
+	$message_row['message_text'] = censor_text($message_row['message_text']);
+
 	// If the board has HTML off but the message has HTML on then we process it, else leave it alone
 	if ($message_row['enable_html'] && !$config['auth_html_pm'])
 	{
 		$message = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $message);
 	}
+
+	// Second parse bbcode here
+	if ($message_row['bbcode_bitfield'])
+	{
+		$bbcode->bbcode_second_pass($message_row['message_text'], $message_row['bbcode_uid'], $message_row['bbcode_bitfield']);
+	}
+
+	// Always process smilies after parsing bbcodes
+	$message_row['message_text'] = str_replace("\n", '<br />', smiley_text($message_row['message_text']));
 
-	// Second parse bbcode here
-	if ($message_row['bbcode_bitfield'])
-	{
-		$bbcode->bbcode_second_pass($message, $message_row['bbcode_uid'], $message_row['bbcode_bitfield']);
-	}
-
-	// Always process smilies after parsing bbcodes
-	$message = smiley_text($message);
-
-	// Replace naughty words such as farty pants
-	$message_row['message_subject'] = censor_text($message_row['message_subject']);
-	$message = str_replace("\n", '<br />', censor_text($message));
-
 	// Editing information
 	if ($message_row['message_edit_count'] && $config['display_last_edited'])
 	{
@@ -119,7 +127,7 @@
 
 	if (!empty($attachments))
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 		$null = array();
 
 		$unset_attachments = parse_inline_attachments($message, $attachments, $update_count, 0);
@@ -131,6 +139,15 @@
 		}
 		unset($unset_attachments);
 			
+		// Update the attachment download counts
+		if (!empty($update_count))
+		{
+			$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
+				SET download_count = download_count + 1 
+				WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
+			$_CLASS['core_db']->query($sql);
+		}
+
 		if (!empty($attachments))
 		{
 			$_CLASS['core_template']->assign('S_HAS_ATTACHMENTS', true);
@@ -140,15 +157,7 @@
 		unset($attachment_data, $null);
 	}
 
-	if (!mb_strpos($_CLASS['core_user']->data['session_url'], '&amp;t='.$msg_id) && !empty($update_count))
-	{
-		// Update the attachment download counts
-		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
-			SET download_count = download_count + 1 
-			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-
+	$user_info['sig'] = '';
 	$signature = ($message_row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->user_data_get('viewsigs')) ? $user_info['user_sig'] : '';
 	
 	// End signature parsing, only if needed
@@ -156,9 +165,9 @@
 	{
 		if ($user_info['user_sig_bbcode_bitfield'])
 		{
-			if (!isset($bbcode) || !$bbcode)
+			if ($bbcode === false)
 			{
-				require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+				require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 				$bbcode = new bbcode($user_info['user_sig_bbcode_bitfield']);
 			}
 
@@ -175,12 +184,13 @@
 		'AUTHOR_NAME'		=> ($user_info['user_colour']) ? '<span style="color:#' . $user_info['user_colour'] . '">' . $user_info['username'] . '</span>' : $user_info['username'],
 		'AUTHOR_RANK' 		=> $user_info['rank_title'],
 		'RANK_IMAGE' 		=> $user_info['rank_image'],
-		'AUTHOR_AVATAR'		=> (isset($user_info['avatar'])) ? $user_info['avatar'] : '',
+		'AUTHOR_AVATAR'		=> isset($user_info['avatar']) ? $user_info['avatar'] : '',
 		'AUTHOR_JOINED'		=> $_CLASS['core_user']->format_date($user_info['user_reg_date']),
 		'AUTHOR_POSTS' 		=> (!empty($user_info['user_posts'])) ? $user_info['user_posts'] : '',
 		'AUTHOR_FROM' 		=> (!empty($user_info['user_from'])) ? $user_info['user_from'] : '',
 
 		'ONLINE_IMG'		=> (!$config['load_onlinetrack']) ? '' : ((isset($user_info['online']) && $user_info['online']) ? $_CLASS['core_user']->img('btn_online', $_CLASS['core_user']->lang['ONLINE']) : $_CLASS['core_user']->img('btn_offline', $_CLASS['core_user']->lang['OFFLINE'])),
+		'S_ONLINE'			=> (!$config['load_onlinetrack']) ? false : ((isset($user_info['online']) && $user_info['online']) ? true : false),
 		'DELETE_IMG' 		=> $_CLASS['core_user']->img('btn_delete', $_CLASS['core_user']->lang['DELETE_MESSAGE']),
 		'INFO_IMG' 			=> $_CLASS['core_user']->img('btn_info', $_CLASS['core_user']->lang['VIEW_PM_INFO']),
 		'REPORT_IMG'		=> $_CLASS['core_user']->img('btn_report', $_CLASS['core_user']->lang['REPORT_PM']),
@@ -194,15 +204,15 @@
 
 		'SENT_DATE' 		=> $_CLASS['core_user']->format_date($message_row['message_time']),
 		'SUBJECT'			=> $message_row['message_subject'],
-		'MESSAGE' 			=> $message,
+		'MESSAGE' 			=> $message_row['message_text'],
 		'SIGNATURE' 		=> ($message_row['enable_sig']) ? $signature : '',
 		'EDITED_MESSAGE'	=> $l_edited_by,
 
 		'U_MCP_REPORT'		=> generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']),
 		'U_REPORT'			=> (false) ? generate_link('Forums&amp;file=report&amp;pm=' . $message_row['msg_id']) : '',
-		'U_INFO'			=> ($_CLASS['forums_auth']->acl_get('m_') && ($message_row['message_reported'] || $message_row['forwarded'])) ? generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']) : '',
+		'U_INFO'			=> ($_CLASS['forums_auth']->acl_get('m_') && ($message_row['message_reported'] || $message_row['pm_forwarded'])) ? generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']) : '',
 		'U_DELETE' 			=> generate_link("$url&amp;mode=compose&amp;action=delete&amp;f=$folder_id&amp;p=" . $message_row['msg_id']),
-		'U_AUTHOR_PROFILE' 	=> generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $author_id),
+		'U_AUTHOR_PROFILE' 	=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $author_id),
 		'U_EMAIL' 			=> $user_info['email'],
 		'U_QUOTE'			=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '',
 		'U_EDIT' 			=> (($message_row['message_time'] > time() - $config['pm_edit_time'] || !$config['pm_edit_time']) && $folder_id == PRIVMSGS_OUTBOX) ? generate_link("$url&amp;mode=compose&amp;action=edit&amp;f=$folder_id&amp;p=" . $message_row['msg_id']) : '', 
@@ -218,7 +228,7 @@
 		'U_FORWARD_PM'		=> generate_link("$url&amp;mode=compose&amp;action=forward&amp;f=$folder_id&amp;p=" . $message_row['msg_id'])
 	));
 
-	if (!isset($_REQUEST['view']) || $_REQUEST['view'] != 'print')
+	if (!isset($_REQUEST['view']) || $_REQUEST['view'] !== 'print')
 	{
 		// Message History
 		if (message_history($msg_id, $_CLASS['core_user']->data['user_id'], $message_row, $folder))
@@ -238,7 +248,7 @@
 		FROM ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . CORE_USERS_TABLE . ' u
 		WHERE t.msg_id = p.msg_id 
 			AND p.author_id = u.user_id
-			AND t.folder_id <> ' . PRIVMSGS_NO_BOX . "
+			AND t.folder_id NOT IN (' . PRIVMSGS_NO_BOX . ', ' . PRIVMSGS_HOLD_BOX . ")
 			AND t.user_id = $user_id";
 
 	if (!$message_row['root_level'])
@@ -252,12 +262,14 @@
 
 	$sql .= ' ORDER BY p.message_time ';
 	$sort_dir = (!empty($_CLASS['core_user']->data['user_sortby_dir'])) ? $_CLASS['core_user']->data['user_sortby_dir'] : 'd';
-	$sql .= ($sort_dir == 'd') ? 'ASC' : 'DESC';
+	$sql .= ($sort_dir === 'd') ? 'ASC' : 'DESC';
 
 	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
 
-	if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+	if (!$row)
 	{
+		$_CLASS['core_db']->free_result($result);
 		return false;
 	}
 
@@ -279,7 +291,7 @@
 		else
 		{
 			$rowset[$row['msg_id']] = $row;
-			$bbcode_bitfield |= $row['bbcode_bitfield'];
+			$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 		}
 	}
 	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
@@ -293,12 +305,9 @@
 	}
 	
 	// Instantiate BBCode class
-	if (!isset($bbcode) && $bbcode_bitfield)
+	if ((empty($bbcode) || $bbcode === false) && $bbcode_bitfield)
 	{
-		if (!class_exists('bbcode'))
-		{
-			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
-		}
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
 
@@ -344,7 +353,7 @@
 
 			'U_MSG_ID'			=> $row['msg_id'],
 			'U_VIEW_MESSAGE'	=> generate_link("$url&amp;f=$folder_id&amp;p=" . $row['msg_id']),
-			'U_AUTHOR_PROFILE' 	=> generate_link('Members_List&amp;mode=viewprofile&amp;u='.$author_id),
+			'U_AUTHOR_PROFILE' 	=> generate_link('members_list&amp;mode=viewprofile&amp;u='.$author_id),
 			'U_QUOTE'			=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=quote&amp;f=" . $folder_id . "&amp;p=" . $row['msg_id']) : '',
 			'U_POST_REPLY_PM' 	=> ($author_id != $_CLASS['core_user']->data['user_id']) ? generate_link("$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=" . $row['msg_id']) : '')
 		);
@@ -363,19 +372,26 @@
 	return true;
 }
 
-// Get User Informations (only for message display)
+/**
+* Get User Informations (only for message display)
+*/
 function get_user_informations($user_id, $user_row)
 {
 	global $config, $_CORE_CONFIG, $_CLASS;
 
 	if (!$user_id)
 	{
-		return;
+		return array();
 	}
 
 	if (empty($user_row))
 	{
-		$user_row = get_userdata((int) $user_id);
+		$sql = 'SELECT *
+			FROM ' . CORE_USERS_TABLE . '
+			WHERE user_id = ' . (int) $user_id;
+		$result = $_CLASS['core_db']->query($sql);
+		$user_row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 	}
 
 	// Grab ranks
@@ -410,11 +426,11 @@
 		switch ($user_row['user_avatar_type'])
 		{
 			case AVATAR_UPLOAD:
-				$avatar_img = $config['avatar_path'] . '/';
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
 			break;
 
 			case AVATAR_GALLERY:
-				$avatar_img = $config['avatar_gallery_path'] . '/';
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
 			break;
 		}
 		$avatar_img .= $user_row['user_avatar'];
@@ -448,7 +464,7 @@
 
 	if (!empty($user_row['user_allow_viewemail']))
 	{
-		$user_row['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails']) ? '' : 'mailto:' . $user_row['user_email']);
+		$user_row['email'] = ($config['board_email_form'] && $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails']) ? '' : 'mailto:' . $user_row['user_email']);
 	}
 	else
 	{

Modified: cms/trunk/modules/forums/mcp.php
===================================================================
--- cms/trunk/modules/forums/mcp.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/mcp.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -34,7 +34,7 @@
 {
 	global $_CLASS;
 
-	if ($module_name != 'queue')
+	if ($module_name !== 'queue')
 	{
 		return '';
 	}
@@ -52,7 +52,6 @@
 	switch ($mode)
 	{
 		case 'unapproved_topics':
-
 			$sql = 'SELECT COUNT(*) AS total
 				FROM ' . FORUMS_TOPICS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_list) . ')
@@ -97,7 +96,6 @@
 
 $i	= get_variable('i', 'REQUEST');
 $mode	= $i ? $i : get_variable('mode', 'REQUEST', 'front');
-$action = get_variable('action', 'REQUEST');
 $quick_mod = isset($_REQUEST['quickmod']);
 
 $post_id = get_variable('p', 'REQUEST', 0);
@@ -106,6 +104,13 @@
 $user_id = get_variable('u', 'REQUEST', 0);
 $username = get_variable('username', 'REQUEST', '');
 
+$action = (isset($_REQUEST['action']) && is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
+
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
+
 if ($mode == 'topic_logs')
 {
 	$id = 'logs';
@@ -114,21 +119,9 @@
 
 if ($mode === 'approve' || $mode === 'disapprove')
 {
-	$module = 'queue';
+	$mode = 'queue';
 }
 
-if ($action == 'merge_select')
-{
-	$mode = 'forum_view';
-}
-
-/*
-if (!$_CLASS['forums_auth']->acl_get('m_'))
-{
-	trigger_error('YOUR_NO_MODERATOR');
-}
-*/
-
 if (in_array($mode, array('split', 'split_all', 'split_beyond', 'merge', 'merge_posts')))
 {
 	$_REQUEST['action'] = $action = $mode;
@@ -249,11 +242,16 @@
 			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_notes.php';
 			script_close(false);
 		break;
+		
+		case 'queue':
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_queue.php';
+			script_close(false);
+		break;
 	}
-
 	//script_close(false);
 }
 
+$mode = ($mode !== 'front') ? $mode : $action;
 require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
 
 switch ($mode)
@@ -667,11 +665,4 @@
 	return empty($ids) ? false : array_unique($forum_ids);
 }
 
-// REMOVE
-
-function build_hidden_fields($array)
-{
-	return generate_hidden_fields($array);
-}
-
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/posting.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -191,14 +191,14 @@
 	break;
 
 	case 'edit':
-		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets('f_edit', 'm_edit', $forum_id))
+		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets(array('f_edit', 'm_edit'), $forum_id))
 		{
 			$is_authed = true;
 		}
 	break;
 
 	case 'delete':
-		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets('f_delete', 'm_delete', $forum_id))
+		if ($_CLASS['core_user']->is_user && $_CLASS['forums_auth']->acl_gets(array('f_delete', 'm_delete'), $forum_id))
 		{
 			$is_authed = true;
 		}
@@ -615,7 +615,7 @@
 
 	// If subject is all-uppercase then we make all lowercase (we do not want to be yelled at too :P)
 	// Admins/Mods might want to create all-uppercase topics, therefore we do not apply this check to them (they should know better ;))
-	if ($post_data['post_subject'] && !$_CLASS['forums_auth']->acl_gets('a_', 'm_', $forum_id))// && strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
+	if ($post_data['post_subject'] && !$_CLASS['forums_auth']->acl_gets(array('a_', 'm_'), $forum_id))// && strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
 	{
 		//$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
 		$post_data['post_subject'] = mb_strtolower(htmlentities($post_data['post_subject'], ENT_QUOTES, 'UTF-8'));
@@ -714,7 +714,7 @@
 	// notify and show user the post made between his request and the final submit
 	if (($mode == 'reply' || $mode == 'quote') && $post_data['topic_cur_post_id'] && $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
-		if (topic_review($topic_id, $forum_id, 'post_review', $topic_cur_post_id))
+		if (topic_review($topic_id, $forum_id, 'post_review', $post_data['topic_cur_post_id']))
 		{
 			$_CLASS['core_template']->assign('S_POST_REVIEW',  true);
 		}
@@ -982,7 +982,7 @@
 				'notify_set'			=> $post_data['notify_set'],
 				'poster_ip'				=> (isset($post_data['poster_ip'])) ? $post_data['poster_ip'] : $_CLASS['core_user']->ip,
 				'post_edit_locked'		=> (int) $post_data['post_edit_locked'],
-				'bbcode_bitfield'		=> (int) $message_parser->bbcode_bitfield,
+				'bbcode_bitfield'		=> $message_parser->bbcode_bitfield,
 				'bbcode_uid'			=> $message_parser->bbcode_uid,
 				'message'				=> $message_parser->message,
 				'attachment_data'		=> $message_parser->attachment_data,

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -580,7 +580,7 @@
 			'S_TOPIC_UNAPPROVED'	=> (!$row['topic_approved'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)),
 
 			'U_NEWEST_POST'			=> generate_link($view_topic_url . '&amp;view=unread#unread'),
-			'U_LAST_POST'			=> generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
+			'U_LAST_POST'			=> generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#p' . $row['topic_last_post_id']),	
 			'U_LAST_POST_AUTHOR'	=> ($row['topic_last_poster_id']&& $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 			'U_VIEW_TOPIC'			=> generate_link($view_topic_url),
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -264,10 +264,25 @@
 $_CLASS['core_user']->add_lang('viewtopic');
 $_CLASS['core_user']->add_img();
 
-
+// This is for determining where we are (page)
 // What is start equal to?
 if ($post_id)
-{
+{
+	/**
+	* @todo adjust for using post_time? Generally adjust query... it is not called very often though
+	*/
+	$sql = 'SELECT COUNT(post_id) AS prev_posts
+		FROM ' . FORUMS_POSTS_TABLE . "
+		WHERE topic_id = {$topic_data['topic_id']}
+			" . ((!$_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '') . "
+			AND " . (($sort_dir === 'd') ?  "post_id >= $post_id" : "post_id <= $post_id");
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	$topic_data['prev_posts'] = $row['prev_posts'];
+	unset($row);
+
 	$start = floor(($topic_data['prev_posts'] - 1) / $config['posts_per_page']) * $config['posts_per_page'];
 }
 
@@ -499,20 +514,24 @@
 
 	for ($i = 0; $i < $count; $i++)
 	{
+		$poll_info[$i]['poll_option_text'] = censor_text($poll_info[$i]['poll_option_text']);
+
 		if ($poll_bbcode !== false)
 		{
 			$poll_bbcode->bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
 		}
 		$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
-		$poll_info[$i]['poll_option_text'] = str_replace("\n", '<br />', censor_text($poll_info[$i]['poll_option_text']));
+		$poll_info[$i]['poll_option_text'] = str_replace("\n", '<br />', $poll_info[$i]['poll_option_text']);
 	}
 
+	$topic_data['poll_title'] = censor_text($topic_data['poll_title']);
+
 	if ($poll_bbcode !== false)
 	{
 		$poll_bbcode->bbcode_second_pass($topic_data['poll_title'], $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
 	}
 	$topic_data['poll_title'] = smiley_text($topic_data['poll_title']);
-	$topic_data['poll_title'] = str_replace("\n", '<br />', censor_text($topic_data['poll_title']));
+	$topic_data['poll_title'] = str_replace("\n", '<br />', $topic_data['poll_title']);
 
 	unset($poll_bbcode);
 	
@@ -683,12 +702,12 @@
 	);
 
 	// Define the global bbcode bitfield, will be used to load bbcodes
-	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 
 	// Is a signature attached? Are we going to display it?
 	if ($row['enable_sig'] && $config['allow_sig'] && $_CLASS['core_user']->user_data_get('viewsigs'))
 	{
-		$bbcode_bitfield = $bbcode_bitfield | $row['user_sig_bbcode_bitfield'];
+		$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['user_sig_bbcode_bitfield']);
 	}
 
 	// Cache various user specific data ... so we don't have to recompute
@@ -844,7 +863,18 @@
 
 				if ($bday_year)
 				{
-					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - (($today['month'] - $bday_month < 0) ? 1 : (($today['day'] - $bday_day < 0) ? 1 : 0)));
+					$diff = $today['month'] - $bday_month;
+					
+					if ($diff == 0)
+					{
+						$diff = ($today['day'] - $bday_day < 0) ? 1 : 0;
+					}
+					else
+					{
+						$diff = ($diff < 0) ? 1 : 0;
+					}
+					
+					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - $diff);
 				}
 			}
 		}
@@ -945,10 +975,10 @@
 }
 
 // Instantiate BBCode if need be
-if ($bbcode_bitfield)
+if ($bbcode_bitfield !== '')
 {
 	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-	$bbcode = new bbcode($bbcode_bitfield);
+	$bbcode = new bbcode(base64_encode($bbcode_bitfield));
 }
 
 $i_total = count($rowset) - 1;
@@ -979,13 +1009,15 @@
 	// End signature parsing, only if needed
 	if ($user_cache[$poster_id]['sig'] && empty($user_cache[$poster_id]['sig_parsed']))
 	{
+		$user_cache[$poster_id]['sig'] = censor_text($user_cache[$poster_id]['sig']);
+
 		if ($user_cache[$poster_id]['sig_bbcode_bitfield'])
 		{
 			$bbcode->bbcode_second_pass($user_cache[$poster_id]['sig'], $user_cache[$poster_id]['sig_bbcode_uid'], $user_cache[$poster_id]['sig_bbcode_bitfield']);
 		}
 
 		$user_cache[$poster_id]['sig'] = smiley_text($user_cache[$poster_id]['sig']);
-		$user_cache[$poster_id]['sig'] = str_replace("\n", '<br />', censor_text($user_cache[$poster_id]['sig']));
+		$user_cache[$poster_id]['sig'] = str_replace("\n", '<br />', $user_cache[$poster_id]['sig']);
 		$user_cache[$poster_id]['sig_parsed'] = true;
 	}
 
@@ -995,6 +1027,8 @@
 		$row['post_text'] = preg_replace('#(<!\-\- h \-\-><)([\/]?.*?)(><!\-\- h \-\->)#is', "&lt;\\2&gt;", $row['post_text']);
 	}
 
+	$row['post_text'] = censor_text($row['post_text']);
+
 	// Second parse bbcode here
 	if ($row['bbcode_bitfield'])
 	{
@@ -1029,7 +1063,7 @@
 
 	// Replace naughty words such as farty pants
 	$row['post_subject'] = censor_text($row['post_subject']);
-	$row['post_text'] = str_replace("\n", '<br />', censor_text($row['post_text']));
+	$row['post_text'] = str_replace("\n", '<br />', $row['post_text']);
 
 	// Editing information
 	if (($row['post_edit_count'] && $config['display_last_edited']) || $row['post_edit_reason'])
@@ -1151,7 +1185,7 @@
 
 		'U_REPORT'			=> generate_link('forums&amp;file=report&amp;p=' . $row['post_id']),
 		'U_MCP_REPORT'		=> ($_CLASS['forums_auth']->acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MCP_APPROVE'		=> ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
+		'U_MCP_APPROVE'		=> ($_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;action=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
 		'U_MCP_DETAILS'		=> ($_CLASS['forums_auth']->acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
 		'U_MINI_POST'		=> generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
 		'U_NEXT_POST_ID'	=> ($i < $i_total && isset($rowset[$i + 1])) ? $rowset[$i + 1]['post_id'] : '', 
@@ -1398,7 +1432,7 @@
 
 	if ($_CLASS['core_user']->is_bot)
 	{
-		return gmtime();
+		return $_CLASS['core_user']->time;
 	}
 
 	if ($_CLASS['core_user']->is_user && $config['load_db_lastread'])



From viperal at mail.berlios.de  Wed Aug 16 14:23:29 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Wed, 16 Aug 2006 14:23:29 +0200
Subject: [Viperals-svncheckins] r184 - in cms/trunk: . admin includes
	includes/auth includes/cache includes/db includes/display
	includes/forums includes/forums/admin includes/forums/mcp
	includes/templates/modules/forums
	includes/templates/modules/forums/admin install javascript
	modules/control_panel/modules modules/forums
	modules/forums/admin modules/members_list
Message-ID: <200608161223.k7GCNTQK001157@sheep.berlios.de>

Author: viperal
Date: 2006-08-16 14:22:53 +0200 (Wed, 16 Aug 2006)
New Revision: 184

Added:
   cms/trunk/includes/templates/modules/forums/admin/
   cms/trunk/includes/templates/modules/forums/admin/acp_main.html
Removed:
   cms/trunk/includes/display/menu.php
Modified:
   cms/trunk/admin/index.php
   cms/trunk/core.php
   cms/trunk/includes/auth/auth.php
   cms/trunk/includes/cache/cache_file.php
   cms/trunk/includes/db/mysql.php
   cms/trunk/includes/db/mysql3.php
   cms/trunk/includes/db/mysqli.php
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/db/sqlite.php
   cms/trunk/includes/db/sqlite_pdo.php
   cms/trunk/includes/forums/admin/main.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_upload.php
   cms/trunk/includes/forums/mcp/mcp_notes.php
   cms/trunk/includes/forums/mcp/mcp_post.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/install/build_data.php
   cms/trunk/install/build_tables.php
   cms/trunk/installer.php
   cms/trunk/javascript/editor.js
   cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
   cms/trunk/modules/control_panel/modules/ucp_register.php
   cms/trunk/modules/forums/admin/index.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewtopic.php
   cms/trunk/modules/members_list/index.php
Log:


Modified: cms/trunk/admin/index.php
===================================================================
--- cms/trunk/admin/index.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -28,7 +28,7 @@
 
 if (isset($_REQUEST['user_mode']) && $_CLASS['core_auth']->admin_power('users') && display_confirmation())
 {
-	require_once($site_file_root.'includes/functions_user.php');
+	require_once SITE_FILE_ROOT.'includes/functions_user.php';
 	$user_id = get_variable('id', 'REQUEST', false, 'integer');
 
 	if ($user_id)
@@ -50,7 +50,7 @@
 {
 	$cms_news = array();
 	
-	load_class($site_file_root.'includes/core_rss.php', 'core_rss');
+	load_class(SITE_FILE_ROOT.'includes/core_rss.php', 'core_rss');
 	
 	if ($_CLASS['core_rss']->get_rss('http://www.php.net/news.rss', 3))
 	{

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/core.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -39,6 +39,13 @@
 set_magic_quotes_runtime(0);
 error_reporting(E_ALL);
 
+if (function_exists('date_default_timezone_set'))
+{
+	error_reporting(E_ALL | E_STRICT);
+
+	@date_default_timezone_set('America/New_York');
+}
+
 /* Error reporting tyoes */
 define('ERROR_NONE', 0);
 define('ERROR_ONPAGE', 1);
@@ -98,7 +105,6 @@
 
 /* We're going ot use our own error handler */
 $_CLASS['core_handler']->start();
-
 /*
 	$_CLASS['core_handler']->stop();
 */

Modified: cms/trunk/includes/auth/auth.php
===================================================================
--- cms/trunk/includes/auth/auth.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/auth/auth.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -216,11 +216,11 @@
 			'USERNAME'				=>	$user_name,
 			'PASSWORD'				=>	$user_password,
 
-			'U_SEND_PASSWORD'	 	=> ($_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=sendpassword') : '',
-			'U_RESEND_ACTIVATION'   => ($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_NONE && $_CORE_CONFIG['email']['email_enable']) ? generate_link('Control_Panel&amp;mode=resend_act') : '',
-			'U_TERMS_USE'			=> generate_link('Control_Panel&amp;mode=terms'), 
-			'U_PRIVACY'				=> generate_link('Control_Panel&amp;mode=privacy'),
-			'U_REGISTER'			=> generate_link('Control_Panel&amp;mode=register'),
+			'U_SEND_PASSWORD'	 	=> ($_CORE_CONFIG['email']['email_enable']) ? generate_link('control_panel&amp;mode=sendpassword') : '',
+			'U_RESEND_ACTIVATION'   => ($_CORE_CONFIG['user']['activation'] != USER_ACTIVATION_NONE && $_CORE_CONFIG['email']['email_enable']) ? generate_link('control_panel&amp;mode=resend_act') : '',
+			'U_TERMS_USE'			=> generate_link('control_panel&amp;mode=terms'), 
+			'U_PRIVACY'				=> generate_link('control_panel&amp;mode=privacy'),
+			'U_REGISTER'			=> generate_link('control_panel&amp;mode=register'),
 			'U_CONFIRM_IMAGE'		=> $confirm_image,
 
 			'S_DISPLAY_FULL_LOGIN'  => ($login_array['full_login']),

Modified: cms/trunk/includes/cache/cache_file.php
===================================================================
--- cms/trunk/includes/cache/cache_file.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/cache/cache_file.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -114,6 +114,19 @@
 			$this->remove($name);
 		}
 	}
+
+	function destroy_all()
+	{
+		$handle = opendir($this->cache_dir);
+
+		while ($file = readdir($handle))
+		{
+			if (substr($file, 0, 6) == 'cache_')
+			{
+				unlink($this->cache_dir . $file);
+			} 
+		}
+	}
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/db/mysql.php
===================================================================
--- cms/trunk/includes/db/mysql.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/mysql.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -162,7 +162,7 @@
 			return false; 
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 			
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -173,7 +173,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -202,8 +202,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
 
 		if (!$backtrace)
@@ -212,7 +210,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -570,8 +568,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Modified: cms/trunk/includes/db/mysql3.php
===================================================================
--- cms/trunk/includes/db/mysql3.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/mysql3.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -108,7 +108,7 @@
 			return false; 
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 			
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -119,7 +119,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -153,8 +153,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
 
 		if (!$backtrace)
@@ -163,7 +161,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -421,8 +419,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Modified: cms/trunk/includes/db/mysqli.php
===================================================================
--- cms/trunk/includes/db/mysqli.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/mysqli.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -164,7 +164,7 @@
 			return false; 
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -175,7 +175,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -204,8 +204,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
 
 		if (!$backtrace)
@@ -214,7 +212,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -567,8 +565,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/postgres.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -174,7 +174,7 @@
 			return false; 
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 			
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -185,7 +185,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -219,8 +219,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT '. $total . (($offset) ? ' OFFSET '.$offset : '');
 
 		if (!$backtrace)
@@ -229,7 +227,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -244,6 +242,14 @@
 			return false;
 		}
 
+		$debug_backtrace = debug_backtrace();
+		$backtrace = array();
+		// remove the root directorys
+		$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
+		$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+
+		$backtrace['line'] = $debug_backtrace[0]['line'];
+
 		$this->num_queries++;
 		$this->last_query = '';
 
@@ -252,7 +258,8 @@
 			case 'MULTI_INSERT':
 				foreach ($array as $array2)
 				{
-					pg_insert($this->link_identifier, $table, $array2);
+					//pg_insert($this->link_identifier, $table, $array2);
+					$this->query('INSERT INTO ' . $table . ' '. $this->sql_build_array('INSERT', $array2), $backtrace);
 				}
 			break;
 
@@ -260,7 +267,7 @@
 				//	return pg_insert($this->link_identifier, $table, $array);
 				// We can't use pg_insert if we need needed to get the insert_id
 				$this->last_query = 'INSERT INTO ' . $table . ' '. $this->sql_build_array('INSERT', $array);
-				$this->last_result = $this->query($this->last_query);
+				$this->last_result = $this->query($this->last_query, $backtrace);
 	
 				return $this->last_result;
 			break;
@@ -600,8 +607,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Modified: cms/trunk/includes/db/sqlite.php
===================================================================
--- cms/trunk/includes/db/sqlite.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/sqlite.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -155,7 +155,7 @@
 			return false;
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 			
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -166,7 +166,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -201,8 +201,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
 
 		if (!$backtrace)
@@ -211,7 +209,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -479,8 +477,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Modified: cms/trunk/includes/db/sqlite_pdo.php
===================================================================
--- cms/trunk/includes/db/sqlite_pdo.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/db/sqlite_pdo.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -143,7 +143,7 @@
 			return false; 
 		}
 
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 			
 		$this->num_queries++;
 		$this->last_query = $query;
@@ -154,7 +154,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -184,8 +184,6 @@
 			return $this->query($query);
 		}
 
-		global $site_file_root;
-
 		$query .= ' LIMIT ' . (($offset) ? $offset . ', ' : '') . $total;
 
 		if (!$backtrace)
@@ -194,7 +192,7 @@
 			$backtrace = array();
 			// remove the root directorys
 			$backtrace['file'] = str_replace('\\','/', $debug_backtrace[0]['file']);
-			$backtrace['file'] = str_replace($site_file_root, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
+			$backtrace['file'] = str_replace(SITE_FILE_ROOT, '', str_replace($_SERVER['DOCUMENT_ROOT'],'', $backtrace['file']));
 
 			$backtrace['line'] = $debug_backtrace[0]['line'];
 		}
@@ -398,8 +396,6 @@
 			break;
 
 			case 'stop':
-				global $site_file_root;
-
 				$end_time = explode(' ', microtime());
 				$end_time = $end_time[0] + $end_time[1];
 				$this->queries_time += $end_time - $start_time;

Deleted: cms/trunk/includes/display/menu.php
===================================================================
--- cms/trunk/includes/display/menu.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/display/menu.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -1,65 +0,0 @@
-<?php
-//**************************************************************//
-//  Vipeal CMS:													//
-//**************************************************************//
-//																//
-//  Copyright ? 2004 by Viperal									//
-//  http://www.viperal.com										//
-//																//
-//  Viperal CMS is released under the terms and conditions		//
-//  of the GNU General Public License version 2					//
-//																//
-//**************************************************************//
-
-class menu
-{
-
-	var $menu = '<script language="JavaScript" type="text/javascript">';
-	var $menuname = 'Menu';
-	var $options = '<script language="JavaScript" type="text/javascript">var AdminM =[';
-
-	var $mainopen = false;
-	function main($image='null', $name, $link ,$t2='null',$t3=false)
-	{
-		if ($this->mainopen)
-		{
-			$this->options .= "]\n";
-		}
-		$this->options .= "[null,'$name','$link',null,'Home Page',\n";
-
-	}
-	
-	function sub($image='null', $name, $link ,$t2='null',$t3=false)
-	{
-
-		$this->options .= "[null,'$name','$link',null,'Home Page'],\n";
-
-	}
-	
-	function menuarray($menu, $previous=false) {
-
-		foreach  ($menu as $name => $value)
-		{
-			if ($previous == $name)
-			{
-				$this->main($image='null', $name, $value ,$t2='null',$t3='null');
-			} else {
-			
-				if (is_array($value))
-				{
-					$this->menuarray($value, $name);
-				} else {
-					$this->sub($image='null', $name, $value ,$t2='null',$t3='null');
-				}
-			}
-		}
-		$this->options .= "],\n";
-	}
-	
-	function menuclose() {
-			$this->options = substr($this->options, 0, -2). ";\ncmDraw ('AdminMenu', AdminM, 'hbr', cmThemeOffice, 'ThemeOffice');
-</script>\n"; 
-	}
-}
-
-?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/admin/main.php
===================================================================
--- cms/trunk/includes/forums/admin/main.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/admin/main.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -1,283 +1,198 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: index.php,v 1.24 2004/05/26 18:55:25 acydburn Exp $
-//
-// FILENAME  : adm/index.php
-// STARTED   : Sat Feb 13, 2001
-// COPYRIGHT : ? 2003 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
-// 
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Do we have any admin permissions at all?
-if (!$_CLASS['auth']->acl_get('a_'))
-{
-	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-}
-
-// Define some vars
-$action = request_var('action', '');
-
-switch ($action)
-{
-	case 'stats':
-		if (!$_CLASS['auth']->acl_get('a_defaults'))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-		}
-
-		$sql = 'SELECT COUNT(post_id) AS stat 
-			FROM ' . FORUMS_POSTS_TABLE . '
-			WHERE post_approved = 1';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-		set_config('num_posts', (int) $row['stat'], true);
-
-		$sql = 'SELECT COUNT(topic_id) AS stat
-			FROM ' . FORUMS_TOPICS_TABLE . '
-			WHERE topic_approved = 1';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-		set_config('num_topics', (int) $row['stat'], true);
-
-		$sql = 'SELECT COUNT(attach_id) as stat
-			FROM ' . FORUMS_ATTACHMENTS_TABLE;
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-	
-		set_config('num_files', (int) $row['stat'], true);
-		$_CLASS['core_db']->free_result($result);
-
-		$sql = 'SELECT SUM(filesize) as stat
-			FROM ' . FORUMS_ATTACHMENTS_TABLE;
-		$result = $_CLASS['core_db']->query($sql);
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-
-		set_config('upload_dir_size', (int) $row['stat'], true);
-		$_CLASS['core_db']->free_result($result);
-
-		add_log('admin', 'LOG_RESYNC_STATS');
-	break;
-		
-	case 'user':
-		if (!$_CLASS['auth']->acl_get('a_defaults'))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
-		}
-
-		$post_count_ary = $_CLASS['auth']->acl_getf('f_postcount');
-
-		$forum_ary = array();
-		foreach ($post_count_ary as $forum_id => $allowed)
-		{
-			if ($allowed['f_postcount'])
-			{
-				$forum_ary[] = $forum_id;
-			}
-		}
-		
-		if (!sizeof($forum_ary))
-		{
-			$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . ' SET user_posts = 0');
-		}
-		else
-		{
-			$sql = 'SELECT COUNT(post_id) AS num_posts, poster_id
-				FROM ' . FORUMS_POSTS_TABLE . '
-				WHERE poster_id <> ' . ANONYMOUS . '
-					AND forum_id IN (' . implode(', ', $forum_ary) . ')
-				GROUP BY poster_id';
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$_CLASS['core_db']->query('UPDATE ' . USERS_TABLE . " SET user_posts = {$row['num_posts']} WHERE user_id = {$row['poster_id']}");
-			}
-			$_CLASS['core_db']->free_result($result);
-		}
-
-		add_log('admin', 'LOG_RESYNC_POSTCOUNTS');
-		break;
-}
-
-// Get forum statistics
-$total_posts = $config['num_posts'];
-$total_topics = $config['num_topics'];
-$total_users = $_CORE_CONFIG['user']['total_users'];
-$total_files = $config['num_files'];
-
-$start_date = $_CLASS['core_user']->format_date($config['board_start_date']);
-
-$boarddays = (gmtime() - $config['board_start_date']) / 86400;
-
-$posts_per_day = sprintf('%.2f', $total_posts / $boarddays);
-$topics_per_day = sprintf('%.2f', $total_topics / $boarddays);
-$users_per_day = sprintf('%.2f', $total_users / $boarddays);
-$files_per_day = sprintf('%.2f', $total_files / $boarddays);
-
-$upload_dir_size = ($config['upload_dir_size'] >= 1048576) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['MB'], ($config['upload_dir_size'] / 1048576)) : (($config['upload_dir_size'] >= 1024) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['KB'], ($config['upload_dir_size'] / 1024)) : sprintf('%.2f ' . $_CLASS['core_user']->lang['BYTES'], $config['upload_dir_size']));
-
-$avatar_dir_size = 0;
-
-if ($avatar_dir = @opendir($config['avatar_path']))
-{
-	while ($file = readdir($avatar_dir))
-	{
-		if ($file{0} != '.')
-		{
-			$avatar_dir_size += filesize($config['avatar_path'] . '/' . $file);
-		}
-	}
-	@closedir($avatar_dir);
-
-	// This bit of code translates the avatar directory size into human readable format
-	// Borrowed the code from the PHP.net annoted manual, origanally written by:
-	// Jesse (jesse at jess.on.ca)
-	$avatar_dir_size = ($avatar_dir_size >= 1048576) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['MB'], ($avatar_dir_size / 1048576)) : (($avatar_dir_size >= 1024) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['KB'], ($avatar_dir_size / 1024)) : sprintf('%.2f ' . $_CLASS['core_user']->lang['BYTES'], $avatar_dir_size));
-}
-else
-{
-	// Couldn't open Avatar dir.
-	$avatar_dir_size = $_CLASS['core_user']->lang['NOT_AVAILABLE'];
-}
-
-if ($posts_per_day > $total_posts)
-{
-	$posts_per_day = $total_posts;
-}
-
-if ($topics_per_day > $total_topics)
-{
-	$topics_per_day = $total_topics;
-}
-
-if ($users_per_day > $total_users)
-{
-	$users_per_day = $total_users;
-}
-
-if ($files_per_day > $total_files)
-{
-	$files_per_day = $total_files;
-}
-
-// Remove
-$dbsize = $_CLASS['core_user']->lang['NOT_AVAILABLE'];
-
-adm_page_header($_CLASS['core_user']->lang['ADMIN_INDEX']);
-
-?>
-
-<script language="Javascript" type="text/javascript">
-<!--
-	function marklist(status)
-	{
-		for (i = 0; i < document.inactive.length; i++)
-		{
-			document.inactive.elements[i].checked = status;
-		}
-	}
-//-->
-</script>
-
-<h1><?php echo $_CLASS['core_user']->lang['WELCOME_PHPBB']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['ADMIN_INTRO']; ?></p>
-
-<h1><?php echo $_CLASS['core_user']->lang['FORUM_STATS']; ?></h1>
-
-<form name="statistics" method="post" action="<?php echo generate_link('forums', array('admin' => true)); ?>"><table class="tablebg" width="100%" cellpadding="4" cellspacing="1" border="0">
-	<tr>
-		<th width="25%" nowrap="nowrap" height="25"><?php echo $_CLASS['core_user']->lang['STATISTIC']; ?></th>
-		<th width="25%"><?php echo $_CLASS['core_user']->lang['VALUE']; ?></th>
-		<th width="25%" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['STATISTIC']; ?></th>
-		<th width="25%"><?php echo $_CLASS['core_user']->lang['VALUE']; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['NUMBER_POSTS']; ?>:</td>
-		<td class="row2"><b><?php echo $total_posts; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['POSTS_PER_DAY']; ?>:</td>
-		<td class="row2"><b><?php echo $posts_per_day; ?></b></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['NUMBER_TOPICS']; ?>:</td>
-		<td class="row2"><b><?php echo $total_topics; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['TOPICS_PER_DAY']; ?>:</td>
-		<td class="row2"><b><?php echo $topics_per_day; ?></b></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['NUMBER_USERS']; ?>:</td>
-		<td class="row2"><b><?php echo $total_users; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['USERS_PER_DAY']; ?>:</td>
-		<td class="row2"><b><?php echo $users_per_day; ?></b></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['NUMBER_FILES']; ?>:</td>
-		<td class="row2"><b><?php echo $total_files; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['FILES_PER_DAY']; ?>:</td>
-		<td class="row2"><b><?php echo $files_per_day; ?></b></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['BOARD_STARTED']; ?>:</td>
-		<td class="row2"><b><?php echo $start_date; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['AVATAR_DIR_SIZE']; ?>:</td>
-		<td class="row2"><b><?php echo $avatar_dir_size; ?></b></td>
-	</tr>
-	<tr>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['DATABASE_SIZE']; ?>:</td>
-		<td class="row2"><b><?php echo $dbsize; ?></b></td>
-		<td class="row1" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['UPLOAD_DIR_SIZE']; ?>:</td>
-		<td class="row2"><b><?php echo $upload_dir_size; ?></b></td>
-	</tr>
-	<tr>
-		<td class="cat" colspan="4" align="right"><select name="action"><option value="online"><?php echo $_CLASS['core_user']->lang['RESET_ONLINE']; ?></option><option value="date"><?php echo $_CLASS['core_user']->lang['RESET_DATE']; ?></option><option value="stats"><?php echo $_CLASS['core_user']->lang['RESYNC_STATS']; ?></option><option value="user"><?php echo $_CLASS['core_user']->lang['RESYNC_POSTCOUNTS']; ?></option>
-		</select> <input class="btnlite" type="submit" name="submit" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" />&nbsp;</td>
-	</tr>
-</table></form>
-
-<h1><?php echo $_CLASS['core_user']->lang['ADMIN_LOG']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['ADMIN_LOG_INDEX_EXPLAIN']; ?></p>
-
-<table class="tablebg" width="100%" cellpadding="4" cellspacing="1" border="0">
-	<tr>
-		<th width="15%" height="25" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['USERNAME']; ?></th>
-		<th width="15%"><?php echo $_CLASS['core_user']->lang['IP']; ?></th>
-		<th width="20%"><?php echo $_CLASS['core_user']->lang['TIME']; ?></th>
-		<th width="45%" nowrap="nowrap"><?php echo $_CLASS['core_user']->lang['ACTION']; ?></th>
-	</tr>
-<?php
-
-	view_log('admin', $log_data, $log_count, 10);
-
-	$row_class = 'row2';
-	for($i = 0; $i < sizeof($log_data); $i++)
-	{
-		$row_class = ($row_class == 'row1') ? 'row2' : 'row1';
-
-?>
-	<tr>
-		<td class="<?php echo $row_class; ?>"><?php echo $log_data[$i]['username']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo $log_data[$i]['ip']; ?></td>
-		<td class="<?php echo $row_class; ?>" align="center"><?php echo $_CLASS['core_user']->format_date($log_data[$i]['time']); ?></td>
-		<td class="<?php echo $row_class; ?>"><?php echo $log_data[$i]['action']; ?></td>
-	</tr>
-<?php
-
-	}
-	?></table>
-	<?php
-
-	adm_page_footer();
-
+<?php
+// -------------------------------------------------------------
+//
+// $Id: index.php,v 1.24 2004/05/26 18:55:25 acydburn Exp $
+//
+// FILENAME  : adm/index.php
+// STARTED   : Sat Feb 13, 2001
+// COPYRIGHT : ? 2003 phpBB Group
+// WWW       : http://www.phpbb.com/
+// LICENCE   : GPL vs2.0 [ see /docs/COPYING ] 
+// 
+// -------------------------------------------------------------
+if (!defined('VIPERAL') || VIPERAL != 'Admin')
+{
+	die; 
+}
+
+// Do we have any admin permissions at all?
+if (!$_CLASS['auth']->acl_get('a_'))
+{
+	trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+}
+
+// Define some vars
+$action = request_var('action', '');
+
+switch ($action)
+{
+	case 'stats':
+		if (!$_CLASS['auth']->acl_get('a_board'))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+		}
+
+		$sql = 'SELECT COUNT(post_id) AS stat 
+			FROM ' . FORUMS_POSTS_TABLE . '
+			WHERE post_approved = 1';
+		$result = $_CLASS['core_db']->query($sql);
+
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		set_config('num_posts', (int) $row['stat'], true);
+
+		$sql = 'SELECT COUNT(topic_id) AS stat
+			FROM ' . FORUMS_TOPICS_TABLE . '
+			WHERE topic_approved = 1';
+		$result = $_CLASS['core_db']->query($sql);
+
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+		set_config('num_topics', (int) $row['stat'], true);
+
+		$sql = 'SELECT COUNT(attach_id) as stat
+			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	
+		set_config('num_files', (int) $row['stat'], true);
+		$_CLASS['core_db']->free_result($result);
+
+		$sql = 'SELECT SUM(filesize) as stat
+			FROM ' . FORUMS_ATTACHMENTS_TABLE;
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+
+		set_config('upload_dir_size', (int) $row['stat'], true);
+		$_CLASS['core_db']->free_result($result);
+
+		add_log('admin', 'LOG_RESYNC_STATS');
+	break;
+		
+	case 'user':
+		if (!$_CLASS['auth']->acl_get('a_defaults'))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_ADMIN']);
+		}
+
+		$sql = 'SELECT COUNT(post_id) AS num_posts, poster_id
+			FROM ' . FORUMS_POSTS_TABLE . '
+			WHERE post_postcount = 1
+			GROUP BY poster_id';
+		$result = $_CLASS['core_db']->query($sql);
+
+		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$_CLASS['core_db']->query('UPDATE ' . CORE_USERS_TABLE . " SET user_posts = {$row['num_posts']} WHERE user_id = {$row['poster_id']}");
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		add_log('admin', 'LOG_RESYNC_POSTCOUNTS');
+	break;
+}
+
+// Get forum statistics
+$total_posts = $config['num_posts'];
+$total_topics = $config['num_topics'];
+$total_users = $_CORE_CONFIG['user']['total_users'];
+$total_files = $config['num_files'];
+
+$start_date = $_CLASS['core_user']->format_date($config['board_start_date']);
+
+$boarddays = ($_CLASS['core_user']->time - $config['board_start_date']) / 86400;
+
+$posts_per_day = sprintf('%.2f', $total_posts / $boarddays);
+$topics_per_day = sprintf('%.2f', $total_topics / $boarddays);
+$users_per_day = sprintf('%.2f', $total_users / $boarddays);
+$files_per_day = sprintf('%.2f', $total_files / $boarddays);
+
+$upload_dir_size = ($config['upload_dir_size'] >= 1048576) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['MB'], ($config['upload_dir_size'] / 1048576)) : (($config['upload_dir_size'] >= 1024) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['KB'], ($config['upload_dir_size'] / 1024)) : sprintf('%.2f ' . $_CLASS['core_user']->lang['BYTES'], $config['upload_dir_size']));
+
+$avatar_dir_size = 0;
+
+if ($avatar_dir = @opendir($_CORE_CONFIG['global']['path_avatar_upload']))
+{
+	while (($file = readdir($avatar_dir)) !== false)
+	{
+		if ($file{0} != '.' && $file != 'CVS' && strpos($file, 'index.') === false)
+		{
+			$avatar_dir_size += filesize($_CORE_CONFIG['global']['path_avatar_upload'] . '/' . $file);
+		}
+	}
+	@closedir($avatar_dir);
+
+	// This bit of code translates the avatar directory size into human readable format
+	// Borrowed the code from the PHP.net annoted manual, origanally written by:
+	// Jesse (jesse at jess.on.ca)
+	$avatar_dir_size = ($avatar_dir_size >= 1048576) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['MB'], ($avatar_dir_size / 1048576)) : (($avatar_dir_size >= 1024) ? sprintf('%.2f ' . $_CLASS['core_user']->lang['KB'], ($avatar_dir_size / 1024)) : sprintf('%.2f ' . $_CLASS['core_user']->lang['BYTES'], $avatar_dir_size));
+}
+else
+{
+	// Couldn't open Avatar dir.
+	$avatar_dir_size = $_CLASS['core_user']->lang['NOT_AVAILABLE'];
+}
+
+if ($posts_per_day > $total_posts)
+{
+	$posts_per_day = $total_posts;
+}
+
+if ($topics_per_day > $total_topics)
+{
+	$topics_per_day = $total_topics;
+}
+
+if ($users_per_day > $total_users)
+{
+	$users_per_day = $total_users;
+}
+
+if ($files_per_day > $total_files)
+{
+	$files_per_day = $total_files;
+}
+
+// Remove
+$dbsize = $_CLASS['core_user']->lang['NOT_AVAILABLE'];
+$s_action_options = build_select(array('online' => 'RESET_ONLINE', 'date' => 'RESET_DATE', 'stats' => 'RESYNC_STATS', 'user' => 'RESYNC_POSTCOUNTS'));
+
+$_CLASS['core_template']->assign_array(array(
+	'TOTAL_POSTS'		=> $total_posts,
+	'POSTS_PER_DAY'		=> $posts_per_day,
+	'TOTAL_TOPICS'		=> $total_topics,
+	'TOPICS_PER_DAY'	=> $topics_per_day,
+	'TOTAL_USERS'		=> $total_users,
+	'USERS_PER_DAY'		=> $users_per_day,
+	'TOTAL_FILES'		=> $total_files,
+	'FILES_PER_DAY'		=> $files_per_day,
+	'START_DATE'		=> $start_date,
+	'AVATAR_DIR_SIZE'	=> $avatar_dir_size,
+	'UPLOAD_DIR_SIZE'	=> $upload_dir_size,
+
+	'U_ACTION'			=> generate_link('forums', array('admin' => true)),
+	'U_ADMIN_LOG'		=> generate_link('forums&amp;i=logs&amp;mode=admin', array('admin' => true)),
+
+	'S_ACTION_OPTIONS'	=> $_CLASS['forums_auth']->acl_get('a_board') ? $s_action_options : '',
+));
+
+$log_data = array();
+$log_count = 0;
+
+if (!$_CLASS['forums_auth']->acl_get('a_viewlogs'))
+{
+	view_log('admin', $log_data, $log_count, 5);
+
+	foreach ($log_data as $row)
+	{
+		$_CLASS['core_template']->assign_vars_array('log', array(
+			'USERNAME'	=> $row['username'],
+			'IP'		=> $row['ip'],
+			'DATE'		=> $_CLASS['core_user']->format_date($row['time']),
+			'ACTION'	=> $row['action']
+		));
+	}
+}
+
+$_CLASS['core_display']->display($_CLASS['core_user']->lang['ADMIN_INDEX'], 'modules/forums/admin/acp_main.html');
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/auth.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -333,10 +333,10 @@
 		{
 			$userdata['user_permissions'] = $hold_str;
 
-			$sql = 'UPDATE ' . USERS_TABLE . "
-				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "',
-					user_perm_from = 0
-				WHERE user_id = " . $userdata['user_id'];
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . "
+				SET user_permissions = '" . $_CLASS['core_db']->escape($userdata['user_permissions']) . "'
+				WHERE user_id = " . $userdata['user_id'];//, user_perm_from = 0
+
 			$_CLASS['core_db']->query($sql);
 		}
 	}
@@ -495,17 +495,19 @@
 		}
 
 		// Sort by group_id since we want user setting to over right grp..  specific > broad
-		$sql = 'SELECT ao.auth_option, a.user_id, a.group_id, a.forum_id, a.auth_setting
-					FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_OPTIONS_TABLE . " ao
-					WHERE a.auth_option_id = ao.auth_option_id 
+		$sql = 'SELECT ao.auth_option, a.auth_role_id, r.auth_setting as role_auth_setting, a.user_id, a.group_id, a.forum_id, a.auth_setting
+					FROM ' . FORUMS_ACL_OPTIONS_TABLE . ' ao, ' . FORUMS_ACL_TABLE . ' a
+					LEFT JOIN '.FORUMS_ACL_ROLES_DATA_TABLE." r ON a.auth_role_id = r.role_id
+					WHERE (ao.auth_option_id = a.auth_option_id OR ao.auth_option_id = r.auth_option_id)
 						$sql_user $sql_forum $sql_opts
-						ORDER BY a.group_id";
+						ORDER BY a.group_id, ao.auth_option";
 
 		$result = $_CLASS['core_db']->query($sql);
 
 		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 		{
-			if ($row['auth_setting'] != ACL_YES)
+			$auth_setting = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
+			if ($auth_setting != ACL_YES)
 			{
 				continue;
 			}
@@ -517,7 +519,23 @@
 				continue;
 			}
 
-			$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+			$hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] = $auth_setting;
+
+			/*	// Check for existence of ACL_YES if an option got set to ACL_NEVER
+				if ($setting == ACL_NEVER)
+				{
+					$flag = substr($row['auth_option'], 0, strpos($row['auth_option'], '_') + 1);
+
+					if (isset($hold_ary[$row['user_id']][$row['forum_id']][$flag]) && $hold_ary[$row['user_id']][$row['forum_id']][$flag] == ACL_YES)
+					{
+						unset($hold_ary[$row['user_id']][$row['forum_id']][$flag]);
+
+						if (in_array(ACL_YES, $hold_ary[$row['user_id']][$row['forum_id']]))
+						{
+							$hold_ary[$row['user_id']][$row['forum_id']][$flag] = ACL_YES;
+						}
+					}
+				}*/
 		}
 		$_CLASS['core_db']->free_result($result);
 
@@ -525,7 +543,9 @@
 		{
 			if (empty($group_members))
 			{
-				$sql = 'SELECT user_group, user_id FROM ' . CORE_USERS_TABLE .' WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).') AND user_status = '.STATUS_ACTIVE;
+				$sql = 'SELECT user_group, user_id FROM ' . CORE_USERS_TABLE .' 
+					WHERE user_group IN ('.implode(', ', array_keys($group_id_array)).')
+					AND user_status = '.STATUS_ACTIVE." $sql_user ";
 				$result = $_CLASS['core_db']->query($sql);
 	
 				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
@@ -546,7 +566,26 @@
 				{
 					foreach($rows as $row)
 					{
-						$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = $row['auth_setting'];
+						if (!isset($hold_ary[$user_id][$row['forum_id']][$row['auth_option']]) || (isset($hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']]) && $hold_ary[$row['user_id']][$row['forum_id']][$row['auth_option']] != ACL_NEVER))
+						{
+							$hold_ary[$user_id][$row['forum_id']][$row['auth_option']] = ($row['auth_role_id']) ? $row['role_auth_setting'] : $row['auth_setting'];
+						}
+						/*	
+						// Check for existence of ACL_YES if an option got set to ACL_NEVER
+						if ($setting == ACL_NEVER)
+						{
+							$flag = substr($row['auth_option'], 0, strpos($row['auth_option'], '_') + 1);
+		
+							if (isset($hold_ary[$row['user_id']][$row['forum_id']][$flag]) && $hold_ary[$row['user_id']][$row['forum_id']][$flag] == ACL_YES)
+							{
+								unset($hold_ary[$row['user_id']][$row['forum_id']][$flag]);
+		
+								if (in_array(ACL_YES, $hold_ary[$row['user_id']][$row['forum_id']]))
+								{
+									$hold_ary[$row['user_id']][$row['forum_id']][$flag] = ACL_YES;
+								}
+							}
+						}*/	
 					}
 				}
 			}

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/functions.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -1495,7 +1495,7 @@
 	switch ($mode)
 	{
 		case 'email':
-			return '[a-z0-9&\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*?[a-z]+';
+			return '[a-z0-9&\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*[a-z]+';
 		break;
 	}
 

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -87,8 +87,6 @@
 			continue;
 		}
 
-
-
 		if ($row['forum_type'] == FORUM_CAT && ($row['left_id'] + 1 == $row['right_id']))
 		{
 			// Non-postable forum with no subforums: don't display
@@ -554,7 +552,7 @@
 			}
 			
 			$data['lang_size'] = ($attachment['filesize'] >= 1048576) ? round((round($attachment['filesize'] / 1048576 * 100) / 100), 2) .$_CLASS['core_user']->lang['MB'] : (($attachment['filesize'] >= 1024) ? round((round($attachment['filesize'] / 1024 * 100) / 100), 2)  . $_CLASS['core_user']->lang['KB']: $attachment['filesize'] . $_CLASS['core_user']->lang['BYTES']);
-			$data['lang_views'] = (!$attachment['download_count']) ? $_CLASS['core_user']->lang['DOWNLOAD_NONE'] : (($attachment['download_count'] == 1) ? sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNT'], $attachment['download_count']) : sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNTS'], $attachment['download_count']));
+			$data['lang_views'] = (empty($attachment['download_count']) || !$attachment['download_count']) ? $_CLASS['core_user']->lang['DOWNLOAD_NONE'] : (($attachment['download_count'] == 1) ? sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNT'], $attachment['download_count']) : sprintf($_CLASS['core_user']->lang['DOWNLOAD_COUNTS'], $attachment['download_count']));
 	
 			$data['icon'] = (isset($extensions[$attachment['extension']]['upload_icon']) && $extensions[$attachment['extension']]['upload_icon']) ? $config['upload_icons_path'] . '/' . trim($extensions[$attachment['extension']]['upload_icon']) : false;
 			$data['name'] = basename($attachment['real_filename']);

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -188,7 +188,7 @@
 	$filedata = array();
 	$filedata['error'] = array();
 
-	include_once(SITE_FILE_ROOT. 'includes/forums/functions_upload.php');
+	require_once SITE_FILE_ROOT. 'includes/forums/functions_upload.php';
 	$upload = new fileupload();
 	
 	if (!$local)
@@ -776,6 +776,9 @@
 {
 	global $_CLASS, $bbcode, $config;
 
+	$rowset = array();
+	$bbcode_bitfield = '';
+
 	// Go ahead and pull all data for this topic
 	$sql = 'SELECT u.username, u.user_id, p.post_id, p.post_username, p.post_subject, p.post_text, p.enable_smilies, p.bbcode_uid, p.bbcode_bitfield, p.post_time
 		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
@@ -786,26 +789,23 @@
 		ORDER BY p.post_time DESC';
 	$result = $_CLASS['core_db']->query_limit($sql, $config['posts_per_page']);
 
-	if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
 	{
-		$_CLASS['core_db']->free_result($result);
-		return false;
+		$rowset[] = $row;
+		$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 	}
+	$_CLASS['core_db']->free_result($result);
 
-	$bbcode_bitfield = '';
-	do
+	if (empty($rowset))
 	{
-		$rowset[] = $row;
-		 $bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
+		return false;
 	}
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
-	$_CLASS['core_db']->free_result($result);
 
 	// Instantiate BBCode class
-	if (!isset($bbcode) && $bbcode_bitfield)
+	if (!isset($bbcode) && $bbcode_bitfield !== '')
 	{
 		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-		$bbcode = new bbcode($bbcode_bitfield);
+		$bbcode = new bbcode(base64_encode($bbcode_bitfield));
 	}
 
 	foreach ($rowset as $i => $row)
@@ -985,7 +985,7 @@
 
 	$email_sig = str_replace('<br />', "\n", "-- \n" . $config['board_email_sig']);
 
-	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	require_once SITE_FILE_ROOT.'includes/mailer.php';
 
 	foreach ($processed as $template => $user_list)
 	{
@@ -1375,8 +1375,8 @@
 					'poll_start'		=> ($poll['poll_start']) ? $poll['poll_start'] : $current_time,
 					'poll_max_options'	=> $poll['poll_max_options'],
 					'poll_length'		=> ($poll['poll_length'] * 86400),
-					'poll_vote_change'	=> $poll['poll_vote_change'])
-				);
+					'poll_vote_change'	=> $poll['poll_vote_change']
+				));
 			}
 
 			$sql_data[CORE_USERS_TABLE]['stat'][] = "user_last_post_time = $current_time" . (($_CLASS['forums_auth']->acl_get('f_postcount', $data['forum_id'])) ? ', user_posts = user_posts + 1' : '');
@@ -1561,7 +1561,8 @@
 					$sql_insert_ary[] = array(
 						'poll_option_id'	=> (int) $i,
 						'topic_id'			=> (int) $data['topic_id'],
-						'poll_option_text'	=> (string) $poll['poll_options'][$i]
+						'poll_option_text'	=> (string) $poll['poll_options'][$i],
+						'poll_option_total' => 0
 					);
 				}
 				else if ($poll['poll_options'][$i] != $cur_poll_options[$i])
@@ -1602,7 +1603,7 @@
 			{
 				// update entry in db if attachment already stored in db and filespace
 				$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . "
-					SET attach_comment = '" . $_CLASS['core_db']->escape($attach_row['attach_comment']) . "'
+					SET comment = '" . $_CLASS['core_db']->escape($attach_row['comment']) . "'
 					WHERE attach_id = " . (int) $attach_row['attach_id'];
 				$_CLASS['core_db']->query($sql);
 				
@@ -1617,14 +1618,14 @@
 				}
 
 				$attach_sql_array[] = array(
-					'post_msg_id'		=> $data['post_id'],
-					'topic_id'			=> $data['topic_id'],
+					'post_msg_id'		=> (int) $data['post_id'],
+					'topic_id'			=> (int) $data['topic_id'],
 					'in_message'		=> 0,
-					'poster_id'			=> $poster_id,
+					'poster_id'			=> (int) $poster_id,
 					'physical_filename'	=> basename($attach_row['physical_filename']),
 					'real_filename'		=> basename($attach_row['real_filename']),
 					'download_count'	=> 0,
-					'attach_comment'	=> $attach_row['attach_comment'],
+					'comment'			=> $attach_row['comment'],
 					'extension'			=> $attach_row['extension'],
 					'mimetype'			=> $attach_row['mimetype'],
 					'filesize'			=> $attach_row['filesize'],
@@ -1637,12 +1638,12 @@
 			}
 		}
 
-		if (count($attach_sql_array))
+		if (!empty($attach_sql_array))
 		{
-			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_TOPICS_TABLE);
+			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_ATTACHMENTS_TABLE);
 			unset($attach_sql_array);
 		}
-	
+
 		if ($files_updated || $files_added)
 		{
 			$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '

Modified: cms/trunk/includes/forums/functions_upload.php
===================================================================
--- cms/trunk/includes/forums/functions_upload.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/functions_upload.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -1,663 +1,795 @@
-<?php
-/** 
-*
-* @package phpBB3
-* @version $Id: functions_upload.php,v 1.5 2005/05/10 17:00:41 acydburn Exp $ 
-* @copyright (c) 2005 phpBB Group 
-* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
-*
-*/
-
-/**
-* @package phpBB3
-* Responsible for holding all file relevant informations, as well as doing file-specific operations.
-* The {@link fileupload fileupload class} can be used to upload several files, each of them being this object to operate further on.
-*/
-class filespec
-{
-	var $filename = '';
-	var $realname = '';
-	var $uploadname = '';
-	var $mimetype = '';
-	var $extension = '';
-	var $filesize = 0;
-	var $width = 0;
-	var $height = 0;
-
-	var $destination_file = '';
-	var $destination_path = '';
-
-	var $file_moved = false;
-	var $init_error = false;
-	var $local = false;
-
-	var $error = array();
-
-	var $upload = '';
-
-	/**
-	* File Class
-	*
-	* @access private
-	*
-	*/
-	function filespec($upload_ary, $upload_namespace)
-	{
-		if (!isset($upload_ary))
-		{
-			$this->init_error = true;
-			return;
-		}
-
-		$this->filename = $upload_ary['tmp_name'];
-		$this->filesize = $upload_ary['size'];
-		$this->realname = $this->uploadname = trim(htmlspecialchars(basename($upload_ary['name'])));
-		$this->mimetype = $upload_ary['type'];
-
-		// Opera adds the name to the mime type
-		$this->mimetype	= (strpos($this->mimetype, '; name') !== false) ? str_replace(strstr($this->mimetype, '; name'), '', $this->mimetype) : $this->mimetype;
-
-		if (!$this->mimetype)
-		{
-			$this->mimetype = 'application/octetstream';
-		}
-		
-		$this->extension = explode('.', strtolower($this->realname));
-		$this->extension = array_pop($this->extension);
-
-		// Try to get real filesize from temporary folder (not always working) ;)
-		$this->filesize = (@filesize($this->filename)) ? @filesize($this->filename) : $this->filesize;
-
-		$this->width = $this->height = 0;
-		$this->file_moved = false;
-
-		$this->local = (isset($upload_ary['local_mode'])) ? true : false;
-		$this->upload = $upload_namespace;
-	}
-
-	/**
-	* Cleans destination filename
-	* 
-	* @access public
-	* @param real|unique $mode real creates a realname, filtering some characters, lowering every character. Unique creates an unique filename
-	* @param string $prefix Prefix applied to filename
-	*/
-	function clean_filename($mode = 'unique', $prefix = '')
-	{
-		if ($this->init_error)
-		{
-			return;
-		}
-		
-		switch ($mode)
-		{
-			case 'real':
-				// Replace any chars which may cause us problems with _
-				$bad_chars = array("'", "\\", ' ', '/', ':', '*', '?', '"', '<', '>', '|');
-
-				$this->realname = rawurlencode(str_replace($bad_chars, '_', strtolower($this->realname)));
-				$this->realname = preg_replace("/%(\w{2})/", '_', $this->realname);
-
-				$this->realname = $prefix . $this->realname . '_.' . $this->extension;
-				break;
-
-			case 'unique':
-			default:
-				$this->realname = $prefix . md5(uniqid(mt_rand(), true)) . '.' . $this->extension;
-			break;
-		}
-	}
-
-	function get($property)
-	{
-		if ($this->init_error)
-		{
-			return;
-		}
-		
-		if (!isset($this->$property))
-		{
-			return false;
-		}
-		
-		return $this->$property;
-	}
-
-	function is_image()
-	{
-		return (strpos($this->mimetype, 'image/') !== false) ? true : false;
-	}
-
-	function is_uploaded()
-	{
-		if (!$this->local && !is_uploaded_file($this->filename))
-		{
-			return false;
-		}
-
-		return (file_exists($this->filename)) ? true : false;
-	}
-
-	function remove()
-	{
-		if ($this->file_moved)
-		{
-			@unlink($this->destination_file);
-		}
-	}
-
-	/**
-	* Move file to destination folder
-	* 
-	* The phpbb_root_path variable will be applied to the destination path
-	*
-	* @access public
-	* @param string $destination_path Destination path, for example $config['avatar_path']
-	* @param octal $chmod Permission mask for chmodding the file after a successful move
-	*/
-	function move_file($destination, $chmod = 0666)
-	{
-		global $_CLASS;
-
-		if (sizeof($this->error))
-		{
-			return false;
-		}
-
-		// Adjust destination path (no trailing slash)
-		if ($destination{(sizeof($destination)-1)} == '/' || $destination{(sizeof($destination)-1)} == '\\')
-		{
-			$destination = substr($destination, 0, sizeof($destination)-2);
-		}
-		
-		$destination = str_replace(array('../', '..\\', './', '.\\'), '', $destination);
-		if ($destination && ($destination{0} == '/' || $destination{0} == "\\"))
-		{
-			$destination = '';
-		}
-
-		$this->destination_path = $destination;
-
-		$upload_mode = (@ini_get('open_basedir') || @ini_get('safe_mode')) ? 'move' : 'copy';
-		$upload_mode = ($this->local) ? 'local' : $upload_mode;
-		$this->destination_file = $this->destination_path . '/' . basename($this->realname);
-
-		switch ($upload_mode)
-		{
-			case 'copy':
-				if (!@copy($this->filename, $this->destination_file)) 
-				{
-					if (!@move_uploaded_file($this->filename, $this->destination_file)) 
-					{
-						$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
-						return false;
-					}
-				}
-				else
-				{
-					@unlink($this->filename);
-				}
-				break;
-
-			case 'move':
-				if (!@move_uploaded_file($this->filename, $this->destination_file)) 
-				{ 
-					if (!@copy($this->filename, $this->destination_file)) 
-					{
-						$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
-						return false;
-					}
-					else
-					{
-						@unlink($this->filename);
-					}
-				} 
-				break;
-
-			case 'local':
-				if (!@copy($this->filename, $this->destination_file)) 
-				{
-					$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
-					return false;
-				}
-				@unlink($this->filename);
-				break;
-		}
-
-		@chmod($this->destination_file, $chmod);
-		
-		// Try to get real filesize from destination folder
-		$this->filesize = (@filesize($this->destination_file)) ? @filesize($this->destination_file) : $this->filesize;
-
-		if ($this->is_image())
-		{
-			list($this->width, $this->height) = @getimagesize($this->destination_file);
-		}
-
-		$this->file_moved = true;
-		$this->additional_checks();
-		unset($this->upload);
-	}
-
-	function additional_checks()
-	{
-		global $_CLASS;
-
-		if (!$this->file_moved)
-		{
-			return false;
-		}
-		
-		// Filesize is too big or it's 0 if it was larger than the maxsize in the upload form
-		if ($this->upload->max_filesize && ($this->get('filesize') > $this->upload->max_filesize || $this->filesize == 0))
-		{
-			$size_lang = ($this->upload->max_filesize >= 1048576) ? $_CLASS['core_user']->lang['MB'] : (($this->upload->max_filesize >= 1024) ? $_CLASS['core_user']->lang['KB'] : $_CLASS['core_user']->lang['BYTES'] );
-			$max_filesize = ($this->upload->max_filesize >= 1048576) ? round($this->upload->max_filesize / 1048576 * 100) / 100 : (($this->upload->max_filesize >= 1024) ? round($this->upload->max_filesize / 1024 * 100) / 100 : $this->upload->max_filesize);
-			
-			$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'WRONG_FILESIZE'], $max_filesize, $size_lang);
-			return;
-		}
-
-		if (!$this->upload->valid_dimensions($this))
-		{
-			$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'WRONG_SIZE'], $this->min_width, $this->min_height, $this->max_width, $this->max_height);
-		}
-	}
-}
-
-/**
-* @package phpBB3
-* Class for assigning error messages before a real filespec class can be assigned
-*/
-class fileerror extends filespec
-{
-	function fileerror($error_msg)
-	{
-		$this->error[] = $error_msg;
-	}
-}
-
-/**
-* @package phpBB3
-* File upload class
-*
-* Init class (all parameters optional and able to be set/overwritten seperatly) - scope is global and valid for all uploads
-*/
-class fileupload
-{
-	var $allowed_extensions = array();
-	var $max_filesize = 0;
-	var $min_width = 0;
-	var $min_height = 0;
-	var $max_width = 0;
-	var $max_height = 0;
-	var $error_prefix = '';
-
-	/**
-	*
-	* @param string $error_prefix Used error messages will get prefixed by this string
-	* @param array $allowed_extensions Array of allowed extensions, for example array('jpg', 'jpeg', 'gif', 'png')
-	* @param int $max_filesize Maximum filesize
-	* @param int $min_width Minimum image width (only checked for images)
-	* @param int $min_height Minimum image height (only checked for images)
-	* @param int $max_width Maximum image width (only checked for images)
-	* @param int $max_height Maximum image height (only checked for images)
-	*
-	*/
-	function fileupload($error_prefix = '', $allowed_extensions = false, $max_filesize = false, $min_width = false, $min_height = false, $max_width = false, $max_height = false)
-	{
-		$this->set_allowed_extensions($allowed_extensions);
-		$this->set_max_filesize($max_filesize);
-		$this->set_allowed_dimensions($min_width, $min_height, $max_width, $max_height);
-		$this->set_error_prefix($error_prefix);
-	}
-
-	// Reset vars
-	function reset_vars()
-	{
-		$this->max_filesize = 0;
-		$this->min_width = $this->min_height = $this->max_width = $this->max_height = 0;
-		$this->error_prefix = '';
-		$this->allowed_extensions = array();
-	}
-
-	// Set allowed extensions
-	function set_allowed_extensions($allowed_extensions)
-	{
-		if ($allowed_extensions !== false && is_array($allowed_extensions))
-		{
-			$this->allowed_extensions = $allowed_extensions;
-		}
-	}
-
-	// Set allowed dimensions
-	function set_allowed_dimensions($min_width, $min_height, $max_width, $max_height)
-	{
-		$this->min_width = (int) $min_width;
-		$this->min_height = (int) $min_height;
-		$this->max_width = (int) $max_width;
-		$this->max_height = (int) $max_height;
-	}
-
-	// Set maximum allowed filesize
-	function set_max_filesize($max_filesize)
-	{
-		if ($max_filesize !== false && (int) $max_filesize)
-		{
-			$this->max_filesize = (int) $max_filesize;
-		}
-	}
-
-	// Set error prefix
-	function set_error_prefix($error_prefix)
-	{
-		$this->error_prefix = $error_prefix;
-	}
-
-	/**
-	* Form upload method
-	*
-	* Upload file from users harddisk
-	*
-	* @access public
-	* @param string $form_name Form name assigned to the file input field (if it is an array, the key has to be specified)
-	* @return object $file Object "filespec" is returned, all further operations can be done with this object
-	*/
-	function form_upload($form_name)
-	{
-		global $_CLASS;
-
-		unset($_FILES[$form_name]['local_mode']);
-		$file = new filespec($_FILES[$form_name], $this);
-
-		if ($file->init_error)
-		{
-			$file->error[] = '';
-			return $file;
-		}
-			
-		// Error array filled?
-		if (isset($_FILES[$form_name]['error']))
-		{
-			$error = $this->assign_internal_error($_FILES[$form_name]['error']);
-
-			if ($error !== false)
-			{
-				$file->error[] = $error;
-				return $file;
-			}
-		}
-
-		// Check if empty file got uploaded (not catched by is_uploaded_file)
-		if (isset($_FILES[$form_name]['size']) && $_FILES[$form_name]['size'] == 0)
-		{
-			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'EMPTY_FILEUPLOAD'];
-			return $file;
-		}
-
-		// PHP Upload filesize exceeded
-		if ($file->get('filename') == 'none')
-		{
-			$file->error[] = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
-			return $file;
-		}
-
-		// Not correctly uploaded
-		if (!$file->is_uploaded())
-		{
-			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
-			return $file;
-		}
-
-		$this->common_checks($file);
-
-		return $file;
-	}
-
-	// Move file from another location to phpBB
-	function local_upload($source_file, $filedata = false)
-	{
-		global $_CLASS;
-
-		$form_name = 'local';
-
-		$_FILES[$form_name]['local_mode'] = true;
-		$_FILES[$form_name]['tmp_name'] = $source_file;
-
-		if ($filedata === false)
-		{
-			$_FILES[$form_name]['name'] = basename($source_file);
-			$_FILES[$form_name]['size'] = 0;
-			$_FILES[$form_name]['type'] = '';
-		}
-		else
-		{
-			$_FILES[$form_name]['name'] = $filedata['realname'];
-			$_FILES[$form_name]['size'] = $filedata['size'];
-			$_FILES[$form_name]['type'] = $filedata['type'];
-		}		
-
-		$file = new filespec($_FILES[$form_name], $this);
-
-		if ($file->init_error)
-		{
-			$file->error[] = '';
-			return $file;
-		}
-			
-		if (isset($_FILES[$form_name]['error']))
-		{
-			$error = $this->assign_internal_error($_FILES[$form_name]['error']);
-
-			if ($error !== false)
-			{
-				$file->error[] = $error;
-				return $file;
-			}
-		}
-
-		// PHP Upload filesize exceeded
-		if ($file->get('filename') == 'none')
-		{
-			$file->error[] = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
-			return $file;
-		}
-
-		// Not correctly uploaded
-		if (!$file->is_uploaded())
-		{
-			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
-			return $file;
-		}
-
-		$this->common_checks($file);
-
-		return $file;
-	}
-
-	/**
-	* Remote upload method
-	*
-	* Uploads file from given url
-	*
-	* @access public
-	* @param string $upload_url URL pointing to file to upload, for example http://www.foobar.com/example.gif
-	* @return object $file Object "filespec" is returned, all further operations can be done with this object
-	*/
-	function remote_upload($upload_url)
-	{
-		global $_CLASS;
-		
-		$upload_ary = array();
-		$upload_ary['local_mode'] = true;
-
-		if (!preg_match('#^(http://).*?\.(' . implode('|', $this->allowed_extensions) . ')$#i', $upload_url, $match))
-		{
-			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'URL_INVALID']);
-			return $file;
-		}
- 
-		if (empty($match[2]))
-		{
-			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'URL_INVALID']);
-			return $file;
-		}
-
-		$url = parse_url($upload_url);
-
-		$host = $url['host'];
-		$path = dirname($url['path']);
-		$port = (!empty($url['port'])) ? (int) $url['port'] : 80;
-			
-		$upload_ary['type'] = 'application/octet-stream';
-		$upload_ary['name'] = basename($url['path']) . '.' . array_pop(explode('.', $url['path']));
-		$filename = $url['path'];
-		$filesize = 0;
-
-		if (!($fsock = @fsockopen($host, $port, $errno, $errstr)))
-		{
-			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED']);
-			return $file;
-		}
-
-		fputs($fsock, 'GET /' . $filename . " HTTP/1.1\r\n");
-		fputs($fsock, "HOST: " . $host . "\r\n");
-		fputs($fsock, "Connection: close\r\n\r\n");
-
-		$get_info = false;
-		$data = '';
-		while (!@feof($fsock))
-		{
-			if ($get_info)
-			{
-				$data .= @fread($fsock, 1024);
-			}
-			else
-			{
-				$line = @fgets($fsock, 1024);
-
-				if ($line == "\r\n")
-				{
-					$get_info = true;
-				}
-				else
-				{
-					if (strpos($line, 'Content-Type: ') !== false)
-					{
-						$upload_ary['type'] = rtrim(str_replace('Content-Type: ', '', $line));
-					}
-				}
-			}
-		}
-		@fclose($fsock);
-
-		if (empty($data))
-		{
-			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'EMPTY_REMOTE_DATA']);
-			return $file;
-		}
-		unset($url_ary);
-
-		$tmp_path = (!@ini_get('safe_mode')) ? false : 'cache';
-		$filename = tempnam($tmp_path, uniqid(rand()) . '-');
-
-		if (!($fp = @fopen($filename, 'wb')))
-		{
-			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED']);
-			return $file;
-		}
-		$upload_ary['size'] = fwrite($fp, $data);
-		fclose($fp);
-		unset($data);
-
-		$upload_ary['tmp_name'] = $filename;
-
-		$file = new filespec($upload_ary, $this);
-		$this->common_checks($file);
-
-		return $file;
-	}
-
-	// Private::assign_internal_error
-	function assign_internal_error($errorcode)
-	{
-		global $_CLASS;
-
-		switch ($errorcode)
-		{
-			case 1:
-				$error = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
-				break;
-			case 2:
-				$error = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'WRONG_FILESIZE'], $this->max_filesize);
-				break;			
-			case 3:
-				$error = 'The uploaded file was only partially uploaded';
-				break;
-			case 4:
-				$error = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
-				break;
-			case 6:
-				$error = 'Temporary folder could not be found. Please check your PHP installation.';
-				break;
-			default:
-				$error = false;
-		}
-
-		return $error;
-	}
-	
-	// Private::common_checks
-	function common_checks(&$file)
-	{
-		global $_CLASS;
-
-		// Filesize is too big or it's 0 if it was larger than the maxsize in the upload form
-		if ($this->max_filesize && ($file->get('filesize') > $this->max_filesize || $file->get('filesize') == 0))
-		{
-			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'WRONG_FILESIZE'], $this->max_filesize);
-		}
-
-		// check Filename
-		if (preg_match("#[\\/:*?\"<>|]#i", $file->get('realname')))
-		{ 
-			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'INVALID_FILENAME'], $file->get('realname'));
-		}
-
-		// Invalid Extension
-		if (!$this->valid_extension($file))
-		{
-			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'DISALLOWED_EXTENSION'], $file->get('extension'));
-		}
-	}
-
-	function valid_extension(&$file)
-	{
-		return in_array($file->get('extension'), $this->allowed_extensions);
-	}
-
-	function valid_dimensions(&$file)
-	{
-		if (!$this->max_width && !$this->max_height && !$this->min_width && !$this->min_height)
-		{
-			return true;
-		}
-		
-		if (($file->get('width') > $this->max_width && $this->max_width) || 
-			($file->get('height') > $this->max_height && $this->max_height) || 
-			($file->get('width') < $this->min_width && $this->min_width) ||
-			($file->get('height') < $this->min_height && $this->min_height))
-		{
-			return false;
-		}
-
-		return true;
-	}
-
-	function is_valid($form_name)
-	{
-		return (isset($_FILES[$form_name]) && $_FILES[$form_name]['name'] != 'none') ? true : false;
-	}
-}
-
+<?php
+/** 
+*
+* @package phpBB3
+* @version $Id: functions_upload.php,v 1.17 2006/06/13 21:06:27 acydburn Exp $ 
+* @copyright (c) 2005 phpBB Group 
+* @license http://opensource.org/licenses/gpl-license.php GNU Public License 
+*
+*/
+
+/**
+* Responsible for holding all file relevant informations, as well as doing file-specific operations.
+* The {@link fileupload fileupload class} can be used to upload several files, each of them being this object to operate further on.
+* @package phpBB3
+*/
+class filespec
+{
+	var $filename = '';
+	var $realname = '';
+	var $uploadname = '';
+	var $mimetype = '';
+	var $extension = '';
+	var $filesize = 0;
+	var $width = 0;
+	var $height = 0;
+	var $image_info = array();
+
+	var $destination_file = '';
+	var $destination_path = '';
+
+	var $file_moved = false;
+	var $init_error = false;
+	var $local = false;
+
+	var $error = array();
+
+	var $upload = '';
+
+	/**
+	* File Class
+	* @access: private
+	*/
+	function filespec($upload_ary, $upload_namespace)
+	{
+		if (!isset($upload_ary))
+		{
+			$this->init_error = true;
+			return;
+		}
+
+		$this->filename = $upload_ary['tmp_name'];
+		$this->filesize = $upload_ary['size'];
+		$this->realname = $this->uploadname = trim(htmlspecialchars(basename($upload_ary['name'])));
+		$this->mimetype = $upload_ary['type'];
+
+		// Opera adds the name to the mime type
+		$this->mimetype	= (strpos($this->mimetype, '; name') !== false) ? str_replace(strstr($this->mimetype, '; name'), '', $this->mimetype) : $this->mimetype;
+
+		if (!$this->mimetype)
+		{
+			$this->mimetype = 'application/octetstream';
+		}
+
+		$this->extension = strtolower($this->get_extension($this->realname));
+
+		// Try to get real filesize from temporary folder (not always working) ;)
+		$this->filesize = (@filesize($this->filename)) ? @filesize($this->filename) : $this->filesize;
+
+		$this->width = $this->height = 0;
+		$this->file_moved = false;
+
+		$this->local = (isset($upload_ary['local_mode'])) ? true : false;
+		$this->upload = $upload_namespace;
+	}
+
+	/**
+	* Cleans destination filename
+	* 
+	* @param real|unique $mode real creates a realname, filtering some characters, lowering every character. Unique creates an unique filename
+	* @param string $prefix Prefix applied to filename
+	* @access public
+	*/
+	function clean_filename($mode = 'unique', $prefix = '')
+	{
+		if ($this->init_error)
+		{
+			return;
+		}
+
+		switch ($mode)
+		{
+			case 'real':
+				// Remove every extension from filename (to not let the mime bug being exposed)
+				if (strpos($this->realname, '.') !== false)
+				{
+					$this->realname = substr($this->realname, 0, strpos($this->realname, '.'));
+				}
+
+				// Replace any chars which may cause us problems with _
+				$bad_chars = array("'", "\\", ' ', '/', ':', '*', '?', '"', '<', '>', '|');
+
+				$this->realname = rawurlencode(str_replace($bad_chars, '_', strtolower($this->realname)));
+				$this->realname = preg_replace("/%(\w{2})/", '_', $this->realname);
+
+				$this->realname = $prefix . $this->realname . '.' . $this->extension;
+			break;
+
+			case 'unique':
+			default:
+				$this->realname = $prefix . md5(uniqid(mt_rand(), true)) . '.' . $this->extension;
+			break;
+		}
+	}
+
+	/**
+	* Get property from file object
+	*/
+	function get($property)
+	{
+		if ($this->init_error || !isset($this->$property))
+		{
+			return false;
+		}
+
+		return $this->$property;
+	}
+
+	/**
+	* Check if file is an image (mimetype)
+	*
+	* @return true if it is an image, false if not
+	*/
+	function is_image()
+	{
+		return (strpos($this->mimetype, 'image/') !== false) ? true : false;
+	}
+
+	/**
+	* Check if the file got correctly uploaded
+	*
+	* @return true if it is a valid upload and the file exist, false if not
+	*/
+	function is_uploaded()
+	{
+		if (!$this->local && !is_uploaded_file($this->filename))
+		{
+			return false;
+		}
+
+		return (file_exists($this->filename)) ? true : false;
+	}
+
+	/**
+	* Remove file
+	*/
+	function remove()
+	{
+		if ($this->file_moved)
+		{
+			@unlink($this->destination_file);
+		}
+	}
+
+	/**
+	* Get file extension
+	*/
+	function get_extension($filename)
+	{
+		if (strpos($filename, '.') === false)
+		{
+			return '';
+		}
+
+		$filename = explode('.', $filename);
+		return array_pop($filename);
+	}
+
+	/**
+	* Get mimetype. Utilize mime_content_type if the function exist.
+	*/
+	function get_mimetype($filename)
+	{
+		$mimetype = '';
+
+		if (function_exists('mime_content_type'))
+		{
+			$mimetype = mime_content_type($filename);
+		}
+
+		// Some browsers choke on a mimetype of application/octet-stream
+		if (!$mimetype || $mimetype == 'application/octet-stream')
+		{
+			$mimetype = 'application/octetstream';
+		}
+
+		return $mimetype;
+	}
+
+	/**
+	* Get filesize
+	*/
+	function get_filesize($filename)
+	{
+		return @filesize($filename);
+	}
+
+	/**
+	* Move file to destination folder
+	* The SITE_FILE_ROOT constant will be applied to the destination path
+	*
+	* @param string $destination_path Destination path, for example $config['avatar_path']
+	* @param octal $chmod Permission mask for chmodding the file after a successful move
+	* @access public
+	*/
+	function move_file($destination, $chmod = 0666)
+	{
+		global $_CLASS;
+
+		if (sizeof($this->error))
+		{
+			return false;
+		}
+
+		// Adjust destination path (no trailing slash)
+		if ($destination{(sizeof($destination)-1)} == '/' || $destination{(sizeof($destination)-1)} == '\\')
+		{
+			$destination = substr($destination, 0, sizeof($destination)-2);
+		}
+
+		$destination = str_replace(array('../', '..\\', './', '.\\'), '', $destination);
+		if ($destination && ($destination{0} == '/' || $destination{0} == "\\"))
+		{
+			$destination = '';
+		}
+
+		$this->destination_path = SITE_FILE_ROOT.$destination;
+
+		$upload_mode = (@ini_get('open_basedir') || @ini_get('safe_mode')) ? 'move' : 'copy';
+		$upload_mode = ($this->local) ? 'local' : $upload_mode;
+		$this->destination_file = $this->destination_path . '/' . basename($this->realname);
+
+		switch ($upload_mode)
+		{
+			case 'copy':
+
+				if (!@copy($this->filename, $this->destination_file)) 
+				{
+					if (!@move_uploaded_file($this->filename, $this->destination_file)) 
+					{
+						$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
+						return false;
+					}
+				}
+				else
+				{
+					@unlink($this->filename);
+				}
+
+			break;
+
+			case 'move':
+
+				if (!@move_uploaded_file($this->filename, $this->destination_file)) 
+				{
+					if (!@copy($this->filename, $this->destination_file)) 
+					{
+						$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
+						return false;
+					}
+					else
+					{
+						@unlink($this->filename);
+					}
+				}
+
+			break;
+
+			case 'local':
+
+				if (!@copy($this->filename, $this->destination_file)) 
+				{
+					$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'GENERAL_UPLOAD_ERROR'], $this->destination_file);
+					return false;
+				}
+				@unlink($this->filename);
+
+			break;
+		}
+
+		@chmod($this->destination_file, $chmod);
+
+		// Try to get real filesize from destination folder
+		$this->filesize = (@filesize($this->destination_file)) ? @filesize($this->destination_file) : $this->filesize;
+
+		if ($this->is_image())
+		{
+			$this->width = $this->height = 0;
+
+			if (($this->image_info = @getimagesize($this->destination_file)) !== false)
+			{
+				$this->width = $this->image_info[0];
+				$this->height = $this->image_info[1];
+
+				if (!empty($this->image_info['mime']))
+				{
+					$this->mimetype = $this->image_info['mime'];
+				}
+			}
+		}
+
+		$this->file_moved = true;
+		$this->additional_checks();
+		unset($this->upload);
+
+		return true;
+	}
+
+	/**
+	* Performing additional checks
+	*/
+	function additional_checks()
+	{
+		global $_CLASS;
+
+		if (!$this->file_moved)
+		{
+			return false;
+		}
+
+		// Filesize is too big or it's 0 if it was larger than the maxsize in the upload form
+		if ($this->upload->max_filesize && ($this->get('filesize') > $this->upload->max_filesize || $this->filesize == 0))
+		{
+			$size_lang = ($this->upload->max_filesize >= 1048576) ? $_CLASS['core_user']->lang['MB'] : (($this->upload->max_filesize >= 1024) ? $_CLASS['core_user']->lang['KB'] : $_CLASS['core_user']->lang['BYTES'] );
+			$max_filesize = ($this->upload->max_filesize >= 1048576) ? round($this->upload->max_filesize / 1048576 * 100) / 100 : (($this->upload->max_filesize >= 1024) ? round($this->upload->max_filesize / 1024 * 100) / 100 : $this->upload->max_filesize);
+	
+			$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'WRONG_FILESIZE'], $max_filesize, $size_lang);
+
+			return false;
+		}
+
+		if (!$this->upload->valid_dimensions($this))
+		{
+			$this->error[] = sprintf($_CLASS['core_user']->lang[$this->upload->error_prefix . 'WRONG_SIZE'], $this->upload->min_width, $this->upload->min_height, $this->upload->max_width, $this->upload->max_height, $this->width, $this->height);
+
+			return false;
+		}
+
+		return true;
+	}
+}
+
+/**
+* Class for assigning error messages before a real filespec class can be assigned
+*
+* @package phpBB3
+*/
+class fileerror extends filespec
+{
+	function fileerror($error_msg)
+	{
+		$this->error[] = $error_msg;
+	}
+}
+
+/**
+* File upload class
+* Init class (all parameters optional and able to be set/overwritten seperatly) - scope is global and valid for all uploads
+*
+* @package phpBB3
+*/
+class fileupload
+{
+	var $allowed_extensions = array();
+	var $max_filesize = 0;
+	var $min_width = 0;
+	var $min_height = 0;
+	var $max_width = 0;
+	var $max_height = 0;
+	var $error_prefix = '';
+
+	/**
+	* Init file upload class.
+	*
+	* @param string $error_prefix Used error messages will get prefixed by this string
+	* @param array $allowed_extensions Array of allowed extensions, for example array('jpg', 'jpeg', 'gif', 'png')
+	* @param int $max_filesize Maximum filesize
+	* @param int $min_width Minimum image width (only checked for images)
+	* @param int $min_height Minimum image height (only checked for images)
+	* @param int $max_width Maximum image width (only checked for images)
+	* @param int $max_height Maximum image height (only checked for images)
+	*
+	*/
+	function fileupload($error_prefix = '', $allowed_extensions = false, $max_filesize = false, $min_width = false, $min_height = false, $max_width = false, $max_height = false)
+	{
+		$this->set_allowed_extensions($allowed_extensions);
+		$this->set_max_filesize($max_filesize);
+		$this->set_allowed_dimensions($min_width, $min_height, $max_width, $max_height);
+		$this->set_error_prefix($error_prefix);
+	}
+
+	/**
+	* Reset vars
+	*/
+	function reset_vars()
+	{
+		$this->max_filesize = 0;
+		$this->min_width = $this->min_height = $this->max_width = $this->max_height = 0;
+		$this->error_prefix = '';
+		$this->allowed_extensions = array();
+	}
+
+	/**
+	* Set allowed extensions
+	*/
+	function set_allowed_extensions($allowed_extensions)
+	{
+		if ($allowed_extensions !== false && is_array($allowed_extensions))
+		{
+			$this->allowed_extensions = $allowed_extensions;
+		}
+	}
+
+	/**
+	* Set allowed dimensions
+	*/
+	function set_allowed_dimensions($min_width, $min_height, $max_width, $max_height)
+	{
+		$this->min_width = (int) $min_width;
+		$this->min_height = (int) $min_height;
+		$this->max_width = (int) $max_width;
+		$this->max_height = (int) $max_height;
+	}
+
+	/**
+	* Set maximum allowed filesize
+	*/
+	function set_max_filesize($max_filesize)
+	{
+		if ($max_filesize !== false && (int) $max_filesize)
+		{
+			$this->max_filesize = (int) $max_filesize;
+		}
+	}
+
+	/**
+	* Set error prefix
+	*/
+	function set_error_prefix($error_prefix)
+	{
+		$this->error_prefix = $error_prefix;
+	}
+
+	/**
+	* Form upload method
+	* Upload file from users harddisk
+	*
+	* @param string $form_name Form name assigned to the file input field (if it is an array, the key has to be specified)
+	* @return object $file Object "filespec" is returned, all further operations can be done with this object
+	* @access public
+	*/
+	function form_upload($form_name)
+	{
+		global $_CLASS;
+
+		unset($_FILES[$form_name]['local_mode']);
+		$file = new filespec($_FILES[$form_name], $this);
+
+		if ($file->init_error)
+		{
+			$file->error[] = '';
+			return $file;
+		}
+
+		// Error array filled?
+		if (isset($_FILES[$form_name]['error']))
+		{
+			$error = $this->assign_internal_error($_FILES[$form_name]['error']);
+
+			if ($error !== false)
+			{
+				$file->error[] = $error;
+				return $file;
+			}
+		}
+
+		// Check if empty file got uploaded (not catched by is_uploaded_file)
+		if (isset($_FILES[$form_name]['size']) && $_FILES[$form_name]['size'] == 0)
+		{
+			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'EMPTY_FILEUPLOAD'];
+			return $file;
+		}
+
+		// PHP Upload filesize exceeded
+		if ($file->get('filename') == 'none')
+		{
+			$file->error[] = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
+			return $file;
+		}
+
+		// Not correctly uploaded
+		if (!$file->is_uploaded())
+		{
+			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
+			return $file;
+		}
+
+		$this->common_checks($file);
+
+		return $file;
+	}
+
+	/**
+	* Move file from another location to phpBB
+	*/
+	function local_upload($source_file, $filedata = false)
+	{
+		global $_CLASS;
+
+		$form_name = 'local';
+
+		$_FILES[$form_name]['local_mode'] = true;
+		$_FILES[$form_name]['tmp_name'] = $source_file;
+
+		if ($filedata === false)
+		{
+			$_FILES[$form_name]['name'] = basename($source_file);
+			$_FILES[$form_name]['size'] = 0;
+			$_FILES[$form_name]['type'] = '';
+		}
+		else
+		{
+			$_FILES[$form_name]['name'] = $filedata['realname'];
+			$_FILES[$form_name]['size'] = $filedata['size'];
+			$_FILES[$form_name]['type'] = $filedata['type'];
+		}
+
+		$file = new filespec($_FILES[$form_name], $this);
+
+		if ($file->init_error)
+		{
+			$file->error[] = '';
+			return $file;
+		}
+
+		if (isset($_FILES[$form_name]['error']))
+		{
+			$error = $this->assign_internal_error($_FILES[$form_name]['error']);
+
+			if ($error !== false)
+			{
+				$file->error[] = $error;
+				return $file;
+			}
+		}
+
+		// PHP Upload filesize exceeded
+		if ($file->get('filename') == 'none')
+		{
+			$file->error[] = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
+			return $file;
+		}
+
+		// Not correctly uploaded
+		if (!$file->is_uploaded())
+		{
+			$file->error[] = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
+			return $file;
+		}
+
+		$this->common_checks($file);
+
+		return $file;
+	}
+
+	/**
+	* Remote upload method
+	* Uploads file from given url
+	*
+	* @param string $upload_url URL pointing to file to upload, for example http://www.foobar.com/example.gif
+	* @return object $file Object "filespec" is returned, all further operations can be done with this object
+	* @access public
+	*/
+	function remote_upload($upload_url)
+	{
+		global $_CLASS;
+
+		$upload_ary = array();
+		$upload_ary['local_mode'] = true;
+
+		if (!preg_match('#^(https?://).*?\.(' . implode('|', $this->allowed_extensions) . ')$#i', $upload_url, $match))
+		{
+			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'URL_INVALID']);
+			return $file;
+		}
+ 
+		if (empty($match[2]))
+		{
+			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'URL_INVALID']);
+			return $file;
+		}
+
+		$url = parse_url($upload_url);
+
+		$host = $url['host'];
+		$path = $url['path'];
+		$port = (!empty($url['port'])) ? (int) $url['port'] : 80;
+
+		$upload_ary['type'] = 'application/octet-stream';
+
+		$url['path'] = explode('.', $url['path']);
+		$ext = array_pop($url['path']);
+
+		$url['path'] = implode('', $url['path']);
+		$upload_ary['name'] = basename($url['path']) . (($ext) ? '.' . $ext : '');
+		$filename = $url['path'];
+		$filesize = 0;
+
+		if (!($fsock = @fsockopen($host, $port, $errno, $errstr)))
+		{
+			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED']);
+			return $file;
+		}
+
+		fputs($fsock, 'GET /' . $path . " HTTP/1.1\r\n");
+		fputs($fsock, "HOST: " . $host . "\r\n");
+		fputs($fsock, "Connection: close\r\n\r\n");
+
+		$get_info = false;
+		$data = '';
+		while (!@feof($fsock))
+		{
+			if ($get_info)
+			{
+				$data .= @fread($fsock, 1024);
+			}
+			else
+			{
+				$line = @fgets($fsock, 1024);
+
+				if ($line == "\r\n")
+				{
+					$get_info = true;
+				}
+				else
+				{
+					if (strpos($line, 'Content-Type: ') !== false)
+					{
+						$upload_ary['type'] = rtrim(str_replace('Content-Type: ', '', $line));
+					}
+					else if (strpos($line, '404 Not Found') !== false)
+					{
+						$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'URL_NOT_FOUND']);
+						return $file;
+					}
+				}
+			}
+		}
+		@fclose($fsock);
+
+		if (empty($data))
+		{
+			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'EMPTY_REMOTE_DATA']);
+			return $file;
+		}
+
+		$tmp_path = (!@ini_get('safe_mode')) ? false : SITE_FILE_ROOT . 'cache';
+		$filename = tempnam($tmp_path, uniqid(mt_rand(), true) . '-');
+
+		if (!($fp = @fopen($filename, 'wb')))
+		{
+			$file = new fileerror($_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED']);
+			return $file;
+		}
+
+		$upload_ary['size'] = fwrite($fp, $data);
+		fclose($fp);
+		unset($data);
+
+		$upload_ary['tmp_name'] = $filename;
+
+		$file = new filespec($upload_ary, $this);
+		$this->common_checks($file);
+
+		return $file;
+	}
+
+	/**
+	* Assign internal error
+	* @access private
+	*/
+	function assign_internal_error($errorcode)
+	{
+		global $_CLASS;
+
+		switch ($errorcode)
+		{
+			case 1:
+				$error = (@ini_get('upload_max_filesize') == '') ? $_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_NA'] : sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'PHP_SIZE_OVERRUN'], @ini_get('upload_max_filesize'));
+			break;
+
+			case 2:
+				$size_lang = ($this->max_filesize >= 1048576) ? $_CLASS['core_user']->lang['MB'] : (($this->max_filesize >= 1024) ? $_CLASS['core_user']->lang['KB'] : $_CLASS['core_user']->lang['BYTES'] );
+				$max_filesize = ($this->max_filesize >= 1048576) ? round($this->max_filesize / 1048576 * 100) / 100 : (($this->max_filesize >= 1024) ? round($this->max_filesize / 1024 * 100) / 100 : $this->max_filesize);
+
+				$error = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'WRONG_FILESIZE'], $max_filesize, $size_lang);
+			break;
+
+			case 3:
+				$error = $_CLASS['core_user']->lang[$this->error_prefix . 'PARTIAL_UPLOAD'];
+			break;
+
+			case 4:
+				$error = $_CLASS['core_user']->lang[$this->error_prefix . 'NOT_UPLOADED'];
+			break;
+
+			case 6:
+				$error = 'Temporary folder could not be found. Please check your PHP installation.';
+			break;
+
+			default:
+				$error = false;
+			break;
+		}
+
+		return $error;
+	}
+
+	/**
+	* Perform common checks
+	*/
+	function common_checks(&$file)
+	{
+		global $_CLASS;
+
+		// Filesize is too big or it's 0 if it was larger than the maxsize in the upload form
+		if ($this->max_filesize && ($file->get('filesize') > $this->max_filesize || $file->get('filesize') == 0))
+		{
+			$size_lang = ($this->max_filesize >= 1048576) ? $_CLASS['core_user']->lang['MB'] : (($this->max_filesize >= 1024) ? $_CLASS['core_user']->lang['KB'] : $_CLASS['core_user']->lang['BYTES'] );
+			$max_filesize = ($this->max_filesize >= 1048576) ? round($this->max_filesize / 1048576 * 100) / 100 : (($this->max_filesize >= 1024) ? round($this->max_filesize / 1024 * 100) / 100 : $this->max_filesize);
+
+			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'WRONG_FILESIZE'], $max_filesize, $size_lang);
+		}
+
+		// check Filename
+		if (preg_match("#[\\/:*?\"<>|]#i", $file->get('realname')))
+		{ 
+			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'INVALID_FILENAME'], $file->get('realname'));
+		}
+
+		// Invalid Extension
+		if (!$this->valid_extension($file))
+		{
+			$file->error[] = sprintf($_CLASS['core_user']->lang[$this->error_prefix . 'DISALLOWED_EXTENSION'], $file->get('extension'));
+		}
+	}
+
+	/**
+	* Check for allowed extension
+	*/
+	function valid_extension(&$file)
+	{
+		return (in_array($file->get('extension'), $this->allowed_extensions)) ? true : false;
+	}
+
+	/**
+	* Check for allowed dimension
+	*/
+	function valid_dimensions(&$file)
+	{
+		if (!$this->max_width && !$this->max_height && !$this->min_width && !$this->min_height)
+		{
+			return true;
+		}
+
+		if (($file->get('width') > $this->max_width && $this->max_width) || 
+			($file->get('height') > $this->max_height && $this->max_height) || 
+			($file->get('width') < $this->min_width && $this->min_width) ||
+			($file->get('height') < $this->min_height && $this->min_height))
+		{
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
+	* Check if form upload is valid
+	*/
+	function is_valid($form_name)
+	{
+		return (isset($_FILES[$form_name]) && $_FILES[$form_name]['name'] != 'none') ? true : false;
+	}
+}
+
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/mcp/mcp_notes.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -84,15 +84,9 @@
 	if (($deletemark || $deleteall) && $_CLASS['forums_auth']->acl_get('a_clearlogs'))
 	{
 		$where_sql = '';
-		if ($deletemark && $marked)
+		if ($deletemark && !empty($marked))
 		{
-			/*$sql_in = array();
-			foreach ($marked as $mark)
-			{
-				$sql_in[] = $mark;
-			}*/
 			$where_sql = ' AND log_id IN (' . implode(', ', $marked) . ')';
-			/*unset($sql_in);*/
 		}
 
 		if ($where_sql || $deleteall)

Modified: cms/trunk/includes/forums/mcp/mcp_post.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -147,7 +147,7 @@
 	'U_MCP_APPROVE'			=> generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve_details&amp;p=' . $post_info['post_id']),
 	'U_MCP_REPORT'			=> generate_link('forums&amp;file=mcp&amp;i=reports&amp;mode=report_details&amp;p=' . $post_info['post_id']),
 	'U_MCP_USER_NOTES'		=> generate_link('forums&amp;file=mcp&amp;i=notes&amp;mode=user_notes&amp;u=' . $post_info['user_id']),
-	'U_MCP_WARN_USER'		=> $_CLASS['forums_auth']->acl_get('m_warn') ? append_sid("{$phpbb_root_path}mcp.$phpEx", 'i=warn&amp;mode=warn_user&amp;u=' . $post_info['user_id']) : '',
+	'U_MCP_WARN_USER'		=> $_CLASS['forums_auth']->acl_get('m_warn') ? generate_link('forums&amp;file=mcp&amp;i=warn&amp;mode=warn_user&amp;u=' . $post_info['user_id']) : '',
 	'U_VIEW_POST'			=> generate_link('forums&amp;file=viewtopic&amp;p=' . $post_info['post_id'] . '#p' . $post_info['post_id']),
 	'U_VIEW_PROFILE'		=> generate_link('members_list&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
 	'U_VIEW_TOPIC'			=> generate_link('forums&amp;file=viewtopic&amp;t=' . $post_info['topic_id']),

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -146,10 +146,10 @@
 }
 $_CLASS['core_db']->free_result($result);
 
-if ($bbcode_bitfield)
+if ($bbcode_bitfield !== '')
 {
 	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-	$bbcode = new bbcode($bbcode_bitfield);
+	$bbcode = new bbcode(base64_encode($bbcode_bitfield));
 }
 
 foreach ($rowset as $i => $row)

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/forums/message_parser.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -51,7 +51,6 @@
 		$this->bbcode_bitfield = '';
 		$bitfield = new bitfield();
 
-		$size = mb_strlen($this->message);
 		foreach ($this->bbcodes as $bbcode_name => $bbcode_data)
 		{
 			if (isset($bbcode_data['disabled']) && $bbcode_data['disabled'])
@@ -66,22 +65,29 @@
 				}
 			}
 			else
-			{
-				foreach ($bbcode_data['regexp'] as $regexp => $replacement)
-				{
-					$this->message = preg_replace($regexp, $replacement, $this->message);
-				}
+			{
+				// TODO: Review this
+				$found = false;
+				foreach ($bbcode_data['regexp'] as $regexp => $replacement)
+				{
+					if (!$found)
+					{
+						$before = strlen($this->message);
+					}
+					$this->message = preg_replace($regexp, $replacement, $this->message);
+					if (!$found)
+					{
+						$after = strlen($this->message);
+						if ($before != $after)
+						{
+							// Because we add bbcode_uid to all tags, the message length
+							// will increase whenever a tag is found
+							$bitfield->set($bbcode_data['bbcode_id']);
+							$found = true;
+						}
+					}
+				}
 			}
-
-			// Because we add bbcode_uid to all tags, the message length
-			// will increase whenever a tag is found
-			$new_size = mb_strlen($this->message);
-
-			if ($size !== $new_size)
-			{
-				$bitfield->set($bbcode_data['bbcode_id']);
-				$size = $new_size;
-			}
 		}
 
 		$this->bbcode_bitfield = $bitfield->get_base64();
@@ -1281,7 +1287,7 @@
 	*/
 	function get_submitted_attachment_data($check_user_id = false)
 	{
-		global $_CLASS;
+		global $_CLASS, $config;
 
 		$this->filename_data['filecomment'] = request_var('filecomment', '', true);
 		$this->attachment_data = isset($_POST['attachment_data']) ? $_POST['attachment_data'] : array();
@@ -1295,7 +1301,7 @@
 		{
 			if ($var_ary['attach_id'])
 			{
-				$attach_ids[(int) $this->attachment_data[$pos]['attach_id']] = $pos;
+				$attach_ids[$this->attachment_data[$pos]['attach_id']] = $pos;
 			}
 			else
 			{
@@ -1308,12 +1314,12 @@
 		$this->attachment_data = array();
 
 		// Regenerate already posted attachments...
-		if (sizeof($attach_ids))
+		if (!empty($attach_ids))
 		{
 			// Get the data from the attachments
-			$sql = 'SELECT attach_id, physical_filename, real_filename, extension, mimetype, filesize, filetime, thumbnail
-				FROM ' . ATTACHMENTS_TABLE . '
-				WHERE attach_id IN (' . implode(', ', $attach_ids) . ')
+			$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', array_unique(array_map('intval', array_keys($attach_ids)))) . ')
 					AND poster_id = ' . $check_user_id;
 			$result = $_CLASS['core_db']->query($sql);
 
@@ -1323,16 +1329,16 @@
 				{
 					$pos = $attach_ids[$row['attach_id']];
 					$this->attachment_data[$pos] = $row;
-					set_var($this->attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+					set_var($this->attachment_data[$pos]['comment'], $_POST['attachment_data'][$pos]['comment'], 'string', true);
 
 					unset($attach_ids[$row['attach_id']]);
 				}
 			}
 			$_CLASS['core_db']->free_result($result);
 
-			if (sizeof($attach_ids))
+			if (!empty($attach_ids))
 			{
-				trigger_error($_CLASS['core_user']->lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+				trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
 			}
 		}
 
@@ -1342,7 +1348,7 @@
 			require_once SITE_FILE_ROOT.'includes/forums/functions_upload.php';
 
 			$sql = 'SELECT attach_id
-				FROM ' . ATTACHMENTS_TABLE . "
+				FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 				WHERE LOWER(physical_filename) IN ('" . implode("' ,'", $_CLASS['core_db']->escape_array(array_map('strtolower', $filenames))) . "')";
 			$result = $_CLASS['core_db']->query_limit($sql, 1);
 			$row = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -1350,7 +1356,7 @@
 
 			if ($row)
 			{
-				trigger_error($_CLASS['core_user']->lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+				trigger_error('NO_ACCESS_ATTACHMENT', E_USER_ERROR);
 			}
 
 			foreach ($filenames as $pos => $physical_filename)
@@ -1363,7 +1369,7 @@
 					'thumbnail'			=> (file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/thumb_' . $physical_filename)) ? 1 : 0,
 				);
 
-				set_var($this->attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+				set_var($this->attachment_data[$pos]['comment'], $_POST['attachment_data'][$pos]['comment'], 'string', true);
 				set_var($this->attachment_data[$pos]['real_filename'], $_POST['attachment_data'][$pos]['real_filename'], 'string', true);
 				set_var($this->attachment_data[$pos]['filetime'], $_POST['attachment_data'][$pos]['filetime'], 'int');
 
@@ -1393,7 +1399,7 @@
 		$this->message = $poll['poll_option_text'];
 
 
-		$poll['poll_option_text'] = $this->parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+		$poll['poll_option_text'] = $this->parse(false, $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
 
 
 		$this->message = $tmp_message;
@@ -1403,9 +1409,8 @@
 		$this->message = $poll['poll_title'];
 
 
-		$poll['poll_title'] = $this->parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+		$poll['poll_title'] = $this->parse(false, $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
 
-
 		$this->message = $tmp_message;
 
 		unset($tmp_message);

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/functions.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -45,7 +45,7 @@
 {
 	//Code Copyright 2004 phpBB Group - http://www.phpbb.com/
 	return preg_match('#^[a-z0-9\.\-_\+]+?@(.*?\.)*?[a-z0-9\-_]+?\.[a-z]{2,4}$#i', $email);
-	//preg_match('#^.*?@(.*?\.)?[a-z0-9\-]+\.[a-z]{2,4}$#i', $email)
+	//preg_match('[a-z0-9&\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*[a-z]+', $email)
 }
 
 function check_bot_status($browser, $ip)
@@ -655,8 +655,8 @@
 		}
 
 /* I think reference is required below PHP 4.4 */
-		$_CLASS[$name] =& new $class;
-		//$_CLASS[$name] = new $class;
+		//$_CLASS[$name] =& new $class;
+		$_CLASS[$name] = new $class;
 	}
 }
 

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/tables.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -76,9 +76,9 @@
 define('PAGE_MODULE', 0);
 define('PAGE_TEMPLATE', 1);
 
-define('ACL_NO', 0);
-define('ACL_YES', 1);
-define('ACL_UNSET', -1);
+define('ACL_NEVER', 0);
+define('ACL_YES', 1);
+define('ACL_NO', -1);
 
 define('GROUP_HIDDEN', 0);
 define('GROUP_SYSTEM', 1);
@@ -161,6 +161,8 @@
 define('FORUMS_ACL_TABLE', $table_prefix.'forums_auth');
 define('FORUMS_ACL_OPTIONS_TABLE', $table_prefix.'forums_auth_options');
 define('FORUMS_ACL_PRESETS_TABLE', $table_prefix.'forums_auth_presets');
+define('FORUMS_ACL_ROLES_TABLE', $table_prefix.'forums_acl_roles');
+define('FORUMS_ACL_ROLES_DATA_TABLE', $table_prefix.'forums_acl_roles_data');
 
 define('FORUMS_ATTACHMENTS_TABLE', $table_prefix.'forums_attachments');
 define('FORUMS_BOOKMARKS_TABLE', $table_prefix.'forums_bookmarks');

Added: cms/trunk/includes/templates/modules/forums/admin/acp_main.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/admin/acp_main.html	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/includes/templates/modules/forums/admin/acp_main.html	2006-08-16 12:22:53 UTC (rev 184)
@@ -0,0 +1,100 @@
+<!-- INCLUDE modules/forums/admin/overall_header.html -->
+
+<a name="maincontent"></a><h1>{ $L_WELCOME_PHPBB }</h1>
+
+<p>{ $L_ADMIN_INTRO }</p>
+
+<form id="stats" method="post" action="{ $U_ACTION }">
+
+<table class="tablebg" width="100%" cellspacing="1">
+	<caption>{ $L_FORUM_STATS }</caption>
+<thead>
+	<tr>
+		<th>{ $L_STATISTIC }</th>
+		<th>{ $L_VALUE }</th>
+		<th>{ $L_STATISTIC }</th>
+		<th>{ $L_VALUE }</th>
+	</tr>
+</thead>
+<tbody>
+	<tr>
+		<td class="row1">{ $L_NUMBER_POSTS }: </td>
+		<td class="row2"><b>{ $TOTAL_POSTS }</b></td>
+		<td class="row1">{ $L_POSTS_PER_DAY }: </td>
+		<td class="row2"><b>{ $POSTS_PER_DAY }</b></td>
+	</tr>
+	<tr>
+		<td class="row1">{ $L_NUMBER_TOPICS }: </td>
+		<td class="row2"><b>{ $TOTAL_TOPICS }</b></td>
+		<td class="row1">{ $L_TOPICS_PER_DAY }: </td>
+		<td class="row2"><b>{ $TOPICS_PER_DAY }</b></td>
+	</tr>
+	<tr>
+		<td class="row1">{ $L_NUMBER_USERS }: </td>
+		<td class="row2"><b>{ $TOTAL_USERS }</b></td>
+		<td class="row1">{ $L_USERS_PER_DAY }: </td>
+		<td class="row2"><b>{ $USERS_PER_DAY }</b></td>
+	</tr>
+	<tr>
+		<td class="row1">{ $L_NUMBER_FILES }: </td>
+		<td class="row2"><b>{ $TOTAL_FILES }</b></td>
+		<td class="row1">{ $L_FILES_PER_DAY }: </td>
+		<td class="row2"><b>{ $FILES_PER_DAY }</b></td>
+	</tr>
+	<tr>
+		<td class="row1">{ $L_BOARD_STARTED }: </td>
+		<td class="row2"><b>{ $START_DATE }</b></td>
+		<td class="row1">{ $L_AVATAR_DIR_SIZE }: </td>
+		<td class="row2"><b>{ $AVATAR_DIR_SIZE }</b></td>
+	</tr>
+	<tr>
+		<td class="row1">{ $L_UPLOAD_DIR_SIZE }: </td>
+		<td class="row2"><b>{ $UPLOAD_DIR_SIZE }</b></td>
+	</tr>
+<!-- IF { $S_ACTION_OPTIONS } -->
+	<tr>
+		<td class="cat" colspan="4" align="right">
+	
+		<select name="action">{ $S_ACTION_OPTIONS }</select>
+		<input class="button" type="submit" name="submit" value="{ $L_SUBMIT }" />
+	</tr>
+<!-- ENDIF -->
+</tbody>
+</table>
+
+</form>
+
+
+<!-- IF !empty({ $log }) -->
+	<h2>{ $L_ADMIN_LOG }</h2>
+
+	<p>{ $L_ADMIN_LOG_INDEX_EXPLAIN }</p>
+
+	<table class="tablebg" width="100%" cellspacing="1">
+	<thead>
+	<tr>
+		<th>{ $L_USERNAME }</th>
+		<th>{ $L_IP }</th>
+		<th>{ $L_TIME }</th>
+		<th>{ $L_ACTION }</th>
+	</tr>
+	</thead>
+	<tbody>
+	<!-- LOOP $log -->
+		<!-- IF { $log:#LOOP_INDEX } % 2 --><tr class="row1"><!-- ELSE --><tr class="row2"><!-- ENDIF -->
+
+			<td class="row1">{ $log:USERNAME }</td>
+			<td style="text-align: center;">{ $log:IP }</td>
+			<td style="text-align: center;">{ $log:DATE }</td>
+			<td class="row1">{ $log:ACTION }</td>
+		</tr>
+	<!-- ENDLOOP $log -->
+	</tbody>
+	</table>
+
+	<br />
+	<div style="text-align: right;"><a href="{ $U_ADMIN_LOG}">&raquo; { $L_VIEW_ADMIN_LOG }</a></div>
+
+<!-- ENDIF -->
+
+<!-- INCLUDE modules/forums/admin/overall_footer.html -->
\ No newline at end of file

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/install/build_data.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -23,154 +23,154 @@
 
 $time = gmtime();
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_access (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_AUTH_TABLE ." (admin_section, user_id, admin_status) VALUES ('_all_', 2, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_upload', 'images/avatars/upload', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_gallery', 'images/avatars/gallery', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_smilies', 'images/smilies', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_upload', 'images/avatars/upload', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_avatar_gallery', 'images/avatars/gallery', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'path_smilies', 'images/smilies', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'site_name', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_theme', 'viperal', 'string', 1)");
 $content = $_CLASS['core_db']->escape('<a href="feed.php?mod=articles&feed=rss1" title="RSS 1.0 / RDF Feed"><img alt="RSS 1.0 / RDF" src="images/rss10_logo.gif" /></a> <a href="feed.php?mod=articles&feed=rss2" title="RSS 2.0 Feed"><img alt="RSS 2.0" src="images/rss20_logo.gif" /></a> <a href="feed.php?mod=articles&feed=rss" title="RSS 0.91 Feed"><img alt="RSS 0.9" src="images/rss090_logo.gif" /></a>');
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '$content', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dst', '0', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'only_registered', '0', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_timezone', '-5', 'float', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'link_optimization', '0', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'index_page', 'contact', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot1', '$content', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'foot2', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_lang', 'en', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dst', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'only_registered', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_dateformat', 'D M d, Y g:i a', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'default_timezone', '-5', 'float', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'link_optimization', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('global', 'index_page', 'contact', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'active', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'active', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'start', '', 'int', 1)");
 $content = $_CLASS['core_db']->escape('<p align="center"><b>Sorry we are currently updating this site.<br>Please try again later</b></p>');
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '$content', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('maintenance', 'text', '$content', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'allow_html_email', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_enable', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_function_name', 'mail', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp', 0, 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_host', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_port', '', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_username', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_password', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'site_email', 'none at none.com', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'allow_html_email', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_enable', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'email_function_name', 'mail', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp', 0, 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_host', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_port', '', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_username', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'smtp_password', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('email', 'site_email', 'none at none.com', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_chars', '.*', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'enable_confirm', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_enable', '1', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_fax', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_mail', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_name_chars', '5', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_reg_attempts', '10', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_name_chars', '50', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_pass_chars', '5', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_pass_chars', '25', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_email_reuse', '0', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_change', '0', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_username', 'admin', 'string', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_user_id', '2', 'int', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'activation', '0', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'total_users', '1', 'int', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'password_encoding', 'md5', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_chars', '.*', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'enable_confirm', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_enable', '1', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_fax', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'coppa_mail', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_name_chars', '5', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_reg_attempts', '10', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_name_chars', '50', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'min_pass_chars', '5', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'max_pass_chars', '25', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_email_reuse', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'allow_name_change', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_username', 'admin', 'string', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'newest_user_id', '2', 'int', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'activation', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'total_users', '1', 'int', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('user', 'password_encoding', 'md5', 'string', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'path', '/', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_domain', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_name', 'viperal', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_path', '/', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_load', '0', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_sessions', '0', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'ip_check', '4', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'session_length', '3600', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'error_options', '0', 'int', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_secure', '0', 'bool', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_domain', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_path', '', 'string', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."config (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_port', '', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'path', '/', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_domain', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_name', 'viperal', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'cookie_path', '/', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_load', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'limit_sessions', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'ip_check', '4', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'session_length', '3600', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'error_options', '0', 'int', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_secure', '0', 'bool', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_domain', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_path', '', 'string', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONFIG_TABLE  ." (config_section, config_name, config_value, config_type, config_cache) VALUES ('server', 'site_port', '', 'int', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('GUESTS', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('REGISTERED_COPPA', 1, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('ADMINISTRATORS', 1, 2, 'AA0000', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('BOTS', 1, 2, '9E8DA7', 1, '')");
 // To be seperated
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ." (group_name, group_type, group_status, group_colour, group_legend, group_description) VALUES ('SUPER_MODERATORS', 1, 2, '00AA00', 0, '')");
 
 
 //Admin
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (2, 2, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (4, 2, 10)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (6, 2, 10)");
 // Anonymous
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (1, 1, 2)");
 // Bots
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."groups_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 3, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 4, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 5, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 6, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 7, 2)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_GROUPS_TABLE  ."_members (group_id, user_id, member_status) VALUES (5, 8, 2)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 1, 1, 'block-Control_Panel.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 1, 2, 'block-Modules.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 1, 3, 'block-User.php')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 2, 1, 'http://www.php.net/news.rss', 7200)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 2, 2, 'block-theme_select.php')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Contol Panel', 3, 2, 1, 1, 'block-Control_Panel.php')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Modules', 0, 2, 1, 2, 'block-Modules.php')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('User', 0, 2, 1, 3, 'block-User.php')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_rss_url, block_rss_rate) VALUES ('php.net RSS Feed', 1, 2, 2, 1, 'http://www.php.net/news.rss', 7200)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_file) VALUES ('Theme Select', 0, 2, 2, 2, 'block-theme_select.php')");
 
 $content = $_CLASS['core_db']->escape('<div style="text-align:center">Hello and welcome</div>');
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."blocks (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_BLOCKS_TABLE  ." (block_title, block_type, block_status, block_position, block_order, block_content) VALUES ('Welcome', 4, 2, 6, 4, '$content')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('blocks', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('system', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('messages', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('modules', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('pages', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('smiles', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('users', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."admin_modules (module_name, module_status, module_type) VALUES ('forums', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('blocks', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('system', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('messages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('modules', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('pages', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('smiles', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('users', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('forums', 2, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('main', 2, 'front\r\nsubscribed\r\nbookmarks\r\ndrafts')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('pm', 2, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('profile', 2,'profile_info\r\nreg_details\r\nsignature\r\navatar')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('prefs', 2, 'personal\r\nview\r\npost')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('zebra', 2, 'friends\r\nfoes')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('attachments', 1, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('groups', 2, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."control_panel_modules (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('main', 2, 'front\r\nsubscribed\r\nbookmarks\r\ndrafts')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('pm', 2, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('profile', 2,'profile_info\r\nreg_details\r\nsignature\r\navatar')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('prefs', 2, 'personal\r\nview\r\npost')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('zebra', 2, 'friends\r\nfoes')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('attachments', 1, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('groups', 2, '')");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('calender', 2,'month_view\r\nday_view\r\nadd_event')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('articles', 0, 1, 102)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('contact', 0, 2, 102)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('calender', 0, 1, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 0, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('forums', 0, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('members_list', 0, 2, 98)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."pages (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 0, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('articles', 0, 1, 102)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('contact', 0, 2, 102)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('calender', 0, 1, 98)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('control_panel', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('forums', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('members_list', 0, 2, 98)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_PAGES_TABLE  ." (page_name, page_type, page_status, page_blocks) VALUES ('quick_message', 0, 1, 102)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."smilies (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':D', 'grin.png', 'Very Happy', 19, 19, 1, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':)', 'smile.png', 'Smile', 19, 19, 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':(', 'sad.png', 'Sad', 19, 19, 3, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':o', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':eek:', 'surprised.png', 'Surprised', 19, 19, 4, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8O', 'eek.png', 'Shocked', 19, 19, 5, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?', 'confused.png', 'Confused', 19, 19, 6, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES ('8)', 'cool.png', 'Cool', 19, 19, 7, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':lol:', 'laugh.png', 'Laughing', 19, 19, 8, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':x', 'mad.png', 'Mad', 19, 19, 9, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':P', 'icon_razz.gif', 'Razz', 19, 19, 10, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':oops:', 'embarrassed.png', 'Embarassed', 19, 19, 11, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':cry:', 'cry.png', 'Crying or Very sad', 19, 19, 12, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':evil:', 'evil.png', 'Evil or Very Mad', 19, 19, 13, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':twisted:', 'twisted.png', 'Twisted Evil', 19, 19, 14, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':roll:', 'rolleyes.png', 'Rolling Eyes', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (';)', 'wink.png', 'Wink', 19, 19, 16, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':!:', 'exclaim.png', 'Exclamation', 19, 19, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':?:', 'question.png', 'Question', 19, 19, 18, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':idea:', 'idea.png', 'Idea', 19, 19, 19, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':arrow:', 'arrow.png', 'Arrow', 19, 19, 20, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':|', 'neutral.png', 'Neutral', 19, 19, 21, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_SMILIES_TABLE  ." (smiley_code, smiley_src, smiley_description, smiley_width, smiley_height, smiley_order, smiley_type) VALUES (':mrgreen:', 'mrgreen.png', 'Mr. Green', 19, 19, 22, 0)");
 
 $data = serialize(array(
 	'viewimg' => 1,
@@ -189,313 +189,441 @@
 
 $admin_data = $guest_data = $bot_data = $_CLASS['core_db']->escape($data);
 
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', 'AA0000', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8.,66.249.64.,66.249.71.', 'Googlebot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '222.122.194.,218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$user_prefix."users (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (0, 2, 1, 'Anonymous', '', '', '', $time, '', 1, 0, 0, 0, 0, '$guest_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (1, 2, 4, 'admin', '21232f297a57a5a743894a0e4a801fc3', 'md5', '', $time, '', 'AA0000', 1, 1, 1, 1, 1, '$admin_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Googlebot', '', '', '', $time, '216.239.46.,64.68.8.,66.249.64.,66.249.71.', 'Googlebot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'MSN', '', '', '', $time, '65.54.188.', 'msnbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Yahoo', '', '', '', $time, '66.196.90.1', 'Yahoo! Slurp', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Alexa', '', '', '', $time, '66.28.250.,209.237.238.', 'ia_archiver', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'NaverBot', '', '', '', $time, '222.122.194.,218.145.25.,61.78.61.,61.78.61.', 'NaverBot-', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_USERS_TABLE  ." (user_type, user_status, user_group, username, user_password, user_password_encoding, user_email, user_reg_date, user_ip, user_agent, user_colour, user_allow_viewonline, user_allow_viewemail, user_allow_massemail, user_allow_pm, user_allow_email, user_data, user_new_privmsg, user_unread_privmsg, user_posts) VALUES (2, 2, 5, 'Jetbot', '', '', '', $time, '64.71.144.', 'Jetbot/', '9E8DA7', 1, 0, 0, 0, 0, '$bot_data', 0, 0, 0)");
 
 // Forums
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_list', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_read', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_post', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_reply', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_quote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_user_lock', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bump', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_poll', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_vote', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_votechg', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_announce', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sticky', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_bbcode', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_flash', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_sigs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_rate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_postcount', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_moderate', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local) VALUES ('f_subscribe', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_announce', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_bbcode', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_bump', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_ignoreflood', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_list', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_noapprove', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_print', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_poll', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_post', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_postcount', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_read', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_reply', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_report', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_sigs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_sticky', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_subscribe', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_user_lock', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_vote', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local) VALUES ('f_votechg', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_unrate', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_auth', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_ip', 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_approve', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_chgposter', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_delete', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_edit', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_info', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_lock', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_merge', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_move', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_report', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_split', 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_local, is_global) VALUES ('m_warn', 1, 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_readpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sendim', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_hideonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewonline', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_viewprofile', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgavatar', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chggrp', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgemail', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgname', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_chgcensors', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_savedrafts', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_sig', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_sendemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_readpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_sendpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_sendim', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_hideonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_viewonline', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_viewprofile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chgavatar', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chggrp', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chgemail', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chgname', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chgpasswd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_chgcensors', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_savedrafts', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_sig', 1)");
 
 // START: This should be replaced by beta
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_server', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_defaults', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_board', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cookies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_clearlogs', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_words', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_icons', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_email', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_styles', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_user', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_useradd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_userdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ranks', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_ban', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_names', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_group', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_groupdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forum', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumadd', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_forumdel', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_prune', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_auth', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authmods', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authadmins', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authusers', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authgroups', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_authdeps', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_backup', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_restore', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_search', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_events', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('a_cron', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_aauth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_backup', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_bbcode', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_board', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_clearlogs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_email', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_fauth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_forum', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_forumadd', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_forumdel', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_icons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_mauth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_modules', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_names', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_profile', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_prune', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_ranks', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_reasons', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_roles', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_search', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_server', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_switchperm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_uauth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_user', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_viewauth', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_viewlogs', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('a_words', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_attach', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_html', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_bbsmiley_code', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_download', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_report', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_edit', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_forward', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_delete', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_img', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth_options (auth_option, is_global) VALUES ('u_pm_flash', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_attach', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_bbcode', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_smilies', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_download', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_edit', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_printpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_emailpm', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_forward', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_delete', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_img', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_OPTIONS_TABLE  ." (auth_option, is_global) VALUES ('u_pm_flash', 1)");
 
-// ADMINISTRATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%'");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 4, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'a_%'");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Standard Admin', 'ROLE_DESCRIPTION_ADMIN_STANDARD', 'a_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Forum Admin', 'ROLE_DESCRIPTION_ADMIN_FORUM', 'a_', 3)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('User and Groups Admin', 'ROLE_DESCRIPTION_ADMIN_USERGROUP', 'a_', 4)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Full Admin', 'ROLE_DESCRIPTION_ADMIN_FULL', 'a_', 2)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('All Features', 'ROLE_DESCRIPTION_USER_FULL', 'u_', 3)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Standard Features', 'ROLE_DESCRIPTION_USER_STANDARD', 'u_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Limited Features', 'ROLE_DESCRIPTION_USER_LIMITED', 'u_', 2)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('No Private Messages', 'ROLE_DESCRIPTION_USER_NOPM', 'u_', 4)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('No Avatar', 'ROLE_DESCRIPTION_USER_NOAVATAR', 'u_', 5)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Full Moderator', 'ROLE_DESCRIPTION_MOD_FULL', 'm_', 3)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Standard Moderator', 'ROLE_DESCRIPTION_MOD_STANDARD', 'm_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Simple Moderator', 'ROLE_DESCRIPTION_MOD_SIMPLE', 'm_', 2)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Queue Moderator', 'ROLE_DESCRIPTION_MOD_QUEUE', 'm_', 4)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Full Access', 'ROLE_DESCRIPTION_FORUM_FULL', 'f_', 6)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Standard Access', 'ROLE_DESCRIPTION_FORUM_STANDARD', 'f_', 4)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('No Access', 'ROLE_DESCRIPTION_FORUM_NOACCESS', 'f_', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Read Only Access', 'ROLE_DESCRIPTION_FORUM_READONLY', 'f_', 2)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Limited Access', 'ROLE_DESCRIPTION_FORUM_LIMITED', 'f_', 3)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Bot Access', 'ROLE_DESCRIPTION_FORUM_BOT', 'f_', 8)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('On Moderation Queue', 'ROLE_DESCRIPTION_FORUM_ONQUEUE', 'f_', 7)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_TABLE . " (role_name, role_description, role_type, role_order) VALUES ('Standard Access + Polls', 'ROLE_DESCRIPTION_FORUM_POLLS', 'f_', 5)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");// maybe keep
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
+
+//$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
+//$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
+//$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
 
-// SUPER MODERATOR group
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth (group_id, forum_id, auth_option_id, auth_setting) SELECT 6, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'm_%'");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_start_date', $time, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('record_online_users', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('record_online_date', '0', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_CONFIG_TABLE  ." (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
 
-# REGISTERED/REGISTERED COPPA groups - common forum rights
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 2, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chggrp', 'u_viewonline', 'u_chgname')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_auth  (group_id, forum_id, auth_option_id, auth_setting) SELECT 3, 0, auth_option_id, 1 FROM ".$table_prefix."forums_auth_options WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_chgcensors', 'u_chggrp', 'u_viewonline', 'u_chgname')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Plain Text', 0, 0, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Documents', 0, 0, 1, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Real Media', 3, 0, 2, '', 0, '')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSION_GROUPS_TABLE  ." (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Windows Media', 2, 0, 1, '', 0, '')");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'gif')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'png')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'jpeg')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'jpg')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'tif')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (1, 'tga')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'gtar')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'gz')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'tar')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'zip')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'rar')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (2, 'ace')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'txt')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'c')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'h')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'cpp')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'hpp')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (3, 'diz')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'xls')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'doc')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'dot')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'pdf')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'ai')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'ps')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (4, 'ppt')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (5, 'rm')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (6, 'wma')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_EXTENSIONS_TABLE  ." (group_id, extension) VALUES (6, 'wmv')");
+
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/arrow_bold_rgt.gif', 19, 19, 1, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/redface_anim.gif', 19, 19, 9, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/mr_green.gif', 19, 19, 10, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/musical.gif', 19, 19, 4, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/asterix.gif', 19, 19, 2, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/square.gif', 19, 19, 3, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/alien_grn.gif', 19, 19, 5, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/idea.gif', 19, 19, 8, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/question.gif', 19, 19, 6, 1)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ICONS_TABLE  ." (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/exclaim.gif', 19, 19, 7, 1)");
+
+# -- Roles data
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_attachments', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bbcode', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_html_tags', 'b,i,u,pre', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_topic_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_forum_notify', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_local', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_remote', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_avatar_upload', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_nocensors', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_bookmarks', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_disable_msg', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_form', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_login_attempts', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_ratings', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('posts_per_page', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('topics_per_page', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('hot_threshold', '25', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_path', 'images/avatars/upload', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_gallery_path', 'images/avatars/gallery', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('smilies_path', 'images/smilies', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('icons_path', 'images/icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_icons_path', 'images/upload_icons', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('ranks_path', 'images/ranks', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('email_enable', '1', 0)");// maybe keep
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_privmsg', '1', 0)");
+# Standard Admin (a_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 1, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'a_%' AND auth_option NOT IN ('a_switchperm', 'a_jabber', 'a_phpinfo', 'a_server', 'a_backup', 'a_styles', 'a_clearlogs', 'a_modules', 'a_language', 'a_email', 'a_bots', 'a_search', 'a_aauth', 'a_roles')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_time', '5', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_birthdays', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_moderators', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_jumpbox', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_upd', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_search_phr', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_db_lastread', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_onlinetrack', '1', 0)");
+# Forum admin (a_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 2, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'a_%' AND auth_option IN ('a_', 'a_authgroups', 'a_authusers', 'a_fauth', 'a_forum', 'a_forumadd', 'a_forumdel', 'a_mauth', 'a_prune', 'a_uauth', 'a_viewauth', 'a_viewlogs')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_gc', '7200', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('queue_interval', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('version', '2.1.2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_chars', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_smilies', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_quote_depth', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_sig_chars', '255', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_poll_options', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('min_search_chars', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_search_chars', '10', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('edit_time', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_last_edited', '1', 0)");
+# User and Groups Admin (a_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 3, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'a_%' AND auth_option IN ('a_', 'a_authgroups', 'a_authusers', 'a_ban', 'a_group', 'a_groupadd', 'a_groupdel', 'a_ranks', 'a_uauth', 'a_user', 'a_viewauth', 'a_viewlogs')");
 
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email_sig', 'Thanks, The Management', 0)");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_email', '', 0)");
-//$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_contact', '', 0)");
+# Full Admin (a_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 4, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'a_%'");
+
+# All Features (u_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 5, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%'");
+
+# Standard Features (u_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 6, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_viewonline', 'u_chggrp', 'u_chgname', 'u_ignoreflood', 'u_pm_flash', 'u_pm_forward')");
+
+# Limited Features (u_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 7, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_attach', 'u_viewonline', 'u_chggrp', 'u_chgname', 'u_ignoreflood', 'u_pm_attach', 'u_pm_emailpm', 'u_pm_flash', 'u_savedrafts', 'u_search', 'u_sendemail', 'u_sendim')");
+
+# No Private Messages (u_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 8, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option IN ('u_', 'u_chgavatar', 'u_chgcensors', 'u_chgemail', 'u_chgpasswd', 'u_download', 'u_hideonline', 'u_sig', 'u_viewprofile')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 8, auth_option_id, 0 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option IN ('u_readpm', 'u_sendpm', 'u_masspm')");
+
+# No Avatar (u_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 9, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option NOT IN ('u_attach', 'u_chgavatar', 'u_viewonline', 'u_chggrp', 'u_chgname', 'u_ignoreflood', 'u_pm_attach', 'u_pm_emailpm', 'u_pm_flash', 'u_savedrafts', 'u_search', 'u_sendemail', 'u_sendim')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 9, auth_option_id, 0 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'u_%' AND auth_option IN ('u_chgavatar')");
+
+# Full Moderator (m_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 10, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'm_%'");
+
+# Standard Moderator (m_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 11, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'm_%' AND auth_option NOT IN ('m_approve', 'm_ban', 'm_chgposter', 'm_delete')");
+
+# Simple Moderator (m_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 12, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'm_%' AND auth_option IN ('m_', 'm_approve', 'm_delete', 'm_edit', 'm_info', 'm_report', 'm_warn')");
+
+# Queue Moderator (m_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 13, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'm_%' AND auth_option IN ('m_', 'm_approve', 'm_edit')");
+
+# Full Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 14, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%'");
+
+# Standard Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 15, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option NOT IN ('f_announce', 'f_delete', 'f_ignoreflood', 'f_poll', 'f_sticky', 'f_user_lock')");
+
+# No Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 16, auth_option_id, 0 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option = 'f_'");
+
+# Read Only Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 17, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option IN ('f_', 'f_download', 'f_list', 'f_read', 'f_search', 'f_subscribe')");
+
+# Limited Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 18, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option NOT IN ('f_announce', 'f_attach', 'f_bump', 'f_delete', 'f_flash', 'f_icons', 'f_ignoreflood', 'f_poll', 'f_sticky', 'f_user_lock', 'f_votechg')");
+
+# Bot Access (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 19, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option IN ('f_', 'f_download', 'f_list', 'f_read')");
+
+# On Moderation Queue (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 20, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option NOT IN ('f_announce', 'f_bump', 'f_delete', 'f_flash', 'f_icons', 'f_ignoreflood', 'f_poll', 'f_sticky', 'f_user_lock', 'f_votechg', 'f_noapprove')");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 20, auth_option_id, 0 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option IN ('f_noapprove')");
+
+# Standard Access + Polls (f_)
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_ROLES_DATA_TABLE  ." (role_id, auth_option_id, auth_setting) SELECT 21, auth_option_id, 1 FROM  ". FORUMS_ACL_OPTIONS_TABLE  ."  WHERE auth_option LIKE 'f_%' AND auth_option NOT IN ('f_announce', 'f_delete', 'f_ignoreflood', 'f_sticky', 'f_user_lock')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_start_date', $time, 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('flood_interval', '15', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_interval', '10h', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_interval', '', 0)");
+# -- Forums
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_FORUMS_TABLE ." (forum_name, forum_desc, forum_status, left_id, right_id, parent_id, forum_type, forum_posts, forum_topics, forum_topics_real, forum_last_post_id, forum_last_poster_id, forum_last_poster_name, forum_last_post_time, forum_link, forum_password, forum_image, forum_rules, forum_rules_link, forum_rules_uid, forum_desc_uid, enable_icons) VALUES ('My first Category', '', ".ITEM_UNLOCKED.",1, 4, 0, 0, 1, 1, 1, 1, 2, 'Admin', 972086460, '', '', '', '', '', '', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_filesize', '6144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_width', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_min_height', '20', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_width', '90', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('avatar_max_height', '90', 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_FORUMS_TABLE ." (forum_name, forum_desc, forum_status, left_id, right_id, parent_id, forum_type, forum_posts, forum_topics, forum_topics_real, forum_last_post_id, forum_last_poster_id, forum_last_poster_name, forum_last_post_time, forum_link, forum_password, forum_image, forum_rules, forum_rules_link, forum_rules_uid, forum_desc_uid, enable_icons) VALUES ('Test Forum 1', 'This is just a test forum.', ".ITEM_UNLOCKED.", 2, 3, 1, 1, 1, 1, 1, 1, 2, 'Admin', 972086460, '', '', '', '', '', '', '', 1)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('lastread', '432000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('display_order', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_filesize_pm', '262144', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('attachment_quota', '52428800', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments', '3', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_attachments_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_pm_attach', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_path', 'files', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_display_inlined', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_downloads', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_deny', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('secure_allow_empty_referer', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_max_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_width', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_link_height', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_create_thumbnail', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_min_thumb_filesize', '12000', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('img_imagick', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_boxes', '4', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_max_msgs', '50', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_html_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_bbsmiley_code_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_smilies_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_download_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_report_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('load_online_guests', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_img_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('auth_flash_pm', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('enable_pm_icons', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('pm_edit_time', '', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_mass_pm', '1', 0)");
+# Permissions
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_users', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('record_online_date', '0', 1)");
+# Admin user - full user features
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (user_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (2, 0, 0, 5, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_posts', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_topics', '0', 1)");
+# ADMINISTRATOR Group - full user features
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (4, 0, 0, 5, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('num_files', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('upload_dir_size', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('search_last_gc', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('last_queue_run', '0', 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('full_folder_action', '2', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('bump_type', 'm', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('board_hide_emails', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_bbsmiley_code', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_flash', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_html', '0', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_img', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('allow_sig_smilies', '1', 0)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_config (config_name, config_value, is_dynamic) VALUES ('max_post_urls', '0', 0)");
+# ADMINISTRATOR Group - standard admin
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (4, 0, 0, 1, 0)");
+
+# REGISTERED and REGISTERED_COPPA having standard user features
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (2, 0, 0, 6, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (3, 0, 0, 6, 0)");
+
+# GLOBAL_MODERATORS having full user features
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (6, 0, 0, 5, 0)");
+
+# GLOBAL_MODERATORS having full global moderator access
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (6, 0, 0, 10, 0)");
+
+# Giving all groups read only access to the first category
+# since administrators and moderators are already within the registered users group we do not need to set them here
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (1, 1, 0, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (2, 1, 0, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (3, 1, 0, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (4, 1, 0, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (5, 1, 0, 17, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (6, 1, 0, 17, 0)");
+
+# Giving access to the first forum
+
+# guests having read only access
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (1, 2, 0, 17, 0)");
+
+# registered and registered_coppa having standard access
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (2, 2, 0, 15, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (3, 2, 0, 15, 0)");
+
+# global moderators having standard access + polls
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (6, 2, 0, 21, 0)");
+
+# administrators having full forum and full moderator access
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (4, 2, 0, 14, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (4, 2, 0, 10, 0)");
+
+# Bots having bot access
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_ACL_TABLE  ." (group_id, forum_id, auth_option_id, auth_role_id, auth_setting) VALUES (5, 2, 0, 19, 0)");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Images', 1, 1, 1, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Archives', 0, 1, 1, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Plain Text', 0, 0, 1, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Documents', 0, 0, 1, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Real Media', 3, 0, 2, '', 0, '')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extension_groups (group_name, cat_id, allow_group, download_mode, upload_icon, max_filesize, allowed_forums) VALUES ('Windows Media', 2, 0, 1, '', 0, '')");
+# -- Demo Topic
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_TOPICS_TABLE  ." (topic_title, topic_poster, icon_id, topic_approved, topic_time, topic_views, topic_replies, topic_replies_real, forum_id, topic_status, topic_type, topic_first_post_id, topic_first_poster_name, topic_last_post_id, topic_last_poster_id, topic_last_poster_name, topic_last_post_time, topic_last_view_time) VALUES ('Welcome to phpBB 3', 2, 0, 1, 972086460, 0, 0, 0, 2, 0, 0, 1, 'Admin', 1, 2, 'Admin', 972086460, 972086460)");
+
+# -- Demo Post
+$_CLASS['core_db']->query('INSERT INTO '. FORUMS_POSTS_TABLE  ." (topic_id, forum_id, poster_id, icon_id, post_approved, post_postcount, post_time, post_username, poster_ip, post_subject, post_text, post_checksum, bbcode_uid) VALUES (1, 2, 2, 1, 1, 1, 972086460, '', '', 'Welcome to phpBB 3', 'This is an example post in your phpBB 3.0 installation. You may delete this post, this topic and even this forum if you like since everything seems to be working!', '5dd683b17f641daf84c040bfefc58ce9', '')");
 
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'gif')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'png')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'jpeg')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'jpg')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'tif')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (1, 'tga')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'gtar')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'gz')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'tar')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'zip')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'rar')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (2, 'ace')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'txt')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'c')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'h')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'cpp')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'hpp')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (3, 'diz')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'xls')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'doc')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'dot')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'pdf')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ai')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ps')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (4, 'ppt')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (5, 'rm')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wma')");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_extensions (group_id, extension) VALUES (6, 'wmv')");
-
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/arrow_bold_rgt.gif', 19, 19, 1, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/redface_anim.gif', 19, 19, 9, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/mr_green.gif', 19, 19, 10, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/musical.gif', 19, 19, 4, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/asterix.gif', 19, 19, 2, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('misc/square.gif', 19, 19, 3, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/alien_grn.gif', 19, 19, 5, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/idea.gif', 19, 19, 8, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/question.gif', 19, 19, 6, 1)");
-$_CLASS['core_db']->query('INSERT INTO '.$table_prefix."forums_icons (icons_url, icons_width, icons_height, icons_order, display_on_posting) VALUES ('smilies/exclaim.gif', 19, 19, 7, 1)");
-
 ?>
\ No newline at end of file

Modified: cms/trunk/install/build_tables.php
===================================================================
--- cms/trunk/install/build_tables.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/install/build_tables.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -32,7 +32,7 @@
 	Admin Auth Table
 */
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'admin_access');
+$_CLASS['core_db']->table_create('start', CORE_ADMIN_AUTH_TABLE);
 
 $_CLASS['core_db']->add_table_field_char('admin_section', 100);
 
@@ -50,7 +50,7 @@
 /*
 	Blocks Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'blocks');
+$_CLASS['core_db']->table_create('start', CORE_BLOCKS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('block_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('block_title', 100);
@@ -76,7 +76,7 @@
 /*
 	Config Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'config');
+$_CLASS['core_db']->table_create('start', CORE_CONFIG_TABLE);
 
 $_CLASS['core_db']->add_table_field_char('config_section', 20);
 $_CLASS['core_db']->add_table_field_char('config_name', 20);
@@ -94,7 +94,7 @@
 	Groups Table
 */
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'groups');
+$_CLASS['core_db']->table_create('start', CORE_GROUPS_TABLE);
 
 // this section needs updating, with null fields
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
@@ -126,7 +126,7 @@
 /*
 	Groups Members Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'groups_members');
+$_CLASS['core_db']->table_create('start', CORE_GROUPS_MEMBERS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -141,7 +141,7 @@
 /*
 	Modules Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'admin_modules');
+$_CLASS['core_db']->table_create('start', CORE_ADMIN_MODULES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
@@ -157,7 +157,7 @@
 
 $_CLASS['core_db']->table_create('commit');
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'control_panel_modules');
+$_CLASS['core_db']->table_create('start', CORE_CONTROL_PANEL_MODULES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_name', 100);
@@ -174,7 +174,7 @@
 
 $_CLASS['core_db']->table_create('commit');
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'pages');
+$_CLASS['core_db']->table_create('start', CORE_PAGES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('page_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('page_name', 100);
@@ -194,7 +194,7 @@
 /*
 	Sessions Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'sessions');
+$_CLASS['core_db']->table_create('start', CORE_SESSIONS_TABLE);
 
 $_CLASS['core_db']->add_table_field_char('session_id', 40);
 $_CLASS['core_db']->add_table_field_int('session_user_id', array('max' => 16000000));
@@ -222,7 +222,7 @@
 /*
 	Sessions Auto login Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'sessions_auto_login');
+$_CLASS['core_db']->table_create('start', CORE_SESSIONS_AUTOLOGIN_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('auto_login_browser', 255);
@@ -236,7 +236,7 @@
 /*
 	Smiles Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'smilies');
+$_CLASS['core_db']->table_create('start', CORE_SMILIES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('smiley_id', array('max' => 16000000, 'auto_increment' => true));
 
@@ -259,7 +259,7 @@
 `user_unread_privmsg` tinyint(4) unsigned NOT NULL default '0',
 */
 
-$_CLASS['core_db']->table_create('start', $user_prefix.'users');
+$_CLASS['core_db']->table_create('start', CORE_USERS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('username', 80);
@@ -303,7 +303,7 @@
 $_CLASS['core_db']->add_table_field_char('user_msnm', 255, true);
 $_CLASS['core_db']->add_table_field_char('user_jabber', 255, true);
 $_CLASS['core_db']->add_table_field_char('user_website', 255, true);
-$_CLASS['core_db']->add_table_field_char('user_interests', 255, true);
+$_CLASS['core_db']->add_table_field_text('user_interests', 8000, true);
 $_CLASS['core_db']->add_table_field_char('user_occ', 255, true);
 
 // look at these
@@ -357,7 +357,7 @@
 /*
 	Attachments Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_attachments');
+$_CLASS['core_db']->table_create('start', FORUMS_ATTACHMENTS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('attach_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('post_msg_id', array('max' => 16000000));
@@ -379,17 +379,20 @@
 $_CLASS['core_db']->add_table_index('post_msg_id');
 $_CLASS['core_db']->add_table_index('topic_id');
 $_CLASS['core_db']->add_table_index('poster_id');
+$_CLASS['core_db']->add_table_index('filetime');
+$_CLASS['core_db']->add_table_index('filesize');
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
 	Forums Auth Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth');
+$_CLASS['core_db']->table_create('start', FORUMS_ACL_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('auth_role_id', array('max' => 16000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_int('auth_setting', array('max' => 1));
 
@@ -402,7 +405,7 @@
 /*
 	Forums Auth Options Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_options');
+$_CLASS['core_db']->table_create('start', FORUMS_ACL_OPTIONS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('auth_option', 20);
@@ -418,7 +421,7 @@
 /*
 	Forums Auth Presets Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_auth_presets');
+$_CLASS['core_db']->table_create('start', FORUMS_ACL_PRESETS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('preset_id', array('max' => 16000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('preset_user_id', array('max' => 16000000));
@@ -433,25 +436,55 @@
 $_CLASS['core_db']->table_create('commit');
 
 /*
+	Forums Auth Roles Table
+*/
+$_CLASS['core_db']->table_create('start', FORUMS_ACL_ROLES_TABLE);
+
+$_CLASS['core_db']->add_table_field_int('role_id', array('max' => 16000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_char('role_name', 255);
+$_CLASS['core_db']->add_table_field_text('role_description', 8000);
+$_CLASS['core_db']->add_table_field_char('role_type', 10);
+$_CLASS['core_db']->add_table_field_int('role_order', array('max' => 1600));
+
+$_CLASS['core_db']->add_table_index('role_id', 'primary');
+$_CLASS['core_db']->add_table_index('role_type');
+$_CLASS['core_db']->add_table_index('role_order');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
+	Forums Auth Roles Table
+*/
+$_CLASS['core_db']->table_create('start', FORUMS_ACL_ROLES_DATA_TABLE);
+
+$_CLASS['core_db']->add_table_field_int('role_id', array('max' => 16000, 'auto_increment' => true));
+$_CLASS['core_db']->add_table_field_int('auth_option_id', array('max' => 2000));
+$_CLASS['core_db']->add_table_field_int('auth_setting', array('max' => 1));
+
+$_CLASS['core_db']->add_table_index(array('role_id', 'auth_option_id'), 'primary');
+
+$_CLASS['core_db']->table_create('commit');
+
+/*
 	Forums Bookmarks Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_bookmarks');
+$_CLASS['core_db']->table_create('start', FORUMS_BOOKMARKS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('order_id', array('max' => 16000000));
 
-$_CLASS['core_db']->add_table_index('topic_id');
-$_CLASS['core_db']->add_table_index('user_id');
+$_CLASS['core_db']->add_table_index('order_id');
+$_CLASS['core_db']->add_table_index(array('topic_id', 'user_id'));
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
 	Forums Config Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_config');
+$_CLASS['core_db']->table_create('start', FORUMS_CONFIG_TABLE);
 
-$_CLASS['core_db']->add_table_field_char('config_name', 100);
+$_CLASS['core_db']->add_table_field_char('config_name', 255);
 $_CLASS['core_db']->add_table_field_char('config_value', 255);
 $_CLASS['core_db']->add_table_field_int('is_dynamic', array('max' => 1));
 
@@ -477,7 +510,7 @@
 /*
 	Forums Drafts Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_drafts');
+$_CLASS['core_db']->table_create('start', FORUMS_DRAFTS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('draft_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -485,10 +518,11 @@
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 field_unix_time('save_time');
 $_CLASS['core_db']->add_table_field_char('draft_subject', 50);
-$_CLASS['core_db']->add_table_field_text('draft_message',  16000000);
+$_CLASS['core_db']->add_table_field_text('draft_message',  10000000);
 
 $_CLASS['core_db']->add_table_index('draft_id', 'primary');
 $_CLASS['core_db']->add_table_index('user_id');
+$_CLASS['core_db']->add_table_index('topic_id');
 $_CLASS['core_db']->add_table_index('save_time');
 
 $_CLASS['core_db']->table_create('commit');
@@ -496,7 +530,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extensions');
+$_CLASS['core_db']->table_create('start', FORUMS_EXTENSIONS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('extension_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000));
@@ -509,7 +543,7 @@
 /*
 	Forums Extension Groups Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_extension_groups');
+$_CLASS['core_db']->table_create('start', FORUMS_EXTENSION_GROUPS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('group_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('group_name', 20);
@@ -528,7 +562,7 @@
 /*
 	Forums Forums Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_forums');
+$_CLASS['core_db']->table_create('start', FORUMS_FORUMS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('parent_id', array('max' => 16000));
@@ -537,15 +571,19 @@
 $_CLASS['core_db']->add_table_field_text('forum_parents', 20000);
 $_CLASS['core_db']->add_table_field_char('forum_name', 150);
 $_CLASS['core_db']->add_table_field_text('forum_desc', 20000);
-$_CLASS['core_db']->add_table_field_text('forum_rules', 20000, true);
-$_CLASS['core_db']->add_table_field_char('forum_rules_link', 200, true);
-$_CLASS['core_db']->add_table_field_char('forum_rules_flags', 50, true);
-$_CLASS['core_db']->add_table_field_int('forum_rules_bbcode_bitfield', array('max' => 16000000, 'null' => true));
-$_CLASS['core_db']->add_table_field_char('forum_rules_bbcode_uid', 5, true);
-$_CLASS['core_db']->add_table_field_char('forum_link', 200, true);
+$_CLASS['core_db']->add_table_field_char('forum_desc_bitfield', 255, true);
+$_CLASS['core_db']->add_table_field_int('forum_desc_options', array('max' => 16000, 'null' => true));
+$_CLASS['core_db']->add_table_field_char('forum_desc_uid', 5, true);
+$_CLASS['core_db']->add_table_field_char('forum_link', 255, true);
 $_CLASS['core_db']->add_table_field_char('forum_password', 40, true);
 $_CLASS['core_db']->add_table_field_char('forum_password_encoding', 10, true);
 $_CLASS['core_db']->add_table_field_char('forum_image', 200, true);
+$_CLASS['core_db']->add_table_field_text('forum_rules', 20000, true);
+$_CLASS['core_db']->add_table_field_char('forum_rules_link', 255, true);
+$_CLASS['core_db']->add_table_field_char('forum_rules_bitfield', 255, true);
+$_CLASS['core_db']->add_table_field_char('forum_rules_uid', 5, true);
+$_CLASS['core_db']->add_table_field_int('forum_rules_options', array('max' => 16000, 'null' => true));
+
 $_CLASS['core_db']->add_table_field_int('forum_topics_per_page', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('forum_type', array('max' => 10));
 $_CLASS['core_db']->add_table_field_int('forum_status', array('max' => 10));
@@ -556,64 +594,65 @@
 $_CLASS['core_db']->add_table_field_int('forum_last_poster_id', array('max' => 16000000, 'null' => true));
 field_unix_time('forum_last_post_time', true);
 $_CLASS['core_db']->add_table_field_char('forum_last_poster_name', 50, true);
-$_CLASS['core_db']->add_table_field_int('forum_flags', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('enable_indexing', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('enable_icons', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('forum_flags', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('display_on_index', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_indexing', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_icons', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_prune', array('max' => 10, 'null' => true));
 field_unix_time('prune_next', true);
+$_CLASS['core_db']->add_table_field_int('prune_days', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('prune_viewed', array('max' => 200, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('prune_freq', array('max' => 200, 'null' => true));
 
-//////
-
-$_CLASS['core_db']->add_table_field_int('enable_prune', array('max' => 10));
-$_CLASS['core_db']->add_table_field_int('prune_days', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('prune_viewed', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('prune_freq', array('max' => 200));
-//////
-
 $_CLASS['core_db']->add_table_index('forum_id', 'primary');
-$_CLASS['core_db']->add_table_index('left_id');
-$_CLASS['core_db']->add_table_index('right_id');
+$_CLASS['core_db']->add_table_index(array('left_id', 'right_id'));
+$_CLASS['core_db']->add_table_index('forum_last_post_id');
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
 	Forums POsts Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_posts');
+$_CLASS['core_db']->table_create('start', FORUMS_POSTS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000));
-$_CLASS['core_db']->add_table_field_int('right_id', array('max' => 16000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
 $_CLASS['core_db']->add_table_field_int('poster_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_char('poster_ip', 20);
 field_unix_time('post_time');
-$_CLASS['core_db']->add_table_field_char('poster_ip', 20);
+$_CLASS['core_db']->add_table_field_int('post_approved', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('post_reported', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_bbcode', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('post_attachment', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('post_username', 50);
-$_CLASS['core_db']->add_table_field_int('enable_bbcode', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1));
-field_unix_time('post_edit_time', true);
-$_CLASS['core_db']->add_table_field_int('post_edit_count', array('max' => 20000, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('post_attachment', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('post_subject', 50);
 $_CLASS['core_db']->add_table_field_text('post_text', 10000000);
-$_CLASS['core_db']->add_table_field_char('bbcode_uid', 10);
-$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
-$_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('post_approved', array('max' => 1));
-$_CLASS['core_db']->add_table_field_char('post_edit_reason', 255, true);
+$_CLASS['core_db']->add_table_field_char('post_checksum', 32);
+
+$_CLASS['core_db']->add_table_field_char('bbcode_bitfield', 255, true);
+$_CLASS['core_db']->add_table_field_char('bbcode_uid', 5, true);
+$_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1, 'null' => true));
+
+$_CLASS['core_db']->add_table_field_int('post_postcount', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_text('post_edit_reason', 3000, true);
+field_unix_time('post_edit_time', true);
 $_CLASS['core_db']->add_table_field_int('post_edit_user', array('max' => 16000000, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('post_edit_count', array('max' => 20000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('post_edit_locked', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('post_reported', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_char('post_checksum', 32);
 
 $_CLASS['core_db']->add_table_index('post_id', 'primary');
 $_CLASS['core_db']->add_table_index('forum_id');
 $_CLASS['core_db']->add_table_index('topic_id');
 $_CLASS['core_db']->add_table_index('poster_id');
+$_CLASS['core_db']->add_table_index('poster_ip');
 $_CLASS['core_db']->add_table_index('post_approved');
+$_CLASS['core_db']->add_table_index('post_postcount');
 $_CLASS['core_db']->add_table_index('post_time');
 
 $_CLASS['core_db']->table_create('commit');
@@ -621,40 +660,35 @@
 /*
 	Forums Topics Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_topics');
+$_CLASS['core_db']->table_create('start', FORUMS_TOPICS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
+$_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1, 'null' => true)); 
+
 $_CLASS['core_db']->add_table_field_char('topic_title', 50);
 $_CLASS['core_db']->add_table_field_int('topic_poster', array('max' => 16000000));
 field_unix_time('topic_time');
+field_unix_time('topic_time_limit', true);
 $_CLASS['core_db']->add_table_field_int('topic_views', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000));  
+$_CLASS['core_db']->add_table_field_int('topic_replies', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('topic_status', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('topic_type', array('max' => 1));
-
-// we should set this on topic creation
-$_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_first_post_id', array('max' => 16000000, 'null' => true));
-
-$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200));
-
-$_CLASS['core_db']->add_table_field_int('topic_attachment', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('topic_approved', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('topic_reported', array('max' => 1, 'null' => true)); 
-field_unix_time('topic_time_limit', true);
-$_CLASS['core_db']->add_table_field_int('topic_replies_real', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('topic_first_poster_name', 50);
+$_CLASS['core_db']->add_table_field_int('topic_last_post_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_last_poster_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('topic_last_poster_name', 50, true);
 field_unix_time('topic_last_post_time', true);
 field_unix_time('topic_last_view_time', true);
-
+$_CLASS['core_db']->add_table_field_int('topic_moved_id', array('max' => 16000000, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_bumped', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('topic_bumper', array('max' => 16000000, 'null' => true));
-  
-$_CLASS['core_db']->add_table_field_char('poll_title', 100, true);
+$_CLASS['core_db']->add_table_field_text('poll_title', 1000, true);
 field_unix_time('poll_start', true);
 field_unix_time('poll_length', true); 
 $_CLASS['core_db']->add_table_field_int('poll_max_options', array('max' => 200, 'null' => true));
@@ -663,6 +697,7 @@
 
 $_CLASS['core_db']->add_table_index('topic_id', 'primary');
 $_CLASS['core_db']->add_table_index('forum_id');
+$_CLASS['core_db']->add_table_index('topic_type');
 $_CLASS['core_db']->add_table_index('topic_moved_id');
 $_CLASS['core_db']->add_table_index('topic_status');
 $_CLASS['core_db']->add_table_index('topic_type');
@@ -672,7 +707,7 @@
 /*
 	Forums Extensions Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_tracking');
+$_CLASS['core_db']->table_create('start', FORUMS_TRACK_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
@@ -688,7 +723,7 @@
 /*
 	Forums Icons Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_icons');
+$_CLASS['core_db']->table_create('start', FORUMS_ICONS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('icons_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('icons_url', 50);
@@ -698,6 +733,7 @@
 $_CLASS['core_db']->add_table_field_int('display_on_posting', array('max' => 1));
 
 $_CLASS['core_db']->add_table_index('icons_id', 'primary');
+$_CLASS['core_db']->add_table_index('display_on_posting');
 
 $_CLASS['core_db']->table_create('commit');
 
@@ -705,7 +741,7 @@
 	Forums Forums Watch Table
 */
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_watch');
+$_CLASS['core_db']->table_create('start', FORUMS_WATCH_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
@@ -722,7 +758,7 @@
 /*
 	Forums Modules Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_modules');
+$_CLASS['core_db']->table_create('start', FORUMS_MODULES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('module_id', array('max' => 2000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('module_type', 3);
@@ -742,7 +778,7 @@
 /*
 	Forums Moderator Cache Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_moderator_cache');
+$_CLASS['core_db']->table_create('start', FORUMS_MODERATOR_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('forum_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000, 'null' => true));
@@ -756,16 +792,14 @@
 
 $_CLASS['core_db']->table_create('commit');
 
-// Look into Forum polls by alpha 3 //
-
 /*
 	Forums Poll Results Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_results');
+$_CLASS['core_db']->table_create('start', FORUMS_POLL_OPTIONS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('poll_option_text', 255);
+$_CLASS['core_db']->add_table_field_text('poll_option_text', 8000);
 $_CLASS['core_db']->add_table_field_int('poll_option_total', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('poll_option_id');
@@ -776,7 +810,7 @@
 /*
 	Forums Poll Voters Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_poll_voters');
+$_CLASS['core_db']->table_create('start', FORUMS_POLL_VOTES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('topic_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('poll_option_id', array('max' => 2000));
@@ -789,26 +823,26 @@
 
 $_CLASS['core_db']->table_create('commit');
 
-// Look into Forum polls by alpha 3 //
-
 /*
-	Forums Poll Voters Table
+	Forums Ranks Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_ranks');
+$_CLASS['core_db']->table_create('start', FORUMS_RANKS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('rank_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('rank_title', 50);
 $_CLASS['core_db']->add_table_field_int('rank_min', array('min' => -1, 'max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('rank_special', array('max' => 1));
-$_CLASS['core_db']->add_table_field_char('rank_image', 100);
+$_CLASS['core_db']->add_table_field_char('rank_image', 255);
 
 $_CLASS['core_db']->add_table_index('rank_id', 'primary');
 
 $_CLASS['core_db']->table_create('commit');
 
+
 /*
 	Forums Words Table
 */
+/*
 $_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordlist');
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 3000000000, 'auto_increment' => true));
@@ -819,10 +853,11 @@
 $_CLASS['core_db']->add_table_index('word_text');
 
 $_CLASS['core_db']->table_create('commit');
-
+*/
 /*
 	Forums search_wordmatch Table
 */
+/*
 $_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_wordmatch');
 
 $_CLASS['core_db']->add_table_field_int('post_id', array('max' => 16000000));
@@ -832,11 +867,11 @@
 $_CLASS['core_db']->add_table_index('word_id');
 
 $_CLASS['core_db']->table_create('commit');
-
+*/
 /*
 	Forums Words Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'censor');
+$_CLASS['core_db']->table_create('start', CORE_CENSOR_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('word_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('word_match', 100);
@@ -849,7 +884,7 @@
 /*
 	Forums Zebra Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_zebra');
+$_CLASS['core_db']->table_create('start', ZEBRA_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('zebra_id', array('max' => 16000000));
@@ -866,7 +901,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_log');
+$_CLASS['core_db']->table_create('start', FORUMS_LOG_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('log_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('log_type', array('max' => 200));
@@ -890,7 +925,7 @@
 
 /*
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs');
+$_CLASS['core_db']->table_create('start', FORUMS_PRIVMSGS_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('root_level', array('max' => 16000000));
@@ -898,25 +933,23 @@
 $_CLASS['core_db']->add_table_field_int('icon_id', array('max' => 200, 'null' => true));
 $_CLASS['core_db']->add_table_field_char('author_ip', 40);
 field_unix_time('message_time');
-$_CLASS['core_db']->add_table_field_int('message_reported', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('enable_bbcode', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_html', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_smilies', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_magic_url', array('max' => 1));
 $_CLASS['core_db']->add_table_field_int('enable_sig', array('max' => 1));
 
-$_CLASS['core_db']->add_table_field_char('message_subject', 60);
+$_CLASS['core_db']->add_table_field_char('message_subject', 255);
 $_CLASS['core_db']->add_table_field_text('message_text', 10000000);
-$_CLASS['core_db']->add_table_field_char('message_edit_reason', 100, true);
+$_CLASS['core_db']->add_table_field_text('message_edit_reason', 3000, true);
 $_CLASS['core_db']->add_table_field_int('message_edit_user', array('max' => 16000000, 'null' => true));
-$_CLASS['core_db']->add_table_field_char('message_checksum', 11);
 $_CLASS['core_db']->add_table_field_int('message_attachment', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('bbcode_bitfield', array('max' => 16000000));
+$_CLASS['core_db']->add_table_field_char('bbcode_bitfield', 255);
 $_CLASS['core_db']->add_table_field_char('bbcode_uid', 5);
 field_unix_time('message_edit_time', true);
 $_CLASS['core_db']->add_table_field_int('message_edit_count', array('max' => 200, 'null' => true));
-$_CLASS['core_db']->add_table_field_text('to_address', 1000000);
-$_CLASS['core_db']->add_table_field_text('bcc_address', 1000000);
+$_CLASS['core_db']->add_table_field_text('to_address', 8000);
+$_CLASS['core_db']->add_table_field_text('bcc_address', 8000);
 
 $_CLASS['core_db']->add_table_index('msg_id', 'primary');
 $_CLASS['core_db']->add_table_index('author_ip');
@@ -929,11 +962,11 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_folder');
+$_CLASS['core_db']->table_create('start', FORUMS_PRIVMSGS_FOLDER_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('folder_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_char('folder_name', 40);
+$_CLASS['core_db']->add_table_field_char('folder_name', 255);
 $_CLASS['core_db']->add_table_field_int('pm_count', array('max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('folder_id', 'primary');
@@ -944,7 +977,7 @@
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_rules');
+$_CLASS['core_db']->table_create('start', FORUMS_PRIVMSGS_RULES_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('rule_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
@@ -957,33 +990,35 @@
 $_CLASS['core_db']->add_table_field_text('rule_folder_id', 16000000);
 
 $_CLASS['core_db']->add_table_index('rule_id', 'primary');
+$_CLASS['core_db']->add_table_index('user_id');
 
 $_CLASS['core_db']->table_create('commit');
 
 /*
 	Forums Log Table
 */
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_privmsgs_to');
+$_CLASS['core_db']->table_create('start', FORUMS_PRIVMSGS_TO_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('msg_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('user_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_int('author_id', array('max' => 16000000));
-$_CLASS['core_db']->add_table_field_int('deleted', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('msg_new', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('unread', array('max' => 1));
-$_CLASS['core_db']->add_table_field_int('replied', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('marked', array('max' => 1, 'null' => true));
-$_CLASS['core_db']->add_table_field_int('forwarded', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('pm_deleted', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('pm_new', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('pm_unread', array('max' => 1));
+$_CLASS['core_db']->add_table_field_int('pm_replied', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('pm_marked', array('max' => 1, 'null' => true));
+$_CLASS['core_db']->add_table_field_int('pm_forwarded', array('max' => 1, 'null' => true));
 $_CLASS['core_db']->add_table_field_int('folder_id', array('min' => -10, 'max' => 16000000));
 
 $_CLASS['core_db']->add_table_index('msg_id');
+$_CLASS['core_db']->add_table_index('author_id');
 $_CLASS['core_db']->add_table_index(array('user_id', 'folder_id'));
 
 $_CLASS['core_db']->table_create('commit');
 
 
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_sitelist');
+$_CLASS['core_db']->table_create('start', FORUMS_SITELIST_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('site_id', array('max' => 16000000, 'auto_increment' => true));
 $_CLASS['core_db']->add_table_field_char('site_ip', 40);
@@ -995,7 +1030,7 @@
 $_CLASS['core_db']->table_create('commit');
 
 
-$_CLASS['core_db']->table_create('start', $table_prefix.'forums_search_results');
+$_CLASS['core_db']->table_create('start', FORUMS_SEARCH_TABLE);
 
 $_CLASS['core_db']->add_table_field_int('search_id', array('max' => 16000000));
 $_CLASS['core_db']->add_table_field_char('session_id', 40);

Modified: cms/trunk/installer.php
===================================================================
--- cms/trunk/installer.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/installer.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -172,6 +172,7 @@
 		require_once SITE_FILE_ROOT.'includes/cache/cache_' . $acm_type . '.php';
 
 		load_class(false, 'core_cache', 'cache_'.$acm_type);
+		$_CLASS['core_cache']->destroy_all();
 
 		set_core_config('global', 'site_name', $site_name, false);
 		set_core_config('server', 'site_domain', $site_domain, false);

Modified: cms/trunk/javascript/editor.js
===================================================================
--- cms/trunk/javascript/editor.js	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/javascript/editor.js	2006-08-16 12:22:53 UTC (rev 184)
@@ -1,353 +1,509 @@
-// bbCode control by subBlue design [ www.subBlue.com ]
-// Includes unixsafe colour palette selector by SHS`
-
-// Startup variables
-var imageTag = false;
-var theSelection = false;
-
-// Check for Browser & Platform for PC & IE specific bits
-// More details from: http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html
-var clientPC = navigator.userAgent.toLowerCase(); // Get client info
-var clientVer = parseInt(navigator.appVersion); // Get browser version
-
-var is_ie = ((clientPC.indexOf("msie") != -1) && (clientPC.indexOf("opera") == -1));
-var is_nav = ((clientPC.indexOf('mozilla')!=-1) && (clientPC.indexOf('spoofer')==-1)
-                && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera')==-1)
-                && (clientPC.indexOf('webtv')==-1) && (clientPC.indexOf('hotjava')==-1));
-
-var is_win = ((clientPC.indexOf("win")!=-1) || (clientPC.indexOf("16bit") != -1));
-var is_mac = (clientPC.indexOf("mac")!=-1);
-
-// Shows the help messages in the helpline window
-function helpline(help) {
-	document.forms[form_name].helpbox.value = eval(help + "_help");
-}
-
-// Replacement for arrayname.length property
-function getarraysize(thearray) {
-	for (i = 0; i < thearray.length; i++) {
-		if ((thearray[i] == "undefined") || (thearray[i] == "") || (thearray[i] == null))
-			return i;
-		}
-	return thearray.length;
-}
-
-// Replacement for arrayname.push(value) not implemented in IE until version 5.5
-// Appends element to the array
-function arraypush(thearray,value) {
-	thearray[ getarraysize(thearray) ] = value;
-}
-
-// Replacement for arrayname.pop() not implemented in IE until version 5.5
-// Removes and returns the last element of an array
-function arraypop(thearray) {
-	thearraysize = getarraysize(thearray);
-	retval = thearray[thearraysize - 1];
-	delete thearray[thearraysize - 1];
-	return retval;
-}
-
-function smiley(text) {
-	text = ' ' + text + ' ';
-	if (document.forms[form_name].elements[text_name].createTextRange && document.forms[form_name].elements[text_name].caretPos) {
-		var caretPos = document.forms[form_name].elements[text_name].caretPos;
-
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-		document.forms[form_name].elements[text_name].focus();
-	} else {
-		var selStart = document.forms[form_name].elements[text_name].selectionStart;
-		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
-
-		mozWrap(document.forms[form_name].elements[text_name], text, '')
-		document.forms[form_name].elements[text_name].focus();
-		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
-		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
-	}
-}
-
-function bbfontstyle(bbopen, bbclose) {
-	if ((clientVer >= 4) && is_ie && is_win) {
-		theSelection = document.selection.createRange().text;
-		if (!theSelection) {
-			insert_text(bbopen + bbclose);
-			document.forms[form_name].elements[text_name].focus();
-			return;
-		}
-		document.selection.createRange().text = bbopen + theSelection + bbclose;
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	} else {
-		insert_text(bbopen + bbclose);
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-	storeCaret(document.forms[form_name].elements[text_name]);
-}
-
-function insert_text(text) {
-	if (document.forms[form_name].elements[text_name].createTextRange && document.forms[form_name].elements[text_name].caretPos) {
-		var caretPos = document.forms[form_name].elements[text_name].caretPos;
-		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
-	} else {
-		var selStart = document.forms[form_name].elements[text_name].selectionStart;
-		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
-
-		mozWrap(document.forms[form_name].elements[text_name], text, '')
-		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
-		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
-	}
-}
-
-function attach_inline() {
-	insert_text('[attachment=' + document.forms[form_name].elements['attachments'].value + ']' + document.forms[form_name].elements['attachments'].options[document.forms[form_name].elements['attachments'].selectedIndex].text + '[/attachment]');
-	document.forms[form_name].elements[text_name].focus();
-}
-
-function addquote(post_id, username)
-{
-	var message_name = 'message_' + post_id;
-	var theSelection = '';
-
-	var divarea = document.getElementById(message_name);
-
-	// Get text selection - not only the post content :(
-	if (window.getSelection)
-	{
-		theSelection = window.getSelection().toString();
-	}
-	else if (document.getSelection)
-	{
-		theSelection = document.getSelection();
-	}
-	else if (document.selection)
-	{
-		theSelection = document.selection.createRange().text;
-	}
-
-	if (!theSelection)
-	{
-		if (document.all)
-		{
-			theSelection = divarea.innerText;
-		}
-		else if (divarea.textContent)
-		{
-			theSelection = divarea.textContent;
-		}
-		else if (divarea.firstChild.nodeValue)
-		{
-			theSelection = divarea.firstChild.nodeValue;
-		}
-	}
-	
-	if (theSelection)
-	{
-		insert_text('[quote="' + username + '"]' + theSelection + '[/quote]');
-	}
-
-	return;
-}
-
-function bbstyle(bbnumber) {
-
-	donotinsert = false;
-	theSelection = false;
-	bblast = 0;
-	document.forms[form_name].elements[text_name].focus();
-
-	if (bbnumber == -1) { // Close all open tags & default button names
-		while (bbcode[0]) {
-			butnumber = arraypop(bbcode) - 1;
-			document.forms[form_name].elements[text_name].value += bbtags[butnumber + 1];
-			buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
-			if (buttext != "[*]")
-			{
-				eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
-			}
-		}
-		document.forms[form_name].addbbcode10.value = "List";
-		bbtags[10] = "[list]";
-		document.forms[form_name].addbbcode12.value = "List=";
-		bbtags[12] = "[list=]";
-		imageTag = false; // All tags are closed including image tags :D
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-
-	if ((clientVer >= 4) && is_ie && is_win)
-	{
-		theSelection = document.selection.createRange().text; // Get text selection
-		if (theSelection) {
-			// Add tags around selection
-			document.selection.createRange().text = bbtags[bbnumber] + theSelection + bbtags[bbnumber+1];
-			document.forms[form_name].elements[text_name].focus();
-			theSelection = '';
-			return;
-		}
-	}
-	else if (document.forms[form_name].elements[text_name].selectionEnd && (document.forms[form_name].elements[text_name].selectionEnd - document.forms[form_name].elements[text_name].selectionStart > 0))
-	{
-		mozWrap(document.forms[form_name].elements[text_name], bbtags[bbnumber], bbtags[bbnumber+1]);
-		document.forms[form_name].elements[text_name].focus();
-		theSelection = '';
-		return;
-	}
-
-	// Find last occurance of an open tag the same as the one just clicked
-	for (i = 0; i < bbcode.length; i++) {
-		if (bbcode[i] == bbnumber+1) {
-			bblast = i;
-			donotinsert = true;
-		}
-	}
-
-	if ((bbnumber == 10) && (bbtags[10] != "[*]"))
-	{
-		if (donotinsert)
-		{
-			document.forms[form_name].addbbcode12.value = "List=";
-			tmp_help = o_help;
-			o_help = e_help;
-			e_help = tmp_help;
-			bbtags[12] = "[list=]";
-		}
-		else
-		{
-			document.forms[form_name].addbbcode12.value = "[*]";
-			tmp_help = o_help;
-			o_help = e_help;
-			e_help = tmp_help;
-			bbtags[12] = "[*]";
-		}
-	}
-
-	if ((bbnumber == 12) && (bbtags[12] != "[*]"))
-	{
-		if (donotinsert)
-		{
-			document.forms[form_name].addbbcode10.value = "List";
-			tmp_help = l_help;
-			l_help = e_help;
-			e_help = tmp_help;
-			bbtags[10] = "[list]";
-		}
-		else
-		{
-			document.forms[form_name].addbbcode10.value = "[*]";
-			tmp_help = l_help;
-			l_help = e_help;
-			e_help = tmp_help;
-			bbtags[10] = "[*]";
-		}
-	}
-
-	if (donotinsert) {		// Close all open tags up to the one just clicked & default button names
-		while (bbcode[bblast]) {
-				butnumber = arraypop(bbcode) - 1;
-				if (bbtags[butnumber] != "[*]")
-				{
-					insert_text(bbtags[butnumber + 1]);
-				}
-				else
-				{
-					insert_text(bbtags[butnumber]);
-				}
-				buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
-				if (bbtags[butnumber] != "[*]")
-				{
-					eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
-				}
-				imageTag = false;
-			}
-			document.forms[form_name].elements[text_name].focus();
-			return;
-	} else { // Open tags
-
-		if (imageTag && (bbnumber != 14)) {		// Close image tag before adding another
-			insert_text(bbtags[15]);
-
-			lastValue = arraypop(bbcode) - 1;	// Remove the close image tag from the list
-			document.forms[form_name].addbbcode14.value = "Img";	// Return button back to normal state
-			imageTag = false;
-		}
-
-		// Open tag
-		insert_text(bbtags[bbnumber]);
-
-		if ((bbnumber == 14) && (imageTag == false)) imageTag = 1; // Check to stop additional tags after an unclosed image tag
-		if (bbtags[bbnumber] != "[*]")
-		{
-			arraypush(bbcode,bbnumber+1);
-			eval('document.forms[form_name].addbbcode'+bbnumber+'.value += "*"');
-		}
-		document.forms[form_name].elements[text_name].focus();
-		return;
-	}
-
-	storeCaret(document.forms[form_name].elements[text_name]);
-}
-
-// From http://www.massless.org/mozedit/
-function mozWrap(txtarea, open, close)
-{
-	var selLength = txtarea.textLength;
-	var selStart = txtarea.selectionStart;
-	var selEnd = txtarea.selectionEnd;
-	if (selEnd == 1 || selEnd == 2) 
-		selEnd = selLength;
-
-	var s1 = (txtarea.value).substring(0,selStart);
-	var s2 = (txtarea.value).substring(selStart, selEnd)
-	var s3 = (txtarea.value).substring(selEnd, selLength);
-	txtarea.value = s1 + open + s2 + close + s3;
-	return;
-}
-
-// Insert at Claret position. Code from
-// http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
-function storeCaret(textEl) {
-	if (textEl.createTextRange) { textEl.caretPos = document.selection.createRange().duplicate(); }
-}
-
-function colorPalette(dir, width, height)
-{
-	var r = 0, g = 0, b = 0;
-	var numberList = new Array(6);
-	numberList[0] = "00";
-	numberList[1] = "40";
-	numberList[2] = "80";
-	numberList[3] = "BF";
-	numberList[4] = "FF";
-	document.writeln('<table cellspacing="1" cellpadding="0" border="0">');
-	for(r = 0; r < 5; r++)
-	{
-		if (dir == 'h')
-		{
-			document.writeln('<tr>');
-		}
-		for(g = 0; g < 5; g++)
-		{
-			if (dir == 'v')
-			{
-				document.writeln('<tr>');
-			}
-			for(b = 0; b < 5; b++)
-			{
-				color = String(numberList[r]) + String(numberList[g]) + String(numberList[b]);
-				document.write('<td bgcolor="#' + color + '">');
-				document.write('<a href="javascript:bbfontstyle(\'[color=#' + color + ']\', \'[/color]\');" onmouseover="helpline(\'s\');"><img src="images/spacer.gif" width="' + width + '" height="' + height + '" border="0" alt="#' + color + '" title="#' + color + '" /></a>');
-				document.writeln('</td>');
-			}
-			if (dir == 'v')
-			{
-				document.writeln('</tr>');
-			}
-		}
-		if (dir == 'h')
-		{
-			document.writeln('</tr>');
-		}
-	}
-	document.writeln('</table>');
-}
-
+/**
+* bbCode control by subBlue design [ www.subBlue.com ]
+* Includes unixsafe colour palette selector by SHS`
+*/
+
+// Startup variables
+var imageTag = false;
+var theSelection = false;
+
+// Check for Browser & Platform for PC & IE specific bits
+// More details from: http://www.mozilla.org/docs/web-developer/sniffer/browser_type.html
+var clientPC = navigator.userAgent.toLowerCase(); // Get client info
+var clientVer = parseInt(navigator.appVersion); // Get browser version
+
+var is_ie = ((clientPC.indexOf('msie') != -1) && (clientPC.indexOf('opera') == -1));
+var is_nav = ((clientPC.indexOf('mozilla') != -1) && (clientPC.indexOf('spoofer') == -1) && (clientPC.indexOf('compatible') == -1) && (clientPC.indexOf('opera') == -1) && (clientPC.indexOf('webtv') == -1) && (clientPC.indexOf('hotjava') == -1));
+
+var is_win = ((clientPC.indexOf('win') != -1) || (clientPC.indexOf('16bit') != -1));
+var is_mac = (clientPC.indexOf('mac') != -1);
+
+/**
+* Shows the help messages in the helpline window
+*/
+function helpline(help)
+{
+	document.forms[form_name].helpbox.value = eval(help + '_help');
+}
+
+/**
+* Replacement for arrayname.length property
+*/
+function getarraysize(thearray)
+{
+	for (i = 0; i < thearray.length; i++)
+	{
+		if (thearray[i] == 'undefined' || thearray[i] == '' || thearray[i] == null)
+		{
+			return i;
+		}
+	}
+
+	return thearray.length;
+}
+
+/**
+* Replacement for arrayname.push(value) not implemented in IE until version 5.5
+* Appends element to the array
+*/
+function arraypush(thearray,value)
+{
+	thearray[getarraysize(thearray)] = value;
+}
+
+/**
+* Replacement for arrayname.pop() not implemented in IE until version 5.5
+* Removes and returns the last element of an array
+*/
+function arraypop(thearray)
+{
+	thearraysize = getarraysize(thearray);
+	retval = thearray[thearraysize - 1];
+	delete thearray[thearraysize - 1];
+
+	return retval;
+}
+
+/**
+* Insert emoticon
+*/
+function smiley(text) 
+{
+	text = ' ' + text + ' ';
+
+	if (document.forms[form_name].elements[text_name].createTextRange && document.forms[form_name].elements[text_name].caretPos)
+	{
+		var caretPos = document.forms[form_name].elements[text_name].caretPos;
+
+		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
+		document.forms[form_name].elements[text_name].focus();
+	}
+	else
+	{
+		var selStart = document.forms[form_name].elements[text_name].selectionStart;
+		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
+
+		mozWrap(document.forms[form_name].elements[text_name], text, '')
+		document.forms[form_name].elements[text_name].focus();
+		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
+		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
+	}
+}
+
+/**
+* Apply bbcodes
+*/
+function bbfontstyle(bbopen, bbclose)
+{
+	theSelection = false;
+	document.forms[form_name].elements[text_name].focus();
+
+	if ((clientVer >= 4) && is_ie && is_win)
+	{
+		// Get text selection
+		theSelection = document.selection.createRange().text;
+
+		if (theSelection)
+		{
+			// Add tags around selection
+			document.selection.createRange().text = bbopen + theSelection + bbclose;
+			document.forms[form_name].elements[text_name].focus();
+			theSelection = '';
+			return;
+		}
+	}
+	else if (document.forms[form_name].elements[text_name].selectionEnd && (document.forms[form_name].elements[text_name].selectionEnd - document.forms[form_name].elements[text_name].selectionStart > 0))
+	{
+		mozWrap(document.forms[form_name].elements[text_name], bbopen, bbclose);
+		document.forms[form_name].elements[text_name].focus();
+		theSelection = '';
+		return;
+	}
+
+	// Close image tag before adding
+	if (imageTag)
+	{
+		insert_text(bbtags[15]);
+
+		// Remove the close image tag from the list
+		lastValue = arraypop(bbcode) - 1;
+
+		// Return button back to normal state
+		document.forms[form_name].addbbcode14.value = 'Img';
+		imageTag = false;
+	}
+
+	// Open tag
+	insert_text(bbopen + bbclose);
+
+	document.forms[form_name].elements[text_name].focus();
+
+	storeCaret(document.forms[form_name].elements[text_name]);
+	return;
+}
+
+/**
+* Insert text at position
+*/
+function insert_text(text)
+{
+	if (document.forms[form_name].elements[text_name].createTextRange && !isNaN(document.forms[form_name].elements[text_name].caretPos))
+	{
+		var caretPos = document.forms[form_name].elements[text_name].caretPos;
+		caretPos.text = caretPos.text.charAt(caretPos.text.length - 1) == ' ' ? caretPos.text + text + ' ' : caretPos.text + text;
+	}
+	else if (!isNaN(document.forms[form_name].elements[text_name].selectionStart))
+	{
+		var selStart = document.forms[form_name].elements[text_name].selectionStart;
+		var selEnd = document.forms[form_name].elements[text_name].selectionEnd;
+
+		mozWrap(document.forms[form_name].elements[text_name], text, '')
+		document.forms[form_name].elements[text_name].selectionStart = selStart + text.length;
+		document.forms[form_name].elements[text_name].selectionEnd = selEnd + text.length;
+	}
+	else
+	{
+		document.forms[form_name].elements[text_name].value = document.forms[form_name].elements[text_name].value + text;
+	}
+}
+
+/**
+* Add inline attachment at position
+*/
+function attach_inline()
+{
+	insert_text('[attachment=' + document.forms[form_name].elements['attachments'].value + ']' + document.forms[form_name].elements['attachments'].options[document.forms[form_name].elements['attachments'].selectedIndex].text + '[/attachment]');
+	document.forms[form_name].elements[text_name].focus();
+}
+
+/**
+* Add quote text to message
+*/
+function addquote(post_id, username)
+{
+	var message_name = 'message_' + post_id;
+	var theSelection = '';
+	var divarea = false;
+
+	if (document.all)
+	{
+		eval('divarea = document.all.' + message_name + ';');
+	}
+	else
+	{
+		eval("divarea = document.getElementById('" + message_name + "');");
+	}
+
+	// Get text selection - not only the post content :(
+	if (window.getSelection)
+	{
+		theSelection = window.getSelection().toString();
+	}
+	else if (document.getSelection)
+	{
+		theSelection = document.getSelection();
+	}
+	else if (document.selection)
+	{
+		theSelection = document.selection.createRange().text;
+	}
+
+	if (theSelection == '')
+	{
+		if (divarea.innerHTML)
+		{
+			theSelection = divarea.innerHTML.replace(/<br>/ig, '\n');
+			theSelection = theSelection.replace(/<br\/>/ig, '\n');
+		}
+		else if (document.all)
+		{
+			theSelection = divarea.innerText;
+		}
+		else if (divarea.textContent)
+		{
+			theSelection = divarea.textContent;
+		}
+		else if (divarea.firstChild.nodeValue)
+		{
+			theSelection = divarea.firstChild.nodeValue;
+		}
+	}
+
+	if (theSelection)
+	{
+		insert_text('[quote="' + username + '"]' + theSelection + '[/quote]');
+	}
+
+	return;
+}
+
+/**
+* bbstyle
+*/
+function bbstyle(bbnumber)
+{
+	donotinsert = false;
+	theSelection = false;
+	bblast = 0;
+	document.forms[form_name].elements[text_name].focus();
+
+	// Close all open tags & default button names
+	if (bbnumber == -1)
+	{
+		while (bbcode[0])
+		{
+			butnumber = arraypop(bbcode) - 1;
+			document.forms[form_name].elements[text_name].value += bbtags[butnumber + 1];
+			buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
+		
+			if (buttext != '[*]')
+			{
+				eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
+			}
+		}
+
+		document.forms[form_name].addbbcode10.value = 'List';
+		bbtags[10] = '[list]';
+
+		document.forms[form_name].addbbcode12.value = 'List=';
+		bbtags[12] = '[list=]';
+		
+		// All tags are closed including image tags :D
+		imageTag = false;
+		document.forms[form_name].elements[text_name].focus();
+
+		return;
+	}
+
+	// [*] doesn't have an end tag
+	noEndTag = (bbtags[bbnumber] == '[*]')
+
+	if ((clientVer >= 4) && is_ie && is_win)
+	{
+		// Get text selection
+		theSelection = document.selection.createRange().text;
+
+		if (theSelection) 
+		{
+			// Add tags around selection
+			document.selection.createRange().text = bbtags[bbnumber] + theSelection + ((!noEndTag) ? bbtags[bbnumber+1] : '');
+			document.forms[form_name].elements[text_name].focus();
+			theSelection = '';
+			return;
+		}
+	}
+	else if (document.forms[form_name].elements[text_name].selectionEnd && (document.forms[form_name].elements[text_name].selectionEnd - document.forms[form_name].elements[text_name].selectionStart > 0))
+	{
+		mozWrap(document.forms[form_name].elements[text_name], bbtags[bbnumber], ((!noEndTag) ? bbtags[bbnumber+1] : ''));
+		document.forms[form_name].elements[text_name].focus();
+		theSelection = '';
+		return;
+	}
+
+	// Find last occurance of an open tag the same as the one just clicked
+	for (i = 0; i < bbcode.length; i++)
+	{
+		if (bbcode[i] == bbnumber+1)
+		{
+			bblast = i;
+			donotinsert = true;
+		}
+	}
+
+	if (bbnumber == 10 && bbtags[10] != '[*]')
+	{
+		if (donotinsert)
+		{
+			document.forms[form_name].addbbcode12.value = 'List=';
+			tmp_help = o_help;
+			o_help = e_help;
+			e_help = tmp_help;
+			bbtags[12] = '[list=]';
+		}
+		else
+		{
+			document.forms[form_name].addbbcode12.value = '[*]';
+			tmp_help = o_help;
+			o_help = e_help;
+			e_help = tmp_help;
+			bbtags[12] = '[*]';
+		}
+	}
+
+	if (bbnumber == 12 && bbtags[12] != '[*]')
+	{
+		if (donotinsert)
+		{
+			document.forms[form_name].addbbcode10.value = 'List';
+			tmp_help = l_help;
+			l_help = e_help;
+			e_help = tmp_help;
+			bbtags[10] = '[list]';
+		}
+		else
+		{
+			document.forms[form_name].addbbcode10.value = '[*]';
+			tmp_help = l_help;
+			l_help = e_help;
+			e_help = tmp_help;
+			bbtags[10] = '[*]';
+		}
+	}
+
+	// Close all open tags up to the one just clicked & default button names
+	if (donotinsert)
+	{
+		while (bbcode[bblast])
+		{
+			butnumber = arraypop(bbcode) - 1;
+
+			if (bbtags[butnumber] != '[*]')
+			{
+				insert_text(bbtags[butnumber + 1]);
+			}
+			else
+			{
+				insert_text(bbtags[butnumber]);
+			}
+
+			buttext = eval('document.forms[form_name].addbbcode' + butnumber + '.value');
+
+			if (bbtags[butnumber] != '[*]')
+			{
+				eval('document.forms[form_name].addbbcode' + butnumber + '.value ="' + buttext.substr(0,(buttext.length - 1)) + '"');
+			}
+			imageTag = false;
+		}
+		document.forms[form_name].elements[text_name].focus();
+		return;
+	}
+	else
+	{
+		// Open tags
+
+		// Close image tag before adding another
+		if (imageTag && (bbnumber != 14))
+		{
+			insert_text(bbtags[15]);
+
+			// Remove the close image tag from the list
+			lastValue = arraypop(bbcode) - 1;
+
+			// Return button back to normal state
+			document.forms[form_name].addbbcode14.value = 'Img';
+			imageTag = false;
+		}
+
+		// Open tag
+		insert_text(bbtags[bbnumber]);
+
+		// Check to stop additional tags after an unclosed image tag
+		if (bbnumber == 14 && imageTag == false)
+		{
+			imageTag = 1; 
+		}
+
+		if (bbtags[bbnumber] != '[*]')
+		{
+			arraypush(bbcode, bbnumber + 1);
+			eval('document.forms[form_name].addbbcode'+bbnumber+'.value += "*"');
+		}
+
+		document.forms[form_name].elements[text_name].focus();
+		return;
+	}
+
+	storeCaret(document.forms[form_name].elements[text_name]);
+}
+
+/**
+* From http://www.massless.org/mozedit/
+*/
+function mozWrap(txtarea, open, close)
+{
+	var selLength = txtarea.textLength;
+	var selStart = txtarea.selectionStart;
+	var selEnd = txtarea.selectionEnd;
+	var scrollTop = txtarea.scrollTop;
+
+	if (selEnd == 1 || selEnd == 2) 
+	{
+		selEnd = selLength;
+	}
+
+	var s1 = (txtarea.value).substring(0,selStart);
+	var s2 = (txtarea.value).substring(selStart, selEnd)
+	var s3 = (txtarea.value).substring(selEnd, selLength);
+
+	txtarea.value = s1 + open + s2 + close + s3;
+	txtarea.selectionStart = selEnd + open.length + close.length;
+	txtarea.selectionEnd = txtarea.selectionStart;
+	txtarea.focus();
+	txtarea.scrollTop = scrollTop;
+
+	return;
+}
+
+/**
+* Insert at Claret position. Code from
+* http://www.faqts.com/knowledge_base/view.phtml/aid/1052/fid/130
+*/
+function storeCaret(textEl)
+{
+	if (textEl.createTextRange)
+	{
+		textEl.caretPos = document.selection.createRange().duplicate();
+	}
+}
+
+/**
+* Color pallette
+*/
+function colorPalette(dir, width, height)
+{
+	var r = 0, g = 0, b = 0;
+	var numberList = new Array(6);
+
+	numberList[0] = '00';
+	numberList[1] = '40';
+	numberList[2] = '80';
+	numberList[3] = 'BF';
+	numberList[4] = 'FF';
+
+	document.writeln('<table cellspacing="1" cellpadding="0" border="0">');
+
+	for (r = 0; r < 5; r++)
+	{
+		if (dir == 'h')
+		{
+			document.writeln('<tr>');
+		}
+
+		for (g = 0; g < 5; g++)
+		{
+			if (dir == 'v')
+			{
+				document.writeln('<tr>');
+			}
+			
+			for (b = 0; b < 5; b++)
+			{
+				color = String(numberList[r]) + String(numberList[g]) + String(numberList[b]);
+				document.write('<td bgcolor="#' + color + '">');
+				document.write('<a href="javascript:bbfontstyle(\'[color=#' + color + ']\', \'[/color]\');" onmouseover="helpline(\'s\');"><img src="images/spacer.gif" width="' + width + '" height="' + height + '" border="0" alt="#' + color + '" title="#' + color + '" /></a>');
+				document.writeln('</td>');
+			}
+
+			if (dir == 'v')
+			{
+				document.writeln('</tr>');
+			}
+		}
+
+		if (dir == 'h')
+		{
+			document.writeln('</tr>');
+		}
+	}
+	document.writeln('</table>');
+}
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -334,7 +334,7 @@
 		$sql_start = $start;
 	}
 
-	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.message_reported, p.to_address, p.message_attachment, p.bcc_address, u.username 
+	$sql = 'SELECT t.*, p.author_id, p.root_level, p.message_time, p.message_subject, p.icon_id, p.to_address, p.message_attachment, p.bcc_address, u.username 
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . " u
 		WHERE t.user_id = $user_id
 			AND p.author_id = u.user_id

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -305,10 +305,10 @@
 	}
 	
 	// Instantiate BBCode class
-	if ((empty($bbcode) || $bbcode === false) && $bbcode_bitfield)
+	if ((empty($bbcode) || $bbcode === false) && $bbcode_bitfield !== '')
 	{
 		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-		$bbcode = new bbcode($bbcode_bitfield);
+		$bbcode = new bbcode(base64_encode($bbcode_bitfield));
 	}
 
 	$title = censor_text($title);

Modified: cms/trunk/modules/control_panel/modules/ucp_register.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_register.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/control_panel/modules/ucp_register.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -34,7 +34,7 @@
 	trigger_error('UCP_REGISTER_DISABLE');
 }
 
-$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('Control_Panel&amp;mode=register'));
+$_CLASS['core_template']->assign('S_UCP_ACTION', generate_link('control_panel&amp;mode=register'));
 
 $error = $data = array();
 $hidden_fields = '';
@@ -51,12 +51,12 @@
 			'L_COPPA_NO'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_BEFORE'], $coppa_birthday),
 			'L_COPPA_YES'		=> sprintf($_CLASS['core_user']->lang['UCP_COPPA_ON_AFTER'], $coppa_birthday),
 
-			'U_COPPA_NO'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=0'), 
-			'U_COPPA_YES'		=> generate_link('Control_Panel&amp;mode=register&amp;coppa=1'), 
+			'U_COPPA_NO'		=> generate_link('control_panel&amp;mode=register&amp;coppa=0'), 
+			'U_COPPA_YES'		=> generate_link('control_panel&amp;mode=register&amp;coppa=1'), 
 
 			'S_SHOW_COPPA'		=> true, 
 			'S_HIDDEN_FIELDS'	=> $hidden_fields,
-			'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register'))
+			'S_REGISTER_ACTION'	=> generate_link('control_panel&amp;mode=register'))
 		);
 	}
 	else
@@ -66,11 +66,11 @@
 		$_CLASS['core_template']->assign_array(array(
 			'S_SHOW_COPPA'		=> false,
 			'S_HIDDEN_FIELDS'	=> $hidden_fields,
-			'S_REGISTER_ACTION'	=> generate_link('Control_Panel&amp;mode=register')
+			'S_REGISTER_ACTION'	=> generate_link('control_panel&amp;mode=register')
 		));
 	}
 
-	$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/Control_Panel/ucp_agreement.html');
+	$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/control_panel/ucp_agreement.html');
 }
 
 if ($submit)
@@ -298,9 +298,9 @@
 
 	'S_COPPA'			=> $coppa, 
 	'S_HIDDEN_FIELDS'	=> $hidden_fields,
-	'S_UCP_ACTION'		=> generate_link("Control_Panel&amp;mode=register"))
+	'S_UCP_ACTION'		=> generate_link("control_panel&amp;mode=register"))
 );
 
-$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/Control_Panel/ucp_register.html');
+$_CLASS['core_display']->display($_CLASS['core_user']->lang['REGISTER'], 'modules/control_panel/ucp_register.html');
 
 ?>
\ No newline at end of file

Modified: cms/trunk/modules/forums/admin/index.php
===================================================================
--- cms/trunk/modules/forums/admin/index.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/forums/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -37,6 +37,8 @@
 	die; 
 }
 
+global $_CLASS, $_CORE_CONFIG;
+
 // Some often used variables
 $safe_mode	= (@ini_get('safe_mode') || @strtolower(ini_get('safe_mode')) == 'on') ? true : false;
 $file_uploads = (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on') ? true : false;
@@ -55,7 +57,7 @@
 require_once(SITE_FILE_ROOT.'includes/forums/functions.php');
 require_once(SITE_FILE_ROOT.'includes/forums/functions_admin.php');
 
-$_CLASS['core_user']->add_lang('admin', 'Forums');
+$_CLASS['core_user']->add_lang('admin', 'forums');
 //$_CLASS['core_user']->add_img(false, 'Forums');
 $_CLASS['auth']->acl($_CLASS['core_user']->data);
 
@@ -73,128 +75,90 @@
 
 // -----------------------------
 // Functions
-function adm_page_header($sub_title, $meta = '', $table_html = true)
+function adm_page_header($page_title)
 {
-	global $config, $db, $_CLASS;
+	global $config, $_CLASS;
 
-	$_CLASS['core_display']->display_header();
-	echo $_CLASS['core_display']->theme->table_open;
+	$_CLASS['core_template']->assign_array(array(
+		'PAGE_TITLE'			=> $page_title,
+		'USERNAME'				=> $_CLASS['core_user']->data['username'],
 
-	if ($table_html)
-	{
+		//'U_ADM_INDEX'			=> append_sid("{$phpbb_admin_path}index.$phpEx"),
+		//'U_INDEX'				=> append_sid("index.$phpEx"),
 
-?>
-<a name="top"></a>
+		'T_IMAGES_PATH'			=> "images/",
+		'T_SMILIES_PATH'		=> "{$config['smilies_path']}/",
+		'T_AVATAR_PATH'			=> "{$config['avatar_path']}/",
+		'T_AVATAR_GALLERY_PATH'	=> "{$config['avatar_gallery_path']}/",
+		'T_ICONS_PATH'			=> "{$config['icons_path']}/",
+		'T_RANKS_PATH'			=> "{$config['ranks_path']}/",
+		'T_UPLOAD_PATH'			=> "{$config['upload_path']}/",
 
-<table width="100%" cellspacing="0" cellpadding="0" border="0" align="center">
-	<tr>
-		<td>
-
-<?php
-
-	}
-
+		'ICON_MOVE_UP'		=> '<img src="images/icon_up.gif" alt="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" title="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" />',
+		'ICON_MOVE_DOWN'	=> '<img src="images/icon_down.gif" alt="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" title="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" />',
+		'ICON_EDIT'			=> '<img src="images/icon_edit.gif" alt="' . $_CLASS['core_user']->lang['EDIT'] . '" title="' . $_CLASS['core_user']->lang['EDIT'] . '" />',
+		'ICON_DELETE'		=> '<img src="images/icon_delete.gif" alt="' . $_CLASS['core_user']->lang['DELETE'] . '" title="' . $_CLASS['core_user']->lang['DELETE'] . '" />',
+		'ICON_SYNC'			=> '<img src="images/icon_sync.gif" alt="' . $_CLASS['core_user']->lang['RESYNC'] . '" title="' . $_CLASS['core_user']->lang['RESYNC'] . '" />',
+	));
 }
 
 function adm_page_footer($copyright_html = true)
 {
-	global $cache, $config, $_CLASS;
+	garbage_collection();
+}
 
-?>
+/**
+* Generate back link for acp pages
+*/
+function adm_back_link($u_action)
+{
+	global $user;
+	return '<br /><br /><a href="' . $u_action . '">&laquo; ' . $_CLASS['core_user']->lang['BACK_TO_PREV'] . '</a>';
+}
 
-		</td>
-	</tr>
-</table>
-<?php
+/**
+* Build select field options in acp pages
+*/
+function build_select($option_ary, $option_default = false)
+{
+	global $_CLASS;
 
-	if ($copyright_html)
+	$html = '';
+	foreach ($option_ary as $value => $title)
 	{
-
-?>
-
-<div class="copyright" align="center">Powered by phpBB <?php echo $config['version']; ?> &copy; 2002 <a href="http://www.phpbb.com/" target="_phpbb">phpBB Group</a></div>
-
-<br clear="all" />
-<?php
+		$selected = ($option_default !== false && $value == $option_default) ? ' selected="selected"' : '';
+		$html .= '<option value="' . $value . '"' . $selected . '>' . $_CLASS['core_user']->get_lang($title) . '</option>';
 	}
 
-	echo $_CLASS['core_display']->theme->table_close;
-	$_CLASS['core_display']->display_footer();
+	return $html;
 }
 
-function adm_page_confirm($title, $message)
+/**
+* Build radio fields in acp pages
+*/
+function h_radio($name, &$input_ary, $input_default = false, $id = false, $key = false)
 {
 	global $_CLASS;
 
-	// Grab data from GET and POST arrays ... note this is _not_
-	// validated! Everything is typed as string to ensure no
-	// funny business on displayed hidden field data. Validation
-	// will be carried out by whatever processes this form.
-	$var_ary = array_merge($_GET, $_POST);
-
-	$s_hidden_fields = '';
-	foreach ($var_ary as $key => $var)
+	$html = '';
+	$id_assigned = false;
+	foreach ($input_ary as $value => $title)
 	{
-		if (empty($var))
-		{
-			continue;
-		}
-
-		if (is_array($var))
-		{
-			foreach ($var as $k => $v)
-			{
-				if (is_array($v))
-				{
-					foreach ($v as $_k => $_v)
-					{
-						set_var($var[$k][$_k], $_v, 'string');
-						$s_hidden_fields .= "<input type=\"hidden\" name=\"${key}[$k][$_k]\" value=\"" . addslashes($_v) . '" />';
-					}
-				}
-				else
-				{
-					set_var($var[$k], $v, 'string');
-					$s_hidden_fields .= "<input type=\"hidden\" name=\"${key}[$k]\" value=\"" . addslashes($v) . '" />';
-				}
-			}
-		}
-		else
-		{
-			set_var($var, $var, 'string');
-			$s_hidden_fields .= '<input type="hidden" name="' . $key . '" value="' . addslashes($var) . '" />';
-		}
-		unset($var_ary[$key]);
+		$selected = ($input_default !== false && $value == $input_default) ? ' checked="checked"' : '';
+		$html .= ($html) ? ' &nbsp; ' : '';
+		$html .= '<input type="radio" name="' . $name . '"' . (($id && !$id_assigned) ? ' id="' . $id . '"' : '') . ' value="' . $value . '"' . $selected . (($key) ? ' accesskey="' . $key . '"' : '') . ' class="radio" /> ' . $_CLASS['core_user']->lang[$title];
+		$id_assigned = true;
 	}
 
-?>
-
-<br /><br />
-
-<form name="confirm" method="post" action="<?php echo $_SERVER['REQUEST_URI']; ?>">
-<table class="tablebg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th><?php echo $title; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center"><?php echo $message; ?><br /><br /><input class="btnlite" type="submit" name="confirm" value="<?php echo $_CLASS['core_user']->lang['YES']; ?>" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['NO']; ?>" /></td>
-	</tr>
-</table>
-
-<?php echo $s_hidden_fields; ?>
-</form>
-
-<br />
-
-<?php
-
-	adm_page_footer();
-
+	return $html;
 }
 
-function build_cfg_template($tpl_type, $config_key, $options = '')
+/**
+* Build configuration template for acp configuration pages
+*/
+function build_cfg_template($tpl_type, $key, &$new, $config_key, $vars)
 {
-	global $new, $_CLASS;
+	global $_CLASS;
 
 	$tpl = '';
 	$name = 'config[' . $config_key . ']';
@@ -206,22 +170,22 @@
 			$size = (int) $tpl_type[1];
 			$maxlength = (int) $tpl_type[2];
 
-			$tpl = '<input class="post" type="' . $tpl_type[0] . '"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="' . $name . '" value="' . $new[$config_key] . '" />';
-			break;
+			$tpl = '<input id="' . $key . '" type="' . $tpl_type[0] . '"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="' . $name . '" value="' . $new[$config_key] . '" />';
+		break;
 
 		case 'dimension':
 			$size = (int) $tpl_type[1];
 			$maxlength = (int) $tpl_type[2];
 
-			$tpl = '<input class="post" type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_height]" value="' . $new[$config_key . '_height'] . '" /> x <input class="post" type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_width]" value="' . $new[$config_key . '_width'] . '" />';
-			break;
+			$tpl = '<input id="' . $key . '" type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_height]" value="' . $new[$config_key . '_height'] . '" /> x <input type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_width]" value="' . $new[$config_key . '_width'] . '" />';
+		break;
 
 		case 'textarea':
 			$rows = (int) $tpl_type[1];
 			$cols = (int) $tpl_type[2];
 
-			$tpl = '<textarea name="' . $name . '" rows="' . $rows . '" cols="' . $cols . '">' . $new[$config_key] . '</textarea>';
-			break;
+			$tpl = '<textarea id="' . $key . '" name="' . $name . '" rows="' . $rows . '" cols="' . $cols . '">' . $new[$config_key] . '</textarea>';
+		break;
 
 		case 'radio':
 			$key_yes	= ($new[$config_key]) ? ' checked="checked"' : '';
@@ -230,25 +194,76 @@
 			$tpl_type_cond = explode('_', $tpl_type[1]);
 			$type_no = ($tpl_type_cond[0] == 'disabled' || $tpl_type_cond[0] == 'enabled') ? false : true;
 
-			$tpl_no = '<input type="radio" name="' . $name . '" value="0"' . $key_no . ' />' . (($type_no) ? $_CLASS['core_user']->lang['NO'] : $_CLASS['core_user']->lang['DISABLED']);
-			$tpl_yes = '<input type="radio" name="' . $name . '" value="1"' . $key_yes . ' />' . (($type_no) ? $_CLASS['core_user']->lang['YES'] : $_CLASS['core_user']->lang['ENABLED']);
+			$tpl_no = '<input type="radio" name="' . $name . '" value="0"' . $key_no . ' class="radio" />&nbsp;' . (($type_no) ? $_CLASS['core_user']->lang['NO'] : $_CLASS['core_user']->lang['DISABLED']);
+			$tpl_yes = '<input type="radio" id="' . $key . '" name="' . $name . '" value="1"' . $key_yes . ' class="radio" />&nbsp;' . (($type_no) ? $_CLASS['core_user']->lang['YES'] : $_CLASS['core_user']->lang['ENABLED']);
 
 			$tpl = ($tpl_type_cond[0] == 'yes' || $tpl_type_cond[0] == 'enabled') ? $tpl_yes . '&nbsp;&nbsp;' . $tpl_no : $tpl_no . '&nbsp;&nbsp;' . $tpl_yes;
-			break;
+		break;
 
 		case 'select':
-			eval('$s_options = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			$tpl = '<select name="' . $name . '">' . $s_options . '</select>';
-			break;
-
 		case 'custom':
-			eval('$tpl = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			break;
+			
+			$return = '';
 
+			if (isset($vars['method']))
+			{
+				$call = array($module->module, $vars['method']);
+			}
+			else if (isset($vars['function']))
+			{
+				$call = $vars['function'];
+			}
+			else
+			{
+				break;
+			}
+
+			if (isset($vars['params']))
+			{
+				$args = array();
+				foreach ($vars['params'] as $value)
+				{
+					switch ($value)
+					{
+						case '{CONFIG_VALUE}':
+							$value = $new[$config_key];
+						break;
+
+						case '{KEY}':
+							$value = $key;
+						break;
+					}
+
+					$args[] = $value;
+				}
+			}
+			else
+			{
+				$args = array($new[$config_key], $key);
+			}
+			
+			$return = call_user_func_array($call, $args);
+
+			if ($tpl_type[0] == 'select')
+			{
+				$tpl = '<select id="' . $key . '" name="' . $name . '">' . $return . '</select>';
+			}
+			else
+			{
+				$tpl = $return;
+			}
+
+		break;
+
 		default:
-			break;
+		break;
 	}
 
+	if (isset($vars['append']))
+	{
+		$tpl .= $vars['append'];
+	}
+
 	return $tpl;
 }
 

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/forums/posting.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -151,7 +151,7 @@
 		trigger_error('USER_CANNOT_READ');
 	}
 
-	login_box('', $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_POST'));
+	login_box(array('explain' => $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_POST')));
 }
 
 if ($post_data['forum_password'])
@@ -162,7 +162,6 @@
 	));
 }
 
-
 // Permission to do the action asked?
 $is_authed = false;
 
@@ -212,7 +211,7 @@
 		trigger_error('USER_CANNOT_' . strtoupper(($mode == 'quote') ? 'reply' : $mode));
 	}
 
-	login_box('', $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_' . strtoupper($mode)));
+	login_box(array('explain' => $_CLASS['core_user']->get_lang('LOGIN_EXPLAIN_' . strtoupper($mode))));
 }
 unset($is_authed);
 
@@ -356,7 +355,7 @@
 
 if ($post_data['post_attachment'] && !$submit && !$refresh && !$preview && $mode == 'edit')
 {
-	$sql = 'SELECT attach_id, physical_filename, attach_comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
+	$sql = 'SELECT attach_id, physical_filename, comment, real_filename, extension, mimetype, filesize, filetime, thumbnail
 		FROM ' . FORUMS_ATTACHMENTS_TABLE . "
 		WHERE post_msg_id = $post_id
 			AND in_message = 0
@@ -647,7 +646,7 @@
 	$topic_lock			= isset($_POST['lock_topic']);
 	$post_lock			= isset($_POST['lock_post']);
 	$poll_delete		= isset($_POST['poll_delete']);
-	
+
 	// Faster than crc32
 	if ($submit)
 	{
@@ -660,7 +659,7 @@
 	}
 
 	// Delete Poll
-	if ($poll_delete && $mode == 'edit' && count($post_data['poll_options']) && 
+	if ($poll_delete && $mode === 'edit' && count($post_data['poll_options']) && 
 		((!$post_data['poll_last_vote'] && $post_data['poster_id'] == $_CLASS['core_user']->data['user_id'] && $_CLASS['forums_auth']->acl_get('f_delete', $forum_id)) || $_CLASS['forums_auth']->acl_get('m_delete', $forum_id)))
 	{
 		switch ($_CLASS['core_db']->db_layer)
@@ -712,7 +711,7 @@
 	// If replying/quoting and last post id has changed
 	// give user option to continue submit or return to post
 	// notify and show user the post made between his request and the final submit
-	if (($mode == 'reply' || $mode == 'quote') && $post_data['topic_cur_post_id'] && $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
+	if (($mode === 'reply' || $mode === 'quote') && $post_data['topic_cur_post_id'] && $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
 		if (topic_review($topic_id, $forum_id, 'post_review', $post_data['topic_cur_post_id']))
 		{
@@ -741,7 +740,7 @@
 		$message_parser->bbcode_bitfield = $post_data['bbcode_bitfield'];
 	}
 
-	if ($mode != 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['forums_auth']->acl_get('f_ignoreflood', $forum_id))
+	if ($mode !== 'edit' && !$preview && !$refresh && $config['flood_interval'] && !$_CLASS['forums_auth']->acl_get('f_ignoreflood', $forum_id))
 	{
 		// Flood check
 		$last_post_time = 0;
@@ -771,7 +770,7 @@
 	}
 
 	// Validate username
-	if (($post_data['username'] && !$_CLASS['core_user']->is_user) || ($mode == 'edit' && $post_data['post_username']))
+	if (($post_data['username'] && !$_CLASS['core_user']->is_user) || ($mode === 'edit' && $post_data['post_username']))
 	{
 		require_once SITE_FILE_ROOT.'includes/functions_user.php';
 		$result = validate_username($post_data['username']);
@@ -781,7 +780,7 @@
 			$error[] = $_CLASS['core_user']->get_lang($result);
 		}
 	}
-	
+
 /*
  ADD
 	if ($config['enable_post_confirm'] && !$_CLASS['core_user']->is_user && in_array($mode, array('quote', 'post', 'reply')))
@@ -806,15 +805,15 @@
 */
 
 	// Parse subject
-	if (!$post_data['post_subject'] && ($mode == 'post' || ($mode == 'edit' && $post_data['topic_first_post_id'] == $post_id)))
+	if (!$post_data['post_subject'] && ($mode === 'post' || ($mode === 'edit' && $post_data['topic_first_post_id'] == $post_id)))
 	{
 		$error[] = $_CLASS['core_user']->get_lang('EMPTY_SUBJECT');
 	}
 
-	$post_data['poll_last_vote'] = (isset($post_data['poll_last_vote'])) ? $post_data['poll_last_vote'] : 0;
+	$post_data['poll_last_vote'] = isset($post_data['poll_last_vote']) ? $post_data['poll_last_vote'] : 0;
 
 	if ($post_data['poll_option_text'] && 
-		($mode == 'post' || ($mode == 'edit' && $post_id == $post_data['topic_first_post_id'] && (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))))
+		($mode === 'post' || ($mode === 'edit' && $post_id == $post_data['topic_first_post_id'] && (!$post_data['poll_last_vote'] || $_CLASS['forums_auth']->acl_get('m_edit', $forum_id))))
 			&& $_CLASS['forums_auth']->acl_get('f_poll', $forum_id))
 	{
 		$poll = array(

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -260,6 +260,8 @@
 	$topic_data['topic_time_limit'] = 0;
 }
 
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang('viewtopic');
 $_CLASS['core_user']->add_img();
@@ -420,7 +422,7 @@
 		
 	if ($update && $s_can_vote)
 	{
-		if (empty($voted_id) || !empty($voted_id) > $poll_max_options)
+		if (empty($voted_id) || !empty($voted_id) > $topic_data['poll_max_options'])
 		{
 			$_CLASS['core_display']->meta_refresh(5, generate_link("forums&amp;file=viewtopic&amp;t=$topic_id"));
 
@@ -429,6 +431,8 @@
 			trigger_error($message);
 		}
 
+		$sql_ary = array();
+
 		foreach ($voted_id as $option)
 		{
 			if (in_array($option, $cur_voted_id))
@@ -436,7 +440,7 @@
 				continue;
 			}
 
-			$sql = 'UPDATE ' . POLL_OPTIONS_TABLE . '
+			$sql = 'UPDATE ' . FORUMS_POLL_OPTIONS_TABLE . '
 				SET poll_option_total = poll_option_total + 1
 				WHERE poll_option_id = ' . (int) $option . '
 					AND topic_id = ' . (int) $topic_id;
@@ -444,18 +448,23 @@
 
 			if ($_CLASS['core_user']->is_user)
 			{
-				$sql_ary = array(
+				$sql_ary[] = array(
 					'topic_id'			=> (int) $topic_id,
 					'poll_option_id'	=> (int) $option,
 					'vote_user_id'		=> (int) $_CLASS['core_user']->data['user_id'],
 					'vote_user_ip'		=> (string) $_CLASS['core_user']->ip,
 				);
-
-				$sql = 'INSERT INTO  ' . POLL_VOTES_TABLE . ' ' . $db->sql_build_array('INSERT', $sql_ary);
+
 				$_CLASS['core_db']->query($sql);
 			}
 		}
 
+		if (!empty($sql_ary))
+		{
+			$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_ary, FORUMS_POLL_VOTES_TABLE);
+			unset($sql_ary);
+		}
+
 		foreach ($cur_voted_id as $option)
 		{
 			if (!in_array($option, $voted_id))

Modified: cms/trunk/modules/members_list/index.php
===================================================================
--- cms/trunk/modules/members_list/index.php	2006-08-13 02:53:31 UTC (rev 183)
+++ cms/trunk/modules/members_list/index.php	2006-08-16 12:22:53 UTC (rev 184)
@@ -96,7 +96,7 @@
 		$sql = 'SELECT u.user_id, u.username, u.user_colour, u.user_rank, u.user_posts, g.group_id, g.group_name, g.group_colour, g.group_type, ug.user_id as ug_user_id
 			FROM ' . CORE_USERS_TABLE . ' u, ' . CORE_GROUPS_TABLE . ' g
 			LEFT JOIN ' . CORE_GROUPS_MEMBERS_TABLE . ' ug ON (ug.group_id = g.group_id AND ug.user_id = ' . $_CLASS['core_user']->data['user_id'] . ')
-			WHERE u.user_id IN (' . implode(', ', $modorators) . ')
+			WHERE u.user_id IN (' . implode(', ', array_unique($modorators)) . ')
 				AND u.user_group = g.group_id
 			ORDER BY g.group_name ASC, u.username ASC';
 
@@ -132,7 +132,7 @@
 			}
 
 			$rank_title = $rank_img = '';
-			get_user_rank($row['user_rank'], $row['user_posts'], $rank_title, $rank_img);
+			get_user_rank($row['user_rank'], $row['user_posts'], $rank_title, $rank_img, $rank_img_src);
 
 			$_CLASS['core_template']->assign_vars_array('moderators', array(
 				'USER_ID'		=> $row['user_id'],
@@ -144,6 +144,7 @@
 				'GROUP_COLOR'	=> $row['group_colour'],
 
 				'RANK_IMG'		=> $rank_img,
+				'RANK_IMG_SRC'	=> $rank_img_src,
 
 				'U_GROUP'		=> $u_group,
 				'U_VIEWPROFILE'	=> generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['user_id']),
@@ -173,19 +174,12 @@
 		$presence_img = '';
 		switch ($action)
 		{
-			case 'icq':
-				$lang = 'ICQ';
-				$sql_field = 'user_icq';
-				$s_select = 'S_SEND_ICQ';
-				$s_action = 'http://wwp.icq.com/scripts/WWPMsg.dll';
-				break;
-
 			case 'aim':
 				$lang = 'AIM';
 				$sql_field = 'user_aim';
 				$s_select = 'S_SEND_AIM';
 				$s_action = '';
-				break;
+			break;
 
 			case 'msnm':
 				$lang = 'MSNM';
@@ -199,35 +193,37 @@
 				$sql_field = 'user_jabber';
 				$s_select = (@extension_loaded('xml')) ? 'S_SEND_JABBER' : 'S_NO_SEND_JABBER';
 				$s_action = generate_link("members_list&amp;mode=contact&amp;action=$action&amp;u=$user_id");
-				break;
+			break;
 
 			default:
 				trigger_error('NO_USER_DATA');
 				die;
-				break;
+			break;
 		}
 
 		// Grab relevant data
 		$sql = "SELECT user_id, username, user_email, user_lang, $sql_field
-			FROM " . USERS_TABLE . "
+			FROM " . CORE_USERS_TABLE . "
 			WHERE user_id = $user_id
 				AND user_type = " . USER_NORMAL .' AND user_status = ' . STATUS_ACTIVE;
 		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
 
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
+		if (!$row)
 		{
 			trigger_error('NO_USER_DATA');
 		}
-		$_CLASS['core_db']->free_result($result);
+		
 
 		// Post data grab actions
 		switch ($action)
 		{
 			case 'icq':
 				$presence_img = '<img src="http://web.icq.com/whitepages/online?icq=' . $row[$sql_field] . '&amp;img=5" width="18" height="18" border="0" alt="" />';
-				break;
+			break;
 
-			case 'jabber':
+		/*	case 'jabber':
 				if ($submit && @extension_loaded('xml'))
 				{
 					// Add class loader
@@ -257,7 +253,7 @@
 
 					$s_select = 'S_SENT_JABBER';
 				}
-				break;
+				break;*/
 		}
 
 		$_CLASS['core_template']->assign_array(array(
@@ -280,21 +276,29 @@
 	case 'viewprofile':
 	
 		$user_id = get_variable('u', 'REQUEST', ANONYMOUS, 'int');
+		$username = get_variable('username', 'REQUEST');
 
 		// Display a profile
-		if ($user_id === ANONYMOUS)
+		if ($user_id === ANONYMOUS && !$username)
 		{
 			trigger_error('NO_USER');
 		}
 
-		// We left join on the session table to see if the user is currently online
-		$sql = 'SELECT username, user_id, user_type, user_status, user_group, user_colour, user_permissions, user_sig,
-			user_sig_bbcode_uid, user_sig_bbcode_bitfield, user_allow_viewemail, user_posts, user_reg_date, user_rank,
-			user_from, user_occ, user_interests, user_website, user_email, user_icq, user_aim, user_yim, user_msnm,
-			user_jabber, user_avatar, user_avatar_width, user_avatar_height, user_avatar_type, user_last_visit
-			FROM ' . CORE_USERS_TABLE . "
-			WHERE user_id = $user_id
-				AND user_type = " . USER_NORMAL;
+		// Get user...
+		if ($username)
+		{
+			$sql = 'SELECT *
+				FROM ' . CORE_USERS_TABLE . "
+				WHERE LOWER(username) = '" . $_CLASS['core_db']->escape(strtolower($username)) . "'
+					AND user_type IN (" . USER_NORMAL . ')';
+		}
+		else
+		{
+			$sql = 'SELECT *
+				FROM ' . CORE_USERS_TABLE . "
+				WHERE user_id = $user_id
+					AND user_type IN (" . USER_NORMAL . ')';
+		}
 
 		$result = $_CLASS['core_db']->query($sql);
 		$member = $_CLASS['core_db']->fetch_row_assoc($result);
@@ -302,8 +306,6 @@
 
 		if (!$member || (!$_CLASS['core_auth']->admin_power('users') && $member['user_status'] != STATUS_ACTIVE))
 		{
-			$_CLASS['core_db']->free_result($result);
-
 			trigger_error(($member) ? 'USER_INACTIVE' : 'NO_USER');
 		}
 		



From viperal at mail.berlios.de  Sun Aug 20 19:59:33 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 20 Aug 2006 19:59:33 +0200
Subject: [Viperals-svncheckins] r185 - in cms/trunk: . admin includes
	includes/cache includes/display includes/forums
	includes/forums/admin includes/templates/admin
	includes/templates/admin/eaccelerator
	includes/templates/modules/forums
	includes/templates/modules/forums/admin install
	modules/forums modules/forums/admin
Message-ID: <200608201759.k7KHxX3B016405@sheep.berlios.de>

Author: viperal
Date: 2006-08-20 19:59:24 +0200 (Sun, 20 Aug 2006)
New Revision: 185

Added:
   cms/trunk/admin/eaccelerator.php
   cms/trunk/includes/templates/admin/eaccelerator/
   cms/trunk/includes/templates/admin/eaccelerator/index.html
   cms/trunk/includes/templates/modules/forums/admin/acp_forums.html
Removed:
   cms/trunk/includes/forums/admin/index.php
   cms/trunk/includes/forums/admin/subSilver.css
   cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html
   cms/trunk/modules/forums/images/
Modified:
   cms/trunk/core.php
   cms/trunk/includes/cache/cache_eaccelerator.php
   cms/trunk/includes/cache/cache_file.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/forums/admin/index.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Added: cms/trunk/admin/eaccelerator.php
===================================================================
--- cms/trunk/admin/eaccelerator.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/admin/eaccelerator.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,218 @@
+<?php
+/*
+||**************************************************************||
+||  Viperal CMS ?? :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005, 2006								||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: viperal1 at gmail.com									||
+||  Site: http://www.viperal.com								||
+||																||
+||**************************************************************||
+||	LICENSE: ( http://www.gnu.org/licenses/gpl.txt )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+if (!function_exists('eaccelerator_info'))
+{
+
+}
+
+global $_CLASS, $sort_by;
+
+
+if (isset($_REQUEST['mode']))
+{
+	$setting = (isset($_REQUEST['setting']) && $_REQUEST['setting']) ? true : false;
+
+	switch ($_REQUEST['mode'])
+	{
+		case 'caching':
+			eaccelerator_caching($setting);
+		break;
+	
+		case 'optimizer':
+			eaccelerator_optimizer($setting);
+		break;
+	
+		case 'clear_cache':
+			eaccelerator_clear();
+		break;
+	
+		case 'clean_cache':
+			eaccelerator_clean();
+		break;
+	
+		case 'purge_cache':
+			eaccelerator_purge();
+		break;
+
+		case 'keys':
+		case 'scripts':
+		case 'removed_scripts':
+			$_CLASS['core_template']->assign('eaccelerator_info', false);
+
+			eaccelerator_display($_REQUEST['mode'], get_variable('start', 'REQUEST', 0, 'integer'), 10);
+
+			$_CLASS['core_template']->display('admin/eaccelerator/index.html');
+			die;
+		break;
+	}
+}
+
+$info = eaccelerator_info();
+
+$rename_array = array(
+	'memory_size'		=> 'memorySize',
+	'memory_available'	=> 'memoryAvailable',
+	'memory_allocated'	=> 'memoryAllocated',
+	'cached_scripts'	=> 'cachedScripts',
+	'cached_keys'		=> 'cachedKeys',
+	'removed_scripts'	=> 'removedScripts'
+);
+
+$info['memory_usage'] = number_format(100 * $info['memoryAllocated'] / $info['memorySize'], 2);
+
+foreach ($rename_array as $new_name => $old_name)
+{
+	if (strpos($new_name, 'memory_') === 0)
+	{
+		$info[$new_name] = generate_size($info[$old_name]);
+	}
+	else
+	{
+		$info[$new_name] = $info[$old_name];
+	}
+
+	unset($info[$old_name]);
+}
+
+$info += array(
+	'eaccelerator_info'		=> true,
+	'caching_link_title'	=> (($info['cache']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE']) . ' Caching',
+	'caching_link'			=> generate_link('eaccelerator&amp;mode=caching&amp;setting='.(($info['cache']) ? 0 : 1), array('admin' => true)),
+	'optimizer_link_title'	=> (($info['optimizer']) ? $_CLASS['core_user']->lang['DEACTIVATE'] : $_CLASS['core_user']->lang['ACTIVATE']) . ' Optimizer',
+	'optimizer_link'		=> generate_link('eaccelerator&amp;mode=optimizer&amp;setting='.(($info['optimizer']) ? 0 : 1), array('admin' => true)),
+	'clear_cache_link_title'=> 'Clear cache',
+	'clear_cache_link'		=> generate_link('eaccelerator&amp;mode=clear_cache', array('admin' => true)),
+	'clean_cache_link_title'=> 'Clean cache',
+	'clean_cache_link'		=> generate_link('eaccelerator&amp;mode=clean_cache', array('admin' => true)),
+	'purge_cache_link_title'=> 'Purge cache',
+	'purge_cache_link'		=> generate_link('eaccelerator&amp;mode=purge_cache', array('admin' => true)),
+
+	'link_scripts'			=> generate_link('eaccelerator&amp;mode=scripts', array('admin' => true)),
+	'link_removed_scripts'	=> generate_link('eaccelerator&amp;mode=removed_scripts', array('admin' => true)),
+	'link_keys'				=> generate_link('eaccelerator&amp;mode=keys', array('admin' => true)),
+);
+
+$_CLASS['core_template']->assign_array($info);
+
+eaccelerator_display('keys');
+eaccelerator_display('scripts');
+eaccelerator_display('removed_scripts');
+
+$_CLASS['core_template']->display('admin/eaccelerator/index.html');
+
+function eaccelerator_display($mode, $start = 0, $limit = 5, $sort = false)
+{
+	global $_CLASS, $sort_by;
+
+	$total_count = 0;
+
+	switch ($mode)
+	{
+		case 'scripts':
+		case 'removed_scripts':
+			$scripts_array = ($mode === 'scripts') ? eaccelerator_cached_scripts() : eaccelerator_removed_scripts();
+
+			if (!empty($scripts_array))
+			{
+				$sort_by = 'mtime';
+				usort($scripts_array, 'eaccelerator_compare');
+				$total_count = count($scripts_array);
+
+				$end = min($start + $limit, $total_count);
+
+				for ($i = $start; $i < $end; $i++)
+				{
+					$scripts_array[$i]['time'] = date('Y/m/d H:i', $scripts_array[$i]['mtime']);
+					$scripts_array[$i]['size'] = generate_size($scripts_array[$i]['size']);
+
+					$_CLASS['core_template']->assign_vars_array($mode.'_array', $scripts_array[$i]);
+				}
+			}
+		break;
+
+		case 'keys':
+			$keys_array = eaccelerator_list_keys();
+
+			if (!empty($keys_array))
+			{
+				$sort_by = 'created';
+				usort($keys_array, 'eaccelerator_compare');
+				$total_count = count($keys_array);
+
+				$end = min($start + $limit, $total_count);
+
+				for ($i = $start; $i < $end; $i++)
+				{
+					$keys_array[$i]['created'] = date('Y/m/d H:i', $keys_array[$i]['created']);
+					$keys_array[$i]['size'] = generate_size($keys_array[$i]['size']);
+				
+					if ($keys_array[$i]['ttl'] == 0)
+					{
+						$keys_array[$i]['expire_time'] = 'none';
+					}
+					elseif ($keys_array[$i]['ttl'] == -1)
+					{
+						$keys_array[$i]['expire_time'] = 'expired';
+					}
+					else
+					{
+						$keys_array[$i]['expire_time'] = date('Y/m/d H:i', $keys_array[$i]['ttl']);
+					}
+
+					$_CLASS['core_template']->assign_vars_array('keys_array', $keys_array[$i]);
+				}
+			}
+		break;
+	}
+
+	$pagination = generate_pagination('eaccelerator&amp;mode='.$mode, $total_count, $limit, $start, true);
+
+	$_CLASS['core_template']->assign_array(array(
+		$mode.'_more'				=> ($total_count < $limit) ? false : true,
+		$mode.'_pagination'			=> $pagination['formated'],
+		$mode.'_pagination_array'	=> $pagination['array'],
+	));
+}
+
+function eaccelerator_compare($x, $y)
+{
+	global $sort_by;
+
+	if ($x[$sort_by] == $y[$sort_by])
+	{
+		return 0;
+	}
+	elseif ($x[$sort_by] < $y[$sort_by])
+	{
+		return 1;
+	}
+
+	return -1;
+}
+?>
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/core.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -104,8 +104,9 @@
 load_class(false, 'core_handler');
 
 /* We're going ot use our own error handler */
+/*$_CLASS['core_handler']->start();
+
 $_CLASS['core_handler']->start();
-/*
 	$_CLASS['core_handler']->stop();
 */
 

Modified: cms/trunk/includes/cache/cache_eaccelerator.php
===================================================================
--- cms/trunk/includes/cache/cache_eaccelerator.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/cache/cache_eaccelerator.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -29,6 +29,8 @@
 		{
 			// Error here
 		}
+
+		eaccelerator_gc();
 	}
 
 	function load($name)
@@ -46,12 +48,15 @@
 	function put($name, $data, $ttl = 604800)
 	{
 		$ttl = ((int) $ttl) ? (int) $ttl : 604800;
+		$expires = gmtime() + $ttl;
 
-		if (eaccelerator_lock($this->key.$name))
+		eaccelerator_put($this->key.$name, serialize($data), $expires);
+		
+		/*if (eaccelerator_lock($this->key.$name))
 		{
-			eaccelerator_put($this->key.$name, serialize($data), $ttl);
+			eaccelerator_put($this->key.$name, serialize($data), $expires);
 			eaccelerator_unlock($this->key.$name);
-		}
+		}*/
 
 		$this->vars[$name] = $data;
 	}
@@ -66,6 +71,27 @@
 		eaccelerator_rm($this->key.$name);
 		$this->remove($name);
 	}
+
+	function destroy_all()
+	{
+		if (!function_exists('eaccelerator_list_keys'))
+		{
+			return;
+		}
+
+		$key_list = eaccelerator_list_keys();
+
+		foreach ($key_list as $key)
+		{
+			if (strpos($key['name'], $this->key) === 0)
+			{
+				$name = substr($key['name'], strlen($this->key));
+
+				eaccelerator_rm($key['name']);
+				$this->remove($name);
+			}
+		}
+	}
 }
 
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/cache/cache_file.php
===================================================================
--- cms/trunk/includes/cache/cache_file.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/cache/cache_file.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -121,7 +121,7 @@
 
 		while ($file = readdir($handle))
 		{
-			if (substr($file, 0, 6) == 'cache_')
+			if (strpos($file, 'cache_') === 0)
 			{
 				unlink($this->cache_dir . $file);
 			} 

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/display/template.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -531,6 +531,14 @@
 
 				Switch ($vars[$loop])
 				{
+					case 'LOOP_START':
+						$output = "(\$this->_loop['$loop_name']['index'] === 0)";
+					break;
+
+					case 'LOOP_END':
+						$output = "(\$this->_loop['$loop_name']['index'] === \$this->_loop['$loop_name']['count'])";
+					break;
+
 					case 'LOOP_INDEX':
 						$output = "\$this->_loop['$loop_name']['index']";
 					break;

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -22,34 +22,41 @@
 $forum_id	= request_var('f', 0);
 $parent_id	= request_var('parent_id', 0);
 
+$l_title	= '';
 $forum_data = $errors = array();
 
-// Do we have permissions?
-switch ($mode)
+if (!$_CLASS['forums_auth']->acl_get('a_forum'))
 {
-	case 'add':
-		$acl = 'a_forumadd';
-	break;
-
-	case 'delete':
-		$acl = 'a_forumdel';
-	break;
-
-	default:
-		$acl = 'a_forum';
-	break;
+	trigger_error('NO_ADMIN');
 }
 
-if (!$_CLASS['auth']->acl_get($acl))
-{
-	trigger_error('NO_ADMIN');
+switch ($action)
+{
+	case 'delete':
+		if (!$_CLASS['forums_auth']->acl_get('a_forumdel'))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_PERMISSION_FORUM_DELETE'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	break;
+
+	case 'add':
+		if (!$_CLASS['forums_auth']->acl_get('a_forumadd'))
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_PERMISSION_FORUM_ADD'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	break;
 }
 
+$_CLASS['core_template']->assign_array(array(
+	'S_EDIT_FORUM'		=> false,
+	'S_DELETE_FORUM'	=> false,
+	'S_RESYNCED'		=> false,
+));
 
 // Major routines
 if ($update)
 {
-	switch ($mode)
+	switch ($action)
 	{
 		case 'delete':
 			if (!$forum_id)
@@ -62,12 +69,16 @@
 			$action_posts		= request_var('action_posts', '');
 			$posts_to_id		= request_var('posts_to_id', 0);
 
-			delete_forum($forum_id, $action_posts, $action_subforums, $posts_to_id, $subforums_to_id);
+			$errors = delete_forum($forum_id, $action_posts, $action_subforums, $posts_to_id, $subforums_to_id);
 
-			$_CLASS['auth']->acl_clear_prefetch();
+			if (sizeof($errors))
+			{
+				break;
+			}
 
-			$show_prev_info = false;
-			trigger_error('FORUM_DELETED');
+			$_CLASS['forums_auth']->acl_clear_prefetch();
+
+			trigger_error($_CLASS['core_user']->lang['FORUM_DELETED'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
 		break;
 
 		case 'edit':
@@ -84,29 +95,37 @@
 			$forum_data += array(
 				'parent_id'				=> $parent_id,
 				'forum_type'			=> request_var('forum_type', FORUM_POST),
+				'type_action'			=> request_var('type_action', ''),
 				'forum_status'			=> request_var('forum_status', ITEM_UNLOCKED),
-				'forum_name'			=> request_var('forum_name', ''),
-				'forum_link'			=> request_var('forum_link', ''),
-				'forum_link_track'		=> request_var('forum_link_track', FALSE),
-				'forum_desc'			=> str_replace("\n", '<br />', request_var('forum_desc', '')),
-				'forum_rules'			=> request_var('forum_rules', ''),
-				'forum_rules_link'		=> request_var('forum_rules_link', ''),
-				'forum_image'			=> request_var('forum_image', ''),
-				'display_on_index'		=> request_var('display_on_index', FALSE),
-				'forum_topics_per_page'	=> request_var('topics_per_page', 0), 
-				'enable_indexing'		=> request_var('enable_indexing',true), 
-				'enable_icons'			=> request_var('enable_icons', FALSE),
-				'enable_prune'			=> request_var('enable_prune', FALSE),
-				'prune_days'			=> request_var('prune_days', 7),
-				'prune_viewed'			=> request_var('prune_viewed', 7),
-				'prune_freq'			=> request_var('prune_freq', 1),
-				'prune_old_polls'		=> request_var('prune_old_polls', FALSE),
-				'prune_announce'		=> request_var('prune_announce', FALSE),
-				'prune_sticky'			=> request_var('prune_sticky', FALSE),
-				'forum_password'		=> request_var('forum_password', ''),
+				'forum_name'			=> request_var('forum_name', '', true),
+				'forum_link'			=> request_var('forum_link', ''),
+				'forum_link_track'		=> request_var('forum_link_track', false),
+				'forum_desc'			=> request_var('forum_desc', '', true),
+				'forum_desc_uid'		=> '',
+				'forum_desc_options'	=> 0,
+				'forum_desc_bitfield'	=> '',
+				'forum_rules'			=> request_var('forum_rules', '', true),
+				'forum_rules_uid'		=> '',
+				'forum_rules_options'	=> 0,
+				'forum_rules_bitfield'	=> '',
+				'forum_rules_link'		=> request_var('forum_rules_link', ''),
+				'forum_image'			=> request_var('forum_image', ''),
+				'display_on_index'		=> request_var('display_on_index', false),
+				'forum_topics_per_page'	=> request_var('topics_per_page', 0), 
+				'enable_indexing'		=> request_var('enable_indexing',true), 
+				'enable_icons'			=> request_var('enable_icons', false),
+				'enable_prune'			=> request_var('enable_prune', false),
+				'enable_post_review'	=> request_var('enable_post_review', true),
+				'prune_days'			=> request_var('prune_days', 7),
+				'prune_viewed'			=> request_var('prune_viewed', 7),
+				'prune_freq'			=> request_var('prune_freq', 1),
+				'prune_old_polls'		=> request_var('prune_old_polls', false),
+				'prune_announce'		=> request_var('prune_announce', false),
+				'prune_sticky'			=> request_var('prune_sticky', false),
+				'forum_password'		=> request_var('forum_password', ''),
 				'forum_password_confirm'=> request_var('forum_password_confirm', ''),
 			);
-	
+
 			if ($mode === 'add')
 			{
 				$forum_data += array(
@@ -116,1524 +135,1348 @@
 				);
 			}
 
-			if ($forum_data['forum_rules'])
-			{
-				require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
+			$forum_data['show_active'] = ($forum_data['forum_type'] == FORUM_POST) ? request_var('display_recent', false) : request_var('display_active', false);
 
-				$allow_bbcode = request_var('parse_bbcode', false);
-				$allow_smilies = request_var('parse_smilies', false);
-				$allow_urls = request_var('parse_urls', false);
-
-				$forum_data['forum_rules_flags'] = (($allow_bbcode) ? 1 : 0) + (($allow_smilies) ? 2 : 0) + (($allow_urls) ? 4 : 0);
-
-				$message_parser = new parse_message($forum_data['forum_rules']);
-				$message_parser->parse(false, $allow_bbcode, $allow_urls, $allow_smilies);
-			
-				$forum_data['forum_rules'] = $message_parser->message;
-				$forum_data['forum_rules_bbcode_uid'] = $message_parser->bbcode_uid;
-				$forum_data['forum_rules_bbcode_bitfield'] = $message_parser->bbcode_bitfield;
-				unset($message_parser);
+			// Get data for forum rules if specified...
+			if ($forum_data['forum_rules'])
+			{
+				generate_text_for_storage($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options'], request_var('rules_parse_bbcode', false), request_var('rules_parse_urls', false), request_var('rules_parse_smilies', false));
 			}
 
-			$errors = update_forum_data($forum_data);
-
-			if ($errors)
-			{
-				break;
+			// Get data for forum description if specified
+			if ($forum_data['forum_desc'])
+			{
+				generate_text_for_storage($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options'], request_var('desc_parse_bbcode', false), request_var('desc_parse_urls', false), request_var('desc_parse_smilies', false));
 			}
 
-			$_CLASS['auth']->acl_clear_prefetch();
+			$_CLASS['core_db']->transaction();
+				$errors = update_forum_data($forum_data);
+			$_CLASS['core_db']->transaction('commit');
 
-			// Redirect to permissions
-			$message = ($mode === 'add') ? $_CLASS['core_user']->lang['FORUM_CREATED'] : $_CLASS['core_user']->lang['FORUM_UPDATED'];
-			$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['REDIRECT_ACL'], '<a href="'.generate_link('forums&amp;file=admin_permissions&amp;mode=forum&amp;submit_usergroups=true&amp;ug_type=forum&amp;action=usergroups&amp;f[forum][]=' . $forum_data['forum_id'], array('admin' => true)) . '">', '</a>');
-			$show_prev_info = ($mode == 'edit') ? true : false;
-
-			trigger_error($message);
+			if (!sizeof($errors))
+			{
+				$forum_perm_from = request_var('forum_perm_from', 0);
+
+				// Copy permissions?
+				if ($forum_perm_from)
+				{
+					// if we edit a forum delete current permissions first
+					if ($action === 'edit')
+					{
+						$sql = 'DELETE FROM ' . FORUMS_ACL_TABLE . '
+							WHERE forum_id = ' . (int) $forum_data['forum_id'];
+						$_CLASS['core_db']->query($sql);
+					}
+
+					// From the mysql documentation:
+					// Prior to MySQL 4.0.14, the target table of the INSERT statement cannot appear in the FROM clause of the SELECT part of the query. This limitation is lifted in 4.0.14.
+					// Due to this we stay on the safe side if we do the insertion "the manual way"
+
+					// Copy permisisons from/to the acl users table (only forum_id gets changed)
+					$sql = 'SELECT user_id, group_id, auth_option_id, auth_role_id, auth_setting
+						FROM ' . FORUMS_ACL_TABLE . '
+						WHERE forum_id = ' . $forum_perm_from;
+					$result = $_CLASS['core_db']->query($sql);
+
+					$sql_array = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$sql_array[] = array(
+							'user_id'			=> (int) $row['user_id'],
+							'group_id'			=> (int) $row['group_id'],
+							'forum_id'			=> (int) $forum_data['forum_id'],
+							'auth_option_id'	=> (int) $row['auth_option_id'],
+							'auth_role_id'		=> (int) $row['auth_role_id'],
+							'auth_setting'		=> (int) $row['auth_setting']
+						);
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					// Now insert the data
+					if (!empty($sql_array))
+					{
+						$_CLASS['core_db']->sql_query_build('MULTI_INSERT', $sql_array, FORUMS_ACL_TABLE);
+						unset($sql_array);
+					}
+				}
+
+				$_CLASS['forums_auth']->acl_clear_prefetch();
+
+				$acl_url = '&amp;mode=setting_forum_local&amp;forum_id[]=' . $forum_data['forum_id'] . '&amp;select_all_groups=1';
+
+				$message = ($action == 'add') ? $_CLASS['core_user']->lang['FORUM_CREATED'] : $_CLASS['core_user']->lang['FORUM_UPDATED'];
+
+				// Redirect to permissions
+				if ($_CLASS['forums_auth']->acl_get('a_fauth'))
+				{
+					$message .= '<br /><br />' . sprintf($_CLASS['core_user']->lang['REDIRECT_ACL'], '<a href="' . generate_link('forums&amp;i=permissions'. $acl_url, array('admin' => true)) . '">', '</a>');
+				}
+
+				// redirect directly to permission settings screen if authed
+				if ($action === 'add' && !$forum_perm_from && $_CLASS['forums_auth']->acl_get('a_fauth'))
+				{
+					$_CLASS['core_display']->meta_refresh(4, generate_link('forums&amp;i=permissions'. $acl_url, array('admin' => true)));
+				}
+
+				trigger_error($message . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+			}
 		break;
 	}
 }
 
-switch ($mode)
+switch ($action)
 {
+	case 'move_up':
+	case 'move_down':
+	
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	
+		$sql = 'SELECT *
+			FROM ' . FORUMS_FORUMS_TABLE . "
+			WHERE forum_id = $forum_id";
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+	
+		if (!$row)
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	
+		$move_forum_name = move_forum_by($row, $action, 1);
+	
+		if ($move_forum_name !== false)
+		{
+			add_log('admin', 'LOG_FORUM_' . strtoupper($action), $row['forum_name'], $move_forum_name);
+		}
+	
+	break;
+	
+	case 'sync':
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	
+		$sql = 'SELECT forum_name, forum_type
+			FROM ' . FORUMS_FORUMS_TABLE . "
+			WHERE forum_id = $forum_id";
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+	
+		if (!$row)
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+	
+		sync('forum', 'forum_id', $forum_id);
+		add_log('admin', 'LOG_FORUM_SYNC', $row['forum_name']);
+	
+		$_CLASS['core_template']->assign('L_FORUM_RESYNCED', sprintf($_CLASS['core_user']->lang['FORUM_RESYNCED'], $row['forum_name']));
+	
+	break;
+
 	case 'add':
 	case 'edit':
-		if ($update)
-		{
-			extract($forum_data);
+		if ($update)
+		{
+			$forum_data['forum_flags'] = 0;
+			$forum_data['forum_flags'] += (request_var('forum_link_track', false)) ? 1 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_old_polls', false)) ? 2 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_announce', false)) ? 4 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_sticky', false)) ? 8 : 0;
+			$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
+			$forum_data['forum_flags'] += (request_var('enable_post_review', true)) ? 32 : 0;
 		}
-		else
-		{
-			$forum_id				= request_var('f', 0);
-			$parent_id				= request_var('parent_id', 0);
-			$style_id				= request_var('style_id', 0);
-			$forum_type				= request_var('forum_type', FORUM_POST);
-			$forum_status			= request_var('forum_status', ITEM_UNLOCKED);
-			$forum_desc				= request_var('forum_desc', '');
-			$forum_name				= request_var('forum_name', '');
-			$forum_rules_link		= request_var('forum_rules_link', '');
-			$forum_rules			= request_var('forum_rules', '');
-			$forum_password			= request_var('forum_password', '');
-			$forum_password_confirm	= request_var('forum_password_confirm', '');
 
-			$forum_rules_flags		= 0;
-			$forum_rules_flags		+= (request_var('parse_bbcode', false)) ? 1 : 0;
-			$forum_rules_flags		+= (request_var('parse_smilies', false)) ? 2 : 0;
-			$forum_rules_flags		+= (request_var('parse_urls', false)) ? 4 : 0;
+		// Show form to create/modify a forum
+		if ($action == 'edit')
+		{
+			$l_title = 'EDIT_FORUM';
+			$row = get_forum_info($forum_id);
+			$old_forum_type = $row['forum_type'];
+
+			if (!$update)
+			{
+				$forum_data = $row;
+			}
+
+			// Make sure there is no forum displayed for parents_list having the current forum id as a parent...
+			$sql = 'SELECT forum_id
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE parent_id = ' . $forum_id;
+			$result = $_CLASS['core_db']->query($sql);
+
+			$exclude_forums = array($forum_id);
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$exclude_forums[] = $row['forum_id'];
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$parents_list = make_forum_select($forum_data['parent_id'], $exclude_forums, false, false, false);
+
+			$forum_data['forum_password_confirm'] = $forum_data['forum_password'];
 		}
-		
-		// Show form to create/modify a forum
-		if ($mode == 'edit')
-		{
-			$l_title = $_CLASS['core_user']->lang['EDIT_FORUM'];
-			$forum_data = get_forum_info($forum_id);
+		else
+		{
+			$l_title = 'CREATE_FORUM';
+
+			$forum_id = $parent_id;
+			$parents_list = make_forum_select($parent_id, false, false, false, false);
+
+			// Fill forum data with default values
+			if (!$update)
+			{
+				$forum_data = array(
+					'parent_id'				=> $parent_id,
+					'forum_type'			=> FORUM_POST,
+					'forum_status'			=> ITEM_UNLOCKED,
+					'forum_name'			=> request_var('forum_name', '', true),
+					'forum_link'			=> '',
+					'forum_link_track'		=> false,
+					'forum_desc'			=> '',
+					'forum_rules'			=> '',
+					'forum_rules_link'		=> '',
+					'forum_image'			=> '',
+					'forum_style'			=> 0,
+					'display_on_index'		=> false,
+					'forum_topics_per_page'	=> 0, 
+					'enable_indexing'		=> true, 
+					'enable_icons'			=> false,
+					'enable_prune'			=> false,
+					'prune_days'			=> 7,
+					'prune_viewed'			=> 7,
+					'prune_freq'			=> 1,
+					'forum_flags'			=> 0,
+					'forum_password'		=> '',
+					'forum_password_confirm'=> '',
+				);
+			}
+		}
+
+		$forum_rules_data = array(
+			'text'			=> $forum_data['forum_rules'],
+			'allow_bbcode'	=> true,
+			'allow_smilies'	=> true,
+			'allow_urls'	=> true
+		);
+
+		$forum_desc_data = array(
+			'text'			=> $forum_data['forum_desc'],
+			'allow_bbcode'	=> true,
+			'allow_smilies'	=> true,
+			'allow_urls'	=> true
+		);
+
+		$forum_rules_preview = '';
+
+		// Parse rules if specified
+		if ($forum_data['forum_rules'])
+		{
+			if (!isset($forum_data['forum_rules_uid']))
+			{
+				// Before we are able to display the preview and plane text, we need to parse our request_var()'d value...
+				$forum_data['forum_rules_uid'] = '';
+				$forum_data['forum_rules_bitfield'] = '';
+				$forum_data['forum_rules_options'] = 0;
+
+				generate_text_for_storage($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options'], request_var('rules_allow_bbcode', false), request_var('rules_allow_urls', false), request_var('rules_allow_smiliess', false));
+			}
+
+			// Generate preview content
+			$forum_rules_preview = generate_text_for_display($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options']);
+
+			// decode...
+			$forum_rules_data = generate_text_for_edit($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_options']);
+		}
+
+		// Parse desciption if specified
+		if ($forum_data['forum_desc'])
+		{
+			if (!isset($forum_data['forum_desc_uid']))
+			{
+				// Before we are able to display the preview and plane text, we need to parse our request_var()'d value...
+				$forum_data['forum_desc_uid'] = '';
+				$forum_data['forum_desc_bitfield'] = '';
+				$forum_data['forum_desc_options'] = 0;
+
+				generate_text_for_storage($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options'], request_var('desc_allow_bbcode', false), request_var('desc_allow_urls', false), request_var('desc_allow_smiliess', false));
+			}
+
+			// decode...
+			$forum_desc_data = generate_text_for_edit($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_options']);
+		}
+
+		$forum_type_options = '';
+		$forum_type_ary = array(FORUM_CAT => 'CAT', FORUM_POST => 'FORUM', FORUM_LINK => 'LINK');
+
+		foreach ($forum_type_ary as $value => $lang)
+		{
+			$forum_type_options .= '<option value="' . $value . '"' . (($value == $forum_data['forum_type']) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['TYPE_' . $lang] . '</option>';
+		}
+
+		$statuslist = '<option value="' . ITEM_UNLOCKED . '"' . (($forum_data['forum_status'] == ITEM_UNLOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['UNLOCKED'] . '</option><option value="' . ITEM_LOCKED . '"' . (($forum_data['forum_status'] == ITEM_LOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['LOCKED'] . '</option>';
+
+		$sql = 'SELECT forum_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_type = ' . FORUM_POST . "
+				AND forum_id <> $forum_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'S_MOVE_FORUM_OPTIONS'		=> make_forum_select($forum_data['parent_id'], $forum_id, false, true, false))
+			);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		$s_show_display_on_index = false;
+
+		if ($forum_data['parent_id'] > 0)
+		{
+			// if this forum is a subforum put the "display on index" checkbox
+			if ($parent_info = get_forum_info($forum_data['parent_id']))
+			{
+				if ($parent_info['parent_id'] > 0 || $parent_info['forum_type'] == FORUM_CAT)
+				{
+					$s_show_display_on_index = true;
+				}
+			}
+		}
+
+		$_CLASS['core_template']->assign_array(array(
+			'S_EDIT_FORUM'		=> true,
+			'S_ERROR'			=> (sizeof($errors)) ? true : false,
+			'S_PARENT_ID'		=> $parent_id,
+			'S_FORUM_PARENT_ID'	=> $forum_data['parent_id'],
+			'S_ADD_ACTION'		=> ($action === 'add') ? true : false,
+
+			'U_BACK'		=> generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true)),
+			'U_EDIT_ACTION'	=> generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id . "&amp;action=$action&amp;f=$forum_id", array('admin' => true)),
+
+			'L_COPY_PERMISSIONS_EXPLAIN'	=> $_CLASS['core_user']->get_lang('COPY_PERMISSIONS_' . strtoupper($action) . '_EXPLAIN'),
+			'ERROR_MSG'						=> (sizeof($errors)) ? implode('<br />', $errors) : '',
+
+			'FORUM_NAME'				=> $forum_data['forum_name'],
+			'FORUM_DATA_LINK'			=> $forum_data['forum_link'],
+			'FORUM_IMAGE'				=> $forum_data['forum_image'],
+			'FORUM_IMAGE_SRC'			=> ($forum_data['forum_image']) ? $forum_data['forum_image'] : '',
+			'FORUM_POST'				=> FORUM_POST,
+			'FORUM_LINK'				=> FORUM_LINK,
+			'FORUM_CAT'					=> FORUM_CAT,
+			'PRUNE_FREQ'				=> $forum_data['prune_freq'],
+			'PRUNE_DAYS'				=> $forum_data['prune_days'],
+			'PRUNE_VIEWED'				=> $forum_data['prune_viewed'],
+			'TOPICS_PER_PAGE'			=> $forum_data['forum_topics_per_page'],
+			'FORUM_PASSWORD'			=> $forum_data['forum_password'],
+			'FORUM_PASSWORD_CONFIRM'	=> $forum_data['forum_password_confirm'],
+			'FORUM_RULES_LINK'			=> $forum_data['forum_rules_link'],
+			'FORUM_RULES'				=> $forum_data['forum_rules'],
+			'FORUM_RULES_PREVIEW'		=> $forum_rules_preview,
+			'FORUM_RULES_PLAIN'			=> $forum_rules_data['text'],
+			'S_BBCODE_CHECKED'			=> ($forum_rules_data['allow_bbcode']) ? true : false,
+			'S_SMILIES_CHECKED'			=> ($forum_rules_data['allow_smilies']) ? true : false,
+			'S_URLS_CHECKED'			=> ($forum_rules_data['allow_urls']) ? true : false,
+
+			'FORUM_DESC'				=> $forum_desc_data['text'],
+			'S_DESC_BBCODE_CHECKED'		=> ($forum_desc_data['allow_bbcode']) ? true : false,
+			'S_DESC_SMILIES_CHECKED'	=> ($forum_desc_data['allow_smilies']) ? true : false,
+			'S_DESC_URLS_CHECKED'		=> ($forum_desc_data['allow_urls']) ? true : false,
+
+			'S_FORUM_TYPE_OPTIONS'		=> $forum_type_options,
+			'S_PARENT_OPTIONS'			=> $parents_list,
+			'S_STATUS_OPTIONS'			=> $statuslist,
+			'S_FORUM_OPTIONS'			=> make_forum_select(($action === 'add') ? $forum_data['parent_id'] : false, false, false, false, false),
+			'S_SHOW_DISPLAY_ON_INDEX'	=> $s_show_display_on_index,
+			'S_FORUM_POST'				=> ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+			'S_FORUM_ORIG_POST'			=> (isset($old_forum_type) && $old_forum_type == FORUM_POST) ? true : false,
+			'S_FORUM_LINK'				=> ($forum_data['forum_type'] == FORUM_LINK) ? true : false,
+			'S_FORUM_CAT'				=> ($forum_data['forum_type'] == FORUM_CAT) ? true : false,
+			'S_ENABLE_INDEXING'			=> ($forum_data['enable_indexing']) ? true : false,
+			'S_TOPIC_ICONS'				=> ($forum_data['enable_icons']) ? true : false,
+			'S_DISPLAY_ON_INDEX'		=> ($forum_data['display_on_index']) ? true : false,
+			'S_PRUNE_ENABLE'			=> ($forum_data['enable_prune']) ? true : false,
+			'S_FORUM_LINK_TRACK'		=> ($forum_data['forum_flags'] & 1) ? true : false,
+			'S_PRUNE_OLD_POLLS'			=> ($forum_data['forum_flags'] & 2) ? true : false,
+			'S_PRUNE_ANNOUNCE'			=> ($forum_data['forum_flags'] & 4) ? true : false,
+			'S_PRUNE_STICKY'			=> ($forum_data['forum_flags'] & 8) ? true : false,
+			'S_DISPLAY_ACTIVE_TOPICS'	=> ($forum_data['forum_flags'] & 16) ? true : false,
+			'S_ENABLE_POST_REVIEW'		=> ($forum_data['forum_flags'] & 32) ? true : false,
+			)
+		);
 
-			if (!isset($_POST['forum_type']))
-			{
-				extract($forum_data);
-			}
-			else
-			{
-				$old_forum_type = $forum_data['forum_type'];
-			}
-			unset($forum_data);
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang($l_title), 'modules/forums/admin/acp_forums.html');
+
+		return;
+
+	break;
+
+	case 'delete':
+
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']->lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true))));
+		}
+
+		$forum_data = get_forum_info($forum_id);
+
+		$subforums_id = array();
+
+		$subforums = get_forum_branch($forum_id, 'children');
+		foreach ($subforums as $row)
+		{
+			$subforums_id[] = $row['forum_id'];
+		}
+
+		$forums_list = make_forum_select($forum_data['parent_id'], $subforums_id);
+
+		$sql = 'SELECT forum_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_type = ' . FORUM_POST . "
+				AND forum_id <> $forum_id";
+		$result = $_CLASS['core_db']->query($sql);
+
+		if ($_CLASS['core_db']->fetch_row_assoc($result))
+		{
+			$_CLASS['core_template']->assign_array(array(
+				'S_MOVE_FORUM_OPTIONS'		=> make_forum_select($forum_data['parent_id'], $subforums_id)) // , false, true, false???
+			);
+		}
+		$_CLASS['core_db']->free_result($result);
+
+		$parent_id = ($parent_id == $forum_id) ? 0 : $parent_id;
+
+		$_CLASS['core_template']->assign_array(array(
+			'S_DELETE_FORUM'		=> true,
+			'U_ACTION'				=> generate_link("forums&amp;file=admin_forums&amp;parent_id=$parent_id&amp;parent_id={$parent_id}&amp;action=delete&amp;f=$forum_id", array('admin' => true)),
+			'U_BACK'				=> generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true)),
+
+			'FORUM_NAME'			=> $forum_data['forum_name'],
+			'S_FORUM_POST'			=> ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+			'S_HAS_SUBFORUMS'		=> ($forum_data['right_id'] - $forum_data['left_id'] > 1) ? true : false,
+			'S_FORUMS_LIST'			=> $forums_list,
+			'S_ERROR'				=> (sizeof($errors)) ? true : false,
+			'ERROR_MSG'				=> (sizeof($errors)) ? implode('<br />', $errors) : '')
+		);
 
-			$parents_list = make_forum_select($parent_id, $forum_id, false, false, false);
-			$forums_list = make_forum_select($parent_id, $forum_id, false, true, false);
+		$_CLASS['core_display']->display($_CLASS['core_user']->get_lang($l_title), 'modules/forums/admin/acp_forums.html');
+
+		return;
+	break;
+}
+
+// Default management page
+if (!$parent_id)
+{
+	$navigation = $_CLASS['core_user']->lang['FORUM_INDEX'];
+}
+else
+{
+	$navigation = '<a href="' . generate_link('forums&amp;file=admin_forums', array('admin' => true)) . '">' . $_CLASS['core_user']->lang['FORUM_INDEX'] . '</a>';
+
+	$forums_nav = get_forum_branch($parent_id, 'parents', 'descending');
+	foreach ($forums_nav as $row)
+	{
+		if ($row['forum_id'] == $parent_id)
+		{
+			$navigation .= ' -&gt; ' . $row['forum_name'];
+		}
+		else
+		{
+			$navigation .= ' -&gt; <a href="' . generate_link('forums&amp;file=admin_forums&amp;parent_id='.$row['forum_id'], array('admin' => true)) . '">' . $row['forum_name'] . '</a>';
+		}
+	}
+}
+
+// Jumpbox
+$forum_box = make_forum_select($parent_id, false, false, false, false); //make_forum_select($parent_id);
+
+if ($action == 'sync')
+{
+	$_CLASS['core_template']->assign('S_RESYNCED', true);
+}
+
+$sql = 'SELECT *
+	FROM ' . FORUMS_FORUMS_TABLE . "
+	WHERE parent_id = $parent_id
+	ORDER BY left_id";
+$result = $_CLASS['core_db']->query($sql);
+
+if ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+{
+	$_CLASS['core_template']->assign('S_NO_FORUMS', false);
 
-			$forum_password_confirm = $forum_password;
+	do
+	{
+		$forum_type = $row['forum_type'];
+
+		if ($row['forum_status'] == ITEM_LOCKED)
+		{
+			$folder_image = '<img src="modules/forums/images/admin/icon_folder_lock.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['LOCKED'] . '" />';
+		}
+		else
+		{
+			switch ($forum_type)
+			{
+				case FORUM_LINK:
+					$folder_image = '<img src="modules/forums/images/admin/icon_folder_link.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['LINK'] . '" />';
+				break;
+
+				default:
+					$folder_image = ($row['left_id'] + 1 != $row['right_id']) ? '<img src="modules/forums/images/admin/icon_subfolder.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['SUBFORUM'] . '" />' : '<img src="modules/forums/images/admin/icon_folder.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['FOLDER'] . '" />';
+				break;
+			}
+		}
+
+		$url = "forums&amp;file=admin_forums&amp;parent_id=&amp;parent_id=$parent_id&amp;f={$row['forum_id']}";
+
+		$forum_title = ($forum_type != FORUM_LINK) ? '<a href="' . generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' => true)) . '">' : '';
+		$forum_title .= $row['forum_name'];
+		$forum_title .= ($forum_type != FORUM_LINK) ? '</a>' : '';
+
+		$_CLASS['core_template']->assign_vars_array('forums', array(
+			'FOLDER_IMAGE'		=> $folder_image,
+			'FORUM_NAME'		=> $row['forum_name'],
+			'FORUM_DESCRIPTION'	=> generate_text_for_display($row['forum_desc'], $row['forum_desc_uid'], $row['forum_desc_bitfield'], $row['forum_desc_options']),
+			'FORUM_TOPICS'		=> $row['forum_topics'],
+			'FORUM_POSTS'		=> $row['forum_posts'],
+
+			'S_FORUM_LINK'		=> ($forum_type == FORUM_LINK) ? true : false,
+			'S_FORUM_POST'		=> ($forum_type == FORUM_POST) ? true : false,
+
+			'U_FORUM'			=> generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' => true)),
+			'U_MOVE_UP'			=> generate_link($url . '&amp;action=move_up', array('admin' => true)),
+			'U_MOVE_DOWN'		=> generate_link($url . '&amp;action=move_down', array('admin' => true)),
+			'U_EDIT'			=> generate_link($url . '&amp;action=edit', array('admin' => true)),
+			'U_DELETE'			=> generate_link($url . '&amp;action=delete', array('admin' => true)),
+			'U_SYNC'			=> generate_link($url . '&amp;action=sync', array('admin' => true))
+		));
+	}
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result));
+}
+elseif ($parent_id)
+{
+	$row = get_forum_info($parent_id);
+
+	$url = 'forums&amp;file=admin_forums&amp;parent_id=' . $parent_id . '&amp;f=' . $row['forum_id'];
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_NO_FORUMS'		=> true,
+
+		'U_EDIT'			=> generate_link($url . '&amp;action=edit', array('admin' => true)),
+		'U_DELETE'			=> generate_link($url . '&amp;action=delete', array('admin' => true)),
+		'U_SYNC'			=> generate_link($url . '&amp;action=sync', array('admin' => true))
+	));
+}
+$_CLASS['core_db']->free_result($result);
+
+$_CLASS['core_template']->assign_array(array(
+	'ERROR_MSG'		=> (sizeof($errors)) ? implode('<br />', $errors) : '',
+	'NAVIGATION'	=> $navigation,
+	'FORUM_BOX'		=> $forum_box,
+	'U_SEL_ACTION'	=> generate_link('forums&amp;file=admin_forums', array('admin' => true)),
+	'U_ACTION'		=> generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $parent_id, array('admin' => true))
+));
 
-			$bbcode_checked		= ($forum_rules_flags & 1) ? ' checked="checked"' : '';
-			$smilies_checked	= ($forum_rules_flags & 2) ? ' checked="checked"' : '';
-			$urls_checked		= ($forum_rules_flags & 4) ? ' checked="checked"' : '';
-		}
-		else
-		{
-			$l_title = $_CLASS['core_user']->lang['CREATE_FORUM'];
+$_CLASS['core_display']->display($_CLASS['core_user']->get_lang($l_title), 'modules/forums/admin/acp_forums.html');
 
-			$forum_id = $parent_id;
-			$parents_list = make_forum_select($parent_id, false, false, false, false);
+
+/**
+* Get forum details
+*/
+function get_forum_info($forum_id)
+{
+	global $_CLASS;
+
+	$sql = 'SELECT *
+		FROM ' . FORUMS_FORUMS_TABLE . "
+		WHERE forum_id = $forum_id";
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	if (!$row)
+	{
+		trigger_error("Forum #$forum_id does not exist", E_USER_ERROR);
+	}
+
+	return $row;
+}
+
+/**
+* Update forum data
+*/
+function update_forum_data(&$forum_data)
+{
+	global $_CLASS;
+
+	$errors = array();
+
+	if (!$forum_data['forum_name'])
+	{
+		$errors[] = $_CLASS['core_user']->lang['FORUM_NAME_EMPTY'];
+	}
+
+	if ($forum_data['forum_password'] || $forum_data['forum_password_confirm'])
+	{
+		if ($forum_data['forum_password'] != $forum_data['forum_password_confirm'])
+		{
+			$forum_data['forum_password'] = $forum_data['forum_password_confirm'] = '';
+			$errors[] = $_CLASS['core_user']->lang['FORUM_PASSWORD_MISMATCH'];
+		}
+	}
+
+	if ($forum_data['prune_days'] < 0 || $forum_data['prune_viewed'] < 0 || $forum_data['prune_freq'] < 0)
+	{
+		$forum_data['prune_days'] = $forum_data['prune_viewed'] = $forum_data['prune_freq'] = 0;
+		$errors[] = $_CLASS['core_user']->lang['FORUM_DATA_NEGATIVE'];
+	}
+
+	// Set forum flags
+	// 1 = link tracking
+	// 2 = prune old polls
+	// 4 = prune announcements
+	// 8 = prune stickies
+	// 16 = show active topics
+	// 32 = enable post review
+	$forum_data['forum_flags'] = 0;
+	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? 1 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? 2 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? 4 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? 8 : 0;
+	$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
+	$forum_data['forum_flags'] += ($forum_data['enable_post_review']) ? 32 : 0;
+
+	// Unset data that are not database fields
+	$forum_data_sql = $forum_data;
+
+	unset($forum_data_sql['forum_link_track']);
+	unset($forum_data_sql['prune_old_polls']);
+	unset($forum_data_sql['prune_announce']);
+	unset($forum_data_sql['prune_sticky']);
+	unset($forum_data_sql['show_active']);
+	unset($forum_data_sql['enable_post_review']);
+	unset($forum_data_sql['forum_password_confirm']);
+
+	// What are we going to do tonight Brain? The same thing we do everynight,
+	// try to take over the world ... or decide whether to continue update
+	// and if so, whether it's a new forum/cat/link or an existing one
+	if (sizeof($errors))
+	{
+		return $errors;
+	}
+
+	if (!isset($forum_data_sql['forum_id']))
+	{
+		// no forum_id means we're creating a new forum
+		unset($forum_data_sql['type_action']);
+
+		if ($forum_data_sql['parent_id'])
+		{
+			$sql = 'SELECT left_id, right_id
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $forum_data_sql['parent_id'];
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if (!$row)
+			{
+				trigger_error($_CLASS['core_user']->lang['PARENT_NOT_EXIST'] . adm_back_link(u_action . '&amp;' . $parent_id));
+			}
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+				SET left_id = left_id + 2, right_id = right_id + 2
+				WHERE left_id > ' . $row['right_id'];
+			$_CLASS['core_db']->query($sql);
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+				SET right_id = right_id + 2
+				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
+			$_CLASS['core_db']->query($sql);
+
+			$forum_data_sql['left_id'] = $row['right_id'];
+			$forum_data_sql['right_id'] = $row['right_id'] + 1;
+		}
+		else
+		{
+			$sql = 'SELECT MAX(right_id) AS right_id
+				FROM ' . FORUMS_FORUMS_TABLE;
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			$forum_data_sql['left_id'] = $row['right_id'] + 1;
+			$forum_data_sql['right_id'] = $row['right_id'] + 2;
+		}
+
+		$_CLASS['core_db']->sql_query_build('INSERT', $forum_data_sql, FORUMS_FORUMS_TABLE);
+		$forum_data['forum_id'] = $_CLASS['core_db']->insert_id(FORUMS_FORUMS_TABLE, 'forum_id');
+
+		add_log('admin', 'LOG_FORUM_ADD', $forum_data['forum_name']);
+	}
+	else
+	{
+		$row = get_forum_info($forum_data_sql['forum_id']);
+
+		if ($row['forum_type'] == FORUM_POST && $row['forum_type'] != $forum_data_sql['forum_type'])
+		{
+			// we're turning a postable forum into a non-postable forum
+			if ($forum_data_sql['type_action'] == 'move')
+			{
+				$to_forum_id = request_var('to_forum_id', 0);
+
+				if ($to_forum_id)
+				{
+					$errors = move_forum_content($forum_data_sql['forum_id'], $to_forum_id);
+				}
+				else
+				{
+					return array($_CLASS['core_user']->lang['NO_DESTINATION_FORUM']);
+				}
+			}
+			else if ($forum_data_sql['type_action'] == 'delete')
+			{
+				$errors = delete_forum_content($forum_data_sql['forum_id']);
+			}
+			else
+			{
+				return array($_CLASS['core_user']->lang['NO_FORUM_ACTION']);
+			}
+
+			$forum_data_sql['forum_posts'] = $forum_data_sql['forum_topics'] = $forum_data_sql['forum_topics_real'] = 0;
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		if ($row['parent_id'] != $forum_data_sql['parent_id'])
+		{
+			$errors = move_forum($forum_data_sql['forum_id'], $forum_data_sql['parent_id']);
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		unset($forum_data_sql['type_action']);
+
+		if ($row['forum_name'] != $forum_data_sql['forum_name'])
+		{
+			// the forum name has changed, clear the parents list of child forums
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+				SET forum_parents = ''
+				WHERE left_id > " . $row['left_id'] . '
+					AND right_id < ' . $row['right_id'];
+			$_CLASS['core_db']->query($sql);
+		}
+
+		// Setting the forum id to the forum id is not really received well by some dbs. ;)
+		$forum_id = $forum_data_sql['forum_id'];
+		unset($forum_data_sql['forum_id']);
+
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $forum_data_sql) . '
+			WHERE forum_id = ' . $forum_id;
+		$_CLASS['core_db']->query($sql);
+
+		// Add it back
+		$forum_data['forum_id'] = $forum_id;
+
+		add_log('admin', 'LOG_FORUM_EDIT', $forum_data['forum_name']);
+	}
+
+	return $errors;
+}
+
+/**
+* Move forum
+*/
+function move_forum($from_id, $to_id)
+{
+	global $_CLASS;
+
+	$moved_forums = get_forum_branch($from_id, 'children', 'descending');
+	$from_data = $moved_forums[0];
+	$diff = sizeof($moved_forums) * 2;
+
+	$moved_ids = array();
+	for ($i = 0; $i < sizeof($moved_forums); ++$i)
+	{
+		$moved_ids[] = $moved_forums[$i]['forum_id'];
+	}
+
+	// Resync parents
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET right_id = right_id - $diff, forum_parents = ''
+		WHERE left_id < " . $from_data['right_id'] . "
+			AND right_id > " . $from_data['right_id'];
+	$_CLASS['core_db']->query($sql);
+
+	// Resync righthand side of tree
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET left_id = left_id - $diff, right_id = right_id - $diff, forum_parents = ''
+		WHERE left_id > " . $from_data['right_id'];
+	$_CLASS['core_db']->query($sql);
+
+	if ($to_id > 0)
+	{
+		$to_data = get_forum_info($to_id);
+
+		// Resync new parents
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+			SET right_id = right_id + $diff, forum_parents = ''
+			WHERE " . $to_data['right_id'] . ' BETWEEN left_id AND right_id
+				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		// Resync the righthand side of the tree
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+			SET left_id = left_id + $diff, right_id = right_id + $diff, forum_parents = ''
+			WHERE left_id > " . $to_data['right_id'] . '
+				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$_CLASS['core_db']->query($sql);
+
+		// Resync moved branch
+		$to_data['right_id'] += $diff;
+
+		if ($to_data['right_id'] > $from_data['right_id'])
+		{
+			$diff = '+ ' . ($to_data['right_id'] - $from_data['right_id'] - 1);
+		}
+		else
+		{
+			$diff = '- ' . abs($to_data['right_id'] - $from_data['right_id'] - 1);
+		}
+	}
+	else
+	{
+		$sql = 'SELECT MAX(right_id) AS right_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$result = $_CLASS['core_db']->query($sql);
+		$row = $_CLASS['core_db']->fetch_row_assoc($result);
+		$_CLASS['core_db']->free_result($result);
+
+		$diff = '+ ' . ($row['right_id'] - $from_data['left_id'] + 1);
+	}
+
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET left_id = left_id $diff, right_id = right_id $diff, forum_parents = ''
+		WHERE forum_id IN (" . implode(', ', $moved_ids) . ')';
+	$_CLASS['core_db']->query($sql);
+}
+
+/**
+* Move forum content from one to another forum
+*/
+function move_forum_content($from_id, $to_id, $sync = true)
+{
+	global $_CLASS;
+
+	$table_ary = array(ACL_GROUPS_TABLE, ACL_USERS_TABLE, LOG_TABLE, POSTS_TABLE, TOPICS_TABLE, DRAFTS_TABLE, TOPICS_TRACK_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$sql = "UPDATE $table
+			SET forum_id = $to_id
+			WHERE forum_id = $from_id";
+		$_CLASS['core_db']->query($sql);
+	}
+	unset($table_ary);
+
+	$table_ary = array(FORUMS_ACCESS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, MODERATOR_CACHE_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$sql = "DELETE FROM $table
+			WHERE forum_id = $from_id";
+		$_CLASS['core_db']->query($sql);
+	}
+
+	if ($sync)
+	{
+		// Delete ghost topics that link back to the same forum then resync counters
+		sync('topic_moved');
+		sync('forum', 'forum_id', $to_id);
+	}
+
+	return array();
+}
+
+/**
+* Remove complete forum
+*/
+function delete_forum($forum_id, $action_posts = 'delete', $action_subforums = 'delete', $posts_to_id = 0, $subforums_to_id = 0)
+{
+	global $_CLASS;
+
+	$forum_data = get_forum_info($forum_id);
+
+	$errors = array();
+	$log_action_posts = $log_action_forums = $posts_to_name = $subforums_to_name = '';
+	$forum_ids = array($forum_id);
+
+	if ($action_posts == 'delete')
+	{
+		$log_action_posts = 'POSTS';
+		$errors = array_merge($errors, delete_forum_content($forum_id));
+	}
+	else if ($action_posts == 'move')
+	{
+		if (!$posts_to_id)
+		{
+			$errors[] = $_CLASS['core_user']->lang['NO_DESTINATION_FORUM'];
+		}
+		else
+		{
+			$log_action_posts = 'MOVE_POSTS';
+
+			$sql = 'SELECT forum_name 
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $posts_to_id;
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if (!$row)
+			{
+				$errors[] = $_CLASS['core_user']->lang['NO_FORUM'];
+			}
+			else
+			{
+				$posts_to_name = $row['forum_name'];
+				$errors = array_merge($errors, move_forum_content($forum_id, $posts_to_id));
+			}
+		}
+	}
+
+	if (sizeof($errors))
+	{
+		return $errors;
+	}
+
+	if ($action_subforums == 'delete')
+	{
+		$log_action_forums = 'FORUMS';
+		$rows = get_forum_branch($forum_id, 'children', 'descending', false);
+
+		foreach ($rows as $row)
+		{
+			$forum_ids[] = $row['forum_id'];
+			$errors = array_merge($errors, delete_forum_content($row['forum_id']));
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		$diff = sizeof($forum_ids) * 2;
+
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
+		$_CLASS['core_db']->query($sql);
+	}
+	else if ($action_subforums == 'move')
+	{
+		if (!$subforums_to_id)
+		{
+			$errors[] = $_CLASS['core_user']->lang['NO_DESTINATION_FORUM'];
+		}
+		else
+		{
+			$log_action_forums = 'MOVE_FORUMS';
+
+			$sql = 'SELECT forum_name 
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $subforums_to_id;
+			$result = $_CLASS['core_db']->query($sql);
+			$row = $_CLASS['core_db']->fetch_row_assoc($result);
+			$_CLASS['core_db']->free_result($result);
+
+			if (!$row)
+			{
+				$errors[] = $_CLASS['core_user']->lang['NO_FORUM'];
+			}
+			else
+			{
+				$subforums_to_name = $row['forum_name'];
+
+				$sql = 'SELECT forum_id
+					FROM ' . FORUMS_FORUMS_TABLE . "
+					WHERE parent_id = $forum_id";
+				$result = $_CLASS['core_db']->query($sql);
+
+				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+				{
+					move_forum($row['forum_id'], $subforums_to_id);
+				}
+				$_CLASS['core_db']->free_result($result);
+
+				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+					SET parent_id = $subforums_to_id
+					WHERE parent_id = $forum_id";
+				$_CLASS['core_db']->query($sql);
+
+				$diff = 2;
+				$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
+					WHERE forum_id = $forum_id";
+				$_CLASS['core_db']->query($sql);
+			}
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+	}
+	else
+	{
+		$diff = 2;
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
+			WHERE forum_id = $forum_id";
+		$_CLASS['core_db']->query($sql);
+	}
+
+	// Resync tree
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET right_id = right_id - $diff
+		WHERE left_id < {$forum_data['right_id']} AND right_id > {$forum_data['right_id']}";
+	$_CLASS['core_db']->query($sql);
+
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET left_id = left_id - $diff, right_id = right_id - $diff
+		WHERE left_id > {$forum_data['right_id']}";
+	$_CLASS['core_db']->query($sql);
+
+	// Delete forum ids from extension groups table
+	$sql = 'SELECT group_id, allowed_forums 
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		if (!$row['allowed_forums'])
+		{
+			continue;
+		}
+
+		$allowed_forums = unserialize(trim($row['allowed_forums']));
+		$allowed_forums = array_diff($allowed_forums, $forum_ids);
+
+		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . " 
+			SET allowed_forums = '" . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . "'
+			WHERE group_id = {$row['group_id']}";
+		$_CLASS['core_db']->query($sql);
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	$_CLASS['core_cache']->destroy('_extensions');
+
+	$log_action = implode('_', array($log_action_posts, $log_action_forums));
+
+	switch ($log_action)
+	{
+		case 'MOVE_POSTS_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'MOVE_POSTS_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case '_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'MOVE_POSTS_':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_data['forum_name']);
+		break;
+
+		case '_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_data['forum_name']);
+		break;
+
+		default:
+			add_log('admin', 'LOG_FORUM_DEL_FORUM', $forum_data['forum_name']);
+		break;
+	}
+
+	return $errors;
+}
+
+/**
+* Delete forum content
+*/
+function delete_forum_content($forum_id)
+{
+	global $_CLASS;
+
+	require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+
+	$_CLASS['core_db']->transaction();
+
+	// Select then delete all attachments
+	$sql = 'SELECT a.topic_id
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_ATTACHMENTS_TABLE . " a
+		WHERE p.forum_id = $forum_id
+			AND a.in_message = 0
+			AND a.topic_id = p.topic_id";
+	$result = $_CLASS['core_db']->query($sql);	
+
+	$topic_ids = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$topic_ids[] = $row['topic_id'];
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	delete_attachments('topic', $topic_ids, false);
+
+	switch ($_CLASS['core_db']->db_layer)
+	{
+		case 'mysql4':
+		case 'mysqli':
+
+			// Delete everything else and thank MySQL for offering multi-table deletion
+			$tables_ary = array(
+				FORUMS_SEARCH_WORDMATCH_TABLE	=> 'post_id',
+				FORUMS_REPORTS_TABLE			=> 'post_id',
+				//WARNINGS_TABLE			=> 'post_id',
+				FORUMS_BOOKMARKS_TABLE			=> 'topic_id',
+				FORUMS_WATCH_TABLE			=> 'topic_id',
+				//TOPICS_POSTED_TABLE		=> 'topic_id',
+				FORUMS_POLL_OPTIONS_TABLE	=> 'topic_id',
+				FORUMS_POLL_VOTES_TABLE		=> 'topic_id',
+			);
+
+			$sql = 'DELETE ' . FORUMS_POSTS_TABLE;
+			$sql_using = "\nFROM " . FORUMS_POSTS_TABLE;
+			$sql_where = "\nWHERE " . FORUMS_POSTS_TABLE . ".forum_id = $forum_id\n";
+
+			foreach ($tables_ary as $table => $field)
+			{
+				$sql .= ", $table ";
+				$sql_using .= ", $table ";
+				$sql_where .= "\nAND $table.$field = " . POSTS_TABLE . ".$field";
+			}
+
+			$_CLASS['core_db']->query($sql . $sql_using . $sql_where);
+
+		break;
+
+		default:
+		
+			// Delete everything else and curse your DB for not offering multi-table deletion
+			$tables_ary = array(
+				'post_id'	=>	array(
+					FORUMS_SEARCH_WORDMATCH_TABLE,
+					FORUMS_REPORTS_TABLE,
+					//WARNINGS_TABLE,
+				),
+
+				'topic_id'	=>	array(
+					FORUMS_BOOKMARKS_TABLE,
+					FORUMS_WATCH_TABLE,
+					//TOPICS_POSTED_TABLE,
+					FORUMS_POLL_OPTIONS_TABLE,
+					FORUMS_POLL_VOTES_TABLE,
+				)
+			);
+
+			foreach ($tables_ary as $field => $tables)
+			{
+				$start = 0;
+
+				do
+				{
+					$sql = "SELECT $field
+						FROM " . FORUMS_POSTS_TABLE . '
+						WHERE forum_id = ' . $forum_id;
+					$result = $_CLASS['core_db']->query_limit($sql, 500, $start);
+
+					$ids = array();
+					while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+					{
+						$ids[] = $row[$field];
+					}
+					$_CLASS['core_db']->free_result($result);
+
+					if (sizeof($ids))
+					{
+						$start += sizeof($ids);
+
+						foreach ($tables as $table)
+						{
+							$_CLASS['core_db']->query("DELETE FROM $table WHERE $field IN (" . implode(', ', $id_list) . ')');
+						}
+					}
+				}
+				while ($row);
+			}
+			unset($ids, $id_list);
+
+		break;
+	}
+
+	$table_ary = array(FORUMS_ACL_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE, FORUMS_MODERATOR_CACHE_TABLE, FORUMS_POSTS_TABLE, FORUMS_TOPICS_TABLE);//, TOPICS_TRACK_TABLE
+
+	foreach ($table_ary as $table)
+	{
+		$_CLASS['core_db']->query("DELETE FROM $table WHERE forum_id = $forum_id");
+	}
+
+	// Set forum ids to 0
+	$table_ary = array(FORUMS_DRAFTS_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$_CLASS['core_db']->query("UPDATE $table SET forum_id = 0 WHERE forum_id = $forum_id");
+	}
+
+	$_CLASS['core_db']->transaction('commit');
+
+	// Make sure the overall post/topic count is correct...
+	$sql = 'SELECT COUNT(post_id) AS stat 
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE post_approved = 1';
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	set_config('num_posts', (int) $row['stat'], true);
+
+	$sql = 'SELECT COUNT(topic_id) AS stat
+		FROM ' . FORUMS_TOPICS_TABLE . '
+		WHERE topic_approved = 1';
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	set_config('num_topics', (int) $row['stat'], true);
+
+	$sql = 'SELECT COUNT(attach_id) as stat
+		FROM ' . FORUMS_ATTACHMENTS_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	set_config('num_files', (int) $row['stat'], true);
+
+	$sql = 'SELECT SUM(filesize) as stat
+		FROM ' . FORUMS_ATTACHMENTS_TABLE;
+	$result = $_CLASS['core_db']->query($sql);
+	$row = $_CLASS['core_db']->fetch_row_assoc($result);
+	$_CLASS['core_db']->free_result($result);
+
+	set_config('upload_dir_size', (int) $row['stat'], true);
+
+	add_log('admin', 'LOG_RESYNC_STATS');
+
+	return array();
+}
+
+/**
+* Move forum position by $steps up/down
+*/
+function move_forum_by($forum_row, $action = 'move_up', $steps = 1)
+{
+	global $_CLASS;
+
+	/**
+	* Fetch all the siblings between the module's current spot
+	* and where we want to move it to. If there are less than $steps
+	* siblings between the current spot and the target then the
+	* module will move as far as possible
+	*/
+	$sql = 'SELECT forum_id, forum_name, left_id, right_id
+		FROM ' . FORUMS_FORUMS_TABLE . "
+		WHERE parent_id = {$forum_row['parent_id']}
+			AND " . (($action == 'move_up') ? "right_id < {$forum_row['right_id']} ORDER BY right_id DESC" : "left_id > {$forum_row['left_id']} ORDER BY left_id ASC");
+	$result = $_CLASS['core_db']->query_limit($sql, $steps);
+
+	$target = array();
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$target = $row;
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	if (!sizeof($target))
+	{
+		// The forum is already on top or bottom
+		return false;
+	}
+
+	/**
+	* $left_id and $right_id define the scope of the nodes that are affected by the move.
+	* $diff_up and $diff_down are the values to substract or add to each node's left_id
+	* and right_id in order to move them up or down.
+	* $move_up_left and $move_up_right define the scope of the nodes that are moving
+	* up. Other nodes in the scope of ($left_id, $right_id) are considered to move down.
+	*/
+	if ($action == 'move_up')
+	{
+		$left_id = $target['left_id'];
+		$right_id = $forum_row['right_id'];
+
+		$diff_up = $forum_row['left_id'] - $target['left_id'];
+		$diff_down = $forum_row['right_id'] + 1 - $forum_row['left_id'];
+
+		$move_up_left = $forum_row['left_id'];
+		$move_up_right = $forum_row['right_id'];
+	}
+	else
+	{
+		$left_id = $forum_row['left_id'];
+		$right_id = $target['right_id'];
+
+		$diff_up = $forum_row['right_id'] + 1 - $forum_row['left_id'];
+		$diff_down = $target['right_id'] - $forum_row['right_id'];
+
+		$move_up_left = $forum_row['right_id'] + 1;
+		$move_up_right = $target['right_id'];
+	}
+
+	// Now do the dirty job
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+		SET left_id = left_id + CASE
+			WHEN left_id BETWEEN {$move_up_left} AND {$move_up_right} THEN -{$diff_up}
+			ELSE {$diff_down}
+		END,
+		right_id = right_id + CASE
+			WHEN right_id BETWEEN {$move_up_left} AND {$move_up_right} THEN -{$diff_up}
+			ELSE {$diff_down}
+		END,
+		forum_parents = ''
+		WHERE 
+			left_id BETWEEN {$left_id} AND {$right_id}
+			AND right_id BETWEEN {$left_id} AND {$right_id}";
+	$_CLASS['core_db']->query($sql);
+
+	return $target['forum_name'];
+}
 
-			if ($parent_id)
-			{
-				$temp_forum_desc = $forum_desc;
-				$temp_forum_name = $forum_name;
-				$temp_forum_rules = $forum_rules;
-				$temp_forum_rules_link = $forum_rules_link;
-				$temp_forum_type = $forum_type;
-
-				extract(get_forum_info($parent_id));
-				$forum_type = $temp_forum_type;
-				$forum_name = $temp_forum_name;
-				$forum_desc = $temp_forum_desc;
-				$forum_rules = $temp_forum_rules;
-				$forum_rules_link = $temp_forum_rules_link;
-				$forum_password_confirm = $forum_password;
-			}
-		}
-
-		if ($forum_rules)
-		{
-			require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
-			require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
-			
-			$message_parser = new parse_message($forum_rules);
-			if (isset($forum_rules_bbcode_uid))
-			{
-				$message_parser->bbcode_uid = $forum_rules_bbcode_uid;
-				$message_parser->bbcode_bitfield = $forum_rules_bbcode_bitfield;
-			}
-			else
-			{
-				$message_parser->parse(false, ($forum_rules_flags & 1), ($forum_rules_flags & 4), ($forum_rules_flags & 2));
-			}
-		}
-		
-		$forum_type_options = '';
-		$forum_type_ary = array(FORUM_CAT => 'CAT', FORUM_POST => 'FORUM', FORUM_LINK => 'LINK');
-		foreach ($forum_type_ary as $value => $lang)
-		{
-			$forum_type_options .= '<option value="' . $value . '"' . (($value == $forum_type) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['TYPE_' . $lang] . '</option>';
-		}
-
-		$statuslist = '<option value="' . ITEM_UNLOCKED . '"' . (($forum_status == ITEM_UNLOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['UNLOCKED'] . '</option><option value="' . ITEM_LOCKED . '"' . (($forum_status == ITEM_LOCKED) ? ' selected="selected"' : '') . '>' . $_CLASS['core_user']->lang['LOCKED'] . '</option>';
-
-		$enable_icons = isset($enable_icons) ? $enable_icons : 0;
-		$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
-		$enable_prune = isset($enable_prune) ? $enable_prune : 0;
-		$display_on_index = isset($display_on_index) ? $display_on_index : 0;
-		$forum_flags = isset($forum_flags) ? $forum_flags : 0;
-		
-		$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
-		$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
-		$urls_checked = isset($urls_checked) ? $urls_checked : false;
-		
-		$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
-		$forum_image = isset($forum_image) ? $forum_image : '';
-		$prune_freq = isset($prune_freq) ? $prune_freq : '';
-		$prune_days = isset($prune_days) ? $prune_days : '';
-		$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
-		$forum_link = isset($forum_link) ? $forum_link : '';
-		
-		$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
-
-		$indexing_yes = ($enable_indexing) ? ' checked="checked"' : '';
-		$indexing_no = (!$enable_indexing) ? ' checked="checked"' : '';
-		$topic_icons_yes = ($enable_icons) ? ' checked="checked"' : '';
-		$topic_icons_no = (!$enable_icons) ? ' checked="checked"' : '';
-		$display_index_yes = ($display_on_index) ? ' checked="checked"' : '';
-		$display_index_no = (!$display_on_index) ? ' checked="checked"' : '';
-
-		$prune_enable_yes = ($enable_prune) ? ' checked="checked"' : '';
-		$prune_enable_no = (!$enable_prune) ? ' checked="checked"' : '';
-		$prune_old_polls_yes = ($forum_flags & 2) ? ' checked="checked"' : '';
-		$prune_old_polls_no = (!($forum_flags & 2)) ? ' checked="checked"' : '';
-		$prune_announce_yes = ($forum_flags & 4) ? ' checked="checked"' : '';
-		$prune_announce_no = (!($forum_flags & 4)) ? ' checked="checked"' : '';
-		$prune_sticky_yes = ($forum_flags & 8) ? ' checked="checked"' : '';
-		$prune_sticky_no = (!($forum_flags & 8)) ? ' checked="checked"' : '';
-
-		$forum_link_track_yes = ($forum_flags & 1) ? ' checked="checked"' : '';
-		$forum_link_track_no = (!($forum_flags & 1)) ? ' checked="checked"' : '';
-
-		$navigation = '<a href="'.generate_link('forums&amp;file=admin_forums', array('admin' => true)) . '">' . $_CLASS['core_user']->lang['FORUM_INDEX'] . '</a>';
-
-		$forums_nav = get_forum_branch($forum_id, 'parents', 'descending');
-		foreach ($forums_nav as $row)
-		{
-			$navigation .= ($row['forum_id'] == $forum_id) ? ' -&gt; ' . $row['forum_name'] : ' -&gt; <a href="'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' => true)) . '">' . $row['forum_name'] . '</a>';
-		}
-
-		adm_page_header($l_title);
-
-?>
-
-<p><?php echo $_CLASS['core_user']->lang['FORUM_ADMIN_EXPLAIN'] ?></p>
-
-<h1><?php echo $l_title ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['FORUM_EDIT_EXPLAIN'] ?></p>
-
-<form method="post" name="edit" action="<?php echo generate_link('forums&amp;file=admin_forums&amp;mode='.$mode . (($forum_id) ? "&amp;f=$forum_id" : ''), array('admin' => true)); ?>"><table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
-	<tr>
-		<td class="nav"><?php echo $navigation ?></td>
-	</tr>
-</table>
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['FORUM_SETTINGS'] ?></th>
-	</tr>
-<?php
-
-		if (!empty($errors))
-		{
-
-?>
-	<tr>
-		<td class="row3" colspan="2" align="center"><span style="color:red"><?php echo implode('<br />', $errors); ?></span></td>
-	</tr>
-<?php
-
-		}
-
-?>
-	<tr>
-		<td class="row1" width="33%"><b><?php echo $_CLASS['core_user']->lang['FORUM_TYPE'] ?>: </b></td>
-		<td class="row2"><select name="forum_type" onchange="this.form.submit();"><?php echo $forum_type_options; ?></select><?php
-	
-		if ($old_forum_type == FORUM_POST && $forum_type != FORUM_POST)
-		{
-			// Forum type being changed to a non-postable type, let the user decide between
-			// deleting all posts or moving them to another forum (if applicable)
-
-?><br /><input type="radio" name="action" value="delete" checked="checked" /> <?php echo $_CLASS['core_user']->lang['DELETE_ALL_POSTS'];
-?>&nbsp;<input type="radio" name="action" value="move" /> <?php echo $_CLASS['core_user']->lang['MOVE_POSTS_TO'] ?> <select name="to_forum_id"><?php echo $forums_list ?></select><?php
-
-		}
-
-?></td>
-	</tr>
-<?php
-
-		if ($forum_type == FORUM_POST)
-		{
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_STATUS'] ?>: </b></td>
-		<td class="row2"><select name="forum_status"><?php echo $statuslist ?></select></td>
-	</tr>
-<?php
-		}
-
-?>
-	<tr>
-		<td class="row1" width="40%"><b><?php echo $_CLASS['core_user']->lang['FORUM_PARENT'] ?>: </b></td>
-		<td class="row2"><select name="parent_id"><option value="0"><?php echo $_CLASS['core_user']->lang['NO_PARENT'] ?></option><?php echo $parents_list ?></select></td>
-	</tr>
-<?php
-
-		if ($forum_type == FORUM_LINK)
-		{
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_LINK'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_LINK_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" size="40" name="forum_link" value="<?php echo $forum_link; ?>" /></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_LINK_TRACK'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_LINK_TRACK_EXPLAIN']; ?></span></td>
-		<td class="row2"><input type="radio" name="forum_link_track" value="1"<?php echo $forum_link_track_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="forum_link_track" value="0"<?php echo $forum_link_track_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-<?php
-		}
-
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_NAME']; ?>: </b></td>
-		<td class="row2"><input class="post" type="text" size="40" name="forum_name" value="<?php echo $forum_name ?>" /></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_DESC'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_DESC_EXPLAIN']; ?></span> </td>
-		<td class="row2"><textarea class="post" rows="5" cols="45" wrap="virtual" name="forum_desc"><?php echo htmlspecialchars(str_replace('<br />', "\n", $forum_desc)); ?></textarea></td>
-	</tr>
-<?php
-	if ($forum_type != FORUM_LINK)
-	{
-?>	
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_RULES_LINK']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_RULES_LINK_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" size="40" name="forum_rules_link" value="<?php echo $forum_rules_link ?>" /></td>
-	</tr>
-<?php
-	if ($forum_rules)
-	{
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_RULES_PREVIEW'] ?>: </b></td>
-		<td class="row2"><?php echo $message_parser->format_display(false, ($forum_rules_flags & 1), ($forum_rules_flags & 4), ($forum_rules_flags & 2), false); ?></td>
-	</tr>
-<?php
-	}
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_RULES'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_RULES_EXPLAIN']; ?></span></td>
-		<td class="row2"><table cellspacing="2" cellpadding="0" border="0"><tr><td colspan="6"><textarea class="post" rows="4" cols="70" name="forum_rules">
-<?php 
-		if ($forum_rules)
-		{
-			$message_parser->decode_message();
-			echo $message_parser->message;
-		}
-?></textarea></td></tr><tr>
-			<td width="10"><input type="checkbox" name="parse_bbcode"<?php echo $bbcode_checked; ?> /></td><td><?php echo $_CLASS['core_user']->lang['PARSE_BBCODE']; ?></td><td width="10"><input type="checkbox" name="parse_smilies"<?php echo $smilies_checked; ?> /></td><td><?php echo $_CLASS['core_user']->lang['PARSE_SMILIES']; ?></td><td width="10"><input type="checkbox" name="parse_urls"<?php echo $urls_checked; ?> /></td><td><?php echo $_CLASS['core_user']->lang['PARSE_URLS']; ?></td></tr></table>
-		</td>
-	</tr>
-<?php
-	}
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_IMAGE']; ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_IMAGE_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" size="40" name="forum_image" value="<?php echo $forum_image ?>" /><br /><?php
-	
-		if ($forum_image)
-		{
-			echo '<img src="' . $forum_image . '" alt="" />';
-		}
-		
-?></td>
-	</tr>
-<?php
-
-		if ($forum_type == FORUM_POST)
-		{
-
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['ENABLE_INDEXING'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['ENABLE_INDEXING_EXPLAIN'] ?></span></td>
-		<td class="row2"><input type="radio" name="enable_indexing" value="1"<?php echo $indexing_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="enable_indexing" value="0"<?php echo $indexing_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['ENABLE_TOPIC_ICONS'] ?>: </b></td>
-		<td class="row2"><input type="radio" name="enable_icons" value="1"<?php echo $topic_icons_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="enable_icons" value="0"<?php echo $topic_icons_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-<?php
-
-			if ($mode == 'edit' && $parent_id > 0)
-			{
-				// if this forum is a subforum put the "display on index" checkbox
-				if ($parent_info = get_forum_info($parent_id))
-				{
-					if ($parent_info['parent_id'] > 0 || $parent_info['forum_type'] == FORUM_CAT)
-					{
-
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['LIST_INDEX'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['LIST_INDEX_EXPLAIN']; ?></span></td>
-		<td class="row2"><input type="radio" name="display_on_index" value="1"<?php echo $display_index_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="display_on_index" value="0"<?php echo $display_index_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-<?php
-
-					}
-				}
-			}
-
-?>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_AUTO_PRUNE'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_AUTO_PRUNE_EXPLAIN']; ?></span></td>
-		<td class="row2"><input type="radio" name="enable_prune" value="1"<?php echo $prune_enable_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="enable_prune" value="0"<?php echo $prune_enable_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_FREQ'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_FREQ_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="prune_freq" value="<?php echo $prune_freq ?>" size="5" /> <?php echo $_CLASS['core_user']->lang['DAYS']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_DAYS'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_DAYS_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="prune_days" value="<?php echo $prune_days ?>" size="5" /> <?php echo $_CLASS['core_user']->lang['DAYS']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_VIEWED'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['AUTO_PRUNE_VIEWED_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="prune_viewed" value="<?php echo $prune_viewed ?>" size="5" /> <?php echo $_CLASS['core_user']->lang['DAYS']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['PRUNE_OLD_POLLS'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['PRUNE_OLD_POLLS_EXPLAIN']; ?></span></td>
-		<td class="row2"><input type="radio" name="prune_old_polls" value="1"<?php echo $prune_old_polls_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="prune_old_polls" value="0"<?php echo $prune_old_polls_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['PRUNE_ANNOUNCEMENTS'] ?>: </b></td>
-		<td class="row2"><input type="radio" name="prune_announce" value="1"<?php echo $prune_announce_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="prune_announce" value="0"<?php echo $prune_announce_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['PRUNE_STICKY'] ?>: </b></td>
-		<td class="row2"><input type="radio" name="prune_sticky" value="1"<?php echo $prune_sticky_yes; ?> /> <?php echo $_CLASS['core_user']->lang['YES']; ?> &nbsp; <input type="radio" name="prune_sticky" value="0"<?php echo $prune_sticky_no; ?> /> <?php echo $_CLASS['core_user']->lang['NO']; ?></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_TOPICS_PAGE'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_TOPICS_PAGE_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="text" name="topics_per_page" value="<?php echo $forum_topics_per_page; ?>" size="3" maxlength="3" /></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_PASSWORD'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_PASSWORD_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="password" name="forum_password" value="<?php echo $forum_password; ?>" size="25" maxlength="25" /></td>
-	</tr>
-	<tr>
-		<td class="row1"><b><?php echo $_CLASS['core_user']->lang['FORUM_PASSWORD_CONFIRM'] ?>: </b><br /><span class="gensmall"><?php echo $_CLASS['core_user']->lang['FORUM_PASSWORD_CONFIRM_EXPLAIN']; ?></span></td>
-		<td class="row2"><input class="post" type="password" name="forum_password_confirm" value="<?php echo $forum_password_confirm; ?>" size="25" maxlength="25" /></td>
-	</tr>
-<?php
-
-		}
-
-?>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input class="btnmain" name="update" type="submit" value="<?php echo $_CLASS['core_user']->lang['SUBMIT']; ?>" /> &nbsp;<input class="btnlite" type="reset" value="<?php echo $_CLASS['core_user']->lang['RESET']; ?>" /></td>
-	</tr>
-</table></form>
-
-<br clear="all" />
-
-<?php
-
-		adm_page_footer();
-		break;
-
-	case 'delete':
-
-		$forum_id = request_var('f', 0);
-
-		adm_page_header($_CLASS['core_user']->lang['MANAGE']);
-		extract(get_forum_info($forum_id));
-
-		$subforums_id = array();
-		$subforums = get_forum_branch($forum_id, 'children');
-		foreach ($subforums as $row)
-		{
-			$subforums_id[] = $row['forum_id'];
-		}
-
-		$forums_list = make_forum_select($parent_id, $subforums_id);
-		$move_posts_list = make_forum_select($parent_id, $subforums_id);
-
-?>
-
-<p><?php echo $_CLASS['core_user']->lang['FORUM_ADMIN_EXPLAIN']; ?></p>
-
-<h1><?php echo $_CLASS['core_user']->lang['FORUM_DELETE'] ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['FORUM_DELETE_EXPLAIN'] ?></p>
-
-<form action="<?php echo generate_link('forums&amp;file=admin_forums', array('admin' => true)) ?>&mode=delete&amp;f=<?php echo $forum_id ?>" method="post"><table class="tablebg" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="2"><?php echo $_CLASS['core_user']->lang['FORUM_DELETE'] ?></th>
-	</tr>
-	<tr>
-		<td class="row1"><?php echo $_CLASS['core_user']->lang['FORUM_NAME']; ?>: </td>
-		<td class="row1"><b><?php echo $forum_name ?></b></td>
-	</tr>
-<?php
-
-	if ($forum_type == FORUM_POST)
-	{
-
-?>
-	<tr>
-		<td class="row1"><?php echo $_CLASS['core_user']->lang['ACTION'] ?>: </td>
-		<td class="row1"><table cellspacing="0" cellpadding="2" border="0">
-			<tr>
-				<td><input type="radio" name="action_posts" value="delete" checked="checked" /> <?php echo $_CLASS['core_user']->lang['DELETE_ALL_POSTS'] ?></td>
-			</tr>
-<?php
-
-			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_type = ' . FORUM_POST . "
-					AND forum_id <> $forum_id";
-			$result = $_CLASS['core_db']->query($sql);
-
-			if ($_CLASS['core_db']->fetch_row_assoc($result))
-			{
-
-?>
-			<tr>
-				<td><input type="radio" name="action_posts" value="move" /> <?php echo $_CLASS['core_user']->lang['MOVE_POSTS_TO'] ?> <select name="posts_to_id" ?><?php echo $move_posts_list ?></select></td>
-			</tr>
-<?php
-
-			}
-
-?>
-		</table></td>
-	</tr>
-<?php
-
-	}
-
-	if ($right_id - $left_id > 1)
-	{
-
-?>
-	<tr>
-		<td class="row1"><?php echo $_CLASS['core_user']->lang['ACTION'] ?>:</td>
-		<td class="row1"><table cellspacing="0" cellpadding="2" border="0">
-			<tr>
-				<td><input type="radio" name="action_subforums" value="delete" checked="checked" /> <?php echo $_CLASS['core_user']->lang['DELETE_SUBFORUMS'] ?></td>
-			</tr>
-			<tr>
-				<td><input type="radio" name="action_subforums" value="move" /> <?php echo $_CLASS['core_user']->lang['MOVE_SUBFORUMS_TO'] ?> <select name="subforums_to_id" ?><?php echo $forums_list ?></select></td>
-			</tr>
-		</table></td>
-	</tr>
-<?php
-
-	}
-
-?>
-	<tr>
-		<td class="cat" colspan="2" align="center"><input type="submit" name="update" value="<?php echo $_CLASS['core_user']->lang['SUBMIT'] ?>" class="btnmain" /></td>
-	</tr>
-</table></form>
-<?php
-
-		adm_page_footer();
-		break;
-
-	case 'move_up':
-	case 'move_down':
-		$sql = 'SELECT parent_id, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . "
-			WHERE forum_id = $forum_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error('NO_FORUM');
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		extract($row);
-		$forum_info = array($forum_id => $row);
-
-		// Get the adjacent forum
-		$sql = 'SELECT forum_id, forum_name, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . "
-			WHERE parent_id = $parent_id
-				AND " . (($mode == 'move_up') ? "right_id < $right_id ORDER BY right_id DESC" : "left_id > $left_id ORDER BY left_id ASC");
-		$result = $_CLASS['core_db']->query_limit($sql, 1);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			// already on top or at bottom
-			break;
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		if ($mode == 'move_up')
-		{
-			$log_action = 'LOG_FORUM_MOVE_UP';
-			$up_id = $forum_id;
-			$down_id = $row['forum_id'];
-		}
-		else
-		{
-			$log_action = 'LOG_FORUM_MOVE_DOWN';
-			$up_id = $row['forum_id'];
-			$down_id = $forum_id;
-		}
-
-		$move_forum_name = $row['forum_name'];
-		$forum_info[$row['forum_id']] = $row;
-		$diff_up = $forum_info[$up_id]['right_id'] - $forum_info[$up_id]['left_id'];
-		$diff_down = $forum_info[$down_id]['right_id'] - $forum_info[$down_id]['left_id'];
-
-		$forum_ids = array();
-		$sql = 'SELECT forum_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE left_id > ' . $forum_info[$up_id]['left_id'] . '
-				AND right_id < ' . $forum_info[$up_id]['right_id'];
-		$result = $_CLASS['core_db']->query($sql);
-
-		while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-		{
-			$forum_ids[] = $row['forum_id'];
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		// Start transaction
-		$_CLASS['core_db']->transaction();
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = left_id + ' . ($diff_up + 1) . ', right_id = right_id + ' . ($diff_up + 1) . '
-			WHERE left_id > ' . $forum_info[$down_id]['left_id'] . '
-				AND right_id < ' . $forum_info[$down_id]['right_id'];
-		$_CLASS['core_db']->query($sql);
-
-		if (count($forum_ids))
-		{
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id - ' . ($diff_down + 1) . ', right_id = right_id - ' . ($diff_down + 1) . '
-				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
-			$_CLASS['core_db']->query($sql);
-		}
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . $forum_info[$down_id]['left_id'] . ', right_id = ' . ($forum_info[$down_id]['left_id'] + $diff_up) . '
-			WHERE forum_id = ' . $up_id;
-		$_CLASS['core_db']->query($sql);
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . ($forum_info[$up_id]['right_id'] - $diff_down) . ', right_id = ' . $forum_info[$up_id]['right_id'] . '
-			WHERE forum_id = ' . $down_id;
-		$_CLASS['core_db']->query($sql);
-
-		$_CLASS['core_db']->transaction('commit');
-
-		$forum_data = get_forum_info($forum_id);
-
-		add_log('admin', $log_action, $forum_data['forum_name'], $move_forum_name);
-		unset($forum_data);
-		break;
-
-	case 'sync':
-		if (!$forum_id)
-		{
-			trigger_error('NO_FORUM');
-		}
-
-		$sql = "SELECT forum_name
-			FROM " . FORUMS_FORUMS_TABLE . "
-			WHERE forum_id = $forum_id";
-		$result = $_CLASS['core_db']->query($sql);
-
-		if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']->lang['NO_FORUM']);
-		}
-		$_CLASS['core_db']->free_result($result);
-
-		sync('forum', 'forum_id', $forum_id);
-		add_log('admin', 'LOG_FORUM_SYNC', $row['forum_name']);
-
-		break;
-}
-
-// Default management page
-
-if (!$parent_id)
-{
-	$navigation = $_CLASS['core_user']->lang['FORUM_INDEX'];
-}
-else
-{
-	$navigation = '<a href="'.generate_link('forums&amp;file=admin_forums', array('admin' => true)) . '">' . $_CLASS['core_user']->lang['FORUM_INDEX'] . '</a>';
-
-	$forums_nav = get_forum_branch($parent_id, 'parents', 'descending');
-	foreach ($forums_nav as $row)
-	{
-		if ($row['forum_id'] == $parent_id)
-		{
-			$navigation .= ' -&gt; ' . $row['forum_name'];
-		}
-		else
-		{
-			$navigation .= ' -&gt; <a href="'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' => true)) . '">' . $row['forum_name'] . '</a>';
-		}
-	}
-}
-
-// Jumpbox
-$forum_box = make_forum_select($parent_id);
-
-// Front end
-adm_page_header($_CLASS['core_user']->lang['MANAGE']);
-
-?>
-
-<h1><?php echo $_CLASS['core_user']->lang['MANAGE']; ?></h1>
-
-<p><?php echo $_CLASS['core_user']->lang['FORUM_ADMIN_EXPLAIN']; ?></p><?php
-
-if ($mode == 'sync')
-{
-	echo '<br /><div class="gen" align="center"><b>' . $_CLASS['core_user']->lang['FORUM_RESYNCED'] . '</b></div>';
-}
-
-?><form method="post" action="<?php echo generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' => true)) ?>"><table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
-	<tr>
-		<td class="nav"><?php echo $navigation ?></td>
-	</tr>
-</table>
-		
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th colspan="6"><?php echo $_CLASS['core_user']->lang['FORUM_ADMIN'] ?></th>
-	</tr>
-<?php
-
-$sql = 'SELECT *
-	FROM ' . FORUMS_FORUMS_TABLE . "
-	WHERE parent_id = $parent_id
-	ORDER BY left_id";
-$result = $_CLASS['core_db']->query($sql);
-
-while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-{
-	$forum_type = $row['forum_type'];
-
-	if ($row['forum_status'] == ITEM_LOCKED)
-	{
-		$folder_image = '<img src="images/modules/forums/adm/images/icon_folder_lock.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['LOCKED'] . '" />';
-	}
-	else
-	{
-		switch ($forum_type)
-		{
-			case FORUM_LINK:
-				$folder_image = '<img src="images/modules/forums/adm/images/icon_folder_link.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['LINK'] . '" />';
-				break;
-
-			default:
-				$folder_image = ($row['left_id'] + 1 != $row['right_id']) ? '<img src="images/modules/forums/adm/images/icon_subfolder.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['SUBFORUM'] . '" />' : '<img src="images/modules/forums/adm/images/icon_folder.gif" width="46" height="25" alt="' . $_CLASS['core_user']->lang['FOLDER'] . '" />';
-		}
-	}
-
-	$forum_title = ($forum_type != FORUM_LINK) ? '<a href="'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' => true)) . '">' : '';
-	$forum_title .= $row['forum_name'];
-	$forum_title .= ($forum_type != FORUM_LINK) ? '</a>' : '';
-	$url = "forums&amp;file=admin_forums&amp;parent_id=$parent_id&amp;f=" . $row['forum_id'];
-
-?>
-	<tr>
-		<td class="row1" width="5%"><?php echo $folder_image; ?></td>
-		<td class="row1" width="50%"><table width="100%" cellspacing="0" cellpadding="0" border="0">
-				<tr>
-					<td><span class="forumlink"><?php echo $forum_title ?></span></td>
-				</tr>
-			</table>
-			<table cellspacing="5" cellpadding="0" border="0">
-				<tr>
-					<td class="gensmall"><?php echo $row['forum_desc'] ?></td>
-				</tr>
-			</table>
-<?php
-
-	if ($forum_type == FORUM_POST)
-	{
-
-?>
-			<table width="100%" cellspacing="0" cellpadding="0" border="0">
-				<tr>
-					<td class="gensmall">&nbsp;<?php echo $_CLASS['core_user']->lang['TOPICS']; ?>: <b><?php echo $row['forum_topics'] ?></b> / <?php echo $_CLASS['core_user']->lang['POSTS']; ?>: <b><?php echo $row['forum_posts'] ?></b></td>
-				</tr>
-			</table>
-<?php
-
-	}
-
-?></td>
-		<td class="row2" width="15%" align="center" valign="middle" nowrap="nowrap"><a href="<?php echo generate_link($url.'&amp;mode=move_up', array('admin' => true)); ?>"><?php echo $_CLASS['core_user']->lang['MOVE_UP'] ?></a><br /><a href="<?php echo generate_link($url.'&amp;mode=move_down', array('admin' => true)); ?>"><?php echo $_CLASS['core_user']->lang['MOVE_DOWN'] ?></a></td>
-		<td class="row2" width="20%" align="center" valign="middle" nowrap="nowrap">&nbsp;<a href="<?php echo generate_link($url.'&amp;mode=edit', array('admin' => true)); ?>"><?php echo $_CLASS['core_user']->lang['EDIT'] ?></a> | <a href="<?php echo generate_link($url.'&amp;mode=delete', array('admin' => true)); ?>"><?php echo $_CLASS['core_user']->lang['DELETE'] ?></a><?php
-			
-	if ($forum_type != FORUM_LINK)
-	{
-
-?> | <a href="<?php echo generate_link($url.'&amp;mode=sync', array('admin' => true)); ?>"><?php echo $_CLASS['core_user']->lang['RESYNC'] ?></a><?php
-	
-
-	}
-	
-?>&nbsp;</td>
-	</tr>
-<?php
-
-}
-$_CLASS['core_db']->free_result($result);
-
-?>
-	<tr>
-		<td width="100%" colspan="6" class="cat"><input type="hidden" name="mode" value="add" /><input class="post" type="text" name="forum_name" /> <input class="btnlite" type="submit" value="<?php echo $_CLASS['core_user']->lang['CREATE_FORUM'] ?>" /></td>
-	</tr>
-</table></form>
-
-<form method="post" action="<?php echo generate_link('forums&amp;file=admin_forums', array('admin' => true)) ?>"><table width="100%" cellpadding="1" cellspacing="1" border="0">
-	<tr>
-		<td align="right"><?php echo $_CLASS['core_user']->lang['SELECT_FORUM']; ?>: <select name="parent_id" onchange="if(this.options[this.selectedIndex].value != -1){ this.form.submit(); }"><?php echo $forum_box; ?></select> <input class="btnlite" type="submit" value="<?php echo $_CLASS['core_user']->lang['GO']; ?>" /><input type="hidden" name="sid" value="<?php echo $_CLASS['core_user']->session_id; ?>" /></td>
-	</tr>
-</table></form>
-<?php
-
-adm_page_footer();
-
-//
-// END
-//
-
-
-// ------------------
-// Begin function block
-//
-function get_forum_info($forum_id)
-{
-	global $_CLASS;
-
-	$sql = 'SELECT *
-		FROM ' . FORUMS_FORUMS_TABLE . "
-		WHERE forum_id = $forum_id";
-	$result = $_CLASS['core_db']->query($sql);
-
-	if (!($row = $_CLASS['core_db']->fetch_row_assoc($result)))
-	{
-		trigger_error("Forum #$forum_id does not exist", E_USER_ERROR);
-	}
-
-	return $row;
-}
-
-function update_forum_data(&$forum_data)
-{
-	global $_CLASS;
-
-	$errors = array();
-	if (!trim($forum_data['forum_name']))
-	{
-		$errors[] = $_CLASS['core_user']->lang['FORUM_NAME_EMPTY'];
-	}
-
-	if (!empty($_POST['forum_password']) || !empty($_POST['forum_password_confirm']))
-	{
-		if ($_POST['forum_password'] != $_POST['forum_password_confirm'])
-		{
-			$forum_data['forum_password'] = $forum_data['forum_password_confirm'] = '';
-			$errors[] = $_CLASS['core_user']->lang['FORUM_PASSWORD_MISMATCH'];
-		}
-	}
-
-	if ($forum_data['prune_days'] < 0 || $forum_data['prune_viewed'] < 0 || $forum_data['prune_freq'] < 0)
-	{
-		$forum_data['prune_days'] = $forum_data['prune_viewed'] = $forum_data['prune_freq'] = 0;
-		$errors[] = $_CLASS['core_user']->lang['FORUM_DATA_NEGATIVE'];
-	}
-
-	// Set forum flags
-	// 1 = link tracking
-	// 2 = prune old polls
-	// 4 = prune announcements
-	// 8 = prune stickies
-	$forum_data['forum_flags'] = 0;
-	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? 1 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? 2 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? 4 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? 8 : 0;
-
-	// Unset data that are not database fields
-	unset($forum_data['forum_link_track']);
-	unset($forum_data['prune_old_polls']);
-	unset($forum_data['prune_announce']);
-	unset($forum_data['prune_sticky']);
-	unset($forum_data['forum_password_confirm']);
-
-	// What are we going to do tonight Brain? The same thing we do everynight,
-	// try to take over the world ... or decide whether to continue update
-	// and if so, whether it's a new forum/cat/link or an existing one
-	if (count($errors))
-	{
-		return $errors;
-	}
-
-	if (empty($forum_data['forum_id']))
-	{
-		// no forum_id means we're creating a new forum
-
-		$_CLASS['core_db']->transaction();
-
-		if ($forum_data['parent_id'])
-		{
-			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $forum_data['parent_id'];
-			$result = $_CLASS['core_db']->query($sql);
-
-			if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				trigger_error('Parent does not exist', E_USER_ERROR);
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id + 2, right_id = right_id + 2
-				WHERE left_id > ' . $row['right_id'];
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET right_id = right_id + 2
-				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
-			$_CLASS['core_db']->query($sql);
-
-			$forum_data['left_id'] = $row['right_id'];
-			$forum_data['right_id'] = $row['right_id'] + 1;
-		}
-		else
-		{
-			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_FORUMS_TABLE;
-			$result = $_CLASS['core_db']->query($sql);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			$forum_data['left_id'] = $row['right_id'] + 1;
-			$forum_data['right_id'] = $row['right_id'] + 2;
-		}
-
-		$sql = 'INSERT INTO ' . FORUMS_FORUMS_TABLE . ' ' . $_CLASS['core_db']->sql_build_array('INSERT', $forum_data);
-		$_CLASS['core_db']->query($sql);
-		
-		$_CLASS['core_db']->transaction('commit');
-
-		$forum_data['forum_id'] = $_CLASS['core_db']->insert_id(FORUMS_FORUMS_TABLE, 'forum_id');
-		add_log('admin', 'LOG_FORUM_ADD', $forum_data['forum_name']);
-	}
-	else
-	{
-		$row = get_forum_info($forum_data['forum_id']);
-
-		if ($forum_data['forum_type'] != FORUM_POST && $row['forum_type'] != $forum_data['forum_type'])
-		{
-			// we're turning a postable forum into a non-postable forum
-
-			if (empty($forum_data['action']))
-			{
-				// TODO: error message if no action is specified
-
-				return array($_CLASS['core_user']->lang['']);
-			}
-			elseif ($forum_data['action'] == 'move')
-			{
-				if (!empty($forum_data['to_forum_id']))
-				{
-					$errors = move_forum_content($forum_data['forum_id'], $forum_data['to_forum_id']);				
-				}
-				else
-				{
-					return array($_CLASS['core_user']->lang['SELECT_DESTINATION_FORUM']);
-				}
-			}
-			elseif ($forum_data['action'] == 'delete')
-			{
-				$errors = delete_forum_content($forum_data['forum_id']);
-			}
-
-			$forum_data['forum_posts'] = 0;
-			$forum_data['forum_topics'] = 0;
-			$forum_data['forum_topics_real'] = 0;
-		}
-
-		if ($row['parent_id'] != $forum_data['parent_id'])
-		{
-			$errors = move_forum($forum_data['forum_id'], $forum_data['parent_id']);
-		}
-		elseif ($row['forum_name'] != $forum_data['forum_name'])
-		{
-			// the forum name has changed, clear the parents list of child forums
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-				SET forum_parents = ''
-				WHERE left_id > " . $row['left_id'] . '
-					AND right_id < ' . $row['right_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET ' . $_CLASS['core_db']->sql_build_array('UPDATE', $forum_data) . '
-			WHERE forum_id = ' . $forum_data['forum_id'];
-		$_CLASS['core_db']->query($sql);
-
-		add_log('admin', 'LOG_FORUM_EDIT', $forum_data['forum_name']);
-	}
-}
-
-function move_forum($from_id, $to_id)
-{
-	global $_CLASS;
-
-	$moved_forums = get_forum_branch($from_id, 'children', 'descending');
-	$from_data = $moved_forums[0];
-	$diff = count($moved_forums) * 2;
-
-	$moved_ids = array();
-	for ($i = 0; $i < count($moved_forums); ++$i)
-	{
-		$moved_ids[] = $moved_forums[$i]['forum_id'];
-	}
-
-	// Resync parents
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-		SET right_id = right_id - $diff, forum_parents = ''
-		WHERE left_id < " . $from_data['right_id'] . "
-			AND right_id > " . $from_data['right_id'];
-	$_CLASS['core_db']->query($sql);
-
-	// Resync righthand side of tree
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-		SET left_id = left_id - $diff, right_id = right_id - $diff, forum_parents = ''
-		WHERE left_id > " . $from_data['right_id'];
-	$_CLASS['core_db']->query($sql);
-
-	if ($to_id > 0)
-	{
-		$to_data = get_forum_info($to_id);
-
-		// Resync new parents
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-			SET right_id = right_id + $diff, forum_parents = ''
-			WHERE " . $to_data['right_id'] . ' BETWEEN left_id AND right_id
-				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		// Resync the righthand side of the tree
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-			SET left_id = left_id + $diff, right_id = right_id + $diff, forum_parents = ''
-			WHERE left_id > " . $to_data['right_id'] . '
-				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$_CLASS['core_db']->query($sql);
-
-		// Resync moved branch
-		$to_data['right_id'] += $diff;
-		if ($to_data['right_id'] > $from_data['right_id'])
-		{
-			$diff = '+ ' . ($to_data['right_id'] - $from_data['right_id'] - 1);
-		}
-		else
-		{
-			$diff = '- ' . abs($to_data['right_id'] - $from_data['right_id'] - 1);
-		}
-	}
-	else
-	{
-		$sql = 'SELECT MAX(right_id) AS right_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$result = $_CLASS['core_db']->query($sql);
-
-		$row = $_CLASS['core_db']->fetch_row_assoc($result);
-		$_CLASS['core_db']->free_result($result);
-
-		$diff = '+ ' . ($row['right_id'] - $from_data['left_id'] + 1);
-	}
-
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-		SET left_id = left_id $diff, right_id = right_id $diff, forum_parents = ''
-		WHERE forum_id IN (" . implode(', ', $moved_ids) . ')';
-	$_CLASS['core_db']->query($sql);
-}
-
-function move_forum_content($from_id, $to_id, $sync = TRUE)
-{
-	// TODO: empty tables like forum_tracks or forum_access
-
-	global $_CLASS;
-
-	$table_ary = array(LOG_TABLE, POSTS_TABLE, TOPICS_TABLE);
-	foreach ($table_ary as $table)
-	{
-		$sql = "UPDATE $table
-			SET forum_id = $to_id
-			WHERE forum_id = $from_id";
-		$_CLASS['core_db']->query($sql);
-	}
-	unset($table_ary);
-
-	if ($sync)
-	{
-		// Delete ghost topics that link back to the same forum
-		// then resync counters
-
-		sync('topic_moved');
-		sync('forum', 'forum_id', $to_id);
-	}
-}
-
-function delete_forum($forum_id, $action_posts = 'delete', $action_subforums = 'delete', $posts_to_id = 0, $subforums_to_id = 0)
-{
-	global $_CLASS;
-
-	$row = get_forum_info($forum_id);
-	extract($row);
-
-	$errors = array();
-	$log_action_posts = $log_action_forums = '';
-
-	if ($action_posts == 'delete')
-	{
-		$_CLASS['core_db']->query('UPDATE '.FORUMS_FORUMS_TABLE.' SET forum_status = '.ITEM_DELETING.' WHERE forum_id = '.$forum_id);
-
-		$log_action_posts = 'POSTS';
-		
-		if ($delete_error = delete_forum_content($forum_id))
-		{
-			$errors[] = $delete_error;
-		}
-	}
-	elseif ($action_posts == 'move')
-	{
-		if (!$posts_to_id)
-		{
-			$errors[] = $_CLASS['core_user']->lang['NO_DESTINATION_FORUM'];
-		}
-		else
-		{
-			$log_action_posts = 'MOVE_POSTS';
-
-			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $posts_to_id;
-			$result = $_CLASS['core_db']->query($sql);
-
-			if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$errors[] = $_CLASS['core_user']->lang['NO_FORUM'];
-			}
-			else
-			{
-				$posts_to_name = $row['forum_name'];
-				unset($row);
-
-				$errors[] = move_forum_content($forum_id, $subforums_to_id);
-			}
-		}
-	}
-
-	if (count($errors))
-	{
-		return $errors;
-	}
-
-	if ($action_subforums == 'delete')
-	{
-		$log_action_forums = 'forums';
-
-		$forum_ids = array($forum_id);
-		$rows = get_forum_branch($forum_id, 'children', 'descending', FALSE);
-
-// Maybe add feild to the get_forum_branch
-		foreach ($rows as $row)
-		{
-			$forum_ids[] = $row['forum_id'];
-		}
-		unset($rows);
-
-		$_CLASS['core_db']->query('UPDATE '.FORUMS_FORUMS_TABLE.'  SET forum_status = '.ITEM_DELETING.' WHERE forum_id  IN (' . implode(', ', $forum_ids) . ')');
-
-		foreach ($forum_ids as $forum_id)
-		{
-			if ($delete_error = delete_forum_content($forum_id))
-			{
-				$errors[] = $delete_error;
-			}
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-
-		$diff = count($forum_ids) * 2;
-
-		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
-		$_CLASS['core_db']->query($sql);
-	}
-	elseif ($action_subforums == 'move')
-	{
-		if (!$subforums_to_id)
-		{
-			$errors[] = $_CLASS['core_user']->lang['NO_DESTINATION_FORUM'];
-		}
-		else
-		{
-			$log_action_forums = 'MOVE_FORUMS';
-
-			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $subforums_to_id;
-			$result = $_CLASS['core_db']->query($sql);
-
-			if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$errors[] = $_CLASS['core_user']->lang['NO_FORUM'];
-			}
-			else
-			{
-				$subforums_to_name = $row['forum_name'];
-				unset($row);
-
-				$sql = 'SELECT forum_id
-					FROM ' . FORUMS_FORUMS_TABLE . "
-					WHERE parent_id = $forum_id";
-				$result = $_CLASS['core_db']->query($sql);
-
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					move_forum($row['forum_id'], intval($_POST['subforums_to_id']));
-				}
-				$_CLASS['core_db']->free_result($result);
-
-				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-					SET parent_id = $subforums_to_id
-					WHERE parent_id = $forum_id";
-				$_CLASS['core_db']->query($sql);
-
-				$diff = 2;
-				$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
-					WHERE forum_id = $forum_id";
-				$_CLASS['core_db']->query($sql);
-			}
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-	}
-	else
-	{
-		$diff = 2;
-		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . "
-			WHERE forum_id = $forum_id";
-		$_CLASS['core_db']->query($sql);
-	}
-
-	// Resync tree
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-		SET right_id = right_id - $diff
-		WHERE left_id < $right_id AND right_id > $right_id";
-	$_CLASS['core_db']->query($sql);
-
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-		SET left_id = left_id - $diff, right_id = right_id - $diff
-		WHERE left_id > $right_id";
-	$_CLASS['core_db']->query($sql);
-
-	if (!is_array($forum_ids))
-	{
-		$forum_ids = array($forum_id);
-	}
-
-	// Delete forum ids from extension groups table
-	$sql = 'SELECT group_id, allowed_forums 
-		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . "
-		WHERE allowed_forums <> ''";
-	$result = $_CLASS['core_db']->query($sql);
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$allowed_forums = unserialize(trim($row['allowed_forums']));
-		$allowed_forums = array_diff($allowed_forums, $forum_ids);
-		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . " 
-			SET allowed_forums = '" . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . "'
-			WHERE group_id = {$row['group_id']}";
-		$_CLASS['core_db']->query($sql);
-	}
-	$_CLASS['core_cache']->destroy('extensions');
-
-	$log_action = implode('_', array($log_action_posts, $log_action_forums));
-
-	switch ($log_action)
-	{
-		case 'MOVE_POSTS_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_name);
-		break;
-
-		case 'MOVE_POSTS_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_name);
-		break;
-
-		case 'POSTS_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_name);
-		break;
-
-		case '_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_name);
-		break;
-
-		case 'MOVE_POSTS_':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_name);
-			break;
-		case 'POSTS_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_name);
-		break;
-
-		case '_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_name);
-		break;
-
-		case 'POSTS_':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_name);
-		break; 
-	}
-
-	return $errors;
-}
-
-function delete_forum_content($forum_id)
-{
-	global $_CLASS;
-	require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
-
-	$_CLASS['core_db']->transaction();
-
-	switch ($_CLASS['core_db']->db_layer)
-	{
-// Needs updating and testing
-/*		case 'mysql':
-		case 'mysqli':
-			// Select then delete all attachments
-			$sql = 'SELECT a.topic_id
-				FROM ' . POSTS_TABLE . ' p, ' . ATTACHMENTS_TABLE . " a
-				WHERE p.forum_id = $forum_id
-					AND a.in_message = 0
-					AND a.topic_id = p.topic_id";
-			$result = $_CLASS['core_db']->query($sql);	
-		
-			$topic_ids = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$topic_ids[] = $row['topic_id'];
-			}
-			$_CLASS['core_db']->free_result($result);
-			
-			delete_attachments('topic', $topic_ids, false);
-
-			// Delete everything else and thank MySQL for offering multi-table deletion
-			$tables_ary = array(
-				BOOKMARKS_TABLE 	=> 'bm.topic_id',
-				SEARCH_MATCH_TABLE	=> 'wm.post_id',
-				REPORTS_TABLE		=> 're.post_id',
-				TOPICS_WATCH_TABLE	=> 'tw.topic_id',
-				TOPICS_TRACK_TABLE	=> 'tt.topic_id',
-				POLL_OPTIONS_TABLE	=> 'po.topic_id',
-				POLL_VOTES_TABLE	=> 'pv.topic_id'
-			);
-
-			$sql = 'DELETE QUICK FROM ' . POSTS_TABLE;
-			$sql_using = "\nUSING " . POSTS_TABLE . ' p';
-			$sql_where = "\nWHERE p.forum_id = $forum_id\n";
-			$sql_optimise = 'OPTIMIZE TABLE . ' . POSTS_TABLE;
-
-			foreach ($tables_ary as $table => $field)
-			{
-				$sql .= ", $table";
-				$sql_using .= ", $table " . strtok($field, '.');
-				$sql_where .= "\nAND $field = p." . strtok('');
-				$sql_optimise .= ', ' . $table;
-			}
-
-			$_CLASS['core_db']->query($sql . $sql_using . $sql_where);
-
-			$tables_ary = array(FORUMS_ACCESS_TABLE, TOPICS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, ACL_GROUPS_TABLE, ACL_USERS_TABLE, MODERATOR_TABLE, LOG_TABLE);
-			foreach ($tables_ary as $table)
-			{
-				$_CLASS['core_db']->query("DELETE QUICK FROM $table WHERE forum_id = $forum_id");
-				$sql_optimise .= ', ' . $table;
-			}
-
-			// Now optimise a hell lot of tables
-			$_CLASS['core_db']->query($sql_optimise);
-		break;
-*/
-		default:
-			// Select then delete all attachments
-			$sql = 'SELECT a.attach_id, a.physical_filename, a.thumbnail
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_ATTACHMENTS_TABLE . " a
-				WHERE p.forum_id = $forum_id
-					AND a.in_message = 0
-					AND a.post_msg_id = p.post_id";
-			$result = $_CLASS['core_db']->query($sql);	
-
-			$attach_ids = array();
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$attach_ids[] = $row['attach_id'];
-
-				phpbb_unlink($row['physical_filename'], 'file');
-
-				if ($row['thumbnail'])
-				{
-					phpbb_unlink($row['physical_filename'], 'thumbnail');
-				}
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			if (count($attach_ids))
-			{
-				$attach_id_list = implode(',', array_unique($attach_ids));
-				$_CLASS['core_db']->query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . " WHERE attach_id IN ($attach_id_list)");
-				unset($attach_ids, $attach_id_list);
-			}
-
-			// Delete everything else and curse your DB for not offering multi-table deletion
-			$tables_ary = array(
-				'post_id'	=>	array(
-					FORUMS_SEARCH_MATCH_TABLE,
-					FORUMS_REPORTS_TABLE,
-				),
-				
-				'topic_id'	=>	array(
-					FORUMS_BOOKMARKS_TABLE,
-					FORUMS_WATCH_TABLE,
-					FORUMS_TRACK_TABLE,
-					FORUMS_POLL_OPTIONS_TABLE,
-					FORUMS_POLL_VOTES_TABLE
-				)
-			);
-
-			foreach ($tables_ary as $field => $tables)
-			{
-				$start = 0;
-				$id_array = array();
-
-				$sql = "SELECT $field
-					FROM " . FORUMS_POSTS_TABLE . '
-					WHERE forum_id = ' . $forum_id;
-				$result = $_CLASS['core_db']->query($sql);
-
-				while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-				{
-					$id_array[] = $row[$field];
-				}
-				$_CLASS['core_db']->free_result($result);
-
-				if (empty($id_array))
-				{
-					continue;
-				}
-
-				foreach ($tables as $table)
-				{
-					$_CLASS['core_db']->query("DELETE FROM $table WHERE $field IN (".implode(',', $id_array).')');
-				}
-			}
-			unset($id_array);
-
-			$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE, FORUMS_ACL_TABLE, FORUMS_MODERATOR_TABLE, FORUMS_LOG_TABLE);
-
-			foreach ($table_ary as $table)
-			{
-				$_CLASS['core_db']->query("DELETE FROM $table WHERE forum_id = $forum_id");
-			}
-		break;
-	}
-
-	$_CLASS['core_db']->transaction('commit');
-	
-	// NEED to have this done at the end, maybe a cran
-	$tables = array_unique(array_merge($tables_ary['post_id'], $tables_ary['topic_id'], $table_ary, array(FORUMS_ATTACHMENTS_TABLE)));
-	$_CLASS['core_db']->optimize_tables($tables);
-}
-
-function recalc_btree()
-{
-	global $_CLASS;
-
-	$sql = 'SELECT forum_id, parent_id, left_id, right_id 
-		FROM ' . FORUMS_FORUMS_TABLE . '
-		ORDER BY parent_id ASC';
-	$f_result = $_CLASS['core_db']->query($sql);
-
-	while ($forum_data = $_CLASS['core_db']->fetch_row_assoc($f_result))
-	{
-		if ($forum_data['parent_id'])
-		{
-			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $forum_data['parent_id'];
-			$result = $_CLASS['core_db']->query($sql);
-
-			if (!$row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . ' SET parent_id = 0 WHERE forum_id = ' . $forum_data['forum_id'];
-				$_CLASS['core_db']->query($sql);
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id + 2, right_id = right_id + 2
-				WHERE left_id > ' . $row['right_id'];
-			$_CLASS['core_db']->query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET right_id = right_id + 2
-				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
-			$_CLASS['core_db']->query($sql);
-
-			$forum_data['left_id'] = $row['right_id'];
-			$forum_data['right_id'] = $row['right_id'] + 1;
-		}
-		else
-		{
-			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_FORUMS_TABLE;
-			$result = $_CLASS['core_db']->query($sql);
-
-			$row = $_CLASS['core_db']->fetch_row_assoc($result);
-			$_CLASS['core_db']->free_result($result);
-
-			$forum_data['left_id'] = $row['right_id'] + 1;
-			$forum_data['right_id'] = $row['right_id'] + 2;
-		}
-	
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . $forum_data['left_id'] . ', right_id = ' . $forum_data['right_id'] . '
-			WHERE forum_id = ' . $forum_data['forum_id'];
-		$_CLASS['core_db']->query($sql);
-	}
-	$_CLASS['core_db']->free_result($f_result);
-}
-
-//
-// End function block
-// ------------------
-
 ?>
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/index.php
===================================================================
--- cms/trunk/includes/forums/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/index.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,388 +0,0 @@
-<?php
-// -------------------------------------------------------------
-//
-// $Id: pagestart.php,v 1.18 2004/08/02 14:31:45 psotfx Exp $
-//
-// FILENAME  : pagestart.php
-// STARTED   : Thu Aug 2, 2001
-// COPYRIGHT : ? 2001, 2004 phpBB Group
-// WWW       : http://www.phpbb.com/
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Some often used variables
-$safe_mode	= (@ini_get('safe_mode') || @strtolower(ini_get('safe_mode')) == 'on') ? true : false;
-$file_uploads = (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on') ? true : false;
-
-$data = array(
-	'title' => 'Forum Administration',
-	'position' => BLOCK_LEFT,
-	'file' => 'block-Admin_Forums.php',
-);
-
-$_CLASS['core_blocks']->add_block($data);
-
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
-require_once($site_file_root.'includes/forums/functions.php');
-require_once($site_file_root.'includes/forums/functions_admin.php');
-
-$_CLASS['core_user']->add_lang('admin', 'Forums');
-//$_CLASS['core_user']->add_img(false, 'Forums');
-$_CLASS['auth']->acl($_CLASS['core_user']->data);
-
-$file = get_variable('file', 'REQUEST', 'main');
-
-if (file_exists($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/'.$file.'.php'))
-{
-	require($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/'.$file.'.php');
-}
-else
-{
-	require($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/main.php');
-}
-
-
-// -----------------------------
-// Functions
-function adm_page_header($sub_title, $meta = '', $table_html = true)
-{
-	global $config, $db, $_CLASS;
-
-	$_CLASS['core_display']->display_head();
-	$_CLASS['core_display']->table_open;
-
-	if ($table_html)
-	{
-
-?>
-<a name="top"></a>
-
-<table width="95%" cellspacing="0" cellpadding="0" border="0" align="center">
-	<tr>
-		<td>
-
-<?php
-
-	}
-
-}
-
-function adm_page_footer($copyright_html = true)
-{
-	global $cache, $config, $_CLASS;
-
-?>
-
-		</td>
-	</tr>
-</table>
-<?php
-
-	if ($copyright_html)
-	{
-
-?>
-
-<div class="copyright" align="center">Powered by phpBB <?php echo $config['version']; ?> &copy; 2002 <a href="http://www.phpbb.com/" target="_phpbb">phpBB Group</a></div>
-
-<br clear="all" />
-<?php
-	$_CLASS['core_display']->table_close;
-	$_CLASS['core_display']->display_footer();
-
-	}
-}
-
-function adm_page_message($title, $message, $show_header = false, $show_prev_info = true)
-{
-	global $_CLASS, $_SERVER, $_ENV;
-
-?>
-<br /><br />
-
-<table class="tablebg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th><?php echo $title; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center"><?php echo $message; ?></td>
-	</tr>
-</table>
-
-<br />
-
-<?php
-
-}
-
-function adm_page_confirm($title, $message)
-{
-	global $_CLASS;
-
-	// Grab data from GET and POST arrays ... note this is _not_
-	// validated! Everything is typed as string to ensure no
-	// funny business on displayed hidden field data. Validation
-	// will be carried out by whatever processes this form.
-	$var_ary = array_merge($_GET, $_POST);
-
-	$s_hidden_fields = '';
-	foreach ($var_ary as $key => $var)
-	{
-		if (empty($var))
-		{
-			continue;
-		}
-
-		if (is_array($var))
-		{
-			foreach ($var as $k => $v)
-			{
-				if (is_array($v))
-				{
-					foreach ($v as $_k => $_v)
-					{
-						set_var($var[$k][$_k], $_v, 'string');
-						$s_hidden_fields .= "<input type=\"hidden\" name=\"${key}[$k][$_k]\" value=\"" . addslashes($_v) . '" />';
-					}
-				}
-				else
-				{
-					set_var($var[$k], $v, 'string');
-					$s_hidden_fields .= "<input type=\"hidden\" name=\"${key}[$k]\" value=\"" . addslashes($v) . '" />';
-				}
-			}
-		}
-		else
-		{
-			set_var($var, $var, 'string');
-			$s_hidden_fields .= '<input type="hidden" name="' . $key . '" value="' . addslashes($var) . '" />';
-		}
-		unset($var_ary[$key]);
-	}
-
-?>
-
-<br /><br />
-
-<form name="confirm" method="post" action="<?php echo $_SERVER['REQUEST_URI']; ?>">
-<table class="tablebg" width="80%" cellspacing="1" cellpadding="4" border="0" align="center">
-	<tr>
-		<th><?php echo $title; ?></th>
-	</tr>
-	<tr>
-		<td class="row1" align="center"><?php echo $message; ?><br /><br /><input class="btnlite" type="submit" name="confirm" value="<?php echo $_CLASS['core_user']->lang['YES']; ?>" />&nbsp;&nbsp;<input class="btnmain" type="submit" name="cancel" value="<?php echo $_CLASS['core_user']->lang['NO']; ?>" /></td>
-	</tr>
-</table>
-
-<?php echo $s_hidden_fields; ?>
-</form>
-
-<br />
-
-<?php
-
-	adm_page_footer();
-
-}
-
-function build_cfg_template($tpl_type, $config_key, $options = '')
-{
-	global $new, $_CLASS;
-
-	$tpl = '';
-	$name = 'config[' . $config_key . ']';
-
-	switch ($tpl_type[0])
-	{
-		case 'text':
-		case 'password':
-			$size = (int) $tpl_type[1];
-			$maxlength = (int) $tpl_type[2];
-
-			$tpl = '<input class="post" type="' . $tpl_type[0] . '"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="' . $name . '" value="' . $new[$config_key] . '" />';
-			break;
-
-		case 'dimension':
-			$size = (int) $tpl_type[1];
-			$maxlength = (int) $tpl_type[2];
-
-			$tpl = '<input class="post" type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_height]" value="' . $new[$config_key . '_height'] . '" /> x <input class="post" type="text"' . (($size) ? ' size="' . $size . '"' : '') . ' maxlength="' . (($maxlength) ? $maxlength : 255) . '" name="config[' . $config_key . '_width]" value="' . $new[$config_key . '_width'] . '" />';
-			break;
-
-		case 'textarea':
-			$rows = (int) $tpl_type[1];
-			$cols = (int) $tpl_type[2];
-
-			$tpl = '<textarea name="' . $name . '" rows="' . $rows . '" cols="' . $cols . '">' . $new[$config_key] . '</textarea>';
-			break;
-
-		case 'radio':
-			$key_yes	= ($new[$config_key]) ? ' checked="checked"' : '';
-			$key_no		= (!$new[$config_key]) ? ' checked="checked"' : '';
-
-			$tpl_type_cond = explode('_', $tpl_type[1]);
-			$type_no = ($tpl_type_cond[0] == 'disabled' || $tpl_type_cond[0] == 'enabled') ? false : true;
-
-			$tpl_no = '<input type="radio" name="' . $name . '" value="0"' . $key_no . ' />' . (($type_no) ? $_CLASS['core_user']->lang['NO'] : $_CLASS['core_user']->lang['DISABLED']);
-			$tpl_yes = '<input type="radio" name="' . $name . '" value="1"' . $key_yes . ' />' . (($type_no) ? $_CLASS['core_user']->lang['YES'] : $_CLASS['core_user']->lang['ENABLED']);
-
-			$tpl = ($tpl_type_cond[0] == 'yes' || $tpl_type_cond[0] == 'enabled') ? $tpl_yes . '&nbsp;&nbsp;' . $tpl_no : $tpl_no . '&nbsp;&nbsp;' . $tpl_yes;
-			break;
-
-		case 'select':
-			eval('$s_options = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			$tpl = '<select name="' . $name . '">' . $s_options . '</select>';
-			break;
-
-		case 'custom':
-			eval('$tpl = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			break;
-
-		default:
-			break;
-	}
-
-	return $tpl;
-}
-
-// General ACP module class
-class module
-{
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
-
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $selected_mod = false, $selected_submod = false)
-	{
-		global $template, $_CLASS, $db, $config;
-
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . MODULES_TABLE . "
-			WHERE module_type = 'acp'
-				AND module_enabled = 1
-			ORDER BY module_order ASC";
-		$result = $db->sql_query($sql);
-
-		while ($row = $db->sql_fetchrow($result))
-		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('$_CLASS[\'auth\']->acl_get("\\1")', '$config["\\1"]'), $row['module_acl']) . ');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod && !$i)) ?  true : false;
-/*
-			// Get the localised lang string if available, or make up our own otherwise
-			$template->assign_block_vars($module_type . '_section', array(
-				'L_TITLE'		=> (isset($_CLASS['core_user']->lang[strtoupper($module_type) . '_' . $row['module_title']])) ? $_CLASS['core_user']->lang[strtoupper($module_type) . '_' . $row['module_title']] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
-				'S_SELECTED'	=> $selected,
-				'U_TITLE'		=> $module_url . '&amp;i=' . $row['module_id'])
-			);
-*/
-			if ($selected)
-			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
-				{
-					$j = 0;
-					$submodules_ary = explode("\n", $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
-					{
-						$submodule = explode(',', trim($submodule));
-						$submodule_title = array_shift($submodule);
-
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							if (!$_CLASS['auth']->acl_get($auth_option))
-							{
-								$is_auth = false;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod && !$j)) ? true : false;
-/*
-						// Get the localised lang string if available, or make up our own otherwise
-						$template->assign_block_vars("{$module_type}_section.{$module_type}_subsection", array(
-							'L_TITLE'		=> (isset($_CLASS['core_user']->lang[strtoupper($module_type) . '_' . strtoupper($submodule_title)])) ? $_CLASS['core_user']->lang[strtoupper($module_type) . '_' . strtoupper($submodule_title)] : ucfirst(str_replace('_', ' ', strtolower($submodule_title))),
-							'S_SELECTED'	=> $selected,
-							'U_TITLE'		=> $module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title
-						));
-*/
-						if ($selected)
-						{
-							$this->mode = $submodule_title;
-						}
-
-						$j++;
-					}
-				}
-			}
-
-			$i++;
-		}
-		$db->sql_freeresult($result);
-
-		if (!$module_id)
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-
-		$this->type = $module_type;
-		$this->id = $module_id;
-		$this->name = $module_name;
-	}
-
-	// Public methods to be overwritten by modules
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-
-	function install()
-	{
-		return false;
-	}
-
-	function uninstall()
-	{
-		return false;
-	}
-}
-// End Functions
-// -----------------------------
-
-?>
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/subSilver.css
===================================================================
--- cms/trunk/includes/forums/admin/subSilver.css	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/subSilver.css	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,217 +0,0 @@
-/*
-	$Id: subSilver.css,v 1.14 2004/02/15 09:03:19 acydburn Exp $	
-
-	    The original "subSilver" theme for phpBB2
-	Created by subBlue design :: http://www.subBlue.com
-	  Updated for phpBB 2.2 by psoTFX :: phpBB Group
-	        Copyright (c) 2002 phpBB Group
-*/
-
-body {
-	background-color:	white;
-	font-family:		Verdana, Arial, Helvetica, sans-serif;
-	margin:				0px;
-	border:				0px;
-	padding:			0px;
-
-	scrollbar-face-color:		#DEE3E7;
-	scrollbar-highlight-color:	white;
-	scrollbar-shadow-color:		#DEE3E7;
-	scrollbar-3dlight-color:	#D1D7DC;
-	scrollbar-arrow-color:		#006699;
-	scrollbar-track-color:		#EFEFEF;
-	scrollbar-darkshadow-color: #98AAB1;
-}
-
-p {
-	font-size:	8pt;
-}
-
-.maintitle, h1 {
-	font:			bold 18pt 'Trebuchet MS', Verdana, sans-serif;
-	text-decoration:none; 
-	line-height:	120%; 
-}
-h2 {
-	font:			bold 12pt Arial, Helvetica, sans-serif;
-	text-decoration:none; 
-	line-height:	120%; 
-}
-
-.maintitle {
-	color:	#12749B
-}
-
-.subtitle {
-	font:	bold 12pt Arial, Helvetica, sans-serif;
-}
-
-.blue {
-	color: #006699;
-}
-
-.syntaxbg { color: #FFFFFF; }
-.syntaxcomment { color: #FF8000; }
-.syntaxdefault { color: #0000BB; }
-.syntaxhtml { color: #000000; }
-.syntaxkeyword { color: #007700; }
-.syntaxstring { color: #DD0000; }
-
-/*
-	Anchors
-*/
-a:link, a:active, a:visited { color: #006699; text-decoration: none; }
-a:hover { color: #DD6900; text-decoration: underline; }
-
-a.nav { color: #006699; text-decoration: none; }
-a.nav:hover { text-decoration: underline; }
-
-a.th:link { color: #FFA34F; text-decoration: none; }
-a.th:active { color: #FFA34F; text-decoration: none; }
-a.th:visited { color: #FFA34F; text-decoration: none; }
-a.th:hover {  color: #FFA34F; text-decoration: underline; }
-
-/*
-	Non-tag specific
-*/
-.gen, .gensmall {
-	color:	black;
-}
-.gen {
-	font-size:	8pt;
-}
-.gensmall {
-	font-size:	7pt;
-}
-.nav {
-	color:	black;
-	font:	bold 7pt;
-}
-.forumlink {
-	font:	bold 120% Verdana, Arial, Helvetica, sans-serif;
-}
-.name {
-	color:		black;
-	font-size:	11px;
-}
-.postdetails { 
-	color:		black;
-	font-size:	10px;
-}
-.copyright {
-	color:			#444444; 
-	font:			8pt Verdana, Arial, Helvetica, sans-serif; 
-	letter-spacing:	-1px;
-}
-.error { color: #FF0000 }
-
-/*
-	Tables
-*/
-table.bg {
-	background-color: #ACBBC6
-}
-
-th, td { 
-	font:	normal 8pt Verdana, Arial, Helvetica, sans-serif;
-}
-
-th	{
-	height:				25px;
-	background-color:	#006699;
-	color:				#FFA34F;
-	font-weight:		bold;
-	font-size:			11px;
-}
-
-th.forummenu {
-	text-align: left;
-}
-
-td.cat {
-	height:				28px;
-	background-color:	#D1D7DC; 
-}
-
-.row1 {
-	background-color:	#EFEFEF;
-}
-.row2 {
-	background-color:	#DEE3E7;
-}
-.row3 {
-	background-color:	#D1D7DC;
-}
-
-.sourcenum {
-	color:			gray;
-	font-family:	'Courier New', monospace;
-	font-size:		9pt;
-	font-weight:	bold;
-	line-height:	160%;
-}
-.source {
-	font-family:	'Courier New', monospace;
-	font-size:		9pt;
-	line-height:	160%;
-}
-
-
-/*
-	Misc
-*/
-hr	{ 
-	height:				0px; 
-	border:				solid #D1D7DC 0px; 
-	border-top-width:	1px;
-}
-
-/*
-	Forms
-*/
-input {
-	text-indent: 2px;
-}
-
-textarea, select, input.post, input.mainoption, input.liteoption {
-	border: 1px solid; 
-}
-
-input, textarea, select {
-	color:			black;
-	font:			normal 8pt Verdana, Arial, Helvetica, sans-serif;
-	border-color:	black;
-}
-
-input.text {
-	font-family:	'Courier New', courier;
-}
-
-input.checkbox {
-	height:		16px;
-	width:		16px;
-}
-
-option.sep {
-	color:				white;
-	background-color:	#006699;
-}
-
-textarea.edit {
-	font:		9pt 'Courier New', courier;
-	line-height:125%;
-}
-
-.btnmain {
-	background-color:	#FAFAFA;
-	font-weight:		bold;
-	border-width:		1px;
-}
-
-.btnlite {
-	background-color:	#FAFAFA;
-	font-weight:		normal;
-	border-width:		1px;
-}
-
-.helpline { background-color: #DEE3E7; border-style: none; }

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -183,174 +183,6 @@
 	return ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row : false;
 }
 
-// Create forum rules for given forum 
-function generate_forum_rules(&$forum_data)
-{
-	global $_CLASS;
-	
-	if (!$forum_data['forum_rules'] && !$forum_data['forum_rules_link'])
-	{
-		$_CLASS['core_template']->assign('S_FORUM_RULES', false);
-		return;
-	}
-
-	if ($forum_data['forum_rules'])
-	{
-		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-		$bbcode = new bbcode($forum_data['forum_rules_bbcode_bitfield']);
-		$bbcode->bbcode_second_pass($forum_data['forum_rules'], $forum_data['forum_rules_bbcode_uid']);
-
-		$forum_data['forum_rules'] = smiley_text($forum_data['forum_rules'], !($forum_data['forum_rules_flags'] & 2));
-		$forum_data['forum_rules'] = str_replace("\n", '<br />', censor_text($forum_data['forum_rules']));
-		unset($bbcode);
-	}
-
-	$_CLASS['core_template']->assign_array(array(
-		'S_FORUM_RULES'	=> true,
-		'U_FORUM_RULES'	=> $forum_data['forum_rules_link'],
-		'FORUM_RULES'   => $forum_data['forum_rules'])
-	);
-}
-
-// Create forum navigation links for given forum, create parent
-// list if currently null, assign basic forum info to template
-function generate_forum_nav(&$forum_data)
-{
-	global $_CLASS;
-
-	// Get forum parents
-	$forum_parents = get_forum_parents($forum_data);
-
-	// Build navigation links
-	foreach ($forum_parents as $parent_forum_id => $parent_data)
-	{
-		list($parent_name, $parent_type) = array_values($parent_data);
-
-		$_CLASS['core_template']->assign_vars_array('navlinks', array(
-			'S_IS_CAT'		=>	($parent_type == FORUM_CAT) ? true : false,
-			'S_IS_LINK'		=>	($parent_type == FORUM_LINK) ? true : false,
-			'S_IS_POST'		=>	($parent_type == FORUM_POST) ? true : false,
-			'FORUM_NAME'	=>	$parent_name,
-			'FORUM_ID'		=>	$parent_forum_id,
-			'U_VIEW_FORUM'	=>	generate_link('Forums&amp;file=viewforum&amp;f='.$parent_forum_id)
-			)
-		);
-	}
-
-	$_CLASS['core_template']->assign_vars_array('navlinks', array(
-		'S_IS_CAT'		=>	($forum_data['forum_type'] == FORUM_CAT) ? true : false,
-		'S_IS_LINK'		=>	($forum_data['forum_type'] == FORUM_LINK) ? true : false,
-		'S_IS_POST'		=>	($forum_data['forum_type'] == FORUM_POST) ? true : false,
-		'FORUM_NAME'	=>	$forum_data['forum_name'],
-		'FORUM_ID'		=>  $forum_data['forum_id'],
-		'U_VIEW_FORUM'	=>	generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_data['forum_id'])
-		)
-	);
-
-	$_CLASS['core_template']->assign_array(array(
-		'FORUM_ID' 		=> $forum_data['forum_id'],
-		'FORUM_NAME'	=> $forum_data['forum_name'],
-		'FORUM_DESC'	=> strip_tags($forum_data['forum_desc']))
-	);
-
-	return;
-}
-
-// Returns forum parents as an array. Get them from forum_data if available, or update the database otherwise
-function get_forum_parents(&$forum_data)
-{
-	global $_CLASS;
-
-	$forum_parents = array();
-	
-	if ($forum_data['parent_id'])
-	{
-		if (!$forum_data['forum_parents'])
-		{
-			$sql = 'SELECT forum_id, forum_name, forum_type
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE left_id < ' . $forum_data['left_id'] . '
-					AND right_id > ' . $forum_data['right_id'] . '
-				ORDER BY left_id ASC';
-			$result = $_CLASS['core_db']->query($sql);
-
-			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-			{
-				$forum_parents[$row['forum_id']] = array($row['forum_name'], (int) $row['forum_type']);
-			}
-			$_CLASS['core_db']->free_result($result);
-
-			$forum_data['forum_parents'] = serialize($forum_parents);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
-				SET forum_parents = '" . $_CLASS['core_db']->escape($forum_data['forum_parents']) . "'
-				WHERE parent_id = " . $forum_data['parent_id'];
-			$_CLASS['core_db']->query($sql);
-		}
-		else
-		{
-			$forum_parents = unserialize($forum_data['forum_parents']);
-		}
-	}
-
-	return $forum_parents;
-}
-
-// Obtain list of moderators of each forum
-function get_moderators($forum_id = false)
-{
-	global $config, $_CLASS;
-
-	if (!$config['load_moderators'])
-	{
-		return array();
-	}
-
-	$forum_sql = '';
-
-	if ($forum_id)
-	{
-		$forum_sql = is_array($forum_id) ? 'AND forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND forum_id = ' . $forum_id;
-	}
-
-	$sql = 'SELECT *
-		FROM ' . FORUMS_MODERATOR_TABLE . "
-		WHERE display_on_index = 1
-			$forum_sql";
-	$result = $_CLASS['core_db']->query($sql);
-
-	$forum_moderators = array();
-
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
-	{
-		$forum_moderators[$row['forum_id']][] = empty($row['user_id']) ? '<a href="' . generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>' : '<a href="' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>';
-	}
-	$_CLASS['core_db']->free_result($result);
-
-	return $forum_moderators;
-}
-
-// User authorisation levels output
-function gen_forum_auth_level($mode, $forum_id)
-{
-	global $_CLASS, $config;
-
-	$rules = array(
-		($_CLASS['forums_auth']->acl_get('f_post', $forum_id)) ? $_CLASS['core_user']->lang['RULES_POST_CAN'] : $_CLASS['core_user']->lang['RULES_POST_CANNOT'],
-		($_CLASS['forums_auth']->acl_get('f_reply', $forum_id)) ? $_CLASS['core_user']->lang['RULES_REPLY_CAN'] : $_CLASS['core_user']->lang['RULES_REPLY_CANNOT'],
-		($_CLASS['forums_auth']->acl_gets(array('f_edit', 'm_edit'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
-		($_CLASS['forums_auth']->acl_gets(array('f_delete', 'm_delete'), $forum_id)) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
-		($config['allow_attachments'] && $_CLASS['forums_auth']->acl_get('f_attach', $forum_id) && $_CLASS['forums_auth']->acl_get('u_attach', $forum_id)) ? $_CLASS['core_user']->lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']->lang['RULES_ATTACH_CANNOT']
-	);
-
-	foreach ($rules as $rule)
-	{
-		$_CLASS['core_template']->assign_vars_array('rules', array('RULE' => $rule));
-	}
-
-	return;
-}
-
 function gen_sort_selects(&$limit_days, &$sort_by_text, &$sort_days, &$sort_key, &$sort_dir, &$s_limit_days, &$s_sort_key, &$s_sort_dir, &$u_sort_param)
 {
 	global $_CLASS;
@@ -386,6 +218,135 @@
 	return;
 }
 
+/**
+* Decode text whereby text is coming from the db and expected to be pre-parsed content
+* We are placing this outside of the message parser because we are often in need of it...
+*/
+function decode_message(&$message, $bbcode_uid = '')
+{
+	if ($bbcode_uid)
+	{
+		$match = array('<br />', "[/*:m:$bbcode_uid]", ":u:$bbcode_uid", ":o:$bbcode_uid", ":$bbcode_uid");
+		$replace = array("\n", '', '', '', '');
+	}
+	else
+	{
+		$match = array('<br />');
+		$replace = array("\n");
+	}
+
+	$message = str_replace($match, $replace, $message);
+
+	$match = array(
+		'#<!\-\- e \-\-><a href="mailto:(.*?)">.*?</a><!\-\- e \-\->#',
+		'#<!\-\- m \-\-><a href="(.*?)" target="_blank">.*?</a><!\-\- m \-\->#',
+		'#<!\-\- w \-\-><a href="http:\/\/(.*?)" target="_blank">.*?</a><!\-\- w \-\->#',
+		'#<!\-\- l \-\-><a href="(.*?)">.*?</a><!\-\- l \-\->#',
+		'#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#',
+		'#<!\-\- .*? \-\->#s',
+		'#<.*?>#s'
+	);
+	
+	$replace = array('\1', '\1', '\1', '\1', '\1', '', '');
+	
+	$message = preg_replace($match, $replace, $message);
+
+	return;
+}
+
+/**
+* For display of custom parsed text on user-facing pages
+* Expects $text to be the value directly from the database (stored value)
+*/
+function generate_text_for_display($text, $uid, $bitfield, $flags)
+{
+	static $bbcode;
+
+	if (!$text)
+	{
+		return '';
+	}
+
+	// Parse bbcode if bbcode uid stored and bbcode enabled
+	if ($uid && ($flags & 1))
+	{
+		if (!class_exists('bbcode'))
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
+		}
+
+		if (empty($bbcode))
+		{
+			$bbcode = new bbcode($bitfield);
+		}
+		else
+		{
+			$bbcode->bbcode($bitfield);
+		}
+		
+		$bbcode->bbcode_second_pass($text, $uid);
+	}
+
+	$text = smiley_text($text, !($flags & 2));
+	$text = str_replace("\n", '<br />', censor_text($text));
+
+	return $text;
+}
+
+/**
+* For parsing custom parsed text to be stored within the database.
+* This function additionally returns the uid and bitfield that needs to be stored.
+* Expects $text to be the value directly from request_var() and in it's non-parsed form
+*/
+function generate_text_for_storage(&$text, &$uid, &$bitfield, &$flags, $allow_bbcode = false, $allow_urls = false, $allow_smilies = false)
+{
+	$uid = '';
+	$bitfield = '';
+
+	if (!$text)
+	{
+		return;
+	}
+
+	if (!class_exists('parse_message'))
+	{
+		require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
+	}
+
+	$message_parser = new parse_message($text);
+	$message_parser->parse(false, $allow_bbcode, $allow_urls, $allow_smilies);
+
+	$text = $message_parser->message;
+	$uid = $message_parser->bbcode_uid;
+
+	// If the bbcode_bitfield is empty, there is no need for the uid to be stored.
+	if (!$message_parser->bbcode_bitfield)
+	{
+		$uid = '';
+	}
+
+	$flags = (($allow_bbcode) ? 1 : 0) + (($allow_smilies) ? 2 : 0) + (($allow_urls) ? 4 : 0);
+	$bitfield = $message_parser->bbcode_bitfield;
+
+	return;
+}
+
+/**
+* For decoding custom parsed text for edits as well as extracting the flags
+* Expects $text to be the value directly from the database (pre-parsed content)
+*/
+function generate_text_for_edit($text, $uid, $flags)
+{
+	decode_message($text, $uid);
+
+	return array(
+		'allow_bbcode'	=> ($flags & 1) ? 1 : 0,
+		'allow_smilies'	=> ($flags & 2) ? 1 : 0,
+		'allow_urls'	=> ($flags & 4) ? 1 : 0,
+		'text'			=> $text
+	);
+}
+
 function make_jumpbox($action, $forum_id = false, $select_all = false, $acl_list = false)
 {
 	global $config, $_CLASS;
@@ -480,125 +441,7 @@
 	return;
 }
 
-// Topic and forum watching common code
-//do we need user_id ?
-function watch_topic_forum($mode, $user_id, $forum_id, $topic_id, $notify_status = 'unset', $start = 0)
-{
-	global $_CLASS, $config, $_CORE_CONFIG;
 
-	if (!$_CLASS['core_user']->is_user || !$_CORE_CONFIG['email']['email_enable'] || !$config['allow_topic_notify'])
-	{
-		return array('link' => '', 'title' => '', 'watching' => false);
-	}
-
-	if ($mode == 'forum')
-	{
-		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id = 0";
-		$url = 'f='.$forum_id;
-	}
-	else
-	{
-		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id IN ($topic_id, 0)";
-		$url = 't='.$topic_id;
-	}
-
-	$is_watching = false;
-
-	if ($notify_status == 'unset')
-	{
-		// Is user watching this thread?
-		$sql = 'SELECT notify_status
-			FROM '.FORUMS_WATCH_TABLE."
-			 WHERE $where";
-
-		$result = $_CLASS['core_db']->query($sql);
-
-		$notify_status = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['notify_status'] : null;
-		$_CLASS['core_db']->free_result($result);
-	}
-
-	if (is_null($notify_status))
-	{
-		if (isset($_GET['watch']))
-		{
-			if ($_GET['watch'] == $mode)
-			{
-				$is_watching = true;
-
-				// Remove all topics that are being watched, we watching the whole forum dude
-				if ($mode == 'forum')
-				{
-					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-						WHERE forum_id = $forum_id
-							AND user_id = $user_id";
-				
-					$_CLASS['core_db']->query($sql);
-				}
-
-				$sql_array = array(
-					'user_id' => (int) $user_id,
-					'forum_id' => $forum_id,
-					'topic_id' => $topic_id,
-					'notify_status' => 0,
-					'notify_type' => 0
-				);
-
-				$_CLASS['core_db']->sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
-			}
-
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
-			$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
-			trigger_error($message);
-		}
-	}
-	else
-	{
-		if (isset($_GET['unwatch']))
-		{
-			if ($_GET['unwatch'] == $mode)
-			{
-				$is_watching = false;
-
-				if ($mode == 'forum')
-				{
-					$where_delete = "forum_id = $forum_id AND topic_id = 0";
-				}
-				else
-				{
-					$where_delete = "forum_id = $forum_id AND topic_id = $topic_id";
-				}
-
-				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
-							WHERE user_id = $user_id AND $where_delete";
-
-				$_CLASS['core_db']->query($sql);
-			}
-
-			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
-			$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
-			trigger_error($message);
-		}
-		else
-		{
-			$is_watching = true;
-
-			if ($notify_status)
-			{
-				$sql = 'UPDATE ' . FORUMS_WATCH_TABLE . "
-					SET notify_status = 0
-					WHERE $where";
-				$_CLASS['core_db']->query($sql);
-			}
-		}
-	}
-
-	return array(
-			'watching' => true,
-			'link' => generate_link("Forums&amp;file=view$mode&amp;$url&amp;" . (($is_watching) ? 'unwatch' : 'watch') . "=$mode&amp;start=$start"),
-			'title' => $_CLASS['core_user']->lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
-	);
-}
-
 // Marks a topic or forum as read
 function markread($mode, $forum_id = 0, $topic_id = 0, $marktime = false)
 {
@@ -1181,6 +1024,7 @@
 				continue;	
 			}
 		}
+		$_CLASS['core_db']->free_result($result);
 		
 		if (!$online_userlist)
 		{

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -219,7 +219,7 @@
 				'FORUM_ID'			=>	$row['forum_id'],
 				'FORUM_NAME'		=>	$row['forum_name'],
 				'FORUM_DESC'		=>	$row['forum_desc'],
-				//'FORUM_FOLDER_IMG'		=> ($row['forum_image']) ? '<img src="' . $phpbb_root_path . $row['forum_image'] . '" alt="' . $user->lang['FORUM_CAT'] . '" />' : '',
+				//'FORUM_FOLDER_IMG'		=> ($row['forum_image']) ? '<img src="' . $phpbb_root_path . $row['forum_image'] . '" alt="' . $_CLASS['core_user']->lang['FORUM_CAT'] . '" />' : '',
 				//'FORUM_FOLDER_IMG_SRC'	=> ($row['forum_image']) ? $phpbb_root_path . $row['forum_image'] : '',
 				'U_VIEWFORUM'		=>	generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
 			);
@@ -287,7 +287,7 @@
 			$last_post_time = $_CLASS['core_user']->format_date($row['forum_last_post_time']);
 
 			$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']->lang['GUEST'];
-			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
+			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
 			
 			$last_post_url = generate_link('forums&amp;file=viewtopic&amp;f='.$row['forum_id_last_post'].'&amp;p='.$row['forum_last_post_id'].'#'.$row['forum_last_post_id'], false, false, false);
 		}
@@ -357,99 +357,268 @@
 }
 
 /**
-* Display reasons
+* Create forum rules for given forum
 */
-function display_reasons($reason_id = 0)
+function generate_forum_rules(&$forum_data)
 {
+	if (!$forum_data['forum_rules'] && !$forum_data['forum_rules_link'])
+	{
+		return;
+	}
+
+	global $_CLASS;
+
+	if ($forum_data['forum_rules'])
+	{
+		$forum_data['forum_rules'] = generate_text_for_display($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options']);
+	}
+
+	$_CLASS['core_template']->assign_array(array(
+		'S_FORUM_RULES'	=> true,
+		'U_FORUM_RULES'	=> $forum_data['forum_rules_link'],
+		'FORUM_RULES'	=> $forum_data['forum_rules']
+	));
+}
+
+/**
+* Create forum navigation links for given forum, create parent
+* list if currently null, assign basic forum info to template
+*/
+function generate_forum_nav(&$forum_data)
+{
 	global $_CLASS;
-return;
-	$sql = 'SELECT * 
-		FROM ' . REPORTS_REASONS_TABLE . ' 
-		ORDER BY reason_order ASC';
-	$result = $_CLASS['core_db']->query($sql);
+
+	if (!$_CLASS['forums_auth']->acl_get('f_list', $forum_data['forum_id']))
+	{
+		return;
+	}
+
+	// Get forum parents
+	$forum_parents = get_forum_parents($forum_data);
+
+	// Build navigation links
+	foreach ($forum_parents as $parent_forum_id => $parent_data)
+	{
+		list($parent_name, $parent_type) = array_values($parent_data);
+
+		// Skip this parent if the user does not have the permission to view it
+		if (!$_CLASS['forums_auth']->acl_get('f_list', $parent_forum_id))
+		{
+			continue;
+		}
+
+		$_CLASS['core_template']->assign_vars_array('navlinks', array(
+			'S_IS_CAT'		=> ($parent_type == FORUM_CAT) ? true : false,
+			'S_IS_LINK'		=> ($parent_type == FORUM_LINK) ? true : false,
+			'S_IS_POST'		=> ($parent_type == FORUM_POST) ? true : false,
+			'FORUM_NAME'	=> $parent_name,
+			'FORUM_ID'		=> $parent_forum_id,
+			'U_VIEW_FORUM'	=> generate_link('forums&amp;file=viewforum&amp;f='.$parent_forum_id)
+		));
+	}
+
+	$_CLASS['core_template']->assign_vars_array('navlinks', array(
+		'S_IS_CAT'		=> ($forum_data['forum_type'] == FORUM_CAT) ? true : false,
+		'S_IS_LINK'		=> ($forum_data['forum_type'] == FORUM_LINK) ? true : false,
+		'S_IS_POST'		=> ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+		'FORUM_NAME'	=> $forum_data['forum_name'],
+		'FORUM_ID'		=> $forum_data['forum_id'],
+		'U_VIEW_FORUM'	=> generate_link('forums&amp;file=viewforum&amp;f=' . $forum_data['forum_id'])
+	));
+
+	$_CLASS['core_template']->assign_array(array(
+		'FORUM_ID' 		=> $forum_data['forum_id'],
+		'FORUM_NAME'	=> $forum_data['forum_name'],
+		'FORUM_DESC'	=> generate_text_for_display($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options']))
+	);
+
+	return;
+}
 
-	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+/**
+* Returns forum parents as an array. Get them from forum_data if available, or update the database otherwise
+*/
+function get_forum_parents(&$forum_data)
+{
+	global $_CLASS;
+
+	$forum_parents = array();
+
+	if ($forum_data['parent_id'] > 0)
 	{
-		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
-		if (isset($_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) && isset($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		if ($forum_data['forum_parents'] == '')
 		{
-			$row['reson_description'] = $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
-			$row['reason_title'] = $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+			$sql = 'SELECT forum_id, forum_name, forum_type
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE left_id < ' . $forum_data['left_id'] . '
+					AND right_id > ' . $forum_data['right_id'] . '
+				ORDER BY left_id ASC';
+			$result = $_CLASS['core_db']->query($sql);
+
+			while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+			{
+				$forum_parents[$row['forum_id']] = array($row['forum_name'], (int) $row['forum_type']);
+			}
+			$_CLASS['core_db']->free_result($result);
+
+			$forum_data['forum_parents'] = serialize($forum_parents);
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . "
+				SET forum_parents = '" . $_CLASS['core_db']->escape($forum_data['forum_parents']) . "'
+				WHERE parent_id = " . $forum_data['parent_id'];
+			$_CLASS['core_db']->query($sql);
 		}
+		else
+		{
+			$forum_parents = unserialize($forum_data['forum_parents']);
+		}
+	}
 
-		$_CLASS['core_template']->assign_vars_array('reason', array(
-			'ID'			=> $row['reason_id'],
-			'TITLE'			=> $row['reason_title'],
-			'DESCRIPTION'	=> $row['reason_description'],
-			'S_SELECTED'	=> ($row['reason_id'] == $reason_id) ? true : false)
-		);
+	return $forum_parents;
+}
+
+/**
+* Obtain list of moderators of each forum
+*/
+function get_moderators($forum_id = false)
+{
+	global $config, $_CLASS;
+
+	// Have we disabled the display of moderators? If so, then return
+	// from whence we came ...
+	if (!$config['load_moderators'])
+	{
+		return array();
 	}
-	$_CLASS['core_db']->free_result($result);
-}
+
+	$forum_sql = '';
+
+	if ($forum_id !== false)
+	{
+		// If we don't have a forum then we can't have a moderator
+		if (is_array($forum_id) && !sizeof($forum_id))
+		{
+			return;
+		}
+
+		$forum_sql = is_array($forum_id) ? 'AND forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND forum_id = ' . $forum_id;
+	}
+
+	$sql = 'SELECT *
+		FROM ' . FORUMS_MODERATOR_TABLE . "
+		WHERE display_on_index = 1
+			$forum_sql";
+	$result = $_CLASS['core_db']->query($sql);
+	
+	$forum_moderators = array();
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$forum_moderators[$row['forum_id']][] = empty($row['user_id']) ? '<a href="' . generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id']) . '">' . (isset($_CLASS['core_user']->lang['G_' . $row['group_name']]) ? $_CLASS['core_user']->lang['G_' . $row['group_name']] : $row['group_name']) . '</a>' : '<a href="' . generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '">' . $row['username'] . '</a>';
+	}
+	$_CLASS['core_db']->free_result($result);
+
+	return $forum_moderators;
+}
 
-function topic_status(&$topic_row, $replies, $mark_time, &$unread, &$folder_img, &$folder_alt, &$topic_type)
+/**
+* User authorisation levels output
+*/
+function gen_forum_auth_level($mode, $forum_id, $forum_status)
+{
+	global $_CLASS, $config;
+
+	$locked = ($forum_status == ITEM_LOCKED && !$_CLASS['forums_auth']->acl_get('m_edit', $forum_id)) ? true : false;
+
+	$rules = array(
+		($_CLASS['forums_auth']->acl_get('f_post', $forum_id) && !$locked) ? $_CLASS['core_user']->lang['RULES_POST_CAN'] : $_CLASS['core_user']->lang['RULES_POST_CANNOT'],
+		($_CLASS['forums_auth']->acl_get('f_reply', $forum_id) && !$locked) ? $_CLASS['core_user']->lang['RULES_REPLY_CAN'] : $_CLASS['core_user']->lang['RULES_REPLY_CANNOT'],
+		($_CLASS['forums_auth']->acl_gets('f_edit', 'm_edit', $forum_id) && !$locked) ? $_CLASS['core_user']->lang['RULES_EDIT_CAN'] : $_CLASS['core_user']->lang['RULES_EDIT_CANNOT'],
+		($_CLASS['forums_auth']->acl_gets('f_delete', 'm_delete', $forum_id) && !$locked) ? $_CLASS['core_user']->lang['RULES_DELETE_CAN'] : $_CLASS['core_user']->lang['RULES_DELETE_CANNOT'],
+	);
+
+	if ($config['allow_attachments'])
+	{
+		$rules[] = ($_CLASS['forums_auth']->acl_get('f_attach', $forum_id) && $_CLASS['forums_auth']->acl_get('u_attach') && !$locked) ? $_CLASS['core_user']->lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']->lang['RULES_ATTACH_CANNOT'];
+	}
+
+	foreach ($rules as $rule)
+	{
+		$_CLASS['core_template']->assign_vars_array('rules', array('RULE' => $rule));
+	}
+
+	return;
+}
+
+function topic_status(&$topic_row, $replies, $unread_topic, &$folder_img, &$folder_alt, &$topic_type)
 {
 	global $_CLASS, $config;
 
-	$folder = '';
-	$unread = ($mark_time < $topic_row['topic_last_post_time']);
+	$folder = $folder_new = '';
 
-	if ($topic_row['topic_status'] == ITEM_MOVED)
-	{
-		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
-		$folder_img = 'folder_moved';
-		$folder_alt = 'VIEW_TOPIC_MOVED';
-		//$status = 9;
+	if ($topic_row['topic_status'] == ITEM_MOVED)
+	{
+		$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_MOVED'];
+		$folder_img = 'topic_moved';
+		$folder_alt = 'VIEW_TOPIC_MOVED';
+	}
+	else
+	{
+		switch ($topic_row['topic_type'])
+		{
+			case POST_GLOBAL:
+				$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_GLOBAL'];
+				$folder = 'global_read';
+				$folder_new = 'global_unread';
+			break;
+
+			case POST_ANNOUNCE:
+				$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
+				$folder = 'announce_read';
+				$folder_new = 'announce_unread';
+			break;
+
+			case POST_STICKY:
+				$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
+				$folder = 'sticky_read';
+				$folder_new = 'sticky_unread';
+			break;
+
+			default:
+				$topic_type = '';
+				$folder = 'topic_read';
+				$folder_new = 'topic_unread';
+
+				if ($config['hot_threshold'] && $replies >= $config['hot_threshold'])
+				{
+					$folder .= '_hot';
+					$folder_new .= '_hot';
+				}
+			break;
+		}
+
+		if ($topic_row['topic_status'] == ITEM_LOCKED)
+		{
+			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
+			$folder .= '_locked';
+			$folder_new .= '_locked';
+		}
+
+
+		$folder_img = ($unread_topic) ? $folder_new : $folder;
+		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+
+		// Posted image?
+		if (!empty($topic_row['topic_posted']) && $topic_row['topic_posted'])
+		{
+			$folder_img .= '_mine';
+		}
+	}
+
+	if ($topic_row['poll_start'])
+	{
+		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
 	}
-	else
-	{
-		if ($topic_row['topic_status'] == ITEM_LOCKED)
-		{
-			$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_LOCKED'];
-			$folder_img = ($unread) ? 'folder_locked_new' :'folder_locked';
-			//$status = ($unread) ? 11 : 10;
-		}
-		else
-		{
-			switch ($topic_row['topic_type'])
-			{
-				case POST_GLOBAL:
-				case POST_ANNOUNCE:
-					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_ANNOUNCEMENT'];
-					$folder_img = ($unread) ? 'folder_announce_new' : 'folder_announce';
-					//$status = ($unread) ? 8 : 7;
-				break;
-	
-				case POST_STICKY:
-					$topic_type = $_CLASS['core_user']->lang['VIEW_TOPIC_STICKY'];
-					$folder_img = ($unread) ? 'folder_sticky_new' : 'folder_sticky';
-					//$status = ($unread) ? 6 : 5;
-				break;
-	
-				default:
-					if ($config['hot_threshold'] && $replies >= $config['hot_threshold'])
-					{
-						$folder_img = ($unread) ? 'folder_hot_new': 'folder_hot';
-						//$status = ($unread) ? 4 : 3;
-					}
-					else
-					{
-						$folder_img = ($unread) ? 'folder_new' : 'folder';
-						//$status = ($unread) ? 2 : 1;
-					}
-				break;
-			}
-		}
-
-		$folder_alt = ($unread) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
-	}
-
-	if ($topic_row['poll_start'])
-	{
-		$topic_type .= $_CLASS['core_user']->lang['VIEW_TOPIC_POLL'];
-	}
-
-	//return $status;
 }
 
 // Display Attachments
@@ -573,4 +742,346 @@
 	return $datas;
 }
 
+/**
+* Assign/Build custom bbcodes for display in screens supporting using of bbcodes
+* The custom bbcodes buttons will be placed within the template block 'custom_codes'
+*/
+function display_custom_bbcodes()
+{
+	global $_CLASS;
+
+	// Start counting from 22 for the bbcode ids (every bbcode takes two ids - opening/closing)
+	$num_predefined_bbcodes = 22;
+
+	/*
+	* @todo while adjusting custom bbcodes, think about caching this query as well as correct ordering
+	*/
+	$sql = 'SELECT bbcode_id, bbcode_tag, bbcode_helpline
+		FROM ' . FORUMS_BBCODES_TABLE . '
+		WHERE display_on_posting = 1';
+	$result = $_CLASS['core_db']->query($sql);
+
+	$i = 0;
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		$_CLASS['core_template']->assign_vars_array('custom_tags', array(
+			'BBCODE_NAME'		=> "'[{$row['bbcode_tag']}]', '[/" . str_replace('=', '', $row['bbcode_tag']) . "]'",
+			'BBCODE_ID'			=> $num_predefined_bbcodes + ($i * 2),
+			'BBCODE_TAG'		=> $row['bbcode_tag'],
+			'BBCODE_HELPLINE'	=> $row['bbcode_helpline']
+		));
+
+		$i++;
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+
+/**
+* Display reasons
+*/
+function display_reasons($reason_id = 0)
+{
+	global $_CLASS;
+return;
+	$sql = 'SELECT * 
+		FROM ' . REPORTS_REASONS_TABLE . ' 
+		ORDER BY reason_order ASC';
+	$result = $_CLASS['core_db']->query($sql);
+
+	while ($row = $_CLASS['core_db']->fetch_row_assoc($result))
+	{
+		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
+		if (isset($_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) && isset($_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		{
+			$row['reson_description'] = $_CLASS['core_user']->lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
+			$row['reason_title'] = $_CLASS['core_user']->lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+		}
+
+		$_CLASS['core_template']->assign_vars_array('reason', array(
+			'ID'			=> $row['reason_id'],
+			'TITLE'			=> $row['reason_title'],
+			'DESCRIPTION'	=> $row['reason_description'],
+			'S_SELECTED'	=> ($row['reason_id'] == $reason_id) ? true : false)
+		);
+	}
+	$_CLASS['core_db']->free_result($result);
+}
+
+/**
+* Display user activity (action forum/topic)
+*/
+function display_user_activity(&$userdata)
+{
+	global $auth, $template, $db, $user;
+	global $phpbb_root_path, $phpEx;
+
+	// Init new auth class if user is different
+	if ($user->data['user_id'] != $userdata['user_id'])
+	{
+		$auth2 = new auth();
+		$auth2->acl($userdata);
+
+		$post_count_ary = $auth2->acl_getf('!f_postcount');
+	}
+	else
+	{
+		$post_count_ary = $auth->acl_getf('!f_postcount');
+	}
+
+	$forum_read_ary = $auth->acl_getf('!f_read');
+
+	$forum_ary = array();
+
+	// Do not include those forums the user is not having read access to...
+	foreach ($forum_read_ary as $forum_id => $not_allowed)
+	{
+		if ($not_allowed['f_read'])
+		{
+			$forum_ary[] = (int) $forum_id;
+		}
+	}
+
+	// Now do not include those forums where the posts do not count...
+	foreach ($post_count_ary as $forum_id => $not_counted)
+	{
+		if ($not_counted['f_postcount'])
+		{
+			$forum_ary[] = (int) $forum_id;
+		}
+	}
+
+	$forum_ary = array_unique($forum_ary);
+	$post_count_sql = (sizeof($forum_ary)) ? 'AND ' . $db->sql_in_set('f.forum_id', $forum_ary, true) : '';
+
+	// Firebird does not support ORDER BY on aliased columns
+	// MySQL does not support ORDER BY on functions
+	switch (SQL_LAYER)
+	{
+		case 'firebird':
+			$sql = 'SELECT f.forum_id, COUNT(p.post_id) AS num_posts
+				FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+				WHERE p.poster_id = ' . $userdata['user_id'] . " 
+					AND f.forum_id = p.forum_id 
+					$post_count_sql
+				GROUP BY f.forum_id
+				ORDER BY COUNT(p.post_id) DESC";
+		break;
+
+		default:
+			$sql = 'SELECT f.forum_id, COUNT(p.post_id) AS num_posts
+				FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+				WHERE p.poster_id = ' . $userdata['user_id'] . " 
+					AND f.forum_id = p.forum_id 
+					$post_count_sql
+				GROUP BY f.forum_id
+				ORDER BY num_posts DESC";
+		break;
+	}
+
+	$result = $db->sql_query_limit($sql, 1);
+	$active_f_row = $db->sql_fetchrow($result);
+	$db->sql_freeresult($result);
+
+	if (!empty($active_f_row))
+	{
+		$sql = 'SELECT forum_name
+			FROM ' . FORUMS_TABLE . '
+			WHERE forum_id = ' . $active_f_row['forum_id'];
+		$result = $db->sql_query($sql, 3600);
+		$active_f_row['forum_name'] = (string) $db->sql_fetchfield('forum_name');
+		$db->sql_freeresult($result);
+	}
+
+	// Firebird does not support ORDER BY on aliased columns
+	// MySQL does not support ORDER BY on functions
+	switch (SQL_LAYER)
+	{
+		case 'firebird':
+			$sql = 'SELECT t.topic_id, COUNT(p.post_id) AS num_posts   
+				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+				WHERE p.poster_id = ' . $userdata['user_id'] . " 
+					AND t.topic_id = p.topic_id  
+					AND f.forum_id = t.forum_id 
+					$post_count_sql
+				GROUP BY t.topic_id
+				ORDER BY COUNT(p.post_id) DESC";
+		break;
+
+		default:
+			$sql = 'SELECT t.topic_id, COUNT(p.post_id) AS num_posts   
+				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+				WHERE p.poster_id = ' . $userdata['user_id'] . " 
+					AND t.topic_id = p.topic_id  
+					AND f.forum_id = t.forum_id 
+					$post_count_sql
+				GROUP BY t.topic_id
+				ORDER BY num_posts DESC";
+		break;
+	}
+
+	$result = $db->sql_query_limit($sql, 1);
+	$active_t_row = $db->sql_fetchrow($result);
+	$db->sql_freeresult($result);
+
+	if (!empty($active_t_row))
+	{
+		$sql = 'SELECT topic_title
+			FROM ' . TOPICS_TABLE . '
+			WHERE topic_id = ' . $active_t_row['topic_id'];
+		$result = $db->sql_query($sql);
+		$active_t_row['topic_title'] = (string) $db->sql_fetchfield('topic_title');
+		$db->sql_freeresult($result);
+	}
+
+	$userdata['active_t_row'] = $active_t_row;
+	$userdata['active_f_row'] = $active_f_row;
+
+	$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+	if (!empty($active_f_row['num_posts']))
+	{
+		$active_f_name = $active_f_row['forum_name'];
+		$active_f_id = $active_f_row['forum_id'];
+		$active_f_count = $active_f_row['num_posts'];
+		$active_f_pct = ($userdata['user_posts']) ? ($active_f_count / $userdata['user_posts']) * 100 : 0;
+	}
+
+	$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+	if (!empty($active_t_row['num_posts']))
+	{
+		$active_t_name = $active_t_row['topic_title'];
+		$active_t_id = $active_t_row['topic_id'];
+		$active_t_count = $active_t_row['num_posts'];
+		$active_t_pct = ($userdata['user_posts']) ? ($active_t_count / $userdata['user_posts']) * 100 : 0;
+	}
+
+	$template->assign_vars(array(
+		'ACTIVE_FORUM'			=> $active_f_name,
+		'ACTIVE_FORUM_POSTS'	=> ($active_f_count == 1) ? sprintf($user->lang['USER_POST'], 1) : sprintf($user->lang['USER_POSTS'], $active_f_count),
+		'ACTIVE_FORUM_PCT'		=> sprintf($user->lang['POST_PCT_ACTIVE'], $active_f_pct),
+		'ACTIVE_TOPIC'			=> censor_text($active_t_name),
+		'ACTIVE_TOPIC_POSTS'	=> ($active_t_count == 1) ? sprintf($user->lang['USER_POST'], 1) : sprintf($user->lang['USER_POSTS'], $active_t_count),
+		'ACTIVE_TOPIC_PCT'		=> sprintf($user->lang['POST_PCT_ACTIVE'], $active_t_pct),
+		'U_ACTIVE_FORUM'		=> append_sid("{$phpbb_root_path}viewforum.$phpEx", 'f=' . $active_f_id),
+		'U_ACTIVE_TOPIC'		=> append_sid("{$phpbb_root_path}viewtopic.$phpEx", 't=' . $active_t_id))
+	);
+}
+
+// Topic and forum watching common code
+//do we need user_id ?
+function watch_topic_forum($mode, $user_id, $forum_id, $topic_id, $notify_status = 'unset', $start = 0)
+{
+	global $_CLASS, $config, $_CORE_CONFIG;
+
+	if (!$_CLASS['core_user']->is_user || !$_CORE_CONFIG['email']['email_enable'] || !$config['allow_topic_notify'])
+	{
+		return array('link' => '', 'title' => '', 'watching' => false);
+	}
+
+	if ($mode == 'forum')
+	{
+		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id = 0";
+		$url = 'f='.$forum_id;
+	}
+	else
+	{
+		$where = "user_id = $user_id AND forum_id = $forum_id AND topic_id IN ($topic_id, 0)";
+		$url = 't='.$topic_id;
+	}
+
+	$is_watching = false;
+
+	if ($notify_status == 'unset')
+	{
+		// Is user watching this thread?
+		$sql = 'SELECT notify_status
+			FROM '.FORUMS_WATCH_TABLE."
+			 WHERE $where";
+
+		$result = $_CLASS['core_db']->query($sql);
+
+		$notify_status = ($row = $_CLASS['core_db']->fetch_row_assoc($result)) ? $row['notify_status'] : null;
+		$_CLASS['core_db']->free_result($result);
+	}
+
+	if (is_null($notify_status))
+	{
+		if (isset($_GET['watch']))
+		{
+			if ($_GET['watch'] == $mode)
+			{
+				$is_watching = true;
+
+				// Remove all topics that are being watched, we watching the whole forum dude
+				if ($mode == 'forum')
+				{
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
+						WHERE forum_id = $forum_id
+							AND user_id = $user_id";
+				
+					$_CLASS['core_db']->query($sql);
+				}
+
+				$sql_array = array(
+					'user_id' => (int) $user_id,
+					'forum_id' => $forum_id,
+					'topic_id' => $topic_id,
+					'notify_status' => 0,
+					'notify_type' => 0
+				);
+
+				$_CLASS['core_db']->sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
+			}
+
+			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			$message = $_CLASS['core_user']->lang['ARE_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
+			trigger_error($message);
+		}
+	}
+	else
+	{
+		if (isset($_GET['unwatch']))
+		{
+			if ($_GET['unwatch'] == $mode)
+			{
+				$is_watching = false;
+
+				if ($mode == 'forum')
+				{
+					$where_delete = "forum_id = $forum_id AND topic_id = 0";
+				}
+				else
+				{
+					$where_delete = "forum_id = $forum_id AND topic_id = $topic_id";
+				}
+
+				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . "
+							WHERE user_id = $user_id AND $where_delete";
+
+				$_CLASS['core_db']->query($sql);
+			}
+
+			$_CLASS['core_display']->meta_refresh(3, generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start"));
+			$message = $_CLASS['core_user']->lang['NOT_WATCHING_' . strtoupper($mode)] . '<br /><br />' . sprintf($_CLASS['core_user']->lang['RETURN_' . strtoupper($mode)], '<a href="' . generate_link("Forums&amp;file=view$mode&amp;$url&amp;start=$start") . '">', '</a>');
+			trigger_error($message);
+		}
+		else
+		{
+			$is_watching = true;
+
+			if ($notify_status)
+			{
+				$sql = 'UPDATE ' . FORUMS_WATCH_TABLE . "
+					SET notify_status = 0
+					WHERE $where";
+				$_CLASS['core_db']->query($sql);
+			}
+		}
+	}
+
+	return array(
+			'watching' => true,
+			'link' => generate_link("forums&amp;file=view$mode&amp;$url&amp;" . (($is_watching) ? 'unwatch' : 'watch') . "=$mode&amp;start=$start"),
+			'title' => $_CLASS['core_user']->lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
+	);
+}
 ?>
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -484,33 +484,6 @@
 	return true;
 }
 
-// DECODE TEXT -> This will/should be handled by bbcode.php eventually
-function decode_message(&$message, $bbcode_uid = '')
-{
-	global $config;
-
-	$match = array('<br />', "[/*:m:$bbcode_uid]", ":u:$bbcode_uid", ":o:$bbcode_uid", ":$bbcode_uid");
-	$replace = array("\n", '', '', '', '');
-
-	$message = ($bbcode_uid) ? str_replace($match, $replace, $message) : str_replace('<br />', "\n", $message);
-
-	$match = array(
-		'#<!\-\- e \-\-><a href="mailto:(.*?)">.*?</a><!\-\- e \-\->#',
-		'#<!\-\- m \-\-><a href="(.*?)" target="_blank">.*?</a><!\-\- m \-\->#',
-		'#<!\-\- w \-\-><a href="http:\/\/(.*?)" target="_blank">.*?</a><!\-\- w \-\->#',
-		'#<!\-\- l \-\-><a href="(.*?)">.*?</a><!\-\- l \-\->#',
-		'#<!\-\- s(.*?) \-\-><img src="\{SMILIES_PATH\}\/.*? \/><!\-\- s\1 \-\->#',
-		'#<!\-\- h \-\-><(.*?)><!\-\- h \-\->#',
-		'#<.*?>#s'
-	);
-	
-	$replace = array('\1', '\1', '\1', '\1', '\1', '&lt;\1&gt;', '');
-	
-	$message = preg_replace($match, $replace, $message);
-
-	return;
-}
-
 // Generate Topic Icons for display
 function posting_gen_topic_icons($mode, $icon_id)
 {

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/message_parser.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -66,26 +66,15 @@
 			}
 			else
 			{
-				// TODO: Review this
-				$found = false;
 				foreach ($bbcode_data['regexp'] as $regexp => $replacement)
 				{
-					if (!$found)
+					// The pattern gets compiled and cached by the PCRE extension,
+					// it should not demand recompilation
+					if (preg_match($regexp, $this->message))
 					{
-						$before = strlen($this->message);
+						$this->message = preg_replace($regexp, $replacement, $this->message);
+						$bitfield->set($bbcode_data['bbcode_id']);
 					}
-					$this->message = preg_replace($regexp, $replacement, $this->message);
-					if (!$found)
-					{
-						$after = strlen($this->message);
-						if ($before != $after)
-						{
-							// Because we add bbcode_uid to all tags, the message length
-							// will increase whenever a tag is found
-							$bitfield->set($bbcode_data['bbcode_id']);
-							$found = true;
-						}
-					}
 				}
 			}
 		}

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/functions.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -533,6 +533,32 @@
     return ($options['full']) ? generate_base_url().$link : $link;
 }
 
+function generate_size($value, $array = false)
+{
+	global $_CLASS;
+
+	if ($value >= 1048576)
+	{
+		$return = array('size' => round((round($value / 1048576 * 100) / 100), 2), 'size_name' => $_CLASS['core_user']->lang['MB']);
+	}
+	elseif ($value >= 1024)
+	{
+		$return = array('size' => round((round($value / 1024 * 100) / 100), 2), 'size_name' => $_CLASS['core_user']->lang['KB']);
+	}
+	else
+	{
+		$return = array('size' => round($value, 2), 'size_name' => $_CLASS['core_user']->lang['BYTES']);
+	}
+	
+	if (!$array)
+	{
+		$return['size'] = number_format($return['size'], 2);
+		return implode(' ', $return);
+	}
+
+	return $return;
+}
+
 function generate_hidden_fields($fields)
 {
 	$hidden_fields = '';

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/tables.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -173,7 +173,10 @@
 define('FORUMS_ACCESS_TABLE', $table_prefix.'forums_access');
 define('FORUMS_ICONS_TABLE', $table_prefix.'forums_icons');
 define('FORUMS_LOG_TABLE', $table_prefix.'forums_log');
+
 define('FORUMS_MODERATOR_TABLE', $table_prefix.'forums_moderator_cache');
+define('FORUMS_MODERATOR_CACHE_TABLE', $table_prefix.'forums_moderator_cache');
+
 define('FORUMS_MODULES_TABLE', $table_prefix . 'forums_modules');
 define('FORUMS_POSTS_TABLE', $table_prefix.'forums_posts');
 define('FORUMS_PRIVMSGS_TABLE', $table_prefix.'forums_privmsgs');
@@ -185,7 +188,7 @@
 define('FORUMS_SITELIST_TABLE', $table_prefix.'forums_sitelist');
 define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
 define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
-define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');
+define('FORUMS_SEARCH_WORDMATCH_TABLE', $table_prefix.'forums_search_wordmatch');
 define('FORUMS_TOPICS_TABLE', $table_prefix.'forums_topics');
 define('FORUMS_POLL_OPTIONS_TABLE', $table_prefix.'forums_poll_results');
 define('FORUMS_POLL_VOTES_TABLE', $table_prefix.'forums_poll_voters');

Added: cms/trunk/includes/templates/admin/eaccelerator/index.html
===================================================================
--- cms/trunk/includes/templates/admin/eaccelerator/index.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/admin/eaccelerator/index.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,318 @@
+<!-- DISPLAY_HEADER -->
+
+{ $THEME_TABLE_OPEN }
+
+<!-- IF { $eaccelerator_info } -->
+
+<table border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<td width="50%" valign="top">
+				<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+					<tbody>
+						<tr>
+							<th width="25%" colspan="2" align="center"><b>eAccelerator Info</b></td>
+						</tr>
+						<tr class="row1">
+							<td>
+								eAccelerator Version
+							</td>
+							<td>
+								{ $version }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Caching enabled
+							</td>
+							<td>
+								<!-- IF { $cache } -->
+									<img src="images/led_green.png" alt="Enabled" title="Enabled" border="0">
+								<!-- ELSE -->
+									<img src="images/led_red.png" alt="Disabled" title="Disabled" border="0">
+								<!-- ENDIF -->
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Optimizer enabled
+							</td>
+							<td>
+								<!-- IF { $optimizer } -->
+									<img src="images/led_green.png" alt="Enabled" title="Enabled" border="0">
+								<!-- ELSE -->
+									<img src="images/led_red.png" alt="Disabled" title="Disabled" border="0">
+								<!-- ENDIF -->
+							</td>
+						</tr>
+						<tr class="row2">
+							<td colspan="2">
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Memory Usage
+							</td>
+							<td>
+								{ $memory_usage }%
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Memory Total
+							</td>
+							<td>
+								{ $memory_size }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Memory Used
+							</td>
+							<td>
+								{ $memory_allocated }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								 Memory Free
+							</td>
+							<td>
+								{ $memory_available }
+							</td>
+						</tr>
+						<tr class="row2">
+							<td colspan="2">
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Cached scripts
+							</td>
+							<td>
+								{ $cached_scripts }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Removed scripts
+							</td>
+							<td>
+								{ $removed_scripts }
+							</td>
+						</tr>
+						<tr class="row1">
+							<td>
+								Cached keys
+							</td>
+							<td>
+								{ $cached_keys }
+							</td>
+						</tr>
+					</tbody>
+				</table>
+			<td width="50%" valign="top">
+				<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+					<tbody>
+						<tr>
+							<th width="25%" colspan="2" align="center"><b>eAccelerator</b></td>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $caching_link }'; return false;">
+								<a href="{ $caching_link }">{ $caching_link_title }</a>
+							</td>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $optimizer_link }'; return false;">
+								<a href="{ $optimizer_link }">{ $optimizer_link_title }</a>
+							</td>
+						</tr>
+						<tr>
+							<td class="row2" colspan="2" style="padding: 4px;"></th>
+						</tr>
+						<tr>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $purge_cache_link }'; return false;">
+								<a href="{ $purge_cache_link }">{ $purge_cache_link_title }</a>
+							</td>
+							<td align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $clean_cache_link }'; return false;">
+								<a href="{ $clean_cache_link }">{ $clean_cache_link_title }</a>
+							</td>
+						</tr>
+						<tr>
+							<td  colspan="2" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'" onclick="location.href='{ $clear_cache_link }'; return false;">
+								<a href="{ $clear_cache_link }">{ $clear_cache_link_title }</a>
+							</td>
+						</tr>
+						<tr>
+							<td class="row2" colspan="2" style="padding: 4px;"></th>
+						</tr>
+						<tr>
+							<td  colspan="2" align="center" class="row1" onmouseover="this.className='row2'" onmouseout="this.className='row1'">
+<strong>Purge the cache</strong>
+<br/>
+Removed all scripts that are marked for deletetion. This will happen automaticly when shared memory is needed.
+<br/><br/>
+<strong>Clean the cache</strong><br/>
+Remove all expired scripts and data from shared memory and disk cache.
+<br/><br/>
+<strong>Clear the cache</strong>
+<br/>
+Remove all unused scripts and data from shared memory and disk cache, this means all data that isn't used in the current requests.
+<br/><br/>
+optimizer which may speed up code execution
+
+							</td>
+						</tr>
+					</tbody>
+				</table>
+			</td>
+		</tr>
+    </tbody>
+</table>
+<!-- ENDIF -->
+
+<!-- IF !empty({ $scripts_array }) -->
+
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<th colspan="5" align="center"><b>Last 5 Current Cached Files</b></td>
+		</tr>
+		<tr>
+			<td colspan="5" class="row2" style="padding: 4px;"></th>
+		</tr>
+		<tr>
+			<th align="center"><b>Filename</b></td>
+			<th align="center"><b>Time</b></td>
+			<th align="center"><b>File Size</b></td>
+			<th align="center"><b>Reloads</b></td>
+			<th align="center"><b>Hits</b></td>
+		</tr>
+		<!-- LOOP $scripts_array -->
+		<tr>
+			<td class="row1">
+				{ $scripts_array:file }
+			</td>
+			<td align="center" class="row1">
+				{ $scripts_array:time }
+			</td>
+			<td align="center" class="row1">
+				{ $scripts_array:size }
+			</td>
+			<td align="center" class="row1">
+				{ $scripts_array:reloads }
+			</td>
+			<td align="center" class="row1">
+				{ $scripts_array:hits }
+			</td>
+		</tr>
+		<!-- ENDLOOP $scripts_array-->
+		<tr>
+			<td colspan="5" class="row2" align="center" style="padding: 4px;">
+			<!-- IF { $scripts_more } && isset({ $link_scripts }) -->
+				<a href="{ $link_scripts }">View More</a>
+			<!-- ELSE -->
+				{ $scripts_pagination }
+			<!-- ENDIF -->
+			</td>
+		</tr>
+	</tbody>
+</table>
+<!-- ENDIF -->
+
+<br />
+<!-- IF !empty({ $removed_scripts_array }) -->
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<th colspan="5" align="center"><b>Last 5 Removed Cached Files</b></td>
+		</tr>
+		<tr>
+			<td colspan="5" class="row2" style="padding: 4px;"></th>
+		</tr>
+		<tr>
+			<th align="center"><b>Filename</b></td>
+			<th align="center"><b>Time</b></td>
+			<th align="center"><b>File Size</b></td>
+			<th align="center"><b>Reloads</b></td>
+			<th align="center"><b>Hits</b></td>
+		</tr>
+		<!-- LOOP $removed_scripts_array -->
+		<tr>
+			<td class="row1">
+				{ $removed_scripts_array:file }
+			</td>
+			<td align="center" class="row1">
+				{ $removed_scripts_array:time }
+			</td>
+			<td align="center" class="row1">
+				{ $removed_scripts_array:size }
+			</td>
+			<td align="center" class="row1">
+				{ $removed_scripts_array:reloads }
+			</td>
+			<td align="center" class="row1">
+				{ $removed_scripts_array:hits }
+			</td>
+		</tr>
+		<!-- ENDLOOP $removed_scripts_array -->
+		<tr>
+			<td colspan="5" class="row2" align="center" style="padding: 4px;">
+			<!-- IF { $removed_scripts_more } && isset({ $link_removed_scripts })  -->
+				<a href="{ $link_removed_scripts }">View More</a>
+			<!-- ELSE -->
+				{ $removed_scripts_pagination }
+			<!-- ENDIF -->
+			</td>
+		</tr>
+	</tbody>
+</table>
+<!-- ENDIF -->
+
+<br />
+
+<!-- IF !empty({ $keys_array }) -->
+<table class="tablebg" border="0" cellpadding="4" cellspacing="1" width="100%">
+	<tbody>
+		<tr>
+			<th colspan="5" align="center"><b>Last 5 Current Keys</b></td>
+		</tr>
+		<tr>
+			<td colspan="5" class="row2" style="padding: 4px;"></th>
+		</tr>
+		<tr>
+			<th align="center"><b>Name</b></td>
+			<th align="center"><b>Created</b></td>
+			<th align="center"><b>Size</b></td>
+			<th align="center"><b>Expires</b></td>
+		</tr>
+		<!-- LOOP $keys_array -->
+		<tr>
+			<td class="row1">
+				{ $keys_array:name }
+			</td>
+			<td align="center" class="row1">
+				{ $keys_array:created }
+			</td>
+			<td align="center" class="row1">
+				{ $keys_array:size }
+			</td>
+			<td align="center" class="row1">
+				{ $keys_array:expire_time }
+			</td>
+		</tr>
+		<!-- ENDLOOP $keys_array -->
+		<tr>
+			<td colspan="5" class="row2" align="center" style="padding: 4px;">
+				<!-- IF { $keys_more } && isset({ $link_keys })  -->
+					<a href="{ $link_keys }">View More</a>
+			<!-- ELSE -->
+				{ $link_pagination }
+			<!-- ENDIF -->
+			</td>
+		</tr>
+	</tbody>
+</table>
+<!-- ENDIF -->
+
+{ $THEME_TABLE_CLOSE }
+
+<!-- DISPLAY_FOOTER -->
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/forums/admin/acp_forums.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/admin/acp_forums.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/modules/forums/admin/acp_forums.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,538 @@
+<!-- INCLUDE modules/forums/admin/overall_header.html -->
+
+<a name="maincontent"></a>
+
+<!-- IF { $S_EDIT_FORUM } -->
+
+	<script type="text/javascript">
+	<!--
+
+		function display_options(value)
+		{
+			<!-- IF !{ $S_ADD_ACTION } && { $S_FORUM_ORIG_POST } -->
+				if (value == { $FORUM_POST })
+				{
+					dE('type_actions', -1);
+				}
+				else
+				{
+					dE('type_actions', 1);
+				}
+			<!-- ENDIF -->
+
+			if (value == { $FORUM_POST })
+			{
+				dE('forum_post_options', 1);
+				dE('forum_link_options', -1);
+				dE('forum_rules_options', 1);
+				dE('forum_cat_options', -1);
+			}
+			else if (value == { $FORUM_LINK })
+			{
+				dE('forum_post_options', -1);
+				dE('forum_link_options', 1);
+				dE('forum_rules_options', -1);
+				dE('forum_cat_options', -1);
+			}
+			else if (value == { $FORUM_CAT })
+			{
+				dE('forum_post_options', -1);
+				dE('forum_link_options', -1);
+				dE('forum_rules_options', 1);
+				dE('forum_cat_options', 1);
+			}
+		}
+
+	//-->
+	</script>
+
+	<a href="{ $U_BACK }" style="float: right">&laquo; { $L_BACK}</a>
+
+	<h1>{ $L_TITLE } :: { $FORUM_NAME }</h1>
+
+	<p>{ $L_FORUM_EDIT_EXPLAIN }</p>
+
+	<!-- IF { $S_ERROR } -->
+		<div class="errorbox">
+			<h3>{ $L_WARNING }</h3>
+			<p>{ $ERROR_MSG }</p>
+		</div>
+	<!-- ENDIF -->
+
+	<form id="forumedit" method="post" action="{ $U_EDIT_ACTION }">
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">{ $L_FORUM_SETTINGS }</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_TYPE }:
+		</td>
+		<td class="row2">
+			<select id="forum_type" name="forum_type" onchange="display_options(this.options[this.selectedIndex].value);">{ $S_FORUM_TYPE_OPTIONS }</select>
+		</td>
+	</tr>
+
+	<!-- IF !{ $S_ADD_ACTION } && { $S_FORUM_ORIG_POST } -->
+	<tr id="type_actions"<!-- IF { $S_FORUM_POST } --> style="display: none;"<!-- ENDIF -->>
+		<td  width="40%" class="row1">
+			{ $L_DECIDE_MOVE_DELETE_CONTENT }:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" id="type_action" name="type_action" value="delete" checked="checked" /> { $L_DELETE_ALL_POSTS }
+			<!-- IF { $S_MOVE_FORUM_OPTIONS } --><input type="radio" class="radio" name="type_action" value="move" /> { $L_MOVE_POSTS_TO } <select name="to_forum_id">{ $S_MOVE_FORUM_OPTIONS }</select><!-- ENDIF -->
+		</td>
+	</tr>
+	<!-- ENDIF -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_PARENT }:
+		</td>
+		<td class="row2">
+			<select id="parent" name="forum_parent_id"><option value="0"<!-- IF !{ $S_FORUM_PARENT_ID } --> selected="selected"<!-- ENDIF -->>{ $L_NO_PARENT }</option>{ $S_PARENT_OPTIONS }</select>
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_NAME }:
+		</td>
+		<td class="row2">
+			<input class="medium" type="text" id="forum_name" name="forum_name" value="{ $FORUM_NAME }" />
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_DESC }:<br /><span>{ $L_FORUM_DESC_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<textarea id="forum_desc" name="forum_desc" rows="5" cols="45">{ $FORUM_DESC }</textarea>
+			<br />
+			<input type="checkbox" class="radio" name="desc_parse_bbcode"<!-- IF { $S_DESC_BBCODE_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_BBCODE } &nbsp; <input type="checkbox" class="radio" name="desc_parse_smilies"<!-- IF { $S_DESC_SMILIES_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_SMILIES } &nbsp; <input type="checkbox" class="radio" name="desc_parse_urls"<!-- IF { $S_DESC_URLS_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_URLS }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_IMAGE }:<br /><span>{ $L_FORUM_IMAGE_EXPLAIN }</span></dt>
+		</td>
+		<td class="row2">
+			<input class="medium" type="text" id="forum_image" name="forum_image" value="{ $FORUM_IMAGE }" />
+		<!-- IF { $FORUM_IMAGE_SRC } -->
+			<img src="{ $FORUM_IMAGE_SRC }" alt="{ $L_FORUM_IMAGE }" />
+		<!-- ENDIF -->
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_STYLE }:</dt>
+		</td>
+		<td class="row2">
+			<select id="forum_style" name="forum_style"><option value="0">{ $L_DEFAULT_STYLE }</option>{ $S_STYLES_OPTIONS }</select>
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_COPY_PERMISSIONS }:<br /><span>{ $L_COPY_PERMISSIONS_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<select id="forum_perm_from" name="forum_perm_from"><option value="0">{ $L_NO_PERMISSIONS }</option>{ $S_FORUM_OPTIONS }</select>
+		</td>
+	</tr>
+</table>
+
+<div id="forum_cat_options"<!-- IF !{ $S_FORUM_CAT } --> style="display: none;"<!-- ENDIF -->>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_GENERAL_FORUM_SETTINGS }
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_DISPLAY_ACTIVE_TOPICS }:<br /><span>{ $L_DISPLAY_ACTIVE_TOPICS_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="display_active" value="1"<!-- IF { $S_DISPLAY_ACTIVE_TOPICS } --> id="display_active" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="display_active" value="0"<!-- IF !{ $S_DISPLAY_ACTIVE_TOPICS } --> id="display_active" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+</table>
+
+</div>
+
+<div id="forum_post_options"<!-- IF !{ $S_FORUM_POST } --> style="display: none;"<!-- ENDIF -->>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_GENERAL_FORUM_SETTINGS }</legend>
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			<label for="forum_status">{ $L_FORUM_STATUS }:
+		</td>
+		<td class="row2">
+			<select id="forum_status" name="forum_status">{ $S_STATUS_OPTIONS }</select>
+		</td>
+	</tr>
+	<!-- IF { $S_SHOW_DISPLAY_ON_INDEX } -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_LIST_INDEX }:<br /><span>{ $L_LIST_INDEX_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="display_on_index" value="1"<!-- IF { $S_DISPLAY_ON_INDEX } --> id="display_on_index" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="display_on_index" value="0"<!-- IF !{ $S_DISPLAY_ON_INDEX } --> id="display_on_index" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<!-- ENDIF -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ENABLE_POST_REVIEW }:<br /><span>{ $L_ENABLE_POST_REVIEW_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="enable_post_review" value="1"<!-- IF { $S_ENABLE_POST_REVIEW } --> id="enable_post_review" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="enable_post_review" value="0"<!-- IF !{ $S_ENABLE_POST_REVIEW } --> id="enable_post_review" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ENABLE_INDEXING }:<br /><span>{ $L_ENABLE_INDEXING_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="enable_indexing" value="1"<!-- IF { $S_ENABLE_INDEXING } --> id="enable_indexing" checked="checked"<!-- ENDIF --> /> { $L_YES} &nbsp; <input type="radio" class="radio" name="enable_indexing" value="0"<!-- IF !{ $S_ENABLE_INDEXING } --> id="enable_indexing" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ENABLE_TOPIC_ICONS }:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="enable_icons" value="1"<!-- IF { $S_TOPIC_ICONS } --> id="enable_icons" checked="checked"<!-- ENDIF --> /> { $L_YES} &nbsp; <input type="radio" class="radio" name="enable_icons" value="0"<!-- IF !{ $S_TOPIC_ICONS } --> id="enable_icons" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ENABLE_RECENT }:<br /><span>{ $L_ENABLE_RECENT_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="display_recent" value="1"<!-- IF { $S_DISPLAY_ACTIVE_TOPICS } --> id="display_recent" checked="checked"<!-- ENDIF --> /> { $L_YES} &nbsp; <input type="radio" class="radio" name="display_recent" value="0"<!-- IF !{ $S_DISPLAY_ACTIVE_TOPICS } --> id="display_recent" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_TOPICS_PAGE }:<br /><span>{ $L_FORUM_TOPICS_PAGE_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="text" id="topics_per_page" name="topics_per_page" value="{ $TOPICS_PER_PAGE }" />
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_PASSWORD }:<br /><span>{ $L_FORUM_PASSWORD_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="password" id="forum_password" name="forum_password" value="{ $FORUM_PASSWORD }" />
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_PASSWORD_CONFIRM }:<br /><span>{ $L_FORUM_PASSWORD_CONFIRM_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="password" id="forum_password_confirm" name="forum_password_confirm" value="{ $FORUM_PASSWORD_CONFIRM }" />
+		</td>
+	</tr>
+</table>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_FORUM_PRUNE_SETTINGS }
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_AUTO_PRUNE }:<br /><span>{ $L_FORUM_AUTO_PRUNE_EXPLAIN}</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="enable_prune" value="1"<!-- IF { $S_PRUNE_ENABLE } --> id="enable_prune" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="enable_prune" value="0"<!-- IF !{ $S_PRUNE_ENABLE } --> id="enable_prune" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_AUTO_PRUNE_FREQ }:<br /><span>{ $L_AUTO_PRUNE_FREQ_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="text" id="prune_freq" name="prune_freq" value="{ $PRUNE_FREQ }" /> { $L_DAYS }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_AUTO_PRUNE_DAYS }:<br /><span>{ $L_AUTO_PRUNE_DAYS_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="text" id="prune_days" name="prune_days" value="{ $PRUNE_DAYS }" /> { $L_DAYS }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_AUTO_PRUNE_VIEWED }:<br /><span>{ $L_AUTO_PRUNE_VIEWED_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="text" id="prune_viewed" name="prune_viewed" value="{ $PRUNE_VIEWED }" /> { $L_DAYS }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_PRUNE_OLD_POLLS }:<br /><span>{ $L_PRUNE_OLD_POLLS_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="prune_old_polls" value="1"<!-- IF { $S_PRUNE_OLD_POLLS } --> id="prune_old_polls" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="prune_old_polls" value="0"<!-- IF !{ $S_PRUNE_OLD_POLLS } --> id="prune_old_polls" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_PRUNE_ANNOUNCEMENTS}:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="prune_announce" value="1"<!-- IF { $S_PRUNE_ANNOUNCE } --> id="prune_announce" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="prune_announce" value="0"<!-- IF !{ $S_PRUNE_ANNOUNCE } --> id="prune_announce" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_PRUNE_STICKY}:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="prune_sticky" value="1"<!-- IF { $S_PRUNE_STICKY } --> id="prune_sticky" checked="checked"<!-- ENDIF --> /> { $L_YES} &nbsp; <input type="radio" class="radio" name="prune_sticky" value="0"<!-- IF !{ $S_PRUNE_STICKY } --> id="prune_sticky" checked="checked"<!-- ENDIF --> /> { $L_NO}
+		</td>
+	</tr>
+</table>
+
+</div>
+
+<div id="forum_link_options"<!-- IF !{ $S_FORUM_LINK } --> style="display: none;"<!-- ENDIF -->>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_GENERAL_FORUM_SETTINGS }
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_LINK }:<br /><span>{ $L_FORUM_LINK_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input class="medium" type="text" id="forum_link" name="forum_link" value="{ $FORUM_DATA_LINK }" />
+		</td>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_LINK_TRACK }:<br /><span>{ $L_FORUM_LINK_TRACK_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" name="forum_link_track" value="1"<!-- IF { $S_FORUM_LINK_TRACK } --> id="forum_link_track" checked="checked"<!-- ENDIF --> /> { $L_YES } &nbsp; <input type="radio" class="radio" name="forum_link_track" value="0"<!-- IF !{ $S_FORUM_LINK_TRACK } --> id="forum_link_track" checked="checked"<!-- ENDIF --> /> { $L_NO }
+		</td>
+	</tr>
+</table>
+
+</div>
+
+<div id="forum_rules_options"<!-- IF { $S_FORUM_LINK } --> style="display: none;"<!-- ENDIF -->>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_FORUM_RULES }
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_RULES_LINK }:<br /><span>{ $L_FORUM_RULES_LINK_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<input class="medium" type="text" id="forum_rules_link" name="forum_rules_link" value="{ $FORUM_RULES_LINK }" />
+		</td>
+	</tr>
+	<!-- IF { $FORUM_RULES_PREVIEW } -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_RULES_PREVIEW }:
+		</td>
+		<td class="row2">
+			{ $FORUM_RULES_PREVIEW }
+		</td>
+	</tr>
+	<!-- ENDIF -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_RULES }:<br /><span>{ $L_FORUM_RULES_EXPLAIN }</span>
+		</td>
+		<td class="row2">
+			<textarea id="forum_rules" name="forum_rules" rows="4" cols="70">{ $FORUM_RULES_PLAIN }</textarea>
+			<input type="checkbox" class="radio" name="rules_parse_bbcode"<!-- IF { $S_BBCODE_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_BBCODE } &nbsp; <input type="checkbox" class="radio" name="rules_parse_smilies"<!-- IF { $S_SMILIES_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_SMILIES } &nbsp; <input type="checkbox" class="radio" name="rules_parse_urls"<!-- IF { $S_URLS_CHECKED } --> checked="checked"<!-- ENDIF --> /> { $L_PARSE_URLS }
+		</td>
+	</tr>
+</table>
+
+</div>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<td align="center" class="cat">
+			<input class="button" type="submit" id="submit" name="update" value="{ $L_SUBMIT }" />&nbsp;
+			<input class="button" type="reset" id="reset" name="reset" value="{ $L_RESET }" />
+		</td>
+	</tr>
+</table>
+
+	</form>
+
+<!-- ELSEIF { $S_DELETE_FORUM } -->
+
+	<a href="{ $U_BACK }" style="float: right">&laquo; { $L_BACK }</a>
+
+	<h1>{ $L_FORUM_DELETE }</h1>
+
+	<p>{ $L_FORUM_DELETE_EXPLAIN }</p>
+
+	<!-- IF { $S_ERROR } -->
+		<div class="errorbox">
+			<h3>{ $L_WARNING }</h3>
+			<p>{ $ERROR_MSG }</p>
+		</div>
+	<!-- ENDIF -->
+
+	<form id="acp_forum" method="post" action="{ $U_ACTION }">
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<th colspan="2">
+			{ $L_FORUM_DELETE }
+		</th>
+	</tr>
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_FORUM_NAME }:
+		</td>
+		<td class="row2">
+			<b>{ $FORUM_NAME }</b>
+		</td>
+	</tr>
+	<!-- IF { $S_FORUM_POST } -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ACTION }:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" id="delete_action" name="action_posts" value="delete" checked="checked" /> { $L_DELETE_ALL_POSTS}
+			<!-- IF { $S_MOVE_FORUM_OPTIONS } -->
+				<br/><input type="radio" class="radio" name="action_posts" value="move" /> { $L_MOVE_POSTS_TO } <select name="posts_to_id">{ $S_MOVE_FORUM_OPTIONS }</select>
+			<!-- ENDIF -->
+		</dl>
+	<!-- ENDIF -->
+	<!-- IF { $S_HAS_SUBFORUMS } -->
+	<tr>
+		<td  width="40%" class="row1">
+			{ $L_ACTION }:
+		</td>
+		<td class="row2">
+			<input type="radio" class="radio" id="sub_delete_action" name="action_subforums" value="delete" checked="checked" /> { $L_DELETE_SUBFORUMS }
+			<!-- IF { $S_FORUMS_LIST } -->
+				<br /><input type="radio" class="radio" name="action_subforums" value="move" /> { $L_MOVE_SUBFORUMS_TO } <select name="subforums_to_id">{ $S_FORUMS_LIST }</select>
+			<!-- ENDIF -->
+		</td>
+	</tr>
+	<!-- ENDIF -->
+		</td>
+	</tr>
+</table>
+
+<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+	<tr>
+		<td align="center" class="cat">
+			<input class="button" type="submit" name="update" value="{ $L_SUBMIT }" />
+		</td>
+	</tr>
+</table>
+
+</form>
+
+<!-- ELSE -->
+
+	<h1>{ $L_FORUM_ADMIN }</h1>
+
+	<p>{ $L_FORUM_ADMIN_EXPLAIN }</p>
+
+	<!-- IF { $ERROR_MSG } -->
+		<div class="errorbox">
+			<h3>{ $L_WARNING }</h3>
+			<p>{ $ERROR_MSG }</p>
+		</div>
+	<!-- ENDIF -->
+
+	<!-- IF { $S_RESYNCED } -->
+		<div class="successbox">
+			<h3>{ $L_NOTIFY }</h3>
+			<p>{ $L_FORUM_RESYNCED }</p>
+		</div>
+	<!-- ENDIF -->
+	
+	<p><strong>{ $NAVIGATION }<!-- IF { $S_NO_FORUMS } --> [<a href="{ $U_EDIT }">{ $L_EDIT }</a> | <a href="{ $U_DELETE }">{ $L_DELETE }</a><!-- IF !{ $S_LINK } --> | <a href="{ $U_SYNC }">{ $L_RESYNC }</a><!-- ENDIF --->]<!-- ENDIF --></strong></p>
+
+	<!-- IF !empty({ $forums }) -->
+		<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+			<col class="row1" /><col class="row1" /><col class="row2" />
+		<tbody>
+		<!-- LOOP $forums -->
+			<tr>
+				<td style="width: 5%;">{ $forums:FOLDER_IMAGE }</td>
+				<td>
+					<strong><!-- IF isset({ $forums:S_LINK }) && { $forums:S_LINK } -->{ $forums:FORUM_NAME }<!-- ELSE --><a href="{ $forums:U_FORUM }">{ $forums:FORUM_NAME }</a><!-- ENDIF --></strong>
+					<!-- IF { $forums:FORUM_DESCRIPTION } --><br /><span>{ $forums:FORUM_DESCRIPTION }</span><!-- ENDIF -->
+					<!-- IF { $forums:S_FORUM_POST } --><br /><br /><span>{ $L_TOPICS }: <b>{ $forums:FORUM_TOPICS }</b> / { $L_POSTS }: <b>{ $forums:FORUM_POSTS }</b></span><!-- ENDIF -->
+				</td>
+				<td style="width: 15%; text-align: right; white-space: nowrap;">
+					<!-- IF !{ $forums:#LOOP_START } --><a href="{ $forums:U_MOVE_UP }">{ $ICON_MOVE_UP }</a> <!-- ENDIF -->
+					<!-- IF !{ $forums:#LOOP_END } --><a href="{ $forums:U_MOVE_DOWN }">{ $ICON_MOVE_DOWN }</a> <!-- ENDIF -->
+					<a href="{ $forums:U_EDIT }">{ $ICON_EDIT }</a> 
+					<!-- IF !isset({ $forums:S_LINK }) || !{ $forums:S_LINK } --><a href="{ $forums:U_SYNC }">{ $ICON_SYNC }</a> <!-- ENDIF -->
+					<a href="{ $forums:U_DELETE }">{ $ICON_DELETE }</a>
+				</td>
+			</tr>
+		<!-- ENDLOOP $forums -->
+		</tbody>
+	</table>
+	<!-- ENDIF -->
+
+	<form id="fselect" method="post" action="{ $U_SEL_ACTION }">
+
+	<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+		<tr>
+			<td align="right" class="row1">
+				{ $L_SELECT_FORUM }: <select name="parent_id" onchange="if(this.options[this.selectedIndex].value != -1){ this.form.submit(); }">{ $FORUM_BOX }</select> 
+				<input class="button" type="submit" value="{ $L_GO }" />
+			</td>
+		</tr>
+	</table>
+	
+	</form>
+
+	<form id="forums" method="post" action="{ $U_ACTION }">
+
+	<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0" align="center">
+		<tr>
+			<td align="right" class="row1">
+				<input type="hidden" name="action" value="add" />
+		
+				<input type="text" name="forum_name" value="" /> 
+				<input class="button" name="addforum" type="submit" value="{ $L_CREATE_FORUM }" />
+			</td>
+		</tr>
+	</table>
+
+	</form>
+
+<!-- ENDIF -->
+
+<!-- INCLUDE modules/forums/admin/overall_footer.html -->
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,52 +0,0 @@
-<!-- $Id: mcp_foruminfo.html,v 1.2 2004/07/08 23:03:03 acydburn Exp $ -->
-
-<!-- Note: was this used ever? -->
-
-<!-- INCLUDE mcp_header.html -->
-
-<form method="post" name="main" action="{S_MCP_ACTION}">
-<!-- IF S_FORUM_ID -->
-
-<table class="tablebg" width="100%" cellspacing="1" cellpadding="4" border="0">
-	<tr>
-		<th colspan="2" height="28" nowrap="nowrap">{L_FORUM_INFO}</th>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{L_FORUM_NAME}</b></td>
-		<td class="row2"><input type="text" class="post" name="forum_name" value="{FORUM_NAME}" size="45" /></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{L_FORUM_DESC}</b></td>
-		<td class="row2"><textarea class="post" rows="5" cols="45" wrap="virtual" name="forum_desc">{FORUM_DESC}</textarea></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{L_FORUM_STYLE}</b></td>
-		<td class="row2"><select name="forum_style">{STYLE_LIST}</select></td>
-	</tr>
-	<tr>
-		<td class="row1"><b class="genmed">{L_FORUM_STATUS}</b></td>
-		<td class="row2"><select name="forum_status">{STATUS_LIST}</select></td>
-	</tr>
-	<tr>
-		<td colspan="2" class="cat" align="center"><input type="submit" name="confirm" value="{L_CONFIRM}" class="btnmain" />&nbsp; &nbsp;<input type="submit" name="cancel" value="{L_CANCEL}" class="btnlite" /></td>
-	</tr>
-</table>
-
-<br />
-<!-- INCLUDE mcp_jumpbox.html -->
-
-<!-- ELSE -->
-
-<table width="100%" class="tablebg" cellspacing="1" cellpadding="4" border="0">
-	<tr>
-		<th height="28"><b>{L_FORUM_INFO}</b></th>
-	</tr>
-	<tr> 
-		<td class="row1" align="center"><br /><!-- INCLUDE mcp_jumpbox.html --><br /><br /></td>
-	</tr>
-</table>
-
-<!-- ENDIF -->
-</form>
-
-<!-- INCLUDE overall_footer.html -->
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/user.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -294,8 +294,8 @@
 			$module = ($module) ? $module : $_CLASS['core_display']->page['page_name'];
 			$lang = ($lang) ? $lang : $this->lang_name;
 
+			$img_file2 = ($img_file) ? "$img_file.php" : 'index.php';
 			$img_file = ($img_file) ? $img_file.'_'.$lang.'.php' : 'index_'.$lang.'.php';
-			$img_file2 = ($img_file) ? "$img_file.php" : 'index.php';
 
 			if (file_exists($_CLASS['core_display']->theme_path."/images/modules/$module/$img_file"))
 			{

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/install/build_data.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -130,6 +130,7 @@
 $_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('users', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('groups', 2, 0)");
 $_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('forums', 2, 0)");
+$_CLASS['core_db']->query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  ." (module_name, module_status, module_type) VALUES ('eaccelerator', 2, 0)");
 
 $_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('main', 2, 'front\r\nsubscribed\r\nbookmarks\r\ndrafts')");
 $_CLASS['core_db']->query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  ." (module_name, module_status, module_subs) VALUES ('pm', 2, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions')");

Modified: cms/trunk/modules/forums/admin/index.php
===================================================================
--- cms/trunk/modules/forums/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/admin/index.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -63,6 +63,27 @@
 
 $file = get_variable('file', 'REQUEST', 'main');
 
+$_CLASS['core_template']->assign_array(array(
+	'USERNAME'				=> $_CLASS['core_user']->data['username'],
+
+	//'U_ADM_INDEX'			=> append_sid("{$phpbb_admin_path}index.$phpEx"),
+	//'U_INDEX'				=> append_sid("index.$phpEx"),
+
+	'T_IMAGES_PATH'			=> "images/",
+	'T_SMILIES_PATH'		=> "{$config['smilies_path']}/",
+	'T_AVATAR_PATH'			=> "{$config['avatar_path']}/",
+	'T_AVATAR_GALLERY_PATH'	=> "{$config['avatar_gallery_path']}/",
+	'T_ICONS_PATH'			=> "{$config['icons_path']}/",
+	'T_RANKS_PATH'			=> "{$config['ranks_path']}/",
+	'T_UPLOAD_PATH'			=> "{$config['upload_path']}/",
+
+	'ICON_MOVE_UP'		=> '<img src="modules/forums/images/admin/icon_up.gif" alt="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" title="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" />',
+	'ICON_MOVE_DOWN'	=> '<img src="modules/forums/images/admin/icon_down.gif" alt="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" title="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" />',
+	'ICON_EDIT'			=> '<img src="modules/forums/images/admin/icon_edit.gif" alt="' . $_CLASS['core_user']->lang['EDIT'] . '" title="' . $_CLASS['core_user']->lang['EDIT'] . '" />',
+	'ICON_DELETE'		=> '<img src="modules/forums/images/admin/icon_delete.gif" alt="' . $_CLASS['core_user']->lang['DELETE'] . '" title="' . $_CLASS['core_user']->lang['DELETE'] . '" />',
+	'ICON_SYNC'			=> '<img src="modules/forums/images/admin/icon_sync.gif" alt="' . $_CLASS['core_user']->lang['RESYNC'] . '" title="' . $_CLASS['core_user']->lang['RESYNC'] . '" />',
+));
+	
 if (file_exists(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php'))
 {
 	require(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php');
@@ -72,47 +93,13 @@
 	require(SITE_FILE_ROOT.'includes/forums/admin/main.php');
 }
 
-
-// -----------------------------
-// Functions
-function adm_page_header($page_title)
-{
-	global $config, $_CLASS;
-
-	$_CLASS['core_template']->assign_array(array(
-		'PAGE_TITLE'			=> $page_title,
-		'USERNAME'				=> $_CLASS['core_user']->data['username'],
-
-		//'U_ADM_INDEX'			=> append_sid("{$phpbb_admin_path}index.$phpEx"),
-		//'U_INDEX'				=> append_sid("index.$phpEx"),
-
-		'T_IMAGES_PATH'			=> "images/",
-		'T_SMILIES_PATH'		=> "{$config['smilies_path']}/",
-		'T_AVATAR_PATH'			=> "{$config['avatar_path']}/",
-		'T_AVATAR_GALLERY_PATH'	=> "{$config['avatar_gallery_path']}/",
-		'T_ICONS_PATH'			=> "{$config['icons_path']}/",
-		'T_RANKS_PATH'			=> "{$config['ranks_path']}/",
-		'T_UPLOAD_PATH'			=> "{$config['upload_path']}/",
-
-		'ICON_MOVE_UP'		=> '<img src="images/icon_up.gif" alt="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" title="' . $_CLASS['core_user']->lang['MOVE_UP'] . '" />',
-		'ICON_MOVE_DOWN'	=> '<img src="images/icon_down.gif" alt="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" title="' . $_CLASS['core_user']->lang['MOVE_DOWN'] . '" />',
-		'ICON_EDIT'			=> '<img src="images/icon_edit.gif" alt="' . $_CLASS['core_user']->lang['EDIT'] . '" title="' . $_CLASS['core_user']->lang['EDIT'] . '" />',
-		'ICON_DELETE'		=> '<img src="images/icon_delete.gif" alt="' . $_CLASS['core_user']->lang['DELETE'] . '" title="' . $_CLASS['core_user']->lang['DELETE'] . '" />',
-		'ICON_SYNC'			=> '<img src="images/icon_sync.gif" alt="' . $_CLASS['core_user']->lang['RESYNC'] . '" title="' . $_CLASS['core_user']->lang['RESYNC'] . '" />',
-	));
-}
-
-function adm_page_footer($copyright_html = true)
-{
-	garbage_collection();
-}
-
 /**
 * Generate back link for acp pages
 */
 function adm_back_link($u_action)
 {
-	global $user;
+	global $_CLASS;
+
 	return '<br /><br /><a href="' . $u_action . '">&laquo; ' . $_CLASS['core_user']->lang['BACK_TO_PREV'] . '</a>';
 }
 

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/posting.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -107,7 +107,7 @@
 	break;
 
 	case 'smilies':
-		require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
 		generate_smilies('window', $forum_id);
 
@@ -132,6 +132,7 @@
 require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
 require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
 require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
 // Use post_row values in favor of submitted ones...
 $forum_id	= (!empty($post_data['forum_id'])) ? (int) $post_data['forum_id'] : (int) $forum_id;

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -229,7 +229,7 @@
 	$s_watching_forum['link'] = $s_watching_forum['title'] = '';
 }
 
-gen_forum_auth_level('forum', $forum_id);
+gen_forum_auth_level('forum', $forum_id, $forum_data['forum_status']);
 
 // Topic ordering options
 $limit_days = array(0 => $_CLASS['core_user']->lang['ALL_TOPICS'], 1 => $_CLASS['core_user']->lang['1_DAY'], 7 => $_CLASS['core_user']->lang['7_DAYS'], 14 => $_CLASS['core_user']->lang['2_WEEKS'], 30 => $_CLASS['core_user']->lang['1_MONTH'], 90 => $_CLASS['core_user']->lang['3_MONTHS'], 180 => $_CLASS['core_user']->lang['6_MONTHS'], 364 => $_CLASS['core_user']->lang['1_YEAR']);
@@ -521,8 +521,11 @@
 
 		// Get folder img, topic status/type related informations
 		$folder_img = $folder_alt = $topic_type = '';
-		topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+	
+		$unread_topic = ($mark_time < $row['topic_last_post_time']);
 
+		topic_status($row, $replies, $unread_topic, $folder_img, $folder_alt, $topic_type);
+
 		$topic_unapproved = (!$row['topic_approved'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? true : false;
 		$posts_unapproved = ($row['topic_approved'] && $row['topic_replies'] < $row['topic_replies_real'] && $_CLASS['forums_auth']->acl_get('m_approve', $forum_id)) ? true : false;
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -194,6 +194,8 @@
 	login_forum_box($topic_data);
 }
 
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
 // Are we watching this topic?
 if (!isset($topic_data['notify_status']))
 {
@@ -260,8 +262,6 @@
 	$topic_data['topic_time_limit'] = 0;
 }
 
-require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
-
 $_CLASS['core_user']->user_setup();
 $_CLASS['core_user']->add_lang('viewtopic');
 $_CLASS['core_user']->add_img();
@@ -511,7 +511,7 @@
 
 	if ($poll_info[0]['bbcode_bitfield'])
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$poll_bbcode = new bbcode();
 	}
 	else



From viperal at mail.berlios.de  Sun Aug 20 20:00:57 2006
From: viperal at mail.berlios.de (viperal at BerliOS)
Date: Sun, 20 Aug 2006 20:00:57 +0200
Subject: [Viperals-svncheckins] r186 - in cms/trunk/modules/forums: . images
	images/admin images/en
Message-ID: <200608201800.k7KI0vru016826@sheep.berlios.de>

Author: viperal
Date: 2006-08-20 20:00:53 +0200 (Sun, 20 Aug 2006)
New Revision: 186

Added:
   cms/trunk/modules/forums/images/
   cms/trunk/modules/forums/images/admin/
   cms/trunk/modules/forums/images/admin/arrow_down.gif
   cms/trunk/modules/forums/images/admin/bg_hash1.gif
   cms/trunk/modules/forums/images/admin/bg_hash2.gif
   cms/trunk/modules/forums/images/admin/bg_hash3.gif
   cms/trunk/modules/forums/images/admin/bg_hash4.gif
   cms/trunk/modules/forums/images/admin/bg_header.gif
   cms/trunk/modules/forums/images/admin/bg_tabs1.gif
   cms/trunk/modules/forums/images/admin/bg_tabs2.gif
   cms/trunk/modules/forums/images/admin/cellpic3.gif
   cms/trunk/modules/forums/images/admin/gradient2b.gif
   cms/trunk/modules/forums/images/admin/icon_delete.gif
   cms/trunk/modules/forums/images/admin/icon_down.gif
   cms/trunk/modules/forums/images/admin/icon_edit.gif
   cms/trunk/modules/forums/images/admin/icon_folder.gif
   cms/trunk/modules/forums/images/admin/icon_folder_link.gif
   cms/trunk/modules/forums/images/admin/icon_folder_link_small.gif
   cms/trunk/modules/forums/images/admin/icon_folder_lock.gif
   cms/trunk/modules/forums/images/admin/icon_folder_lock_small.gif
   cms/trunk/modules/forums/images/admin/icon_folder_small.gif
   cms/trunk/modules/forums/images/admin/icon_folder_sub_small.gif
   cms/trunk/modules/forums/images/admin/icon_subfolder.gif
   cms/trunk/modules/forums/images/admin/icon_sync.gif
   cms/trunk/modules/forums/images/admin/icon_trace.gif
   cms/trunk/modules/forums/images/admin/icon_up.gif
   cms/trunk/modules/forums/images/admin/no_avatar.gif
   cms/trunk/modules/forums/images/admin/no_image.png
   cms/trunk/modules/forums/images/admin/progress_bar.gif
   cms/trunk/modules/forums/images/admin/spacer.gif
   cms/trunk/modules/forums/images/announce_read.gif
   cms/trunk/modules/forums/images/announce_read_locked.gif
   cms/trunk/modules/forums/images/announce_read_locked_mine.gif
   cms/trunk/modules/forums/images/announce_read_mine.gif
   cms/trunk/modules/forums/images/announce_unread.gif
   cms/trunk/modules/forums/images/announce_unread_locked.gif
   cms/trunk/modules/forums/images/announce_unread_locked_mine.gif
   cms/trunk/modules/forums/images/announce_unread_mine.gif
   cms/trunk/modules/forums/images/en/
   cms/trunk/modules/forums/images/en/button_pm_new.gif
   cms/trunk/modules/forums/images/en/button_pm_reply.gif
   cms/trunk/modules/forums/images/en/button_topic_locked.gif
   cms/trunk/modules/forums/images/en/button_topic_new.gif
   cms/trunk/modules/forums/images/en/button_topic_reply.gif
   cms/trunk/modules/forums/images/en/icon_contact_aim.gif
   cms/trunk/modules/forums/images/en/icon_contact_email.gif
   cms/trunk/modules/forums/images/en/icon_contact_icq.gif
   cms/trunk/modules/forums/images/en/icon_contact_jabber.gif
   cms/trunk/modules/forums/images/en/icon_contact_msnm.gif
   cms/trunk/modules/forums/images/en/icon_contact_pm.gif
   cms/trunk/modules/forums/images/en/icon_contact_www.gif
   cms/trunk/modules/forums/images/en/icon_contact_yahoo.gif
   cms/trunk/modules/forums/images/en/icon_post_delete.gif
   cms/trunk/modules/forums/images/en/icon_post_edit.gif
   cms/trunk/modules/forums/images/en/icon_post_info.gif
   cms/trunk/modules/forums/images/en/icon_post_quote.gif
   cms/trunk/modules/forums/images/en/icon_post_report.gif
   cms/trunk/modules/forums/images/en/icon_user_offline.gif
   cms/trunk/modules/forums/images/en/icon_user_online.gif
   cms/trunk/modules/forums/images/en/icon_user_profile.gif
   cms/trunk/modules/forums/images/en/icon_user_search.gif
   cms/trunk/modules/forums/images/en/icon_user_warn.gif
   cms/trunk/modules/forums/images/forum_link.gif
   cms/trunk/modules/forums/images/forum_read.gif
   cms/trunk/modules/forums/images/forum_read_locked.gif
   cms/trunk/modules/forums/images/forum_read_subforum.gif
   cms/trunk/modules/forums/images/forum_unread.gif
   cms/trunk/modules/forums/images/forum_unread_locked.gif
   cms/trunk/modules/forums/images/forum_unread_subforum.gif
   cms/trunk/modules/forums/images/icon_post_target.gif
   cms/trunk/modules/forums/images/icon_post_target_unread.gif
   cms/trunk/modules/forums/images/icon_topic_attach.gif
   cms/trunk/modules/forums/images/icon_topic_latest.gif
   cms/trunk/modules/forums/images/icon_topic_newest.gif
   cms/trunk/modules/forums/images/icon_topic_reported.gif
   cms/trunk/modules/forums/images/icon_topic_unapproved.gif
   cms/trunk/modules/forums/images/imageset.cfg
   cms/trunk/modules/forums/images/index_en.php
   cms/trunk/modules/forums/images/poll_center.gif
   cms/trunk/modules/forums/images/poll_left.gif
   cms/trunk/modules/forums/images/poll_right.gif
   cms/trunk/modules/forums/images/site_logo.gif
   cms/trunk/modules/forums/images/sticky_read.gif
   cms/trunk/modules/forums/images/sticky_read_locked.gif
   cms/trunk/modules/forums/images/sticky_read_locked_mine.gif
   cms/trunk/modules/forums/images/sticky_read_mine.gif
   cms/trunk/modules/forums/images/sticky_unread.gif
   cms/trunk/modules/forums/images/sticky_unread_locked.gif
   cms/trunk/modules/forums/images/sticky_unread_locked_mine.gif
   cms/trunk/modules/forums/images/sticky_unread_mine.gif
   cms/trunk/modules/forums/images/topic_moved.gif
   cms/trunk/modules/forums/images/topic_read.gif
   cms/trunk/modules/forums/images/topic_read_hot.gif
   cms/trunk/modules/forums/images/topic_read_hot_mine.gif
   cms/trunk/modules/forums/images/topic_read_locked.gif
   cms/trunk/modules/forums/images/topic_read_locked_mine.gif
   cms/trunk/modules/forums/images/topic_read_mine.gif
   cms/trunk/modules/forums/images/topic_unread.gif
   cms/trunk/modules/forums/images/topic_unread_hot.gif
   cms/trunk/modules/forums/images/topic_unread_hot_mine.gif
   cms/trunk/modules/forums/images/topic_unread_locked.gif
   cms/trunk/modules/forums/images/topic_unread_locked_mine.gif
   cms/trunk/modules/forums/images/topic_unread_mine.gif
   cms/trunk/modules/forums/images/upload_bar.gif
Log:


Added: cms/trunk/modules/forums/images/admin/arrow_down.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/arrow_down.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_hash1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_hash1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_hash2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_hash2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_hash3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_hash3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_hash4.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_hash4.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_header.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_header.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_tabs1.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_tabs1.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/bg_tabs2.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/bg_tabs2.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/cellpic3.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/cellpic3.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/gradient2b.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/gradient2b.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_down.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_down.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_link.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_link.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_link_small.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_link_small.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_lock.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_lock.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_lock_small.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_lock_small.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_small.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_small.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_folder_sub_small.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_folder_sub_small.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_subfolder.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_subfolder.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_sync.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_sync.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_trace.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_trace.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/icon_up.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/icon_up.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/no_avatar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/no_avatar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/no_image.png
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/no_image.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/progress_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/progress_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/admin/spacer.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/admin/spacer.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_read.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_read.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_read_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_read_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_read_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_read_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_read_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_read_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_unread.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_unread.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_unread_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_unread_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_unread_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_unread_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/announce_unread_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/announce_unread_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/button_pm_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/button_pm_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/button_pm_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/button_pm_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/button_topic_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/button_topic_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/button_topic_new.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/button_topic_new.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/button_topic_reply.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/button_topic_reply.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_aim.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_aim.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_email.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_email.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_icq.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_icq.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_jabber.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_jabber.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_msnm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_msnm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_pm.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_pm.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_www.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_www.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_contact_yahoo.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_contact_yahoo.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_post_delete.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_post_delete.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_post_edit.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_post_edit.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_post_info.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_post_info.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_post_quote.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_post_quote.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_post_report.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_post_report.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_user_offline.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_user_offline.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_user_online.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_user_online.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_user_profile.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_user_profile.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_user_search.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_user_search.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/en/icon_user_warn.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/en/icon_user_warn.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_link.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_link.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_read.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_read.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_read_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_read_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_read_subforum.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_read_subforum.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_unread.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_unread.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_unread_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_unread_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/forum_unread_subforum.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/forum_unread_subforum.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_post_target.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_post_target.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_post_target_unread.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_post_target_unread.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_topic_attach.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_topic_attach.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_topic_latest.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_topic_latest.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_topic_newest.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_topic_newest.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_topic_reported.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_topic_reported.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/icon_topic_unapproved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/icon_topic_unapproved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/imageset.cfg
===================================================================
--- cms/trunk/modules/forums/images/imageset.cfg	2006-08-20 17:59:24 UTC (rev 185)
+++ cms/trunk/modules/forums/images/imageset.cfg	2006-08-20 18:00:53 UTC (rev 186)
@@ -0,0 +1,122 @@
+#
+# phpBB Imageset Configuration File
+#
+# @package phpBB3
+# @copyright (c) 2005 phpBB Group 
+# @license http://opensource.org/licenses/gpl-license.php GNU Public License 
+#
+#
+# At the left is the name, please do not change this
+# At the right the value is entered
+# For on/off options the valid values are on, off, 1, 0, true and false
+#
+# Values get trimmed, if you want to add a space in front or at the end of
+# the value, then enclose the value with single or double quotes. 
+# Single and double quotes do not need to be escaped.
+#
+#
+
+# General Information about this style
+name = subSilver
+copyright = &copy; phpBB Group, 2003
+version = 2.1.1
+
+# Images 
+img_site_logo = site_logo.gif*94*170
+img_upload_bar = upload_bar.gif*16*280
+img_poll_left = poll_left.gif*12*4
+img_poll_center = poll_center.gif*12*
+img_poll_right = poll_right.gif*12*4
+img_icon_friend =
+img_icon_foe =
+
+img_forum_link = forum_link.gif*25*46
+img_forum_read = forum_read.gif*25*46
+img_forum_read_locked = forum_read_locked.gif*25*46
+img_forum_read_subforum = forum_read_subforum.gif*25*46
+img_forum_unread = forum_unread.gif*25*46
+img_forum_unread_locked = forum_unread_locked.gif*25*46
+img_forum_unread_subforum = forum_unread_subforum.gif*25*46
+
+img_topic_moved = topic_moved.gif*18*19
+
+img_topic_read = topic_read.gif*18*19
+img_topic_read_mine = topic_read_mine.gif*18*19
+img_topic_read_hot = topic_read_hot.gif*18*19
+img_topic_read_hot_mine = topic_read_hot_mine.gif*18*19
+img_topic_read_locked = topic_read_locked.gif*18*19
+img_topic_read_locked_mine = topic_read_locked_mine.gif*18*19
+
+img_topic_unread = topic_unread.gif*18*19
+img_topic_unread_mine = topic_unread_mine.gif*18*19
+img_topic_unread_hot = topic_unread_hot.gif*18*19
+img_topic_unread_hot_mine = topic_unread_hot_mine.gif*18*19
+img_topic_unread_locked = topic_unread_locked.gif*18*19
+img_topic_unread_locked_mine = topic_unread_locked_mine.gif*18*19
+
+img_sticky_read = sticky_read.gif*18*19
+img_sticky_read_mine = sticky_read_mine.gif*18*19
+img_sticky_read_locked = sticky_read_locked.gif*18*19
+img_sticky_read_locked_mine = sticky_read_locked_mine.gif*18*19
+img_sticky_unread = sticky_unread.gif*18*19
+img_sticky_unread_mine = sticky_unread_mine.gif*18*19
+img_sticky_unread_locked = sticky_unread_locked.gif*18*19
+img_sticky_unread_locked_mine = sticky_unread_locked_mine.gif*18*19
+
+img_announce_read = announce_read.gif*18*19
+img_announce_read_mine = announce_read_mine.gif*18*19
+img_announce_read_locked = announce_read_locked.gif*18*19
+img_announce_read_locked_mine = announce_read_locked_mine.gif*18*19
+img_announce_unread = announce_unread.gif*18*19
+img_announce_unread_mine = announce_unread_mine.gif*18*19
+img_announce_unread_locked = announce_unread_locked.gif*18*19
+img_announce_unread_locked_mine = announce_unread_locked_mine.gif*18*19
+
+img_global_read = announce_read.gif*18*19
+img_global_read_mine = announce_read_mine.gif*18*19
+img_global_read_locked = announce_read_locked.gif*18*19
+img_global_read_locked_mine = announce_read_locked_mine.gif*18*19
+img_global_unread = announce_unread.gif*18*19
+img_global_unread_mine = announce_unread_mine.gif*18*19
+img_global_unread_locked = announce_unread_locked.gif*18*19
+img_global_unread_locked_mine = announce_unread_locked_mine.gif*18*19
+
+img_pm_read = topic_read.gif*18*19
+img_pm_unread = topic_unread.gif*18*19
+
+img_icon_contact_aim = {LANG}/icon_contact_aim.gif*20*72
+img_icon_contact_email = {LANG}/icon_contact_email.gif*20*72
+img_icon_contact_icq = {LANG}/icon_contact_icq.gif*20*72
+img_icon_contact_jabber = {LANG}/icon_contact_jabber.gif*20*72
+img_icon_contact_msnm = {LANG}/icon_contact_msnm.gif*20*72
+img_icon_contact_pm = {LANG}/icon_contact_pm.gif*20*72
+img_icon_contact_yahoo = {LANG}/icon_contact_yahoo.gif*20*72
+img_icon_contact_www = {LANG}/icon_contact_www.gif*20*72
+
+img_icon_post_delete = {LANG}/icon_post_delete.gif*20*20
+img_icon_post_edit = {LANG}/icon_post_edit.gif*20*90
+img_icon_post_info = {LANG}/icon_post_info.gif*20*20
+img_icon_post_quote = {LANG}/icon_post_quote.gif*20*90
+img_icon_post_report = {LANG}/icon_post_report.gif*20*20
+img_icon_post_target = icon_post_target.gif*9*12
+img_icon_post_target_unread = icon_post_target_unread.gif*9*12
+
+img_icon_topic_attach = icon_topic_attach.gif*18*14
+img_icon_topic_latest = icon_topic_latest.gif*9*18
+img_icon_topic_newest = icon_topic_newest.gif*9*18
+img_icon_topic_reported = icon_topic_reported.gif*18*19
+img_icon_topic_unapproved = icon_topic_unapproved.gif*18*19
+
+img_icon_user_online = {LANG}/icon_user_online.gif*20*72
+img_icon_user_offline = {LANG}/icon_user_offline.gif*20*72
+img_icon_user_profile = {LANG}/icon_user_profile.gif*20*72
+img_icon_user_search = {LANG}/icon_user_search.gif*20*72
+img_icon_user_warn = {LANG}/icon_user_warn.gif*20*20
+
+img_button_pm_forward =
+img_button_pm_new = {LANG}/button_pm_new.gif*27*97
+img_button_pm_reply = {LANG}/button_pm_reply.gif*20*90
+img_button_topic_locked = {LANG}/button_topic_locked.gif*27*97
+img_button_topic_new = {LANG}/button_topic_new.gif*27*97
+img_button_topic_reply = {LANG}/button_topic_reply.gif*27*97
+

Added: cms/trunk/modules/forums/images/index_en.php
===================================================================
--- cms/trunk/modules/forums/images/index_en.php	2006-08-20 17:59:24 UTC (rev 185)
+++ cms/trunk/modules/forums/images/index_en.php	2006-08-20 18:00:53 UTC (rev 186)
@@ -0,0 +1,198 @@
+<?php
+
+global $_CLASS;
+
+$_CLASS['core_template']->assign('T_IMAGE_PATH',  'modules/forums/images/');
+
+$this->img = array(
+	'bbcode_bitfield' => '6913',
+
+    'btn_post' => 'modules/forums/images/en/button_topic_new.gif*27*97',
+    'btn_post_pm' => 'modules/forums/images/en/button_pm_new.gif*27*97',
+    'btn_reply' => 'modules/forums/images/en/button_topic_reply.gif*27*97',
+    'btn_reply_pm' => 'modules/forums/images/en/button_pm_reply.gif*20*90',
+    'btn_locked' => 'modules/forums/images/en/button_topic_locked.gif*27*97',
+    'btn_profile' => 'modules/forums/images/en/icon_user_profile.gif*20*72',
+    'btn_pm' => 'modules/forums/images/en/icon_contact_pm.gif*20*72',
+    'btn_delete' => 'modules/forums/images/en/icon_post_delete.gif*20*20',
+    'btn_info' => 'modules/forums/images/en/icon_post_info.gif*20*20',
+    'btn_quote' => 'modules/forums/images/en/icon_post_quote.gif*20*90',
+    'btn_search' => 'modules/forums/images/en/icon_user_search.gif*20*72',
+    'btn_edit' => 'modules/forums/images/en/icon_post_edit.gif*20*90',
+    'btn_report' => 'modules/forums/images/en/icon_post_report.gif*20*20',
+    'btn_email' => 'modules/forums/images/en/icon_contact_email.gif*20*72',
+    'btn_www' => 'modules/forums/images/en/icon_contact_www.gif*20*72',
+    'btn_icq' => 'modules/forums/images/en/icon_contact_icq.gif*20*72',
+    'btn_aim' => 'modules/forums/images/en/icon_contact_aim.gif*20*72',
+    'btn_yim' => 'modules/forums/images/en/icon_contact_yahoo.gif*20*72',
+    'btn_msnm' => 'modules/forums/images/en/icon_contact_msnm.gif*20*72',
+    'btn_jabber' => 'modules/forums/images/en/icon_contact_jabber.gif*20*72',
+    'btn_online' => 'modules/forums/images/en/icon_user_online.gif*20*72',
+    'btn_offline' => 'modules/forums/images/en/icon_user_offline.gif*20*72',
+    'btn_friend' => '',
+    'btn_foe' => '',
+  
+    'icon_unapproved' => 'modules/forums/images/icon_topic_unapproved.gif*18*19',
+    'icon_reported' => 'modules/forums/images/icon_topic_reported.gif*18*19',
+    'icon_attach' => 'modules/forums/images/icon_topic_attach.gif*18*14',
+    'icon_post' => 'modules/forums/images/icon_post_target.gif*9*12',
+    'icon_post_new' => 'modules/forums/images/icon_post_target_unread.gif*9*12',
+    'icon_post_latest' => 'modules/forums/images/icon_topic_latest.gif*9*18',
+    'icon_post_newest' => 'modules/forums/images/icon_topic_newest.gif*9*18',
+
+    'forum' => 'modules/forums/images/forum_read.gif*25*46',
+    'forum_new' => 'modules/forums/images/forum_unread.gif*25*46',
+    'forum_locked' => 'modules/forums/images/forum_read_locked.gif*25*46',
+    'forum_link' => 'modules/forums/images/forum_link.gif*25*46',
+    'sub_forum' => 'modules/forums/images/forum_read_subforum.gif*25*46',
+    'sub_forum_new' => 'modules/forums/images/forum_unread_subforum.gif*25*46',
+
+    'folder' => 'modules/forums/images/topic_read.gif*18*19',
+    'folder_moved' => 'modules/forums/images/topic_moved.gif*18*19',
+    'folder_posted' => 'modules/forums/images/topic_read_mine.gif*18*19',
+    'folder_new' => 'modules/forums/images/topic_unread.gif*18*19',
+    'folder_new_posted' => 'modules/forums/images/topic_unread_mine.gif*18*19',
+
+    'folder_hot' => 'modules/forums/images/topic_unread_hot.gif*18*19',
+    'folder_hot_posted' => 'modules/forums/images/topic_unread_hot_mine.gif*18*19',
+    'folder_hot_new' => 'modules/forums/images/topic_read_hot.gif*18*19',
+    'folder_hot_new_posted' => 'modules/forums/images/topic_read_hot_mine.gif*18*19',
+
+    'folder_locked' => 'modules/forums/images/topic_read_locked.gif*18*19',
+    'folder_locked_posted' => 'modules/forums/images/topic_read_locked_mine.gif*18*19',
+    'folder_locked_new' => 'modules/forums/images/topic_unread_locked.gif*18*19',
+    'folder_locked_new_posted' => 'modules/forums/images/topic_unread_locked_mine.gif*18*19',
+
+    'folder_sticky' => 'modules/forums/images/sticky_read.gif*18*19',
+    'folder_sticky_posted' => 'modules/forums/images/sticky_read_mine.gif*18*19',
+    'folder_sticky_new' => 'modules/forums/images/sticky_unread.gif*18*19',
+    'folder_sticky_new_posted' => 'modules/forums/images/sticky_unread_mine.gif*18*19',
+
+    'folder_announce' => 'modules/forums/images/announce_read.gif*18*19',
+    'folder_announce_posted' => 'modules/forums/images/announce_read_mine.gif*18*19',
+    'folder_announce_new' => 'modules/forums/images/announce_unread.gif*18*19',
+    'folder_announce_new_posted' => 'modules/forums/images/announce_unread_mine.gif*18*19',
+    'folder_global' => 'modules/forums/images/announce_read.gif*18*19',
+    'folder_global_posted' => 'modules/forums/images/announce_read_mine.gif*18*19',
+    'folder_global_new' => 'modules/forums/images/announce_unread.gif*18*19',
+    'folder_global_new_posted' => 'modules/forums/images/announce_unread_mine.gif*18*19',
+
+    'poll_left'		=> 'modules/forums/images/poll_left.gif*12*4',
+    'poll_center'	=> 'modules/forums/images/poll_center.gif*12*4',
+    'poll_right'	=> 'modules/forums/images/poll_right.gif*12*4',
+    'attach_progress_bar' => 'modules/forums/images/upload_bar.gif*16*280',
+    'karma_left' => '',
+    'karma_center' => 'modules/forums/images/karma/karma{SUFFIX}.gif*6*69',
+    'karma_right' => '',
+    'pagination_sep' => ', ',
+    'user_icon1' => '',
+    'user_icon2' => '',
+    'user_icon3' => '',
+    'user_icon4' => '',
+    'user_icon5' => '',
+    'user_icon6' => '', 
+    'user_icon7' => '',
+    'user_icon8' => '',
+    'user_icon9' => '',
+    'user_icon10' => '',
+
+	'upload_bar' => 'modules/forums/images/upload_bar.gif*16*280',
+	'poll_left' => 'modules/forums/images/poll_left.gif*12*4',
+	'poll_center' => 'modules/forums/images/poll_center.gif*12*',
+	'poll_right' => 'modules/forums/images/poll_right.gif*12*4',
+	'icon_friend' => 'modules/forums/images/',
+	'icon_foe' => 'modules/forums/images/',
+	
+	'forum_link' => 'modules/forums/images/forum_link.gif*25*46',
+	'forum_read' => 'modules/forums/images/forum_read.gif*25*46',
+	'forum_read_locked' => 'modules/forums/images/forum_read_locked.gif*25*46',
+	'forum_read_subforum' => 'modules/forums/images/forum_read_subforum.gif*25*46',
+	'forum_unread' => 'modules/forums/images/forum_unread.gif*25*46',
+	'forum_unread_locked' => 'modules/forums/images/forum_unread_locked.gif*25*46',
+	'forum_unread_subforum' => 'modules/forums/images/forum_unread_subforum.gif*25*46',
+	
+	'topic_moved' => 'modules/forums/images/topic_moved.gif*18*19',
+	
+	'topic_read' => 'modules/forums/images/topic_read.gif*18*19',
+	'topic_read_mine' => 'modules/forums/images/topic_read_mine.gif*18*19',
+	'topic_read_hot' => 'modules/forums/images/topic_read_hot.gif*18*19',
+	'topic_read_hot_mine' => 'modules/forums/images/topic_read_hot_mine.gif*18*19',
+	'topic_read_locked' => 'modules/forums/images/topic_read_locked.gif*18*19',
+	'topic_read_locked_mine' => 'modules/forums/images/topic_read_locked_mine.gif*18*19',
+	
+	'topic_unread' => 'modules/forums/images/topic_unread.gif*18*19',
+	'topic_unread_mine' => 'modules/forums/images/topic_unread_mine.gif*18*19',
+	'topic_unread_hot' => 'modules/forums/images/topic_unread_hot.gif*18*19',
+	'topic_unread_hot_mine' => 'modules/forums/images/topic_unread_hot_mine.gif*18*19',
+	'topic_unread_locked' => 'modules/forums/images/topic_unread_locked.gif*18*19',
+	'topic_unread_locked_mine' => 'modules/forums/images/topic_unread_locked_mine.gif*18*19',
+	
+	'sticky_read' => 'modules/forums/images/sticky_read.gif*18*19',
+	'sticky_read_mine' => 'modules/forums/images/sticky_read_mine.gif*18*19',
+	'sticky_read_locked' => 'modules/forums/images/sticky_read_locked.gif*18*19',
+	'sticky_read_locked_mine' => 'modules/forums/images/sticky_read_locked_mine.gif*18*19',
+	'sticky_unread' => 'modules/forums/images/sticky_unread.gif*18*19',
+	'sticky_unread_mine' => 'modules/forums/images/sticky_unread_mine.gif*18*19',
+	'sticky_unread_locked' => 'modules/forums/images/sticky_unread_locked.gif*18*19',
+	'sticky_unread_locked_mine' => 'modules/forums/images/sticky_unread_locked_mine.gif*18*19',
+	
+	'announce_read' => 'modules/forums/images/announce_read.gif*18*19',
+	'announce_read_mine' => 'modules/forums/images/announce_read_mine.gif*18*19',
+	'announce_read_locked' => 'modules/forums/images/announce_read_locked.gif*18*19',
+	'announce_read_locked_mine' => 'modules/forums/images/announce_read_locked_mine.gif*18*19',
+	'announce_unread' => 'modules/forums/images/announce_unread.gif*18*19',
+	'announce_unread_mine' => 'modules/forums/images/announce_unread_mine.gif*18*19',
+	'announce_unread_locked' => 'modules/forums/images/announce_unread_locked.gif*18*19',
+	'announce_unread_locked_mine' => 'modules/forums/images/announce_unread_locked_mine.gif*18*19',
+	
+	'global_read' => 'modules/forums/images/announce_read.gif*18*19',
+	'global_read_mine' => 'modules/forums/images/announce_read_mine.gif*18*19',
+	'global_read_locked' => 'modules/forums/images/announce_read_locked.gif*18*19',
+	'global_read_locked_mine' => 'modules/forums/images/announce_read_locked_mine.gif*18*19',
+	'global_unread' => 'modules/forums/images/announce_unread.gif*18*19',
+	'global_unread_mine' => 'modules/forums/images/announce_unread_mine.gif*18*19',
+	'global_unread_locked' => 'modules/forums/images/announce_unread_locked.gif*18*19',
+	'global_unread_locked_mine' => 'modules/forums/images/announce_unread_locked_mine.gif*18*19',
+	
+	'pm_read' => 'modules/forums/images/topic_read.gif*18*19',
+	'pm_unread' => 'modules/forums/images/topic_unread.gif*18*19',
+	
+	'icon_contact_aim' => 'modules/forums/images/{LANG}/icon_contact_aim.gif*20*72',
+	'icon_contact_email' => 'modules/forums/images/{LANG}/icon_contact_email.gif*20*72',
+	'icon_contact_icq' => 'modules/forums/images/{LANG}/icon_contact_icq.gif*20*72',
+	'icon_contact_jabber' => 'modules/forums/images/{LANG}/icon_contact_jabber.gif*20*72',
+	'icon_contact_msnm' => 'modules/forums/images/{LANG}/icon_contact_msnm.gif*20*72',
+	'icon_contact_pm' => 'modules/forums/images/{LANG}/icon_contact_pm.gif*20*72',
+	'icon_contact_yahoo' => 'modules/forums/images/{LANG}/icon_contact_yahoo.gif*20*72',
+	'icon_contact_www' => 'modules/forums/images/{LANG}/icon_contact_www.gif*20*72',
+	
+	'icon_post_delete' => 'modules/forums/images/{LANG}/icon_post_delete.gif*20*20',
+	'icon_post_edit' => 'modules/forums/images/{LANG}/icon_post_edit.gif*20*90',
+	'icon_post_info' => 'modules/forums/images/{LANG}/icon_post_info.gif*20*20',
+	'icon_post_quote' => 'modules/forums/images/{LANG}/icon_post_quote.gif*20*90',
+	'icon_post_report' => 'modules/forums/images/{LANG}/icon_post_report.gif*20*20',
+	'icon_post_target' => 'modules/forums/images/icon_post_target.gif*9*12',
+	'icon_post_target_unread' => 'modules/forums/images/icon_post_target_unread.gif*9*12',
+	
+	'icon_topic_attach' => 'modules/forums/images/icon_topic_attach.gif*18*14',
+	'icon_topic_latest' => 'modules/forums/images/icon_topic_latest.gif*9*18',
+	'icon_topic_newest' => 'modules/forums/images/icon_topic_newest.gif*9*18',
+	'icon_topic_reported' => 'modules/forums/images/icon_topic_reported.gif*18*19',
+	'icon_topic_unapproved' => 'modules/forums/images/icon_topic_unapproved.gif*18*19',
+	
+	'icon_user_online' => 'modules/forums/images/{LANG}/icon_user_online.gif*20*72',
+	'icon_user_offline' => 'modules/forums/images/{LANG}/icon_user_offline.gif*20*72',
+	'icon_user_profile' => 'modules/forums/images/{LANG}/icon_user_profile.gif*20*72',
+	'icon_user_search' => 'modules/forums/images/{LANG}/icon_user_search.gif*20*72',
+	'icon_user_warn' => 'modules/forums/images/{LANG}/icon_user_warn.gif*20*20',
+	
+	'button_pm_forward' => 'modules/forums/images/',
+	'button_pm_new' => 'modules/forums/images/{LANG}/button_pm_new.gif*27*97',
+	'button_pm_reply' => 'modules/forums/images/{LANG}/button_pm_reply.gif*20*90',
+	'button_topic_locked' => 'modules/forums/images/{LANG}/button_topic_locked.gif*27*97',
+	'button_topic_new' => 'modules/forums/images/{LANG}/button_topic_new.gif*27*97',
+	'button_topic_reply' => 'modules/forums/images/{LANG}/button_topic_reply.gif*27*97',
+
+);
+
+?>
\ No newline at end of file

Added: cms/trunk/modules/forums/images/poll_center.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/poll_center.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/poll_left.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/poll_left.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/poll_right.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/poll_right.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/site_logo.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/site_logo.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_read.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_read.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_read_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_read_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_read_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_read_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_read_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_read_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_unread.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_unread.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_unread_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_unread_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_unread_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_unread_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/sticky_unread_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/sticky_unread_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_moved.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_moved.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read_hot_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read_hot_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_read_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_read_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread_hot.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread_hot.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread_hot_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread_hot_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread_locked.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread_locked.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread_locked_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread_locked_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/topic_unread_mine.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/topic_unread_mine.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: cms/trunk/modules/forums/images/upload_bar.gif
===================================================================
(Binary files differ)


Property changes on: cms/trunk/modules/forums/images/upload_bar.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



