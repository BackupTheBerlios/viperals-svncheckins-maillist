<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r185 - in cms/trunk: . admin includes	includes/cache includes/display includes/forums	includes/forums/admin includes/templates/admin	includes/templates/admin/eaccelerator	includes/templates/modules/forums	includes/templates/modules/forums/admin install	modules/forums modules/forums/admin
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2006-August/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r185%20-%20in%20cms/trunk%3A%20.%20admin%20includes%0A%09includes/cache%20includes/display%20includes/forums%0A%09includes/forums/admin%20includes/templates/admin%0A%09includes/templates/admin/eaccelerator%0A%09includes/templates/modules/forums%0A%09includes/templates/modules/forums/admin%20install%0A%09modules/forums%20modules/forums/admin&In-Reply-To=%3C200608201759.k7KHxX3B016405%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000103.html">
   <LINK REL="Next"  HREF="000105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r185 - in cms/trunk: . admin includes	includes/cache includes/display includes/forums	includes/forums/admin includes/templates/admin	includes/templates/admin/eaccelerator	includes/templates/modules/forums	includes/templates/modules/forums/admin install	modules/forums modules/forums/admin</H1>
    <B>viperal at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r185%20-%20in%20cms/trunk%3A%20.%20admin%20includes%0A%09includes/cache%20includes/display%20includes/forums%0A%09includes/forums/admin%20includes/templates/admin%0A%09includes/templates/admin/eaccelerator%0A%09includes/templates/modules/forums%0A%09includes/templates/modules/forums/admin%20install%0A%09modules/forums%20modules/forums/admin&In-Reply-To=%3C200608201759.k7KHxX3B016405%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r185 - in cms/trunk: . admin includes	includes/cache includes/display includes/forums	includes/forums/admin includes/templates/admin	includes/templates/admin/eaccelerator	includes/templates/modules/forums	includes/templates/modules/forums/admin install	modules/forums modules/forums/admin">viperal at mail.berlios.de
       </A><BR>
    <I>Sun Aug 20 19:59:33 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000103.html">[Viperals-svncheckins] r184 - in cms/trunk: . admin includes	includes/auth includes/cache includes/db includes/display	includes/forums includes/forums/admin includes/forums/mcp	includes/templates/modules/forums	includes/templates/modules/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/members_list
</A></li>
        <LI>Next message: <A HREF="000105.html">[Viperals-svncheckins] r186 - in cms/trunk/modules/forums: . images	images/admin images/en
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#104">[ date ]</a>
              <a href="thread.html#104">[ thread ]</a>
              <a href="subject.html#104">[ subject ]</a>
              <a href="author.html#104">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2006-08-20 19:59:24 +0200 (Sun, 20 Aug 2006)
New Revision: 185

Added:
   cms/trunk/admin/eaccelerator.php
   cms/trunk/includes/templates/admin/eaccelerator/
   cms/trunk/includes/templates/admin/eaccelerator/index.html
   cms/trunk/includes/templates/modules/forums/admin/acp_forums.html
Removed:
   cms/trunk/includes/forums/admin/index.php
   cms/trunk/includes/forums/admin/subSilver.css
   cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html
   cms/trunk/modules/forums/images/
Modified:
   cms/trunk/core.php
   cms/trunk/includes/cache/cache_eaccelerator.php
   cms/trunk/includes/cache/cache_file.php
   cms/trunk/includes/display/template.php
   cms/trunk/includes/forums/admin/admin_forums.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/tables.php
   cms/trunk/includes/user.php
   cms/trunk/install/build_data.php
   cms/trunk/modules/forums/admin/index.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Added: cms/trunk/admin/eaccelerator.php
===================================================================
--- cms/trunk/admin/eaccelerator.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/admin/eaccelerator.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,218 @@
+&lt;?php
+/*
+||**************************************************************||
+||  Viperal CMS &#194;&#169; :												||
+||**************************************************************||
+||																||
+||	Copyright (C) 2004, 2005, 2006								||
+||  By Ryan Marshall ( Viperal )								||
+||																||
+||  Email: <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">viperal1 at gmail.com</A>									||
+||  Site: <A HREF="http://www.viperal.com">http://www.viperal.com</A>								||
+||																||
+||**************************************************************||
+||	LICENSE: ( <A HREF="http://www.gnu.org/licenses/gpl.txt">http://www.gnu.org/licenses/gpl.txt</A> )			||
+||**************************************************************||
+||  Viperal CMS is released under the terms and conditions		||
+||  of the GNU General Public License version 2					||
+||																||
+||**************************************************************||
+
+$Id$
+*/
+
+if (VIPERAL !== 'Admin') 
+{
+	die;
+}
+
+if (!function_exists('eaccelerator_info'))
+{
+
+}
+
+global $_CLASS, $sort_by;
+
+
+if (isset($_REQUEST['mode']))
+{
+	$setting = (isset($_REQUEST['setting']) &amp;&amp; $_REQUEST['setting']) ? true : false;
+
+	switch ($_REQUEST['mode'])
+	{
+		case 'caching':
+			eaccelerator_caching($setting);
+		break;
+	
+		case 'optimizer':
+			eaccelerator_optimizer($setting);
+		break;
+	
+		case 'clear_cache':
+			eaccelerator_clear();
+		break;
+	
+		case 'clean_cache':
+			eaccelerator_clean();
+		break;
+	
+		case 'purge_cache':
+			eaccelerator_purge();
+		break;
+
+		case 'keys':
+		case 'scripts':
+		case 'removed_scripts':
+			$_CLASS['core_template']-&gt;assign('eaccelerator_info', false);
+
+			eaccelerator_display($_REQUEST['mode'], get_variable('start', 'REQUEST', 0, 'integer'), 10);
+
+			$_CLASS['core_template']-&gt;display('admin/eaccelerator/index.html');
+			die;
+		break;
+	}
+}
+
+$info = eaccelerator_info();
+
+$rename_array = array(
+	'memory_size'		=&gt; 'memorySize',
+	'memory_available'	=&gt; 'memoryAvailable',
+	'memory_allocated'	=&gt; 'memoryAllocated',
+	'cached_scripts'	=&gt; 'cachedScripts',
+	'cached_keys'		=&gt; 'cachedKeys',
+	'removed_scripts'	=&gt; 'removedScripts'
+);
+
+$info['memory_usage'] = number_format(100 * $info['memoryAllocated'] / $info['memorySize'], 2);
+
+foreach ($rename_array as $new_name =&gt; $old_name)
+{
+	if (strpos($new_name, 'memory_') === 0)
+	{
+		$info[$new_name] = generate_size($info[$old_name]);
+	}
+	else
+	{
+		$info[$new_name] = $info[$old_name];
+	}
+
+	unset($info[$old_name]);
+}
+
+$info += array(
+	'eaccelerator_info'		=&gt; true,
+	'caching_link_title'	=&gt; (($info['cache']) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE']) . ' Caching',
+	'caching_link'			=&gt; generate_link('eaccelerator&amp;mode=caching&amp;setting='.(($info['cache']) ? 0 : 1), array('admin' =&gt; true)),
+	'optimizer_link_title'	=&gt; (($info['optimizer']) ? $_CLASS['core_user']-&gt;lang['DEACTIVATE'] : $_CLASS['core_user']-&gt;lang['ACTIVATE']) . ' Optimizer',
+	'optimizer_link'		=&gt; generate_link('eaccelerator&amp;mode=optimizer&amp;setting='.(($info['optimizer']) ? 0 : 1), array('admin' =&gt; true)),
+	'clear_cache_link_title'=&gt; 'Clear cache',
+	'clear_cache_link'		=&gt; generate_link('eaccelerator&amp;mode=clear_cache', array('admin' =&gt; true)),
+	'clean_cache_link_title'=&gt; 'Clean cache',
+	'clean_cache_link'		=&gt; generate_link('eaccelerator&amp;mode=clean_cache', array('admin' =&gt; true)),
+	'purge_cache_link_title'=&gt; 'Purge cache',
+	'purge_cache_link'		=&gt; generate_link('eaccelerator&amp;mode=purge_cache', array('admin' =&gt; true)),
+
+	'link_scripts'			=&gt; generate_link('eaccelerator&amp;mode=scripts', array('admin' =&gt; true)),
+	'link_removed_scripts'	=&gt; generate_link('eaccelerator&amp;mode=removed_scripts', array('admin' =&gt; true)),
+	'link_keys'				=&gt; generate_link('eaccelerator&amp;mode=keys', array('admin' =&gt; true)),
+);
+
+$_CLASS['core_template']-&gt;assign_array($info);
+
+eaccelerator_display('keys');
+eaccelerator_display('scripts');
+eaccelerator_display('removed_scripts');
+
+$_CLASS['core_template']-&gt;display('admin/eaccelerator/index.html');
+
+function eaccelerator_display($mode, $start = 0, $limit = 5, $sort = false)
+{
+	global $_CLASS, $sort_by;
+
+	$total_count = 0;
+
+	switch ($mode)
+	{
+		case 'scripts':
+		case 'removed_scripts':
+			$scripts_array = ($mode === 'scripts') ? eaccelerator_cached_scripts() : eaccelerator_removed_scripts();
+
+			if (!empty($scripts_array))
+			{
+				$sort_by = 'mtime';
+				usort($scripts_array, 'eaccelerator_compare');
+				$total_count = count($scripts_array);
+
+				$end = min($start + $limit, $total_count);
+
+				for ($i = $start; $i &lt; $end; $i++)
+				{
+					$scripts_array[$i]['time'] = date('Y/m/d H:i', $scripts_array[$i]['mtime']);
+					$scripts_array[$i]['size'] = generate_size($scripts_array[$i]['size']);
+
+					$_CLASS['core_template']-&gt;assign_vars_array($mode.'_array', $scripts_array[$i]);
+				}
+			}
+		break;
+
+		case 'keys':
+			$keys_array = eaccelerator_list_keys();
+
+			if (!empty($keys_array))
+			{
+				$sort_by = 'created';
+				usort($keys_array, 'eaccelerator_compare');
+				$total_count = count($keys_array);
+
+				$end = min($start + $limit, $total_count);
+
+				for ($i = $start; $i &lt; $end; $i++)
+				{
+					$keys_array[$i]['created'] = date('Y/m/d H:i', $keys_array[$i]['created']);
+					$keys_array[$i]['size'] = generate_size($keys_array[$i]['size']);
+				
+					if ($keys_array[$i]['ttl'] == 0)
+					{
+						$keys_array[$i]['expire_time'] = 'none';
+					}
+					elseif ($keys_array[$i]['ttl'] == -1)
+					{
+						$keys_array[$i]['expire_time'] = 'expired';
+					}
+					else
+					{
+						$keys_array[$i]['expire_time'] = date('Y/m/d H:i', $keys_array[$i]['ttl']);
+					}
+
+					$_CLASS['core_template']-&gt;assign_vars_array('keys_array', $keys_array[$i]);
+				}
+			}
+		break;
+	}
+
+	$pagination = generate_pagination('eaccelerator&amp;mode='.$mode, $total_count, $limit, $start, true);
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		$mode.'_more'				=&gt; ($total_count &lt; $limit) ? false : true,
+		$mode.'_pagination'			=&gt; $pagination['formated'],
+		$mode.'_pagination_array'	=&gt; $pagination['array'],
+	));
+}
+
+function eaccelerator_compare($x, $y)
+{
+	global $sort_by;
+
+	if ($x[$sort_by] == $y[$sort_by])
+	{
+		return 0;
+	}
+	elseif ($x[$sort_by] &lt; $y[$sort_by])
+	{
+		return 1;
+	}
+
+	return -1;
+}
+?&gt;
\ No newline at end of file

Modified: cms/trunk/core.php
===================================================================
--- cms/trunk/core.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/core.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -104,8 +104,9 @@
 load_class(false, 'core_handler');
 
 /* We're going ot use our own error handler */
+/*$_CLASS['core_handler']-&gt;start();
+
 $_CLASS['core_handler']-&gt;start();
-/*
 	$_CLASS['core_handler']-&gt;stop();
 */
 

Modified: cms/trunk/includes/cache/cache_eaccelerator.php
===================================================================
--- cms/trunk/includes/cache/cache_eaccelerator.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/cache/cache_eaccelerator.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -29,6 +29,8 @@
 		{
 			// Error here
 		}
+
+		eaccelerator_gc();
 	}
 
 	function load($name)
@@ -46,12 +48,15 @@
 	function put($name, $data, $ttl = 604800)
 	{
 		$ttl = ((int) $ttl) ? (int) $ttl : 604800;
+		$expires = gmtime() + $ttl;
 
-		if (eaccelerator_lock($this-&gt;key.$name))
+		eaccelerator_put($this-&gt;key.$name, serialize($data), $expires);
+		
+		/*if (eaccelerator_lock($this-&gt;key.$name))
 		{
-			eaccelerator_put($this-&gt;key.$name, serialize($data), $ttl);
+			eaccelerator_put($this-&gt;key.$name, serialize($data), $expires);
 			eaccelerator_unlock($this-&gt;key.$name);
-		}
+		}*/
 
 		$this-&gt;vars[$name] = $data;
 	}
@@ -66,6 +71,27 @@
 		eaccelerator_rm($this-&gt;key.$name);
 		$this-&gt;remove($name);
 	}
+
+	function destroy_all()
+	{
+		if (!function_exists('eaccelerator_list_keys'))
+		{
+			return;
+		}
+
+		$key_list = eaccelerator_list_keys();
+
+		foreach ($key_list as $key)
+		{
+			if (strpos($key['name'], $this-&gt;key) === 0)
+			{
+				$name = substr($key['name'], strlen($this-&gt;key));
+
+				eaccelerator_rm($key['name']);
+				$this-&gt;remove($name);
+			}
+		}
+	}
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/cache/cache_file.php
===================================================================
--- cms/trunk/includes/cache/cache_file.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/cache/cache_file.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -121,7 +121,7 @@
 
 		while ($file = readdir($handle))
 		{
-			if (substr($file, 0, 6) == 'cache_')
+			if (strpos($file, 'cache_') === 0)
 			{
 				unlink($this-&gt;cache_dir . $file);
 			} 

Modified: cms/trunk/includes/display/template.php
===================================================================
--- cms/trunk/includes/display/template.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/display/template.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -531,6 +531,14 @@
 
 				Switch ($vars[$loop])
 				{
+					case 'LOOP_START':
+						$output = &quot;(\$this-&gt;_loop['$loop_name']['index'] === 0)&quot;;
+					break;
+
+					case 'LOOP_END':
+						$output = &quot;(\$this-&gt;_loop['$loop_name']['index'] === \$this-&gt;_loop['$loop_name']['count'])&quot;;
+					break;
+
 					case 'LOOP_INDEX':
 						$output = &quot;\$this-&gt;_loop['$loop_name']['index']&quot;;
 					break;

Modified: cms/trunk/includes/forums/admin/admin_forums.php
===================================================================
--- cms/trunk/includes/forums/admin/admin_forums.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/admin_forums.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -22,34 +22,41 @@
 $forum_id	= request_var('f', 0);
 $parent_id	= request_var('parent_id', 0);
 
+$l_title	= '';
 $forum_data = $errors = array();
 
-// Do we have permissions?
-switch ($mode)
+if (!$_CLASS['forums_auth']-&gt;acl_get('a_forum'))
 {
-	case 'add':
-		$acl = 'a_forumadd';
-	break;
-
-	case 'delete':
-		$acl = 'a_forumdel';
-	break;
-
-	default:
-		$acl = 'a_forum';
-	break;
+	trigger_error('NO_ADMIN');
 }
 
-if (!$_CLASS['auth']-&gt;acl_get($acl))
-{
-	trigger_error('NO_ADMIN');
+switch ($action)
+{
+	case 'delete':
+		if (!$_CLASS['forums_auth']-&gt;acl_get('a_forumdel'))
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_PERMISSION_FORUM_DELETE'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	break;
+
+	case 'add':
+		if (!$_CLASS['forums_auth']-&gt;acl_get('a_forumadd'))
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_PERMISSION_FORUM_ADD'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	break;
 }
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'S_EDIT_FORUM'		=&gt; false,
+	'S_DELETE_FORUM'	=&gt; false,
+	'S_RESYNCED'		=&gt; false,
+));
 
 // Major routines
 if ($update)
 {
-	switch ($mode)
+	switch ($action)
 	{
 		case 'delete':
 			if (!$forum_id)
@@ -62,12 +69,16 @@
 			$action_posts		= request_var('action_posts', '');
 			$posts_to_id		= request_var('posts_to_id', 0);
 
-			delete_forum($forum_id, $action_posts, $action_subforums, $posts_to_id, $subforums_to_id);
+			$errors = delete_forum($forum_id, $action_posts, $action_subforums, $posts_to_id, $subforums_to_id);
 
-			$_CLASS['auth']-&gt;acl_clear_prefetch();
+			if (sizeof($errors))
+			{
+				break;
+			}
 
-			$show_prev_info = false;
-			trigger_error('FORUM_DELETED');
+			$_CLASS['forums_auth']-&gt;acl_clear_prefetch();
+
+			trigger_error($_CLASS['core_user']-&gt;lang['FORUM_DELETED'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
 		break;
 
 		case 'edit':
@@ -84,29 +95,37 @@
 			$forum_data += array(
 				'parent_id'				=&gt; $parent_id,
 				'forum_type'			=&gt; request_var('forum_type', FORUM_POST),
+				'type_action'			=&gt; request_var('type_action', ''),
 				'forum_status'			=&gt; request_var('forum_status', ITEM_UNLOCKED),
-				'forum_name'			=&gt; request_var('forum_name', ''),
-				'forum_link'			=&gt; request_var('forum_link', ''),
-				'forum_link_track'		=&gt; request_var('forum_link_track', FALSE),
-				'forum_desc'			=&gt; str_replace(&quot;\n&quot;, '&lt;br /&gt;', request_var('forum_desc', '')),
-				'forum_rules'			=&gt; request_var('forum_rules', ''),
-				'forum_rules_link'		=&gt; request_var('forum_rules_link', ''),
-				'forum_image'			=&gt; request_var('forum_image', ''),
-				'display_on_index'		=&gt; request_var('display_on_index', FALSE),
-				'forum_topics_per_page'	=&gt; request_var('topics_per_page', 0), 
-				'enable_indexing'		=&gt; request_var('enable_indexing',true), 
-				'enable_icons'			=&gt; request_var('enable_icons', FALSE),
-				'enable_prune'			=&gt; request_var('enable_prune', FALSE),
-				'prune_days'			=&gt; request_var('prune_days', 7),
-				'prune_viewed'			=&gt; request_var('prune_viewed', 7),
-				'prune_freq'			=&gt; request_var('prune_freq', 1),
-				'prune_old_polls'		=&gt; request_var('prune_old_polls', FALSE),
-				'prune_announce'		=&gt; request_var('prune_announce', FALSE),
-				'prune_sticky'			=&gt; request_var('prune_sticky', FALSE),
-				'forum_password'		=&gt; request_var('forum_password', ''),
+				'forum_name'			=&gt; request_var('forum_name', '', true),
+				'forum_link'			=&gt; request_var('forum_link', ''),
+				'forum_link_track'		=&gt; request_var('forum_link_track', false),
+				'forum_desc'			=&gt; request_var('forum_desc', '', true),
+				'forum_desc_uid'		=&gt; '',
+				'forum_desc_options'	=&gt; 0,
+				'forum_desc_bitfield'	=&gt; '',
+				'forum_rules'			=&gt; request_var('forum_rules', '', true),
+				'forum_rules_uid'		=&gt; '',
+				'forum_rules_options'	=&gt; 0,
+				'forum_rules_bitfield'	=&gt; '',
+				'forum_rules_link'		=&gt; request_var('forum_rules_link', ''),
+				'forum_image'			=&gt; request_var('forum_image', ''),
+				'display_on_index'		=&gt; request_var('display_on_index', false),
+				'forum_topics_per_page'	=&gt; request_var('topics_per_page', 0), 
+				'enable_indexing'		=&gt; request_var('enable_indexing',true), 
+				'enable_icons'			=&gt; request_var('enable_icons', false),
+				'enable_prune'			=&gt; request_var('enable_prune', false),
+				'enable_post_review'	=&gt; request_var('enable_post_review', true),
+				'prune_days'			=&gt; request_var('prune_days', 7),
+				'prune_viewed'			=&gt; request_var('prune_viewed', 7),
+				'prune_freq'			=&gt; request_var('prune_freq', 1),
+				'prune_old_polls'		=&gt; request_var('prune_old_polls', false),
+				'prune_announce'		=&gt; request_var('prune_announce', false),
+				'prune_sticky'			=&gt; request_var('prune_sticky', false),
+				'forum_password'		=&gt; request_var('forum_password', ''),
 				'forum_password_confirm'=&gt; request_var('forum_password_confirm', ''),
 			);
-	
+
 			if ($mode === 'add')
 			{
 				$forum_data += array(
@@ -116,1524 +135,1348 @@
 				);
 			}
 
-			if ($forum_data['forum_rules'])
-			{
-				require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
+			$forum_data['show_active'] = ($forum_data['forum_type'] == FORUM_POST) ? request_var('display_recent', false) : request_var('display_active', false);
 
-				$allow_bbcode = request_var('parse_bbcode', false);
-				$allow_smilies = request_var('parse_smilies', false);
-				$allow_urls = request_var('parse_urls', false);
-
-				$forum_data['forum_rules_flags'] = (($allow_bbcode) ? 1 : 0) + (($allow_smilies) ? 2 : 0) + (($allow_urls) ? 4 : 0);
-
-				$message_parser = new parse_message($forum_data['forum_rules']);
-				$message_parser-&gt;parse(false, $allow_bbcode, $allow_urls, $allow_smilies);
-			
-				$forum_data['forum_rules'] = $message_parser-&gt;message;
-				$forum_data['forum_rules_bbcode_uid'] = $message_parser-&gt;bbcode_uid;
-				$forum_data['forum_rules_bbcode_bitfield'] = $message_parser-&gt;bbcode_bitfield;
-				unset($message_parser);
+			// Get data for forum rules if specified...
+			if ($forum_data['forum_rules'])
+			{
+				generate_text_for_storage($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options'], request_var('rules_parse_bbcode', false), request_var('rules_parse_urls', false), request_var('rules_parse_smilies', false));
 			}
 
-			$errors = update_forum_data($forum_data);
-
-			if ($errors)
-			{
-				break;
+			// Get data for forum description if specified
+			if ($forum_data['forum_desc'])
+			{
+				generate_text_for_storage($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options'], request_var('desc_parse_bbcode', false), request_var('desc_parse_urls', false), request_var('desc_parse_smilies', false));
 			}
 
-			$_CLASS['auth']-&gt;acl_clear_prefetch();
+			$_CLASS['core_db']-&gt;transaction();
+				$errors = update_forum_data($forum_data);
+			$_CLASS['core_db']-&gt;transaction('commit');
 
-			// Redirect to permissions
-			$message = ($mode === 'add') ? $_CLASS['core_user']-&gt;lang['FORUM_CREATED'] : $_CLASS['core_user']-&gt;lang['FORUM_UPDATED'];
-			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['REDIRECT_ACL'], '&lt;a href=&quot;'.generate_link('forums&amp;file=admin_permissions&amp;mode=forum&amp;submit_usergroups=true&amp;ug_type=forum&amp;action=usergroups&amp;f[forum][]=' . $forum_data['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;', '&lt;/a&gt;');
-			$show_prev_info = ($mode == 'edit') ? true : false;
-
-			trigger_error($message);
+			if (!sizeof($errors))
+			{
+				$forum_perm_from = request_var('forum_perm_from', 0);
+
+				// Copy permissions?
+				if ($forum_perm_from)
+				{
+					// if we edit a forum delete current permissions first
+					if ($action === 'edit')
+					{
+						$sql = 'DELETE FROM ' . FORUMS_ACL_TABLE . '
+							WHERE forum_id = ' . (int) $forum_data['forum_id'];
+						$_CLASS['core_db']-&gt;query($sql);
+					}
+
+					// From the mysql documentation:
+					// Prior to MySQL 4.0.14, the target table of the INSERT statement cannot appear in the FROM clause of the SELECT part of the query. This limitation is lifted in 4.0.14.
+					// Due to this we stay on the safe side if we do the insertion &quot;the manual way&quot;
+
+					// Copy permisisons from/to the acl users table (only forum_id gets changed)
+					$sql = 'SELECT user_id, group_id, auth_option_id, auth_role_id, auth_setting
+						FROM ' . FORUMS_ACL_TABLE . '
+						WHERE forum_id = ' . $forum_perm_from;
+					$result = $_CLASS['core_db']-&gt;query($sql);
+
+					$sql_array = array();
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$sql_array[] = array(
+							'user_id'			=&gt; (int) $row['user_id'],
+							'group_id'			=&gt; (int) $row['group_id'],
+							'forum_id'			=&gt; (int) $forum_data['forum_id'],
+							'auth_option_id'	=&gt; (int) $row['auth_option_id'],
+							'auth_role_id'		=&gt; (int) $row['auth_role_id'],
+							'auth_setting'		=&gt; (int) $row['auth_setting']
+						);
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					// Now insert the data
+					if (!empty($sql_array))
+					{
+						$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_array, FORUMS_ACL_TABLE);
+						unset($sql_array);
+					}
+				}
+
+				$_CLASS['forums_auth']-&gt;acl_clear_prefetch();
+
+				$acl_url = '&amp;mode=setting_forum_local&amp;forum_id[]=' . $forum_data['forum_id'] . '&amp;select_all_groups=1';
+
+				$message = ($action == 'add') ? $_CLASS['core_user']-&gt;lang['FORUM_CREATED'] : $_CLASS['core_user']-&gt;lang['FORUM_UPDATED'];
+
+				// Redirect to permissions
+				if ($_CLASS['forums_auth']-&gt;acl_get('a_fauth'))
+				{
+					$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['REDIRECT_ACL'], '&lt;a href=&quot;' . generate_link('forums&amp;i=permissions'. $acl_url, array('admin' =&gt; true)) . '&quot;&gt;', '&lt;/a&gt;');
+				}
+
+				// redirect directly to permission settings screen if authed
+				if ($action === 'add' &amp;&amp; !$forum_perm_from &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('a_fauth'))
+				{
+					$_CLASS['core_display']-&gt;meta_refresh(4, generate_link('forums&amp;i=permissions'. $acl_url, array('admin' =&gt; true)));
+				}
+
+				trigger_error($message . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+			}
 		break;
 	}
 }
 
-switch ($mode)
+switch ($action)
 {
+	case 'move_up':
+	case 'move_down':
+	
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	
+		$sql = 'SELECT *
+			FROM ' . FORUMS_FORUMS_TABLE . &quot;
+			WHERE forum_id = $forum_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+	
+		if (!$row)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	
+		$move_forum_name = move_forum_by($row, $action, 1);
+	
+		if ($move_forum_name !== false)
+		{
+			add_log('admin', 'LOG_FORUM_' . strtoupper($action), $row['forum_name'], $move_forum_name);
+		}
+	
+	break;
+	
+	case 'sync':
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	
+		$sql = 'SELECT forum_name, forum_type
+			FROM ' . FORUMS_FORUMS_TABLE . &quot;
+			WHERE forum_id = $forum_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+	
+		if (!$row)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+	
+		sync('forum', 'forum_id', $forum_id);
+		add_log('admin', 'LOG_FORUM_SYNC', $row['forum_name']);
+	
+		$_CLASS['core_template']-&gt;assign('L_FORUM_RESYNCED', sprintf($_CLASS['core_user']-&gt;lang['FORUM_RESYNCED'], $row['forum_name']));
+	
+	break;
+
 	case 'add':
 	case 'edit':
-		if ($update)
-		{
-			extract($forum_data);
+		if ($update)
+		{
+			$forum_data['forum_flags'] = 0;
+			$forum_data['forum_flags'] += (request_var('forum_link_track', false)) ? 1 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_old_polls', false)) ? 2 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_announce', false)) ? 4 : 0;
+			$forum_data['forum_flags'] += (request_var('prune_sticky', false)) ? 8 : 0;
+			$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
+			$forum_data['forum_flags'] += (request_var('enable_post_review', true)) ? 32 : 0;
 		}
-		else
-		{
-			$forum_id				= request_var('f', 0);
-			$parent_id				= request_var('parent_id', 0);
-			$style_id				= request_var('style_id', 0);
-			$forum_type				= request_var('forum_type', FORUM_POST);
-			$forum_status			= request_var('forum_status', ITEM_UNLOCKED);
-			$forum_desc				= request_var('forum_desc', '');
-			$forum_name				= request_var('forum_name', '');
-			$forum_rules_link		= request_var('forum_rules_link', '');
-			$forum_rules			= request_var('forum_rules', '');
-			$forum_password			= request_var('forum_password', '');
-			$forum_password_confirm	= request_var('forum_password_confirm', '');
 
-			$forum_rules_flags		= 0;
-			$forum_rules_flags		+= (request_var('parse_bbcode', false)) ? 1 : 0;
-			$forum_rules_flags		+= (request_var('parse_smilies', false)) ? 2 : 0;
-			$forum_rules_flags		+= (request_var('parse_urls', false)) ? 4 : 0;
+		// Show form to create/modify a forum
+		if ($action == 'edit')
+		{
+			$l_title = 'EDIT_FORUM';
+			$row = get_forum_info($forum_id);
+			$old_forum_type = $row['forum_type'];
+
+			if (!$update)
+			{
+				$forum_data = $row;
+			}
+
+			// Make sure there is no forum displayed for parents_list having the current forum id as a parent...
+			$sql = 'SELECT forum_id
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE parent_id = ' . $forum_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			$exclude_forums = array($forum_id);
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$exclude_forums[] = $row['forum_id'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$parents_list = make_forum_select($forum_data['parent_id'], $exclude_forums, false, false, false);
+
+			$forum_data['forum_password_confirm'] = $forum_data['forum_password'];
 		}
-		
-		// Show form to create/modify a forum
-		if ($mode == 'edit')
-		{
-			$l_title = $_CLASS['core_user']-&gt;lang['EDIT_FORUM'];
-			$forum_data = get_forum_info($forum_id);
+		else
+		{
+			$l_title = 'CREATE_FORUM';
+
+			$forum_id = $parent_id;
+			$parents_list = make_forum_select($parent_id, false, false, false, false);
+
+			// Fill forum data with default values
+			if (!$update)
+			{
+				$forum_data = array(
+					'parent_id'				=&gt; $parent_id,
+					'forum_type'			=&gt; FORUM_POST,
+					'forum_status'			=&gt; ITEM_UNLOCKED,
+					'forum_name'			=&gt; request_var('forum_name', '', true),
+					'forum_link'			=&gt; '',
+					'forum_link_track'		=&gt; false,
+					'forum_desc'			=&gt; '',
+					'forum_rules'			=&gt; '',
+					'forum_rules_link'		=&gt; '',
+					'forum_image'			=&gt; '',
+					'forum_style'			=&gt; 0,
+					'display_on_index'		=&gt; false,
+					'forum_topics_per_page'	=&gt; 0, 
+					'enable_indexing'		=&gt; true, 
+					'enable_icons'			=&gt; false,
+					'enable_prune'			=&gt; false,
+					'prune_days'			=&gt; 7,
+					'prune_viewed'			=&gt; 7,
+					'prune_freq'			=&gt; 1,
+					'forum_flags'			=&gt; 0,
+					'forum_password'		=&gt; '',
+					'forum_password_confirm'=&gt; '',
+				);
+			}
+		}
+
+		$forum_rules_data = array(
+			'text'			=&gt; $forum_data['forum_rules'],
+			'allow_bbcode'	=&gt; true,
+			'allow_smilies'	=&gt; true,
+			'allow_urls'	=&gt; true
+		);
+
+		$forum_desc_data = array(
+			'text'			=&gt; $forum_data['forum_desc'],
+			'allow_bbcode'	=&gt; true,
+			'allow_smilies'	=&gt; true,
+			'allow_urls'	=&gt; true
+		);
+
+		$forum_rules_preview = '';
+
+		// Parse rules if specified
+		if ($forum_data['forum_rules'])
+		{
+			if (!isset($forum_data['forum_rules_uid']))
+			{
+				// Before we are able to display the preview and plane text, we need to parse our request_var()'d value...
+				$forum_data['forum_rules_uid'] = '';
+				$forum_data['forum_rules_bitfield'] = '';
+				$forum_data['forum_rules_options'] = 0;
+
+				generate_text_for_storage($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options'], request_var('rules_allow_bbcode', false), request_var('rules_allow_urls', false), request_var('rules_allow_smiliess', false));
+			}
+
+			// Generate preview content
+			$forum_rules_preview = generate_text_for_display($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options']);
+
+			// decode...
+			$forum_rules_data = generate_text_for_edit($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_options']);
+		}
+
+		// Parse desciption if specified
+		if ($forum_data['forum_desc'])
+		{
+			if (!isset($forum_data['forum_desc_uid']))
+			{
+				// Before we are able to display the preview and plane text, we need to parse our request_var()'d value...
+				$forum_data['forum_desc_uid'] = '';
+				$forum_data['forum_desc_bitfield'] = '';
+				$forum_data['forum_desc_options'] = 0;
+
+				generate_text_for_storage($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options'], request_var('desc_allow_bbcode', false), request_var('desc_allow_urls', false), request_var('desc_allow_smiliess', false));
+			}
+
+			// decode...
+			$forum_desc_data = generate_text_for_edit($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_options']);
+		}
+
+		$forum_type_options = '';
+		$forum_type_ary = array(FORUM_CAT =&gt; 'CAT', FORUM_POST =&gt; 'FORUM', FORUM_LINK =&gt; 'LINK');
+
+		foreach ($forum_type_ary as $value =&gt; $lang)
+		{
+			$forum_type_options .= '&lt;option value=&quot;' . $value . '&quot;' . (($value == $forum_data['forum_type']) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['TYPE_' . $lang] . '&lt;/option&gt;';
+		}
+
+		$statuslist = '&lt;option value=&quot;' . ITEM_UNLOCKED . '&quot;' . (($forum_data['forum_status'] == ITEM_UNLOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['UNLOCKED'] . '&lt;/option&gt;&lt;option value=&quot;' . ITEM_LOCKED . '&quot;' . (($forum_data['forum_status'] == ITEM_LOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['LOCKED'] . '&lt;/option&gt;';
+
+		$sql = 'SELECT forum_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_type = ' . FORUM_POST . &quot;
+				AND forum_id &lt;&gt; $forum_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'S_MOVE_FORUM_OPTIONS'		=&gt; make_forum_select($forum_data['parent_id'], $forum_id, false, true, false))
+			);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$s_show_display_on_index = false;
+
+		if ($forum_data['parent_id'] &gt; 0)
+		{
+			// if this forum is a subforum put the &quot;display on index&quot; checkbox
+			if ($parent_info = get_forum_info($forum_data['parent_id']))
+			{
+				if ($parent_info['parent_id'] &gt; 0 || $parent_info['forum_type'] == FORUM_CAT)
+				{
+					$s_show_display_on_index = true;
+				}
+			}
+		}
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_EDIT_FORUM'		=&gt; true,
+			'S_ERROR'			=&gt; (sizeof($errors)) ? true : false,
+			'S_PARENT_ID'		=&gt; $parent_id,
+			'S_FORUM_PARENT_ID'	=&gt; $forum_data['parent_id'],
+			'S_ADD_ACTION'		=&gt; ($action === 'add') ? true : false,
+
+			'U_BACK'		=&gt; generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true)),
+			'U_EDIT_ACTION'	=&gt; generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id . &quot;&amp;action=$action&amp;f=$forum_id&quot;, array('admin' =&gt; true)),
+
+			'L_COPY_PERMISSIONS_EXPLAIN'	=&gt; $_CLASS['core_user']-&gt;get_lang('COPY_PERMISSIONS_' . strtoupper($action) . '_EXPLAIN'),
+			'ERROR_MSG'						=&gt; (sizeof($errors)) ? implode('&lt;br /&gt;', $errors) : '',
+
+			'FORUM_NAME'				=&gt; $forum_data['forum_name'],
+			'FORUM_DATA_LINK'			=&gt; $forum_data['forum_link'],
+			'FORUM_IMAGE'				=&gt; $forum_data['forum_image'],
+			'FORUM_IMAGE_SRC'			=&gt; ($forum_data['forum_image']) ? $forum_data['forum_image'] : '',
+			'FORUM_POST'				=&gt; FORUM_POST,
+			'FORUM_LINK'				=&gt; FORUM_LINK,
+			'FORUM_CAT'					=&gt; FORUM_CAT,
+			'PRUNE_FREQ'				=&gt; $forum_data['prune_freq'],
+			'PRUNE_DAYS'				=&gt; $forum_data['prune_days'],
+			'PRUNE_VIEWED'				=&gt; $forum_data['prune_viewed'],
+			'TOPICS_PER_PAGE'			=&gt; $forum_data['forum_topics_per_page'],
+			'FORUM_PASSWORD'			=&gt; $forum_data['forum_password'],
+			'FORUM_PASSWORD_CONFIRM'	=&gt; $forum_data['forum_password_confirm'],
+			'FORUM_RULES_LINK'			=&gt; $forum_data['forum_rules_link'],
+			'FORUM_RULES'				=&gt; $forum_data['forum_rules'],
+			'FORUM_RULES_PREVIEW'		=&gt; $forum_rules_preview,
+			'FORUM_RULES_PLAIN'			=&gt; $forum_rules_data['text'],
+			'S_BBCODE_CHECKED'			=&gt; ($forum_rules_data['allow_bbcode']) ? true : false,
+			'S_SMILIES_CHECKED'			=&gt; ($forum_rules_data['allow_smilies']) ? true : false,
+			'S_URLS_CHECKED'			=&gt; ($forum_rules_data['allow_urls']) ? true : false,
+
+			'FORUM_DESC'				=&gt; $forum_desc_data['text'],
+			'S_DESC_BBCODE_CHECKED'		=&gt; ($forum_desc_data['allow_bbcode']) ? true : false,
+			'S_DESC_SMILIES_CHECKED'	=&gt; ($forum_desc_data['allow_smilies']) ? true : false,
+			'S_DESC_URLS_CHECKED'		=&gt; ($forum_desc_data['allow_urls']) ? true : false,
+
+			'S_FORUM_TYPE_OPTIONS'		=&gt; $forum_type_options,
+			'S_PARENT_OPTIONS'			=&gt; $parents_list,
+			'S_STATUS_OPTIONS'			=&gt; $statuslist,
+			'S_FORUM_OPTIONS'			=&gt; make_forum_select(($action === 'add') ? $forum_data['parent_id'] : false, false, false, false, false),
+			'S_SHOW_DISPLAY_ON_INDEX'	=&gt; $s_show_display_on_index,
+			'S_FORUM_POST'				=&gt; ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+			'S_FORUM_ORIG_POST'			=&gt; (isset($old_forum_type) &amp;&amp; $old_forum_type == FORUM_POST) ? true : false,
+			'S_FORUM_LINK'				=&gt; ($forum_data['forum_type'] == FORUM_LINK) ? true : false,
+			'S_FORUM_CAT'				=&gt; ($forum_data['forum_type'] == FORUM_CAT) ? true : false,
+			'S_ENABLE_INDEXING'			=&gt; ($forum_data['enable_indexing']) ? true : false,
+			'S_TOPIC_ICONS'				=&gt; ($forum_data['enable_icons']) ? true : false,
+			'S_DISPLAY_ON_INDEX'		=&gt; ($forum_data['display_on_index']) ? true : false,
+			'S_PRUNE_ENABLE'			=&gt; ($forum_data['enable_prune']) ? true : false,
+			'S_FORUM_LINK_TRACK'		=&gt; ($forum_data['forum_flags'] &amp; 1) ? true : false,
+			'S_PRUNE_OLD_POLLS'			=&gt; ($forum_data['forum_flags'] &amp; 2) ? true : false,
+			'S_PRUNE_ANNOUNCE'			=&gt; ($forum_data['forum_flags'] &amp; 4) ? true : false,
+			'S_PRUNE_STICKY'			=&gt; ($forum_data['forum_flags'] &amp; 8) ? true : false,
+			'S_DISPLAY_ACTIVE_TOPICS'	=&gt; ($forum_data['forum_flags'] &amp; 16) ? true : false,
+			'S_ENABLE_POST_REVIEW'		=&gt; ($forum_data['forum_flags'] &amp; 32) ? true : false,
+			)
+		);
 
-			if (!isset($_POST['forum_type']))
-			{
-				extract($forum_data);
-			}
-			else
-			{
-				$old_forum_type = $forum_data['forum_type'];
-			}
-			unset($forum_data);
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($l_title), 'modules/forums/admin/acp_forums.html');
+
+		return;
+
+	break;
+
+	case 'delete':
+
+		if (!$forum_id)
+		{
+			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM'] . adm_back_link(generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true))));
+		}
+
+		$forum_data = get_forum_info($forum_id);
+
+		$subforums_id = array();
+
+		$subforums = get_forum_branch($forum_id, 'children');
+		foreach ($subforums as $row)
+		{
+			$subforums_id[] = $row['forum_id'];
+		}
+
+		$forums_list = make_forum_select($forum_data['parent_id'], $subforums_id);
+
+		$sql = 'SELECT forum_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_type = ' . FORUM_POST . &quot;
+				AND forum_id &lt;&gt; $forum_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$_CLASS['core_template']-&gt;assign_array(array(
+				'S_MOVE_FORUM_OPTIONS'		=&gt; make_forum_select($forum_data['parent_id'], $subforums_id)) // , false, true, false???
+			);
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$parent_id = ($parent_id == $forum_id) ? 0 : $parent_id;
+
+		$_CLASS['core_template']-&gt;assign_array(array(
+			'S_DELETE_FORUM'		=&gt; true,
+			'U_ACTION'				=&gt; generate_link(&quot;forums&amp;file=admin_forums&amp;parent_id=$parent_id&amp;parent_id={$parent_id}&amp;action=delete&amp;f=$forum_id&quot;, array('admin' =&gt; true)),
+			'U_BACK'				=&gt; generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true)),
+
+			'FORUM_NAME'			=&gt; $forum_data['forum_name'],
+			'S_FORUM_POST'			=&gt; ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+			'S_HAS_SUBFORUMS'		=&gt; ($forum_data['right_id'] - $forum_data['left_id'] &gt; 1) ? true : false,
+			'S_FORUMS_LIST'			=&gt; $forums_list,
+			'S_ERROR'				=&gt; (sizeof($errors)) ? true : false,
+			'ERROR_MSG'				=&gt; (sizeof($errors)) ? implode('&lt;br /&gt;', $errors) : '')
+		);
 
-			$parents_list = make_forum_select($parent_id, $forum_id, false, false, false);
-			$forums_list = make_forum_select($parent_id, $forum_id, false, true, false);
+		$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($l_title), 'modules/forums/admin/acp_forums.html');
+
+		return;
+	break;
+}
+
+// Default management page
+if (!$parent_id)
+{
+	$navigation = $_CLASS['core_user']-&gt;lang['FORUM_INDEX'];
+}
+else
+{
+	$navigation = '&lt;a href=&quot;' . generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['FORUM_INDEX'] . '&lt;/a&gt;';
+
+	$forums_nav = get_forum_branch($parent_id, 'parents', 'descending');
+	foreach ($forums_nav as $row)
+	{
+		if ($row['forum_id'] == $parent_id)
+		{
+			$navigation .= ' -&gt; ' . $row['forum_name'];
+		}
+		else
+		{
+			$navigation .= ' -&gt; &lt;a href=&quot;' . generate_link('forums&amp;file=admin_forums&amp;parent_id='.$row['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;' . $row['forum_name'] . '&lt;/a&gt;';
+		}
+	}
+}
+
+// Jumpbox
+$forum_box = make_forum_select($parent_id, false, false, false, false); //make_forum_select($parent_id);
+
+if ($action == 'sync')
+{
+	$_CLASS['core_template']-&gt;assign('S_RESYNCED', true);
+}
+
+$sql = 'SELECT *
+	FROM ' . FORUMS_FORUMS_TABLE . &quot;
+	WHERE parent_id = $parent_id
+	ORDER BY left_id&quot;;
+$result = $_CLASS['core_db']-&gt;query($sql);
+
+if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+{
+	$_CLASS['core_template']-&gt;assign('S_NO_FORUMS', false);
 
-			$forum_password_confirm = $forum_password;
+	do
+	{
+		$forum_type = $row['forum_type'];
+
+		if ($row['forum_status'] == ITEM_LOCKED)
+		{
+			$folder_image = '&lt;img src=&quot;modules/forums/images/admin/icon_folder_lock.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['LOCKED'] . '&quot; /&gt;';
+		}
+		else
+		{
+			switch ($forum_type)
+			{
+				case FORUM_LINK:
+					$folder_image = '&lt;img src=&quot;modules/forums/images/admin/icon_folder_link.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['LINK'] . '&quot; /&gt;';
+				break;
+
+				default:
+					$folder_image = ($row['left_id'] + 1 != $row['right_id']) ? '&lt;img src=&quot;modules/forums/images/admin/icon_subfolder.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['SUBFORUM'] . '&quot; /&gt;' : '&lt;img src=&quot;modules/forums/images/admin/icon_folder.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['FOLDER'] . '&quot; /&gt;';
+				break;
+			}
+		}
+
+		$url = &quot;forums&amp;file=admin_forums&amp;parent_id=&amp;parent_id=$parent_id&amp;f={$row['forum_id']}&quot;;
+
+		$forum_title = ($forum_type != FORUM_LINK) ? '&lt;a href=&quot;' . generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;' : '';
+		$forum_title .= $row['forum_name'];
+		$forum_title .= ($forum_type != FORUM_LINK) ? '&lt;/a&gt;' : '';
+
+		$_CLASS['core_template']-&gt;assign_vars_array('forums', array(
+			'FOLDER_IMAGE'		=&gt; $folder_image,
+			'FORUM_NAME'		=&gt; $row['forum_name'],
+			'FORUM_DESCRIPTION'	=&gt; generate_text_for_display($row['forum_desc'], $row['forum_desc_uid'], $row['forum_desc_bitfield'], $row['forum_desc_options']),
+			'FORUM_TOPICS'		=&gt; $row['forum_topics'],
+			'FORUM_POSTS'		=&gt; $row['forum_posts'],
+
+			'S_FORUM_LINK'		=&gt; ($forum_type == FORUM_LINK) ? true : false,
+			'S_FORUM_POST'		=&gt; ($forum_type == FORUM_POST) ? true : false,
+
+			'U_FORUM'			=&gt; generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' =&gt; true)),
+			'U_MOVE_UP'			=&gt; generate_link($url . '&amp;action=move_up', array('admin' =&gt; true)),
+			'U_MOVE_DOWN'		=&gt; generate_link($url . '&amp;action=move_down', array('admin' =&gt; true)),
+			'U_EDIT'			=&gt; generate_link($url . '&amp;action=edit', array('admin' =&gt; true)),
+			'U_DELETE'			=&gt; generate_link($url . '&amp;action=delete', array('admin' =&gt; true)),
+			'U_SYNC'			=&gt; generate_link($url . '&amp;action=sync', array('admin' =&gt; true))
+		));
+	}
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+}
+elseif ($parent_id)
+{
+	$row = get_forum_info($parent_id);
+
+	$url = 'forums&amp;file=admin_forums&amp;parent_id=' . $parent_id . '&amp;f=' . $row['forum_id'];
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_NO_FORUMS'		=&gt; true,
+
+		'U_EDIT'			=&gt; generate_link($url . '&amp;action=edit', array('admin' =&gt; true)),
+		'U_DELETE'			=&gt; generate_link($url . '&amp;action=delete', array('admin' =&gt; true)),
+		'U_SYNC'			=&gt; generate_link($url . '&amp;action=sync', array('admin' =&gt; true))
+	));
+}
+$_CLASS['core_db']-&gt;free_result($result);
+
+$_CLASS['core_template']-&gt;assign_array(array(
+	'ERROR_MSG'		=&gt; (sizeof($errors)) ? implode('&lt;br /&gt;', $errors) : '',
+	'NAVIGATION'	=&gt; $navigation,
+	'FORUM_BOX'		=&gt; $forum_box,
+	'U_SEL_ACTION'	=&gt; generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)),
+	'U_ACTION'		=&gt; generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $parent_id, array('admin' =&gt; true))
+));
 
-			$bbcode_checked		= ($forum_rules_flags &amp; 1) ? ' checked=&quot;checked&quot;' : '';
-			$smilies_checked	= ($forum_rules_flags &amp; 2) ? ' checked=&quot;checked&quot;' : '';
-			$urls_checked		= ($forum_rules_flags &amp; 4) ? ' checked=&quot;checked&quot;' : '';
-		}
-		else
-		{
-			$l_title = $_CLASS['core_user']-&gt;lang['CREATE_FORUM'];
+$_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang($l_title), 'modules/forums/admin/acp_forums.html');
 
-			$forum_id = $parent_id;
-			$parents_list = make_forum_select($parent_id, false, false, false, false);
+
+/**
+* Get forum details
+*/
+function get_forum_info($forum_id)
+{
+	global $_CLASS;
+
+	$sql = 'SELECT *
+		FROM ' . FORUMS_FORUMS_TABLE . &quot;
+		WHERE forum_id = $forum_id&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if (!$row)
+	{
+		trigger_error(&quot;Forum #$forum_id does not exist&quot;, E_USER_ERROR);
+	}
+
+	return $row;
+}
+
+/**
+* Update forum data
+*/
+function update_forum_data(&amp;$forum_data)
+{
+	global $_CLASS;
+
+	$errors = array();
+
+	if (!$forum_data['forum_name'])
+	{
+		$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_NAME_EMPTY'];
+	}
+
+	if ($forum_data['forum_password'] || $forum_data['forum_password_confirm'])
+	{
+		if ($forum_data['forum_password'] != $forum_data['forum_password_confirm'])
+		{
+			$forum_data['forum_password'] = $forum_data['forum_password_confirm'] = '';
+			$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD_MISMATCH'];
+		}
+	}
+
+	if ($forum_data['prune_days'] &lt; 0 || $forum_data['prune_viewed'] &lt; 0 || $forum_data['prune_freq'] &lt; 0)
+	{
+		$forum_data['prune_days'] = $forum_data['prune_viewed'] = $forum_data['prune_freq'] = 0;
+		$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_DATA_NEGATIVE'];
+	}
+
+	// Set forum flags
+	// 1 = link tracking
+	// 2 = prune old polls
+	// 4 = prune announcements
+	// 8 = prune stickies
+	// 16 = show active topics
+	// 32 = enable post review
+	$forum_data['forum_flags'] = 0;
+	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? 1 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? 2 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? 4 : 0;
+	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? 8 : 0;
+	$forum_data['forum_flags'] += ($forum_data['show_active']) ? 16 : 0;
+	$forum_data['forum_flags'] += ($forum_data['enable_post_review']) ? 32 : 0;
+
+	// Unset data that are not database fields
+	$forum_data_sql = $forum_data;
+
+	unset($forum_data_sql['forum_link_track']);
+	unset($forum_data_sql['prune_old_polls']);
+	unset($forum_data_sql['prune_announce']);
+	unset($forum_data_sql['prune_sticky']);
+	unset($forum_data_sql['show_active']);
+	unset($forum_data_sql['enable_post_review']);
+	unset($forum_data_sql['forum_password_confirm']);
+
+	// What are we going to do tonight Brain? The same thing we do everynight,
+	// try to take over the world ... or decide whether to continue update
+	// and if so, whether it's a new forum/cat/link or an existing one
+	if (sizeof($errors))
+	{
+		return $errors;
+	}
+
+	if (!isset($forum_data_sql['forum_id']))
+	{
+		// no forum_id means we're creating a new forum
+		unset($forum_data_sql['type_action']);
+
+		if ($forum_data_sql['parent_id'])
+		{
+			$sql = 'SELECT left_id, right_id
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $forum_data_sql['parent_id'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$row)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['PARENT_NOT_EXIST'] . adm_back_link(u_action . '&amp;' . $parent_id));
+			}
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+				SET left_id = left_id + 2, right_id = right_id + 2
+				WHERE left_id &gt; ' . $row['right_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+				SET right_id = right_id + 2
+				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
+			$_CLASS['core_db']-&gt;query($sql);
+
+			$forum_data_sql['left_id'] = $row['right_id'];
+			$forum_data_sql['right_id'] = $row['right_id'] + 1;
+		}
+		else
+		{
+			$sql = 'SELECT MAX(right_id) AS right_id
+				FROM ' . FORUMS_FORUMS_TABLE;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$forum_data_sql['left_id'] = $row['right_id'] + 1;
+			$forum_data_sql['right_id'] = $row['right_id'] + 2;
+		}
+
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $forum_data_sql, FORUMS_FORUMS_TABLE);
+		$forum_data['forum_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_FORUMS_TABLE, 'forum_id');
+
+		add_log('admin', 'LOG_FORUM_ADD', $forum_data['forum_name']);
+	}
+	else
+	{
+		$row = get_forum_info($forum_data_sql['forum_id']);
+
+		if ($row['forum_type'] == FORUM_POST &amp;&amp; $row['forum_type'] != $forum_data_sql['forum_type'])
+		{
+			// we're turning a postable forum into a non-postable forum
+			if ($forum_data_sql['type_action'] == 'move')
+			{
+				$to_forum_id = request_var('to_forum_id', 0);
+
+				if ($to_forum_id)
+				{
+					$errors = move_forum_content($forum_data_sql['forum_id'], $to_forum_id);
+				}
+				else
+				{
+					return array($_CLASS['core_user']-&gt;lang['NO_DESTINATION_FORUM']);
+				}
+			}
+			else if ($forum_data_sql['type_action'] == 'delete')
+			{
+				$errors = delete_forum_content($forum_data_sql['forum_id']);
+			}
+			else
+			{
+				return array($_CLASS['core_user']-&gt;lang['NO_FORUM_ACTION']);
+			}
+
+			$forum_data_sql['forum_posts'] = $forum_data_sql['forum_topics'] = $forum_data_sql['forum_topics_real'] = 0;
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		if ($row['parent_id'] != $forum_data_sql['parent_id'])
+		{
+			$errors = move_forum($forum_data_sql['forum_id'], $forum_data_sql['parent_id']);
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		unset($forum_data_sql['type_action']);
+
+		if ($row['forum_name'] != $forum_data_sql['forum_name'])
+		{
+			// the forum name has changed, clear the parents list of child forums
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+				SET forum_parents = ''
+				WHERE left_id &gt; &quot; . $row['left_id'] . '
+					AND right_id &lt; ' . $row['right_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
+		// Setting the forum id to the forum id is not really received well by some dbs. ;)
+		$forum_id = $forum_data_sql['forum_id'];
+		unset($forum_data_sql['forum_id']);
+
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
+			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $forum_data_sql) . '
+			WHERE forum_id = ' . $forum_id;
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Add it back
+		$forum_data['forum_id'] = $forum_id;
+
+		add_log('admin', 'LOG_FORUM_EDIT', $forum_data['forum_name']);
+	}
+
+	return $errors;
+}
+
+/**
+* Move forum
+*/
+function move_forum($from_id, $to_id)
+{
+	global $_CLASS;
+
+	$moved_forums = get_forum_branch($from_id, 'children', 'descending');
+	$from_data = $moved_forums[0];
+	$diff = sizeof($moved_forums) * 2;
+
+	$moved_ids = array();
+	for ($i = 0; $i &lt; sizeof($moved_forums); ++$i)
+	{
+		$moved_ids[] = $moved_forums[$i]['forum_id'];
+	}
+
+	// Resync parents
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET right_id = right_id - $diff, forum_parents = ''
+		WHERE left_id &lt; &quot; . $from_data['right_id'] . &quot;
+			AND right_id &gt; &quot; . $from_data['right_id'];
+	$_CLASS['core_db']-&gt;query($sql);
+
+	// Resync righthand side of tree
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET left_id = left_id - $diff, right_id = right_id - $diff, forum_parents = ''
+		WHERE left_id &gt; &quot; . $from_data['right_id'];
+	$_CLASS['core_db']-&gt;query($sql);
+
+	if ($to_id &gt; 0)
+	{
+		$to_data = get_forum_info($to_id);
+
+		// Resync new parents
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+			SET right_id = right_id + $diff, forum_parents = ''
+			WHERE &quot; . $to_data['right_id'] . ' BETWEEN left_id AND right_id
+				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Resync the righthand side of the tree
+		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+			SET left_id = left_id + $diff, right_id = right_id + $diff, forum_parents = ''
+			WHERE left_id &gt; &quot; . $to_data['right_id'] . '
+				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+
+		// Resync moved branch
+		$to_data['right_id'] += $diff;
+
+		if ($to_data['right_id'] &gt; $from_data['right_id'])
+		{
+			$diff = '+ ' . ($to_data['right_id'] - $from_data['right_id'] - 1);
+		}
+		else
+		{
+			$diff = '- ' . abs($to_data['right_id'] - $from_data['right_id'] - 1);
+		}
+	}
+	else
+	{
+		$sql = 'SELECT MAX(right_id) AS right_id
+			FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		$diff = '+ ' . ($row['right_id'] - $from_data['left_id'] + 1);
+	}
+
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET left_id = left_id $diff, right_id = right_id $diff, forum_parents = ''
+		WHERE forum_id IN (&quot; . implode(', ', $moved_ids) . ')';
+	$_CLASS['core_db']-&gt;query($sql);
+}
+
+/**
+* Move forum content from one to another forum
+*/
+function move_forum_content($from_id, $to_id, $sync = true)
+{
+	global $_CLASS;
+
+	$table_ary = array(ACL_GROUPS_TABLE, ACL_USERS_TABLE, LOG_TABLE, POSTS_TABLE, TOPICS_TABLE, DRAFTS_TABLE, TOPICS_TRACK_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$sql = &quot;UPDATE $table
+			SET forum_id = $to_id
+			WHERE forum_id = $from_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	unset($table_ary);
+
+	$table_ary = array(FORUMS_ACCESS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, MODERATOR_CACHE_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$sql = &quot;DELETE FROM $table
+			WHERE forum_id = $from_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	if ($sync)
+	{
+		// Delete ghost topics that link back to the same forum then resync counters
+		sync('topic_moved');
+		sync('forum', 'forum_id', $to_id);
+	}
+
+	return array();
+}
+
+/**
+* Remove complete forum
+*/
+function delete_forum($forum_id, $action_posts = 'delete', $action_subforums = 'delete', $posts_to_id = 0, $subforums_to_id = 0)
+{
+	global $_CLASS;
+
+	$forum_data = get_forum_info($forum_id);
+
+	$errors = array();
+	$log_action_posts = $log_action_forums = $posts_to_name = $subforums_to_name = '';
+	$forum_ids = array($forum_id);
+
+	if ($action_posts == 'delete')
+	{
+		$log_action_posts = 'POSTS';
+		$errors = array_merge($errors, delete_forum_content($forum_id));
+	}
+	else if ($action_posts == 'move')
+	{
+		if (!$posts_to_id)
+		{
+			$errors[] = $_CLASS['core_user']-&gt;lang['NO_DESTINATION_FORUM'];
+		}
+		else
+		{
+			$log_action_posts = 'MOVE_POSTS';
+
+			$sql = 'SELECT forum_name 
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $posts_to_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$row)
+			{
+				$errors[] = $_CLASS['core_user']-&gt;lang['NO_FORUM'];
+			}
+			else
+			{
+				$posts_to_name = $row['forum_name'];
+				$errors = array_merge($errors, move_forum_content($forum_id, $posts_to_id));
+			}
+		}
+	}
+
+	if (sizeof($errors))
+	{
+		return $errors;
+	}
+
+	if ($action_subforums == 'delete')
+	{
+		$log_action_forums = 'FORUMS';
+		$rows = get_forum_branch($forum_id, 'children', 'descending', false);
+
+		foreach ($rows as $row)
+		{
+			$forum_ids[] = $row['forum_id'];
+			$errors = array_merge($errors, delete_forum_content($row['forum_id']));
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+
+		$diff = sizeof($forum_ids) * 2;
+
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . '
+			WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	else if ($action_subforums == 'move')
+	{
+		if (!$subforums_to_id)
+		{
+			$errors[] = $_CLASS['core_user']-&gt;lang['NO_DESTINATION_FORUM'];
+		}
+		else
+		{
+			$log_action_forums = 'MOVE_FORUMS';
+
+			$sql = 'SELECT forum_name 
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE forum_id = ' . $subforums_to_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$row)
+			{
+				$errors[] = $_CLASS['core_user']-&gt;lang['NO_FORUM'];
+			}
+			else
+			{
+				$subforums_to_name = $row['forum_name'];
+
+				$sql = 'SELECT forum_id
+					FROM ' . FORUMS_FORUMS_TABLE . &quot;
+					WHERE parent_id = $forum_id&quot;;
+				$result = $_CLASS['core_db']-&gt;query($sql);
+
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					move_forum($row['forum_id'], $subforums_to_id);
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+
+				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+					SET parent_id = $subforums_to_id
+					WHERE parent_id = $forum_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
+
+				$diff = 2;
+				$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . &quot;
+					WHERE forum_id = $forum_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+		}
+
+		if (sizeof($errors))
+		{
+			return $errors;
+		}
+	}
+	else
+	{
+		$diff = 2;
+		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . &quot;
+			WHERE forum_id = $forum_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Resync tree
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET right_id = right_id - $diff
+		WHERE left_id &lt; {$forum_data['right_id']} AND right_id &gt; {$forum_data['right_id']}&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET left_id = left_id - $diff, right_id = right_id - $diff
+		WHERE left_id &gt; {$forum_data['right_id']}&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	// Delete forum ids from extension groups table
+	$sql = 'SELECT group_id, allowed_forums 
+		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		if (!$row['allowed_forums'])
+		{
+			continue;
+		}
+
+		$allowed_forums = unserialize(trim($row['allowed_forums']));
+		$allowed_forums = array_diff($allowed_forums, $forum_ids);
+
+		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot; 
+			SET allowed_forums = '&quot; . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . &quot;'
+			WHERE group_id = {$row['group_id']}&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	$_CLASS['core_cache']-&gt;destroy('_extensions');
+
+	$log_action = implode('_', array($log_action_posts, $log_action_forums));
+
+	switch ($log_action)
+	{
+		case 'MOVE_POSTS_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'MOVE_POSTS_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case '_MOVE_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'MOVE_POSTS_':
+			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_data['forum_name']);
+		break;
+
+		case '_FORUMS':
+			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_data['forum_name']);
+		break;
+
+		case 'POSTS_':
+			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_data['forum_name']);
+		break;
+
+		default:
+			add_log('admin', 'LOG_FORUM_DEL_FORUM', $forum_data['forum_name']);
+		break;
+	}
+
+	return $errors;
+}
+
+/**
+* Delete forum content
+*/
+function delete_forum_content($forum_id)
+{
+	global $_CLASS;
+
+	require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+
+	$_CLASS['core_db']-&gt;transaction();
+
+	// Select then delete all attachments
+	$sql = 'SELECT a.topic_id
+		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_ATTACHMENTS_TABLE . &quot; a
+		WHERE p.forum_id = $forum_id
+			AND a.in_message = 0
+			AND a.topic_id = p.topic_id&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);	
+
+	$topic_ids = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$topic_ids[] = $row['topic_id'];
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	delete_attachments('topic', $topic_ids, false);
+
+	switch ($_CLASS['core_db']-&gt;db_layer)
+	{
+		case 'mysql4':
+		case 'mysqli':
+
+			// Delete everything else and thank MySQL for offering multi-table deletion
+			$tables_ary = array(
+				FORUMS_SEARCH_WORDMATCH_TABLE	=&gt; 'post_id',
+				FORUMS_REPORTS_TABLE			=&gt; 'post_id',
+				//WARNINGS_TABLE			=&gt; 'post_id',
+				FORUMS_BOOKMARKS_TABLE			=&gt; 'topic_id',
+				FORUMS_WATCH_TABLE			=&gt; 'topic_id',
+				//TOPICS_POSTED_TABLE		=&gt; 'topic_id',
+				FORUMS_POLL_OPTIONS_TABLE	=&gt; 'topic_id',
+				FORUMS_POLL_VOTES_TABLE		=&gt; 'topic_id',
+			);
+
+			$sql = 'DELETE ' . FORUMS_POSTS_TABLE;
+			$sql_using = &quot;\nFROM &quot; . FORUMS_POSTS_TABLE;
+			$sql_where = &quot;\nWHERE &quot; . FORUMS_POSTS_TABLE . &quot;.forum_id = $forum_id\n&quot;;
+
+			foreach ($tables_ary as $table =&gt; $field)
+			{
+				$sql .= &quot;, $table &quot;;
+				$sql_using .= &quot;, $table &quot;;
+				$sql_where .= &quot;\nAND $table.$field = &quot; . POSTS_TABLE . &quot;.$field&quot;;
+			}
+
+			$_CLASS['core_db']-&gt;query($sql . $sql_using . $sql_where);
+
+		break;
+
+		default:
+		
+			// Delete everything else and curse your DB for not offering multi-table deletion
+			$tables_ary = array(
+				'post_id'	=&gt;	array(
+					FORUMS_SEARCH_WORDMATCH_TABLE,
+					FORUMS_REPORTS_TABLE,
+					//WARNINGS_TABLE,
+				),
+
+				'topic_id'	=&gt;	array(
+					FORUMS_BOOKMARKS_TABLE,
+					FORUMS_WATCH_TABLE,
+					//TOPICS_POSTED_TABLE,
+					FORUMS_POLL_OPTIONS_TABLE,
+					FORUMS_POLL_VOTES_TABLE,
+				)
+			);
+
+			foreach ($tables_ary as $field =&gt; $tables)
+			{
+				$start = 0;
+
+				do
+				{
+					$sql = &quot;SELECT $field
+						FROM &quot; . FORUMS_POSTS_TABLE . '
+						WHERE forum_id = ' . $forum_id;
+					$result = $_CLASS['core_db']-&gt;query_limit($sql, 500, $start);
+
+					$ids = array();
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					{
+						$ids[] = $row[$field];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
+
+					if (sizeof($ids))
+					{
+						$start += sizeof($ids);
+
+						foreach ($tables as $table)
+						{
+							$_CLASS['core_db']-&gt;query(&quot;DELETE FROM $table WHERE $field IN (&quot; . implode(', ', $id_list) . ')');
+						}
+					}
+				}
+				while ($row);
+			}
+			unset($ids, $id_list);
+
+		break;
+	}
+
+	$table_ary = array(FORUMS_ACL_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE, FORUMS_MODERATOR_CACHE_TABLE, FORUMS_POSTS_TABLE, FORUMS_TOPICS_TABLE);//, TOPICS_TRACK_TABLE
+
+	foreach ($table_ary as $table)
+	{
+		$_CLASS['core_db']-&gt;query(&quot;DELETE FROM $table WHERE forum_id = $forum_id&quot;);
+	}
+
+	// Set forum ids to 0
+	$table_ary = array(FORUMS_DRAFTS_TABLE);
+
+	foreach ($table_ary as $table)
+	{
+		$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET forum_id = 0 WHERE forum_id = $forum_id&quot;);
+	}
+
+	$_CLASS['core_db']-&gt;transaction('commit');
+
+	// Make sure the overall post/topic count is correct...
+	$sql = 'SELECT COUNT(post_id) AS stat 
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE post_approved = 1';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	set_config('num_posts', (int) $row['stat'], true);
+
+	$sql = 'SELECT COUNT(topic_id) AS stat
+		FROM ' . FORUMS_TOPICS_TABLE . '
+		WHERE topic_approved = 1';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	set_config('num_topics', (int) $row['stat'], true);
+
+	$sql = 'SELECT COUNT(attach_id) as stat
+		FROM ' . FORUMS_ATTACHMENTS_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	set_config('num_files', (int) $row['stat'], true);
+
+	$sql = 'SELECT SUM(filesize) as stat
+		FROM ' . FORUMS_ATTACHMENTS_TABLE;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	set_config('upload_dir_size', (int) $row['stat'], true);
+
+	add_log('admin', 'LOG_RESYNC_STATS');
+
+	return array();
+}
+
+/**
+* Move forum position by $steps up/down
+*/
+function move_forum_by($forum_row, $action = 'move_up', $steps = 1)
+{
+	global $_CLASS;
+
+	/**
+	* Fetch all the siblings between the module's current spot
+	* and where we want to move it to. If there are less than $steps
+	* siblings between the current spot and the target then the
+	* module will move as far as possible
+	*/
+	$sql = 'SELECT forum_id, forum_name, left_id, right_id
+		FROM ' . FORUMS_FORUMS_TABLE . &quot;
+		WHERE parent_id = {$forum_row['parent_id']}
+			AND &quot; . (($action == 'move_up') ? &quot;right_id &lt; {$forum_row['right_id']} ORDER BY right_id DESC&quot; : &quot;left_id &gt; {$forum_row['left_id']} ORDER BY left_id ASC&quot;);
+	$result = $_CLASS['core_db']-&gt;query_limit($sql, $steps);
+
+	$target = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$target = $row;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if (!sizeof($target))
+	{
+		// The forum is already on top or bottom
+		return false;
+	}
+
+	/**
+	* $left_id and $right_id define the scope of the nodes that are affected by the move.
+	* $diff_up and $diff_down are the values to substract or add to each node's left_id
+	* and right_id in order to move them up or down.
+	* $move_up_left and $move_up_right define the scope of the nodes that are moving
+	* up. Other nodes in the scope of ($left_id, $right_id) are considered to move down.
+	*/
+	if ($action == 'move_up')
+	{
+		$left_id = $target['left_id'];
+		$right_id = $forum_row['right_id'];
+
+		$diff_up = $forum_row['left_id'] - $target['left_id'];
+		$diff_down = $forum_row['right_id'] + 1 - $forum_row['left_id'];
+
+		$move_up_left = $forum_row['left_id'];
+		$move_up_right = $forum_row['right_id'];
+	}
+	else
+	{
+		$left_id = $forum_row['left_id'];
+		$right_id = $target['right_id'];
+
+		$diff_up = $forum_row['right_id'] + 1 - $forum_row['left_id'];
+		$diff_down = $target['right_id'] - $forum_row['right_id'];
+
+		$move_up_left = $forum_row['right_id'] + 1;
+		$move_up_right = $target['right_id'];
+	}
+
+	// Now do the dirty job
+	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+		SET left_id = left_id + CASE
+			WHEN left_id BETWEEN {$move_up_left} AND {$move_up_right} THEN -{$diff_up}
+			ELSE {$diff_down}
+		END,
+		right_id = right_id + CASE
+			WHEN right_id BETWEEN {$move_up_left} AND {$move_up_right} THEN -{$diff_up}
+			ELSE {$diff_down}
+		END,
+		forum_parents = ''
+		WHERE 
+			left_id BETWEEN {$left_id} AND {$right_id}
+			AND right_id BETWEEN {$left_id} AND {$right_id}&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+
+	return $target['forum_name'];
+}
 
-			if ($parent_id)
-			{
-				$temp_forum_desc = $forum_desc;
-				$temp_forum_name = $forum_name;
-				$temp_forum_rules = $forum_rules;
-				$temp_forum_rules_link = $forum_rules_link;
-				$temp_forum_type = $forum_type;
-
-				extract(get_forum_info($parent_id));
-				$forum_type = $temp_forum_type;
-				$forum_name = $temp_forum_name;
-				$forum_desc = $temp_forum_desc;
-				$forum_rules = $temp_forum_rules;
-				$forum_rules_link = $temp_forum_rules_link;
-				$forum_password_confirm = $forum_password;
-			}
-		}
-
-		if ($forum_rules)
-		{
-			require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
-			require_once(SITE_FILE_ROOT.'includes/forums/message_parser.php');
-			
-			$message_parser = new parse_message($forum_rules);
-			if (isset($forum_rules_bbcode_uid))
-			{
-				$message_parser-&gt;bbcode_uid = $forum_rules_bbcode_uid;
-				$message_parser-&gt;bbcode_bitfield = $forum_rules_bbcode_bitfield;
-			}
-			else
-			{
-				$message_parser-&gt;parse(false, ($forum_rules_flags &amp; 1), ($forum_rules_flags &amp; 4), ($forum_rules_flags &amp; 2));
-			}
-		}
-		
-		$forum_type_options = '';
-		$forum_type_ary = array(FORUM_CAT =&gt; 'CAT', FORUM_POST =&gt; 'FORUM', FORUM_LINK =&gt; 'LINK');
-		foreach ($forum_type_ary as $value =&gt; $lang)
-		{
-			$forum_type_options .= '&lt;option value=&quot;' . $value . '&quot;' . (($value == $forum_type) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['TYPE_' . $lang] . '&lt;/option&gt;';
-		}
-
-		$statuslist = '&lt;option value=&quot;' . ITEM_UNLOCKED . '&quot;' . (($forum_status == ITEM_UNLOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['UNLOCKED'] . '&lt;/option&gt;&lt;option value=&quot;' . ITEM_LOCKED . '&quot;' . (($forum_status == ITEM_LOCKED) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $_CLASS['core_user']-&gt;lang['LOCKED'] . '&lt;/option&gt;';
-
-		$enable_icons = isset($enable_icons) ? $enable_icons : 0;
-		$enable_indexing = isset($enable_indexing) ? $enable_indexing : 0;
-		$enable_prune = isset($enable_prune) ? $enable_prune : 0;
-		$display_on_index = isset($display_on_index) ? $display_on_index : 0;
-		$forum_flags = isset($forum_flags) ? $forum_flags : 0;
-		
-		$bbcode_checked = isset($bbcode_checked) ? $bbcode_checked : false;
-		$smilies_checked = isset($smilies_checked) ? $smilies_checked : false;
-		$urls_checked = isset($urls_checked) ? $urls_checked : false;
-		
-		$old_forum_type = isset($old_forum_type) ? $old_forum_type : '';
-		$forum_image = isset($forum_image) ? $forum_image : '';
-		$prune_freq = isset($prune_freq) ? $prune_freq : '';
-		$prune_days = isset($prune_days) ? $prune_days : '';
-		$prune_viewed = isset($prune_viewed) ? $prune_viewed : '';
-		$forum_link = isset($forum_link) ? $forum_link : '';
-		
-		$forum_topics_per_page = isset($topics_per_page) ? $topics_per_page : '';
-
-		$indexing_yes = ($enable_indexing) ? ' checked=&quot;checked&quot;' : '';
-		$indexing_no = (!$enable_indexing) ? ' checked=&quot;checked&quot;' : '';
-		$topic_icons_yes = ($enable_icons) ? ' checked=&quot;checked&quot;' : '';
-		$topic_icons_no = (!$enable_icons) ? ' checked=&quot;checked&quot;' : '';
-		$display_index_yes = ($display_on_index) ? ' checked=&quot;checked&quot;' : '';
-		$display_index_no = (!$display_on_index) ? ' checked=&quot;checked&quot;' : '';
-
-		$prune_enable_yes = ($enable_prune) ? ' checked=&quot;checked&quot;' : '';
-		$prune_enable_no = (!$enable_prune) ? ' checked=&quot;checked&quot;' : '';
-		$prune_old_polls_yes = ($forum_flags &amp; 2) ? ' checked=&quot;checked&quot;' : '';
-		$prune_old_polls_no = (!($forum_flags &amp; 2)) ? ' checked=&quot;checked&quot;' : '';
-		$prune_announce_yes = ($forum_flags &amp; 4) ? ' checked=&quot;checked&quot;' : '';
-		$prune_announce_no = (!($forum_flags &amp; 4)) ? ' checked=&quot;checked&quot;' : '';
-		$prune_sticky_yes = ($forum_flags &amp; 8) ? ' checked=&quot;checked&quot;' : '';
-		$prune_sticky_no = (!($forum_flags &amp; 8)) ? ' checked=&quot;checked&quot;' : '';
-
-		$forum_link_track_yes = ($forum_flags &amp; 1) ? ' checked=&quot;checked&quot;' : '';
-		$forum_link_track_no = (!($forum_flags &amp; 1)) ? ' checked=&quot;checked&quot;' : '';
-
-		$navigation = '&lt;a href=&quot;'.generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['FORUM_INDEX'] . '&lt;/a&gt;';
-
-		$forums_nav = get_forum_branch($forum_id, 'parents', 'descending');
-		foreach ($forums_nav as $row)
-		{
-			$navigation .= ($row['forum_id'] == $forum_id) ? ' -&gt; ' . $row['forum_name'] : ' -&gt; &lt;a href=&quot;'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;' . $row['forum_name'] . '&lt;/a&gt;';
-		}
-
-		adm_page_header($l_title);
-
-?&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_ADMIN_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-&lt;h1&gt;&lt;?php echo $l_title ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_EDIT_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;edit&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_forums&amp;mode='.$mode . (($forum_id) ? &quot;&amp;f=$forum_id&quot; : ''), array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;nav&quot;&gt;&lt;?php echo $navigation ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_SETTINGS'] ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		if (!empty($errors))
-		{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row3&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;span style=&quot;color:red&quot;&gt;&lt;?php echo implode('&lt;br /&gt;', $errors); ?&gt;&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;33%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_TYPE'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;forum_type&quot; onchange=&quot;this.form.submit();&quot;&gt;&lt;?php echo $forum_type_options; ?&gt;&lt;/select&gt;&lt;?php
-	
-		if ($old_forum_type == FORUM_POST &amp;&amp; $forum_type != FORUM_POST)
-		{
-			// Forum type being changed to a non-postable type, let the user decide between
-			// deleting all posts or moving them to another forum (if applicable)
-
-?&gt;&lt;br /&gt;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL_POSTS'];
-?&gt;&nbsp;&lt;input type=&quot;radio&quot; name=&quot;action&quot; value=&quot;move&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_POSTS_TO'] ?&gt; &lt;select name=&quot;to_forum_id&quot;&gt;&lt;?php echo $forums_list ?&gt;&lt;/select&gt;&lt;?php
-
-		}
-
-?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		if ($forum_type == FORUM_POST)
-		{
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_STATUS'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;forum_status&quot;&gt;&lt;?php echo $statuslist ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-		}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;40%&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PARENT'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;parent_id&quot;&gt;&lt;option value=&quot;0&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO_PARENT'] ?&gt;&lt;/option&gt;&lt;?php echo $parents_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		if ($forum_type == FORUM_LINK)
-		{
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;40&quot; name=&quot;forum_link&quot; value=&quot;&lt;?php echo $forum_link; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK_TRACK'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_LINK_TRACK_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;1&quot;&lt;?php echo $forum_link_track_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;0&quot;&lt;?php echo $forum_link_track_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-		}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_NAME']; ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;40&quot; name=&quot;forum_name&quot; value=&quot;&lt;?php echo $forum_name ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_DESC'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_DESC_EXPLAIN']; ?&gt;&lt;/span&gt; &lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; rows=&quot;5&quot; cols=&quot;45&quot; wrap=&quot;virtual&quot; name=&quot;forum_desc&quot;&gt;&lt;?php echo htmlspecialchars(str_replace('&lt;br /&gt;', &quot;\n&quot;, $forum_desc)); ?&gt;&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	if ($forum_type != FORUM_LINK)
-	{
-?&gt;	
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_RULES_LINK']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_RULES_LINK_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;40&quot; name=&quot;forum_rules_link&quot; value=&quot;&lt;?php echo $forum_rules_link ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	if ($forum_rules)
-	{
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_RULES_PREVIEW'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;?php echo $message_parser-&gt;format_display(false, ($forum_rules_flags &amp; 1), ($forum_rules_flags &amp; 4), ($forum_rules_flags &amp; 2), false); ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	}
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_RULES'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_RULES_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;table cellspacing=&quot;2&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;&lt;tr&gt;&lt;td colspan=&quot;6&quot;&gt;&lt;textarea class=&quot;post&quot; rows=&quot;4&quot; cols=&quot;70&quot; name=&quot;forum_rules&quot;&gt;
-&lt;?php 
-		if ($forum_rules)
-		{
-			$message_parser-&gt;decode_message();
-			echo $message_parser-&gt;message;
-		}
-?&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;
-			&lt;td width=&quot;10&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;parse_bbcode&quot;&lt;?php echo $bbcode_checked; ?&gt; /&gt;&lt;/td&gt;&lt;td&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PARSE_BBCODE']; ?&gt;&lt;/td&gt;&lt;td width=&quot;10&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;parse_smilies&quot;&lt;?php echo $smilies_checked; ?&gt; /&gt;&lt;/td&gt;&lt;td&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PARSE_SMILIES']; ?&gt;&lt;/td&gt;&lt;td width=&quot;10&quot;&gt;&lt;input type=&quot;checkbox&quot; name=&quot;parse_urls&quot;&lt;?php echo $urls_checked; ?&gt; /&gt;&lt;/td&gt;&lt;td&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PARSE_URLS']; ?&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
-		&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-	}
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_IMAGE']; ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_IMAGE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; size=&quot;40&quot; name=&quot;forum_image&quot; value=&quot;&lt;?php echo $forum_image ?&gt;&quot; /&gt;&lt;br /&gt;&lt;?php
-	
-		if ($forum_image)
-		{
-			echo '&lt;img src=&quot;' . $forum_image . '&quot; alt=&quot;&quot; /&gt;';
-		}
-		
-?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		if ($forum_type == FORUM_POST)
-		{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ENABLE_INDEXING'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ENABLE_INDEXING_EXPLAIN'] ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;enable_indexing&quot; value=&quot;1&quot;&lt;?php echo $indexing_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;enable_indexing&quot; value=&quot;0&quot;&lt;?php echo $indexing_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ENABLE_TOPIC_ICONS'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;enable_icons&quot; value=&quot;1&quot;&lt;?php echo $topic_icons_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;enable_icons&quot; value=&quot;0&quot;&lt;?php echo $topic_icons_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-			if ($mode == 'edit' &amp;&amp; $parent_id &gt; 0)
-			{
-				// if this forum is a subforum put the &quot;display on index&quot; checkbox
-				if ($parent_info = get_forum_info($parent_id))
-				{
-					if ($parent_info['parent_id'] &gt; 0 || $parent_info['forum_type'] == FORUM_CAT)
-					{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LIST_INDEX'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['LIST_INDEX_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;display_on_index&quot; value=&quot;1&quot;&lt;?php echo $display_index_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;display_on_index&quot; value=&quot;0&quot;&lt;?php echo $display_index_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-					}
-				}
-			}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_AUTO_PRUNE'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_AUTO_PRUNE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;enable_prune&quot; value=&quot;1&quot;&lt;?php echo $prune_enable_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;enable_prune&quot; value=&quot;0&quot;&lt;?php echo $prune_enable_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_FREQ'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_FREQ_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;prune_freq&quot; value=&quot;&lt;?php echo $prune_freq ?&gt;&quot; size=&quot;5&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DAYS']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_DAYS'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_DAYS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;prune_days&quot; value=&quot;&lt;?php echo $prune_days ?&gt;&quot; size=&quot;5&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DAYS']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_VIEWED'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['AUTO_PRUNE_VIEWED_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;prune_viewed&quot; value=&quot;&lt;?php echo $prune_viewed ?&gt;&quot; size=&quot;5&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DAYS']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_OLD_POLLS'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_OLD_POLLS_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;1&quot;&lt;?php echo $prune_old_polls_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;0&quot;&lt;?php echo $prune_old_polls_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_ANNOUNCEMENTS'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;1&quot;&lt;?php echo $prune_announce_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;0&quot;&lt;?php echo $prune_announce_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['PRUNE_STICKY'] ?&gt;: &lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;1&quot;&lt;?php echo $prune_sticky_yes; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt; &nbsp; &lt;input type=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;0&quot;&lt;?php echo $prune_sticky_no; ?&gt; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_TOPICS_PAGE'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_TOPICS_PAGE_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;topics_per_page&quot; value=&quot;&lt;?php echo $forum_topics_per_page; ?&gt;&quot; size=&quot;3&quot; maxlength=&quot;3&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;password&quot; name=&quot;forum_password&quot; value=&quot;&lt;?php echo $forum_password; ?&gt;&quot; size=&quot;25&quot; maxlength=&quot;25&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD_CONFIRM'] ?&gt;: &lt;/b&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD_CONFIRM_EXPLAIN']; ?&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input class=&quot;post&quot; type=&quot;password&quot; name=&quot;forum_password_confirm&quot; value=&quot;&lt;?php echo $forum_password_confirm; ?&gt;&quot; size=&quot;25&quot; maxlength=&quot;25&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-		}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; name=&quot;update&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT']; ?&gt;&quot; /&gt; &nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;reset&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESET']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;?php
-
-		adm_page_footer();
-		break;
-
-	case 'delete':
-
-		$forum_id = request_var('f', 0);
-
-		adm_page_header($_CLASS['core_user']-&gt;lang['MANAGE']);
-		extract(get_forum_info($forum_id));
-
-		$subforums_id = array();
-		$subforums = get_forum_branch($forum_id, 'children');
-		foreach ($subforums as $row)
-		{
-			$subforums_id[] = $row['forum_id'];
-		}
-
-		$forums_list = make_forum_select($parent_id, $subforums_id);
-		$move_posts_list = make_forum_select($parent_id, $subforums_id);
-
-?&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_ADMIN_EXPLAIN']; ?&gt;&lt;/p&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_DELETE'] ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_DELETE_EXPLAIN'] ?&gt;&lt;/p&gt;
-
-&lt;form action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) ?&gt;&amp;mode=delete&amp;f=&lt;?php echo $forum_id ?&gt;&quot; method=&quot;post&quot;&gt;&lt;table class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_DELETE'] ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_NAME']; ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b&gt;&lt;?php echo $forum_name ?&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	if ($forum_type == FORUM_POST)
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION'] ?&gt;: &lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;action_posts&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_ALL_POSTS'] ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			$sql = 'SELECT forum_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_type = ' . FORUM_POST . &quot;
-					AND forum_id &lt;&gt; $forum_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if ($_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-
-?&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;action_posts&quot; value=&quot;move&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_POSTS_TO'] ?&gt; &lt;select name=&quot;posts_to_id&quot; ?&gt;&lt;?php echo $move_posts_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-&lt;?php
-
-			}
-
-?&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-	if ($right_id - $left_id &gt; 1)
-	{
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['ACTION'] ?&gt;:&lt;/td&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;table cellspacing=&quot;0&quot; cellpadding=&quot;2&quot; border=&quot;0&quot;&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;action_subforums&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE_SUBFORUMS'] ?&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-			&lt;tr&gt;
-				&lt;td&gt;&lt;input type=&quot;radio&quot; name=&quot;action_subforums&quot; value=&quot;move&quot; /&gt; &lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_SUBFORUMS_TO'] ?&gt; &lt;select name=&quot;subforums_to_id&quot; ?&gt;&lt;?php echo $forums_list ?&gt;&lt;/select&gt;&lt;/td&gt;
-			&lt;/tr&gt;
-		&lt;/table&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-	}
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;update&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['SUBMIT'] ?&gt;&quot; class=&quot;btnmain&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-
-		adm_page_footer();
-		break;
-
-	case 'move_up':
-	case 'move_down':
-		$sql = 'SELECT parent_id, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . &quot;
-			WHERE forum_id = $forum_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error('NO_FORUM');
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		extract($row);
-		$forum_info = array($forum_id =&gt; $row);
-
-		// Get the adjacent forum
-		$sql = 'SELECT forum_id, forum_name, left_id, right_id
-			FROM ' . FORUMS_FORUMS_TABLE . &quot;
-			WHERE parent_id = $parent_id
-				AND &quot; . (($mode == 'move_up') ? &quot;right_id &lt; $right_id ORDER BY right_id DESC&quot; : &quot;left_id &gt; $left_id ORDER BY left_id ASC&quot;);
-		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			// already on top or at bottom
-			break;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if ($mode == 'move_up')
-		{
-			$log_action = 'LOG_FORUM_MOVE_UP';
-			$up_id = $forum_id;
-			$down_id = $row['forum_id'];
-		}
-		else
-		{
-			$log_action = 'LOG_FORUM_MOVE_DOWN';
-			$up_id = $row['forum_id'];
-			$down_id = $forum_id;
-		}
-
-		$move_forum_name = $row['forum_name'];
-		$forum_info[$row['forum_id']] = $row;
-		$diff_up = $forum_info[$up_id]['right_id'] - $forum_info[$up_id]['left_id'];
-		$diff_down = $forum_info[$down_id]['right_id'] - $forum_info[$down_id]['left_id'];
-
-		$forum_ids = array();
-		$sql = 'SELECT forum_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE left_id &gt; ' . $forum_info[$up_id]['left_id'] . '
-				AND right_id &lt; ' . $forum_info[$up_id]['right_id'];
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$forum_ids[] = $row['forum_id'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		// Start transaction
-		$_CLASS['core_db']-&gt;transaction();
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = left_id + ' . ($diff_up + 1) . ', right_id = right_id + ' . ($diff_up + 1) . '
-			WHERE left_id &gt; ' . $forum_info[$down_id]['left_id'] . '
-				AND right_id &lt; ' . $forum_info[$down_id]['right_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-
-		if (count($forum_ids))
-		{
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id - ' . ($diff_down + 1) . ', right_id = right_id - ' . ($diff_down + 1) . '
-				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . $forum_info[$down_id]['left_id'] . ', right_id = ' . ($forum_info[$down_id]['left_id'] + $diff_up) . '
-			WHERE forum_id = ' . $up_id;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . ($forum_info[$up_id]['right_id'] - $diff_down) . ', right_id = ' . $forum_info[$up_id]['right_id'] . '
-			WHERE forum_id = ' . $down_id;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		$_CLASS['core_db']-&gt;transaction('commit');
-
-		$forum_data = get_forum_info($forum_id);
-
-		add_log('admin', $log_action, $forum_data['forum_name'], $move_forum_name);
-		unset($forum_data);
-		break;
-
-	case 'sync':
-		if (!$forum_id)
-		{
-			trigger_error('NO_FORUM');
-		}
-
-		$sql = &quot;SELECT forum_name
-			FROM &quot; . FORUMS_FORUMS_TABLE . &quot;
-			WHERE forum_id = $forum_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-		{
-			trigger_error($_CLASS['core_user']-&gt;lang['NO_FORUM']);
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		sync('forum', 'forum_id', $forum_id);
-		add_log('admin', 'LOG_FORUM_SYNC', $row['forum_name']);
-
-		break;
-}
-
-// Default management page
-
-if (!$parent_id)
-{
-	$navigation = $_CLASS['core_user']-&gt;lang['FORUM_INDEX'];
-}
-else
-{
-	$navigation = '&lt;a href=&quot;'.generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) . '&quot;&gt;' . $_CLASS['core_user']-&gt;lang['FORUM_INDEX'] . '&lt;/a&gt;';
-
-	$forums_nav = get_forum_branch($parent_id, 'parents', 'descending');
-	foreach ($forums_nav as $row)
-	{
-		if ($row['forum_id'] == $parent_id)
-		{
-			$navigation .= ' -&gt; ' . $row['forum_name'];
-		}
-		else
-		{
-			$navigation .= ' -&gt; &lt;a href=&quot;'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;' . $row['forum_name'] . '&lt;/a&gt;';
-		}
-	}
-}
-
-// Jumpbox
-$forum_box = make_forum_select($parent_id);
-
-// Front end
-adm_page_header($_CLASS['core_user']-&gt;lang['MANAGE']);
-
-?&gt;
-
-&lt;h1&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MANAGE']; ?&gt;&lt;/h1&gt;
-
-&lt;p&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_ADMIN_EXPLAIN']; ?&gt;&lt;/p&gt;&lt;?php
-
-if ($mode == 'sync')
-{
-	echo '&lt;br /&gt;&lt;div class=&quot;gen&quot; align=&quot;center&quot;&gt;&lt;b&gt;' . $_CLASS['core_user']-&gt;lang['FORUM_RESYNCED'] . '&lt;/b&gt;&lt;/div&gt;';
-}
-
-?&gt;&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_forums&amp;parent_id='.$parent_id, array('admin' =&gt; true)) ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;nav&quot;&gt;&lt;?php echo $navigation ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-		
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;6&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['FORUM_ADMIN'] ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-$sql = 'SELECT *
-	FROM ' . FORUMS_FORUMS_TABLE . &quot;
-	WHERE parent_id = $parent_id
-	ORDER BY left_id&quot;;
-$result = $_CLASS['core_db']-&gt;query($sql);
-
-while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-{
-	$forum_type = $row['forum_type'];
-
-	if ($row['forum_status'] == ITEM_LOCKED)
-	{
-		$folder_image = '&lt;img src=&quot;images/modules/forums/adm/images/icon_folder_lock.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['LOCKED'] . '&quot; /&gt;';
-	}
-	else
-	{
-		switch ($forum_type)
-		{
-			case FORUM_LINK:
-				$folder_image = '&lt;img src=&quot;images/modules/forums/adm/images/icon_folder_link.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['LINK'] . '&quot; /&gt;';
-				break;
-
-			default:
-				$folder_image = ($row['left_id'] + 1 != $row['right_id']) ? '&lt;img src=&quot;images/modules/forums/adm/images/icon_subfolder.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['SUBFORUM'] . '&quot; /&gt;' : '&lt;img src=&quot;images/modules/forums/adm/images/icon_folder.gif&quot; width=&quot;46&quot; height=&quot;25&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['FOLDER'] . '&quot; /&gt;';
-		}
-	}
-
-	$forum_title = ($forum_type != FORUM_LINK) ? '&lt;a href=&quot;'.generate_link('forums&amp;file=admin_forums&amp;parent_id=' . $row['forum_id'], array('admin' =&gt; true)) . '&quot;&gt;' : '';
-	$forum_title .= $row['forum_name'];
-	$forum_title .= ($forum_type != FORUM_LINK) ? '&lt;/a&gt;' : '';
-	$url = &quot;forums&amp;file=admin_forums&amp;parent_id=$parent_id&amp;f=&quot; . $row['forum_id'];
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;5%&quot;&gt;&lt;?php echo $folder_image; ?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row1&quot; width=&quot;50%&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-				&lt;tr&gt;
-					&lt;td&gt;&lt;span class=&quot;forumlink&quot;&gt;&lt;?php echo $forum_title ?&gt;&lt;/span&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-			&lt;/table&gt;
-			&lt;table cellspacing=&quot;5&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;gensmall&quot;&gt;&lt;?php echo $row['forum_desc'] ?&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-			&lt;/table&gt;
-&lt;?php
-
-	if ($forum_type == FORUM_POST)
-	{
-
-?&gt;
-			&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot;&gt;
-				&lt;tr&gt;
-					&lt;td class=&quot;gensmall&quot;&gt;&nbsp;&lt;?php echo $_CLASS['core_user']-&gt;lang['TOPICS']; ?&gt;: &lt;b&gt;&lt;?php echo $row['forum_topics'] ?&gt;&lt;/b&gt; / &lt;?php echo $_CLASS['core_user']-&gt;lang['POSTS']; ?&gt;: &lt;b&gt;&lt;?php echo $row['forum_posts'] ?&gt;&lt;/b&gt;&lt;/td&gt;
-				&lt;/tr&gt;
-			&lt;/table&gt;
-&lt;?php
-
-	}
-
-?&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; width=&quot;15%&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&lt;a href=&quot;&lt;?php echo generate_link($url.'&amp;mode=move_up', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_UP'] ?&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;&lt;?php echo generate_link($url.'&amp;mode=move_down', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['MOVE_DOWN'] ?&gt;&lt;/a&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot; width=&quot;20%&quot; align=&quot;center&quot; valign=&quot;middle&quot; nowrap=&quot;nowrap&quot;&gt;&nbsp;&lt;a href=&quot;&lt;?php echo generate_link($url.'&amp;mode=edit', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['EDIT'] ?&gt;&lt;/a&gt; | &lt;a href=&quot;&lt;?php echo generate_link($url.'&amp;mode=delete', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['DELETE'] ?&gt;&lt;/a&gt;&lt;?php
-			
-	if ($forum_type != FORUM_LINK)
-	{
-
-?&gt; | &lt;a href=&quot;&lt;?php echo generate_link($url.'&amp;mode=sync', array('admin' =&gt; true)); ?&gt;&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['RESYNC'] ?&gt;&lt;/a&gt;&lt;?php
-	
-
-	}
-	
-?&gt;&nbsp;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;?php
-
-}
-$_CLASS['core_db']-&gt;free_result($result);
-
-?&gt;
-	&lt;tr&gt;
-		&lt;td width=&quot;100%&quot; colspan=&quot;6&quot; class=&quot;cat&quot;&gt;&lt;input type=&quot;hidden&quot; name=&quot;mode&quot; value=&quot;add&quot; /&gt;&lt;input class=&quot;post&quot; type=&quot;text&quot; name=&quot;forum_name&quot; /&gt; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['CREATE_FORUM'] ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-
-&lt;form method=&quot;post&quot; action=&quot;&lt;?php echo generate_link('forums&amp;file=admin_forums', array('admin' =&gt; true)) ?&gt;&quot;&gt;&lt;table width=&quot;100%&quot; cellpadding=&quot;1&quot; cellspacing=&quot;1&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot;&gt;&lt;?php echo $_CLASS['core_user']-&gt;lang['SELECT_FORUM']; ?&gt;: &lt;select name=&quot;parent_id&quot; onchange=&quot;if(this.options[this.selectedIndex].value != -1){ this.form.submit(); }&quot;&gt;&lt;?php echo $forum_box; ?&gt;&lt;/select&gt; &lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['GO']; ?&gt;&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;sid&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;session_id; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;&lt;/form&gt;
-&lt;?php
-
-adm_page_footer();
-
-//
-// END
-//
-
-
-// ------------------
-// Begin function block
-//
-function get_forum_info($forum_id)
-{
-	global $_CLASS;
-
-	$sql = 'SELECT *
-		FROM ' . FORUMS_FORUMS_TABLE . &quot;
-		WHERE forum_id = $forum_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
-	{
-		trigger_error(&quot;Forum #$forum_id does not exist&quot;, E_USER_ERROR);
-	}
-
-	return $row;
-}
-
-function update_forum_data(&amp;$forum_data)
-{
-	global $_CLASS;
-
-	$errors = array();
-	if (!trim($forum_data['forum_name']))
-	{
-		$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_NAME_EMPTY'];
-	}
-
-	if (!empty($_POST['forum_password']) || !empty($_POST['forum_password_confirm']))
-	{
-		if ($_POST['forum_password'] != $_POST['forum_password_confirm'])
-		{
-			$forum_data['forum_password'] = $forum_data['forum_password_confirm'] = '';
-			$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_PASSWORD_MISMATCH'];
-		}
-	}
-
-	if ($forum_data['prune_days'] &lt; 0 || $forum_data['prune_viewed'] &lt; 0 || $forum_data['prune_freq'] &lt; 0)
-	{
-		$forum_data['prune_days'] = $forum_data['prune_viewed'] = $forum_data['prune_freq'] = 0;
-		$errors[] = $_CLASS['core_user']-&gt;lang['FORUM_DATA_NEGATIVE'];
-	}
-
-	// Set forum flags
-	// 1 = link tracking
-	// 2 = prune old polls
-	// 4 = prune announcements
-	// 8 = prune stickies
-	$forum_data['forum_flags'] = 0;
-	$forum_data['forum_flags'] += ($forum_data['forum_link_track']) ? 1 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_old_polls']) ? 2 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_announce']) ? 4 : 0;
-	$forum_data['forum_flags'] += ($forum_data['prune_sticky']) ? 8 : 0;
-
-	// Unset data that are not database fields
-	unset($forum_data['forum_link_track']);
-	unset($forum_data['prune_old_polls']);
-	unset($forum_data['prune_announce']);
-	unset($forum_data['prune_sticky']);
-	unset($forum_data['forum_password_confirm']);
-
-	// What are we going to do tonight Brain? The same thing we do everynight,
-	// try to take over the world ... or decide whether to continue update
-	// and if so, whether it's a new forum/cat/link or an existing one
-	if (count($errors))
-	{
-		return $errors;
-	}
-
-	if (empty($forum_data['forum_id']))
-	{
-		// no forum_id means we're creating a new forum
-
-		$_CLASS['core_db']-&gt;transaction();
-
-		if ($forum_data['parent_id'])
-		{
-			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $forum_data['parent_id'];
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				trigger_error('Parent does not exist', E_USER_ERROR);
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id + 2, right_id = right_id + 2
-				WHERE left_id &gt; ' . $row['right_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET right_id = right_id + 2
-				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$forum_data['left_id'] = $row['right_id'];
-			$forum_data['right_id'] = $row['right_id'] + 1;
-		}
-		else
-		{
-			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_FORUMS_TABLE;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$forum_data['left_id'] = $row['right_id'] + 1;
-			$forum_data['right_id'] = $row['right_id'] + 2;
-		}
-
-		$sql = 'INSERT INTO ' . FORUMS_FORUMS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $forum_data);
-		$_CLASS['core_db']-&gt;query($sql);
-		
-		$_CLASS['core_db']-&gt;transaction('commit');
-
-		$forum_data['forum_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_FORUMS_TABLE, 'forum_id');
-		add_log('admin', 'LOG_FORUM_ADD', $forum_data['forum_name']);
-	}
-	else
-	{
-		$row = get_forum_info($forum_data['forum_id']);
-
-		if ($forum_data['forum_type'] != FORUM_POST &amp;&amp; $row['forum_type'] != $forum_data['forum_type'])
-		{
-			// we're turning a postable forum into a non-postable forum
-
-			if (empty($forum_data['action']))
-			{
-				// TODO: error message if no action is specified
-
-				return array($_CLASS['core_user']-&gt;lang['']);
-			}
-			elseif ($forum_data['action'] == 'move')
-			{
-				if (!empty($forum_data['to_forum_id']))
-				{
-					$errors = move_forum_content($forum_data['forum_id'], $forum_data['to_forum_id']);				
-				}
-				else
-				{
-					return array($_CLASS['core_user']-&gt;lang['SELECT_DESTINATION_FORUM']);
-				}
-			}
-			elseif ($forum_data['action'] == 'delete')
-			{
-				$errors = delete_forum_content($forum_data['forum_id']);
-			}
-
-			$forum_data['forum_posts'] = 0;
-			$forum_data['forum_topics'] = 0;
-			$forum_data['forum_topics_real'] = 0;
-		}
-
-		if ($row['parent_id'] != $forum_data['parent_id'])
-		{
-			$errors = move_forum($forum_data['forum_id'], $forum_data['parent_id']);
-		}
-		elseif ($row['forum_name'] != $forum_data['forum_name'])
-		{
-			// the forum name has changed, clear the parents list of child forums
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-				SET forum_parents = ''
-				WHERE left_id &gt; &quot; . $row['left_id'] . '
-					AND right_id &lt; ' . $row['right_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET ' . $_CLASS['core_db']-&gt;sql_build_array('UPDATE', $forum_data) . '
-			WHERE forum_id = ' . $forum_data['forum_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-
-		add_log('admin', 'LOG_FORUM_EDIT', $forum_data['forum_name']);
-	}
-}
-
-function move_forum($from_id, $to_id)
-{
-	global $_CLASS;
-
-	$moved_forums = get_forum_branch($from_id, 'children', 'descending');
-	$from_data = $moved_forums[0];
-	$diff = count($moved_forums) * 2;
-
-	$moved_ids = array();
-	for ($i = 0; $i &lt; count($moved_forums); ++$i)
-	{
-		$moved_ids[] = $moved_forums[$i]['forum_id'];
-	}
-
-	// Resync parents
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-		SET right_id = right_id - $diff, forum_parents = ''
-		WHERE left_id &lt; &quot; . $from_data['right_id'] . &quot;
-			AND right_id &gt; &quot; . $from_data['right_id'];
-	$_CLASS['core_db']-&gt;query($sql);
-
-	// Resync righthand side of tree
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-		SET left_id = left_id - $diff, right_id = right_id - $diff, forum_parents = ''
-		WHERE left_id &gt; &quot; . $from_data['right_id'];
-	$_CLASS['core_db']-&gt;query($sql);
-
-	if ($to_id &gt; 0)
-	{
-		$to_data = get_forum_info($to_id);
-
-		// Resync new parents
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-			SET right_id = right_id + $diff, forum_parents = ''
-			WHERE &quot; . $to_data['right_id'] . ' BETWEEN left_id AND right_id
-				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		// Resync the righthand side of the tree
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-			SET left_id = left_id + $diff, right_id = right_id + $diff, forum_parents = ''
-			WHERE left_id &gt; &quot; . $to_data['right_id'] . '
-				AND forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-
-		// Resync moved branch
-		$to_data['right_id'] += $diff;
-		if ($to_data['right_id'] &gt; $from_data['right_id'])
-		{
-			$diff = '+ ' . ($to_data['right_id'] - $from_data['right_id'] - 1);
-		}
-		else
-		{
-			$diff = '- ' . abs($to_data['right_id'] - $from_data['right_id'] - 1);
-		}
-	}
-	else
-	{
-		$sql = 'SELECT MAX(right_id) AS right_id
-			FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE forum_id NOT IN (' . implode(', ', $moved_ids) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		$diff = '+ ' . ($row['right_id'] - $from_data['left_id'] + 1);
-	}
-
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-		SET left_id = left_id $diff, right_id = right_id $diff, forum_parents = ''
-		WHERE forum_id IN (&quot; . implode(', ', $moved_ids) . ')';
-	$_CLASS['core_db']-&gt;query($sql);
-}
-
-function move_forum_content($from_id, $to_id, $sync = TRUE)
-{
-	// TODO: empty tables like forum_tracks or forum_access
-
-	global $_CLASS;
-
-	$table_ary = array(LOG_TABLE, POSTS_TABLE, TOPICS_TABLE);
-	foreach ($table_ary as $table)
-	{
-		$sql = &quot;UPDATE $table
-			SET forum_id = $to_id
-			WHERE forum_id = $from_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	unset($table_ary);
-
-	if ($sync)
-	{
-		// Delete ghost topics that link back to the same forum
-		// then resync counters
-
-		sync('topic_moved');
-		sync('forum', 'forum_id', $to_id);
-	}
-}
-
-function delete_forum($forum_id, $action_posts = 'delete', $action_subforums = 'delete', $posts_to_id = 0, $subforums_to_id = 0)
-{
-	global $_CLASS;
-
-	$row = get_forum_info($forum_id);
-	extract($row);
-
-	$errors = array();
-	$log_action_posts = $log_action_forums = '';
-
-	if ($action_posts == 'delete')
-	{
-		$_CLASS['core_db']-&gt;query('UPDATE '.FORUMS_FORUMS_TABLE.' SET forum_status = '.ITEM_DELETING.' WHERE forum_id = '.$forum_id);
-
-		$log_action_posts = 'POSTS';
-		
-		if ($delete_error = delete_forum_content($forum_id))
-		{
-			$errors[] = $delete_error;
-		}
-	}
-	elseif ($action_posts == 'move')
-	{
-		if (!$posts_to_id)
-		{
-			$errors[] = $_CLASS['core_user']-&gt;lang['NO_DESTINATION_FORUM'];
-		}
-		else
-		{
-			$log_action_posts = 'MOVE_POSTS';
-
-			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $posts_to_id;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$errors[] = $_CLASS['core_user']-&gt;lang['NO_FORUM'];
-			}
-			else
-			{
-				$posts_to_name = $row['forum_name'];
-				unset($row);
-
-				$errors[] = move_forum_content($forum_id, $subforums_to_id);
-			}
-		}
-	}
-
-	if (count($errors))
-	{
-		return $errors;
-	}
-
-	if ($action_subforums == 'delete')
-	{
-		$log_action_forums = 'forums';
-
-		$forum_ids = array($forum_id);
-		$rows = get_forum_branch($forum_id, 'children', 'descending', FALSE);
-
-// Maybe add feild to the get_forum_branch
-		foreach ($rows as $row)
-		{
-			$forum_ids[] = $row['forum_id'];
-		}
-		unset($rows);
-
-		$_CLASS['core_db']-&gt;query('UPDATE '.FORUMS_FORUMS_TABLE.'  SET forum_status = '.ITEM_DELETING.' WHERE forum_id  IN (' . implode(', ', $forum_ids) . ')');
-
-		foreach ($forum_ids as $forum_id)
-		{
-			if ($delete_error = delete_forum_content($forum_id))
-			{
-				$errors[] = $delete_error;
-			}
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-
-		$diff = count($forum_ids) * 2;
-
-		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . '
-			WHERE forum_id IN (' . implode(', ', $forum_ids) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	elseif ($action_subforums == 'move')
-	{
-		if (!$subforums_to_id)
-		{
-			$errors[] = $_CLASS['core_user']-&gt;lang['NO_DESTINATION_FORUM'];
-		}
-		else
-		{
-			$log_action_forums = 'MOVE_FORUMS';
-
-			$sql = 'SELECT forum_name 
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $subforums_to_id;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$errors[] = $_CLASS['core_user']-&gt;lang['NO_FORUM'];
-			}
-			else
-			{
-				$subforums_to_name = $row['forum_name'];
-				unset($row);
-
-				$sql = 'SELECT forum_id
-					FROM ' . FORUMS_FORUMS_TABLE . &quot;
-					WHERE parent_id = $forum_id&quot;;
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					move_forum($row['forum_id'], intval($_POST['subforums_to_id']));
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-					SET parent_id = $subforums_to_id
-					WHERE parent_id = $forum_id&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-
-				$diff = 2;
-				$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . &quot;
-					WHERE forum_id = $forum_id&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-		}
-
-		if (count($errors))
-		{
-			return $errors;
-		}
-	}
-	else
-	{
-		$diff = 2;
-		$sql = 'DELETE FROM ' . FORUMS_FORUMS_TABLE . &quot;
-			WHERE forum_id = $forum_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Resync tree
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-		SET right_id = right_id - $diff
-		WHERE left_id &lt; $right_id AND right_id &gt; $right_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-		SET left_id = left_id - $diff, right_id = right_id - $diff
-		WHERE left_id &gt; $right_id&quot;;
-	$_CLASS['core_db']-&gt;query($sql);
-
-	if (!is_array($forum_ids))
-	{
-		$forum_ids = array($forum_id);
-	}
-
-	// Delete forum ids from extension groups table
-	$sql = 'SELECT group_id, allowed_forums 
-		FROM ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot;
-		WHERE allowed_forums &lt;&gt; ''&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$allowed_forums = unserialize(trim($row['allowed_forums']));
-		$allowed_forums = array_diff($allowed_forums, $forum_ids);
-		$sql = 'UPDATE ' . FORUMS_EXTENSION_GROUPS_TABLE . &quot; 
-			SET allowed_forums = '&quot; . ((sizeof($allowed_forums)) ? serialize($allowed_forums) : '') . &quot;'
-			WHERE group_id = {$row['group_id']}&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	$_CLASS['core_cache']-&gt;destroy('extensions');
-
-	$log_action = implode('_', array($log_action_posts, $log_action_forums));
-
-	switch ($log_action)
-	{
-		case 'MOVE_POSTS_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_MOVE_FORUMS', $posts_to_name, $subforums_to_name, $forum_name);
-		break;
-
-		case 'MOVE_POSTS_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS_FORUMS', $posts_to_name, $forum_name);
-		break;
-
-		case 'POSTS_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS_MOVE_FORUMS', $subforums_to_name, $forum_name);
-		break;
-
-		case '_MOVE_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_FORUMS', $subforums_to_name, $forum_name);
-		break;
-
-		case 'MOVE_POSTS_':
-			add_log('admin', 'LOG_FORUM_DEL_MOVE_POSTS', $posts_to_name, $forum_name);
-			break;
-		case 'POSTS_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS_FORUMS', $forum_name);
-		break;
-
-		case '_FORUMS':
-			add_log('admin', 'LOG_FORUM_DEL_FORUMS', $forum_name);
-		break;
-
-		case 'POSTS_':
-			add_log('admin', 'LOG_FORUM_DEL_POSTS', $forum_name);
-		break; 
-	}
-
-	return $errors;
-}
-
-function delete_forum_content($forum_id)
-{
-	global $_CLASS;
-	require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
-
-	$_CLASS['core_db']-&gt;transaction();
-
-	switch ($_CLASS['core_db']-&gt;db_layer)
-	{
-// Needs updating and testing
-/*		case 'mysql':
-		case 'mysqli':
-			// Select then delete all attachments
-			$sql = 'SELECT a.topic_id
-				FROM ' . POSTS_TABLE . ' p, ' . ATTACHMENTS_TABLE . &quot; a
-				WHERE p.forum_id = $forum_id
-					AND a.in_message = 0
-					AND a.topic_id = p.topic_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);	
-		
-			$topic_ids = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$topic_ids[] = $row['topic_id'];
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-			
-			delete_attachments('topic', $topic_ids, false);
-
-			// Delete everything else and thank MySQL for offering multi-table deletion
-			$tables_ary = array(
-				BOOKMARKS_TABLE 	=&gt; 'bm.topic_id',
-				SEARCH_MATCH_TABLE	=&gt; 'wm.post_id',
-				REPORTS_TABLE		=&gt; 're.post_id',
-				TOPICS_WATCH_TABLE	=&gt; 'tw.topic_id',
-				TOPICS_TRACK_TABLE	=&gt; 'tt.topic_id',
-				POLL_OPTIONS_TABLE	=&gt; 'po.topic_id',
-				POLL_VOTES_TABLE	=&gt; 'pv.topic_id'
-			);
-
-			$sql = 'DELETE QUICK FROM ' . POSTS_TABLE;
-			$sql_using = &quot;\nUSING &quot; . POSTS_TABLE . ' p';
-			$sql_where = &quot;\nWHERE p.forum_id = $forum_id\n&quot;;
-			$sql_optimise = 'OPTIMIZE TABLE . ' . POSTS_TABLE;
-
-			foreach ($tables_ary as $table =&gt; $field)
-			{
-				$sql .= &quot;, $table&quot;;
-				$sql_using .= &quot;, $table &quot; . strtok($field, '.');
-				$sql_where .= &quot;\nAND $field = p.&quot; . strtok('');
-				$sql_optimise .= ', ' . $table;
-			}
-
-			$_CLASS['core_db']-&gt;query($sql . $sql_using . $sql_where);
-
-			$tables_ary = array(FORUMS_ACCESS_TABLE, TOPICS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, ACL_GROUPS_TABLE, ACL_USERS_TABLE, MODERATOR_TABLE, LOG_TABLE);
-			foreach ($tables_ary as $table)
-			{
-				$_CLASS['core_db']-&gt;query(&quot;DELETE QUICK FROM $table WHERE forum_id = $forum_id&quot;);
-				$sql_optimise .= ', ' . $table;
-			}
-
-			// Now optimise a hell lot of tables
-			$_CLASS['core_db']-&gt;query($sql_optimise);
-		break;
-*/
-		default:
-			// Select then delete all attachments
-			$sql = 'SELECT a.attach_id, a.physical_filename, a.thumbnail
-				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_ATTACHMENTS_TABLE . &quot; a
-				WHERE p.forum_id = $forum_id
-					AND a.in_message = 0
-					AND a.post_msg_id = p.post_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);	
-
-			$attach_ids = array();
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$attach_ids[] = $row['attach_id'];
-
-				phpbb_unlink($row['physical_filename'], 'file');
-
-				if ($row['thumbnail'])
-				{
-					phpbb_unlink($row['physical_filename'], 'thumbnail');
-				}
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			if (count($attach_ids))
-			{
-				$attach_id_list = implode(',', array_unique($attach_ids));
-				$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . &quot; WHERE attach_id IN ($attach_id_list)&quot;);
-				unset($attach_ids, $attach_id_list);
-			}
-
-			// Delete everything else and curse your DB for not offering multi-table deletion
-			$tables_ary = array(
-				'post_id'	=&gt;	array(
-					FORUMS_SEARCH_MATCH_TABLE,
-					FORUMS_REPORTS_TABLE,
-				),
-				
-				'topic_id'	=&gt;	array(
-					FORUMS_BOOKMARKS_TABLE,
-					FORUMS_WATCH_TABLE,
-					FORUMS_TRACK_TABLE,
-					FORUMS_POLL_OPTIONS_TABLE,
-					FORUMS_POLL_VOTES_TABLE
-				)
-			);
-
-			foreach ($tables_ary as $field =&gt; $tables)
-			{
-				$start = 0;
-				$id_array = array();
-
-				$sql = &quot;SELECT $field
-					FROM &quot; . FORUMS_POSTS_TABLE . '
-					WHERE forum_id = ' . $forum_id;
-				$result = $_CLASS['core_db']-&gt;query($sql);
-
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$id_array[] = $row[$field];
-				}
-				$_CLASS['core_db']-&gt;free_result($result);
-
-				if (empty($id_array))
-				{
-					continue;
-				}
-
-				foreach ($tables as $table)
-				{
-					$_CLASS['core_db']-&gt;query(&quot;DELETE FROM $table WHERE $field IN (&quot;.implode(',', $id_array).')');
-				}
-			}
-			unset($id_array);
-
-			$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_TOPICS_TABLE, FORUMS_ACL_TABLE, FORUMS_MODERATOR_TABLE, FORUMS_LOG_TABLE);
-
-			foreach ($table_ary as $table)
-			{
-				$_CLASS['core_db']-&gt;query(&quot;DELETE FROM $table WHERE forum_id = $forum_id&quot;);
-			}
-		break;
-	}
-
-	$_CLASS['core_db']-&gt;transaction('commit');
-	
-	// NEED to have this done at the end, maybe a cran
-	$tables = array_unique(array_merge($tables_ary['post_id'], $tables_ary['topic_id'], $table_ary, array(FORUMS_ATTACHMENTS_TABLE)));
-	$_CLASS['core_db']-&gt;optimize_tables($tables);
-}
-
-function recalc_btree()
-{
-	global $_CLASS;
-
-	$sql = 'SELECT forum_id, parent_id, left_id, right_id 
-		FROM ' . FORUMS_FORUMS_TABLE . '
-		ORDER BY parent_id ASC';
-	$f_result = $_CLASS['core_db']-&gt;query($sql);
-
-	while ($forum_data = $_CLASS['core_db']-&gt;fetch_row_assoc($f_result))
-	{
-		if ($forum_data['parent_id'])
-		{
-			$sql = 'SELECT left_id, right_id
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE forum_id = ' . $forum_data['parent_id'];
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . ' SET parent_id = 0 WHERE forum_id = ' . $forum_data['forum_id'];
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET left_id = left_id + 2, right_id = right_id + 2
-				WHERE left_id &gt; ' . $row['right_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-				SET right_id = right_id + 2
-				WHERE ' . $row['left_id'] . ' BETWEEN left_id AND right_id';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			$forum_data['left_id'] = $row['right_id'];
-			$forum_data['right_id'] = $row['right_id'] + 1;
-		}
-		else
-		{
-			$sql = 'SELECT MAX(right_id) AS right_id
-				FROM ' . FORUMS_FORUMS_TABLE;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$forum_data['left_id'] = $row['right_id'] + 1;
-			$forum_data['right_id'] = $row['right_id'] + 2;
-		}
-	
-		$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . '
-			SET left_id = ' . $forum_data['left_id'] . ', right_id = ' . $forum_data['right_id'] . '
-			WHERE forum_id = ' . $forum_data['forum_id'];
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-	$_CLASS['core_db']-&gt;free_result($f_result);
-}
-
-//
-// End function block
-// ------------------
-
 ?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/index.php
===================================================================
--- cms/trunk/includes/forums/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/index.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,388 +0,0 @@
-&lt;?php
-// -------------------------------------------------------------
-//
-// $Id: pagestart.php,v 1.18 2004/08/02 14:31:45 psotfx Exp $
-//
-// FILENAME  : pagestart.php
-// STARTED   : Thu Aug 2, 2001
-// COPYRIGHT : &#169; 2001, 2004 phpBB Group
-// WWW       : <A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>
-// LICENCE   : GPL vs2.0 [ see /docs/COPYING ]
-//
-// -------------------------------------------------------------
-if (!defined('VIPERAL') || VIPERAL != 'Admin')
-{
-	die; 
-}
-
-// Some often used variables
-$safe_mode	= (@ini_get('safe_mode') || @strtolower(ini_get('safe_mode')) == 'on') ? true : false;
-$file_uploads = (@ini_get('file_uploads') || strtolower(@ini_get('file_uploads')) == 'on') ? true : false;
-
-$data = array(
-	'title' =&gt; 'Forum Administration',
-	'position' =&gt; BLOCK_LEFT,
-	'file' =&gt; 'block-Admin_Forums.php',
-);
-
-$_CLASS['core_blocks']-&gt;add_block($data);
-
-load_class($site_file_root.'includes/forums/auth.php', 'auth');
-require_once($site_file_root.'includes/forums/functions.php');
-require_once($site_file_root.'includes/forums/functions_admin.php');
-
-$_CLASS['core_user']-&gt;add_lang('admin', 'Forums');
-//$_CLASS['core_user']-&gt;add_img(false, 'Forums');
-$_CLASS['auth']-&gt;acl($_CLASS['core_user']-&gt;data);
-
-$file = get_variable('file', 'REQUEST', 'main');
-
-if (file_exists($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/'.$file.'.php'))
-{
-	require($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/'.$file.'.php');
-}
-else
-{
-	require($site_file_root.'modules/'.$_CORE_MODULE['name'].'/admin/main.php');
-}
-
-
-// -----------------------------
-// Functions
-function adm_page_header($sub_title, $meta = '', $table_html = true)
-{
-	global $config, $db, $_CLASS;
-
-	$_CLASS['core_display']-&gt;display_head();
-	$_CLASS['core_display']-&gt;table_open;
-
-	if ($table_html)
-	{
-
-?&gt;
-&lt;a name=&quot;top&quot;&gt;&lt;/a&gt;
-
-&lt;table width=&quot;95%&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td&gt;
-
-&lt;?php
-
-	}
-
-}
-
-function adm_page_footer($copyright_html = true)
-{
-	global $cache, $config, $_CLASS;
-
-?&gt;
-
-		&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-&lt;?php
-
-	if ($copyright_html)
-	{
-
-?&gt;
-
-&lt;div class=&quot;copyright&quot; align=&quot;center&quot;&gt;Powered by phpBB &lt;?php echo $config['version']; ?&gt; &copy; 2002 &lt;a href=&quot;<A HREF="http://www.phpbb.com/">http://www.phpbb.com/</A>&quot; target=&quot;_phpbb&quot;&gt;phpBB Group&lt;/a&gt;&lt;/div&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-&lt;?php
-	$_CLASS['core_display']-&gt;table_close;
-	$_CLASS['core_display']-&gt;display_footer();
-
-	}
-}
-
-function adm_page_message($title, $message, $show_header = false, $show_prev_info = true)
-{
-	global $_CLASS, $_SERVER, $_ENV;
-
-?&gt;
-&lt;br /&gt;&lt;br /&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;&lt;?php echo $title; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;?php echo $message; ?&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br /&gt;
-
-&lt;?php
-
-}
-
-function adm_page_confirm($title, $message)
-{
-	global $_CLASS;
-
-	// Grab data from GET and POST arrays ... note this is _not_
-	// validated! Everything is typed as string to ensure no
-	// funny business on displayed hidden field data. Validation
-	// will be carried out by whatever processes this form.
-	$var_ary = array_merge($_GET, $_POST);
-
-	$s_hidden_fields = '';
-	foreach ($var_ary as $key =&gt; $var)
-	{
-		if (empty($var))
-		{
-			continue;
-		}
-
-		if (is_array($var))
-		{
-			foreach ($var as $k =&gt; $v)
-			{
-				if (is_array($v))
-				{
-					foreach ($v as $_k =&gt; $_v)
-					{
-						set_var($var[$k][$_k], $_v, 'string');
-						$s_hidden_fields .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;${key}[$k][$_k]\&quot; value=\&quot;&quot; . addslashes($_v) . '&quot; /&gt;';
-					}
-				}
-				else
-				{
-					set_var($var[$k], $v, 'string');
-					$s_hidden_fields .= &quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;${key}[$k]\&quot; value=\&quot;&quot; . addslashes($v) . '&quot; /&gt;';
-				}
-			}
-		}
-		else
-		{
-			set_var($var, $var, 'string');
-			$s_hidden_fields .= '&lt;input type=&quot;hidden&quot; name=&quot;' . $key . '&quot; value=&quot;' . addslashes($var) . '&quot; /&gt;';
-		}
-		unset($var_ary[$key]);
-	}
-
-?&gt;
-
-&lt;br /&gt;&lt;br /&gt;
-
-&lt;form name=&quot;confirm&quot; method=&quot;post&quot; action=&quot;&lt;?php echo $_SERVER['REQUEST_URI']; ?&gt;&quot;&gt;
-&lt;table class=&quot;tablebg&quot; width=&quot;80%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;th&gt;&lt;?php echo $title; ?&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;?php echo $message; ?&gt;&lt;br /&gt;&lt;br /&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['YES']; ?&gt;&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;&lt;?php echo $_CLASS['core_user']-&gt;lang['NO']; ?&gt;&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;?php echo $s_hidden_fields; ?&gt;
-&lt;/form&gt;
-
-&lt;br /&gt;
-
-&lt;?php
-
-	adm_page_footer();
-
-}
-
-function build_cfg_template($tpl_type, $config_key, $options = '')
-{
-	global $new, $_CLASS;
-
-	$tpl = '';
-	$name = 'config[' . $config_key . ']';
-
-	switch ($tpl_type[0])
-	{
-		case 'text':
-		case 'password':
-			$size = (int) $tpl_type[1];
-			$maxlength = (int) $tpl_type[2];
-
-			$tpl = '&lt;input class=&quot;post&quot; type=&quot;' . $tpl_type[0] . '&quot;' . (($size) ? ' size=&quot;' . $size . '&quot;' : '') . ' maxlength=&quot;' . (($maxlength) ? $maxlength : 255) . '&quot; name=&quot;' . $name . '&quot; value=&quot;' . $new[$config_key] . '&quot; /&gt;';
-			break;
-
-		case 'dimension':
-			$size = (int) $tpl_type[1];
-			$maxlength = (int) $tpl_type[2];
-
-			$tpl = '&lt;input class=&quot;post&quot; type=&quot;text&quot;' . (($size) ? ' size=&quot;' . $size . '&quot;' : '') . ' maxlength=&quot;' . (($maxlength) ? $maxlength : 255) . '&quot; name=&quot;config[' . $config_key . '_height]&quot; value=&quot;' . $new[$config_key . '_height'] . '&quot; /&gt; x &lt;input class=&quot;post&quot; type=&quot;text&quot;' . (($size) ? ' size=&quot;' . $size . '&quot;' : '') . ' maxlength=&quot;' . (($maxlength) ? $maxlength : 255) . '&quot; name=&quot;config[' . $config_key . '_width]&quot; value=&quot;' . $new[$config_key . '_width'] . '&quot; /&gt;';
-			break;
-
-		case 'textarea':
-			$rows = (int) $tpl_type[1];
-			$cols = (int) $tpl_type[2];
-
-			$tpl = '&lt;textarea name=&quot;' . $name . '&quot; rows=&quot;' . $rows . '&quot; cols=&quot;' . $cols . '&quot;&gt;' . $new[$config_key] . '&lt;/textarea&gt;';
-			break;
-
-		case 'radio':
-			$key_yes	= ($new[$config_key]) ? ' checked=&quot;checked&quot;' : '';
-			$key_no		= (!$new[$config_key]) ? ' checked=&quot;checked&quot;' : '';
-
-			$tpl_type_cond = explode('_', $tpl_type[1]);
-			$type_no = ($tpl_type_cond[0] == 'disabled' || $tpl_type_cond[0] == 'enabled') ? false : true;
-
-			$tpl_no = '&lt;input type=&quot;radio&quot; name=&quot;' . $name . '&quot; value=&quot;0&quot;' . $key_no . ' /&gt;' . (($type_no) ? $_CLASS['core_user']-&gt;lang['NO'] : $_CLASS['core_user']-&gt;lang['DISABLED']);
-			$tpl_yes = '&lt;input type=&quot;radio&quot; name=&quot;' . $name . '&quot; value=&quot;1&quot;' . $key_yes . ' /&gt;' . (($type_no) ? $_CLASS['core_user']-&gt;lang['YES'] : $_CLASS['core_user']-&gt;lang['ENABLED']);
-
-			$tpl = ($tpl_type_cond[0] == 'yes' || $tpl_type_cond[0] == 'enabled') ? $tpl_yes . '&nbsp;&nbsp;' . $tpl_no : $tpl_no . '&nbsp;&nbsp;' . $tpl_yes;
-			break;
-
-		case 'select':
-			eval('$s_options = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			$tpl = '&lt;select name=&quot;' . $name . '&quot;&gt;' . $s_options . '&lt;/select&gt;';
-			break;
-
-		case 'custom':
-			eval('$tpl = ' . str_replace('{VALUE}', $new[$config_key], $options) . ';');
-			break;
-
-		default:
-			break;
-	}
-
-	return $tpl;
-}
-
-// General ACP module class
-class module
-{
-	var $id = 0;
-	var $type;
-	var $name;
-	var $mode;
-
-	// Private methods, should not be overwritten
-	function create($module_type, $module_url, $selected_mod = false, $selected_submod = false)
-	{
-		global $template, $_CLASS, $db, $config;
-
-		$sql = 'SELECT module_id, module_title, module_filename, module_subs, module_acl
-			FROM ' . MODULES_TABLE . &quot;
-			WHERE module_type = 'acp'
-				AND module_enabled = 1
-			ORDER BY module_order ASC&quot;;
-		$result = $db-&gt;sql_query($sql);
-
-		while ($row = $db-&gt;sql_fetchrow($result))
-		{
-			// Authorisation is required for the basic module
-			if ($row['module_acl'])
-			{
-				$is_auth = false;
-
-				eval('$is_auth = (' . preg_replace(array('#acl_([a-z_]+)#e', '#cfg_([a-z_]+)#e'), array('$_CLASS[\'auth\']-&gt;acl_get(&quot;\\1&quot;)', '$config[&quot;\\1&quot;]'), $row['module_acl']) . ');');
-
-				// The user is not authorised to use this module, skip it
-				if (!$is_auth)
-				{
-					continue;
-				}
-			}
-
-			$selected = ($row['module_filename'] == $selected_mod || $row['module_id'] == $selected_mod || (!$selected_mod &amp;&amp; !$i)) ?  true : false;
-/*
-			// Get the localised lang string if available, or make up our own otherwise
-			$template-&gt;assign_block_vars($module_type . '_section', array(
-				'L_TITLE'		=&gt; (isset($_CLASS['core_user']-&gt;lang[strtoupper($module_type) . '_' . $row['module_title']])) ? $_CLASS['core_user']-&gt;lang[strtoupper($module_type) . '_' . $row['module_title']] : ucfirst(str_replace('_', ' ', strtolower($row['module_title']))),
-				'S_SELECTED'	=&gt; $selected,
-				'U_TITLE'		=&gt; $module_url . '&amp;i=' . $row['module_id'])
-			);
-*/
-			if ($selected)
-			{
-				$module_id = $row['module_id'];
-				$module_name = $row['module_filename'];
-
-				if ($row['module_subs'])
-				{
-					$j = 0;
-					$submodules_ary = explode(&quot;\n&quot;, $row['module_subs']);
-					foreach ($submodules_ary as $submodule)
-					{
-						$submodule = explode(',', trim($submodule));
-						$submodule_title = array_shift($submodule);
-
-						$is_auth = true;
-						foreach ($submodule as $auth_option)
-						{
-							if (!$_CLASS['auth']-&gt;acl_get($auth_option))
-							{
-								$is_auth = false;
-							}
-						}
-
-						if (!$is_auth)
-						{
-							continue;
-						}
-
-						$selected = ($submodule_title == $selected_submod || (!$selected_submod &amp;&amp; !$j)) ? true : false;
-/*
-						// Get the localised lang string if available, or make up our own otherwise
-						$template-&gt;assign_block_vars(&quot;{$module_type}_section.{$module_type}_subsection&quot;, array(
-							'L_TITLE'		=&gt; (isset($_CLASS['core_user']-&gt;lang[strtoupper($module_type) . '_' . strtoupper($submodule_title)])) ? $_CLASS['core_user']-&gt;lang[strtoupper($module_type) . '_' . strtoupper($submodule_title)] : ucfirst(str_replace('_', ' ', strtolower($submodule_title))),
-							'S_SELECTED'	=&gt; $selected,
-							'U_TITLE'		=&gt; $module_url . '&amp;i=' . $module_id . '&amp;mode=' . $submodule_title
-						));
-*/
-						if ($selected)
-						{
-							$this-&gt;mode = $submodule_title;
-						}
-
-						$j++;
-					}
-				}
-			}
-
-			$i++;
-		}
-		$db-&gt;sql_freeresult($result);
-
-		if (!$module_id)
-		{
-			trigger_error('MODULE_NOT_EXIST');
-		}
-
-		$this-&gt;type = $module_type;
-		$this-&gt;id = $module_id;
-		$this-&gt;name = $module_name;
-	}
-
-	// Public methods to be overwritten by modules
-	function module()
-	{
-		// Module name
-		// Module filename
-		// Module description
-		// Module version
-		// Module compatibility
-		return false;
-	}
-
-	function init()
-	{
-		return false;
-	}
-
-	function install()
-	{
-		return false;
-	}
-
-	function uninstall()
-	{
-		return false;
-	}
-}
-// End Functions
-// -----------------------------
-
-?&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/forums/admin/subSilver.css
===================================================================
--- cms/trunk/includes/forums/admin/subSilver.css	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/admin/subSilver.css	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,217 +0,0 @@
-/*
-	$Id: subSilver.css,v 1.14 2004/02/15 09:03:19 acydburn Exp $	
-
-	    The original &quot;subSilver&quot; theme for phpBB2
-	Created by subBlue design :: <A HREF="http://www.subBlue.com">http://www.subBlue.com</A>
-	  Updated for phpBB 2.2 by psoTFX :: phpBB Group
-	        Copyright (c) 2002 phpBB Group
-*/
-
-body {
-	background-color:	white;
-	font-family:		Verdana, Arial, Helvetica, sans-serif;
-	margin:				0px;
-	border:				0px;
-	padding:			0px;
-
-	scrollbar-face-color:		#DEE3E7;
-	scrollbar-highlight-color:	white;
-	scrollbar-shadow-color:		#DEE3E7;
-	scrollbar-3dlight-color:	#D1D7DC;
-	scrollbar-arrow-color:		#006699;
-	scrollbar-track-color:		#EFEFEF;
-	scrollbar-darkshadow-color: #98AAB1;
-}
-
-p {
-	font-size:	8pt;
-}
-
-.maintitle, h1 {
-	font:			bold 18pt 'Trebuchet MS', Verdana, sans-serif;
-	text-decoration:none; 
-	line-height:	120%; 
-}
-h2 {
-	font:			bold 12pt Arial, Helvetica, sans-serif;
-	text-decoration:none; 
-	line-height:	120%; 
-}
-
-.maintitle {
-	color:	#12749B
-}
-
-.subtitle {
-	font:	bold 12pt Arial, Helvetica, sans-serif;
-}
-
-.blue {
-	color: #006699;
-}
-
-.syntaxbg { color: #FFFFFF; }
-.syntaxcomment { color: #FF8000; }
-.syntaxdefault { color: #0000BB; }
-.syntaxhtml { color: #000000; }
-.syntaxkeyword { color: #007700; }
-.syntaxstring { color: #DD0000; }
-
-/*
-	Anchors
-*/
-a:link, a:active, a:visited { color: #006699; text-decoration: none; }
-a:hover { color: #DD6900; text-decoration: underline; }
-
-a.nav { color: #006699; text-decoration: none; }
-a.nav:hover { text-decoration: underline; }
-
-a.th:link { color: #FFA34F; text-decoration: none; }
-a.th:active { color: #FFA34F; text-decoration: none; }
-a.th:visited { color: #FFA34F; text-decoration: none; }
-a.th:hover {  color: #FFA34F; text-decoration: underline; }
-
-/*
-	Non-tag specific
-*/
-.gen, .gensmall {
-	color:	black;
-}
-.gen {
-	font-size:	8pt;
-}
-.gensmall {
-	font-size:	7pt;
-}
-.nav {
-	color:	black;
-	font:	bold 7pt;
-}
-.forumlink {
-	font:	bold 120% Verdana, Arial, Helvetica, sans-serif;
-}
-.name {
-	color:		black;
-	font-size:	11px;
-}
-.postdetails { 
-	color:		black;
-	font-size:	10px;
-}
-.copyright {
-	color:			#444444; 
-	font:			8pt Verdana, Arial, Helvetica, sans-serif; 
-	letter-spacing:	-1px;
-}
-.error { color: #FF0000 }
-
-/*
-	Tables
-*/
-table.bg {
-	background-color: #ACBBC6
-}
-
-th, td { 
-	font:	normal 8pt Verdana, Arial, Helvetica, sans-serif;
-}
-
-th	{
-	height:				25px;
-	background-color:	#006699;
-	color:				#FFA34F;
-	font-weight:		bold;
-	font-size:			11px;
-}
-
-th.forummenu {
-	text-align: left;
-}
-
-td.cat {
-	height:				28px;
-	background-color:	#D1D7DC; 
-}
-
-.row1 {
-	background-color:	#EFEFEF;
-}
-.row2 {
-	background-color:	#DEE3E7;
-}
-.row3 {
-	background-color:	#D1D7DC;
-}
-
-.sourcenum {
-	color:			gray;
-	font-family:	'Courier New', monospace;
-	font-size:		9pt;
-	font-weight:	bold;
-	line-height:	160%;
-}
-.source {
-	font-family:	'Courier New', monospace;
-	font-size:		9pt;
-	line-height:	160%;
-}
-
-
-/*
-	Misc
-*/
-hr	{ 
-	height:				0px; 
-	border:				solid #D1D7DC 0px; 
-	border-top-width:	1px;
-}
-
-/*
-	Forms
-*/
-input {
-	text-indent: 2px;
-}
-
-textarea, select, input.post, input.mainoption, input.liteoption {
-	border: 1px solid; 
-}
-
-input, textarea, select {
-	color:			black;
-	font:			normal 8pt Verdana, Arial, Helvetica, sans-serif;
-	border-color:	black;
-}
-
-input.text {
-	font-family:	'Courier New', courier;
-}
-
-input.checkbox {
-	height:		16px;
-	width:		16px;
-}
-
-option.sep {
-	color:				white;
-	background-color:	#006699;
-}
-
-textarea.edit {
-	font:		9pt 'Courier New', courier;
-	line-height:125%;
-}
-
-.btnmain {
-	background-color:	#FAFAFA;
-	font-weight:		bold;
-	border-width:		1px;
-}
-
-.btnlite {
-	background-color:	#FAFAFA;
-	font-weight:		normal;
-	border-width:		1px;
-}
-
-.helpline { background-color: #DEE3E7; border-style: none; }

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -183,174 +183,6 @@
 	return ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row : false;
 }
 
-// Create forum rules for given forum 
-function generate_forum_rules(&amp;$forum_data)
-{
-	global $_CLASS;
-	
-	if (!$forum_data['forum_rules'] &amp;&amp; !$forum_data['forum_rules_link'])
-	{
-		$_CLASS['core_template']-&gt;assign('S_FORUM_RULES', false);
-		return;
-	}
-
-	if ($forum_data['forum_rules'])
-	{
-		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-		$bbcode = new bbcode($forum_data['forum_rules_bbcode_bitfield']);
-		$bbcode-&gt;bbcode_second_pass($forum_data['forum_rules'], $forum_data['forum_rules_bbcode_uid']);
-
-		$forum_data['forum_rules'] = smiley_text($forum_data['forum_rules'], !($forum_data['forum_rules_flags'] &amp; 2));
-		$forum_data['forum_rules'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($forum_data['forum_rules']));
-		unset($bbcode);
-	}
-
-	$_CLASS['core_template']-&gt;assign_array(array(
-		'S_FORUM_RULES'	=&gt; true,
-		'U_FORUM_RULES'	=&gt; $forum_data['forum_rules_link'],
-		'FORUM_RULES'   =&gt; $forum_data['forum_rules'])
-	);
-}
-
-// Create forum navigation links for given forum, create parent
-// list if currently null, assign basic forum info to template
-function generate_forum_nav(&amp;$forum_data)
-{
-	global $_CLASS;
-
-	// Get forum parents
-	$forum_parents = get_forum_parents($forum_data);
-
-	// Build navigation links
-	foreach ($forum_parents as $parent_forum_id =&gt; $parent_data)
-	{
-		list($parent_name, $parent_type) = array_values($parent_data);
-
-		$_CLASS['core_template']-&gt;assign_vars_array('navlinks', array(
-			'S_IS_CAT'		=&gt;	($parent_type == FORUM_CAT) ? true : false,
-			'S_IS_LINK'		=&gt;	($parent_type == FORUM_LINK) ? true : false,
-			'S_IS_POST'		=&gt;	($parent_type == FORUM_POST) ? true : false,
-			'FORUM_NAME'	=&gt;	$parent_name,
-			'FORUM_ID'		=&gt;	$parent_forum_id,
-			'U_VIEW_FORUM'	=&gt;	generate_link('Forums&amp;file=viewforum&amp;f='.$parent_forum_id)
-			)
-		);
-	}
-
-	$_CLASS['core_template']-&gt;assign_vars_array('navlinks', array(
-		'S_IS_CAT'		=&gt;	($forum_data['forum_type'] == FORUM_CAT) ? true : false,
-		'S_IS_LINK'		=&gt;	($forum_data['forum_type'] == FORUM_LINK) ? true : false,
-		'S_IS_POST'		=&gt;	($forum_data['forum_type'] == FORUM_POST) ? true : false,
-		'FORUM_NAME'	=&gt;	$forum_data['forum_name'],
-		'FORUM_ID'		=&gt;  $forum_data['forum_id'],
-		'U_VIEW_FORUM'	=&gt;	generate_link('Forums&amp;file=viewforum&amp;f=' . $forum_data['forum_id'])
-		)
-	);
-
-	$_CLASS['core_template']-&gt;assign_array(array(
-		'FORUM_ID' 		=&gt; $forum_data['forum_id'],
-		'FORUM_NAME'	=&gt; $forum_data['forum_name'],
-		'FORUM_DESC'	=&gt; strip_tags($forum_data['forum_desc']))
-	);
-
-	return;
-}
-
-// Returns forum parents as an array. Get them from forum_data if available, or update the database otherwise
-function get_forum_parents(&amp;$forum_data)
-{
-	global $_CLASS;
-
-	$forum_parents = array();
-	
-	if ($forum_data['parent_id'])
-	{
-		if (!$forum_data['forum_parents'])
-		{
-			$sql = 'SELECT forum_id, forum_name, forum_type
-				FROM ' . FORUMS_FORUMS_TABLE . '
-				WHERE left_id &lt; ' . $forum_data['left_id'] . '
-					AND right_id &gt; ' . $forum_data['right_id'] . '
-				ORDER BY left_id ASC';
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$forum_parents[$row['forum_id']] = array($row['forum_name'], (int) $row['forum_type']);
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-
-			$forum_data['forum_parents'] = serialize($forum_parents);
-
-			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
-				SET forum_parents = '&quot; . $_CLASS['core_db']-&gt;escape($forum_data['forum_parents']) . &quot;'
-				WHERE parent_id = &quot; . $forum_data['parent_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		else
-		{
-			$forum_parents = unserialize($forum_data['forum_parents']);
-		}
-	}
-
-	return $forum_parents;
-}
-
-// Obtain list of moderators of each forum
-function get_moderators($forum_id = false)
-{
-	global $config, $_CLASS;
-
-	if (!$config['load_moderators'])
-	{
-		return array();
-	}
-
-	$forum_sql = '';
-
-	if ($forum_id)
-	{
-		$forum_sql = is_array($forum_id) ? 'AND forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND forum_id = ' . $forum_id;
-	}
-
-	$sql = 'SELECT *
-		FROM ' . FORUMS_MODERATOR_TABLE . &quot;
-		WHERE display_on_index = 1
-			$forum_sql&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$forum_moderators = array();
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$forum_moderators[$row['forum_id']][] = empty($row['user_id']) ? '&lt;a href=&quot;' . generate_link('Members_List&amp;mode=group&amp;g=' . $row['group_id']) . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/a&gt;' : '&lt;a href=&quot;' . generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	return $forum_moderators;
-}
-
-// User authorisation levels output
-function gen_forum_auth_level($mode, $forum_id)
-{
-	global $_CLASS, $config;
-
-	$rules = array(
-		($_CLASS['forums_auth']-&gt;acl_get('f_post', $forum_id)) ? $_CLASS['core_user']-&gt;lang['RULES_POST_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_POST_CANNOT'],
-		($_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id)) ? $_CLASS['core_user']-&gt;lang['RULES_REPLY_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_REPLY_CANNOT'],
-		($_CLASS['forums_auth']-&gt;acl_gets(array('f_edit', 'm_edit'), $forum_id)) ? $_CLASS['core_user']-&gt;lang['RULES_EDIT_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_EDIT_CANNOT'],
-		($_CLASS['forums_auth']-&gt;acl_gets(array('f_delete', 'm_delete'), $forum_id)) ? $_CLASS['core_user']-&gt;lang['RULES_DELETE_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_DELETE_CANNOT'],
-		($config['allow_attachments'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_attach', $forum_id) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_attach', $forum_id)) ? $_CLASS['core_user']-&gt;lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_ATTACH_CANNOT']
-	);
-
-	foreach ($rules as $rule)
-	{
-		$_CLASS['core_template']-&gt;assign_vars_array('rules', array('RULE' =&gt; $rule));
-	}
-
-	return;
-}
-
 function gen_sort_selects(&amp;$limit_days, &amp;$sort_by_text, &amp;$sort_days, &amp;$sort_key, &amp;$sort_dir, &amp;$s_limit_days, &amp;$s_sort_key, &amp;$s_sort_dir, &amp;$u_sort_param)
 {
 	global $_CLASS;
@@ -386,6 +218,135 @@
 	return;
 }
 
+/**
+* Decode text whereby text is coming from the db and expected to be pre-parsed content
+* We are placing this outside of the message parser because we are often in need of it...
+*/
+function decode_message(&amp;$message, $bbcode_uid = '')
+{
+	if ($bbcode_uid)
+	{
+		$match = array('&lt;br /&gt;', &quot;[/*:m:$bbcode_uid]&quot;, &quot;:u:$bbcode_uid&quot;, &quot;:o:$bbcode_uid&quot;, &quot;:$bbcode_uid&quot;);
+		$replace = array(&quot;\n&quot;, '', '', '', '');
+	}
+	else
+	{
+		$match = array('&lt;br /&gt;');
+		$replace = array(&quot;\n&quot;);
+	}
+
+	$message = str_replace($match, $replace, $message);
+
+	$match = array(
+		'#&lt;!\-\- e \-\-&gt;&lt;a href=&quot;mailto:(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- e \-\-&gt;#',
+		'#&lt;!\-\- m \-\-&gt;&lt;a href=&quot;(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- m \-\-&gt;#',
+		'#&lt;!\-\- w \-\-&gt;&lt;a href=&quot;http:\/\/(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- w \-\-&gt;#',
+		'#&lt;!\-\- l \-\-&gt;&lt;a href=&quot;(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- l \-\-&gt;#',
+		'#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#',
+		'#&lt;!\-\- .*? \-\-&gt;#s',
+		'#&lt;.*?&gt;#s'
+	);
+	
+	$replace = array('\1', '\1', '\1', '\1', '\1', '', '');
+	
+	$message = preg_replace($match, $replace, $message);
+
+	return;
+}
+
+/**
+* For display of custom parsed text on user-facing pages
+* Expects $text to be the value directly from the database (stored value)
+*/
+function generate_text_for_display($text, $uid, $bitfield, $flags)
+{
+	static $bbcode;
+
+	if (!$text)
+	{
+		return '';
+	}
+
+	// Parse bbcode if bbcode uid stored and bbcode enabled
+	if ($uid &amp;&amp; ($flags &amp; 1))
+	{
+		if (!class_exists('bbcode'))
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
+		}
+
+		if (empty($bbcode))
+		{
+			$bbcode = new bbcode($bitfield);
+		}
+		else
+		{
+			$bbcode-&gt;bbcode($bitfield);
+		}
+		
+		$bbcode-&gt;bbcode_second_pass($text, $uid);
+	}
+
+	$text = smiley_text($text, !($flags &amp; 2));
+	$text = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($text));
+
+	return $text;
+}
+
+/**
+* For parsing custom parsed text to be stored within the database.
+* This function additionally returns the uid and bitfield that needs to be stored.
+* Expects $text to be the value directly from request_var() and in it's non-parsed form
+*/
+function generate_text_for_storage(&amp;$text, &amp;$uid, &amp;$bitfield, &amp;$flags, $allow_bbcode = false, $allow_urls = false, $allow_smilies = false)
+{
+	$uid = '';
+	$bitfield = '';
+
+	if (!$text)
+	{
+		return;
+	}
+
+	if (!class_exists('parse_message'))
+	{
+		require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
+	}
+
+	$message_parser = new parse_message($text);
+	$message_parser-&gt;parse(false, $allow_bbcode, $allow_urls, $allow_smilies);
+
+	$text = $message_parser-&gt;message;
+	$uid = $message_parser-&gt;bbcode_uid;
+
+	// If the bbcode_bitfield is empty, there is no need for the uid to be stored.
+	if (!$message_parser-&gt;bbcode_bitfield)
+	{
+		$uid = '';
+	}
+
+	$flags = (($allow_bbcode) ? 1 : 0) + (($allow_smilies) ? 2 : 0) + (($allow_urls) ? 4 : 0);
+	$bitfield = $message_parser-&gt;bbcode_bitfield;
+
+	return;
+}
+
+/**
+* For decoding custom parsed text for edits as well as extracting the flags
+* Expects $text to be the value directly from the database (pre-parsed content)
+*/
+function generate_text_for_edit($text, $uid, $flags)
+{
+	decode_message($text, $uid);
+
+	return array(
+		'allow_bbcode'	=&gt; ($flags &amp; 1) ? 1 : 0,
+		'allow_smilies'	=&gt; ($flags &amp; 2) ? 1 : 0,
+		'allow_urls'	=&gt; ($flags &amp; 4) ? 1 : 0,
+		'text'			=&gt; $text
+	);
+}
+
 function make_jumpbox($action, $forum_id = false, $select_all = false, $acl_list = false)
 {
 	global $config, $_CLASS;
@@ -480,125 +441,7 @@
 	return;
 }
 
-// Topic and forum watching common code
-//do we need user_id ?
-function watch_topic_forum($mode, $user_id, $forum_id, $topic_id, $notify_status = 'unset', $start = 0)
-{
-	global $_CLASS, $config, $_CORE_CONFIG;
 
-	if (!$_CLASS['core_user']-&gt;is_user || !$_CORE_CONFIG['email']['email_enable'] || !$config['allow_topic_notify'])
-	{
-		return array('link' =&gt; '', 'title' =&gt; '', 'watching' =&gt; false);
-	}
-
-	if ($mode == 'forum')
-	{
-		$where = &quot;user_id = $user_id AND forum_id = $forum_id AND topic_id = 0&quot;;
-		$url = 'f='.$forum_id;
-	}
-	else
-	{
-		$where = &quot;user_id = $user_id AND forum_id = $forum_id AND topic_id IN ($topic_id, 0)&quot;;
-		$url = 't='.$topic_id;
-	}
-
-	$is_watching = false;
-
-	if ($notify_status == 'unset')
-	{
-		// Is user watching this thread?
-		$sql = 'SELECT notify_status
-			FROM '.FORUMS_WATCH_TABLE.&quot;
-			 WHERE $where&quot;;
-
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$notify_status = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['notify_status'] : null;
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
-	if (is_null($notify_status))
-	{
-		if (isset($_GET['watch']))
-		{
-			if ($_GET['watch'] == $mode)
-			{
-				$is_watching = true;
-
-				// Remove all topics that are being watched, we watching the whole forum dude
-				if ($mode == 'forum')
-				{
-					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
-						WHERE forum_id = $forum_id
-							AND user_id = $user_id&quot;;
-				
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-
-				$sql_array = array(
-					'user_id' =&gt; (int) $user_id,
-					'forum_id' =&gt; $forum_id,
-					'topic_id' =&gt; $topic_id,
-					'notify_status' =&gt; 0,
-					'notify_type' =&gt; 0
-				);
-
-				$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
-			}
-
-			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;));
-			$message = $_CLASS['core_user']-&gt;lang['ARE_WATCHING_' . strtoupper($mode)] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_' . strtoupper($mode)], '&lt;a href=&quot;' . generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;) . '&quot;&gt;', '&lt;/a&gt;');
-			trigger_error($message);
-		}
-	}
-	else
-	{
-		if (isset($_GET['unwatch']))
-		{
-			if ($_GET['unwatch'] == $mode)
-			{
-				$is_watching = false;
-
-				if ($mode == 'forum')
-				{
-					$where_delete = &quot;forum_id = $forum_id AND topic_id = 0&quot;;
-				}
-				else
-				{
-					$where_delete = &quot;forum_id = $forum_id AND topic_id = $topic_id&quot;;
-				}
-
-				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
-							WHERE user_id = $user_id AND $where_delete&quot;;
-
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-
-			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;));
-			$message = $_CLASS['core_user']-&gt;lang['NOT_WATCHING_' . strtoupper($mode)] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_' . strtoupper($mode)], '&lt;a href=&quot;' . generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;) . '&quot;&gt;', '&lt;/a&gt;');
-			trigger_error($message);
-		}
-		else
-		{
-			$is_watching = true;
-
-			if ($notify_status)
-			{
-				$sql = 'UPDATE ' . FORUMS_WATCH_TABLE . &quot;
-					SET notify_status = 0
-					WHERE $where&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-		}
-	}
-
-	return array(
-			'watching' =&gt; true,
-			'link' =&gt; generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;&quot; . (($is_watching) ? 'unwatch' : 'watch') . &quot;=$mode&amp;start=$start&quot;),
-			'title' =&gt; $_CLASS['core_user']-&gt;lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
-	);
-}
-
 // Marks a topic or forum as read
 function markread($mode, $forum_id = 0, $topic_id = 0, $marktime = false)
 {
@@ -1181,6 +1024,7 @@
 				continue;	
 			}
 		}
+		$_CLASS['core_db']-&gt;free_result($result);
 		
 		if (!$online_userlist)
 		{

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -219,7 +219,7 @@
 				'FORUM_ID'			=&gt;	$row['forum_id'],
 				'FORUM_NAME'		=&gt;	$row['forum_name'],
 				'FORUM_DESC'		=&gt;	$row['forum_desc'],
-				//'FORUM_FOLDER_IMG'		=&gt; ($row['forum_image']) ? '&lt;img src=&quot;' . $phpbb_root_path . $row['forum_image'] . '&quot; alt=&quot;' . $user-&gt;lang['FORUM_CAT'] . '&quot; /&gt;' : '',
+				//'FORUM_FOLDER_IMG'		=&gt; ($row['forum_image']) ? '&lt;img src=&quot;' . $phpbb_root_path . $row['forum_image'] . '&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['FORUM_CAT'] . '&quot; /&gt;' : '',
 				//'FORUM_FOLDER_IMG_SRC'	=&gt; ($row['forum_image']) ? $phpbb_root_path . $row['forum_image'] : '',
 				'U_VIEWFORUM'		=&gt;	generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']))
 			);
@@ -287,7 +287,7 @@
 			$last_post_time = $_CLASS['core_user']-&gt;format_date($row['forum_last_post_time']);
 
 			$last_poster = ($row['forum_last_poster_name'] != '') ? $row['forum_last_poster_name'] : $_CLASS['core_user']-&gt;lang['GUEST'];
-			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('Members_List&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
+			$last_poster_url = ($row['forum_last_poster_id'] == ANONYMOUS) ? '' : generate_link('members_list&amp;mode=viewprofile&amp;u='  . $row['forum_last_poster_id']);
 			
 			$last_post_url = generate_link('forums&amp;file=viewtopic&amp;f='.$row['forum_id_last_post'].'&amp;p='.$row['forum_last_post_id'].'#'.$row['forum_last_post_id'], false, false, false);
 		}
@@ -357,99 +357,268 @@
 }
 
 /**
-* Display reasons
+* Create forum rules for given forum
 */
-function display_reasons($reason_id = 0)
+function generate_forum_rules(&amp;$forum_data)
 {
+	if (!$forum_data['forum_rules'] &amp;&amp; !$forum_data['forum_rules_link'])
+	{
+		return;
+	}
+
+	global $_CLASS;
+
+	if ($forum_data['forum_rules'])
+	{
+		$forum_data['forum_rules'] = generate_text_for_display($forum_data['forum_rules'], $forum_data['forum_rules_uid'], $forum_data['forum_rules_bitfield'], $forum_data['forum_rules_options']);
+	}
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_FORUM_RULES'	=&gt; true,
+		'U_FORUM_RULES'	=&gt; $forum_data['forum_rules_link'],
+		'FORUM_RULES'	=&gt; $forum_data['forum_rules']
+	));
+}
+
+/**
+* Create forum navigation links for given forum, create parent
+* list if currently null, assign basic forum info to template
+*/
+function generate_forum_nav(&amp;$forum_data)
+{
 	global $_CLASS;
-return;
-	$sql = 'SELECT * 
-		FROM ' . REPORTS_REASONS_TABLE . ' 
-		ORDER BY reason_order ASC';
-	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	if (!$_CLASS['forums_auth']-&gt;acl_get('f_list', $forum_data['forum_id']))
+	{
+		return;
+	}
+
+	// Get forum parents
+	$forum_parents = get_forum_parents($forum_data);
+
+	// Build navigation links
+	foreach ($forum_parents as $parent_forum_id =&gt; $parent_data)
+	{
+		list($parent_name, $parent_type) = array_values($parent_data);
+
+		// Skip this parent if the user does not have the permission to view it
+		if (!$_CLASS['forums_auth']-&gt;acl_get('f_list', $parent_forum_id))
+		{
+			continue;
+		}
+
+		$_CLASS['core_template']-&gt;assign_vars_array('navlinks', array(
+			'S_IS_CAT'		=&gt; ($parent_type == FORUM_CAT) ? true : false,
+			'S_IS_LINK'		=&gt; ($parent_type == FORUM_LINK) ? true : false,
+			'S_IS_POST'		=&gt; ($parent_type == FORUM_POST) ? true : false,
+			'FORUM_NAME'	=&gt; $parent_name,
+			'FORUM_ID'		=&gt; $parent_forum_id,
+			'U_VIEW_FORUM'	=&gt; generate_link('forums&amp;file=viewforum&amp;f='.$parent_forum_id)
+		));
+	}
+
+	$_CLASS['core_template']-&gt;assign_vars_array('navlinks', array(
+		'S_IS_CAT'		=&gt; ($forum_data['forum_type'] == FORUM_CAT) ? true : false,
+		'S_IS_LINK'		=&gt; ($forum_data['forum_type'] == FORUM_LINK) ? true : false,
+		'S_IS_POST'		=&gt; ($forum_data['forum_type'] == FORUM_POST) ? true : false,
+		'FORUM_NAME'	=&gt; $forum_data['forum_name'],
+		'FORUM_ID'		=&gt; $forum_data['forum_id'],
+		'U_VIEW_FORUM'	=&gt; generate_link('forums&amp;file=viewforum&amp;f=' . $forum_data['forum_id'])
+	));
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'FORUM_ID' 		=&gt; $forum_data['forum_id'],
+		'FORUM_NAME'	=&gt; $forum_data['forum_name'],
+		'FORUM_DESC'	=&gt; generate_text_for_display($forum_data['forum_desc'], $forum_data['forum_desc_uid'], $forum_data['forum_desc_bitfield'], $forum_data['forum_desc_options']))
+	);
+
+	return;
+}
 
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+/**
+* Returns forum parents as an array. Get them from forum_data if available, or update the database otherwise
+*/
+function get_forum_parents(&amp;$forum_data)
+{
+	global $_CLASS;
+
+	$forum_parents = array();
+
+	if ($forum_data['parent_id'] &gt; 0)
 	{
-		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
-		if (isset($_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) &amp;&amp; isset($_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		if ($forum_data['forum_parents'] == '')
 		{
-			$row['reson_description'] = $_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
-			$row['reason_title'] = $_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+			$sql = 'SELECT forum_id, forum_name, forum_type
+				FROM ' . FORUMS_FORUMS_TABLE . '
+				WHERE left_id &lt; ' . $forum_data['left_id'] . '
+					AND right_id &gt; ' . $forum_data['right_id'] . '
+				ORDER BY left_id ASC';
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$forum_parents[$row['forum_id']] = array($row['forum_name'], (int) $row['forum_type']);
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			$forum_data['forum_parents'] = serialize($forum_parents);
+
+			$sql = 'UPDATE ' . FORUMS_FORUMS_TABLE . &quot;
+				SET forum_parents = '&quot; . $_CLASS['core_db']-&gt;escape($forum_data['forum_parents']) . &quot;'
+				WHERE parent_id = &quot; . $forum_data['parent_id'];
+			$_CLASS['core_db']-&gt;query($sql);
 		}
+		else
+		{
+			$forum_parents = unserialize($forum_data['forum_parents']);
+		}
+	}
 
-		$_CLASS['core_template']-&gt;assign_vars_array('reason', array(
-			'ID'			=&gt; $row['reason_id'],
-			'TITLE'			=&gt; $row['reason_title'],
-			'DESCRIPTION'	=&gt; $row['reason_description'],
-			'S_SELECTED'	=&gt; ($row['reason_id'] == $reason_id) ? true : false)
-		);
+	return $forum_parents;
+}
+
+/**
+* Obtain list of moderators of each forum
+*/
+function get_moderators($forum_id = false)
+{
+	global $config, $_CLASS;
+
+	// Have we disabled the display of moderators? If so, then return
+	// from whence we came ...
+	if (!$config['load_moderators'])
+	{
+		return array();
 	}
-	$_CLASS['core_db']-&gt;free_result($result);
-}
+
+	$forum_sql = '';
+
+	if ($forum_id !== false)
+	{
+		// If we don't have a forum then we can't have a moderator
+		if (is_array($forum_id) &amp;&amp; !sizeof($forum_id))
+		{
+			return;
+		}
+
+		$forum_sql = is_array($forum_id) ? 'AND forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND forum_id = ' . $forum_id;
+	}
+
+	$sql = 'SELECT *
+		FROM ' . FORUMS_MODERATOR_TABLE . &quot;
+		WHERE display_on_index = 1
+			$forum_sql&quot;;
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	
+	$forum_moderators = array();
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$forum_moderators[$row['forum_id']][] = empty($row['user_id']) ? '&lt;a href=&quot;' . generate_link('members_list&amp;mode=group&amp;g=' . $row['group_id']) . '&quot;&gt;' . (isset($_CLASS['core_user']-&gt;lang['G_' . $row['group_name']]) ? $_CLASS['core_user']-&gt;lang['G_' . $row['group_name']] : $row['group_name']) . '&lt;/a&gt;' : '&lt;a href=&quot;' . generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	return $forum_moderators;
+}
 
-function topic_status(&amp;$topic_row, $replies, $mark_time, &amp;$unread, &amp;$folder_img, &amp;$folder_alt, &amp;$topic_type)
+/**
+* User authorisation levels output
+*/
+function gen_forum_auth_level($mode, $forum_id, $forum_status)
+{
+	global $_CLASS, $config;
+
+	$locked = ($forum_status == ITEM_LOCKED &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('m_edit', $forum_id)) ? true : false;
+
+	$rules = array(
+		($_CLASS['forums_auth']-&gt;acl_get('f_post', $forum_id) &amp;&amp; !$locked) ? $_CLASS['core_user']-&gt;lang['RULES_POST_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_POST_CANNOT'],
+		($_CLASS['forums_auth']-&gt;acl_get('f_reply', $forum_id) &amp;&amp; !$locked) ? $_CLASS['core_user']-&gt;lang['RULES_REPLY_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_REPLY_CANNOT'],
+		($_CLASS['forums_auth']-&gt;acl_gets('f_edit', 'm_edit', $forum_id) &amp;&amp; !$locked) ? $_CLASS['core_user']-&gt;lang['RULES_EDIT_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_EDIT_CANNOT'],
+		($_CLASS['forums_auth']-&gt;acl_gets('f_delete', 'm_delete', $forum_id) &amp;&amp; !$locked) ? $_CLASS['core_user']-&gt;lang['RULES_DELETE_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_DELETE_CANNOT'],
+	);
+
+	if ($config['allow_attachments'])
+	{
+		$rules[] = ($_CLASS['forums_auth']-&gt;acl_get('f_attach', $forum_id) &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_attach') &amp;&amp; !$locked) ? $_CLASS['core_user']-&gt;lang['RULES_ATTACH_CAN'] : $_CLASS['core_user']-&gt;lang['RULES_ATTACH_CANNOT'];
+	}
+
+	foreach ($rules as $rule)
+	{
+		$_CLASS['core_template']-&gt;assign_vars_array('rules', array('RULE' =&gt; $rule));
+	}
+
+	return;
+}
+
+function topic_status(&amp;$topic_row, $replies, $unread_topic, &amp;$folder_img, &amp;$folder_alt, &amp;$topic_type)
 {
 	global $_CLASS, $config;
 
-	$folder = '';
-	$unread = ($mark_time &lt; $topic_row['topic_last_post_time']);
+	$folder = $folder_new = '';
 
-	if ($topic_row['topic_status'] == ITEM_MOVED)
-	{
-		$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_MOVED'];
-		$folder_img = 'folder_moved';
-		$folder_alt = 'VIEW_TOPIC_MOVED';
-		//$status = 9;
+	if ($topic_row['topic_status'] == ITEM_MOVED)
+	{
+		$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_MOVED'];
+		$folder_img = 'topic_moved';
+		$folder_alt = 'VIEW_TOPIC_MOVED';
+	}
+	else
+	{
+		switch ($topic_row['topic_type'])
+		{
+			case POST_GLOBAL:
+				$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_GLOBAL'];
+				$folder = 'global_read';
+				$folder_new = 'global_unread';
+			break;
+
+			case POST_ANNOUNCE:
+				$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_ANNOUNCEMENT'];
+				$folder = 'announce_read';
+				$folder_new = 'announce_unread';
+			break;
+
+			case POST_STICKY:
+				$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_STICKY'];
+				$folder = 'sticky_read';
+				$folder_new = 'sticky_unread';
+			break;
+
+			default:
+				$topic_type = '';
+				$folder = 'topic_read';
+				$folder_new = 'topic_unread';
+
+				if ($config['hot_threshold'] &amp;&amp; $replies &gt;= $config['hot_threshold'])
+				{
+					$folder .= '_hot';
+					$folder_new .= '_hot';
+				}
+			break;
+		}
+
+		if ($topic_row['topic_status'] == ITEM_LOCKED)
+		{
+			$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOCKED'];
+			$folder .= '_locked';
+			$folder_new .= '_locked';
+		}
+
+
+		$folder_img = ($unread_topic) ? $folder_new : $folder;
+		$folder_alt = ($unread_topic) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
+
+		// Posted image?
+		if (!empty($topic_row['topic_posted']) &amp;&amp; $topic_row['topic_posted'])
+		{
+			$folder_img .= '_mine';
+		}
+	}
+
+	if ($topic_row['poll_start'])
+	{
+		$topic_type .= $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_POLL'];
 	}
-	else
-	{
-		if ($topic_row['topic_status'] == ITEM_LOCKED)
-		{
-			$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_LOCKED'];
-			$folder_img = ($unread) ? 'folder_locked_new' :'folder_locked';
-			//$status = ($unread) ? 11 : 10;
-		}
-		else
-		{
-			switch ($topic_row['topic_type'])
-			{
-				case POST_GLOBAL:
-				case POST_ANNOUNCE:
-					$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_ANNOUNCEMENT'];
-					$folder_img = ($unread) ? 'folder_announce_new' : 'folder_announce';
-					//$status = ($unread) ? 8 : 7;
-				break;
-	
-				case POST_STICKY:
-					$topic_type = $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_STICKY'];
-					$folder_img = ($unread) ? 'folder_sticky_new' : 'folder_sticky';
-					//$status = ($unread) ? 6 : 5;
-				break;
-	
-				default:
-					if ($config['hot_threshold'] &amp;&amp; $replies &gt;= $config['hot_threshold'])
-					{
-						$folder_img = ($unread) ? 'folder_hot_new': 'folder_hot';
-						//$status = ($unread) ? 4 : 3;
-					}
-					else
-					{
-						$folder_img = ($unread) ? 'folder_new' : 'folder';
-						//$status = ($unread) ? 2 : 1;
-					}
-				break;
-			}
-		}
-
-		$folder_alt = ($unread) ? 'NEW_POSTS' : (($topic_row['topic_status'] == ITEM_LOCKED) ? 'TOPIC_LOCKED' : 'NO_NEW_POSTS');
-	}
-
-	if ($topic_row['poll_start'])
-	{
-		$topic_type .= $_CLASS['core_user']-&gt;lang['VIEW_TOPIC_POLL'];
-	}
-
-	//return $status;
 }
 
 // Display Attachments
@@ -573,4 +742,346 @@
 	return $datas;
 }
 
+/**
+* Assign/Build custom bbcodes for display in screens supporting using of bbcodes
+* The custom bbcodes buttons will be placed within the template block 'custom_codes'
+*/
+function display_custom_bbcodes()
+{
+	global $_CLASS;
+
+	// Start counting from 22 for the bbcode ids (every bbcode takes two ids - opening/closing)
+	$num_predefined_bbcodes = 22;
+
+	/*
+	* @todo while adjusting custom bbcodes, think about caching this query as well as correct ordering
+	*/
+	$sql = 'SELECT bbcode_id, bbcode_tag, bbcode_helpline
+		FROM ' . FORUMS_BBCODES_TABLE . '
+		WHERE display_on_posting = 1';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	$i = 0;
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$_CLASS['core_template']-&gt;assign_vars_array('custom_tags', array(
+			'BBCODE_NAME'		=&gt; &quot;'[{$row['bbcode_tag']}]', '[/&quot; . str_replace('=', '', $row['bbcode_tag']) . &quot;]'&quot;,
+			'BBCODE_ID'			=&gt; $num_predefined_bbcodes + ($i * 2),
+			'BBCODE_TAG'		=&gt; $row['bbcode_tag'],
+			'BBCODE_HELPLINE'	=&gt; $row['bbcode_helpline']
+		));
+
+		$i++;
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+}
+
+/**
+* Display reasons
+*/
+function display_reasons($reason_id = 0)
+{
+	global $_CLASS;
+return;
+	$sql = 'SELECT * 
+		FROM ' . REPORTS_REASONS_TABLE . ' 
+		ORDER BY reason_order ASC';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
+		if (isset($_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) &amp;&amp; isset($_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		{
+			$row['reson_description'] = $_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
+			$row['reason_title'] = $_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+		}
+
+		$_CLASS['core_template']-&gt;assign_vars_array('reason', array(
+			'ID'			=&gt; $row['reason_id'],
+			'TITLE'			=&gt; $row['reason_title'],
+			'DESCRIPTION'	=&gt; $row['reason_description'],
+			'S_SELECTED'	=&gt; ($row['reason_id'] == $reason_id) ? true : false)
+		);
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+}
+
+/**
+* Display user activity (action forum/topic)
+*/
+function display_user_activity(&amp;$userdata)
+{
+	global $auth, $template, $db, $user;
+	global $phpbb_root_path, $phpEx;
+
+	// Init new auth class if user is different
+	if ($user-&gt;data['user_id'] != $userdata['user_id'])
+	{
+		$auth2 = new auth();
+		$auth2-&gt;acl($userdata);
+
+		$post_count_ary = $auth2-&gt;acl_getf('!f_postcount');
+	}
+	else
+	{
+		$post_count_ary = $auth-&gt;acl_getf('!f_postcount');
+	}
+
+	$forum_read_ary = $auth-&gt;acl_getf('!f_read');
+
+	$forum_ary = array();
+
+	// Do not include those forums the user is not having read access to...
+	foreach ($forum_read_ary as $forum_id =&gt; $not_allowed)
+	{
+		if ($not_allowed['f_read'])
+		{
+			$forum_ary[] = (int) $forum_id;
+		}
+	}
+
+	// Now do not include those forums where the posts do not count...
+	foreach ($post_count_ary as $forum_id =&gt; $not_counted)
+	{
+		if ($not_counted['f_postcount'])
+		{
+			$forum_ary[] = (int) $forum_id;
+		}
+	}
+
+	$forum_ary = array_unique($forum_ary);
+	$post_count_sql = (sizeof($forum_ary)) ? 'AND ' . $db-&gt;sql_in_set('f.forum_id', $forum_ary, true) : '';
+
+	// Firebird does not support ORDER BY on aliased columns
+	// MySQL does not support ORDER BY on functions
+	switch (SQL_LAYER)
+	{
+		case 'firebird':
+			$sql = 'SELECT f.forum_id, COUNT(p.post_id) AS num_posts
+				FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+				WHERE p.poster_id = ' . $userdata['user_id'] . &quot; 
+					AND f.forum_id = p.forum_id 
+					$post_count_sql
+				GROUP BY f.forum_id
+				ORDER BY COUNT(p.post_id) DESC&quot;;
+		break;
+
+		default:
+			$sql = 'SELECT f.forum_id, COUNT(p.post_id) AS num_posts
+				FROM ' . POSTS_TABLE . ' p, ' . FORUMS_TABLE . ' f 
+				WHERE p.poster_id = ' . $userdata['user_id'] . &quot; 
+					AND f.forum_id = p.forum_id 
+					$post_count_sql
+				GROUP BY f.forum_id
+				ORDER BY num_posts DESC&quot;;
+		break;
+	}
+
+	$result = $db-&gt;sql_query_limit($sql, 1);
+	$active_f_row = $db-&gt;sql_fetchrow($result);
+	$db-&gt;sql_freeresult($result);
+
+	if (!empty($active_f_row))
+	{
+		$sql = 'SELECT forum_name
+			FROM ' . FORUMS_TABLE . '
+			WHERE forum_id = ' . $active_f_row['forum_id'];
+		$result = $db-&gt;sql_query($sql, 3600);
+		$active_f_row['forum_name'] = (string) $db-&gt;sql_fetchfield('forum_name');
+		$db-&gt;sql_freeresult($result);
+	}
+
+	// Firebird does not support ORDER BY on aliased columns
+	// MySQL does not support ORDER BY on functions
+	switch (SQL_LAYER)
+	{
+		case 'firebird':
+			$sql = 'SELECT t.topic_id, COUNT(p.post_id) AS num_posts   
+				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+				WHERE p.poster_id = ' . $userdata['user_id'] . &quot; 
+					AND t.topic_id = p.topic_id  
+					AND f.forum_id = t.forum_id 
+					$post_count_sql
+				GROUP BY t.topic_id
+				ORDER BY COUNT(p.post_id) DESC&quot;;
+		break;
+
+		default:
+			$sql = 'SELECT t.topic_id, COUNT(p.post_id) AS num_posts   
+				FROM ' . POSTS_TABLE . ' p, ' . TOPICS_TABLE . ' t, ' . FORUMS_TABLE . ' f  
+				WHERE p.poster_id = ' . $userdata['user_id'] . &quot; 
+					AND t.topic_id = p.topic_id  
+					AND f.forum_id = t.forum_id 
+					$post_count_sql
+				GROUP BY t.topic_id
+				ORDER BY num_posts DESC&quot;;
+		break;
+	}
+
+	$result = $db-&gt;sql_query_limit($sql, 1);
+	$active_t_row = $db-&gt;sql_fetchrow($result);
+	$db-&gt;sql_freeresult($result);
+
+	if (!empty($active_t_row))
+	{
+		$sql = 'SELECT topic_title
+			FROM ' . TOPICS_TABLE . '
+			WHERE topic_id = ' . $active_t_row['topic_id'];
+		$result = $db-&gt;sql_query($sql);
+		$active_t_row['topic_title'] = (string) $db-&gt;sql_fetchfield('topic_title');
+		$db-&gt;sql_freeresult($result);
+	}
+
+	$userdata['active_t_row'] = $active_t_row;
+	$userdata['active_f_row'] = $active_f_row;
+
+	$active_f_name = $active_f_id = $active_f_count = $active_f_pct = '';
+	if (!empty($active_f_row['num_posts']))
+	{
+		$active_f_name = $active_f_row['forum_name'];
+		$active_f_id = $active_f_row['forum_id'];
+		$active_f_count = $active_f_row['num_posts'];
+		$active_f_pct = ($userdata['user_posts']) ? ($active_f_count / $userdata['user_posts']) * 100 : 0;
+	}
+
+	$active_t_name = $active_t_id = $active_t_count = $active_t_pct = '';
+	if (!empty($active_t_row['num_posts']))
+	{
+		$active_t_name = $active_t_row['topic_title'];
+		$active_t_id = $active_t_row['topic_id'];
+		$active_t_count = $active_t_row['num_posts'];
+		$active_t_pct = ($userdata['user_posts']) ? ($active_t_count / $userdata['user_posts']) * 100 : 0;
+	}
+
+	$template-&gt;assign_vars(array(
+		'ACTIVE_FORUM'			=&gt; $active_f_name,
+		'ACTIVE_FORUM_POSTS'	=&gt; ($active_f_count == 1) ? sprintf($user-&gt;lang['USER_POST'], 1) : sprintf($user-&gt;lang['USER_POSTS'], $active_f_count),
+		'ACTIVE_FORUM_PCT'		=&gt; sprintf($user-&gt;lang['POST_PCT_ACTIVE'], $active_f_pct),
+		'ACTIVE_TOPIC'			=&gt; censor_text($active_t_name),
+		'ACTIVE_TOPIC_POSTS'	=&gt; ($active_t_count == 1) ? sprintf($user-&gt;lang['USER_POST'], 1) : sprintf($user-&gt;lang['USER_POSTS'], $active_t_count),
+		'ACTIVE_TOPIC_PCT'		=&gt; sprintf($user-&gt;lang['POST_PCT_ACTIVE'], $active_t_pct),
+		'U_ACTIVE_FORUM'		=&gt; append_sid(&quot;{$phpbb_root_path}viewforum.$phpEx&quot;, 'f=' . $active_f_id),
+		'U_ACTIVE_TOPIC'		=&gt; append_sid(&quot;{$phpbb_root_path}viewtopic.$phpEx&quot;, 't=' . $active_t_id))
+	);
+}
+
+// Topic and forum watching common code
+//do we need user_id ?
+function watch_topic_forum($mode, $user_id, $forum_id, $topic_id, $notify_status = 'unset', $start = 0)
+{
+	global $_CLASS, $config, $_CORE_CONFIG;
+
+	if (!$_CLASS['core_user']-&gt;is_user || !$_CORE_CONFIG['email']['email_enable'] || !$config['allow_topic_notify'])
+	{
+		return array('link' =&gt; '', 'title' =&gt; '', 'watching' =&gt; false);
+	}
+
+	if ($mode == 'forum')
+	{
+		$where = &quot;user_id = $user_id AND forum_id = $forum_id AND topic_id = 0&quot;;
+		$url = 'f='.$forum_id;
+	}
+	else
+	{
+		$where = &quot;user_id = $user_id AND forum_id = $forum_id AND topic_id IN ($topic_id, 0)&quot;;
+		$url = 't='.$topic_id;
+	}
+
+	$is_watching = false;
+
+	if ($notify_status == 'unset')
+	{
+		// Is user watching this thread?
+		$sql = 'SELECT notify_status
+			FROM '.FORUMS_WATCH_TABLE.&quot;
+			 WHERE $where&quot;;
+
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		$notify_status = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['notify_status'] : null;
+		$_CLASS['core_db']-&gt;free_result($result);
+	}
+
+	if (is_null($notify_status))
+	{
+		if (isset($_GET['watch']))
+		{
+			if ($_GET['watch'] == $mode)
+			{
+				$is_watching = true;
+
+				// Remove all topics that are being watched, we watching the whole forum dude
+				if ($mode == 'forum')
+				{
+					$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
+						WHERE forum_id = $forum_id
+							AND user_id = $user_id&quot;;
+				
+					$_CLASS['core_db']-&gt;query($sql);
+				}
+
+				$sql_array = array(
+					'user_id' =&gt; (int) $user_id,
+					'forum_id' =&gt; $forum_id,
+					'topic_id' =&gt; $topic_id,
+					'notify_status' =&gt; 0,
+					'notify_type' =&gt; 0
+				);
+
+				$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
+			}
+
+			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;));
+			$message = $_CLASS['core_user']-&gt;lang['ARE_WATCHING_' . strtoupper($mode)] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_' . strtoupper($mode)], '&lt;a href=&quot;' . generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;) . '&quot;&gt;', '&lt;/a&gt;');
+			trigger_error($message);
+		}
+	}
+	else
+	{
+		if (isset($_GET['unwatch']))
+		{
+			if ($_GET['unwatch'] == $mode)
+			{
+				$is_watching = false;
+
+				if ($mode == 'forum')
+				{
+					$where_delete = &quot;forum_id = $forum_id AND topic_id = 0&quot;;
+				}
+				else
+				{
+					$where_delete = &quot;forum_id = $forum_id AND topic_id = $topic_id&quot;;
+				}
+
+				$sql = 'DELETE FROM ' . FORUMS_WATCH_TABLE . &quot;
+							WHERE user_id = $user_id AND $where_delete&quot;;
+
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+
+			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;));
+			$message = $_CLASS['core_user']-&gt;lang['NOT_WATCHING_' . strtoupper($mode)] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_' . strtoupper($mode)], '&lt;a href=&quot;' . generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;) . '&quot;&gt;', '&lt;/a&gt;');
+			trigger_error($message);
+		}
+		else
+		{
+			$is_watching = true;
+
+			if ($notify_status)
+			{
+				$sql = 'UPDATE ' . FORUMS_WATCH_TABLE . &quot;
+					SET notify_status = 0
+					WHERE $where&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+		}
+	}
+
+	return array(
+			'watching' =&gt; true,
+			'link' =&gt; generate_link(&quot;forums&amp;file=view$mode&amp;$url&amp;&quot; . (($is_watching) ? 'unwatch' : 'watch') . &quot;=$mode&amp;start=$start&quot;),
+			'title' =&gt; $_CLASS['core_user']-&gt;lang[(($is_watching) ? 'STOP' : 'START') . '_WATCHING_' . strtoupper($mode)],
+	);
+}
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -484,33 +484,6 @@
 	return true;
 }
 
-// DECODE TEXT -&gt; This will/should be handled by bbcode.php eventually
-function decode_message(&amp;$message, $bbcode_uid = '')
-{
-	global $config;
-
-	$match = array('&lt;br /&gt;', &quot;[/*:m:$bbcode_uid]&quot;, &quot;:u:$bbcode_uid&quot;, &quot;:o:$bbcode_uid&quot;, &quot;:$bbcode_uid&quot;);
-	$replace = array(&quot;\n&quot;, '', '', '', '');
-
-	$message = ($bbcode_uid) ? str_replace($match, $replace, $message) : str_replace('&lt;br /&gt;', &quot;\n&quot;, $message);
-
-	$match = array(
-		'#&lt;!\-\- e \-\-&gt;&lt;a href=&quot;mailto:(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- e \-\-&gt;#',
-		'#&lt;!\-\- m \-\-&gt;&lt;a href=&quot;(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- m \-\-&gt;#',
-		'#&lt;!\-\- w \-\-&gt;&lt;a href=&quot;http:\/\/(.*?)&quot; target=&quot;_blank&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- w \-\-&gt;#',
-		'#&lt;!\-\- l \-\-&gt;&lt;a href=&quot;(.*?)&quot;&gt;.*?&lt;/a&gt;&lt;!\-\- l \-\-&gt;#',
-		'#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#',
-		'#&lt;!\-\- h \-\-&gt;&lt;(.*?)&gt;&lt;!\-\- h \-\-&gt;#',
-		'#&lt;.*?&gt;#s'
-	);
-	
-	$replace = array('\1', '\1', '\1', '\1', '\1', '&lt;\1&gt;', '');
-	
-	$message = preg_replace($match, $replace, $message);
-
-	return;
-}
-
 // Generate Topic Icons for display
 function posting_gen_topic_icons($mode, $icon_id)
 {

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/forums/message_parser.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -66,26 +66,15 @@
 			}
 			else
 			{
-				// TODO: Review this
-				$found = false;
 				foreach ($bbcode_data['regexp'] as $regexp =&gt; $replacement)
 				{
-					if (!$found)
+					// The pattern gets compiled and cached by the PCRE extension,
+					// it should not demand recompilation
+					if (preg_match($regexp, $this-&gt;message))
 					{
-						$before = strlen($this-&gt;message);
+						$this-&gt;message = preg_replace($regexp, $replacement, $this-&gt;message);
+						$bitfield-&gt;set($bbcode_data['bbcode_id']);
 					}
-					$this-&gt;message = preg_replace($regexp, $replacement, $this-&gt;message);
-					if (!$found)
-					{
-						$after = strlen($this-&gt;message);
-						if ($before != $after)
-						{
-							// Because we add bbcode_uid to all tags, the message length
-							// will increase whenever a tag is found
-							$bitfield-&gt;set($bbcode_data['bbcode_id']);
-							$found = true;
-						}
-					}
 				}
 			}
 		}

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/functions.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -533,6 +533,32 @@
     return ($options['full']) ? generate_base_url().$link : $link;
 }
 
+function generate_size($value, $array = false)
+{
+	global $_CLASS;
+
+	if ($value &gt;= 1048576)
+	{
+		$return = array('size' =&gt; round((round($value / 1048576 * 100) / 100), 2), 'size_name' =&gt; $_CLASS['core_user']-&gt;lang['MB']);
+	}
+	elseif ($value &gt;= 1024)
+	{
+		$return = array('size' =&gt; round((round($value / 1024 * 100) / 100), 2), 'size_name' =&gt; $_CLASS['core_user']-&gt;lang['KB']);
+	}
+	else
+	{
+		$return = array('size' =&gt; round($value, 2), 'size_name' =&gt; $_CLASS['core_user']-&gt;lang['BYTES']);
+	}
+	
+	if (!$array)
+	{
+		$return['size'] = number_format($return['size'], 2);
+		return implode(' ', $return);
+	}
+
+	return $return;
+}
+
 function generate_hidden_fields($fields)
 {
 	$hidden_fields = '';

Modified: cms/trunk/includes/tables.php
===================================================================
--- cms/trunk/includes/tables.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/tables.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -173,7 +173,10 @@
 define('FORUMS_ACCESS_TABLE', $table_prefix.'forums_access');
 define('FORUMS_ICONS_TABLE', $table_prefix.'forums_icons');
 define('FORUMS_LOG_TABLE', $table_prefix.'forums_log');
+
 define('FORUMS_MODERATOR_TABLE', $table_prefix.'forums_moderator_cache');
+define('FORUMS_MODERATOR_CACHE_TABLE', $table_prefix.'forums_moderator_cache');
+
 define('FORUMS_MODULES_TABLE', $table_prefix . 'forums_modules');
 define('FORUMS_POSTS_TABLE', $table_prefix.'forums_posts');
 define('FORUMS_PRIVMSGS_TABLE', $table_prefix.'forums_privmsgs');
@@ -185,7 +188,7 @@
 define('FORUMS_SITELIST_TABLE', $table_prefix.'forums_sitelist');
 define('FORUMS_SEARCH_TABLE', $table_prefix.'forums_search_results');
 define('FORUMS_SEARCH_WORD_TABLE', $table_prefix.'forums_search_wordlist');
-define('FORUMS_SEARCH_MATCH_TABLE', $table_prefix.'forums_search_wordmatch');
+define('FORUMS_SEARCH_WORDMATCH_TABLE', $table_prefix.'forums_search_wordmatch');
 define('FORUMS_TOPICS_TABLE', $table_prefix.'forums_topics');
 define('FORUMS_POLL_OPTIONS_TABLE', $table_prefix.'forums_poll_results');
 define('FORUMS_POLL_VOTES_TABLE', $table_prefix.'forums_poll_voters');

Added: cms/trunk/includes/templates/admin/eaccelerator/index.html
===================================================================
--- cms/trunk/includes/templates/admin/eaccelerator/index.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/admin/eaccelerator/index.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,318 @@
+&lt;!-- DISPLAY_HEADER --&gt;
+
+{ $THEME_TABLE_OPEN }
+
+&lt;!-- IF { $eaccelerator_info } --&gt;
+
+&lt;table border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+	&lt;tbody&gt;
+		&lt;tr&gt;
+			&lt;td width=&quot;50%&quot; valign=&quot;top&quot;&gt;
+				&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+					&lt;tbody&gt;
+						&lt;tr&gt;
+							&lt;th width=&quot;25%&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;b&gt;eAccelerator Info&lt;/b&gt;&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								eAccelerator Version
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $version }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Caching enabled
+							&lt;/td&gt;
+							&lt;td&gt;
+								&lt;!-- IF { $cache } --&gt;
+									&lt;img src=&quot;images/led_green.png&quot; alt=&quot;Enabled&quot; title=&quot;Enabled&quot; border=&quot;0&quot;&gt;
+								&lt;!-- ELSE --&gt;
+									&lt;img src=&quot;images/led_red.png&quot; alt=&quot;Disabled&quot; title=&quot;Disabled&quot; border=&quot;0&quot;&gt;
+								&lt;!-- ENDIF --&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Optimizer enabled
+							&lt;/td&gt;
+							&lt;td&gt;
+								&lt;!-- IF { $optimizer } --&gt;
+									&lt;img src=&quot;images/led_green.png&quot; alt=&quot;Enabled&quot; title=&quot;Enabled&quot; border=&quot;0&quot;&gt;
+								&lt;!-- ELSE --&gt;
+									&lt;img src=&quot;images/led_red.png&quot; alt=&quot;Disabled&quot; title=&quot;Disabled&quot; border=&quot;0&quot;&gt;
+								&lt;!-- ENDIF --&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row2&quot;&gt;
+							&lt;td colspan=&quot;2&quot;&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Memory Usage
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $memory_usage }%
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Memory Total
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $memory_size }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Memory Used
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $memory_allocated }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								 Memory Free
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $memory_available }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row2&quot;&gt;
+							&lt;td colspan=&quot;2&quot;&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Cached scripts
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $cached_scripts }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Removed scripts
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $removed_scripts }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr class=&quot;row1&quot;&gt;
+							&lt;td&gt;
+								Cached keys
+							&lt;/td&gt;
+							&lt;td&gt;
+								{ $cached_keys }
+							&lt;/td&gt;
+						&lt;/tr&gt;
+					&lt;/tbody&gt;
+				&lt;/table&gt;
+			&lt;td width=&quot;50%&quot; valign=&quot;top&quot;&gt;
+				&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+					&lt;tbody&gt;
+						&lt;tr&gt;
+							&lt;th width=&quot;25%&quot; colspan=&quot;2&quot; align=&quot;center&quot;&gt;&lt;b&gt;eAccelerator&lt;/b&gt;&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $caching_link }'; return false;&quot;&gt;
+								&lt;a href=&quot;{ $caching_link }&quot;&gt;{ $caching_link_title }&lt;/a&gt;
+							&lt;/td&gt;
+							&lt;td align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $optimizer_link }'; return false;&quot;&gt;
+								&lt;a href=&quot;{ $optimizer_link }&quot;&gt;{ $optimizer_link_title }&lt;/a&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td class=&quot;row2&quot; colspan=&quot;2&quot; style=&quot;padding: 4px;&quot;&gt;&lt;/th&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $purge_cache_link }'; return false;&quot;&gt;
+								&lt;a href=&quot;{ $purge_cache_link }&quot;&gt;{ $purge_cache_link_title }&lt;/a&gt;
+							&lt;/td&gt;
+							&lt;td align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $clean_cache_link }'; return false;&quot;&gt;
+								&lt;a href=&quot;{ $clean_cache_link }&quot;&gt;{ $clean_cache_link_title }&lt;/a&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td  colspan=&quot;2&quot; align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot; onclick=&quot;location.href='{ $clear_cache_link }'; return false;&quot;&gt;
+								&lt;a href=&quot;{ $clear_cache_link }&quot;&gt;{ $clear_cache_link_title }&lt;/a&gt;
+							&lt;/td&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td class=&quot;row2&quot; colspan=&quot;2&quot; style=&quot;padding: 4px;&quot;&gt;&lt;/th&gt;
+						&lt;/tr&gt;
+						&lt;tr&gt;
+							&lt;td  colspan=&quot;2&quot; align=&quot;center&quot; class=&quot;row1&quot; onmouseover=&quot;this.className='row2'&quot; onmouseout=&quot;this.className='row1'&quot;&gt;
+&lt;strong&gt;Purge the cache&lt;/strong&gt;
+&lt;br/&gt;
+Removed all scripts that are marked for deletetion. This will happen automaticly when shared memory is needed.
+&lt;br/&gt;&lt;br/&gt;
+&lt;strong&gt;Clean the cache&lt;/strong&gt;&lt;br/&gt;
+Remove all expired scripts and data from shared memory and disk cache.
+&lt;br/&gt;&lt;br/&gt;
+&lt;strong&gt;Clear the cache&lt;/strong&gt;
+&lt;br/&gt;
+Remove all unused scripts and data from shared memory and disk cache, this means all data that isn't used in the current requests.
+&lt;br/&gt;&lt;br/&gt;
+optimizer which may speed up code execution
+
+							&lt;/td&gt;
+						&lt;/tr&gt;
+					&lt;/tbody&gt;
+				&lt;/table&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+    &lt;/tbody&gt;
+&lt;/table&gt;
+&lt;!-- ENDIF --&gt;
+
+&lt;!-- IF !empty({ $scripts_array }) --&gt;
+
+&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+	&lt;tbody&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;b&gt;Last 5 Current Cached Files&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; style=&quot;padding: 4px;&quot;&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Filename&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Time&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;File Size&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Reloads&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Hits&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $scripts_array --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;
+				{ $scripts_array:file }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $scripts_array:time }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $scripts_array:size }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $scripts_array:reloads }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $scripts_array:hits }
+			&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP $scripts_array--&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; align=&quot;center&quot; style=&quot;padding: 4px;&quot;&gt;
+			&lt;!-- IF { $scripts_more } &amp;&amp; isset({ $link_scripts }) --&gt;
+				&lt;a href=&quot;{ $link_scripts }&quot;&gt;View More&lt;/a&gt;
+			&lt;!-- ELSE --&gt;
+				{ $scripts_pagination }
+			&lt;!-- ENDIF --&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;!-- ENDIF --&gt;
+
+&lt;br /&gt;
+&lt;!-- IF !empty({ $removed_scripts_array }) --&gt;
+&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+	&lt;tbody&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;b&gt;Last 5 Removed Cached Files&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; style=&quot;padding: 4px;&quot;&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Filename&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Time&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;File Size&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Reloads&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Hits&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $removed_scripts_array --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;
+				{ $removed_scripts_array:file }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $removed_scripts_array:time }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $removed_scripts_array:size }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $removed_scripts_array:reloads }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $removed_scripts_array:hits }
+			&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP $removed_scripts_array --&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; align=&quot;center&quot; style=&quot;padding: 4px;&quot;&gt;
+			&lt;!-- IF { $removed_scripts_more } &amp;&amp; isset({ $link_removed_scripts })  --&gt;
+				&lt;a href=&quot;{ $link_removed_scripts }&quot;&gt;View More&lt;/a&gt;
+			&lt;!-- ELSE --&gt;
+				{ $removed_scripts_pagination }
+			&lt;!-- ENDIF --&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;!-- ENDIF --&gt;
+
+&lt;br /&gt;
+
+&lt;!-- IF !empty({ $keys_array }) --&gt;
+&lt;table class=&quot;tablebg&quot; border=&quot;0&quot; cellpadding=&quot;4&quot; cellspacing=&quot;1&quot; width=&quot;100%&quot;&gt;
+	&lt;tbody&gt;
+		&lt;tr&gt;
+			&lt;th colspan=&quot;5&quot; align=&quot;center&quot;&gt;&lt;b&gt;Last 5 Current Keys&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; style=&quot;padding: 4px;&quot;&gt;&lt;/th&gt;
+		&lt;/tr&gt;
+		&lt;tr&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Name&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Created&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Size&lt;/b&gt;&lt;/td&gt;
+			&lt;th align=&quot;center&quot;&gt;&lt;b&gt;Expires&lt;/b&gt;&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- LOOP $keys_array --&gt;
+		&lt;tr&gt;
+			&lt;td class=&quot;row1&quot;&gt;
+				{ $keys_array:name }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $keys_array:created }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $keys_array:size }
+			&lt;/td&gt;
+			&lt;td align=&quot;center&quot; class=&quot;row1&quot;&gt;
+				{ $keys_array:expire_time }
+			&lt;/td&gt;
+		&lt;/tr&gt;
+		&lt;!-- ENDLOOP $keys_array --&gt;
+		&lt;tr&gt;
+			&lt;td colspan=&quot;5&quot; class=&quot;row2&quot; align=&quot;center&quot; style=&quot;padding: 4px;&quot;&gt;
+				&lt;!-- IF { $keys_more } &amp;&amp; isset({ $link_keys })  --&gt;
+					&lt;a href=&quot;{ $link_keys }&quot;&gt;View More&lt;/a&gt;
+			&lt;!-- ELSE --&gt;
+				{ $link_pagination }
+			&lt;!-- ENDIF --&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/tbody&gt;
+&lt;/table&gt;
+&lt;!-- ENDIF --&gt;
+
+{ $THEME_TABLE_CLOSE }
+
+&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Added: cms/trunk/includes/templates/modules/forums/admin/acp_forums.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/admin/acp_forums.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/modules/forums/admin/acp_forums.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -0,0 +1,538 @@
+&lt;!-- INCLUDE modules/forums/admin/overall_header.html --&gt;
+
+&lt;a name=&quot;maincontent&quot;&gt;&lt;/a&gt;
+
+&lt;!-- IF { $S_EDIT_FORUM } --&gt;
+
+	&lt;script type=&quot;text/javascript&quot;&gt;
+	&lt;!--
+
+		function display_options(value)
+		{
+			&lt;!-- IF !{ $S_ADD_ACTION } &amp;&amp; { $S_FORUM_ORIG_POST } --&gt;
+				if (value == { $FORUM_POST })
+				{
+					dE('type_actions', -1);
+				}
+				else
+				{
+					dE('type_actions', 1);
+				}
+			&lt;!-- ENDIF --&gt;
+
+			if (value == { $FORUM_POST })
+			{
+				dE('forum_post_options', 1);
+				dE('forum_link_options', -1);
+				dE('forum_rules_options', 1);
+				dE('forum_cat_options', -1);
+			}
+			else if (value == { $FORUM_LINK })
+			{
+				dE('forum_post_options', -1);
+				dE('forum_link_options', 1);
+				dE('forum_rules_options', -1);
+				dE('forum_cat_options', -1);
+			}
+			else if (value == { $FORUM_CAT })
+			{
+				dE('forum_post_options', -1);
+				dE('forum_link_options', -1);
+				dE('forum_rules_options', 1);
+				dE('forum_cat_options', 1);
+			}
+		}
+
+	//--&gt;
+	&lt;/script&gt;
+
+	&lt;a href=&quot;{ $U_BACK }&quot; style=&quot;float: right&quot;&gt;&laquo; { $L_BACK}&lt;/a&gt;
+
+	&lt;h1&gt;{ $L_TITLE } :: { $FORUM_NAME }&lt;/h1&gt;
+
+	&lt;p&gt;{ $L_FORUM_EDIT_EXPLAIN }&lt;/p&gt;
+
+	&lt;!-- IF { $S_ERROR } --&gt;
+		&lt;div class=&quot;errorbox&quot;&gt;
+			&lt;h3&gt;{ $L_WARNING }&lt;/h3&gt;
+			&lt;p&gt;{ $ERROR_MSG }&lt;/p&gt;
+		&lt;/div&gt;
+	&lt;!-- ENDIF --&gt;
+
+	&lt;form id=&quot;forumedit&quot; method=&quot;post&quot; action=&quot;{ $U_EDIT_ACTION }&quot;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;{ $L_FORUM_SETTINGS }&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_TYPE }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;select id=&quot;forum_type&quot; name=&quot;forum_type&quot; onchange=&quot;display_options(this.options[this.selectedIndex].value);&quot;&gt;{ $S_FORUM_TYPE_OPTIONS }&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+
+	&lt;!-- IF !{ $S_ADD_ACTION } &amp;&amp; { $S_FORUM_ORIG_POST } --&gt;
+	&lt;tr id=&quot;type_actions&quot;&lt;!-- IF { $S_FORUM_POST } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_DECIDE_MOVE_DELETE_CONTENT }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; id=&quot;type_action&quot; name=&quot;type_action&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; { $L_DELETE_ALL_POSTS }
+			&lt;!-- IF { $S_MOVE_FORUM_OPTIONS } --&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;type_action&quot; value=&quot;move&quot; /&gt; { $L_MOVE_POSTS_TO } &lt;select name=&quot;to_forum_id&quot;&gt;{ $S_MOVE_FORUM_OPTIONS }&lt;/select&gt;&lt;!-- ENDIF --&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- ENDIF --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_PARENT }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;select id=&quot;parent&quot; name=&quot;forum_parent_id&quot;&gt;&lt;option value=&quot;0&quot;&lt;!-- IF !{ $S_FORUM_PARENT_ID } --&gt; selected=&quot;selected&quot;&lt;!-- ENDIF --&gt;&gt;{ $L_NO_PARENT }&lt;/option&gt;{ $S_PARENT_OPTIONS }&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_NAME }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input class=&quot;medium&quot; type=&quot;text&quot; id=&quot;forum_name&quot; name=&quot;forum_name&quot; value=&quot;{ $FORUM_NAME }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_DESC }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_DESC_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;textarea id=&quot;forum_desc&quot; name=&quot;forum_desc&quot; rows=&quot;5&quot; cols=&quot;45&quot;&gt;{ $FORUM_DESC }&lt;/textarea&gt;
+			&lt;br /&gt;
+			&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;desc_parse_bbcode&quot;&lt;!-- IF { $S_DESC_BBCODE_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_BBCODE } &nbsp; &lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;desc_parse_smilies&quot;&lt;!-- IF { $S_DESC_SMILIES_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_SMILIES } &nbsp; &lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;desc_parse_urls&quot;&lt;!-- IF { $S_DESC_URLS_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_URLS }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_IMAGE }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_IMAGE_EXPLAIN }&lt;/span&gt;&lt;/dt&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input class=&quot;medium&quot; type=&quot;text&quot; id=&quot;forum_image&quot; name=&quot;forum_image&quot; value=&quot;{ $FORUM_IMAGE }&quot; /&gt;
+		&lt;!-- IF { $FORUM_IMAGE_SRC } --&gt;
+			&lt;img src=&quot;{ $FORUM_IMAGE_SRC }&quot; alt=&quot;{ $L_FORUM_IMAGE }&quot; /&gt;
+		&lt;!-- ENDIF --&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_STYLE }:&lt;/dt&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;select id=&quot;forum_style&quot; name=&quot;forum_style&quot;&gt;&lt;option value=&quot;0&quot;&gt;{ $L_DEFAULT_STYLE }&lt;/option&gt;{ $S_STYLES_OPTIONS }&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_COPY_PERMISSIONS }:&lt;br /&gt;&lt;span&gt;{ $L_COPY_PERMISSIONS_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;select id=&quot;forum_perm_from&quot; name=&quot;forum_perm_from&quot;&gt;&lt;option value=&quot;0&quot;&gt;{ $L_NO_PERMISSIONS }&lt;/option&gt;{ $S_FORUM_OPTIONS }&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;div id=&quot;forum_cat_options&quot;&lt;!-- IF !{ $S_FORUM_CAT } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_GENERAL_FORUM_SETTINGS }
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_DISPLAY_ACTIVE_TOPICS }:&lt;br /&gt;&lt;span&gt;{ $L_DISPLAY_ACTIVE_TOPICS_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_active&quot; value=&quot;1&quot;&lt;!-- IF { $S_DISPLAY_ACTIVE_TOPICS } --&gt; id=&quot;display_active&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_active&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_DISPLAY_ACTIVE_TOPICS } --&gt; id=&quot;display_active&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;div id=&quot;forum_post_options&quot;&lt;!-- IF !{ $S_FORUM_POST } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_GENERAL_FORUM_SETTINGS }&lt;/legend&gt;
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			&lt;label for=&quot;forum_status&quot;&gt;{ $L_FORUM_STATUS }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;select id=&quot;forum_status&quot; name=&quot;forum_status&quot;&gt;{ $S_STATUS_OPTIONS }&lt;/select&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- IF { $S_SHOW_DISPLAY_ON_INDEX } --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_LIST_INDEX }:&lt;br /&gt;&lt;span&gt;{ $L_LIST_INDEX_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_on_index&quot; value=&quot;1&quot;&lt;!-- IF { $S_DISPLAY_ON_INDEX } --&gt; id=&quot;display_on_index&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_on_index&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_DISPLAY_ON_INDEX } --&gt; id=&quot;display_on_index&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- ENDIF --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ENABLE_POST_REVIEW }:&lt;br /&gt;&lt;span&gt;{ $L_ENABLE_POST_REVIEW_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_post_review&quot; value=&quot;1&quot;&lt;!-- IF { $S_ENABLE_POST_REVIEW } --&gt; id=&quot;enable_post_review&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_post_review&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_ENABLE_POST_REVIEW } --&gt; id=&quot;enable_post_review&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ENABLE_INDEXING }:&lt;br /&gt;&lt;span&gt;{ $L_ENABLE_INDEXING_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_indexing&quot; value=&quot;1&quot;&lt;!-- IF { $S_ENABLE_INDEXING } --&gt; id=&quot;enable_indexing&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES} &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_indexing&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_ENABLE_INDEXING } --&gt; id=&quot;enable_indexing&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ENABLE_TOPIC_ICONS }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_icons&quot; value=&quot;1&quot;&lt;!-- IF { $S_TOPIC_ICONS } --&gt; id=&quot;enable_icons&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES} &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_icons&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_TOPIC_ICONS } --&gt; id=&quot;enable_icons&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ENABLE_RECENT }:&lt;br /&gt;&lt;span&gt;{ $L_ENABLE_RECENT_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_recent&quot; value=&quot;1&quot;&lt;!-- IF { $S_DISPLAY_ACTIVE_TOPICS } --&gt; id=&quot;display_recent&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES} &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;display_recent&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_DISPLAY_ACTIVE_TOPICS } --&gt; id=&quot;display_recent&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_TOPICS_PAGE }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_TOPICS_PAGE_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;text&quot; id=&quot;topics_per_page&quot; name=&quot;topics_per_page&quot; value=&quot;{ $TOPICS_PER_PAGE }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_PASSWORD }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_PASSWORD_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;password&quot; id=&quot;forum_password&quot; name=&quot;forum_password&quot; value=&quot;{ $FORUM_PASSWORD }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_PASSWORD_CONFIRM }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_PASSWORD_CONFIRM_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;password&quot; id=&quot;forum_password_confirm&quot; name=&quot;forum_password_confirm&quot; value=&quot;{ $FORUM_PASSWORD_CONFIRM }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_FORUM_PRUNE_SETTINGS }
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_AUTO_PRUNE }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_AUTO_PRUNE_EXPLAIN}&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_prune&quot; value=&quot;1&quot;&lt;!-- IF { $S_PRUNE_ENABLE } --&gt; id=&quot;enable_prune&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;enable_prune&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_PRUNE_ENABLE } --&gt; id=&quot;enable_prune&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_AUTO_PRUNE_FREQ }:&lt;br /&gt;&lt;span&gt;{ $L_AUTO_PRUNE_FREQ_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;text&quot; id=&quot;prune_freq&quot; name=&quot;prune_freq&quot; value=&quot;{ $PRUNE_FREQ }&quot; /&gt; { $L_DAYS }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_AUTO_PRUNE_DAYS }:&lt;br /&gt;&lt;span&gt;{ $L_AUTO_PRUNE_DAYS_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;text&quot; id=&quot;prune_days&quot; name=&quot;prune_days&quot; value=&quot;{ $PRUNE_DAYS }&quot; /&gt; { $L_DAYS }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_AUTO_PRUNE_VIEWED }:&lt;br /&gt;&lt;span&gt;{ $L_AUTO_PRUNE_VIEWED_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;text&quot; id=&quot;prune_viewed&quot; name=&quot;prune_viewed&quot; value=&quot;{ $PRUNE_VIEWED }&quot; /&gt; { $L_DAYS }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_PRUNE_OLD_POLLS }:&lt;br /&gt;&lt;span&gt;{ $L_PRUNE_OLD_POLLS_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;1&quot;&lt;!-- IF { $S_PRUNE_OLD_POLLS } --&gt; id=&quot;prune_old_polls&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_old_polls&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_PRUNE_OLD_POLLS } --&gt; id=&quot;prune_old_polls&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_PRUNE_ANNOUNCEMENTS}:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;1&quot;&lt;!-- IF { $S_PRUNE_ANNOUNCE } --&gt; id=&quot;prune_announce&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_announce&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_PRUNE_ANNOUNCE } --&gt; id=&quot;prune_announce&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_PRUNE_STICKY}:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;1&quot;&lt;!-- IF { $S_PRUNE_STICKY } --&gt; id=&quot;prune_sticky&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES} &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;prune_sticky&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_PRUNE_STICKY } --&gt; id=&quot;prune_sticky&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO}
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;div id=&quot;forum_link_options&quot;&lt;!-- IF !{ $S_FORUM_LINK } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_GENERAL_FORUM_SETTINGS }
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_LINK }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_LINK_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input class=&quot;medium&quot; type=&quot;text&quot; id=&quot;forum_link&quot; name=&quot;forum_link&quot; value=&quot;{ $FORUM_DATA_LINK }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_LINK_TRACK }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_LINK_TRACK_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;1&quot;&lt;!-- IF { $S_FORUM_LINK_TRACK } --&gt; id=&quot;forum_link_track&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_YES } &nbsp; &lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;forum_link_track&quot; value=&quot;0&quot;&lt;!-- IF !{ $S_FORUM_LINK_TRACK } --&gt; id=&quot;forum_link_track&quot; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_NO }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;div id=&quot;forum_rules_options&quot;&lt;!-- IF { $S_FORUM_LINK } --&gt; style=&quot;display: none;&quot;&lt;!-- ENDIF --&gt;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_FORUM_RULES }
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_RULES_LINK }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_RULES_LINK_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input class=&quot;medium&quot; type=&quot;text&quot; id=&quot;forum_rules_link&quot; name=&quot;forum_rules_link&quot; value=&quot;{ $FORUM_RULES_LINK }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- IF { $FORUM_RULES_PREVIEW } --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_RULES_PREVIEW }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			{ $FORUM_RULES_PREVIEW }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- ENDIF --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_RULES }:&lt;br /&gt;&lt;span&gt;{ $L_FORUM_RULES_EXPLAIN }&lt;/span&gt;
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;textarea id=&quot;forum_rules&quot; name=&quot;forum_rules&quot; rows=&quot;4&quot; cols=&quot;70&quot;&gt;{ $FORUM_RULES_PLAIN }&lt;/textarea&gt;
+			&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;rules_parse_bbcode&quot;&lt;!-- IF { $S_BBCODE_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_BBCODE } &nbsp; &lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;rules_parse_smilies&quot;&lt;!-- IF { $S_SMILIES_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_SMILIES } &nbsp; &lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;rules_parse_urls&quot;&lt;!-- IF { $S_URLS_CHECKED } --&gt; checked=&quot;checked&quot;&lt;!-- ENDIF --&gt; /&gt; { $L_PARSE_URLS }
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/div&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;td align=&quot;center&quot; class=&quot;cat&quot;&gt;
+			&lt;input class=&quot;button&quot; type=&quot;submit&quot; id=&quot;submit&quot; name=&quot;update&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;&nbsp;
+			&lt;input class=&quot;button&quot; type=&quot;reset&quot; id=&quot;reset&quot; name=&quot;reset&quot; value=&quot;{ $L_RESET }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+	&lt;/form&gt;
+
+&lt;!-- ELSEIF { $S_DELETE_FORUM } --&gt;
+
+	&lt;a href=&quot;{ $U_BACK }&quot; style=&quot;float: right&quot;&gt;&laquo; { $L_BACK }&lt;/a&gt;
+
+	&lt;h1&gt;{ $L_FORUM_DELETE }&lt;/h1&gt;
+
+	&lt;p&gt;{ $L_FORUM_DELETE_EXPLAIN }&lt;/p&gt;
+
+	&lt;!-- IF { $S_ERROR } --&gt;
+		&lt;div class=&quot;errorbox&quot;&gt;
+			&lt;h3&gt;{ $L_WARNING }&lt;/h3&gt;
+			&lt;p&gt;{ $ERROR_MSG }&lt;/p&gt;
+		&lt;/div&gt;
+	&lt;!-- ENDIF --&gt;
+
+	&lt;form id=&quot;acp_forum&quot; method=&quot;post&quot; action=&quot;{ $U_ACTION }&quot;&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;th colspan=&quot;2&quot;&gt;
+			{ $L_FORUM_DELETE }
+		&lt;/th&gt;
+	&lt;/tr&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_FORUM_NAME }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;b&gt;{ $FORUM_NAME }&lt;/b&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- IF { $S_FORUM_POST } --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ACTION }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; id=&quot;delete_action&quot; name=&quot;action_posts&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; { $L_DELETE_ALL_POSTS}
+			&lt;!-- IF { $S_MOVE_FORUM_OPTIONS } --&gt;
+				&lt;br/&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;action_posts&quot; value=&quot;move&quot; /&gt; { $L_MOVE_POSTS_TO } &lt;select name=&quot;posts_to_id&quot;&gt;{ $S_MOVE_FORUM_OPTIONS }&lt;/select&gt;
+			&lt;!-- ENDIF --&gt;
+		&lt;/dl&gt;
+	&lt;!-- ENDIF --&gt;
+	&lt;!-- IF { $S_HAS_SUBFORUMS } --&gt;
+	&lt;tr&gt;
+		&lt;td  width=&quot;40%&quot; class=&quot;row1&quot;&gt;
+			{ $L_ACTION }:
+		&lt;/td&gt;
+		&lt;td class=&quot;row2&quot;&gt;
+			&lt;input type=&quot;radio&quot; class=&quot;radio&quot; id=&quot;sub_delete_action&quot; name=&quot;action_subforums&quot; value=&quot;delete&quot; checked=&quot;checked&quot; /&gt; { $L_DELETE_SUBFORUMS }
+			&lt;!-- IF { $S_FORUMS_LIST } --&gt;
+				&lt;br /&gt;&lt;input type=&quot;radio&quot; class=&quot;radio&quot; name=&quot;action_subforums&quot; value=&quot;move&quot; /&gt; { $L_MOVE_SUBFORUMS_TO } &lt;select name=&quot;subforums_to_id&quot;&gt;{ $S_FORUMS_LIST }&lt;/select&gt;
+			&lt;!-- ENDIF --&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+	&lt;!-- ENDIF --&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+	&lt;tr&gt;
+		&lt;td align=&quot;center&quot; class=&quot;cat&quot;&gt;
+			&lt;input class=&quot;button&quot; type=&quot;submit&quot; name=&quot;update&quot; value=&quot;{ $L_SUBMIT }&quot; /&gt;
+		&lt;/td&gt;
+	&lt;/tr&gt;
+&lt;/table&gt;
+
+&lt;/form&gt;
+
+&lt;!-- ELSE --&gt;
+
+	&lt;h1&gt;{ $L_FORUM_ADMIN }&lt;/h1&gt;
+
+	&lt;p&gt;{ $L_FORUM_ADMIN_EXPLAIN }&lt;/p&gt;
+
+	&lt;!-- IF { $ERROR_MSG } --&gt;
+		&lt;div class=&quot;errorbox&quot;&gt;
+			&lt;h3&gt;{ $L_WARNING }&lt;/h3&gt;
+			&lt;p&gt;{ $ERROR_MSG }&lt;/p&gt;
+		&lt;/div&gt;
+	&lt;!-- ENDIF --&gt;
+
+	&lt;!-- IF { $S_RESYNCED } --&gt;
+		&lt;div class=&quot;successbox&quot;&gt;
+			&lt;h3&gt;{ $L_NOTIFY }&lt;/h3&gt;
+			&lt;p&gt;{ $L_FORUM_RESYNCED }&lt;/p&gt;
+		&lt;/div&gt;
+	&lt;!-- ENDIF --&gt;
+	
+	&lt;p&gt;&lt;strong&gt;{ $NAVIGATION }&lt;!-- IF { $S_NO_FORUMS } --&gt; [&lt;a href=&quot;{ $U_EDIT }&quot;&gt;{ $L_EDIT }&lt;/a&gt; | &lt;a href=&quot;{ $U_DELETE }&quot;&gt;{ $L_DELETE }&lt;/a&gt;&lt;!-- IF !{ $S_LINK } --&gt; | &lt;a href=&quot;{ $U_SYNC }&quot;&gt;{ $L_RESYNC }&lt;/a&gt;&lt;!-- ENDIF ---&gt;]&lt;!-- ENDIF --&gt;&lt;/strong&gt;&lt;/p&gt;
+
+	&lt;!-- IF !empty({ $forums }) --&gt;
+		&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+			&lt;col class=&quot;row1&quot; /&gt;&lt;col class=&quot;row1&quot; /&gt;&lt;col class=&quot;row2&quot; /&gt;
+		&lt;tbody&gt;
+		&lt;!-- LOOP $forums --&gt;
+			&lt;tr&gt;
+				&lt;td style=&quot;width: 5%;&quot;&gt;{ $forums:FOLDER_IMAGE }&lt;/td&gt;
+				&lt;td&gt;
+					&lt;strong&gt;&lt;!-- IF isset({ $forums:S_LINK }) &amp;&amp; { $forums:S_LINK } --&gt;{ $forums:FORUM_NAME }&lt;!-- ELSE --&gt;&lt;a href=&quot;{ $forums:U_FORUM }&quot;&gt;{ $forums:FORUM_NAME }&lt;/a&gt;&lt;!-- ENDIF --&gt;&lt;/strong&gt;
+					&lt;!-- IF { $forums:FORUM_DESCRIPTION } --&gt;&lt;br /&gt;&lt;span&gt;{ $forums:FORUM_DESCRIPTION }&lt;/span&gt;&lt;!-- ENDIF --&gt;
+					&lt;!-- IF { $forums:S_FORUM_POST } --&gt;&lt;br /&gt;&lt;br /&gt;&lt;span&gt;{ $L_TOPICS }: &lt;b&gt;{ $forums:FORUM_TOPICS }&lt;/b&gt; / { $L_POSTS }: &lt;b&gt;{ $forums:FORUM_POSTS }&lt;/b&gt;&lt;/span&gt;&lt;!-- ENDIF --&gt;
+				&lt;/td&gt;
+				&lt;td style=&quot;width: 15%; text-align: right; white-space: nowrap;&quot;&gt;
+					&lt;!-- IF !{ $forums:#LOOP_START } --&gt;&lt;a href=&quot;{ $forums:U_MOVE_UP }&quot;&gt;{ $ICON_MOVE_UP }&lt;/a&gt; &lt;!-- ENDIF --&gt;
+					&lt;!-- IF !{ $forums:#LOOP_END } --&gt;&lt;a href=&quot;{ $forums:U_MOVE_DOWN }&quot;&gt;{ $ICON_MOVE_DOWN }&lt;/a&gt; &lt;!-- ENDIF --&gt;
+					&lt;a href=&quot;{ $forums:U_EDIT }&quot;&gt;{ $ICON_EDIT }&lt;/a&gt; 
+					&lt;!-- IF !isset({ $forums:S_LINK }) || !{ $forums:S_LINK } --&gt;&lt;a href=&quot;{ $forums:U_SYNC }&quot;&gt;{ $ICON_SYNC }&lt;/a&gt; &lt;!-- ENDIF --&gt;
+					&lt;a href=&quot;{ $forums:U_DELETE }&quot;&gt;{ $ICON_DELETE }&lt;/a&gt;
+				&lt;/td&gt;
+			&lt;/tr&gt;
+		&lt;!-- ENDLOOP $forums --&gt;
+		&lt;/tbody&gt;
+	&lt;/table&gt;
+	&lt;!-- ENDIF --&gt;
+
+	&lt;form id=&quot;fselect&quot; method=&quot;post&quot; action=&quot;{ $U_SEL_ACTION }&quot;&gt;
+
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+		&lt;tr&gt;
+			&lt;td align=&quot;right&quot; class=&quot;row1&quot;&gt;
+				{ $L_SELECT_FORUM }: &lt;select name=&quot;parent_id&quot; onchange=&quot;if(this.options[this.selectedIndex].value != -1){ this.form.submit(); }&quot;&gt;{ $FORUM_BOX }&lt;/select&gt; 
+				&lt;input class=&quot;button&quot; type=&quot;submit&quot; value=&quot;{ $L_GO }&quot; /&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+	
+	&lt;/form&gt;
+
+	&lt;form id=&quot;forums&quot; method=&quot;post&quot; action=&quot;{ $U_ACTION }&quot;&gt;
+
+	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
+		&lt;tr&gt;
+			&lt;td align=&quot;right&quot; class=&quot;row1&quot;&gt;
+				&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;add&quot; /&gt;
+		
+				&lt;input type=&quot;text&quot; name=&quot;forum_name&quot; value=&quot;&quot; /&gt; 
+				&lt;input class=&quot;button&quot; name=&quot;addforum&quot; type=&quot;submit&quot; value=&quot;{ $L_CREATE_FORUM }&quot; /&gt;
+			&lt;/td&gt;
+		&lt;/tr&gt;
+	&lt;/table&gt;
+
+	&lt;/form&gt;
+
+&lt;!-- ENDIF --&gt;
+
+&lt;!-- INCLUDE modules/forums/admin/overall_footer.html --&gt;
\ No newline at end of file

Deleted: cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/templates/modules/forums/mcp_foruminfo.html	2006-08-20 17:59:24 UTC (rev 185)
@@ -1,52 +0,0 @@
-&lt;!-- $Id: mcp_foruminfo.html,v 1.2 2004/07/08 23:03:03 acydburn Exp $ --&gt;
-
-&lt;!-- Note: was this used ever? --&gt;
-
-&lt;!-- INCLUDE mcp_header.html --&gt;
-
-&lt;form method=&quot;post&quot; name=&quot;main&quot; action=&quot;{S_MCP_ACTION}&quot;&gt;
-&lt;!-- IF S_FORUM_ID --&gt;
-
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;2&quot; height=&quot;28&quot; nowrap=&quot;nowrap&quot;&gt;{L_FORUM_INFO}&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{L_FORUM_NAME}&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;input type=&quot;text&quot; class=&quot;post&quot; name=&quot;forum_name&quot; value=&quot;{FORUM_NAME}&quot; size=&quot;45&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{L_FORUM_DESC}&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; rows=&quot;5&quot; cols=&quot;45&quot; wrap=&quot;virtual&quot; name=&quot;forum_desc&quot;&gt;{FORUM_DESC}&lt;/textarea&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{L_FORUM_STYLE}&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;forum_style&quot;&gt;{STYLE_LIST}&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot;&gt;&lt;b class=&quot;genmed&quot;&gt;{L_FORUM_STATUS}&lt;/b&gt;&lt;/td&gt;
-		&lt;td class=&quot;row2&quot;&gt;&lt;select name=&quot;forum_status&quot;&gt;{STATUS_LIST}&lt;/select&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt;
-		&lt;td colspan=&quot;2&quot; class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;{L_CONFIRM}&quot; class=&quot;btnmain&quot; /&gt;&nbsp; &nbsp;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;{L_CANCEL}&quot; class=&quot;btnlite&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br /&gt;
-&lt;!-- INCLUDE mcp_jumpbox.html --&gt;
-
-&lt;!-- ELSE --&gt;
-
-&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
-	&lt;tr&gt;
-		&lt;th height=&quot;28&quot;&gt;&lt;b&gt;{L_FORUM_INFO}&lt;/b&gt;&lt;/th&gt;
-	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;&lt;br /&gt;&lt;!-- INCLUDE mcp_jumpbox.html --&gt;&lt;br /&gt;&lt;br /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;!-- ENDIF --&gt;
-&lt;/form&gt;
-
-&lt;!-- INCLUDE overall_footer.html --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/user.php
===================================================================
--- cms/trunk/includes/user.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/includes/user.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -294,8 +294,8 @@
 			$module = ($module) ? $module : $_CLASS['core_display']-&gt;page['page_name'];
 			$lang = ($lang) ? $lang : $this-&gt;lang_name;
 
+			$img_file2 = ($img_file) ? &quot;$img_file.php&quot; : 'index.php';
 			$img_file = ($img_file) ? $img_file.'_'.$lang.'.php' : 'index_'.$lang.'.php';
-			$img_file2 = ($img_file) ? &quot;$img_file.php&quot; : 'index.php';
 
 			if (file_exists($_CLASS['core_display']-&gt;theme_path.&quot;/images/modules/$module/$img_file&quot;))
 			{

Modified: cms/trunk/install/build_data.php
===================================================================
--- cms/trunk/install/build_data.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/install/build_data.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -130,6 +130,7 @@
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  .&quot; (module_name, module_status, module_type) VALUES ('users', 2, 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  .&quot; (module_name, module_status, module_type) VALUES ('groups', 2, 0)&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  .&quot; (module_name, module_status, module_type) VALUES ('forums', 2, 0)&quot;);
+$_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_ADMIN_MODULES_TABLE  .&quot; (module_name, module_status, module_type) VALUES ('eaccelerator', 2, 0)&quot;);
 
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  .&quot; (module_name, module_status, module_subs) VALUES ('main', 2, 'front\r\nsubscribed\r\nbookmarks\r\ndrafts')&quot;);
 $_CLASS['core_db']-&gt;query('INSERT INTO '. CORE_CONTROL_PANEL_MODULES_TABLE  .&quot; (module_name, module_status, module_subs) VALUES ('pm', 2, 'view_messages\r\ncompose\r\nunread\r\ndrafts\r\noptions')&quot;);

Modified: cms/trunk/modules/forums/admin/index.php
===================================================================
--- cms/trunk/modules/forums/admin/index.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/admin/index.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -63,6 +63,27 @@
 
 $file = get_variable('file', 'REQUEST', 'main');
 
+$_CLASS['core_template']-&gt;assign_array(array(
+	'USERNAME'				=&gt; $_CLASS['core_user']-&gt;data['username'],
+
+	//'U_ADM_INDEX'			=&gt; append_sid(&quot;{$phpbb_admin_path}index.$phpEx&quot;),
+	//'U_INDEX'				=&gt; append_sid(&quot;index.$phpEx&quot;),
+
+	'T_IMAGES_PATH'			=&gt; &quot;images/&quot;,
+	'T_SMILIES_PATH'		=&gt; &quot;{$config['smilies_path']}/&quot;,
+	'T_AVATAR_PATH'			=&gt; &quot;{$config['avatar_path']}/&quot;,
+	'T_AVATAR_GALLERY_PATH'	=&gt; &quot;{$config['avatar_gallery_path']}/&quot;,
+	'T_ICONS_PATH'			=&gt; &quot;{$config['icons_path']}/&quot;,
+	'T_RANKS_PATH'			=&gt; &quot;{$config['ranks_path']}/&quot;,
+	'T_UPLOAD_PATH'			=&gt; &quot;{$config['upload_path']}/&quot;,
+
+	'ICON_MOVE_UP'		=&gt; '&lt;img src=&quot;modules/forums/images/admin/icon_up.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_UP'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_UP'] . '&quot; /&gt;',
+	'ICON_MOVE_DOWN'	=&gt; '&lt;img src=&quot;modules/forums/images/admin/icon_down.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_DOWN'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_DOWN'] . '&quot; /&gt;',
+	'ICON_EDIT'			=&gt; '&lt;img src=&quot;modules/forums/images/admin/icon_edit.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['EDIT'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['EDIT'] . '&quot; /&gt;',
+	'ICON_DELETE'		=&gt; '&lt;img src=&quot;modules/forums/images/admin/icon_delete.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['DELETE'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['DELETE'] . '&quot; /&gt;',
+	'ICON_SYNC'			=&gt; '&lt;img src=&quot;modules/forums/images/admin/icon_sync.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['RESYNC'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['RESYNC'] . '&quot; /&gt;',
+));
+	
 if (file_exists(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php'))
 {
 	require(SITE_FILE_ROOT.'includes/forums/admin/'.$file.'.php');
@@ -72,47 +93,13 @@
 	require(SITE_FILE_ROOT.'includes/forums/admin/main.php');
 }
 
-
-// -----------------------------
-// Functions
-function adm_page_header($page_title)
-{
-	global $config, $_CLASS;
-
-	$_CLASS['core_template']-&gt;assign_array(array(
-		'PAGE_TITLE'			=&gt; $page_title,
-		'USERNAME'				=&gt; $_CLASS['core_user']-&gt;data['username'],
-
-		//'U_ADM_INDEX'			=&gt; append_sid(&quot;{$phpbb_admin_path}index.$phpEx&quot;),
-		//'U_INDEX'				=&gt; append_sid(&quot;index.$phpEx&quot;),
-
-		'T_IMAGES_PATH'			=&gt; &quot;images/&quot;,
-		'T_SMILIES_PATH'		=&gt; &quot;{$config['smilies_path']}/&quot;,
-		'T_AVATAR_PATH'			=&gt; &quot;{$config['avatar_path']}/&quot;,
-		'T_AVATAR_GALLERY_PATH'	=&gt; &quot;{$config['avatar_gallery_path']}/&quot;,
-		'T_ICONS_PATH'			=&gt; &quot;{$config['icons_path']}/&quot;,
-		'T_RANKS_PATH'			=&gt; &quot;{$config['ranks_path']}/&quot;,
-		'T_UPLOAD_PATH'			=&gt; &quot;{$config['upload_path']}/&quot;,
-
-		'ICON_MOVE_UP'		=&gt; '&lt;img src=&quot;images/icon_up.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_UP'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_UP'] . '&quot; /&gt;',
-		'ICON_MOVE_DOWN'	=&gt; '&lt;img src=&quot;images/icon_down.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_DOWN'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['MOVE_DOWN'] . '&quot; /&gt;',
-		'ICON_EDIT'			=&gt; '&lt;img src=&quot;images/icon_edit.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['EDIT'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['EDIT'] . '&quot; /&gt;',
-		'ICON_DELETE'		=&gt; '&lt;img src=&quot;images/icon_delete.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['DELETE'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['DELETE'] . '&quot; /&gt;',
-		'ICON_SYNC'			=&gt; '&lt;img src=&quot;images/icon_sync.gif&quot; alt=&quot;' . $_CLASS['core_user']-&gt;lang['RESYNC'] . '&quot; title=&quot;' . $_CLASS['core_user']-&gt;lang['RESYNC'] . '&quot; /&gt;',
-	));
-}
-
-function adm_page_footer($copyright_html = true)
-{
-	garbage_collection();
-}
-
 /**
 * Generate back link for acp pages
 */
 function adm_back_link($u_action)
 {
-	global $user;
+	global $_CLASS;
+
 	return '&lt;br /&gt;&lt;br /&gt;&lt;a href=&quot;' . $u_action . '&quot;&gt;&laquo; ' . $_CLASS['core_user']-&gt;lang['BACK_TO_PREV'] . '&lt;/a&gt;';
 }
 

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/posting.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -107,7 +107,7 @@
 	break;
 
 	case 'smilies':
-		require_once(SITE_FILE_ROOT.'includes/forums/functions_posting.php');
+		require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
 
 		generate_smilies('window', $forum_id);
 
@@ -132,6 +132,7 @@
 require_once SITE_FILE_ROOT.'includes/forums/message_parser.php';
 require_once SITE_FILE_ROOT.'includes/forums/functions_admin.php';
 require_once SITE_FILE_ROOT.'includes/forums/functions_posting.php';
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 
 // Use post_row values in favor of submitted ones...
 $forum_id	= (!empty($post_data['forum_id'])) ? (int) $post_data['forum_id'] : (int) $forum_id;

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -229,7 +229,7 @@
 	$s_watching_forum['link'] = $s_watching_forum['title'] = '';
 }
 
-gen_forum_auth_level('forum', $forum_id);
+gen_forum_auth_level('forum', $forum_id, $forum_data['forum_status']);
 
 // Topic ordering options
 $limit_days = array(0 =&gt; $_CLASS['core_user']-&gt;lang['ALL_TOPICS'], 1 =&gt; $_CLASS['core_user']-&gt;lang['1_DAY'], 7 =&gt; $_CLASS['core_user']-&gt;lang['7_DAYS'], 14 =&gt; $_CLASS['core_user']-&gt;lang['2_WEEKS'], 30 =&gt; $_CLASS['core_user']-&gt;lang['1_MONTH'], 90 =&gt; $_CLASS['core_user']-&gt;lang['3_MONTHS'], 180 =&gt; $_CLASS['core_user']-&gt;lang['6_MONTHS'], 364 =&gt; $_CLASS['core_user']-&gt;lang['1_YEAR']);
@@ -521,8 +521,11 @@
 
 		// Get folder img, topic status/type related informations
 		$folder_img = $folder_alt = $topic_type = '';
-		topic_status($row, $replies, $mark_time, $unread_topic, $folder_img, $folder_alt, $topic_type);
+	
+		$unread_topic = ($mark_time &lt; $row['topic_last_post_time']);
 
+		topic_status($row, $replies, $unread_topic, $folder_img, $folder_alt, $topic_type);
+
 		$topic_unapproved = (!$row['topic_approved'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? true : false;
 		$posts_unapproved = ($row['topic_approved'] &amp;&amp; $row['topic_replies'] &lt; $row['topic_replies_real'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? true : false;
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-16 12:22:53 UTC (rev 184)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-20 17:59:24 UTC (rev 185)
@@ -194,6 +194,8 @@
 	login_forum_box($topic_data);
 }
 
+require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
 // Are we watching this topic?
 if (!isset($topic_data['notify_status']))
 {
@@ -260,8 +262,6 @@
 	$topic_data['topic_time_limit'] = 0;
 }
 
-require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
-
 $_CLASS['core_user']-&gt;user_setup();
 $_CLASS['core_user']-&gt;add_lang('viewtopic');
 $_CLASS['core_user']-&gt;add_img();
@@ -511,7 +511,7 @@
 
 	if ($poll_info[0]['bbcode_bitfield'])
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$poll_bbcode = new bbcode();
 	}
 	else


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000103.html">[Viperals-svncheckins] r184 - in cms/trunk: . admin includes	includes/auth includes/cache includes/db includes/display	includes/forums includes/forums/admin includes/forums/mcp	includes/templates/modules/forums	includes/templates/modules/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/members_list
</A></li>
	<LI>Next message: <A HREF="000105.html">[Viperals-svncheckins] r186 - in cms/trunk/modules/forums: . images	images/admin images/en
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#104">[ date ]</a>
              <a href="thread.html#104">[ thread ]</a>
              <a href="subject.html#104">[ subject ]</a>
              <a href="author.html#104">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
