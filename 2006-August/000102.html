<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Viperals-svncheckins] r183 - in cms/trunk: includes includes/db	includes/forums includes/forums/mcp	includes/templates/modules/forums modules/control_panel	modules/control_panel/modules modules/forums
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/viperals-svncheckins/2006-August/index.html" >
   <LINK REL="made" HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r183%20-%20in%20cms/trunk%3A%20includes%20includes/db%0A%09includes/forums%20includes/forums/mcp%0A%09includes/templates/modules/forums%20modules/control_panel%0A%09modules/control_panel/modules%20modules/forums&In-Reply-To=%3C200608130253.k7D2reNY004690%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000101.html">
   <LINK REL="Next"  HREF="000103.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Viperals-svncheckins] r183 - in cms/trunk: includes includes/db	includes/forums includes/forums/mcp	includes/templates/modules/forums modules/control_panel	modules/control_panel/modules modules/forums</H1>
    <B>viperal at BerliOS</B> 
    <A HREF="mailto:viperals-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5BViperals-svncheckins%5D%20r183%20-%20in%20cms/trunk%3A%20includes%20includes/db%0A%09includes/forums%20includes/forums/mcp%0A%09includes/templates/modules/forums%20modules/control_panel%0A%09modules/control_panel/modules%20modules/forums&In-Reply-To=%3C200608130253.k7D2reNY004690%40sheep.berlios.de%3E"
       TITLE="[Viperals-svncheckins] r183 - in cms/trunk: includes includes/db	includes/forums includes/forums/mcp	includes/templates/modules/forums modules/control_panel	modules/control_panel/modules modules/forums">viperal at mail.berlios.de
       </A><BR>
    <I>Sun Aug 13 04:53:40 CEST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000101.html">[Viperals-svncheckins] r182 - in cms/trunk/includes: db	templates/modules/forums templates/modules/members_list
</A></li>
        <LI>Next message: <A HREF="000103.html">[Viperals-svncheckins] r184 - in cms/trunk: . admin includes	includes/auth includes/cache includes/db includes/display	includes/forums includes/forums/admin includes/forums/mcp	includes/templates/modules/forums	includes/templates/modules/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/members_list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102">[ date ]</a>
              <a href="thread.html#102">[ thread ]</a>
              <a href="subject.html#102">[ subject ]</a>
              <a href="author.html#102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: viperal
Date: 2006-08-13 04:53:31 +0200 (Sun, 13 Aug 2006)
New Revision: 183

Modified:
   cms/trunk/includes/db/postgres.php
   cms/trunk/includes/forums/auth.php
   cms/trunk/includes/forums/bbcode.php
   cms/trunk/includes/forums/functions.php
   cms/trunk/includes/forums/functions_admin.php
   cms/trunk/includes/forums/functions_display.php
   cms/trunk/includes/forums/functions_posting.php
   cms/trunk/includes/forums/functions_privmsgs.php
   cms/trunk/includes/forums/mcp/mcp_forum.php
   cms/trunk/includes/forums/mcp/mcp_main.php
   cms/trunk/includes/forums/mcp/mcp_notes.php
   cms/trunk/includes/forums/mcp/mcp_post.php
   cms/trunk/includes/forums/mcp/mcp_queue.php
   cms/trunk/includes/forums/mcp/mcp_topic.php
   cms/trunk/includes/forums/message_parser.php
   cms/trunk/includes/functions.php
   cms/trunk/includes/functions_user.php
   cms/trunk/includes/templates/modules/forums/mcp_approve.html
   cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
   cms/trunk/includes/templates/modules/forums/mcp_queue.html
   cms/trunk/includes/templates/modules/forums/viewtopic_body.html
   cms/trunk/modules/control_panel/index.php
   cms/trunk/modules/control_panel/modules/ucp_pm.php
   cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
   cms/trunk/modules/control_panel/modules/ucp_pm_options.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
   cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
   cms/trunk/modules/forums/mcp.php
   cms/trunk/modules/forums/posting.php
   cms/trunk/modules/forums/viewforum.php
   cms/trunk/modules/forums/viewtopic.php
Log:


Modified: cms/trunk/includes/db/postgres.php
===================================================================
--- cms/trunk/includes/db/postgres.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/db/postgres.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -244,6 +244,9 @@
 			return false;
 		}
 
+		$this-&gt;num_queries++;
+		$this-&gt;last_query = '';
+
 		SWitch (strtoupper($query_type))
 		{
 			case 'MULTI_INSERT':
@@ -254,13 +257,17 @@
 			break;
 
 			case 'INSERT':
-				return pg_insert($this-&gt;link_identifier, $table, $array);
-				//return $this-&gt;query('INSERT INTO ' . $table . ' '. $values');
+				//	return pg_insert($this-&gt;link_identifier, $table, $array);
+				// We can't use pg_insert if we need needed to get the insert_id
+				$this-&gt;last_query = 'INSERT INTO ' . $table . ' '. $this-&gt;sql_build_array('INSERT', $array);
+				$this-&gt;last_result = $this-&gt;query($this-&gt;last_query);
+	
+				return $this-&gt;last_result;
 			break;
 
 			case 'UPDATE':
 				return pg_update($this-&gt;link_identifier, $table, $array);
-				//return $this-&gt;query('UPDATE ' . $table . ' SET ' . $values);
+				//return $this-&gt;query('UPDATE ' . $table . ' SET ' . $array);
 			break;
 		}
 	}

Modified: cms/trunk/includes/forums/auth.php
===================================================================
--- cms/trunk/includes/forums/auth.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/auth.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -32,11 +32,14 @@
 // mysteriously appear elsewhere, think up your own solutions!
 class forums_auth
 {
-	var $founder = false;
 	var $acl = array();
+	var $cache = array();
 	var $option = array();
 	var $acl_options = array();
-
+
+	/**
+	* Init permissions
+	*/
 	function acl($userdata)
 	{
 		global $_CLASS;
@@ -49,6 +52,8 @@
 			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			$global = $local = 0;
+			$this-&gt;acl_options = array();
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				if (!empty($row['is_global']))
@@ -74,54 +79,112 @@
 
 		foreach (explode(&quot;\n&quot;, $userdata['user_permissions']) as $f =&gt; $seq)
 		{
-			if ($seq)
-			{
-				$i = 0;
-				while ($subseq = substr($seq, $i, 6))
-				{
-					if (!isset($this-&gt;acl[$f]))
-					{
-						$this-&gt;acl[$f] = '';
-					}
-					$this-&gt;acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
-					$i += 6;
-				}
+			if ($seq)
+			{
+				$i = 0;
+
+				if (!isset($this-&gt;acl[$f]))
+				{
+					$this-&gt;acl[$f] = '';
+				}
+
+				while ($subseq = substr($seq, $i, 6))
+				{
+					// We put the original bitstring into the acl array
+					$this-&gt;acl[$f] .= str_pad(base_convert($subseq, 36, 2), 31, 0, STR_PAD_LEFT);
+					$i += 6;
+				}
 			}
 		}
 		return;
 	}
 
-	// Look up an option
+	/**
+	* Look up an option
+	* if the option is prefixed with !, then the result becomes negated
+	*
+	* If a forum id is specified the local option will be combined with a global option if one exist.
+	* If a forum id is not specified, only the global option will be checked.
+	*/
 	function acl_get($opt, $f = 0)
 	{
-		static $cache;
+		$negate = false;
+
+		if (strpos($opt, '!') === 0)
+		{
+			$negate = true;
+			$opt = substr($opt, 1);
+		}
 
-		if (!isset($cache[$f][$opt]))
+		if (!isset($this-&gt;cache[$f][$opt]))
 		{
-			$cache[$f][$opt] = false;
-			if (isset($this-&gt;acl_options['global'][$opt]))
+			// We combine the global/local option with an OR because some options are global and local.
+			// If the user has the global permission the local one is true too and vice versa
+			$this-&gt;cache[$f][$opt] = false;
+
+			// Is this option a global permission setting?
+			if (isset($this-&gt;acl_options['global'][$opt]))
 			{
 				if (isset($this-&gt;acl[0]))
 				{
-					$cache[$f][$opt] = $this-&gt;acl[0]{$this-&gt;acl_options['global'][$opt]};
+					$this-&gt;cache[$f][$opt] = $this-&gt;acl[0]{$this-&gt;acl_options['global'][$opt]};
 				}
 			}
 
-			if (isset($this-&gt;acl_options['local'][$opt]))
+			// Is this option a local permission setting?
+			// But if we check for a global option only, we won't combine the options...
+			if ($f != 0 &amp;&amp; isset($this-&gt;acl_options['local'][$opt]))
 			{
 				if (isset($this-&gt;acl[$f]))
 				{
-					$cache[$f][$opt] |= $this-&gt;acl[$f]{$this-&gt;acl_options['local'][$opt]};
+					$this-&gt;cache[$f][$opt] |= $this-&gt;acl[$f]{$this-&gt;acl_options['local'][$opt]};
 				}
 			}
 		}
 
-		return isset($cache[$f][$opt]) ? $cache[$f][$opt] : false;
+		// Founder always has all global options set to true...
+		return ($negate) ? !$this-&gt;cache[$f][$opt] : $this-&gt;cache[$f][$opt];
 	}
 
-	function acl_getf($opt)
+	/**
+	* Get forums with the specified permission setting
+	* if the option is prefixed with !, then the result becomes nagated
+	*
+	* @param bool $clean set to true if only values needs to be returned which are set/unset
+	*/
+	function acl_getf($opt, $clean = false)
 	{
-		$cache = false;
+		$acl_f = array();
+		$negate = false;
+
+		if (strpos($opt, '!') === 0)
+		{
+			$negate = true;
+			$opt = substr($opt, 1);
+		}
+
+		// If we retrieve a list of forums not having permissions in, we need to get every forum_id
+		if ($negate)
+		{
+			if ($this-&gt;acl_forum_ids === false)
+			{
+				$sql = 'SELECT forum_id 
+					FROM ' . FORUMS_FORUMS_TABLE;
+				
+				if (sizeof($this-&gt;acl))
+				{
+					$sql .= ' WHERE forum_id NOT IN (' .  implode(', ', array_keys($this-&gt;acl)).')';
+				}
+				$result = $_CLASS['core_db']-&gt;query($sql);
+
+				$this-&gt;acl_forum_ids = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$this-&gt;acl_forum_ids[] = $row['forum_id'];
+				}
+				$_CLASS['core_db']-&gt;free_result($result);
+			}
+		}
 
 		if (isset($this-&gt;acl_options['local'][$opt]))
 		{
@@ -129,23 +192,77 @@
 
 			foreach ($this-&gt;acl as $f =&gt; $bitstring)
 			{
-				if (!isset($cache[$f][$opt]))
-				{
-					$cache[$f][$opt] = false;
+				// Skip global settings
+				if (!$f)
+				{
+					continue;
+				}
 
-					$cache[$f][$opt] = $bitstring{$this-&gt;acl_options['local'][$opt]};
-
-					if (isset($this-&gt;acl_options['global'][$opt]))
-					{
-						$cache[$f][$opt] |= $this-&gt;acl[0]{$this-&gt;acl_options['global'][$opt]};
-					}
+				$allowed = (!isset($this-&gt;cache[$f][$opt])) ? $this-&gt;acl_get($opt, $f) : $this-&gt;cache[$f][$opt];
+
+				if (!$clean)
+				{
+					$acl_f[$f][$opt] = ($negate) ? !$allowed : $allowed;
+				}
+				else
+				{
+					if (($negate &amp;&amp; !$allowed) || (!$negate &amp;&amp; $allowed))
+					{
+						$acl_f[$f][$opt] = 1;
+					}
 				}
 			}
 		}
 
-		return $cache;
+		// If we get forum_ids not having this permission, we need to fill the remaining parts
+		if ($negate &amp;&amp; sizeof($this-&gt;acl_forum_ids))
+		{
+			foreach ($this-&gt;acl_forum_ids as $f)
+			{
+				$acl_f[$f][$opt] = 1;
+			}
+		}
+
+		return $acl_f;
 	}
 
+	/**
+	* Get local permission state for any forum.
+	*
+	* Returns true if user has the permission in one or more forums, false if in no forum.
+	* If global option is checked it returns the global state (same as acl_get($opt))
+	* Local option has precedence...
+	*/
+	function acl_getf_global($opt)
+	{
+		$allowed = false;
+
+		if (isset($this-&gt;acl_options['local'][$opt]))
+		{
+			foreach ($this-&gt;acl as $f =&gt; $bitstring)
+			{
+				// Skip global settings
+				if (!$f)
+				{
+					continue;
+				}
+
+				$allowed = (!isset($this-&gt;cache[$f][$opt])) ? $this-&gt;acl_get($opt, $f) : $this-&gt;cache[$f][$opt];
+
+				if ($allowed)
+				{
+					break;
+				}
+			}
+		}
+		else if (isset($this-&gt;acl_options['global'][$opt]))
+		{
+			$allowed = $this-&gt;acl_get($opt);
+		}
+
+		return $allowed;
+	}
+
 	function acl_gets($opts, $f = 0)
 	{
 		$acl = 0;
@@ -176,87 +293,188 @@
 
 		$auth_ary = array();
 
-		foreach ($hold_ary as $user_id =&gt; $forum_ary)
-		{
-			foreach ($forum_ary as $forum_id =&gt; $auth_option_ary)
-			{
-				foreach ($auth_option_ary as $auth_option =&gt; $auth_setting)
-				{
-					$auth_ary[$forum_id][$auth_option][] = $user_id;
-				}
-			}
+		foreach ($hold_ary as $user_id =&gt; $forum_ary)
+		{
+			foreach ($forum_ary as $forum_id =&gt; $auth_option_ary)
+			{
+				foreach ($auth_option_ary as $auth_option =&gt; $auth_setting)
+				{
+					if ($auth_setting)
+					{
+						$auth_ary[$forum_id][$auth_option][] = $user_id;
+					}
+				}
+			}
 		}
 
 		return $auth_ary;
 	}
 
-	// Cache data
+	/**
+	* Cache data to user_permissions row
+	*/
 	function acl_cache(&amp;$userdata)
 	{
 		global $_CLASS;
 
-		$hold_ary = $this-&gt;acl_raw_data($userdata['user_id'], false, false);
-		$hold_ary = empty($hold_ary[$userdata['user_id']]) ? '' : $hold_ary[$userdata['user_id']];
+		// Empty user_permissions
+		$userdata['user_permissions'] = '';
+
+		$hold_ary = $this-&gt;acl_raw_data($userdata['user_id'], false, false);
+
+		if (isset($hold_ary[$userdata['user_id']]))
+		{
+			$hold_ary = $hold_ary[$userdata['user_id']];
+		}
 
-		$hold_str = '';
-		if (is_array($hold_ary))
-		{
-			ksort($hold_ary);
+		$hold_str = $this-&gt;build_bitstring($hold_ary);
+
+		if ($hold_str)
+		{
+			$userdata['user_permissions'] = $hold_str;
+
+			$sql = 'UPDATE ' . USERS_TABLE . &quot;
+				SET user_permissions = '&quot; . $_CLASS['core_db']-&gt;escape($userdata['user_permissions']) . &quot;',
+					user_perm_from = 0
+				WHERE user_id = &quot; . $userdata['user_id'];
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+	/**
+	* Build bitstring from permission set
+	*/
+	function build_bitstring(&amp;$hold_ary)
+	{
+		$hold_str = '';
+
+		if (sizeof($hold_ary))
+		{
+			ksort($hold_ary);
+
+			$last_f = 0;
+
+			foreach ($hold_ary as $f =&gt; $auth_ary)
+			{
+				$ary_key = (!$f) ? 'global' : 'local';
+
+				$bitstring = array();
+				foreach ($this-&gt;acl_options[$ary_key] as $opt =&gt; $id)
+				{
+					if (isset($auth_ary[$opt]))
+					{
+						$bitstring[$id] = $auth_ary[$opt];
+
+						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
+
+						// If one option is allowed, the global permission for this option has to be allowed too
+						// example: if the user has the a_ permission this means he has one or more a_* permissions
+						if ($auth_ary[$opt] == ACL_YES &amp;&amp; (!isset($bitstring[$this-&gt;acl_options[$ary_key][$option_key]]) || $bitstring[$this-&gt;acl_options[$ary_key][$option_key]] == ACL_NEVER))
+						{
+							$bitstring[$this-&gt;acl_options[$ary_key][$option_key]] = ACL_YES;
+						}
+					}
+					else
+					{
+						$bitstring[$id] = ACL_NEVER;
+					}
+				}
+
+				// Now this bitstring defines the permission setting for the current forum $f (or global setting)
+				$bitstring = implode('', $bitstring);
+
+				// The line number indicates the id, therefore we have to add empty lines for those ids not present
+				$hold_str .= str_repeat(&quot;\n&quot;, $f - $last_f);
+			
+				// Convert bitstring for storage - we do not use binary/bytes because PHP's string functions are not fully binary safe
+				for ($i = 0; $i &lt; strlen($bitstring); $i += 31)
+				{
+					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
+				}
+
+				$last_f = $f;
+			}
+			unset($bitstring);
+
+			$hold_str = rtrim($hold_str);
+		}
+
+		return $hold_str;
+	}
 
-			$last_f = 0;
-			foreach ($hold_ary as $f =&gt; $auth_ary)
-			{
-				$ary_key = (!$f) ? 'global' : 'local';
+	/**
+	* Clear one or all users cached permission settings
+	*/
+	function acl_clear_prefetch($user_id = false)
+	{
+		global $_CLASS;
 
-				$bitstring = array();
-				foreach ($this-&gt;acl_options[$ary_key] as $opt =&gt; $id)
-				{
-					if (!empty($auth_ary[$opt]))
-					{
-						$bitstring[$id] = 1;
+		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : &quot; = $user_id&quot;) : '';
 
-						$option_key = substr($opt, 0, strpos($opt, '_') + 1);
-						if (empty($holding[$this-&gt;acl_options[$ary_key][$option_key]]))
-						{
-							$bitstring[$this-&gt;acl_options[$ary_key][$option_key]] = 1;
-						}
-					}
-					else
-					{
-						$bitstring[$id] = 0;
-					}
-				}
+		$sql = 'UPDATE ' . CORE_USERS_TABLE . &quot;
+			SET user_permissions = ''
+			$where_sql&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
 
-				$bitstring = implode('', $bitstring);
+		return;
+	}
 
-				$hold_str .= str_repeat(&quot;\n&quot;, $f - $last_f);
-
-				for ($i = 0; $i &lt; strlen($bitstring); $i += 31)
-				{
-					$hold_str .= str_pad(base_convert(str_pad(substr($bitstring, $i, 31), 31, 0, STR_PAD_RIGHT), 2, 36), 6, 0, STR_PAD_LEFT);
-				}
-
-				$last_f = $f;
-			}
-			unset($bitstring);
-
-			$userdata['user_permissions'] = rtrim($hold_str);
-
-			$sql = 'UPDATE ' . CORE_USERS_TABLE . &quot;
-				SET user_permissions = '&quot; . $_CLASS['core_db']-&gt;escape($userdata['user_permissions']) . &quot;'
-				WHERE user_id = &quot; . $userdata['user_id'];
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		unset($hold_ary);
+	/**
+	* Get assigned roles
+	*/
+	function acl_role_data($user_type, $role_type, $ug_id = false, $forum_id = false)
+	{
+		global $_CLASS;
+
+		$roles = array();
+
+		$sql_id = ($user_type == 'user') ? 'user_id' : 'group_id';
+
+		$sql_ug = ($ug_id !== false) ? ((!is_array($ug_id)) ? &quot;AND a.$sql_id = $ug_id&quot; : 'AND ' . $db-&gt;sql_in_set(&quot;a.$sql_id&quot;, $ug_id)) : '';
+		$sql_forum = ($forum_id !== false) ? ((!is_array($forum_id)) ? &quot;AND a.forum_id = $forum_id&quot; : 'AND ' . $db-&gt;sql_in_set('a.forum_id', $forum_id)) : '';
+
+		// Grab assigned roles...
+		$sql = 'SELECT a.auth_role_id, a.' . $sql_id . ', a.forum_id
+			FROM ' . FORUMS_ACL_TABLE . ' a, ' . FORUMS_ACL_ROLES_TABLE . &quot; r
+			WHERE a.auth_role_id = r.role_id
+				AND r.role_type = '&quot; . $_CLASS['core_db']-&gt;escape($role_type) . &quot;'
+				$sql_ug
+				$sql_forum
+			ORDER BY r.role_order ASC&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$roles[$row[$sql_id]][$row['forum_id']] = $row['auth_role_id'];
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		return $roles;
 	}
 
+	/**
+	* Get raw acl data based on user/option/forum
+	*/
 	function acl_raw_data($user_id = false, $opts = false, $forum_id = false)
 	{
 		global $_CLASS;
 
 		$sql_user = ($user_id) ? (is_array($user_id) ? 'user_id IN (' . implode(', ', $user_id) . ')' : 'user_id = '.$user_id) : '';
 		$sql_forum = ($forum_id) ? (is_array($forum_id) ? 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')' : 'AND a.forum_id = '.$forum_id) : '';
-		$sql_opts = ($opts) ? (is_array($opts) ? ' AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', &quot;\&quot;'\&quot; . \$_CLASS['core_db']-&gt;escape('\\1') . \&quot;'\&quot;&quot;, $opts)) . ')' : &quot;AND ao.auth_option = '&quot;.$_CLASS['core_db']-&gt;escape($opts).&quot;'&quot;) : '';
+
+		$sql_opts = '';
+
+		if ($opts !== false)
+		{
+			if (!is_array($opts))
+			{
+				$sql_opts = (strpos($opts, '%') !== false) ? &quot;AND ao.auth_option LIKE '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot; : &quot;AND ao.auth_option = '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot;;
+			}
+			else
+			{
+				$sql_opts = &quot;AND ao.auth_option IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($opts)) . &quot;')&quot;;
+			}
+		}
+
 		$groups = $group_id_array = $group_members = $hold_ary = array();
 
 		if ($sql_user)
@@ -337,29 +555,27 @@
 		return $hold_ary;
 	}
 
-	// Clear one or all users cached permission settings
-	function acl_clear_prefetch($user_id = false)
-	{
-		global $_CLASS;
-
-		$where_sql = ($user_id) ? ' WHERE user_id ' . ((is_array($user_id)) ? ' IN (' . implode(', ', array_map('intval', $user_id)) . ')' : &quot; = $user_id&quot;) : '';
-
-		$sql = 'UPDATE ' . CORE_USERS_TABLE . &quot;
-			SET user_permissions = ''
-			$where_sql&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-
-		return;
-	}
-
 	function acl_group_raw_data($group_id = false, $opts = false, $forum_id = false)
 	{
 		global $_CLASS;
 
 		$sql_group = ($group_id) ? ((!is_array($group_id)) ? &quot;group_id = $group_id&quot; : 'group_id IN (' . implode(', ', $group_id) . ')') : '';
 		$sql_forum = ($forum_id) ? ((!is_array($forum_id)) ? &quot;AND a.forum_id = $forum_id&quot; : 'AND a.forum_id IN (' . implode(', ', $forum_id) . ')') : '';
-		$sql_opts = ($opts) ? ((!is_array($opts)) ? &quot;AND ao.auth_option = '$opts'&quot; : 'AND ao.auth_option IN (' . implode(', ', preg_replace('#^[\s]*?(.*?)[\s]*?$#e', &quot;\&quot;'\&quot; . \$_CLASS['core_db']-&gt;escape('\\1') . \&quot;'\&quot;&quot;, $opts)) . ')') : '';
 
+		$sql_opts = '';
+
+		if ($opts !== false)
+		{
+			if (!is_array($opts))
+			{
+				$sql_opts = (strpos($opts, '%') !== false) ? &quot;AND ao.auth_option LIKE '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot; : &quot;AND ao.auth_option = '&quot; . $_CLASS['core_db']-&gt;escape($opts) . &quot;'&quot;;
+			}
+			else
+			{
+				$sql_opts = &quot;AND ao.auth_option IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($opts)) . &quot;')&quot;;
+			}
+		}
+
 		$hold_ary = array();
 
 		// Grab group settings ... ACL_NO overrides ACL_YES so act appropriatley
@@ -381,4 +597,5 @@
 		return $hold_ary;
 	}
 }
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/bbcode.php
===================================================================
--- cms/trunk/includes/forums/bbcode.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/bbcode.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -28,15 +28,20 @@
 class bbcode
 {
 	var $bbcode_uid = '';
-	var $bbcode_bitfield = 0;
+	var $bbcode_bitfield = '';
 	var $bbcode_cache = array();
 	var $bbcode_template = array();
-	
+
 	var $bbcodes = array();
+
 	var $template_bitfield = 0;
 	var $template_filename = '';
 
-	function bbcode($bitfield = 0)
+	/**
+	* Constructor
+	* Init bbcode cache entries if bitfield is specified
+	*/
+	function bbcode($bitfield = '')
 	{
 		if ($bitfield)
 		{
@@ -45,6 +50,9 @@
 		}
 	}
 
+	/**
+	* Second pass bbcodes
+	*/
 	function bbcode_second_pass(&amp;$message, $bbcode_uid = '', $bbcode_bitfield = false)
 	{
 		if ($bbcode_uid)
@@ -55,44 +63,50 @@
 		if ($bbcode_bitfield !== false)
 		{
 			$this-&gt;bbcode_bitfield = $bbcode_bitfield;
+
 			// Init those added with a new bbcode_bitfield (already stored codes will not get parsed again)
 			$this-&gt;bbcode_cache_init();
 		}
 
 		if (!$this-&gt;bbcode_bitfield)
 		{
-			return $message;
+			// Remove the uid from tags that have not been transformed into HTML
+			if ($this-&gt;bbcode_uid)
+			{
+				$message = str_replace(':' . $this-&gt;bbcode_uid, '', $message);
+			}
+
+			return;
 		}
 
 		$str = array('search' =&gt; array(), 'replace' =&gt; array());
 		$preg = array('search' =&gt; array(), 'replace' =&gt; array());
 
-		$bitlen = strlen(decbin($this-&gt;bbcode_bitfield));
-		for ($bbcode_id = 0; $bbcode_id &lt; $bitlen; ++$bbcode_id)
+		$bitfield = new bitfield($this-&gt;bbcode_bitfield);
+		$bbcodes_set = $bitfield-&gt;get_all_set();
+
+		foreach ($bbcodes_set as $bbcode_id)
 		{
-			if ($this-&gt;bbcode_bitfield &amp; (1 &lt;&lt; $bbcode_id))
+			if (!empty($this-&gt;bbcode_cache[$bbcode_id]))
 			{
-				if (!empty($this-&gt;bbcode_cache[$bbcode_id]))
+				foreach ($this-&gt;bbcode_cache[$bbcode_id] as $type =&gt; $array)
 				{
-					foreach ($this-&gt;bbcode_cache[$bbcode_id] as $type =&gt; $array)
+					foreach ($array as $search =&gt; $replace)
 					{
-						foreach ($array as $search =&gt; $replace)
-						{
-							${$type}['search'][] = str_replace('$uid', $this-&gt;bbcode_uid, $search);
-							${$type}['replace'][] = $replace;
-						}
+						${$type}['search'][] = str_replace('$uid', $this-&gt;bbcode_uid, $search);
+						${$type}['replace'][] = $replace;
+					}
 
-						if (sizeof($str['search']))
-						{
-							$message = str_replace($str['search'], $str['replace'], $message);
-							$str = array('search' =&gt; array(), 'replace' =&gt; array());
-						}
+					if (sizeof($str['search']))
+					{
+						$message = str_replace($str['search'], $str['replace'], $message);
+						$str = array('search' =&gt; array(), 'replace' =&gt; array());
+					}
 
-						if (sizeof($preg['search']))
-						{
-							$message = preg_replace($preg['search'], $preg['replace'], $message);
-							$preg = array('search' =&gt; array(), 'replace' =&gt; array());
-						}
+					if (sizeof($preg['search']))
+					{
+						$message = preg_replace($preg['search'], $preg['replace'], $message);
+						$preg = array('search' =&gt; array(), 'replace' =&gt; array());
 					}
 				}
 			}
@@ -100,34 +114,38 @@
 
 		// Remove the uid from tags that have not been transformed into HTML
 		$message = str_replace(':' . $this-&gt;bbcode_uid, '', $message);
-
-		return $message;
 	}
 	
-	//
-	// bbcode_cache_init()
-	//
-	// requires: $this-&gt;bbcode_bitfield
-	// sets: $this-&gt;bbcode_cache with bbcode templates needed for bbcode_bitfield
-	//
+	/**
+	* Init bbcode cache
+	*
+	* requires: $this-&gt;bbcode_bitfield
+	* sets: $this-&gt;bbcode_cache with bbcode templates needed for bbcode_bitfield
+	*/
 	function bbcode_cache_init()
 	{
-		global $_CLASS, $site_file_root;
+		global $_CLASS;
 
 		if (empty($this-&gt;template_filename))
 		{
 			$style = 'primary';
-			$this-&gt;template_bitfield = $_CLASS['core_user']-&gt;img['bbcode_bitfield'];
-			$this-&gt;template_filename = file_exists($site_file_root.'themes/' . $_CLASS['core_display']-&gt;theme . '/template/modules/Forums/bbcode.html') ? $site_file_root.'themes/' . $_CLASS['core_display']-&gt;theme . '/template/modules/Forums/bbcode.html' : $site_file_root.'includes/templates/modules/Forums/bbcode.html';
+			$this-&gt;template_bitfield = @$_CLASS['core_user']-&gt;img['bbcode_bitfield'];
+			$this-&gt;template_filename = file_exists(SITE_FILE_ROOT.'themes/' . $_CLASS['core_display']-&gt;theme . '/template/modules/forums/bbcode.html') ? SITE_FILE_ROOT.'themes/' . $_CLASS['core_display']-&gt;theme . '/template/modules/forums/bbcode.html' : SITE_FILE_ROOT.'includes/templates/modules/forums/bbcode.html';
+		
+			if (!@file_exists($this-&gt;template_filename))
+			{
+				trigger_error('The file ' . $this-&gt;template_filename . ' is missing.', E_USER_ERROR);
+			}
 		}
 
-		$sql = '';
-		$bbcode_ids = array();
-		$bitlen = strlen(decbin($this-&gt;bbcode_bitfield));
+		$bbcode_ids = $rowset = $sql = array();
 
-		for ($bbcode_id = 0; $bbcode_id &lt; $bitlen; ++$bbcode_id)
+		$bitfield = new bitfield($this-&gt;bbcode_bitfield);
+		$bbcodes_set = $bitfield-&gt;get_all_set();
+
+		foreach ($bbcodes_set as $bbcode_id)
 		{
-			if (isset($this-&gt;bbcode_cache[$bbcode_id]) || !($this-&gt;bbcode_bitfield &amp; (1 &lt;&lt; $bbcode_id)))
+			if (isset($this-&gt;bbcode_cache[$bbcode_id]))
 			{
 				// do not try to re-cache it if it's already in
 				continue;
@@ -136,20 +154,17 @@
 
 			if ($bbcode_id &gt; NUM_CORE_BBCODES)
 			{
-				$sql .= (($sql) ? ',' : '') . $bbcode_id;
+				$sql[] = $bbcode_id;
 			}
 		}
 
-//cache this
-		if ($sql)
+		if (!empty($sql))
 		{
-			$rowset = array();
-
 			$sql = 'SELECT *
-				FROM ' . BBCODES_TABLE . &quot;
-				WHERE bbcode_id IN ($sql)&quot;;
+				FROM ' . BBCODES_TABLE . '
+				WHERE bbcode_id IN (' . implode(', ', $sql) . ')';
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
-			$result = $_CLASS['core_db']-&gt;query($sql);
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$rowset[$row['bbcode_id']] = $row;
@@ -164,136 +179,164 @@
 				case 0:
 					$this-&gt;bbcode_cache[$bbcode_id] = array(
 						'str' =&gt; array(
-							'[/quote:$uid]'	=&gt;	$this-&gt;bbcode_tpl('quote_close', $bbcode_id)
+							'[/quote:$uid]'	=&gt; $this-&gt;bbcode_tpl('quote_close', $bbcode_id)
 						),
 						'preg' =&gt; array(
-							'#\[quote(?:=&quot;(.*?)&quot;)?:$uid\](.)#ise' =&gt;      &quot;\$this-&gt;bbcode_second_pass_quote('\$1', '\$2')&quot;
+							'#\[quote(?:=&quot;(.*?)&quot;)?:$uid\](.)#ise'	=&gt; &quot;\$this-&gt;bbcode_second_pass_quote('\$1', '\$2')&quot;
 						)
 					);
 				break;
 
 				case 1:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('str' =&gt; array(
-						'[b:$uid]'	=&gt;	$this-&gt;bbcode_tpl('b_open', $bbcode_id),
-						'[/b:$uid]'	=&gt;	$this-&gt;bbcode_tpl('b_close', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'str' =&gt; array(
+							'[b:$uid]'	=&gt; $this-&gt;bbcode_tpl('b_open', $bbcode_id),
+							'[/b:$uid]'	=&gt; $this-&gt;bbcode_tpl('b_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 2:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('str' =&gt; array(
-						'[i:$uid]'	=&gt;	$this-&gt;bbcode_tpl('i_open', $bbcode_id),
-						'[/i:$uid]'	=&gt;	$this-&gt;bbcode_tpl('i_close', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'str' =&gt; array(
+							'[i:$uid]'	=&gt; $this-&gt;bbcode_tpl('i_open', $bbcode_id),
+							'[/i:$uid]'	=&gt; $this-&gt;bbcode_tpl('i_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 3:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-						'#\[url:$uid\]((.*?))\[/url:$uid\]#s'		=&gt;	$this-&gt;bbcode_tpl('url', $bbcode_id),
-						'#\[url=([^\[]+?):$uid\](.*?)\[/url:$uid\]#s'	=&gt;	$this-&gt;bbcode_tpl('url', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'preg' =&gt; array(
+							'#\[url:$uid\]((.*?))\[/url:$uid\]#s'			=&gt; $this-&gt;bbcode_tpl('url', $bbcode_id),
+							'#\[url=([^\[]+?):$uid\](.*?)\[/url:$uid\]#s'	=&gt; $this-&gt;bbcode_tpl('url', $bbcode_id),
+						)
+					);
 				break;
 
 				case 4:
-					if ($_CLASS['core_user']-&gt;optionget('viewimg'))
+					if ($_CLASS['core_user']-&gt;user_data_get('viewimg'))
 					{
-						$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-							'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=&gt;	$this-&gt;bbcode_tpl('img', $bbcode_id)
-						));
+						$this-&gt;bbcode_cache[$bbcode_id] = array(
+							'preg' =&gt; array(
+								'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=&gt; $this-&gt;bbcode_tpl('img', $bbcode_id),
+							)
+						);
 					}
 					else
 					{
-						$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-							'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=&gt;	str_replace('$2', '[ img ]', $this-&gt;bbcode_tpl('url', $bbcode_id))
-						));
+						$this-&gt;bbcode_cache[$bbcode_id] = array(
+							'preg' =&gt; array(
+								'#\[img:$uid\](.*?)\[/img:$uid\]#s'		=&gt; str_replace('$2', '[ img ]', $this-&gt;bbcode_tpl('url', $bbcode_id)),
+							)
+						);
 					}
 				break;
 
 				case 5:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-						'#\[size=([\-\+]?[1-2]?[0-9]):$uid\](.*?)\[/size:$uid\]#s'	=&gt;	$this-&gt;bbcode_tpl('size', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'preg' =&gt; array(
+							'#\[size=([\-\+]?[1-2]?[0-9]):$uid\](.*?)\[/size:$uid\]#s'	=&gt; $this-&gt;bbcode_tpl('size', $bbcode_id),
+						)
+					);
 				break;
 
 				case 6:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-						'!\[color=(#[0-9A-F]{6}|[a-z\-]+):$uid\](.*?)\[/color:$uid\]!s'	=&gt;	$this-&gt;bbcode_tpl('color', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'preg' =&gt; array(
+							'!\[color=(#[0-9a-fA-F]{6}|[a-z\-]+):$uid\](.*?)\[/color:$uid\]!s'	=&gt; $this-&gt;bbcode_tpl('color', $bbcode_id),
+						)
+					);
 				break;
 
 				case 7:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('str' =&gt; array(
-						'[u:$uid]'	=&gt;	$this-&gt;bbcode_tpl('u_open', $bbcode_id),
-						'[/u:$uid]'	=&gt;	$this-&gt;bbcode_tpl('u_close', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'str' =&gt; array(
+							'[u:$uid]'	=&gt; $this-&gt;bbcode_tpl('u_open', $bbcode_id),
+							'[/u:$uid]'	=&gt; $this-&gt;bbcode_tpl('u_close', $bbcode_id),
+						)
+					);
 				break;
 
 				case 8:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-						'#\[code(?:=([a-z]+))?:$uid\](.*?)\[/code:$uid\]#ise'	=&gt;	&quot;\$this-&gt;bbcode_second_pass_code('\$1', '\$2')&quot;
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'preg' =&gt; array(
+							'#\[code(?:=([a-z]+))?:$uid\](.*?)\[/code:$uid\]#ise'	=&gt; &quot;\$this-&gt;bbcode_second_pass_code('\$1', '\$2')&quot;,
+						)
+					);
 				break;
 
 				case 9:
 					$this-&gt;bbcode_cache[$bbcode_id] = array(
 						'preg' =&gt; array(
 							'#(\[\/?(list|\*):[mou]?:?$uid\])[\n]{1}#'	=&gt; &quot;\$1&quot;,
-							'#(\[list=([^\[]+):$uid\])[\n]{1}#'	=&gt; &quot;\$1&quot;,
-							'#\[list=([^\[]+):$uid\]#e'	=&gt;	&quot;\$this-&gt;bbcode_list('\$1')&quot;,
+							'#(\[list=([^\[]+):$uid\])[\n]{1}#'			=&gt; &quot;\$1&quot;,
+							'#\[list=([^\[]+):$uid\]#e'					=&gt; &quot;\$this-&gt;bbcode_list('\$1')&quot;,
 						),
 						'str' =&gt; array(
-							'[list:$uid]'		=&gt;	$this-&gt;bbcode_tpl('ulist_open_default', $bbcode_id),
-							'[/list:u:$uid]'	=&gt;	$this-&gt;bbcode_tpl('ulist_close', $bbcode_id),
-							'[/list:o:$uid]'	=&gt;	$this-&gt;bbcode_tpl('olist_close', $bbcode_id),
-							'[*:$uid]'			=&gt;	$this-&gt;bbcode_tpl('listitem', $bbcode_id),
-							'[/*:$uid]'			=&gt;	$this-&gt;bbcode_tpl('listitem_close', $bbcode_id),
-							'[/*:m:$uid]'		=&gt;	$this-&gt;bbcode_tpl('listitem_close', $bbcode_id)
+							'[list:$uid]'		=&gt; $this-&gt;bbcode_tpl('ulist_open_default', $bbcode_id),
+							'[/list:u:$uid]'	=&gt; $this-&gt;bbcode_tpl('ulist_close', $bbcode_id),
+							'[/list:o:$uid]'	=&gt; $this-&gt;bbcode_tpl('olist_close', $bbcode_id),
+							'[*:$uid]'			=&gt; $this-&gt;bbcode_tpl('listitem', $bbcode_id),
+							'[/*:$uid]'			=&gt; $this-&gt;bbcode_tpl('listitem_close', $bbcode_id),
+							'[/*:m:$uid]'		=&gt; $this-&gt;bbcode_tpl('listitem_close', $bbcode_id)
 						),
 					);
 				break;
 
 				case 10:
-					$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-							'#\[email:$uid\]((.*?))\[/email:$uid\]#is'				=&gt;	$this-&gt;bbcode_tpl('email', $bbcode_id),
-							'#\[email=([^\[]+):$uid\](.*?)\[/email:$uid\]#is'	=&gt;	$this-&gt;bbcode_tpl('email', $bbcode_id)
-					));
+					$this-&gt;bbcode_cache[$bbcode_id] = array(
+						'preg' =&gt; array(
+							'#\[email:$uid\]((.*?))\[/email:$uid\]#is'			=&gt; $this-&gt;bbcode_tpl('email', $bbcode_id),
+							'#\[email=([^\[]+):$uid\](.*?)\[/email:$uid\]#is'	=&gt; $this-&gt;bbcode_tpl('email', $bbcode_id)
+						)
+					);
 				break;
 
 				case 11:
-					if ($_CLASS['core_user']-&gt;optionget('viewflash'))
+					if ($_CLASS['core_user']-&gt;user_data_get('viewflash'))
 					{
-						$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-							'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=&gt;	$this-&gt;bbcode_tpl('flash', $bbcode_id)
-						));
+						$this-&gt;bbcode_cache[$bbcode_id] = array(
+							'preg' =&gt; array(
+								'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=&gt; $this-&gt;bbcode_tpl('flash', $bbcode_id),
+							)
+						);
 					}
 					else
 					{
-						$this-&gt;bbcode_cache[$bbcode_id] = array('preg' =&gt; array(
-							'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=&gt;	str_replace('$1', '$3', str_replace('$2', '[ flash ]', $this-&gt;bbcode_tpl('url', $bbcode_id)))
-						));
+						$this-&gt;bbcode_cache[$bbcode_id] = array(
+							'preg' =&gt; array(
+								'#\[flash=([0-9]+),([0-9]+):$uid\](.*?)\[/flash:$uid\]#'	=&gt; str_replace('$1', '$3', str_replace('$2', '[ flash ]', $this-&gt;bbcode_tpl('url', $bbcode_id)))
+							)
+						);
 					}
 				break;
 
 				case 12:
 					$this-&gt;bbcode_cache[$bbcode_id] = array(
 						'str'	=&gt; array(
-							'[/attachment:$uid]'	=&gt; $this-&gt;bbcode_tpl('inline_attachment_close', $bbcode_id)),
+							'[/attachment:$uid]'	=&gt; $this-&gt;bbcode_tpl('inline_attachment_close', $bbcode_id)
+						),
 						'preg'	=&gt; array(
-							'#\[attachment=([0-9]+):$uid\]#'	=&gt; $this-&gt;bbcode_tpl('inline_attachment_open', $bbcode_id))
+							'#\[attachment=([0-9]+):$uid\]#'	=&gt; $this-&gt;bbcode_tpl('inline_attachment_open', $bbcode_id)
+						)
 					);
 				break;
 
 				default:
+					if (!isset($template_bitfield))
+					{
+						$template_bitfield = new bitfield($this-&gt;template_bitfield);
+					}
+
 					if (isset($rowset[$bbcode_id]))
 					{
-						if ($this-&gt;template_bitfield &amp; (1 &lt;&lt; $bbcode_id))
+						if ($template_bitfield-&gt;get($bbcode_id))
 						{
 							// The bbcode requires a custom template to be loaded
-
 							if (!$bbcode_tpl = $this-&gt;bbcode_tpl($rowset[$bbcode_id]['bbcode_tag'], $bbcode_id))
 							{
-								// For some reason, the required template seems not to be available,
-								// use the default template
-
+								// For some reason, the required template seems not to be available, use the default template
 								$bbcode_tpl = (!empty($rowset[$bbcode_id]['second_pass_replace'])) ? $rowset[$bbcode_id]['second_pass_replace'] : $rowset[$bbcode_id]['bbcode_tpl'];
 							}
 							else
@@ -301,7 +344,6 @@
 								// In order to use templates with custom bbcodes we need
 								// to replace all {VARS} to corresponding backreferences
 								// Note that backreferences are numbered from bbcode_match
-
 								if (preg_match_all('/\{(URL|EMAIL|TEXT|COLOR|NUMBER)[0-9]*\}/', $rowset[$bbcode_id]['bbcode_match'], $m))
 								{
 									foreach ($m[0] as $i =&gt; $tok)
@@ -314,17 +356,15 @@
 						else
 						{
 							// Default template
-
 							$bbcode_tpl = (!empty($rowset[$bbcode_id]['second_pass_replace'])) ? $rowset[$bbcode_id]['second_pass_replace'] : $rowset[$bbcode_id]['bbcode_tpl'];
 						}
 
 						// Replace {L_*} lang strings
-						$bbcode_tpl = preg_replace('/{L_([A-Z_]+)}/e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\$1'])) ? \$_CLASS['core_user']-&gt;lang['\$1'] : ucwords(strtolower(str_replace'_', ' ', '\$1')))&quot;, $bbcode_tpl);
+						$bbcode_tpl = preg_replace('/{L_([A-Z_]+)}/e', &quot;\$_CLASS['core_user']-&gt;get_lang('\$1')&quot;, $bbcode_tpl);
 
 						if (!empty($rowset[$bbcode_id]['second_pass_replace']))
 						{
 							// The custom BBCode requires second-pass pattern replacements
-
 							$this-&gt;bbcode_cache[$bbcode_id] = array(
 								'preg' =&gt; array($rowset[$bbcode_id]['second_pass_match'] =&gt; $bbcode_tpl)
 							);
@@ -338,43 +378,47 @@
 					}
 					else
 					{
-						$this-&gt;bbcode_cache[$bbcode_id] = FALSE;
+						$this-&gt;bbcode_cache[$bbcode_id] = false;
 					}
+				break;
 			}
 		}
 	}
 
 	function bbcode_tpl($tpl_name, $bbcode_id = -1)
 	{
+		global $_CLASS;
+
 		if (empty($bbcode_hardtpl))
 		{
-			static $bbcode_hardtpl = array(
-				'b_open'	=&gt;	'&lt;span style=&quot;font-weight: bold&quot;&gt;',
-				'b_close'	=&gt;	'&lt;/span&gt;',
-				'i_open'	=&gt;	'&lt;span style=&quot;font-style: italic&quot;&gt;',
-				'i_close'	=&gt;	'&lt;/span&gt;',
-				'u_open'	=&gt;	'&lt;span style=&quot;text-decoration: underline&quot;&gt;',
-				'u_close'	=&gt;	'&lt;/span&gt;',
-				'img'		=&gt;	'&lt;img src=&quot;$1&quot; border=&quot;0&quot; /&gt;',
-				'size'		=&gt;	'&lt;span style=&quot;font-size: $1px; line-height: normal&quot;&gt;$2&lt;/span&gt;',
-				'color'		=&gt;	'&lt;span style=&quot;color: $1&quot;&gt;$2&lt;/span&gt;',
-				'email'		=&gt;	'&lt;a href=&quot;mailto:$1&quot;&gt;$2&lt;/a&gt;'
+			static $bbcode_hardtpl = array();
+
+			$bbcode_hardtpl = array(
+				'b_open'	=&gt; '&lt;span style=&quot;font-weight: bold&quot;&gt;',
+				'b_close'	=&gt; '&lt;/span&gt;',
+				'i_open'	=&gt; '&lt;span style=&quot;font-style: italic&quot;&gt;',
+				'i_close'	=&gt; '&lt;/span&gt;',
+				'u_open'	=&gt; '&lt;span style=&quot;text-decoration: underline&quot;&gt;',
+				'u_close'	=&gt; '&lt;/span&gt;',
+				'img'		=&gt; '&lt;img src=&quot;$1&quot; alt=&quot;' . $_CLASS['core_user']-&gt;get_lang('IMAGE') . '&quot; /&gt;',
+				'size'		=&gt; '&lt;span style=&quot;font-size: $1px; line-height: normal&quot;&gt;$2&lt;/span&gt;',
+				'color'		=&gt; '&lt;span style=&quot;color: $1&quot;&gt;$2&lt;/span&gt;',
+				'email'		=&gt; '&lt;a href=&quot;mailto:$1&quot;&gt;$2&lt;/a&gt;'
 			);
+			$template_bitfield = new bitfield($this-&gt;template_bitfield);
 		}
 
-		if ($bbcode_id != -1 &amp;&amp; !($this-&gt;template_bitfield &amp; (1 &lt;&lt; $bbcode_id)))
+		if ($bbcode_id != -1 &amp;&amp; !$template_bitfield-&gt;get($bbcode_id))
 		{
 			return (isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : FALSE;
 		}
 
 		if (empty($this-&gt;bbcode_template))
 		{
-			if (!($fp = @fopen($this-&gt;template_filename, 'rb')))
+			if (($tpl = file_get_contents($this-&gt;template_filename)) === false)
 			{
-				trigger_error('Could not load bbcode template');
+				trigger_error('Could not load bbcode template', E_USER_ERROR);
 			}
-			$tpl = fread($fp, filesize($this-&gt;template_filename));
-			@fclose($fp);
 
 			// replace \ with \\ and then ' with \'.
 			$tpl = str_replace('\\', '\\\\', $tpl);
@@ -384,30 +428,42 @@
 			$tpl = preg_replace(&quot;/\n[\n\r\s\t]*/&quot;, '', $tpl);
 
 			// Turn template blocks into PHP assignment statements for the values of $bbcode_tpl..
-			$tpl = preg_replace('#&lt;!-- BEGIN (.*?) --&gt;(.*?)&lt;!-- END (.*?) --&gt;#', &quot;\n&quot; . &quot;\$this-&gt;bbcode_template['\$1'] = \$this-&gt;bbcode_tpl_replace('\$1','\$2');&quot;, $tpl);
+			$this-&gt;bbcode_template = array();
 
-			$this-&gt;bbcode_template = array();
-			eval($tpl);
+			$matches = preg_match_all('#&lt;!-- BEGIN (.*?) --&gt;(.*?)&lt;!-- END (?:.*?) --&gt;#', $tpl, $match);
+
+			for ($i = 0; $i &lt; $matches; $i++)
+			{
+				if (empty($match[1][$i]))
+				{
+					continue;
+				}
+
+				$this-&gt;bbcode_template[$match[1][$i]] = $this-&gt;bbcode_tpl_replace($match[1][$i], $match[2][$i]);
+			}
 		}
 
-		return (isset($this-&gt;bbcode_template[$tpl_name])) ? $this-&gt;bbcode_template[$tpl_name] : ((isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : FALSE);
+		return (isset($this-&gt;bbcode_template[$tpl_name])) ? $this-&gt;bbcode_template[$tpl_name] : ((isset($bbcode_hardtpl[$tpl_name])) ? $bbcode_hardtpl[$tpl_name] : false);
 	}
-	
+
+	/**
+	* Return bbcode template replacement
+	*/
 	function bbcode_tpl_replace($tpl_name, $tpl)
 	{
 		global $_CLASS;
 		
 		static $replacements = array(
-			'quote_username_open'	=&gt;	array('{USERNAME}'	=&gt;	'$1'),
-			'color'					=&gt;	array('{COLOR}'		=&gt;	'$1', '{TEXT}'			=&gt;	'$2'),
-			'size'					=&gt;	array('{SIZE}'		=&gt;	'$1', '{TEXT}'			=&gt;	'$2'),
-			'img'					=&gt;	array('{URL}'		=&gt;	'$1'),
-			'flash'					=&gt;	array('{WIDTH}'		=&gt;	'$1', '{HEIGHT}'		=&gt;	'$2', '{URL}'	=&gt;	'$3'),
-			'url'					=&gt;	array('{URL}'		=&gt;	'$1', '{DESCRIPTION}'	=&gt;	'$2'),
-			'email'					=&gt;	array('{EMAIL}'		=&gt;	'$1', '{DESCRIPTION}'	=&gt;	'$2')
+			'quote_username_open'	=&gt; array('{USERNAME}'	=&gt; '$1'),
+			'color'					=&gt; array('{COLOR}'		=&gt; '$1', '{TEXT}'			=&gt; '$2'),
+			'size'					=&gt; array('{SIZE}'		=&gt; '$1', '{TEXT}'			=&gt; '$2'),
+			'img'					=&gt; array('{URL}'		=&gt; '$1'),
+			'flash'					=&gt; array('{WIDTH}'		=&gt; '$1', '{HEIGHT}'			=&gt; '$2', '{URL}'	=&gt; '$3'),
+			'url'					=&gt; array('{URL}'		=&gt; '$1', '{DESCRIPTION}'	=&gt; '$2'),
+			'email'					=&gt; array('{EMAIL}'		=&gt; '$1', '{DESCRIPTION}'	=&gt; '$2')
 		);
 
-		$tpl = preg_replace('/{L_([A-Z_]+)}/e', &quot;(!empty(\$_CLASS['core_user']-&gt;lang['\$1'])) ? \$_CLASS['core_user']-&gt;lang['\$1'] : ucwords(strtolower(str_replace('_', ' ', '\$1')))&quot;, $tpl);
+		$tpl = preg_replace('/{L_([A-Z_]+)}/e', &quot;\$_CLASS['core_user']-&gt;get_lang('\$1')&quot;, $tpl);
 
 		if (!empty($replacements[$tpl_name]))
 		{
@@ -416,7 +472,10 @@
 
 		return trim($tpl);
 	}
-	
+
+	/**
+	* Second parse list bbcode
+	*/
 	function bbcode_list($type)
 	{
 		if ($type == '')
@@ -471,11 +530,15 @@
 		return str_replace('{LIST_TYPE}', $type, $this-&gt;bbcode_tpl($tpl));
 	}
 
+	/**
+	* Second parse quote tag
+	*/
 	function bbcode_second_pass_quote($username, $quote)
 	{
 		// when using the /e modifier, preg_replace slashes double-quotes but does not
 		// seem to slash anything else
 		$quote = str_replace('\&quot;', '&quot;', $quote);
+		$username = str_replace('\&quot;', '&quot;', $username);
 
 		// remove newline at the beginning
 		if ($quote{0} == &quot;\n&quot;)
@@ -487,7 +550,10 @@
 
 		return $quote;
 	}
-	
+
+	/**
+	* Second parse code tag
+	*/
 	function bbcode_second_pass_code($type, $code)
 	{
 		// when using the /e modifier, preg_replace slashes double-quotes but does not
@@ -503,16 +569,19 @@
 					$code = substr($code, 41);
 				}
 
+			// no break;
+
 			default:
 				$code = str_replace(&quot;\t&quot;, '&nbsp; &nbsp;', $code);
 				$code = str_replace('  ', '&nbsp; ', $code);
 				$code = str_replace('  ', ' &nbsp;', $code);
 
 				// remove newline at the beginning
-				if ($code{0} == &quot;\n&quot;)
+				if (!empty($code) &amp;&amp; $code{0} == &quot;\n&quot;)
 				{
 					$code = substr($code, 1);
 				}
+			break;
 		}
 
 		$code = $this-&gt;bbcode_tpl('code_open') . $code . $this-&gt;bbcode_tpl('code_close');

Modified: cms/trunk/includes/forums/functions.php
===================================================================
--- cms/trunk/includes/forums/functions.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -543,7 +543,7 @@
 					'notify_type' =&gt; 0
 				);
 
-				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' '.$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_array));
+				$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, FORUMS_WATCH_TABLE);
 			}
 
 			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link(&quot;Forums&amp;file=view$mode&amp;$url&amp;start=$start&quot;));
@@ -660,17 +660,20 @@
 
 				if ($sql_insert = array_diff($forum_id, $update_array))
 				{
+					$sql_array = array();
+
 					foreach ($sql_insert as $forum_id)
 					{
-						$sql_ary = array(
+						$sql_array[] = array(
 							'user_id'		=&gt; $_CLASS['core_user']-&gt;data['user_id'],
 							'topic_id'		=&gt; 0,
 							'forum_id'		=&gt; $forum_id,
 							'mark_time'		=&gt; $time
 						);
-
-						$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
 					}
+	
+					$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_array, FORUMS_TRACK_TABLE);
+					unset($sql_array);
 				}
 			}
 			else
@@ -708,14 +711,15 @@
 
 				if (!$_CLASS['core_db']-&gt;query($sql) || !$_CLASS['core_db']-&gt;affected_rows())
 				{
-					$sql_ary = array(
+					$sql_array = array(
 						'user_id'		=&gt; $_CLASS['core_user']-&gt;data['user_id'],
 						'topic_id'		=&gt; $topic_id,
 						'forum_id'		=&gt; $forum_id,
 						'mark_time'		=&gt; $time
 					);
 
-					$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_TRACK_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_ary));
+					$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, FORUMS_TRACK_TABLE);
+					unset($sql_array);
 				}
 			}
 			else
@@ -1327,4 +1331,217 @@
 	));
 }
 
+// Logging functions
+function add_log()
+{
+	global $_CLASS;
+
+	$args = func_get_args();
+
+	$mode			= array_shift($args);
+	$reportee_id	= ($mode === 'user') ? (int) array_shift($args) : '';
+	$forum_id		= ($mode === 'mod') ? (int) array_shift($args) : '';
+	$topic_id		= ($mode === 'mod') ? (int) array_shift($args) : '';
+	$action			= array_shift($args);
+	$data			= empty($args) ? '' : serialize($args);
+
+	$sql_array = array(
+		'user_id'		=&gt; empty($_CLASS['core_user']-&gt;data['user_id']) ? ANONYMOUS : $_CLASS['core_user']-&gt;data['user_id'],
+		'log_ip'		=&gt; $_CLASS['core_user']-&gt;ip,
+		'log_time'		=&gt; $_CLASS['core_user']-&gt;time,
+		'log_operation'	=&gt; $action,
+		'log_data'		=&gt; $data,
+	);
+
+	switch ($mode)
+	{
+		case 'admin':
+			$sql_array['log_type'] = LOG_ADMIN;
+		break;
+		
+		case 'mod':
+			$sql_array += array(
+				'log_type'	=&gt; LOG_MOD,
+				'forum_id'	=&gt; $forum_id,
+				'topic_id'	=&gt; $topic_id
+			);
+		break;
+
+		case 'user':
+			$sql_array += array(
+				'log_type'		=&gt; LOG_USERS,
+				'reportee_id'	=&gt; $reportee_id
+			);
+		break;
+
+		case 'critical':
+			$sql_array['log_type'] = LOG_CRITICAL;
+		break;
+		
+		default:
+			return false;
+		break;
+	}
+
+	$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_array, FORUMS_LOG_TABLE);
+
+	return $_CLASS['core_db']-&gt;insert_id(FORUMS_LOG_TABLE, 'log_id');
+}
+
+/**
+*/
+class bitfield
+{
+	var $data;
+
+	function bitfield($bitfield = '')
+	{
+		$this-&gt;data = base64_decode($bitfield);
+	}
+
+	/**
+	*/
+	function get($n)
+	{
+		// Get the ($n / 8)th char
+		$byte = $n &gt;&gt; 3;
+
+		if (!isset($this-&gt;data[$byte]))
+		{
+			// Of course, if it doesn't exist then the result if FALSE
+			return false;
+		}
+
+		$c = $this-&gt;data[$byte];
+
+		// Lookup the ($n % 8)th bit of the byte
+		$bit = 7 - ($n &amp; 7);
+		return (bool) (ord($c) &amp; (1 &lt;&lt; $bit));
+	}
+
+	function set($n)
+	{
+		$byte = $n &gt;&gt; 3;
+		$bit = 7 - ($n &amp; 7);
+
+		if (isset($this-&gt;data[$byte]))
+		{
+			$this-&gt;data[$byte] = $this-&gt;data[$byte] | chr(1 &lt;&lt; $bit);
+		}
+		else
+		{
+			if ($byte - strlen($this-&gt;data) &gt; 0)
+			{
+				$this-&gt;data .= str_repeat(&quot;\0&quot;, $byte - strlen($this-&gt;data));
+			}
+			$this-&gt;data .= chr(1 &lt;&lt; $bit);
+		}
+	}
+
+	function clear($n)
+	{
+		$byte = $n &gt;&gt; 3;
+
+		if (!isset($this-&gt;data[$byte]))
+		{
+			return;
+		}
+
+		$bit = 7 - ($n &amp; 7);
+		$this-&gt;data[$byte] = $this-&gt;data[$byte] &amp;~ chr(1 &lt;&lt; $bit);
+	}
+
+	function get_blob()
+	{
+		return $this-&gt;data;
+	}
+
+	function get_base64()
+	{
+		return base64_encode($this-&gt;data);
+	}
+
+	function get_bin()
+	{
+		$bin = '';
+		$len = strlen($this-&gt;data);
+
+		for ($i = 0; $i &lt; $len; ++$i)
+		{
+			$bin .= str_pad(decbin(ord($this-&gt;data[$i])), 8, '0', STR_PAD_LEFT);
+		}
+
+		return $bin;
+	}
+
+	function get_all_set()
+	{
+		return array_keys(array_filter(str_split($this-&gt;get_bin())));
+	}
+
+	function merge($bitfield)
+	{
+		$this-&gt;data = $this-&gt;data | $bitfield-&gt;get_blob();
+	}
+}
+
+/**
+* This function returns a regular expression pattern for commonly used expressions
+* Use with / as delimiter
+* mode can be: email|
+*/
+function get_preg_expression($mode)
+{
+	switch ($mode)
+	{
+		case 'email':
+			return '[a-z0-9&amp;\'\.\-_\+]+@[a-z0-9\-]+\.([a-z0-9\-]+\.)*?[a-z]+';
+		break;
+	}
+
+	return '';
+}
+
+/**
+* make_clickable function
+*
+* Replace magic urls of form <A HREF="http://xxx.xxx.,">http://xxx.xxx.,</A> www.xxx. and <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">xxx at xxx.xxx.</A>
+* Cuts down displayed size of link if over 50 chars, turns absolute links
+* into relative versions when the server/script path matches the link
+*/
+function make_clickable($text, $server_url = false)
+{
+	if ($server_url === false)
+	{
+		$server_url = generate_board_url();
+	}
+
+	static $magic_url_match;
+	static $magic_url_replace;
+
+	if (!is_array($magic_url_match))
+	{
+		$magic_url_match = $magic_url_replace = array();
+		// Be sure to not let the matches cross over. ;)
+
+		// relative urls for this board
+		$magic_url_match[] = '#(^|[\n ]|\()(' . preg_quote($server_url, '#') . ')/(([^[ \t\n\r&lt;&quot;\'\)&amp;]+|&amp;(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = &quot;'\$1&lt;!-- l --&gt;&lt;a href=\&quot;\$2/' . preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\\1', '\$3') . '\&quot;&gt;' . preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\\1', '\$3') . '&lt;/a&gt;&lt;!-- l --&gt;'&quot;;
+
+		// matches a <A HREF="xxxx://aaaaa.bbb.cccc.">xxxx://aaaaa.bbb.cccc.</A> ...
+		$magic_url_match[] = '#(^|[\n ]|\()([\w]+:/{2}.*?([^[ \t\n\r&lt;&quot;\'\)&amp;]+|&amp;(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = &quot;'\$1&lt;!-- m --&gt;&lt;a href=\&quot;\$2\&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- m --&gt;'&quot;;
+
+		// matches a &quot;www.xxxx.yyyy[/zzzz]&quot; kinda lazy URL thing
+		$magic_url_match[] = '#(^|[\n ]|\()(w{3}\.[\w\-]+\.[\w\-.\~]+(?:[^[ \t\n\r&lt;&quot;\'\)&amp;]+|&amp;(?!lt;|quot;))*)#ie';
+		$magic_url_replace[] = &quot;'\$1&lt;!-- w --&gt;&lt;a href=\&quot;<A HREF="http://\$2\">http://\$2\</A>&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- w --&gt;'&quot;;
+
+		// matches an <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">email at domain</A> type address at the start of a line, or after a space or after what might be a BBCode.
+		$magic_url_match[] = '/(^|[\n ]|\()(' . get_preg_expression('email') . ')/ie';
+		$magic_url_replace[] = &quot;'\$1&lt;!-- e --&gt;&lt;a href=\&quot;mailto:\$2\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr('\$2', 0, 39) . ' ... ' . substr('\$2', -10) : '\$2') . '&lt;/a&gt;&lt;!-- e --&gt;'&quot;;
+	}
+
+	return preg_replace($magic_url_match, $magic_url_replace, $text);
+}
+
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_admin.php
===================================================================
--- cms/trunk/includes/forums/functions_admin.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_admin.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -59,7 +59,7 @@
 
 		$right = $row['right_id'];
 
-		if ($acl &amp;&amp; !$_CLASS['auth']-&gt;acl_gets($acl, $row['forum_id']))
+		if ($acl &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_gets($acl, $row['forum_id']))
 		{
 			continue;
 		}
@@ -91,6 +91,8 @@
 			$forum_list .= '&lt;option value=&quot;' . $row['forum_id'] . '&quot;' . $selected . '&gt;' . $padding . $row['forum_name'] . '&lt;/option&gt;';
 		}
 	}
+	$_CLASS['core_db']-&gt;free_result();
+
 	unset($padding_store);
 
 	return $forum_list;
@@ -149,7 +151,7 @@
 			continue;
 		}
 
-		if (!$acl_list || $_CLASS['auth']-&gt;acl_gets($acl_list, $row['forum_id']))
+		if (!$acl_list || $_CLASS['forums_auth']-&gt;acl_gets($acl_list, $row['forum_id']))
 		{
 			$rowset[] = ($id_only) ? $row['forum_id'] : $row;
 		}
@@ -158,7 +160,7 @@
 	return $rowset;
 }
 
-function get_forum_branch($forum_id, $type = 'all', $order = 'descending', $include_forum = TRUE)
+function get_forum_branch($forum_id, $type = 'all', $order = 'descending', $include_forum = true)
 {
 	global $_CLASS;
 
@@ -204,15 +206,20 @@
 	$matches = array();
 
 	// Remove initial / if present
-	$rootdir = (substr($rootdir, 0, 1) == '/') ? substr($rootdir, 1) : $rootdir;
+	$rootdir = (substr($rootdir, 0, 1) === '/') ? substr($rootdir, 1) : $rootdir;
 	// Add closing / if present
-	$rootdir = ($rootdir &amp;&amp; substr($rootdir, -1) != '/') ? $rootdir . '/' : $rootdir;
+	$rootdir = ($rootdir &amp;&amp; substr($rootdir, -1) !== '/') ? $rootdir . '/' : $rootdir;
 
 	// Remove initial / if present
-	$dir = (substr($dir, 0, 1) == '/') ? substr($dir, 1) : $dir;
+	$dir = (substr($dir, 0, 1) === '/') ? substr($dir, 1) : $dir;
 	// Add closing / if present
-	$dir = ($dir &amp;&amp; substr($dir, -1) != '/') ? $dir . '/' : $dir;
+	$dir = ($dir &amp;&amp; substr($dir, -1) !== '/') ? $dir . '/' : $dir;
 
+	if (!is_dir($rootdir . $dir))
+	{
+		return false;
+	}
+
 	$dh = opendir($rootdir . $dir);
 	while (($fname = readdir($dh)) !== false)
 	{
@@ -223,7 +230,7 @@
 				$matches[$dir][] = $fname;
 			}
 		}
-		else if ($fname{0} != '.' &amp;&amp; is_dir(&quot;$rootdir$dir$fname&quot;))
+		else if ($fname{0} !== '.' &amp;&amp; is_dir(&quot;$rootdir$dir$fname&quot;))
 		{
 			$matches += filelist($rootdir, &quot;$dir$fname&quot;, $type);
 		}
@@ -238,6 +245,13 @@
 {
 	global $_CLASS;
 
+	if (empty($topic_ids))
+	{
+		return;
+	}
+
+	$_CLASS['core_db']-&gt;transaction();
+
 	$forum_ids = array($forum_id);
 	$sql_where = is_array($topic_ids) ? 'IN (' . implode(', ', $topic_ids) . ')' : '= ' . $topic_ids;
 
@@ -260,11 +274,8 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
-	$_CLASS['core_db']-&gt;transaction();
+	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE, FORUMS_DRAFTS_TABLE);
 
-	//$table_ary = array(FORUMS_FORUMS_TABLE, FORUMS_POLL_OPTIONS_TABLE, , FORUMS_TOPICS_TABLE);
-	$table_ary = array(FORUMS_TOPICS_TABLE, FORUMS_POSTS_TABLE, FORUMS_TRACK_TABLE, FORUMS_WATCH_TABLE, FORUMS_LOG_TABLE);
-
 	foreach ($table_ary as $table)
 	{
 		$sql = &quot;UPDATE $table
@@ -280,6 +291,7 @@
 	{
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
+	unset($forum_ids);
 }
 
 function move_posts($post_ids, $topic_id, $auto_sync = true)
@@ -291,37 +303,38 @@
 		$post_ids = array($post_ids);
 	}
 
-	if ($auto_sync)
-	{
-		$forum_ids = array();
-		$topic_ids = array($topic_id);
-
-		$sql = 'SELECT DISTINCT topic_id, forum_id
-			FROM ' . FORUMS_POSTS_TABLE . '
-			WHERE post_id IN (' . implode(', ', $post_ids) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$forum_ids[] = $row['forum_id'];
-			$topic_ids[] = $row['topic_id'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-
 	$sql = 'SELECT forum_id 
 		FROM ' . FORUMS_TOPICS_TABLE . ' 
 		WHERE topic_id = ' . $topic_id;
 	$result = $_CLASS['core_db']-&gt;query($sql);
+	$forum_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
-	if (!$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	if (!$forum_row)
 	{
 		trigger_error('NO_TOPIC');
 	}
+
+	$forum_ids = array($forum_row['forum_id']);
+	$topic_ids = array($topic_id);
+
+	$sql = 'SELECT DISTINCT topic_id, forum_id
+		FROM ' . FORUMS_POSTS_TABLE . '
+		WHERE post_id IN (' . implode(', ', $post_ids) . ')';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		$forum_ids[] = $row['forum_id'];
+		$topic_ids[] = $row['topic_id'];
+	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
+	$forum_ids = array_unique($forum_ids);
+	$topic_ids = array_unique($topic_ids);
+
 	$sql = 'UPDATE ' . FORUMS_POSTS_TABLE . '
-		SET forum_id = ' . $row['forum_id'] . &quot;, topic_id = $topic_id
+		SET forum_id = ' . $forum_row['forum_id'] . &quot;, topic_id = $topic_id
 		WHERE post_id IN (&quot; . implode(', ', $post_ids) . ')';
 	$_CLASS['core_db']-&gt;query($sql);
 
@@ -332,17 +345,21 @@
 
 	if ($auto_sync)
 	{
-		$forum_ids[] = $row['forum_id'];
-
 		sync('reported', 'topic_id', $topic_ids);
 		sync('topic', 'topic_id', $topic_ids, true);
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
+
+	// Update posted informations
+	update_posted_info($topic_ids);
 }
 
+/**
+* Remove topic(s)
+*/
 function delete_topics($where_type, $where_ids, $auto_sync = true)
 {
-	global $_CLASS;
+	global $_CLASS, $config;
 
 	$forum_ids = $topic_ids = array();
 
@@ -357,7 +374,7 @@
 	}
 
 	$return = array(
-		'posts'	=&gt;	delete_posts($where_type, $where_ids, false)
+		'posts'	=&gt;	delete_posts($where_type, $where_ids, false, true)
 	);
 
 	$sql = 'SELECT topic_id, forum_id
@@ -379,8 +396,6 @@
 		return $return;
 	}
 
-	// TODO: probably some other stuff too
-
 	$sql_where = ' IN (' . implode(', ', $topic_ids) . ')';
 
 	$_CLASS['core_db']-&gt;transaction();
@@ -407,6 +422,8 @@
 		sync('topic_reported', $where_type, $where_ids);
 	}
 
+	set_config('num_topics', $config['num_topics'] - count($return['topics']), true);
+
 	return $return;
 }
 
@@ -424,9 +441,9 @@
 		return false;
 	}
 
-	$post_ids = $topic_ids = $forum_ids = array();
+	$post_ids = $topic_ids = $forum_ids = $post_counts = array();
 
-	$sql = 'SELECT post_id, topic_id, forum_id
+	$sql = 'SELECT post_id, poster_id, post_postcount, topic_id, forum_id
 		FROM ' . FORUMS_POSTS_TABLE . &quot;
 		WHERE $where_type &quot; . ((!is_array($where_ids)) ? &quot;= $where_ids&quot; : 'IN (' . implode(', ', $where_ids) . ')');
 	$result = $_CLASS['core_db']-&gt;query($sql);
@@ -434,9 +451,16 @@
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$post_ids[] = $row['post_id'];
+		$poster_ids[] = $row['poster_id'];
 		$topic_ids[] = $row['topic_id'];
 		$forum_ids[] = $row['forum_id'];
+		
+		if ($row['post_postcount'])
+		{
+			$post_counts[$row['poster_id']] = (!empty($post_counts[$row['poster_id']])) ? $post_counts[$row['poster_id']] + 1 : 1;
+		}
 	}
+	$_CLASS['core_db']-&gt;free_result();
 
 	if (empty($post_ids))
 	{
@@ -447,9 +471,8 @@
 
 	$_CLASS['core_db']-&gt;transaction();
 
-	//$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
-	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_SEARCH_MATCH_TABLE);
-	
+	$table_ary = array(FORUMS_POSTS_TABLE, FORUMS_REPORTS_TABLE);
+
 	foreach ($table_ary as $table)
 	{
 		$sql = &quot;DELETE FROM $table 
@@ -458,17 +481,57 @@
 	}
 	unset($table_ary);
 
+	// Adjust users post counts
+	if (!empty($post_counts))
+	{
+		foreach ($post_counts as $poster_id =&gt; $substract)
+		{
+			$sql = 'UPDATE ' . CORE_USERS_TABLE . '
+				SET user_posts = user_posts - ' . $substract . '
+				WHERE user_id = ' . $poster_id;
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+	}
+
+	// Remove the message from the search index
+	$search_type = basename($config['search_type']);
+
+	if (!file_exists(SITE_FILE_ROOT.'includes/forums/search/', $search_type,'.php'))
+	{
+		trigger_error('NO_SUCH_SEARCH_MODULE');
+	}
+
+	require_once SITE_FILE_ROOT.'includes/forums/search/'.$search_type.'.php';
+
+	$error = false;
+	$search = new $search_type($error);
+
+	if ($error)
+	{
+		trigger_error($error);
+	}
+
+	$search-&gt;index_remove($post_ids, $poster_ids, $forum_ids);
+
 	delete_attachments('post', $post_ids, false);
 
 	$_CLASS['core_db']-&gt;transaction('commit');
 
+	// Resync topics_posted table
+	if ($posted_sync)
+	{
+		update_posted_info($topic_ids);
+	}
+
 	if ($auto_sync)
 	{
-		sync('reported', 'topic_id', $topic_ids);
+		sync('topic_reported', $where_type, $where_ids);
 		sync('topic', 'topic_id', $topic_ids, true);
 		sync('forum', 'forum_id', $forum_ids, true);
 	}
 
+	set_config('num_posts', $config['num_posts'] - sizeof($post_ids), true);
+
 	return count($post_ids);
 }
 
@@ -476,26 +539,30 @@
 // mode =&gt; (post, topic, attach, user)
 // ids =&gt; (post_ids, topic_ids, attach_ids, user_ids)
 // resync =&gt; set this to false if you are deleting posts or topics...
-function delete_attachments($mode, $ids, $resync = TRUE)
+function delete_attachments($mode, $ids, $resync = true)
 {
 	global $_CLASS, $config;
 
 	if (is_array($ids))
 	{
-		$ids = array_unique($ids);
+		$ids = array_unique(array_map('intval', $ids));
 	}
-	
+	else
+	{
+		$ids = array((int) $ids);
+	}
+
 	if (empty($ids))
 	{
 		return false;
 	}
-
+
 	$sql_id = ($mode == 'user') ? 'poster_id' : (($mode == 'post') ? 'post_msg_id' : (($mode == 'topic') ? 'topic_id' : 'attach_id'));
 
 	$post_ids = $topic_ids = $physical = array();
 
 	// Collect post and topics ids for later use
-	if ($mode == 'attach' || $mode == 'user' || ($mode == 'topic' &amp;&amp; $resync))
+	if ($mode === 'attach' || $mode === 'user' || ($mode === 'topic' &amp;&amp; $resync))
 	{
 		$sql = 'SELECT post_msg_id as post_id, topic_id, physical_filename, thumbnail, filesize
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -511,7 +578,7 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
-	if ($mode == 'post')
+	if ($mode === 'post')
 	{
 		$sql = 'SELECT topic_id, physical_filename, thumbnail, filesize
 			FROM ' . FORUMS_ATTACHMENTS_TABLE . '
@@ -528,7 +595,8 @@
 	}
 
 	// Delete attachments
-	$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
+	$_CLASS['core_db']-&gt;query('DELETE FROM ' . FORUMS_ATTACHMENTS_TABLE . ' 
+			WHERE ' . $sql_id . ' IN (' . implode(', ', $ids) . ')');
 	$num_deleted = $_CLASS['core_db']-&gt;affected_rows();
 
 	if (!$num_deleted)
@@ -572,14 +640,14 @@
 	// Update post indicators
 	if (!empty($post_ids))
 	{
-		if ($mode == 'post' || $mode == 'topic')
+		if ($mode === 'post' || $mode === 'topic')
 		{
 			$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
 				SET post_attachment = 0
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')');
 		}
 
-		if ($mode == 'user' || $mode == 'attach')
+		if ($mode === 'user' || $mode === 'attach')
 		{
 			$remaining = array();
 
@@ -596,6 +664,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			$unset_ids = array_diff($post_ids, $remaining);
+	
 			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_POSTS_TABLE . ' 
@@ -630,14 +699,14 @@
 	if (!empty($topic_ids))
 	{
 		// Update topic indicator
-		if ($mode == 'topic')
+		if ($mode === 'topic')
 		{
 			$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . '
 				SET topic_attachment = 0
 				WHERE topic_id IN (' . implode(', ', $topic_ids) . ')');
 		}
 
-		if ($mode == 'post' || $mode == 'user' || $mode == 'attach')
+		if ($mode === 'post' || $mode === 'user' || $mode === 'attach')
 		{
 			$remaining = array();
 
@@ -653,6 +722,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			$unset_ids = array_diff($topic_ids, $remaining);
+
 			if (!empty($unset_ids))
 			{
 				$_CLASS['core_db']-&gt;query('UPDATE ' . FORUMS_TOPICS_TABLE . ' 
@@ -666,8 +736,10 @@
 }
 
 
-// FIX
-function delete_topic_shadows($max_age, $forum_id = '', $auto_sync = TRUE)
+/**
+* Remove topic shadows
+*/
+function delete_topic_shadows($max_age, $forum_id = '', $auto_sync = true)
 {
 	global $_CLASS;
 
@@ -680,7 +752,7 @@
 			$sql = 'DELETE t.*
 				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time &lt; ' . (gmtime() - $max_age)
+					AND t.topic_time &lt; ' . ($_CLASS['core_user']-&gt;time - $max_age)
 				. $where;
 			$_CLASS['core_db']-&gt;query($sql);
 		break;
@@ -689,7 +761,7 @@
 			$sql = 'SELECT t.topic_id
 				FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_TOPICS_TABLE . ' t2
 				WHERE t.topic_moved_id = t2.topic_id
-					AND t.topic_time &lt; ' . (gmtime() - $max_age)
+					AND t.topic_time &lt; ' . ($_CLASS['core_user']-&gt;time - $max_age)
 				. $where;
 			$result = $_CLASS['core_db']-&gt;query($sql);
 			
@@ -705,15 +777,86 @@
 					WHERE topic_id IN (' . implode(',', $topic_ids) . ')';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
+		break;
 	}
 
 	if ($auto_sync)
 	{
 		$where_type = ($forum_id) ? 'forum_id' : '';
-		sync('forum', $where_type, $forum_id, TRUE);
+		sync('forum', $where_type, $forum_id, true);
 	}
 }
 
+/**
+* Update/Sync posted informations for topics
+*/
+function update_posted_info(&amp;$topic_ids)
+{
+	return;
+
+	global $db, $config;
+
+	if (empty($topic_ids) || !$config['load_db_track'])
+	{
+		return;
+	}
+
+	// First of all, let us remove any posted information for these topics
+	$sql = 'DELETE FROM ' . TOPICS_POSTED_TABLE . '
+		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
+	$db-&gt;sql_query($sql);
+
+	// Now, let us collect the user/topic combos for rebuilding the information
+	$sql = 'SELECT poster_id, topic_id
+		FROM ' . POSTS_TABLE . '
+		WHERE topic_id IN (' . implode(', ', $topic_ids) . ')
+			AND poster_id &lt;&gt; ' . ANONYMOUS . '
+		GROUP BY poster_id, topic_id';
+	$result = $db-&gt;sql_query($sql);
+
+	$posted = array();
+	while ($row = $db-&gt;sql_fetchrow($result))
+	{
+		// Add as key to make them unique (grouping by) and circumvent empty keys on array_unique
+		$posted[$row['poster_id']][] = $row['topic_id'];
+	}
+	$db-&gt;sql_freeresult($result);
+
+	// Now add the information...
+	$sql_ary = array();
+	foreach ($posted as $user_id =&gt; $topic_row)
+	{
+		foreach ($topic_row as $topic_id)
+		{
+			$sql_ary[] = array(
+				'user_id'		=&gt; $user_id,
+				'topic_id'		=&gt; $topic_id,
+				'topic_posted'	=&gt; 1,
+			);
+		}
+	}
+	unset($posted);
+
+	if (sizeof($sql_ary))
+	{
+		switch (SQL_LAYER)
+		{
+			case 'mysql':
+			case 'mysql4':
+			case 'mysqli':
+				$db-&gt;sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $db-&gt;sql_build_array('MULTI_INSERT', $sql_ary));
+			break;
+
+			default:
+				foreach ($sql_ary as $ary)
+				{
+					$db-&gt;sql_query('INSERT INTO ' . TOPICS_POSTED_TABLE . ' ' . $db-&gt;sql_build_array('INSERT', $ary));
+				}
+			break;
+		}
+	}
+}
+
 // Delete File
 function phpbb_unlink($filename, $mode = 'file')
 {
@@ -724,43 +867,48 @@
 	return @unlink($filename);
 }
 
-// All-encompasing sync function
-//
-// Usage:
-// sync('topic', 'topic_id', 123);			&lt;= resync topic #123
-// sync('topic', 'forum_id', array(2, 3));	&lt;= resync topics from forum #2 and #3
-// sync('topic');							&lt;= resync all topics
-// sync('topic', 'range', 'topic_id BETWEEN 1 AND 60');	&lt;= resync a range of topics/forums (only available for 'topic' and 'forum' modes)
-//
-// Modes:
-// - topic_moved		Removes topic shadows that would be in the same forum as the topic they link to
-// - topic_approved		Resyncs the topic_approved flag according to the status of the first post
-// - post_reported		Resyncs the post_reported flag, relying on actual reports
-// - topic_reported		Resyncs the topic_reported flag, relying on post_reported flags
-// - post_attachement	Same as post_reported, thanks to a quick Search/Replace
-// - topic_attachement	Same as topic_reported, thanks to a quick Search/Replace
-//
-function sync($mode, $where_type = '', $where_ids = '', $resync_parents = FALSE, $sync_extra = FALSE)
+/**
+* All-encompasing sync function
+*
+* Exaples:
+* &lt;code&gt;
+* sync('topic', 'topic_id', 123);			// resync topic #123
+* sync('topic', 'forum_id', array(2, 3));	// resync topics from forum #2 and #3
+* sync('topic');							// resync all topics
+* sync('topic', 'range', 'topic_id BETWEEN 1 AND 60');	// resync a range of topics/forums (only available for 'topic' and 'forum' modes)
+* &lt;/code&gt;
+*
+* Modes:
+* - forum				Resync complete forum
+* - topic				Resync topics
+* - topic_moved			Removes topic shadows that would be in the same forum as the topic they link to
+* - topic_approved		Resyncs the topic_approved flag according to the status of the first post
+* - post_reported		Resyncs the post_reported flag, relying on actual reports
+* - topic_reported		Resyncs the topic_reported flag, relying on post_reported flags
+* - post_attachement	Same as post_reported, but with attachment flags
+* - topic_attachement	Same as topic_reported, but with attachment flags
+*/
+function sync($mode, $where_type = '', $where_ids = '', $resync_parents = false, $sync_extra = false)
 {
 	global $_CLASS;
 
 	if (is_array($where_ids))
 	{
-		$where_ids = array_unique($where_ids);
+		$where_ids = array_unique(array_map('intval', $where_ids));
 	}
-	elseif ($where_type != 'range')
+	elseif ($where_type !== 'range')
 	{
-		$where_ids = ($where_ids) ? array($where_ids) : array();
+		$where_ids = ($where_ids) ? array((int) $where_ids) : array();
 	}
 
-	if ($mode == 'forum' || $mode == 'topic')
+	if ($mode === 'forum' || $mode === 'topic')
 	{
 		if (!$where_type)
 		{
-				$where_sql = '';
-				$where_sql_and = 'WHERE';
+			$where_sql = '';
+			$where_sql_and = 'WHERE';
 		}
-		elseif ($where_type == 'range')
+		elseif ($where_type === 'range')
 		{
 			// Only check a range of topics/forums. For instance: 'topic_id BETWEEN 1 AND 60'
 			$where_sql = 'WHERE (' . $mode{0} . &quot;.$where_ids)&quot;;
@@ -768,13 +916,17 @@
 		}
 		else
 		{
+			// Do not sync the &quot;global forum&quot;
+			$where_ids = array_diff($where_ids, array(0));
+
 			if (empty($where_ids))
 			{
 				// Empty array with IDs. This means that we don't have any work to do. Just return.
 				return;
 			}
+
 			// Limit the topics/forums we are syncing, use specific topic/forum IDs.
-         // $where_type contains the field for the where clause (forum_id, topic_id)
+			// $where_type contains the field for the where clause (forum_id, topic_id)
 			$where_sql = 'WHERE ' . $mode{0} . &quot;.$where_type IN (&quot; . implode(', ', $where_ids) . ')';
 			$where_sql_and = $where_sql . &quot;\n\tAND&quot;;
 		}
@@ -811,23 +963,25 @@
 							AND t1.forum_id = t2.forum_id&quot;;
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
-					if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					$topic_id_ary = array();
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 					{
-						$topic_id_ary = array();
-						do
-						{
-							$topic_id_ary[] = $row['topic_id'];
-						}
-						while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+						$topic_id_ary[] = $row['topic_id'];
+					}
+					$_CLASS['core_db']-&gt;free_result($result);
 
-						$sql = 'DELETE FROM ' . TOPICS_TABLE . '
-							WHERE topic_id IN (' . implode(', ', $topic_id_ary) . ')';
-						$_CLASS['core_db']-&gt;query($sql);
-						unset($topic_id_ary);
+					if (empty($topic_id_ary))
+					{
+						return;
 					}
-					$_CLASS['core_db']-&gt;free_result($result);					
+
+					$sql = 'DELETE FROM ' . TOPICS_TABLE . '
+						WHERE topic_id IN (' . implode(', ', $topic_id_ary) . ')';
+					$_CLASS['core_db']-&gt;query($sql);
+					unset($topic_id_ary);
+				break;	
 			}
-			break;
+		break;
 
 		case 'topic_approved':
 			switch ($_CLASS['core_db']-&gt;db_layer)
@@ -848,11 +1002,11 @@
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
 					$topic_ids = array();
-					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+					while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc())
 					{
 						$topic_ids[] = $row['topic_id'];
 					}
-					$_CLASS['core_db']-&gt;free_result();
+					$_CLASS['core_db']-&gt;free_result($result);
 
 					if (empty($topic_ids))
 					{
@@ -874,6 +1028,7 @@
 				$where_sql
 				GROUP BY p.post_id, p.post_reported&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$post_ids[$row['post_id']] = $row['post_id'];
@@ -882,12 +1037,12 @@
 					$post_reported[$row['post_id']] = 1;
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
-		/*	$sql = 'SELECT DISTINCT(post_id)
+			$sql = 'SELECT DISTINCT(post_id)
 				FROM ' . FORUMS_REPORTS_TABLE . '
 				WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 			$result = $_CLASS['core_db']-&gt;query($sql);
-		*/
 
 			$post_ids = array();
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
@@ -901,6 +1056,7 @@
 					unset($post_reported[$row['post_id']]);
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			// $post_reported should be empty by now, if it's not it contains
 			// posts that are falsely flagged as reported
@@ -916,7 +1072,7 @@
 					WHERE post_id IN (' . implode(', ', $post_ids) . ')';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
-			break;
+		break;
 
 		case 'topic_reported':
 			if ($sync_extra)
@@ -930,10 +1086,12 @@
 				FROM ' . FORUMS_POSTS_TABLE . &quot; t
 				$where_sql_and t.post_reported = 1&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$topic_reported[$row['topic_id']] = 1;
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			$sql = 'SELECT t.topic_id, t.topic_reported
 				FROM ' . FORUMS_TOPICS_TABLE . &quot; t
@@ -946,6 +1104,7 @@
 					$topic_ids[] = $row['topic_id'];
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			if (!empty($topic_ids))
 			{
@@ -964,6 +1123,7 @@
 				$where_sql
 				GROUP BY p.post_id, p.post_attachment&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$post_ids[$row['post_id']] = $row['post_id'];
@@ -972,14 +1132,15 @@
 					$post_attachment[$row['post_id']] = 1;
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			$sql = 'SELECT DISTINCT(post_msg_id)
 				FROM ' . FORUMS_ATTACHMENTS_TABLE . '
 				WHERE post_msg_id IN (' . implode(', ', $post_ids) . ')
 					AND in_message = 0';
+			$result = $_CLASS['core_db']-&gt;query($sql);
 
 			$post_ids = array();
-			$result = $_CLASS['core_db']-&gt;query($sql);
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				if (!isset($post_attachment[$row['post_id']]))
@@ -991,7 +1152,8 @@
 					unset($post_attachment[$row['post_id']]);
 				}
 			}
-
+			$_CLASS['core_db']-&gt;free_result($result);
+	
 			// $post_attachment should be empty by now, if it's not it contains
 			// posts that are falsely flagged as having attachments
 			foreach ($post_attachment as $post_id =&gt; $void)
@@ -1020,15 +1182,18 @@
 				FROM ' . FORUMS_POSTS_TABLE . &quot; t
 				$where_sql_and t.post_attachment = 1&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$topic_attachment[$row['topic_id']] = 1;
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			$sql = 'SELECT t.topic_id, t.topic_attachment
 				FROM ' . FORUMS_TOPICS_TABLE . &quot; t
 				$where_sql&quot;;
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				if ($row['topic_attachment'] ^ isset($topic_attachment[$row['topic_id']]))
@@ -1036,6 +1201,7 @@
 					$topic_ids[] = $row['topic_id'];
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			if (!empty($topic_ids))
 			{
@@ -1044,9 +1210,10 @@
 					WHERE topic_id IN (' . implode(', ', $topic_ids) . ')';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
-			break;
+		break;
 
 		case 'forum':
+
 			// 1: Get the list of all forums
 			$sql = 'SELECT f.*
 				FROM ' . FORUMS_FORUMS_TABLE . &quot; f
@@ -1073,13 +1240,20 @@
 				$forum_data[$forum_id]['last_poster_id'] = 0;
 				$forum_data[$forum_id]['last_poster_name'] = '';
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
+			if (empty($forum_ids))
+			{
+				break;
+			}
+
 			// 2: Get topic counts for each forum
 			$sql = 'SELECT forum_id, topic_approved, COUNT(topic_id) AS forum_topics
 				FROM ' . FORUMS_TOPICS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_ids) . ')
 				GROUP BY forum_id, topic_approved';
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$forum_id = (int) $row['forum_id'];
@@ -1090,6 +1264,7 @@
 					$forum_data[$forum_id]['topics'] = $row['forum_topics'];
 				}
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			// 3: Get post count and last_post_id for each forum
 			$sql = 'SELECT forum_id, COUNT(post_id) AS forum_posts, MAX(post_id) AS last_post_id
@@ -1098,6 +1273,7 @@
 					AND post_approved = 1
 				GROUP BY forum_id';
 			$result = $_CLASS['core_db']-&gt;query($sql);
+
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				$forum_id = (int) $row['forum_id'];
@@ -1107,6 +1283,7 @@
 
 				$post_ids[] = $row['last_post_id'];
 			}
+			$_CLASS['core_db']-&gt;free_result($result);
 
 			// 4: Retrieve last_post infos
 			if (!empty($post_ids))
@@ -1116,6 +1293,7 @@
 					WHERE p.post_id IN (' . implode(', ', $post_ids) . ')
 						AND p.poster_id = u.user_id';
 				$result = $_CLASS['core_db']-&gt;query($sql);
+
 				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 				{
 					$post_info[intval($row['post_id'])] = $row;
@@ -1175,7 +1353,7 @@
 					$_CLASS['core_db']-&gt;query($sql);
 				}
 			}
-			break;
+		break;
 
 		case 'topic':
 			$topic_data = $post_ids = $approved_unapproved_ids = $resync_forums = $delete_topics = $delete_posts = array();
@@ -1206,7 +1384,7 @@
 			$_CLASS['core_db']-&gt;free_result($result);
 
 			// Use &quot;t&quot; as table alias because of the $where_sql clause
-         // NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.
+			// NOTE: 't.post_approved' in the GROUP BY is causing a major slowdown.
 			$sql = 'SELECT t.topic_id, t.post_approved, COUNT(t.post_id) AS total_posts, MIN(t.post_id) AS first_post_id, MAX(t.post_id) AS last_post_id
 				FROM ' . FORUMS_POSTS_TABLE . &quot; t
 				$where_sql
@@ -1255,15 +1433,17 @@
 			// Now we delete empty topics and orphan posts
 			if (!empty($delete_posts))
 			{
-				delete_posts('topic_id', array_keys($delete_posts), FALSE);
+				delete_posts('topic_id', array_keys($delete_posts), false);
 				unset($delete_posts);
 			}
+
 			if (empty($topic_data))
 			{
 				// If we get there, topic ids were invalid or topics did not contain any posts
-				delete_topics($where_type, $where_ids, TRUE);
+				delete_topics($where_type, $where_ids, true);
 				return;
 			}
+
 			if (!empty($delete_topics))
 			{
 				$delete_topic_ids = array();
@@ -1273,7 +1453,7 @@
 					$delete_topic_ids[] = $topic_id;
 				}
 
-				delete_topics('topic_id', $delete_topic_ids, FALSE);
+				delete_topics('topic_id', $delete_topic_ids, false);
 				unset($delete_topics, $delete_topic_ids);
 			}
 
@@ -1298,6 +1478,7 @@
 					$topic_data[$topic_id]['poster'] = $row['poster_id'];
 					$topic_data[$topic_id]['first_poster_name'] = ($row['poster_id'] == ANONYMOUS) ? $row['post_username'] : $row['username'];
 				}
+
 				if ($row['post_id'] == $topic_data[$topic_id]['last_post_id'])
 				{
 					$topic_data[$topic_id]['last_poster_id'] = $row['poster_id'];
@@ -1328,7 +1509,7 @@
 					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . &quot; p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_reported = 1
-					GROUP BY t.topic_id&quot;;
+					GROUP BY t.topic_id, p.post_id&quot;;
 				$result = $_CLASS['core_db']-&gt;query($sql);
 
 				$fieldnames[] = 'reported';
@@ -1344,7 +1525,7 @@
 					FROM ' . FORUMS_TOPICS_TABLE . ' t, ' . FORUMS_POSTS_TABLE . &quot; p
 					$where_sql_and p.topic_id = t.topic_id
 						AND p.post_attachment = 1
-					GROUP BY t.topic_id&quot;;
+					GROUP BY t.topic_id, p.post_id&quot;;
 				$result = $_CLASS['core_db']-&gt;query($sql);
 
 				$fieldnames[] = 'attachment';
@@ -1384,33 +1565,38 @@
 			// batch processing.
 			if ($resync_parents &amp;&amp; !empty($resync_forums) &amp;&amp; $where_type != 'range')
 			{
-				sync('forum', 'forum_id', $resync_forums, TRUE);
+				sync('forum', 'forum_id', $resync_forums, true);
 			}
-			break;
+		break;
 	}
 }
 
+/**
+* Prune function
+*/
 function prune($forum_id, $prune_mode, $prune_date, $prune_flags = 0, $auto_sync = true)
 {
 	global $_CLASS;
 
-	$sql_forum = (is_array($forum_id)) ? ' IN (' . implode(',', $forum_id) . ')' : &quot; = $forum_id&quot;;
+	$sql_forum = (is_array($forum_id)) ? ' IN (' . implode(', ', array_map('intval', $forum_id)) . ')' : ' = '. (int) $forum_id;
 
 	$sql_and = '';
 	if (!($prune_flags &amp; 4))
 	{
 		$sql_and .= ' AND topic_type &lt;&gt; ' . POST_ANNOUNCE;
 	}
+
 	if (!($prune_flags &amp; 8))
 	{
 		$sql_and .= ' AND topic_type &lt;&gt; ' . POST_STICKY;
 	}
 
-	if ($prune_mode == 'posted')
+	if ($prune_mode === 'posted')
 	{
 		$sql_and .= &quot; AND topic_last_post_time &lt; $prune_date&quot;;
 	}
-	if ($prune_mode == 'viewed')
+
+	if ($prune_mode === 'viewed')
 	{
 		$sql_and .= &quot; AND topic_last_view_time &lt; $prune_date&quot;;
 	}
@@ -1451,7 +1637,9 @@
 	return delete_topics('topic_id', $topic_list, $auto_sync);
 }
 
-// Function auto_prune(), this function now relies on passed vars
+/**
+* Function auto_prune(), this function now relies on passed vars
+*/
 function auto_prune($forum_id, $prune_mode, $prune_flags, $prune_days, $prune_freq)
 {
 	global $_CLASS;
@@ -1460,11 +1648,13 @@
 		FROM ' . FORUMS_TABLE . &quot;
 		WHERE forum_id = $forum_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
 
-	if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	if ($row)
 	{
-		$prune_date = time() - ($prune_days * 86400);
-		$next_prune = time() + ($prune_freq * 86400);
+		$prune_date = $_CLASS['core_user']-&gt;time - ($prune_days * 86400);
+		$next_prune = $_CLASS['core_user']-&gt;time + ($prune_freq * 86400);
 
 		prune($forum_id, $prune_mode, $prune_date, $prune_flags, true);
 
@@ -1475,13 +1665,14 @@
 
 		add_log('admin', 'LOG_AUTO_PRUNE', $row['forum_name']);
 	}
-	$_CLASS['core_db']-&gt;free_result($result);
 
 	return;
 }
 
-// remove_comments will strip the sql comment lines out of an uploaded sql file
-// specifically for mssql and postgres type files in the install....
+/**
+* remove_comments will strip the sql comment lines out of an uploaded sql file
+* specifically for mssql and postgres type files in the install....
+*/
 function remove_comments(&amp;$output)
 {
 	$lines = explode(&quot;\n&quot;, $output);
@@ -1513,103 +1704,46 @@
 	return $output;
 }
 
-// remove_remarks will strip the sql comment lines out of an uploaded sql file
+/**
+* remove_remarks will strip the sql comment lines out of an uploaded sql file
+*/
 function remove_remarks(&amp;$sql)
 {
-	$sql = preg_replace('/(\n){2,}/', &quot;\n&quot;, preg_replace('/^#.*/m', &quot;\n&quot;, $sql));
+	$sql = preg_replace('/\n{2,}/', &quot;\n&quot;, preg_replace('/^#.*$/m', &quot;\n&quot;, $sql));
 }
 
-// split_sql_file will split an uploaded sql file into single sql statements.
-// Note: expects trim() to have already been run on $sql.
-function split_sql_file($sql, $delimiter)
-{
-	// Split up our string into &quot;possible&quot; SQL statements.
-	$tokens = explode($delimiter, $sql);
-
-	// try to save mem.
-	$sql = '';
-	$output = array();
-
-	// we don't actually care about the matches preg gives us.
-	$matches = array();
-
-	// this is faster than calling count($oktens) every time thru the loop.
-	$token_count = count($tokens);
-	for ($i = 0; $i &lt; $token_count; $i++)
-	{
-		// Don't wanna add an empty string as the last thing in the array.
-		if ($i != $token_count - 1)
-		{
-			// This is the total number of single quotes in the token.
-			$total_quotes = preg_match_all(&quot;#'#&quot;, $tokens[$i], $matches);
-			// Counts single quotes that are preceded by an odd number of backslashes,
-			// which means they're escaped quotes.
-			$escaped_quotes = preg_match_all(&quot;#(?&lt;!\\\\)(\\\\\\\\)*\\\\'#&quot;, $tokens[$i], $matches);
-
-			$unescaped_quotes = $total_quotes - $escaped_quotes;
-
-			// If the number of unescaped quotes is even, then the delimiter did NOT occur inside a string literal.
-			if (!($unescaped_quotes % 2))
-			{
-				// It's a complete sql statement.
-				$output[] = $tokens[$i];
-				// save memory.
-				$tokens[$i] = '';
-			}
-			else
-			{
-				// incomplete sql statement. keep adding tokens until we have a complete one.
-				// $temp will hold what we have so far.
-				$temp = $tokens[$i] . $delimiter;
-				// save memory..
-				$tokens[$i] = '';
-
-				// Do we have a complete statement yet?
-				$complete_stmt = false;
-
-				for ($j = $i + 1; (!$complete_stmt &amp;&amp; ($j &lt; $token_count)); $j++)
-				{
-					// This is the total number of single quotes in the token.
-					$total_quotes = preg_match_all(&quot;#'#&quot;, $tokens[$j], $matches);
-					// Counts single quotes that are preceded by an odd number of backslashes,
-					// which means they're escaped quotes.
-					$escaped_quotes = preg_match_all(&quot;#(?&lt;!\\\\)(\\\\\\\\)*\\\\'#&quot;, $tokens[$j], $matches);
-
-					$unescaped_quotes = $total_quotes - $escaped_quotes;
-
-					if (($unescaped_quotes % 2) == 1)
-					{
-						// odd number of unescaped quotes. In combination with the previous incomplete
-						// statement(s), we now have a complete statement. (2 odds always make an even)
-						$output[] = $temp . $tokens[$j];
-
-						// save memory.
-						$tokens[$j] = '';
-						$temp = '';
-
-						// exit the loop.
-						$complete_stmt = true;
-						// make sure the outer loop continues at the right point.
-						$i = $j;
-					}
-					else
-					{
-						// even number of unescaped quotes. We still don't have a complete statement.
-						// (1 odd and 1 even always make an odd)
-						$temp .= $tokens[$j] . $delimiter;
-						// save memory.
-						$tokens[$j] = '';
-					}
-				} // for..
-			} // else
-		}
-	}
-
-	return $output;
+/**
+* split_sql_file will split an uploaded sql file into single sql statements.
+* Note: expects trim() to have already been run on $sql.
+*/
+function split_sql_file($sql, $delimiter)
+{
+	$sql = str_replace(&quot;\r&quot; , '', $sql);
+	$data = preg_split('/' . preg_quote($delimiter, '/') . '$/m', $sql);
+
+	foreach ($data as $key =&gt; $value)
+	{
+		$data[$key] = trim($value);
+	}
+
+	// The empty case
+	$end_data = end($data);
+
+	if (empty($end_data))
+	{
+		unset($data[key($data)]);
+	}
+
+	return $data;
 }
 
-// Cache moderators, called whenever permissions are changed via admin_permissions. Changes of username
-// and group names must be carried through for the moderators table
+/**
+* Cache moderators, called whenever permissions are changed via admin_permissions. Changes of username
+* and group names must be carried through for the moderators table
+*
+* @todo let the admin define if he wants to display moderators (forum-based) - display_on_index already present and checked for...
+*/
+// UPDATE UPDATE
 function cache_moderators()
 {
 	global $_CLASS;
@@ -1619,8 +1753,7 @@
 	$_CLASS['core_db']-&gt;query('TRUNCATE ' . FORUMS_MODERATOR_TABLE);
 
 	// Holding array
-	$m_sql = array();
-	$user_id_sql = '';
+	$sql_ary = array();
 
 	$sql = 'SELECT a.forum_id, u.user_id, u.username
 		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . CORE_USERS_TABLE . &quot;  u
@@ -1632,12 +1765,18 @@
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_u_' . $row['user_id']] = $row['forum_id'] . ', ' . $row['user_id'] . &quot;, '&quot; . $row['username'] . &quot;', NULL, NULL, 1&quot;;
-		$user_id_sql .= (($user_id_sql) ? ', ' : '') . $row['user_id'];
+		$sql_ary[] = array(
+			'forum_id'			=&gt; $row['forum_id'],
+			'user_id'			=&gt; $row['user_id'],
+			'username'			=&gt; $row['username'],
+			'group_id'			=&gt; 0,
+			'group_name'		=&gt; '',
+			'display_on_index'	=&gt; 1
+		);
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	$sql = 'SELECT a.forum_id, g.group_name, g.group_id
+	$sql = 'SELECT a.forum_id, g.group_id, g.group_name
 		FROM  ' . FORUMS_ACL_OPTIONS_TABLE . '  o, ' . FORUMS_ACL_TABLE . ' a,  ' . CORE_GROUPS_TABLE . &quot;  g
 		WHERE o.auth_option = 'm_'
 			AND a.auth_option_id = o.auth_option_id
@@ -1648,99 +1787,35 @@
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$m_sql['f_' . $row['forum_id'] . '_g_' . $row['group_id']] = $row['forum_id'] . ', NULL, NULL, ' . $row['group_id'] . &quot;, '&quot; . $row['group_name'] . &quot;', 1&quot;;
+		$sql_ary[] = array(
+			'forum_id'			=&gt; $row['forum_id'],
+			'user_id'			=&gt; 0,
+			'username'			=&gt; '',
+			'group_id'			=&gt; $row['group_id'],
+			'group_name'		=&gt; $row['group_name'],
+			'display_on_index'	=&gt; 1
+		);
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	if (!empty($m_sql))
+	if (!empty($sql_ary))
 	{
-		switch ($_CLASS['core_db']-&gt;db_layer)
-		{
-			case 'mysql3':
-				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index) 
-					VALUES ' . implode(', ', preg_replace('#^(.*)$#', '(\1)',  $m_sql));
-				$_CLASS['core_db']-&gt;query($sql);
-			break;
-
-			case 'mysql':
-			case 'mysqli':
-			case 'mssql':
-			case 'sqlite':
-			case 'sqlite_pdo':
-				$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . ' (forum_id, user_id, username, group_id, group_name, display_on_index)
-					 ' . implode(' UNION ALL ', preg_replace('#^(.*)$#', 'SELECT \1',  $m_sql));
-				$_CLASS['core_db']-&gt;query($sql);
-			break;
-
-			default:
-				foreach ($m_sql as $k =&gt; $sql)
-				{
-					$sql = 'INSERT INTO ' . FORUMS_MODERATOR_TABLE . &quot; (forum_id, user_id, username, group_id, group_name, display_on_index) 
-						VALUES ($sql)&quot;;
-					$_CLASS['core_db']-&gt;query($sql);
-				}
-			break;
-		}
+		$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_ary, FORUMS_MODERATOR_TABLE);
 	}
 }
 
-// Logging functions
-function add_log()
+function view_log($mode, &amp;$log, &amp;$log_count, $limit = 0, $offset = 0, $forum_id = 0, $topic_id = 0, $user_id = 0, $limit_days = 0, $sort_by = 'l.log_time DESC')
 {
 	global $_CLASS;
 
-	$args = func_get_args();
+	$topic_id_list = $reportee_id_list = $is_auth = $is_mod = array();
 
-	$mode			= array_shift($args);
-	$reportee_id	= ($mode == 'user') ? (int) array_shift($args) : '';
-	$forum_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
-	$topic_id		= ($mode == 'mod') ? (int) array_shift($args) : '';
-	$action			= array_shift($args);
-	$data			= empty($args) ? '' : $_CLASS['core_db']-&gt;escape(serialize($args));
-
 	switch ($mode)
 	{
 		case 'admin':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_ADMIN . ', ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;', &quot; . gmtime() . &quot;, '$action', '$data')&quot;;
-		break;
-		
-		case 'mod':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, forum_id, topic_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_MOD . ', ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, $forum_id, $topic_id, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;', &quot; . gmtime() . &quot;, '$action', '$data')&quot;;
-		break;
-
-		case 'user':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, reportee_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_USERS . ', ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, $reportee_id, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;', &quot; . gmtime() . &quot;, '$action', '$data')&quot;;
-		break;
-
-		case 'critical':
-			$sql = 'INSERT INTO ' . FORUMS_LOG_TABLE . ' (log_type, user_id, log_ip, log_time, log_operation, log_data)
-				VALUES (' . LOG_CRITICAL . ', ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;, '&quot;.$_CLASS['core_user']-&gt;ip.&quot;', &quot; . gmtime() . &quot;, '$action', '$data')&quot;;
-		break;
-		
-		default:
-			return;
-		break;
-	}
-
-	$_CLASS['core_db']-&gt;query($sql);
-	return;
-}
-
-function view_log($mode, &amp;$log, &amp;$log_count, $limit = 0, $offset = 0, $forum_id = 0, $topic_id = 0, $user_id = 0, $limit_days = 0, $sort_by = 'l.log_time DESC')
-{
-	global $_CLASS, $phpEx;
-
-	$topic_id_list = $is_auth = $is_mod = array();
-
-	switch ($mode)
-	{
-		case 'admin':
 			$log_type = LOG_ADMIN;
 			$sql_forum = '';
-			break;
+		break;
 		
 		case 'mod':
 			$log_type = LOG_MOD;
@@ -1757,20 +1832,26 @@
 			{
 				$sql_forum = ($forum_id) ? 'AND l.forum_id = ' . intval($forum_id) : '';
 			}
-			break;
+		break;
 
 		case 'user':
 			$log_type = LOG_USERS;
 			$sql_forum = 'AND l.reportee_id = ' . intval($user_id);
-			break;
+		break;
 		
+		case 'users':
+			$log_type = LOG_USERS;
+			$sql_forum = '';
+		break;
+
 		case 'critical':
 			$log_type = LOG_CRITICAL;
 			$sql_forum = '';
-			break;
+		break;
 		
 		default:
 			return;
+		break;
 	}
 
 	$sql = &quot;SELECT l.*, u.username
@@ -1791,30 +1872,36 @@
 			$topic_id_list[] = $row['topic_id'];
 		}
 		
-		$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' =&gt; true)) : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']);
+		if ($row['reportee_id'])
+		{
+			$reportee_id_list[] = $row['reportee_id'];
+		}
 
-		$log[$i]['id'] = $row['log_id'];
-		$log[$i]['username'] = '&lt;a href=&quot;' . $profile_url . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
-		$log[$i]['ip'] = $row['log_ip'];
-		$log[$i]['time'] = $row['log_time'];
-		$log[$i]['forum_id'] = $row['forum_id'];
-		$log[$i]['topic_id'] = $row['topic_id'];
-		$log[$i]['viewforum'] = ($row['forum_id'] &amp;&amp; $_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id'])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : '';
+		$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' =&gt; true)) : generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['user_id']);
 
-		$log[$i]['action'] = (isset($_CLASS['core_user']-&gt;lang[$row['log_operation']])) ? $_CLASS['core_user']-&gt;lang[$row['log_operation']] : '{' . ucfirst(str_replace('_', ' ', $row['log_operation'])) . '}';
-		
+		$log[$i] = array(
+			'id'				=&gt; $row['log_id'],
+			'reportee_id'		=&gt; $row['reportee_id'],
+			'reportee_username'	=&gt; '',
+			'user_id'			=&gt; $row['user_id'],
+			'username'			=&gt; '&lt;a href=&quot;' . $profile_url . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;',
+			'ip'				=&gt; $row['log_ip'],
+			'time'				=&gt; $row['log_time'],
+			'forum_id'			=&gt; $row['forum_id'],
+			'topic_id'			=&gt; $row['topic_id'],
+
+			'viewforum'			=&gt; ($row['forum_id'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('f_read', $row['forum_id'])) ? generate_link('forums&amp;file=viewforum&amp;f=' . $row['forum_id']) : false,
+			'action'			=&gt; (isset($_CLASS['core_user']-&gt;lang[$row['log_operation']])) ? $_CLASS['core_user']-&gt;lang[$row['log_operation']] : '{' . ucfirst(str_replace('_', ' ', $row['log_operation'])) . '}',
+		);
+
 		if (!empty($row['log_data']))
 		{
-			$log_data_ary = unserialize(stripslashes($row['log_data']));
+			$log_data_ary = @unserialize($row['log_data']);
 
 			if (isset($_CLASS['core_user']-&gt;lang[$row['log_operation']]))
 			{
-				foreach ($log_data_ary as $log_data)
-				{
-					$log_data = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($log_data));
-
-					$log[$i]['action'] = preg_replace('#%s#', $log_data, $log[$i]['action'], 1);
-				}
+				$log[$i]['action'] = vsprintf($log[$i]['action'], $log_data_ary);
+				$log[$i]['action'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($log[$i]['action']));
 			}
 			else
 			{
@@ -1839,14 +1926,30 @@
 
 		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			if ($_CLASS['auth']-&gt;acl_get('f_read', $row['forum_id']))
+			/*if (!$row['forum_id'])
+			{
+				if ($auth-&gt;acl_getf_global('f_read'))
+				{
+					if (!$default_forum_id)
+					{
+						$sql = 'SELECT forum_id
+							FROM ' . FORUMS_TABLE . '
+							WHERE forum_type = ' . FORUM_POST;
+						$f_result = $db-&gt;sql_query_limit($sql, 1);
+						$default_forum_id = (int) $db-&gt;sql_fetchfield('forum_id', false, $f_result);
+						$db-&gt;sql_freeresult($f_result);
+					}
+
+					$is_auth[$row['topic_id']] = $default_forum_id;
+				}
+			} else*/
+			
+			if ($_CLASS['forums_auth']-&gt;acl_get('f_read', $row['forum_id']))
 			{
-				// DEBUG!! - global topic
-				$config['default_forum_id'] = 2;
-				$is_auth[$row['topic_id']] = ($row['forum_id']) ? $row['forum_id'] : $config['default_forum_id'];
+				$is_auth[$row['topic_id']] = ($row['forum_id']) ? $row['forum_id'] : false;
 			}
 
-			if ($_CLASS['auth']-&gt;acl_gets('a_', 'm_', $row['forum_id']))
+			if ($_CLASS['forums_auth']-&gt;acl_gets(array('a_', 'm_'), $row['forum_id']))
 			{
 				$is_mod[$row['topic_id']] = $row['forum_id'];
 			}
@@ -1854,11 +1957,27 @@
 
 		foreach ($log as $key =&gt; $row)
 		{
-			$log[$key]['viewtopic'] = (isset($is_auth[$row['topic_id']])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=viewtopic&amp;f=' . $is_auth[$row['topic_id']] . '&amp;t=' . $row['topic_id']) : '';
-			$log[$key]['viewlogs'] = (isset($is_mod[$row['topic_id']])) ? ((defined('IN_ADMIN')) ? '../' : '') . generate_link('Forums&amp;file=mcp&amp;mode=topic_view&amp;action=viewlogs&amp;t=' . $row['topic_id']) : '';
+			$log[$key]['viewtopic'] = isset($is_auth[$row['topic_id']]) ? generate_link('forums&amp;file=viewtopic&amp;&amp;t=' . $row['topic_id']) : '';
+			$log[$key]['viewlogs'] = isset($is_mod[$row['topic_id']]) ? generate_link('forums&amp;file=mcp&amp;mode=topic_view&amp;action=viewlogs&amp;t=' . $row['topic_id']) : '';
 		}
 	}
 
+	if ($reportee_id_list)
+	{
+		$reportee_id_list = array_unique($reportee_id_list);
+		$reportee_names_list = array();
+
+		require_once SITE_FILE_ROOT.'includes/functions_user.php';
+
+		$reportee_names_list = user_get_name($reportee_id_list, $null);
+		foreach ($log as $key =&gt; $row)
+		{
+			$profile_url = (VIPERAL == 'Admin') ? generate_link('admin_users&amp;u=' . $row['user_id'], array('admin' =&gt; true)) : generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['user_id']);
+			$log[$key]['reportee_username'] = isset($reportee_names_list[$row['reportee_id']]) ? '&lt;a href=&quot;' . $profile_url . '&amp;u=' . $row['reportee_id'] . '&quot;&gt;' . $reportee_names_list[$row['reportee_id']] . '&lt;/a&gt;' : false;
+		}
+		unset($null, $reportee_names_list);
+	}
+
 	$sql = 'SELECT COUNT(l.log_id) AS total_entries
 		FROM ' . FORUMS_LOG_TABLE . &quot; l
 		WHERE l.log_type = $log_type
@@ -1869,7 +1988,7 @@
 	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	$log_count =  $row['total_entries'];
+	$log_count = (int) $row['total_entries'];
 
 	return;
 }
@@ -2182,84 +2301,58 @@
 	}
 }
 
-// Update Post Informations (First/Last Post in topic/forum)
-// Should be used instead of sync() if only the last post informations are out of sync... faster
-function update_post_information($type, $ids)
-{
-	global $_CLASS;
-
-	if (!is_array($ids))
-	{
-		$ids = array($ids);
-	}
-
-	$update_sql = $empty_forums = array();
-
-	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
-		FROM ' . FORUMS_POSTS_TABLE . &quot;
-		WHERE post_approved = 1
-			AND {$type}_id IN (&quot; . implode(', ', $ids) . &quot;)
-		GROUP BY {$type}_id&quot;;
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$last_post_ids = array();
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		if ($type == 'forum')
-		{
-			$empty_forums[] = $row['forum_id'];
-		}
-
-		$last_post_ids[] = $row['last_post_id'];
-	}
-	$_CLASS['core_db']-&gt;free_result($result);
-
-	if ($type == 'forum')
-	{
-		$empty_forums = array_diff($ids, $empty_forums);
-
-		foreach ($empty_forums as $void =&gt; $forum_id)
-		{
-			$update_sql[$forum_id][] = 'forum_last_post_id = 0';
-			$update_sql[$forum_id][] =	'forum_last_post_time = 0';
-			$update_sql[$forum_id][] = 'forum_last_poster_id = 0';
-			$update_sql[$forum_id][] = &quot;forum_last_poster_name = ''&quot;;
-		}
-	}
-
-	if (!empty($last_post_ids))
-	{
-		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
-			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . ' u
-			WHERE p.poster_id = u.user_id
-				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_post_id = ' . (int) $row['post_id'];
-			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_post_time = ' . (int) $row['post_time'];
-			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
-			$update_sql[$row[&quot;{$type}_id&quot;]][] = &quot;{$type}_last_poster_name = '&quot; . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']-&gt;escape($row['post_username']) : $_CLASS['core_db']-&gt;escape($row['username'])) . &quot;'&quot;;
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-	}
-	unset($empty_forums, $ids, $last_post_ids);
-
-	if (empty($update_sql))
-	{
-		return;
-	}
-
-	$table = ($type == 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
-
-	foreach ($update_sql as $update_id =&gt; $update_sql_ary)
-	{
-		$sql = &quot;UPDATE $table
-			SET &quot; . implode(', ', $update_sql_ary) . &quot;
-			WHERE {$type}_id = $update_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
+/**
+* Retrieve contents from remotely stored file
+*/
+function get_remote_file($host, $directory, $filename, &amp;$errstr, &amp;$errno, $port = 80, $timeout = 10)
+{
+	global $_CLASS;
+
+	if ($fsock = @fsockopen($host, $port, $errno, $errstr, $timeout))
+	{
+		@fputs($fsock, &quot;GET $directory/$filename HTTP/1.1\r\n&quot;);
+		@fputs($fsock, &quot;HOST: $host\r\n&quot;);
+		@fputs($fsock, &quot;Connection: close\r\n\r\n&quot;);
+	
+		$file_info = '';
+		$get_info = false;
+
+		while (!@feof($fsock))
+		{
+			if ($get_info)
+			{
+				$file_info .= @fread($fsock, 1024);
+			}
+			else
+			{
+				$line = @fgets($fsock, 1024);
+				if ($line == &quot;\r\n&quot;)
+				{
+					$get_info = true;
+				}
+				else if (strpos($line, '404 Not Found') !== false)
+				{
+					$errstr = $_CLASS['core_user']-&gt;lang['FILE_NOT_FOUND'];
+					return false;
+				}
+			}
+		}
+		@fclose($fsock);
+	}
+	else
+	{
+		if ($errstr)
+		{
+			return false;
+		}
+		else
+		{
+			$errstr = 'fsock disabled';
+			return false;
+		}
+	}
+	
+	return $file_info;
 }
 
 /**
@@ -2270,13 +2363,13 @@
 {
 	global $_CLASS;
 return;
-	$remove_date = time() - (3 * 62 * 24 * 3600);
+	$remove_date = $_CLASS['core_user']-&gt;time - (3 * 62 * 24 * 3600);
 
 	$sql = 'DELETE FROM ' . FORUMS_TRACK_TABLE . '
 		WHERE mark_time &lt; ' . $remove_date;
 	$_CLASS['core_db']-&gt;query($sql);
 
-	set_config('database_last_gc', time(), true);
+	set_config('database_last_gc', $_CLASS['core_user']-&gt;time, true);
 }
 
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/includes/forums/functions_display.php
===================================================================
--- cms/trunk/includes/forums/functions_display.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_display.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -358,6 +358,37 @@
 	return array($active_forum_ary, array());
 }
 
+/**
+* Display reasons
+*/
+function display_reasons($reason_id = 0)
+{
+	global $_CLASS;
+return;
+	$sql = 'SELECT * 
+		FROM ' . REPORTS_REASONS_TABLE . ' 
+		ORDER BY reason_order ASC';
+	$result = $_CLASS['core_db']-&gt;query($sql);
+
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	{
+		// If the reason is defined within the language file, we will use the localized version, else just use the database entry...
+		if (isset($_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])]) &amp;&amp; isset($_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])]))
+		{
+			$row['reson_description'] = $_CLASS['core_user']-&gt;lang['report_reasons']['DESCRIPTION'][strtoupper($row['reason_title'])];
+			$row['reason_title'] = $_CLASS['core_user']-&gt;lang['report_reasons']['TITLE'][strtoupper($row['reason_title'])];
+		}
+
+		$_CLASS['core_template']-&gt;assign_vars_array('reason', array(
+			'ID'			=&gt; $row['reason_id'],
+			'TITLE'			=&gt; $row['reason_title'],
+			'DESCRIPTION'	=&gt; $row['reason_description'],
+			'S_SELECTED'	=&gt; ($row['reason_id'] == $reason_id) ? true : false)
+		);
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+}
+
 function topic_status(&amp;$topic_row, $replies, $mark_time, &amp;$unread, &amp;$folder_img, &amp;$folder_alt, &amp;$topic_type)
 {
 	global $_CLASS, $config;

Modified: cms/trunk/includes/forums/functions_posting.php
===================================================================
--- cms/trunk/includes/forums/functions_posting.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_posting.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -91,47 +91,94 @@
 	}
 }
 
-// Update Last Post Informations
-function update_last_post_information($type, $id)
+/**
+* Update Post Informations (First/Last Post in topic/forum)
+* Should be used instead of sync() if only the last post informations are out of sync... faster
+*
+* @param string $type Can be forum|topic
+* @param mixed $ids topic/forum ids
+*/
+function update_post_information($type, $ids, $return_update_sql = false)
 {
 	global $_CLASS;
 
-	$update_sql = array();
+	if (!is_array($ids))
+	{
+		$ids = array($ids);
+	}
 
-	$sql = 'SELECT MAX(p.post_id) as last_post_id
-		FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . &quot; t
-		WHERE p.topic_id = t.topic_id
-			AND p.post_approved = 1
-			AND t.topic_approved = 1
-			AND p.{$type}_id = $id&quot;;
-			
+	$update_sql = $empty_forums = array();
+
+	$sql = 'SELECT ' . $type . '_id, MAX(post_id) as last_post_id
+		FROM ' . FORUMS_POSTS_TABLE . &quot;
+		WHERE post_approved = 1
+			AND {$type}_id IN (&quot; . implode(', ', $ids) . &quot;)
+		GROUP BY {$type}_id&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
-	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 
-	if ((int) $row['last_post_id'])
+	$last_post_ids = array();
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$sql = 'SELECT p.post_id, p.poster_id, p.post_time, u.username, p.post_username
+		if ($type === 'forum')
+		{
+			$empty_forums[] = $row['forum_id'];
+		}
+
+		$last_post_ids[] = $row['last_post_id'];
+	}
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	if ($type === 'forum')
+	{
+		$empty_forums = array_diff($ids, $empty_forums);
+
+		foreach ($empty_forums as $void =&gt; $forum_id)
+		{
+			$update_sql[$forum_id][] = 'forum_last_post_id = 0';
+			$update_sql[$forum_id][] =	'forum_last_post_time = 0';
+			$update_sql[$forum_id][] = 'forum_last_poster_id = 0';
+			$update_sql[$forum_id][] = &quot;forum_last_poster_name = ''&quot;;
+		}
+	}
+
+	if (!empty($last_post_ids))
+	{
+		$sql = 'SELECT p.' . $type . '_id, p.post_id, p.post_time, p.poster_id, p.post_username, u.user_id, u.username
 			FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . ' u
 			WHERE p.poster_id = u.user_id
-				AND p.post_id = ' . $row['last_post_id'];
+				AND p.post_id IN (' . implode(', ', $last_post_ids) . ')';
 		$result = $_CLASS['core_db']-&gt;query($sql);
-		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_post_id = ' . (int) $row['post_id'];
+			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_post_time = ' . (int) $row['post_time'];
+			$update_sql[$row[&quot;{$type}_id&quot;]][] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
+			$update_sql[$row[&quot;{$type}_id&quot;]][] = &quot;{$type}_last_poster_name = '&quot; . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']-&gt;escape($row['post_username']) : $_CLASS['core_db']-&gt;escape($row['username'])) . &quot;'&quot;;
+		}
 		$_CLASS['core_db']-&gt;free_result($result);
+	}
+	unset($empty_forums, $ids, $last_post_ids);
 
-		$update_sql[] = $type . '_last_post_id = ' . (int) $row['post_id'];
-		$update_sql[] =	$type . '_last_post_time = ' . (int) $row['post_time'];
-		$update_sql[] = $type . '_last_poster_id = ' . (int) $row['poster_id'];
-		$update_sql[] = &quot;{$type}_last_poster_name = '&quot; . (($row['poster_id'] == ANONYMOUS) ? $_CLASS['core_db']-&gt;escape($row['post_username']) : $_CLASS['core_db']-&gt;escape($row['username'])) . &quot;'&quot;;
+	if (empty($update_sql))
+	{
+		return;
 	}
-	else if ($type == 'forum')
+
+	/*if ($return_update_sql)
 	{
-		$update_sql[] = 'forum_last_post_id = 0';
-		$update_sql[] =	'forum_last_post_time = 0';
-		$update_sql[] = 'forum_last_poster_id = 0';
-		$update_sql[] = &quot;forum_last_poster_name = ''&quot;;
+		return $update_sql;
+	}*/
+
+	$table = ($type === 'forum') ? FORUMS_FORUMS_TABLE : FORUMS_TOPICS_TABLE;
+
+	foreach ($update_sql as $update_id =&gt; $update_sql_ary)
+	{
+		$sql = &quot;UPDATE $table
+			SET &quot; . implode(', ', $update_sql_ary) . &quot;
+			WHERE {$type}_id = $update_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
 	}
-
-	return $update_sql;
 }
 
 function upload_attachment($form_name, $forum_id, $local = false, $local_storage = '', $is_message = false)
@@ -361,7 +408,7 @@
 
 	if (file_exists($destination) &amp;&amp; function_exists('passthru'))
 	{
-		passthru($config['img_imagick'] . 'convert' . ((defined('PHP_OS') &amp;&amp; preg_match('#win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' &quot;' . str_replace('\\', '/', $source) . '&quot; +profile &quot;*&quot; &quot;' . str_replace('\\', '/', $destination) . '&quot;');
+		passthru(escapeshellcmd($config['img_imagick']) . 'convert' . ((defined('PHP_OS') &amp;&amp; preg_match('#^win#i', PHP_OS)) ? '.exe' : '') . ' -quality 85 -antialias -sample ' . $new_width . 'x' . $new_height . ' &quot;' . str_replace('\\', '/', $source) . '&quot; +profile &quot;*&quot; &quot;' . str_replace('\\', '/', $destination) . '&quot;');
 		if (file_exists($new_file))
 		{
 			$used_imagick = true;
@@ -745,11 +792,11 @@
 		return false;
 	}
 
-	$bbcode_bitfield = 0;
+	$bbcode_bitfield = '';
 	do
 	{
 		$rowset[] = $row;
-		$bbcode_bitfield |= $row['bbcode_bitfield'];
+		 $bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 	}
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
 	$_CLASS['core_db']-&gt;free_result($result);
@@ -812,7 +859,7 @@
 		unset($rowset[$i]);
 	}
 
-	if ($mode == 'topic_review')
+	if ($mode === 'topic_review')
 	{
 		$_CLASS['core_template']-&gt;assign('QUOTE_IMG', $_CLASS['core_user']-&gt;img('btn_quote', $_CLASS['core_user']-&gt;lang['REPLY_WITH_QUOTE']));
 	}
@@ -1140,7 +1187,8 @@
 		{
 			$_CLASS['core_db']-&gt;query(&quot;UPDATE $table SET $update_sql WHERE &quot; . $where_sql[$table]);
 		}
-	}
+	}
+	unset($sql_data);
 
 	$_CLASS['core_db']-&gt;transaction('commit');
 
@@ -1378,7 +1426,7 @@
 	$_CLASS['core_db']-&gt;transaction();
 
 	// Submit new topic
-	if ($post_mode == 'post')
+	if ($post_mode === 'post')
 	{
 		$sql = 'INSERT INTO ' . FORUMS_TOPICS_TABLE . ' ' .
 			$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_TOPICS_TABLE]['sql']);
@@ -1393,19 +1441,21 @@
 	}
 
 	// Submit new post
-	if ($post_mode == 'post' || $post_mode == 'reply')
+	if ($post_mode === 'post' || $post_mode === 'reply')
 	{
-		if ($post_mode == 'reply')
+		if ($post_mode === 'reply')
 		{
 			$sql_data[FORUMS_POSTS_TABLE]['sql'] = array_merge($sql_data[FORUMS_POSTS_TABLE]['sql'], array(
 				'topic_id' =&gt; $data['topic_id']
 			));
 		}
 
-		$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_POSTS_TABLE . ' ' .	$_CLASS['core_db']-&gt;sql_build_array('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql']));
+		$_CLASS['core_db']-&gt;sql_query_build('INSERT', $sql_data[FORUMS_POSTS_TABLE]['sql'], FORUMS_POSTS_TABLE);
+		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
+
 		$data['post_id'] = $_CLASS['core_db']-&gt;insert_id(FORUMS_POSTS_TABLE, 'post_id');
 
-		if ($post_mode == 'post')
+		if ($post_mode === 'post')
 		{
 			$sql_data[FORUMS_TOPICS_TABLE]['sql'] = array(
 				'topic_first_post_id'	=&gt; $data['post_id'],
@@ -1415,14 +1465,12 @@
 				'topic_last_poster_name'=&gt; (!$_CLASS['core_user']-&gt;is_user &amp;&amp; $username) ? $username : (($_CLASS['core_user']-&gt;data['user_id'] != ANONYMOUS) ? $_CLASS['core_user']-&gt;data['username'] : ''
 			));
 		}
-
-		unset($sql_data[FORUMS_POSTS_TABLE]['sql']);
 	}
 
 	$make_global = false;
 
 	// Are we globalising or unglobalising?
-	if ($post_mode == 'edit_first_post' || $post_mode == 'edit_topic')
+	if ($post_mode === 'edit_first_post' || $post_mode === 'edit_topic')
 	{
 		$sql = 'SELECT topic_type, topic_replies_real, topic_approved
 			FROM ' . FORUMS_TOPICS_TABLE . '
@@ -1527,23 +1575,10 @@
 			}
 		}
 
-		if (sizeof($sql_insert_ary))
+		if (!empty($sql_insert_ary))
 		{
-			switch ($_CLASS['core_db']-&gt;db_layer)
-			{
-				case 'mysql':
-				case 'mysql4':
-				case 'mysqli':
-					$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('MULTI_INSERT', $sql_insert_ary));
-				break;
-
-				default:
-					foreach ($sql_insert_ary as $ary)
-					{
-						$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_POLL_OPTIONS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $ary));
-					}
-				break;
-			}
+			$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_insert_ary, FORUMS_POLL_OPTIONS_TABLE);
+			unset($sql_insert_ary);
 		}
 
 		if (count($poll['poll_options']) &lt; count($cur_poll_options))
@@ -1605,6 +1640,7 @@
 		if (count($attach_sql_array))
 		{
 			$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $attach_sql_array, FORUMS_TOPICS_TABLE);
+			unset($attach_sql_array);
 		}
 	
 		if ($files_updated || $files_added)
@@ -1627,7 +1663,7 @@
 
 	$_CLASS['core_db']-&gt;transaction('commit');
 
-	if ($post_mode == 'post' || $post_mode == 'reply' || $post_mode == 'edit_last_post')
+	if ($post_mode === 'post' || $post_mode === 'reply' || $post_mode === 'edit_last_post')
 	{
 		if ($topic_type != POST_GLOBAL)
 		{
@@ -1654,7 +1690,7 @@
 		}
 	}
 
-	if ($post_mode == 'edit_topic')
+	if ($post_mode === 'edit_topic')
 	{
 		$update_sql = update_post_information('topic', $data['topic_id'], true);
 		if (sizeof($update_sql))
@@ -1666,13 +1702,13 @@
 	// Update total post count, do not consider moderated posts/topics
 	if ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id']))
 	{
-		if ($post_mode == 'post')
+		if ($post_mode === 'post')
 		{
 			set_config('num_topics', $config['num_topics'] + 1, true);
 			set_config('num_posts', $config['num_posts'] + 1, true);
 		}
 
-		if ($post_mode == 'reply')
+		if ($post_mode === 'reply')
 		{
 			set_config('num_posts', $config['num_posts'] + 1, true);
 		}
@@ -1747,8 +1783,8 @@
 				'notify_type'	=&gt; $poster_id,
 				'notify_status'	=&gt; 0,
 			);
-				
-			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_WATCH_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $notify_sql));
+
+			$_CLASS['core_db']-&gt;sql_query_build('INSERT', $notify_sql, FORUMS_WATCH_TABLE);
 			unset($notify_sql);
 		}
 		else if ($data['notify_set'] &amp;&amp; !$data['notify'])
@@ -1771,12 +1807,12 @@
 	markread('topic', $data['forum_id'], $data['topic_id'], $_CLASS['core_user']-&gt;time);
 
 	// Send Notifications
-	if ($mode != 'edit' &amp;&amp; $mode != 'delete' &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])))
+	if ($mode !== 'edit' &amp;&amp; $mode !== 'delete' &amp;&amp; ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])))
 	{
 		user_notification($mode, $subject, $data['topic_title'], $data['forum_name'], $data['forum_id'], $data['topic_id'], $data['post_id']);
 	}
 
-	if ($mode == 'post')
+	if ($mode === 'post')
 	{
 		$url = ($_CLASS['forums_auth']-&gt;acl_get('f_noapprove', $data['forum_id']) || $_CLASS['forums_auth']-&gt;acl_get('m_approve', $data['forum_id'])) ? generate_link('forums&amp;file=viewtopic&amp;f=' . $data['forum_id'] . '&amp;t=' . $data['topic_id']) : generate_link('forums&amp;file=viewforum&amp;f=' . $data['forum_id']);
 	}

Modified: cms/trunk/includes/forums/functions_privmsgs.php
===================================================================
--- cms/trunk/includes/forums/functions_privmsgs.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/functions_privmsgs.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -36,21 +36,20 @@
 		To add new actions (yes, checks can be added here too) to the rule management, the core code has to be modified.
 */
 
-define('RULE_IS_LIKE', 1); // Is Like
-define('RULE_IS_NOT_LIKE', 2); // Is Not Like
-define('RULE_IS', 3); // Is
-define('RULE_IS_NOT', 4); // Is Not
-define('RULE_BEGINS_WITH', 5); // Begins with
-define('RULE_ENDS_WITH', 6); // Ends with
-define('RULE_IS_FRIEND', 7); // Is Friend
-define('RULE_IS_FOE', 8); // Is Foe
-define('RULE_IS_USER', 9); // Is User
-define('RULE_IS_GROUP', 10); // Is In Usergroup
-define('RULE_ANSWERED', 11); // Answered
-define('RULE_FORWARDED', 12); // Forwarded
-define('RULE_REPORTED', 13); // Reported
-define('RULE_TO_GROUP', 14); // Usergroup
-define('RULE_TO_ME', 15); // Me
+define('RULE_IS_LIKE', 1);		// Is Like
+define('RULE_IS_NOT_LIKE', 2);	// Is Not Like
+define('RULE_IS', 3);			// Is
+define('RULE_IS_NOT', 4);		// Is Not
+define('RULE_BEGINS_WITH', 5);	// Begins with
+define('RULE_ENDS_WITH', 6);	// Ends with
+define('RULE_IS_FRIEND', 7);	// Is Friend
+define('RULE_IS_FOE', 8);		// Is Foe
+define('RULE_IS_USER', 9);		// Is User
+define('RULE_IS_GROUP', 10);	// Is In Usergroup
+define('RULE_ANSWERED', 11);	// Answered
+define('RULE_FORWARDED', 12);	// Forwarded
+define('RULE_TO_GROUP', 14);	// Usergroup
+define('RULE_TO_ME', 15);		// Me
 
 define('ACTION_PLACE_INTO_FOLDER', 1);
 define('ACTION_MARK_AS_READ', 2);
@@ -63,67 +62,76 @@
 define('CHECK_STATUS', 4);
 define('CHECK_TO', 5);
 
-$global_privmsgs_rules = array(
-	CHECK_SUBJECT	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})')),
+/**
+* Global private message rules
+* These rules define what to do if a rule is hit
+*/
+$global_privmsgs_rules = array(
+	CHECK_SUBJECT	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0})'),
+		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'message_subject', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;$/i&quot;, {CHECK0})'),
+	),
+
+	CHECK_SENDER	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'username', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} != {STRING}'),
+		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0})'),
+		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;$/i&quot;, {CHECK0})'),
+		RULE_IS_FRIEND		=&gt; array('check0' =&gt; 'friend', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_IS_FOE			=&gt; array('check0' =&gt; 'foe', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_IS_USER		=&gt; array('check0' =&gt; 'author_id', 'function' =&gt; '{CHECK0} == {USER_ID}'),
+		RULE_IS_GROUP		=&gt; array('check0' =&gt; 'author_in_group', 'function' =&gt; 'in_array({GROUP_ID}, {CHECK0})'),
+	),
+
+	CHECK_MESSAGE	=&gt; array(
+		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0})'),
+		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}, &quot;/&quot;) . &quot;/i&quot;, {CHECK0}))'),
+		RULE_IS				=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} == {STRING}'),
+		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} != {STRING}'),
+	),
+
+	CHECK_STATUS	=&gt; array(
+		RULE_ANSWERED		=&gt; array('check0' =&gt; 'pm_replied', 'function' =&gt; '{CHECK0} == 1'),
+		RULE_FORWARDED		=&gt; array('check0' =&gt; 'pm_forwarded', 'function' =&gt; '{CHECK0} == 1'),
+	),
+
+	CHECK_TO		=&gt; array(
+		RULE_TO_GROUP		=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'check2' =&gt; 'user_in_group', 'function' =&gt; 'in_array(&quot;g_&quot; . {CHECK2}, {CHECK0}) || in_array(&quot;g_&quot; . {CHECK2}, {CHECK1})'),
+		RULE_TO_ME			=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'function' =&gt; 'in_array(&quot;u_&quot; . $user_id, {CHECK0}) || in_array(&quot;u_&quot; . $user_id, {CHECK1})'),
+	)
+);
 
-	CHECK_SENDER	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'username', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'username', 'function' =&gt; '{CHECK0} != {STRING}'),
-		RULE_BEGINS_WITH	=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/^&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_ENDS_WITH		=&gt; array('check0' =&gt; 'username', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;$/i&quot;, {CHECK0})'),
-		RULE_IS_FRIEND		=&gt; array('check0' =&gt; 'friend', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_IS_FOE			=&gt; array('check0' =&gt; 'foe', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_IS_USER		=&gt; array('check0' =&gt; 'author_id', 'function' =&gt; '{CHECK0} == {USER_ID}'),
-		RULE_IS_GROUP       =&gt; array('check0' =&gt; 'author_in_group', 'function' =&gt; 'in_array({GROUP_ID}, {CHECK0})')),
+/**
+* This is for defining which condition fields to show for which Rule
+*/
+$global_rule_conditions = array(
+	RULE_IS_LIKE		=&gt; 'text',
+	RULE_IS_NOT_LIKE	=&gt; 'text',
+	RULE_IS				=&gt; 'text',
+	RULE_IS_NOT			=&gt; 'text',
+	RULE_BEGINS_WITH	=&gt; 'text',
+	RULE_ENDS_WITH		=&gt; 'text',
+	RULE_IS_USER		=&gt; 'user',
+	RULE_IS_GROUP		=&gt; 'group'
+);
 
-	CHECK_MESSAGE	=&gt; array(
-		RULE_IS_LIKE		=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; 'preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0})'),
-		RULE_IS_NOT_LIKE	=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '!(preg_match(&quot;/&quot; . preg_quote({STRING}) . &quot;/i&quot;, {CHECK0}))'),
-		RULE_IS				=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} == {STRING}'),
-		RULE_IS_NOT			=&gt; array('check0' =&gt; 'message_text', 'function' =&gt; '{CHECK0} != {STRING}')),
-		
-	CHECK_STATUS	=&gt; array(
-		RULE_ANSWERED		=&gt; array('check0' =&gt; 'replied', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_FORWARDED		=&gt; array('check0' =&gt; 'forwarded', 'function' =&gt; '{CHECK0} == 1'),
-		RULE_REPORTED		=&gt; array('check0' =&gt; 'message_reported', 'function' =&gt; '{CHECK0} == 1')),
-		
-	CHECK_TO		=&gt; array(
-		RULE_TO_GROUP		=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'check2' =&gt; 'user_in_group', 'function' =&gt; 'in_array(&quot;g_&quot; . {CHECK2}, {CHECK0}) || in_array(&quot;g_&quot; . {CHECK2}, {CHECK1})'),
-		RULE_TO_ME			=&gt; array('check0' =&gt; 'to', 'check1' =&gt; 'bcc', 'function' =&gt; 'in_array(&quot;u_&quot; . $user_id, {CHECK0}) || in_array(&quot;u_&quot; . $user_id, {CHECK1})'))
-);
-
-// This is for defining which condition fields to show for which Rule
-$global_rule_conditions = array(
-	RULE_IS_LIKE		=&gt; 'text',
-	RULE_IS_NOT_LIKE	=&gt; 'text',
-	RULE_IS				=&gt; 'text',
-	RULE_IS_NOT			=&gt; 'text',
-	RULE_BEGINS_WITH	=&gt; 'text',
-	RULE_ENDS_WITH		=&gt; 'text',
-	RULE_IS_USER		=&gt; 'user',
-	RULE_IS_GROUP		=&gt; 'group'
-);
-
-// Get all folder
-function get_folder($user_id, &amp;$folder, $folder_id = false)
+/**
+* Get all folder
+*/
+function get_folder($user_id, $folder_id = false)
 {
 	global $_CLASS;
 
-	if (!is_array($folder))
-	{
-		$folder = array();
-	}
+	$folder = array();
 
 	// Get folder informations
-	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(unread) as num_unread
+	$sql = 'SELECT folder_id, COUNT(*) as num_messages, SUM(pm_unread) as num_unread
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
 		WHERE user_id = $user_id
 			AND folder_id &lt;&gt; &quot; . PRIVMSGS_NO_BOX . '
@@ -138,25 +146,30 @@
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	// Make sure the default boxes are defined
-	$folder_array = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
-	foreach ($folder_array as $default_folder)
-	{
-		if (!isset($num_messages[$default_folder]))
-		{
-			$num_messages[$default_folder] = 0;
-		}
-
-		if (!isset($num_unread[$default_folder]))
-		{
-			$num_unread[$default_folder] = 0;
-		}
+	// Make sure the default boxes are defined
+	$available_folder = array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX);
+
+	foreach ($available_folder as $default_folder)
+	{
+		if (!isset($num_messages[$default_folder]))
+		{
+			$num_messages[$default_folder] = 0;
+		}
+
+		if (!isset($num_unread[$default_folder]))
+		{
+			$num_unread[$default_folder] = 0;
+		}
 	}
 
 	// Adjust unread status for outbox
 	$num_unread[PRIVMSGS_OUTBOX] = $num_messages[PRIVMSGS_OUTBOX];
 	
-	$folder[PRIVMSGS_INBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_INBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_INBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_INBOX]);
+	$folder[PRIVMSGS_INBOX] = array(
+		'folder_name'		=&gt; $_CLASS['core_user']-&gt;lang['PM_INBOX'],
+		'num_messages'		=&gt; $num_messages[PRIVMSGS_INBOX],
+		'unread_messages'	=&gt; $num_unread[PRIVMSGS_INBOX]
+	);
 
 	// Custom Folder
 	$sql = 'SELECT folder_id, folder_name, pm_count
@@ -166,32 +179,52 @@
 			
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$folder[$row['folder_id']] = array('folder_name' =&gt; $row['folder_name'], 'num_messages' =&gt; $row['pm_count'], 'unread_messages' =&gt; ((isset($num_unread[$row['folder_id']])) ? $num_unread[$row['folder_id']] : 0));
+		$folder[$row['folder_id']] = array(
+			'folder_name'		=&gt; $row['folder_name'],
+			'num_messages'		=&gt; $row['pm_count'],
+			'unread_messages'	=&gt; isset($num_unread[$row['folder_id']]) ? $num_unread[$row['folder_id']] : 0
+		);
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
-	$folder[PRIVMSGS_OUTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_OUTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_OUTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_OUTBOX]);
-	$folder[PRIVMSGS_SENTBOX] = array('folder_name' =&gt; $_CLASS['core_user']-&gt;lang['PM_SENTBOX'], 'num_messages' =&gt; $num_messages[PRIVMSGS_SENTBOX], 'unread_messages' =&gt; $num_unread[PRIVMSGS_SENTBOX]);
+	$folder[PRIVMSGS_OUTBOX] = array(
+		'folder_name'		=&gt; $_CLASS['core_user']-&gt;lang['PM_OUTBOX'],
+		'num_messages'		=&gt; $num_messages[PRIVMSGS_OUTBOX],
+		'unread_messages'	=&gt; $num_unread[PRIVMSGS_OUTBOX]
+	);
 
+	$folder[PRIVMSGS_SENTBOX] = array(
+		'folder_name'		=&gt; $_CLASS['core_user']-&gt;lang['PM_SENTBOX'],
+		'num_messages'		=&gt; $num_messages[PRIVMSGS_SENTBOX],
+		'unread_messages'	=&gt; $num_unread[PRIVMSGS_SENTBOX]
+	);
+
 	// Define Folder Array for template designers (and for making custom folders usable by the template too)
 	foreach ($folder as $f_id =&gt; $folder_ary)
 	{
+		$folder_id_name = ($f_id == PRIVMSGS_INBOX) ? 'inbox' : (($f_id == PRIVMSGS_OUTBOX) ? 'outbox' : 'sentbox');
+
 		$_CLASS['core_template']-&gt;assign_vars_array('folder', array(
 			'FOLDER_ID'			=&gt; $f_id,
 			'FOLDER_NAME'		=&gt; $folder_ary['folder_name'],
 			'NUM_MESSAGES'		=&gt; $folder_ary['num_messages'],
 			'UNREAD_MESSAGES'	=&gt; $folder_ary['unread_messages'],
 
-			'S_CUR_FOLDER'		=&gt; ($f_id == $folder_id) ? true : false,
-			'S_UNREAD_MESSAGES'	=&gt; ($folder_ary['unread_messages']) ? true : false,
-			'S_CUSTOM_FOLDER'	=&gt; ($f_id &gt; 0) ? true : false)
-		);
+			'U_FOLDER'			=&gt; ($f_id &gt; 0) ? generate_link('control_panel&amp;i=pm&amp;folder=' . $f_id) : generate_link('control_panel&amp;i=pm&amp;folder=' . $folder_id_name),
+
+			'S_CUR_FOLDER'		=&gt; ($f_id === $folder_id),
+			'S_UNREAD_MESSAGES'	=&gt; ($folder_ary['unread_messages']),
+			'S_CUSTOM_FOLDER'	=&gt; ($f_id &gt; 0)
+		));
 	}
 
-	return;
+	return $folder;
 }
 
-// Delete Messages From Sentbox - we are doing this here because this saves us a bunch of checks and queries
+/**
+* Delete Messages From Sentbox
+* we are doing this here because this saves us a bunch of checks and queries
+*/
 function clean_sentbox($num_sentbox_messages)
 {
 	global $_CLASS, $config;
@@ -226,7 +259,9 @@
 	}
 }
 
-// Check Rule against Message Informations
+/**
+* Check Rule against Message Informations
+*/
 function check_rule(&amp;$rules, &amp;$rule_row, &amp;$message_row, $user_id)
 {
 	global $_CLASS, $config;
@@ -258,27 +293,32 @@
 	{
 		case ACTION_PLACE_INTO_FOLDER:
 			return array('action' =&gt; $rule_row['rule_action'], 'folder_id' =&gt; $rule_row['rule_folder_id']);
-			break;
+		break;
+
 		case ACTION_MARK_AS_READ:
 		case ACTION_MARK_AS_IMPORTANT:
 		case ACTION_DELETE_MESSAGE:
-			return array('action' =&gt; $rule_row['rule_action'], 'unread' =&gt; $row['unread'], 'important' =&gt; $row['important']);
-			break;
+			return array('action' =&gt; $rule_row['rule_action'], 'pm_unread' =&gt; $message_row['pm_unread'], 'pm_marked' =&gt; $message_row['pm_marked']);
+		break;
+
 		default:
 			return false;
+		break;
 	}
 
 	return false;
 }
 
-// Place new messages into appropiate folder
+/**
+* Place new messages into appropiate folder
+*/
 function place_pm_into_folder(&amp;$global_privmsgs_rules, $release = false)
 {
 	global $_CLASS, $config;
 
 	if (!$_CLASS['core_user']-&gt;data['user_new_privmsg'])
 	{
-		return;
+		return 0;
 	}
 $_CLASS['core_user']-&gt;data['user_message_rules'] = 0;
 $_CLASS['core_user']-&gt;data['user_full_folder'] = FULL_FOLDER_NONE;
@@ -287,87 +327,130 @@
 	$user_message_rules = (int) $_CLASS['core_user']-&gt;data['user_message_rules'];
 	$user_id = (int) $_CLASS['core_user']-&gt;data['user_id'];
 
-	$user_rules = $zebra = array();
+	$action_ary = $move_into_folder = array();
 
+	if ($release)
+	{
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_NO_BOX . '
+			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . &quot;
+				AND user_id = $user_id&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Get those messages not yet placed into any box
+	$retrieve_sql = 'SELECT t.*, p.*, u.username, u.user_id, u.user_group as group_id
+		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
+		WHERE t.user_id = $user_id
+			AND p.author_id = u.user_id
+			AND t.folder_id = &quot; . PRIVMSGS_NO_BOX . '
+			AND t.msg_id = p.msg_id';
+
 	if ($user_message_rules)
 	{
-		$sql = 'SELECT * 
-			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . &quot;
-			WHERE user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+		$result = $_CLASS['core_db']-&gt;query($retrieve_sql);
 
 		while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			$user_rules[] = $row;
+			$action_ary[$row['msg_id']][] = array('action' =&gt; false);
+			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
 		}
 		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (!empty($user_rules))
-		{
-			$sql = 'SELECT zebra_id, friend, foe
-				FROM ' . ZEBRA_TABLE . &quot;
-				WHERE user_id = $user_id&quot;;
-			$result = $_CLASS['core_db']-&gt;query($sql);
-
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-			{
-				$zebra[$row['zebra_id']] = $row;
-			}
-			$_CLASS['core_db']-&gt;free_result($result);
-		}
 	}
-
-// I don't like no box
-	/*
-	if ($release)
-	{
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_NO_BOX . '
-			WHERE folder_id = ' . PRIVMSGS_HOLD_BOX . &quot;
-				AND user_id = $user_id&quot;;
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-*/
-
-	// Get those messages not yet placed into any box
-	// NOTE: Expand Group Information to all groups the user/author is in? 
-	$sql = 'SELECT t.*, p.*, u.username, u.user_group as author_in_group
-		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
-		WHERE t.user_id = $user_id
-			AND p.author_id = u.user_id
-			AND t.folder_id = &quot; . PRIVMSGS_NO_BOX . '
-			AND t.msg_id = p.msg_id';
-	$result = $_CLASS['core_db']-&gt;query($sql);
-
-	$action_ary = $move_into_folder = array();
-
-	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-	{
-		$row['to']		= explode(':', $row['to_address']);
-		$row['bcc']		= explode(':', $row['bcc_address']);
-		$row['friend']	= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['friend'] : 0;
-		$row['foe']		= isset($zebra[$row['author_id']]) ? $zebra[$row['author_id']]['foe'] : 0;
-		$row['user_in_group'] = $_CLASS['core_user']-&gt;data['user_group'];
-		
-		// Check Rule - this should be very quick since we have all informations we need
-		$is_match = false;
-
-		foreach ($user_rules as $rule_row)
+	else
+	{
+		$user_rules = $zebra = $check_rows = array();
+		$user_ids = $memberships = array();
+
+		// First of all, grab all rules and retrieve friends/foes
+		$sql = 'SELECT * 
+			FROM ' . FORUMS_PRIVMSGS_RULES_TABLE . &quot;
+			WHERE user_id = $user_id&quot;;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 		{
-			if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
-			{
-				$is_match = true;
-				$action_ary[$row['msg_id']][] = $action;
-			}
+			$user_rules[] = $row;
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if (sizeof($user_rules))
+		{
+			$sql = 'SELECT zebra_id, friend, foe
+				FROM ' . ZEBRA_TABLE . &quot;
+				WHERE user_id = $user_id&quot;;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$zebra[$row['zebra_id']] = $row;
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
 		}
-	
-		if (!$is_match)
-		{
-			$action_ary[$row['msg_id']][] = array('action' =&gt; false);
-			$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
-		}
+
+		// Now build a bare-bone check_row array
+		$result = $_CLASS['core_db']-&gt;query($retrieve_sql);
+
+		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		{
+			$check_rows[] = array_merge($row, array(
+				'to'				=&gt; explode(':', $row['to_address']),
+				'bcc'				=&gt; explode(':', $row['bcc_address']),
+				'friend'			=&gt; (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['friend'] : 0,
+				'foe'				=&gt; (isset($zebra[$row['author_id']])) ? $zebra[$row['author_id']]['foe'] : 0,
+				'user_in_group'		=&gt; array($_CLASS['core_user']-&gt;data['user_group']),
+				'author_in_group'	=&gt; array())
+			);
+
+			$user_ids[] = $row['user_id'];
+		}
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		// Retrieve user memberships
+		if (sizeof($user_ids))
+		{
+			$sql = 'SELECT *
+				FROM ' . CORE_GROUPS_MEMBERS_TABLE . '
+				WHERE user_id IN (' . implode(', ', $user_ids) . ')
+					AND member_status = '.STATUS_ACTIVE;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				$memberships[$row['user_id']][] = $row['group_id'];
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+		}
+
+		// Now place into the appropiate folder
+		foreach ($check_rows as $row)
+		{
+			// Add membership if set
+			if (isset($memberships[$row['author_id']]))
+			{
+				$row['author_in_group'] = $memberships[$row['user_id']];
+			}
+
+			// Check Rule - this should be very quick since we have all informations we need
+			$is_match = false;
+			foreach ($user_rules as $rule_row)
+			{
+				if (($action = check_rule($global_privmsgs_rules, $rule_row, $row, $user_id)) !== false)
+				{
+					$is_match = true;
+					$action_ary[$row['msg_id']][] = $action;
+				}
+			}
+
+			if (!$is_match)
+			{
+				$action_ary[$row['msg_id']][] = array('action' =&gt; false);
+				$move_into_folder[PRIVMSGS_INBOX][] = $row['msg_id'];
+			}
+		}
+
+		unset($user_rules, $zebra, $check_rows, $user_ids, $memberships);
 	}
-	$_CLASS['core_db']-&gt;free_result($result);
 
 	// We place actions into arrays, to save queries.
 	$num_new = $num_unread = 0;
@@ -388,18 +471,24 @@
 			switch ($rule_ary['action'])
 			{
 				case ACTION_PLACE_INTO_FOLDER:
+					// Folder actions have precedence, so we will remove any other ones
 					$folder_action = true;
 					$_folder_id = (int) $rule_ary['folder_id'];
+					$move_into_folder = array();
 					$move_into_folder[$_folder_id][] = $msg_id;
 					$num_new++;
 				break;
 
 				case ACTION_MARK_AS_READ:
-					if ($rule_ary['unread'])
+					if ($rule_ary['pm_unread'])
 					{
 						$unread_ids[] = $msg_id;
 					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+
+					if (!$folder_action)
+					{
+						$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+					}
 				break;
 
 				case ACTION_DELETE_MESSAGE:
@@ -407,11 +496,15 @@
 				break;
 
 				case ACTION_MARK_AS_IMPORTANT:
-					if (!$rule_ary['important'])
+					if (!$rule_ary['pm_marked'])
 					{
 						$important_ids[] = $msg_id;
 					}
-					$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+
+					if (!$folder_action)
+					{
+						$move_into_folder[PRIVMSGS_INBOX][] = $msg_id;
+					}
 				break;
 			}
 		}
@@ -438,7 +531,7 @@
 	if (!empty($unread_ids))
 	{
 		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET unread = 0
+			SET pm_unread = 0
 			WHERE msg_id IN (' . implode(', ', $unread_ids) . &quot;)
 				AND user_id = $user_id
 				AND folder_id = &quot; . PRIVMSGS_NO_BOX;
@@ -449,7 +542,7 @@
 	if (!empty($important_ids))
 	{
 		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-			SET marked = 1
+			SET pm_marked = !pm_marked
 			WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
 				AND user_id = $user_id
 				AND msg_id IN (&quot; . implode(', ', $important_ids) . ')';
@@ -458,155 +551,126 @@
 
 	// Move into folder
 	$folder = array();
-
-	if (!empty($move_into_folder))
+	// Here we have ideally only one folder to move into
+	foreach ($move_into_folder as $folder_id =&gt; $msg_ary)
 	{
-		// Determine Full Folder Action - we need the move to folder id later eventually
-		$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
+		$dest_folder = $folder_id;
+		$full_folder_action = FULL_FOLDER_NONE;
 
-		$sql = 'SELECT folder_id, pm_count 
-			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-			WHERE folder_id IN (' . implode(', ', array_keys($move_into_folder)) . (($full_folder_action &gt;= 0) ? ', ' . $full_folder_action : '') . &quot;)
-				AND user_id = $user_id&quot;;
-		$result = $_CLASS['core_db']-&gt;query($sql);
+/////  KILLL
+$_CLASS['core_user']-&gt;data['message_limit'] = 0;
 
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		// Check Message Limit - we calculate with the complete array, most of the time it is one message
+		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
+		if ($_CLASS['core_user']-&gt;data['message_limit'] &amp;&amp; $folder[$folder_id] &amp;&amp; ($folder[$folder_id] + sizeof($msg_ary)) &gt; $_CLASS['core_user']-&gt;data['message_limit'])
 		{
-			$folder[(int) $row['folder_id']] = (int) $row['pm_count'];
-		}
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		if (in_array(PRIVMSGS_INBOX, array_keys($move_into_folder)))
-		{
-			$sql = 'SELECT COUNT(*) as num_messages
-				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-				WHERE user_id = $user_id
-					AND folder_id = &quot; . PRIVMSGS_INBOX;
-
-			$result = $_CLASS['core_db']-&gt;query_limit($sql);
-			list($count) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-			$_CLASS['core_db']-&gt;free_result($result);	
-
-			$folder[PRIVMSGS_INBOX] = (int) $count;
-		}
-	}
-
-	// Here we have ideally only one folder to move into
-	$message_limit = ($_CLASS['core_user']-&gt;data['user_message_limit']) ? $_CLASS['core_user']-&gt;data['user_message_limit'] : $config['pm_max_msgs'];
-
-	foreach ($move_into_folder as $folder_id =&gt; $msg_ary)
-	{
-		$dest_folder = $folder_id;
-		$full_folder_action = FULL_FOLDER_NONE;
-
-		// Check Message Limit - we calculate with the complete array, most of the time it is one message
-		// But we are making sure that the other way around works too (more messages in queue than allowed to be stored)
-		if ($message_limit &amp;&amp; $folder[$folder_id] &amp;&amp; ($folder[$folder_id] + count($msg_ary)) &gt; $message_limit)
-		{
+			// Determine Full Folder Action - we need the move to folder id later eventually
 			$full_folder_action = ($_CLASS['core_user']-&gt;data['user_full_folder'] == FULL_FOLDER_NONE) ? ($config['full_folder_action'] - (FULL_FOLDER_NONE*(-1))) : $_CLASS['core_user']-&gt;data['user_full_folder'];
+	
+			if ($full_folder_action &gt;= 0 &amp;&amp; ($folder[$full_folder_action] + sizeof($msg_ary)) &gt; $_CLASS['core_user']-&gt;data['message_limit'])
+			{
+				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
+			}
 
-			// If destination folder itself is full...
-			if ($full_folder_action &gt;= 0 &amp;&amp; ($folder[$full_folder_action] + count($msg_ary)) &gt; $message_limit)
-			{
-				$full_folder_action = $config['full_folder_action'] - (FULL_FOLDER_NONE*(-1));
-			}
-
-			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
-			if ($full_folder_action &gt;= 0)
-			{
-				$dest_folder = $full_folder_action;
-			}
-			elseif ($full_folder_action == FULL_FOLDER_DELETE)
-			{
-				// Delete some messages ;)
-				$sql = 'SELECT t.msg_id
-					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
-					WHERE t.msg_id = p.msg_id
-						AND t.user_id = $user_id
-						AND t.folder_id = $dest_folder
-					ORDER BY p.message_time ASC&quot;;
-				$result = $_CLASS['core_db']-&gt;query_limit($sql, (($folder[$dest_folder] + count($msg_ary)) - $message_limit));
-
-				$delete_ids = array();
-				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-				{
-					$delete_ids[] = $row['msg_id'];
-				}
+			// If Full Folder Action is to move to another folder, we simply adjust the destination folder
+			if ($full_folder_action &gt;= 0)
+			{
+				$dest_folder = $full_folder_action;
+			}
+			else if ($full_folder_action == FULL_FOLDER_DELETE)
+			{
+				// Delete some messages ;)
+				$sql = 'SELECT t.msg_id
+					FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
+					WHERE t.msg_id = p.msg_id
+						AND t.user_id = $user_id
+						AND t.folder_id = $dest_folder
+					ORDER BY p.message_time ASC&quot;;
+				$result = $_CLASS['core_db']-&gt;query_limit($sql, (($folder[$dest_folder] + sizeof($msg_ary)) - $_CLASS['core_user']-&gt;data['message_limit']));
+
+				$delete_ids = array();
+				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+				{
+					$delete_ids[] = $row['msg_id'];
+				}
 				$_CLASS['core_db']-&gt;free_result($result);
-				delete_pm($user_id, $delete_ids, $dest_folder);
-			}
+				delete_pm($user_id, $delete_ids, $dest_folder);
+			}
 		}
-
-		if ($full_folder_action == FULL_FOLDER_HOLD)
-		{
-			$num_not_moved += count($msg_ary);
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . '
-				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
-				WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
-					AND user_id = $user_id
-					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-		}
-		else
-		{
-			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
-				SET folder_id = $dest_folder, msg_new = 0
-				WHERE folder_id = &quot; . PRIVMSGS_NO_BOX . &quot;
-					AND user_id = $user_id
-					AND msg_new = 1
-					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
-			$_CLASS['core_db']-&gt;query($sql);
-
-			if ($dest_folder != PRIVMSGS_INBOX)
-			{
-				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
-					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']-&gt;affected_rows() . &quot;
-					WHERE folder_id = $dest_folder
-						AND user_id = $user_id&quot;;
-				$_CLASS['core_db']-&gt;query($sql);
-			}
-			else
-			{
-				$num_new += $_CLASS['core_db']-&gt;affected_rows();
-			}
-		}
+		
+		// 
+		if ($full_folder_action == FULL_FOLDER_HOLD)
+		{
+			$num_not_moved += sizeof($msg_ary);
+
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+				SET folder_id = ' . PRIVMSGS_HOLD_BOX . '
+				WHERE folder_id = ' . PRIVMSGS_NO_BOX . &quot;
+					AND user_id = $user_id
+					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+		else
+		{
+			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
+				SET folder_id = $dest_folder, pm_new = 0
+				WHERE folder_id = &quot; . PRIVMSGS_NO_BOX . &quot;
+					AND user_id = $user_id
+					AND pm_new = 1
+					AND msg_id IN (&quot; . implode(', ', $msg_ary) . ')';
+			$_CLASS['core_db']-&gt;query($sql);
+
+			if ($dest_folder != PRIVMSGS_INBOX)
+			{
+				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . '
+					SET pm_count = pm_count + ' . (int) $_CLASS['core_db']-&gt;affected_rows() . &quot;
+					WHERE folder_id = $dest_folder
+						AND user_id = $user_id&quot;;
+				$_CLASS['core_db']-&gt;query($sql);
+			}
+			else
+			{
+				$num_new += (int) $_CLASS['core_db']-&gt;affected_rows();
+			}
+		}
+	}
+
+	if (sizeof($action_ary))
+	{
+		// Move from OUTBOX to SENTBOX
+		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
+		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
+			SET folder_id = ' . PRIVMSGS_SENTBOX . '
+			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
+				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
+		$_CLASS['core_db']-&gt;query($sql);
+	}
+
+	// Update unread and new status field
+	if ($num_unread || $num_new)
+	{
+		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
+		if ($num_new)
+		{
+			$set_sql .= ($set_sql != '') ? ', ' : '';
+			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
+		}
+		
+		$_CLASS['core_db']-&gt;query('UPDATE ' . CORE_USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
+		$_CLASS['core_user']-&gt;data['user_new_privmsg'] -= $num_new;
+		$_CLASS['core_user']-&gt;data['user_unread_privmsg'] -= $num_unread;
 	}
-
-	if (!empty($action_ary))
-	{
-		// Move from OUTBOX to SENTBOX
-		// We are not checking any full folder status here... SENTBOX is a special treatment (old messages get deleted)
-		$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . ' 
-			SET folder_id = ' . PRIVMSGS_SENTBOX . '
-			WHERE folder_id = ' . PRIVMSGS_OUTBOX . '
-				AND msg_id IN (' . implode(', ', array_keys($action_ary)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
-	// Update unread and new status field
-	if ($num_unread || $num_new)
-	{
-		$set_sql = ($num_unread) ? 'user_unread_privmsg = user_unread_privmsg - ' . $num_unread : '';
-
-		if ($num_new)
-		{
-			$set_sql .= ($set_sql) ? ', ' : '';
-			$set_sql .= 'user_new_privmsg = user_new_privmsg - ' . $num_new;
-		}
-
-		$_CLASS['core_db']-&gt;query('UPDATE ' . CORE_USERS_TABLE . &quot; SET $set_sql WHERE user_id = $user_id&quot;);
-
-		$_CLASS['core_user']-&gt;data['user_new_privmsg'] -= $num_new;
-		$_CLASS['core_user']-&gt;data['user_unread_privmsg'] -= $num_unread;
-	}
-
+
 	$_CLASS['core_db']-&gt;transaction('commit');
-
+
 	return $num_not_moved;
-}
+}	
+	
 
-// Move PM from one to another folder
-function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
+/**
+* Move PM from one to another folder
+*/
+function move_pm($user_id, $message_limit, $move_msg_ids, $dest_folder, $cur_folder_id)
 {
 	global $_CLASS;
 	
@@ -615,13 +679,14 @@
 		$move_msg_ids = array($move_msg_ids);
 	}
 	
-	if (empty($move_msg_ids) || in_array($dest_folder, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || in_array($cur_folder_id, array(PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) || $cur_folder_id === $dest_folder)
+	if (empty($move_msg_ids) &amp;&amp; !in_array($dest_folder, array(PRIVMSGS_NO_BOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) &amp;&amp; 
+		!in_array($cur_folder_id, array(PRIVMSGS_NO_BOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)) &amp;&amp; $cur_folder_id != $dest_folder)
 	{
 		return 0;
 	}
 	
 	// We have to check the destination folder ;)
-	if ($dest_folder !== PRIVMSGS_INBOX)
+	if ($dest_folder != PRIVMSGS_INBOX)
 	{
 		$sql = 'SELECT folder_id, folder_name, pm_count
 			FROM ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
@@ -635,11 +700,11 @@
 		{
 			trigger_error('NOT_AUTHORIZED');
 		}
-// is message limit per folder ?
+
 		if ($row['pm_count'] + count($move_msg_ids) &gt; $message_limit)
 		{
 			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $row['folder_name']) . '&lt;br /&gt;&lt;br /&gt;';
-			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder='.$row['folder_id']).'&quot;&gt;', '&lt;/a&gt;', $row['folder_name']);
+			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('control_panel&amp;i=pm&amp;folder='.$row['folder_id']).'&quot;&gt;', '&lt;/a&gt;', $row['folder_name']);
 
 			trigger_error($message);
 		}
@@ -657,7 +722,7 @@
 		if (!$row || ((int) $row['num_messages'] + count($move_msg_ids)) &gt; $message_limit)
 		{
 			$message = sprintf($_CLASS['core_user']-&gt;lang['NOT_ENOUGH_SPACE_FOLDER'], $_CLASS['core_user']-&gt;lang['PM_INBOX']) . '&lt;br /&gt;&lt;br /&gt;';
-			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;folder=inbox').'&quot;&gt;', '&lt;/a&gt;', $_CLASS['core_user']-&gt;lang['PM_INBOX']);
+			$message .= sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;'.generate_link('control_panel&amp;i=pm&amp;folder=inbox').'&quot;&gt;', '&lt;/a&gt;', $_CLASS['core_user']-&gt;lang['PM_INBOX']);
 			trigger_error($message);
 		}
 	}
@@ -674,9 +739,7 @@
 	// Update pm counts
 	if ($num_moved)
 	{
-// We should maybe add moving of atleast sentbox messages, maybe
-		//if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
-		if ($cur_folder_id !== PRIVMSGS_INBOX)
+		if (!in_array($cur_folder_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX)))
 		{
 			$sql = 'UPDATE ' . FORUMS_PRIVMSGS_FOLDER_TABLE . &quot;
 				SET pm_count = pm_count - $num_moved
@@ -714,7 +777,7 @@
 	$_CLASS['core_db']-&gt;transaction();
 
 	$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot; 
-		SET unread = $read
+		SET pm_unread = $read
 		WHERE msg_id $sql_msg
 			AND user_id = $user_id
 			AND folder_id = $folder_id&quot;;
@@ -733,7 +796,9 @@
 	$_CLASS['core_db']-&gt;transaction('commit');
 }
 
-// Handle all actions possible with marked messages
+/**
+* Handle all actions possible with marked messages
+*/
 function handle_mark_actions($user_id, $mark_action, $msg_ids, $cur_folder_id)
 {
 	global $_CLASS;
@@ -749,7 +814,7 @@
 
 			$mark_list = array();
 
-			$sql = 'SELECT msg_id, marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+			$sql = 'SELECT msg_id, pm_marked FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
 				WHERE folder_id = $cur_folder_id
 					AND user_id = $user_id
 					AND msg_id IN (&quot; . implode(', ', $msg_ids) . ')';
@@ -757,8 +822,8 @@
 
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$row['marked'] = ($row['marked']) ? 0 : 1;
-				$mark_list[$row['marked']][] = $row['msg_id'];
+				$row['pm_marked'] = ($row['pm_marked']) ? 0 : 1;
+				$mark_list[$row['pm_marked']][] = $row['msg_id'];
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
 
@@ -772,7 +837,7 @@
 			foreach ($mark_list as $mark =&gt; $ids)
 			{
 				$sql = 'UPDATE ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
-					SET marked = $mark
+					SET pm_marked = $mark
 					WHERE msg_id IN (&quot; . implode(', ', $ids) . ')';
 				$_CLASS['core_db']-&gt;query($sql);
 			}
@@ -781,7 +846,12 @@
 		break;
 
 		case 'delete_marked':
-			$hidden_fields = array('marked_msg_id' =&gt; $msg_ids, 'cur_folder_id' =&gt; $cur_folder_id, 'mark_option' =&gt; 'delete_marked', 'submit_mark' =&gt; true);
+			$hidden_fields = array(
+				'marked_msg_id'		=&gt; $msg_ids,
+				'cur_folder_id'		=&gt; $cur_folder_id,
+				'mark_option'		=&gt; 'delete_marked',
+				'submit_mark'		=&gt; true
+			);
 
 			if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DELETE_MARKED_PM'), generate_hidden_fields($hidden_fields)))
 			{
@@ -792,7 +862,7 @@
 				$_CLASS['core_db']-&gt;transaction('commit');
 
 				$success_msg = (count($msg_ids) === 1) ? 'MESSAGE_DELETED' : 'MESSAGES_DELETED';
-				$redirect = generate_link('Control_Panel&amp;i=pm&amp;folder='.$cur_folder_id);
+				$redirect = generate_link('control_panel&amp;i=pm&amp;folder='.$cur_folder_id);
 				$_CLASS['core_display']-&gt;meta_refresh(3, $redirect);
 				
 				trigger_error($_CLASS['core_user']-&gt;lang[$success_msg] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FOLDER'], '&lt;a href=&quot;' . $redirect . '&quot;&gt;', '&lt;/a&gt;'));
@@ -815,7 +885,9 @@
 	return true;
 }
 
-// Delete PM(s)
+/**
+* Delete PM(s)
+*/
 function delete_pm($user_id, $msg_ids, $folder_id)
 {
 	global $_CLASS;
@@ -844,7 +916,7 @@
 	}
 
 	// Get PM Informations for later deleting
-	$sql = 'SELECT msg_id, unread, msg_new
+	$sql = 'SELECT msg_id, pm_unread, pm_new
 		FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 		WHERE msg_id IN (' . implode(', ', array_map('intval', $msg_ids)) . &quot;)
 			AND folder_id = $folder_id
@@ -856,8 +928,8 @@
 	
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$num_unread += ($row['unread']) ? 1 : 0;
-		$num_new += ($row['msg_new']) ? 1 : 0;
+		$num_unread += ($row['pm_unread']) ? 1 : 0;
+		$num_new += ($row['pm_new']) ? 1 : 0;
 
 		$delete_rows[$row['msg_id']] = 1;
 	}
@@ -892,7 +964,7 @@
 			WHERE msg_id IN (' . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']-&gt;query($sql);
 
-		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
+		$num_deleted = $_CLASS['core_db']-&gt;affected_rows();
 	}
 	else
 	{
@@ -902,7 +974,7 @@
 				AND folder_id = $folder_id
 				AND msg_id IN (&quot; . implode(', ', array_keys($delete_rows)) . ')';
 		$_CLASS['core_db']-&gt;query($sql);
-		$num_deleted = $_CLASS['core_db']-&gt;sql_affectedrows();
+		$num_deleted = $_CLASS['core_db']-&gt;affected_rows();
 	}
 
 	// if folder id is user defined folder then decrease pm_count
@@ -947,9 +1019,13 @@
 			WHERE msg_id IN (' . $delete_ids . ')';
 		$_CLASS['core_db']-&gt;query($sql);
 	}
+
+	return true;
 }
 
-// Rebuild message header
+/**
+* Rebuild message header
+*/
 function rebuild_header($check_ary)
 {
 	$address = array();
@@ -980,7 +1056,9 @@
 	return $address;
 }
 
-// Print out/Assign recipient informations
+/**
+* Print out/assign recipient informations
+*/
 function write_pm_addresses($check_ary, $author_id, $plaintext = false)
 {
 	global $_CLASS;
@@ -989,13 +1067,21 @@
 	
 	foreach ($check_ary as $check_type =&gt; $address_field)
 	{
-		// Split Addresses into users and groups
-		preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
-
-		$u = $g = array();
-		foreach ($match[1] as $id =&gt; $type)
+		if (!is_array($address_field))
 		{
-			${$type}[] = (int) $match[2][$id];
+			// Split Addresses into users and groups
+			preg_match_all('/:?(u|g)_([0-9]+):?/', $address_field, $match);
+	
+			$u = $g = array();
+			foreach ($match[1] as $id =&gt; $type)
+			{
+				${$type}[] = (int) $match[2][$id];
+			}
+		}
+		else
+		{
+			$u = $address_field['u'];
+			$g = $address_field['g'];
 		}
 
 		$address = array();
@@ -1080,11 +1166,11 @@
 				{
 					$_CLASS['core_template']-&gt;assign_vars_array($check_type . '_recipient', array(
 						'NAME'		=&gt; $row['name'],
-						'IS_GROUP'	=&gt; ($type == 'group'),
-						'IS_USER'	=&gt; ($type == 'user'),
+						'IS_GROUP'	=&gt; ($type === 'group'),
+						'IS_USER'	=&gt; ($type === 'user'),
 						'COLOUR'	=&gt; ($row['colour']) ? $row['colour'] : '',
 						'UG_ID'		=&gt; $id,
-						'U_VIEW'	=&gt; ($type == 'user') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id))
+						'U_VIEW'	=&gt; ($type === 'user') ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) : generate_link('members_list&amp;mode=group&amp;g=' . $id))
 					);
 				}
 			}
@@ -1096,7 +1182,9 @@
 	return $addresses;
 }
 
-// Get folder status
+/**
+* Get folder status
+*/
 function get_folder_status($folder_id, $folder)
 {
 	global $_CLASS, $config;
@@ -1125,17 +1213,19 @@
 	return $return;
 }
 
-//
-// COMPOSE MESSAGES
-//
-
-// Submit PM
+//
+// COMPOSE MESSAGES
+//
+
+/**
+* Submit PM
+*/
 function submit_pm($mode, $subject, &amp;$data, $update_message, $put_in_outbox = true)
 {
 	global $_CLASS, $config;
 
 	// We do not handle erasing posts here
-	if ($mode == 'delete')
+	if ($mode === 'delete')
 	{
 		return;
 	}
@@ -1151,20 +1241,27 @@
 	{
 		// Build Recipient List
 		// u|g =&gt; array($user_id =&gt; 'to'|'bcc')
-		foreach (array('u', 'g') as $ug_type)
+		$_types = array('u', 'g');
+		foreach ($_types as $ug_type)
 		{
 			if (!empty($data['address_list'][$ug_type]))
 			{
 				foreach ($data['address_list'][$ug_type] as $id =&gt; $field)
 				{
-					$field = ($field == 'to') ? 'to' : 'bcc';
+					$id = (int) $id;
+
+					// Do not rely on the address list being &quot;valid&quot;
+					if (!$id)
+					{
+						continue;
+					}
 
+					$field = ($field === 'to') ? 'to' : 'bcc';
 					if ($ug_type == 'u')
 					{
 						$recipients[$id] = $field;
 					}
-
-					${$field}[] = $ug_type . '_' . (int) $id;
+					${$field}[] = $ug_type . '_' . $id;
 				}
 			}
 		}
@@ -1179,7 +1276,7 @@
 	
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				$field = ($data['address_list']['g'][$row['group_id']] == 'to') ? 'to' : 'bcc';
+				$field = ($data['address_list']['g'][$row['group_id']] === 'to') ? 'to' : 'bcc';
 				$recipients[$row['user_id']] = $field;
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
@@ -1208,13 +1305,15 @@
 				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . '
 					AND msg_id = ' . $data['reply_from_msg_id'];
 
+		// no break
+
 		case 'forward':
 		case 'post':
 			$sql_data = array(
 				'root_level'		=&gt; $root_level,
-				'author_id'			=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
+				'author_id'			=&gt; $data['from_user_id'],
 				'icon_id'			=&gt; $data['icon_id'], 
-				'author_ip' 		=&gt; $_CLASS['core_user']-&gt;ip,
+				'author_ip' 		=&gt; $data['from_user_ip'],
 				'message_time'		=&gt; $_CLASS['core_user']-&gt;time,
 				'enable_bbcode' 	=&gt; $data['enable_bbcode'],
 				'enable_html' 		=&gt; $data['enable_html'],
@@ -1223,7 +1322,6 @@
 				'enable_sig' 		=&gt; $data['enable_sig'],
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
-				'message_checksum'	=&gt; $data['message_md5'],
 				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid'],
@@ -1243,7 +1341,6 @@
 				'enable_sig' 		=&gt; $data['enable_sig'],
 				'message_subject'	=&gt; $subject,
 				'message_text' 		=&gt; $data['message'],
-				'message_checksum'	=&gt; $data['message_md5'],
 				'message_attachment'=&gt; (isset($data['filename_data']['physical_filename']) &amp;&amp; !empty($data['filename_data'])) ? 1 : 0,
 				'bbcode_bitfield'	=&gt; $data['bbcode_bitfield'],
 				'bbcode_uid'		=&gt; $data['bbcode_uid']
@@ -1275,20 +1372,28 @@
 		{
 			$_CLASS['core_db']-&gt;query($sql);
 		}
+		unset($sql);
 
+		$sql_array = array();
 		foreach ($recipients as $user_id =&gt; $type)
 		{
-			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'msg_id'	=&gt; $data['msg_id'],
-				'user_id'	=&gt; $user_id,
-				'author_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-				'folder_id'	=&gt; PRIVMSGS_NO_BOX,
-				'msg_new'	=&gt; 1,
-				'unread'	=&gt; 1,
-				'forwarded'	=&gt; ($mode == 'forward') ? 1 : 0)
-			));
+			$sql_array[] = array(
+				'msg_id'		=&gt; (int) $data['msg_id'],
+				'user_id'		=&gt; (int) $user_id,
+				'author_id'		=&gt; (int) $data['from_user_id'],
+				'folder_id'		=&gt; PRIVMSGS_NO_BOX,
+				'pm_new'		=&gt; 1,
+				'pm_unread'		=&gt; 1,
+				'pm_forwarded'	=&gt; ($mode == 'forward') ? 1 : 0
+			);
 		}
 
+		if (!empty($sql_array))
+		{
+			$_CLASS['core_db']-&gt;sql_query_build('MULTI_INSERT', $sql_array, FORUMS_PRIVMSGS_TO_TABLE);
+			unset($sql_array);
+		}
+
 		$sql = 'UPDATE ' . CORE_USERS_TABLE . ' 
 			SET user_new_privmsg = user_new_privmsg + 1, user_unread_privmsg = user_unread_privmsg + 1
 			WHERE user_id IN (' . implode(', ', array_keys($recipients)) . ')';
@@ -1298,19 +1403,19 @@
 		if ($put_in_outbox)
 		{
 			$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_PRIVMSGS_TO_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'msg_id'	=&gt; (int) $data['msg_id'],
-				'user_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'author_id'	=&gt; (int) $_CLASS['core_user']-&gt;data['user_id'],
-				'folder_id'	=&gt; (int) PRIVMSGS_OUTBOX,
-				'msg_new'	=&gt; 0,
-				'unread'	=&gt; 0,
-				'forwarded'	=&gt; ($mode === 'forward') ? 1 : 0))
-			);
+				'msg_id'		=&gt; (int) $data['msg_id'],
+				'user_id'		=&gt; (int) $data['from_user_id'],
+				'author_id'		=&gt; (int) $data['from_user_id'],
+				'folder_id'		=&gt; PRIVMSGS_OUTBOX,
+				'pm_new'		=&gt; 0,
+				'pm_unread'		=&gt; 0,
+				'pm_forwarded'	=&gt; ($mode == 'forward') ? 1 : 0)
+			));
 		}
 	}
 
 	// Set user last post time
-	if ($mode === 'reply' || $mode === 'quote' || $mode === 'forward' || $mode === 'post')
+	if ($mode === 'reply' || $mode === 'quote'|| $mode === 'quotepost' || $mode === 'forward' || $mode === 'post')
 	{
 		$sql = 'UPDATE ' . CORE_USERS_TABLE . &quot;
 			SET user_last_post_time = {$_CLASS['core_user']-&gt;time}
@@ -1319,7 +1424,7 @@
 	}
 
 	// Submit Attachments
-	if (!empty($data['attachment_data']) &amp;&amp; $data['msg_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit', 'forward')))
+	if (!empty($data['attachment_data']) &amp;&amp; $data['msg_id'] &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'quotepost', 'edit', 'forward')))
 	{
 		$space_taken = $files_added = 0;
 
@@ -1341,7 +1446,7 @@
 					'download_count'	=&gt; 0,
 					'topic_id'			=&gt; 0,
 					'in_message'		=&gt; 1,
-					'poster_id'			=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+					'poster_id'			=&gt; $data['from_user_id'],
 					'physical_filename'	=&gt; basename($attach_row['physical_filename']),
 					'real_filename'		=&gt; basename($attach_row['real_filename']),
 					'comment'			=&gt; $attach_row['comment'],
@@ -1352,10 +1457,9 @@
 					'thumbnail'			=&gt; $attach_row['thumbnail']
 				);
 
-				$_CLASS['core_db']-&gt;query('INSERT INTO ' . FORUMS_ATTACHMENTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', $attach_sql));
+				$_CLASS['core_db']-&gt;sql_query_build('INSERT', $attach_sql, FORUMS_ATTACHMENTS_TABLE);
 
 				$space_taken += $attach_row['filesize'];
-
 				$files_added++;
 			}
 		}
@@ -1393,17 +1497,21 @@
 	{
 	//unset($recipients[$_CLASS['core_user']-&gt;data['user_id']]);
 
-		pm_notification($mode, $_CLASS['core_user']-&gt;data['username'], $recipients, $subject, $data['message']);
+		pm_notification($mode, $data['from_username'], $recipients, $subject, $data['message']);
 	}
 
 	return $data['msg_id'];
 }
 
-// PM Notification
+/**
+* PM Notification
+*/
 function pm_notification($mode, $author, $recipients, $subject, $message)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
+	unset($recipients[ANONYMOUS], $recipients[$_CLASS['core_user']-&gt;data['user_id']]);
+
 	if (empty($recipients))
 	{
 		return;
@@ -1436,7 +1544,7 @@
 
 	$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
 
-	require_once(SITE_FILE_ROOT.'includes/mailer.php');
+	require_once SITE_FILE_ROOT.'includes/mailer.php';
 	$mailer = new core_mailer;
 
 	$count = count($user_list);
@@ -1450,10 +1558,10 @@
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'EMAIL_SIG'		=&gt; $email_sig,
 		'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
-		'SUBJECT'		=&gt; $subject,
-		'AUTHOR_NAME'	=&gt; $author,
+		'SUBJECT'		=&gt; html_entity_decode($subject),
+		'AUTHOR_NAME'	=&gt; html_entity_decode($author),
 
-		'LINK_INBOX'		=&gt; generate_link('Control_Panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true))
+		'LINK_INBOX'	=&gt; generate_link('control_panel&amp;i=pm&amp;mode=unread', array('full' =&gt; true, 'sid' =&gt; true))
 	));
 
 	$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/control_panel/pm_notify.txt', true));

Modified: cms/trunk/includes/forums/mcp/mcp_forum.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_forum.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -66,7 +66,7 @@
 $topic_id = get_variable('t', 'REQUEST', false, 'int');;
 
 // Resync Topics
-if ($action == 'resync')
+if ($action === 'resync')
 {
 	if (empty($topic_id_list))
 	{
@@ -227,7 +227,7 @@
 	$_CLASS['core_template']-&gt;assign_vars_array('topicrow', array(
 		'U_VIEW_TOPIC'		=&gt; generate_link(&quot;Forums&amp;file=mcp&amp;t={$row['topic_id']}&amp;mode=topic_view&quot;),
 
-		'S_SELECT_TOPIC'	=&gt; ($action == 'merge_select' &amp;&amp; $row['topic_id'] != $topic_id) ? true : false,
+		'S_SELECT_TOPIC'	=&gt; ($action === 'merge_select' &amp;&amp; $row['topic_id'] != $topic_id) ? true : false,
 		'U_SELECT_TOPIC'	=&gt; generate_link($url . '&amp;mode=topic_view&amp;action=merge&amp;to_topic_id=' . $row['topic_id'] . $selected_ids),
 		'U_MCP_QUEUE'		=&gt; $u_mcp_queue,
 		'U_MCP_REPORT'		=&gt; generate_link(&quot;forums&amp;file=mcp&amp;i=main&amp;mode=topic_view&amp;t={$row['topic_id']}&amp;action=reports&quot;),

Modified: cms/trunk/includes/forums/mcp/mcp_main.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_main.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -61,7 +61,7 @@
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);//generate_link('Forums')
 	$message = $_CLASS['core_user']-&gt;get_lang(strtoupper($mode) . '_' . $l_prefix . ((count($ids) === 1) ? '' : 'S'));
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		$sql_id . '_list'	=&gt; $ids,
 		'mode'				=&gt; $mode,
 		'redirect'			=&gt; $redirect
@@ -138,7 +138,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=&gt; $topic_ids,
 		'mode'			=&gt; $mode,
 		'redirect'		=&gt; $redirect
@@ -252,7 +252,7 @@
 		unset($_POST['confirm']);
 	}
 	
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=&gt; $topic_ids,
 		'mode'			=&gt; 'move',
 		'redirect'		=&gt; $redirect
@@ -366,7 +366,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=&gt; $topic_ids,
 		'mode'			=&gt; 'delete_topic',
 		'redirect'		=&gt; $redirect
@@ -414,7 +414,7 @@
 
 	$redirect = get_variable('redirect', 'POST', $_CLASS['core_user']-&gt;data['session_url']);
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'post_id_list'	=&gt; $post_ids,
 		'mode'			=&gt; 'delete_post',
 		'redirect'		=&gt; $redirect
@@ -557,7 +557,7 @@
 		unset($_POST['confirm']);
 	}
 
-	$hidden_fields = build_hidden_fields(array(
+	$hidden_fields = generate_hidden_fields(array(
 		'topic_id_list'	=&gt; $topic_ids,
 		'mode'			=&gt; 'fork',
 		'redirect'		=&gt; $redirect

Modified: cms/trunk/includes/forums/mcp/mcp_notes.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_notes.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -12,9 +12,13 @@
 
 global $_CLASS;
 
-$action = get_variable('action', 'REQUEST');
 $mode = get_variable('mode', 'REQUEST');
+$action = (isset($_REQUEST['action']) &amp;&amp; is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
 //$this-&gt;page_title = 'MCP_NOTES';
 
 switch ($mode)
@@ -94,7 +98,7 @@
 		if ($where_sql || $deleteall)
 		{
 			$sql = 'DELETE FROM ' . FORUMS_LOG_TABLE . '
-				WHERE log_type = ' . FORUMS_LOG_USERS . &quot; 
+				WHERE log_type = ' . LOG_USERS . &quot; 
 					AND reportee_id = $user_id
 					$where_sql&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
@@ -169,8 +173,8 @@
 				'REPORT_AT'		=&gt; $_CLASS['core_user']-&gt;format_date($row['time']),
 				'ACTION'		=&gt; $row['action'],
 				'IP'			=&gt; $row['ip'],
-				'ID'			=&gt; $row['id'])
-			);
+				'ID'			=&gt; $row['id']
+			));
 		}
 	}
 

Modified: cms/trunk/includes/forums/mcp/mcp_post.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_post.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -27,8 +27,13 @@
 $_CLASS['core_user']-&gt;add_lang('posting');
 
 $post_id = get_variable('p', 'REQUEST', false, 'int');
-$action = get_variable('action', 'REQUEST');
+$action = (isset($_REQUEST['action']) &amp;&amp; is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
+
 if (!$post_id &amp;&amp; $action !== 'whois')
 {
 	trigger_error('POST_NOT_EXIST');
@@ -45,7 +50,7 @@
 	}
 	$post_info = $post_info[$post_id];
 	
-	$url = 'forums&amp;file=mcp';
+	$url = 'forums&amp;file=mcp&amp;p='.$post_info['post_id'];
 	$start	= get_variable('start', 'REQUEST', 0, 'int');
 }
 
@@ -122,7 +127,7 @@
 $message = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $message);
 
 $_CLASS['core_template']-&gt;assign_array(array(
-	'U_MCP_ACTION'			=&gt; generate_link($url.'&amp;i=main&amp;quickmod=1'), // Use this for mode paramaters
+	'U_MCP_ACTION'			=&gt; generate_link($url.'&amp;quickmod=1'), // Use this for mode paramaters
 	'U_POST_ACTION'			=&gt; generate_link(&quot;$url&amp;mode=post_details&quot;), // Use this for action parameters
 	'U_APPROVE_ACTION'		=&gt; generate_link('forums&amp;file=mcp&amp;i=queue&amp;p='.$post_info['post_id']),
 
@@ -231,7 +236,7 @@
 	$rdns_ip_num = get_variable('rdns', 'REQUEST');
 	$users_ary = array();
 
-	$_CLASS['core_template']-&gt;assign('U_LOOKUP_ALL', ($rdns_ip_num === 'all') ? false : generate_link($url.'&amp;i=main&amp;mode=post_details&amp;rdns=all&amp;p='.$post_info['post_id']));
+	$_CLASS['core_template']-&gt;assign('U_LOOKUP_ALL', ($rdns_ip_num === 'all') ? false : generate_link($url.'&amp;mode=post_details&amp;rdns=all&amp;p='.$post_info['post_id']));
 
 	// Get other users who've posted under this IP
 	$sql = 'SELECT u.user_id, u.username, COUNT(*) as postings

Modified: cms/trunk/includes/forums/mcp/mcp_queue.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_queue.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -28,9 +28,13 @@
 
 $forum_id = request_var('f', 0);
 $start = request_var('start', 0);
-$action = get_variable('action', 'REQUEST');
+$action = (isset($_REQUEST['action']) &amp;&amp; is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
 $mode = get_variable('mode', 'REQUEST');
 
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
 
 switch ($action)
 {
@@ -45,7 +49,7 @@
 			trigger_error('NO_POST_SELECTED');
 		}
 
-		($mode === 'approve') ? approve_post($post_id_list, $mode) : disapprove_post($post_id_list, $mode);
+		($action === 'approve') ? approve_post($post_id_list, $mode) : disapprove_post($post_id_list, $mode);
 	break;
 }
 
@@ -64,7 +68,7 @@
 			$post_id = isset($topic_info[$topic_id]['topic_first_post_id']) ? (int) $topic_info[$topic_id]['topic_first_post_id'] : false;
 		}
 
-		$post_info = ($post_id/) ? get_post_data(array($post_id), 'm_approve') : false;
+		$post_info = ($post_id) ? get_post_data(array($post_id), 'm_approve') : false;
 
 		if (!$post_id || empty($post_info[$post_id]))
 		{
@@ -90,15 +94,16 @@
 		$poster = ($post_info['user_colour']) ? '&lt;span style=&quot;color:#' . $post_info['user_colour'] . '&quot;&gt;' . $post_info['username'] . '&lt;/span&gt;' : $post_info['username'];
 
 		// Process message, leave it uncensored
-		$message = $post_info['post_text'];
+		$post_info['post_text'] = $post_info['post_text'];
+
 		if ($post_info['bbcode_bitfield'])
 		{
 			require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 
 			$bbcode = new bbcode($post_info['bbcode_bitfield']);
-			$bbcode-&gt;bbcode_second_pass($message, $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
+			$bbcode-&gt;bbcode_second_pass($post_info['post_text'], $post_info['bbcode_uid'], $post_info['bbcode_bitfield']);
 		}
-		$message = smiley_text($message);
+		$post_info['post_text'] = smiley_text($post_info['post_text']);
 
 		$_CLASS['core_template']-&gt;assign_array(array(
 			'S_MCP_QUEUE'			=&gt; true,
@@ -118,13 +123,13 @@
 			'U_VIEW_PROFILE'		=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u=' . $post_info['user_id']),
 			'U_VIEW_TOPIC'			=&gt; generate_link('forums&amp;file=viewtopic&amp;t=' . $post_info['topic_id']),
 
-			'RETURN_QUEUE'			=&gt; sprintf($_CLASS['core_user']-&gt;lang['RETURN_QUEUE'], '&lt;a href=&quot;' . generate_link('forums&amp;file=mcp&amp;i=queue' . (($topic_id) ? '&amp;mode=unapproved_topics' : '&amp;mode=unapproved_posts')) . &quot;&amp;start=$start\&quot;&gt;&quot;, '&lt;/a&gt;'),
+			'RETURN_QUEUE'			=&gt; sprintf($_CLASS['core_user']-&gt;get_lang('RETURN_QUEUE'), '&lt;a href=&quot;' . generate_link('forums&amp;file=mcp&amp;i=queue' . (($topic_id) ? '&amp;mode=unapproved_topics' : '&amp;mode=unapproved_posts')) . &quot;&amp;start=$start\&quot;&gt;&quot;, '&lt;/a&gt;'),
 			'REPORTED_IMG'			=&gt; $_CLASS['core_user']-&gt;img('icon_reported', $_CLASS['core_user']-&gt;lang['POST_REPORTED']),
 			'UNAPPROVED_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_unapproved', $_CLASS['core_user']-&gt;lang['POST_UNAPPROVED']),
 			'EDIT_IMG'				=&gt; $_CLASS['core_user']-&gt;img('btn_edit', $_CLASS['core_user']-&gt;lang['EDIT_POST']),
 
 			'POSTER_NAME'			=&gt; $poster,
-			'POST_PREVIEW'			=&gt; $message,
+			'POST_PREVIEW'			=&gt; $post_info['post_text'],
 			'POST_SUBJECT'			=&gt; $post_info['post_subject'],
 			'POST_DATE'				=&gt; $_CLASS['core_user']-&gt;format_date($post_info['post_time']),
 			'POST_IP'				=&gt; $post_info['poster_ip'],
@@ -201,7 +206,7 @@
 		$forum_topics = ($total == -1) ? $forum_info['forum_topics'] : $total;
 		$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time &gt;= ' . ($_CLASS['core_user']-&gt;time - ($sort_days * 86400)) : '';
 
-		if ($mode == 'unapproved_posts')
+		if ($mode === 'unapproved_posts')
 		{
 			$sql = 'SELECT DISTINCT p.post_id
 				FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t' . (($sort_order_sql{0} == 'u') ? ', ' . CORE_USERS_TABLE . ' u' : '') . &quot;
@@ -308,17 +313,17 @@
 		}
 		unset($rowset);
 
-		$pagination = generate_pagination('forums&amp;file=mcp&amp;f='.$forum_id, $total, $config['topics_per_page'], $start)
+		$pagination = generate_pagination('forums&amp;file=mcp&amp;f='.$forum_id, $total, $config['topics_per_page'], $start);
 
 		// Now display the page
 		$_CLASS['core_template']-&gt;assign_array(array(
-			'L_DISPLAY_ITEMS'		=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;lang['DISPLAY_POSTS'] : $_CLASS['core_user']-&gt;lang['DISPLAY_TOPICS'],
-			'L_EXPLAIN'				=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;lang['MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN'] : $_CLASS['core_user']-&gt;lang['MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'],
-			'L_TITLE'				=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;lang['MCP_QUEUE_UNAPPROVED_POSTS'] : $_CLASS['core_user']-&gt;lang['MCP_QUEUE_UNAPPROVED_TOPICS'],
+			'L_DISPLAY_ITEMS'		=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;get_lang('DISPLAY_POSTS') : $_CLASS['core_user']-&gt;get_lang('DISPLAY_TOPICS'),
+			'L_EXPLAIN'				=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;get_lang('MCP_QUEUE_UNAPPROVED_POSTS_EXPLAIN') : $_CLASS['core_user']-&gt;get_lang('MCP_QUEUE_UNAPPROVED_TOPICS_EXPLAIN'),
+			'L_TITLE'				=&gt; ($mode === 'unapproved_posts') ? $_CLASS['core_user']-&gt;get_lang('MCP_QUEUE_UNAPPROVED_POSTS') : $_CLASS['core_user']-&gt;get_lang('MCP_QUEUE_UNAPPROVED_TOPICS'),
 			'L_ONLY_TOPIC'			=&gt; ($topic_id) ? sprintf($_CLASS['core_user']-&gt;lang['ONLY_TOPIC'], $topic_info['topic_title']) : '',
 
 			'S_FORUM_OPTIONS'		=&gt; $forum_options,
-			'S_MCP_ACTION'			=&gt; build_url(array('t', 'f', 'sd', 'st', 'sk')),
+			'S_MCP_ACTION'			=&gt; generate_link(&quot;forums&amp;file=mcp&amp;i=queue&amp;t=$topic_id&amp;f=$forum_id&quot;),//build_url(array('t', 'f', 'sd', 'st', 'sk')),
 			'S_TOPICS'				=&gt; ($mode === 'unapproved_posts') ? false : true,
 
 			'PAGINATION'			=&gt; $pagination['formated'],
@@ -340,7 +345,9 @@
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
+	$forum_id = request_var('f', 0);
+
+	if (!check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
@@ -349,15 +356,20 @@
 	$success_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
-		'i'				=&gt; 'queue',
+		'i'				=&gt; 'queue',
+		'f'				=&gt; $forum_id,
 		'mode'			=&gt; $mode,
 		'post_id_list'	=&gt; $post_id_list,
-		'f'				=&gt; $forum_id,
 		'action'		=&gt; 'approve',
 		'redirect'		=&gt; $redirect
 	));
 
-	if (confirm_box(true))
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_NOTIFY_POSTER'	=&gt; true,
+		'S_APPROVE'			=&gt; true
+	));
+
+	if (display_confirmation($_CLASS['core_user']-&gt;get_lang('APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S')), $s_hidden_fields, 'modules/forums/mcp_approve.html'))
 	{
 		$notify_poster = (isset($_REQUEST['notify_poster'])) ? true : false;
 	
@@ -459,48 +471,55 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-/*		$messenger = new messenger();
-
 		// Notify Poster?
 		if ($notify_poster)
 		{
-			$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
-		
+			require_once SITE_FILE_ROOT.'includes/mailer.php';
+
+			$mailer = new core_mailer();
+
 			foreach ($post_info as $post_id =&gt; $post_data)
 			{
 				if ($post_data['poster_id'] == ANONYMOUS)
 				{
 					continue;
 				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] &amp;&amp; $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_approved' : 'post_approved';
 
-				$messenger-&gt;template($email_template, $post_data['user_lang']);
+				$post_data['post_subject'] = censor_text($post_data['post_subject'], true);
+				$post_data['topic_title'] = censor_text($post_data['topic_title'], true);
 
-				$messenger-&gt;replyto($config['board_email']);
-				$messenger-&gt;to($post_data['user_email'], $post_data['username']);
-				$messenger-&gt;im($post_data['user_jabber'], $post_data['username']);
+				if ($post_data['post_id'] == $post_data['topic_first_post_id'] &amp;&amp; $post_data['post_id'] == $post_data['topic_last_post_id'])
+				{
+					$email_template = 'topic_approved.txt';
+					$subject = 'Topic Approved - '.$post_data['topic_title'];
+				}
+				else
+				{
+					$email_template = 'post_approved.txt';
+					$subject = 'Post Approved - '.$post_data['post_subject'];
+				}
 
-				$messenger-&gt;assign_vars(array(
-					'EMAIL_SIG'		=&gt; $email_sig,
-					'SITENAME'		=&gt; $_CORE_CONFIG['global']['sitename'],
+				$mailer-&gt;to($post_data['user_email'], $post_data['username']);
+				//$mailer-&gt;reply_to($_CORE_CONFIG['email']['site_email']);
+				$mailer-&gt;subject($subject);
+				//$messenger-&gt;im($post_data['user_jabber'], $post_data['username']);
+
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
 					'USERNAME'		=&gt; $post_data['username'],
-					'POST_SUBJECT'	=&gt; censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=&gt; censor_text($post_data['topic_title']),
+					'POST_SUBJECT'	=&gt; $post_data['post_subject'],
+					'TOPIC_TITLE'	=&gt; $post_data['topic_title'],
 
-					'U_VIEW_TOPIC'	=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;f=$forum_id&amp;t={$post_data['topic_id']}&amp;e=0&quot;),
-					'U_VIEW_POST'	=&gt; generate_link(&quot;forums&amp;file=viewtopic7amp;f=$forum_id&amp;t={$post_data['topic_id']}&amp;p=$post_id&amp;e=$post_id&quot;))
-				);
+					'U_VIEW_TOPIC'	=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;t={$post_data['topic_id']}&amp;e=0&quot;),
+					'U_VIEW_POST'	=&gt; generate_link(&quot;forums&amp;file=viewtopic&amp;p=$post_id&amp;e=$post_id&quot;)
+				));
 
-				$messenger-&gt;send($post_data['user_notify_type']);
-				$messenger-&gt;reset();
+				$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/forums/'.$email_template, true));
+				$mailer-&gt;send();
 			}
-			$messenger-&gt;save_queue();
 		}
-*/
+
 		// Send out normal user notifications
-		$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
-		
 		foreach ($post_info as $post_id =&gt; $post_data)
 		{
 			if ($post_id == $post_data['topic_first_post_id'] &amp;&amp; $post_id == $post_data['topic_last_post_id'])
@@ -525,16 +544,7 @@
 			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_APPROVED_SUCCESS' : 'POSTS_APPROVED_SUCCESS';
 		}
 	}
-	else
-	{
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'S_NOTIFY_POSTER'	=&gt; true,
-			'S_APPROVE'			=&gt; true)
-		);
 
-		confirm_box(false, 'APPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'modules/forums/mcp_approve.html');
-	}
-
 	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)
@@ -551,11 +561,13 @@
 /**
 * Disapprove Post/Topic
 */
-function disapprove_post($post_id_list)
+function disapprove_post($post_id_list, $mode)
 {
 	global $_CLASS, $_CORE_CONFIG, $config;
 
-	if (!check_ids($post_id_list, POSTS_TABLE, 'post_id', 'm_approve'))
+	$forum_id = request_var('f', 0);
+
+	if (!check_ids($post_id_list, FORUMS_POSTS_TABLE, 'post_id', 'm_approve'))
 	{
 		trigger_error('NOT_AUTHORIZED');
 	}
@@ -566,10 +578,10 @@
 	$success_msg = $additional_msg = '';
 
 	$s_hidden_fields = build_hidden_fields(array(
-		'i'				=&gt; 'queue',
+		'i'				=&gt; 'queue',
+		'f'				=&gt; $forum_id,
 		'mode'			=&gt; $mode,
 		'post_id_list'	=&gt; $post_id_list,
-		'f'				=&gt; $forum_id,
 		'mode'			=&gt; 'disapprove',
 		'redirect'		=&gt; $redirect
 	));
@@ -599,7 +611,18 @@
 		}
 	}
 
-	if (confirm_box(true))
+	require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
+
+	$reason = display_reasons($reason_id);
+
+	$_CLASS['core_template']-&gt;assign_array(array(
+		'S_NOTIFY_POSTER'	=&gt; true,
+		'S_APPROVE'			=&gt; false,
+		'REASON'			=&gt; $reason,
+		'ADDITIONAL_MSG'	=&gt; $additional_msg
+	));
+
+	if (display_confirmation($_CLASS['core_user']-&gt;get_lang('DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S')), $s_hidden_fields, 'modules/forums/mcp_approve.html'))
 	{
 		$post_info = get_post_data($post_id_list, 'm_approve');
 		
@@ -671,42 +694,51 @@
 		update_post_information('forum', $forum_id);
 		unset($topic_id_list);
 		
-		/*$messenger = new messenger();
-
 		// Notify Poster?
 		if ($notify_poster)
 		{
-			$email_sig = str_replace('&lt;br /&gt;', &quot;\n&quot;, &quot;-- \n&quot; . $config['board_email_sig']);
-		
+			require_once SITE_FILE_ROOT.'includes/mailer.php';
+
+			$mailer = new core_mailer();
+
 			foreach ($post_info as $post_id =&gt; $post_data)
 			{
 				if ($post_data['poster_id'] == ANONYMOUS)
 				{
 					continue;
 				}
-				
-				$email_template = ($post_data['post_id'] == $post_data['topic_first_post_id'] &amp;&amp; $post_data['post_id'] == $post_data['topic_last_post_id']) ? 'topic_disapproved' : 'post_disapproved';
 
-				$messenger-&gt;template($email_template, $post_data['user_lang']);
+				$post_data['post_subject'] = censor_text($post_data['post_subject'], true);
+				$post_data['topic_title'] = censor_text($post_data['topic_title'], true);
 
-				$messenger-&gt;replyto($config['board_email']);
-				$messenger-&gt;to($post_data['user_email'], $post_data['username']);
-				$messenger-&gt;im($post_data['user_jabber'], $post_data['username']);
+				if ($post_data['post_id'] == $post_data['topic_first_post_id'] &amp;&amp; $post_data['post_id'] == $post_data['topic_last_post_id'])
+				{
+					$email_template = 'topic_disapproved.txt';
+					$subject = 'Topic Disapproved - '.$post_data['topic_title'];
+				}
+				else
+				{
+					$email_template = 'post_disapproved.txt';
+					$subject = 'Post Disapproved - '.$post_data['post_subject'];
+				}
 
-				$messenger-&gt;assign_vars(array(
-					'EMAIL_SIG'		=&gt; $email_sig,
-					'SITENAME'		=&gt; $_CORE_CONFIG['global']['sitename'],
+				$mailer-&gt;to($post_data['user_email'], $post_data['username']);
+				//$mailer-&gt;reply_to($_CORE_CONFIG['email']['site_email']);
+				$mailer-&gt;subject($subject);
+				//$messenger-&gt;im($post_data['user_jabber'], $post_data['username']);
+
+				$_CLASS['core_template']-&gt;assign_array(array(
+					'SITENAME'		=&gt; $_CORE_CONFIG['global']['site_name'],
 					'USERNAME'		=&gt; $post_data['username'],
 					'REASON'		=&gt; stripslashes($disapprove_reason),
-					'POST_SUBJECT'	=&gt; censor_text($post_data['post_subject']),
-					'TOPIC_TITLE'	=&gt; censor_text($post_data['topic_title']))
-				);
+					'POST_SUBJECT'	=&gt; $post_data['post_subject'],
+					'TOPIC_TITLE'	=&gt; $post_data['topic_title'],
+				));
 
-				$messenger-&gt;send($post_data['user_notify_type']);
-				$messenger-&gt;reset();
+				$mailer-&gt;message = trim($_CLASS['core_template']-&gt;display('email/forums/'.$email_template, true));
+				$mailer-&gt;send();
 			}
-			$messenger-&gt;save_queue();
-		}*/
+		}
 		unset($post_info, $disapprove_reason);
 
 		if ($forum_topics_real)
@@ -718,22 +750,7 @@
 			$success_msg = (sizeof($post_id_list) == 1) ? 'POST_DISAPPROVED_SUCCESS' : 'POSTS_DISAPPROVED_SUCCESS';
 		}
 	}
-	else
-	{
-		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
-
-		display_reasons($reason_id);
-
-		$_CLASS['core_template']-&gt;assign_array(array(
-			'S_NOTIFY_POSTER'	=&gt; true,
-			'S_APPROVE'			=&gt; false,
-			'REASON'			=&gt; $reason,
-			'ADDITIONAL_MSG'	=&gt; $additional_msg
-		));
 
-		confirm_box(false, 'DISAPPROVE_POST' . ((sizeof($post_id_list) == 1) ? '' : 'S'), $s_hidden_fields, 'mcp_approve.html');
-	}
-
 	$redirect = request_var('redirect', generate_link('forums'));
 
 	if (!$success_msg)

Modified: cms/trunk/includes/forums/mcp/mcp_topic.php
===================================================================
--- cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/mcp/mcp_topic.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -63,27 +63,52 @@
 $to_forum_id = get_variable('to_forum_id', 'REQUEST', false, 'int');
 $post_id_list = array_unique(get_variable('post_id_list', 'REQUEST', array(), 'array:int'));
 
-// Split Topic?
-if ($action === 'split_all' || $action === 'split_beyond')
+switch ($action)
 {
-	if ($message = split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject))
-	{
-		$_CLASS['core_template']-&gt;assign('MESSAGE', $_CLASS['core_user']-&gt;get_lang($message));
-	}
+	case 'lock_post':
+	case 'unlock_post':
+		$post_ids = get_post_ids($quick_mod);
 
-	$action = 'split';
-}
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
 
-// Merge Posts?
-if ($action == 'merge_posts')
-{
-	merge_posts($topic_id, $to_topic_id);
-	$action = 'merge';
-}
+		require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
 
-if ($action === 'split' &amp;&amp; !$subject)
-{
-	$subject = $topic_info['topic_title'];
+		lock_unlock($action, $post_ids);
+	break;
+
+	case 'delete_post':
+		$_CLASS['core_user']-&gt;add_lang('posting');
+
+		$post_ids = get_post_ids($quick_mod);
+
+		if (empty($post_ids))
+		{
+			trigger_error('NO_POST_SELECTED');
+		}
+
+		require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
+
+		mcp_delete_post($post_ids);
+	break;
+
+	case 'split_all':
+	case 'split_beyond':
+		if ($message = split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject))
+		{
+			$_CLASS['core_template']-&gt;assign('MESSAGE', $_CLASS['core_user']-&gt;get_lang($message));
+		}
+	
+		$action = 'split';
+		$subject = ($subject) ? $subject : $topic_info['topic_title'];
+	break;
+
+	case 'merge_posts':
+		merge_posts($topic_id, $to_topic_id);
+		$action = 'merge';
+	break;
 }
 
 $topics_per_page = ($topic_info['forum_topics_per_page']) ? $topic_info['forum_topics_per_page'] : $config['topics_per_page'];
@@ -117,7 +142,7 @@
 while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 {
 	$rowset[] = $row;
-	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 }
 $_CLASS['core_db']-&gt;free_result($result);
 
@@ -223,7 +248,7 @@
 	'REPORTED_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_reported', 'POST_REPORTED', false, true),
 	'UNAPPROVED_IMG'	=&gt; $_CLASS['core_user']-&gt;img('icon_unapproved', 'POST_UNAPPROVED', false, true),
 
-	'S_MCP_ACTION'		=&gt; generate_link(&quot;$url&amp;mode=$mode&amp;action=$action&quot;.(($start) ? '&amp;start='.$start : '')),
+	'S_MCP_ACTION'		=&gt; generate_link(&quot;$url&amp;mode=$mode&quot;.(($start) ? '&amp;start='.$start : '')),
 	'S_FORUM_SELECT'	=&gt; '&lt;select name=&quot;to_forum_id&quot;&gt;' . (($to_forum_id) ? make_forum_select($to_forum_id) : make_forum_select($topic_info['forum_id'])) . '&lt;/select&gt;',
 	'S_CAN_SPLIT'		=&gt; $_CLASS['forums_auth']-&gt;acl_get('m_split', $topic_info['forum_id']),
 	'S_CAN_MERGE'		=&gt; $_CLASS['forums_auth']-&gt;acl_get('m_merge', $topic_info['forum_id']),
@@ -250,7 +275,7 @@
 
 $_CLASS['core_display']-&gt;display($_CLASS['core_user']-&gt;get_lang('MCP'), 'modules/forums/mcp_topic.html');
 
-function split_topic($mode, $post_id_list, $topic_id, $to_forum_id, $subject)
+function split_topic($action, $post_id_list, $topic_id, $to_forum_id, $subject)
 {
 	global $_CLASS;
 
@@ -268,6 +293,7 @@
 	{
 		return 'NO_POST_SELECTED';
 	}
+	$post_info = $post_info[$post_id];
 
 	$subject = trim($subject);
 
@@ -301,7 +327,7 @@
 		'post_id_list'	=&gt; $post_id_list,
 		'mode'			=&gt; 'topic_view',
 		'start'			=&gt; $start,
-		'action'		=&gt; $mode,
+		'action'		=&gt; $action,
 		't'				=&gt; $topic_id,
 		'redirect'		=&gt; $redirect,
 		'subject'		=&gt; $subject,
@@ -309,18 +335,18 @@
 		'icon'			=&gt; get_variable('icon', 'REQUEST', false, 'int')
 	));
 
-	$message = ($mode === 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
+	$message = ($action === 'split_all') ? 'SPLIT_TOPIC_ALL' : 'SPLIT_TOPIC_BEYOND';
 
 	if (display_confirmation($_CLASS['core_user']-&gt;get_lang($message), $hidden_fields))
 	{
-		if ($mode === 'split_beyond')
+		if ($action === 'split_beyond')
 		{
-			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $forum_id, $topic_id);
+			mcp_sorting('viewtopic', $sort_days, $sort_key, $sort_dir, $sort_by_sql, $sort_order_sql, $total, $post_info['forum_id'], $topic_id);
 			$limit_time_sql = ($sort_days) ? 'AND t.topic_last_post_time &gt;= ' . ($_CLASS['core_user']-&gt;time - ($sort_days * 86400)) : '';
 
 			if ($sort_order_sql{0} == 'u')
 			{
-				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+				$sql = 'SELECT p.post_id
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . CORE_USERS_TABLE . &quot; u
 					WHERE p.topic_id = $topic_id
 						AND p.poster_id = u.user_id
@@ -329,7 +355,7 @@
 			}
 			else
 			{
-				$sql = 'SELECT p.post_id, p.poster_id, p.post_username, p.post_time
+				$sql = 'SELECT p.post_id
 					FROM ' . FORUMS_POSTS_TABLE . &quot; p
 					WHERE p.topic_id = $topic_id
 						$limit_time_sql
@@ -344,11 +370,8 @@
 			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
 				// Start to store post_ids as soon as we see the first post that was selected
-				if ($row['post_id'] == $post_id)
+				if ($row['post_id'] === $post_id)
 				{
-					$topic_time = $row['post_time'];
-					$topic_poster = $row['poster_id'];
-					$topic_poster_name = $row['post_username'];
 					$store = true;
 				}
 
@@ -365,7 +388,7 @@
 			trigger_error('NO_POST_SELECTED');
 		}
 
-		$icon_id =  get_variable('icon', 'REQUEST', false, 'int');
+		$icon_id = get_variable('icon', 'REQUEST', 0, 'int');
 
 		$_CLASS['core_db']-&gt;transaction();
 
@@ -374,9 +397,9 @@
 			'topic_title'				=&gt; $subject,
 			'icon_id'					=&gt; $icon_id,
 			'topic_approved'			=&gt; 1,
-			'topic_poster' 				=&gt; $topic_poster,
-			'topic_first_poster_name'	=&gt; $topic_poster_name,
-			'topic_time'				=&gt; $_CLASS['core_user']-&gt;time,
+			'topic_poster' 				=&gt; $post_info['poster_id'],
+			'topic_first_poster_name'	=&gt; $post_info['post_username'],
+			'topic_time'				=&gt; $_CLASS['core_user']-&gt;time,//$post_info['post_time']
 			'topic_status'				=&gt; ITEM_UNLOCKED,
 			'topic_type'				=&gt; POST_NORMAL,
 			'topic_attachment'			=&gt; 0,

Modified: cms/trunk/includes/forums/message_parser.php
===================================================================
--- cms/trunk/includes/forums/message_parser.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/forums/message_parser.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -48,9 +48,10 @@
 		}
 
 		global $_CLASS;
-		$this-&gt;bbcode_bitfield = 0;
+		$this-&gt;bbcode_bitfield = '';
+		$bitfield = new bitfield();
 
-		$size = strlen($this-&gt;message);
+		$size = mb_strlen($this-&gt;message);
 		foreach ($this-&gt;bbcodes as $bbcode_name =&gt; $bbcode_data)
 		{
 			if (isset($bbcode_data['disabled']) &amp;&amp; $bbcode_data['disabled'])
@@ -74,16 +75,38 @@
 
 			// Because we add bbcode_uid to all tags, the message length
 			// will increase whenever a tag is found
-			$new_size = strlen($this-&gt;message);
+			$new_size = mb_strlen($this-&gt;message);
 
-			if ($size != $new_size)
+			if ($size !== $new_size)
 			{
-				$this-&gt;bbcode_bitfield |= (1 &lt;&lt; $bbcode_data['bbcode_id']);
+				$bitfield-&gt;set($bbcode_data['bbcode_id']);
 				$size = $new_size;
 			}
 		}
+
+		$this-&gt;bbcode_bitfield = $bitfield-&gt;get_base64();
 	}
 
+	/**
+	* Prepare some bbcodes for better parsing
+	*/
+	function prepare_bbcodes()
+	{
+		// Add newline at the end and in front of each quote block to prevent parsing errors (urls, smilies, etc.)
+		if (strpos($this-&gt;message, '[quote') !== false)
+		{
+			$in = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, $this-&gt;message);
+
+			$this-&gt;message = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array(&quot;[quote\\1]\n\\2&quot;, &quot;\\1\n[/quote]&quot;), $this-&gt;message);
+			$this-&gt;message = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array(&quot;[quote\\1]\n\\2&quot;, &quot;\\1\n[/quote]&quot;), $this-&gt;message);
+		}
+
+		// Add other checks which needs to be placed before actually parsing anything (be it bbcodes, smilies, urls...)
+	}
+
+	/**
+	* Init bbcode data for later parsing
+	*/
 	function bbcode_init()
 	{
 		static $rowset;
@@ -91,33 +114,37 @@
 		// This array holds all bbcode data. BBCodes will be processed in this
 		// order, so it is important to keep [code] in first position and
 		// [quote] in second position.
-		$this-&gt;bbcodes = array(
-			'code'		=&gt;	array('bbcode_id' =&gt; 8, 'regexp' =&gt; array('#\[code(?:=([a-z]+))?\](.+\[/code\])#ise' =&gt; &quot;\$this-&gt;bbcode_code('\$1', '\$2')&quot;)),
-			'quote'		=&gt;	array('bbcode_id' =&gt; 0, 'regexp' =&gt; array('#\[quote(?:=&quot;(.*?)&quot;)?\](.+)\[/quote\]#ise' =&gt; &quot;\$this-&gt;bbcode_quote('\$0')&quot;)),
-			'attachment'=&gt;	array('bbcode_id' =&gt; 12, 'regexp' =&gt; array('#\[attachment=([0-9]+)\](.*?)\[/attachment\]#ise' =&gt; &quot;\$this-&gt;bbcode_attachment('\$1', '\$2')&quot;)),
-			'b'			=&gt;	array('bbcode_id' =&gt; 1, 'regexp' =&gt; array('#\[b\](.*?)\[/b\]#ise' =&gt; &quot;\$this-&gt;bbcode_strong('\$1')&quot;)),
-			'i'			=&gt;	array('bbcode_id' =&gt; 2, 'regexp' =&gt; array('#\[i\](.*?)\[/i\]#ise' =&gt; &quot;\$this-&gt;bbcode_italic('\$1')&quot;)),
-			'url'		=&gt;	array('bbcode_id' =&gt; 3, 'regexp' =&gt; array('#\[url(=(.*))?\](.*)\[/url\]#ie' =&gt; &quot;\$this-&gt;validate_url('\$2', '\$3')&quot;)),
-			'img'		=&gt;	array('bbcode_id' =&gt; 4, 'regexp' =&gt; array('#\[img\](https?://)([a-z0-9\-\.,\?!%\*_:;~\\&amp;$@/=\+]+)\[/img\]#ie' =&gt; &quot;\$this-&gt;bbcode_img('\$1\$2')&quot;)),
-			'size'		=&gt;	array('bbcode_id' =&gt; 5, 'regexp' =&gt; array('#\[size=([\-\+]?[1-2]?[0-9])\](.*?)\[/size\]#ise' =&gt; &quot;\$this-&gt;bbcode_size('\$1', '\$2')&quot;)),
-			'color'		=&gt;	array('bbcode_id' =&gt; 6, 'regexp' =&gt; array('!\[color=(#[0-9A-F]{6}|[a-z\-]+)\](.*?)\[/color\]!ise' =&gt; &quot;\$this-&gt;bbcode_color('\$1', '\$2')&quot;)),
-			'u'			=&gt;	array('bbcode_id' =&gt; 7, 'regexp' =&gt; array('#\[u\](.*?)\[/u\]#ise' =&gt; &quot;\$this-&gt;bbcode_underline('\$1')&quot;)),
-			'list'		=&gt;	array('bbcode_id' =&gt; 9, 'regexp' =&gt; array('#\[list(=[a-z|0-9|(?:disc|circle|square))]+)?\].*\[/list\]#ise' =&gt; &quot;\$this-&gt;bbcode_parse_list('\$0')&quot;)),
-			'email'		=&gt;	array('bbcode_id' =&gt; 10, 'regexp' =&gt; array('#\[email=?(.*?)?\](.*?)\[/email\]#ise' =&gt; &quot;\$this-&gt;validate_email('\$1', '\$2')&quot;)),
-			'flash'		=&gt;	array('bbcode_id' =&gt; 11, 'regexp' =&gt; array('#\[flash=([0-9]+),([0-9]+)\](.*?)\[/flash\]#ie' =&gt; &quot;\$this-&gt;bbcode_flash('\$1', '\$2', '\$3')&quot;))
-		);
+		$this-&gt;bbcodes = array(
+			'code'			=&gt; array('bbcode_id' =&gt; 8,	'regexp' =&gt; array('#\[code(?:=([a-z]+))?\](.+\[/code\])#ise' =&gt; &quot;\$this-&gt;bbcode_code('\$1', '\$2')&quot;)),
+			'quote'			=&gt; array('bbcode_id' =&gt; 0,	'regexp' =&gt; array('#\[quote(?:=&quot;(.*?)&quot;)?\](.+)\[/quote\]#ise' =&gt; &quot;\$this-&gt;bbcode_quote('\$0')&quot;)),
+			'attachment'	=&gt; array('bbcode_id' =&gt; 12,	'regexp' =&gt; array('#\[attachment=([0-9]+)\](.*?)\[/attachment\]#ise' =&gt; &quot;\$this-&gt;bbcode_attachment('\$1', '\$2')&quot;)),
+			'b'				=&gt; array('bbcode_id' =&gt; 1,	'regexp' =&gt; array('#\[b\](.*?)\[/b\]#ise' =&gt; &quot;\$this-&gt;bbcode_strong('\$1')&quot;)),
+			'i'				=&gt; array('bbcode_id' =&gt; 2,	'regexp' =&gt; array('#\[i\](.*?)\[/i\]#ise' =&gt; &quot;\$this-&gt;bbcode_italic('\$1')&quot;)),
+			'url'			=&gt; array('bbcode_id' =&gt; 3,	'regexp' =&gt; array('#\[url(=(.*))?\](.*)\[/url\]#iUe' =&gt; &quot;\$this-&gt;validate_url('\$2', '\$3')&quot;)),
+			'img'			=&gt; array('bbcode_id' =&gt; 4,	'regexp' =&gt; array('#\[img\](https?://)([a-z0-9\-\.,\?!%\*_:;~\\&amp;$@/=\+]+)\[/img\]#ie' =&gt; &quot;\$this-&gt;bbcode_img('\$1\$2')&quot;)),
+			'size'			=&gt; array('bbcode_id' =&gt; 5,	'regexp' =&gt; array('#\[size=([\-\+]?[1-2]?[0-9])\](.*?)\[/size\]#ise' =&gt; &quot;\$this-&gt;bbcode_size('\$1', '\$2')&quot;)),
+			'color'			=&gt; array('bbcode_id' =&gt; 6,	'regexp' =&gt; array('!\[color=(#[0-9A-Fa-f]{6}|[a-z\-]+)\](.*?)\[/color\]!ise' =&gt; &quot;\$this-&gt;bbcode_color('\$1', '\$2')&quot;)),
+			'u'				=&gt; array('bbcode_id' =&gt; 7,	'regexp' =&gt; array('#\[u\](.*?)\[/u\]#ise' =&gt; &quot;\$this-&gt;bbcode_underline('\$1')&quot;)),
+			'list'			=&gt; array('bbcode_id' =&gt; 9,	'regexp' =&gt; array('#\[list(=[a-z|0-9|(?:disc|circle|square))]+)?\].*\[/list\]#ise' =&gt; &quot;\$this-&gt;bbcode_parse_list('\$0')&quot;)),
+			'email'			=&gt; array('bbcode_id' =&gt; 10,	'regexp' =&gt; array('#\[email=?(.*?)?\](.*?)\[/email\]#ise' =&gt; &quot;\$this-&gt;validate_email('\$1', '\$2')&quot;)),
+			'flash'			=&gt; array('bbcode_id' =&gt; 11,	'regexp' =&gt; array('#\[flash=([0-9]+),([0-9]+)\](.*?)\[/flash\]#ie' =&gt; &quot;\$this-&gt;bbcode_flash('\$1', '\$2', '\$3')&quot;))
+		);
 		
-		$this-&gt;parsed_items = array('code' =&gt; 0, 'quote' =&gt; 0, 'attachment' =&gt; 0, 'b' =&gt; 0, 'i' =&gt; 0, 'url' =&gt; 0, 'img' =&gt; 0, 'size' =&gt; 0, 'color' =&gt; 0, 'u' =&gt; 0, 'list' =&gt; 0, 'email' =&gt; 0, 'flash' =&gt; 0);
+		// Zero the parsed items array
+		$this-&gt;parsed_items = array();
+
+		foreach ($this-&gt;bbcodes as $tag =&gt; $bbcode_data)
+		{
+			$this-&gt;parsed_items[$tag] = 0;
+		}
 		
-		/*
-		if (!is_array($rowset))
+		/*if (!is_array($rowset))
 		{
 			$rowset = array();
 
-			
 			global $_CLASS;
 
-			$sql = 'SELECT bbcode_id, bbcode_tag, first_pass_match, first_pass_replace
+			$sql = 'SELECT *
 				FROM ' . FORUMS_BBCODES_TABLE;
 
 			$result = $_CLASS['core_db']-&gt;query($sql);
@@ -126,26 +153,30 @@
 				$rowset[] = $row;
 			}
 			$_CLASS['core_db']-&gt;free_result($result);
-			
 		}
-		
-		foreach ($rowset as $row)
-		{
-			$this-&gt;bbcodes[$row['bbcode_tag']] = array(
-				'bbcode_id'	=&gt;	intval($row['bbcode_id']),
-				'regexp'	=&gt;	array($row['first_pass_match'] =&gt; str_replace('$uid', $this-&gt;bbcode_uid, $row['first_pass_replace']))
-			);
-		}
-		*/
+
+		foreach ($rowset as $row)
+		{
+			$this-&gt;bbcodes[$row['bbcode_tag']] = array(
+				'bbcode_id'	=&gt; (int) $row['bbcode_id'],
+				'regexp'	=&gt; array($row['first_pass_match'] =&gt; str_replace('$uid', $this-&gt;bbcode_uid, $row['first_pass_replace']))
+			);
+		}*/
 	}
-	
+
+	/**
+	* Making some pre-checks for bbcodes as well as increasing the number of parsed items
+	*/
 	function check_bbcode($bbcode, &amp;$in)
 	{
-		$in = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($in)));
+		// when using the /e modifier, preg_replace slashes double-quotes but does not
+		// seem to slash anything else
+		$in = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', $in));
 
-		if (!$in)
-		{
-			return false;
+		// Trimming here to make sure no empty bbcodes are parsed accidently
+		if (trim($in) == '')
+		{
+			return false;
 		}
 		
 		$this-&gt;parsed_items[$bbcode]++;
@@ -153,99 +184,191 @@
 		return true;
 	}
 
-	function bbcode_size($stx, $in)
-	{
-		if (!$this-&gt;check_bbcode('size', $in))
-		{
-			return '';
+	/**
+	* Transform some characters in valid bbcodes
+	*/
+	function bbcode_specialchars($text)
+	{
+		$str_from = array('&lt;', '&gt;', '[', ']', '.', ':');
+		$str_to = array('&lt;', '&gt;', '&#91;', '&#93;', '&#46;', '&#58;');
+
+		return str_replace($str_from, $str_to, $text);
+	}
+
+	/**
+	* Parse size tag
+	*/
+	function bbcode_size($stx, $in)
+	{
+		if (!$this-&gt;check_bbcode('size', $in))
+		{
+			return '';
 		}
-		
-		return '[size=' . $stx . ':' . $this-&gt;bbcode_uid . ']' . $in . '[/size:' . $this-&gt;bbcode_uid . ']';
+
+		/*global $_CLASS, $config;
+		if ($config['max_' . $this-&gt;mode . '_font_size'] &amp;&amp; $config['max_' . $this-&gt;mode . '_font_size'] &lt; $stx)
+		{
+			$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['MAX_FONT_SIZE_EXCEEDED'], $config['max_' . $this-&gt;mode . '_font_size']);
+		}*/
+
+		return '[size=' . $stx . ':' . $this-&gt;bbcode_uid . ']' . $in . '[/size:' . $this-&gt;bbcode_uid . ']';
 	}
 
-	function bbcode_color($stx, $in)
-	{
-		if (!$this-&gt;check_bbcode('color', $in))
-		{
-			return '';
-		}
-
-		return '[color=' . $stx . ':' . $this-&gt;bbcode_uid . ']' . $in . '[/color:' . $this-&gt;bbcode_uid . ']';
+	/**
+	* Parse color tag
+	*/
+	function bbcode_color($stx, $in)
+	{
+		if (!$this-&gt;check_bbcode('color', $in))
+		{
+			return '';
+		}
+
+		return '[color=' . $stx . ':' . $this-&gt;bbcode_uid . ']' . $in . '[/color:' . $this-&gt;bbcode_uid . ']';
 	}
-	
-	function bbcode_underline($in)
-	{
-		if (!$this-&gt;check_bbcode('u', $in))
-		{
-			return '';
-		}
 
-		return '[u:' . $this-&gt;bbcode_uid . ']' . $in . '[/u:' . $this-&gt;bbcode_uid . ']';
+	/**
+	* Parse u tag
+	*/
+	function bbcode_underline($in)
+	{
+		if (!$this-&gt;check_bbcode('u', $in))
+		{
+			return '';
+		}
+
+		return '[u:' . $this-&gt;bbcode_uid . ']' . $in . '[/u:' . $this-&gt;bbcode_uid . ']';
 	}
 
-	function bbcode_strong($in)
-	{
-		if (!$this-&gt;check_bbcode('b', $in))
-		{
-			return '';
-		}
-
-		return '[b:' . $this-&gt;bbcode_uid . ']' . $in . '[/b:' . $this-&gt;bbcode_uid . ']';
+	/**
+	* Parse b tag
+	*/
+	function bbcode_strong($in)
+	{
+		if (!$this-&gt;check_bbcode('b', $in))
+		{
+			return '';
+		}
+
+		return '[b:' . $this-&gt;bbcode_uid . ']' . $in . '[/b:' . $this-&gt;bbcode_uid . ']';
 	}
 	
-	function bbcode_italic($in)
-	{
-		if (!$this-&gt;check_bbcode('i', $in))
-		{
-			return '';
-		}
-
-		return '[i:' . $this-&gt;bbcode_uid . ']' . $in . '[/i:' . $this-&gt;bbcode_uid . ']';
+	/**
+	* Parse i tag
+	*/
+	function bbcode_italic($in)
+	{
+		if (!$this-&gt;check_bbcode('i', $in))
+		{
+			return '';
+		}
+
+		return '[i:' . $this-&gt;bbcode_uid . ']' . $in . '[/i:' . $this-&gt;bbcode_uid . ']';
 	}
 	
-	function bbcode_img($in)
-	{
-		if (!$this-&gt;check_bbcode('img', $in))
-		{
-			return '';
-		}
+	/**
+	* Parse img tag
+	*/
+	function bbcode_img($in)
+	{
+		if (!$this-&gt;check_bbcode('img', $in))
+		{
+			return '';
+		}
+
+		$in = trim($in);
 
-		return '[img:' . $this-&gt;bbcode_uid . ']' . $in . '[/img:' . $this-&gt;bbcode_uid . ']';
+		/*global $_CLASS, $config;
+
+		if ($config['max_' . $this-&gt;mode . '_img_height'] || $config['max_' . $this-&gt;mode . '_img_width'])
+		{
+			$stats = @getimagesize($in);
+
+			if ($stats === false)
+			{
+				$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['UNABLE_GET_IMAGE_SIZE'];
+			}
+			else
+			{
+				if ($config['max_' . $this-&gt;mode . '_img_height'] &amp;&amp; $config['max_' . $this-&gt;mode . '_img_height'] &lt; $stats[1])
+				{
+					$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['MAX_IMG_HEIGHT_EXCEEDED'], $config['max_' . $this-&gt;mode . '_img_height']);
+				}
+
+				if ($config['max_' . $this-&gt;mode . '_img_width'] &amp;&amp; $config['max_' . $this-&gt;mode . '_img_width'] &lt; $stats[0])
+				{
+					$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['MAX_IMG_WIDTH_EXCEEDED'], $config['max_' . $this-&gt;mode . '_img_width']);
+				}
+			}
+		}*/
+
+		if ($this-&gt;path_in_domain($in))
+		{
+			return '[img]' . $in . '[/img]';
+		}
+
+		return '[img:' . $this-&gt;bbcode_uid . ']' . $this-&gt;bbcode_specialchars($in) . '[/img:' . $this-&gt;bbcode_uid . ']';
 	}
 
-	function bbcode_flash($width, $height, $in)
-	{
-		if (!$this-&gt;check_bbcode('flash', $in))
-		{
-			return '';
-		}
-	
-		return '[flash=' . $width . ',' . $height . ':' . $this-&gt;bbcode_uid . ']' . $in . '[/flash:' . $this-&gt;bbcode_uid . ']';
+	/**
+	* Parse flash tag
+	*/
+	function bbcode_flash($width, $height, $in)
+	{
+		if (!$this-&gt;check_bbcode('flash', $in))
+		{
+			return '';
+		}
+
+		$in = trim($in);
+
+		/*global $_CLASS, $config;
+		// Apply the same size checks on flash files as on images
+		if ($config['max_' . $this-&gt;mode . '_img_height'] || $config['max_' . $this-&gt;mode . '_img_width'])
+		{
+			if ($config['max_' . $this-&gt;mode . '_img_height'] &amp;&amp; $config['max_' . $this-&gt;mode . '_img_height'] &lt; $height)
+			{
+				$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['MAX_FLASH_HEIGHT_EXCEEDED'], $config['max_' . $this-&gt;mode . '_img_height']);
+			}
+
+			if ($config['max_' . $this-&gt;mode . '_img_width'] &amp;&amp; $config['max_' . $this-&gt;mode . '_img_width'] &lt; $width)
+			{
+				$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['MAX_FLASH_WIDTH_EXCEEDED'], $config['max_' . $this-&gt;mode . '_img_width']);
+			}
+		}*/
+
+		if ($this-&gt;path_in_domain($in))
+		{
+			return '[flash=' . $width . ',' . $height . ']' . $in . '[/flash]';
+		}
+
+		return '[flash=' . $width . ',' . $height . ':' . $this-&gt;bbcode_uid . ']' . $this-&gt;bbcode_specialchars($in) . '[/flash:' . $this-&gt;bbcode_uid . ']';
 	}
 	
-	// Hardcode inline attachments [ia]
-	function bbcode_attachment($stx, $in)
-	{
-		if (!$this-&gt;check_bbcode('attachment', $in))
-		{
-			return '';
-		}
+	/**
+	* Parse inline attachments [ia]
+	*/
+	function bbcode_attachment($stx, $in)
+	{
+		if (!$this-&gt;check_bbcode('attachment', $in))
+		{
+			return '';
+		}
+
+		return '[attachment=' . $stx . ':' . $this-&gt;bbcode_uid . ']&lt;!-- ia' . $stx . ' --&gt;' . trim($in) . '&lt;!-- ia' . $stx . ' --&gt;[/attachment:' . $this-&gt;bbcode_uid . ']';
+	}
 
-		return '[attachment=' . $stx . ':' . $this-&gt;bbcode_uid . ']&lt;!-- ia' . $stx . ' --&gt;' . $in . '&lt;!-- ia' . $stx . ' --&gt;[/attachment:' . $this-&gt;bbcode_uid . ']';
-	}
-
-	// Expects the argument to start right after the opening [code] tag and to end with [/code]
-	function bbcode_code($stx, $in)
-	{
-		// when using the /e modifier, preg_replace slashes double-quotes but does not
-		// seem to slash anything else
-		if (!$this-&gt;check_bbcode('list', $in))
-		{
-			return '';
+	/**
+	* Parse code tag
+	* Expects the argument to start right after the opening [code] tag and to end with [/code]
+	*/
+	function bbcode_code($stx, $in)
+	{
+		if (!$this-&gt;check_bbcode('code', $in))
+		{
+			return '';
 		}
 
-		$this-&gt;parsed_items['code']++;
-
 		// We remove the hardcoded elements from the code block here because it is not used in code blocks
 		// Having it here saves us one preg_replace per message containing [code] blocks
 		// Additionally, magic url parsing should go after parsing bbcodes, but for safety those are stripped out too...
@@ -294,71 +417,65 @@
 				case 'php':
 					$remove_tags = false;
 
-					$str_from = array('&lt;', '&gt;', '&amp;', '&quot;', '&amp;\#039;', '&nbsp;');
-					$str_to = array('&lt;', '&gt;', '&amp;', '&quot;', &quot;'&quot;, ' ');
+					$code = str_replace(array('&lt;', '&gt;'), array('&lt;', '&gt;'), $code);
 
-					$code = str_replace($str_from, $str_to, $code);
-
-					if (!preg_match('/^\&lt;\?(.*?)\?\&gt;/is', $code))
+					if (!preg_match('/\&lt;\?.*?\?\&gt;/is', $code))
 					{
 						$remove_tags = true;
 						$code = '&lt;?php '. $code;
 					}
 
 					$conf = array('highlight.bg', 'highlight.comment', 'highlight.default', 'highlight.html', 'highlight.keyword', 'highlight.string');
-
 					foreach ($conf as $ini_var)
 					{
 						ini_set($ini_var, str_replace('highlight.', 'syntax', $ini_var));
 					}
-					
+
+					// Because highlight_string is specialcharing the text (but we already did this before), we have to reverse this in order to get correct results
+					$code = html_entity_decode($code);
 					$code = highlight_string($code, true);
 
-					if (version_compare(PHP_VERSION, '5.0', '&lt;'))
-					{
-						$code = str_replace('&lt;font color=&quot;syntax', '&lt;span class=&quot;syntax', $code);
-						$code = str_replace('&lt;font color=&quot;', '&lt;span style=&quot;color: ', $code);
-						$code = str_replace('&lt;/font&gt;', '&lt;/span&gt;', $code);
-					}
-					else
-					{
-						$code = str_replace('&lt;span style=&quot;color: syntax', '&lt;span class=&quot;syntax', $code);
-					}
-
-					$str_from = array('&lt;code&gt;', '&lt;/code&gt;','[', ']', '.', ':', '&amp;#058;');
-					$str_to = array('', '', '&#91;', '&#93;', '&#46;', '&amp;#58', '&#058;');
+					$str_from = array('&lt;span style=&quot;color: ', '&lt;font color=&quot;syntax', '&lt;/font&gt;', '&lt;code&gt;', '&lt;/code&gt;','[', ']', '.', ':');
+					$str_to = array('&lt;span class=&quot;', '&lt;span class=&quot;syntax', '&lt;/span&gt;', '', '', '&#91;', '&#93;', '&#46;', '&#58;');
 
-					$code = str_replace($str_from, $str_to, $code);
 					if ($remove_tags)
 					{
-						// if theres any problems with this, find the first &quot;php&quot; without span remove it
-						// then find the first &lt;/span&gt; and remove it
-						$pos = ($pos = mb_strpos($code, 'php&nbsp;')) ? $pos + 9 : mb_strpos($code, 'php ') + 40;
-						$section = mb_substr($code, 0, $pos);
-						$code = mb_substr($code, $pos);
-						$code = str_replace(array('&lt;?', '&lt;?', 'php&nbsp;', 'php '), '', $section).$code;
-					}
-	
+						$str_from[] = '&lt;span class=&quot;syntaxdefault&quot;&gt;&lt;?php &lt;/span&gt;';
+						$str_to[] = '';
+						$str_from[] = '&lt;span class=&quot;syntaxdefault&quot;&gt;&lt;?php&nbsp;';
+						$str_to[] = '&lt;span class=&quot;syntaxdefault&quot;&gt;';
+					}
+
+					$code = str_replace($str_from, $str_to, $code);
 					$code = preg_replace('#^(&lt;span class=&quot;[a-z_]+&quot;&gt;)\n?(.*?)\n?(&lt;/span&gt;)$#is', '$1$2$3', $code);
+
+					if ($remove_tags)
+					{
+						$code = preg_replace('#(&lt;span class=&quot;[a-z]+&quot;&gt;)?\?&gt;&lt;/span&gt;#', '', $code);
+					}
+
 					$code = preg_replace('#^&lt;span class=&quot;[a-z]+&quot;&gt;&lt;span class=&quot;([a-z]+)&quot;&gt;(.*)&lt;/span&gt;&lt;/span&gt;#s', '&lt;span class=&quot;$1&quot;&gt;$2&lt;/span&gt;', $code);
 					$code = preg_replace('#(?:[\n\r\s\t]|&nbsp;)*&lt;/span&gt;$#', '&lt;/span&gt;', $code);
-			//echo $code; die;	
-					$out .= &quot;[code=$stx:&quot; . $this-&gt;bbcode_uid . ']' . trim($code) . '[/code:' . $this-&gt;bbcode_uid . ']';
+
+					// remove newline at the end
+					if (!empty($code) &amp;&amp; $code{strlen($code)-1} == &quot;\n&quot;)
+					{
+						$code = substr($code, 0, -1);
+					}
+
+					$out .= &quot;[code=$stx:&quot; . $this-&gt;bbcode_uid . ']' . $code . '[/code:' . $this-&gt;bbcode_uid . ']';
 				break;
 
-				default:
-					$str_from = array('&lt;', '&gt;', '[', ']', '.', ':');
-					$str_to = array('&lt;', '&gt;', '&#91;', '&#93;', '&#46;', '&amp;#58');
-
-					$out .= '[code:' . $this-&gt;bbcode_uid . ']' . str_replace($str_from, $str_to, $code) . '[/code:' . $this-&gt;bbcode_uid . ']';
+				default:
+					$out .= '[code:' . $this-&gt;bbcode_uid . ']' . $this-&gt;bbcode_specialchars($code) . '[/code:' . $this-&gt;bbcode_uid . ']';
 				break;
 			}
 
-			if (preg_match('#(.*?)\[code(?:=([a-z]+))?\](.+)#is', $in, $m))
-			{
-				$out .= $m[1];
-				$stx = $m[2];
-				$in = $m[3];
+			if (preg_match('#(.*?)\[code(?:=([a-z]+))?\](.+)#is', $in, $m))
+			{
+				$out .= $m[1];
+				$stx = $m[2];
+				$in = $m[3];
 			}
 		}
 		while ($in);
@@ -366,335 +483,400 @@
 		return $out;
 	}
 
-	// Expects the argument to start with a tag
-	function bbcode_parse_list($in)
-	{
-		if (!$this-&gt;check_bbcode('list', $in))
-		{
-			return '';
-		}
-		
-		$in = str_replace('\&quot;', '&quot;', $in);
-		$out = '[';
+	/**
+	* Parse list bbcode
+	* Expects the argument to start with a tag
+	*/
+	function bbcode_parse_list($in)
+	{
+		if (!$this-&gt;check_bbcode('list', $in))
+		{
+			return '';
+		}
+
+		$out = '[';
+
+		// Grab item_start with no item_end
+		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])#is', '[*:' . $this-&gt;bbcode_uid . ']\1[/*:m:' . $this-&gt;bbcode_uid . ']\2', $in);
+
+		// Grab them again as backreference
+		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])(^\[\/*\])#is', '[*:' . $this-&gt;bbcode_uid . ']\1[/*:m:' . $this-&gt;bbcode_uid . ']\2', $in);
+
+		// Grab end tag following start tag
+		$in = preg_replace('#\[\/\*:m:' . $this-&gt;bbcode_uid . '\](\n|)\[\*\]#is', '[/*:m:' . $this-&gt;bbcode_uid . '][*:' . $this-&gt;bbcode_uid . ']', $in);
+
+		// Replace end tag
+		$in = preg_replace('#\[\/\*\]#i', '[/*:' . $this-&gt;bbcode_uid . ']', $in);
+
+		// $tok holds characters to stop at. Since the string starts with a '[' we'll get everything up to the first ']' which should be the opening [list] tag
+		$tok = ']';
+		$out = '[';
+
+		$in = substr($in, 1);
+		$list_end_tags = array();
+
+		do
+		{
+			$pos = strlen($in);
+			for ($i = 0; $i &lt; strlen($tok); ++$i)
+			{
+				$tmp_pos = strpos($in, $tok{$i});
+
+				if ($tmp_pos !== false &amp;&amp; $tmp_pos &lt; $pos)
+				{
+					$pos = $tmp_pos;
+				}
+			}
+
+			$buffer = substr($in, 0, $pos);
+			$tok = $in{$pos};
+
+			$in = substr($in, $pos + 1);
+
+			if ($tok == ']')
+			{
+				// if $tok is ']' the buffer holds a tag
+				if ($buffer == '/list' &amp;&amp; sizeof($list_end_tags))
+				{
+					$out .= array_pop($list_end_tags) . ']';
+					$tok = '[';
+				}
+				else if (preg_match('#list(=?(?:[0-9]|[a-z]|))#i', $buffer, $m))
+				{
+					// sub-list, add a closing tag
+					if (!$m[1] || preg_match('/^(disc|square|circle)$/i', $m[1]))
+					{
+						array_push($list_end_tags, '/list:u:' . $this-&gt;bbcode_uid);
+					}
+					else
+					{
+						array_push($list_end_tags, '/list:o:' . $this-&gt;bbcode_uid);
+					}
+					$out .= $buffer . ':' . $this-&gt;bbcode_uid . ']';
+					$tok = '[';
+				}
+				else
+				{
+					$out .= $buffer . $tok;
+					$tok = '[]';
+				}
+			}
+			else
+			{
+				// Not within a tag, just add buffer to the return string
+				$out .= $buffer . $tok;
+				$tok = ($tok == '[') ? ']' : '[]';
+			}
+		}
+		while ($in);
+
+		if (sizeof($list_end_tags))
+		{
+			$out .= '[' . implode('][', $list_end_tags) . ']';
+		}
+
+		return $out;
+	}
 
-		// Grab item_start with no item_end
-		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])#is', '[*:' . $this-&gt;bbcode_uid . ']\1[/*:m:' . $this-&gt;bbcode_uid . ']\2', $in);
-
-		// Grab them again as backreference
-		$in = preg_replace('#\[\*\](.*?)(\[\/list\]|\[list(=?(?:[0-9]|[a-z]|))\]|\[\*\])(^\[\/*\])#is', '[*:' . $this-&gt;bbcode_uid . ']\1[/*:m:' . $this-&gt;bbcode_uid . ']\2', $in);
-		
-		// Grab end tag following start tag
-		$in = preg_replace('#\[\/\*:m:' . $this-&gt;bbcode_uid . '\](\n|)\[\*\]#is', '[/*:m:' . $this-&gt;bbcode_uid . '][*:' . $this-&gt;bbcode_uid . ']', $in);
-		
-		// Replace end tag
-		$in = preg_replace('#\[\/\*\]#i', '[/*:' . $this-&gt;bbcode_uid . ']', $in);
-		
-		// $tok holds characters to stop at. Since the string starts with a '[' we'll get everything up to the first ']' which should be the opening [list] tag
-		$tok = ']';
-		$out = '[';
-
-
-		$in = substr($in, 1);
-		$list_end_tags = array();
-
-		do
-		{
-			$pos = strlen($in);
-			for ($i = 0; $i &lt; strlen($tok); ++$i)
-			{
-				$tmp_pos = strpos($in, $tok{$i});
-				
-				if ($tmp_pos !== false &amp;&amp; $tmp_pos &lt; $pos)
-				{
-					$pos = $tmp_pos;
-				}
-			}
-
-			$buffer = substr($in, 0, $pos);
-			$tok = $in{$pos};
-
-			$in = substr($in, $pos + 1);
-
-			if ($tok == ']')
-			{
-				// if $tok is ']' the buffer holds a tag
-				if ($buffer == '/list' &amp;&amp; sizeof($list_end_tags))
-				{
-					$out .= array_pop($list_end_tags) . ']';
-					$tok = '[';
-				}
-				elseif (preg_match('#list(=?(?:[0-9]|[a-z]|))#i', $buffer, $m))
-				{
-					// sub-list, add a closing tag
-					if (!$m[1] || preg_match('/^(disc|square|circle)$/i', $m[1]))
-					{
-						array_push($list_end_tags, '/list:u:' . $this-&gt;bbcode_uid);
-					}
-					else
-					{
-						array_push($list_end_tags, '/list:o:' . $this-&gt;bbcode_uid);
-					}
-					$out .= $buffer . ':' . $this-&gt;bbcode_uid . ']';
-					$tok = '[';
-				}
-				else
-				{
-					$out .= $buffer . $tok;
-					$tok = '[]';
-				}
-			}
-			else
-			{
-				// Not within a tag, just add buffer to the return string
-				$out .= $buffer . $tok;
-				$tok = ($tok == '[') ? ']' : '[]';
-			}
-		}
-		while ($in);
-
-		if (sizeof($list_end_tags))
-		{
-			$out .= '[' . implode('][', $list_end_tags) . ']';
-		}
-
-		return $out;
+	/**
+	* Parse quote bbcode
+	* Expects the argument to start with a tag
+	*/
+	function bbcode_quote($in)
+	{
+		global $config, $_CLASS;
+
+		$in = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($in)));
+
+		if (!$in)
+		{
+			return '';
+		}
+
+		$tok = ']';
+		$out = '[';
+
+		$in = substr($in, 1);
+		$close_tags = $error_ary = array();
+		$buffer = '';
+
+		do
+		{
+			$pos = strlen($in);
+			for ($i = 0; $i &lt; strlen($tok); ++$i)
+			{
+				$tmp_pos = strpos($in, $tok{$i});
+				if ($tmp_pos !== false &amp;&amp; $tmp_pos &lt; $pos)
+				{
+					$pos = $tmp_pos;
+				}
+			}
+
+			$buffer .= substr($in, 0, $pos);
+			$tok = $in{$pos};
+			$in = substr($in, $pos + 1);
+
+			if ($tok == ']')
+			{
+				if ($buffer == '/quote' &amp;&amp; sizeof($close_tags))
+				{
+					// we have found a closing tag
+					// Add space at the end of the closing tag to allow following urls/smilies to be parsed correctly
+					$out .= array_pop($close_tags) . '] ';
+					$tok = '[';
+					$buffer = '';
+				}
+				else if (preg_match('#^quote(?:=&quot;(.*?)&quot;)?$#is', $buffer, $m))
+				{
+					$this-&gt;parsed_items['quote']++;
+
+					// the buffer holds a valid opening tag
+					if ($config['max_quote_depth'] &amp;&amp; sizeof($close_tags) &gt;= $config['max_quote_depth'])
+					{
+						// there are too many nested quotes
+						$error_ary['quote_depth'] = sprintf($_CLASS['core_user']-&gt;lang['QUOTE_DEPTH_EXCEEDED'], $config['max_quote_depth']);
+
+						$out .= $buffer . $tok;
+						$tok = '[]';
+						$buffer = '';
+
+						continue;
+					}
+
+					array_push($close_tags, '/quote:' . $this-&gt;bbcode_uid);
+
+					if (isset($m[1]) &amp;&amp; $m[1])
+					{
+						$username = preg_replace('#\[(?!b|i|u|color|url|email|/b|/i|/u|/color|/url|/email)#iU', '&#91;$1', $m[1]);
+						$end_tags = array();
+						$error = false;
+
+						preg_match_all('#\[((?:/)?(?:[a-z]+))#i', $username, $tags);
+						foreach ($tags[1] as $tag)
+						{
+							if ($tag{0} != '/')
+							{
+								$end_tags[] = '/' . $tag;
+							}
+							else
+							{
+								$end_tag = array_pop($end_tags);
+								if ($end_tag != $tag)
+								{
+									$error = true;
+								}
+								else
+								{
+									$error = false;
+								}
+							}
+						}
+
+						if ($error)
+						{
+							$username = str_replace('[', '&#91;', str_replace(']', '&#93;', $m[1]));
+						}
+
+						$out .= 'quote=&quot;' . $username . '&quot;:' . $this-&gt;bbcode_uid . ']';
+					}
+					else
+					{
+						$out .= 'quote:' . $this-&gt;bbcode_uid . ']';
+					}
+
+					$tok = '[';
+					$buffer = '';
+				}
+				else if (preg_match('#^quote=&quot;(.*?)#is', $buffer, $m))
+				{
+					// the buffer holds an invalid opening tag
+					$buffer .= ']';
+				}
+				else
+				{
+					$out .= $buffer . $tok;
+					$tok = '[]';
+					$buffer = '';
+				}
+			}
+			else
+			{
+				$out .= $buffer . $tok;
+				// $tok = ($tok == '[') ? ']' : '[]';
+				$tok = '[]';
+				$buffer = '';
+			}
+		}
+		while ($in);
+
+		if (sizeof($close_tags))
+		{
+			$out .= '[' . implode('][', $close_tags) . ']';
+		}
+
+		foreach ($error_ary as $error_msg)
+		{
+			$this-&gt;warn_msg[] = $error_msg;
+		}
+
+		return $out;
+	}
+
+	/**
+	* Validate email
+	*/
+	function validate_email($var1, $var2)
+	{
+		$var1 = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($var1)));
+		$var2 = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($var2)));
+
+		$txt = $var2;
+		$email = ($var1) ? $var1 : $var2;
+
+		$validated = true;
+
+		if (!preg_match('/^' . get_preg_expression('email') . '$/i', $email))
+		{
+			$validated = false;
+		}
+
+		if (!$validated)
+		{
+			return '[email' . (($var1) ? &quot;=$var1&quot; : '') . ']' . $var2 . '[/email]';
+		}
+
+		$this-&gt;parsed_items['email']++;
+
+		if ($var1)
+		{
+			$retval = '[email=' . $this-&gt;bbcode_specialchars($email) . ':' . $this-&gt;bbcode_uid . ']' . $txt . '[/email:' . $this-&gt;bbcode_uid . ']';
+		}
+		else
+		{
+			$retval = '[email:' . $this-&gt;bbcode_uid . ']' . $this-&gt;bbcode_specialchars($email) . '[/email:' . $this-&gt;bbcode_uid . ']';
+		}
+
+		return $retval;
 	}
 
-	// Expects the argument to start with a tag
-	function bbcode_quote($in)
-	{
-		global $config, $_CLASS;
-
-		$in = trim($in);
-		
-		if (!$in)
-		{
-			return '';
-		}
-		
-		$tok = ']';
-		$out = '[';
-		
-		// Add newline at the end and in front of each quote block to prevent parsing errors (urls, smilies, etc.)
-		$in = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array(&quot;[quote\\1]\n\\2&quot;, &quot;\\1\n[/quote]&quot;), $in);
-		$in = preg_replace(array('#\[quote(=&quot;.*?&quot;)?\]([^\n])#is', '#([^\n])\[\/quote\]#is'), array(&quot;[quote\\1]\n\\2&quot;, &quot;\\1\n[/quote]&quot;), $in);
-		
-		$in = substr(str_replace('\&quot;', '&quot;', $in), 1);
-		$close_tags = $error_ary = array();
-		$buffer = '';
-
-		do
-		{
-			$pos = strlen($in);
-			for ($i = 0; $i &lt; strlen($tok); ++$i)
-			{
-				$tmp_pos = strpos($in, $tok{$i});
-				if ($tmp_pos !== false &amp;&amp; $tmp_pos &lt; $pos)
+	/**
+	* Validate url
+	*/
+	function validate_url($var1, $var2)
+	{
+		global $config;
+
+		$var1 = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($var1)));
+		$var2 = str_replace(&quot;\r\n&quot;, &quot;\n&quot;, str_replace('\&quot;', '&quot;', trim($var2)));
+
+		$url = ($var1) ? $var1 : $var2;
+		$valid = false;
+
+		if (!$url || ($var1 &amp;&amp; !$var2))
+		{
+			return '';
+		}
+
+		// Checking urls
+		if (preg_match('#' . preg_quote(generate_base_url(), '#') . '/([^ \t\n\r&lt;&quot;\']+)#i', $url) ||
+			preg_match('#([\w]+?://.*?[^ \t\n\r&lt;&quot;\']*)#i', $url) ||
+			preg_match('#(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r&lt;&quot;\']*)?)#i', $url))
+		{
+			$valid = true;
+		}
+
+		if ($valid)
+		{
+			$this-&gt;parsed_items['url']++;
+
+			if (!preg_match('#^[\w]+?://.*?#i', $url))
+			{
+				$url = '<A HREF="http://">http://</A>' . $url;
+			}
+
+			// We take our test url and stick on the first bit of text we get to check if we are really at the domain. If so, lets go!
+			if (mb_strpos($url, generate_base_url()) !== false &amp;&amp; mb_strpos($url, 'sid=') !== false)
+			{
+				//$url = preg_replace('/(&amp;|\?)sid=[0-9a-f]{32}/', '\1', $url);
+				if (($pos = mb_strpos($url, 'sid=')) !== false)
 				{
-					$pos = $tmp_pos;
+					$url = mb_substr($url, 0, $pos - 1);
 				}
-			}
-
-			$buffer .= substr($in, 0, $pos);
-			$tok = $in{$pos};
-			$in = substr($in, $pos + 1);
-
-			if ($tok == ']')
-			{
-				if ($buffer == '/quote' &amp;&amp; sizeof($close_tags))
-				{
-					// we have found a closing tag
-
-					$out .= array_pop($close_tags) . ']';
-					$tok = '[';
-					$buffer = '';
-				}
-				elseif (preg_match('#^quote(?:=&quot;(.*?)&quot;)?$#is', $buffer, $m))
-				{
-					$this-&gt;parsed_items['quote']++;
-					
-					// the buffer holds a valid opening tag
-					if ($config['max_quote_depth'] &amp;&amp; sizeof($close_tags) &gt;= $config['max_quote_depth'])
-					{
-						// there are too many nested quotes
-						$error_ary['quote_depth'] = sprintf($_CLASS['core_user']-&gt;lang['QUOTE_DEPTH_EXCEEDED'], $config['max_quote_depth']);
-
-						$out .= $buffer . $tok;
-						$tok = '[]';
-						$buffer = '';
-
-						continue;
-					}
-
-					array_push($close_tags, '/quote:' . $this-&gt;bbcode_uid);
-
-					if (isset($m[1]) &amp;&amp; $m[1])
-					{
-						$username = preg_replace('#\[(?!b|i|u|color|url|email|/b|/i|/u|/color|/url|/email)#iU', '&#91;$1', $m[1]);
-						$end_tags = array();
-						$error = false;
-
-						preg_match_all('#\[((?:/)?(?:[a-z]+))#i', $username, $tags);
-						foreach ($tags[1] as $tag)
-						{
-							if ($tag{0} != '/')
-							{
-								$end_tags[] = '/' . $tag;
-							}
-							else
-							{
-								$end_tag = array_pop($end_tags);
-								if ($end_tag != $tag)
-								{
-									$error = true;
-								}
-								else
-								{
-									$error = false;
-								}
-							}
-						}
-						if ($error)
-						{
-							$username = str_replace('[', '&#91;', str_replace(']', '&#93;', $m[1]));
-						}
-
-						$out .= 'quote=&quot;' . $username . '&quot;:' . $this-&gt;bbcode_uid . ']';
-					}
-					else
-					{
-						$out .= 'quote:' . $this-&gt;bbcode_uid . ']';
-					}
-
-					$tok = '[';
-					$buffer = '';
-				}
-				elseif (preg_match('#^quote=&quot;(.*?)#is', $buffer, $m))
-				{
-					// the buffer holds an invalid opening tag
-					$buffer .= ']';
-				}
-				else
-				{
-					$out .= $buffer . $tok;
-					$tok = '[]';
-					$buffer = '';
-				}
-			}
-			else
-			{
-				$out .= $buffer . $tok;
-				$tok = ($tok == '[') ? ']' : '[]';
-				$buffer = '';
-			}
-		}
-		while ($in);
-
-		if (sizeof($close_tags))
-		{
-			$out .= '[' . implode('][', $close_tags) . ']';
-		}
-
-		foreach ($error_ary as $error_msg)
-		{
-			$this-&gt;warn_msg[] = $error_msg;
-		}
-
-		return $out;
+			}
+
+			return ($var1) ? '[url=' . $this-&gt;bbcode_specialchars($url) . ':' . $this-&gt;bbcode_uid . ']' . $var2 . '[/url:' . $this-&gt;bbcode_uid . ']' : '[url:' . $this-&gt;bbcode_uid . ']' . $this-&gt;bbcode_specialchars($url) . '[/url:' . $this-&gt;bbcode_uid . ']'; 
+		}
+
+		return '[url' . (($var1) ? '=' . $var1 : '') . ']' . $var2 . '[/url]';
 	}
 
-	function validate_email($var1, $var2)
-	{
-		$txt = stripslashes($var2);
-		$email = ($var1) ? stripslashes($var1) : stripslashes($var2);
-
-		$validated = true;
-
-		if (!preg_match('!([a-z0-9]+[a-z0-9\-\._]*@(?:(?:[0-9]{1,3}\.){3,5}[0-9]{1,3}|[a-z0-9]+[a-z0-9\-\._]*\.[a-z]+))!i', $email))
-		{
-			$validated = false;
-		}
-
-		if (!$validated)
-		{
-			return '[email' . (($var1) ? &quot;=$var1&quot; : '') . ']' . $var2 . '[/email]';
-		}
-		
-		$this-&gt;parsed_items['email']++;
-
-		if ($var1)
-		{
-			$retval = '[email=' . $email . ':' . $this-&gt;bbcode_uid . ']' . $txt . '[/email:' . $this-&gt;bbcode_uid . ']';
-		}
-		else
-		{
-			$retval = '[email:' . $this-&gt;bbcode_uid . ']' . $email . '[/email:' . $this-&gt;bbcode_uid . ']';
-		}
-
-		return $retval;
+	/**
+	* Check if url is pointing to this domain/script_path/php-file
+	*
+	* @param string $url the url to check
+	* @return true if the url is pointing to this domain/script_path/php-file, false if not
+	*
+	* @access: private
+	*/
+// Fixed
+	function path_in_domain($url)
+	{
+		global $config, $phpEx, $_CLASS;
+
+		$check_path = '';//($_CLASS['core_user']-&gt;page['root_script_path'] != '/') ? substr($_CLASS['core_user']-&gt;page['root_script_path'], 0, -1) : '/';
+
+		// Is the user trying to link to a php file in this domain and script path?
+		if (strpos($url, &quot;.{$phpEx}&quot;) !== false &amp;&amp; strpos($url, $check_path) !== false)
+		{
+			$server_name = (!empty($_SERVER['SERVER_NAME'])) ? $_SERVER['SERVER_NAME'] : getenv('SERVER_NAME');
+
+			// Forcing server vars is the only way to specify/override the protocol
+			if ($config['force_server_vars'] || !$server_name)
+			{
+				$server_name = $config['server_name'];
+			}
+
+			// Check again in correct order...
+			$pos_ext = strpos($url, &quot;.{$phpEx}&quot;);
+			$pos_path = strpos($url, $check_path);
+			$pos_domain = strpos($url, $server_name);
+
+			if ($pos_domain !== false &amp;&amp; $pos_path &gt;= $pos_domain &amp;&amp; $pos_ext &gt;= $pos_path)
+			{
+				return true;
+			}
+		}
+
+		return false;
 	}
-
-	function validate_url($var1, $var2)
-	{
-		global $config;
-		
-		$var1 = trim($var1);
-		$var2 = trim($var2);
-		
-		$url = ($var1) ? stripslashes($var1) : stripslashes($var2);
-		$valid = false;
-
-		if (!$url || ($var1 &amp;&amp; !$var2))
-		{
-			return '';
-		}
-		
-		// relative urls for this board
-		if (preg_match('#' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . '/([^ \t\n\r&lt;&quot;\']+)#i', $url) ||
-			preg_match('#([\w]+?://.*?[^ \t\n\r&lt;&quot;\']*)#i', $url) ||
-			preg_match('#(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r&lt;&quot;\']*)?)#i', $url))
-		{
-			$valid = true;
-		}
-
-		if ($valid)
-		{
-			$this-&gt;parsed_items['url']++;
-			
-			if (!preg_match('#^[\w]+?://.*?#i', $url))
-			{
-				$url = '<A HREF="http://">http://</A>' . $url;
-			}
-
-			return ($var1) ? '[url=' . str_replace(array(']', '['), array('&#93;', '&#91;'), $url) . ':' . $this-&gt;bbcode_uid . ']' . stripslashes($var2) . '[/url:' . $this-&gt;bbcode_uid . ']' : '[url:' . $this-&gt;bbcode_uid . ']' . $url . '[/url:' . $this-&gt;bbcode_uid . ']';
-		}
-
-		return '[url' . (($var1) ? '=' . stripslashes($var1) : '') . ']' . stripslashes($var2) . '[/url]';
-	}
 }
 
-// PARSE_MESSAGE EXTENDS BBCODE 
-//
-
-// Main message parser for posting, pm, etc. takes raw message
-// and parses it for attachments, html, bbcode and smilies
-class parse_message extends bbcode_firstpass
+/**
+* Main message parser for posting, pm, etc. takes raw message
+* and parses it for attachments, bbcode and smilies
+* @package phpBB3
+*/
+class parse_message extends bbcode_firstpass
 {
-	var $attachment_data = array();
-	var $filename_data = array();
+	var $attachment_data = array();
+	var $filename_data = array();
+
+	// Helps ironing out user error
+	var $message_status = '';
+
+	var $allow_img_bbcode = true;
+	var $allow_flash_bbcode = true;
+	var $allow_quote_bbcode = true;
+
+	var $mode;
 
-	// Helps ironing out user error
-	var $message_status = '';
-
-	var $allow_img_bbcode = true;
-	var $allow_flash_bbcode = true;
-	var $allow_quote_bbcode = true;
-
-	// Init - give message here or manually
+	/**
+	* Init - give message here or manually
+	*/
 	function parse_message($message = '')
 	{
 		// Init BBCode UID
-		$this-&gt;bbcode_uid = substr(md5(time()), 0, BBCODE_UID_LEN);
+		$this-&gt;bbcode_uid = substr(md5(time()), 0, BBCODE_UID_LEN);
 
 		if ($message)
 		{
@@ -702,13 +884,17 @@
 		}
 	}
 
-	// Parse Message : public
+	/**
+	* Parse Message
+	*/
 	function parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $allow_img_bbcode = true, $allow_flash_bbcode = true, $allow_quote_bbcode = true, $update_this_message = true, $mode = 'post')
 	{
 		global $config, $_CLASS;
 		
 		$mode = ($mode != 'sig') ? 'post' : 'sig';
 
+		$this-&gt;mode = $mode;
+
 		$this-&gt;allow_img_bbcode = $allow_img_bbcode;
 		$this-&gt;allow_flash_bbcode = $allow_flash_bbcode;
 		$this-&gt;allow_quote_bbcode = $allow_quote_bbcode;
@@ -732,12 +918,12 @@
 		$replace = array(&quot;\n&quot;, '', &quot;\n\n&quot;, &quot;\\1&#058;&quot;);
 		$this-&gt;message = preg_replace($match, $replace, trim($this-&gt;message));
 
-		// Message length check. -1 disables this check completely, even allows empty messsages.
-		if($config['max_' . $mode . '_chars'] != -1)
+		// Message length check. -1 disables this check completely.
+		if ($config['max_' . $mode . '_chars'] != -1)
 		{
-			$msg_len = ($mode == 'post') ? strlen($this-&gt;message) : strlen(preg_replace('#\[\/?[a-z\*\+\-]+(=[\S]+)?\]#is', ' ', $this-&gt;message));
+			$msg_len = ($mode === 'post') ? strlen($this-&gt;message) : strlen(preg_replace('#\[\/?[a-z\*\+\-]+(=[\S]+)?\]#is', ' ', $this-&gt;message));
 			
-			if (!$msg_len || ($config['max_' . $mode . '_chars'] &amp;&amp; $msg_len &gt; $config['max_' . $mode . '_chars']))
+			if ((!$msg_len &amp;&amp; $mode !== 'sig') || $config['max_' . $mode . '_chars'] &amp;&amp; $msg_len &gt; $config['max_' . $mode . '_chars'])
 			{
 				$this-&gt;warn_msg[] = (!$msg_len) ? $_CLASS['core_user']-&gt;lang['TOO_FEW_CHARS'] : $_CLASS['core_user']-&gt;lang['TOO_MANY_CHARS'];
 				return $this-&gt;warn_msg;
@@ -750,63 +936,70 @@
 			$this-&gt;html($config['allow_html_tags']);
 		}
 
-		// Parse smilies
-		if ($allow_smilies)
-		{	
-			$this-&gt;smilies(isset($config['max_' . $mode . '_smilies']) ? $config['max_' . $mode . '_smilies'] : 0);
+		// Prepare BBcode (just prepares some tags for better parsing)
+		if ($allow_bbcode &amp;&amp; strpos($this-&gt;message, '[') !== false)
+		{
+			$this-&gt;bbcode_init();
+			$disallow = array('img', 'flash', 'quote');
+			foreach ($disallow as $bool)
+			{
+				if (!${'allow_' . $bool . '_bbcode'})
+				{
+					$this-&gt;bbcodes[$bool]['disabled'] = true;
+				}
+			}
+
+			$this-&gt;prepare_bbcodes();
 		}
-		$num_urls = 0;
-		
-		// Parse BBCode
-		if ($allow_bbcode &amp;&amp; strpos($this-&gt;message, '[') !== false)
-		{
-			$this-&gt;bbcode_init();
+
+		// Parse smilies
+		if ($allow_smilies)
+		{
+			$this-&gt;smilies($config['max_' . $mode . '_smilies']);
+		}
 
-			$disallow = array('img', 'flash', 'quote');
-
-			foreach ($disallow as $bool)
-			{
-				if (!${'allow_' . $bool . '_bbcode'})
-				{
-					$this-&gt;bbcodes[$bool]['disabled'] = true;
-				}
-			}
-			$this-&gt;parse_bbcode();
-			
-			$num_urls += $this-&gt;parsed_items['url'];
+
+		$num_urls = 0;
+
+		// Parse BBCode
+		if ($allow_bbcode &amp;&amp; strpos($this-&gt;message, '[') !== false)
+		{
+			$this-&gt;parse_bbcode();
+			$num_urls += $this-&gt;parsed_items['url'];
 		}
 
-		// Parse URL's
-		if ($allow_magic_url)
-		{
-			$this-&gt;magic_url();
-
-			if (isset($config['max_' . $mode . '_urls']) &amp;&amp; $config['max_' . $mode . '_urls'])
-			{
-				$num_urls += preg_match_all('#\&lt;!-- (l|m|w|e) --\&gt;.*?\&lt;!-- \1 --\&gt;#', $this-&gt;message, $matches);
-			}
+		// Parse URL's
+		if ($allow_magic_url)
+		{
+			$this-&gt;magic_url(generate_base_url());
+	
+			if ($config['max_' . $mode . '_urls'])
+			{
+				$num_urls += preg_match_all('#\&lt;!-- (l|m|w|e) --\&gt;.*?\&lt;!-- \1 --\&gt;#', $this-&gt;message, $matches);
+			}
 		}
 		
 		// Check number of links
-//max_sig_urls
-		if (isset($config['max_' . $mode . '_urls']) &amp;&amp; $config['max_' . $mode . '_urls'] &amp;&amp; $num_urls &gt; $config['max_' . $mode . '_urls'])
+		if ($config['max_' . $mode . '_urls'] &amp;&amp; $num_urls &gt; $config['max_' . $mode . '_urls'])
 		{
 			$this-&gt;warn_msg[] = sprintf($_CLASS['core_user']-&gt;lang['TOO_MANY_URLS'], $config['max_' . $mode . '_urls']);
 			return $this-&gt;warn_msg;
 		}
 		
-		if (!$update_this_message)
-		{
-			unset($this-&gt;message);
-			$this-&gt;message = $tmp_message;
-			return $return_message;
+		if (!$update_this_message)
+		{
+			unset($this-&gt;message);
+			$this-&gt;message = $tmp_message;
+			return $return_message;
 		}
 
 		$this-&gt;message_status = 'parsed';
-		return;
+		return false;
 	}
 
-	// Formatting text for display
+	/**
+	* Formatting text for display
+	*/
 	function format_display($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $update_this_message = true)
 	{
 		// If false, then the parsed message get returned but internal message not processed.
@@ -816,7 +1009,7 @@
 			$return_message = &amp;$this-&gt;message;
 		}
 
-		if ($this-&gt;message_status == 'plain')
+		if ($this-&gt;message_status === 'plain')
 		{
 			// Force updating message - of course.
 			$this-&gt;parse($allow_html, $allow_bbcode, $allow_magic_url, $allow_smilies, $this-&gt;allow_img_bbcode, $this-&gt;allow_flash_bbcode, $this-&gt;allow_quote_bbcode, true);
@@ -836,18 +1029,20 @@
 		// Replace naughty words such as farty pants
 		$this-&gt;message = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($this-&gt;message));
 
-		if (!$update_this_message)
-		{
-			unset($this-&gt;message);
-			$this-&gt;message = $tmp_message;
-			return $return_message;
-		}
-
-		$this-&gt;message_status = 'display';
-		return;
+		if (!$update_this_message)
+		{
+			unset($this-&gt;message);
+			$this-&gt;message = $tmp_message;
+			return $return_message;
+		}
+
+		$this-&gt;message_status = 'display';
+		return false;
 	}	
 	
-	// Decode message to be placed back into form box
+	/**
+	* Decode message to be placed back into form box
+	*/
 	function decode_message($custom_bbcode_uid = '', $update_this_message = true)
 	{
 		// If false, then the parsed message get returned but internal message not processed.
@@ -867,6 +1062,7 @@
 		}
 
 		$this-&gt;message_status = 'plain';
+		return false;
 	}
 	
 	// Parse HTML
@@ -882,62 +1078,34 @@
 		}
 	}
 
-	// Replace magic urls of form <A HREF="http://xxx.xxx.,">http://xxx.xxx.,</A> www.xxx. and <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">xxx at xxx.xxx.</A>
-	// Cuts down displayed size of link if over 50 chars, turns absolute links
-	// into relative versions when the server/script path matches the link
-	function magic_url()
-	{
-		static $match;
-		static $replace;
-		
-		if(!is_array($match))
-		{
-			$match = $replace = array();
-			// Be sure to not let the matches cross over. ;)
-	
-			// relative urls for this board
-			$match[] = '#(^|[\n ]|\()(' . preg_quote(preg_replace('/^\/?(.*?)(\/)?$/', '$1', generate_base_url()), '#') . ')/(.*?([^ \t\n\r&lt;&quot;\'\)]*)?)#i';
-			$replace[] = '$1&lt;!-- l --&gt;&lt;a href=&quot;$2/$3&quot;&gt;$3&lt;/a&gt;&lt;!-- l --&gt;';
-	
-			// matches a <A HREF="xxxx://aaaaa.bbb.cccc.">xxxx://aaaaa.bbb.cccc.</A> ...
-			$match[] = '#(^|[\n ]|\()([\w]+?://.*?([^ \t\n\r&lt;&quot;\'\)]*)?)#ie';
-			$replace[] = &quot;'\$1&lt;!-- m --&gt;&lt;a href=\&quot;\$2\&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- m --&gt;'&quot;;
-			
-			// matches a &quot;www.xxxx.yyyy[/zzzz]&quot; kinda lazy URL thing
-			$match[] = '#(^|[\n ]|\()(www\.[\w\-]+\.[\w\-.\~]+(?:/[^ \t\n\r&lt;&quot;\'\)]*)?)#ie';
-			$replace[] = &quot;'\$1&lt;!-- w --&gt;&lt;a href=\&quot;<A HREF="http://\$2\">http://\$2\</A>&quot; target=\&quot;_blank\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr(str_replace('&amp;', '&amp;', '\$2'), 0, 39) . ' ... ' . substr(str_replace('&amp;', '&amp;', '\$2'), -10) : '\$2') . '&lt;/a&gt;&lt;!-- w --&gt;'&quot;;
-	
-			// matches an <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">email at domain</A> type address at the start of a line, or after a space.
-			$match[] = '#(^|[\n ]|\()([a-z0-9&amp;\-_.]+?@[\w\-]+\.([\w\-\.]+\.)?[\w]+)#ie';
-			$replace[] = &quot;'\$1&lt;!-- e --&gt;&lt;a href=\&quot;mailto:\$2\&quot;&gt;' . ((strlen('\$2') &gt; 55) ? substr('\$2', 0, 39) . ' ... ' . substr('\$2', -10) : '\$2') . '&lt;/a&gt;&lt;!-- e --&gt;'&quot;;
-		}
-		
-		/* IMPORTANT NOTE (Developer inability to do advanced regular expressions) - Acyd Burn:  
-			Transforming &lt; (&lt;) to &lt;&amp;lt; in order to bypass the inability of preg_replace 
-			supporting multi-character sequences (POSIX - [..]). Since all message text is specialchared by
-			default a match against &lt; will always fail, since it is a &lt; sequence within the text.
-			Replacing with &lt;&amp;lt; and switching back thereafter produces no problems, because &lt; will never show up with &amp;lt; in
-			the same text (due to this specialcharing). The &lt; is put in front of &amp;lt; to let the url break gracefully.
-			I hope someone can lend me a hand here, telling me how to achive the wanted result without switching to ereg_replace.
-		*/
-		$this-&gt;message = preg_replace($match, $replace, str_replace('&lt;', '&lt;&amp;lt;', $this-&gt;message));
-		$this-&gt;message = str_replace('&lt;&amp;lt;', '&lt;', $this-&gt;message);
+	/**
+	* Replace magic urls of form <A HREF="http://xxx.xxx.,">http://xxx.xxx.,</A> www.xxx. and <A HREF="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">xxx at xxx.xxx.</A>
+	* Cuts down displayed size of link if over 50 chars, turns absolute links
+	* into relative versions when the server/script path matches the link
+	*/
+	function magic_url($server_url)
+	{
+		// We use the global make_clickable function
+		$this-&gt;message = make_clickable($this-&gt;message, $server_url);
 	}
 
-	// Parse Smilies
+	/**
+	* Parse Smilies
+	*/
 	function smilies($max_smilies = 0)
 	{
 		global $_CLASS;
 
   	    if (is_null($smiley = $_CLASS['core_cache']-&gt;get('smiley_parse')))
   	    {
-			$result = $_CLASS['core_db']-&gt;query('SELECT * FROM ' . CORE_SMILIES_TABLE .' ORDER BY LENGTH(smiley_code) DESC');
+			$result = $_CLASS['core_db']-&gt;query('SELECT * 
+						FROM ' . CORE_SMILIES_TABLE .'
+						ORDER BY LENGTH(smiley_code) DESC');
 
 			$smiley = array();
-			
-			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 			{
-				// (assertion)
 				$smiley['match'][] = '#(?&lt;=^|[\n ]|\.)' . preg_quote($row['smiley_code'], '#') . '#';
 				$smiley['replace'][] = '&lt;!-- s' . $row['smiley_code'] . ' --&gt;&lt;img src=&quot;{SMILIES_PATH}/' . $row['smiley_src'] . '&quot; border=&quot;0&quot; alt=&quot;' . $row['smiley_description'] . '&quot; title=&quot;' . $row['smiley_description'] . '&quot; /&gt;&lt;!-- s' . $row['smiley_code'] . ' --&gt;';
 			}
@@ -964,10 +1132,12 @@
 		}
 	}
 
-	// Parse Attachments
+	/**
+	* Parse Attachments
+	*/
 	function parse_attachments($form_name, $mode, $forum_id, $submit, $preview, $refresh, $is_message = false)
 	{
-		global $config, $_CLASS, $forum_id;
+		global $config, $_CLASS;
 
 		$error = array();
 
@@ -985,10 +1155,9 @@
 
 		if ($submit &amp;&amp; in_array($mode, array('post', 'reply', 'quote', 'edit')) &amp;&amp; $upload_file)
 		{
-			if ($num_attachments &lt; $cfg['max_attachments'] || $_CLASS['auth']-&gt;acl_gets('m_', 'a_'))
+			if ($num_attachments &lt; $cfg['max_attachments'] || $_CLASS['auth']-&gt;acl_gets(array('m_', 'a_'), $forum_id))
 			{
 				$filedata = upload_attachment($form_name, $forum_id, false, '', $is_message);
-				
 				$error = $filedata['error'];
 
 				if ($filedata['post_attach'] &amp;&amp; empty($error))
@@ -1059,20 +1228,19 @@
 			{
 				if ($edit_comment)
 				{
-					$actual_comment_list = request_var('comment_list', array(''));
+					$actual_comment_list = request_var('comment_list', array(''), true);
 
 					foreach ($actual_comment_list as $index =&gt; $entry)
 					{
-						$this-&gt;attachment_data[$index]['comment'] = preg_replace('#&amp;(\#[0-9]+;)#', '&amp;\1', $entry);
+						$this-&gt;attachment_data[$index]['comment'] = $entry;
 					}
 				}
 				
 				if (($add_file || $preview) &amp;&amp; $upload_file)
 				{
-					if ($num_attachments &lt; $cfg['max_attachments'] || $_CLASS['auth']-&gt;acl_gets('m_', 'a_'))
+					if ($num_attachments &lt; $cfg['max_attachments'] || $_CLASS['auth']-&gt;acl_gets(array('m_', 'a_'), $forum_id))
 					{
 						$filedata = upload_attachment($form_name, $forum_id, false, '', $is_message);
-
 						$error = array_merge($error, $filedata['error']);
 
 						if (!sizeof($error))
@@ -1090,7 +1258,7 @@
 							);
 
 							$this-&gt;attachment_data = array_merge(array(0 =&gt; $new_entry), $this-&gt;attachment_data);
-							$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;'[attachment='.(\\1 + 1).']\\2[/attachment]'&quot;, $this-&gt;message);
+							$this-&gt;message = preg_replace('#\[attachment=([0-9]+)\](.*?)\[\/attachment\]#e', &quot;'[attachment='.(\\1 + 1).']\\2[/attachment]'&quot;, $this-&gt;message);
 							$this-&gt;filename_data['filecomment'] = '';
 						}
 					}
@@ -1108,84 +1276,162 @@
 		}
 	}
 
-	// Get Attachment Data
-	function get_submitted_attachment_data()
+	/**
+	* Get Attachment Data
+	*/
+	function get_submitted_attachment_data($check_user_id = false)
 	{
+		global $_CLASS;
+
 		$this-&gt;filename_data['filecomment'] = request_var('filecomment', '', true);
-		$this-&gt;attachment_data = (isset($_POST['attachment_data'])) ? $_POST['attachment_data'] : array();
+		$this-&gt;attachment_data = isset($_POST['attachment_data']) ? $_POST['attachment_data'] : array();
 
-		// 
-		$data_prepare = array('physical_filename' =&gt; 's', 'real_filename' =&gt; 's', 'comment' =&gt; 's', 'extension' =&gt; 's', 'mimetype' =&gt; 's',
-							'filesize' =&gt; 'i', 'filetime' =&gt; 'i', 'attach_id' =&gt; 'i', 'thumbnail' =&gt; 'i');
-		foreach ($this-&gt;attachment_data as $pos =&gt; $var_ary)
-		{
-			foreach ($data_prepare as $var =&gt; $type)
-			{
-				if ($type == 's')
-				{
-					$this-&gt;attachment_data[$pos][$var] = trim(htmlspecialchars(str_replace(array(&quot;\r\n&quot;, &quot;\r&quot;, '\xFF'), array(&quot;\n&quot;, &quot;\n&quot;, ' '), stripslashes($this-&gt;attachment_data[$pos][$var]))));
-				}
-				else
-				{
-					$this-&gt;attachment_data[$pos][$var] = (int) $this-&gt;attachment_data[$pos][$var];
-				}
-			}
+		$check_user_id = ($check_user_id === false) ? $_CLASS['core_user']-&gt;data['user_id'] : $check_user_id;
 
-			$this-&gt;attachment_data[$pos]['download_count'] = 0;
+		// Regenerate data array...
+		$attach_ids = $filenames = array();
+
+		foreach ($this-&gt;attachment_data as $pos =&gt; $var_ary)
+		{
+			if ($var_ary['attach_id'])
+			{
+				$attach_ids[(int) $this-&gt;attachment_data[$pos]['attach_id']] = $pos;
+			}
+			else
+			{
+				$filenames[$pos] = '';
+				set_var($filenames[$pos], $this-&gt;attachment_data[$pos]['physical_filename'], 'string');
+				$filenames[$pos] = basename($filenames[$pos]);
+			}
+		}
+
+		$this-&gt;attachment_data = array();
+
+		// Regenerate already posted attachments...
+		if (sizeof($attach_ids))
+		{
+			// Get the data from the attachments
+			$sql = 'SELECT attach_id, physical_filename, real_filename, extension, mimetype, filesize, filetime, thumbnail
+				FROM ' . ATTACHMENTS_TABLE . '
+				WHERE attach_id IN (' . implode(', ', $attach_ids) . ')
+					AND poster_id = ' . $check_user_id;
+			$result = $_CLASS['core_db']-&gt;query($sql);
+
+			while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+			{
+				if (isset($attach_ids[$row['attach_id']]))
+				{
+					$pos = $attach_ids[$row['attach_id']];
+					$this-&gt;attachment_data[$pos] = $row;
+					set_var($this-&gt;attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+
+					unset($attach_ids[$row['attach_id']]);
+				}
+			}
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (sizeof($attach_ids))
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+			}
+		}
+
+		// Regenerate newly uploaded attachments
+		if (sizeof($filenames))
+		{
+			require_once SITE_FILE_ROOT.'includes/forums/functions_upload.php';
+
+			$sql = 'SELECT attach_id
+				FROM ' . ATTACHMENTS_TABLE . &quot;
+				WHERE LOWER(physical_filename) IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array(array_map('strtolower', $filenames))) . &quot;')&quot;;
+			$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if ($row)
+			{
+				trigger_error($_CLASS['core_user']-&gt;lang['NO_ACCESS_ATTACHMENT'], E_USER_ERROR);
+			}
+
+			foreach ($filenames as $pos =&gt; $physical_filename)
+			{
+				$this-&gt;attachment_data[$pos] = array(
+					'physical_filename'	=&gt; $physical_filename,
+					'extension'			=&gt; strtolower(filespec::get_extension(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename)),
+					'filesize'			=&gt; filespec::get_filesize(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename),
+					'attach_id'			=&gt; 0,
+					'thumbnail'			=&gt; (file_exists(SITE_FILE_ROOT . $config['upload_path'] . '/thumb_' . $physical_filename)) ? 1 : 0,
+				);
+
+				set_var($this-&gt;attachment_data[$pos]['attach_comment'], $_POST['attachment_data'][$pos]['attach_comment'], 'string', true);
+				set_var($this-&gt;attachment_data[$pos]['real_filename'], $_POST['attachment_data'][$pos]['real_filename'], 'string', true);
+				set_var($this-&gt;attachment_data[$pos]['filetime'], $_POST['attachment_data'][$pos]['filetime'], 'int');
+
+				if (strpos($_POST['attachment_data'][$pos]['mimetype'], 'image/') !== false)
+				{
+					set_var($this-&gt;attachment_data[$pos]['mimetype'], $_POST['attachment_data'][$pos]['mimetype'], 'string');
+				}
+				else
+				{
+					$this-&gt;attachment_data[$pos]['mimetype'] = filespec::get_mimetype(SITE_FILE_ROOT . $config['upload_path'] . '/' . $physical_filename);
+				}
+			}
 		}
 	}
 	
-	// Parse Poll
-	function parse_poll(&amp;$poll)
-	{
-		global $_CLASS, $config;
-
-		$poll_max_options = $poll['poll_max_options'];
-
-		// Parse Poll Option text ;)
-		$tmp_message = $this-&gt;message;
-		$this-&gt;message = $poll['poll_option_text'];
-		$bbcode_bitfield = $this-&gt;bbcode_bitfield;
-
-		$poll['poll_option_text'] = $this-&gt;parse($poll['enable_html'], $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-		
-		$this-&gt;bbcode_bitfield |= $bbcode_bitfield;
-		$this-&gt;message = $tmp_message;
-
-		// Parse Poll Title
-		$tmp_message = $this-&gt;message;
-		$this-&gt;message = $poll['poll_title'];
-		$bbcode_bitfield = $this-&gt;bbcode_bitfield;
-
-		$poll['poll_title'] = $this-&gt;parse($poll['enable_html'], $poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
-
-		$this-&gt;bbcode_bitfield |= $bbcode_bitfield;
-		$this-&gt;message = $tmp_message;
-
-		unset($tmp_message);
-
-		$poll['poll_options'] = explode(&quot;\n&quot;, trim($poll['poll_option_text']));
-		$poll['poll_options_size'] = sizeof($poll['poll_options']);
-			
-		if (sizeof($poll['poll_options']) == 1)
-		{
-			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_FEW_POLL_OPTIONS'];
-		}
-		else if ($poll['poll_options_size'] &gt; (int) $config['max_poll_options'])
-		{
-			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_MANY_POLL_OPTIONS'];
-		}
-		else if ($poll_max_options &gt; $poll['poll_options_size'])
-		{
-			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_MANY_USER_OPTIONS'];
-		}
-
-		if (!$poll['poll_title'] &amp;&amp; $poll['poll_options_size'])
-		{
-			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['NO_POLL_TITLE'];
-		}
-
-		$poll['poll_max_options'] = ($poll['poll_max_options'] &lt; 1) ? 1 : (($poll['poll_max_options'] &gt; $config['max_poll_options']) ? $config['max_poll_options'] : $poll['poll_max_options']);
+	/**
+	* Parse Poll
+	*/
+	function parse_poll(&amp;$poll)
+	{
+		global $_CLASS, $config;
+
+		$poll_max_options = $poll['poll_max_options'];
+
+		// Parse Poll Option text ;)
+		$tmp_message = $this-&gt;message;
+		$this-&gt;message = $poll['poll_option_text'];
+
+
+		$poll['poll_option_text'] = $this-&gt;parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+
+
+		$this-&gt;message = $tmp_message;
+
+		// Parse Poll Title
+		$tmp_message = $this-&gt;message;
+		$this-&gt;message = $poll['poll_title'];
+
+
+		$poll['poll_title'] = $this-&gt;parse($poll['enable_bbcode'], $poll['enable_urls'], $poll['enable_smilies'], $poll['img_status'], false, false, false);
+
+
+		$this-&gt;message = $tmp_message;
+
+		unset($tmp_message);
+
+		$poll['poll_options'] = explode(&quot;\n&quot;, trim($poll['poll_option_text']));
+		$poll['poll_options_size'] = sizeof($poll['poll_options']);
+
+		if (sizeof($poll['poll_options']) == 1)
+		{
+			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_FEW_POLL_OPTIONS'];
+		}
+		else if ($poll['poll_options_size'] &gt; (int) $config['max_poll_options'])
+		{
+			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_MANY_POLL_OPTIONS'];
+		}
+		else if ($poll_max_options &gt; $poll['poll_options_size'])
+		{
+			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['TOO_MANY_USER_OPTIONS'];
+		}
+
+		if (!$poll['poll_title'] &amp;&amp; $poll['poll_options_size'])
+		{
+			$this-&gt;warn_msg[] = $_CLASS['core_user']-&gt;lang['NO_POLL_TITLE'];
+		}
+
+		$poll['poll_max_options'] = ($poll['poll_max_options'] &lt; 1) ? 1 : (($poll['poll_max_options'] &gt; $config['max_poll_options']) ? $config['max_poll_options'] : $poll['poll_max_options']);
 	}
 }
 

Modified: cms/trunk/includes/functions.php
===================================================================
--- cms/trunk/includes/functions.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/functions.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -247,6 +247,11 @@
 
 	$confirmation_code = generate_string(6);
 
+	if (is_array($hidden))
+	{
+		$hidden = generate_hidden_fields($hidden);
+	}
+
 	if ($image)
 	{
 		$confirm_image = '&lt;img src=&quot;'.generate_link('system&amp;mode=confirmation_image').'&quot; alt=&quot;&quot; title=&quot;&quot; /&gt;';
@@ -371,7 +376,7 @@
 		break;
 	}
 
-	if (is_null($variable))
+	if (is_null($variable) || $variable === $default)
 	{
 		return $default;
 	}
@@ -1045,7 +1050,14 @@
 {
 	global $config, $_CLASS;
 
-	return ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']-&gt;user_data_get('viewsmilies')) ? preg_replace('#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#', '\1', $text) : str_replace('&lt;img src=&quot;{SMILIES_PATH}', '&lt;img src=&quot;' . $config['smilies_path'], $text);
+	if ($force_option || !$config['allow_smilies'] || !$_CLASS['core_user']-&gt;user_data_get('viewsmilies'))
+	{
+		return preg_replace('#&lt;!\-\- s(.*?) \-\-&gt;&lt;img src=&quot;\{SMILIES_PATH\}\/.*? \/&gt;&lt;!\-\- s\1 \-\-&gt;#', '\1', $text);
+	}
+	else
+	{
+		return str_replace('&lt;img src=&quot;{SMILIES_PATH}', '&lt;img src=&quot;' . $config['smilies_path'], $text);
+	}
 }
 
 if (!function_exists('stripos'))

Modified: cms/trunk/includes/functions_user.php
===================================================================
--- cms/trunk/includes/functions_user.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/functions_user.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -259,14 +259,17 @@
 	$_CLASS['core_db']-&gt;query($sql);
 
 	// Now we disable the user in his active groups
-	//	( note disable is not uses for group removal, the entry is just deleted )
-// should also remove all pending groups
 	$sql = 'UPDATE ' . CORE_USER_GROUP_TABLE . '
 		SET member_status = ' . STATUS_DISABLED . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')
 			AND member_status = ' . STATUS_ACTIVE;
 	$_CLASS['core_db']-&gt;query($sql);
 
+	$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
+		WHERE user_id IN (' . implode(', ', $user_id) . &quot;)
+		AND auto_login_code = '&quot; . $_CLASS['core_db']-&gt;escape($code) . &quot;'&quot;;
+	$_CLASS['core_db']-&gt;query($sql);
+
 	if ($update_stats)
 	{
 		if (in_array($_CORE_CONFIG['user']['newest_user_id'], $user_id))
@@ -282,13 +285,13 @@
 			set_core_config('user', 'newest_user_id', $row['user_id'], false);
 			set_core_config('user', 'newest_username', $row['username'], false);
 		}
-	
+
 		$total_users = $_CORE_CONFIG['user']['total_users'] - count($user_id);
 		set_core_config('user', 'total_users', $total_users, false);
-		
+
 		$_CLASS['core_cache']-&gt;destroy('core_config');
 	}
-	
+
 	$_CLASS['core_db']-&gt;transaction('commit');
 }
 
@@ -308,7 +311,12 @@
 		$sql = 'DELETE FROM ' . CORE_USERS_TABLE . '
 			WHERE user_id IN (' . implode(', ', $user_id) . ')';
 		$_CLASS['core_db']-&gt;query($sql);
-		
+
+		$sql = 'DELETE FROM ' . CORE_SESSIONS_AUTOLOGIN_TABLE . ' 
+			WHERE user_id IN (' . implode(', ', $user_id) . &quot;)
+			AND auto_login_code = '&quot; . $_CLASS['core_db']-&gt;escape($code) . &quot;'&quot;;
+		$_CLASS['core_db']-&gt;query($sql);
+
 		return;
 	}
 
@@ -323,7 +331,7 @@
 	$_CLASS['core_db']-&gt;transaction();
 
 	$optimize_array = array();
-	$tables = array(CORE_USERS_TABLE =&gt; 'user_id', CORE_USER_GROUP_TABLE =&gt; 'user_id');
+	$tables = array(CORE_USERS_TABLE =&gt; 'user_id', CORE_SESSIONS_AUTOLOGIN_TABLE =&gt; 'user_id', CORE_USER_GROUP_TABLE =&gt; 'user_id');
 // hook here
 
 // Move this to hooks on seperation
@@ -380,19 +388,19 @@
 
 	$difference = array();
 
-	$username = is_array($username) ? $username : array($username);
+	$username = is_array($username) ? array_map('strtolower', $username) : array(strtolower($username));
 
 	$data = array('user_id' =&gt; array(), 'username' =&gt; array());
 
 	$sql = 'SELECT user_id, username
 				FROM ' . CORE_USERS_TABLE . &quot; 
-				WHERE username IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($username)) . &quot;')&quot;;
+				WHERE LOWER(username) IN ('&quot; . implode(&quot;' ,'&quot;, $_CLASS['core_db']-&gt;escape_array($username)) . &quot;')&quot;;
 	$result = $_CLASS['core_db']-&gt;query($sql);
 
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
-		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
+		$data['user_id'][strtolower($row['username'])] = $row['user_id'];
+		$data['username'][] = strtolower($row['username']);
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 
@@ -424,7 +432,7 @@
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$data['user_id'][] = $row['user_id'];
-		$data['username'][] = $row['username'];
+		$data['username'][$row['user_id']] = $row['username'];
 	}
 	$_CLASS['core_db']-&gt;free_result($result);
 

Modified: cms/trunk/includes/templates/modules/forums/mcp_approve.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_approve.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_approve.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -1,38 +1,39 @@
-&lt;!-- INCLUDE overall_header.html --&gt;
-&lt;!-- $Id: mcp_approve.html,v 1.2 2004/07/19 20:13:17 acydburn Exp $ --&gt;
+&lt;!-- DISPLAY_HEADER --&gt;
+
+&lt;!-- INCLUDE modules/forums/mcp_header.html --&gt;
 
 &lt;div id=&quot;pagecontent&quot;&gt;
 
-	&lt;form name=&quot;confirm&quot; action=&quot;{S_CONFIRM_ACTION}&quot; method=&quot;post&quot;&gt;
+	&lt;form name=&quot;confirm&quot; action=&quot;{ $CONFIRM_ACTION }&quot; method=&quot;post&quot;&gt;
 	
 	&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot;&gt;
 	&lt;tr&gt;
-		&lt;th&gt;{MESSAGE_TITLE}&lt;/th&gt;
+		&lt;th&gt;{ $MESSAGE_TITLE }&lt;/th&gt;
 	&lt;/tr&gt;
 	&lt;tr&gt;
 		&lt;td class=&quot;row1&quot; align=&quot;center&quot;&gt;
-			&lt;!-- IF ADDITIONAL_MSG --&gt;
-				&lt;span class=&quot;gen&quot; style=&quot;color:red&quot;&gt;{ADDITIONAL_MSG}&lt;/span&gt;&lt;br /&gt;
+			&lt;!-- IF { $ADDITIONAL_MSG } --&gt;
+				&lt;span class=&quot;gen&quot; style=&quot;color:red&quot;&gt;{ $ADDITIONAL_MSG }&lt;/span&gt;&lt;br /&gt;
 			&lt;!-- ENDIF --&gt;
-			&lt;!-- IF S_NOTIFY_POSTER --&gt;
-				&lt;input type=&quot;checkbox&quot; name=&quot;notify_poster&quot; checked=&quot;checked&quot; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;!-- IF S_APPROVE --&gt;{L_NOTIFY_POSTER_APPROVAL}&lt;!-- ELSE --&gt;{L_NOTIFY_POSTER_DISAPPROVAL}&lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;br /&gt;
+			&lt;!-- IF { $S_NOTIFY_POSTER } --&gt;
+				&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;notify_poster&quot; checked=&quot;checked&quot; /&gt;&lt;span class=&quot;gen&quot;&gt;&lt;!-- IF { $S_APPROVE } --&gt;{ $L_NOTIFY_POSTER_APPROVAL }&lt;!-- ELSE --&gt;{ $L_NOTIFY_POSTER_DISAPPROVAL }&lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;br /&gt;
 			&lt;!-- ENDIF --&gt;
-			&lt;!-- IF not S_APPROVE --&gt;
+			&lt;!-- IF !{ $S_APPROVE } --&gt;
 				&lt;br /&gt;
 				&lt;table border=&quot;0&quot; width=&quot;90%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;1&quot;&gt;
 				&lt;tr&gt;
-					&lt;td class=&quot;row2&quot; width=&quot;22%&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{L_DISAPPROVE_REASON}:&lt;/b&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot; width=&quot;78%&quot;&gt;&lt;select name=&quot;reason_id&quot;&gt;&lt;!-- BEGIN reason --&gt;&lt;option value=&quot;{reason.ID}&quot;&lt;!-- IF reason.S_SELECTED --&gt; selected=&quot;selected&quot;&lt;!-- ENDIF --&gt;&gt;{reason.DESCRIPTION}&lt;/option&gt;&lt;!-- END reason --&gt;&lt;/select&gt;&lt;/td&gt;
+					&lt;td class=&quot;row1&quot; width=&quot;22%&quot;&gt;&lt;b class=&quot;gen&quot;&gt;{ $L_DISAPPROVE_REASON }:&lt;/b&gt;&lt;/td&gt;
+					&lt;td class=&quot;row1&quot; width=&quot;78%&quot;&gt;&lt;select name=&quot;reason_id&quot;&gt;&lt;!-- LOOP $reason --&gt;&lt;option value=&quot;{ $reason:ID }&quot;&lt;!-- IF { $reason:S_SELECTED } --&gt; selected=&quot;selected&quot;&lt;!-- ENDIF --&gt;&gt;{ $reason:DESCRIPTION }&lt;/option&gt;&lt;!-- ENDLOOP $reason --&gt;&lt;/select&gt;&lt;/td&gt;
 				&lt;/tr&gt;
 				&lt;tr&gt;
-					&lt;td class=&quot;row2&quot; valign=&quot;top&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;b&gt;{L_MORE_INFO}:&lt;/b&gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{L_CAN_LEAVE_BLANK}&lt;/span&gt;&lt;/td&gt;
-					&lt;td class=&quot;row2&quot;&gt;&lt;textarea class=&quot;post&quot; style=&quot;width:500px&quot; name=&quot;reason&quot; rows=&quot;10&quot; cols=&quot;40&quot;&gt;{REASON}&lt;/textarea&gt;&lt;/td&gt;
+					&lt;td class=&quot;row1&quot; valign=&quot;top&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;b&gt;{ $L_MORE_INFO }:&lt;/b&gt;&lt;/span&gt;&lt;br /&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_CAN_LEAVE_BLANK }&lt;/span&gt;&lt;/td&gt;
+					&lt;td class=&quot;row1&quot;&gt;&lt;textarea class=&quot;post&quot; style=&quot;width:500px&quot; name=&quot;reason&quot; rows=&quot;10&quot; cols=&quot;40&quot;&gt;{ $REASON }&lt;/textarea&gt;&lt;/td&gt;
 				&lt;/tr&gt;
 				&lt;/table&gt;
 				&lt;br /&gt;
 			&lt;!-- ENDIF --&gt;
-			&lt;br /&gt;{S_HIDDEN_FIELDS}&lt;span class=&quot;gen&quot;&gt;{MESSAGE_TEXT}&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;
-			&lt;input type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;{YES_VALUE}&quot; class=&quot;btnmain&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;{L_NO}&quot; class=&quot;btnlite&quot; /&gt;&lt;/span&gt;
+			&lt;br /&gt;{ $HIDDEN_FIELDS }&lt;span class=&quot;gen&quot;&gt;{ $MESSAGE }&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;
+			&lt;input type=&quot;submit&quot; name=&quot;confirm&quot; value=&quot;Submit&quot; class=&quot;button&quot; /&gt;&nbsp;&nbsp;&lt;input type=&quot;submit&quot; name=&quot;cancel&quot; value=&quot;{ $L_CANCEL }&quot; class=&quot;button&quot; /&gt;&lt;/span&gt;
 		&lt;/td&gt;
 	&lt;/tr&gt;
 	&lt;/table&gt;
@@ -42,15 +43,6 @@
 
 &lt;br clear=&quot;all&quot; /&gt;
 
-&lt;table class=&quot;tablebg&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;0&quot;&gt;
-&lt;tr&gt;
-	&lt;td class=&quot;row1&quot;&gt;
-		&lt;p class=&quot;breadcrumbs&quot;&gt;&lt;a href=&quot;{U_INDEX}&quot;&gt;{L_INDEX}&lt;/a&gt;&lt;!-- BEGIN navlinks --&gt; &#187; &lt;a href=&quot;{navlinks.U_VIEW_FORUM}&quot;&gt;{navlinks.FORUM_NAME}&lt;/a&gt;&lt;!-- END navlinks --&gt;&lt;/p&gt;
-		&lt;p class=&quot;datetime&quot;&gt;{S_TIMEZONE}&lt;/p&gt;
-	&lt;/td&gt;
-&lt;/tr&gt;
-&lt;/table&gt;
-
-&lt;br clear=&quot;all&quot; /&gt;
-
-&lt;!-- INCLUDE overall_footer.html --&gt;
+&lt;!-- INCLUDE modules/forums/mcp_footer.html --&gt;
+
+&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/mcp_notes_user.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_notes_user.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -74,7 +74,7 @@
 			&lt;td style=&quot;text-align: center;&quot;&gt;{ $usernotes:REPORT_AT }&lt;/td&gt;
 			&lt;td class=&quot;gen&quot;&gt;
 				{ $usernotes:ACTION }
-				&lt;!-- IF { $usernotes:DATA } --&gt;&lt;br /&gt;&#187; &lt;span class=&quot;gensmall&quot;&gt;[ { $usernotes:DATA } ]&lt;/span&gt;&lt;!-- ENDIF --&gt;
+				&lt;!-- IF isset({ $usernotes:DATA }) --&gt;&lt;br /&gt;&#187; &lt;span class=&quot;gensmall&quot;&gt;[ { $usernotes:DATA } ]&lt;/span&gt;&lt;!-- ENDIF --&gt;
 			&lt;/td&gt;
 			&lt;td style=&quot;text-align: center;&quot;&gt;&lt;!-- IF { $S_CLEAR_ALLOWED } --&gt;&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;marknote[]&quot; value=&quot;{ $usernotes:ID }&quot; /&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 		&lt;/tr&gt;

Modified: cms/trunk/includes/templates/modules/forums/mcp_queue.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/mcp_queue.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/mcp_queue.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -1,41 +1,50 @@
-{ include file='modules/Forums/mcp_header.html' }
+&lt;!-- DISPLAY_HEADER --&gt;
+
+&lt;!-- INCLUDE modules/forums/mcp_header.html --&gt;
 
-&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;&lt;form name=&quot;mcp&quot; method=&quot;post&quot; action=&quot;{$S_MCP_ACTION}&quot;&gt;
-	&lt;tr&gt;
-		&lt;th colspan=&quot;6&quot; height=&quot;28&quot; nowrap=&quot;nowrap&quot;&gt;{$L_DISPLAY_OPTIONS}&lt;/th&gt;
+&lt;form name=&quot;mcp&quot; id=&quot;mcp&quot; method=&quot;post&quot; action=&quot;{ $S_MCP_ACTION }&quot;&gt;
+
+&lt;table width=&quot;100%&quot; class=&quot;tablebg&quot; cellspacing=&quot;1&quot; cellpadding=&quot;4&quot; border=&quot;0&quot;&gt;
+&lt;tr&gt;
+	&lt;th colspan=&quot;6&quot; nowrap=&quot;nowrap&quot;&gt;{ $L_DISPLAY_OPTIONS }&lt;/th&gt;
+&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;td colspan=&quot;5&quot; class=&quot;cat&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{ $L_DISPLAY_ITEMS }:&lt;/span&gt; { $S_SELECT_SORT_DAYS }&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{ $L_SORT_BY }&lt;/span&gt; { $S_SELECT_SORT_KEY } { $S_SELECT_SORT_DIR }&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{ $L_FORUM }&lt;/span&gt; &lt;select name=&quot;f&quot;&gt;{ $S_FORUM_OPTIONS }&lt;/select&gt; &nbsp; &lt;!-- IF { $TOPIC_ID } --&gt;&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;t&quot; value=&quot;{ $TOPIC_ID }&quot; checked=&quot;checked&quot; /&gt;&nbsp; &lt;b&gt;{ $L_ONLY_TOPIC }&lt;/b&gt; &nbsp; &lt;!-- ENDIF --&gt;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;sort&quot; value=&quot;{ $L_GO }&quot; /&gt;&lt;/span&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;tr&gt; 
+	&lt;th&gt;&nbsp;&lt;!-- IF { $S_TOPICS } --&gt;{ $L_TOPIC }&lt;!-- ELSE --&gt;{ $L_POST }&lt;!-- ENDIF --&gt;&nbsp;&lt;/th&gt;
+	&lt;th&gt;&nbsp;{ $L_AUTHOR }&nbsp;&lt;/th&gt;
+	&lt;th&gt;&nbsp;{ $L_POST_TIME }&nbsp;&lt;/th&gt;
+	&lt;th width=&quot;5%&quot;&gt;&nbsp;{ $L_SELECT }&nbsp;&lt;/th&gt;
+&lt;/tr&gt;
+&lt;!-- LOOP $postrow --&gt;
+	&lt;!-- IF { $postrow:#LOOP_INDEX } % 2 --&gt;&lt;tr class=&quot;row1&quot;&gt;&lt;!-- ELSE --&gt;&lt;tr class=&quot;row2&quot;&gt;&lt;!-- ENDIF --&gt;
+		&lt;td style=&quot;padding: 4px;&quot;&gt;&lt;p class=&quot;topictitle&quot;&gt;&lt;a href=&quot;{ $postrow:U_VIEWTOPIC }&quot;&gt;{ $postrow:POST_SUBJECT }&lt;/a&gt;&lt;/p&gt;
+			&lt;span class=&quot;gensmall&quot;&gt;&lt;!-- IF { $postrow:U_VIEWFORUM } --&gt;{ $L_FORUM }: &lt;a href=&quot;{ $postrow:U_VIEWFORUM }&quot;&gt;{ $postrow:FORUM_NAME }&lt;/a&gt;&lt;!-- ELSE --&gt;{ $postrow:FORUM_NAME }&lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;/td&gt;
+		&lt;td style=&quot;padding: 4px;&quot; align=&quot;left&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;span class=&quot;gen&quot;&gt;&lt;!-- IF { $postrow:U_VIEWPROFILE } --&gt;&lt;a href=&quot;{ $postrow:U_VIEWPROFILE }&quot;&gt;{ $postrow:POSTER }&lt;/a&gt;&lt;!-- ELSE --&gt;{ $postrow:POSTER }&lt;!-- ENDIF --&gt;&lt;/span&gt;&lt;br /&gt;
+			&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;{ $postrow:U_VIEW_DETAILS }&quot;&gt;{ $L_VIEW_DETAILS }&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
+		&lt;td class=&quot;postdetails&quot; style=&quot;padding: 4px;&quot; align=&quot;left&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;{ $postrow:POST_TIME }&lt;/td&gt;
+		&lt;td align=&quot;center&quot;&gt;&lt;input type=&quot;checkbox&quot; class=&quot;radio&quot; name=&quot;post_id_list[]&quot; value=&quot;{ $postrow:POST_ID }&quot; /&gt;&lt;/td&gt;
 	&lt;/tr&gt;
+&lt;!-- LOOPELSE --&gt;
 	&lt;tr&gt;
-		&lt;td colspan=&quot;5&quot; class=&quot;cat&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;span class=&quot;gensmall&quot;&gt;{$L_DISPLAY_ITEMS}:&lt;/span&gt; {$S_SELECT_SORT_DAYS}&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{$L_SORT_BY}&lt;/span&gt; {$S_SELECT_SORT_KEY} {$S_SELECT_SORT_DIR}&nbsp;&lt;span class=&quot;gensmall&quot;&gt;{$L_FORUM}&lt;/span&gt; &lt;select name=&quot;f&quot;&gt;{$S_FORUM_OPTIONS}&lt;/select&gt;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;sort&quot; value=&quot;{$L_GO}&quot; /&gt;&lt;/span&gt;&lt;/td&gt;
+		&lt;td class=&quot;row1&quot; colspan=&quot;6&quot; height=&quot;30&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ $L_NO_POSTS }&lt;/span&gt;&lt;/td&gt;
 	&lt;/tr&gt;
-	&lt;tr&gt; 
-		&lt;th height=&quot;28&quot;&gt;&nbsp;{$L_TOPIC}&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;{$L_AUTHOR}&nbsp;&lt;/th&gt;
-		&lt;th&gt;&nbsp;{$L_POST_TIME}&nbsp;&lt;/th&gt;
-		&lt;th width=&quot;5%&quot;&gt;&nbsp;{$L_SELECT}&nbsp;&lt;/th&gt;
-	&lt;/tr&gt;
-	{section name=postrowloop loop=$postrow}
-	{ if $smarty.section.postrowloop.index is even }&lt;tr class=&quot;row1&quot;&gt;{ else }&lt;tr class=&quot;row2&quot;&gt;{ /if }
-		&lt;td style=&quot;padding: 4px;&quot;&gt;&lt;p class=&quot;topictitle&quot;&gt;&lt;a href=&quot;{$postrow[postrowloop].U_VIEWTOPIC}&quot;&gt;{$postrow[postrowloop].TOPIC_TITLE}&lt;/a&gt;&lt;/p&gt;&lt;br /&gt;
-			&lt;span class=&quot;gensmall&quot;&gt;{$L_FORUM}: &lt;a href=&quot;{$postrow[postrowloop].U_VIEWFORUM}&quot;&gt;{$postrow[postrowloop].FORUM_NAME}&lt;/a&gt;&lt;/span&gt;&lt;/td&gt;
-		&lt;td style=&quot;padding: 4px;&quot; align=&quot;left&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{ if $postrow[postrowloop].U_VIEWPROFILE }&lt;a href=&quot;{$postrow[postrowloop].U_VIEWPROFILE}&quot;&gt;{$postrow[postrowloop].POSTER}&lt;/a&gt;{ else }{$postrow[postrowloop].POSTER}{ /if }&lt;/span&gt;&lt;br /&gt;
-			&lt;span class=&quot;gensmall&quot;&gt;[ &lt;a href=&quot;{$postrow[postrowloop].U_VIEW_DETAILS}&quot;&gt;{$L_VIEW_DETAILS}&lt;/a&gt; ]&lt;/span&gt;&lt;/td&gt;
-		&lt;td class=&quot;postdetails&quot; style=&quot;padding: 4px;&quot; align=&quot;left&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;{$postrow[postrowloop].POST_TIME}&lt;/td&gt;
-		&lt;td align=&quot;center&quot;&gt;{$postrow[postrowloop].S_CHECKBOX}&lt;/td&gt;
-	&lt;/tr&gt;
-	{ sectionelse }
-	&lt;tr&gt;
-		&lt;td class=&quot;row1&quot; colspan=&quot;6&quot; height=&quot;30&quot; align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;span class=&quot;gen&quot;&gt;{$L_NO_POSTS}&lt;/span&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-	{ /section }
-	&lt;tr&gt;
-		&lt;td class=&quot;cat&quot; colspan=&quot;6&quot; height=&quot;28&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;mode[approve]&quot; value=&quot;{$L_APPROVE}&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;mode[disapprove]&quot; value=&quot;{$L_DISAPPROVE}&quot; /&gt;&lt;/td&gt;
-	&lt;/tr&gt;
-&lt;/form&gt;&lt;/table&gt;
+&lt;!-- ENDLOOP $postrow --&gt;
+&lt;tr&gt;
+	&lt;td class=&quot;cat&quot; colspan=&quot;6&quot; align=&quot;center&quot;&gt;&lt;input class=&quot;btnmain&quot; type=&quot;submit&quot; name=&quot;action[approve]&quot; value=&quot;{ $L_APPROVE }&quot; /&gt;&nbsp;&nbsp;&lt;input class=&quot;btnlite&quot; type=&quot;submit&quot; name=&quot;action[disapprove]&quot; value=&quot;{ $L_DISAPPROVE }&quot; /&gt;&lt;/td&gt;
+&lt;/tr&gt;
+&lt;/table&gt;
 
+&lt;/form&gt;
+
 &lt;table width=&quot;100%&quot; cellspacing=&quot;2&quot; cellpadding=&quot;2&quot; border=&quot;0&quot; align=&quot;center&quot;&gt;
-	&lt;tr&gt;
-		&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('mcp', true);&quot;&gt;{$L_MARK_ALL}&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('mcp', false);&quot;&gt;{$L_UNMARK_ALL}&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;
-	&lt;/tr&gt;
+&lt;tr&gt;
+	&lt;td align=&quot;right&quot; valign=&quot;top&quot; nowrap=&quot;nowrap&quot;&gt;&lt;b class=&quot;gensmall&quot;&gt;&lt;a href=&quot;javascript:marklist('mcp', '', true);&quot;&gt;{ $L_MARK_ALL }&lt;/a&gt; :: &lt;a href=&quot;javascript:marklist('mcp', '', false);&quot;&gt;{ $L_UNMARK_ALL }&lt;/a&gt;&lt;/b&gt;&lt;/td&gt;
+&lt;/tr&gt;
 &lt;/table&gt;
 
-{ include file='modules/Forums/mcp_footer.html' }
\ No newline at end of file
+
+&lt;!-- INCLUDE modules/forums/mcp_footer.html --&gt;
+
+&lt;!-- DISPLAY_FOOTER --&gt;
\ No newline at end of file

Modified: cms/trunk/includes/templates/modules/forums/viewtopic_body.html
===================================================================
--- cms/trunk/includes/templates/modules/forums/viewtopic_body.html	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/includes/templates/modules/forums/viewtopic_body.html	2006-08-13 02:53:31 UTC (rev 183)
@@ -118,7 +118,7 @@
 		&lt;!-- IF { $postrow:S_IGNORE_POST } --&gt;
 			&lt;td class=&quot;gensmall&quot; colspan=&quot;2&quot; height=&quot;25&quot; align=&quot;center&quot;&gt;{ $postrow:L_IGNORE_POST }&lt;/td&gt;
 		&lt;!-- ELSE --&gt;
-			&lt;td align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;!-- IF { $postrow:S_FIRST_UNREAD } --&gt;&lt;a name=&quot;unread&quot;&gt;&lt;/a&gt;&lt;!-- ELSE --&gt;&lt;a name=&quot;{ $postrow:POST_ID }&quot;&gt;&lt;/a&gt;&lt;!-- ENDIF --&gt;
+			&lt;td align=&quot;center&quot; valign=&quot;middle&quot;&gt;&lt;!-- IF { $postrow:S_FIRST_UNREAD } --&gt;&lt;a name=&quot;unread&quot;&gt;&lt;/a&gt;&lt;!-- ELSE --&gt;&lt;a name=&quot;p{ $postrow:POST_ID }&quot;&gt;&lt;/a&gt;&lt;!-- ENDIF --&gt;
 			&lt;!-- IF { $postrow:U_PROFILE } --&gt;&lt;a href=&quot;{ $postrow:U_PROFILE }&quot;&gt;&lt;b class=&quot;postauthor&quot;&gt;{ $postrow:POSTER_NAME }&lt;/b&gt;&lt;!-- ELSE --&gt;&lt;b class=&quot;postauthor&quot;&gt;{ $postrow:POSTER_NAME }&lt;/b&gt;&lt;!-- ENDIF --&gt;&lt;/td&gt;
 			&lt;td width=&quot;100%&quot; height=&quot;25&quot;&gt;&lt;table width=&quot;100%&quot; cellspacing=&quot;0&quot;&gt;
 				&lt;tr&gt;

Modified: cms/trunk/modules/control_panel/index.php
===================================================================
--- cms/trunk/modules/control_panel/index.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/index.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -51,7 +51,7 @@
 	function process_module($type = 'page')
 	{
 		global $_CLASS;
-		
+
 		if ($this-&gt;module)
 		{
 			$sql = 'SELECT * FROM ' . CORE_CONTROL_PANEL_MODULES_TABLE. &quot;
@@ -129,7 +129,7 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 	
 		// Output listing of friends online
-		$online_time = $_CLASS['core_user']-&gt;time = $_CORE_CONFIG['server']['session_length'];
+		$online_time = ($_CLASS['core_user']-&gt;time - $_CORE_CONFIG['server']['session_length']);
 		
 		$sql = 'SELECT DISTINCT u.user_id, u.username, s.session_time, s.session_hidden
 			FROM ' . CORE_USERS_TABLE . ' u, ' . ZEBRA_TABLE . ' z 

Modified: cms/trunk/modules/control_panel/modules/ucp_pm.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -11,42 +11,35 @@
 // 
 // -------------------------------------------------------------
 
-/**
-* @package ucp
-* ucp_pm
-*
-* Private Message Class
-*
-* @param int $folder display folder with the id used
-* @param inbox|outbox|sentbox display folder with the associated name
-*
-*
-*	Display Unread Messages - mode=unread
-*
-*	if the folder id with (&amp;f=[folder_id]) is used when displaying messages, one query will be saved. If it is not used, phpBB needs to grab
-*	the folder id first in order to display the input boxes and folder names and such things. ;) phpBB always checks this against the database to make
-*	sure the user is able to view the message.
-*
-*	Composing Messages (mode=compose):
-*		To specific user (u=[user_id])
-*		To specific group (g=[group_id])
-*		Quoting a post (action=quote&amp;q=1&amp;p=[post_id])
-*		Quoting a PM (action=quote&amp;p=[msg_id])
-*		Forwarding a PM (action=forward&amp;p=[msg_id])
-*
-*
-* @todo Review of post when replying/quoting
-* @todo Report PM
-* @todo Check Permissions (compose message - to user/group)
-*
+/** 
+* Private Message Class
+*
+* @param int $folder display folder with the id used
+* @param inbox|outbox|sentbox display folder with the associated name
+*
+*
+*	Display Messages (default to inbox) - mode=view
+*	Display single message - mode=view&amp;p=[msg_id] or &amp;p=[msg_id] (short linkage)
+*
+*	if the folder id with (&amp;f=[folder_id]) is used when displaying messages, one query will be saved. If it is not used, phpBB needs to grab
+*	the folder id first in order to display the input boxes and folder names and such things. ;) phpBB always checks this against the database to make
+*	sure the user is able to view the message.
+*
+*	Composing Messages (mode=compose):
+*		To specific user (u=[user_id])
+*		To specific group (g=[group_id])
+*		Quoting a post (action=quotepost&amp;p=[post_id])
+*		Quoting a PM (action=quote&amp;p=[msg_id])
+*		Forwarding a PM (action=forward&amp;p=[msg_id])
+*
+* @package ucp
 */
-
 global $_CLASS, $config;
 
 $action = '';
 $mode = false;
 
-if ($_CLASS['core_user']-&gt;data['user_id'] == ANONYMOUS)
+if (!$_CLASS['core_user']-&gt;is_user)
 {
 	trigger_error('NO_MESSAGE');
 }
@@ -78,11 +71,11 @@
 		$folder_specified = ($folder_specified === 'sentbox') ? PRIVMSGS_SENTBOX : (($folder_specified === 'outbox') ? PRIVMSGS_OUTBOX : PRIVMSGS_INBOX);
 	}
 
-	$mode = 'view_messages';
+	$mode = 'view';
 }
 else
 {
-	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view_messages') : $mode;
+	$mode = (!$mode) ? get_variable('mode', 'REQUEST', 'view') : $mode;
 }
 
 $id = 'pm';
@@ -91,7 +84,7 @@
 require_once SITE_FILE_ROOT.'includes/forums/functions_privmsgs.php';
 
 $_CLASS['core_template']-&gt;assign_array(array( 
-	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;lang['UCP_PM_' . strtoupper($mode)],
+	'L_TITLE'			=&gt; $_CLASS['core_user']-&gt;get_lang('UCP_PM_' . strtoupper($mode)),
 	'S_UCP_ACTION'      =&gt; generate_link($this-&gt;link . ((isset($action)) ? &quot;&amp;action=$action&quot; : '')))
 );
 
@@ -100,7 +93,7 @@
 	// New private messages popup
 	case 'popup':
 	
-		$indox_link = generate_link('control_panel&amp;i=pm&amp;folder=inbox');
+		$indox_link = generate_link('control_panel&amp;i=pm&amp;folder=inbox');
 
 		if ($_CLASS['core_user']-&gt;data['user_new_privmsg'])
 		{
@@ -126,7 +119,7 @@
 	case 'compose':
 		$action = get_variable('action', 'REQUEST', 'post');
 
-		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+		get_folder($_CLASS['core_user']-&gt;data['user_id']);
 		
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_compose.php';
 		compose_pm($id, $mode, $action);
@@ -135,19 +128,11 @@
 	break;
 	
 	case 'options':
-		/*$sql = 'SELECT group_message_limit
-			FROM ' . CORE_GROUPS_TABLE . '
-			WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-*/
 		$message_limit = 10;
 		
 		(int) $_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 		
-		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+		get_folder($_CLASS['core_user']-&gt;data['user_id']);
 
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_options.php';
 		message_options($id, $mode, $global_privmsgs_rules, $global_rule_conditions);
@@ -156,7 +141,7 @@
 	break;
 
 	case 'drafts':
-		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder);
+		get_folder($_CLASS['core_user']-&gt;data['user_id']);
 	
 		require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_main.php';
 		$module = new ucp_main($id, $mode);
@@ -164,16 +149,9 @@
 		exit;
 	break;
 
-	case 'unread':
-	case 'view_messages':
-		$sql = 'SELECT group_message_limit
-			FROM ' . CORE_GROUPS_TABLE . '
-			WHERE group_id = ' . $_CLASS['core_user']-&gt;data['user_group'];
-		$result = $_CLASS['core_db']-&gt;query($sql);
+	case 'view':
+		$message_limit = 10;
 
-		list($message_limit) = $_CLASS['core_db']-&gt;fetch_row_num($result);
-		$_CLASS['core_db']-&gt;free_result($result);
-
 		$_CLASS['core_user']-&gt;data['user_message_limit'] = (!$message_limit) ? $config['pm_max_msgs'] : $message_limit;
 
 		if ($folder_specified)
@@ -183,36 +161,42 @@
 		}
 		else
 		{
-			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_INBOX, 'int');
+			$folder_id = get_variable('f', 'REQUEST', PRIVMSGS_NO_BOX, 'int');
 			$action = get_variable('action', 'REQUEST', 'view_folder');
 		}
 
-		if ($folder_id === PRIVMSGS_NO_BOX)
-		{
-			$folder_id = PRIVMSGS_INBOX;
-		}
-
 		$msg_id = get_variable('p', 'REQUEST', 0, 'int');
 		$view	= get_variable('view', 'REQUEST');
 		
-		if ($msg_id &amp;&amp; $action === 'view_folder')
+		if ($msg_id)
 		{
 			$action = 'view_message';
 		}
 
-// First Handle Mark actions and moving messages
+		// First Handle Mark actions and moving messages
+		$submit_mark	= isset($_POST['submit_mark']);
+		$move_pm		= isset($_POST['move_pm']);
+		$mark_option	= get_variable('mark_option', 'REQUEST', '');
+		$dest_folder	= get_variable('dest_folder', 'REQUEST', PRIVMSGS_NO_BOX);
 
+		// Is moving PM triggered through mark options?
+		if (!in_array($mark_option, array('mark_important', 'delete_marked')) &amp;&amp; $submit_mark)
+		{
+			$move_pm = true;
+			$dest_folder = (int) $mark_option;
+			$submit_mark = false;
+		}
+
 		// Move PM
-		if (isset($_REQUEST['move_pm']))
+		if ($move_pm)
 		{
 			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
-			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_INBOX, 'int');
-			$dest_folder	= get_variable('dest_folder', 'POST', PRIVMSGS_INBOX, 'int');
+			$cur_folder_id	= get_variable('cur_folder_id', 'POST', PRIVMSGS_NO_BOX, 'int');
 
 			if (move_pm($_CLASS['core_user']-&gt;data['user_id'], $_CLASS['core_user']-&gt;data['user_message_limit'], $msg_ids, $dest_folder, $cur_folder_id))
 			{
 				// Return to folder view if single message moved
-				if ($action == 'view_message')
+				if ($action === 'view_message')
 				{
 					$msg_id		= 0;
 					$folder_id	= $cur_folder_id;
@@ -222,7 +206,7 @@
 		}
 
 		// Message Mark Options
-		if (isset($_REQUEST['submit_mark']))
+		if ($submit_mark)
 		{
 			$mark_option = get_variable('mark_option', 'POST');
 			$msg_ids		= isset($_POST['marked_msg_id']) ? array_unique(array_map('intval', $_POST['marked_msg_id'])) : array();
@@ -232,12 +216,11 @@
 			{
 				case 'mark_read':
 				case 'mark_unread':
-						$read_status = ($mark_option === 'mark_read');
-						set_read_status($read_status, $msg_ids, $_CLASS['core_user']-&gt;data['user_id'], $cur_folder_id);
+					$read_status = ($mark_option === 'mark_read');
+					set_read_status($read_status, $msg_ids, $_CLASS['core_user']-&gt;data['user_id'], $cur_folder_id);
 				break;
 
 				default:
-					// redo this
 					handle_mark_actions($_CLASS['core_user']-&gt;data['user_id'], $mark_option, $msg_ids, $cur_folder_id);
 				break;
 			}
@@ -248,13 +231,34 @@
 
 		if ($_CLASS['core_user']-&gt;data['user_new_privmsg'] &amp;&amp; $action == 'view_folder')
 		{
-			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', false));
+			place_pm_into_folder($global_privmsgs_rules, get_variable('release', 'POST', 0));
 			$num_not_moved = $_CLASS['core_user']-&gt;data['user_new_privmsg'];
 		}
 
+		if (!$msg_id &amp;&amp; $folder_id == PRIVMSGS_NO_BOX)
+		{
+			$folder_id = PRIVMSGS_INBOX;
+		}
+		else if ($msg_id &amp;&amp; $folder_id == PRIVMSGS_NO_BOX)
+		{
+			$sql = 'SELECT folder_id
+				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . &quot;
+				WHERE msg_id = $msg_id
+					AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
+			$result = $_CLASS['core_db']-&gt;query($sql);
+			$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+			$_CLASS['core_db']-&gt;free_result($result);
+
+			if (!$row)
+			{
+				trigger_error('NO_MESSAGE');
+			}
+			$folder_id = (int) $row['folder_id'];
+		}
+
 		$message_row = array();
 
-		if ($mode === 'view_messages' &amp;&amp; $action === 'view_message' &amp;&amp; $msg_id)
+		if ($action === 'view_message' &amp;&amp; $msg_id)
 		{
 			// Get Message user want to see
 			if ($view === 'next' || $view === 'previous')
@@ -280,8 +284,10 @@
 						AND p.message_time $sql_condition p2.message_time
 					ORDER BY p.message_time $sql_ordering&quot;;
 				$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
+				$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+				$_CLASS['core_db']-&gt;free_result($result);
 
-				if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+				if (!$row)
 				{
 					$message = ($view === 'next') ? 'NO_NEWER_PM' : 'NO_OLDER_PM';
 					trigger_error($message);
@@ -290,8 +296,6 @@
 				{
 					$msg_id = $row['msg_id'];
 				}
-
-				$_CLASS['core_db']-&gt;free_result($result);
 			}
 
 			$sql = 'SELECT t.*, p.*, u.*
@@ -311,24 +315,22 @@
 			}
 
 			// Update unread status
-			if ($message_row['unread'])
+			if ($message_row['pm_unread'])
 			{
 				set_read_status(true, $message_row['msg_id'], $_CLASS['core_user']-&gt;data['user_id'], $folder_id);
 			}
 		}
 
-		$folder = array();
-		get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder, $folder_id);
+		$folder = get_folder($_CLASS['core_user']-&gt;data['user_id'], $folder_id);
 
 		$s_folder_options = $s_to_folder_options = '';
 		foreach ($folder as $f_id =&gt; $folder_ary)
 		{
-			$option = '&lt;option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $f_id . '&quot;' . ((($f_id == $folder_id &amp;&amp; $mode != 'unread') || ($f_id === 'unread' &amp;&amp; $mode == 'unread')) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '&lt;/option&gt;';
+			$option = '&lt;option' . ((!in_array($f_id, array(PRIVMSGS_INBOX, PRIVMSGS_OUTBOX, PRIVMSGS_SENTBOX))) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $f_id . '&quot;' . (($f_id == $folder_id) ? ' selected=&quot;selected&quot;' : '') . '&gt;' . $folder_ary['folder_name'] . (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '&lt;/option&gt;';
 
 			$s_to_folder_options .= ($f_id != PRIVMSGS_OUTBOX &amp;&amp; $f_id != PRIVMSGS_SENTBOX) ? $option : '';
 			$s_folder_options .= $option;
 		}
-
 		clean_sentbox($folder[PRIVMSGS_SENTBOX]['num_messages']);
 
 		// Header for message view - folder and so on
@@ -343,7 +345,7 @@
 
 			'S_FOLDER_OPTIONS'			=&gt; $s_folder_options,
 			'S_TO_FOLDER_OPTIONS'		=&gt; $s_to_folder_options,
-			'S_FOLDER_ACTION'			=&gt; generate_link($this-&gt;link_parent.'&amp;mode=view_messages&amp;action=view_folder'),
+			'S_FOLDER_ACTION'			=&gt; generate_link($this-&gt;link_parent.'&amp;mode=view&amp;action=view_folder'),
 			'S_PM_ACTION'				=&gt; generate_link($this-&gt;link_parent.'&amp;mode=$mode&amp;action='.$action),
 			
 			'U_INBOX'					=&gt; generate_link($this-&gt;link_parent.'&amp;folder=inbox'),
@@ -364,7 +366,7 @@
 		
 		$_CLASS['core_template']-&gt;assign('S_VIEW_MESSAGE',  false);
 
-		if ($mode == 'unread' || $action == 'view_folder')
+		if ($action === 'view_folder')
 		{
 			require SITE_FILE_ROOT.'modules/control_panel/modules/ucp_pm_viewfolder.php';
 			view_folder($this, $folder_id, $folder, (($mode === 'unread') ? 'unread' : 'folder'));
@@ -376,8 +378,8 @@
 		{
 			$_CLASS['core_template']-&gt;assign_array(array(
 				'S_VIEW_MESSAGE'=&gt; true,
-				'MSG_ID'		=&gt; $msg_id)
-			);
+				'MSG_ID'		=&gt; $msg_id
+			));
 		
 			if (!$msg_id)
 			{
@@ -396,70 +398,4 @@
 	break;
 }
 
-/*
-function obtain_icons()
-{
-	global $_CLASS;
-
-	if (is_null($icons = $_CLASS['core_cache']-&gt;get('icons')))
-	{
-		$sql = 'SELECT *
-			FROM ' . FORUMS_ICONS_TABLE . ' 
-			ORDER BY icons_order';
-		$result = $_CLASS['core_db']-&gt;query($sql);
-
-		$icons = array();
-
-		while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
-		{
-			$icons[$row['icons_id']]['img'] = $row['icons_url'];
-			$icons[$row['icons_id']]['width'] = (int) $row['icons_width'];
-			$icons[$row['icons_id']]['height'] = (int) $row['icons_height'];
-			$icons[$row['icons_id']]['display'] = (bool) $row['display_on_posting'];
-		}
-
-		$_CLASS['core_db']-&gt;free_result($result);
-
-		$_CLASS['core_cache']-&gt;put('icons', $icons);
-	}
-
-	return $icons;
-}*/
-
-/*
-function gen_sort_selects(&amp;$limit_days, &amp;$sort_by_text, &amp;$sort_days, &amp;$sort_key, &amp;$sort_dir, &amp;$s_limit_days, &amp;$s_sort_key, &amp;$s_sort_dir, &amp;$u_sort_param)
-{
-	global $_CLASS;
-
-	$sort_dir_text = array('a' =&gt; $_CLASS['core_user']-&gt;lang['ASCENDING'], 'd' =&gt; $_CLASS['core_user']-&gt;lang['DESCENDING']);
-
-	$s_limit_days = '&lt;select name=&quot;st&quot;&gt;';
-	foreach ($limit_days as $day =&gt; $text)
-	{
-		$selected = ($sort_days == $day) ? ' selected=&quot;selected&quot;' : '';
-		$s_limit_days .= '&lt;option value=&quot;' . $day . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
-	}
-	$s_limit_days .= '&lt;/select&gt;';
-
-	$s_sort_key = '&lt;select name=&quot;sk&quot;&gt;';
-	foreach ($sort_by_text as $key =&gt; $text)
-	{
-		$selected = ($sort_key == $key) ? ' selected=&quot;selected&quot;' : '';
-		$s_sort_key .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $text . '&lt;/option&gt;';
-	}
-	$s_sort_key .= '&lt;/select&gt;';
-
-	$s_sort_dir = '&lt;select name=&quot;sd&quot;&gt;';
-	foreach ($sort_dir_text as $key =&gt; $value)
-	{
-		$selected = ($sort_dir == $key) ? ' selected=&quot;selected&quot;' : '';
-		$s_sort_dir .= '&lt;option value=&quot;' . $key . '&quot;' . $selected . '&gt;' . $value . '&lt;/option&gt;';
-	}
-	$s_sort_dir .= '&lt;/select&gt;';
-
-	$u_sort_param = &quot;st=$sort_days&amp;sk=$sort_key&amp;sd=$sort_dir&quot;;
-
-	return;
-}*/
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_compose.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_compose.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -13,6 +13,7 @@
 
 // * Called from ucp_pm with mode == 'compose'
 
+global $_CLASS;
 
 load_class(SITE_FILE_ROOT.'includes/forums/auth.php', 'forums_auth');
 $_CLASS['forums_auth']-&gt;acl($_CLASS['core_user']-&gt;data);
@@ -46,7 +47,6 @@
 	$to_user_id     = get_variable('u', 'REQUEST', 0);
   	$to_group_id    = get_variable('g', 'REQUEST', 0);
 	$msg_id			= get_variable('p', 'REQUEST', 0);
-	$quote_post		= get_variable('q', 'REQUEST', 0);
 	$draft_id		= get_variable('d', 'REQUEST', 0);
 	$lastclick		= get_variable('lastclick', 'REQUEST', 0);
 	$message_text = $subject = '';
@@ -58,8 +58,7 @@
 	$preview	= isset($_POST['preview']);
 	$save		= isset($_POST['save']);
 	$load		= isset($_POST['load']);
-	$cancel		= isset($_POST['cancel']);
-	$confirm	= isset($_POST['confirm']);
+	$cancel		= (isset($_POST['cancel']) &amp;&amp; !isset($_POST['save']));
 	$delete		= isset($_POST['delete']);
 
 	$remove_u	= isset($_REQUEST['remove_u']);
@@ -67,18 +66,17 @@
 	$add_to		= isset($_REQUEST['add_to']);
 	$add_bcc	= isset($_REQUEST['add_bcc']);
 
-	$refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || $save || $load
+	$refresh	= isset($_POST['add_file']) || isset($_POST['delete_file']) || isset($_POST['edit_comment']) || $save || $load
 		|| $remove_u || $remove_g || $add_to || $add_bcc;
 
-	$action		= ($delete &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $submit) ? 'delete' : $action;
+	$action		= ($delete &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $submit) ? 'delete' : $action;
 
 	$error = array();
-	$current_time = gmtime();
 
 	// Was cancel pressed? If so then redirect to the appropriate page
-	if ($cancel || ($current_time - $lastclick &lt; 2 &amp;&amp; $submit))
+	if ($cancel || ($_CLASS['core_user']-&gt;time - $lastclick &lt; 2 &amp;&amp; $submit))
 	{
-		$redirect = generate_link(&quot;Control_Panel&amp;i=$id&amp;mode=view_messages&amp;action=view_message&quot; . (($msg_id) ? &quot;&amp;p=$msg_id&quot; : ''));
+		$redirect = generate_link(&quot;control_panel&amp;i=$id&amp;mode=view&amp;action=view_message&quot; . (($msg_id) ? &quot;&amp;p=$msg_id&quot; : ''));
 		redirect($redirect);
 	}
 
@@ -104,6 +102,7 @@
 		case 'reply':
 		case 'quote':
 		case 'forward':
+		case 'quotepost':
 			if (!$msg_id)
 			{
 				trigger_error('NO_MESSAGE');
@@ -114,7 +113,7 @@
 				trigger_error('NO_AUTH_SEND_MESSAGE');
 			}
 
-			if ($quote_post)
+			if ($action == 'quotepost')
 			{
 				$sql = 'SELECT p.post_text as message_text, p.poster_id as author_id, p.post_time as message_time, p.bbcode_bitfield, p.bbcode_uid, p.enable_sig, p.enable_html, p.enable_smilies, p.enable_magic_url, t.topic_title as message_subject, u.username as quote_username
 					FROM ' . FORUMS_POSTS_TABLE . ' p, ' . FORUMS_TOPICS_TABLE . ' t, ' . CORE_USERS_TABLE . &quot; u
@@ -159,7 +158,7 @@
 				trigger_error('NO_MESSAGE');
 			}
 
-			$sql = 'SELECT msg_id, unread, new, author_id, folder_id
+			$sql = 'SELECT msg_id, pm_unread, pm_new, author_id, folder_id
 				FROM ' . FORUMS_PRIVMSGS_TO_TABLE . '
 				WHERE user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . &quot;
 					AND msg_id = $msg_id&quot;;
@@ -181,43 +180,72 @@
 	if ($sql)
 	{
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-		if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+		$post = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+		
+		if (!$post)
 		{
 			trigger_error('NO_MESSAGE');
 		}
+	
+		$msg_id			= (int) $post['msg_id'];
+		$folder_id		= isset($post['folder_id']) ? $post['folder_id'] : 0;
+		$message_text	= isset($post['message_text']) ? $post['message_text'] : '';
 
-		extract($row);
-		$_CLASS['core_db']-&gt;free_result($result);
-		
-		$msg_id = (int) $msg_id;
-		$enable_urls = $enable_magic_url;
+		if (!$post['author_id'] &amp;&amp; $msg_id)
+		{
+			trigger_error('NO_AUTHOR');
+		}
 
-		if (!$author_id &amp;&amp; $msg_id)
-		{
-			trigger_error('NO_AUTHOR');
+		if ($action === 'quotepost')
+		{
+			// Decode text for message display
+			decode_message($message_text, $post['bbcode_uid']);
 		}
 
-		if (($action == 'reply' || $action == 'quote') &amp;&amp; empty($address_list) &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp; !$preview)
+		if ($action !== 'delete')
 		{
-			$address_list = array('u' =&gt; array($author_id =&gt; 'to'));
+			$enable_urls = $post['enable_magic_url'];
+			$enable_sig = isset($post['enable_sig']) ? $post['enable_sig'] : 0;
+
+			$message_attachment = isset($post['message_attachement']) ? $post['message_attachement'] : 0;
+			$message_subject = $post['message_subject'];
+			$message_time = $post['message_time'];
+			$bbcode_uid = $post['bbcode_uid'];
+
+			$quote_username = isset($post['quote_username']) ? $post['quote_username'] : '';
+			$icon_id = isset($post['icon_id']) ? $post['icon_id'] : 0;
+
+			if (($action === 'reply' || $action === 'quote' || $action === 'quotepost') &amp;&amp; empty($address_list) &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp; !$preview)
+			{
+				$address_list = array('u' =&gt; array($post['author_id'] =&gt; 'to'));
+			}
+			elseif ($action === 'edit' &amp;&amp; empty($address_list) &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp; !$preview)
+			{
+				// Rebuild TO and BCC Header
+				$address_list = rebuild_header(array('to' =&gt; $post['to_address'], 'bcc' =&gt; $post['bcc_address']));
+			}
+
+			if ($action == 'quotepost')
+			{
+				$check_value = 0;
+			}
+			else
+			{
+				$check_value = (($post['enable_bbcode']+1) &lt;&lt; 8) + (($post['enable_smilies']+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($post['enable_sig']+1) &lt;&lt; 1);
+			}
 		}
-		elseif ($action == 'edit' &amp;&amp; empty($address_list) &amp;&amp; !$refresh &amp;&amp; !$submit &amp;&amp; !$preview)
-		{
-			// Rebuild TO and BCC Header
-			$address_list = rebuild_header(array('to' =&gt; $to_address, 'bcc' =&gt; $bcc_address));
-		}
-		$check_value = (($enable_html+1) &lt;&lt; 16) + (($enable_bbcode+1) &lt;&lt; 8) + (($enable_smilies+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($enable_sig+1) &lt;&lt; 1);
 	}
 	else
 	{
 		$message_attachment = 0;
+		$message_text = $message_subject = '';
 
-		if ($to_user_id &amp;&amp; $action == 'post')
+		if ($to_user_id &amp;&amp; $action === 'post')
 		{
 			$address_list['u'][$to_user_id] = 'to';
 		}
-		else if ($to_group_id &amp;&amp; $action == 'post')
+		else if ($to_group_id &amp;&amp; $action === 'post')
 		{
 			$address_list['g'][$to_group_id] = 'to';
 		}
@@ -229,9 +257,9 @@
 		trigger_error('NO_AUTH_GROUP_MESSAGE');
 	}
 
-	if ($action == 'edit' &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; !$submit)
+	if ($action === 'edit' &amp;&amp; !$refresh &amp;&amp; !$preview &amp;&amp; !$submit)
 	{
-		if (!($message_time &gt; time() - $config['pm_edit_time'] || !$config['pm_edit_time']))
+		if (!($message_time &gt; $_CLASS['core_user']-&gt;time - ($config['pm_edit_time'] * 60) || !$config['pm_edit_time']))
 		{
 			trigger_error('CANNOT_EDIT_MESSAGE_TIME');
 		}
@@ -248,39 +276,36 @@
 
 	$message_parser = new parse_message();
 
-	$message_subject = isset($message_subject) ? $message_subject : '';
-	$message_parser-&gt;message = ($action == 'reply') ? '' : (isset($message_text) ? $message_text : '');
+	$message_parser-&gt;message = ($action == 'reply') ? '' : $message_text;
 	unset($message_text);
 
-	$s_action = &quot;Control_Panel&amp;i=$id&amp;mode=$mode&amp;action=$action&quot;;
+	$s_action = &quot;control_panel&amp;i=$id&amp;mode=$mode&amp;action=$action&quot;;
 	$s_action .= ($msg_id) ? &quot;&amp;p=$msg_id&quot; : '';
-	$s_action .= ($quote_post) ? &quot;&amp;q=1&quot; : '';
 
 	// Delete triggered ?
-	if ($action == 'delete')
+	if ($action === 'delete')
 	{
 		// Folder id has been determined by the SQL Statement
 		// $folder_id = request_var('f', PRIVMSGS_NO_BOX);
 
-		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;p&quot; value=&quot;' . $msg_id . '&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;f&quot; value=&quot;' . $folder_id . '&quot; /&gt;&lt;input type=&quot;hidden&quot; name=&quot;action&quot; value=&quot;delete&quot; /&gt;';
+		$s_hidden_fields = array(
+			'p'			=&gt; $msg_id,
+			'f'			=&gt; $folder_id,
+			'action'	=&gt; 'delete'
+		);
 
-		// Do we need to confirm ?
-		if (confirm_box(true))
+		if (display_confirmation('DELETE_MESSAGE', $s_hidden_fields))
 		{
 			delete_pm($_CLASS['core_user']-&gt;data['user_id'], $msg_id, $folder_id);
 						
 			// TODO - jump to next message in &quot;history&quot;?
-			$meta_info = generate_link('Control_Panel&amp;i=pm&amp;folder='.$folder_id);
+			$meta_info = generate_link('control_panel&amp;i=pm&amp;folder='.$folder_id);
 			$message = $_CLASS['core_user']-&gt;lang['MESSAGE_DELETED'];
 
-			meta_refresh(3, $meta_info);
+			$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);
 			$message .= '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_FOLDER'], '&lt;a href=&quot;' . $meta_info . '&quot;&gt;', '&lt;/a&gt;');
 			trigger_error($message);
 		}
-		else
-		{
-			confirm_box(false, 'DELETE_MESSAGE', $s_hidden_fields);
-		}
 	}
 
 	// Handle User/Group adding/removing
@@ -308,7 +333,7 @@
 		
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
-	
+
 	if (!in_array($action, array('quote', 'edit', 'delete', 'forward')))
 	{
 		$enable_sig		= ($config['allow_sig'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_sig') &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('attachsig'));
@@ -320,11 +345,12 @@
 	$enable_magic_url = $drafts = false;
 
 	// User own some drafts?
-	if ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $action != 'delete')
+	if ($_CLASS['forums_auth']-&gt;acl_get('u_savedrafts') &amp;&amp; $action !== 'delete')
 	{
 		$sql = 'SELECT draft_id
 			FROM ' . FORUMS_DRAFTS_TABLE . '
-			WHERE (forum_id = 0 AND topic_id = 0)
+			WHERE forum_id = 0
+				AND topic_id = 0
 				AND user_id = ' . $_CLASS['core_user']-&gt;data['user_id'] . 
 				(($draft_id) ? &quot; AND draft_id &lt;&gt; $draft_id&quot; : '');
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
@@ -336,7 +362,7 @@
 		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
-	if ($action == 'edit' || $action == 'forward')
+	if ($action == 'edit')
 	{
 		$message_parser-&gt;bbcode_uid = $bbcode_uid;
 	}
@@ -359,29 +385,42 @@
 	if ($save &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('u_savedrafts'))
 	{
 		$subject = request_var('subject', '', true);
-		$subject = (!$subject &amp;&amp; $action != 'post') ? $_CLASS['core_user']-&gt;lang['NEW_MESSAGE'] : $subject;
+		$subject = (!$subject &amp;&amp; $action !== 'post') ? $_CLASS['core_user']-&gt;lang['NEW_MESSAGE'] : $subject;
 		$message = request_var('message', '', true);
 
 		if ($subject &amp;&amp; $message)
 		{
-			$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
-				'user_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
-				'topic_id'	=&gt; 0,
-				'forum_id'	=&gt; 0,
-				'save_time'	=&gt; $current_time,
-				'draft_subject' =&gt; $subject,
-				'draft_message' =&gt; $message));
-			$_CLASS['core_db']-&gt;query($sql);
+			$s_hidden_fields = array(
+				'mode'		=&gt; $mode,
+				'action'	=&gt; $action,
+				'save'		=&gt; true,
+				'subject'	=&gt; $subject,
+				'message'	=&gt; $message,
+				'u'			=&gt; $to_user_id,
+				'g'			=&gt; $to_group_id,
+				'p'			=&gt; $msg_id
+			);
+
+			if (display_confirmation('SAVE_DRAFT', $s_hidden_fields))
+			{
+				$sql = 'INSERT INTO ' . FORUMS_DRAFTS_TABLE . ' ' . $_CLASS['core_db']-&gt;sql_build_array('INSERT', array(
+					'user_id'	=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+					'topic_id'	=&gt; 0,
+					'forum_id'	=&gt; 0,
+					'save_time'	=&gt; $_CLASS['core_user']-&gt;time,
+					'draft_subject' =&gt; $subject,
+					'draft_message' =&gt; $message
+				));
+				$_CLASS['core_db']-&gt;query($sql);
+		
+				$_CLASS['core_display']-&gt;meta_refresh(3, generate_link('control_panel&amp;i=pm&amp;mode='.$mode));
+				$message = $_CLASS['core_user']-&gt;lang['DRAFT_SAVED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link('control_panel&amp;i=pm&amp;mode='.$mode).'&quot;&gt;', '&lt;/a&gt;');
 	
-			$_CLASS['core_display']-&gt;meta_refresh(3, generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode));
-
-			$message = $_CLASS['core_user']-&gt;lang['DRAFT_SAVED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['RETURN_UCP'], '&lt;a href=&quot;'.generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode).'&quot;&gt;', '&lt;/a&gt;');
-
-			trigger_error($message);
+				trigger_error($message);
+			}
 		}
 
-		unset($subject);
-		unset($message);
+		unset($subject, $message);
 	}
 
 	// Load Draft
@@ -394,12 +433,14 @@
 				AND forum_id = 0
 				AND user_id = &quot; . $_CLASS['core_user']-&gt;data['user_id'];
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-	
-		if ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+		$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
+
+		if ($row)
 		{
-			$_REQUEST['subject'] = $row['draft_subject'];
-			$_REQUEST['message'] = $row['draft_message'];
-			$refresh = true;
+			$message_parser-&gt;message = $row['draft_message'];
+			$message_subject = $row['draft_subject'];
+
 			$_CLASS['core_template']-&gt;assign('S_DRAFT_LOADED', true);
 		}
 		else
@@ -430,7 +471,7 @@
 
 		if ($submit)
 		{
-			$status_switch  = (($enable_html+1) &lt;&lt; 16) + (($enable_bbcode+1) &lt;&lt; 8) + (($enable_smilies+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($enable_sig+1) &lt;&lt; 1);
+			$status_switch	= (($enable_bbcode+1) &lt;&lt; 8) + (($enable_smilies+1) &lt;&lt; 4) + (($enable_urls+1) &lt;&lt; 2) + (($enable_sig+1) &lt;&lt; 1);
 			$status_switch = ($status_switch != $check_value);
 		}
 		else
@@ -440,22 +481,10 @@
 
 		// Parse Attachments - before checksum is calculated
 		$message_parser-&gt;parse_attachments('fileupload', $action, 0, $submit, $preview, $refresh, true);
-		
-		// Grab md5 'checksum' of new message
-		$message_md5 = md5($message_parser-&gt;message);
 
-		// Check checksum ... don't re-parse message if the same
-		$update_message = ($action != 'edit' || $message_md5 != $post_checksum || $status_switch || $preview) ? true : false;
+		// Parse message
+		$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
 
-		if ($update_message)
-		{
-			$message_parser-&gt;parse($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, $img_status, $flash_status, true);
-		}
-		else
-		{
-			$message_parser-&gt;bbcode_bitfield = $bbcode_bitfield;
-		}
-
 		if ($action != 'edit' &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; $config['flood_interval'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_get('u_ignoreflood'))
 		{
 			// Flood check
@@ -463,7 +492,7 @@
 
 			if ($last_post_time)
 			{
-				if ($last_post_time &amp;&amp; ($current_time - $last_post_time) &lt; intval($config['flood_interval']))
+				if ($last_post_time &amp;&amp; ($_CLASS['core_user']-&gt;time - $last_post_time) &lt; intval($config['flood_interval']))
 				{
 					$error[] = $_CLASS['core_user']-&gt;lang['FLOOD_ERROR'];
 				}
@@ -491,6 +520,9 @@
 		{
 			$pm_data = array(
 				'msg_id'				=&gt; (int) $msg_id,
+				'from_user_id'			=&gt; $_CLASS['core_user']-&gt;data['user_id'],
+				'from_user_ip'			=&gt; $_CLASS['core_user']-&gt;data['user_ip'],
+				'from_username'			=&gt; $_CLASS['core_user']-&gt;data['username'],
 				'reply_from_root_level'	=&gt; (isset($root_level)) ? (int) $root_level : 0,
 				'reply_from_msg_id'		=&gt; (int) $msg_id,
 				'icon_id'				=&gt; (int) $icon_id,
@@ -499,8 +531,7 @@
 				'enable_html' 			=&gt; (bool) $enable_html,
 				'enable_smilies'		=&gt; (bool) $enable_smilies,
 				'enable_urls'			=&gt; (bool) $enable_urls,
-				'message_md5'			=&gt; (int) $message_md5,
-				'bbcode_bitfield'		=&gt; (int) $message_parser-&gt;bbcode_bitfield,
+				'bbcode_bitfield'		=&gt; $message_parser-&gt;bbcode_bitfield,
 				'bbcode_uid'			=&gt; $message_parser-&gt;bbcode_uid,
 				'message'				=&gt; $message_parser-&gt;message,
 				'attachment_data'		=&gt; $message_parser-&gt;attachment_data,
@@ -508,24 +539,24 @@
 				'address_list'			=&gt; $address_list
 			);
 			unset($message_parser);
-			
+
 			// ((!$message_subject) ? $subject : $message_subject)
-			$msg_id = submit_pm($action, $subject, $pm_data, $update_message);
+			$msg_id = submit_pm($action, $subject, $pm_data, true);
 
-			$return_message_url = generate_link('Control_Panel&amp;i=pm&amp;mode=view_messages&amp;action=view_message&amp;p=' . $msg_id);
-			$return_folder_url = generate_link('Control_Panel&amp;i=pm&amp;folder=outbox');
+			$return_message_url = generate_link('control_panel&amp;i=pm&amp;mode=view&amp;p=' . $msg_id);
+			$return_folder_url = generate_link('control_panel&amp;i=pm&amp;folder=outbox');
 			$_CLASS['core_display']-&gt;meta_refresh(3, $return_message_url);
 
 			$message = $_CLASS['core_user']-&gt;lang['MESSAGE_STORED'] . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['VIEW_MESSAGE'], '&lt;a href=&quot;' . $return_message_url . '&quot;&gt;', '&lt;/a&gt;') . '&lt;br /&gt;&lt;br /&gt;' . sprintf($_CLASS['core_user']-&gt;lang['CLICK_RETURN_FOLDER'], '&lt;a href=&quot;' . $return_folder_url . '&quot;&gt;', '&lt;/a&gt;', $_CLASS['core_user']-&gt;lang['PM_OUTBOX']);
 			trigger_error($message);
 		}
 
-		$message_subject = stripslashes($subject);
+		$message_subject = $subject;
 	}
 
 	if (empty($error) &amp;&amp; $preview)
 	{
-		$post_time = ($action == 'edit') ? $post_time : $current_time;
+		$post_time = ($action === 'edit') ? $post_time : $_CLASS['core_user']-&gt;time;
 
 		$preview_message = $message_parser-&gt;format_display($enable_html, $enable_bbcode, $enable_urls, $enable_smilies, false);
 
@@ -552,7 +583,7 @@
 		// Attachment Preview
 		if (!empty($message_parser-&gt;attachment_data))
 		{
-			require_once(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+			require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 			$null = array();
 					
 			$attachment_data = $message_parser-&gt;attachment_data;
@@ -586,27 +617,36 @@
 			'S_DISPLAY_PREVIEW'		=&gt; true
 		));
 
-		unset($preview_message, $preview_subject, $preview_signature, $preview_signature);
+		unset($message_text, $preview_message, $preview_subject, $preview_signature, $preview_signature);
 	}
 
 	// Decode text for message display
-	$bbcode_uid = (($action == 'quote' || $action == 'forward') &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; empty($error)) ? $bbcode_uid : $message_parser-&gt;bbcode_uid;
+	$bbcode_uid = (($action === 'quote' || $action === 'forward') &amp;&amp; !$preview &amp;&amp; !$refresh &amp;&amp; empty($error)) ? $bbcode_uid : $message_parser-&gt;bbcode_uid;
 
 	$message_parser-&gt;decode_message($bbcode_uid);
 
-	if ($action == 'quote' &amp;&amp; !$preview &amp;&amp; !$refresh)
+	if (($action === 'quote' || $action === 'quotepost') &amp;&amp; !$preview &amp;&amp; !$refresh)
 	{
-		$message_parser-&gt;message = '[quote=&quot;' . $quote_username . '&quot;]' . censor_text(trim($message_parser-&gt;message)) . &quot;[/quote]\n&quot;;
+		if ($action === 'quotepost')
+		{
+			$post_id = request_var('p', 0);
+			$message_link = &quot;[url=&quot; . generate_link(&quot;forums&amp;file=viewtopic&amp;p={$post_id}#p{$post_id}&quot;).&quot;]{$message_subject}[/url]\n&quot;;
+		}
+		else 
+		{
+			$message_link = '';
+		}
+		$message_parser-&gt;message = $message_link . '[quote=&quot;' . $quote_username . '&quot;]' . censor_text(trim($message_parser-&gt;message)) . &quot;[/quote]\n&quot;;
 	}
 	
-	if (($action == 'reply' || $action == 'quote') &amp;&amp; !$preview &amp;&amp; !$refresh)
+	if (($action === 'reply' || $action === 'quote' || $action === 'quotepost') &amp;&amp; !$preview &amp;&amp; !$refresh)
 	{
 		$message_subject = ((!preg_match('/^Re:/', $message_subject)) ? 'Re: ' : '') . censor_text($message_subject);
 	}
 
-	if ($action == 'forward' &amp;&amp; !$preview &amp;&amp; !$refresh)
+	if ($action === 'forward' &amp;&amp; !$preview &amp;&amp; !$refresh)
 	{
-		$fwd_to_field = write_pm_addresses(array('to' =&gt; $to_address), 0, true);
+		$fwd_to_field = write_pm_addresses(array('to' =&gt; $post['to_address']), 0, true);
 
 		$forward_text = array();
 		$forward_text[] = $_CLASS['core_user']-&gt;lang['FWD_ORIGINAL_MESSAGE'];
@@ -615,7 +655,7 @@
 		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_FROM'], $quote_username);
 		$forward_text[] = sprintf($_CLASS['core_user']-&gt;lang['FWD_TO'], implode(', ', $fwd_to_field['to']));
 
-		$message_parser-&gt;message = implode(&quot;\n&quot;, $forward_text) . &quot;\n\n[quote=\&quot;[url=&quot; . generate_link(&quot;Members_List&amp;mode=viewprofile&amp;u={$author_id}]{$quote_username}&quot;).&quot;[/url]\&quot;]\n&quot; . censor_text(trim($message_parser-&gt;message)) . &quot;\n[/quote]&quot;;
+		$message_parser-&gt;message = implode(&quot;\n&quot;, $forward_text) . &quot;\n\n[quote=\&quot;[url=&quot; . generate_link(&quot;members_list&amp;mode=viewprofile&amp;u={$post['author_id']}&quot;).&quot;{$quote_username}[/url]\&quot;]\n&quot; . censor_text(trim($message_parser-&gt;message)) . &quot;\n[/quote]&quot;;
 		$message_subject = ((!preg_match('/^Fwd:/', $message_subject)) ? 'Fwd: ' : '') . censor_text($message_subject);
 	}
 
@@ -646,25 +686,27 @@
 	{
 		// Get Usernames and Group Names
 		$result = array();
-		if (isset($address_list['u']) &amp;&amp; !empty($address_list['u']))
+
+		if (!empty($address_list['u']))
 		{
 			$result['u'] = $_CLASS['core_db']-&gt;query('SELECT user_id as id, username as name, user_colour as colour 
 				FROM ' . CORE_USERS_TABLE . ' 
 				WHERE user_id IN (' . implode(', ', array_map('intval', array_keys($address_list['u']))) . ')');
 		}
 		
-		if (isset($address_list['g']) &amp;&amp; !empty($address_list['g']))
+		if (!empty($address_list['g']))
 		{
 			$result['g'] = $_CLASS['core_db']-&gt;query('SELECT group_id as id, group_name as name, group_colour as colour 
-				FROM ' . GROUPS_TABLE . ' 
+				FROM ' . CORE_GROUPS_TABLE . ' 
 				WHERE group_receive_pm = 1 AND group_id IN (' . implode(', ', array_map('intval', array_keys($address_list['g']))) . ')');
 		}
 
 		$u = $g = array();
 
-		foreach (array('u', 'g') as $type)
+		$_types = array('u', 'g');
+		foreach ($_types as $type)
 		{
-			if (isset($result[$type]))
+			if (isset($result[$type]) &amp;&amp; $result[$type])
 			{
 				while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result[$type]))
 				{
@@ -692,13 +734,13 @@
 				
 				$_CLASS['core_template']-&gt;assign_vars_array($field . '_recipient', array(
 					'NAME'		=&gt; ${$type}[$id]['name'],
-					'IS_GROUP'	=&gt; ($type == 'g'),
-					'IS_USER'	=&gt; ($type == 'u'),
+					'IS_GROUP'	=&gt; ($type === 'g'),
+					'IS_USER'	=&gt; ($type === 'u'),
 					'COLOUR'	=&gt; (${$type}[$id]['colour']) ? ${$type}[$id]['colour'] : '',
 					'UG_ID'		=&gt; $id,
-					'U_VIEW'	=&gt; ($type == 'u') ? generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $id) : generate_link('Members_List&amp;mode=group&amp;g=' . $id),
-					'TYPE'		=&gt; $type)
-				);
+					'U_VIEW'	=&gt; ($type == 'u') ? generate_link('members_list&amp;mode=viewprofile&amp;u=' . $id) : generate_link('members_list&amp;mode=group&amp;g=' . $id),
+					'TYPE'		=&gt; $type
+				));
 			}
 		}
 	}
@@ -729,6 +771,10 @@
 			$page_title = $_CLASS['core_user']-&gt;lang['POST_QUOTE_PM'];
 		break;
 
+		case 'quotepost':
+			$page_title = $_CLASS['core_user']-&gt;lang['POST_PM_POST'];
+		break;
+
 		case 'reply':
 			$page_title = $_CLASS['core_user']-&gt;lang['POST_REPLY_PM'];
 		break;
@@ -746,7 +792,7 @@
 		break;
 	}
 
-	$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;lastclick&quot; value=&quot;' . $current_time . '&quot; /&gt;';
+	$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;lastclick&quot; value=&quot;' . $_CLASS['core_user']-&gt;time . '&quot; /&gt;';
 	$s_hidden_fields .= (isset($check_value)) ? '&lt;input type=&quot;hidden&quot; name=&quot;status_switch&quot; value=&quot;' . $check_value . '&quot; /&gt;' : '';
 	$s_hidden_fields .= ($draft_id || isset($_REQUEST['draft_loaded'])) ? '&lt;input type=&quot;hidden&quot; name=&quot;draft_loaded&quot; value=&quot;' . ((isset($_REQUEST['draft_loaded'])) ? intval($_REQUEST['draft_loaded']) : $draft_id) . '&quot; /&gt;' : '';
 
@@ -831,7 +877,7 @@
 		}
 		
 		// Build usernames to add
-		$usernames = (isset($_REQUEST['username'])) ? array(request_var('username', '')) : array();
+		$usernames = isset($_REQUEST['username']) ? array(request_var('username', '')) : array();
 		$username_list = request_var('username_list', '');
 		if ($username_list)
 		{
@@ -841,7 +887,7 @@
 		// Reveal the correct user_ids
 		if (!empty($usernames))
 		{
-			require_once(SITE_FILE_ROOT.'includes/functions_user.php');
+			require_once SITE_FILE_ROOT.'includes/functions_user.php';
 
 			$user_id_ary = user_get_id($usernames, $difference);
 
@@ -864,7 +910,6 @@
 			$address_list['u'][$user_id] = $type;
 		}
 	}
-
 }
 
 // Return number of recipients

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_options.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_options.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_options.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -15,7 +15,7 @@
 {
 	global $_CLASS, $config;
 
-	$redirect_url = generate_link('Control_Panel&amp;i=pm&amp;mode=options');
+	$redirect_url = generate_link('control_panel&amp;i=pm&amp;mode=options');
 	
 	$_CLASS['core_template']-&gt;assign_array(array(
 		'ERROR_MESSAGE'				=&gt; false,
@@ -254,7 +254,7 @@
 				$_CLASS['core_user']-&gt;data['user_full_folder'] = PRIVMSGS_INBOX;
 			}
 
-			$meta_info = generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode);
+			$meta_info = generate_link('control_panel&amp;i=pm&amp;mode='.$mode);
 			$message = $_CLASS['core_user']-&gt;lang['FOLDER_REMOVED'];
 
 			$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);
@@ -326,7 +326,7 @@
 
 		if (!$delete_id)
 		{
-			redirect(generate_link('Control_Panel&amp;i=pm&amp;mode='.$mode));
+			redirect(generate_link('control_panel&amp;i=pm&amp;mode='.$mode));
 		}
 
 		$s_hidden_fields = '&lt;input type=&quot;hidden&quot; name=&quot;delete_rule[' . $delete_id . ']&quot; value=&quot;1&quot; /&gt;';
@@ -339,7 +339,7 @@
 					AND rule_id = $delete_id&quot;;
 			$_CLASS['core_db']-&gt;query($sql);
 
-			$meta_info = generate_link(&quot;Control_Panel$SID&amp;i=pm&amp;mode=$mode&quot;);
+			$meta_info = generate_link(&quot;control_panel$SID&amp;i=pm&amp;mode=$mode&quot;);
 			$message = $_CLASS['core_user']-&gt;lang['RULE_DELETED'];
 
 			$_CLASS['core_display']-&gt;meta_refresh(3, $meta_info);

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewfolder.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -11,7 +11,6 @@
 // 
 // -------------------------------------------------------------
 
-// * Called from ucp_pm with mode == 'view_messages' &amp;&amp; action == 'view_folder'
 $_CLASS['core_template']-&gt;assign_array(array(
 	'S_SHOW_RECIPIENTS'	=&gt; false,
 	'messagerow'		=&gt; false,
@@ -24,15 +23,18 @@
 	
 	$limit = 10;
 	$icons = obtain_icons();
+	$submit_export = (isset($_POST['submit_export'])) ? true : false;
 
-	$color_rows = array('marked', 'replied', 'message_reported', 'friend', 'foe');
+	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']-&gt;data['user_id'], $parent_class-&gt;link_parent, $type);
+
+	$color_rows = array('marked', 'replied', 'friend', 'foe');//, 'message_reported'
 	
 	foreach ($color_rows as $var)
 	{
 		$_CLASS['core_template']-&gt;assign_vars_array('pm_colour_info', array(
 			'IMG'	=&gt; $_CLASS['core_user']-&gt;img(&quot;pm_{$var}&quot;, ''),
 			'CLASS' =&gt; &quot;pm_{$var}_colour&quot;,
-			'LANG'	=&gt; $_CLASS['core_user']-&gt;lang[strtoupper($var) . '_MESSAGE'])
+			'LANG'	=&gt; $_CLASS['core_user']-&gt;get_lang(strtoupper($var) . '_MESSAGE'))
 		);
 	}
 
@@ -44,6 +46,20 @@
 		$s_mark_options .= '&lt;option value=&quot;' . $mark_option . '&quot;&gt;' . $_CLASS['core_user']-&gt;get_lang(strtoupper($mark_option)) . '&lt;/option&gt;';
 	}
 
+	// We do the folder moving options here too, for template authors to use...
+	$s_folder_move_options = '';
+	foreach ($folder as $f_id =&gt; $folder_ary)
+	{
+		if ($f_id == PRIVMSGS_OUTBOX || $f_id == PRIVMSGS_SENTBOX || $f_id == $folder_id)
+		{
+			continue;
+		}
+	
+		$s_folder_move_options .= '&lt;option' . (($f_id != PRIVMSGS_INBOX) ? ' class=&quot;blue&quot;' : '') . ' value=&quot;' . $f_id . '&quot;&gt;';
+		$s_folder_move_options .= sprintf($_CLASS['core_user']-&gt;get_lang('MOVE_MARKED_TO_FOLDER'), $folder_ary['folder_name']);
+		$s_folder_move_options .= (($folder_ary['unread_messages']) ? ' [' . $folder_ary['unread_messages'] . '] ' : '') . '&lt;/option&gt;';
+	}
+
 	$friend = $foe = array();
 
 	// Get friends and foes
@@ -60,12 +76,10 @@
 	$_CLASS['core_db']-&gt;free_result($result);
 
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'S_UNREAD'		=&gt; ($type == 'unread'),
+		'S_UNREAD'		=&gt; ($type === 'unread'),
 		'S_MARK_OPTIONS'=&gt; $s_mark_options)
 	);
 
-	$folder_info = get_pm_from($folder_id, $folder, $_CLASS['core_user']-&gt;data['user_id'], $parent_class-&gt;link_parent, $type);
-
 	// Okay, lets dump out the page ...
 	if (!empty($folder_info['pm_list']))
 	{
@@ -77,7 +91,9 @@
 			foreach ($folder_info['rowset'] as $message_id =&gt; $row)
 			{
 				$address[$message_id] = rebuild_header(array('to' =&gt; $row['to_address'], 'bcc' =&gt; $row['bcc_address']));
-				foreach (array('u', 'g') as $save)
+
+				$_save = array('u', 'g');
+				foreach ($_save as $save)
 				{
 					if (isset($address[$message_id][$save]) &amp;&amp; sizeof($address[$message_id][$save]))
 					{
@@ -89,12 +105,13 @@
 				}
 			}
 		
-			foreach (array('u', 'g') as $ug_type)
+			$_types = array('u', 'g');
+			foreach ($_types as $ug_type)
 			{
-				if (isset($recipient_list[$ug_type]) &amp;&amp; sizeof($recipient_list[$ug_type]))
+				if (!empty($recipient_list[$ug_type]))
 				{
 					$sql = ($ug_type === 'u') ? 'SELECT user_id as id, username as name, user_colour as colour FROM ' . CORE_USERS_TABLE . ' WHERE user_id' : 'SELECT group_id as id, group_name as name, group_colour as colour FROM ' . CORE_GROUPS_TABLE . ' WHERE group_id';
-					$sql .= ' IN (' . implode(', ', array_keys($recipient_list[$ug_type])) . ')';
+					$sql .= ' IN (' . implode(', ', array_map('intval', array_keys($recipient_list[$ug_type]))) . ')';
 	
 					$result = $_CLASS['core_db']-&gt;query($sql);
 
@@ -112,11 +129,10 @@
 				{
 					foreach ($id_ary as $ug_id =&gt; $_id)
 					{
-						$address_list[$message_id][] = (($type == 'u') ? '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u='.$ug_id).'&quot;&gt;' : '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=group&amp;g='.$ug_id).'&quot;&gt;') . (($recipient_list[$type][$ug_id]['colour']) ? '&lt;span style=&quot;color:#' . $recipient_list[$type][$ug_id]['colour'] . '&quot;&gt;' : '&lt;span&gt;') . $recipient_list[$type][$ug_id]['name'] . '&lt;/span&gt;&lt;/a&gt;';
+						$address_list[$message_id][] = (($type === 'u') ? '&lt;a href=&quot;'.generate_link('members_list&amp;mode=viewprofile&amp;u='.$ug_id).'&quot;&gt;' : '&lt;a href=&quot;'.generate_link('members_list&amp;mode=group&amp;g='.$ug_id).'&quot;&gt;') . (($recipient_list[$type][$ug_id]['colour']) ? '&lt;span style=&quot;color:#' . $recipient_list[$type][$ug_id]['colour'] . '&quot;&gt;' : '&lt;span&gt;') . $recipient_list[$type][$ug_id]['name'] . '&lt;/span&gt;&lt;/a&gt;';
 					}
 				}
 			}
-			
 			unset($recipient_list, $address);
 		}
 
@@ -124,19 +140,19 @@
 		{
 			$row =&amp; $folder_info['rowset'][$message_id];
 
-			$folder_img = ($row['unread']) ? 'folder_new' : 'folder';
-			$folder_alt = ($row['unread']) ? 'NEW_MESSAGES' : 'NO_NEW_MESSAGES';
+			$folder_img = ($row['pm_unread']) ? 'folder_new' : 'folder';
+			$folder_alt = ($row['pm_unread']) ? 'NEW_MESSAGES' : 'NO_NEW_MESSAGES';
 
 			// Generate all URIs ...
-			$message_author = '&lt;a href=&quot;'.generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
+			$message_author = '&lt;a href=&quot;'.generate_link('members_list&amp;mode=viewprofile&amp;u=' . $row['author_id']) . '&quot;&gt;' . $row['username'] . '&lt;/a&gt;';
 			$view_message_url = generate_link($parent_class-&gt;link_parent.&quot;&amp;f=$folder_id&amp;p=$message_id&quot;);
 			$remove_message_url = generate_link($parent_class-&gt;link_parent.'&amp;mode=compose&amp;action=delete&amp;p='.$message_id);
 			
 			$row_indicator = '';
 			foreach ($color_rows as $var)
 			{
-				if (($var != 'friend' &amp;&amp; $var != 'foe' &amp;&amp; $row[$var]) || 
-					(($var == 'friend' || $var == 'foe') &amp;&amp; isset(${$var}[$row['author_id']])))
+				if (($var !== 'friend' &amp;&amp; $var !== 'foe' &amp;&amp; $row['pm_' . $var]) || 
+					(($var == 'friend' || $var == 'foe') &amp;&amp; isset(${$var}[$row['author_id']]) &amp;&amp; ${$var}[$row['author_id']]))
 				{
 					$row_indicator = $var;
 					break;
@@ -160,23 +176,22 @@
 				'ATTACH_ICON_IMG'	=&gt; ($row['message_attachment']) ? $_CLASS['core_user']-&gt;img('icon_attach', $_CLASS['core_user']-&gt;lang['TOTAL_ATTACHMENTS']) : '',
 				//'S_PM_REPORTED'		=&gt; (!empty($row['message_reported'])) ? true : false,
 				'S_PM_REPORTED'		=&gt; '',
-				'S_PM_DELETED'		=&gt; ($row['deleted']) ? true : false,
+				'S_PM_DELETED'		=&gt; ($row['pm_deleted']),
 				
-				'U_VIEW_PM'			=&gt; ($row['deleted']) ? '' : $view_message_url,
-				'U_REMOVE_PM'		=&gt; ($row['deleted']) ? $remove_message_url : '',
+				'U_VIEW_PM'			=&gt; ($row['pm_deleted']) ? '' : $view_message_url,
+				'U_REMOVE_PM'		=&gt; ($row['pm_deleted']) ? $remove_message_url : '',
 				
 				'RECIPIENTS'		=&gt; ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? implode(', ', $address_list[$message_id]) : '',
 				'U_MCP_REPORT'		=&gt; generate_link('forums&amp;file=mcp&amp;mode=reports&amp;pm='.$message_id))
 //				'U_MCP_QUEUE'		=&gt; &quot;mcp.$phpEx?sid={$_CLASS['core_user']-&gt;session_id}&amp;mode=mod_queue&amp;t=$topic_id&quot;)
 			);
 		}
-		
 		unset($folder_info['rowset']);
 		
 		$_CLASS['core_template']-&gt;assign_array(array(
-			'S_SHOW_RECIPIENTS'	=&gt; ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? true : false,
-			'S_SHOW_COLOUR_LEGEND'	=&gt; true)
-		);
+			'S_SHOW_RECIPIENTS'		=&gt; ($folder_id == PRIVMSGS_OUTBOX || $folder_id == PRIVMSGS_SENTBOX) ? true : false,
+			'S_SHOW_COLOUR_LEGEND'	=&gt; true
+		));
 	}
 }
 
@@ -189,10 +204,6 @@
 	$limit = 10;
 	$start = get_variable('start', 'REQUEST', 0, 'int');
 
-	//$sort_days = request_var('st', ((!empty($_CLASS['core_user']-&gt;data['user_post_show_days'])) ? $_CLASS['core_user']-&gt;data['user_post_show_days'] : 0));
-	//$sort_key	= request_var('sk', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_type'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_type'] : 't'));
-	//$sort_dir	= request_var('sd', ((!empty($_CLASS['core_user']-&gt;data['user_post_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_post_sortby_dir'] : 'd'));
-
 	$sort_days	= get_variable('st', 'REQUEST', 0, 'int');
 	$sort_key	= get_variable('sk', 'REQUEST', 't');
 	$sort_dir	= get_variable('sd', 'REQUEST', 'd');
@@ -209,7 +220,7 @@
 
 	if ($type !== 'folder')
 	{
-		$folder_sql = ($type === 'unread') ? 't.unread = 1' : 't.msg_new = 1';
+		$folder_sql = ($type === 'unread') ? 't.pm_unread = 1' : 't.pm_new = 1';
 		$folder_id = PRIVMSGS_INBOX;
 	}
 	else
@@ -222,6 +233,11 @@
 	{
 		$min_post_time = $_CLASS['core_user']-&gt;time - ($sort_days * 86400);
 
+		if (isset($_POST['sort']))
+		{
+			$start = 0;
+		}
+
 		$sql = 'SELECT COUNT(t.msg_id) AS pm_count
 			FROM ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . FORUMS_PRIVMSGS_TABLE . &quot; p
 			WHERE $folder_sql
@@ -229,12 +245,6 @@
 				AND t.msg_id = p.msg_id
 				AND p.message_time &gt;= $min_post_time&quot;;
 		$result = $_CLASS['core_db']-&gt;query_limit($sql, 1);
-
-		if (isset($_POST['sort']))
-		{
-			$start = 0;
-		}
-
 		$pm_count = ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)) ? $row['pm_count'] : 0;
 		$_CLASS['core_db']-&gt;free_result($result);
 
@@ -271,17 +281,20 @@
 		$sql_limit_time = '';
 	}
 
+	$pagination	= generate_pagination(&quot;$url&amp;mode=view&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param&quot;, $pm_count, $limit, $start);
+
 	$_CLASS['core_template']-&gt;assign_array(array(
-		'PAGINATION'		=&gt; generate_pagination(&quot;$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&amp;$u_sort_param&quot;, $pm_count, $limit, $start),
+		'PAGINATION'		=&gt; $pagination['formated'],
+		'PAGINATION_ARRAY'	=&gt; $pagination['array'],
+
 		'PAGE_NUMBER'		=&gt; on_page($pm_count, $limit, $start),
 		'TOTAL_MESSAGES'	=&gt; (($pm_count == 1) ? $_CLASS['core_user']-&gt;lang['VIEW_PM_MESSAGE'] : sprintf($_CLASS['core_user']-&gt;lang['VIEW_PM_MESSAGES'], $pm_count)),
 
-		//'POST_IMG'			=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;img('btn_locked', 'PM_LOCKED') : $_CLASS['core_user']-&gt;img('btn_post_pm', 'POST_PM'),
+		//'POST_IMG'		=&gt; (!$auth-&gt;acl_get('u_sendpm')) ? $user-&gt;img('button_topic_locked', 'PM_LOCKED') : $user-&gt;img('button_pm_new', 'POST_PM'),
 		'POST_IMG'			=&gt; $_CLASS['core_user']-&gt;img('btn_post_pm', 'POST_PM'),
-
 		'REPORTED_IMG'		=&gt; $_CLASS['core_user']-&gt;img('icon_reported', 'MESSAGE_REPORTED'),
 
-		//'L_NO_MESSAGES'		=&gt; (!$_CLASS['auth']-&gt;acl_get('u_sendpm')) ? $_CLASS['core_user']-&gt;lang['POST_PM_LOCKED'] : $_CLASS['core_user']-&gt;lang['NO_MESSAGES'],
+		//'L_NO_MESSAGES'	=&gt; (!$auth-&gt;acl_get('u_sendpm')) ? $user-&gt;lang['POST_PM_LOCKED'] : $user-&gt;lang['NO_MESSAGES'],
 		'L_NO_MESSAGES'		=&gt; $_CLASS['core_user']-&gt;lang['NO_MESSAGES'],
 
 		'S_SELECT_SORT_DIR'		=&gt; $s_sort_dir,
@@ -291,8 +304,7 @@
 
 		//'U_POST_NEW_TOPIC'	=&gt; ($_CLASS['auth']-&gt;acl_get('u_sendpm')) ? generate_link($url.'&amp;mode=compose&amp;action=post') : '', 
 		'U_POST_NEW_TOPIC'	=&gt; generate_link($url.'&amp;mode=compose&amp;action=post'), 
-
-		'S_PM_ACTION'		=&gt; generate_link(&quot;$url&amp;mode=view_messages&amp;action=view_folder&amp;f=$folder_id&quot;))
+		'S_PM_ACTION'		=&gt; generate_link(&quot;$url&amp;mode=view&amp;action=view_folder&amp;f=$folder_id&quot;))
 	);
 
 	// Grab all pm data
@@ -333,7 +345,7 @@
 
 	$result = $_CLASS['core_db']-&gt;query_limit($sql, $sql_limit, $sql_start);
 
-	while($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
+	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result))
 	{
 		$rowset[$row['msg_id']] = $row;
 		$pm_list[] = $row['msg_id'];

Modified: cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php
===================================================================
--- cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/control_panel/modules/ucp_pm_viewmessage.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -20,20 +20,29 @@
 	global $_CLASS, $_CORE_CONFIG, $config;
 
 	$_CLASS['core_user']-&gt;add_lang('viewtopic');
+
 	$msg_id		= (int) $msg_id;
 	$folder_id	= (int) $folder_id;
 	$author_id	= (int) $message_row['author_id'];
 	
 	// Not able to view message, it was deleted by the sender
-	if ($message_row['deleted'])
+	if ($message_row['pm_deleted'])
 	{
 		trigger_error('NO_AUTH_READ_REMOVED_MESSAGE');
 	}
 	
+	// Do not allow hold messages to be seen
+	if ($folder_id == PRIVMSGS_HOLD_BOX)
+	{
+		trigger_error('NO_AUTH_READ_HOLD_MESSAGE');
+	}
+
 	// Grab icons
 	$icons = array();
 	obtain_icons($icons);
 
+	$bbcode = false;
+
 	// Instantiate BBCode if need be
 	if ($message_row['bbcode_bitfield'])
 	{
@@ -47,27 +56,26 @@
 	$user_info = get_user_informations($author_id, $message_row);
 
 	// Parse the message and subject
-	$message = $message_row['message_text'];
 
+	// Replace naughty words such as farty pants
+	$message_row['message_subject'] = censor_text($message_row['message_subject']);
+	$message_row['message_text'] = censor_text($message_row['message_text']);
+
 	// If the board has HTML off but the message has HTML on then we process it, else leave it alone
 	if ($message_row['enable_html'] &amp;&amp; !$config['auth_html_pm'])
 	{
 		$message = preg_replace('#(&lt;!\-\- h \-\-&gt;&lt;)([\/]?.*?)(&gt;&lt;!\-\- h \-\-&gt;)#is', &quot;&lt;\\2&gt;&quot;, $message);
 	}
+
+	// Second parse bbcode here
+	if ($message_row['bbcode_bitfield'])
+	{
+		$bbcode-&gt;bbcode_second_pass($message_row['message_text'], $message_row['bbcode_uid'], $message_row['bbcode_bitfield']);
+	}
+
+	// Always process smilies after parsing bbcodes
+	$message_row['message_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', smiley_text($message_row['message_text']));
 
-	// Second parse bbcode here
-	if ($message_row['bbcode_bitfield'])
-	{
-		$bbcode-&gt;bbcode_second_pass($message, $message_row['bbcode_uid'], $message_row['bbcode_bitfield']);
-	}
-
-	// Always process smilies after parsing bbcodes
-	$message = smiley_text($message);
-
-	// Replace naughty words such as farty pants
-	$message_row['message_subject'] = censor_text($message_row['message_subject']);
-	$message = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($message));
-
 	// Editing information
 	if ($message_row['message_edit_count'] &amp;&amp; $config['display_last_edited'])
 	{
@@ -119,7 +127,7 @@
 
 	if (!empty($attachments))
 	{
-		require_once(SITE_FILE_ROOT.'includes/forums/functions_display.php');
+		require_once SITE_FILE_ROOT.'includes/forums/functions_display.php';
 		$null = array();
 
 		$unset_attachments = parse_inline_attachments($message, $attachments, $update_count, 0);
@@ -131,6 +139,15 @@
 		}
 		unset($unset_attachments);
 			
+		// Update the attachment download counts
+		if (!empty($update_count))
+		{
+			$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
+				SET download_count = download_count + 1 
+				WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
+			$_CLASS['core_db']-&gt;query($sql);
+		}
+
 		if (!empty($attachments))
 		{
 			$_CLASS['core_template']-&gt;assign('S_HAS_ATTACHMENTS', true);
@@ -140,15 +157,7 @@
 		unset($attachment_data, $null);
 	}
 
-	if (!mb_strpos($_CLASS['core_user']-&gt;data['session_url'], '&amp;t='.$msg_id) &amp;&amp; !empty($update_count))
-	{
-		// Update the attachment download counts
-		$sql = 'UPDATE ' . FORUMS_ATTACHMENTS_TABLE . ' 
-			SET download_count = download_count + 1 
-			WHERE attach_id IN (' . implode(', ', array_unique($update_count)) . ')';
-		$_CLASS['core_db']-&gt;query($sql);
-	}
-
+	$user_info['sig'] = '';
 	$signature = ($message_row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewsigs')) ? $user_info['user_sig'] : '';
 	
 	// End signature parsing, only if needed
@@ -156,9 +165,9 @@
 	{
 		if ($user_info['user_sig_bbcode_bitfield'])
 		{
-			if (!isset($bbcode) || !$bbcode)
+			if ($bbcode === false)
 			{
-				require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
+				require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 				$bbcode = new bbcode($user_info['user_sig_bbcode_bitfield']);
 			}
 
@@ -175,12 +184,13 @@
 		'AUTHOR_NAME'		=&gt; ($user_info['user_colour']) ? '&lt;span style=&quot;color:#' . $user_info['user_colour'] . '&quot;&gt;' . $user_info['username'] . '&lt;/span&gt;' : $user_info['username'],
 		'AUTHOR_RANK' 		=&gt; $user_info['rank_title'],
 		'RANK_IMAGE' 		=&gt; $user_info['rank_image'],
-		'AUTHOR_AVATAR'		=&gt; (isset($user_info['avatar'])) ? $user_info['avatar'] : '',
+		'AUTHOR_AVATAR'		=&gt; isset($user_info['avatar']) ? $user_info['avatar'] : '',
 		'AUTHOR_JOINED'		=&gt; $_CLASS['core_user']-&gt;format_date($user_info['user_reg_date']),
 		'AUTHOR_POSTS' 		=&gt; (!empty($user_info['user_posts'])) ? $user_info['user_posts'] : '',
 		'AUTHOR_FROM' 		=&gt; (!empty($user_info['user_from'])) ? $user_info['user_from'] : '',
 
 		'ONLINE_IMG'		=&gt; (!$config['load_onlinetrack']) ? '' : ((isset($user_info['online']) &amp;&amp; $user_info['online']) ? $_CLASS['core_user']-&gt;img('btn_online', $_CLASS['core_user']-&gt;lang['ONLINE']) : $_CLASS['core_user']-&gt;img('btn_offline', $_CLASS['core_user']-&gt;lang['OFFLINE'])),
+		'S_ONLINE'			=&gt; (!$config['load_onlinetrack']) ? false : ((isset($user_info['online']) &amp;&amp; $user_info['online']) ? true : false),
 		'DELETE_IMG' 		=&gt; $_CLASS['core_user']-&gt;img('btn_delete', $_CLASS['core_user']-&gt;lang['DELETE_MESSAGE']),
 		'INFO_IMG' 			=&gt; $_CLASS['core_user']-&gt;img('btn_info', $_CLASS['core_user']-&gt;lang['VIEW_PM_INFO']),
 		'REPORT_IMG'		=&gt; $_CLASS['core_user']-&gt;img('btn_report', $_CLASS['core_user']-&gt;lang['REPORT_PM']),
@@ -194,15 +204,15 @@
 
 		'SENT_DATE' 		=&gt; $_CLASS['core_user']-&gt;format_date($message_row['message_time']),
 		'SUBJECT'			=&gt; $message_row['message_subject'],
-		'MESSAGE' 			=&gt; $message,
+		'MESSAGE' 			=&gt; $message_row['message_text'],
 		'SIGNATURE' 		=&gt; ($message_row['enable_sig']) ? $signature : '',
 		'EDITED_MESSAGE'	=&gt; $l_edited_by,
 
 		'U_MCP_REPORT'		=&gt; generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']),
 		'U_REPORT'			=&gt; (false) ? generate_link('Forums&amp;file=report&amp;pm=' . $message_row['msg_id']) : '',
-		'U_INFO'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_') &amp;&amp; ($message_row['message_reported'] || $message_row['forwarded'])) ? generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']) : '',
+		'U_INFO'			=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_') &amp;&amp; ($message_row['message_reported'] || $message_row['pm_forwarded'])) ? generate_link('Forums&amp;file=mcp&amp;mode=pm_details&amp;p=' . $message_row['msg_id']) : '',
 		'U_DELETE' 			=&gt; generate_link(&quot;$url&amp;mode=compose&amp;action=delete&amp;f=$folder_id&amp;p=&quot; . $message_row['msg_id']),
-		'U_AUTHOR_PROFILE' 	=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u=' . $author_id),
+		'U_AUTHOR_PROFILE' 	=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u=' . $author_id),
 		'U_EMAIL' 			=&gt; $user_info['email'],
 		'U_QUOTE'			=&gt; ($author_id != $_CLASS['core_user']-&gt;data['user_id']) ? generate_link(&quot;$url&amp;mode=compose&amp;action=quote&amp;f=$folder_id&amp;p=&quot; . $message_row['msg_id']) : '',
 		'U_EDIT' 			=&gt; (($message_row['message_time'] &gt; time() - $config['pm_edit_time'] || !$config['pm_edit_time']) &amp;&amp; $folder_id == PRIVMSGS_OUTBOX) ? generate_link(&quot;$url&amp;mode=compose&amp;action=edit&amp;f=$folder_id&amp;p=&quot; . $message_row['msg_id']) : '', 
@@ -218,7 +228,7 @@
 		'U_FORWARD_PM'		=&gt; generate_link(&quot;$url&amp;mode=compose&amp;action=forward&amp;f=$folder_id&amp;p=&quot; . $message_row['msg_id'])
 	));
 
-	if (!isset($_REQUEST['view']) || $_REQUEST['view'] != 'print')
+	if (!isset($_REQUEST['view']) || $_REQUEST['view'] !== 'print')
 	{
 		// Message History
 		if (message_history($msg_id, $_CLASS['core_user']-&gt;data['user_id'], $message_row, $folder))
@@ -238,7 +248,7 @@
 		FROM ' . FORUMS_PRIVMSGS_TABLE . ' p, ' . FORUMS_PRIVMSGS_TO_TABLE . ' t, ' . CORE_USERS_TABLE . ' u
 		WHERE t.msg_id = p.msg_id 
 			AND p.author_id = u.user_id
-			AND t.folder_id &lt;&gt; ' . PRIVMSGS_NO_BOX . &quot;
+			AND t.folder_id NOT IN (' . PRIVMSGS_NO_BOX . ', ' . PRIVMSGS_HOLD_BOX . &quot;)
 			AND t.user_id = $user_id&quot;;
 
 	if (!$message_row['root_level'])
@@ -252,12 +262,14 @@
 
 	$sql .= ' ORDER BY p.message_time ';
 	$sort_dir = (!empty($_CLASS['core_user']-&gt;data['user_sortby_dir'])) ? $_CLASS['core_user']-&gt;data['user_sortby_dir'] : 'd';
-	$sql .= ($sort_dir == 'd') ? 'ASC' : 'DESC';
+	$sql .= ($sort_dir === 'd') ? 'ASC' : 'DESC';
 
 	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
 
-	if (!($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result)))
+	if (!$row)
 	{
+		$_CLASS['core_db']-&gt;free_result($result);
 		return false;
 	}
 
@@ -279,7 +291,7 @@
 		else
 		{
 			$rowset[$row['msg_id']] = $row;
-			$bbcode_bitfield |= $row['bbcode_bitfield'];
+			$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 		}
 	}
 	while ($row = $_CLASS['core_db']-&gt;fetch_row_assoc($result));
@@ -293,12 +305,9 @@
 	}
 	
 	// Instantiate BBCode class
-	if (!isset($bbcode) &amp;&amp; $bbcode_bitfield)
+	if ((empty($bbcode) || $bbcode === false) &amp;&amp; $bbcode_bitfield)
 	{
-		if (!class_exists('bbcode'))
-		{
-			require_once(SITE_FILE_ROOT.'includes/forums/bbcode.php');
-		}
+		require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
 		$bbcode = new bbcode($bbcode_bitfield);
 	}
 
@@ -344,7 +353,7 @@
 
 			'U_MSG_ID'			=&gt; $row['msg_id'],
 			'U_VIEW_MESSAGE'	=&gt; generate_link(&quot;$url&amp;f=$folder_id&amp;p=&quot; . $row['msg_id']),
-			'U_AUTHOR_PROFILE' 	=&gt; generate_link('Members_List&amp;mode=viewprofile&amp;u='.$author_id),
+			'U_AUTHOR_PROFILE' 	=&gt; generate_link('members_list&amp;mode=viewprofile&amp;u='.$author_id),
 			'U_QUOTE'			=&gt; ($author_id != $_CLASS['core_user']-&gt;data['user_id']) ? generate_link(&quot;$url&amp;mode=compose&amp;action=quote&amp;f=&quot; . $folder_id . &quot;&amp;p=&quot; . $row['msg_id']) : '',
 			'U_POST_REPLY_PM' 	=&gt; ($author_id != $_CLASS['core_user']-&gt;data['user_id']) ? generate_link(&quot;$url&amp;mode=compose&amp;action=reply&amp;f=$folder_id&amp;p=&quot; . $row['msg_id']) : '')
 		);
@@ -363,19 +372,26 @@
 	return true;
 }
 
-// Get User Informations (only for message display)
+/**
+* Get User Informations (only for message display)
+*/
 function get_user_informations($user_id, $user_row)
 {
 	global $config, $_CORE_CONFIG, $_CLASS;
 
 	if (!$user_id)
 	{
-		return;
+		return array();
 	}
 
 	if (empty($user_row))
 	{
-		$user_row = get_userdata((int) $user_id);
+		$sql = 'SELECT *
+			FROM ' . CORE_USERS_TABLE . '
+			WHERE user_id = ' . (int) $user_id;
+		$result = $_CLASS['core_db']-&gt;query($sql);
+		$user_row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+		$_CLASS['core_db']-&gt;free_result($result);
 	}
 
 	// Grab ranks
@@ -410,11 +426,11 @@
 		switch ($user_row['user_avatar_type'])
 		{
 			case AVATAR_UPLOAD:
-				$avatar_img = $config['avatar_path'] . '/';
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_upload'] . '/';
 			break;
 
 			case AVATAR_GALLERY:
-				$avatar_img = $config['avatar_gallery_path'] . '/';
+				$avatar_img = $_CORE_CONFIG['global']['path_avatar_gallery'] . '/';
 			break;
 		}
 		$avatar_img .= $user_row['user_avatar'];
@@ -448,7 +464,7 @@
 
 	if (!empty($user_row['user_allow_viewemail']))
 	{
-		$user_row['email'] = ($config['board_email_form'] &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('Members_List&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails']) ? '' : 'mailto:' . $user_row['user_email']);
+		$user_row['email'] = ($config['board_email_form'] &amp;&amp; $_CORE_CONFIG['email']['email_enable']) ? generate_link('members_list&amp;mode=email&amp;u='.$user_id) : (($config['board_hide_emails']) ? '' : 'mailto:' . $user_row['user_email']);
 	}
 	else
 	{

Modified: cms/trunk/modules/forums/mcp.php
===================================================================
--- cms/trunk/modules/forums/mcp.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/mcp.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -34,7 +34,7 @@
 {
 	global $_CLASS;
 
-	if ($module_name != 'queue')
+	if ($module_name !== 'queue')
 	{
 		return '';
 	}
@@ -52,7 +52,6 @@
 	switch ($mode)
 	{
 		case 'unapproved_topics':
-
 			$sql = 'SELECT COUNT(*) AS total
 				FROM ' . FORUMS_TOPICS_TABLE . '
 				WHERE forum_id IN (' . implode(', ', $forum_list) . ')
@@ -97,7 +96,6 @@
 
 $i	= get_variable('i', 'REQUEST');
 $mode	= $i ? $i : get_variable('mode', 'REQUEST', 'front');
-$action = get_variable('action', 'REQUEST');
 $quick_mod = isset($_REQUEST['quickmod']);
 
 $post_id = get_variable('p', 'REQUEST', 0);
@@ -106,6 +104,13 @@
 $user_id = get_variable('u', 'REQUEST', 0);
 $username = get_variable('username', 'REQUEST', '');
 
+$action = (isset($_REQUEST['action']) &amp;&amp; is_array($_REQUEST['action'])) ? get_variable('action', 'REQUEST', false, 'array') : get_variable('action', 'REQUEST');
+
+if (is_array($action))
+{
+	list($action, ) = each($action);
+}
+
 if ($mode == 'topic_logs')
 {
 	$id = 'logs';
@@ -114,21 +119,9 @@
 
 if ($mode === 'approve' || $mode === 'disapprove')
 {
-	$module = 'queue';
+	$mode = 'queue';
 }
 
-if ($action == 'merge_select')
-{
-	$mode = 'forum_view';
-}
-
-/*
-if (!$_CLASS['forums_auth']-&gt;acl_get('m_'))
-{
-	trigger_error('YOUR_NO_MODERATOR');
-}
-*/
-
 if (in_array($mode, array('split', 'split_all', 'split_beyond', 'merge', 'merge_posts')))
 {
 	$_REQUEST['action'] = $action = $mode;
@@ -249,11 +242,16 @@
 			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_notes.php';
 			script_close(false);
 		break;
+		
+		case 'queue':
+			require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_queue.php';
+			script_close(false);
+		break;
 	}
-
 	//script_close(false);
 }
 
+$mode = ($mode !== 'front') ? $mode : $action;
 require_once SITE_FILE_ROOT.'includes/forums/mcp/mcp_main.php';
 
 switch ($mode)
@@ -667,11 +665,4 @@
 	return empty($ids) ? false : array_unique($forum_ids);
 }
 
-// REMOVE
-
-function build_hidden_fields($array)
-{
-	return generate_hidden_fields($array);
-}
-
 ?&gt;
\ No newline at end of file

Modified: cms/trunk/modules/forums/posting.php
===================================================================
--- cms/trunk/modules/forums/posting.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/posting.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -191,14 +191,14 @@
 	break;
 
 	case 'edit':
-		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets('f_edit', 'm_edit', $forum_id))
+		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets(array('f_edit', 'm_edit'), $forum_id))
 		{
 			$is_authed = true;
 		}
 	break;
 
 	case 'delete':
-		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets('f_delete', 'm_delete', $forum_id))
+		if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $_CLASS['forums_auth']-&gt;acl_gets(array('f_delete', 'm_delete'), $forum_id))
 		{
 			$is_authed = true;
 		}
@@ -615,7 +615,7 @@
 
 	// If subject is all-uppercase then we make all lowercase (we do not want to be yelled at too :P)
 	// Admins/Mods might want to create all-uppercase topics, therefore we do not apply this check to them (they should know better ;))
-	if ($post_data['post_subject'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_gets('a_', 'm_', $forum_id))// &amp;&amp; strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
+	if ($post_data['post_subject'] &amp;&amp; !$_CLASS['forums_auth']-&gt;acl_gets(array('a_', 'm_'), $forum_id))// &amp;&amp; strcmp($post_data['post_subject'], strtoupper($post_data['post_subject'])) == 0)
 	{
 		//$subject = mb_strtolower(htmlentities(get_variable('subject', 'POST', ''), ENT_QUOTES, 'UTF-8'));
 		$post_data['post_subject'] = mb_strtolower(htmlentities($post_data['post_subject'], ENT_QUOTES, 'UTF-8'));
@@ -714,7 +714,7 @@
 	// notify and show user the post made between his request and the final submit
 	if (($mode == 'reply' || $mode == 'quote') &amp;&amp; $post_data['topic_cur_post_id'] &amp;&amp; $post_data['topic_cur_post_id'] != $post_data['topic_last_post_id'])
 	{
-		if (topic_review($topic_id, $forum_id, 'post_review', $topic_cur_post_id))
+		if (topic_review($topic_id, $forum_id, 'post_review', $post_data['topic_cur_post_id']))
 		{
 			$_CLASS['core_template']-&gt;assign('S_POST_REVIEW',  true);
 		}
@@ -982,7 +982,7 @@
 				'notify_set'			=&gt; $post_data['notify_set'],
 				'poster_ip'				=&gt; (isset($post_data['poster_ip'])) ? $post_data['poster_ip'] : $_CLASS['core_user']-&gt;ip,
 				'post_edit_locked'		=&gt; (int) $post_data['post_edit_locked'],
-				'bbcode_bitfield'		=&gt; (int) $message_parser-&gt;bbcode_bitfield,
+				'bbcode_bitfield'		=&gt; $message_parser-&gt;bbcode_bitfield,
 				'bbcode_uid'			=&gt; $message_parser-&gt;bbcode_uid,
 				'message'				=&gt; $message_parser-&gt;message,
 				'attachment_data'		=&gt; $message_parser-&gt;attachment_data,

Modified: cms/trunk/modules/forums/viewforum.php
===================================================================
--- cms/trunk/modules/forums/viewforum.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/viewforum.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -580,7 +580,7 @@
 			'S_TOPIC_UNAPPROVED'	=&gt; (!$row['topic_approved'] &amp;&amp; $_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)),
 
 			'U_NEWEST_POST'			=&gt; generate_link($view_topic_url . '&amp;view=unread#unread'),
-			'U_LAST_POST'			=&gt; generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#' . $row['topic_last_post_id']),	
+			'U_LAST_POST'			=&gt; generate_link($view_topic_url . '&amp;p=' . $row['topic_last_post_id'] . '#p' . $row['topic_last_post_id']),	
 			'U_LAST_POST_AUTHOR'	=&gt; ($row['topic_last_poster_id']&amp;&amp; $row['topic_last_poster_id'] != ANONYMOUS) ? generate_link('members_list&amp;mode=viewprofile&amp;u='.$row['topic_last_poster_id']) : '',
 			'U_VIEW_TOPIC'			=&gt; generate_link($view_topic_url),
 

Modified: cms/trunk/modules/forums/viewtopic.php
===================================================================
--- cms/trunk/modules/forums/viewtopic.php	2006-08-06 20:31:57 UTC (rev 182)
+++ cms/trunk/modules/forums/viewtopic.php	2006-08-13 02:53:31 UTC (rev 183)
@@ -264,10 +264,25 @@
 $_CLASS['core_user']-&gt;add_lang('viewtopic');
 $_CLASS['core_user']-&gt;add_img();
 
-
+// This is for determining where we are (page)
 // What is start equal to?
 if ($post_id)
-{
+{
+	/**
+	* @todo adjust for using post_time? Generally adjust query... it is not called very often though
+	*/
+	$sql = 'SELECT COUNT(post_id) AS prev_posts
+		FROM ' . FORUMS_POSTS_TABLE . &quot;
+		WHERE topic_id = {$topic_data['topic_id']}
+			&quot; . ((!$_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? 'AND post_approved = 1' : '') . &quot;
+			AND &quot; . (($sort_dir === 'd') ?  &quot;post_id &gt;= $post_id&quot; : &quot;post_id &lt;= $post_id&quot;);
+	$result = $_CLASS['core_db']-&gt;query($sql);
+	$row = $_CLASS['core_db']-&gt;fetch_row_assoc($result);
+	$_CLASS['core_db']-&gt;free_result($result);
+
+	$topic_data['prev_posts'] = $row['prev_posts'];
+	unset($row);
+
 	$start = floor(($topic_data['prev_posts'] - 1) / $config['posts_per_page']) * $config['posts_per_page'];
 }
 
@@ -499,20 +514,24 @@
 
 	for ($i = 0; $i &lt; $count; $i++)
 	{
+		$poll_info[$i]['poll_option_text'] = censor_text($poll_info[$i]['poll_option_text']);
+
 		if ($poll_bbcode !== false)
 		{
 			$poll_bbcode-&gt;bbcode_second_pass($poll_info[$i]['poll_option_text'], $poll_info[$i]['bbcode_uid'], $poll_option['bbcode_bitfield']);
 		}
 		$poll_info[$i]['poll_option_text'] = smiley_text($poll_info[$i]['poll_option_text']);
-		$poll_info[$i]['poll_option_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($poll_info[$i]['poll_option_text']));
+		$poll_info[$i]['poll_option_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $poll_info[$i]['poll_option_text']);
 	}
 
+	$topic_data['poll_title'] = censor_text($topic_data['poll_title']);
+
 	if ($poll_bbcode !== false)
 	{
 		$poll_bbcode-&gt;bbcode_second_pass($topic_data['poll_title'], $poll_info[0]['bbcode_uid'], $poll_info[0]['bbcode_bitfield']);
 	}
 	$topic_data['poll_title'] = smiley_text($topic_data['poll_title']);
-	$topic_data['poll_title'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($topic_data['poll_title']));
+	$topic_data['poll_title'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $topic_data['poll_title']);
 
 	unset($poll_bbcode);
 	
@@ -683,12 +702,12 @@
 	);
 
 	// Define the global bbcode bitfield, will be used to load bbcodes
-	$bbcode_bitfield = $bbcode_bitfield | $row['bbcode_bitfield'];
+	$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['bbcode_bitfield']);
 
 	// Is a signature attached? Are we going to display it?
 	if ($row['enable_sig'] &amp;&amp; $config['allow_sig'] &amp;&amp; $_CLASS['core_user']-&gt;user_data_get('viewsigs'))
 	{
-		$bbcode_bitfield = $bbcode_bitfield | $row['user_sig_bbcode_bitfield'];
+		$bbcode_bitfield = $bbcode_bitfield | base64_decode($row['user_sig_bbcode_bitfield']);
 	}
 
 	// Cache various user specific data ... so we don't have to recompute
@@ -844,7 +863,18 @@
 
 				if ($bday_year)
 				{
-					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - (($today['month'] - $bday_month &lt; 0) ? 1 : (($today['day'] - $bday_day &lt; 0) ? 1 : 0)));
+					$diff = $today['month'] - $bday_month;
+					
+					if ($diff == 0)
+					{
+						$diff = ($today['day'] - $bday_day &lt; 0) ? 1 : 0;
+					}
+					else
+					{
+						$diff = ($diff &lt; 0) ? 1 : 0;
+					}
+					
+					$user_cache[$poster_id]['age'] = (int) ($today['year'] - $bday_year - $diff);
 				}
 			}
 		}
@@ -945,10 +975,10 @@
 }
 
 // Instantiate BBCode if need be
-if ($bbcode_bitfield)
+if ($bbcode_bitfield !== '')
 {
 	require_once SITE_FILE_ROOT.'includes/forums/bbcode.php';
-	$bbcode = new bbcode($bbcode_bitfield);
+	$bbcode = new bbcode(base64_encode($bbcode_bitfield));
 }
 
 $i_total = count($rowset) - 1;
@@ -979,13 +1009,15 @@
 	// End signature parsing, only if needed
 	if ($user_cache[$poster_id]['sig'] &amp;&amp; empty($user_cache[$poster_id]['sig_parsed']))
 	{
+		$user_cache[$poster_id]['sig'] = censor_text($user_cache[$poster_id]['sig']);
+
 		if ($user_cache[$poster_id]['sig_bbcode_bitfield'])
 		{
 			$bbcode-&gt;bbcode_second_pass($user_cache[$poster_id]['sig'], $user_cache[$poster_id]['sig_bbcode_uid'], $user_cache[$poster_id]['sig_bbcode_bitfield']);
 		}
 
 		$user_cache[$poster_id]['sig'] = smiley_text($user_cache[$poster_id]['sig']);
-		$user_cache[$poster_id]['sig'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($user_cache[$poster_id]['sig']));
+		$user_cache[$poster_id]['sig'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $user_cache[$poster_id]['sig']);
 		$user_cache[$poster_id]['sig_parsed'] = true;
 	}
 
@@ -995,6 +1027,8 @@
 		$row['post_text'] = preg_replace('#(&lt;!\-\- h \-\-&gt;&lt;)([\/]?.*?)(&gt;&lt;!\-\- h \-\-&gt;)#is', &quot;&lt;\\2&gt;&quot;, $row['post_text']);
 	}
 
+	$row['post_text'] = censor_text($row['post_text']);
+
 	// Second parse bbcode here
 	if ($row['bbcode_bitfield'])
 	{
@@ -1029,7 +1063,7 @@
 
 	// Replace naughty words such as farty pants
 	$row['post_subject'] = censor_text($row['post_subject']);
-	$row['post_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', censor_text($row['post_text']));
+	$row['post_text'] = str_replace(&quot;\n&quot;, '&lt;br /&gt;', $row['post_text']);
 
 	// Editing information
 	if (($row['post_edit_count'] &amp;&amp; $config['display_last_edited']) || $row['post_edit_reason'])
@@ -1151,7 +1185,7 @@
 
 		'U_REPORT'			=&gt; generate_link('forums&amp;file=report&amp;p=' . $row['post_id']),
 		'U_MCP_REPORT'		=&gt; ($_CLASS['forums_auth']-&gt;acl_gets(array('m_', 'a_', 'f_report'), $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
-		'U_MCP_APPROVE'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;mode=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
+		'U_MCP_APPROVE'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_approve', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;i=queue&amp;action=approve&amp;post_id_list[]=' . $row['post_id'], false, false) : '',
 		'U_MCP_DETAILS'		=&gt; ($_CLASS['forums_auth']-&gt;acl_get('m_', $forum_id)) ? generate_link('forums&amp;file=mcp&amp;mode=post_details&amp;p=' . $row['post_id']) : '',
 		'U_MINI_POST'		=&gt; generate_link('forums&amp;file=viewtopic&amp;p=' . $row['post_id']) . '#' . $row['post_id'],
 		'U_NEXT_POST_ID'	=&gt; ($i &lt; $i_total &amp;&amp; isset($rowset[$i + 1])) ? $rowset[$i + 1]['post_id'] : '', 
@@ -1398,7 +1432,7 @@
 
 	if ($_CLASS['core_user']-&gt;is_bot)
 	{
-		return gmtime();
+		return $_CLASS['core_user']-&gt;time;
 	}
 
 	if ($_CLASS['core_user']-&gt;is_user &amp;&amp; $config['load_db_lastread'])


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000101.html">[Viperals-svncheckins] r182 - in cms/trunk/includes: db	templates/modules/forums templates/modules/members_list
</A></li>
	<LI>Next message: <A HREF="000103.html">[Viperals-svncheckins] r184 - in cms/trunk: . admin includes	includes/auth includes/cache includes/db includes/display	includes/forums includes/forums/admin includes/forums/mcp	includes/templates/modules/forums	includes/templates/modules/forums/admin install javascript	modules/control_panel/modules modules/forums	modules/forums/admin modules/members_list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102">[ date ]</a>
              <a href="thread.html#102">[ thread ]</a>
              <a href="subject.html#102">[ subject ]</a>
              <a href="author.html#102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/viperals-svncheckins">More information about the Viperals-svncheckins
mailing list</a><br>
</body></html>
